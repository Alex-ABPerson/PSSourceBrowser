<!DOCTYPE html>
<html><head><title>Computer.cs</title><link rel="stylesheet" href="../../../styles.css"><script src="../../../scripts.js"></script></head>
<body class="cB" onload="i(2279);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#Microsoft.PowerShell.Commands.Management/commands/management/Computer.cs" target="_top">commands\management\Computer.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#Microsoft.PowerShell.Commands.Management" target="_top">src\Microsoft.PowerShell.Commands.Management\Microsoft.PowerShell.Commands.Management.csproj</a> (Microsoft.PowerShell.Commands.Management)</td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation.</span>
<span class="c">// Licensed under the MIT License.</span>
 
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">UNIX</span>
 
<b>using</b> <span class="i">System</span>;
<b>using</b> <span class="i">System</span>.<span class="i">Collections</span>;
<b>using</b> <span class="i">System</span>.<span class="i">Collections</span>.<span class="i">Generic</span>;
<b>using</b> <span class="i">System</span>.<span class="i">Collections</span>.<span class="i">ObjectModel</span>;
<b>using</b> <span class="i">System</span>.<span class="i">ComponentModel</span>;
<b>using</b> <span class="i">System</span>.<span class="i">Diagnostics</span>.<span class="i">CodeAnalysis</span>;
<b>using</b> <span class="i">System</span>.<span class="i">Globalization</span>;
<b>using</b> <span class="i">System</span>.<span class="i">IO</span>;
<b>using</b> <span class="i">System</span>.<span class="i">Linq</span>;
<b>using</b> <span class="i">System</span>.<span class="i">Management</span>.<span class="i">Automation</span>;
<b>using</b> <span class="i">System</span>.<span class="i">Management</span>.<span class="i">Automation</span>.<span class="i">Internal</span>;
<b>using</b> <span class="i">System</span>.<span class="i">Net</span>;
<b>using</b> <span class="i">System</span>.<span class="i">Runtime</span>.<span class="i">Serialization</span>;
<b>using</b> <span class="i">System</span>.<span class="i">Security</span>.<span class="i">Cryptography</span>;
<b>using</b> <span class="i">System</span>.<span class="i">Text</span>;
<b>using</b> <span class="i">System</span>.<span class="i">Threading</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i">Management</span>.<span class="i">Infrastructure</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i">Management</span>.<span class="i">Infrastructure</span>.<span class="i">Options</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i">Win32</span>;
<b>using</b> <span class="i">Dbg</span> = <span class="i">System</span>.<span class="i">Management</span>.<span class="i">Automation</span>;
 
<span class="c">// FxCop suppressions for resource strings:</span>
[<b>module</b>: <span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Naming&quot;</span>, <span class="s">&quot;CA1703:ResourceStringsShouldBeSpelledCorrectly&quot;</span>, <span class="i">Scope</span> = <span class="s">&quot;resource&quot;</span>, <span class="i">Target</span> = <span class="s">&quot;ComputerResources.resources&quot;</span>, <span class="i">MessageId</span> = <span class="s">&quot;unjoined&quot;</span>)]
[<b>module</b>: <span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Naming&quot;</span>, <span class="s">&quot;CA1701:ResourceStringCompoundWordsShouldBeCasedCorrectly&quot;</span>, <span class="i">Scope</span> = <span class="s">&quot;resource&quot;</span>, <span class="i">Target</span> = <span class="s">&quot;ComputerResources.resources&quot;</span>, <span class="i">MessageId</span> = <span class="s">&quot;UpTime&quot;</span>)]
 
<b>namespace</b> <span class="i n">Microsoft</span>.<span class="i n">PowerShell</span>.<span class="i n">Commands</span>
{
    <span class="k preprocess">#</span><span class="k preprocess">region</span> Restart-Computer
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> This exception is thrown when the timeout expires before a computer finishes restarting.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    [<span class="i">Serializable</span>]
    <b>public sealed class</b> <a id="151bc9100cd5488a" href="../../R/151bc9100cd5488a.html" target="n" data-glyph="0,0" class="t t">RestartComputerTimeoutException</a> : <span class="i">RuntimeException</span>
    {
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Name of the computer that is restarting.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public string</b> <a id="aaa9a9463955c30a" href="../../R/aaa9a9463955c30a.html" target="n" data-glyph="102,1" class="i property">ComputerName</a> { <b>get</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The timeout value specified by the user. It indicates the seconds to wait before timeout.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public int</b> <a id="c5346111fc2cefb8" href="../../R/c5346111fc2cefb8.html" target="n" data-glyph="102,1" class="i property">Timeout</a> { <b>get</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Construct a RestartComputerTimeoutException.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r0 r">computerName</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r1 r">timeout</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r2 r">message</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r3 r">errorId</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal</b> <a id="2638e2da7e867b03" href="../../R/2638e2da7e867b03.html" target="n" data-glyph="74,1" class="t constructor">RestartComputerTimeoutException</a>(<b>string</b> <span id="r0 rd" class="r0 r">computerName</span>, <b>int</b> <span id="r1 rd" class="r1 r">timeout</span>, <b>string</b> <span id="r2 rd" class="r2 r">message</span>, <b>string</b> <span id="r3 rd" class="r3 r">errorId</span>)
            : <b>base</b>(<span class="r2 r">message</span>)
        {
            <span class="i">SetErrorId</span>(<span class="r3 r">errorId</span>);
            <span class="i">SetErrorCategory</span>(<span class="i">ErrorCategory</span>.<span class="i">OperationTimeout</span>);
            <a href="#aaa9a9463955c30a" class="i property">ComputerName</a> = <span class="r0 r">computerName</span>;
            <a href="#c5346111fc2cefb8" class="i property">Timeout</a> = <span class="r1 r">timeout</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Construct a RestartComputerTimeoutException.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public</b> <a id="575b102362f89a7f" href="../../R/../../0000000000.html" target="n" data-glyph="72,1" class="t constructor">RestartComputerTimeoutException</a>() : <b>base</b>() { }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Constructs a RestartComputerTimeoutException.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r4 r">message</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The message used in the exception.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>public</b> <a id="a3c31463de55847f" href="../../R/../../0000000000.html" target="n" data-glyph="72,1" class="t constructor">RestartComputerTimeoutException</a>(<b>string</b> <span id="r4 rd" class="r4 r">message</span>) : <b>base</b>(<span class="r4 r">message</span>) { }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Constructs a RestartComputerTimeoutException.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r5 r">message</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The message used in the exception.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r6 r">innerException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> An exception that led to this exception.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>public</b> <a id="b3a923fa09f4c254" href="../../R/../../0000000000.html" target="n" data-glyph="72,1" class="t constructor">RestartComputerTimeoutException</a>(<b>string</b> <span id="r5 rd" class="r5 r">message</span>, <span class="i">Exception</span> <span id="r6 rd" class="r6 r">innerException</span>) : <b>base</b>(<span class="r5 r">message</span>, <span class="r6 r">innerException</span>) { }
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Serialization
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Serialization constructor for class RestartComputerTimeoutException.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r7 r">info</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> serialization information</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r8 r">context</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> streaming context</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>private</b> <a id="52c44d7bcc9d8c82" href="../../R/../../0000000000.html" target="n" data-glyph="76,1" class="t constructor">RestartComputerTimeoutException</a>(<span class="i">SerializationInfo</span> <span id="r7 rd" class="r7 r">info</span>, <span class="i">StreamingContext</span> <span id="r8 rd" class="r8 r">context</span>)
            : <b>base</b>(<span class="r7 r">info</span>, <span class="r8 r">context</span>)
        {
            <b>if</b> (<span class="r7 r">info</span> == <b>null</b>)
            {
                <b>throw</b> <b>new</b> <span class="i">PSArgumentNullException</span>(<b>nameof</b>(<span class="r7 r">info</span>));
            }
 
            <a href="#aaa9a9463955c30a" class="i property">ComputerName</a> = <span class="r7 r">info</span>.<span class="i">GetString</span>(<span class="s">&quot;ComputerName&quot;</span>);
            <a href="#c5346111fc2cefb8" class="i property">Timeout</a> = <span class="r7 r">info</span>.<span class="i">GetInt32</span>(<span class="s">&quot;Timeout&quot;</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Serializes the RestartComputerTimeoutException.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r9 r">info</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> serialization information</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r10 r">context</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> streaming context</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>public override void</b> <a id="379d6f33d68ddf49" href="../../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">GetObjectData</a>(<span class="i">SerializationInfo</span> <span id="r9 rd" class="r9 r">info</span>, <span class="i">StreamingContext</span> <span id="r10 rd" class="r10 r">context</span>)
        {
            <b>if</b> (<span class="r9 r">info</span> == <b>null</b>)
            {
                <b>throw</b> <b>new</b> <span class="i">PSArgumentNullException</span>(<b>nameof</b>(<span class="r9 r">info</span>));
            }
 
            <b>base</b>.<span class="i">GetObjectData</span>(<span class="r9 r">info</span>, <span class="r10 r">context</span>);
            <span class="r9 r">info</span>.<span class="i">AddValue</span>(<span class="s">&quot;ComputerName&quot;</span>, <a href="#aaa9a9463955c30a" class="i property">ComputerName</a>);
            <span class="r9 r">info</span>.<span class="i">AddValue</span>(<span class="s">&quot;Timeout&quot;</span>, <a href="#c5346111fc2cefb8" class="i property">Timeout</a>);
        }
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Serialization
    }
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Defines the services that Restart-Computer can wait on.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Design&quot;</span>, <span class="s">&quot;CA1027:MarkEnumsWithFlags&quot;</span>)]
    <b>public enum</b> <a id="9f49bfaed22c5093" href="../../R/9f49bfaed22c5093.html" target="n" data-glyph="18,0" class="t t"><span id="0c39d7d0d66d0c79">WaitForServiceTypes</span></a>
    {
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Wait for the WMI service to be ready.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <a id="a3bdc9ac72498626" href="../../R/a3bdc9ac72498626.html" target="n" data-glyph="24,1" class="i field">Wmi</a> = 0x0,
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Wait for the WinRM service to be ready.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <a id="6fb4fd67e09ff3bb" href="../../R/6fb4fd67e09ff3bb.html" target="n" data-glyph="24,1" class="i field">WinRM</a> = 0x1,
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Wait for the PowerShell to be ready.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <a id="38cd456e8d907c32" href="../../R/38cd456e8d907c32.html" target="n" data-glyph="24,1" class="i field">PowerShell</a> = 0x2,
    }
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Restarts the computer.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    [<span class="i">Cmdlet</span>(<span class="i">VerbsLifecycle</span>.<span class="i">Restart</span>, <span class="s">&quot;Computer&quot;</span>, <span class="i">SupportsShouldProcess</span> = <b>true</b>, <span class="i">DefaultParameterSetName</span> = <a href="#f04f4bf246f41fce" class="i field">DefaultParameterSet</a>,
        <span class="i">HelpUri</span> = <span class="s">&quot;https://go.microsoft.com/fwlink/?LinkID=2097060&quot;</span>, <span class="i">RemotingCapability</span> = <span class="i">RemotingCapability</span>.<span class="i">OwnedByCommand</span>)]
    <b>public class</b> <a id="9d8886f81af322bb" href="../../R/../../0000000000.html" target="n" data-glyph="0,0" class="t t"><span id="8be885881e2ff67d">RestartComputerCommand</span></a> : <span class="i">PSCmdlet</span>, <span class="i">IDisposable</span>
    {
        <span class="k preprocess">#</span><span class="k preprocess">region</span> &quot;Parameters and PrivateData&quot;
 
        <b>private const string</b> <a id="f04f4bf246f41fce" href="../../R/f04f4bf246f41fce.html" target="n" data-glyph="10,1" class="i field">DefaultParameterSet</a> = <span class="s">&quot;DefaultSet&quot;</span>;
        <b>private const int</b> <a id="287b8f4ee22ef046" href="../../R/287b8f4ee22ef046.html" target="n" data-glyph="10,1" class="i field">forcedReboot</a> = 6; <span class="c">// see https://msdn.microsoft.com/library/aa394058(v=vs.85).aspx</span>
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The authentication options for CIM_WSMan connection.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>(<span class="i">ParameterSetName</span> = <a href="#f04f4bf246f41fce" class="i field">DefaultParameterSet</a>)]
        [<span class="i">ValidateSet</span>(
            <span class="s">&quot;Default&quot;</span>,
            <span class="s">&quot;Basic&quot;</span>,
            <span class="s">&quot;Negotiate&quot;</span>, <span class="c">// can be used with and without credential (without -&gt; PSRP mapped to NegotiateWithImplicitCredential)</span>
            <span class="s">&quot;CredSSP&quot;</span>,
            <span class="s">&quot;Digest&quot;</span>,
            <span class="s">&quot;Kerberos&quot;</span>)] <span class="c">// can be used with explicit or implicit credential</span>
        [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Naming&quot;</span>, <span class="s">&quot;CA1704:IdentifiersShouldBeSpelledCorrectly&quot;</span>)]
        <b>public string</b> <a id="22602ac220715afe" href="../../R/22602ac220715afe.html" target="n" data-glyph="102,1" class="i property">WsmanAuthentication</a> { <b>get</b>; <b>set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Specifies the computer (s)Name on which this command is executed.</span>
        <span class="c">///</span><span class="c"> When this parameter is omitted, this cmdlet restarts the local computer.</span>
        <span class="c">///</span><span class="c"> Type the NETBIOS name, IP address, or fully-qualified domain name of one</span>
        <span class="c">///</span><span class="c"> or more computers in a comma-separated list. To specify the local computer, type the computername or &quot;localhost&quot;.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>(<span class="i">Position</span> = 0, <span class="i">ValueFromPipeline</span> = <b>true</b>,
                   <span class="i">ValueFromPipelineByPropertyName</span> = <b>true</b>)]
        [<span class="i">ValidateNotNullOrEmpty</span>]
        [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Performance&quot;</span>, <span class="s">&quot;CA1819:PropertiesShouldNotReturnArrays&quot;</span>)]
        [<span class="i">Alias</span>(<span class="s">&quot;CN&quot;</span>, <span class="s">&quot;__SERVER&quot;</span>, <span class="s">&quot;Server&quot;</span>, <span class="s">&quot;IPAddress&quot;</span>)]
        <b>public string</b>[] <a id="58345166f88d090a" href="../../R/58345166f88d090a.html" target="n" data-glyph="102,1" class="i property">ComputerName</a> { <b>get</b>; <b>set</b>; } = <b>new</b> <b>string</b>[] { <span class="s">&quot;.&quot;</span> };
 
        <b>private</b> <span class="i">List</span>&lt;<b>string</b>&gt; <a id="3e3ed1a0d1d55573" href="../../R/3e3ed1a0d1d55573.html" target="n" data-glyph="46,1" class="i field">_validatedComputerNames</a> = <b>new</b>();
        <b>private readonly</b> <span class="i">List</span>&lt;<b>string</b>&gt; <a id="a8af4e4c0c7b5524" href="../../R/a8af4e4c0c7b5524.html" target="n" data-glyph="46,1" class="i field">_waitOnComputers</a> = <b>new</b>();
        <b>private readonly</b> <span class="i">HashSet</span>&lt;<b>string</b>&gt; <a id="b67064e2e05f6ba6" href="../../R/b67064e2e05f6ba6.html" target="n" data-glyph="46,1" class="i field">_uniqueComputerNames</a> = <b>new</b>(<span class="i">StringComparer</span>.<span class="i">OrdinalIgnoreCase</span>);
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The following is the definition of the input parameter &quot;Credential&quot;.</span>
        <span class="c">///</span><span class="c"> Specifies a user account that has permission to perform this action. Type a</span>
        <span class="c">///</span><span class="c"> user-name, such as &quot;User01&quot; or &quot;Domain01\User01&quot;, or enter a PSCredential</span>
        <span class="c">///</span><span class="c"> object, such as one from the Get-Credential cmdlet.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>(<span class="i">Position</span> = 1)]
        [<span class="i">ValidateNotNullOrEmpty</span>]
        [<span class="i">Credential</span>]
        <b>public</b> <span class="i">PSCredential</span> <a id="c9605b14b093949f" href="../../R/c9605b14b093949f.html" target="n" data-glyph="102,1" class="i property">Credential</a> { <b>get</b>; <b>set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Using Force in conjunction with Reboot on a</span>
        <span class="c">///</span><span class="c"> remote computer immediately reboots the remote computer.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>]
        [<span class="i">Alias</span>(<span class="s">&quot;f&quot;</span>)]
        <b>public</b> <span class="i">SwitchParameter</span> <a id="d40ac37a5487205e" href="../../R/d40ac37a5487205e.html" target="n" data-glyph="102,1" class="i property">Force</a> { <b>get</b>; <b>set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Specify the Wait parameter. Prompt will be blocked is the Timeout is not 0.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>(<span class="i">ParameterSetName</span> = <a href="#f04f4bf246f41fce" class="i field">DefaultParameterSet</a>)]
        <b>public</b> <span class="i">SwitchParameter</span> <a id="9e0c57cb19042f2f" href="../../R/9e0c57cb19042f2f.html" target="n" data-glyph="102,1" class="i property">Wait</a> { <b>get</b>; <b>set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Specify the Timeout parameter.</span>
        <span class="c">///</span><span class="c"> Negative value indicates wait infinitely.</span>
        <span class="c">///</span><span class="c"> Positive value indicates the seconds to wait before timeout.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>(<span class="i">ParameterSetName</span> = <a href="#f04f4bf246f41fce" class="i field">DefaultParameterSet</a>)]
        [<span class="i">Alias</span>(<span class="s">&quot;TimeoutSec&quot;</span>)]
        [<span class="i">ValidateRange</span>(-1, <b>int</b>.<span class="i">MaxValue</span>)]
        <b>public int</b> <a id="4457c02c42afc7c9" href="../../R/4457c02c42afc7c9.html" target="n" data-glyph="102,1" class="i property">Timeout</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#4d21311b1b54b6a1" class="i field">_timeout</a>;
            }
 
            <b>set</b>
            {
                <a href="#4d21311b1b54b6a1" class="i field">_timeout</a> = <b>value</b>;
                <a href="#1040c67c4d21f1b8" class="i field">_timeoutSpecified</a> = <b>true</b>;
            }
        }
 
        <b>private int</b> <a id="4d21311b1b54b6a1" href="../../R/4d21311b1b54b6a1.html" target="n" data-glyph="46,1" class="i field">_timeout</a> = -1;
        <b>private bool</b> <a id="1040c67c4d21f1b8" href="../../R/1040c67c4d21f1b8.html" target="n" data-glyph="46,1" class="i field">_timeoutSpecified</a> = <b>false</b>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Specify the For parameter.</span>
        <span class="c">///</span><span class="c"> Wait for the specific service before unblocking the prompt.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>(<span class="i">ParameterSetName</span> = <a href="#f04f4bf246f41fce" class="i field">DefaultParameterSet</a>)]
        <b>public</b> <a href="#9f49bfaed22c5093" class="t t">WaitForServiceTypes</a> <a id="4c2960e040f7cadf" href="../../R/../../0000000000.html" target="n" data-glyph="102,1" class="i property">For</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#777cca59aca6a36c" class="i field">_waitFor</a>;
            }
 
            <b>set</b>
            {
                <a href="#777cca59aca6a36c" class="i field">_waitFor</a> = <b>value</b>;
                <a href="#0ccd52b3dc591791" class="i field">_waitForSpecified</a> = <b>true</b>;
            }
        }
 
        <b>private</b> <a href="#9f49bfaed22c5093" class="t t">WaitForServiceTypes</a> <a id="777cca59aca6a36c" href="../../R/777cca59aca6a36c.html" target="n" data-glyph="46,1" class="i field">_waitFor</a> = <a href="#9f49bfaed22c5093" class="t t">WaitForServiceTypes</a>.<a href="#38cd456e8d907c32" class="i field">PowerShell</a>;
        <b>private bool</b> <a id="0ccd52b3dc591791" href="../../R/0ccd52b3dc591791.html" target="n" data-glyph="46,1" class="i field">_waitForSpecified</a> = <b>false</b>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Specify the Delay parameter.</span>
        <span class="c">///</span><span class="c"> The specific time interval (in second) to wait between network pings or service queries.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>(<span class="i">ParameterSetName</span> = <a href="#f04f4bf246f41fce" class="i field">DefaultParameterSet</a>)]
        [<span class="i">ValidateRange</span>(1, <b>short</b>.<span class="i">MaxValue</span>)]
        <b>public short</b> <a id="aec2116632504871" href="../../R/../../0000000000.html" target="n" data-glyph="102,1" class="i property">Delay</a>
        {
            <b>get</b>
            {
                <b>return</b> (<b>short</b>)<a href="#76521ceb4446723a" class="i field">_delay</a>;
            }
 
            <b>set</b>
            {
                <a href="#76521ceb4446723a" class="i field">_delay</a> = <b>value</b>;
                <a href="#c1d7ed971b6468df" class="i field">_delaySpecified</a> = <b>true</b>;
            }
        }
 
        <b>private int</b> <a id="76521ceb4446723a" href="../../R/76521ceb4446723a.html" target="n" data-glyph="46,1" class="i field">_delay</a> = 5;
        <b>private bool</b> <a id="c1d7ed971b6468df" href="../../R/c1d7ed971b6468df.html" target="n" data-glyph="46,1" class="i field">_delaySpecified</a> = <b>false</b>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Script to test if the PowerShell is ready.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private const string</b> <a id="1aeec724968d24c0" href="../../R/1aeec724968d24c0.html" target="n" data-glyph="10,1" class="i field">TestPowershellScript</a> = <span class="s">@&quot;
$array = @($input)
$result = @{}
foreach ($computerName in $array[1])
{
    $ret = $null
    $arguments = @{
        ComputerName = $computerName
        ScriptBlock = { $true }
 
        SessionOption = NewPSSessionOption -NoMachineProfile
        ErrorAction = &#39;SilentlyContinue&#39;
    }
 
    if ( $null -ne $array[0] )
    {
        $arguments[&#39;Credential&#39;] = $array[0]
    }
 
    $result[$computerName] = (Invoke-Command @arguments) -as [bool]
}
$result
&quot;</span>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The indicator to use when show progress.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private readonly string</b>[] <a id="572a4007f69b6b2c" href="../../R/572a4007f69b6b2c.html" target="n" data-glyph="46,1" class="i field">_indicator</a> = { <span class="s">&quot;|&quot;</span>, <span class="s">&quot;/&quot;</span>, <span class="s">&quot;-&quot;</span>, <span class="s">&quot;\\&quot;</span> };
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The activity id.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private int</b> <a id="839a0c310235ff3b" href="../../R/839a0c310235ff3b.html" target="n" data-glyph="46,1" class="i field">_activityId</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> After call &#39;Shutdown&#39; on the target computer, wait a few</span>
        <span class="c">///</span><span class="c"> seconds for the restart to begin.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private const int</b> <a id="a124f9b3b7bb454b" href="../../R/a124f9b3b7bb454b.html" target="n" data-glyph="10,1" class="i field">SecondsToWaitForRestartToBegin</a> = 25;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Actual time out in seconds.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private int</b> <a id="142e036152d28fe0" href="../../R/142e036152d28fe0.html" target="n" data-glyph="46,1" class="i field">_timeoutInMilliseconds</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Indicate to exit.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private bool</b> <a id="847e06fc16b46f47" href="../../R/847e06fc16b46f47.html" target="n" data-glyph="46,1" class="i field">_exit</a>, <a id="dd01ee4445285ea8" href="../../R/dd01ee4445285ea8.html" target="n" data-glyph="46,1" class="i field">_timeUp</a>;
        <b>private readonly</b> <span class="i">CancellationTokenSource</span> <a id="067821c7b2279345" href="../../R/067821c7b2279345.html" target="n" data-glyph="46,1" class="i field">_cancel</a> = <b>new</b>();
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> A waithandler to wait on. Current thread will wait on it during the delay interval.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private readonly</b> <span class="i">ManualResetEventSlim</span> <a id="063e9876d6da82e3" href="../../R/063e9876d6da82e3.html" target="n" data-glyph="46,1" class="i field">_waitHandler</a> = <b>new</b>(<b>false</b>);
        <b>private readonly</b> <span class="i">Dictionary</span>&lt;<b>string</b>, <a href="#12f4082d4b9cdbf2" class="t t">ComputerInfo</a>&gt; <a id="274f35bd10c60b2b" href="../../R/274f35bd10c60b2b.html" target="n" data-glyph="46,1" class="i field">_computerInfos</a> = <b>new</b>(<span class="i">StringComparer</span>.<span class="i">OrdinalIgnoreCase</span>);
 
        <span class="c">// CLR 4.0 Port note - use https://msdn.microsoft.com/library/system.net.networkinformation.ipglobalproperties.hostname(v=vs.110).aspx</span>
        <b>private readonly string</b> <a id="8375db44362efaf5" href="../../R/8375db44362efaf5.html" target="n" data-glyph="46,1" class="i field">_shortLocalMachineName</a> = <span class="i">Dns</span>.<span class="i">GetHostName</span>();
 
        <span class="c">// And for this, use PsUtils.GetHostname()</span>
        <b>private readonly string</b> <a id="aba3f99f02b97d2e" href="../../R/aba3f99f02b97d2e.html" target="n" data-glyph="46,1" class="i field">_fullLocalMachineName</a> = <span class="i">Dns</span>.<span class="i">GetHostEntryAsync</span>(<b>string</b>.<span class="i">Empty</span>).<span class="i">Result</span>.<span class="i">HostName</span>;
 
        <b>private int</b> <a id="3adbff84e0ff3c17" href="../../R/3adbff84e0ff3c17.html" target="n" data-glyph="46,1" class="i field">_percent</a>;
        <b>private string</b> <a id="405c69cec56d4c47" href="../../R/405c69cec56d4c47.html" target="n" data-glyph="46,1" class="i field">_status</a>;
        <b>private string</b> <a id="42372db3c9bfffae" href="../../R/42372db3c9bfffae.html" target="n" data-glyph="46,1" class="i field">_activity</a>;
        <b>private</b> <span class="i">Timer</span> <a id="eb7b27d03284440b" href="../../R/eb7b27d03284440b.html" target="n" data-glyph="46,1" class="i field">_timer</a>;
        <b>private</b> <span class="i">System</span>.<span class="i">Management</span>.<span class="i">Automation</span>.<span class="i">PowerShell</span> <a id="f2e36aa9a6cc688d" href="../../R/f2e36aa9a6cc688d.html" target="n" data-glyph="46,1" class="i field">_powershell</a>;
 
        <b>private const string</b> <a id="be86b083c58ac8ca" href="../../R/be86b083c58ac8ca.html" target="n" data-glyph="10,1" class="i field">StageVerification</a> = <span class="s">&quot;VerifyStage&quot;</span>;
        <b>private const string</b> <a id="04f726ec2685ba84" href="../../R/04f726ec2685ba84.html" target="n" data-glyph="10,1" class="i field">WmiConnectionTest</a> = <span class="s">&quot;WMI&quot;</span>;
        <b>private const string</b> <a id="f7952679c7d43101" href="../../R/f7952679c7d43101.html" target="n" data-glyph="10,1" class="i field">WinrmConnectionTest</a> = <span class="s">&quot;WinRM&quot;</span>;
        <b>private const string</b> <a id="abf9e5b73466d196" href="../../R/abf9e5b73466d196.html" target="n" data-glyph="10,1" class="i field">PowerShellConnectionTest</a> = <span class="s">&quot;PowerShell&quot;</span>;
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> &quot;parameters and PrivateData&quot;
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> &quot;IDisposable Members&quot;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Dispose Method.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public void</b> <a id="2ee7fb214b9fba05" href="../../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">Dispose</a>()
        {
            <a href="#9d8886f81af322bb" class="k">this</a>.<a href="#6fa87d4c6ad31f41" class="i method">Dispose</a>(<b>true</b>);
            <span class="c">// Use SuppressFinalize in case a subclass</span>
            <span class="c">// of this type implements a finalizer.</span>
            <span class="i">GC</span>.<span class="i">SuppressFinalize</span>(<a href="#9d8886f81af322bb" class="k">this</a>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Dispose Method.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r11 r">disposing</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>public void</b> <a id="6fa87d4c6ad31f41" href="../../R/6fa87d4c6ad31f41.html" target="n" data-glyph="72,1" class="i method">Dispose</a>(<b>bool</b> <span id="r11 rd" class="r11 r">disposing</span>)
        {
            <b>if</b> (<span class="r11 r">disposing</span>)
            {
                <b>if</b> (<a href="#eb7b27d03284440b" class="i field">_timer</a> != <b>null</b>)
                {
                    <a href="#eb7b27d03284440b" class="i field">_timer</a>.<span class="i">Dispose</span>();
                }
 
                <a href="#063e9876d6da82e3" class="i field">_waitHandler</a>.<span class="i">Dispose</span>();
                <a href="#067821c7b2279345" class="i field">_cancel</a>.<span class="i">Dispose</span>();
                <b>if</b> (<a href="#f2e36aa9a6cc688d" class="i field">_powershell</a> != <b>null</b>)
                {
                    <a href="#f2e36aa9a6cc688d" class="i field">_powershell</a>.<span class="i">Dispose</span>();
                }
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> &quot;IDisposable Members&quot;
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> &quot;Private Methods&quot;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Validate parameters for &#39;DefaultSet&#39;</span>
        <span class="c">///</span><span class="c"> 1. When the Wait is specified, the computername cannot contain the local machine</span>
        <span class="c">///</span><span class="c"> 2. If the local machine is present, make sure it is at the end of the list (so the remote ones get restarted before the local machine reboot).</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private void</b> <a id="cef2dd08527e8e22" href="../../R/cef2dd08527e8e22.html" target="n" data-glyph="76,1" class="i method">ValidateComputerNames</a>()
        {
            <b>bool</b> <span id="r12 rd" class="r12 r">containLocalhost</span> = <b>false</b>;
            <a href="#3e3ed1a0d1d55573" class="i field">_validatedComputerNames</a>.<span class="i">Clear</span>();
 
            <b>foreach</b> (<b>string</b> <span id="r13 rd" class="r13 r">name</span> <b>in</b> <a href="#58345166f88d090a" class="i property">ComputerName</a>)
            {
                <span class="i">ErrorRecord</span> <span id="r14 rd" class="r14 r">error</span> = <b>null</b>;
                <b>string</b> <span id="r15 rd" class="r15 r">targetComputerName</span> = <a href="#e8bc15cd238f4de0" class="t t">ComputerWMIHelper</a>.<a href="#63c511374ea180c9" class="i method">ValidateComputerName</a>(<span class="r13 r">name</span>, <a href="#8375db44362efaf5" class="i field">_shortLocalMachineName</a>, <a href="#aba3f99f02b97d2e" class="i field">_fullLocalMachineName</a>, <b>ref</b> <span class="r14 r">error</span>);
                <b>if</b> (<span class="r15 r">targetComputerName</span> == <b>null</b>)
                {
                    <b>if</b> (<span class="r14 r">error</span> != <b>null</b>)
                    {
                        <span class="i">WriteError</span>(<span class="r14 r">error</span>);
                    }
 
                    <b>continue</b>;
                }
 
                <b>if</b> (<span class="r15 r">targetComputerName</span>.<span class="i">Equals</span>(<a href="#e8bc15cd238f4de0" class="t t">ComputerWMIHelper</a>.<a href="#f343d6c6559c69a3" class="i field">localhostStr</a>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
                {
                    <span class="r12 r">containLocalhost</span> = <b>true</b>;
                }
                <b>else</b> <b>if</b> (!<a href="#b67064e2e05f6ba6" class="i field">_uniqueComputerNames</a>.<span class="i">Contains</span>(<span class="r15 r">targetComputerName</span>))
                {
                    <a href="#3e3ed1a0d1d55573" class="i field">_validatedComputerNames</a>.<span class="i">Add</span>(<span class="r15 r">targetComputerName</span>);
                    <a href="#b67064e2e05f6ba6" class="i field">_uniqueComputerNames</a>.<span class="i">Add</span>(<span class="r15 r">targetComputerName</span>);
                }
            }
 
            <span class="c">// Force wait with a test hook even if we&#39;re on the local computer</span>
            <b>if</b> (!<span class="i">InternalTestHooks</span>.<span class="i">TestWaitStopComputer</span> &amp;&amp; <a href="#9e0c57cb19042f2f" class="i property">Wait</a> &amp;&amp; <span class="r12 r">containLocalhost</span>)
            {
                <span class="c">// The local machine will be ignored, and an error will be emitted.</span>
                <span class="i">InvalidOperationException</span> <span id="r16 rd" class="r16 r">ex</span> = <b>new</b>(<span class="i">ComputerResources</span>.<span class="i">CannotWaitLocalComputer</span>);
                <span class="i">WriteError</span>(<b>new</b> <span class="i">ErrorRecord</span>(<span class="r16 r">ex</span>, <span class="s">&quot;CannotWaitLocalComputer&quot;</span>, <span class="i">ErrorCategory</span>.<span class="i">InvalidOperation</span>, <b>null</b>));
                <span class="r12 r">containLocalhost</span> = <b>false</b>;
            }
 
            <span class="c">// Add the localhost to the end of the list, so we will restart remote machines</span>
            <span class="c">// before we restart the local one.</span>
            <b>if</b> (<span class="r12 r">containLocalhost</span>)
            {
                <a href="#3e3ed1a0d1d55573" class="i field">_validatedComputerNames</a>.<span class="i">Add</span>(<a href="#e8bc15cd238f4de0" class="t t">ComputerWMIHelper</a>.<a href="#f343d6c6559c69a3" class="i field">localhostStr</a>);
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Write out progress.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r17 r">activity</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r18 r">status</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r19 r">percent</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r20 r">progressRecordType</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>private void</b> <a id="2838df5b738e6dc9" href="../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">WriteProgress</a>(<b>string</b> <span id="r17 rd" class="r17 r">activity</span>, <b>string</b> <span id="r18 rd" class="r18 r">status</span>, <b>int</b> <span id="r19 rd" class="r19 r">percent</span>, <span class="i">ProgressRecordType</span> <span id="r20 rd" class="r20 r">progressRecordType</span>)
        {
            <span class="i">ProgressRecord</span> <span id="r21 rd" class="r21 r">progress</span> = <b>new</b>(<a href="#839a0c310235ff3b" class="i field">_activityId</a>, <span class="r17 r">activity</span>, <span class="r18 r">status</span>);
            <span class="r21 r">progress</span>.<span class="i">PercentComplete</span> = <span class="r19 r">percent</span>;
            <span class="r21 r">progress</span>.<span class="i">RecordType</span> = <span class="r20 r">progressRecordType</span>;
            <span class="i">WriteProgress</span>(<span class="r21 r">progress</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Calculate the progress percentage.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r22 r">currentStage</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>private int</b> <a id="973c198d4e5342f3" href="../../R/973c198d4e5342f3.html" target="n" data-glyph="76,1" class="i method">CalculateProgressPercentage</a>(<b>string</b> <span id="r22 rd" class="r22 r">currentStage</span>)
        {
            <b>switch</b> (<span class="r22 r">currentStage</span>)
            {
                <b>case</b> <a href="#be86b083c58ac8ca" class="i field">StageVerification</a>:
                    <b>return</b> <a href="#777cca59aca6a36c" class="i field">_waitFor</a>.<span class="i">Equals</span>(<a href="#9f49bfaed22c5093" class="t t">WaitForServiceTypes</a>.<a href="#a3bdc9ac72498626" class="i field">Wmi</a>) || <a href="#777cca59aca6a36c" class="i field">_waitFor</a>.<span class="i">Equals</span>(<a href="#9f49bfaed22c5093" class="t t">WaitForServiceTypes</a>.<a href="#6fb4fd67e09ff3bb" class="i field">WinRM</a>)
                               ? 33
                               : 20;
                <b>case</b> <a href="#04f726ec2685ba84" class="i field">WmiConnectionTest</a>:
                    <b>return</b> <a href="#777cca59aca6a36c" class="i field">_waitFor</a>.<span class="i">Equals</span>(<a href="#9f49bfaed22c5093" class="t t">WaitForServiceTypes</a>.<a href="#a3bdc9ac72498626" class="i field">Wmi</a>) ? 66 : 40;
                <b>case</b> <a href="#f7952679c7d43101" class="i field">WinrmConnectionTest</a>:
                    <b>return</b> <a href="#777cca59aca6a36c" class="i field">_waitFor</a>.<span class="i">Equals</span>(<a href="#9f49bfaed22c5093" class="t t">WaitForServiceTypes</a>.<a href="#6fb4fd67e09ff3bb" class="i field">WinRM</a>) ? 66 : 60;
                <b>case</b> <a href="#abf9e5b73466d196" class="i field">PowerShellConnectionTest</a>:
                    <b>return</b> 80;
                <b>default</b>:
                    <b>break</b>;
            }
 
            <span class="i">Dbg</span>.<span class="i">Diagnostics</span>.<span class="i">Assert</span>(<b>false</b>, <span class="s">&quot;CalculateProgressPercentage should never hit the default case&quot;</span>);
            <b>return</b> 0;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Event handler for the timer.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r23 r">s</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>private void</b> <a id="c572090cd4539ca7" href="../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">OnTimedEvent</a>(<b>object</b> <span id="r23 rd" class="r23 r">s</span>)
        {
            <a href="#847e06fc16b46f47" class="i field">_exit</a> = <a href="#dd01ee4445285ea8" class="i field">_timeUp</a> = <b>true</b>;
            <a href="#067821c7b2279345" class="i field">_cancel</a>.<span class="i">Cancel</span>();
            <a href="#063e9876d6da82e3" class="i field">_waitHandler</a>.<span class="i">Set</span>();
 
            <b>if</b> (<a href="#f2e36aa9a6cc688d" class="i field">_powershell</a> != <b>null</b>)
            {
                <a href="#f2e36aa9a6cc688d" class="i field">_powershell</a>.<span class="i">Stop</span>();
                <a href="#f2e36aa9a6cc688d" class="i field">_powershell</a>.<span class="i">Dispose</span>();
            }
        }
 
        <b>private sealed class</b> <a id="12f4082d4b9cdbf2" href="../../R/12f4082d4b9cdbf2.html" target="n" data-glyph="4,1" class="t t"><span id="f4a67ca083655817">ComputerInfo</span></a>
        {
            <b>internal string</b> <a id="47d091beaeb1ebb5" href="../../R/47d091beaeb1ebb5.html" target="n" data-glyph="44,2" class="i field">LastBootUpTime</a>;
            <b>internal bool</b> <a id="673ab0c777df89b8" href="../../R/673ab0c777df89b8.html" target="n" data-glyph="44,2" class="i field">RebootComplete</a>;
        }
 
        <b>private</b> <span class="i">List</span>&lt;<b>string</b>&gt; <a id="f87dda9d6f2734d5" href="../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">TestRestartStageUsingWsman</a>(<span class="i">IEnumerable</span>&lt;<b>string</b>&gt; <span id="r24 rd" class="r24 r">computerNames</span>, <span class="i">List</span>&lt;<b>string</b>&gt; <span id="r25 rd" class="r25 r">nextTestList</span>, <span class="i">CancellationToken</span> <span id="r26 rd" class="r26 r">token</span>)
        {
            <b>var</b> <span id="r27 rd" class="r27 r">restartStageTestList</span> = <b>new</b> <span class="i">List</span>&lt;<b>string</b>&gt;();
            <b>var</b> <span id="r28 rd" class="r28 r">operationOptions</span> = <b>new</b> <span class="i">CimOperationOptions</span>
            {
                <span class="i">Timeout</span> = <span class="i">TimeSpan</span>.<span class="i">FromMilliseconds</span>(2000),
                <span class="i">CancellationToken</span> = <span class="r26 r">token</span>
            };
            <b>foreach</b> (<b>var</b> <span id="r29 rd" class="r29 r">computer</span> <b>in</b> <span class="r24 r">computerNames</span>)
            {
                <b>try</b>
                {
                    <b>if</b> (<span class="r26 r">token</span>.<span class="i">IsCancellationRequested</span>) { <b>break</b>; }
 
                    <b>using</b> (<span class="i">CimSession</span> <span id="r30 rd" class="r30 r">cimSession</span> = <span class="i">RemoteDiscoveryHelper</span>.<span class="i">CreateCimSession</span>(<span class="r29 r">computer</span>, <a href="#c9605b14b093949f" class="i property">Credential</a>, <a href="#22602ac220715afe" class="i property">WsmanAuthentication</a>, <span class="i">isLocalHost</span>: <b>false</b>, <a href="#9d8886f81af322bb" class="k">this</a>, <span class="r26 r">token</span>))
                    {
                        <b>bool</b> <span id="r31 rd" class="r31 r">itemRetrieved</span> = <b>false</b>;
                        <span class="i">IEnumerable</span>&lt;<span class="i">CimInstance</span>&gt; <span id="r32 rd" class="r32 r">mCollection</span> = <span class="r30 r">cimSession</span>.<span class="i">QueryInstances</span>(
                                                                 <a href="#e8bc15cd238f4de0" class="t t">ComputerWMIHelper</a>.<a href="#651d3255d91c264e" class="i field">CimOperatingSystemNamespace</a>,
                                                                 <a href="#e8bc15cd238f4de0" class="t t">ComputerWMIHelper</a>.<a href="#0e6d68434b34bc05" class="i field">CimQueryDialect</a>,
                                                                 <span class="s">&quot;Select * from &quot;</span> + <a href="#e8bc15cd238f4de0" class="t t">ComputerWMIHelper</a>.<a href="#8ce54643ae82a88c" class="i field">WMI_Class_OperatingSystem</a>,
                                                                 <span class="r28 r">operationOptions</span>);
                        <b>foreach</b> (<span class="i">CimInstance</span> <span id="r33 rd" class="r33 r">os</span> <b>in</b> <span class="r32 r">mCollection</span>)
                        {
                            <span class="r31 r">itemRetrieved</span> = <b>true</b>;
                            <b>string</b> <span id="r34 rd" class="r34 r">newLastBootUpTime</span> = <span class="r33 r">os</span>.<span class="i">CimInstanceProperties</span>[<span class="s">&quot;LastBootUpTime&quot;</span>].<span class="i">Value</span>.<span class="i">ToString</span>();
                            <b>string</b> <span id="r35 rd" class="r35 r">oldLastBootUpTime</span> = <a href="#274f35bd10c60b2b" class="i field">_computerInfos</a>[<span class="r29 r">computer</span>].<span class="i">LastBootUpTime</span>;
 
                            <b>if</b> (!<b>string</b>.<span class="i">Equals</span>(<span class="r34 r">newLastBootUpTime</span>, <span class="r35 r">oldLastBootUpTime</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
                            {
                                <a href="#274f35bd10c60b2b" class="i field">_computerInfos</a>[<span class="r29 r">computer</span>].<span class="i">RebootComplete</span> = <b>true</b>;
                                <span class="r25 r">nextTestList</span>.<span class="i">Add</span>(<span class="r29 r">computer</span>);
                            }
                            <b>else</b>
                            {
                                <span class="r27 r">restartStageTestList</span>.<span class="i">Add</span>(<span class="r29 r">computer</span>);
                            }
                        }
 
                        <b>if</b> (!<span class="r31 r">itemRetrieved</span>)
                        {
                            <span class="r27 r">restartStageTestList</span>.<span class="i">Add</span>(<span class="r29 r">computer</span>);
                        }
                    }
                }
                <b>catch</b> (<span class="i">CimException</span>)
                {
                    <span class="r27 r">restartStageTestList</span>.<span class="i">Add</span>(<span class="r29 r">computer</span>);
                }
                <b>catch</b> (<span class="i">Exception</span>)
                {
                    <span class="r27 r">restartStageTestList</span>.<span class="i">Add</span>(<span class="r29 r">computer</span>);
                }
            }
 
            <b>return</b> <span class="r27 r">restartStageTestList</span>;
        }
 
        <b>private</b> <span class="i">List</span>&lt;<b>string</b>&gt; <a id="3460d2b24272235c" href="../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">SetUpComputerInfoUsingWsman</a>(<span class="i">IEnumerable</span>&lt;<b>string</b>&gt; <span id="r36 rd" class="r36 r">computerNames</span>, <span class="i">CancellationToken</span> <span id="r37 rd" class="r37 r">token</span>)
        {
            <b>var</b> <span id="r38 rd" class="r38 r">validComputerNameList</span> = <b>new</b> <span class="i">List</span>&lt;<b>string</b>&gt;();
            <b>var</b> <span id="r39 rd" class="r39 r">operationOptions</span> = <b>new</b> <span class="i">CimOperationOptions</span>
            {
                <span class="i">Timeout</span> = <span class="i">TimeSpan</span>.<span class="i">FromMilliseconds</span>(2000),
                <span class="i">CancellationToken</span> = <span class="r37 r">token</span>
            };
            <b>foreach</b> (<b>var</b> <span id="r40 rd" class="r40 r">computer</span> <b>in</b> <span class="r36 r">computerNames</span>)
            {
                <b>try</b>
                {
                    <b>using</b> (<span class="i">CimSession</span> <span id="r41 rd" class="r41 r">cimSession</span> = <span class="i">RemoteDiscoveryHelper</span>.<span class="i">CreateCimSession</span>(<span class="r40 r">computer</span>, <a href="#c9605b14b093949f" class="i property">Credential</a>, <a href="#22602ac220715afe" class="i property">WsmanAuthentication</a>, <span class="i">isLocalHost</span>: <b>false</b>, <a href="#9d8886f81af322bb" class="k">this</a>, <span class="r37 r">token</span>))
                    {
                        <b>bool</b> <span id="r42 rd" class="r42 r">itemRetrieved</span> = <b>false</b>;
                        <span class="i">IEnumerable</span>&lt;<span class="i">CimInstance</span>&gt; <span id="r43 rd" class="r43 r">mCollection</span> = <span class="r41 r">cimSession</span>.<span class="i">QueryInstances</span>(
                                                                 <a href="#e8bc15cd238f4de0" class="t t">ComputerWMIHelper</a>.<a href="#651d3255d91c264e" class="i field">CimOperatingSystemNamespace</a>,
                                                                 <a href="#e8bc15cd238f4de0" class="t t">ComputerWMIHelper</a>.<a href="#0e6d68434b34bc05" class="i field">CimQueryDialect</a>,
                                                                 <span class="s">&quot;Select * from &quot;</span> + <a href="#e8bc15cd238f4de0" class="t t">ComputerWMIHelper</a>.<a href="#8ce54643ae82a88c" class="i field">WMI_Class_OperatingSystem</a>,
                                                                 <span class="r39 r">operationOptions</span>);
                        <b>foreach</b> (<span class="i">CimInstance</span> <span id="r44 rd" class="r44 r">os</span> <b>in</b> <span class="r43 r">mCollection</span>)
                        {
                            <span class="r42 r">itemRetrieved</span> = <b>true</b>;
                            <b>if</b> (!<a href="#274f35bd10c60b2b" class="i field">_computerInfos</a>.<span class="i">ContainsKey</span>(<span class="r40 r">computer</span>))
                            {
                                <a href="#12f4082d4b9cdbf2" class="k">var</a> <span id="r45 rd" class="r45 r">info</span> = <b>new</b> <span class="t">ComputerInfo</span>
                                {
                                    <a href="#47d091beaeb1ebb5" class="i field">LastBootUpTime</a> = <span class="r44 r">os</span>.<span class="i">CimInstanceProperties</span>[<span class="s">&quot;LastBootUpTime&quot;</span>].<span class="i">Value</span>.<span class="i">ToString</span>(),
                                    <a href="#673ab0c777df89b8" class="i field">RebootComplete</a> = <b>false</b>
                                };
                                <a href="#274f35bd10c60b2b" class="i field">_computerInfos</a>.<span class="i">Add</span>(<span class="r40 r">computer</span>, <span class="r45 r">info</span>);
                                <span class="r38 r">validComputerNameList</span>.<span class="i">Add</span>(<span class="r40 r">computer</span>);
                            }
                        }
 
                        <b>if</b> (!<span class="r42 r">itemRetrieved</span>)
                        {
                            <b>string</b> <span id="r46 rd" class="r46 r">errMsg</span> = <span class="i">StringUtil</span>.<span class="i">Format</span>(<span class="i">ComputerResources</span>.<span class="i">RestartComputerSkipped</span>, <span class="r40 r">computer</span>, <span class="i">ComputerResources</span>.<span class="i">CannotGetOperatingSystemObject</span>);
                            <b>var</b> <span id="r47 rd" class="r47 r">error</span> = <b>new</b> <span class="i">ErrorRecord</span>(<b>new</b> <span class="i">InvalidOperationException</span>(<span class="r46 r">errMsg</span>), <span class="s">&quot;RestartComputerSkipped&quot;</span>,
                                                            <span class="i">ErrorCategory</span>.<span class="i">OperationStopped</span>, <span class="r40 r">computer</span>);
                            <a href="#9d8886f81af322bb" class="k">this</a>.<span class="i">WriteError</span>(<span class="r47 r">error</span>);
                        }
                    }
                }
                <b>catch</b> (<span class="i">CimException</span> <span id="r48 rd" class="r48 r">ex</span>)
                {
                    <b>string</b> <span id="r49 rd" class="r49 r">errMsg</span> = <span class="i">StringUtil</span>.<span class="i">Format</span>(<span class="i">ComputerResources</span>.<span class="i">RestartComputerSkipped</span>, <span class="r40 r">computer</span>, <span class="r48 r">ex</span>.<span class="i">Message</span>);
                    <b>var</b> <span id="r50 rd" class="r50 r">error</span> = <b>new</b> <span class="i">ErrorRecord</span>(<b>new</b> <span class="i">InvalidOperationException</span>(<span class="r49 r">errMsg</span>), <span class="s">&quot;RestartComputerSkipped&quot;</span>,
                                                        <span class="i">ErrorCategory</span>.<span class="i">OperationStopped</span>, <span class="r40 r">computer</span>);
                    <a href="#9d8886f81af322bb" class="k">this</a>.<span class="i">WriteError</span>(<span class="r50 r">error</span>);
                }
                <b>catch</b> (<span class="i">Exception</span> <span id="r51 rd" class="r51 r">ex</span>)
                {
                    <b>string</b> <span id="r52 rd" class="r52 r">errMsg</span> = <span class="i">StringUtil</span>.<span class="i">Format</span>(<span class="i">ComputerResources</span>.<span class="i">RestartComputerSkipped</span>, <span class="r40 r">computer</span>, <span class="r51 r">ex</span>.<span class="i">Message</span>);
                    <b>var</b> <span id="r53 rd" class="r53 r">error</span> = <b>new</b> <span class="i">ErrorRecord</span>(<b>new</b> <span class="i">InvalidOperationException</span>(<span class="r52 r">errMsg</span>), <span class="s">&quot;RestartComputerSkipped&quot;</span>,
                                                        <span class="i">ErrorCategory</span>.<span class="i">OperationStopped</span>, <span class="r40 r">computer</span>);
                    <a href="#9d8886f81af322bb" class="k">this</a>.<span class="i">WriteError</span>(<span class="r53 r">error</span>);
                }
            }
 
            <b>return</b> <span class="r38 r">validComputerNameList</span>;
        }
 
        <b>private void</b> <a id="df511d705c7ecac2" href="../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">WriteOutTimeoutError</a>(<span class="i">IEnumerable</span>&lt;<b>string</b>&gt; <span id="r54 rd" class="r54 r">computerNames</span>)
        {
            <b>const string</b> <span id="r55 rd" class="r55 r">errorId</span> = <span class="s">&quot;RestartComputerTimeout&quot;</span>;
            <b>foreach</b> (<b>string</b> <span id="r56 rd" class="r56 r">computer</span> <b>in</b> <span class="r54 r">computerNames</span>)
            {
                <b>string</b> <span id="r57 rd" class="r57 r">errorMsg</span> = <span class="i">StringUtil</span>.<span class="i">Format</span>(<span class="i">ComputerResources</span>.<span class="i">RestartcomputerFailed</span>, <span class="r56 r">computer</span>, <span class="i">ComputerResources</span>.<span class="i">TimeoutError</span>);
                <a href="#151bc9100cd5488a" class="k">var</a> <span id="r58 rd" class="r58 r">exception</span> = <b>new</b> <a href="#2638e2da7e867b03" class="t constructor">RestartComputerTimeoutException</a>(<span class="r56 r">computer</span>, <a href="#4457c02c42afc7c9" class="i property">Timeout</a>, <span class="r57 r">errorMsg</span>, <span class="r55 r">errorId</span>);
                <b>var</b> <span id="r59 rd" class="r59 r">error</span> = <b>new</b> <span class="i">ErrorRecord</span>(<span class="r58 r">exception</span>, <span class="r55 r">errorId</span>, <span class="i">ErrorCategory</span>.<span class="i">OperationTimeout</span>, <span class="r56 r">computer</span>);
                <b>if</b> (!<span class="i">InternalTestHooks</span>.<span class="i">TestWaitStopComputer</span>)
                {
                    <span class="i">WriteError</span>(<span class="r59 r">error</span>);
                }
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> &quot;Private Methods&quot;
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> &quot;Internal Methods&quot;
 
        <b>internal static</b> <span class="i">List</span>&lt;<b>string</b>&gt; <a id="00f2129f34068df5" href="../../R/../../0000000000.html" target="n" data-glyph="74,1" class="i method">TestWmiConnectionUsingWsman</a>(<span class="i">List</span>&lt;<b>string</b>&gt; <span id="r60 rd" class="r60 r">computerNames</span>, <span class="i">List</span>&lt;<b>string</b>&gt; <span id="r61 rd" class="r61 r">nextTestList</span>, <span class="i">PSCredential</span> <span id="r62 rd" class="r62 r">credential</span>, <b>string</b> <span id="r63 rd" class="r63 r">wsmanAuthentication</span>, <span class="i">PSCmdlet</span> <span id="r64 rd" class="r64 r">cmdlet</span>, <span class="i">CancellationToken</span> <span id="r65 rd" class="r65 r">token</span>)
        {
            <span class="c">// Check if the WMI service &quot;Winmgmt&quot; is started</span>
            <b>const string</b> <span id="r66 rd" class="r66 r">wmiServiceQuery</span> = <span class="s">&quot;Select * from &quot;</span> + <a href="#e8bc15cd238f4de0" class="t t">ComputerWMIHelper</a>.<a href="#6c78c0d307de278d" class="i field">WMI_Class_Service</a> + <span class="s">&quot; Where name = &#39;Winmgmt&#39;&quot;</span>;
            <b>var</b> <span id="r67 rd" class="r67 r">wmiTestList</span> = <b>new</b> <span class="i">List</span>&lt;<b>string</b>&gt;();
            <b>var</b> <span id="r68 rd" class="r68 r">operationOptions</span> = <b>new</b> <span class="i">CimOperationOptions</span>
            {
                <span class="i">Timeout</span> = <span class="i">TimeSpan</span>.<span class="i">FromMilliseconds</span>(2000),
                <span class="i">CancellationToken</span> = <span class="r65 r">token</span>
            };
            <b>foreach</b> (<b>var</b> <span id="r69 rd" class="r69 r">computer</span> <b>in</b> <span class="r60 r">computerNames</span>)
            {
                <b>try</b>
                {
                    <b>if</b> (<span class="r65 r">token</span>.<span class="i">IsCancellationRequested</span>) { <b>break</b>; }
 
                    <b>using</b> (<span class="i">CimSession</span> <span id="r70 rd" class="r70 r">cimSession</span> = <span class="i">RemoteDiscoveryHelper</span>.<span class="i">CreateCimSession</span>(<span class="r69 r">computer</span>, <span class="r62 r">credential</span>, <span class="r63 r">wsmanAuthentication</span>, <span class="i">isLocalHost</span>: <b>false</b>, <span class="r64 r">cmdlet</span>, <span class="r65 r">token</span>))
                    {
                        <b>bool</b> <span id="r71 rd" class="r71 r">itemRetrieved</span> = <b>false</b>;
                        <span class="i">IEnumerable</span>&lt;<span class="i">CimInstance</span>&gt; <span id="r72 rd" class="r72 r">mCollection</span> = <span class="r70 r">cimSession</span>.<span class="i">QueryInstances</span>(
                                                                 <a href="#e8bc15cd238f4de0" class="t t">ComputerWMIHelper</a>.<a href="#651d3255d91c264e" class="i field">CimOperatingSystemNamespace</a>,
                                                                 <a href="#e8bc15cd238f4de0" class="t t">ComputerWMIHelper</a>.<a href="#0e6d68434b34bc05" class="i field">CimQueryDialect</a>,
                                                                 <span class="r66 r">wmiServiceQuery</span>,
                                                                 <span class="r68 r">operationOptions</span>);
                        <b>foreach</b> (<span class="i">CimInstance</span> <span id="r73 rd" class="r73 r">service</span> <b>in</b> <span class="r72 r">mCollection</span>)
                        {
                            <span class="r71 r">itemRetrieved</span> = <b>true</b>;
                            <b>if</b> (<span class="i">LanguagePrimitives</span>.<span class="i">IsTrue</span>(<span class="r73 r">service</span>.<span class="i">CimInstanceProperties</span>[<span class="s">&quot;Started&quot;</span>].<span class="i">Value</span>))
                            {
                                <span class="r61 r">nextTestList</span>.<span class="i">Add</span>(<span class="r69 r">computer</span>);
                            }
                            <b>else</b>
                            {
                                <span class="r67 r">wmiTestList</span>.<span class="i">Add</span>(<span class="r69 r">computer</span>);
                            }
                        }
 
                        <b>if</b> (!<span class="r71 r">itemRetrieved</span>)
                        {
                            <span class="r67 r">wmiTestList</span>.<span class="i">Add</span>(<span class="r69 r">computer</span>);
                        }
                    }
                }
                <b>catch</b> (<span class="i">CimException</span>)
                {
                    <span class="r67 r">wmiTestList</span>.<span class="i">Add</span>(<span class="r69 r">computer</span>);
                }
                <b>catch</b> (<span class="i">Exception</span>)
                {
                    <span class="r67 r">wmiTestList</span>.<span class="i">Add</span>(<span class="r69 r">computer</span>);
                }
            }
 
            <b>return</b> <span class="r67 r">wmiTestList</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Test the PowerShell state for the restarting computer.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r74 r">computerNames</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r75 r">nextTestList</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r76 r">powershell</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r77 r">credential</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal static</b> <span class="i">List</span>&lt;<b>string</b>&gt; <a id="cbab60967c14d110" href="../../R/cbab60967c14d110.html" target="n" data-glyph="74,1" class="i method">TestPowerShell</a>(<span class="i">List</span>&lt;<b>string</b>&gt; <span id="r74 rd" class="r74 r">computerNames</span>, <span class="i">List</span>&lt;<b>string</b>&gt; <span id="r75 rd" class="r75 r">nextTestList</span>, <span class="i">System</span>.<span class="i">Management</span>.<span class="i">Automation</span>.<span class="i">PowerShell</span> <span id="r76 rd" class="r76 r">powershell</span>, <span class="i">PSCredential</span> <span id="r77 rd" class="r77 r">credential</span>)
        {
            <span class="i">List</span>&lt;<b>string</b>&gt; <span id="r78 rd" class="r78 r">psList</span> = <b>new</b>();
 
            <b>try</b>
            {
                <span class="i">Collection</span>&lt;<span class="i">PSObject</span>&gt; <span id="r79 rd" class="r79 r">psObjectCollection</span> = <span class="r76 r">powershell</span>.<span class="i">Invoke</span>(<b>new</b> <b>object</b>[] { <span class="r77 r">credential</span>, <span class="r74 r">computerNames</span>.<span class="i">ToArray</span>() });
                <b>if</b> (<span class="r79 r">psObjectCollection</span> == <b>null</b>)
                {
                    <span class="i">Dbg</span>.<span class="i">Diagnostics</span>.<span class="i">Assert</span>(<b>false</b>, <span class="s">&quot;This should never happen. Invoke should never return null.&quot;</span>);
                }
 
                <span class="c">// If ^C or timeout happens when we are in powershell.Invoke(), the psObjectCollection might be empty</span>
                <b>if</b> (<span class="r79 r">psObjectCollection</span>.<span class="i">Count</span> == 0)
                {
                    <b>return</b> <span class="r74 r">computerNames</span>;
                }
 
                <b>object</b> <span id="r80 rd" class="r80 r">result</span> = <span class="i">PSObject</span>.<span class="i">Base</span>(<span class="r79 r">psObjectCollection</span>[0]);
                <span class="i">Hashtable</span> <span id="r81 rd" class="r81 r">data</span> = <span class="r80 r">result</span> <b>as</b> <span class="i">Hashtable</span>;
 
                <span class="i">Dbg</span>.<span class="i">Diagnostics</span>.<span class="i">Assert</span>(<span class="r81 r">data</span> != <b>null</b>, <span class="s">&quot;data should never be null&quot;</span>);
                <span class="i">Dbg</span>.<span class="i">Diagnostics</span>.<span class="i">Assert</span>(<span class="r81 r">data</span>.<span class="i">Count</span> == <span class="r74 r">computerNames</span>.<span class="i">Count</span>, <span class="s">&quot;data should contain results for all computers in computerNames&quot;</span>);
 
                <b>foreach</b> (<b>string</b> <span id="r82 rd" class="r82 r">computer</span> <b>in</b> <span class="r74 r">computerNames</span>)
                {
                    <b>if</b> (<span class="i">LanguagePrimitives</span>.<span class="i">IsTrue</span>(<span class="r81 r">data</span>[<span class="r82 r">computer</span>]))
                    {
                        <span class="r75 r">nextTestList</span>.<span class="i">Add</span>(<span class="r82 r">computer</span>);
                    }
                    <b>else</b>
                    {
                        <span class="r78 r">psList</span>.<span class="i">Add</span>(<span class="r82 r">computer</span>);
                    }
                }
            }
            <b>catch</b> (<span class="i">PipelineStoppedException</span>)
            {
                <span class="c">// powershell.Stop() is invoked because timeout expires, or Ctrl+C is pressed</span>
            }
            <b>catch</b> (<span class="i">ObjectDisposedException</span>)
            {
                <span class="c">// powershell.dispose() is invoked because timeout expires, or Ctrl+C is pressed</span>
            }
 
            <b>return</b> <span class="r78 r">psList</span>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> &quot;Internal Methods&quot;
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> &quot;Overrides&quot;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> BeginProcessing method.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>protected override void</b> <a id="48df6cb6b9be0e85" href="../../R/../../0000000000.html" target="n" data-glyph="75,1" class="i method">BeginProcessing</a>()
        {
            <span class="c">// Timeout, For, Delay, Progress cannot be present if Wait is not present</span>
            <b>if</b> ((<a href="#1040c67c4d21f1b8" class="i field">_timeoutSpecified</a> || <a href="#0ccd52b3dc591791" class="i field">_waitForSpecified</a> || <a href="#c1d7ed971b6468df" class="i field">_delaySpecified</a>) &amp;&amp; !<a href="#9e0c57cb19042f2f" class="i property">Wait</a>)
            {
                <span class="i">InvalidOperationException</span> <span id="r83 rd" class="r83 r">ex</span> = <b>new</b>(<span class="i">ComputerResources</span>.<span class="i">RestartComputerInvalidParameter</span>);
                <span class="i">ThrowTerminatingError</span>(<b>new</b> <span class="i">ErrorRecord</span>(<span class="r83 r">ex</span>, <span class="s">&quot;RestartComputerInvalidParameter&quot;</span>, <span class="i">ErrorCategory</span>.<span class="i">InvalidOperation</span>, <b>null</b>));
            }
 
            <b>if</b> (<a href="#9e0c57cb19042f2f" class="i property">Wait</a>)
            {
                <a href="#839a0c310235ff3b" class="i field">_activityId</a> = (<b>new</b> <span class="i">Random</span>()).<span class="i">Next</span>();
                <b>if</b> (<a href="#4d21311b1b54b6a1" class="i field">_timeout</a> == -1 || <a href="#4d21311b1b54b6a1" class="i field">_timeout</a> &gt;= <b>int</b>.<span class="i">MaxValue</span> / 1000)
                {
                    <a href="#142e036152d28fe0" class="i field">_timeoutInMilliseconds</a> = <b>int</b>.<span class="i">MaxValue</span>;
                }
                <b>else</b>
                {
                    <a href="#142e036152d28fe0" class="i field">_timeoutInMilliseconds</a> = <a href="#4d21311b1b54b6a1" class="i field">_timeout</a> * 1000;
                }
 
                <span class="c">// We don&#39;t support combined service types for now</span>
                <b>switch</b> (<a href="#777cca59aca6a36c" class="i field">_waitFor</a>)
                {
                    <b>case</b> <a href="#9f49bfaed22c5093" class="t t">WaitForServiceTypes</a>.<a href="#a3bdc9ac72498626" class="i field">Wmi</a>:
                    <b>case</b> <a href="#9f49bfaed22c5093" class="t t">WaitForServiceTypes</a>.<a href="#6fb4fd67e09ff3bb" class="i field">WinRM</a>:
                        <b>break</b>;
                    <b>case</b> <a href="#9f49bfaed22c5093" class="t t">WaitForServiceTypes</a>.<a href="#38cd456e8d907c32" class="i field">PowerShell</a>:
                        <a href="#f2e36aa9a6cc688d" class="i field">_powershell</a> = <span class="i">System</span>.<span class="i">Management</span>.<span class="i">Automation</span>.<span class="i">PowerShell</span>.<span class="i">Create</span>();
                        <a href="#f2e36aa9a6cc688d" class="i field">_powershell</a>.<span class="i">AddScript</span>(<a href="#1aeec724968d24c0" class="i field">TestPowershellScript</a>);
                        <b>break</b>;
                    <b>default</b>:
                        <span class="i">InvalidOperationException</span> <span id="r84 rd" class="r84 r">ex</span> = <b>new</b>(<span class="i">ComputerResources</span>.<span class="i">NoSupportForCombinedServiceType</span>);
                        <span class="i">ErrorRecord</span> <span id="r85 rd" class="r85 r">error</span> = <b>new</b>(<span class="r84 r">ex</span>, <span class="s">&quot;NoSupportForCombinedServiceType&quot;</span>, <span class="i">ErrorCategory</span>.<span class="i">InvalidOperation</span>, (<b>int</b>)<a href="#777cca59aca6a36c" class="i field">_waitFor</a>);
                        <span class="i">ThrowTerminatingError</span>(<span class="r85 r">error</span>);
                        <b>break</b>;
                }
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> ProcessRecord method.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Maintainability&quot;</span>, <span class="s">&quot;CA1506:AvoidExcessiveClassCoupling&quot;</span>)]
        <b>protected override void</b> <a id="183370d6a14a0b12" href="../../R/../../0000000000.html" target="n" data-glyph="75,1" class="i method">ProcessRecord</a>()
        {
            <span class="c">// Validate parameters</span>
            <a href="#cef2dd08527e8e22" class="i method">ValidateComputerNames</a>();
 
            <b>object</b>[] <span id="r86 rd" class="r86 r">flags</span> = <b>new</b> <b>object</b>[] { 2, 0 };
            <b>if</b> (<a href="#d40ac37a5487205e" class="i property">Force</a>) <span class="r86 r">flags</span>[0] = <a href="#287b8f4ee22ef046" class="i field">forcedReboot</a>;
 
            <b>if</b> (<span class="i">ParameterSetName</span>.<span class="i">Equals</span>(<a href="#f04f4bf246f41fce" class="i field">DefaultParameterSet</a>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
            {
                <b>if</b> (<a href="#9e0c57cb19042f2f" class="i property">Wait</a> &amp;&amp; <a href="#4d21311b1b54b6a1" class="i field">_timeout</a> != 0)
                {
                    <a href="#3e3ed1a0d1d55573" class="i field">_validatedComputerNames</a> =
                        <span class="i">SetUpComputerInfoUsingWsman</span>(<a href="#3e3ed1a0d1d55573" class="i field">_validatedComputerNames</a>, <a href="#067821c7b2279345" class="i field">_cancel</a>.<span class="i">Token</span>);
                }
 
                <b>foreach</b> (<b>string</b> <span id="r87 rd" class="r87 r">computer</span> <b>in</b> <a href="#3e3ed1a0d1d55573" class="i field">_validatedComputerNames</a>)
                {
                    <b>bool</b> <span id="r88 rd" class="r88 r">isLocal</span> = <b>false</b>;
                    <b>string</b> <span id="r89 rd" class="r89 r">compname</span>;
 
                    <b>if</b> (<span class="r87 r">computer</span>.<span class="i">Equals</span>(<span class="s">&quot;localhost&quot;</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
                    {
                        <span class="r89 r">compname</span> = <a href="#8375db44362efaf5" class="i field">_shortLocalMachineName</a>;
                        <span class="r88 r">isLocal</span> = <b>true</b>;
                    }
                    <b>else</b>
                    {
                        <span class="r89 r">compname</span> = <span class="r87 r">computer</span>;
                    }
 
                    <span class="c">// Generate target and action strings</span>
                    <b>string</b> <span id="r90 rd" class="r90 r">action</span> =
                        <span class="i">StringUtil</span>.<span class="i">Format</span>(
                            <span class="i">ComputerResources</span>.<span class="i">RestartComputerAction</span>,
                            <span class="r88 r">isLocal</span> ? <span class="i">ComputerResources</span>.<span class="i">LocalShutdownPrivilege</span> : <span class="i">ComputerResources</span>.<span class="i">RemoteShutdownPrivilege</span>);
                    <b>string</b> <span id="r91 rd" class="r91 r">target</span> =
                        <span class="r88 r">isLocal</span> ? <span class="i">StringUtil</span>.<span class="i">Format</span>(<span class="i">ComputerResources</span>.<span class="i">DoubleComputerName</span>, <span class="s">&quot;localhost&quot;</span>, <span class="r89 r">compname</span>) : <span class="r89 r">compname</span>;
 
                    <b>if</b> (!<span class="i">ShouldProcess</span>(<span class="r91 r">target</span>, <span class="r90 r">action</span>))
                    {
                        <b>continue</b>;
                    }
 
                    <b>bool</b> <span id="r92 rd" class="r92 r">isSuccess</span> =
                        <a href="#e8bc15cd238f4de0" class="t t">ComputerWMIHelper</a>.<span class="i">InvokeWin32ShutdownUsingWsman</span>(<a href="#9d8886f81af322bb" class="k">this</a>, <span class="r88 r">isLocal</span>, <span class="r89 r">compname</span>, <span class="r86 r">flags</span>, <a href="#c9605b14b093949f" class="i property">Credential</a>, <a href="#22602ac220715afe" class="i property">WsmanAuthentication</a>, <span class="i">ComputerResources</span>.<span class="i">RestartcomputerFailed</span>, <span class="s">&quot;RestartcomputerFailed&quot;</span>, <a href="#067821c7b2279345" class="i field">_cancel</a>.<span class="i">Token</span>);
 
                    <b>if</b> (<span class="r92 r">isSuccess</span> &amp;&amp; <a href="#9e0c57cb19042f2f" class="i property">Wait</a> &amp;&amp; <a href="#4d21311b1b54b6a1" class="i field">_timeout</a> != 0)
                    {
                        <a href="#a8af4e4c0c7b5524" class="i field">_waitOnComputers</a>.<span class="i">Add</span>(<span class="r87 r">computer</span>);
                    }
                }
 
                <b>if</b> (<a href="#a8af4e4c0c7b5524" class="i field">_waitOnComputers</a>.<span class="i">Count</span> &gt; 0)
                {
                    <b>var</b> <span id="r93 rd" class="r93 r">restartStageTestList</span> = <b>new</b> <span class="i">List</span>&lt;<b>string</b>&gt;(<a href="#a8af4e4c0c7b5524" class="i field">_waitOnComputers</a>);
                    <b>var</b> <span id="r94 rd" class="r94 r">wmiTestList</span> = <b>new</b> <span class="i">List</span>&lt;<b>string</b>&gt;();
                    <b>var</b> <span id="r95 rd" class="r95 r">winrmTestList</span> = <b>new</b> <span class="i">List</span>&lt;<b>string</b>&gt;();
                    <b>var</b> <span id="r96 rd" class="r96 r">psTestList</span> = <b>new</b> <span class="i">List</span>&lt;<b>string</b>&gt;();
                    <b>var</b> <span id="r97 rd" class="r97 r">allDoneList</span> = <b>new</b> <span class="i">List</span>&lt;<b>string</b>&gt;();
 
                    <b>bool</b> <span id="r98 rd" class="r98 r">isForWmi</span> = <a href="#777cca59aca6a36c" class="i field">_waitFor</a>.<span class="i">Equals</span>(<a href="#9f49bfaed22c5093" class="t t">WaitForServiceTypes</a>.<a href="#a3bdc9ac72498626" class="i field">Wmi</a>);
                    <b>bool</b> <span id="r99 rd" class="r99 r">isForWinRm</span> = <a href="#777cca59aca6a36c" class="i field">_waitFor</a>.<span class="i">Equals</span>(<a href="#9f49bfaed22c5093" class="t t">WaitForServiceTypes</a>.<a href="#6fb4fd67e09ff3bb" class="i field">WinRM</a>);
                    <b>bool</b> <span id="r100 rd" class="r100 r">isForPowershell</span> = <a href="#777cca59aca6a36c" class="i field">_waitFor</a>.<span class="i">Equals</span>(<a href="#9f49bfaed22c5093" class="t t">WaitForServiceTypes</a>.<a href="#38cd456e8d907c32" class="i field">PowerShell</a>);
 
                    <b>int</b> <span id="r101 rd" class="r101 r">indicatorIndex</span> = 0;
                    <b>int</b> <span id="r102 rd" class="r102 r">machineCompleteRestart</span> = 0;
                    <b>int</b> <span id="r103 rd" class="r103 r">actualDelay</span> = <a href="#a124f9b3b7bb454b" class="i field">SecondsToWaitForRestartToBegin</a>;
                    <b>bool</b> <span id="r104 rd" class="r104 r">first</span> = <b>true</b>;
                    <b>bool</b> <span id="r105 rd" class="r105 r">waitComplete</span> = <b>false</b>;
 
                    <a href="#3adbff84e0ff3c17" class="i field">_percent</a> = 0;
                    <a href="#405c69cec56d4c47" class="i field">_status</a> = <span class="i">ComputerResources</span>.<span class="i">WaitForRestartToBegin</span>;
                    <a href="#42372db3c9bfffae" class="i field">_activity</a> = <a href="#a8af4e4c0c7b5524" class="i field">_waitOnComputers</a>.<span class="i">Count</span> == 1 ?
                        <span class="i">StringUtil</span>.<span class="i">Format</span>(<span class="i">ComputerResources</span>.<span class="i">RestartSingleComputerActivity</span>, <a href="#a8af4e4c0c7b5524" class="i field">_waitOnComputers</a>[0]) :
                        <span class="i">ComputerResources</span>.<span class="i">RestartMultipleComputersActivity</span>;
 
                    <a href="#eb7b27d03284440b" class="i field">_timer</a> = <b>new</b> <span class="i">Timer</span>(<span class="i">OnTimedEvent</span>, <b>null</b>, <a href="#142e036152d28fe0" class="i field">_timeoutInMilliseconds</a>, <span class="i">System</span>.<span class="i">Threading</span>.<span class="i">Timeout</span>.<span class="i">Infinite</span>);
 
                    <b>while</b> (<b>true</b>)
                    {
                        <b>int</b> <span id="r106 rd" class="r106 r">loopCount</span> = <span class="r103 r">actualDelay</span> * 4; <span class="c">// (delay * 1000)/250ms</span>
                        <b>while</b> (<span class="r106 r">loopCount</span> &gt; 0)
                        {
                            <span class="i">WriteProgress</span>(<a href="#572a4007f69b6b2c" class="i field">_indicator</a>[(<span class="r101 r">indicatorIndex</span>++) % 4] + <a href="#42372db3c9bfffae" class="i field">_activity</a>, <a href="#405c69cec56d4c47" class="i field">_status</a>, <a href="#3adbff84e0ff3c17" class="i field">_percent</a>, <span class="i">ProgressRecordType</span>.<span class="i">Processing</span>);
 
                            <span class="r106 r">loopCount</span>--;
                            <a href="#063e9876d6da82e3" class="i field">_waitHandler</a>.<span class="i">Wait</span>(250);
                            <b>if</b> (<a href="#847e06fc16b46f47" class="i field">_exit</a>) { <b>break</b>; }
                        }
 
                        <b>if</b> (<span class="r104 r">first</span>)
                        {
                            <span class="r103 r">actualDelay</span> = <a href="#76521ceb4446723a" class="i field">_delay</a>;
                            <span class="r104 r">first</span> = <b>false</b>;
 
                            <b>if</b> (<a href="#a8af4e4c0c7b5524" class="i field">_waitOnComputers</a>.<span class="i">Count</span> &gt; 1)
                            {
                                <a href="#405c69cec56d4c47" class="i field">_status</a> = <span class="i">StringUtil</span>.<span class="i">Format</span>(<span class="i">ComputerResources</span>.<span class="i">WaitForMultipleComputers</span>, <span class="r102 r">machineCompleteRestart</span>, <a href="#a8af4e4c0c7b5524" class="i field">_waitOnComputers</a>.<span class="i">Count</span>);
                                <span class="i">WriteProgress</span>(<a href="#572a4007f69b6b2c" class="i field">_indicator</a>[(<span class="r101 r">indicatorIndex</span>++) % 4] + <a href="#42372db3c9bfffae" class="i field">_activity</a>, <a href="#405c69cec56d4c47" class="i field">_status</a>, <a href="#3adbff84e0ff3c17" class="i field">_percent</a>, <span class="i">ProgressRecordType</span>.<span class="i">Processing</span>);
                            }
                        }
 
                        <b>do</b>
                        {
                            <span class="c">// Test restart stage.</span>
                            <span class="c">// We check if the target machine has already rebooted by querying the LastBootUpTime from the Win32_OperatingSystem object.</span>
                            <span class="c">// So after this step, we are sure that both the Network and the WMI or WinRM service have already come up.</span>
                            <b>if</b> (<a href="#847e06fc16b46f47" class="i field">_exit</a>) { <b>break</b>; }
 
                            <b>if</b> (<span class="r93 r">restartStageTestList</span>.<span class="i">Count</span> &gt; 0)
                            {
                                <b>if</b> (<a href="#a8af4e4c0c7b5524" class="i field">_waitOnComputers</a>.<span class="i">Count</span> == 1)
                                {
                                    <a href="#405c69cec56d4c47" class="i field">_status</a> = <span class="i">ComputerResources</span>.<span class="i">VerifyRebootStage</span>;
                                    <a href="#3adbff84e0ff3c17" class="i field">_percent</a> = <a href="#973c198d4e5342f3" class="i method">CalculateProgressPercentage</a>(<a href="#be86b083c58ac8ca" class="i field">StageVerification</a>);
                                    <span class="i">WriteProgress</span>(<a href="#572a4007f69b6b2c" class="i field">_indicator</a>[(<span class="r101 r">indicatorIndex</span>++) % 4] + <a href="#42372db3c9bfffae" class="i field">_activity</a>, <a href="#405c69cec56d4c47" class="i field">_status</a>, <a href="#3adbff84e0ff3c17" class="i field">_percent</a>, <span class="i">ProgressRecordType</span>.<span class="i">Processing</span>);
                                }
 
                                <span class="i">List</span>&lt;<b>string</b>&gt; <span id="r107 rd" class="r107 r">nextTestList</span> = (<span class="r98 r">isForWmi</span> || <span class="r100 r">isForPowershell</span>) ? <span class="r94 r">wmiTestList</span> : <span class="r95 r">winrmTestList</span>;
                                <span class="r93 r">restartStageTestList</span> = <span class="i">TestRestartStageUsingWsman</span>(<span class="r93 r">restartStageTestList</span>, <span class="r107 r">nextTestList</span>, <a href="#067821c7b2279345" class="i field">_cancel</a>.<span class="i">Token</span>);
                            }
 
                            <span class="c">// Test WMI service</span>
                            <b>if</b> (<a href="#847e06fc16b46f47" class="i field">_exit</a>) { <b>break</b>; }
 
                            <b>if</b> (<span class="r94 r">wmiTestList</span>.<span class="i">Count</span> &gt; 0)
                            {
                                <span class="c">// This statement block executes for both CLRs.</span>
                                <span class="c">// In the &quot;full&quot; CLR, it serves as the else case.</span>
                                {
                                    <b>if</b> (<a href="#a8af4e4c0c7b5524" class="i field">_waitOnComputers</a>.<span class="i">Count</span> == 1)
                                    {
                                        <a href="#405c69cec56d4c47" class="i field">_status</a> = <span class="i">ComputerResources</span>.<span class="i">WaitForWMI</span>;
                                        <a href="#3adbff84e0ff3c17" class="i field">_percent</a> = <a href="#973c198d4e5342f3" class="i method">CalculateProgressPercentage</a>(<a href="#04f726ec2685ba84" class="i field">WmiConnectionTest</a>);
                                        <span class="i">WriteProgress</span>(<a href="#572a4007f69b6b2c" class="i field">_indicator</a>[(<span class="r101 r">indicatorIndex</span>++) % 4] + <a href="#42372db3c9bfffae" class="i field">_activity</a>, <a href="#405c69cec56d4c47" class="i field">_status</a>, <a href="#3adbff84e0ff3c17" class="i field">_percent</a>, <span class="i">ProgressRecordType</span>.<span class="i">Processing</span>);
                                    }
 
                                    <span class="r94 r">wmiTestList</span> = <span class="i">TestWmiConnectionUsingWsman</span>(<span class="r94 r">wmiTestList</span>, <span class="r95 r">winrmTestList</span>, <a href="#c9605b14b093949f" class="i property">Credential</a>, <a href="#22602ac220715afe" class="i property">WsmanAuthentication</a>, <a href="#9d8886f81af322bb" class="k">this</a>, <a href="#067821c7b2279345" class="i field">_cancel</a>.<span class="i">Token</span>);
                                }
                            }
 
                            <b>if</b> (<span class="r98 r">isForWmi</span>) { <b>break</b>; }
 
                            <span class="c">// Test WinRM service</span>
                            <b>if</b> (<a href="#847e06fc16b46f47" class="i field">_exit</a>) { <b>break</b>; }
 
                            <b>if</b> (<span class="r95 r">winrmTestList</span>.<span class="i">Count</span> &gt; 0)
                            {
                                <span class="c">// This statement block executes for both CLRs.</span>
                                <span class="c">// In the &quot;full&quot; CLR, it serves as the else case.</span>
                                {
                                    <span class="c">// CIM-WSMan in use. In this case, restart stage checking is done by using WMIv2,</span>
                                    <span class="c">// so the WinRM service on the target machine is already up at this point.</span>
                                    <span class="r96 r">psTestList</span>.<span class="i">AddRange</span>(<span class="r95 r">winrmTestList</span>);
                                    <span class="r95 r">winrmTestList</span>.<span class="i">Clear</span>();
 
                                    <b>if</b> (<a href="#a8af4e4c0c7b5524" class="i field">_waitOnComputers</a>.<span class="i">Count</span> == 1)
                                    {
                                        <span class="c">// This is to simulate the test for WinRM service</span>
                                        <a href="#405c69cec56d4c47" class="i field">_status</a> = <span class="i">ComputerResources</span>.<span class="i">WaitForWinRM</span>;
                                        <a href="#3adbff84e0ff3c17" class="i field">_percent</a> = <a href="#973c198d4e5342f3" class="i method">CalculateProgressPercentage</a>(<a href="#f7952679c7d43101" class="i field">WinrmConnectionTest</a>);
 
                                        <span class="r106 r">loopCount</span> = <span class="r103 r">actualDelay</span> * 4; <span class="c">// (delay * 1000)/250ms</span>
                                        <b>while</b> (<span class="r106 r">loopCount</span> &gt; 0)
                                        {
                                            <span class="i">WriteProgress</span>(<a href="#572a4007f69b6b2c" class="i field">_indicator</a>[(<span class="r101 r">indicatorIndex</span>++) % 4] + <a href="#42372db3c9bfffae" class="i field">_activity</a>, <a href="#405c69cec56d4c47" class="i field">_status</a>, <a href="#3adbff84e0ff3c17" class="i field">_percent</a>, <span class="i">ProgressRecordType</span>.<span class="i">Processing</span>);
 
                                            <span class="r106 r">loopCount</span>--;
                                            <a href="#063e9876d6da82e3" class="i field">_waitHandler</a>.<span class="i">Wait</span>(250);
                                            <b>if</b> (<a href="#847e06fc16b46f47" class="i field">_exit</a>) { <b>break</b>; }
                                        }
                                    }
                                }
                            }
 
                            <b>if</b> (<span class="r99 r">isForWinRm</span>) { <b>break</b>; }
 
                            <span class="c">// Test PowerShell</span>
                            <b>if</b> (<a href="#847e06fc16b46f47" class="i field">_exit</a>) { <b>break</b>; }
 
                            <b>if</b> (<span class="r96 r">psTestList</span>.<span class="i">Count</span> &gt; 0)
                            {
                                <b>if</b> (<a href="#a8af4e4c0c7b5524" class="i field">_waitOnComputers</a>.<span class="i">Count</span> == 1)
                                {
                                    <a href="#405c69cec56d4c47" class="i field">_status</a> = <span class="i">ComputerResources</span>.<span class="i">WaitForPowerShell</span>;
                                    <a href="#3adbff84e0ff3c17" class="i field">_percent</a> = <a href="#973c198d4e5342f3" class="i method">CalculateProgressPercentage</a>(<a href="#abf9e5b73466d196" class="i field">PowerShellConnectionTest</a>);
                                    <span class="i">WriteProgress</span>(<a href="#572a4007f69b6b2c" class="i field">_indicator</a>[(<span class="r101 r">indicatorIndex</span>++) % 4] + <a href="#42372db3c9bfffae" class="i field">_activity</a>, <a href="#405c69cec56d4c47" class="i field">_status</a>, <a href="#3adbff84e0ff3c17" class="i field">_percent</a>, <span class="i">ProgressRecordType</span>.<span class="i">Processing</span>);
                                }
 
                                <span class="r96 r">psTestList</span> = <a href="#cbab60967c14d110" class="i method">TestPowerShell</a>(<span class="r96 r">psTestList</span>, <span class="r97 r">allDoneList</span>, <a href="#f2e36aa9a6cc688d" class="i field">_powershell</a>, <a href="#9d8886f81af322bb" class="k">this</a>.<a href="#c9605b14b093949f" class="i property">Credential</a>);
                            }
                        } <b>while</b> (<b>false</b>);
 
                        <span class="c">// if time is up or Ctrl+c is typed, break out</span>
                        <b>if</b> (<a href="#847e06fc16b46f47" class="i field">_exit</a>) { <b>break</b>; }
 
                        <span class="c">// Check if the restart completes</span>
                        <b>switch</b> (<a href="#777cca59aca6a36c" class="i field">_waitFor</a>)
                        {
                            <b>case</b> <a href="#9f49bfaed22c5093" class="t t">WaitForServiceTypes</a>.<a href="#a3bdc9ac72498626" class="i field">Wmi</a>:
                                <span class="r105 r">waitComplete</span> = (<span class="r95 r">winrmTestList</span>.<span class="i">Count</span> == <a href="#a8af4e4c0c7b5524" class="i field">_waitOnComputers</a>.<span class="i">Count</span>);
                                <span class="r102 r">machineCompleteRestart</span> = <span class="r95 r">winrmTestList</span>.<span class="i">Count</span>;
                                <b>break</b>;
                            <b>case</b> <a href="#9f49bfaed22c5093" class="t t">WaitForServiceTypes</a>.<a href="#6fb4fd67e09ff3bb" class="i field">WinRM</a>:
                                <span class="r105 r">waitComplete</span> = (<span class="r96 r">psTestList</span>.<span class="i">Count</span> == <a href="#a8af4e4c0c7b5524" class="i field">_waitOnComputers</a>.<span class="i">Count</span>);
                                <span class="r102 r">machineCompleteRestart</span> = <span class="r96 r">psTestList</span>.<span class="i">Count</span>;
                                <b>break</b>;
                            <b>case</b> <a href="#9f49bfaed22c5093" class="t t">WaitForServiceTypes</a>.<a href="#38cd456e8d907c32" class="i field">PowerShell</a>:
                                <span class="r105 r">waitComplete</span> = (<span class="r97 r">allDoneList</span>.<span class="i">Count</span> == <a href="#a8af4e4c0c7b5524" class="i field">_waitOnComputers</a>.<span class="i">Count</span>);
                                <span class="r102 r">machineCompleteRestart</span> = <span class="r97 r">allDoneList</span>.<span class="i">Count</span>;
                                <b>break</b>;
                        }
 
                        <span class="c">// Wait is done or time is up</span>
                        <b>if</b> (<span class="r105 r">waitComplete</span> || <a href="#847e06fc16b46f47" class="i field">_exit</a>)
                        {
                            <b>if</b> (<span class="r105 r">waitComplete</span>)
                            {
                                <a href="#405c69cec56d4c47" class="i field">_status</a> = <span class="i">ComputerResources</span>.<span class="i">RestartComplete</span>;
                                <span class="i">WriteProgress</span>(<a href="#572a4007f69b6b2c" class="i field">_indicator</a>[<span class="r101 r">indicatorIndex</span> % 4] + <a href="#42372db3c9bfffae" class="i field">_activity</a>, <a href="#405c69cec56d4c47" class="i field">_status</a>, 100, <span class="i">ProgressRecordType</span>.<span class="i">Completed</span>);
                                <a href="#eb7b27d03284440b" class="i field">_timer</a>.<span class="i">Change</span>(<span class="i">System</span>.<span class="i">Threading</span>.<span class="i">Timeout</span>.<span class="i">Infinite</span>, <span class="i">System</span>.<span class="i">Threading</span>.<span class="i">Timeout</span>.<span class="i">Infinite</span>);
                            }
 
                            <b>break</b>;
                        }
 
                        <b>if</b> (<a href="#a8af4e4c0c7b5524" class="i field">_waitOnComputers</a>.<span class="i">Count</span> &gt; 1)
                        {
                            <a href="#405c69cec56d4c47" class="i field">_status</a> = <span class="i">StringUtil</span>.<span class="i">Format</span>(<span class="i">ComputerResources</span>.<span class="i">WaitForMultipleComputers</span>, <span class="r102 r">machineCompleteRestart</span>, <a href="#a8af4e4c0c7b5524" class="i field">_waitOnComputers</a>.<span class="i">Count</span>);
                            <a href="#3adbff84e0ff3c17" class="i field">_percent</a> = <span class="r102 r">machineCompleteRestart</span> * 100 / <a href="#a8af4e4c0c7b5524" class="i field">_waitOnComputers</a>.<span class="i">Count</span>;
                        }
                    }
 
                    <b>if</b> (<a href="#dd01ee4445285ea8" class="i field">_timeUp</a>)
                    {
                        <span class="c">// The timeout expires. Write out timeout error messages for the computers that haven&#39;t finished restarting</span>
                        <b>do</b>
                        {
                            <b>if</b> (<span class="r93 r">restartStageTestList</span>.<span class="i">Count</span> &gt; 0) { <span class="i">WriteOutTimeoutError</span>(<span class="r93 r">restartStageTestList</span>); }
 
                            <b>if</b> (<span class="r94 r">wmiTestList</span>.<span class="i">Count</span> &gt; 0) { <span class="i">WriteOutTimeoutError</span>(<span class="r94 r">wmiTestList</span>); }
                            <span class="c">// Wait for WMI. All computers that finished restarting are put in &quot;winrmTestList&quot;</span>
                            <b>if</b> (<span class="r98 r">isForWmi</span>) { <b>break</b>; }
 
                            <span class="c">// Wait for WinRM. All computers that finished restarting are put in &quot;psTestList&quot;</span>
                            <b>if</b> (<span class="r95 r">winrmTestList</span>.<span class="i">Count</span> &gt; 0) { <span class="i">WriteOutTimeoutError</span>(<span class="r95 r">winrmTestList</span>); }
 
                            <b>if</b> (<span class="r99 r">isForWinRm</span>) { <b>break</b>; }
 
                            <b>if</b> (<span class="r96 r">psTestList</span>.<span class="i">Count</span> &gt; 0) { <span class="i">WriteOutTimeoutError</span>(<span class="r96 r">psTestList</span>); }
                            <span class="c">// Wait for PowerShell. All computers that finished restarting are put in &quot;allDoneList&quot;</span>
                        } <b>while</b> (<b>false</b>);
                    }
                }
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> To implement ^C.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>protected override void</b> <a id="51b063de678726e6" href="../../R/../../0000000000.html" target="n" data-glyph="75,1" class="i method">StopProcessing</a>()
        {
            <a href="#847e06fc16b46f47" class="i field">_exit</a> = <b>true</b>;
            <a href="#067821c7b2279345" class="i field">_cancel</a>.<span class="i">Cancel</span>();
            <a href="#063e9876d6da82e3" class="i field">_waitHandler</a>.<span class="i">Set</span>();
 
            <b>if</b> (<a href="#eb7b27d03284440b" class="i field">_timer</a> != <b>null</b>)
            {
                <a href="#eb7b27d03284440b" class="i field">_timer</a>.<span class="i">Change</span>(<span class="i">System</span>.<span class="i">Threading</span>.<span class="i">Timeout</span>.<span class="i">Infinite</span>, <span class="i">System</span>.<span class="i">Threading</span>.<span class="i">Timeout</span>.<span class="i">Infinite</span>);
            }
 
            <b>if</b> (<a href="#f2e36aa9a6cc688d" class="i field">_powershell</a> != <b>null</b>)
            {
                <a href="#f2e36aa9a6cc688d" class="i field">_powershell</a>.<span class="i">Stop</span>();
                <a href="#f2e36aa9a6cc688d" class="i field">_powershell</a>.<span class="i">Dispose</span>();
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> &quot;Overrides&quot;
    }
 
    <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Restart-Computer
 
    <span class="k preprocess">#</span><span class="k preprocess">region</span> Stop-Computer
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Cmdlet to stop computer.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    [<span class="i">Cmdlet</span>(<span class="i">VerbsLifecycle</span>.<span class="i">Stop</span>, <span class="s">&quot;Computer&quot;</span>, <span class="i">SupportsShouldProcess</span> = <b>true</b>,
        <span class="i">HelpUri</span> = <span class="s">&quot;https://go.microsoft.com/fwlink/?LinkID=2097151&quot;</span>, <span class="i">RemotingCapability</span> = <span class="i">RemotingCapability</span>.<span class="i">SupportedByCommand</span>)]
    <b>public sealed class</b> <a id="54c02f08d9390701" href="../../R/../../0000000000.html" target="n" data-glyph="0,0" class="t t"><span id="42439b1463ed2ceb">StopComputerCommand</span></a> : <span class="i">PSCmdlet</span>, <span class="i">IDisposable</span>
    {
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Private Members
 
        <b>private readonly</b> <span class="i">CancellationTokenSource</span> <a id="db319ba71783c0f3" href="../../R/db319ba71783c0f3.html" target="n" data-glyph="46,1" class="i field">_cancel</a> = <b>new</b>();
 
        <b>private const int</b> <a id="77010816eb89e136" href="../../R/77010816eb89e136.html" target="n" data-glyph="10,1" class="i field">forcedShutdown</a> = 5; <span class="c">// See https://msdn.microsoft.com/library/aa394058(v=vs.85).aspx</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> &quot;Parameters&quot;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The authentication options for CIM_WSMan connection.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>]
        [<span class="i">ValidateSet</span>(
            <span class="s">&quot;Default&quot;</span>,
            <span class="s">&quot;Basic&quot;</span>,
            <span class="s">&quot;Negotiate&quot;</span>, <span class="c">// can be used with and without credential (without -&gt; PSRP mapped to NegotiateWithImplicitCredential)</span>
            <span class="s">&quot;CredSSP&quot;</span>,
            <span class="s">&quot;Digest&quot;</span>,
            <span class="s">&quot;Kerberos&quot;</span>)] <span class="c">// can be used with explicit or implicit credential</span>
        [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Naming&quot;</span>, <span class="s">&quot;CA1704:IdentifiersShouldBeSpelledCorrectly&quot;</span>)]
        <b>public string</b> <a id="3df9336ef50a26db" href="../../R/3df9336ef50a26db.html" target="n" data-glyph="102,1" class="i property">WsmanAuthentication</a> { <b>get</b>; <b>set</b>; } = <span class="s">&quot;Default&quot;</span>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The following is the definition of the input parameter &quot;ComputerName&quot;.</span>
        <span class="c">///</span><span class="c"> Value of the address requested. The form of the value can be either the</span>
        <span class="c">///</span><span class="c"> computer name (&quot;wxyz1234&quot;), IPv4 address (&quot;192.168.177.124&quot;), or IPv6</span>
        <span class="c">///</span><span class="c"> address (&quot;2010:836B:4179::836B:4179&quot;).</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>(<span class="i">Position</span> = 0, <span class="i">ValueFromPipelineByPropertyName</span> = <b>true</b>)]
        [<span class="i">ValidateNotNullOrEmpty</span>]
        [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Performance&quot;</span>, <span class="s">&quot;CA1819:PropertiesShouldNotReturnArrays&quot;</span>)]
        [<span class="i">Alias</span>(<span class="s">&quot;CN&quot;</span>, <span class="s">&quot;__SERVER&quot;</span>, <span class="s">&quot;Server&quot;</span>, <span class="s">&quot;IPAddress&quot;</span>)]
        <b>public string</b>[] <a id="0a0cccf183c5cdb8" href="../../R/0a0cccf183c5cdb8.html" target="n" data-glyph="102,1" class="i property">ComputerName</a> { <b>get</b>; <b>set</b>; } = <b>new</b> <b>string</b>[] { <span class="s">&quot;.&quot;</span> };
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The following is the definition of the input parameter &quot;Credential&quot;.</span>
        <span class="c">///</span><span class="c"> Specifies a user account that has permission to perform this action. Type a</span>
        <span class="c">///</span><span class="c"> user-name, such as &quot;User01&quot; or &quot;Domain01\User01&quot;, or enter a PSCredential</span>
        <span class="c">///</span><span class="c"> object, such as one from the Get-Credential cmdlet.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>(<span class="i">Position</span> = 1)]
        [<span class="i">ValidateNotNullOrEmpty</span>]
        [<span class="i">Credential</span>]
        <b>public</b> <span class="i">PSCredential</span> <a id="32871d94dd761f0d" href="../../R/32871d94dd761f0d.html" target="n" data-glyph="102,1" class="i property">Credential</a> { <b>get</b>; <b>set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Force the operation to take place if possible.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>]
        <b>public</b> <span class="i">SwitchParameter</span> <a id="570599c5a2722e05" href="../../R/570599c5a2722e05.html" target="n" data-glyph="102,1" class="i property">Force</a> { <b>get</b>; <b>set</b>; } = <b>false</b>;
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> &quot;parameters&quot;
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> &quot;IDisposable Members&quot;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Dispose Method.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public void</b> <a id="687fdb3eaa924f5c" href="../../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">Dispose</a>()
        {
            <a href="#db319ba71783c0f3" class="i field">_cancel</a>.<span class="i">Dispose</span>();
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> &quot;IDisposable Members&quot;
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> &quot;Overrides&quot;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> ProcessRecord.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Maintainability&quot;</span>, <span class="s">&quot;CA1506:AvoidExcessiveClassCoupling&quot;</span>)]
        <b>protected override void</b> <a id="8ccc25a984bfb33b" href="../../R/../../0000000000.html" target="n" data-glyph="75,1" class="i method">ProcessRecord</a>()
        {
            <b>object</b>[] <span id="r108 rd" class="r108 r">flags</span> = <b>new</b> <b>object</b>[] { 1, 0 };
            <b>if</b> (<a href="#570599c5a2722e05" class="i property">Force</a>.<span class="i">IsPresent</span>)
                <span class="r108 r">flags</span>[0] = <a href="#77010816eb89e136" class="i field">forcedShutdown</a>;
 
            <a href="#3b3d3ed4167c1b8b" class="i method">ProcessWSManProtocol</a>(<span class="r108 r">flags</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> To implement ^C.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>protected override void</b> <a id="9e0017bfd6e534a9" href="../../R/../../0000000000.html" target="n" data-glyph="75,1" class="i method">StopProcessing</a>()
        {
            <b>try</b>
            {
                <a href="#db319ba71783c0f3" class="i field">_cancel</a>.<span class="i">Cancel</span>();
            }
            <b>catch</b> (<span class="i">ObjectDisposedException</span>) { }
            <b>catch</b> (<span class="i">AggregateException</span>) { }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> &quot;Overrides&quot;
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Private Methods
 
        <b>private void</b> <a id="3b3d3ed4167c1b8b" href="../../R/3b3d3ed4167c1b8b.html" target="n" data-glyph="76,1" class="i method">ProcessWSManProtocol</a>(<b>object</b>[] <span id="r109 rd" class="r109 r">flags</span>)
        {
            <b>foreach</b> (<b>string</b> <span id="r110 rd" class="r110 r">computer</span> <b>in</b> <a href="#0a0cccf183c5cdb8" class="i property">ComputerName</a>)
            {
                <b>string</b> <span id="r111 rd" class="r111 r">compname</span> = <b>string</b>.<span class="i">Empty</span>;
                <b>string</b> <span id="r112 rd" class="r112 r">strLocal</span> = <b>string</b>.<span class="i">Empty</span>;
                <b>bool</b> <span id="r113 rd" class="r113 r">isLocalHost</span> = <b>false</b>;
 
                <b>if</b> (<a href="#db319ba71783c0f3" class="i field">_cancel</a>.<span class="i">Token</span>.<span class="i">IsCancellationRequested</span>) { <b>break</b>; }
 
                <b>if</b> ((<span class="r110 r">computer</span>.<span class="i">Equals</span>(<span class="s">&quot;localhost&quot;</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>)) || (<span class="r110 r">computer</span>.<span class="i">Equals</span>(<span class="s">&quot;.&quot;</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>)))
                {
                    <span class="r111 r">compname</span> = <span class="i">Dns</span>.<span class="i">GetHostName</span>();
                    <span class="r112 r">strLocal</span> = <span class="s">&quot;localhost&quot;</span>;
                    <span class="r113 r">isLocalHost</span> = <b>true</b>;
                }
                <b>else</b>
                {
                    <span class="r111 r">compname</span> = <span class="r110 r">computer</span>;
                }
 
                <b>if</b> (!<span class="i">ShouldProcess</span>(<span class="i">StringUtil</span>.<span class="i">Format</span>(<span class="i">ComputerResources</span>.<span class="i">DoubleComputerName</span>, <span class="r112 r">strLocal</span>, <span class="r111 r">compname</span>)))
                {
                    <b>continue</b>;
                }
                <b>else</b>
                {
                    <a href="#e8bc15cd238f4de0" class="t t">ComputerWMIHelper</a>.<span class="i">InvokeWin32ShutdownUsingWsman</span>(
                        <a href="#54c02f08d9390701" class="k">this</a>,
                        <span class="r113 r">isLocalHost</span>,
                        <span class="r111 r">compname</span>,
                        <span class="r109 r">flags</span>,
                        <a href="#32871d94dd761f0d" class="i property">Credential</a>,
                        <a href="#3df9336ef50a26db" class="i property">WsmanAuthentication</a>,
                        <span class="i">ComputerResources</span>.<span class="i">StopcomputerFailed</span>,
                        <span class="s">&quot;StopComputerException&quot;</span>,
                        <a href="#db319ba71783c0f3" class="i field">_cancel</a>.<span class="i">Token</span>);
                }
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
    }
 
    <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
    <span class="k preprocess">#</span><span class="k preprocess">region</span> Rename-Computer
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Renames a domain computer and its corresponding domain account or a</span>
    <span class="c">///</span><span class="c"> workgroup computer. Use this command to rename domain workstations and local</span>
    <span class="c">///</span><span class="c"> machines only. It cannot be used to rename Domain Controllers.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    [<span class="i">Cmdlet</span>(<span class="i">VerbsCommon</span>.<span class="i">Rename</span>, <span class="s">&quot;Computer&quot;</span>, <span class="i">SupportsShouldProcess</span> = <b>true</b>,
        <span class="i">HelpUri</span> = <span class="s">&quot;https://go.microsoft.com/fwlink/?LinkID=2097054&quot;</span>, <span class="i">RemotingCapability</span> = <span class="i">RemotingCapability</span>.<span class="i">SupportedByCommand</span>)]
    <b>public class</b> <a id="a56ea633e09bdd1d" href="../../R/../../0000000000.html" target="n" data-glyph="0,0" class="t t"><span id="ad68d6b67b46f943">RenameComputerCommand</span></a> : <span class="i">PSCmdlet</span>
    {
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Private Members
 
        <b>private bool</b> <a id="a19c9b5254e6ef77" href="../../R/a19c9b5254e6ef77.html" target="n" data-glyph="46,1" class="i field">_containsLocalHost</a> = <b>false</b>;
        <b>private string</b> <a id="a6fe3a99b9b826de" href="../../R/a6fe3a99b9b826de.html" target="n" data-glyph="46,1" class="i field">_newNameForLocalHost</a> = <b>null</b>;
 
        <b>private readonly string</b> <a id="3a12b36efbe8f4d0" href="../../R/3a12b36efbe8f4d0.html" target="n" data-glyph="46,1" class="i field">_shortLocalMachineName</a> = <span class="i">Dns</span>.<span class="i">GetHostName</span>();
        <b>private readonly string</b> <a id="8ebd25abffb25d37" href="../../R/8ebd25abffb25d37.html" target="n" data-glyph="46,1" class="i field">_fullLocalMachineName</a> = <span class="i">Dns</span>.<span class="i">GetHostEntryAsync</span>(<b>string</b>.<span class="i">Empty</span>).<span class="i">Result</span>.<span class="i">HostName</span>;
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Parameters
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Target computers to rename.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>(<span class="i">ValueFromPipelineByPropertyName</span> = <b>true</b>)]
        [<span class="i">ValidateNotNullOrEmpty</span>]
        <b>public string</b> <a id="ec8aa0301a7011fc" href="../../R/ec8aa0301a7011fc.html" target="n" data-glyph="102,1" class="i property">ComputerName</a> { <b>get</b>; <b>set</b>; } = <span class="s">&quot;localhost&quot;</span>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Emit the output.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">// [Alias(&quot;Restart&quot;)]</span>
        [<span class="i">Parameter</span>]
        <b>public</b> <span class="i">SwitchParameter</span> <a id="0644c52672e22d21" href="../../R/0644c52672e22d21.html" target="n" data-glyph="102,1" class="i property">PassThru</a> { <b>get</b>; <b>set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The domain credential of the domain the target computer joined.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>]
        [<span class="i">ValidateNotNullOrEmpty</span>]
        [<span class="i">Credential</span>]
        <b>public</b> <span class="i">PSCredential</span> <a id="052abfa0a82e6859" href="../../R/052abfa0a82e6859.html" target="n" data-glyph="102,1" class="i property">DomainCredential</a> { <b>get</b>; <b>set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The administrator credential of the target computer.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>]
        [<span class="i">ValidateNotNullOrEmpty</span>]
        [<span class="i">Credential</span>]
        <b>public</b> <span class="i">PSCredential</span> <a id="33da7be8bd51449a" href="../../R/33da7be8bd51449a.html" target="n" data-glyph="102,1" class="i property">LocalCredential</a> { <b>get</b>; <b>set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> New names for the target computers.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>(<span class="i">Mandatory</span> = <b>true</b>, <span class="i">Position</span> = 0, <span class="i">ValueFromPipelineByPropertyName</span> = <b>true</b>)]
        [<span class="i">ValidateNotNullOrEmpty</span>]
        <b>public string</b> <a id="4112fab2d971372f" href="../../R/4112fab2d971372f.html" target="n" data-glyph="102,1" class="i property">NewName</a> { <b>get</b>; <b>set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Suppress the ShouldContinue.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>]
        <b>public</b> <span class="i">SwitchParameter</span> <a id="fe243bea799919a9" href="../../R/fe243bea799919a9.html" target="n" data-glyph="102,1" class="i property">Force</a>
        {
            <b>get</b> { <b>return</b> <a href="#4440611b7070dd41" class="i field">_force</a>; }
 
            <b>set</b> { <a href="#4440611b7070dd41" class="i field">_force</a> = <b>value</b>; }
        }
 
        <b>private bool</b> <a id="4440611b7070dd41" href="../../R/4440611b7070dd41.html" target="n" data-glyph="46,1" class="i field">_force</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> To restart the target computer after rename it.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>]
        <b>public</b> <span class="i">SwitchParameter</span> <a id="b4fb49fa80a9a1f5" href="../../R/../../0000000000.html" target="n" data-glyph="102,1" class="i property">Restart</a>
        {
            <b>get</b> { <b>return</b> <a href="#17d4fb5583e5a920" class="i field">_restart</a>; }
 
            <b>set</b> { <a href="#17d4fb5583e5a920" class="i field">_restart</a> = <b>value</b>; }
        }
 
        <b>private bool</b> <a id="17d4fb5583e5a920" href="../../R/17d4fb5583e5a920.html" target="n" data-glyph="46,1" class="i field">_restart</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The authentication options for CIM_WSMan connection.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>]
        [<span class="i">ValidateSet</span>(
            <span class="s">&quot;Default&quot;</span>,
            <span class="s">&quot;Basic&quot;</span>,
            <span class="s">&quot;Negotiate&quot;</span>, <span class="c">// can be used with and without credential (without -&gt; PSRP mapped to NegotiateWithImplicitCredential)</span>
            <span class="s">&quot;CredSSP&quot;</span>,
            <span class="s">&quot;Digest&quot;</span>,
            <span class="s">&quot;Kerberos&quot;</span>)] <span class="c">// can be used with implicit or explicit credential</span>
        [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Naming&quot;</span>, <span class="s">&quot;CA1704:IdentifiersShouldBeSpelledCorrectly&quot;</span>)]
        <b>public string</b> <a id="0cd8d0116181a277" href="../../R/0cd8d0116181a277.html" target="n" data-glyph="102,1" class="i property">WsmanAuthentication</a> { <b>get</b>; <b>set</b>; } = <span class="s">&quot;Default&quot;</span>;
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> &quot;Private Methods&quot;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Check to see if the target computer is the local machine.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private string</b> <a id="d0972da7668e1d3b" href="../../R/d0972da7668e1d3b.html" target="n" data-glyph="76,1" class="i method">ValidateComputerName</a>()
        {
            <span class="c">// Validate target name.</span>
            <span class="i">ErrorRecord</span> <span id="r114 rd" class="r114 r">targetError</span> = <b>null</b>;
            <b>string</b> <span id="r115 rd" class="r115 r">targetComputer</span> = <a href="#e8bc15cd238f4de0" class="t t">ComputerWMIHelper</a>.<a href="#63c511374ea180c9" class="i method">ValidateComputerName</a>(<a href="#ec8aa0301a7011fc" class="i property">ComputerName</a>, <a href="#3a12b36efbe8f4d0" class="i field">_shortLocalMachineName</a>, <a href="#8ebd25abffb25d37" class="i field">_fullLocalMachineName</a>, <b>ref</b> <span class="r114 r">targetError</span>);
            <b>if</b> (<span class="r115 r">targetComputer</span> == <b>null</b>)
            {
                <b>if</b> (<span class="r114 r">targetError</span> != <b>null</b>)
                {
                    <span class="i">WriteError</span>(<span class="r114 r">targetError</span>);
                }
 
                <b>return</b> <b>null</b>;
            }
 
            <span class="c">// Validate *new* name. Validate the format of the new name. Check if the old name is the same as the</span>
            <span class="c">// new name later.</span>
            <b>if</b> (!<a href="#e8bc15cd238f4de0" class="t t">ComputerWMIHelper</a>.<a href="#aa12934cc51159ea" class="i method">IsComputerNameValid</a>(<a href="#4112fab2d971372f" class="i property">NewName</a>))
            {
                <b>bool</b> <span id="r116 rd" class="r116 r">isLocalhost</span> = <span class="r115 r">targetComputer</span>.<span class="i">Equals</span>(<a href="#e8bc15cd238f4de0" class="t t">ComputerWMIHelper</a>.<a href="#f343d6c6559c69a3" class="i field">localhostStr</a>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>);
                <b>string</b> <span id="r117 rd" class="r117 r">errMsg</span> = <span class="i">StringUtil</span>.<span class="i">Format</span>(<span class="i">ComputerResources</span>.<span class="i">InvalidNewName</span>, <span class="r116 r">isLocalhost</span> ? <a href="#3a12b36efbe8f4d0" class="i field">_shortLocalMachineName</a> : <span class="r115 r">targetComputer</span>, <a href="#4112fab2d971372f" class="i property">NewName</a>);
                <span class="i">ErrorRecord</span> <span id="r118 rd" class="r118 r">error</span> = <b>new</b>(
                        <b>new</b> <span class="i">InvalidOperationException</span>(<span class="r117 r">errMsg</span>), <span class="s">&quot;InvalidNewName&quot;</span>,
                        <span class="i">ErrorCategory</span>.<span class="i">InvalidArgument</span>, <a href="#4112fab2d971372f" class="i property">NewName</a>);
                <span class="i">WriteError</span>(<span class="r118 r">error</span>);
                <b>return</b> <b>null</b>;
            }
 
            <b>return</b> <span class="r115 r">targetComputer</span>;
        }
 
        <b>private void</b> <a id="0f03122192c3998f" href="../../R/0f03122192c3998f.html" target="n" data-glyph="76,1" class="i method">DoRenameComputerAction</a>(<b>string</b> <span id="r119 rd" class="r119 r">computer</span>, <b>string</b> <span id="r120 rd" class="r120 r">newName</span>, <b>bool</b> <span id="r121 rd" class="r121 r">isLocalhost</span>)
        {
            <b>string</b> <span id="r122 rd" class="r122 r">computerName</span> = <span class="r121 r">isLocalhost</span> ? <a href="#3a12b36efbe8f4d0" class="i field">_shortLocalMachineName</a> : <span class="r119 r">computer</span>;
 
            <b>if</b> (!<span class="i">ShouldProcess</span>(<span class="r122 r">computerName</span>))
            {
                <b>return</b>;
            }
 
            <span class="c">// Check the length of the new name</span>
            <b>if</b> (<span class="r120 r">newName</span> != <b>null</b> &amp;&amp; <span class="r120 r">newName</span>.<span class="i">Length</span> &gt; <a href="#e8bc15cd238f4de0" class="t t">ComputerWMIHelper</a>.<a href="#c648c34f5fe25002" class="i field">NetBIOSNameMaxLength</a>)
            {
                <b>string</b> <span id="r123 rd" class="r123 r">truncatedName</span> = <span class="r120 r">newName</span>.<span class="i">Substring</span>(0, <a href="#e8bc15cd238f4de0" class="t t">ComputerWMIHelper</a>.<a href="#c648c34f5fe25002" class="i field">NetBIOSNameMaxLength</a>);
                <b>string</b> <span id="r124 rd" class="r124 r">query</span> = <span class="i">StringUtil</span>.<span class="i">Format</span>(<span class="i">ComputerResources</span>.<span class="i">TruncateNetBIOSName</span>, <span class="r123 r">truncatedName</span>);
                <b>string</b> <span id="r125 rd" class="r125 r">caption</span> = <span class="i">ComputerResources</span>.<span class="i">TruncateNetBIOSNameCaption</span>;
                <b>if</b> (!<a href="#fe243bea799919a9" class="i property">Force</a> &amp;&amp; !<span class="i">ShouldContinue</span>(<span class="r124 r">query</span>, <span class="r125 r">caption</span>))
                {
                    <b>return</b>;
                }
            }
 
            <a href="#358c7f3746f1d990" class="i method">DoRenameComputerWsman</a>(<span class="r119 r">computer</span>, <span class="r122 r">computerName</span>, <span class="r120 r">newName</span>, <span class="r121 r">isLocalhost</span>);
        }
 
        <b>private void</b> <a id="358c7f3746f1d990" href="../../R/358c7f3746f1d990.html" target="n" data-glyph="76,1" class="i method">DoRenameComputerWsman</a>(<b>string</b> <span id="r126 rd" class="r126 r">computer</span>, <b>string</b> <span id="r127 rd" class="r127 r">computerName</span>, <b>string</b> <span id="r128 rd" class="r128 r">newName</span>, <b>bool</b> <span id="r129 rd" class="r129 r">isLocalhost</span>)
        {
            <b>bool</b> <span id="r130 rd" class="r130 r">successful</span> = <b>false</b>;
            <b>int</b> <span id="r131 rd" class="r131 r">retVal</span>;
            <span class="i">PSCredential</span> <span id="r132 rd" class="r132 r">credToUse</span> = <span class="r129 r">isLocalhost</span> ? <b>null</b> : (<a href="#33da7be8bd51449a" class="i property">LocalCredential</a> ?? <a href="#052abfa0a82e6859" class="i property">DomainCredential</a>);
 
            <b>try</b>
            {
                <b>using</b> (<span class="i">CancellationTokenSource</span> <span id="r133 rd" class="r133 r">cancelTokenSource</span> = <b>new</b>())
                <b>using</b> (<span class="i">CimSession</span> <span id="r134 rd" class="r134 r">cimSession</span> = <span class="i">RemoteDiscoveryHelper</span>.<span class="i">CreateCimSession</span>(<span class="r126 r">computer</span>, <span class="r132 r">credToUse</span>, <a href="#0cd8d0116181a277" class="i property">WsmanAuthentication</a>, <span class="r129 r">isLocalhost</span>, <a href="#a56ea633e09bdd1d" class="k">this</a>, <span class="r133 r">cancelTokenSource</span>.<span class="i">Token</span>))
                {
                    <b>var</b> <span id="r135 rd" class="r135 r">operationOptions</span> = <b>new</b> <span class="i">CimOperationOptions</span>
                    {
                        <span class="i">Timeout</span> = <span class="i">TimeSpan</span>.<span class="i">FromMilliseconds</span>(10000),
                        <span class="i">CancellationToken</span> = <span class="r133 r">cancelTokenSource</span>.<span class="i">Token</span>,
                        <span class="c">// This prefix works against all versions of the WinRM server stack, both win8 and win7</span>
                        <span class="i">ResourceUriPrefix</span> = <b>new</b> <span class="i">Uri</span>(<a href="#e8bc15cd238f4de0" class="t t">ComputerWMIHelper</a>.<a href="#08c72d7041df8fc6" class="i field">CimUriPrefix</a>)
                    };
 
                    <span class="i">IEnumerable</span>&lt;<span class="i">CimInstance</span>&gt; <span id="r136 rd" class="r136 r">mCollection</span> = <span class="r134 r">cimSession</span>.<span class="i">QueryInstances</span>(
                                                             <a href="#e8bc15cd238f4de0" class="t t">ComputerWMIHelper</a>.<a href="#651d3255d91c264e" class="i field">CimOperatingSystemNamespace</a>,
                                                             <a href="#e8bc15cd238f4de0" class="t t">ComputerWMIHelper</a>.<a href="#0e6d68434b34bc05" class="i field">CimQueryDialect</a>,
                                                             <span class="s">&quot;Select * from &quot;</span> + <a href="#e8bc15cd238f4de0" class="t t">ComputerWMIHelper</a>.<a href="#df2a88e69a5cefe1" class="i field">WMI_Class_ComputerSystem</a>,
                                                             <span class="r135 r">operationOptions</span>);
 
                    <b>foreach</b> (<span class="i">CimInstance</span> <span id="r137 rd" class="r137 r">cimInstance</span> <b>in</b> <span class="r136 r">mCollection</span>)
                    {
                        <b>var</b> <span id="r138 rd" class="r138 r">oldName</span> = <span class="r137 r">cimInstance</span>.<span class="i">CimInstanceProperties</span>[<span class="s">&quot;DNSHostName&quot;</span>].<span class="i">Value</span>.<span class="i">ToString</span>();
                        <b>if</b> (<span class="r138 r">oldName</span>.<span class="i">Equals</span>(<span class="r128 r">newName</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
                        {
                            <b>string</b> <span id="r139 rd" class="r139 r">errMsg</span> = <span class="i">StringUtil</span>.<span class="i">Format</span>(<span class="i">ComputerResources</span>.<span class="i">NewNameIsOldName</span>, <span class="r127 r">computerName</span>, <span class="r128 r">newName</span>);
                            <span class="i">ErrorRecord</span> <span id="r140 rd" class="r140 r">error</span> = <b>new</b>(
                                    <b>new</b> <span class="i">InvalidOperationException</span>(<span class="r139 r">errMsg</span>), <span class="s">&quot;NewNameIsOldName&quot;</span>,
                                    <span class="i">ErrorCategory</span>.<span class="i">InvalidArgument</span>, <span class="r128 r">newName</span>);
                            <span class="i">WriteError</span>(<span class="r140 r">error</span>);
 
                            <b>continue</b>;
                        }
 
                        <span class="c">// If the target computer is in a domain, always use the DomainCred. If the DomainCred is not given,</span>
                        <span class="c">// use null for UserName and Password, so the context of the caller will be used.</span>
                        <span class="c">// If the target computer is not in a domain, just use null for the UserName and Password</span>
                        <b>string</b> <span id="r141 rd" class="r141 r">dUserName</span> = <b>null</b>;
                        <b>string</b> <span id="r142 rd" class="r142 r">dPassword</span> = <b>null</b>;
                        <b>if</b> (((<b>bool</b>)<span class="r137 r">cimInstance</span>.<span class="i">CimInstanceProperties</span>[<span class="s">&quot;PartOfDomain&quot;</span>].<span class="i">Value</span>) &amp;&amp; (<a href="#052abfa0a82e6859" class="i property">DomainCredential</a> != <b>null</b>))
                        {
                            <span class="r141 r">dUserName</span> = <a href="#052abfa0a82e6859" class="i property">DomainCredential</a>.<span class="i">UserName</span>;
                            <span class="r142 r">dPassword</span> = <span class="i">Utils</span>.<span class="i">GetStringFromSecureString</span>(<a href="#052abfa0a82e6859" class="i property">DomainCredential</a>.<span class="i">Password</span>);
                        }
 
                        <b>var</b> <span id="r143 rd" class="r143 r">methodParameters</span> = <b>new</b> <span class="i">CimMethodParametersCollection</span>();
                        <span class="r143 r">methodParameters</span>.<span class="i">Add</span>(<span class="i">CimMethodParameter</span>.<span class="i">Create</span>(
                            <span class="s">&quot;Name&quot;</span>,
                            <span class="r128 r">newName</span>,
                            <span class="i n">Microsoft</span>.<span class="i">Management</span>.<span class="i">Infrastructure</span>.<span class="i">CimType</span>.<span class="i">String</span>,
                            <span class="i">CimFlags</span>.<span class="i">None</span>));
 
                        <span class="r143 r">methodParameters</span>.<span class="i">Add</span>(<span class="i">CimMethodParameter</span>.<span class="i">Create</span>(
                            <span class="s">&quot;UserName&quot;</span>,
                            <span class="r141 r">dUserName</span>,
                            <span class="i n">Microsoft</span>.<span class="i">Management</span>.<span class="i">Infrastructure</span>.<span class="i">CimType</span>.<span class="i">String</span>,
                            (<span class="r141 r">dUserName</span> == <b>null</b>) ? <span class="i">CimFlags</span>.<span class="i">NullValue</span> : <span class="i">CimFlags</span>.<span class="i">None</span>));
 
                        <span class="r143 r">methodParameters</span>.<span class="i">Add</span>(
                            <span class="i">CimMethodParameter</span>.<span class="i">Create</span>(
                            <span class="s">&quot;Password&quot;</span>,
                            <span class="r142 r">dPassword</span>,
                            <span class="i n">Microsoft</span>.<span class="i">Management</span>.<span class="i">Infrastructure</span>.<span class="i">CimType</span>.<span class="i">String</span>,
                            (<span class="r142 r">dPassword</span> == <b>null</b>) ? <span class="i">CimFlags</span>.<span class="i">NullValue</span> : <span class="i">CimFlags</span>.<span class="i">None</span>));
 
                        <b>if</b> (!<span class="i">InternalTestHooks</span>.<span class="i">TestRenameComputer</span>)
                        {
                            <span class="i">CimMethodResult</span> <span id="r144 rd" class="r144 r">result</span> = <span class="r134 r">cimSession</span>.<span class="i">InvokeMethod</span>(
                                <a href="#e8bc15cd238f4de0" class="t t">ComputerWMIHelper</a>.<a href="#651d3255d91c264e" class="i field">CimOperatingSystemNamespace</a>,
                                <span class="r137 r">cimInstance</span>,
                                <span class="s">&quot;Rename&quot;</span>,
                                <span class="r143 r">methodParameters</span>,
                                <span class="r135 r">operationOptions</span>);
 
                            <span class="r131 r">retVal</span> = <span class="i">Convert</span>.<span class="i">ToInt32</span>(<span class="r144 r">result</span>.<span class="i">ReturnValue</span>.<span class="i">Value</span>, <span class="i">CultureInfo</span>.<span class="i">CurrentCulture</span>);
                        }
                        <b>else</b>
                        {
                            <span class="r131 r">retVal</span> = <span class="i">InternalTestHooks</span>.<span class="i">TestRenameComputerResults</span>;
                        }
 
                        <b>if</b> (<span class="r131 r">retVal</span> != 0)
                        {
                            <b>var</b> <span id="r145 rd" class="r145 r">ex</span> = <b>new</b> <span class="i">Win32Exception</span>(<span class="r131 r">retVal</span>);
                            <b>string</b> <span id="r146 rd" class="r146 r">errMsg</span> = <span class="i">StringUtil</span>.<span class="i">Format</span>(<span class="i">ComputerResources</span>.<span class="i">FailToRename</span>, <span class="r127 r">computerName</span>, <span class="r128 r">newName</span>, <span class="r145 r">ex</span>.<span class="i">Message</span>);
                            <span class="i">ErrorRecord</span> <span id="r147 rd" class="r147 r">error</span> = <b>new</b>(<b>new</b> <span class="i">InvalidOperationException</span>(<span class="r146 r">errMsg</span>), <span class="s">&quot;FailToRenameComputer&quot;</span>, <span class="i">ErrorCategory</span>.<span class="i">OperationStopped</span>, <span class="r127 r">computerName</span>);
                            <span class="i">WriteError</span>(<span class="r147 r">error</span>);
                        }
                        <b>else</b>
                        {
                            <span class="r130 r">successful</span> = <b>true</b>;
                        }
 
                        <b>if</b> (<a href="#0644c52672e22d21" class="i property">PassThru</a>)
                        {
                            <span class="i">WriteObject</span>(<a href="#e8bc15cd238f4de0" class="t t">ComputerWMIHelper</a>.<a href="#068bd83bf2c008a2" class="i method">GetRenameComputerStatusObject</a>(<span class="r131 r">retVal</span>, <span class="r128 r">newName</span>, <span class="r127 r">computerName</span>));
                        }
 
                        <b>if</b> (<span class="r130 r">successful</span>)
                        {
                            <b>if</b> (<a href="#17d4fb5583e5a920" class="i field">_restart</a>)
                            {
                                <span class="c">// If successful and the Restart parameter is specified, restart the computer</span>
                                <b>object</b>[] <span id="r148 rd" class="r148 r">flags</span> = <b>new</b> <b>object</b>[] { 6, 0 };
                                <a href="#e8bc15cd238f4de0" class="t t">ComputerWMIHelper</a>.<span class="i">InvokeWin32ShutdownUsingWsman</span>(
                                    <a href="#a56ea633e09bdd1d" class="k">this</a>,
                                    <span class="r129 r">isLocalhost</span>,
                                    <span class="r127 r">computerName</span>,
                                    <span class="r148 r">flags</span>,
                                    <span class="r132 r">credToUse</span>,
                                    <a href="#0cd8d0116181a277" class="i property">WsmanAuthentication</a>,
                                    <span class="i">ComputerResources</span>.<span class="i">RestartcomputerFailed</span>,
                                    <span class="s">&quot;RestartcomputerFailed&quot;</span>,
                                    <span class="r133 r">cancelTokenSource</span>.<span class="i">Token</span>);
                            }
                            <b>else</b>
                            {
                                <span class="i">WriteWarning</span>(<span class="i">StringUtil</span>.<span class="i">Format</span>(<span class="i">ComputerResources</span>.<span class="i">RestartNeeded</span>, <b>null</b>, <span class="r127 r">computerName</span>));
                            }
                        }
                    }
                }
            }
            <b>catch</b> (<span class="i">CimException</span> <span id="r149 rd" class="r149 r">ex</span>)
            {
                <b>string</b> <span id="r150 rd" class="r150 r">errMsg</span> = <span class="i">StringUtil</span>.<span class="i">Format</span>(<span class="i">ComputerResources</span>.<span class="i">FailToConnectToComputer</span>, <span class="r127 r">computerName</span>, <span class="r149 r">ex</span>.<span class="i">Message</span>);
                <span class="i">ErrorRecord</span> <span id="r151 rd" class="r151 r">error</span> = <b>new</b>(<b>new</b> <span class="i">InvalidOperationException</span>(<span class="r150 r">errMsg</span>), <span class="s">&quot;RenameComputerException&quot;</span>,
                                                    <span class="i">ErrorCategory</span>.<span class="i">OperationStopped</span>, <span class="r127 r">computerName</span>);
                <span class="i">WriteError</span>(<span class="r151 r">error</span>);
            }
            <b>catch</b> (<span class="i">Exception</span> <span id="r152 rd" class="r152 r">ex</span>)
            {
                <b>string</b> <span id="r153 rd" class="r153 r">errMsg</span> = <span class="i">StringUtil</span>.<span class="i">Format</span>(<span class="i">ComputerResources</span>.<span class="i">FailToConnectToComputer</span>, <span class="r127 r">computerName</span>, <span class="r152 r">ex</span>.<span class="i">Message</span>);
                <span class="i">ErrorRecord</span> <span id="r154 rd" class="r154 r">error</span> = <b>new</b>(<b>new</b> <span class="i">InvalidOperationException</span>(<span class="r153 r">errMsg</span>), <span class="s">&quot;RenameComputerException&quot;</span>,
                                                    <span class="i">ErrorCategory</span>.<span class="i">OperationStopped</span>, <span class="r127 r">computerName</span>);
                <span class="i">WriteError</span>(<span class="r154 r">error</span>);
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> &quot;Private Methods&quot;
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> &quot;Override Methods&quot;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> ProcessRecord method.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>protected override void</b> <a id="20f1e3c28051b742" href="../../R/../../0000000000.html" target="n" data-glyph="75,1" class="i method">ProcessRecord</a>()
        {
            <b>string</b> <span id="r155 rd" class="r155 r">targetComputer</span> = <a href="#d0972da7668e1d3b" class="i method">ValidateComputerName</a>();
            <b>if</b> (<span class="r155 r">targetComputer</span> == <b>null</b>) <b>return</b>;
 
            <b>bool</b> <span id="r156 rd" class="r156 r">isLocalhost</span> = <span class="r155 r">targetComputer</span>.<span class="i">Equals</span>(<span class="s">&quot;localhost&quot;</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>);
            <b>if</b> (<span class="r156 r">isLocalhost</span>)
            {
                <b>if</b> (!<a href="#a19c9b5254e6ef77" class="i field">_containsLocalHost</a>)
                    <a href="#a19c9b5254e6ef77" class="i field">_containsLocalHost</a> = <b>true</b>;
                <a href="#a6fe3a99b9b826de" class="i field">_newNameForLocalHost</a> = <a href="#4112fab2d971372f" class="i property">NewName</a>;
 
                <b>return</b>;
            }
 
            <a href="#0f03122192c3998f" class="i method">DoRenameComputerAction</a>(<span class="r155 r">targetComputer</span>, <a href="#4112fab2d971372f" class="i property">NewName</a>, <b>false</b>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> EndProcessing method.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>protected override void</b> <a id="8b3a480c9183cdf4" href="../../R/../../0000000000.html" target="n" data-glyph="75,1" class="i method">EndProcessing</a>()
        {
            <b>if</b> (!<a href="#a19c9b5254e6ef77" class="i field">_containsLocalHost</a>) <b>return</b>;
 
            <a href="#0f03122192c3998f" class="i method">DoRenameComputerAction</a>(<span class="s">&quot;localhost&quot;</span>, <a href="#a6fe3a99b9b826de" class="i field">_newNameForLocalHost</a>, <b>true</b>);
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> &quot;Override Methods&quot;
    }
 
    <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Rename-Computer
 
    <span class="k preprocess">#</span><span class="k preprocess">region</span> &quot;Public API&quot;
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> The object returned by SAM Computer cmdlets representing the status of the target machine.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>public sealed class</b> <a id="f06d84b134c72121" href="../../R/f06d84b134c72121.html" target="n" data-glyph="0,0" class="t t"><span id="8465542041c0c0d0">ComputerChangeInfo</span></a>
    {
        <b>private const string</b> <a id="fa360a343835b4f9" href="../../R/fa360a343835b4f9.html" target="n" data-glyph="10,1" class="i field">MatchFormat</a> = <span class="s">&quot;{0}:{1}&quot;</span>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The HasSucceeded which shows the operation was success or not.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public bool</b> <a id="d4bc5a83892a1b05" href="../../R/d4bc5a83892a1b05.html" target="n" data-glyph="102,1" class="i property">HasSucceeded</a> { <b>get</b>; <b>set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The ComputerName on which the operation is done.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public string</b> <a id="b8db72910b988729" href="../../R/b8db72910b988729.html" target="n" data-glyph="102,1" class="i property">ComputerName</a> { <b>get</b>; <b>set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Returns the string representation of this object.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public override string</b> <a id="63b2e07e541cd736" href="../../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">ToString</a>()
        {
            <b>return</b> <span class="i">FormatLine</span>(<a href="#f06d84b134c72121" class="k">this</a>.<a href="#d4bc5a83892a1b05" class="i property">HasSucceeded</a>.<span class="i">ToString</span>(), <a href="#f06d84b134c72121" class="k">this</a>.<a href="#b8db72910b988729" class="i property">ComputerName</a>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Formats a line for use in ToString.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r157 r">HasSucceeded</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r158 r">computername</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>private static string</b> <a id="990a5ce82800306c" href="../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">FormatLine</a>(<b>string</b> <span id="r157 rd" class="r157 r">HasSucceeded</span>, <b>string</b> <span id="r158 rd" class="r158 r">computername</span>)
        {
            <b>return</b> <span class="i">StringUtil</span>.<span class="i">Format</span>(<a href="#fa360a343835b4f9" class="i field">MatchFormat</a>, <span class="r157 r">HasSucceeded</span>, <span class="r158 r">computername</span>);
        }
    }
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> The object returned by Rename-Computer cmdlet representing the status of the target machine.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>public sealed class</b> <a id="340df02a20075d79" href="../../R/340df02a20075d79.html" target="n" data-glyph="0,0" class="t t"><span id="5e6f70dc7c0a0f64">RenameComputerChangeInfo</span></a>
    {
        <b>private const string</b> <a id="799f16797a5165d2" href="../../R/799f16797a5165d2.html" target="n" data-glyph="10,1" class="i field">MatchFormat</a> = <span class="s">&quot;{0}:{1}:{2}&quot;</span>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The status which shows the operation was success or failure.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public bool</b> <a id="a4013e9468f0f089" href="../../R/a4013e9468f0f089.html" target="n" data-glyph="102,1" class="i property">HasSucceeded</a> { <b>get</b>; <b>set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The NewComputerName which represents the target machine.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public string</b> <a id="0870234544c615e0" href="../../R/0870234544c615e0.html" target="n" data-glyph="102,1" class="i property">NewComputerName</a> { <b>get</b>; <b>set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The OldComputerName which represented the target machine.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public string</b> <a id="e9395f3f774f2bad" href="../../R/e9395f3f774f2bad.html" target="n" data-glyph="102,1" class="i property">OldComputerName</a> { <b>get</b>; <b>set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Returns the string representation of this object.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public override string</b> <a id="e61478560ca6bc51" href="../../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">ToString</a>()
        {
            <b>return</b> <span class="i">FormatLine</span>(<a href="#340df02a20075d79" class="k">this</a>.<a href="#a4013e9468f0f089" class="i property">HasSucceeded</a>.<span class="i">ToString</span>(), <a href="#340df02a20075d79" class="k">this</a>.<a href="#0870234544c615e0" class="i property">NewComputerName</a>, <a href="#340df02a20075d79" class="k">this</a>.<a href="#e9395f3f774f2bad" class="i property">OldComputerName</a>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Formats a line for use in ToString.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r159 r">HasSucceeded</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r160 r">newcomputername</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r161 r">oldcomputername</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>private static string</b> <a id="727a085e3fe976ad" href="../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">FormatLine</a>(<b>string</b> <span id="r159 rd" class="r159 r">HasSucceeded</span>, <b>string</b> <span id="r160 rd" class="r160 r">newcomputername</span>, <b>string</b> <span id="r161 rd" class="r161 r">oldcomputername</span>)
        {
            <b>return</b> <span class="i">StringUtil</span>.<span class="i">Format</span>(<a href="#799f16797a5165d2" class="i field">MatchFormat</a>, <span class="r159 r">HasSucceeded</span>, <span class="r160 r">newcomputername</span>, <span class="r161 r">oldcomputername</span>);
        }
    }
    <span class="k preprocess">#</span><span class="k preprocess">endregion</span> &quot;Public API&quot;
 
    <span class="k preprocess">#</span><span class="k preprocess">region</span> Helper
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Helper Class used by Stop-Computer,Restart-Computer and Test-Connection</span>
    <span class="c">///</span><span class="c"> Also Contain constants used by System Restore related Cmdlets.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>internal static class</b> <a id="e8bc15cd238f4de0" href="../../R/e8bc15cd238f4de0.html" target="n" data-glyph="2,0" class="t t">ComputerWMIHelper</a>
    {
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The maximum length of a valid NetBIOS name.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal const int</b> <a id="c648c34f5fe25002" href="../../R/c648c34f5fe25002.html" target="n" data-glyph="8,1" class="i field">NetBIOSNameMaxLength</a> = 15;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> System Restore Class used by Cmdlets.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal const string</b> <a id="ab44112f93df390d" href="../../R/../../0000000000.html" target="n" data-glyph="8,1" class="i field">WMI_Class_SystemRestore</a> = <span class="s">&quot;SystemRestore&quot;</span>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> OperatingSystem WMI class used by Cmdlets.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal const string</b> <a id="8ce54643ae82a88c" href="../../R/8ce54643ae82a88c.html" target="n" data-glyph="8,1" class="i field">WMI_Class_OperatingSystem</a> = <span class="s">&quot;Win32_OperatingSystem&quot;</span>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Service WMI class used by Cmdlets.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal const string</b> <a id="6c78c0d307de278d" href="../../R/6c78c0d307de278d.html" target="n" data-glyph="8,1" class="i field">WMI_Class_Service</a> = <span class="s">&quot;Win32_Service&quot;</span>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Win32_ComputerSystem WMI class used by Cmdlets.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal const string</b> <a id="df2a88e69a5cefe1" href="../../R/df2a88e69a5cefe1.html" target="n" data-glyph="8,1" class="i field">WMI_Class_ComputerSystem</a> = <span class="s">&quot;Win32_ComputerSystem&quot;</span>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Ping Class used by Cmdlet.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal const string</b> <a id="a45c5f39bac42240" href="../../R/../../0000000000.html" target="n" data-glyph="8,1" class="i field">WMI_Class_PingStatus</a> = <span class="s">&quot;Win32_PingStatus&quot;</span>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> CIMV2 path.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal const string</b> <a id="48cd302c5b4f38f4" href="../../R/48cd302c5b4f38f4.html" target="n" data-glyph="8,1" class="i field">WMI_Path_CIM</a> = <span class="s">&quot;\\root\\cimv2&quot;</span>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Default path.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal const string</b> <a id="d755c31be6c932be" href="../../R/../../0000000000.html" target="n" data-glyph="8,1" class="i field">WMI_Path_Default</a> = <span class="s">&quot;\\root\\default&quot;</span>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The error says The interface is unknown.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal const int</b> <a id="8b965f5a06c4b9c1" href="../../R/../../0000000000.html" target="n" data-glyph="8,1" class="i field">ErrorCode_Interface</a> = 1717;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This error says An instance of the service is already running.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal const int</b> <a id="741e4bfebf76bb8f" href="../../R/../../0000000000.html" target="n" data-glyph="8,1" class="i field">ErrorCode_Service</a> = 1056;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The name of the privilege to shutdown a local system.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal const string</b> <a id="e0624c83f0b325f8" href="../../R/e0624c83f0b325f8.html" target="n" data-glyph="8,1" class="i field">SE_SHUTDOWN_NAME</a> = <span class="s">&quot;SeShutdownPrivilege&quot;</span>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The name of the privilege to shutdown a remote system.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal const string</b> <a id="2d365f660fb8ac75" href="../../R/2d365f660fb8ac75.html" target="n" data-glyph="8,1" class="i field">SE_REMOTE_SHUTDOWN_NAME</a> = <span class="s">&quot;SeRemoteShutdownPrivilege&quot;</span>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> CimUriPrefix.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal const string</b> <a id="08c72d7041df8fc6" href="../../R/08c72d7041df8fc6.html" target="n" data-glyph="8,1" class="i field">CimUriPrefix</a> = <span class="s">&quot;http://schemas.microsoft.com/wbem/wsman/1/wmi/root/cimv2&quot;</span>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> CimOperatingSystemNamespace.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal const string</b> <a id="651d3255d91c264e" href="../../R/651d3255d91c264e.html" target="n" data-glyph="8,1" class="i field">CimOperatingSystemNamespace</a> = <span class="s">&quot;root/cimv2&quot;</span>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> CimOperatingSystemShutdownMethod.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal const string</b> <a id="5274ea6596528a79" href="../../R/5274ea6596528a79.html" target="n" data-glyph="8,1" class="i field">CimOperatingSystemShutdownMethod</a> = <span class="s">&quot;Win32shutdown&quot;</span>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> CimQueryDialect.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal const string</b> <a id="0e6d68434b34bc05" href="../../R/0e6d68434b34bc05.html" target="n" data-glyph="8,1" class="i field">CimQueryDialect</a> = <span class="s">&quot;WQL&quot;</span>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Local host name.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal const string</b> <a id="f343d6c6559c69a3" href="../../R/f343d6c6559c69a3.html" target="n" data-glyph="8,1" class="i field">localhostStr</a> = <span class="s">&quot;localhost&quot;</span>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Get the local admin user name from a local NetworkCredential.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r162 r">computerName</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r163 r">psLocalCredential</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal static string</b> <a id="b2ab97049f6c14eb" href="../../R/../../0000000000.html" target="n" data-glyph="74,1" class="i method">GetLocalAdminUserName</a>(<b>string</b> <span id="r162 rd" class="r162 r">computerName</span>, <span class="i">PSCredential</span> <span id="r163 rd" class="r163 r">psLocalCredential</span>)
        {
            <b>string</b> <span id="r164 rd" class="r164 r">localUserName</span> = <b>null</b>;
 
            <span class="c">// The format of local admin username should be &quot;ComputerName\AdminName&quot;</span>
            <b>if</b> (<span class="r163 r">psLocalCredential</span>.<span class="i">UserName</span>.<span class="i">Contains</span>(<span class="s">&#39;\\&#39;</span>))
            {
                <span class="r164 r">localUserName</span> = <span class="r163 r">psLocalCredential</span>.<span class="i">UserName</span>;
            }
            <b>else</b>
            {
                <b>int</b> <span id="r165 rd" class="r165 r">dotIndex</span> = <span class="r162 r">computerName</span>.<span class="i">IndexOf</span>(<span class="s">&#39;.&#39;</span>);
                <b>if</b> (<span class="r165 r">dotIndex</span> == -1)
                {
                    <span class="r164 r">localUserName</span> = <span class="r162 r">computerName</span> + <span class="s">&quot;\\&quot;</span> + <span class="r163 r">psLocalCredential</span>.<span class="i">UserName</span>;
                }
                <b>else</b>
                {
                    <span class="r164 r">localUserName</span> = <b>string</b>.<span class="i">Concat</span>(<span class="r162 r">computerName</span>.<span class="i">AsSpan</span>(0, <span class="r165 r">dotIndex</span>), <span class="s">&quot;\\&quot;</span>, <span class="r163 r">psLocalCredential</span>.<span class="i">UserName</span>);
                }
            }
 
            <b>return</b> <span class="r164 r">localUserName</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Generate a random password.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r166 r">passwordLength</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal static string</b> <a id="650f206bf47e284c" href="../../R/../../0000000000.html" target="n" data-glyph="74,1" class="i method">GetRandomPassword</a>(<b>int</b> <span id="r166 rd" class="r166 r">passwordLength</span>)
        {
            <b>const int</b> <span id="r167 rd" class="r167 r">charMin</span> = 32, <span id="r168 rd" class="r168 r">charMax</span> = 122;
            <b>const int</b> <span id="r169 rd" class="r169 r">allowedCharsCount</span> = <span class="r168 r">charMax</span> - <span class="r167 r">charMin</span> + 1;
            <b>byte</b>[] <span id="r170 rd" class="r170 r">randomBytes</span> = <b>new</b> <b>byte</b>[<span class="r166 r">passwordLength</span>];
            <b>char</b>[] <span id="r171 rd" class="r171 r">chars</span> = <b>new</b> <b>char</b>[<span class="r166 r">passwordLength</span>];
 
            <span class="i">RandomNumberGenerator</span> <span id="r172 rd" class="r172 r">rng</span> = <span class="i">RandomNumberGenerator</span>.<span class="i">Create</span>();
            <span class="r172 r">rng</span>.<span class="i">GetBytes</span>(<span class="r170 r">randomBytes</span>);
 
            <b>for</b> (<b>int</b> <span id="r173 rd" class="r173 r">i</span> = 0; <span class="r173 r">i</span> &lt; <span class="r166 r">passwordLength</span>; <span class="r173 r">i</span>++)
            {
                <span class="r171 r">chars</span>[<span class="r173 r">i</span>] = (<b>char</b>)(<span class="r170 r">randomBytes</span>[<span class="r173 r">i</span>] % <span class="r169 r">allowedCharsCount</span> + <span class="r167 r">charMin</span>);
            }
 
            <b>return</b> <b>new</b> <b>string</b>(<span class="r171 r">chars</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the Scope.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r174 r">computer</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r175 r">namespaceParameter</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal static string</b> <a id="158da5f9f8328384" href="../../R/158da5f9f8328384.html" target="n" data-glyph="74,1" class="i method">GetScopeString</a>(<b>string</b> <span id="r174 rd" class="r174 r">computer</span>, <b>string</b> <span id="r175 rd" class="r175 r">namespaceParameter</span>)
        {
            <span class="i">StringBuilder</span> <span id="r176 rd" class="r176 r">returnValue</span> = <b>new</b>(<span class="s">&quot;\\\\&quot;</span>);
            <b>if</b> (<span class="r174 r">computer</span>.<span class="i">Equals</span>(<span class="s">&quot;::1&quot;</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>) || <span class="r174 r">computer</span>.<span class="i">Equals</span>(<span class="s">&quot;[::1]&quot;</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
            {
                <span class="r176 r">returnValue</span>.<span class="i">Append</span>(<span class="s">&quot;localhost&quot;</span>);
            }
            <b>else</b>
            {
                <span class="r176 r">returnValue</span>.<span class="i">Append</span>(<span class="r174 r">computer</span>);
            }
 
            <span class="r176 r">returnValue</span>.<span class="i">Append</span>(<span class="r175 r">namespaceParameter</span>);
            <b>return</b> <span class="r176 r">returnValue</span>.<span class="i">ToString</span>();
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Returns true if it is a valid drive on the system.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r177 r">drive</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal static bool</b> <a id="b9077fa086def017" href="../../R/../../0000000000.html" target="n" data-glyph="74,1" class="i method">IsValidDrive</a>(<b>string</b> <span id="r177 rd" class="r177 r">drive</span>)
        {
            <span class="i">DriveInfo</span>[] <span id="r178 rd" class="r178 r">drives</span> = <span class="i">DriveInfo</span>.<span class="i">GetDrives</span>();
            <b>foreach</b> (<span class="i">DriveInfo</span> <span id="r179 rd" class="r179 r">logicalDrive</span> <b>in</b> <span class="r178 r">drives</span>)
            {
                <b>if</b> (<span class="r179 r">logicalDrive</span>.<span class="i">DriveType</span>.<span class="i">Equals</span>(<span class="i">DriveType</span>.<span class="i">Fixed</span>))
                {
                    <b>if</b> (<span class="r177 r">drive</span>.<span class="i">Equals</span>(<span class="r179 r">logicalDrive</span>.<span class="i">Name</span>, <span class="i">System</span>.<span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
                        <b>return</b> <b>true</b>;
                }
            }
 
            <b>return</b> <b>false</b>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Checks whether string[] contains System Drive.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r180 r">drives</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r181 r">sysdrive</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal static bool</b> <a id="84f228c154788047" href="../../R/../../0000000000.html" target="n" data-glyph="74,1" class="i method">ContainsSystemDrive</a>(<b>string</b>[] <span id="r180 rd" class="r180 r">drives</span>, <b>string</b> <span id="r181 rd" class="r181 r">sysdrive</span>)
        {
            <b>string</b> <span id="r182 rd" class="r182 r">driveApp</span>;
            <b>foreach</b> (<b>string</b> <span id="r183 rd" class="r183 r">drive</span> <b>in</b> <span class="r180 r">drives</span>)
            {
                <b>if</b> (!<span class="r183 r">drive</span>.<span class="i">EndsWith</span>(<span class="s">&#39;\\&#39;</span>))
                {
                    <span class="r182 r">driveApp</span> = <b>string</b>.<span class="i">Concat</span>(<span class="r183 r">drive</span>, <span class="s">&quot;\\&quot;</span>);
                }
                <b>else</b>
                    <span class="r182 r">driveApp</span> = <span class="r183 r">drive</span>;
                <b>if</b> (<span class="r182 r">driveApp</span>.<span class="i">Equals</span>(<span class="r181 r">sysdrive</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
                    <b>return</b> <b>true</b>;
            }
 
            <b>return</b> <b>false</b>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Returns the given computernames in a string.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r184 r">computerNames</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal static string</b> <a id="e41ef7e04f37e165" href="../../R/../../0000000000.html" target="n" data-glyph="74,1" class="i method">GetMachineNames</a>(<b>string</b>[] <span id="r184 rd" class="r184 r">computerNames</span>)
        {
            <b>string</b> <span id="r185 rd" class="r185 r">separator</span> = <span class="s">&quot;,&quot;</span>;
            <span class="i">RegistryKey</span> <span id="r186 rd" class="r186 r">regKey</span> = <span class="i">Registry</span>.<span class="i">CurrentUser</span>.<span class="i">OpenSubKey</span>(<span class="s">@&quot;Control Panel\International&quot;</span>);
            <b>if</b> (<span class="r186 r">regKey</span> != <b>null</b>)
            {
                <b>object</b> <span id="r187 rd" class="r187 r">sListValue</span> = <span class="r186 r">regKey</span>.<span class="i">GetValue</span>(<span class="s">&quot;sList&quot;</span>);
                <b>if</b> (<span class="r187 r">sListValue</span> != <b>null</b>)
                {
                    <span class="r185 r">separator</span> = <span class="r187 r">sListValue</span>.<span class="i">ToString</span>();
                }
            }
 
            <b>string</b> <span id="r188 rd" class="r188 r">compname</span> = <b>string</b>.<span class="i">Empty</span>;
            <span class="i">StringBuilder</span> <span id="r189 rd" class="r189 r">strComputers</span> = <b>new</b>();
            <b>int</b> <span id="r190 rd" class="r190 r">i</span> = 0;
            <b>foreach</b> (<b>string</b> <span id="r191 rd" class="r191 r">computer</span> <b>in</b> <span class="r184 r">computerNames</span>)
            {
                <b>if</b> (<span class="r190 r">i</span> &gt; 0)
                {
                    <span class="r189 r">strComputers</span>.<span class="i">Append</span>(<span class="r185 r">separator</span>);
                }
                <b>else</b>
                {
                    <span class="r190 r">i</span>++;
                }
 
                <b>if</b> ((<span class="r191 r">computer</span>.<span class="i">Equals</span>(<span class="s">&quot;localhost&quot;</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>)) || (<span class="r191 r">computer</span>.<span class="i">Equals</span>(<span class="s">&quot;.&quot;</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>)))
                {
                    <span class="r188 r">compname</span> = <span class="i">Dns</span>.<span class="i">GetHostName</span>();
                }
                <b>else</b>
                {
                    <span class="r188 r">compname</span> = <span class="r191 r">computer</span>;
                }
 
                <span class="r189 r">strComputers</span>.<span class="i">Append</span>(<span class="r188 r">compname</span>);
            }
 
            <b>return</b> <span class="r189 r">strComputers</span>.<span class="i">ToString</span>();
        }
 
        <b>internal static</b> <a href="#f06d84b134c72121" class="t t">ComputerChangeInfo</a> <a id="31de44bd3b031e69" href="../../R/../../0000000000.html" target="n" data-glyph="74,1" class="i method">GetComputerStatusObject</a>(<b>int</b> <span id="r192 rd" class="r192 r">errorcode</span>, <b>string</b> <span id="r193 rd" class="r193 r">computername</span>)
        {
            <a href="#f06d84b134c72121" class="t t">ComputerChangeInfo</a> <span id="r194 rd" class="r194 r">computerchangeinfo</span> = <b>new</b>();
            <span class="r194 r">computerchangeinfo</span>.<a href="#b8db72910b988729" class="i property">ComputerName</a> = <span class="r193 r">computername</span>;
            <b>if</b> (<span class="r192 r">errorcode</span> != 0)
            {
                <span class="r194 r">computerchangeinfo</span>.<a href="#d4bc5a83892a1b05" class="i property">HasSucceeded</a> = <b>false</b>;
            }
            <b>else</b>
            {
                <span class="r194 r">computerchangeinfo</span>.<a href="#d4bc5a83892a1b05" class="i property">HasSucceeded</a> = <b>true</b>;
            }
 
            <b>return</b> <span class="r194 r">computerchangeinfo</span>;
        }
 
        <b>internal static</b> <a href="#340df02a20075d79" class="t t">RenameComputerChangeInfo</a> <a id="068bd83bf2c008a2" href="../../R/068bd83bf2c008a2.html" target="n" data-glyph="74,1" class="i method">GetRenameComputerStatusObject</a>(<b>int</b> <span id="r195 rd" class="r195 r">errorcode</span>, <b>string</b> <span id="r196 rd" class="r196 r">newcomputername</span>, <b>string</b> <span id="r197 rd" class="r197 r">oldcomputername</span>)
        {
            <a href="#340df02a20075d79" class="t t">RenameComputerChangeInfo</a> <span id="r198 rd" class="r198 r">renamecomputerchangeinfo</span> = <b>new</b>();
            <span class="r198 r">renamecomputerchangeinfo</span>.<a href="#e9395f3f774f2bad" class="i property">OldComputerName</a> = <span class="r197 r">oldcomputername</span>;
            <span class="r198 r">renamecomputerchangeinfo</span>.<a href="#0870234544c615e0" class="i property">NewComputerName</a> = <span class="r196 r">newcomputername</span>;
            <b>if</b> (<span class="r195 r">errorcode</span> != 0)
            {
                <span class="r198 r">renamecomputerchangeinfo</span>.<a href="#a4013e9468f0f089" class="i property">HasSucceeded</a> = <b>false</b>;
            }
            <b>else</b>
            {
                <span class="r198 r">renamecomputerchangeinfo</span>.<a href="#a4013e9468f0f089" class="i property">HasSucceeded</a> = <b>true</b>;
            }
 
            <b>return</b> <span class="r198 r">renamecomputerchangeinfo</span>;
        }
 
        <b>internal static void</b> <a id="6d94c39ce3709b73" href="../../R/../../0000000000.html" target="n" data-glyph="74,1" class="i method">WriteNonTerminatingError</a>(<b>int</b> <span id="r199 rd" class="r199 r">errorcode</span>, <span class="i">PSCmdlet</span> <span id="r200 rd" class="r200 r">cmdlet</span>, <b>string</b> <span id="r201 rd" class="r201 r">computername</span>)
        {
            <span class="i">Win32Exception</span> <span id="r202 rd" class="r202 r">ex</span> = <b>new</b>(<span class="r199 r">errorcode</span>);
            <b>string</b> <span id="r203 rd" class="r203 r">additionalmessage</span> = <b>string</b>.<span class="i">Empty</span>;
            <b>if</b> (<span class="r202 r">ex</span>.<span class="i">NativeErrorCode</span>.<span class="i">Equals</span>(0x00000035))
            {
                <span class="r203 r">additionalmessage</span> = <span class="i">StringUtil</span>.<span class="i">Format</span>(<span class="i">ComputerResources</span>.<span class="i">NetworkPathNotFound</span>, <span class="r201 r">computername</span>);
            }
 
            <b>string</b> <span id="r204 rd" class="r204 r">message</span> = <span class="i">StringUtil</span>.<span class="i">Format</span>(<span class="i">ComputerResources</span>.<span class="i">OperationFailed</span>, <span class="r202 r">ex</span>.<span class="i">Message</span>, <span class="r201 r">computername</span>, <span class="r203 r">additionalmessage</span>);
            <span class="i">ErrorRecord</span> <span id="r205 rd" class="r205 r">er</span> = <b>new</b>(<b>new</b> <span class="i">InvalidOperationException</span>(<span class="r204 r">message</span>), <span class="s">&quot;InvalidOperationException&quot;</span>, <span class="i">ErrorCategory</span>.<span class="i">InvalidOperation</span>, <span class="r201 r">computername</span>);
            <span class="r200 r">cmdlet</span>.<span class="i">WriteError</span>(<span class="r205 r">er</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Check whether the new computer name is valid.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r206 r">computerName</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal static bool</b> <a id="aa12934cc51159ea" href="../../R/aa12934cc51159ea.html" target="n" data-glyph="74,1" class="i method">IsComputerNameValid</a>(<b>string</b> <span id="r206 rd" class="r206 r">computerName</span>)
        {
            <b>bool</b> <span id="r207 rd" class="r207 r">allDigits</span> = <b>true</b>;
 
            <b>if</b> (<span class="r206 r">computerName</span>.<span class="i">Length</span> &gt;= 64)
                <b>return</b> <b>false</b>;
 
            <b>foreach</b> (<b>char</b> <span id="r208 rd" class="r208 r">t</span> <b>in</b> <span class="r206 r">computerName</span>)
            {
                <b>if</b> (<span class="r208 r">t</span> &gt;= <span class="s">&#39;A&#39;</span> &amp;&amp; <span class="r208 r">t</span> &lt;= <span class="s">&#39;Z&#39;</span> ||
                    <span class="r208 r">t</span> &gt;= <span class="s">&#39;a&#39;</span> &amp;&amp; <span class="r208 r">t</span> &lt;= <span class="s">&#39;z&#39;</span>)
                {
                    <span class="r207 r">allDigits</span> = <b>false</b>;
                    <b>continue</b>;
                }
                <b>else</b> <b>if</b> (<span class="r208 r">t</span> &gt;= <span class="s">&#39;0&#39;</span> &amp;&amp; <span class="r208 r">t</span> &lt;= <span class="s">&#39;9&#39;</span>)
                {
                    <b>continue</b>;
                }
                <b>else</b> <b>if</b> (<span class="r208 r">t</span> == <span class="s">&#39;-&#39;</span>)
                {
                    <span class="r207 r">allDigits</span> = <b>false</b>;
                    <b>continue</b>;
                }
                <b>else</b>
                {
                    <b>return</b> <b>false</b>;
                }
            }
 
            <b>return</b> !<span class="r207 r">allDigits</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> System Restore APIs are not supported on the ARM platform. Skip the system restore operation is necessary.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r209 r">cmdlet</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal static bool</b> <a id="66c7a04c00d85202" href="../../R/../../0000000000.html" target="n" data-glyph="74,1" class="i method">SkipSystemRestoreOperationForARMPlatform</a>(<span class="i">PSCmdlet</span> <span id="r209 rd" class="r209 r">cmdlet</span>)
        {
            <b>bool</b> <span id="r210 rd" class="r210 r">retValue</span> = <b>false</b>;
            <b>if</b> (<span class="i">PsUtils</span>.<span class="i">IsRunningOnProcessorArchitectureARM</span>())
            {
                <b>var</b> <span id="r211 rd" class="r211 r">ex</span> = <b>new</b> <span class="i">InvalidOperationException</span>(<span class="i">ComputerResources</span>.<span class="i">SystemRestoreNotSupported</span>);
                <b>var</b> <span id="r212 rd" class="r212 r">er</span> = <b>new</b> <span class="i">ErrorRecord</span>(<span class="r211 r">ex</span>, <span class="s">&quot;SystemRestoreNotSupported&quot;</span>, <span class="i">ErrorCategory</span>.<span class="i">InvalidOperation</span>, <b>null</b>);
                <span class="r209 r">cmdlet</span>.<span class="i">WriteError</span>(<span class="r212 r">er</span>);
                <span class="r210 r">retValue</span> = <b>true</b>;
            }
 
            <b>return</b> <span class="r210 r">retValue</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Invokes the Win32Shutdown command on provided target computer using WSMan</span>
        <span class="c">///</span><span class="c"> over a CIMSession.  The flags parameter determines the type of shutdown operation</span>
        <span class="c">///</span><span class="c"> such as shutdown, reboot, force etc.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r213 r">cmdlet</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Cmdlet host for reporting errors.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r214 r">isLocalhost</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">True if local host computer.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r215 r">computerName</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Target computer.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r216 r">flags</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Win32Shutdown flags.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r217 r">credential</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Optional credential.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r218 r">authentication</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Optional authentication.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r219 r">formatErrorMessage</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Error message format string that takes two parameters.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r220 r">ErrorFQEID</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Fully qualified error Id.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r221 r">cancelToken</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Cancel token.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">True on success.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal static bool</b> <a id="a73f46c21fdee615" href="../../R/../../0000000000.html" target="n" data-glyph="74,1" class="i method">InvokeWin32ShutdownUsingWsman</a>(
            <span class="i">PSCmdlet</span> <span id="r213 rd" class="r213 r">cmdlet</span>,
            <b>bool</b> <span id="r214 rd" class="r214 r">isLocalhost</span>,
            <b>string</b> <span id="r215 rd" class="r215 r">computerName</span>,
            <b>object</b>[] <span id="r216 rd" class="r216 r">flags</span>,
            <span class="i">PSCredential</span> <span id="r217 rd" class="r217 r">credential</span>,
            <b>string</b> <span id="r218 rd" class="r218 r">authentication</span>,
            <b>string</b> <span id="r219 rd" class="r219 r">formatErrorMessage</span>,
            <b>string</b> <span id="r220 rd" class="r220 r">ErrorFQEID</span>,
            <span class="i">CancellationToken</span> <span id="r221 rd" class="r221 r">cancelToken</span>)
        {
            <span class="i">Dbg</span>.<span class="i">Diagnostics</span>.<span class="i">Assert</span>(<span class="r216 r">flags</span>.<span class="i">Length</span> == 2, <span class="s">&quot;Caller need to verify the flags passed in&quot;</span>);
 
            <b>bool</b> <span id="r222 rd" class="r222 r">isSuccess</span> = <b>false</b>;
            <b>string</b> <span id="r223 rd" class="r223 r">targetMachine</span> = <span class="r214 r">isLocalhost</span> ? <span class="s">&quot;localhost&quot;</span> : <span class="r215 r">computerName</span>;
            <b>string</b> <span id="r224 rd" class="r224 r">authInUse</span> = <span class="r214 r">isLocalhost</span> ? <b>null</b> : <span class="r218 r">authentication</span>;
            <span class="i">PSCredential</span> <span id="r225 rd" class="r225 r">credInUse</span> = <span class="r214 r">isLocalhost</span> ? <b>null</b> : <span class="r217 r">credential</span>;
            <b>var</b> <span id="r226 rd" class="r226 r">currentPrivilegeState</span> = <b>new</b> <span class="i">PlatformInvokes</span>.<span class="i">TOKEN_PRIVILEGE</span>();
            <b>var</b> <span id="r227 rd" class="r227 r">operationOptions</span> = <b>new</b> <span class="i">CimOperationOptions</span>
            {
                <span class="i">Timeout</span> = <span class="i">TimeSpan</span>.<span class="i">FromMilliseconds</span>(10000),
                <span class="i">CancellationToken</span> = <span class="r221 r">cancelToken</span>,
                <span class="c">// This prefix works against all versions of the WinRM server stack, both win8 and win7</span>
                <span class="i">ResourceUriPrefix</span> = <b>new</b> <span class="i">Uri</span>(<a href="#e8bc15cd238f4de0" class="t t">ComputerWMIHelper</a>.<a href="#08c72d7041df8fc6" class="i field">CimUriPrefix</a>)
            };
 
            <b>try</b>
            {
                <b>if</b> (!(<span class="r214 r">isLocalhost</span> &amp;&amp; <span class="i">PlatformInvokes</span>.<span class="i">EnableTokenPrivilege</span>(<a href="#e8bc15cd238f4de0" class="t t">ComputerWMIHelper</a>.<a href="#e0624c83f0b325f8" class="i field">SE_SHUTDOWN_NAME</a>, <b>ref</b> <span class="r226 r">currentPrivilegeState</span>)) &amp;&amp;
                    !(!<span class="r214 r">isLocalhost</span> &amp;&amp; <span class="i">PlatformInvokes</span>.<span class="i">EnableTokenPrivilege</span>(<a href="#e8bc15cd238f4de0" class="t t">ComputerWMIHelper</a>.<a href="#2d365f660fb8ac75" class="i field">SE_REMOTE_SHUTDOWN_NAME</a>, <b>ref</b> <span class="r226 r">currentPrivilegeState</span>)))
                {
                    <b>string</b> <span id="r228 rd" class="r228 r">message</span> =
                        <span class="i">StringUtil</span>.<span class="i">Format</span>(<span class="i">ComputerResources</span>.<span class="i">PrivilegeNotEnabled</span>, <span class="r215 r">computerName</span>,
                            <span class="r214 r">isLocalhost</span> ? <a href="#e8bc15cd238f4de0" class="t t">ComputerWMIHelper</a>.<a href="#e0624c83f0b325f8" class="i field">SE_SHUTDOWN_NAME</a> : <a href="#e8bc15cd238f4de0" class="t t">ComputerWMIHelper</a>.<a href="#2d365f660fb8ac75" class="i field">SE_REMOTE_SHUTDOWN_NAME</a>);
                    <span class="i">ErrorRecord</span> <span id="r229 rd" class="r229 r">errorRecord</span> = <b>new</b>(<b>new</b> <span class="i">InvalidOperationException</span>(<span class="r228 r">message</span>), <span class="s">&quot;PrivilegeNotEnabled&quot;</span>, <span class="i">ErrorCategory</span>.<span class="i">InvalidOperation</span>, <b>null</b>);
                    <span class="r213 r">cmdlet</span>.<span class="i">WriteError</span>(<span class="r229 r">errorRecord</span>);
                    <b>return</b> <b>false</b>;
                }
 
                <b>using</b> (<span class="i">CimSession</span> <span id="r230 rd" class="r230 r">cimSession</span> = <span class="i">RemoteDiscoveryHelper</span>.<span class="i">CreateCimSession</span>(<span class="r223 r">targetMachine</span>, <span class="r225 r">credInUse</span>, <span class="r224 r">authInUse</span>, <span class="r214 r">isLocalhost</span>, <span class="r213 r">cmdlet</span>, <span class="r221 r">cancelToken</span>))
                {
                    <b>var</b> <span id="r231 rd" class="r231 r">methodParameters</span> = <b>new</b> <span class="i">CimMethodParametersCollection</span>();
                    <b>int</b> <span id="r232 rd" class="r232 r">retVal</span>;
                    <span class="r231 r">methodParameters</span>.<span class="i">Add</span>(<span class="i">CimMethodParameter</span>.<span class="i">Create</span>(
                        <span class="s">&quot;Flags&quot;</span>,
                        <span class="r216 r">flags</span>[0],
                        <span class="i n">Microsoft</span>.<span class="i">Management</span>.<span class="i">Infrastructure</span>.<span class="i">CimType</span>.<span class="i">SInt32</span>,
                        <span class="i">CimFlags</span>.<span class="i">None</span>));
 
                    <span class="r231 r">methodParameters</span>.<span class="i">Add</span>(<span class="i">CimMethodParameter</span>.<span class="i">Create</span>(
                        <span class="s">&quot;Reserved&quot;</span>,
                        <span class="r216 r">flags</span>[1],
                        <span class="i n">Microsoft</span>.<span class="i">Management</span>.<span class="i">Infrastructure</span>.<span class="i">CimType</span>.<span class="i">SInt32</span>,
                        <span class="i">CimFlags</span>.<span class="i">None</span>));
 
                    <b>if</b> (!<span class="i">InternalTestHooks</span>.<span class="i">TestStopComputer</span>)
                    {
                        <span class="i">CimMethodResult</span> <span id="r233 rd" class="r233 r">result</span> = <b>null</b>;
 
                        <b>if</b> (<span class="r214 r">isLocalhost</span>)
                        {
                            <span class="c">// Win32_ComputerSystem is a singleton hence FirstOrDefault() return the only instance returned by EnumerateInstances.</span>
                            <b>var</b> <span id="r234 rd" class="r234 r">computerSystem</span> = <span class="r230 r">cimSession</span>.<span class="i">EnumerateInstances</span>(<a href="#e8bc15cd238f4de0" class="t t">ComputerWMIHelper</a>.<a href="#651d3255d91c264e" class="i field">CimOperatingSystemNamespace</a>, <a href="#e8bc15cd238f4de0" class="t t">ComputerWMIHelper</a>.<a href="#8ce54643ae82a88c" class="i field">WMI_Class_OperatingSystem</a>).<span class="i">FirstOrDefault</span>();
 
                            <span class="r233 r">result</span> = <span class="r230 r">cimSession</span>.<span class="i">InvokeMethod</span>(
                                <a href="#e8bc15cd238f4de0" class="t t">ComputerWMIHelper</a>.<a href="#651d3255d91c264e" class="i field">CimOperatingSystemNamespace</a>,
                                <span class="r234 r">computerSystem</span>,
                                <a href="#e8bc15cd238f4de0" class="t t">ComputerWMIHelper</a>.<a href="#5274ea6596528a79" class="i field">CimOperatingSystemShutdownMethod</a>,
                                <span class="r231 r">methodParameters</span>,
                                <span class="r227 r">operationOptions</span>);
                        }
                        <b>else</b>
                        {
                            <span class="r233 r">result</span> = <span class="r230 r">cimSession</span>.<span class="i">InvokeMethod</span>(
                                <a href="#e8bc15cd238f4de0" class="t t">ComputerWMIHelper</a>.<a href="#651d3255d91c264e" class="i field">CimOperatingSystemNamespace</a>,
                                <a href="#e8bc15cd238f4de0" class="t t">ComputerWMIHelper</a>.<a href="#8ce54643ae82a88c" class="i field">WMI_Class_OperatingSystem</a>,
                                <a href="#e8bc15cd238f4de0" class="t t">ComputerWMIHelper</a>.<a href="#5274ea6596528a79" class="i field">CimOperatingSystemShutdownMethod</a>,
                                <span class="r231 r">methodParameters</span>,
                                <span class="r227 r">operationOptions</span>);
                        }
 
                        <span class="r232 r">retVal</span> = <span class="i">Convert</span>.<span class="i">ToInt32</span>(<span class="r233 r">result</span>.<span class="i">ReturnValue</span>.<span class="i">Value</span>, <span class="i">CultureInfo</span>.<span class="i">CurrentCulture</span>);
                    }
                    <b>else</b>
                    {
                        <span class="r232 r">retVal</span> = <span class="i">InternalTestHooks</span>.<span class="i">TestStopComputerResults</span>;
                    }
 
                    <b>if</b> (<span class="r232 r">retVal</span> != 0)
                    {
                        <b>var</b> <span id="r235 rd" class="r235 r">ex</span> = <b>new</b> <span class="i">Win32Exception</span>(<span class="r232 r">retVal</span>);
                        <b>string</b> <span id="r236 rd" class="r236 r">errMsg</span> = <span class="i">StringUtil</span>.<span class="i">Format</span>(<span class="r219 r">formatErrorMessage</span>, <span class="r215 r">computerName</span>, <span class="r235 r">ex</span>.<span class="i">Message</span>);
                        <span class="i">ErrorRecord</span> <span id="r237 rd" class="r237 r">error</span> = <b>new</b>(
                            <b>new</b> <span class="i">InvalidOperationException</span>(<span class="r236 r">errMsg</span>), <span class="r220 r">ErrorFQEID</span>, <span class="i">ErrorCategory</span>.<span class="i">OperationStopped</span>, <span class="r215 r">computerName</span>);
                        <span class="r213 r">cmdlet</span>.<span class="i">WriteError</span>(<span class="r237 r">error</span>);
                    }
                    <b>else</b>
                    {
                        <span class="r222 r">isSuccess</span> = <b>true</b>;
                    }
                }
            }
            <b>catch</b> (<span class="i">CimException</span> <span id="r238 rd" class="r238 r">ex</span>)
            {
                <b>string</b> <span id="r239 rd" class="r239 r">errMsg</span> = <span class="i">StringUtil</span>.<span class="i">Format</span>(<span class="r219 r">formatErrorMessage</span>, <span class="r215 r">computerName</span>, <span class="r238 r">ex</span>.<span class="i">Message</span>);
                <span class="i">ErrorRecord</span> <span id="r240 rd" class="r240 r">error</span> = <b>new</b>(<b>new</b> <span class="i">InvalidOperationException</span>(<span class="r239 r">errMsg</span>), <span class="r220 r">ErrorFQEID</span>,
                                                    <span class="i">ErrorCategory</span>.<span class="i">OperationStopped</span>, <span class="r215 r">computerName</span>);
                <span class="r213 r">cmdlet</span>.<span class="i">WriteError</span>(<span class="r240 r">error</span>);
            }
            <b>catch</b> (<span class="i">Exception</span> <span id="r241 rd" class="r241 r">ex</span>)
            {
                <b>string</b> <span id="r242 rd" class="r242 r">errMsg</span> = <span class="i">StringUtil</span>.<span class="i">Format</span>(<span class="r219 r">formatErrorMessage</span>, <span class="r215 r">computerName</span>, <span class="r241 r">ex</span>.<span class="i">Message</span>);
                <span class="i">ErrorRecord</span> <span id="r243 rd" class="r243 r">error</span> = <b>new</b>(<b>new</b> <span class="i">InvalidOperationException</span>(<span class="r242 r">errMsg</span>), <span class="r220 r">ErrorFQEID</span>,
                                                    <span class="i">ErrorCategory</span>.<span class="i">OperationStopped</span>, <span class="r215 r">computerName</span>);
                <span class="r213 r">cmdlet</span>.<span class="i">WriteError</span>(<span class="r243 r">error</span>);
            }
            <b>finally</b>
            {
                <span class="c">// Restore the previous privilege state if something unexpected happened</span>
                <span class="i">PlatformInvokes</span>.<span class="i">RestoreTokenPrivilege</span>(
                    <span class="r214 r">isLocalhost</span> ? <a href="#e8bc15cd238f4de0" class="t t">ComputerWMIHelper</a>.<a href="#e0624c83f0b325f8" class="i field">SE_SHUTDOWN_NAME</a> : <a href="#e8bc15cd238f4de0" class="t t">ComputerWMIHelper</a>.<a href="#2d365f660fb8ac75" class="i field">SE_REMOTE_SHUTDOWN_NAME</a>, <b>ref</b> <span class="r226 r">currentPrivilegeState</span>);
            }
 
            <b>return</b> <span class="r222 r">isSuccess</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Returns valid computer name or null on failure.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r244 r">nameToCheck</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Computer name to validate.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r245 r">shortLocalMachineName</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r246 r">fullLocalMachineName</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r247 r">error</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">Valid computer name.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal static string</b> <a id="63c511374ea180c9" href="../../R/63c511374ea180c9.html" target="n" data-glyph="74,1" class="i method">ValidateComputerName</a>(
            <b>string</b> <span id="r244 rd" class="r244 r">nameToCheck</span>,
            <b>string</b> <span id="r245 rd" class="r245 r">shortLocalMachineName</span>,
            <b>string</b> <span id="r246 rd" class="r246 r">fullLocalMachineName</span>,
            <b>ref</b> <span class="i">ErrorRecord</span> <span id="r247 rd" class="r247 r">error</span>)
        {
            <b>string</b> <span id="r248 rd" class="r248 r">validatedComputerName</span> = <b>null</b>;
 
            <b>if</b> (<span class="r244 r">nameToCheck</span>.<span class="i">Equals</span>(<span class="s">&quot;.&quot;</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>) ||
                <span class="r244 r">nameToCheck</span>.<span class="i">Equals</span>(<a href="#f343d6c6559c69a3" class="i field">localhostStr</a>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>) ||
                <span class="r244 r">nameToCheck</span>.<span class="i">Equals</span>(<span class="r245 r">shortLocalMachineName</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>) ||
                <span class="r244 r">nameToCheck</span>.<span class="i">Equals</span>(<span class="r246 r">fullLocalMachineName</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
            {
                <span class="r248 r">validatedComputerName</span> = <a href="#f343d6c6559c69a3" class="i field">localhostStr</a>;
            }
            <b>else</b>
            {
                <b>bool</b> <span id="r249 rd" class="r249 r">isIPAddress</span> = <b>false</b>;
                <b>try</b>
                {
                    <span class="i">IPAddress</span> <span id="r250 rd" class="r250 r">unused</span>;
                    <span class="r249 r">isIPAddress</span> = <span class="i">IPAddress</span>.<span class="i">TryParse</span>(<span class="r244 r">nameToCheck</span>, <b>out</b> <span class="r250 r">unused</span>);
                }
                <b>catch</b> (<span class="i">Exception</span>)
                {
                }
 
                <b>try</b>
                {
                    <b>string</b> <span id="r251 rd" class="r251 r">fqcn</span> = <span class="i">Dns</span>.<span class="i">GetHostEntryAsync</span>(<span class="r244 r">nameToCheck</span>).<span class="i">Result</span>.<span class="i">HostName</span>;
                    <b>if</b> (<span class="r251 r">fqcn</span>.<span class="i">Equals</span>(<span class="r245 r">shortLocalMachineName</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>) ||
                        <span class="r251 r">fqcn</span>.<span class="i">Equals</span>(<span class="r246 r">fullLocalMachineName</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
                    {
                        <span class="c">// The IPv4 or IPv6 of the local machine is specified</span>
                        <span class="r248 r">validatedComputerName</span> = <a href="#f343d6c6559c69a3" class="i field">localhostStr</a>;
                    }
                    <b>else</b>
                    {
                        <span class="r248 r">validatedComputerName</span> = <span class="r244 r">nameToCheck</span>;
                    }
                }
                <b>catch</b> (<span class="i">Exception</span> <span id="r252 rd" class="r252 r">e</span>)
                {
                    <span class="c">// If GetHostEntry() throw exception, then the target should not be the local machine</span>
                    <b>if</b> (!<span class="r249 r">isIPAddress</span>)
                    {
                        <span class="c">// Return error if the computer name is not an IP address. Dns.GetHostEntry() may not work on IP addresses.</span>
                        <b>string</b> <span id="r253 rd" class="r253 r">errMsg</span> = <span class="i">StringUtil</span>.<span class="i">Format</span>(<span class="i">ComputerResources</span>.<span class="i">CannotResolveComputerName</span>, <span class="r244 r">nameToCheck</span>, <span class="r252 r">e</span>.<span class="i">Message</span>);
                        <span class="r247 r">error</span> = <b>new</b> <span class="i">ErrorRecord</span>(
                            <b>new</b> <span class="i">InvalidOperationException</span>(<span class="r253 r">errMsg</span>), <span class="s">&quot;AddressResolutionException&quot;</span>,
                            <span class="i">ErrorCategory</span>.<span class="i">InvalidArgument</span>, <span class="r244 r">nameToCheck</span>);
 
                        <b>return</b> <b>null</b>;
                    }
 
                    <span class="r248 r">validatedComputerName</span> = <span class="r244 r">nameToCheck</span>;
                }
            }
 
            <b>return</b> <span class="r248 r">validatedComputerName</span>;
        }
    }
    <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Helper
}
 
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
</pre></td></tr></table></div></body></html>
