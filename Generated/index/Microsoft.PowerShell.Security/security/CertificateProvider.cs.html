<!DOCTYPE html>
<html><head><title>CertificateProvider.cs</title><link rel="stylesheet" href="../../styles.css"><script src="../../scripts.js"></script></head>
<body class="cB" onload="i(3615);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#Microsoft.PowerShell.Security/security/CertificateProvider.cs" target="_top">security\CertificateProvider.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#Microsoft.PowerShell.Security" target="_top">src\Microsoft.PowerShell.Security\Microsoft.PowerShell.Security.csproj</a> (Microsoft.PowerShell.Security)</td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation.</span>
<span class="c">// Licensed under the MIT License.</span>
 
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">UNIX</span>
 
<b>using</b> <span class="i n">System</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Collections</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Collections</span>.<span class="i">Generic</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Collections</span>.<span class="i">ObjectModel</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Diagnostics</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Diagnostics</span>.<span class="i">CodeAnalysis</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Globalization</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">IO</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Host</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Internal</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Provider</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Runtime</span>.<span class="i">InteropServices</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Security</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Security</span>.<span class="i">Cryptography</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Security</span>.<span class="i">Cryptography</span>.<span class="i">X509Certificates</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Text</span>.<span class="i">RegularExpressions</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Xml</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Xml</span>.<span class="i">XPath</span>;
 
<b>using</b> <span class="i">Dbg</span> = <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>;
<b>using</b> <span class="i">DWORD</span> = <span class="i n">System</span>.<span class="i">UInt32</span>;
<b>using</b> <span class="i">Runspaces</span> = <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Runspaces</span>;
<b>using</b> <span class="i">Security</span> = <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Security</span>;
 
<b>namespace</b> <span class="i n">Microsoft</span>.<span class="i n">PowerShell</span>.<span class="i n">Commands</span>
{
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Defines the Certificate Provider dynamic parameters.</span>
    <span class="c">///</span><span class="c"> We only support one dynamic parameter for Win 7 and earlier:</span>
    <span class="c">///</span><span class="c"> CodeSigningCert</span>
    <span class="c">///</span><span class="c"> If provided, we only return certificates valid for signing code or</span>
    <span class="c">///</span><span class="c"> scripts.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>internal sealed class</b> <a id="aab93afeaaefc1f3" href="../R/aab93afeaaefc1f3.html" target="n" data-glyph="2,0" class="t t"><span id="75d750f3454c58d1">CertificateProviderDynamicParameters</span></a>
    {
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets or sets a switch that controls whether we only return</span>
        <span class="c">///</span><span class="c"> code signing certs.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>]
        <b>public</b> <a href="/System.Management.Automation/A.html#8260026027378f6c" class="t t">SwitchParameter</a> <a id="69bb046f9713336b" href="../R/69bb046f9713336b.html" target="n" data-glyph="102,1" class="i property">CodeSigningCert</a>
        {
            <b>get</b> { <b>return</b> <a href="#e4d77372d42e0317" class="i field">_codeSigningCert</a>; }
 
            <b>set</b> { <a href="#e4d77372d42e0317" class="i field">_codeSigningCert</a> = <b>value</b>; }
        }
 
        <b>private</b> <a href="/System.Management.Automation/A.html#8260026027378f6c" class="t t">SwitchParameter</a> <a id="e4d77372d42e0317" href="../R/e4d77372d42e0317.html" target="n" data-glyph="46,1" class="i field">_codeSigningCert</a> = <b>new</b>();
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets or sets a filter that controls whether we only return</span>
        <span class="c">///</span><span class="c"> data encipherment certs.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>]
        <b>public</b> <a href="/System.Management.Automation/A.html#8260026027378f6c" class="t t">SwitchParameter</a> <a id="10296ef7a5bd3f32" href="../R/10296ef7a5bd3f32.html" target="n" data-glyph="102,1" class="i property">DocumentEncryptionCert</a>
        {
            <b>get</b>;
            <b>set</b>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets or sets a filter that controls whether we only return</span>
        <span class="c">///</span><span class="c"> server authentication certs.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>]
        <b>public</b> <a href="/System.Management.Automation/A.html#8260026027378f6c" class="t t">SwitchParameter</a> <a id="0e723f22e39be04d" href="../R/0e723f22e39be04d.html" target="n" data-glyph="102,1" class="i property">SSLServerAuthentication</a>
        {
            <b>get</b>;
            <b>set</b>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets or sets a filter by DNSName.</span>
        <span class="c">///</span><span class="c"> Expected content is a single DNS Name that may start and/or end</span>
        <span class="c">///</span><span class="c"> with &#39;*&#39;: &quot;contoso.com&quot; or &quot;*toso.c*&quot;.</span>
        <span class="c">///</span><span class="c"> All WildcardPattern class features supported.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>]
        <b>public string</b> <a id="b3c941049887c52b" href="../R/b3c941049887c52b.html" target="n" data-glyph="102,1" class="i property">DnsName</a>
        {
            <b>get</b>;
            <b>set</b>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets or sets a filter by EKU.</span>
        <span class="c">///</span><span class="c"> Expected content is one or more OID strings:</span>
        <span class="c">///</span><span class="c"> &quot;1.3.6.1.5.5.7.3.1&quot;, &quot;*Server*&quot;, etc.</span>
        <span class="c">///</span><span class="c"> For a cert to match, it must be valid for all listed OIDs.</span>
        <span class="c">///</span><span class="c"> All WildcardPattern class features supported.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>]
        <b>public string</b>[] <a id="0fd3793b9e45cabc" href="../R/0fd3793b9e45cabc.html" target="n" data-glyph="102,1" class="i property">Eku</a>
        {
            <b>get</b>;
            <b>set</b>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets or sets a filter by the number of valid days.</span>
        <span class="c">///</span><span class="c"> Expected content is a non-negative integer.</span>
        <span class="c">///</span><span class="c"> &quot;0&quot; matches all certs that have already expired.</span>
        <span class="c">///</span><span class="c"> &quot;1&quot; matches all certs that are currently valid and will expire</span>
        <span class="c">///</span><span class="c"> by next day (local time).</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>]
        [<span class="i">ValidateRange</span>(<a href="/System.Management.Automation/A.html#9533fc8813743b40" class="t t">ValidateRangeKind</a>.<a href="/System.Management.Automation/A.html#909f9a368b4be710" class="i field">NonNegative</a>)]
        <b>public int</b> <a id="b6020508cb729b41" href="../R/b6020508cb729b41.html" target="n" data-glyph="102,1" class="i property">ExpiringInDays</a>
        {
            <b>get</b>;
            <b>set</b>;
        } = -1;
    }
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Defines the type of DNS string</span>
    <span class="c">///</span><span class="c"> The structure contains punycode name and unicode name.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Performance&quot;</span>, <span class="s">&quot;CA1815:OverrideEqualsAndOperatorEqualsOnValueTypes&quot;</span>)]
    <b>public readonly struct</b> <a id="236f3219648f587a" href="../R/236f3219648f587a.html" target="n" data-glyph="108,0" class="t t"><span id="1b0c7c76eb9607b1">DnsNameRepresentation</span></a>
    {
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Punycode version of DNS name.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private readonly string</b> <a id="4f85fa56f7f5dde4" href="../R/4f85fa56f7f5dde4.html" target="n" data-glyph="46,1" class="i field">_punycodeName</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Unicode version of DNS name.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private readonly string</b> <a id="9c1b01bf958bb33c" href="../R/9c1b01bf958bb33c.html" target="n" data-glyph="46,1" class="i field">_unicodeName</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Ambiguous constructor of a DnsNameRepresentation.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public</b> <a id="ed2af653d03c9257" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="t constructor">DnsNameRepresentation</a>(<b>string</b> <span id="r0 rd" class="r0 r">inputDnsName</span>)
        {
            <a href="#4f85fa56f7f5dde4" class="i field">_punycodeName</a> = <span class="r0 r">inputDnsName</span>;
            <a href="#9c1b01bf958bb33c" class="i field">_unicodeName</a> = <span class="r0 r">inputDnsName</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Specific constructor of a DnsNameRepresentation.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Naming&quot;</span>, <span class="s">&quot;CA1704:IdentifiersShouldBeSpelledCorrectly&quot;</span>, <span class="i">MessageId</span> = <span class="s">&quot;Punycode&quot;</span>)]
        <b>public</b> <a id="5385a51da0d64684" href="../R/5385a51da0d64684.html" target="n" data-glyph="72,1" class="t constructor">DnsNameRepresentation</a>(
            <b>string</b> <span id="r1 rd" class="r1 r">inputPunycodeName</span>,
            <b>string</b> <span id="r2 rd" class="r2 r">inputUnicodeName</span>)
        {
            <a href="#4f85fa56f7f5dde4" class="i field">_punycodeName</a> = <span class="r1 r">inputPunycodeName</span>;
            <a href="#9c1b01bf958bb33c" class="i field">_unicodeName</a> = <span class="r2 r">inputUnicodeName</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Value comparison.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public bool</b> <a id="d7455e074a834164" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">Equals</a>(<a href="#236f3219648f587a" class="t t">DnsNameRepresentation</a> <span id="r3 rd" class="r3 r">dnsName</span>)
        {
            <b>bool</b> <span id="r4 rd" class="r4 r">match</span> = <b>false</b>;
 
            <b>if</b> (<a href="#9c1b01bf958bb33c" class="i field">_unicodeName</a> != <b>null</b> &amp;&amp; <span class="r3 r">dnsName</span>.<a href="#9c1b01bf958bb33c" class="i field">_unicodeName</a> != <b>null</b>)
            {
                <b>if</b> (<b>string</b>.<span class="i">Equals</span>(
                            <a href="#9c1b01bf958bb33c" class="i field">_unicodeName</a>,
                            <span class="r3 r">dnsName</span>.<a href="#9c1b01bf958bb33c" class="i field">_unicodeName</a>,
                            <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
                {
                    <span class="r4 r">match</span> = <b>true</b>;
                }
            }
            <b>else</b> <b>if</b> (<a href="#9c1b01bf958bb33c" class="i field">_unicodeName</a> == <b>null</b> &amp;&amp; <span class="r3 r">dnsName</span>.<a href="#9c1b01bf958bb33c" class="i field">_unicodeName</a> == <b>null</b>)
            {
                <span class="r4 r">match</span> = <b>true</b>;
            }
 
            <b>return</b> <span class="r4 r">match</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Get property of Punycode.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Naming&quot;</span>, <span class="s">&quot;CA1704:IdentifiersShouldBeSpelledCorrectly&quot;</span>, <span class="i">MessageId</span> = <span class="s">&quot;Punycode&quot;</span>)]
        <b>public string</b> <a id="2c1251e048eb6d5e" href="../R/../../0000000000.html" target="n" data-glyph="102,1" class="i property">Punycode</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#4f85fa56f7f5dde4" class="i field">_punycodeName</a>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Get property of Unicode.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public string</b> <a id="d6667fcc0d378b72" href="../R/d6667fcc0d378b72.html" target="n" data-glyph="102,1" class="i property">Unicode</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#9c1b01bf958bb33c" class="i field">_unicodeName</a>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Get display string.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public override string</b> <a id="0b1ecc2ccc4cb750" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">ToString</a>()
        {
            <span class="c">// Use case sensitive comparison here.</span>
            <span class="c">// We don&#39;t ever expect to see the punycode and unicode strings</span>
            <span class="c">// to differ only by upper/lower case.  If they do, that&#39;s really</span>
            <span class="c">// a code bug, and the effect is to just display both strings.</span>
 
            <b>return</b> <b>string</b>.<span class="i">Equals</span>(<a href="#4f85fa56f7f5dde4" class="i field">_punycodeName</a>, <a href="#9c1b01bf958bb33c" class="i field">_unicodeName</a>, <span class="i">StringComparison</span>.<span class="i">Ordinal</span>)
                ? <a href="#4f85fa56f7f5dde4" class="i field">_punycodeName</a>
                : <a href="#9c1b01bf958bb33c" class="i field">_unicodeName</a> + <span class="s">&quot; (&quot;</span> + <a href="#4f85fa56f7f5dde4" class="i field">_punycodeName</a> + <span class="s">&quot;)&quot;</span>;
        }
    }
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Defines the Certificate Provider remove-item dynamic parameters.</span>
    <span class="c">///</span>
    <span class="c">///</span><span class="c"> Currently, we only support one dynamic parameter: DeleteKey</span>
    <span class="c">///</span><span class="c"> If provided, we will delete the private key when we remove a certificate.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>internal sealed class</b> <a id="92f7a4edfeee598c" href="../R/92f7a4edfeee598c.html" target="n" data-glyph="2,0" class="t t"><span id="4925fac14b6f8bea">ProviderRemoveItemDynamicParameters</span></a>
    {
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Switch that controls whether we should delete private key</span>
        <span class="c">///</span><span class="c"> when remove a certificate.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>]
        <b>public</b> <a href="/System.Management.Automation/A.html#8260026027378f6c" class="t t">SwitchParameter</a> <a id="c6dbb19747944ce7" href="../R/c6dbb19747944ce7.html" target="n" data-glyph="102,1" class="i property">DeleteKey</a>
        {
            <b>get</b>
            {
                {
                    <b>return</b> <a href="#ce6b9ae0ff6a910f" class="i field">_deleteKey</a>;
                }
            }
 
            <b>set</b>
            {
                {
                    <a href="#ce6b9ae0ff6a910f" class="i field">_deleteKey</a> = <b>value</b>;
                }
            }
        }
 
        <b>private</b> <a href="/System.Management.Automation/A.html#8260026027378f6c" class="t t">SwitchParameter</a> <a id="ce6b9ae0ff6a910f" href="../R/ce6b9ae0ff6a910f.html" target="n" data-glyph="46,1" class="i field">_deleteKey</a> = <b>new</b>();
    }
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Defines the safe handle class for native cert store handles,</span>
    <span class="c">///</span><span class="c"> HCERTSTORE.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>internal sealed class</b> <a id="ba7354514cf441cd" href="../R/ba7354514cf441cd.html" target="n" data-glyph="2,0" class="t t">CertificateStoreHandle</a> : <span class="i">SafeHandle</span>
    {
        <b>public</b> <a id="dae4ec95304912a2" href="../R/dae4ec95304912a2.html" target="n" data-glyph="72,1" class="t constructor">CertificateStoreHandle</a>() : <b>base</b>(<span class="i">IntPtr</span>.<span class="i">Zero</span>, <b>true</b>)
        {
            <b>return</b>;
        }
 
        <b>public override bool</b> <a id="262a2c8f66555d83" href="../R/../../0000000000.html" target="n" data-glyph="102,1" class="i property">IsInvalid</a>
        {
            <b>get</b> { <b>return</b> <span class="i">handle</span> == <span class="i">IntPtr</span>.<span class="i">Zero</span>; }
        }
 
        <b>protected override bool</b> <a id="434cf1bbe00f90bc" href="../R/../../0000000000.html" target="n" data-glyph="75,1" class="i method">ReleaseHandle</a>()
        {
            <b>bool</b> <span id="r5 rd" class="r5 r">fResult</span> = <b>false</b>;
 
            <b>if</b> (<span class="i">handle</span> != <span class="i">IntPtr</span>.<span class="i">Zero</span>)
            {
                <span class="r5 r">fResult</span> = <span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">CertCloseStore</span>(<span class="i">handle</span>, 0);
                <span class="i">handle</span> = <span class="i">IntPtr</span>.<span class="i">Zero</span>;
            }
 
            <b>return</b> <span class="r5 r">fResult</span>;
        }
 
        <b>public</b> <span class="i">IntPtr</span> <a id="599b13f6d896602d" href="../R/599b13f6d896602d.html" target="n" data-glyph="102,1" class="i property">Handle</a>
        {
            <b>get</b> { <b>return</b> <span class="i">handle</span>; }
 
            <b>set</b> { <span class="i">handle</span> = <b>value</b>; }
        }
    }
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Defines the Certificate Provider store handle class.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>internal sealed class</b> <a id="b042c5630701a14b" href="../R/b042c5630701a14b.html" target="n" data-glyph="2,0" class="t t">X509NativeStore</a>
    {
        <span class="c">// #region tracer</span>
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Initializes a new instance of the X509NativeStore class.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public</b> <a id="c67b6a7a29e8994a" href="../R/c67b6a7a29e8994a.html" target="n" data-glyph="72,1" class="t constructor">X509NativeStore</a>(<a href="#2a4c4cd887b45563" class="t t">X509StoreLocation</a> <span id="r6 rd" class="r6 r">StoreLocation</span>, <b>string</b> <span id="r7 rd" class="r7 r">StoreName</span>)
        {
            <a href="#a7769e2e9202a7a3" class="i field">_storeLocation</a> = <span class="r6 r">StoreLocation</span>;
            <a href="#0887a589fa6dc9a3" class="i field">_storeName</a> = <span class="r7 r">StoreName</span>;
        }
 
        <b>public void</b> <a id="d28202dfbc20d0d8" href="../R/d28202dfbc20d0d8.html" target="n" data-glyph="72,1" class="i method">Open</a>(<b>bool</b> <span id="r8 rd" class="r8 r">includeArchivedCerts</span>)
        {
            <b>if</b> (<a href="#a375a51bf5bc2e1c" class="i field">_storeHandle</a> != <b>null</b> &amp;&amp; <a href="#650feec89b70bc01" class="i field">_archivedCerts</a> != <span class="r8 r">includeArchivedCerts</span>)
            {
                <a href="#a375a51bf5bc2e1c" class="i field">_storeHandle</a> = <b>null</b>;        <span class="c">// release the old handle</span>
            }
 
            <b>if</b> (<a href="#a375a51bf5bc2e1c" class="i field">_storeHandle</a> == <b>null</b>)
            {
                <a href="#1a9e8615968b9d66" class="i field">_valid</a> = <b>false</b>;
                <a href="#08050c64ab251bee" class="i field">_open</a> = <b>false</b>;
 
                <span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">CertOpenStoreFlags</span> <span id="r9 rd" class="r9 r">StoreFlags</span> =
                    <span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">CertOpenStoreFlags</span>.<span class="i">CERT_STORE_SHARE_STORE_FLAG</span> |
                    <span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">CertOpenStoreFlags</span>.<span class="i">CERT_STORE_SHARE_CONTEXT_FLAG</span> |
                    <span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">CertOpenStoreFlags</span>.<span class="i">CERT_STORE_OPEN_EXISTING_FLAG</span> |
                    <span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">CertOpenStoreFlags</span>.<span class="i">CERT_STORE_MAXIMUM_ALLOWED_FLAG</span>;
 
                <b>if</b> (<span class="r8 r">includeArchivedCerts</span>)
                {
                    <span class="r9 r">StoreFlags</span> |= <span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">CertOpenStoreFlags</span>.<span class="i">CERT_STORE_ENUM_ARCHIVED_FLAG</span>;
                }
 
                <b>switch</b> (<a href="#a7769e2e9202a7a3" class="i field">_storeLocation</a>.<a href="#2fcfcb7271252c0c" class="i property">Location</a>)
                {
                    <b>case</b> <span class="i">StoreLocation</span>.<span class="i">LocalMachine</span>:
                        <span class="r9 r">StoreFlags</span> |= <span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">CertOpenStoreFlags</span>.<span class="i">CERT_SYSTEM_STORE_LOCAL_MACHINE</span>;
                        <b>break</b>;
 
                    <b>case</b> <span class="i">StoreLocation</span>.<span class="i">CurrentUser</span>:
                        <span class="r9 r">StoreFlags</span> |= <span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">CertOpenStoreFlags</span>.<span class="i">CERT_SYSTEM_STORE_CURRENT_USER</span>;
                        <b>break</b>;
 
                    <b>default</b>:
                        <span class="c">// ThrowItemNotFound(storeLocation.ToString(), CertificateProviderItem.StoreLocation);</span>
                        <b>break</b>;
                }
 
                <span class="i">IntPtr</span> <span id="r10 rd" class="r10 r">hCertStore</span> = <span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">CertOpenStore</span>(
                                <span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">CertOpenStoreProvider</span>.<span class="i">CERT_STORE_PROV_SYSTEM</span>,
                                <span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">CertOpenStoreEncodingType</span>.<span class="i">X509_ASN_ENCODING</span>,
                                <span class="i">IntPtr</span>.<span class="i">Zero</span>,  <span class="c">// hCryptProv</span>
                                <span class="r9 r">StoreFlags</span>,
                                <a href="#0887a589fa6dc9a3" class="i field">_storeName</a>);
                <b>if</b> (<span class="r10 r">hCertStore</span> == <span class="i">IntPtr</span>.<span class="i">Zero</span>)
                {
                    <b>throw</b> <b>new</b> <span class="i n">System</span>.<span class="i">ComponentModel</span>.<span class="i">Win32Exception</span>(<span class="i">Marshal</span>.<span class="i">GetLastWin32Error</span>());
                }
 
                <a href="#a375a51bf5bc2e1c" class="i field">_storeHandle</a> = <b>new</b> <a href="#dae4ec95304912a2" class="t constructor">CertificateStoreHandle</a>();
                <a href="#a375a51bf5bc2e1c" class="i field">_storeHandle</a>.<a href="#599b13f6d896602d" class="i property">Handle</a> = <span class="r10 r">hCertStore</span>;
 
                <span class="c">// we only do CertControlStore for stores other than UserDS</span>
                <b>if</b> (!<b>string</b>.<span class="i">Equals</span>(
                                <a href="#0887a589fa6dc9a3" class="i field">_storeName</a>,
                                <span class="s">&quot;UserDS&quot;</span>,
                                <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
                {
                    <b>if</b> (!<span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">CertControlStore</span>(
                                <a href="#a375a51bf5bc2e1c" class="i field">_storeHandle</a>.<a href="#599b13f6d896602d" class="i property">Handle</a>,
                                0,
                                <span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">CertControlStoreType</span>.<span class="i">CERT_STORE_CTRL_AUTO_RESYNC</span>,
                                <span class="i">IntPtr</span>.<span class="i">Zero</span>))
                    {
                        <a href="#a375a51bf5bc2e1c" class="i field">_storeHandle</a> = <b>null</b>;
                        <b>throw</b> <b>new</b> <span class="i n">System</span>.<span class="i">ComponentModel</span>.<span class="i">Win32Exception</span>(<span class="i">Marshal</span>.<span class="i">GetLastWin32Error</span>());
                    }
                }
 
                <a href="#1a9e8615968b9d66" class="i field">_valid</a> = <b>true</b>;
                <a href="#08050c64ab251bee" class="i field">_open</a> = <b>true</b>;
                <a href="#650feec89b70bc01" class="i field">_archivedCerts</a> = <span class="r8 r">includeArchivedCerts</span>;
            }
        }
 
        <b>public</b> <span class="i">IntPtr</span> <a id="939ecd37de4b527e" href="../R/939ecd37de4b527e.html" target="n" data-glyph="72,1" class="i method">GetFirstCert</a>()
        {
            <b>return</b> <span class="i">GetNextCert</span>(<span class="i">IntPtr</span>.<span class="i">Zero</span>);
        }
 
        <b>public</b> <span class="i">IntPtr</span> <a id="03be2ed900c1b0c8" href="../R/03be2ed900c1b0c8.html" target="n" data-glyph="72,1" class="i method">GetNextCert</a>(<span class="i">IntPtr</span> <span id="r11 rd" class="r11 r">certContext</span>)
        {
            <b>if</b> (!<a href="#08050c64ab251bee" class="i field">_open</a>)
            {
                <b>throw</b> <span class="i">Marshal</span>.<span class="i">GetExceptionForHR</span>(
                                    <span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">CRYPT_E_NOT_FOUND</span>);
            }
 
            <b>if</b> (<a href="#3bfae204bcee6809" class="i property">Valid</a>)
            {
                <span class="r11 r">certContext</span> = <span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">CertEnumCertificatesInStore</span>(
                                                    <a href="#a375a51bf5bc2e1c" class="i field">_storeHandle</a>.<a href="#599b13f6d896602d" class="i property">Handle</a>,
                                                    <span class="r11 r">certContext</span>);
            }
            <b>else</b>
            {
                <span class="r11 r">certContext</span> = <span class="i">IntPtr</span>.<span class="i">Zero</span>;
            }
 
            <b>return</b> <span class="r11 r">certContext</span>;
        }
 
        <b>public</b> <span class="i">IntPtr</span> <a id="d860dfcc81066e57" href="../R/d860dfcc81066e57.html" target="n" data-glyph="72,1" class="i method">GetCertByName</a>(<b>string</b> <span id="r12 rd" class="r12 r">Name</span>)
        {
            <span class="i">IntPtr</span> <span id="r13 rd" class="r13 r">certContext</span> = <span class="i">IntPtr</span>.<span class="i">Zero</span>;
 
            <b>if</b> (!<a href="#08050c64ab251bee" class="i field">_open</a>)
            {
                <b>throw</b> <span class="i">Marshal</span>.<span class="i">GetExceptionForHR</span>(
                                    <span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">CRYPT_E_NOT_FOUND</span>);
            }
 
            <b>if</b> (<a href="#3bfae204bcee6809" class="i property">Valid</a>)
            {
                <b>if</b> (<a href="#9088e9d56a46b577" class="t t">DownLevelHelper</a>.<a href="#47230082ac4ade07" class="i method">HashLookupSupported</a>())
                {
                    <span class="r13 r">certContext</span> = <span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">CertFindCertificateInStore</span>(
                            <a href="#a375a51bf5bc2e1c" class="i field">_storeHandle</a>.<a href="#599b13f6d896602d" class="i property">Handle</a>,
                            <span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">CertOpenStoreEncodingType</span>.<span class="i">X509_ASN_ENCODING</span>,
                            0,                                <span class="c">// dwFindFlags</span>
                            <span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">CertFindType</span>.<span class="i">CERT_FIND_HASH_STR</span>,
                            <span class="r12 r">Name</span>,
                            <span class="i">IntPtr</span>.<span class="i">Zero</span>);                     <span class="c">// pPrevCertContext</span>
                }
                <b>else</b>
                {
                    <span class="c">//</span>
                    <span class="c">// the pre-Win8 CAPI2 code does not provide an easy way</span>
                    <span class="c">// to directly access a specific certificate.</span>
                    <span class="c">// We have to iterate through all certs to find</span>
                    <span class="c">// what we want.</span>
                    <span class="c">//</span>
 
                    <b>while</b> (<b>true</b>)
                    {
                        <span class="r13 r">certContext</span> = <a href="#03be2ed900c1b0c8" class="i method">GetNextCert</a>(<span class="r13 r">certContext</span>);
                        <b>if</b> (<span class="r13 r">certContext</span> == <span class="i">IntPtr</span>.<span class="i">Zero</span>)
                        {
                            <b>break</b>;
                        }
 
                        <span class="i">X509Certificate2</span> <span id="r14 rd" class="r14 r">cert</span> = <b>new</b>(<span class="r13 r">certContext</span>);
                        <b>if</b> (<b>string</b>.<span class="i">Equals</span>(
                                    <span class="r14 r">cert</span>.<span class="i">Thumbprint</span>,
                                    <span class="r12 r">Name</span>,
                                    <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
                        {
                            <b>break</b>;
                        }
                    }
                }
            }
 
            <b>return</b> <span class="r13 r">certContext</span>;
        }
 
        <b>public void</b> <a id="2b44ac4b9e1d3dab" href="../R/2b44ac4b9e1d3dab.html" target="n" data-glyph="72,1" class="i method">FreeCert</a>(<span class="i">IntPtr</span> <span id="r15 rd" class="r15 r">certContext</span>)
        {
            <span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">CertFreeCertificateContext</span>(<span class="r15 r">certContext</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Native IntPtr store handle.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public</b> <span class="i">IntPtr</span> <a id="7eb31f2ba64133ff" href="../R/7eb31f2ba64133ff.html" target="n" data-glyph="102,1" class="i property">StoreHandle</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#a375a51bf5bc2e1c" class="i field">_storeHandle</a>.<a href="#599b13f6d896602d" class="i property">Handle</a>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> X509StoreLocation store location.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public</b> <a href="#2a4c4cd887b45563" class="t t">X509StoreLocation</a> <a id="3aa7db610be0ad56" href="../R/3aa7db610be0ad56.html" target="n" data-glyph="102,1" class="i property">Location</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#a7769e2e9202a7a3" class="i field">_storeLocation</a>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> String store name.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public string</b> <a id="76acf366fbf24982" href="../R/76acf366fbf24982.html" target="n" data-glyph="102,1" class="i property">StoreName</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#0887a589fa6dc9a3" class="i field">_storeName</a>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> True if a real store is open.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public bool</b> <a id="3bfae204bcee6809" href="../R/3bfae204bcee6809.html" target="n" data-glyph="102,1" class="i property">Valid</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#1a9e8615968b9d66" class="i field">_valid</a>;
            }
        }
 
        <b>private bool</b> <a id="650feec89b70bc01" href="../R/650feec89b70bc01.html" target="n" data-glyph="46,1" class="i field">_archivedCerts</a> = <b>false</b>;
        <b>private readonly</b> <a href="#2a4c4cd887b45563" class="t t">X509StoreLocation</a> <a id="a7769e2e9202a7a3" href="../R/a7769e2e9202a7a3.html" target="n" data-glyph="46,1" class="i field">_storeLocation</a> = <b>null</b>;
        <b>private readonly string</b> <a id="0887a589fa6dc9a3" href="../R/0887a589fa6dc9a3.html" target="n" data-glyph="46,1" class="i field">_storeName</a> = <b>null</b>;
        <b>private</b> <a href="#ba7354514cf441cd" class="t t">CertificateStoreHandle</a> <a id="a375a51bf5bc2e1c" href="../R/a375a51bf5bc2e1c.html" target="n" data-glyph="46,1" class="i field">_storeHandle</a> = <b>null</b>;
        <b>private bool</b> <a id="1a9e8615968b9d66" href="../R/1a9e8615968b9d66.html" target="n" data-glyph="46,1" class="i field">_valid</a> = <b>false</b>;
        <b>private bool</b> <a id="08050c64ab251bee" href="../R/08050c64ab251bee.html" target="n" data-glyph="46,1" class="i field">_open</a> = <b>false</b>;
    }
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Defines the types of items</span>
    <span class="c">///</span><span class="c"> supported by the certificate provider.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>internal enum</b> <a id="e8d23026f96d84c8" href="../R/e8d23026f96d84c8.html" target="n" data-glyph="20,0" class="t t"><span id="40a5ea00f2303b73">CertificateProviderItem</span></a>
    {
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> An unknown item.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <a id="5f5f4a8ddedced38" href="../R/../../0000000000.html" target="n" data-glyph="24,1" class="i field">Unknown</a>,
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> An X509 Certificate.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <a id="82505c9bafd5fc3e" href="../R/82505c9bafd5fc3e.html" target="n" data-glyph="24,1" class="i field">Certificate</a>,
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> A certificate store location.</span>
        <span class="c">///</span><span class="c"> For example, cert:\CurrentUser.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <a id="8dd368d9b1529869" href="../R/8dd368d9b1529869.html" target="n" data-glyph="24,1" class="i field">Store</a>,
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> A certificate store.</span>
        <span class="c">///</span><span class="c"> For example, cert:\CurrentUser\My.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <a id="b22e248f66ce18c6" href="../R/b22e248f66ce18c6.html" target="n" data-glyph="24,1" class="i field">StoreLocation</a>
    }
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Defines the implementation of a Certificate Store Provider.  This provider</span>
    <span class="c">///</span><span class="c"> allows for stateless namespace navigation of the computer&#39;s certificate</span>
    <span class="c">///</span><span class="c"> store.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    [<span class="i">CmdletProvider</span>(<span class="s">&quot;Certificate&quot;</span>, <a href="/System.Management.Automation/A.html#a29c0c50418632fb" class="t t">ProviderCapabilities</a>.<a href="/System.Management.Automation/A.html#1c74e44e7cb58abe" class="i field">ShouldProcess</a>)]
    [<span class="i">OutputType</span>(<b>typeof</b>(<b>string</b>), <b>typeof</b>(<a href="/System.Management.Automation/A.html#9504cfb54420cfd7" class="t t">PathInfo</a>), <a href="/System.Management.Automation/A.html#d8d80d601118095c" class="i property">ProviderCmdlet</a> = <a href="/System.Management.Automation/A.html#148012d7a65af04c" class="t t">ProviderCmdlet</a>.<a href="/System.Management.Automation/A.html#4e62cf10a09d1e17" class="i field">ResolvePath</a>)]
    [<span class="i">OutputType</span>(<b>typeof</b>(<a href="/System.Management.Automation/A.html#9504cfb54420cfd7" class="t t">PathInfo</a>), <a href="/System.Management.Automation/A.html#d8d80d601118095c" class="i property">ProviderCmdlet</a> = <a href="/System.Management.Automation/A.html#148012d7a65af04c" class="t t">ProviderCmdlet</a>.<a href="/System.Management.Automation/A.html#6178e5d7b1d2527a" class="i field">PushLocation</a>)]
    [<span class="i">OutputType</span>(<b>typeof</b>(<span class="i n">Microsoft</span>.<span class="i n">PowerShell</span>.<span class="i n">Commands</span>.<a href="#2a4c4cd887b45563" class="t t">X509StoreLocation</a>), <b>typeof</b>(<span class="i">X509Certificate2</span>), <a href="/System.Management.Automation/A.html#d8d80d601118095c" class="i property">ProviderCmdlet</a> = <a href="/System.Management.Automation/A.html#148012d7a65af04c" class="t t">ProviderCmdlet</a>.<a href="/System.Management.Automation/A.html#d5a1345545ad36b3" class="i field">GetItem</a>)]
    [<span class="i">OutputType</span>(<b>typeof</b>(<span class="i">X509Store</span>), <b>typeof</b>(<span class="i">X509Certificate2</span>), <a href="/System.Management.Automation/A.html#d8d80d601118095c" class="i property">ProviderCmdlet</a> = <a href="/System.Management.Automation/A.html#148012d7a65af04c" class="t t">ProviderCmdlet</a>.<a href="/System.Management.Automation/A.html#077ace411238b46a" class="i field">GetChildItem</a>)]
    <b>public sealed class</b> <a id="c2a6f6e8e1dd509a" href="../R/../../0000000000.html" target="n" data-glyph="0,0" class="t t">CertificateProvider</a> : <a href="/System.Management.Automation/A.html#7d31476313596b0b" class="t t">NavigationCmdletProvider</a>, <a href="/System.Management.Automation/A.html#3e872a90de02a9b2" class="t t">ICmdletProviderSupportsHelp</a>
    {
        <span class="k preprocess">#</span><span class="k preprocess">region</span> tracer
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Tracer for certificate provider.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">TraceSource</span>(<span class="s">&quot;CertificateProvider&quot;</span>,
                      <span class="s">&quot;The core command provider for certificates&quot;</span>)]
        <b>private static readonly</b> <a href="/System.Management.Automation/A.html#6de812d1f374e1ae" class="t t">PSTraceSource</a> <a id="798f0bbd23a8926c" href="../R/798f0bbd23a8926c.html" target="n" data-glyph="46,1" class="i field">s_tracer</a> = <a href="/System.Management.Automation/A.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<span class="i">GetTracer</span>(<span class="s">&quot;CertificateProvider&quot;</span>,
                      <span class="s">&quot;The core command provider for certificates&quot;</span>);
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> tracer
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Indicate if we already have attempted to load the PKI module.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private bool</b> <a id="3057324a208a416e" href="../R/3057324a208a416e.html" target="n" data-glyph="46,1" class="i field">_hasAttemptedToLoadPkiModule</a> = <b>false</b>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Lock that guards access to the following static members</span>
        <span class="c">///</span><span class="c"> -- storeLocations</span>
        <span class="c">///</span><span class="c"> -- pathCache.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private static readonly object</b> <a id="1233d9342632009e" href="../R/1233d9342632009e.html" target="n" data-glyph="46,1" class="i field">s_staticLock</a> = <b>new</b>();
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> List of store locations. They do not change once initialized.</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> Synchronized on staticLock.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private static</b> <span class="i">List</span>&lt;<a href="#2a4c4cd887b45563" class="t t">X509StoreLocation</a>&gt; <a id="a61857b26b0f04c8" href="../R/a61857b26b0f04c8.html" target="n" data-glyph="46,1" class="i field">s_storeLocations</a> = <b>null</b>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Cache that stores paths and their associated objects.</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> key is full path to store-location/store/certificate</span>
        <span class="c">///</span><span class="c"> value is X509StoreLocation/X509NativeStore/X509Certificate2 object</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> Synchronized on staticLock.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private static</b> <span class="i">Hashtable</span> <a id="987ef6b9e1e7929a" href="../R/987ef6b9e1e7929a.html" target="n" data-glyph="46,1" class="i field">s_pathCache</a> = <b>null</b>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> We allow either / or \ to be the path separator.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private static readonly char</b>[] <a id="60b62183a3e2c487" href="../R/60b62183a3e2c487.html" target="n" data-glyph="46,1" class="i field">s_pathSeparators</a> = <b>new</b> <b>char</b>[] { <span class="s">&#39;/&#39;</span>, <span class="s">&#39;\\&#39;</span> };
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Regex pattern that defines a valid cert path.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private const string</b> <a id="29b967940bba3cdc" href="../R/29b967940bba3cdc.html" target="n" data-glyph="10,1" class="i field">certPathPattern</a> = <span class="s">@&quot;^\\((?&lt;StoreLocation&gt;CurrentUser|LocalMachine)(\\(?&lt;StoreName&gt;[a-zA-Z]+)(\\(?&lt;Thumbprint&gt;[0-9a-f]{40}))?)?)?$&quot;</span>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Cache the store handle to avoid repeated CertOpenStore calls.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private static</b> <a href="#b042c5630701a14b" class="t t">X509NativeStore</a> <a id="f7b4721498f564c1" href="../R/f7b4721498f564c1.html" target="n" data-glyph="46,1" class="i field">s_storeCache</a> = <b>null</b>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> On demand create the Regex to avoid a hit to startup perf.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Note, its OK that staticLock is being used here because only</span>
        <span class="c">///</span><span class="c"> IsValidPath is calling this static property so we shouldn&#39;t</span>
        <span class="c">///</span><span class="c"> have any deadlocks due to other locked static members calling</span>
        <span class="c">///</span><span class="c"> this property.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>private static</b> <span class="i">Regex</span> <a id="2dd3c640a7b322a2" href="../R/2dd3c640a7b322a2.html" target="n" data-glyph="46,1" class="i field">s_certPathRegex</a> = <b>null</b>;
 
        <b>private static</b> <span class="i">Regex</span> <a id="0325030c260c023e" href="../R/0325030c260c023e.html" target="n" data-glyph="106,1" class="i property">CertPathRegex</a>
        {
            <b>get</b>
            {
                <b>lock</b> (<a href="#1233d9342632009e" class="i field">s_staticLock</a>)
                {
                    <b>if</b> (<a href="#2dd3c640a7b322a2" class="i field">s_certPathRegex</a> == <b>null</b>)
                    {
                        <b>const</b> <span class="i">RegexOptions</span> <span id="r16 rd" class="r16 r">options</span> = <span class="i">RegexOptions</span>.<span class="i">IgnoreCase</span> | <span class="i">RegexOptions</span>.<span class="i">Compiled</span>;
                        <a href="#2dd3c640a7b322a2" class="i field">s_certPathRegex</a> = <b>new</b> <span class="i">Regex</span>(<a href="#29b967940bba3cdc" class="i field">certPathPattern</a>, <span class="r16 r">options</span>);
                    }
                }
 
                <b>return</b> <a href="#2dd3c640a7b322a2" class="i field">s_certPathRegex</a>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Initializes a new instance of the CertificateProvider class.</span>
        <span class="c">///</span><span class="c"> This initializes the default certificate store locations.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public</b> <a id="ab0384bbf6d2ea31" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="t constructor">CertificateProvider</a>()
        {
            <span class="c">//</span>
            <span class="c">// initialize storeLocations list and also update the cache</span>
            <span class="c">//</span>
            <b>lock</b> (<a href="#1233d9342632009e" class="i field">s_staticLock</a>)
            {
                <b>if</b> (<a href="#a61857b26b0f04c8" class="i field">s_storeLocations</a> == <b>null</b>)
                {
                    <a href="#987ef6b9e1e7929a" class="i field">s_pathCache</a> = <b>new</b> <span class="i">Hashtable</span>(<span class="i">StringComparer</span>.<span class="i">OrdinalIgnoreCase</span>);
                    <a href="#a61857b26b0f04c8" class="i field">s_storeLocations</a> =
                        <b>new</b> <span class="i">List</span>&lt;<a href="#2a4c4cd887b45563" class="t t">X509StoreLocation</a>&gt;();
 
                    <span class="c">//</span>
                    <span class="c">// create and cache CurrentUser store-location</span>
                    <span class="c">//</span>
                    <a href="#2a4c4cd887b45563" class="t t">X509StoreLocation</a> <span id="r17 rd" class="r17 r">user</span> = <b>new</b>(<span class="i">StoreLocation</span>.<span class="i">CurrentUser</span>);
                    <a href="#a61857b26b0f04c8" class="i field">s_storeLocations</a>.<span class="i">Add</span>(<span class="r17 r">user</span>);
                    <a href="#f97c4c0c40734c86" class="i method">AddItemToCache</a>(<b>nameof</b>(<span class="i">StoreLocation</span>.<span class="i">CurrentUser</span>),
                                  <span class="r17 r">user</span>);
 
                    <span class="c">//</span>
                    <span class="c">// create and cache LocalMachine store-location</span>
                    <span class="c">//</span>
                    <a href="#2a4c4cd887b45563" class="t t">X509StoreLocation</a> <span id="r18 rd" class="r18 r">machine</span> = <b>new</b>(<span class="i">StoreLocation</span>.<span class="i">LocalMachine</span>);
                    <a href="#a61857b26b0f04c8" class="i field">s_storeLocations</a>.<span class="i">Add</span>(<span class="r18 r">machine</span>);
                    <a href="#f97c4c0c40734c86" class="i method">AddItemToCache</a>(<b>nameof</b>(<span class="i">StoreLocation</span>.<span class="i">LocalMachine</span>),
                                   <span class="r18 r">machine</span>);
 
                    <span class="i">AddItemToCache</span>(<b>string</b>.<span class="i">Empty</span>, <a href="#a61857b26b0f04c8" class="i field">s_storeLocations</a>);
                }
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Removes an item at the specified path.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r19 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The path of the item to remove.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r20 r">recurse</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Recursively remove.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Nothing.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">System</span>.<span class="i">ArgumentException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">     path is null or empty.</span>
        <span class="c">///</span><span class="c">     destination is null or empty.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>protected override void</b> <a id="47842b4da96f9c9f" href="../R/47842b4da96f9c9f.html" target="n" data-glyph="75,1" class="i method">RemoveItem</a>(
                                <b>string</b> <span id="r19 rd" class="r19 r">path</span>,
                                <b>bool</b> <span id="r20 rd" class="r20 r">recurse</span>)
        {
            <span class="r19 r">path</span> = <a href="#5f3c29f7bd3fa6a7" class="i method">NormalizePath</a>(<span class="r19 r">path</span>);
            <b>bool</b> <span id="r21 rd" class="r21 r">isContainer</span> = <b>false</b>;
            <b>bool</b> <span id="r22 rd" class="r22 r">fDeleteKey</span> = <b>false</b>;
 
            <b>object</b> <span id="r23 rd" class="r23 r">outObj</span> = <a href="#3862cf48fc3ad194" class="i method">GetItemAtPath</a>(<span class="r19 r">path</span>, <b>false</b>, <b>out</b> <span class="r21 r">isContainer</span>);
            <b>string</b>[] <span id="r24 rd" class="r24 r">pathElements</span> = <a href="#bd050b685321e393" class="i method">GetPathElements</a>(<span class="r19 r">path</span>);
 
            <b>bool</b> <span id="r25 rd" class="r25 r">fUserContext</span> = <b>string</b>.<span class="i">Equals</span>(<span class="r24 r">pathElements</span>[0], <span class="s">&quot;CurrentUser&quot;</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>);
 
            <span class="c">// isContainer = true means not a valid certificate</span>
 
            <span class="c">// if source store is user root store and UI is not allowed</span>
            <span class="c">// we raise invalid operation</span>
            <b>if</b> (<a href="#dd6ef8c0fee00482" class="t t">DetectUIHelper</a>.<a href="#03db50bb826c2f66" class="i method">GetOwnerWindow</a>(<a href="/System.Management.Automation/A.html#be8557754a3bdef0" class="i property">Host</a>) == <span class="i">IntPtr</span>.<span class="i">Zero</span> &amp;&amp; <span class="r25 r">fUserContext</span> &amp;&amp;
                 <b>string</b>.<span class="i">Equals</span>(<span class="r24 r">pathElements</span>[1], <span class="s">&quot;ROOT&quot;</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
            {
                <b>string</b> <span id="r26 rd" class="r26 r">message</span> = <span class="i">CertificateProviderStrings</span>.<span class="i">UINotAllowed</span>;
                <b>const string</b> <span id="r27 rd" class="r27 r">errorId</span> = <span class="s">&quot;UINotAllowed&quot;</span>;
                <a href="#027cd5e6475c3ff7" class="i method">ThrowInvalidOperation</a>(<span class="r27 r">errorId</span>, <span class="r26 r">message</span>);
            }
 
            <b>if</b> (<a href="/System.Management.Automation/A.html#57d60aa2d2bc908d" class="i property">DynamicParameters</a> != <b>null</b>)
            {
                <a href="#92f7a4edfeee598c" class="t t">ProviderRemoveItemDynamicParameters</a> <span id="r28 rd" class="r28 r">dp</span> =
                    <a href="/System.Management.Automation/A.html#57d60aa2d2bc908d" class="i property">DynamicParameters</a> <b>as</b> <a href="#92f7a4edfeee598c" class="t t">ProviderRemoveItemDynamicParameters</a>;
                <b>if</b> (<span class="r28 r">dp</span> != <b>null</b>)
                {
                    <b>if</b> (<span class="r28 r">dp</span>.<a href="#c6dbb19747944ce7" class="i property">DeleteKey</a>)
                    {
                        <span class="r22 r">fDeleteKey</span> = <b>true</b>;
                    }
                }
            }
 
            <b>if</b> (<span class="r21 r">isContainer</span>)
            {
                <b>if</b> (<span class="r24 r">pathElements</span>.<span class="i">Length</span> == 2) <span class="c">// is a store</span>
                {
                    <span class="c">// not support user context</span>
                    <b>if</b> (<span class="r25 r">fUserContext</span>)
                    {
                        <b>string</b> <span id="r29 rd" class="r29 r">message</span> = <span class="i">CertificateProviderStrings</span>.<span class="i">CannotDeleteUserStore</span>;
                        <b>const string</b> <span id="r30 rd" class="r30 r">errorId</span> = <span class="s">&quot;CannotDeleteUserStore&quot;</span>;
                        <a href="#027cd5e6475c3ff7" class="i method">ThrowInvalidOperation</a>(<span class="r30 r">errorId</span>, <span class="r29 r">message</span>);
                    }
 
                    <a href="#60b3702815aef4b7" class="i method">RemoveCertStore</a>(<span class="r24 r">pathElements</span>[1], <span class="r22 r">fDeleteKey</span>, <span class="r19 r">path</span>);
                    <b>return</b>;
                }
                <b>else</b> <span class="c">// other container than a store</span>
                {
                    <b>string</b> <span id="r31 rd" class="r31 r">message</span> = <span class="i">CertificateProviderStrings</span>.<span class="i">CannotRemoveContainer</span>;
                    <b>const string</b> <span id="r32 rd" class="r32 r">errorId</span> = <span class="s">&quot;CannotRemoveContainer&quot;</span>;
                    <a href="#027cd5e6475c3ff7" class="i method">ThrowInvalidOperation</a>(<span class="r32 r">errorId</span>, <span class="r31 r">message</span>);
                }
            }
            <b>else</b> <span class="c">// certificate</span>
            {
                <span class="c">// do remove</span>
                <span class="i">X509Certificate2</span> <span id="r33 rd" class="r33 r">certificate</span> = <span class="r23 r">outObj</span> <b>as</b> <span class="i">X509Certificate2</span>;
                <span class="i">RemoveCertItem</span>(<span class="r33 r">certificate</span>, <span class="r22 r">fDeleteKey</span>, !<span class="r25 r">fUserContext</span>, <span class="r19 r">path</span>);
                <b>return</b>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the dynamic parameters for remove-item on the Certificate</span>
        <span class="c">///</span><span class="c"> Provider.  We currently only support one dynamic parameter,</span>
        <span class="c">///</span><span class="c"> &quot;DeleteKey,&quot; that delete private key when we delete a certificate.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r34 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If the path was specified on the command line, this is the path</span>
        <span class="c">///</span><span class="c"> to the item for which to get the dynamic parameters.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r35 r">recurse</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Ignored.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> An object that has properties and fields decorated with</span>
        <span class="c">///</span><span class="c"> parsing attributes similar to a cmdlet class.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>protected override object</b> <a id="df1b7a538337230c" href="../R/df1b7a538337230c.html" target="n" data-glyph="75,1" class="i method">RemoveItemDynamicParameters</a>(<b>string</b> <span id="r34 rd" class="r34 r">path</span>, <b>bool</b> <span id="r35 rd" class="r35 r">recurse</span>)
        {
            <b>return</b> <b>new</b> <span class="t">ProviderRemoveItemDynamicParameters</span>();
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Moves an item at the specified path to the given destination.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r36 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The path of the item to move.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r37 r">destination</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The path of the destination.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Nothing.  Moved items are written to the context&#39;s pipeline.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">System</span>.<span class="i">ArgumentException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">     path is null or empty.</span>
        <span class="c">///</span><span class="c">     destination is null or empty.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>protected override void</b> <a id="fbd5c815fdcb9651" href="../R/fbd5c815fdcb9651.html" target="n" data-glyph="75,1" class="i method">MoveItem</a>(
                                <b>string</b> <span id="r36 rd" class="r36 r">path</span>,
                                <b>string</b> <span id="r37 rd" class="r37 r">destination</span>)
        {
            <span class="c">// normalize path</span>
            <span class="r36 r">path</span> = <a href="#5f3c29f7bd3fa6a7" class="i method">NormalizePath</a>(<span class="r36 r">path</span>);
            <span class="r37 r">destination</span> = <a href="#5f3c29f7bd3fa6a7" class="i method">NormalizePath</a>(<span class="r37 r">destination</span>);
 
            <span class="c">// get elements from the path</span>
            <b>string</b>[] <span id="r38 rd" class="r38 r">pathElements</span> = <a href="#bd050b685321e393" class="i method">GetPathElements</a>(<span class="r36 r">path</span>);
            <b>string</b>[] <span id="r39 rd" class="r39 r">destElements</span> = <a href="#bd050b685321e393" class="i method">GetPathElements</a>(<span class="r37 r">destination</span>);
 
            <b>bool</b> <span id="r40 rd" class="r40 r">isContainer</span> = <b>false</b>;
            <b>object</b> <span id="r41 rd" class="r41 r">cert</span> = <a href="#3862cf48fc3ad194" class="i method">GetItemAtPath</a>(<span class="r36 r">path</span>, <b>false</b>, <b>out</b> <span class="r40 r">isContainer</span>);
 
            <span class="c">//</span>
            <span class="c">// isContainer = true; means an invalid path</span>
            <span class="c">//</span>
            <b>if</b> (<span class="r40 r">isContainer</span>)
            {
                <b>string</b> <span id="r42 rd" class="r42 r">message</span> = <span class="i">CertificateProviderStrings</span>.<span class="i">CannotMoveContainer</span>;
                <b>const string</b> <span id="r43 rd" class="r43 r">errorId</span> = <span class="s">&quot;CannotMoveContainer&quot;</span>;
                <a href="#027cd5e6475c3ff7" class="i method">ThrowInvalidOperation</a>(<span class="r43 r">errorId</span>, <span class="r42 r">message</span>);
            }
 
            <b>if</b> (<span class="r39 r">destElements</span>.<span class="i">Length</span> != 2) <span class="c">// not a store</span>
            {
                <span class="c">// if the destination leads to the same thumbprint</span>
                <b>if</b> (<span class="r39 r">destElements</span>.<span class="i">Length</span> == 3 &amp;&amp;
                   (<b>string</b>.<span class="i">Equals</span>(<span class="r38 r">pathElements</span>[2], <span class="r39 r">destElements</span>[2], <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>)))
                {
                    <span class="c">// in this case we think of destination path as valid</span>
                    <span class="c">// and strip the thumbprint part</span>
                    <span class="r37 r">destination</span> = <span class="i">Path</span>.<span class="i">GetDirectoryName</span>(<span class="r37 r">destination</span>);
                }
                <b>else</b>
                {
                    <b>string</b> <span id="r44 rd" class="r44 r">message</span> = <span class="i">CertificateProviderStrings</span>.<span class="i">InvalidDestStore</span>;
                    <b>const string</b> <span id="r45 rd" class="r45 r">errorId</span> = <span class="s">&quot;InvalidDestStore&quot;</span>;
                    <a href="#027cd5e6475c3ff7" class="i method">ThrowInvalidOperation</a>(<span class="r45 r">errorId</span>, <span class="r44 r">message</span>);
                }
            }
 
            <span class="c">// the second element is store location</span>
            <span class="c">// we do not allow cross context move</span>
            <span class="c">// we do not allow the destination store is the same as source</span>
 
            <b>if</b> (!<b>string</b>.<span class="i">Equals</span>(<span class="r38 r">pathElements</span>[0], <span class="r39 r">destElements</span>[0], <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
            {
                <b>string</b> <span id="r46 rd" class="r46 r">message</span> = <span class="i">CertificateProviderStrings</span>.<span class="i">CannotMoveCrossContext</span>;
                <b>const string</b> <span id="r47 rd" class="r47 r">errorId</span> = <span class="s">&quot;CannotMoveCrossContext&quot;</span>;
                <a href="#027cd5e6475c3ff7" class="i method">ThrowInvalidOperation</a>(<span class="r47 r">errorId</span>, <span class="r46 r">message</span>);
            }
 
            <b>if</b> (<b>string</b>.<span class="i">Equals</span>(<span class="r38 r">pathElements</span>[1], <span class="r39 r">destElements</span>[1], <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
            {
                <b>string</b> <span id="r48 rd" class="r48 r">message</span> = <span class="i">CertificateProviderStrings</span>.<span class="i">CannotMoveToSameStore</span>;
                <b>const string</b> <span id="r49 rd" class="r49 r">errorId</span> = <span class="s">&quot;CannotMoveToSameStore&quot;</span>;
                <a href="#027cd5e6475c3ff7" class="i method">ThrowInvalidOperation</a>(<span class="r49 r">errorId</span>, <span class="r48 r">message</span>);
            }
 
            <span class="c">// if source or destination store is user root store and UI is not allowed</span>
            <span class="c">// we raise invalid operation</span>
            <b>if</b> (<a href="#dd6ef8c0fee00482" class="t t">DetectUIHelper</a>.<a href="#03db50bb826c2f66" class="i method">GetOwnerWindow</a>(<a href="/System.Management.Automation/A.html#be8557754a3bdef0" class="i property">Host</a>) == <span class="i">IntPtr</span>.<span class="i">Zero</span>)
            {
                <b>if</b> ((<b>string</b>.<span class="i">Equals</span>(<span class="r38 r">pathElements</span>[0], <span class="s">&quot;CurrentUser&quot;</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>) &amp;&amp;
                     <b>string</b>.<span class="i">Equals</span>(<span class="r38 r">pathElements</span>[1], <span class="s">&quot;ROOT&quot;</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>)) ||
                     (<b>string</b>.<span class="i">Equals</span>(<span class="r39 r">destElements</span>[0], <span class="s">&quot;CurrentUser&quot;</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>) &amp;&amp;
                     <b>string</b>.<span class="i">Equals</span>(<span class="r39 r">destElements</span>[1], <span class="s">&quot;ROOT&quot;</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>)))
                {
                    <b>string</b> <span id="r50 rd" class="r50 r">message</span> = <span class="i">CertificateProviderStrings</span>.<span class="i">UINotAllowed</span>;
                    <b>const string</b> <span id="r51 rd" class="r51 r">errorId</span> = <span class="s">&quot;UINotAllowed&quot;</span>;
                    <a href="#027cd5e6475c3ff7" class="i method">ThrowInvalidOperation</a>(<span class="r51 r">errorId</span>, <span class="r50 r">message</span>);
                }
            }
 
            <b>if</b> (<span class="r41 r">cert</span> != <b>null</b>) <span class="c">// we get cert</span>
            {
                <span class="c">// get destination store</span>
                <b>bool</b> <span id="r52 rd" class="r52 r">isDestContainer</span> = <b>false</b>;
                <b>object</b> <span id="r53 rd" class="r53 r">store</span> = <a href="#3862cf48fc3ad194" class="i method">GetItemAtPath</a>(<span class="r37 r">destination</span>, <b>false</b>, <b>out</b> <span class="r52 r">isDestContainer</span>);
 
                <span class="i">X509Certificate2</span> <span id="r54 rd" class="r54 r">certificate</span> = <span class="r41 r">cert</span> <b>as</b> <span class="i">X509Certificate2</span>;
                <a href="#b042c5630701a14b" class="t t">X509NativeStore</a> <span id="r55 rd" class="r55 r">certstore</span> = <span class="r53 r">store</span> <b>as</b> <a href="#b042c5630701a14b" class="t t">X509NativeStore</a>;
 
                <b>if</b> (<span class="r55 r">certstore</span> != <b>null</b>)
                {
                    <span class="r55 r">certstore</span>.<a href="#d28202dfbc20d0d8" class="i method">Open</a>(<b>true</b>);
 
                    <b>string</b> <span id="r56 rd" class="r56 r">action</span> = <span class="i">CertificateProviderStrings</span>.<span class="i">Action_Move</span>;
                    <b>string</b> <span id="r57 rd" class="r57 r">resource</span> = <b>string</b>.<span class="i">Format</span>(
                                          <span class="i">CultureInfo</span>.<span class="i">CurrentCulture</span>,
                                          <span class="i">CertificateProviderStrings</span>.<span class="i">MoveItemTemplate</span>,
                                          <span class="r36 r">path</span>,
                                          <span class="r37 r">destination</span>);
                    <b>if</b> (<span class="i">ShouldProcess</span>(<span class="r57 r">resource</span>, <span class="r56 r">action</span>))
                    {
                        <a href="#da4962b164b00088" class="i method">DoMove</a>(<span class="r37 r">destination</span>, <span class="r54 r">certificate</span>, <span class="r55 r">certstore</span>, <span class="r36 r">path</span>);
                    }
                }
            }
            <b>else</b>
            {
                <a href="#f00d1fe56ddcb477" class="i method">ThrowItemNotFound</a>(<span class="r36 r">path</span>, <a href="#e8d23026f96d84c8" class="t t">CertificateProviderItem</a>.<a href="#82505c9bafd5fc3e" class="i field">Certificate</a>);
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Creates a certificate store with the given path.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> New-Item doesn&#39;t go through the method &quot;ItemExists&quot;. But for the</span>
        <span class="c">///</span><span class="c"> CertificateProvider, New-Item can create an X509Store and return</span>
        <span class="c">///</span><span class="c"> it, and the user can access the certificates within the store via its</span>
        <span class="c">///</span><span class="c"> property &quot;Certificates&quot;. We want the extra new properties of the</span>
        <span class="c">///</span><span class="c"> X509Certificate2 objects to be shown to the user, so we also need</span>
        <span class="c">///</span><span class="c"> to import the PKI module in this method, if we haven&#39;t tried it yet.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r58 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The path of the certificate store to create.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r59 r">type</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Ignored.</span>
        <span class="c">///</span><span class="c"> Only support store.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r60 r">value</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Ignored</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Nothing.  The new certificate store object is</span>
        <span class="c">///</span><span class="c"> written to the context&#39;s pipeline.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">System</span>.<span class="i">ArgumentException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">     path is null or empty.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>protected override void</b> <a id="811807edb94abaf3" href="../R/811807edb94abaf3.html" target="n" data-glyph="75,1" class="i method">NewItem</a>(
                <b>string</b> <span id="r58 rd" class="r58 r">path</span>,
                <b>string</b> <span id="r59 rd" class="r59 r">type</span>,
                <b>object</b> <span id="r60 rd" class="r60 r">value</span>)
        {
            <b>if</b> (!<a href="#3057324a208a416e" class="i field">_hasAttemptedToLoadPkiModule</a>)
            {
                <span class="c">// Attempt to load the PKI module if we haven&#39;t tried yet</span>
                <a href="#57f651005bc1e8d2" class="i method">AttemptToImportPkiModule</a>();
            }
 
            <span class="r58 r">path</span> = <a href="#5f3c29f7bd3fa6a7" class="i method">NormalizePath</a>(<span class="r58 r">path</span>);
 
            <span class="c">// get the elements from the path</span>
            <b>string</b>[] <span id="r61 rd" class="r61 r">pathElements</span> = <a href="#bd050b685321e393" class="i method">GetPathElements</a>(<span class="r58 r">path</span>);
 
            <span class="c">// only support creating store</span>
            <b>if</b> (<span class="r61 r">pathElements</span>.<span class="i">Length</span> != 2)
            {
                <b>string</b> <span id="r62 rd" class="r62 r">message</span> = <span class="i">CertificateProviderStrings</span>.<span class="i">CannotCreateItem</span>;
                <b>const string</b> <span id="r63 rd" class="r63 r">errorId</span> = <span class="s">&quot;CannotCreateItem&quot;</span>;
                <a href="#027cd5e6475c3ff7" class="i method">ThrowInvalidOperation</a>(<span class="r63 r">errorId</span>, <span class="r62 r">message</span>);
            }
 
            <b>bool</b> <span id="r64 rd" class="r64 r">fUserContext</span> = <b>string</b>.<span class="i">Equals</span>(<span class="r61 r">pathElements</span>[0], <span class="s">&quot;CurrentUser&quot;</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>);
 
            <span class="c">// not support user context</span>
            <b>if</b> (<span class="r64 r">fUserContext</span>)
            {
                <b>string</b> <span id="r65 rd" class="r65 r">message</span> = <span class="i">CertificateProviderStrings</span>.<span class="i">CannotCreateUserStore</span>;
                <b>const string</b> <span id="r66 rd" class="r66 r">errorId</span> = <span class="s">&quot;CannotCreateUserStore&quot;</span>;
                <a href="#027cd5e6475c3ff7" class="i method">ThrowInvalidOperation</a>(<span class="r66 r">errorId</span>, <span class="r65 r">message</span>);
            }
 
            <b>const</b> <span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">CertOpenStoreFlags</span> <span id="r67 rd" class="r67 r">StoreFlags</span> =
                    <span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">CertOpenStoreFlags</span>.<span class="i">CERT_STORE_CREATE_NEW_FLAG</span> |
                    <span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">CertOpenStoreFlags</span>.<span class="i">CERT_STORE_MAXIMUM_ALLOWED_FLAG</span> |
                    <span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">CertOpenStoreFlags</span>.<span class="i">CERT_SYSTEM_STORE_LOCAL_MACHINE</span>;
 
            <span class="c">// Create new store</span>
            <span class="i">IntPtr</span> <span id="r68 rd" class="r68 r">hCertStore</span> = <span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">CertOpenStore</span>(
                                <span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">CertOpenStoreProvider</span>.<span class="i">CERT_STORE_PROV_SYSTEM</span>,
                                <span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">CertOpenStoreEncodingType</span>.<span class="i">X509_ASN_ENCODING</span>,
                                <span class="i">IntPtr</span>.<span class="i">Zero</span>,  <span class="c">// hCryptProv</span>
                                <span class="r67 r">StoreFlags</span>,
                                <span class="r61 r">pathElements</span>[1]);
            <b>if</b> (<span class="r68 r">hCertStore</span> == <span class="i">IntPtr</span>.<span class="i">Zero</span>)
            {
                <b>throw</b> <b>new</b> <span class="i n">System</span>.<span class="i">ComponentModel</span>.<span class="i">Win32Exception</span>(<span class="i">Marshal</span>.<span class="i">GetLastWin32Error</span>());
            }
            <b>else</b> <span class="c">// free native store handle</span>
            {
                <b>bool</b> <span id="r69 rd" class="r69 r">fResult</span> = <b>false</b>;
                <span class="r69 r">fResult</span> = <span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">CertCloseStore</span>(<span class="r68 r">hCertStore</span>, 0);
            }
 
            <span class="i">X509Store</span> <span id="r70 rd" class="r70 r">outStore</span> = <b>new</b>(<span class="r61 r">pathElements</span>[1], <span class="i">StoreLocation</span>.<span class="i">LocalMachine</span>);
            <span class="i">WriteItemObject</span>(<span class="r70 r">outStore</span>, <span class="r58 r">path</span>, <b>true</b>);
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> DriveCmdletProvider overrides
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Initializes the cert: drive.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> A collection that contains the PSDriveInfo object</span>
        <span class="c">///</span><span class="c"> that represents the cert: drive.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>protected override</b> <span class="i">Collection</span>&lt;<a href="/System.Management.Automation/A.html#2d16b26a541ba185" class="t t">PSDriveInfo</a>&gt; <a id="f2b6cde5230e612d" href="../R/f2b6cde5230e612d.html" target="n" data-glyph="75,1" class="i method">InitializeDefaultDrives</a>()
        {
            <b>string</b> <span id="r71 rd" class="r71 r">providerDescription</span> = <span class="i">CertificateProviderStrings</span>.<span class="i">CertProvidername</span>;
 
            <a href="/System.Management.Automation/A.html#2d16b26a541ba185" class="t t">PSDriveInfo</a> <span id="r72 rd" class="r72 r">drive</span> = <b>new</b>(
                <span class="i">name</span>: <span class="s">&quot;Cert&quot;</span>,
                <span class="i">provider</span>: <a href="/System.Management.Automation/A.html#6129ef83671ead76" class="i property">ProviderInfo</a>,
                <span class="i">root</span>: <span class="s">@&quot;\&quot;</span>,
                <span class="r71 r">providerDescription</span>,
                <span class="i">credential</span>: <b>null</b>);
 
            <span class="i">Collection</span>&lt;<a href="/System.Management.Automation/A.html#2d16b26a541ba185" class="t t">PSDriveInfo</a>&gt; <span id="r73 rd" class="r73 r">drives</span> = <b>new</b>();
            <span class="r73 r">drives</span>.<span class="i">Add</span>(<span class="r72 r">drive</span>);
 
            <b>return</b> <span class="r73 r">drives</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Determines if the item at the given path is a store-location</span>
        <span class="c">///</span><span class="c"> or store with items in it.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r74 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The full path to the item.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> True if the path refers to a store location, or store that contains</span>
        <span class="c">///</span><span class="c"> certificates.  False otherwise.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">System</span>.<span class="i">ArgumentNullException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Path is null</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">System</span>.<span class="i">Security</span>.<span class="i">Cryptography</span>.<span class="i">CryptographicException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This exception can be thrown if any cryptographic error occurs.</span>
        <span class="c">///</span><span class="c"> It is not possible to know exactly what went wrong.</span>
        <span class="c">///</span><span class="c"> This is because of the way CryptographicException is designed.</span>
        <span class="c">///</span><span class="c"> Some example reasons include:</span>
        <span class="c">///</span><span class="c">  -- certificate is invalid</span>
        <span class="c">///</span><span class="c">  -- certificate has no private key</span>
        <span class="c">///</span><span class="c">  -- certificate password mismatch</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>protected override bool</b> <a id="2d01093d456f2660" href="../R/2d01093d456f2660.html" target="n" data-glyph="75,1" class="i method">HasChildItems</a>(<b>string</b> <span id="r74 rd" class="r74 r">path</span>)
        {
            <b>bool</b> <span id="r75 rd" class="r75 r">result</span> = <b>false</b>;
 
            <span class="i">Utils</span>.<span class="i">CheckArgForNull</span>(<span class="r74 r">path</span>, <span class="s">&quot;path&quot;</span>);
 
            <span class="r74 r">path</span> = <a href="#5f3c29f7bd3fa6a7" class="i method">NormalizePath</a>(<span class="r74 r">path</span>);
 
            <b>if</b> (<span class="r74 r">path</span>.<span class="i">Length</span> == 0)
            {
                <b>return</b> <b>true</b>;
            }
 
            <b>bool</b> <span id="r76 rd" class="r76 r">isContainer</span> = <b>false</b>;
 
            <b>object</b> <span id="r77 rd" class="r77 r">item</span> = <a href="#3862cf48fc3ad194" class="i method">GetItemAtPath</a>(<span class="r74 r">path</span>, <b>false</b>, <b>out</b> <span class="r76 r">isContainer</span>);
 
            <b>if</b> ((<span class="r77 r">item</span> != <b>null</b>) &amp;&amp; <span class="r76 r">isContainer</span>)
            {
                <a href="#2a4c4cd887b45563" class="t t">X509StoreLocation</a> <span id="r78 rd" class="r78 r">storeLocation</span> = <span class="r77 r">item</span> <b>as</b> <a href="#2a4c4cd887b45563" class="t t">X509StoreLocation</a>;
                <b>if</b> (<span class="r78 r">storeLocation</span> != <b>null</b>)
                {
                    <span class="r75 r">result</span> = <span class="r78 r">storeLocation</span>.<a href="#f6befc49f6e25116" class="i property">StoreNames</a>.<span class="i">Count</span> &gt; 0;
                }
                <b>else</b>
                {
                    <a href="#b042c5630701a14b" class="t t">X509NativeStore</a> <span id="r79 rd" class="r79 r">store</span> = <span class="r77 r">item</span> <b>as</b> <a href="#b042c5630701a14b" class="t t">X509NativeStore</a>;
                    <b>if</b> (<span class="r79 r">store</span> != <b>null</b>)
                    {
                        <span class="r79 r">store</span>.<a href="#d28202dfbc20d0d8" class="i method">Open</a>(<a href="#bd3f5b33f16588d3" class="i method">IncludeArchivedCerts</a>());
                        <span class="i">IntPtr</span> <span id="r80 rd" class="r80 r">certContext</span> = <span class="r79 r">store</span>.<a href="#939ecd37de4b527e" class="i method">GetFirstCert</a>();
                        <b>if</b> (<span class="r80 r">certContext</span> != <span class="i">IntPtr</span>.<span class="i">Zero</span>)
                        {
                            <span class="r79 r">store</span>.<a href="#2b44ac4b9e1d3dab" class="i method">FreeCert</a>(<span class="r80 r">certContext</span>);
                            <span class="r75 r">result</span> = <b>true</b>;
                        }
                    }
                }
            }
 
            <b>return</b> <span class="r75 r">result</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Determines if the specified path is syntactically and semantically valid.</span>
        <span class="c">///</span><span class="c"> An example path looks like this:</span>
        <span class="c">///</span><span class="c">     cert:\CurrentUser\My\5F98EBBFE735CDDAE00E33E0FD69050EF9220254.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r81 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The path of the item to check.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> True if the path is valid, false otherwise.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>protected override bool</b> <a id="b109edca099259d4" href="../R/b109edca099259d4.html" target="n" data-glyph="75,1" class="i method">IsValidPath</a>(<b>string</b> <span id="r81 rd" class="r81 r">path</span>)
        {
            <span class="r81 r">path</span> = <a href="#5f3c29f7bd3fa6a7" class="i method">NormalizePath</a>(<span class="r81 r">path</span>);
            <span class="r81 r">path</span> = <a href="#4f19e851dd8cee30" class="i method">EnsureDriveIsRooted</a>(<span class="r81 r">path</span>);
 
            <b>bool</b> <span id="r82 rd" class="r82 r">isCertPath</span> = <a href="#0325030c260c023e" class="i property">CertPathRegex</a>.<span class="i">Match</span>(<span class="r81 r">path</span>).<span class="i">Success</span>;
 
            <b>return</b> <span class="r82 r">isCertPath</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Determines if the store location, store, or certificate exists</span>
        <span class="c">///</span><span class="c"> at the specified path.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The method ItemExists will be hit by all built-in cmdlets that interact</span>
        <span class="c">///</span><span class="c"> with the CertificateProvider except for the New-Item. They are:</span>
        <span class="c">///</span><span class="c">     Get-ChildItem</span>
        <span class="c">///</span><span class="c">     Set-Location</span>
        <span class="c">///</span><span class="c">     Push-Location</span>
        <span class="c">///</span><span class="c">     Pop-Location</span>
        <span class="c">///</span><span class="c">     Move-Item</span>
        <span class="c">///</span><span class="c">     Invoke-Item</span>
        <span class="c">///</span><span class="c">     Get-Item</span>
        <span class="c">///</span><span class="c">     Remove-Item</span>
        <span class="c">///</span><span class="c"> So we import the PKI module in this method if we haven&#39;t tried yet.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r83 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The path of the item to check.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> True if a the store location, store, or certificate exists</span>
        <span class="c">///</span><span class="c"> at the specified path.  False otherwise.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">System</span>.<span class="i">ArgumentNullException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Path is null</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">System</span>.<span class="i">Security</span>.<span class="i">Cryptography</span>.<span class="i">CryptographicException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This exception can be thrown if any cryptographic error occurs.</span>
        <span class="c">///</span><span class="c"> It is not possible to know exactly what went wrong.</span>
        <span class="c">///</span><span class="c"> This is because of the way CryptographicException is designed.</span>
        <span class="c">///</span><span class="c"> Possible reasons:</span>
        <span class="c">///</span><span class="c">  -- certificate is invalid</span>
        <span class="c">///</span><span class="c">  -- certificate has no private key</span>
        <span class="c">///</span><span class="c">  -- certificate password mismatch</span>
        <span class="c">///</span><span class="c">  -- etc</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>protected override bool</b> <a id="714a18801da46cac" href="../R/714a18801da46cac.html" target="n" data-glyph="75,1" class="i method">ItemExists</a>(<b>string</b> <span id="r83 rd" class="r83 r">path</span>)
        {
            <b>if</b> (!<a href="#3057324a208a416e" class="i field">_hasAttemptedToLoadPkiModule</a>)
            {
                <span class="c">// Attempt to load the PKI module if we haven&#39;t tried yet</span>
                <a href="#57f651005bc1e8d2" class="i method">AttemptToImportPkiModule</a>();
            }
 
            <span class="i">Utils</span>.<span class="i">CheckArgForNull</span>(<span class="r83 r">path</span>, <span class="s">&quot;path&quot;</span>);
            <b>bool</b> <span id="r84 rd" class="r84 r">result</span> = <b>false</b>;
            <b>bool</b> <span id="r85 rd" class="r85 r">isContainer</span> = <b>false</b>;
            <b>object</b> <span id="r86 rd" class="r86 r">item</span> = <b>null</b>;
 
            <span class="r83 r">path</span> = <a href="#5f3c29f7bd3fa6a7" class="i method">NormalizePath</a>(<span class="r83 r">path</span>);
 
            <b>if</b> (<span class="r83 r">path</span>.<span class="i">Length</span> == 0)
            {
                <span class="r84 r">result</span> = <b>true</b>;
            }
            <b>else</b>
            {
                <span class="c">//</span>
                <span class="c">// We fetch the item to see if it exists. This is</span>
                <span class="c">// because the managed cert infrastructure does not</span>
                <span class="c">// provide a way to test for existence.</span>
                <span class="c">//</span>
                <b>try</b>
                {
                    <span class="r86 r">item</span> = <a href="#3862cf48fc3ad194" class="i method">GetItemAtPath</a>(<span class="r83 r">path</span>, <b>true</b>, <b>out</b> <span class="r85 r">isContainer</span>);
                }
                <b>catch</b> (<a href="/System.Management.Automation/A.html#35e07c15a7526bcd" class="t t">ProviderInvocationException</a> <span id="r87 rd" class="r87 r">e</span>)
                {
                    <span class="c">//</span>
                    <span class="c">// if the item is not found, we get ProviderInvocationException</span>
                    <span class="c">// with inner exception set to CertificateProviderItemNotFoundException</span>
                    <span class="c">// If the inner exception is not of that type</span>
                    <span class="c">// then we need to rethrow</span>
                    <span class="c">//</span>
                    <b>if</b> (<span class="r87 r">e</span>.<span class="i">InnerException</span> <b>is not</b> <a href="certificateproviderexceptions.cs.html#67812ca5409c3f35" class="t t">CertificateProviderItemNotFoundException</a>)
                    {
                        <b>throw</b>;
                    }
                }
 
                <span class="r84 r">result</span> = (<b>bool</b>)<span class="r86 r">item</span>;
            }
 
            <a href="#798f0bbd23a8926c" class="i field">s_tracer</a>.<span class="i">WriteLine</span>(<span class="s">&quot;result = {0}&quot;</span>, <span class="r84 r">result</span>);
            <b>return</b> <span class="r84 r">result</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the store location, store, or certificate</span>
        <span class="c">///</span><span class="c"> at the specified path.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r88 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The path of the item to retrieve.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">System</span>.<span class="i">ArgumentNullException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Path is null</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">System</span>.<span class="i">Security</span>.<span class="i">Cryptography</span>.<span class="i">CryptographicException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This exception can be thrown if any cryptographic error occurs.</span>
        <span class="c">///</span><span class="c"> It is not possible to know exactly what went wrong.</span>
        <span class="c">///</span><span class="c"> This is because of the way CryptographicException is designed.</span>
        <span class="c">///</span><span class="c"> Possible reasons:</span>
        <span class="c">///</span><span class="c">  -- certificate is invalid</span>
        <span class="c">///</span><span class="c">  -- certificate has no private key</span>
        <span class="c">///</span><span class="c">  -- certificate password mismatch</span>
        <span class="c">///</span><span class="c">  -- etc</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>protected override void</b> <a id="5cddf0adf908eb88" href="../R/5cddf0adf908eb88.html" target="n" data-glyph="75,1" class="i method">GetItem</a>(<b>string</b> <span id="r88 rd" class="r88 r">path</span>)
        {
            <b>bool</b> <span id="r89 rd" class="r89 r">isContainer</span> = <b>false</b>;
 
            <span class="r88 r">path</span> = <a href="#5f3c29f7bd3fa6a7" class="i method">NormalizePath</a>(<span class="r88 r">path</span>);
            <b>object</b> <span id="r90 rd" class="r90 r">item</span> = <a href="#3862cf48fc3ad194" class="i method">GetItemAtPath</a>(<span class="r88 r">path</span>, <b>false</b>, <b>out</b> <span class="r89 r">isContainer</span>);
            <span class="i">CertificateFilterInfo</span> <span id="r91 rd" class="r91 r">filter</span> = <a href="#1fe890fc6cd2c7a7" class="i method">GetFilter</a>();
 
            <b>if</b> (<span class="r90 r">item</span> != <b>null</b>)
            {
                <b>if</b> (!<span class="r89 r">isContainer</span>) <span class="c">// certificate</span>
                {
                    <span class="c">// If the filter is null, output the certificate we got.</span>
                    <b>if</b> (<span class="r91 r">filter</span> == <b>null</b>)
                    {
                        <span class="i">WriteItemObject</span>(<span class="r90 r">item</span>, <span class="r88 r">path</span>, <span class="r89 r">isContainer</span>);
                    }
                    <b>else</b>
                    {
                        <span class="c">// The filter is non null. If the certificate</span>
                        <span class="c">// satisfies the filter, output it. Otherwise, don&#39;t.</span>
                        <span class="i">X509Certificate2</span> <span id="r92 rd" class="r92 r">cert</span> = <span class="r90 r">item</span> <b>as</b> <span class="i">X509Certificate2</span>;
                        <span class="i n">Dbg</span>.<span class="i">Diagnostics</span>.<span class="i">Assert</span>(<span class="r92 r">cert</span> != <b>null</b>, <span class="s">&quot;item should be a certificate&quot;</span>);
 
                        <b>if</b> (<a href="#af3d83042e4bfdb4" class="i method">MatchesFilter</a>(<span class="r92 r">cert</span>, <span class="r91 r">filter</span>))
                        {
                            <span class="i">WriteItemObject</span>(<span class="r90 r">item</span>, <span class="r88 r">path</span>, <span class="r89 r">isContainer</span>);
                        }
                    }
                }
                <b>else</b>  <span class="c">// container</span>
                {
                    <span class="c">// The item is a container. If the filter is non null, we don&#39;t output it.</span>
                    <b>if</b> (<span class="r91 r">filter</span> != <b>null</b>)
                    {
                        <b>return</b>;
                    }
 
                    <a href="#2a4c4cd887b45563" class="t t">X509StoreLocation</a> <span id="r93 rd" class="r93 r">storeLocation</span> = <span class="r90 r">item</span> <b>as</b> <a href="#2a4c4cd887b45563" class="t t">X509StoreLocation</a>;
                    <b>if</b> (<span class="r93 r">storeLocation</span> != <b>null</b>)  <span class="c">// store location</span>
                    {
                        <span class="i">WriteItemObject</span>(<span class="r90 r">item</span>, <span class="r88 r">path</span>, <span class="r89 r">isContainer</span>);
                    }
                    <b>else</b> <span class="c">// store</span>
                    {
                        <a href="#b042c5630701a14b" class="t t">X509NativeStore</a> <span id="r94 rd" class="r94 r">store</span> = <span class="r90 r">item</span> <b>as</b> <a href="#b042c5630701a14b" class="t t">X509NativeStore</a>;
                        <b>if</b> (<span class="r94 r">store</span> != <b>null</b>)
                        {
                            <span class="c">// create X509Store</span>
                            <span class="i">X509Store</span> <span id="r95 rd" class="r95 r">outStore</span> = <b>new</b>(<span class="r94 r">store</span>.<a href="#76acf366fbf24982" class="i property">StoreName</a>, <span class="r94 r">store</span>.<a href="#3aa7db610be0ad56" class="i property">Location</a>.<a href="#2fcfcb7271252c0c" class="i property">Location</a>);
                            <span class="i">WriteItemObject</span>(<span class="r95 r">outStore</span>, <span class="r88 r">path</span>, <span class="r89 r">isContainer</span>);
                        }
                    }
                }
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the parent of the given path.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r96 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The path of which to get the parent.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r97 r">root</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The root of the drive.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The parent of the given path.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>protected override string</b> <a id="d47a83d0b1988ab9" href="../R/d47a83d0b1988ab9.html" target="n" data-glyph="75,1" class="i method">GetParentPath</a>(<b>string</b> <span id="r96 rd" class="r96 r">path</span>, <b>string</b> <span id="r97 rd" class="r97 r">root</span>)
        {
            <b>string</b> <span id="r98 rd" class="r98 r">parentPath</span> = <a href="/System.Management.Automation/A.html#7d31476313596b0b" class="k">base</a>.<span class="i">GetParentPath</span>(<span class="r96 r">path</span>, <span class="r97 r">root</span>);
 
            <b>return</b> <span class="r98 r">parentPath</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the name of the leaf element of the specified path.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r99 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The fully qualified path to the item.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The leaf element of the specified path.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>protected override string</b> <a id="006d0a715345fa9b" href="../R/006d0a715345fa9b.html" target="n" data-glyph="75,1" class="i method">GetChildName</a>(<b>string</b> <span id="r99 rd" class="r99 r">path</span>)
        {
            <span class="c">// Path for root is empty string</span>
            <b>if</b> (<span class="r99 r">path</span> != <b>null</b> &amp;&amp; <span class="r99 r">path</span>.<span class="i">Length</span> == 0)
            {
                <b>return</b> <span class="r99 r">path</span>;
            }
            <b>else</b>
            {
                <b>return</b> <a href="#7a005ff6e849fa96" class="i method">MyGetChildName</a>(<span class="r99 r">path</span>);
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> We want to import the PKI module explicitly because a type for X509Certificate</span>
        <span class="c">///</span><span class="c"> is defined in the PKI module that add new properties to the X509Certificate2</span>
        <span class="c">///</span><span class="c"> objects. We want to show those new properties to the user without requiring</span>
        <span class="c">///</span><span class="c"> someone to force the loading of this module.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private void</b> <a id="57f651005bc1e8d2" href="../R/57f651005bc1e8d2.html" target="n" data-glyph="76,1" class="i method">AttemptToImportPkiModule</a>()
        {
            <b>const string</b> <span id="r100 rd" class="r100 r">moduleName</span> = <span class="s">&quot;pki&quot;</span>;
 
            <b>if</b> (<span class="i n">Runspaces</span>.<a href="/System.Management.Automation/A.html#7e5b8eab1aa16fd7" class="t t">Runspace</a>.<a href="/System.Management.Automation/A.html#efcd2ba43103de17" class="i property">DefaultRunspace</a> == <b>null</b>)
            {
                <span class="c">//</span>
                <span class="c">// Requires default runspace. Only import the module.</span>
                <span class="c">// when a default runspace is available.</span>
                <span class="c">//</span>
 
                <b>return</b>;
            }
 
            <a href="/System.Management.Automation/A.html#71babe57a99ca852" class="t t">CommandInfo</a> <span id="r101 rd" class="r101 r">commandInfo</span> =
                <b>new</b> <span class="t">CmdletInfo</span>(
                    <span class="s">&quot;Import-Module&quot;</span>,
                     <b>typeof</b>(<span class="i n">Microsoft</span>.<span class="i n">PowerShell</span>.<span class="i n">Commands</span>.<a href="/System.Management.Automation/A.html#4a6e75cbbfb65b34" class="t t">ImportModuleCommand</a>));
            <span class="i n">Runspaces</span>.<a href="/System.Management.Automation/A.html#b55b68a3bf75e612" class="t t">Command</a> <span id="r102 rd" class="r102 r">importModuleCommand</span> = <b>new</b>(<span class="r101 r">commandInfo</span>);
 
            <a href="#798f0bbd23a8926c" class="i field">s_tracer</a>.<span class="i">WriteLine</span>(<span class="s">&quot;Attempting to load module: {0}&quot;</span>, <span class="r100 r">moduleName</span>);
 
            <b>try</b>
            {
                <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="/System.Management.Automation/A.html#3d1b346df3be574c" class="t t">PowerShell</a> <span id="r103 rd" class="r103 r">ps</span> = <b>null</b>;
                <span class="r103 r">ps</span> = <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="/System.Management.Automation/A.html#3d1b346df3be574c" class="t t">PowerShell</a>.<a href="/System.Management.Automation/A.html#1c6a51d3c837bb4d" class="i method">Create</a>(<a href="/System.Management.Automation/A.html#c3c0f0e5e0b337ff" class="t t">RunspaceMode</a>.<a href="/System.Management.Automation/A.html#75d224de5df87e75" class="i field">CurrentRunspace</a>)
                            .<span class="i">AddCommand</span>(<span class="r102 r">importModuleCommand</span>)
                                .<span class="i">AddParameter</span>(<span class="s">&quot;Name&quot;</span>, <span class="r100 r">moduleName</span>)
                                .<span class="i">AddParameter</span>(<span class="s">&quot;Scope&quot;</span>, <span class="i">StringLiterals</span>.<span class="i">Global</span>)
                                .<span class="i">AddParameter</span>(<span class="s">&quot;ErrorAction&quot;</span>, <a href="/System.Management.Automation/A.html#18f88a0529e26331" class="t t">ActionPreference</a>.<a href="/System.Management.Automation/A.html#e7eef70977370b56" class="i field">Ignore</a>)
                                .<span class="i">AddParameter</span>(<span class="s">&quot;WarningAction&quot;</span>, <a href="/System.Management.Automation/A.html#18f88a0529e26331" class="t t">ActionPreference</a>.<a href="/System.Management.Automation/A.html#e7eef70977370b56" class="i field">Ignore</a>)
                                .<span class="i">AddParameter</span>(<span class="s">&quot;InformationAction&quot;</span>, <a href="/System.Management.Automation/A.html#18f88a0529e26331" class="t t">ActionPreference</a>.<a href="/System.Management.Automation/A.html#e7eef70977370b56" class="i field">Ignore</a>)
                                .<span class="i">AddParameter</span>(<span class="s">&quot;Verbose&quot;</span>, <b>false</b>)
                                .<span class="i">AddParameter</span>(<span class="s">&quot;Debug&quot;</span>, <b>false</b>);
                <span class="r103 r">ps</span>.<span class="i">Invoke</span>();
            }
            <b>catch</b> (<span class="i">Exception</span>)
            {
            }
 
            <a href="#3057324a208a416e" class="i field">_hasAttemptedToLoadPkiModule</a> = <b>true</b>;
        }
 
        <b>private static string</b> <a id="7a005ff6e849fa96" href="../R/7a005ff6e849fa96.html" target="n" data-glyph="76,1" class="i method">MyGetChildName</a>(<b>string</b> <span id="r104 rd" class="r104 r">path</span>)
        {
            <span class="c">// Verify the parameters</span>
 
            <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r104 r">path</span>))
            {
                <b>throw</b> <a href="/System.Management.Automation/A.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<span class="i">NewArgumentException</span>(<b>nameof</b>(<span class="r104 r">path</span>));
            }
 
            <span class="c">// Normalize the path</span>
            <span class="r104 r">path</span> = <span class="r104 r">path</span>.<span class="i">Replace</span>(<span class="i">StringLiterals</span>.<span class="i">AlternatePathSeparator</span>, <span class="i">StringLiterals</span>.<span class="i">DefaultPathSeparator</span>);
 
            <span class="c">// Trim trailing back slashes</span>
            <span class="r104 r">path</span> = <span class="r104 r">path</span>.<span class="i">TrimEnd</span>(<span class="i">StringLiterals</span>.<span class="i">DefaultPathSeparator</span>);
            <b>string</b> <span id="r105 rd" class="r105 r">result</span> = <b>null</b>;
 
            <b>int</b> <span id="r106 rd" class="r106 r">separatorIndex</span> = <span class="r104 r">path</span>.<span class="i">LastIndexOf</span>(<span class="i">StringLiterals</span>.<span class="i">DefaultPathSeparator</span>);
 
            <span class="c">// Since there was no path separator return the entire path</span>
            <b>if</b> (<span class="r106 r">separatorIndex</span> == -1)
            {
                <span class="r105 r">result</span> = <span class="r104 r">path</span>;
            }
            <b>else</b>
            {
                <span class="r105 r">result</span> = <span class="r104 r">path</span>.<span class="i">Substring</span>(<span class="r106 r">separatorIndex</span> + 1);
            }
 
            <b>return</b> <span class="r105 r">result</span>;
        }
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Invokes the certificate management UI (certmgr.msc)</span>
        <span class="c">///</span><span class="c"> for any path.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r107 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Ignored.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>protected override void</b> <a id="e800e1beca66fb2c" href="../R/e800e1beca66fb2c.html" target="n" data-glyph="75,1" class="i method">InvokeDefaultAction</a>(<b>string</b> <span id="r107 rd" class="r107 r">path</span>)
        {
            <span class="r107 r">path</span> = <a href="#5f3c29f7bd3fa6a7" class="i method">NormalizePath</a>(<span class="r107 r">path</span>);
            <b>string</b> <span id="r108 rd" class="r108 r">action</span> = <span class="i">CertificateProviderStrings</span>.<span class="i">Action_Invoke</span>;
            <b>const string</b> <span id="r109 rd" class="r109 r">certmgr</span> = <span class="s">&quot;certmgr.msc&quot;</span>;
            <b>string</b> <span id="r110 rd" class="r110 r">certPath</span> = <span class="i n">System</span>.<span class="i">IO</span>.<span class="i">Path</span>.<span class="i">Combine</span>(
                <span class="i n">System</span>.<span class="i">Environment</span>.<span class="i">ExpandEnvironmentVariables</span>(<span class="s">&quot;%windir%&quot;</span>), <span class="s">&quot;system32&quot;</span>);
 
            <b>if</b> (<span class="i">ShouldProcess</span>(<span class="r107 r">path</span>, <span class="r108 r">action</span>))
            {
                <span class="i n">System</span>.<span class="i">Diagnostics</span>.<span class="i">Process</span>.<span class="i">Start</span>(<span class="i n">System</span>.<span class="i">IO</span>.<span class="i">Path</span>.<span class="i">Combine</span>(<span class="r110 r">certPath</span>, <span class="r109 r">certmgr</span>));
            }
        }
 
        <b>private static string</b> <a id="4f19e851dd8cee30" href="../R/4f19e851dd8cee30.html" target="n" data-glyph="76,1" class="i method">EnsureDriveIsRooted</a>(<b>string</b> <span id="r111 rd" class="r111 r">path</span>)
        {
            <b>string</b> <span id="r112 rd" class="r112 r">result</span> = <span class="r111 r">path</span>;
 
            <span class="c">// Find the drive separator</span>
            <b>int</b> <span id="r113 rd" class="r113 r">index</span> = <span class="r111 r">path</span>.<span class="i">IndexOf</span>(<span class="s">&#39;:&#39;</span>);
 
            <b>if</b> (<span class="r113 r">index</span> != -1)
            {
                <span class="c">// if the drive separator is the end of the path, add</span>
                <span class="c">// the root path separator back</span>
                <b>if</b> (<span class="r113 r">index</span> + 1 == <span class="r111 r">path</span>.<span class="i">Length</span>)
                {
                    <span class="r112 r">result</span> = <span class="r111 r">path</span> + <span class="i">StringLiterals</span>.<span class="i">DefaultPathSeparator</span>;
                }
            }
            <b>else</b> <b>if</b> ((<span class="r111 r">path</span>.<span class="i">Length</span> == 0) || (<span class="r111 r">path</span>[0] != <span class="i">StringLiterals</span>.<span class="i">DefaultPathSeparator</span>))
            {
                <span class="r112 r">result</span> = <span class="i">StringLiterals</span>.<span class="i">DefaultPathSeparator</span> + <span class="r111 r">path</span>;
            }
 
            <a href="#798f0bbd23a8926c" class="i field">s_tracer</a>.<span class="i">WriteLine</span>(<span class="s">&quot;result = {0}&quot;</span>, <span class="r112 r">result</span>);
            <b>return</b> <span class="r112 r">result</span>;
        }
 
        <b>private static</b> <a href="/System.Management.Automation/A.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <a id="2f75bbaf8b0ed78d" href="../R/2f75bbaf8b0ed78d.html" target="n" data-glyph="76,1" class="i method">CreateErrorRecord</a>(<b>string</b> <span id="r114 rd" class="r114 r">path</span>,
                                              <a href="#e8d23026f96d84c8" class="t t">CertificateProviderItem</a> <span id="r115 rd" class="r115 r">itemType</span>)
        {
            <span class="i">Exception</span> <span id="r116 rd" class="r116 r">e</span> = <b>null</b>;
            <b>string</b> <span id="r117 rd" class="r117 r">message</span> = <b>null</b>;
 
            <span class="c">//</span>
            <span class="c">// first, find the resource-id so that we can display</span>
            <span class="c">// correct message</span>
            <span class="c">//</span>
            <b>switch</b> (<span class="r115 r">itemType</span>)
            {
                <b>case</b> <a href="#e8d23026f96d84c8" class="t t">CertificateProviderItem</a>.<a href="#82505c9bafd5fc3e" class="i field">Certificate</a>:
                    <span class="r117 r">message</span> = <span class="i">CertificateProviderStrings</span>.<span class="i">CertificateNotFound</span>;
                    <b>break</b>;
 
                <b>case</b> <a href="#e8d23026f96d84c8" class="t t">CertificateProviderItem</a>.<a href="#8dd368d9b1529869" class="i field">Store</a>:
                    <span class="r117 r">message</span> = <span class="i">CertificateProviderStrings</span>.<span class="i">CertificateStoreNotFound</span>;
                    <b>break</b>;
 
                <b>case</b> <a href="#e8d23026f96d84c8" class="t t">CertificateProviderItem</a>.<a href="#b22e248f66ce18c6" class="i field">StoreLocation</a>:
                    <span class="r117 r">message</span> = <span class="i">CertificateProviderStrings</span>.<span class="i">CertificateStoreLocationNotFound</span>;
                    <b>break</b>;
 
                <b>default</b>:
                    <span class="r117 r">message</span> = <span class="i">CertificateProviderStrings</span>.<span class="i">InvalidPath</span>;
                    <b>break</b>;
            }
 
            <span class="r117 r">message</span> = <b>string</b>.<span class="i">Format</span>(
                <span class="i n">System</span>.<span class="i">Globalization</span>.<span class="i">CultureInfo</span>.<span class="i">CurrentCulture</span>,
                <span class="r117 r">message</span>, <span class="r114 r">path</span>);
            <a href="/System.Management.Automation/A.html#d882fa1d2308673f" class="t t">ErrorDetails</a> <span id="r118 rd" class="r118 r">ed</span> = <b>new</b>(<span class="r117 r">message</span>);
 
            <span class="c">//</span>
            <span class="c">// create appropriate exception type</span>
            <span class="c">//</span>
            <b>switch</b> (<span class="r115 r">itemType</span>)
            {
                <b>case</b> <a href="#e8d23026f96d84c8" class="t t">CertificateProviderItem</a>.<a href="#82505c9bafd5fc3e" class="i field">Certificate</a>:
                    <span class="r116 r">e</span> = <b>new</b> <a href="certificateproviderexceptions.cs.html#858c3c6c048ed06c" class="t constructor">CertificateNotFoundException</a>(<span class="r117 r">message</span>);
                    <b>break</b>;
 
                <b>case</b> <a href="#e8d23026f96d84c8" class="t t">CertificateProviderItem</a>.<a href="#8dd368d9b1529869" class="i field">Store</a>:
                    <span class="r116 r">e</span> = <b>new</b> <a href="certificateproviderexceptions.cs.html#1c07c913d6e1120d" class="t constructor">CertificateStoreNotFoundException</a>(<span class="r117 r">message</span>);
                    <b>break</b>;
 
                <b>case</b> <a href="#e8d23026f96d84c8" class="t t">CertificateProviderItem</a>.<a href="#b22e248f66ce18c6" class="i field">StoreLocation</a>:
                    <span class="r116 r">e</span> = <b>new</b> <a href="certificateproviderexceptions.cs.html#1b39fd2f628dc23c" class="t constructor">CertificateStoreLocationNotFoundException</a>(<span class="r117 r">message</span>);
                    <b>break</b>;
 
                <b>default</b>:
                    <span class="r116 r">e</span> = <b>new</b> <span class="i">ArgumentException</span>(<span class="r117 r">message</span>);
                    <b>break</b>;
            }
 
            <a href="/System.Management.Automation/A.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r119 rd" class="r119 r">er</span> = <b>new</b>(
                <span class="r116 r">e</span>,
                <span class="s">&quot;CertProviderItemNotFound&quot;</span>,
                <a href="/System.Management.Automation/A.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="/System.Management.Automation/A.html#9a72a7d3051ac7c5" class="i field">ObjectNotFound</a>,
                <span class="i">targetObject</span>: <b>null</b>);
 
            <span class="r119 r">er</span>.<span class="i">ErrorDetails</span> = <span class="r118 r">ed</span>;
 
            <b>return</b> <span class="r119 r">er</span>;
        }
 
        <b>private void</b> <a id="c94b7df1614e0dcc" href="../R/c94b7df1614e0dcc.html" target="n" data-glyph="76,1" class="i method">ThrowErrorRemoting</a>(<b>int</b> <span id="r120 rd" class="r120 r">stat</span>)
        {
            <b>if</b> (<a href="#c2a6f6e8e1dd509a" class="k">this</a>.<a href="/System.Management.Automation/A.html#be8557754a3bdef0" class="i property">Host</a>.<a href="/System.Management.Automation/A.html#be091ea30a661c13" class="i property">Name</a>.<span class="i">Equals</span>(<span class="s">&quot;ServerRemoteHost&quot;</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
            {
                <span class="i">Exception</span> <span id="r121 rd" class="r121 r">e</span> = <b>new</b> <span class="i n">System</span>.<span class="i">ComponentModel</span>.<span class="i">Win32Exception</span>(<span class="r120 r">stat</span>);
                <b>string</b> <span id="r122 rd" class="r122 r">error</span> = <span class="r121 r">e</span>.<span class="i">Message</span>;
                <b>string</b> <span id="r123 rd" class="r123 r">message</span> = <span class="i">CertificateProviderStrings</span>.<span class="i">RemoteErrorMessage</span>;
                <span class="r122 r">error</span> += <span class="r123 r">message</span>;
 
                <span class="i">Exception</span> <span id="r124 rd" class="r124 r">e2</span> = <b>new</b>(<span class="r122 r">error</span>);
                <span class="i">ThrowTerminatingError</span>(
                        <b>new</b> <span class="t">ErrorRecord</span>(
                            <span class="r124 r">e2</span>,
                            <span class="s">&quot;RemotingFailure&quot;</span>,
                            <a href="/System.Management.Automation/A.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="/System.Management.Automation/A.html#707bbec7a1bb5ead" class="i field">NotSpecified</a>,
                            <b>null</b>));
            }
            <b>else</b>
            {
                <b>throw</b> <b>new</b> <span class="i n">System</span>.<span class="i">ComponentModel</span>.<span class="i">Win32Exception</span>(<span class="r120 r">stat</span>);
            }
        }
 
        <b>private void</b> <a id="027cd5e6475c3ff7" href="../R/027cd5e6475c3ff7.html" target="n" data-glyph="76,1" class="i method">ThrowInvalidOperation</a>(<b>string</b> <span id="r125 rd" class="r125 r">errorId</span>, <b>string</b> <span id="r126 rd" class="r126 r">message</span>)
        {
            <a href="/System.Management.Automation/A.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r127 rd" class="r127 r">errorRecord</span> = <b>new</b>(
                <b>new</b> <span class="i">InvalidOperationException</span>(<span class="r126 r">message</span>),
                <span class="r125 r">errorId</span>,
                <a href="/System.Management.Automation/A.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="/System.Management.Automation/A.html#b5cba3d51f976bb3" class="i field">InvalidOperation</a>,
                <span class="i">targetObject</span>: <b>null</b>);
            <span class="r127 r">errorRecord</span>.<span class="i">ErrorDetails</span> = <b>new</b> <span class="t">ErrorDetails</span>(<span class="r126 r">message</span>);
            <span class="i">ThrowTerminatingError</span>(<span class="r127 r">errorRecord</span>);
 
            <b>return</b>;
        }
 
        <b>private void</b> <a id="f00d1fe56ddcb477" href="../R/f00d1fe56ddcb477.html" target="n" data-glyph="76,1" class="i method">ThrowItemNotFound</a>(<b>string</b> <span id="r128 rd" class="r128 r">path</span>,
                                       <a href="#e8d23026f96d84c8" class="t t">CertificateProviderItem</a> <span id="r129 rd" class="r129 r">itemType</span>)
        {
            <a href="/System.Management.Automation/A.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r130 rd" class="r130 r">er</span> = <a href="#2f75bbaf8b0ed78d" class="i method">CreateErrorRecord</a>(<span class="r128 r">path</span>, <span class="r129 r">itemType</span>);
 
            <span class="i">ThrowTerminatingError</span>(<span class="r130 r">er</span>);
        }
 
        <b>private static string</b> <a id="5f3c29f7bd3fa6a7" href="../R/5f3c29f7bd3fa6a7.html" target="n" data-glyph="76,1" class="i method">NormalizePath</a>(<b>string</b> <span id="r131 rd" class="r131 r">path</span>)
        {
            <b>if</b> (<span class="r131 r">path</span>.<span class="i">Length</span> &gt; 0)
            {
                <b>char</b> <span id="r132 rd" class="r132 r">lastChar</span> = <span class="r131 r">path</span>[<span class="r131 r">path</span>.<span class="i">Length</span> - 1];
 
                <b>if</b> ((<span class="r132 r">lastChar</span> == <span class="s">&#39;/&#39;</span>) || (<span class="r132 r">lastChar</span> == <span class="s">&#39;\\&#39;</span>))
                {
                    <span class="r131 r">path</span> = <span class="r131 r">path</span>.<span class="i">Substring</span>(0, <span class="r131 r">path</span>.<span class="i">Length</span> - 1);
                }
 
                <b>string</b>[] <span id="r133 rd" class="r133 r">elts</span> = <a href="#bd050b685321e393" class="i method">GetPathElements</a>(<span class="r131 r">path</span>);
 
                <span class="r131 r">path</span> = <b>string</b>.<span class="i">Join</span>(<span class="s">&quot;\\&quot;</span>, <span class="r133 r">elts</span>);
            }
 
            <b>return</b> <span class="r131 r">path</span>;
        }
 
        <b>private static string</b>[] <a id="bd050b685321e393" href="../R/bd050b685321e393.html" target="n" data-glyph="76,1" class="i method">GetPathElements</a>(<b>string</b> <span id="r134 rd" class="r134 r">path</span>)
        {
            <b>string</b>[] <span id="r135 rd" class="r135 r">allElts</span> = <span class="r134 r">path</span>.<span class="i">Split</span>(<a href="#60b62183a3e2c487" class="i field">s_pathSeparators</a>);
            <b>string</b>[] <span id="r136 rd" class="r136 r">result</span> = <b>null</b>;
 
            <span class="i">Stack</span>&lt;<b>string</b>&gt; <span id="r137 rd" class="r137 r">elts</span> = <b>new</b>();
 
            <b>foreach</b> (<b>string</b> <span id="r138 rd" class="r138 r">e</span> <b>in</b> <span class="r135 r">allElts</span>)
            {
                <b>if</b> ((<span class="r138 r">e</span> == <span class="s">&quot;.&quot;</span>) || (<span class="r138 r">e</span> == <b>string</b>.<span class="i">Empty</span>))
                {
                    <b>continue</b>;
                }
                <b>else</b> <b>if</b> (<span class="r138 r">e</span> == <span class="s">&quot;..&quot;</span>)
                {
                    <b>if</b> (<span class="r137 r">elts</span>.<span class="i">Count</span> &gt; 0)
                    {
                        <span class="r137 r">elts</span>.<span class="i">Pop</span>();
                    }
                }
                <b>else</b>
                {
                    <span class="r137 r">elts</span>.<span class="i">Push</span>(<span class="r138 r">e</span>);
                }
            }
 
            <span class="r136 r">result</span> = <span class="r137 r">elts</span>.<span class="i">ToArray</span>();
            <span class="i">Array</span>.<span class="i">Reverse</span>(<span class="r136 r">result</span>);
 
            <b>return</b> <span class="r136 r">result</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Delete private key.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r139 r">pProvInfo</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Key prov info.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">No return.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Usage&quot;</span>, <span class="s">&quot;CA1806:DoNotIgnoreMethodResults&quot;</span>, <span class="i">MessageId</span> = <span class="s">&quot;System.Management.Automation.Security.NativeMethods.NCryptSetProperty(System.IntPtr,System.String,System.Void*,System.Int32,System.Int32)&quot;</span>)]
        [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Usage&quot;</span>, <span class="s">&quot;CA1806:DoNotIgnoreMethodResults&quot;</span>, <span class="i">MessageId</span> = <span class="s">&quot;System.Management.Automation.Security.NativeMethods.NCryptFreeObject(System.IntPtr)&quot;</span>)]
        <b>private void</b> <a id="c5a83a527718c517" href="../R/c5a83a527718c517.html" target="n" data-glyph="76,1" class="i method">DoDeleteKey</a>(<span class="i">IntPtr</span> <span id="r139 rd" class="r139 r">pProvInfo</span>)
        {
            <span class="i">IntPtr</span> <span id="r140 rd" class="r140 r">hProv</span> = <span class="i">IntPtr</span>.<span class="i">Zero</span>;
            <span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">CRYPT_KEY_PROV_INFO</span> <span id="r141 rd" class="r141 r">keyProvInfo</span> =
                <span class="i">Marshal</span>.<span class="i">PtrToStructure</span>&lt;<span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">CRYPT_KEY_PROV_INFO</span>&gt;(<span class="r139 r">pProvInfo</span>);
 
            <span class="i">IntPtr</span> <span id="r142 rd" class="r142 r">hWnd</span> = <a href="#dd6ef8c0fee00482" class="t t">DetectUIHelper</a>.<a href="#03db50bb826c2f66" class="i method">GetOwnerWindow</a>(<a href="/System.Management.Automation/A.html#be8557754a3bdef0" class="i property">Host</a>);
 
            <b>if</b> (<span class="r141 r">keyProvInfo</span>.<span class="i">dwProvType</span> != 0) <span class="c">// legacy</span>
            {
                <b>if</b> (<span class="r142 r">hWnd</span> != <span class="i">IntPtr</span>.<span class="i">Zero</span>)
                {
                    <b>if</b> (<span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">CryptAcquireContext</span>(
                        <b>ref</b> <span class="r140 r">hProv</span>,
                        <span class="r141 r">keyProvInfo</span>.<span class="i">pwszContainerName</span>,
                        <span class="r141 r">keyProvInfo</span>.<span class="i">pwszProvName</span>,
                        (<b>int</b>)<span class="r141 r">keyProvInfo</span>.<span class="i">dwProvType</span>,
                        (<b>uint</b>)<span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">ProviderFlagsEnum</span>.<span class="i">CRYPT_VERIFYCONTEXT</span>))
                    {
                        <b>unsafe</b>
                        {
                            <b>void</b>* <span id="r143 rd" class="r143 r">pWnd</span> = <span class="r142 r">hWnd</span>.<span class="i">ToPointer</span>();
                            <span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">CryptSetProvParam</span>(
                                <span class="r140 r">hProv</span>,
                                <span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">ProviderParam</span>.<span class="i">PP_CLIENT_HWND</span>,
                                &amp;<span class="r143 r">pWnd</span>,
                                0);
                            <span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">CryptReleaseContext</span>(<span class="r140 r">hProv</span>, 0);
                        }
                    }
                }
 
                <b>if</b> (!<span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">CryptAcquireContext</span>(
                                <b>ref</b> <span class="r140 r">hProv</span>,
                                <span class="r141 r">keyProvInfo</span>.<span class="i">pwszContainerName</span>,
                                <span class="r141 r">keyProvInfo</span>.<span class="i">pwszProvName</span>,
                                (<b>int</b>)<span class="r141 r">keyProvInfo</span>.<span class="i">dwProvType</span>,
                                <span class="r141 r">keyProvInfo</span>.<span class="i">dwFlags</span> | (<b>uint</b>)<span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">ProviderFlagsEnum</span>.<span class="i">CRYPT_DELETEKEYSET</span> |
                                (<span class="r142 r">hWnd</span> == <span class="i">IntPtr</span>.<span class="i">Zero</span> ? (<b>uint</b>)<span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">ProviderFlagsEnum</span>.<span class="i">CRYPT_SILENT</span> : 0)))
                {
                    <span class="i">ThrowErrorRemoting</span>(<span class="i">Marshal</span>.<span class="i">GetLastWin32Error</span>());
                }
            }
            <b>else</b>  <span class="c">// cng key</span>
            {
                <b>uint</b> <span id="r144 rd" class="r144 r">cngKeyFlag</span> = 0;
                <b>int</b> <span id="r145 rd" class="r145 r">result</span> = 0;
 
                <span class="i">IntPtr</span> <span id="r146 rd" class="r146 r">hCNGProv</span> = <span class="i">IntPtr</span>.<span class="i">Zero</span>;
                <span class="i">IntPtr</span> <span id="r147 rd" class="r147 r">hCNGKey</span> = <span class="i">IntPtr</span>.<span class="i">Zero</span>;
 
                <b>if</b> ((<span class="r141 r">keyProvInfo</span>.<span class="i">dwFlags</span> &amp; (<b>uint</b>)<span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">ProviderFlagsEnum</span>.<span class="i">CRYPT_MACHINE_KEYSET</span>) != 0)
                {
                    <span class="r144 r">cngKeyFlag</span> = (<b>uint</b>)<span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">NCryptDeletKeyFlag</span>.<span class="i">NCRYPT_MACHINE_KEY_FLAG</span>;
                }
 
                <b>if</b> (<span class="r142 r">hWnd</span> == <span class="i">IntPtr</span>.<span class="i">Zero</span> ||
                    (<span class="r141 r">keyProvInfo</span>.<span class="i">dwFlags</span> &amp; (<b>uint</b>)<span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">ProviderFlagsEnum</span>.<span class="i">CRYPT_SILENT</span>) != 0)
                {
                    <span class="r144 r">cngKeyFlag</span> |= (<b>uint</b>)<span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">NCryptDeletKeyFlag</span>.<span class="i">NCRYPT_SILENT_FLAG</span>;
                }
 
                <b>int</b> <span id="r148 rd" class="r148 r">stat</span> = 0;
                <b>try</b>
                {
                    <span class="r148 r">stat</span> = <span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">NCryptOpenStorageProvider</span>(
                                    <b>ref</b> <span class="r146 r">hCNGProv</span>,
                                    <span class="r141 r">keyProvInfo</span>.<span class="i">pwszProvName</span>,
                                    0);
                    <b>if</b> (<span class="r148 r">stat</span> != 0)
                    {
                        <a href="#c94b7df1614e0dcc" class="i method">ThrowErrorRemoting</a>(<span class="r148 r">stat</span>);
                    }
 
                    <span class="r148 r">stat</span> = <span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">NCryptOpenKey</span>(
                                        <span class="r146 r">hCNGProv</span>,
                                        <b>ref</b> <span class="r147 r">hCNGKey</span>,
                                        <span class="r141 r">keyProvInfo</span>.<span class="i">pwszContainerName</span>,
                                        <span class="r141 r">keyProvInfo</span>.<span class="i">dwKeySpec</span>,
                                        <span class="r144 r">cngKeyFlag</span>);
                    <b>if</b> (<span class="r148 r">stat</span> != 0)
                    {
                        <a href="#c94b7df1614e0dcc" class="i method">ThrowErrorRemoting</a>(<span class="r148 r">stat</span>);
                    }
 
                    <b>if</b> ((<span class="r144 r">cngKeyFlag</span> &amp; (<b>uint</b>)<span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">NCryptDeletKeyFlag</span>.<span class="i">NCRYPT_SILENT_FLAG</span>) != 0)
                    {
                        <b>unsafe</b>
                        {
                            <b>void</b>* <span id="r149 rd" class="r149 r">pWnd</span> = <span class="r142 r">hWnd</span>.<span class="i">ToPointer</span>();
                            <span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">NCryptSetProperty</span>(
                                <span class="r146 r">hCNGProv</span>,
                                <span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">NCRYPT_WINDOW_HANDLE_PROPERTY</span>,
                                &amp;<span class="r149 r">pWnd</span>,
                                <b>sizeof</b>(<b>void</b>*),
                                0); <span class="c">// dwFlags</span>
                        }
                    }
 
                    <span class="r148 r">stat</span> = <span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">NCryptDeleteKey</span>(<span class="r147 r">hCNGKey</span>, 0);
                    <b>if</b> (<span class="r148 r">stat</span> != 0)
                    {
                        <a href="#c94b7df1614e0dcc" class="i method">ThrowErrorRemoting</a>(<span class="r148 r">stat</span>);
                    }
 
                    <span class="r147 r">hCNGKey</span> = <span class="i">IntPtr</span>.<span class="i">Zero</span>;
                }
                <b>finally</b>
                {
                    <b>if</b> (<span class="r146 r">hCNGProv</span> != <span class="i">IntPtr</span>.<span class="i">Zero</span>)
                        <span class="r145 r">result</span> = <span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">NCryptFreeObject</span>(<span class="r146 r">hCNGProv</span>);
 
                    <b>if</b> (<span class="r147 r">hCNGKey</span> != <span class="i">IntPtr</span>.<span class="i">Zero</span>)
                        <span class="r145 r">result</span> = <span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">NCryptFreeObject</span>(<span class="r147 r">hCNGKey</span>);
                }
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Delete the cert store; if -DeleteKey is specified, we also delete</span>
        <span class="c">///</span><span class="c"> the associated private key.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r150 r">storeName</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The store name.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r151 r">fDeleteKey</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Boolean to specify whether or not to delete private key.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span> <span class="c">=</span> <span class="c">&quot;</span><span class="r152 r">sourcePath</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Source path.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">No return.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>private void</b> <a id="60b3702815aef4b7" href="../R/60b3702815aef4b7.html" target="n" data-glyph="76,1" class="i method">RemoveCertStore</a>(<b>string</b> <span id="r150 rd" class="r150 r">storeName</span>, <b>bool</b> <span id="r151 rd" class="r151 r">fDeleteKey</span>, <b>string</b> <span id="r152 rd" class="r152 r">sourcePath</span>)
        {
            <span class="c">// if recurse is true, remove every cert in the store</span>
            <span class="i">IntPtr</span> <span id="r153 rd" class="r153 r">localName</span> = <span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">CryptFindLocalizedName</span>(<span class="r150 r">storeName</span>);
            <b>string</b>[] <span id="r154 rd" class="r154 r">pathElements</span> = <a href="#bd050b685321e393" class="i method">GetPathElements</a>(<span class="r152 r">sourcePath</span>);
            <b>if</b> (<span class="r153 r">localName</span> == <span class="i">IntPtr</span>.<span class="i">Zero</span>)<span class="c">//not find, we can remove</span>
            {
                <a href="#b042c5630701a14b" class="t t">X509NativeStore</a> <span id="r155 rd" class="r155 r">store</span> = <b>null</b>;
 
                <span class="c">//</span>
                <span class="c">// first open the store</span>
                <span class="c">//</span>
                <span class="r155 r">store</span> = <a href="#ee129085879c3c23" class="i method">GetStore</a>(<span class="r152 r">sourcePath</span>, <b>false</b>, <span class="r154 r">pathElements</span>);
                <span class="r155 r">store</span>.<a href="#d28202dfbc20d0d8" class="i method">Open</a>(<a href="#bd3f5b33f16588d3" class="i method">IncludeArchivedCerts</a>());
 
                <span class="c">//</span>
                <span class="c">// enumerate over each cert and remove it</span>
                <span class="c">//</span>
                <span class="i">IntPtr</span> <span id="r156 rd" class="r156 r">certContext</span> = <span class="r155 r">store</span>.<a href="#939ecd37de4b527e" class="i method">GetFirstCert</a>();
                <b>while</b> (<span class="r156 r">certContext</span> != <span class="i">IntPtr</span>.<span class="i">Zero</span>)
                {
                    <span class="i">X509Certificate2</span> <span id="r157 rd" class="r157 r">cert</span> = <b>new</b>(<span class="r156 r">certContext</span>);
                    <b>string</b> <span id="r158 rd" class="r158 r">certPath</span> = <span class="r152 r">sourcePath</span> + <span class="r157 r">cert</span>.<span class="i">Thumbprint</span>;
                    <a href="#fc8100e52dd06d53" class="i method">RemoveCertItem</a>(<span class="r157 r">cert</span>, <span class="r151 r">fDeleteKey</span>, <b>true</b>, <span class="r158 r">certPath</span>);
 
                    <span class="r156 r">certContext</span> = <span class="r155 r">store</span>.<a href="#03be2ed900c1b0c8" class="i method">GetNextCert</a>(<span class="r156 r">certContext</span>);
                }
                <span class="c">// remove the cert store</span>
                <b>const</b> <span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">CertOpenStoreFlags</span> <span id="r159 rd" class="r159 r">StoreFlags</span> =
                        <span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">CertOpenStoreFlags</span>.<span class="i">CERT_STORE_READONLY_FLAG</span> |
                        <span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">CertOpenStoreFlags</span>.<span class="i">CERT_STORE_OPEN_EXISTING_FLAG</span> |
                        <span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">CertOpenStoreFlags</span>.<span class="i">CERT_STORE_DEFER_CLOSE_UNTIL_LAST_FREE_FLAG</span> |
                        <span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">CertOpenStoreFlags</span>.<span class="i">CERT_STORE_DELETE_FLAG</span> |
                        <span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">CertOpenStoreFlags</span>.<span class="i">CERT_SYSTEM_STORE_LOCAL_MACHINE</span>;
 
                <span class="c">// delete store</span>
                <span class="i">IntPtr</span> <span id="r160 rd" class="r160 r">hCertStore</span> = <span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">CertOpenStore</span>(
                                <span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">CertOpenStoreProvider</span>.<span class="i">CERT_STORE_PROV_SYSTEM</span>,
                                <span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">CertOpenStoreEncodingType</span>.<span class="i">X509_ASN_ENCODING</span>,
                                <span class="i">IntPtr</span>.<span class="i">Zero</span>,  <span class="c">// hCryptProv</span>
                                <span class="r159 r">StoreFlags</span>,
                                <span class="r150 r">storeName</span>);
            }
            <b>else</b>
            {
                <b>string</b> <span id="r161 rd" class="r161 r">message</span> = <b>string</b>.<span class="i">Format</span>(
                                        <span class="i">CultureInfo</span>.<span class="i">CurrentCulture</span>,
                                        <span class="i">CertificateProviderStrings</span>.<span class="i">RemoveStoreTemplate</span>,
                                        <span class="r150 r">storeName</span>);
                <b>const string</b> <span id="r162 rd" class="r162 r">errorId</span> = <span class="s">&quot;CannotRemoveSystemStore&quot;</span>;
                <a href="#027cd5e6475c3ff7" class="i method">ThrowInvalidOperation</a>(<span class="r162 r">errorId</span>, <span class="r161 r">message</span>);
            }
        }
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Delete the a single cert from the store; if -DeleteKey is specified, we also delete</span>
        <span class="c">///</span><span class="c"> the associated private key.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r163 r">cert</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">An X509Certificate2 object.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r164 r">fDeleteKey</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Boolean to specify whether or not to delete private key.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r165 r">fMachine</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Machine context or user.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span> <span class="c">=</span> <span class="c">&quot;</span><span class="r166 r">sourcePath</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Source path.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">No return.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>private void</b> <a id="fc8100e52dd06d53" href="../R/fc8100e52dd06d53.html" target="n" data-glyph="76,1" class="i method">RemoveCertItem</a>(<span class="i">X509Certificate2</span> <span id="r163 rd" class="r163 r">cert</span>, <b>bool</b> <span id="r164 rd" class="r164 r">fDeleteKey</span>, <b>bool</b> <span id="r165 rd" class="r165 r">fMachine</span>, <b>string</b> <span id="r166 rd" class="r166 r">sourcePath</span>)
        {
            <b>if</b> (<span class="r163 r">cert</span> != <b>null</b>)
            {
                <b>string</b> <span id="r167 rd" class="r167 r">action</span> = <b>null</b>;
                <b>if</b> (<span class="r164 r">fDeleteKey</span>)
                {
                    <span class="r167 r">action</span> = <span class="i">CertificateProviderStrings</span>.<span class="i">Action_RemoveAndDeleteKey</span>;
                }
                <b>else</b>
                {
                    <span class="r167 r">action</span> = <span class="i">CertificateProviderStrings</span>.<span class="i">Action_Remove</span>;
                }
 
                <b>string</b> <span id="r168 rd" class="r168 r">resource</span> = <b>string</b>.<span class="i">Format</span>(
                                        <span class="i">CultureInfo</span>.<span class="i">CurrentCulture</span>,
                                        <span class="i">CertificateProviderStrings</span>.<span class="i">RemoveItemTemplate</span>,
                                        <span class="r166 r">sourcePath</span>);
 
                <b>if</b> (<span class="i">ShouldProcess</span>(<span class="r168 r">resource</span>, <span class="r167 r">action</span>))
                {
                    <a href="#eee160d370363aaf" class="i method">DoRemove</a>(<span class="r163 r">cert</span>, <span class="r164 r">fDeleteKey</span>, <span class="r165 r">fMachine</span>, <span class="r166 r">sourcePath</span>);
                }
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Delete the cert from the store; if -DeleteKey is specified, we also delete</span>
        <span class="c">///</span><span class="c"> the associated private key.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r169 r">cert</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">An X509Certificate2 object.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r170 r">fDeleteKey</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Boolean to specify whether or not to delete private key.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r171 r">fMachine</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Machine context or user.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span> <span class="c">=</span> <span class="c">&quot;</span><span class="r172 r">sourcePath</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Source path.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">No return.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        [<span class="i n">System</span>.<span class="i">Diagnostics</span>.<span class="i">CodeAnalysis</span>.<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Usage&quot;</span>, <span class="s">&quot;CA1806:DoNotIgnoreMethodResults&quot;</span>)]
        <b>private void</b> <a id="eee160d370363aaf" href="../R/eee160d370363aaf.html" target="n" data-glyph="76,1" class="i method">DoRemove</a>(<span class="i">X509Certificate2</span> <span id="r169 rd" class="r169 r">cert</span>, <b>bool</b> <span id="r170 rd" class="r170 r">fDeleteKey</span>, <b>bool</b> <span id="r171 rd" class="r171 r">fMachine</span>, <b>string</b> <span id="r172 rd" class="r172 r">sourcePath</span>)
        {
            <span class="c">// get CERT_KEY_PROV_INFO_PROP_ID</span>
            <b>int</b> <span id="r173 rd" class="r173 r">provSize</span> = 0;
            <span class="i">IntPtr</span> <span id="r174 rd" class="r174 r">pProvInfo</span> = <span class="i">IntPtr</span>.<span class="i">Zero</span>;
            <b>bool</b> <span id="r175 rd" class="r175 r">fHasPrivateKey</span> = <b>false</b>;
 
            <b>try</b>
            {
                <b>if</b> (<span class="r170 r">fDeleteKey</span>)
                {
                    <span class="c">// it is fine if below call fails</span>
                    <b>if</b> (<span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">CertGetCertificateContextProperty</span>(
                                <span class="r169 r">cert</span>.<span class="i">Handle</span>,
                                <span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">CertPropertyId</span>.<span class="i">CERT_KEY_PROV_INFO_PROP_ID</span>,
                                <span class="i">IntPtr</span>.<span class="i">Zero</span>,
                                <b>ref</b> <span class="r173 r">provSize</span>))
                    {
                        <span class="r174 r">pProvInfo</span> = <span class="i">Marshal</span>.<span class="i">AllocHGlobal</span>((<b>int</b>)<span class="r173 r">provSize</span>);
 
                        <b>if</b> (<span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">CertGetCertificateContextProperty</span>(
                                <span class="r169 r">cert</span>.<span class="i">Handle</span>,
                                <span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">CertPropertyId</span>.<span class="i">CERT_KEY_PROV_INFO_PROP_ID</span>,
                                <span class="r174 r">pProvInfo</span>,
                                <b>ref</b> <span class="r173 r">provSize</span>))
                        {
                            <span class="r175 r">fHasPrivateKey</span> = <b>true</b>;
                        }
                    }
 
                    <b>if</b> (!<span class="r175 r">fHasPrivateKey</span>)
                    {
                        <span class="c">// raise a verbose message</span>
                        <span class="c">// we should not use WriteWarning here</span>
                        <b>string</b> <span id="r176 rd" class="r176 r">verboseNoPrivatekey</span> = <span class="i">CertificateProviderStrings</span>.<span class="i">VerboseNoPrivateKey</span>;
                        <span class="i">WriteVerbose</span>(<span class="r176 r">verboseNoPrivatekey</span>);
                    }
                }
 
                <span class="c">// do remove certificate</span>
                <span class="c">// should not use the original handle</span>
 
                <b>if</b> (!<span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">CertDeleteCertificateFromStore</span>(
                            <span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">CertDuplicateCertificateContext</span>(<span class="r169 r">cert</span>.<span class="i">Handle</span>)))
                {
                    <b>throw</b> <b>new</b> <span class="i n">System</span>.<span class="i">ComponentModel</span>.<span class="i">Win32Exception</span>(<span class="i">Marshal</span>.<span class="i">GetLastWin32Error</span>());
                }
 
                <span class="c">// commit the change to physical store</span>
                <b>if</b> (<span class="r172 r">sourcePath</span>.<span class="i">Contains</span>(<span class="s">&quot;UserDS&quot;</span>))
                {
                    <span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">CERT_CONTEXT</span> <span id="r177 rd" class="r177 r">context</span> =
                        <span class="i">Marshal</span>.<span class="i">PtrToStructure</span>&lt;<span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">CERT_CONTEXT</span>&gt;(<span class="r169 r">cert</span>.<span class="i">Handle</span>);
 
                    <span class="i">CommitUserDS</span>(<span class="r177 r">context</span>.<span class="i">hCertStore</span>);
                }
 
                <span class="c">// TODO: Log Cert Delete</span>
 
                <span class="c">// delete private key</span>
                <b>if</b> (<span class="r170 r">fDeleteKey</span> &amp;&amp; <span class="r175 r">fHasPrivateKey</span>)
                {
                    <a href="#c5a83a527718c517" class="i method">DoDeleteKey</a>(<span class="r174 r">pProvInfo</span>);
                }
            }
            <b>finally</b>
            {
                <b>if</b> (<span class="r174 r">pProvInfo</span> != <span class="i">IntPtr</span>.<span class="i">Zero</span>)
                    <span class="i">Marshal</span>.<span class="i">FreeHGlobal</span>(<span class="r174 r">pProvInfo</span>);
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Commit store for UserDS store.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r178 r">storeHandle</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">An IntPtr for store handle.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">No return.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>private static void</b> <a id="7213323a1d29db6e" href="../R/7213323a1d29db6e.html" target="n" data-glyph="76,1" class="i method">CommitUserDS</a>(<span class="i">IntPtr</span> <span id="r178 rd" class="r178 r">storeHandle</span>)
        {
            <b>if</b> (!<span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">CertControlStore</span>(
                                        <span class="r178 r">storeHandle</span>,
                                        0,
                                        <span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">CertControlStoreType</span>.<span class="i">CERT_STORE_CTRL_COMMIT</span>,
                                        <span class="i">IntPtr</span>.<span class="i">Zero</span>))
            {
                <b>throw</b> <b>new</b> <span class="i n">System</span>.<span class="i">ComponentModel</span>.<span class="i">Win32Exception</span>(<span class="i">Marshal</span>.<span class="i">GetLastWin32Error</span>());
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Delete the cert from the original store and add to the destination store.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r179 r">destination</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Destination path.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r180 r">cert</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">An X509Certificate2.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r181 r">store</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">An X509NativeStore.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r182 r">sourcePath</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Source path.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">No return.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        [<span class="i n">System</span>.<span class="i">Diagnostics</span>.<span class="i">CodeAnalysis</span>.<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Usage&quot;</span>, <span class="s">&quot;CA1806:DoNotIgnoreMethodResults&quot;</span>)]
        <b>private void</b> <a id="da4962b164b00088" href="../R/da4962b164b00088.html" target="n" data-glyph="76,1" class="i method">DoMove</a>(<b>string</b> <span id="r179 rd" class="r179 r">destination</span>, <span class="i">X509Certificate2</span> <span id="r180 rd" class="r180 r">cert</span>, <a href="#b042c5630701a14b" class="t t">X509NativeStore</a> <span id="r181 rd" class="r181 r">store</span>, <b>string</b> <span id="r182 rd" class="r182 r">sourcePath</span>)
        {
            <span class="i">IntPtr</span> <span id="r183 rd" class="r183 r">dupCert</span> = <span class="i">IntPtr</span>.<span class="i">Zero</span>;  <span class="c">// should not free this</span>
            <span class="i">IntPtr</span> <span id="r184 rd" class="r184 r">outCert</span> = <span class="i">IntPtr</span>.<span class="i">Zero</span>;
 
            <span class="c">// duplicate cert first</span>
            <span class="r183 r">dupCert</span> = <span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">CertDuplicateCertificateContext</span>(<span class="r180 r">cert</span>.<span class="i">Handle</span>);
 
            <b>if</b> (<span class="r183 r">dupCert</span> == <span class="i">IntPtr</span>.<span class="i">Zero</span>)
            {
                <b>throw</b> <b>new</b> <span class="i n">System</span>.<span class="i">ComponentModel</span>.<span class="i">Win32Exception</span>(<span class="i">Marshal</span>.<span class="i">GetLastWin32Error</span>());
            }
            <b>else</b>
            {
                <b>if</b> (!<span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">CertAddCertificateContextToStore</span>(
                                             <span class="r181 r">store</span>.<a href="#7eb31f2ba64133ff" class="i property">StoreHandle</a>,
                                             <span class="r180 r">cert</span>.<span class="i">Handle</span>,
                                             (<b>uint</b>)<span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">AddCertificateContext</span>.<span class="i">CERT_STORE_ADD_ALWAYS</span>,
                                             <b>ref</b> <span class="r184 r">outCert</span>))
                {
                    <b>throw</b> <b>new</b> <span class="i n">System</span>.<span class="i">ComponentModel</span>.<span class="i">Win32Exception</span>(<span class="i">Marshal</span>.<span class="i">GetLastWin32Error</span>());
                }
 
                <b>if</b> (!<span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">CertDeleteCertificateFromStore</span>(<span class="r183 r">dupCert</span>))
                {
                    <b>throw</b> <b>new</b> <span class="i n">System</span>.<span class="i">ComponentModel</span>.<span class="i">Win32Exception</span>(<span class="i">Marshal</span>.<span class="i">GetLastWin32Error</span>());
                }
 
                <span class="c">// TODO: log cert move</span>
            }
 
            <span class="c">// commit the change to physical store</span>
            <b>if</b> (<span class="r179 r">destination</span>.<span class="i">Contains</span>(<span class="s">&quot;UserDS&quot;</span>))
            {
                <a href="#7213323a1d29db6e" class="i method">CommitUserDS</a>(<span class="r181 r">store</span>.<a href="#7eb31f2ba64133ff" class="i property">StoreHandle</a>);
            }
 
            <b>if</b> (<span class="r182 r">sourcePath</span>.<span class="i">Contains</span>(<span class="s">&quot;UserDS&quot;</span>))
            {
                <span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">CERT_CONTEXT</span> <span id="r185 rd" class="r185 r">context</span> = <span class="i">Marshal</span>.<span class="i">PtrToStructure</span>&lt;<span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">CERT_CONTEXT</span>&gt;(<span class="r180 r">cert</span>.<span class="i">Handle</span>);
 
                <span class="i">CommitUserDS</span>(<span class="r185 r">context</span>.<span class="i">hCertStore</span>);
            }
 
            <span class="c">// get the output object</span>
            <span class="i">X509Certificate2</span> <span id="r186 rd" class="r186 r">outObj</span> = <b>new</b>(<span class="r184 r">outCert</span>);
            <b>string</b> <span id="r187 rd" class="r187 r">certName</span> = <a href="#69efff4482164a93" class="i method">GetCertName</a>(<span class="r186 r">outObj</span>);
            <b>string</b> <span id="r188 rd" class="r188 r">certPath</span> = <span class="i">MakePath</span>(<span class="r179 r">destination</span>, <span class="r187 r">certName</span>);
            <span class="i">WriteItemObject</span>((<b>object</b>)<span class="r186 r">outObj</span>, <span class="r188 r">certPath</span>, <b>false</b>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Fetches the store-location/store/certificate at the</span>
        <span class="c">///</span><span class="c"> specified path.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r189 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Path to the item.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r190 r">test</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">True if this is to only for an ItemExists call. Returns True / False.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r191 r">isContainer</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Set to true if item exists and is a container.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">Item at the path.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>private object</b> <a id="3862cf48fc3ad194" href="../R/3862cf48fc3ad194.html" target="n" data-glyph="76,1" class="i method">GetItemAtPath</a>(<b>string</b> <span id="r189 rd" class="r189 r">path</span>, <b>bool</b> <span id="r190 rd" class="r190 r">test</span>, <b>out bool</b> <span id="r191 rd" class="r191 r">isContainer</span>)
        {
            <span class="i">Utils</span>.<span class="i">CheckArgForNull</span>(<span class="r189 r">path</span>, <span class="s">&quot;path&quot;</span>);
 
            <b>object</b> <span id="r192 rd" class="r192 r">item</span> = <b>null</b>;
            <b>string</b>[] <span id="r193 rd" class="r193 r">pathElements</span> = <a href="#bd050b685321e393" class="i method">GetPathElements</a>(<span class="r189 r">path</span>);
 
            <span class="c">//</span>
            <span class="c">// certs have a fixed depth hierarchy.</span>
            <span class="c">//</span>
            <span class="c">// pathElements.Length == 0 ==&gt; List&lt;X509StoreLocation&gt;</span>
            <span class="c">// pathElements.Length == 1 ==&gt; X509StoreLocation</span>
            <span class="c">// pathElements.Length == 2 ==&gt; X509NativeStore</span>
            <span class="c">// pathElements.Length == 3 ==&gt; X509Certificate2</span>
            <span class="c">//</span>
            <span class="c">// Thus lengths 1 &amp; 2 are container items.</span>
            <span class="c">//</span>
            <span class="r191 r">isContainer</span> = <span class="r193 r">pathElements</span>.<span class="i">Length</span> &lt;= 2;
 
            <a href="#b042c5630701a14b" class="t t">X509NativeStore</a> <span id="r194 rd" class="r194 r">store</span> = <b>null</b>;
 
            <span class="c">//</span>
            <span class="c">// handle invalid path depth</span>
            <span class="c">//</span>
            <b>if</b> (<span class="r193 r">pathElements</span>.<span class="i">Length</span> &gt; 3)
            {
                <b>if</b> (<span class="r190 r">test</span>)
                {
                    <b>return</b> <b>false</b>;
                }
                <b>else</b>
                {
                    <a href="#f00d1fe56ddcb477" class="i method">ThrowItemNotFound</a>(<span class="r189 r">path</span>, <a href="#e8d23026f96d84c8" class="t t">CertificateProviderItem</a>.<a href="#82505c9bafd5fc3e" class="i field">Certificate</a>);
                }
            }
 
            <span class="c">//</span>
            <span class="c">// if path cache already has the item, return it</span>
            <span class="c">//</span>
            <span class="r192 r">item</span> = <a href="#28f414c57f97eba3" class="i method">GetCachedItem</a>(<span class="r189 r">path</span>);
 
            <b>if</b> (<span class="r192 r">item</span> == <b>null</b>)
            {
                <b>switch</b> (<span class="r193 r">pathElements</span>.<span class="i">Length</span>)
                {
                    <b>case</b> 1:
                        <span class="c">// if this is a single element path and if we</span>
                        <span class="c">// did not find in path-cache, the path</span>
                        <span class="c">// must be wrong. This is because we initialize</span>
                        <span class="c">// the only possible two store locations in ctor</span>
                        <b>if</b> (<span class="r190 r">test</span>)
                        {
                            <span class="r191 r">isContainer</span> = <b>false</b>;
                            <b>return</b> <b>false</b>;
                        }
                        <b>else</b>
                        {
                            <a href="#f00d1fe56ddcb477" class="i method">ThrowItemNotFound</a>(<span class="r189 r">path</span>, <a href="#e8d23026f96d84c8" class="t t">CertificateProviderItem</a>.<a href="#b22e248f66ce18c6" class="i field">StoreLocation</a>);
                        }
 
                        <b>break</b>;
 
                    <b>case</b> 2:
                        <span class="c">//</span>
                        <span class="c">// items at paths of depth 2 are stores.</span>
                        <span class="c">//</span>
 
                        <span class="c">//</span>
                        <span class="c">// GetStore() handles store-not-found case. If Test is true,</span>
                        <span class="c">// Item is True / False and we can return it.</span>
                        <span class="c">//</span>
                        <span class="r194 r">store</span> = <a href="#ee129085879c3c23" class="i method">GetStore</a>(<span class="r189 r">path</span>, <span class="r190 r">test</span>, <span class="r193 r">pathElements</span>);
                        <span class="r192 r">item</span> = <span class="r194 r">store</span>;
 
                        <b>break</b>;
 
                    <b>case</b> 3:
                        <span class="c">//</span>
                        <span class="c">// items at paths of depth 3 are certificates.</span>
                        <span class="c">//</span>
                        <b>string</b> <span id="r195 rd" class="r195 r">storePath</span> = <span class="i">GetParentPath</span>(<span class="r189 r">path</span>, <b>string</b>.<span class="i">Empty</span>);
                        <b>string</b>[] <span id="r196 rd" class="r196 r">storePathElements</span> = <a href="#bd050b685321e393" class="i method">GetPathElements</a>(<span class="r195 r">storePath</span>);
 
                        <span class="c">//</span>
                        <span class="c">// first get the store</span>
                        <span class="c">//</span>
 
                        <span class="r194 r">store</span> = <a href="#ee129085879c3c23" class="i method">GetStore</a>(<span class="r195 r">storePath</span>, <b>false</b>, <span class="r196 r">storePathElements</span>);
 
                        <span class="c">//</span>
                        <span class="c">// store must be opened to get access to the</span>
                        <span class="c">// certificates within it.</span>
                        <span class="c">//</span>
 
                        <span class="r194 r">store</span>.<a href="#d28202dfbc20d0d8" class="i method">Open</a>(<a href="#bd3f5b33f16588d3" class="i method">IncludeArchivedCerts</a>());
 
                        <span class="i">IntPtr</span> <span id="r197 rd" class="r197 r">certContext</span> = <span class="r194 r">store</span>.<a href="#d860dfcc81066e57" class="i method">GetCertByName</a>(<span class="r193 r">pathElements</span>[2]);
                        <b>if</b> (<span class="r197 r">certContext</span> == <span class="i">IntPtr</span>.<span class="i">Zero</span>)
                        {
                            <b>if</b> (<span class="r190 r">test</span>)
                            {
                                <b>return</b> <b>false</b>;
                            }
                            <b>else</b>
                            {
                                <a href="#f00d1fe56ddcb477" class="i method">ThrowItemNotFound</a>(<span class="r189 r">path</span>, <a href="#e8d23026f96d84c8" class="t t">CertificateProviderItem</a>.<a href="#82505c9bafd5fc3e" class="i field">Certificate</a>);
                            }
                        }
 
                        <span class="c">// Return true / false rather than the certificate</span>
                        <b>if</b> (<span class="r190 r">test</span>)
                        {
                            <span class="r192 r">item</span> = <b>true</b>;
                        }
                        <b>else</b>
                        {
                            <span class="r192 r">item</span> = <b>new</b> <span class="i">X509Certificate2</span>(<span class="r197 r">certContext</span>);
                        }
 
                        <span class="r194 r">store</span>.<a href="#2b44ac4b9e1d3dab" class="i method">FreeCert</a>(<span class="r197 r">certContext</span>);
 
                        <b>break</b>;
 
                    <b>default</b>:
                        <span class="c">// already handled by ThrowItemNotFound()</span>
                        <span class="c">// at the beginning.</span>
                        <b>break</b>;
                }
            }
 
            <b>if</b> ((<span class="r192 r">item</span> != <b>null</b>) &amp;&amp; <span class="r190 r">test</span>)
            {
                <span class="r192 r">item</span> = <b>true</b>;
            }
 
            <b>return</b> <span class="r192 r">item</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the child items of a given store, or location.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r198 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The full path of the store or location to enumerate.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r199 r">recurse</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If true, recursively enumerates the child items as well.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">System</span>.<span class="i">ArgumentNullException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Path is null or empty.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">System</span>.<span class="i">Security</span>.<span class="i">Cryptography</span>.<span class="i">CryptographicException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This exception can be thrown if any cryptographic error occurs.</span>
        <span class="c">///</span><span class="c"> It is not possible to know exactly what went wrong.</span>
        <span class="c">///</span><span class="c"> This is because of the way CryptographicException is designed.</span>
        <span class="c">///</span><span class="c"> Possible reasons:</span>
        <span class="c">///</span><span class="c">  -- certificate is invalid</span>
        <span class="c">///</span><span class="c">  -- certificate has no private key</span>
        <span class="c">///</span><span class="c">  -- certificate password mismatch</span>
        <span class="c">///</span><span class="c">  -- etc</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>protected override void</b> <a id="86b2f1cffe99be76" href="../R/86b2f1cffe99be76.html" target="n" data-glyph="75,1" class="i method">GetChildItems</a>(<b>string</b> <span id="r198 rd" class="r198 r">path</span>, <b>bool</b> <span id="r199 rd" class="r199 r">recurse</span>)
        {
            <span class="r198 r">path</span> = <a href="#5f3c29f7bd3fa6a7" class="i method">NormalizePath</a>(<span class="r198 r">path</span>);
 
            <a href="#e26fb0d837ec97b6" class="i method">GetChildItemsOrNames</a>(<span class="r198 r">path</span>, <span class="r199 r">recurse</span>, <a href="/System.Management.Automation/A.html#33becc108c70a3e1" class="t t">ReturnContainers</a>.<a href="/System.Management.Automation/A.html#1b66c2d2e8f051dd" class="i field">ReturnAllContainers</a>, <b>false</b>, <a href="#1fe890fc6cd2c7a7" class="i method">GetFilter</a>());
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the child names of a given store, or location.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r200 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The full path of the store or location to enumerate.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r201 r">returnContainers</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Determines if all containers should be returned or only those containers that match the</span>
        <span class="c">///</span><span class="c"> filter(s).</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">System</span>.<span class="i">ArgumentNullException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Path is null or empty.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">System</span>.<span class="i">Security</span>.<span class="i">Cryptography</span>.<span class="i">CryptographicException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This exception can be thrown if any cryptographic error occurs.</span>
        <span class="c">///</span><span class="c"> It is not possible to know exactly what went wrong.</span>
        <span class="c">///</span><span class="c"> This is because of the way CryptographicException is designed.</span>
        <span class="c">///</span><span class="c"> Possible reasons:</span>
        <span class="c">///</span><span class="c">  -- certificate is invalid</span>
        <span class="c">///</span><span class="c">  -- certificate has no private key</span>
        <span class="c">///</span><span class="c">  -- certificate password mismatch</span>
        <span class="c">///</span><span class="c">  -- etc</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>protected override void</b> <a id="d5f97384de76fb55" href="../R/d5f97384de76fb55.html" target="n" data-glyph="75,1" class="i method">GetChildNames</a>(
            <b>string</b> <span id="r200 rd" class="r200 r">path</span>,
            <a href="/System.Management.Automation/A.html#33becc108c70a3e1" class="t t">ReturnContainers</a> <span id="r201 rd" class="r201 r">returnContainers</span>)
        {
            <span class="r200 r">path</span> = <a href="#5f3c29f7bd3fa6a7" class="i method">NormalizePath</a>(<span class="r200 r">path</span>);
            <a href="#e26fb0d837ec97b6" class="i method">GetChildItemsOrNames</a>(<span class="r200 r">path</span>, <b>false</b>, <span class="r201 r">returnContainers</span>, <b>true</b>, <a href="#1fe890fc6cd2c7a7" class="i method">GetFilter</a>());
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Determines if the item at the specified path is a store</span>
        <span class="c">///</span><span class="c"> or location.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> True if the item at the specified path is a store or location.</span>
        <span class="c">///</span><span class="c"> False otherwise.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">System</span>.<span class="i">ArgumentNullException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Path is null or empty.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">System</span>.<span class="i">Security</span>.<span class="i">Cryptography</span>.<span class="i">CryptographicException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This exception can be thrown if any cryptographic error occurs.</span>
        <span class="c">///</span><span class="c"> It is not possible to know exactly what went wrong.</span>
        <span class="c">///</span><span class="c"> This is because of the way CryptographicException is designed.</span>
        <span class="c">///</span><span class="c"> Possible reasons:</span>
        <span class="c">///</span><span class="c">  -- certificate is invalid</span>
        <span class="c">///</span><span class="c">  -- certificate has no private key</span>
        <span class="c">///</span><span class="c">  -- certificate password mismatch</span>
        <span class="c">///</span><span class="c">  -- etc</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>protected override bool</b> <a id="463348ba1e5ca175" href="../R/463348ba1e5ca175.html" target="n" data-glyph="75,1" class="i method">IsItemContainer</a>(<b>string</b> <span id="r202 rd" class="r202 r">path</span>)
        {
            <span class="r202 r">path</span> = <a href="#5f3c29f7bd3fa6a7" class="i method">NormalizePath</a>(<span class="r202 r">path</span>);
            <span class="i">Utils</span>.<span class="i">CheckArgForNull</span>(<span class="r202 r">path</span>, <span class="s">&quot;path&quot;</span>);
            <b>bool</b> <span id="r203 rd" class="r203 r">isContainer</span> = <b>false</b>;
 
            <b>if</b> (<span class="r202 r">path</span>.<span class="i">Length</span> == 0)
            {
                <span class="c">//</span>
                <span class="c">// root path is always container</span>
                <span class="c">//</span>
                <span class="r203 r">isContainer</span> = <b>true</b>;
            }
            <b>else</b>
            {
                <span class="c">//</span>
                <span class="c">// We fetch the item to see if it is a container. This is</span>
                <span class="c">// because the managed cert infrastructure does not</span>
                <span class="c">// provide a way to test for existence.</span>
                <span class="c">//</span>
                <a href="#3862cf48fc3ad194" class="i method">GetItemAtPath</a>(<span class="r202 r">path</span>, <b>true</b>, <b>out</b> <span class="r203 r">isContainer</span>);
            }
 
            <a href="#798f0bbd23a8926c" class="i field">s_tracer</a>.<span class="i">WriteLine</span>(<span class="s">&quot;result = {0}&quot;</span>, <span class="r203 r">isContainer</span>);
            <b>return</b> <span class="r203 r">isContainer</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the dynamic parameters for get-item on the Certificate</span>
        <span class="c">///</span><span class="c"> Provider.  We currently support the following dynamic parameters:</span>
        <span class="c">///</span><span class="c"> &quot;CodeSigning,&quot; that returns only certificates good for signing</span>
        <span class="c">///</span><span class="c"> code or scripts.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r204 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If the path was specified on the command line, this is the path</span>
        <span class="c">///</span><span class="c"> to the item for which to get the dynamic parameters.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> An object that has properties and fields decorated with</span>
        <span class="c">///</span><span class="c"> parsing attributes similar to a cmdlet class.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>protected override object</b> <a id="deeddcc32a0f198e" href="../R/deeddcc32a0f198e.html" target="n" data-glyph="75,1" class="i method">GetItemDynamicParameters</a>(<b>string</b> <span id="r204 rd" class="r204 r">path</span>)
        {
            <b>return</b> <b>new</b> <span class="t">CertificateProviderDynamicParameters</span>();
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the dynamic parameters for get-childitem on the Certificate</span>
        <span class="c">///</span><span class="c"> Provider.  We currently only support one dynamic parameter,</span>
        <span class="c">///</span><span class="c"> &quot;CodeSigning,&quot; that returns only certificates good for signing</span>
        <span class="c">///</span><span class="c"> code or scripts.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r205 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If the path was specified on the command line, this is the path</span>
        <span class="c">///</span><span class="c"> to the item for which to get the dynamic parameters.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r206 r">recurse</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Ignored.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> An object that has properties and fields decorated with</span>
        <span class="c">///</span><span class="c"> parsing attributes similar to a cmdlet class.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>protected override object</b> <a id="4f12f5b582be4f70" href="../R/4f12f5b582be4f70.html" target="n" data-glyph="75,1" class="i method">GetChildItemsDynamicParameters</a>(<b>string</b> <span id="r205 rd" class="r205 r">path</span>, <b>bool</b> <span id="r206 rd" class="r206 r">recurse</span>)
        {
            <b>return</b> <b>new</b> <span class="t">CertificateProviderDynamicParameters</span>();
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> DriveCmdletProvider overrides
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> private members
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Helper function to get store-location/store/cert at</span>
        <span class="c">///</span><span class="c"> the specified path.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r207 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Path to the item.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r208 r">recurse</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Whether we need to recursively find all.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r209 r">returnContainers</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Determines if all containers should be returned or only those containers that match the</span>
        <span class="c">///</span><span class="c"> filter(s).</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r210 r">returnNames</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Whether we only need the names.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r211 r">filter</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Filter info.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c"> Does not return a value.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>private void</b> <a id="e26fb0d837ec97b6" href="../R/e26fb0d837ec97b6.html" target="n" data-glyph="76,1" class="i method">GetChildItemsOrNames</a>(
            <b>string</b> <span id="r207 rd" class="r207 r">path</span>,
            <b>bool</b> <span id="r208 rd" class="r208 r">recurse</span>,
            <a href="/System.Management.Automation/A.html#33becc108c70a3e1" class="t t">ReturnContainers</a> <span id="r209 rd" class="r209 r">returnContainers</span>,
            <b>bool</b> <span id="r210 rd" class="r210 r">returnNames</span>,
            <span class="i">CertificateFilterInfo</span> <span id="r211 rd" class="r211 r">filter</span>)
        {
            <b>object</b> <span id="r212 rd" class="r212 r">thingToReturn</span> = <b>null</b>;
            <b>string</b> <span id="r213 rd" class="r213 r">childPath</span> = <b>null</b>;
 
            <b>bool</b> <span id="r214 rd" class="r214 r">returnAllContainers</span> = <span class="r209 r">returnContainers</span> == <a href="/System.Management.Automation/A.html#33becc108c70a3e1" class="t t">ReturnContainers</a>.<a href="/System.Management.Automation/A.html#1b66c2d2e8f051dd" class="i field">ReturnAllContainers</a>;
 
            <span class="i">Utils</span>.<span class="i">CheckArgForNull</span>(<span class="r207 r">path</span>, <span class="s">&quot;path&quot;</span>);
 
            <span class="c">//</span>
            <span class="c">// children at the root path are store locations</span>
            <span class="c">//</span>
            <b>if</b> (<span class="r207 r">path</span>.<span class="i">Length</span> == 0)
            {
                <b>foreach</b> (<a href="#2a4c4cd887b45563" class="t t">X509StoreLocation</a> <span id="r215 rd" class="r215 r">l</span> <b>in</b> <a href="#a61857b26b0f04c8" class="i field">s_storeLocations</a>)
                {
                    <span class="r212 r">thingToReturn</span> = <span class="r210 r">returnNames</span> ?
                        (<b>object</b>)<span class="r215 r">l</span>.<a href="#f24f1cdd50df3fe4" class="i property">LocationName</a> : (<b>object</b>)<span class="r215 r">l</span>;
 
                    <span class="c">// &#39;returnNames&#39; is true only when called from</span>
                    <span class="c">// GetChildNames(), in which case &#39;recurse&#39; will always be</span>
                    <span class="c">// false.  When the -Path parameter needs to be globbed,</span>
                    <span class="c">// the potential location names should be returned by</span>
                    <span class="c">// calling this method from GetChildNames.</span>
 
                    <span class="c">// The original code didn&#39;t have a &quot;|| returnNames&quot; clause.</span>
                    <span class="c">// Suppose the user types:</span>
                    <span class="c">//     dir cert:\curr* -CodeSigningCert -recurse</span>
                    <span class="c">// We need to do path globbing here to resolve wild cards.</span>
                    <span class="c">// Since -CodeSigningCert is present, &#39;filter&#39; is not null.</span>
                    <span class="c">// Since this method is called from GetChildNames() when</span>
                    <span class="c">// doing the path globbing, &#39;returnNames&#39; is true and</span>
                    <span class="c">// &#39;recurse&#39; is false.</span>
                    <span class="c">// In the original code, nothing was returned by</span>
                    <span class="c">// WriteItemObject(), so the path globbing fails and the</span>
                    <span class="c">// above dir command would not display the certificates</span>
                    <span class="c">// as expected.</span>
 
                    <span class="c">// Another case is:</span>
                    <span class="c">//     dir cert:\ -CodeSigningCert -Recurse</span>
                    <span class="c">// -Recurse is present, so we need to call</span>
                    <span class="c">// DoManualGetChildItems, and inside DoManualGetChildItems,</span>
                    <span class="c">// this method will be called to get the names.</span>
                    <span class="c">// The original code had the same problem for this case.</span>
 
                    <span class="c">// With the &quot;|| returnNames&quot; clause, we test if this method</span>
                    <span class="c">// is called from the GetChildNames().  When this method is</span>
                    <span class="c">// called from GetChildNames(), &#39;recurse&#39; will always be</span>
                    <span class="c">// false.  Then we should return the names whether &#39;filter&#39;</span>
                    <span class="c">// is null or not.</span>
 
                    <b>if</b> (<span class="r211 r">filter</span> == <b>null</b> || <span class="r210 r">returnNames</span>)
                    {
                        <span class="i">WriteItemObject</span>(<span class="r212 r">thingToReturn</span>, <span class="r215 r">l</span>.<a href="#f24f1cdd50df3fe4" class="i property">LocationName</a>, <b>true</b>);
                    }
 
                    <span class="r213 r">childPath</span> = <span class="r215 r">l</span>.<a href="#f24f1cdd50df3fe4" class="i property">LocationName</a>;
                    <b>if</b> (<span class="r208 r">recurse</span>)
                    {
                        <a href="#e26fb0d837ec97b6" class="i method">GetChildItemsOrNames</a>(
                                        <span class="r213 r">childPath</span>,
                                        <span class="r208 r">recurse</span>,
                                        <span class="r209 r">returnContainers</span>,
                                        <span class="r210 r">returnNames</span>,
                                        <span class="r211 r">filter</span>);
                    }
                }
            }
            <b>else</b>
            {
                <b>string</b>[] <span id="r216 rd" class="r216 r">pathElements</span> = <a href="#bd050b685321e393" class="i method">GetPathElements</a>(<span class="r207 r">path</span>);
 
                <span class="c">//</span>
                <span class="c">// children at depth 1 are stores</span>
                <span class="c">//</span>
                <b>if</b> (<span class="r216 r">pathElements</span>.<span class="i">Length</span> == 1)
                {
                    <a href="#71192c6127604fee" class="i method">GetStoresOrNames</a>(<span class="r216 r">pathElements</span>[0],
                                     <span class="r208 r">recurse</span>,
                                     <span class="r210 r">returnNames</span>,
                                     <span class="r211 r">filter</span>);
                }
                <span class="c">//</span>
                <span class="c">// children at depth 2 are certificates</span>
                <span class="c">//</span>
                <b>else</b> <b>if</b> (<span class="r216 r">pathElements</span>.<span class="i">Length</span> == 2)
                {
                    <a href="#9cad5eb7fe6fa3d7" class="i method">GetCertificatesOrNames</a>(<span class="r207 r">path</span>,
                                           <span class="r216 r">pathElements</span>,
                                           <span class="r210 r">returnNames</span>,
                                           <span class="r211 r">filter</span>);
                }
                <b>else</b>
                {
                    <a href="#f00d1fe56ddcb477" class="i method">ThrowItemNotFound</a>(<span class="r207 r">path</span>, <a href="#e8d23026f96d84c8" class="t t">CertificateProviderItem</a>.<a href="#82505c9bafd5fc3e" class="i field">Certificate</a>);
                }
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Get the name of the specified certificate.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r217 r">cert</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">Cert name .</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span><span class="c"> we use Thumbprint as the name  </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>private static string</b> <a id="69efff4482164a93" href="../R/69efff4482164a93.html" target="n" data-glyph="76,1" class="i method">GetCertName</a>(<span class="i">X509Certificate2</span> <span id="r217 rd" class="r217 r">cert</span>)
        {
            <b>return</b> <span class="r217 r">cert</span>.<span class="i">Thumbprint</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Get cert objects or their name at the specified path.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r218 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Path to cert.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r219 r">pathElements</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Path elements.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r220 r">returnNames</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Whether we should return only the names (instead of objects).</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r221 r">filter</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Filter info.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">Does not return a value.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>private void</b> <a id="9cad5eb7fe6fa3d7" href="../R/9cad5eb7fe6fa3d7.html" target="n" data-glyph="76,1" class="i method">GetCertificatesOrNames</a>(<b>string</b> <span id="r218 rd" class="r218 r">path</span>,
                                             <b>string</b>[] <span id="r219 rd" class="r219 r">pathElements</span>,
                                             <b>bool</b> <span id="r220 rd" class="r220 r">returnNames</span>,
                                             <span class="i">CertificateFilterInfo</span> <span id="r221 rd" class="r221 r">filter</span>)
        {
            <b>object</b> <span id="r222 rd" class="r222 r">thingToReturn</span> = <b>null</b>;
            <b>string</b> <span id="r223 rd" class="r223 r">certPath</span> = <b>null</b>;
            <a href="#b042c5630701a14b" class="t t">X509NativeStore</a> <span id="r224 rd" class="r224 r">store</span> = <b>null</b>;
 
            <span class="c">//</span>
            <span class="c">// first open the store</span>
            <span class="c">//</span>
 
            <span class="r224 r">store</span> = <a href="#ee129085879c3c23" class="i method">GetStore</a>(<span class="r218 r">path</span>, <b>false</b>, <span class="r219 r">pathElements</span>);
            <span class="r224 r">store</span>.<a href="#d28202dfbc20d0d8" class="i method">Open</a>(<a href="#bd3f5b33f16588d3" class="i method">IncludeArchivedCerts</a>());
 
            <span class="c">//</span>
            <span class="c">// enumerate over each cert and return it (or its name)</span>
            <span class="c">//</span>
            <span class="i">IntPtr</span> <span id="r225 rd" class="r225 r">certContext</span> = <span class="r224 r">store</span>.<a href="#939ecd37de4b527e" class="i method">GetFirstCert</a>();
 
            <b>while</b> (<span class="r225 r">certContext</span> != <span class="i">IntPtr</span>.<span class="i">Zero</span>)
            {
                <span class="i">X509Certificate2</span> <span id="r226 rd" class="r226 r">cert</span> = <b>new</b>(<span class="r225 r">certContext</span>);
 
                <b>if</b> (<a href="#af3d83042e4bfdb4" class="i method">MatchesFilter</a>(<span class="r226 r">cert</span>, <span class="r221 r">filter</span>))
                {
                    <b>string</b> <span id="r227 rd" class="r227 r">certName</span> = <a href="#69efff4482164a93" class="i method">GetCertName</a>(<span class="r226 r">cert</span>);
                    <span class="r223 r">certPath</span> = <span class="i">MakePath</span>(<span class="r218 r">path</span>, <span class="r227 r">certName</span>);
 
                    <b>if</b> (<span class="r220 r">returnNames</span>)
                    {
                        <span class="r222 r">thingToReturn</span> = (<b>object</b>)<span class="r227 r">certName</span>;
                    }
                    <b>else</b>
                    {
                        <a href="/System.Management.Automation/A.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r228 rd" class="r228 r">myPsObj</span> = <b>new</b>(<span class="r226 r">cert</span>);
                        <span class="r222 r">thingToReturn</span> = (<b>object</b>)<span class="r228 r">myPsObj</span>;
                    }
 
                    <span class="i">WriteItemObject</span>(<span class="r222 r">thingToReturn</span>, <span class="r223 r">certPath</span>, <b>false</b>);
                }
 
                <span class="r225 r">certContext</span> = <span class="r224 r">store</span>.<a href="#03be2ed900c1b0c8" class="i method">GetNextCert</a>(<span class="r225 r">certContext</span>);
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Get X509StoreLocation object at path.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r229 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">X509StoreLocation object.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>private</b> <a href="#2a4c4cd887b45563" class="t t">X509StoreLocation</a> <a id="4184c17b6fb03e08" href="../R/4184c17b6fb03e08.html" target="n" data-glyph="76,1" class="i method">GetStoreLocation</a>(<b>string</b> <span id="r229 rd" class="r229 r">path</span>)
        {
            <span class="c">//</span>
            <span class="c">// we store the only two possible store-location</span>
            <span class="c">// objects during ctor.</span>
            <span class="c">//</span>
            <a href="#2a4c4cd887b45563" class="t t">X509StoreLocation</a> <span id="r230 rd" class="r230 r">location</span> =
                <a href="#28f414c57f97eba3" class="i method">GetCachedItem</a>(<span class="r229 r">path</span>) <b>as</b> <a href="#2a4c4cd887b45563" class="t t">X509StoreLocation</a>;
 
            <b>if</b> (<span class="r230 r">location</span> == <b>null</b>)
            {
                <a href="#f00d1fe56ddcb477" class="i method">ThrowItemNotFound</a>(<span class="r229 r">path</span>, <a href="#e8d23026f96d84c8" class="t t">CertificateProviderItem</a>.<a href="#b22e248f66ce18c6" class="i field">StoreLocation</a>);
            }
 
            <b>return</b> <span class="r230 r">location</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Get the X509NativeStore object at path.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r231 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Path to store.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r232 r">test</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">True if this should be a test for path existence. Returns True or False.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r233 r">pathElements</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Path elements.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">X509NativeStore object.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>private</b> <a href="#b042c5630701a14b" class="t t">X509NativeStore</a> <a id="ee129085879c3c23" href="../R/ee129085879c3c23.html" target="n" data-glyph="76,1" class="i method">GetStore</a>(<b>string</b> <span id="r231 rd" class="r231 r">path</span>, <b>bool</b> <span id="r232 rd" class="r232 r">test</span>, <b>string</b>[] <span id="r233 rd" class="r233 r">pathElements</span>)
        {
            <a href="#2a4c4cd887b45563" class="t t">X509StoreLocation</a> <span id="r234 rd" class="r234 r">location</span> = <a href="#4184c17b6fb03e08" class="i method">GetStoreLocation</a>(<span class="r233 r">pathElements</span>[0]);
            <a href="#b042c5630701a14b" class="t t">X509NativeStore</a> <span id="r235 rd" class="r235 r">store</span> = <a href="#80c2ed397e1acfdf" class="i method">GetStore</a>(<span class="r231 r">path</span>, <span class="r233 r">pathElements</span>[1], <span class="r234 r">location</span>);
 
            <b>if</b> (<span class="r235 r">store</span> == <b>null</b>)
            {
                <b>if</b> (<span class="r232 r">test</span>)
                {
                    <b>return</b> <b>null</b>;
                }
                <b>else</b>
                {
                    <a href="#f00d1fe56ddcb477" class="i method">ThrowItemNotFound</a>(<span class="r231 r">path</span>, <a href="#e8d23026f96d84c8" class="t t">CertificateProviderItem</a>.<a href="#8dd368d9b1529869" class="i field">Store</a>);
                }
            }
 
            <b>return</b> <span class="r235 r">store</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the X509NativeStore at the specified path.</span>
        <span class="c">///</span><span class="c"> Adds to cache if not already there.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r236 r">storePath</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Path to the store.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r237 r">storeName</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Name of store (path leaf element).</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r238 r">storeLocation</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Location of store (CurrentUser or LocalMachine).</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">X509NativeStore object.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>private</b> <a href="#b042c5630701a14b" class="t t">X509NativeStore</a> <a id="80c2ed397e1acfdf" href="../R/80c2ed397e1acfdf.html" target="n" data-glyph="76,1" class="i method">GetStore</a>(<b>string</b> <span id="r236 rd" class="r236 r">storePath</span>,
                                   <b>string</b> <span id="r237 rd" class="r237 r">storeName</span>,
                                   <a href="#2a4c4cd887b45563" class="t t">X509StoreLocation</a> <span id="r238 rd" class="r238 r">storeLocation</span>)
        {
            <b>if</b> (!<span class="r238 r">storeLocation</span>.<a href="#f6befc49f6e25116" class="i property">StoreNames</a>.<span class="i">ContainsKey</span>(<span class="r237 r">storeName</span>))
            {
                <a href="#f00d1fe56ddcb477" class="i method">ThrowItemNotFound</a>(<span class="r236 r">storePath</span>, <a href="#e8d23026f96d84c8" class="t t">CertificateProviderItem</a>.<a href="#8dd368d9b1529869" class="i field">Store</a>);
            }
 
            <b>if</b> (<a href="#f7b4721498f564c1" class="i field">s_storeCache</a> != <b>null</b>)
            {
                <b>if</b> (<a href="#f7b4721498f564c1" class="i field">s_storeCache</a>.<a href="#3aa7db610be0ad56" class="i property">Location</a> != <span class="r238 r">storeLocation</span> ||
                    !<b>string</b>.<span class="i">Equals</span>(
                                <a href="#f7b4721498f564c1" class="i field">s_storeCache</a>.<a href="#76acf366fbf24982" class="i property">StoreName</a>,
                                <span class="r237 r">storeName</span>,
                                <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
                {
                    <a href="#f7b4721498f564c1" class="i field">s_storeCache</a> = <b>null</b>;
                }
            }
 
            <b>if</b> (<a href="#f7b4721498f564c1" class="i field">s_storeCache</a> == <b>null</b>)
            {
                <a href="#f7b4721498f564c1" class="i field">s_storeCache</a> = <b>new</b> <a href="#c67b6a7a29e8994a" class="t constructor">X509NativeStore</a>(<span class="r238 r">storeLocation</span>, <span class="r237 r">storeName</span>);
            }
 
            <b>return</b> <a href="#f7b4721498f564c1" class="i field">s_storeCache</a>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets X509NativeStore objects or their name at the specified path.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r239 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Path to the store.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r240 r">recurse</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Recursively return all items if true.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r241 r">returnNames</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r242 r">filter</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Filter info.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c"> Does not return a value.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>private void</b> <a id="71192c6127604fee" href="../R/71192c6127604fee.html" target="n" data-glyph="76,1" class="i method">GetStoresOrNames</a>(
            <b>string</b> <span id="r239 rd" class="r239 r">path</span>,
            <b>bool</b> <span id="r240 rd" class="r240 r">recurse</span>,
            <b>bool</b> <span id="r241 rd" class="r241 r">returnNames</span>,
            <span class="i">CertificateFilterInfo</span> <span id="r242 rd" class="r242 r">filter</span>)
        {
            <b>object</b> <span id="r243 rd" class="r243 r">thingToReturn</span> = <b>null</b>;
 
            <a href="#2a4c4cd887b45563" class="t t">X509StoreLocation</a> <span id="r244 rd" class="r244 r">location</span> = <a href="#4184c17b6fb03e08" class="i method">GetStoreLocation</a>(<span class="r239 r">path</span>);
 
            <b>string</b> <span id="r245 rd" class="r245 r">storePath</span> = <b>null</b>;
 
            <span class="c">//</span>
            <span class="c">// enumerate over each store</span>
            <span class="c">//</span>
            <b>foreach</b> (<b>string</b> <span id="r246 rd" class="r246 r">name</span> <b>in</b> <span class="r244 r">location</span>.<a href="#f6befc49f6e25116" class="i property">StoreNames</a>.<span class="i">Keys</span>)
            {
                <span class="r245 r">storePath</span> = <span class="i">MakePath</span>(<span class="r239 r">path</span>, <span class="r246 r">name</span>);
                <b>if</b> (<span class="r241 r">returnNames</span>)
                {
                    <span class="r243 r">thingToReturn</span> = <span class="r246 r">name</span>;
                }
                <b>else</b>
                {
                    <a href="#b042c5630701a14b" class="t t">X509NativeStore</a> <span id="r247 rd" class="r247 r">store</span> = <a href="#80c2ed397e1acfdf" class="i method">GetStore</a>(<span class="r245 r">storePath</span>, <span class="r246 r">name</span>, <span class="r244 r">location</span>);
                    <span class="i">X509Store</span> <span id="r248 rd" class="r248 r">ManagedStore</span> = <b>new</b>(<span class="r247 r">store</span>.<a href="#76acf366fbf24982" class="i property">StoreName</a>, <span class="r247 r">store</span>.<a href="#3aa7db610be0ad56" class="i property">Location</a>.<a href="#2fcfcb7271252c0c" class="i property">Location</a>);
                    <span class="r243 r">thingToReturn</span> = <span class="r248 r">ManagedStore</span>;
                }
 
                <span class="c">// &#39;returnNames&#39; is true only when called from</span>
                <span class="c">// GetChildNames(), in which case &#39;recurse&#39; will always be</span>
                <span class="c">// false.  When the -Path parameter needs to be globbed,</span>
                <span class="c">// the potential store names should be returned by</span>
                <span class="c">// calling this method from GetChildNames.</span>
 
                <span class="c">// The original code didn&#39;t have a &quot;|| returnNames&quot; clause.</span>
                <span class="c">// Suppose the user types:</span>
                <span class="c">//     dir cert:\CurrentUser\Tru* -CodeSigningCert -recurse</span>
                <span class="c">// We need to do path globbing here to resolve wild cards.</span>
                <span class="c">// Since -CodeSigningCert is present, &#39;filter&#39; is not null.</span>
                <span class="c">// Since this method is called from GetChildNames() when</span>
                <span class="c">// doing the path globbing, &#39;returnNames&#39; is true and</span>
                <span class="c">// &#39;recurse&#39; is false.</span>
                <span class="c">// In the original code, nothing was returned by</span>
                <span class="c">// WriteItemObject(), so the path globbing fails and the</span>
                <span class="c">// above dir command would not display the certificates</span>
                <span class="c">// as expected.</span>
 
                <span class="c">// Another case is:</span>
                <span class="c">//     dir cert:\CurrentUser -CodeSigningCert -Recurse</span>
                <span class="c">// -Recurse is present, so we need to call</span>
                <span class="c">// DoManualGetChildItems, and inside DoManualGetChildItems,</span>
                <span class="c">// this method will be called to get the names.</span>
                <span class="c">// The original code had the same problem for this case.</span>
 
                <span class="c">// With the &quot;|| returnNames&quot; clause, we test if this method</span>
                <span class="c">// is called from the GetChildNames().  When this method is</span>
                <span class="c">// called from GetChildNames(), &#39;recurse&#39; will always be</span>
                <span class="c">// false.  Then we should return the names whether &#39;filter&#39;</span>
                <span class="c">// is null or not.</span>
 
                <b>if</b> (<span class="r242 r">filter</span> == <b>null</b> || <span class="r241 r">returnNames</span>)
                {
                    <span class="i">WriteItemObject</span>(<span class="r243 r">thingToReturn</span>, <span class="r246 r">name</span>, <b>true</b>);
                }
 
                <span class="c">//</span>
                <span class="c">// if recurse is true, get cert objects (or names) as well</span>
                <span class="c">//</span>
                <b>if</b> (<span class="r240 r">recurse</span>)
                {
                    <b>string</b>[] <span id="r249 rd" class="r249 r">pathElements</span> = <a href="#bd050b685321e393" class="i method">GetPathElements</a>(<span class="r245 r">storePath</span>);
                    <a href="#9cad5eb7fe6fa3d7" class="i method">GetCertificatesOrNames</a>(
                                    <span class="r245 r">storePath</span>,
                                    <span class="r249 r">pathElements</span>,
                                    <span class="r241 r">returnNames</span>,
                                    <span class="r242 r">filter</span>);
                }
            }
        }
 
        <b>private</b> <span class="i">CertificateFilterInfo</span> <a id="1fe890fc6cd2c7a7" href="../R/1fe890fc6cd2c7a7.html" target="n" data-glyph="76,1" class="i method">GetFilter</a>()
        {
            <span class="i">CertificateFilterInfo</span> <span id="r250 rd" class="r250 r">filter</span> = <b>null</b>;
 
            <b>if</b> (<a href="/System.Management.Automation/A.html#57d60aa2d2bc908d" class="i property">DynamicParameters</a> != <b>null</b>)
            {
                <a href="#aab93afeaaefc1f3" class="t t">CertificateProviderDynamicParameters</a> <span id="r251 rd" class="r251 r">dp</span> =
                    <a href="/System.Management.Automation/A.html#57d60aa2d2bc908d" class="i property">DynamicParameters</a> <b>as</b> <a href="#aab93afeaaefc1f3" class="t t">CertificateProviderDynamicParameters</a>;
                <b>if</b> (<span class="r251 r">dp</span> != <b>null</b>)
                {
                    <b>if</b> (<span class="r251 r">dp</span>.<a href="#69bb046f9713336b" class="i property">CodeSigningCert</a>)
                    {
                        <span class="r250 r">filter</span> = <b>new</b> <span class="i">CertificateFilterInfo</span>();
                        <span class="r250 r">filter</span>.<span class="i">Purpose</span> = <span class="i">CertificatePurpose</span>.<span class="i">CodeSigning</span>;
                    }
 
                    <b>if</b> (<span class="r251 r">dp</span>.<a href="#10296ef7a5bd3f32" class="i property">DocumentEncryptionCert</a>)
                    {
                        <span class="r250 r">filter</span> ??= <b>new</b> <span class="i">CertificateFilterInfo</span>();
                        <span class="r250 r">filter</span>.<span class="i">Purpose</span> = <span class="i">CertificatePurpose</span>.<span class="i">DocumentEncryption</span>;
                    }
 
                    <b>if</b> (<span class="r251 r">dp</span>.<a href="#b3c941049887c52b" class="i property">DnsName</a> != <b>null</b>)
                    {
                        <span class="r250 r">filter</span> ??= <b>new</b> <span class="i">CertificateFilterInfo</span>();
                        <span class="r250 r">filter</span>.<span class="i">DnsName</span> = <b>new</b> <span class="t">WildcardPattern</span>(<span class="r251 r">dp</span>.<a href="#b3c941049887c52b" class="i property">DnsName</a>, <a href="/System.Management.Automation/A.html#4e788ab2470b3632" class="t t">WildcardOptions</a>.<a href="/System.Management.Automation/A.html#2d0521a6986208d3" class="i field">IgnoreCase</a>);
                    }
 
                    <b>if</b> (<span class="r251 r">dp</span>.<a href="#0fd3793b9e45cabc" class="i property">Eku</a> != <b>null</b>)
                    {
                        <span class="r250 r">filter</span> ??= <b>new</b> <span class="i">CertificateFilterInfo</span>();
                        <span class="r250 r">filter</span>.<span class="i">Eku</span> = <b>new</b> <span class="i">List</span>&lt;<a href="/System.Management.Automation/A.html#d450e739ff28e660" class="t t">WildcardPattern</a>&gt;();
                        <b>foreach</b> (<b>var</b> <span id="r252 rd" class="r252 r">pattern</span> <b>in</b> <span class="r251 r">dp</span>.<a href="#0fd3793b9e45cabc" class="i property">Eku</a>)
                        {
                            <span class="r250 r">filter</span>.<span class="i">Eku</span>.<span class="i">Add</span>(<b>new</b> <span class="t">WildcardPattern</span>(<span class="r252 r">pattern</span>, <a href="/System.Management.Automation/A.html#4e788ab2470b3632" class="t t">WildcardOptions</a>.<a href="/System.Management.Automation/A.html#2d0521a6986208d3" class="i field">IgnoreCase</a>));
                        }
                    }
 
                    <b>if</b> (<span class="r251 r">dp</span>.<a href="#b6020508cb729b41" class="i property">ExpiringInDays</a> &gt;= 0)
                    {
                        <span class="r250 r">filter</span> ??= <b>new</b> <span class="i">CertificateFilterInfo</span>();
                        <span class="r250 r">filter</span>.<span class="i">Expiring</span> = <span class="i">DateTime</span>.<span class="i">Now</span>.<span class="i">AddDays</span>(<span class="r251 r">dp</span>.<a href="#b6020508cb729b41" class="i property">ExpiringInDays</a>);
                    }
 
                    <b>if</b> (<span class="r251 r">dp</span>.<a href="#0e723f22e39be04d" class="i property">SSLServerAuthentication</a>)
                    {
                        <span class="r250 r">filter</span> ??= <b>new</b> <span class="i">CertificateFilterInfo</span>();
                        <span class="r250 r">filter</span>.<span class="i">SSLServerAuthentication</span> = <b>true</b>;
                    }
                }
            }
 
            <b>return</b> <span class="r250 r">filter</span>;
        }
 
        <b>private bool</b> <a id="bd3f5b33f16588d3" href="../R/bd3f5b33f16588d3.html" target="n" data-glyph="76,1" class="i method">IncludeArchivedCerts</a>()
        {
            <b>bool</b> <span id="r253 rd" class="r253 r">includeArchivedCerts</span> = <b>false</b>;
 
            <b>if</b> (<a href="/System.Management.Automation/A.html#e3c4d51f13fbfcaa" class="i property">Force</a>)
            {
                <span class="r253 r">includeArchivedCerts</span> = <b>true</b>;
            }
 
            <b>return</b> <span class="r253 r">includeArchivedCerts</span>;
        }
 
        <b>private static bool</b> <a id="af3d83042e4bfdb4" href="../R/af3d83042e4bfdb4.html" target="n" data-glyph="76,1" class="i method">MatchesFilter</a>(<span class="i">X509Certificate2</span> <span id="r254 rd" class="r254 r">cert</span>, <span class="i">CertificateFilterInfo</span> <span id="r255 rd" class="r255 r">filter</span>)
        {
            <span class="c">// No filter means, match everything</span>
            <b>if</b> (<span class="r255 r">filter</span> == <b>null</b>)
            {
                <b>return</b> <b>true</b>;
            }
 
            <b>if</b> (<span class="r255 r">filter</span>.<span class="i">Expiring</span> &gt; <span class="i">DateTime</span>.<span class="i">MinValue</span> &amp;&amp; !<a href="/System.Management.Automation/A.html#5c234bd2337db61c" class="t t">SecuritySupport</a>.<span class="i">CertExpiresByTime</span>(<span class="r254 r">cert</span>, <span class="r255 r">filter</span>.<span class="i">Expiring</span>))
            {
                <b>return</b> <b>false</b>;
            }
 
            <b>if</b> (<span class="r255 r">filter</span>.<span class="i">DnsName</span> != <b>null</b> &amp;&amp; !<a href="#611d5e5babe9f2f5" class="i method">CertContainsName</a>(<span class="r254 r">cert</span>, <span class="r255 r">filter</span>.<span class="i">DnsName</span>))
            {
                <b>return</b> <b>false</b>;
            }
 
            <b>if</b> (<span class="r255 r">filter</span>.<span class="i">Eku</span> != <b>null</b> &amp;&amp; !<span class="i">CertContainsEku</span>(<span class="r254 r">cert</span>, <span class="r255 r">filter</span>.<span class="i">Eku</span>))
            {
                <b>return</b> <b>false</b>;
            }
 
            <b>if</b> (<span class="r255 r">filter</span>.<span class="i">SSLServerAuthentication</span> &amp;&amp; !<a href="#6393b136749172f9" class="i method">CertIsSSLServerAuthentication</a>(<span class="r254 r">cert</span>))
            {
                <b>return</b> <b>false</b>;
            }
 
            <b>switch</b> (<span class="r255 r">filter</span>.<span class="i">Purpose</span>)
            {
                <b>case</b> <span class="i">CertificatePurpose</span>.<span class="i">CodeSigning</span>:
                    <b>return</b> <a href="/System.Management.Automation/A.html#5c234bd2337db61c" class="t t">SecuritySupport</a>.<span class="i">CertIsGoodForSigning</span>(<span class="r254 r">cert</span>);
 
                <b>case</b> <span class="i">CertificatePurpose</span>.<span class="i">DocumentEncryption</span>:
                    <b>return</b> <a href="/System.Management.Automation/A.html#5c234bd2337db61c" class="t t">SecuritySupport</a>.<span class="i">CertIsGoodForEncryption</span>(<span class="r254 r">cert</span>);
 
                <b>case</b> <span class="i">CertificatePurpose</span>.<span class="i">NotSpecified</span>:
                <b>case</b> <span class="i">CertificatePurpose</span>.<span class="i">All</span>:
                    <b>return</b> <b>true</b>;
 
                <b>default</b>:
                    <b>break</b>;
            }
 
            <b>return</b> <b>false</b>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Check if the specified certificate has the name in DNS name list.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r256 r">cert</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Certificate object.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r257 r">pattern</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Wildcard pattern for DNS name to search.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">True on success, false otherwise.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal static bool</b> <a id="611d5e5babe9f2f5" href="../R/611d5e5babe9f2f5.html" target="n" data-glyph="74,1" class="i method">CertContainsName</a>(<span class="i">X509Certificate2</span> <span id="r256 rd" class="r256 r">cert</span>, <a href="/System.Management.Automation/A.html#d450e739ff28e660" class="t t">WildcardPattern</a> <span id="r257 rd" class="r257 r">pattern</span>)
        {
            <span class="i">List</span>&lt;<a href="#236f3219648f587a" class="t t">DnsNameRepresentation</a>&gt; <span id="r258 rd" class="r258 r">list</span> = (<b>new</b> <a href="#aa73d522318974d6" class="t constructor">DnsNameProperty</a>(<span class="r256 r">cert</span>)).<a href="#f2295cb7a52bb3bb" class="i property">DnsNameList</a>;
            <b>foreach</b> (<a href="#236f3219648f587a" class="t t">DnsNameRepresentation</a> <span id="r259 rd" class="r259 r">dnsName</span> <b>in</b> <span class="r258 r">list</span>)
            {
                <b>if</b> (<span class="r257 r">pattern</span>.<span class="i">IsMatch</span>(<span class="r259 r">dnsName</span>.<a href="#d6667fcc0d378b72" class="i property">Unicode</a>))
                {
                    <b>return</b> <b>true</b>;
                }
            }
 
            <b>return</b> <b>false</b>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Check if the specified certificate is a server authentication certificate.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r260 r">cert</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Certificate object.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">True on success, false otherwise.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal static bool</b> <a id="6393b136749172f9" href="../R/6393b136749172f9.html" target="n" data-glyph="74,1" class="i method">CertIsSSLServerAuthentication</a>(<span class="i">X509Certificate2</span> <span id="r260 rd" class="r260 r">cert</span>)
        {
            <span class="i">X509ExtensionCollection</span> <span id="r261 rd" class="r261 r">extentionList</span> = <span class="r260 r">cert</span>.<span class="i">Extensions</span>;
            <b>foreach</b> (<b>var</b> <span id="r262 rd" class="r262 r">extension</span> <b>in</b> <span class="r261 r">extentionList</span>)
            {
                <b>if</b> (<span class="r262 r">extension</span> <b>is</b> <span class="i">X509EnhancedKeyUsageExtension</span> <span id="r263 rd" class="r263 r">eku</span>)
                {
                    <b>foreach</b> (<span class="i">Oid</span> <span id="r264 rd" class="r264 r">usage</span> <b>in</b> <span class="r263 r">eku</span>.<span class="i">EnhancedKeyUsages</span>)
                    {
                        <b>if</b> (<span class="r264 r">usage</span>.<span class="i">Value</span>.<span class="i">Equals</span>(<span class="i">CertificateFilterInfo</span>.<span class="i">OID_PKIX_KP_SERVER_AUTH</span>, <span class="i">StringComparison</span>.<span class="i">Ordinal</span>))
                        {
                            <b>return</b> <b>true</b>;
                        }
                    }
                }
            }
 
            <b>return</b> <b>false</b>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Check if the specified certificate contains EKU matching all of these patterns.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r265 r">cert</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Certificate object.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r266 r">ekuPatterns</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">EKU patterns.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">True on success, false otherwise.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal static bool</b> <a id="17e1bf2e256d1546" href="../R/../../0000000000.html" target="n" data-glyph="74,1" class="i method">CertContainsEku</a>(<span class="i">X509Certificate2</span> <span id="r265 rd" class="r265 r">cert</span>, <span class="i">List</span>&lt;<a href="/System.Management.Automation/A.html#d450e739ff28e660" class="t t">WildcardPattern</a>&gt; <span id="r266 rd" class="r266 r">ekuPatterns</span>)
        {
            <span class="i">X509ExtensionCollection</span> <span id="r267 rd" class="r267 r">extensionList</span> = <span class="r265 r">cert</span>.<span class="i">Extensions</span>;
            <b>foreach</b> (<b>var</b> <span id="r268 rd" class="r268 r">extension</span> <b>in</b> <span class="r267 r">extensionList</span>)
            {
                <b>if</b> (<span class="r268 r">extension</span> <b>is</b> <span class="i">X509EnhancedKeyUsageExtension</span> <span id="r269 rd" class="r269 r">eku</span>)
                {
                    <span class="i">OidCollection</span> <span id="r270 rd" class="r270 r">enhancedKeyUsages</span> = <span class="r269 r">eku</span>.<span class="i">EnhancedKeyUsages</span>;
                    <b>foreach</b> (<a href="/System.Management.Automation/A.html#d450e739ff28e660" class="t t">WildcardPattern</a> <span id="r271 rd" class="r271 r">ekuPattern</span> <b>in</b> <span class="r266 r">ekuPatterns</span>)
                    {
                        <b>const bool</b> <span id="r272 rd" class="r272 r">patternPassed</span> = <b>false</b>;
                        <b>foreach</b> (<b>var</b> <span id="r273 rd" class="r273 r">usage</span> <b>in</b> <span class="r270 r">enhancedKeyUsages</span>)
                        {
                            <b>if</b> (<span class="r271 r">ekuPattern</span>.<span class="i">IsMatch</span>(<span class="r273 r">usage</span>.<span class="i">Value</span>) || <span class="r271 r">ekuPattern</span>.<span class="i">IsMatch</span>(<span class="r273 r">usage</span>.<span class="i">FriendlyName</span>))
                            {
                                <b>return</b> <b>true</b>;
                            }
                        }
 
                        <b>if</b> (!<span class="r272 r">patternPassed</span>)
                        {
                            <b>return</b> <b>false</b>;
                        }
                    }
 
                    <b>return</b> <b>true</b>;
                }
            }
 
            <b>return</b> <b>false</b>;
        }
 
        <b>private static object</b> <a id="28f414c57f97eba3" href="../R/28f414c57f97eba3.html" target="n" data-glyph="76,1" class="i method">GetCachedItem</a>(<b>string</b> <span id="r274 rd" class="r274 r">path</span>)
        {
            <b>object</b> <span id="r275 rd" class="r275 r">item</span> = <b>null</b>;
 
            <b>lock</b> (<a href="#1233d9342632009e" class="i field">s_staticLock</a>)
            {
                <b>if</b> (<a href="#987ef6b9e1e7929a" class="i field">s_pathCache</a>.<span class="i">ContainsKey</span>(<span class="r274 r">path</span>))
                {
                    <span class="r275 r">item</span> = <a href="#987ef6b9e1e7929a" class="i field">s_pathCache</a>[<span class="r274 r">path</span>];
                    <span class="i n">Dbg</span>.<span class="i">Diagnostics</span>.<span class="i">Assert</span>(<span class="r275 r">item</span> != <b>null</b>, <span class="s">&quot;GetCachedItem&quot;</span>);
                }
            }
 
            <b>return</b> <span class="r275 r">item</span>;
        }
 
        <b>private static void</b> <a id="f97c4c0c40734c86" href="../R/f97c4c0c40734c86.html" target="n" data-glyph="76,1" class="i method">AddItemToCache</a>(<b>string</b> <span id="r276 rd" class="r276 r">path</span>, <b>object</b> <span id="r277 rd" class="r277 r">item</span>)
        {
            <b>lock</b> (<a href="#1233d9342632009e" class="i field">s_staticLock</a>)
            {
                <b>if</b> ((<span class="r277 r">item</span> != <b>null</b>) &amp;&amp; (!<a href="#987ef6b9e1e7929a" class="i field">s_pathCache</a>.<span class="i">ContainsKey</span>(<span class="r276 r">path</span>)))
                {
                    <a href="#987ef6b9e1e7929a" class="i field">s_pathCache</a>.<span class="i">Add</span>(<span class="r276 r">path</span>, <span class="r277 r">item</span>);
                }
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> private members
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> ICmdletProviderSupportsHelp Members
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Get provider-specific help.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r278 r">helpItemName</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Name of help item or cmdlet for which user has requested help</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span> <span class="c">=</span> <span class="c">&quot;</span><span class="r279 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Path to the current location or path to the location of the property that the user needs</span>
        <span class="c">///</span><span class="c"> help about.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Provider specific MAML help content string</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>string</b> <a href="/System.Management.Automation/A.html#3e872a90de02a9b2" class="t t">ICmdletProviderSupportsHelp</a>.<a href="/System.Management.Automation/A.html#bc871a17c337a439" class="i method">GetHelpMaml</a>(<b>string</b> <span id="r278 rd" class="r278 r">helpItemName</span>, <b>string</b> <span id="r279 rd" class="r279 r">path</span>)
        {
            <span class="c">//</span>
            <span class="c">// Get the ver and noun from helpItemName</span>
            <span class="c">//</span>
            <b>string</b> <span id="r280 rd" class="r280 r">verb</span> = <b>null</b>;
            <b>string</b> <span id="r281 rd" class="r281 r">noun</span> = <b>null</b>;
            <b>try</b>
            {
                <b>if</b> (!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r278 r">helpItemName</span>))
                {
                    <a href="/System.Management.Automation/A.html#9492ffc9968f644d" class="t t">CmdletInfo</a>.<span class="i">SplitCmdletName</span>(<span class="r278 r">helpItemName</span>, <b>out</b> <span class="r280 r">verb</span>, <b>out</b> <span class="r281 r">noun</span>);
                }
                <b>else</b>
                {
                    <b>return</b> <b>string</b>.<span class="i">Empty</span>;
                }
 
                <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r280 r">verb</span>) || <b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r281 r">noun</span>))
                {
                    <b>return</b> <b>string</b>.<span class="i">Empty</span>;
                }
 
                <span class="c">//</span>
                <span class="c">// Load the help file from the current UI culture subfolder of the module&#39;s root folder</span>
                <span class="c">//</span>
                <span class="i">XmlDocument</span> <span id="r282 rd" class="r282 r">document</span> = <b>new</b>();
 
                <span class="i">CultureInfo</span> <span id="r283 rd" class="r283 r">currentUICulture</span> = <span class="i">CultureInfo</span>.<span class="i">CurrentUICulture</span>;
 
                <b>string</b> <span id="r284 rd" class="r284 r">fullHelpPath</span> = <span class="i">Path</span>.<span class="i">Combine</span>(
                    <a href="#c2a6f6e8e1dd509a" class="k">this</a>.<a href="/System.Management.Automation/A.html#6129ef83671ead76" class="i property">ProviderInfo</a>.<span class="i">ApplicationBase</span>,
                    <span class="r283 r">currentUICulture</span>.<span class="i">ToString</span>(),
                    <a href="#c2a6f6e8e1dd509a" class="k">this</a>.<a href="/System.Management.Automation/A.html#6129ef83671ead76" class="i property">ProviderInfo</a>.<a href="/System.Management.Automation/A.html#f3d7084f8a70f287" class="i property">HelpFile</a>);
                <span class="i">XmlReaderSettings</span> <span id="r285 rd" class="r285 r">settings</span> = <b>new</b>();
                <span class="r285 r">settings</span>.<span class="i">XmlResolver</span> = <b>null</b>;
                <b>using</b> (<span class="i">XmlReader</span> <span id="r286 rd" class="r286 r">reader</span> = <span class="i">XmlReader</span>.<span class="i">Create</span>(<span class="r284 r">fullHelpPath</span>, <span class="r285 r">settings</span>))
                {
                    <span class="r282 r">document</span>.<span class="i">Load</span>(<span class="r286 r">reader</span>);
                }
 
                <span class="c">// Add &quot;msh&quot; and &quot;command&quot; namespaces from the MAML schema</span>
                <span class="i">XmlNamespaceManager</span> <span id="r287 rd" class="r287 r">nsMgr</span> = <b>new</b>(<span class="r282 r">document</span>.<span class="i">NameTable</span>);
                <span class="r287 r">nsMgr</span>.<span class="i">AddNamespace</span>(<span class="s">&quot;msh&quot;</span>, <span class="i">HelpCommentsParser</span>.<span class="i">mshURI</span>);
                <span class="r287 r">nsMgr</span>.<span class="i">AddNamespace</span>(<span class="s">&quot;command&quot;</span>, <span class="i">HelpCommentsParser</span>.<span class="i">commandURI</span>);
 
                <span class="c">// Compose XPath query to select the appropriate node based on the cmdlet</span>
                <b>string</b> <span id="r288 rd" class="r288 r">xpathQuery</span> = <b>string</b>.<span class="i">Format</span>(
                    <span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>,
                    <span class="i">HelpCommentsParser</span>.<span class="i">ProviderHelpCommandXPath</span>,
                    <b>string</b>.<span class="i">Empty</span>,
                    <span class="r280 r">verb</span>,
                    <span class="r281 r">noun</span>);
 
                <span class="c">// Execute the XPath query and return its MAML snippet</span>
                <span class="i">XmlNode</span> <span id="r289 rd" class="r289 r">result</span> = <span class="r282 r">document</span>.<span class="i">SelectSingleNode</span>(<span class="r288 r">xpathQuery</span>, <span class="r287 r">nsMgr</span>);
                <b>if</b> (<span class="r289 r">result</span> != <b>null</b>)
                {
                    <b>return</b> <span class="r289 r">result</span>.<span class="i">OuterXml</span>;
                }
            }
            <b>catch</b> (<span class="i">XmlException</span>)
            {
                <b>return</b> <b>string</b>.<span class="i">Empty</span>;
            }
            <b>catch</b> (<span class="i">PathTooLongException</span>)
            {
                <b>return</b> <b>string</b>.<span class="i">Empty</span>;
            }
            <b>catch</b> (<span class="i">IOException</span>)
            {
                <b>return</b> <b>string</b>.<span class="i">Empty</span>;
            }
            <b>catch</b> (<span class="i">UnauthorizedAccessException</span>)
            {
                <b>return</b> <b>string</b>.<span class="i">Empty</span>;
            }
            <b>catch</b> (<span class="i">NotSupportedException</span>)
            {
                <b>return</b> <b>string</b>.<span class="i">Empty</span>;
            }
            <b>catch</b> (<span class="i">SecurityException</span>)
            {
                <b>return</b> <b>string</b>.<span class="i">Empty</span>;
            }
            <b>catch</b> (<span class="i">XPathException</span>)
            {
                <b>return</b> <b>string</b>.<span class="i">Empty</span>;
            }
 
            <b>return</b> <b>string</b>.<span class="i">Empty</span>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
    }
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Defines a class to represent a store location in the certificate</span>
    <span class="c">///</span><span class="c"> provider.  The two possible store locations are CurrentUser and</span>
    <span class="c">///</span><span class="c"> LocalMachine.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>public sealed class</b> <a id="2a4c4cd887b45563" href="../R/2a4c4cd887b45563.html" target="n" data-glyph="0,0" class="t t">X509StoreLocation</a>
    {
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the location, as a string.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public string</b> <a id="f24f1cdd50df3fe4" href="../R/f24f1cdd50df3fe4.html" target="n" data-glyph="102,1" class="i property">LocationName</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#afd2d55b8e87094b" class="i field">_location</a>.<span class="i">ToString</span>();
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the location as a</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">System</span>.<span class="i">Security</span>.<span class="i">Cryptography</span>.<span class="i">X509Certificates</span>.<span class="i">StoreLocation</span><span class="c">&quot;</span><span class="c">/&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public</b> <span class="i">StoreLocation</span> <a id="2fcfcb7271252c0c" href="../R/2fcfcb7271252c0c.html" target="n" data-glyph="102,1" class="i property">Location</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#afd2d55b8e87094b" class="i field">_location</a>;
            }
 
            <b>set</b>
            {
                <a href="#afd2d55b8e87094b" class="i field">_location</a> = <b>value</b>;
            }
        }
 
        <b>private</b> <span class="i">StoreLocation</span> <a id="afd2d55b8e87094b" href="../R/afd2d55b8e87094b.html" target="n" data-glyph="46,1" class="i field">_location</a> = <span class="i">StoreLocation</span>.<span class="i">CurrentUser</span>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the list of stores at this location.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public</b> <span class="i">Hashtable</span> <a id="f6befc49f6e25116" href="../R/f6befc49f6e25116.html" target="n" data-glyph="102,1" class="i property">StoreNames</a>
        {
            <b>get</b>
            {
                <span class="i">Hashtable</span> <span id="r290 rd" class="r290 r">storeNames</span>;
                <span class="c">// always try to get new names</span>
                <span class="r290 r">storeNames</span> = <b>new</b> <span class="i">Hashtable</span>(<span class="i">StringComparer</span>.<span class="i">OrdinalIgnoreCase</span>);
 
                <span class="c">// since there is no managed support to obtain store names,</span>
                <span class="c">// we use pinvoke to get it ourselves.</span>
                <span class="i">List</span>&lt;<b>string</b>&gt; <span id="r291 rd" class="r291 r">names</span> = <a href="#d46b08fc3a8e770e" class="t t">Crypt32Helpers</a>.<a href="#d77bcf7a410fb2b8" class="i method">GetStoreNamesAtLocation</a>(<a href="#afd2d55b8e87094b" class="i field">_location</a>);
                <b>foreach</b> (<b>string</b> <span id="r292 rd" class="r292 r">name</span> <b>in</b> <span class="r291 r">names</span>)
                {
                    <span class="r290 r">storeNames</span>.<span class="i">Add</span>(<span class="r292 r">name</span>, <b>true</b>);
                }
 
                <b>return</b> <span class="r290 r">storeNames</span>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Initializes a new instance of the X509StoreLocation class.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public</b> <a id="1f5cf89064b773b6" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="t constructor">X509StoreLocation</a>(<span class="i">StoreLocation</span> <span id="r293 rd" class="r293 r">location</span>)
        {
            <a href="#2fcfcb7271252c0c" class="i property">Location</a> = <span class="r293 r">location</span>;
        }
    }
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Defines the type of EKU string</span>
    <span class="c">///</span><span class="c"> The structure contains friendly name and EKU oid.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Performance&quot;</span>, <span class="s">&quot;CA1815:OverrideEqualsAndOperatorEqualsOnValueTypes&quot;</span>)]
    <b>public readonly struct</b> <a id="4d8318271a7fa709" href="../R/4d8318271a7fa709.html" target="n" data-glyph="108,0" class="t t"><span id="944bac520a2964e3">EnhancedKeyUsageRepresentation</span></a>
    {
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Localized friendly name of EKU.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private readonly string</b> <a id="c3967ed8ba5ab48b" href="../R/c3967ed8ba5ab48b.html" target="n" data-glyph="46,1" class="i field">_friendlyName</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> OID of EKU.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private readonly string</b> <a id="9563ed778ce47d30" href="../R/9563ed778ce47d30.html" target="n" data-glyph="46,1" class="i field">_oid</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Constructor of an EnhancedKeyUsageRepresentation.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Naming&quot;</span>, <span class="s">&quot;CA1704:IdentifiersShouldBeSpelledCorrectly&quot;</span>, <span class="i">MessageId</span> = <span class="s">&quot;Oid&quot;</span>)]
 
        <b>public</b> <a id="5e2e93367ebaa4e2" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="t constructor">EnhancedKeyUsageRepresentation</a>(<b>string</b> <span id="r294 rd" class="r294 r">inputFriendlyName</span>, <b>string</b> <span id="r295 rd" class="r295 r">inputOid</span>)
        {
            <a href="#c3967ed8ba5ab48b" class="i field">_friendlyName</a> = <span class="r294 r">inputFriendlyName</span>;
            <a href="#9563ed778ce47d30" class="i field">_oid</a> = <span class="r295 r">inputOid</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Value comparison.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public bool</b> <a id="d03ce94878eaf9d4" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">Equals</a>(<a href="#4d8318271a7fa709" class="t t">EnhancedKeyUsageRepresentation</a> <span id="r296 rd" class="r296 r">keyUsage</span>)
        {
            <b>bool</b> <span id="r297 rd" class="r297 r">match</span> = <b>false</b>;
 
            <b>if</b> (<a href="#9563ed778ce47d30" class="i field">_oid</a> != <b>null</b> &amp;&amp; <span class="r296 r">keyUsage</span>.<a href="#9563ed778ce47d30" class="i field">_oid</a> != <b>null</b>)
            {
                <span class="c">// OID strings only contain numbers and periods</span>
 
                <b>if</b> (<b>string</b>.<span class="i">Equals</span>(<a href="#9563ed778ce47d30" class="i field">_oid</a>, <span class="r296 r">keyUsage</span>.<a href="#9563ed778ce47d30" class="i field">_oid</a>, <span class="i">StringComparison</span>.<span class="i">Ordinal</span>))
                {
                    <span class="r297 r">match</span> = <b>true</b>;
                }
            }
            <b>else</b> <b>if</b> (<a href="#9563ed778ce47d30" class="i field">_oid</a> == <b>null</b> &amp;&amp; <span class="r296 r">keyUsage</span>.<a href="#9563ed778ce47d30" class="i field">_oid</a> == <b>null</b>)
            {
                <span class="r297 r">match</span> = <b>true</b>;
            }
 
            <b>return</b> <span class="r297 r">match</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Get property of friendlyName.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public string</b> <a id="754cad0ab4badb5a" href="../R/../../0000000000.html" target="n" data-glyph="102,1" class="i property">FriendlyName</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#c3967ed8ba5ab48b" class="i field">_friendlyName</a>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Get property of oid.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public string</b> <a id="df289bee5646b08a" href="../R/../../0000000000.html" target="n" data-glyph="102,1" class="i property">ObjectId</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#9563ed778ce47d30" class="i field">_oid</a>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Get display string.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public override string</b> <a id="925083056b8b204b" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">ToString</a>()
        {
            <b>return</b> <b>string</b>.<span class="i">IsNullOrEmpty</span>(<a href="#c3967ed8ba5ab48b" class="i field">_friendlyName</a>) ?
                        <a href="#9563ed778ce47d30" class="i field">_oid</a> :
                        <a href="#c3967ed8ba5ab48b" class="i field">_friendlyName</a> + <span class="s">&quot; (&quot;</span> + <a href="#9563ed778ce47d30" class="i field">_oid</a> + <span class="s">&quot;)&quot;</span>;
        }
    }
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Class for SendAsTrustedIssuer.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Design&quot;</span>, <span class="s">&quot;CA1053:StaticHolderTypesShouldNotHaveConstructors&quot;</span>)]
    <b>public sealed class</b> <a id="fcbff0dec70d6501" href="../R/../../0000000000.html" target="n" data-glyph="0,0" class="t t"><span id="d1c059e11f786e0d">SendAsTrustedIssuerProperty</span></a>
    {
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Get property of SendAsTrustedIssuer.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Design&quot;</span>, <span class="s">&quot;CA1011:ConsiderPassingBaseTypesAsParameters&quot;</span>)]
        <b>public static bool</b> <a id="54cff11f9bacfbe5" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">ReadSendAsTrustedIssuerProperty</a>(<span class="i">X509Certificate2</span> <span id="r298 rd" class="r298 r">cert</span>)
        {
            <b>bool</b> <span id="r299 rd" class="r299 r">fHasProperty</span> = <b>false</b>;
            <b>if</b> (<a href="#9088e9d56a46b577" class="t t">DownLevelHelper</a>.<a href="#9eec8f559792964d" class="i method">TrustedIssuerSupported</a>())
            {
                <b>int</b> <span id="r300 rd" class="r300 r">propSize</span> = 0;
                <span class="c">// try to get the property</span>
                <span class="c">// it is fine if fail for not there</span>
                <b>if</b> (<span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">CertGetCertificateContextProperty</span>(
                                <span class="r298 r">cert</span>.<span class="i">Handle</span>,
                                <span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">CertPropertyId</span>.<span class="i">CERT_SEND_AS_TRUSTED_ISSUER_PROP_ID</span>,
                                <span class="i">IntPtr</span>.<span class="i">Zero</span>,
                                <b>ref</b> <span class="r300 r">propSize</span>))
                {
                    <span class="c">// we have the property</span>
                    <span class="r299 r">fHasProperty</span> = <b>true</b>;
                }
                <b>else</b>
                {
                    <span class="c">// if fail</span>
                    <b>int</b> <span id="r301 rd" class="r301 r">error</span> = <span class="i">Marshal</span>.<span class="i">GetLastWin32Error</span>();
                    <b>if</b> (<span class="r301 r">error</span> != <span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">CRYPT_E_NOT_FOUND</span>)
                    {
                        <b>throw</b> <b>new</b> <span class="i n">System</span>.<span class="i">ComponentModel</span>.<span class="i">Win32Exception</span>(<span class="r301 r">error</span>);
                    }
                }
            }
 
            <b>return</b> <span class="r299 r">fHasProperty</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Set property of SendAsTrustedIssuer.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Design&quot;</span>, <span class="s">&quot;CA1011:ConsiderPassingBaseTypesAsParameters&quot;</span>)]
        <b>public static void</b> <a id="5ea757c0b8a026c7" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">WriteSendAsTrustedIssuerProperty</a>(<span class="i">X509Certificate2</span> <span id="r302 rd" class="r302 r">cert</span>, <b>string</b> <span id="r303 rd" class="r303 r">certPath</span>, <b>bool</b> <span id="r304 rd" class="r304 r">addProperty</span>)
        {
            <b>if</b> (<a href="#9088e9d56a46b577" class="t t">DownLevelHelper</a>.<a href="#9eec8f559792964d" class="i method">TrustedIssuerSupported</a>())
            {
                <span class="i">IntPtr</span> <span id="r305 rd" class="r305 r">propertyPtr</span> = <span class="i">IntPtr</span>.<span class="i">Zero</span>;
                <span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">CRYPT_DATA_BLOB</span> <span id="r306 rd" class="r306 r">dataBlob</span> = <b>new</b>();
                <span class="r306 r">dataBlob</span>.<span class="i">cbData</span> = 0;
                <span class="r306 r">dataBlob</span>.<span class="i">pbData</span> = <span class="i">IntPtr</span>.<span class="i">Zero</span>;
                <span class="i">X509Certificate</span> <span id="r307 rd" class="r307 r">certFromStore</span> = <b>null</b>;
 
                <b>try</b>
                {
                    <b>if</b> (<span class="r303 r">certPath</span> != <b>null</b>)
                    {
                        <span class="c">// try to open the store and get the cert out</span>
                        <span class="c">// in case the store handle is already released</span>
                        <b>string</b>[] <span id="r308 rd" class="r308 r">pathElements</span> = <a href="#18cd05a9edeca6bd" class="i method">GetPathElements</a>(<span class="r303 r">certPath</span>);
 
                        <span class="c">// certpath is in the format: Microsoft.Powershell.Security\</span>
                        <span class="c">// Certificate::CurrentUser(LocalMachine)\my\HashID</span>
                        <span class="c">// obtained pathElements[0] is Microsoft.Powershell.Security</span>
                        <span class="c">// obtained pathElements[1] is Certificate::CurrentUser</span>
                        <span class="c">// obtained pathElements[2] is MY</span>
                        <span class="c">// obtained pathElements[3] is HashID</span>
 
                        <b>bool</b> <span id="r309 rd" class="r309 r">fUserContext</span> = <b>string</b>.<span class="i">Equals</span>(<span class="r308 r">pathElements</span>[1], <span class="s">&quot;Certificate::CurrentUser&quot;</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>);
 
                        <a href="#2a4c4cd887b45563" class="t t">X509StoreLocation</a> <span id="r310 rd" class="r310 r">storeLocation</span> =
                            <b>new</b>(<span class="r309 r">fUserContext</span> ? <span class="i">StoreLocation</span>.<span class="i">CurrentUser</span> : <span class="i">StoreLocation</span>.<span class="i">LocalMachine</span>);
 
                        <span class="c">// get certificate from the store pathElements[2]</span>
                        <a href="#b042c5630701a14b" class="t t">X509NativeStore</a> <span id="r311 rd" class="r311 r">store</span> = <b>null</b>;
 
                        <span class="r311 r">store</span> = <b>new</b> <a href="#c67b6a7a29e8994a" class="t constructor">X509NativeStore</a>(<span class="r310 r">storeLocation</span>, <span class="r308 r">pathElements</span>[2]);
                        <span class="r311 r">store</span>.<a href="#d28202dfbc20d0d8" class="i method">Open</a>(<b>true</b>); <span class="c">// including archival flag</span>
 
                        <span class="i">IntPtr</span> <span id="r312 rd" class="r312 r">certContext</span> = <span class="r311 r">store</span>.<a href="#d860dfcc81066e57" class="i method">GetCertByName</a>(<span class="r308 r">pathElements</span>[3]);
 
                        <b>if</b> (<span class="r312 r">certContext</span> != <span class="i">IntPtr</span>.<span class="i">Zero</span>)
                        {
                            <span class="r307 r">certFromStore</span> = <b>new</b> <span class="i">X509Certificate2</span>(<span class="r312 r">certContext</span>);
                            <span class="r311 r">store</span>.<a href="#2b44ac4b9e1d3dab" class="i method">FreeCert</a>(<span class="r312 r">certContext</span>);
                        }
                    }
 
                    <b>if</b> (<span class="r304 r">addProperty</span>) <span class="c">// should add the property</span>
                    {
                        <span class="r305 r">propertyPtr</span> = <span class="i">Marshal</span>.<span class="i">AllocHGlobal</span>(<span class="i">Marshal</span>.<span class="i">SizeOf</span>(<span class="r306 r">dataBlob</span>));
                        <span class="i">Marshal</span>.<span class="i">StructureToPtr</span>(<span class="r306 r">dataBlob</span>, <span class="r305 r">propertyPtr</span>, <b>false</b>);
                    }
 
                    <span class="c">// set property</span>
                    <b>if</b> (!<span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">CertSetCertificateContextProperty</span>(
                                <span class="r307 r">certFromStore</span> != <b>null</b> ? <span class="r307 r">certFromStore</span>.<span class="i">Handle</span> : <span class="r302 r">cert</span>.<span class="i">Handle</span>,
                                <span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">CertPropertyId</span>.<span class="i">CERT_SEND_AS_TRUSTED_ISSUER_PROP_ID</span>,
                                0,
                                <span class="r305 r">propertyPtr</span>))
                    {
                        <b>throw</b> <b>new</b> <span class="i n">System</span>.<span class="i">ComponentModel</span>.<span class="i">Win32Exception</span>(<span class="i">Marshal</span>.<span class="i">GetLastWin32Error</span>());
                    }
                }
                <b>finally</b>
                {
                    <b>if</b> (<span class="r305 r">propertyPtr</span> != <span class="i">IntPtr</span>.<span class="i">Zero</span>)
                    {
                        <span class="i">Marshal</span>.<span class="i">FreeHGlobal</span>(<span class="r305 r">propertyPtr</span>);
                    }
                }
            }
            <b>else</b>
            {
                <span class="i">Marshal</span>.<span class="i">ThrowExceptionForHR</span>(<span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">NTE_NOT_SUPPORTED</span>);
            }
        }
 
        <b>private static readonly char</b>[] <a id="609b4a723540e1e0" href="../R/609b4a723540e1e0.html" target="n" data-glyph="46,1" class="i field">s_separators</a> = <b>new</b> <b>char</b>[] { <span class="s">&#39;/&#39;</span>, <span class="s">&#39;\\&#39;</span> };
 
        <b>private static string</b>[] <a id="18cd05a9edeca6bd" href="../R/18cd05a9edeca6bd.html" target="n" data-glyph="76,1" class="i method">GetPathElements</a>(<b>string</b> <span id="r313 rd" class="r313 r">path</span>)
        {
            <b>string</b>[] <span id="r314 rd" class="r314 r">allElts</span> = <span class="r313 r">path</span>.<span class="i">Split</span>(<a href="#609b4a723540e1e0" class="i field">s_separators</a>);
            <b>string</b>[] <span id="r315 rd" class="r315 r">result</span> = <b>null</b>;
 
            <span class="i">Stack</span>&lt;<b>string</b>&gt; <span id="r316 rd" class="r316 r">elts</span> = <b>new</b>();
 
            <b>foreach</b> (<b>string</b> <span id="r317 rd" class="r317 r">e</span> <b>in</b> <span class="r314 r">allElts</span>)
            {
                <b>if</b> ((<span class="r317 r">e</span> == <span class="s">&quot;.&quot;</span>) || (<span class="r317 r">e</span> == <b>string</b>.<span class="i">Empty</span>))
                {
                    <b>continue</b>;
                }
                <b>else</b> <b>if</b> (<span class="r317 r">e</span> == <span class="s">&quot;..&quot;</span>)
                {
                    <b>if</b> (<span class="r316 r">elts</span>.<span class="i">Count</span> &gt; 0)
                    {
                        <span class="r316 r">elts</span>.<span class="i">Pop</span>();
                    }
                }
                <b>else</b>
                {
                    <span class="r316 r">elts</span>.<span class="i">Push</span>(<span class="r317 r">e</span>);
                }
            }
 
            <span class="r315 r">result</span> = <span class="r316 r">elts</span>.<span class="i">ToArray</span>();
            <span class="i">Array</span>.<span class="i">Reverse</span>(<span class="r315 r">result</span>);
 
            <b>return</b> <span class="r315 r">result</span>;
        }
    }
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Class for ekulist.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>public sealed class</b> <a id="0ac4f843205d3335" href="../R/../../0000000000.html" target="n" data-glyph="0,0" class="t t">EnhancedKeyUsageProperty</a>
    {
        <b>private readonly</b> <span class="i">List</span>&lt;<a href="#4d8318271a7fa709" class="t t">EnhancedKeyUsageRepresentation</a>&gt; <a id="b1aad51650eb39ac" href="../R/b1aad51650eb39ac.html" target="n" data-glyph="46,1" class="i field">_ekuList</a> = <b>new</b>();
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Get property of EKUList.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public</b> <span class="i">List</span>&lt;<a href="#4d8318271a7fa709" class="t t">EnhancedKeyUsageRepresentation</a>&gt; <a id="83b034de85898871" href="../R/../../0000000000.html" target="n" data-glyph="102,1" class="i property">EnhancedKeyUsageList</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#b1aad51650eb39ac" class="i field">_ekuList</a>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Constructor for EnhancedKeyUsageProperty.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public</b> <a id="52f7398d32400137" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="t constructor">EnhancedKeyUsageProperty</a>(<span class="i">X509Certificate2</span> <span id="r318 rd" class="r318 r">cert</span>)
        {
            <b>foreach</b> (<span class="i">X509Extension</span> <span id="r319 rd" class="r319 r">extension</span> <b>in</b> <span class="r318 r">cert</span>.<span class="i">Extensions</span>)
            {
                <span class="c">// Filter to the OID for EKU</span>
                <b>if</b> (<span class="r319 r">extension</span>.<span class="i">Oid</span>.<span class="i">Value</span> == <span class="s">&quot;2.5.29.37&quot;</span>)
                {
                    <span class="i">X509EnhancedKeyUsageExtension</span> <span id="r320 rd" class="r320 r">ext</span> = <span class="r319 r">extension</span> <b>as</b> <span class="i">X509EnhancedKeyUsageExtension</span>;
                    <b>if</b> (<span class="r320 r">ext</span> != <b>null</b>)
                    {
                        <span class="i">OidCollection</span> <span id="r321 rd" class="r321 r">oids</span> = <span class="r320 r">ext</span>.<span class="i">EnhancedKeyUsages</span>;
                        <b>foreach</b> (<span class="i">Oid</span> <span id="r322 rd" class="r322 r">oid</span> <b>in</b> <span class="r321 r">oids</span>)
                        {
                            <a href="#4d8318271a7fa709" class="t t">EnhancedKeyUsageRepresentation</a> <span id="r323 rd" class="r323 r">ekuString</span> = <b>new</b>(<span class="r322 r">oid</span>.<span class="i">FriendlyName</span>, <span class="r322 r">oid</span>.<span class="i">Value</span>);
                            <a href="#b1aad51650eb39ac" class="i field">_ekuList</a>.<span class="i">Add</span>(<span class="r323 r">ekuString</span>);
                        }
                    }
                }
            }
        }
    }
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Class for DNSNameList.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>public sealed class</b> <a id="546a623302eab652" href="../R/546a623302eab652.html" target="n" data-glyph="0,0" class="t t">DnsNameProperty</a>
    {
        <b>private readonly</b> <span class="i">List</span>&lt;<a href="#236f3219648f587a" class="t t">DnsNameRepresentation</a>&gt; <a id="033855ad844ee4bc" href="../R/033855ad844ee4bc.html" target="n" data-glyph="46,1" class="i field">_dnsList</a> = <b>new</b>();
        <b>private readonly</b> <span class="i n">System</span>.<span class="i">Globalization</span>.<span class="i">IdnMapping</span> <a id="63611ea76353ce62" href="../R/63611ea76353ce62.html" target="n" data-glyph="46,1" class="i field">idnMapping</a> = <b>new</b>();
 
        <b>private const string</b> <a id="d0e7f4f8c09051a6" href="../R/d0e7f4f8c09051a6.html" target="n" data-glyph="10,1" class="i field">dnsNamePrefix</a> = <span class="s">&quot;DNS Name=&quot;</span>;
        <b>private const string</b> <a id="151db39d4f3ff7e3" href="../R/151db39d4f3ff7e3.html" target="n" data-glyph="10,1" class="i field">distinguishedNamePrefix</a> = <span class="s">&quot;CN=&quot;</span>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Get property of DnsNameList.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public</b> <span class="i">List</span>&lt;<a href="#236f3219648f587a" class="t t">DnsNameRepresentation</a>&gt; <a id="f2295cb7a52bb3bb" href="../R/f2295cb7a52bb3bb.html" target="n" data-glyph="102,1" class="i property">DnsNameList</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#033855ad844ee4bc" class="i field">_dnsList</a>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Constructor for DnsNameProperty.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public</b> <a id="aa73d522318974d6" href="../R/aa73d522318974d6.html" target="n" data-glyph="72,1" class="t constructor">DnsNameProperty</a>(<span class="i">X509Certificate2</span> <span id="r324 rd" class="r324 r">cert</span>)
        {
            <b>string</b> <span id="r325 rd" class="r325 r">name</span>;
            <b>string</b> <span id="r326 rd" class="r326 r">unicodeName</span>;
            <a href="#236f3219648f587a" class="t t">DnsNameRepresentation</a> <span id="r327 rd" class="r327 r">dnsName</span>;
            <a href="#033855ad844ee4bc" class="i field">_dnsList</a> = <b>new</b> <span class="i">List</span>&lt;<a href="#236f3219648f587a" class="t t">DnsNameRepresentation</a>&gt;();
 
            <span class="c">// extract DNS name from subject distinguish name</span>
            <span class="c">// if it exists and does not contain a comma</span>
            <span class="c">// a comma, indicates it is not a DNS name</span>
            <b>if</b> (<span class="r324 r">cert</span>.<span class="i">Subject</span>.<span class="i">StartsWith</span>(<a href="#151db39d4f3ff7e3" class="i field">distinguishedNamePrefix</a>, <span class="i n">System</span>.<span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>) &amp;&amp;
                !<span class="r324 r">cert</span>.<span class="i">Subject</span>.<span class="i">Contains</span>(<span class="s">&#39;,&#39;</span>))
            {
                <span class="r325 r">name</span> = <span class="r324 r">cert</span>.<span class="i">Subject</span>.<span class="i">Substring</span>(<a href="#151db39d4f3ff7e3" class="i field">distinguishedNamePrefix</a>.<span class="i">Length</span>);
                <b>try</b>
                {
                    <span class="r326 r">unicodeName</span> = <a href="#63611ea76353ce62" class="i field">idnMapping</a>.<span class="i">GetUnicode</span>(<span class="r325 r">name</span>);
                }
                <b>catch</b> (<span class="i n">System</span>.<span class="i">ArgumentException</span>)
                {
                    <span class="c">// The name is not valid punyCode, assume it&#39;s valid ascii.</span>
                    <span class="r326 r">unicodeName</span> = <span class="r325 r">name</span>;
                }
 
                <span class="r327 r">dnsName</span> = <b>new</b> <a href="#5385a51da0d64684" class="t constructor">DnsNameRepresentation</a>(<span class="r325 r">name</span>, <span class="r326 r">unicodeName</span>);
                <a href="#033855ad844ee4bc" class="i field">_dnsList</a>.<span class="i">Add</span>(<span class="r327 r">dnsName</span>);
            }
 
            <b>foreach</b> (<span class="i">X509Extension</span> <span id="r328 rd" class="r328 r">extension</span> <b>in</b> <span class="r324 r">cert</span>.<span class="i">Extensions</span>)
            {
                <span class="c">// Filter to the OID for Subject Alternative Name</span>
                <b>if</b> (<span class="r328 r">extension</span>.<span class="i">Oid</span>.<span class="i">Value</span> == <span class="s">&quot;2.5.29.17&quot;</span>)
                {
                    <b>string</b>[] <span id="r329 rd" class="r329 r">names</span> = <span class="r328 r">extension</span>.<span class="i">Format</span>(<b>true</b>).<span class="i">Split</span>(<span class="i">Environment</span>.<span class="i">NewLine</span>);
                    <b>foreach</b> (<b>string</b> <span id="r330 rd" class="r330 r">nameLine</span> <b>in</b> <span class="r329 r">names</span>)
                    {
                        <span class="c">// Get the part after &#39;DNS Name=&#39;</span>
                        <b>if</b> (<span class="r330 r">nameLine</span>.<span class="i">StartsWith</span>(<a href="#d0e7f4f8c09051a6" class="i field">dnsNamePrefix</a>, <span class="i n">System</span>.<span class="i">StringComparison</span>.<span class="i">InvariantCultureIgnoreCase</span>))
                        {
                            <span class="r325 r">name</span> = <span class="r330 r">nameLine</span>.<span class="i">Substring</span>(<a href="#d0e7f4f8c09051a6" class="i field">dnsNamePrefix</a>.<span class="i">Length</span>);
                            <b>try</b>
                            {
                                <span class="r326 r">unicodeName</span> = <a href="#63611ea76353ce62" class="i field">idnMapping</a>.<span class="i">GetUnicode</span>(<span class="r325 r">name</span>);
                            }
                            <b>catch</b> (<span class="i n">System</span>.<span class="i">ArgumentException</span>)
                            {
                                <span class="c">// The name is not valid punyCode, assume it&#39;s valid ascii.</span>
                                <span class="r326 r">unicodeName</span> = <span class="r325 r">name</span>;
                            }
 
                            <span class="r327 r">dnsName</span> = <b>new</b> <a href="#5385a51da0d64684" class="t constructor">DnsNameRepresentation</a>(<span class="r325 r">name</span>, <span class="r326 r">unicodeName</span>);
 
                            <span class="c">// Only add the name if it is not the same as an existing name.</span>
                            <b>if</b> (!<a href="#033855ad844ee4bc" class="i field">_dnsList</a>.<span class="i">Contains</span>(<span class="r327 r">dnsName</span>))
                            {
                                <a href="#033855ad844ee4bc" class="i field">_dnsList</a>.<span class="i">Add</span>(<span class="r327 r">dnsName</span>);
                            }
                        }
                    }
                }
            }
        }
    }
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Downlevel helper function to determine if the OS is WIN8 and above.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>internal static class</b> <a id="9088e9d56a46b577" href="../R/9088e9d56a46b577.html" target="n" data-glyph="2,0" class="t t">DownLevelHelper</a>
    {
        <b>private static bool</b> <a id="563a963e13290174" href="../R/563a963e13290174.html" target="n" data-glyph="46,1" class="i field">s_isWin8Set</a> = <b>false</b>;
        <b>private static bool</b> <a id="0a5a8f1bcaae4769" href="../R/0a5a8f1bcaae4769.html" target="n" data-glyph="46,1" class="i field">s_isWin8</a> = <b>false</b>;
 
        <b>internal static bool</b> <a id="f7281b68fbd9aaff" href="../R/f7281b68fbd9aaff.html" target="n" data-glyph="74,1" class="i method">IsWin8AndAbove</a>()
        {
            <b>if</b> (!<a href="#563a963e13290174" class="i field">s_isWin8Set</a>)
            {
                <span class="i n">System</span>.<span class="i">OperatingSystem</span> <span id="r331 rd" class="r331 r">osInfo</span> = <span class="i n">System</span>.<span class="i">Environment</span>.<span class="i">OSVersion</span>;
                <span class="i">PlatformID</span> <span id="r332 rd" class="r332 r">platform</span> = <span class="r331 r">osInfo</span>.<span class="i">Platform</span>;
                <span class="i">Version</span> <span id="r333 rd" class="r333 r">version</span> = <span class="r331 r">osInfo</span>.<span class="i">Version</span>;
 
                <b>if</b> (<span class="r332 r">platform</span>.<span class="i">Equals</span>(<span class="i">PlatformID</span>.<span class="i">Win32NT</span>) &amp;&amp;
                    ((<span class="r333 r">version</span>.<span class="i">Major</span> &gt; 6) ||
                     (<span class="r333 r">version</span>.<span class="i">Major</span> == 6 &amp;&amp; <span class="r333 r">version</span>.<span class="i">Minor</span> &gt;= 2)))
                {
                    <a href="#0a5a8f1bcaae4769" class="i field">s_isWin8</a> = <b>true</b>;
                }
 
                <a href="#563a963e13290174" class="i field">s_isWin8Set</a> = <b>true</b>;
            }
 
            <b>return</b> <a href="#0a5a8f1bcaae4769" class="i field">s_isWin8</a>;
        }
 
        <b>internal static bool</b> <a id="9eec8f559792964d" href="../R/9eec8f559792964d.html" target="n" data-glyph="74,1" class="i method">TrustedIssuerSupported</a>()
        {
            <b>return</b> <a href="#f7281b68fbd9aaff" class="i method">IsWin8AndAbove</a>();
        }
 
        <b>internal static bool</b> <a id="47230082ac4ade07" href="../R/47230082ac4ade07.html" target="n" data-glyph="74,1" class="i method">HashLookupSupported</a>()
        {
            <b>return</b> <a href="#f7281b68fbd9aaff" class="i method">IsWin8AndAbove</a>();
        }
    }
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Check in UI is allowed.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>internal static class</b> <a id="dd6ef8c0fee00482" href="../R/dd6ef8c0fee00482.html" target="n" data-glyph="2,0" class="t t">DetectUIHelper</a>
    {
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">CORECLR</span>
        <b>internal static</b> <span class="i">IntPtr</span> <a id="03db50bb826c2f66" href="../R/03db50bb826c2f66.html" target="n" data-glyph="74,1" class="i method">GetOwnerWindow</a>(<a href="/System.Management.Automation/A.html#7b79cd90e035740e" class="t t">PSHost</a> <span id="r334 rd" class="r334 r">host</span>)
        {
            <b>return</b> <span class="i">IntPtr</span>.<span class="i">Zero</span>;
        }
<span class="k preprocess">#</span><span class="k preprocess">else</span>
<span class="e">        [SuppressMessage(&quot;Microsoft.Reliability&quot;, &quot;CA2006:UseSafeHandleToEncapsulateNativeResources&quot;)]
        private static IntPtr hWnd = IntPtr.Zero;
        private static bool firstRun = true;
 
        internal static IntPtr GetOwnerWindow(PSHost host)
        {
            if (firstRun)
            {
                firstRun = false;
 
                if (IsUIAllowed(host))
                {
                    hWnd = System.Diagnostics.Process.GetCurrentProcess().MainWindowHandle;
 
                    if (hWnd == IntPtr.Zero)
                    {
                        hWnd = Security.NativeMethods.GetConsoleWindow();
                    }
 
                    if (hWnd == IntPtr.Zero)
                    {
                        hWnd = Security.NativeMethods.GetDesktopWindow();
                    }
                }
            }
 
            return hWnd;
        }
 
        private static bool IsUIAllowed(PSHost host)
        {
            if (host.Name.Equals(&quot;ServerRemoteHost&quot;, StringComparison.OrdinalIgnoreCase))
                return false;
 
            uint SessionId;
            uint ProcessId = (uint)System.Diagnostics.Process.GetCurrentProcess().Id;
            if (!Security.NativeMethods.ProcessIdToSessionId(ProcessId, out SessionId))
                return false;
 
            if (SessionId == 0)
                return false;
 
            if (!Environment.UserInteractive)
                return false;
 
            string[] args = Environment.GetCommandLineArgs();
 
            bool fRet = true;
            foreach (string arg in args)
            {
                const string NonInteractiveParamName = &quot;-noninteractive&quot;;
                if (arg.Length &gt;= 4 &amp;&amp; NonInteractiveParamName.StartsWith(arg, StringComparison.OrdinalIgnoreCase))
                {
                    fRet = false;
                    break;
                }
            }
 
            return fRet;
        }
</span><span class="k preprocess">#</span><span class="k preprocess">endif</span>
    }
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Container for helper functions that use pinvoke into crypt32.dll.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>internal static class</b> <a id="d46b08fc3a8e770e" href="../R/d46b08fc3a8e770e.html" target="n" data-glyph="2,0" class="t t">Crypt32Helpers</a>
    {
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Lock that guards access to the following static members</span>
        <span class="c">///</span><span class="c"> -- storeNames.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private static readonly object</b> <a id="de0520bbe7f897c1" href="../R/de0520bbe7f897c1.html" target="n" data-glyph="46,1" class="i field">s_staticLock</a> = <b>new</b>();
 
        <b>internal static readonly</b> <span class="i">List</span>&lt;<b>string</b>&gt; <a id="d825ddfee6965143" href="../R/d825ddfee6965143.html" target="n" data-glyph="44,1" class="i field">storeNames</a> = <b>new</b>();
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Get a list of store names at the specified location.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">ArchitectureSensitive</span>]
        <b>internal static</b> <span class="i">List</span>&lt;<b>string</b>&gt; <a id="d77bcf7a410fb2b8" href="../R/d77bcf7a410fb2b8.html" target="n" data-glyph="74,1" class="i method">GetStoreNamesAtLocation</a>(<span class="i">StoreLocation</span> <span id="r335 rd" class="r335 r">location</span>)
        {
            <span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">CertStoreFlags</span> <span id="r336 rd" class="r336 r">locationFlag</span> =
                <span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">CertStoreFlags</span>.<span class="i">CERT_SYSTEM_STORE_CURRENT_USER</span>;
 
            <b>switch</b> (<span class="r335 r">location</span>)
            {
                <b>case</b> <span class="i">StoreLocation</span>.<span class="i">CurrentUser</span>:
                    <span class="r336 r">locationFlag</span> = <span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">CertStoreFlags</span>.<span class="i">CERT_SYSTEM_STORE_CURRENT_USER</span>;
                    <b>break</b>;
 
                <b>case</b> <span class="i">StoreLocation</span>.<span class="i">LocalMachine</span>:
                    <span class="r336 r">locationFlag</span> = <span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">CertStoreFlags</span>.<span class="i">CERT_SYSTEM_STORE_LOCAL_MACHINE</span>;
                    <b>break</b>;
 
                <b>default</b>:
                    <span class="i">Diagnostics</span>.<span class="i">Assert</span>(<b>false</b>, <span class="s">&quot;GetStoreNamesAtLocation: invalid location value&quot;</span>);
                    <b>break</b>;
            }
 
            <span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">CertEnumSystemStoreCallBackProto</span> <span id="r337 rd" class="r337 r">callBack</span> = <b>new</b>(<span class="i">CertEnumSystemStoreCallBack</span>);
 
            <span class="c">// Return a new list to avoid synchronization issues.</span>
 
            <span class="i">List</span>&lt;<b>string</b>&gt; <span id="r338 rd" class="r338 r">names</span> = <b>new</b>();
            <b>lock</b> (<a href="#de0520bbe7f897c1" class="i field">s_staticLock</a>)
            {
                <a href="#d825ddfee6965143" class="i field">storeNames</a>.<span class="i">Clear</span>();
 
                <span class="i n">Security</span>.<span class="i">NativeMethods</span>.<span class="i">CertEnumSystemStore</span>(<span class="r336 r">locationFlag</span>, <span class="i">IntPtr</span>.<span class="i">Zero</span>,
                                                  <span class="i">IntPtr</span>.<span class="i">Zero</span>, <span class="r337 r">callBack</span>);
                <b>foreach</b> (<b>string</b> <span id="r339 rd" class="r339 r">name</span> <b>in</b> <a href="#d825ddfee6965143" class="i field">storeNames</a>)
                {
                    <span class="r338 r">names</span>.<span class="i">Add</span>(<span class="r339 r">name</span>);
                }
            }
 
            <b>return</b> <span class="r338 r">names</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Call back function used by CertEnumSystemStore</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> Currently, there is no managed support for enumerating store</span>
        <span class="c">///</span><span class="c"> names on a machine. We use the win32 function CertEnumSystemStore()</span>
        <span class="c">///</span><span class="c"> to get a list of stores for a given context.</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> Each time this callback is called, we add the passed store name</span>
        <span class="c">///</span><span class="c"> to the list of stores.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal static bool</b> <a id="edd9f657e7d8a724" href="../R/../../0000000000.html" target="n" data-glyph="74,1" class="i method">CertEnumSystemStoreCallBack</a>(<b>string</b> <span id="r340 rd" class="r340 r">storeName</span>,
                                                          <span class="i">DWORD</span> <span id="r341 rd" class="r341 r">dwFlagsNotUsed</span>,
                                                          <span class="i">IntPtr</span> <span id="r342 rd" class="r342 r">notUsed1</span>,
                                                          <span class="i">IntPtr</span> <span id="r343 rd" class="r343 r">notUsed2</span>,
                                                          <span class="i">IntPtr</span> <span id="r344 rd" class="r344 r">notUsed3</span>)
        {
            <a href="#d825ddfee6965143" class="i field">storeNames</a>.<span class="i">Add</span>(<span class="r340 r">storeName</span>);
            <b>return</b> <b>true</b>;
        }
    }
}
<span class="k preprocess">#</span><span class="k preprocess">endif</span> <span class="c">// !UNIX</span>
</pre></td></tr></table></div></body></html>
