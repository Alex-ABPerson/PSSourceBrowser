<!DOCTYPE html>
<html><head><title>AclCommands.cs</title><link rel="stylesheet" href="../../styles.css"><script src="../../scripts.js"></script></head>
<body class="cB" onload="i(1569);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#Microsoft.PowerShell.Security/security/AclCommands.cs" target="_top">security\AclCommands.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#Microsoft.PowerShell.Security" target="_top">src\Microsoft.PowerShell.Security\Microsoft.PowerShell.Security.csproj</a> (Microsoft.PowerShell.Security)</td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation.</span>
<span class="c">// Licensed under the MIT License.</span>
 
<span class="k preprocess">#</span><span class="k preprocess">pragma</span> <span class="k preprocess">warning</span> <span class="k preprocess">disable</span> 1634, 1691
<span class="k preprocess">#</span><span class="k preprocess">pragma</span> <span class="k preprocess">warning</span> <span class="k preprocess">disable</span> 56506
 
<b>using</b> <span class="i n">System</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Collections</span>.<span class="i">Generic</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Collections</span>.<span class="i">ObjectModel</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">ComponentModel</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Diagnostics</span>.<span class="i">CodeAnalysis</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Globalization</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Security</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Runtime</span>.<span class="i">InteropServices</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Security</span>.<span class="i">AccessControl</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Security</span>.<span class="i">Principal</span>;
 
<b>using</b> <span class="i">Dbg</span> = <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>;
 
<b>namespace</b> <span class="i n">Microsoft</span>.<span class="i n">PowerShell</span>.<span class="i n">Commands</span>
{
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Defines the base class from which all Security Descriptor commands</span>
    <span class="c">///</span><span class="c"> are derived.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>public abstract class</b> <a id="310a1f126fc0ee1a" href="../R/310a1f126fc0ee1a.html" target="n" data-glyph="0,0" class="t t"><span id="ffe9420ba3227337">SecurityDescriptorCommandsBase</span></a> : <a href="/System.Management.Automation/A.html#30543a6971fed1fc" class="t t">PSCmdlet</a>
    {
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets or sets the filter property.  The filter</span>
        <span class="c">///</span><span class="c"> property allows for provider-specific filtering of results.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>]
        <b>public string</b> <a id="430ab72a17bf22ca" href="../R/430ab72a17bf22ca.html" target="n" data-glyph="102,1" class="i property">Filter</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#a5b7cb72f6485388" class="i field">_filter</a>;
            }
 
            <b>set</b>
            {
                <a href="#a5b7cb72f6485388" class="i field">_filter</a> = <b>value</b>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets or sets the include property.  The include property</span>
        <span class="c">///</span><span class="c"> specifies the items on which the command will act.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>]
        <b>public string</b>[] <a id="7ab5f5327a290b79" href="../R/7ab5f5327a290b79.html" target="n" data-glyph="102,1" class="i property">Include</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#1ea0ae17d0685c26" class="i field">_include</a>;
            }
 
            <b>set</b>
            {
                <a href="#1ea0ae17d0685c26" class="i field">_include</a> = <b>value</b>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets or sets the exclude property.  The exclude property</span>
        <span class="c">///</span><span class="c"> specifies the items on which the command will not act.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>]
        <b>public string</b>[] <a id="f45d1ffa17ab97cc" href="../R/f45d1ffa17ab97cc.html" target="n" data-glyph="102,1" class="i property">Exclude</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#1a838cdf9f08e0e7" class="i field">_exclude</a>;
            }
 
            <b>set</b>
            {
                <a href="#1a838cdf9f08e0e7" class="i field">_exclude</a> = <b>value</b>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The context for the command that is passed to the core command providers.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal</b> <span class="i">CmdletProviderContext</span> <a id="678521eeda8094cc" href="../R/678521eeda8094cc.html" target="n" data-glyph="104,1" class="i property">CmdletProviderContext</a>
        {
            <b>get</b>
            {
                <span class="i">CmdletProviderContext</span> <span id="r0 rd" class="r0 r">coreCommandContext</span> = <b>new</b>(<a href="#310a1f126fc0ee1a" class="k">this</a>);
 
                <span class="i">Collection</span>&lt;<b>string</b>&gt; <span id="r1 rd" class="r1 r">includeFilter</span> =
                    <span class="i">SessionStateUtilities</span>.<span class="i">ConvertArrayToCollection</span>&lt;<b>string</b>&gt;(<a href="#7ab5f5327a290b79" class="i property">Include</a>);
 
                <span class="i">Collection</span>&lt;<b>string</b>&gt; <span id="r2 rd" class="r2 r">excludeFilter</span> =
                    <span class="i">SessionStateUtilities</span>.<span class="i">ConvertArrayToCollection</span>&lt;<b>string</b>&gt;(<a href="#f45d1ffa17ab97cc" class="i property">Exclude</a>);
 
                <span class="r0 r">coreCommandContext</span>.<span class="i">SetFilters</span>(<span class="r1 r">includeFilter</span>,
                                              <span class="r2 r">excludeFilter</span>,
                                              <a href="#430ab72a17bf22ca" class="i property">Filter</a>);
 
                <b>return</b> <span class="r0 r">coreCommandContext</span>;
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> brokered properties
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Add brokered properties for easy access to important properties</span>
        <span class="c">///</span><span class="c"> of security descriptor.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal static void</b> <a id="c96bba155ed550c0" href="../R/c96bba155ed550c0.html" target="n" data-glyph="74,1" class="i method">AddBrokeredProperties</a>(
            <span class="i">Collection</span>&lt;<a href="/System.Management.Automation/A.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt; <span id="r3 rd" class="r3 r">results</span>,
            <b>bool</b> <span id="r4 rd" class="r4 r">audit</span>,
            <b>bool</b> <span id="r5 rd" class="r5 r">allCentralAccessPolicies</span>)
        {
            <b>foreach</b> (<a href="/System.Management.Automation/A.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r6 rd" class="r6 r">result</span> <b>in</b> <span class="r3 r">results</span>)
            {
                <b>if</b> (<span class="r4 r">audit</span>)
                {
                    <span class="c">// Audit</span>
                    <span class="r6 r">result</span>.<a href="/System.Management.Automation/A.html#59e9cd1ad57ccd34" class="i property">Properties</a>.<span class="i">Add</span>
                    (
                        <b>new</b> <span class="t">PSCodeProperty</span>
                            (
                                <span class="s">&quot;Audit&quot;</span>,
                                <b>typeof</b>(<a href="#310a1f126fc0ee1a" class="t t">SecurityDescriptorCommandsBase</a>).<span class="i">GetMethod</span>(<span class="s">&quot;GetAudit&quot;</span>)
                            )
                    );
                }
                <span class="c">// CentralAccessPolicyId retrieval does not require elevation, so we always add this property.</span>
                <span class="r6 r">result</span>.<a href="/System.Management.Automation/A.html#59e9cd1ad57ccd34" class="i property">Properties</a>.<span class="i">Add</span>
                (
                    <b>new</b> <span class="t">PSCodeProperty</span>
                        (
                            <span class="s">&quot;CentralAccessPolicyId&quot;</span>,
                            <b>typeof</b>(<a href="#310a1f126fc0ee1a" class="t t">SecurityDescriptorCommandsBase</a>).<span class="i">GetMethod</span>(<span class="s">&quot;GetCentralAccessPolicyId&quot;</span>)
                        )
                );
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">CORECLR</span>    <span class="c">// GetAllCentralAccessPolicies and GetCentralAccessPolicyName are not supported in OneCore powershell</span>
<span class="e">                // because function &#39;LsaQueryCAPs&#39; is not available in OneCoreUAP and NanoServer.
                if (allCentralAccessPolicies)
                {
                    // AllCentralAccessPolicies
                    result.Properties.Add
                    (
                        new PSCodeProperty
                            (
                                &quot;AllCentralAccessPolicies&quot;,
                                typeof(SecurityDescriptorCommandsBase).GetMethod(&quot;GetAllCentralAccessPolicies&quot;)
                            )
                    );
                }
                // CentralAccessPolicyName retrieval does not require elevation, so we always add this property.
                result.Properties.Add
                (
                    new PSCodeProperty
                        (
                            &quot;CentralAccessPolicyName&quot;,
                            typeof(SecurityDescriptorCommandsBase).GetMethod(&quot;GetCentralAccessPolicyName&quot;)
                        )
                );
</span><span class="k preprocess">#</span><span class="k preprocess">endif</span>
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the Path of the provided PSObject.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r7 r">instance</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The PSObject for which to obtain the path.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The path of the provided PSObject.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public static string</b> <a id="0f53d18201f929a4" href="../R/0f53d18201f929a4.html" target="n" data-glyph="72,1" class="i method">GetPath</a>(<a href="/System.Management.Automation/A.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r7 rd" class="r7 r">instance</span>)
        {
            <b>if</b> (<span class="r7 r">instance</span> == <b>null</b>)
            {
                <b>throw</b> <a href="/System.Management.Automation/A.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<span class="i">NewArgumentNullException</span>(<b>nameof</b>(<span class="r7 r">instance</span>));
            }
            <b>else</b>
            {
                <span class="c">// These are guaranteed to not be null, but even checking</span>
                <span class="c">// them for null causes a presharp warning</span>
<span class="k preprocess">#</span><span class="k preprocess">pragma</span> <span class="k preprocess">warning</span> <span class="k preprocess">disable</span> 56506
 
                <span class="c">// Get path</span>
                <b>return</b> <span class="r7 r">instance</span>.<a href="/System.Management.Automation/A.html#59e9cd1ad57ccd34" class="i property">Properties</a>[<span class="s">&quot;PSPath&quot;</span>].<a href="/System.Management.Automation/A.html#cd3a9989baedf3dd" class="i property">Value</a>.<span class="i">ToString</span>();
<span class="k preprocess">#</span><span class="k preprocess">pragma</span> <span class="k preprocess">warning</span> <span class="k preprocess">restore</span> 56506
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the Owner of the provided PSObject.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r8 r">instance</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The PSObject for which to obtain the Owner.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The Owner of the provided PSObject.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public static string</b> <a id="66e15d338de24222" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">GetOwner</a>(<a href="/System.Management.Automation/A.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r8 rd" class="r8 r">instance</span>)
        {
            <b>if</b> (<span class="r8 r">instance</span> == <b>null</b>)
            {
                <b>throw</b> <a href="/System.Management.Automation/A.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<span class="i">NewArgumentNullException</span>(<b>nameof</b>(<span class="r8 r">instance</span>));
            }
 
            <b>if</b> (!(<span class="r8 r">instance</span>.<a href="/System.Management.Automation/A.html#d854d13536b70a12" class="i property">BaseObject</a> <b>is</b> <span class="i">ObjectSecurity</span> <span id="r9 rd" class="r9 r">sd</span>))
            {
                <b>throw</b> <a href="/System.Management.Automation/A.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<span class="i">NewArgumentNullException</span>(<b>nameof</b>(<span class="r8 r">instance</span>));
            }
 
            <span class="c">// Get owner</span>
            <b>try</b>
            {
                <span class="i">IdentityReference</span> <span id="r10 rd" class="r10 r">ir</span> = <span class="r9 r">sd</span>.<span class="i">GetOwner</span>(<b>typeof</b>(<span class="i">NTAccount</span>));
                <b>return</b> <span class="r10 r">ir</span>.<span class="i">ToString</span>();
            }
            <b>catch</b> (<span class="i">IdentityNotMappedException</span>)
            {
                <span class="c">// All Acl cmdlets returning SIDs will return a string</span>
                <span class="c">// representation of the SID in all cases where the SID</span>
                <span class="c">// cannot be mapped to a proper user or group name.</span>
            }
 
            <span class="c">// We are here since we cannot get IdentityReference from sd..</span>
            <span class="c">// So return sddl..</span>
            <b>return</b> <span class="r9 r">sd</span>.<span class="i">GetSecurityDescriptorSddlForm</span>(<span class="i">AccessControlSections</span>.<span class="i">Owner</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the Group of the provided PSObject.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r11 r">instance</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The PSObject for which to obtain the Group.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The Group of the provided PSObject.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public static string</b> <a id="a880a8819138c881" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">GetGroup</a>(<a href="/System.Management.Automation/A.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r11 rd" class="r11 r">instance</span>)
        {
            <b>if</b> (<span class="r11 r">instance</span> == <b>null</b>)
            {
                <b>throw</b> <a href="/System.Management.Automation/A.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<span class="i">NewArgumentNullException</span>(<b>nameof</b>(<span class="r11 r">instance</span>));
            }
 
            <b>if</b> (!(<span class="r11 r">instance</span>.<a href="/System.Management.Automation/A.html#d854d13536b70a12" class="i property">BaseObject</a> <b>is</b> <span class="i">ObjectSecurity</span> <span id="r12 rd" class="r12 r">sd</span>))
            {
                <b>throw</b> <a href="/System.Management.Automation/A.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<span class="i">NewArgumentNullException</span>(<b>nameof</b>(<span class="r11 r">instance</span>));
            }
 
            <span class="c">// Get Group</span>
            <b>try</b>
            {
                <span class="i">IdentityReference</span> <span id="r13 rd" class="r13 r">ir</span> = <span class="r12 r">sd</span>.<span class="i">GetGroup</span>(<b>typeof</b>(<span class="i">NTAccount</span>));
                <b>return</b> <span class="r13 r">ir</span>.<span class="i">ToString</span>();
            }
            <b>catch</b> (<span class="i">IdentityNotMappedException</span>)
            {
                <span class="c">// All Acl cmdlets returning SIDs will return a string</span>
                <span class="c">// representation of the SID in all cases where the SID</span>
                <span class="c">// cannot be mapped to a proper user or group name.</span>
            }
 
            <span class="c">// We are here since we cannot get IdentityReference from sd..</span>
            <span class="c">// So return sddl..</span>
            <b>return</b> <span class="r12 r">sd</span>.<span class="i">GetSecurityDescriptorSddlForm</span>(<span class="i">AccessControlSections</span>.<span class="i">Group</span>);
        }
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the access rules of the provided PSObject.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r14 r">instance</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The PSObject for which to obtain the access rules.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The access rules of the provided PSObject.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public static</b> <span class="i">AuthorizationRuleCollection</span> <a id="7441713517a3dad0" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">GetAccess</a>(<a href="/System.Management.Automation/A.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r14 rd" class="r14 r">instance</span>)
        {
            <b>if</b> (<span class="r14 r">instance</span> == <b>null</b>)
            {
                <b>throw</b> <a href="/System.Management.Automation/A.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<span class="i">NewArgumentNullException</span>(<b>nameof</b>(<span class="r14 r">instance</span>));
            }
 
            <span class="i">ObjectSecurity</span> <span id="r15 rd" class="r15 r">sd</span> = <span class="r14 r">instance</span>.<a href="/System.Management.Automation/A.html#d854d13536b70a12" class="i property">BaseObject</a> <b>as</b> <span class="i">ObjectSecurity</span>;
            <b>if</b> (<span class="r15 r">sd</span> == <b>null</b>)
            {
                <a href="/System.Management.Automation/A.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<span class="i">NewArgumentException</span>(<b>nameof</b>(<span class="r14 r">instance</span>));
            }
 
            <span class="c">// Get DACL</span>
            <span class="i">CommonObjectSecurity</span> <span id="r16 rd" class="r16 r">cos</span> = <span class="r15 r">sd</span> <b>as</b> <span class="i">CommonObjectSecurity</span>;
            <b>if</b> (<span class="r16 r">cos</span> != <b>null</b>)
            {
                <b>return</b> <span class="r16 r">cos</span>.<span class="i">GetAccessRules</span>(<b>true</b>, <b>true</b>, <b>typeof</b>(<span class="i">NTAccount</span>));
            }
            <b>else</b>
            {
                <span class="i">DirectoryObjectSecurity</span> <span id="r17 rd" class="r17 r">dos</span> = <span class="r15 r">sd</span> <b>as</b> <span class="i">DirectoryObjectSecurity</span>;
                <span class="i n">Dbg</span>.<span class="i">Diagnostics</span>.<span class="i">Assert</span>(<span class="r17 r">dos</span> != <b>null</b>, <span class="s">&quot;Acl should be of type CommonObjectSecurity or DirectoryObjectSecurity&quot;</span>);
                <b>return</b> <span class="r17 r">dos</span>.<span class="i">GetAccessRules</span>(<b>true</b>, <b>true</b>, <b>typeof</b>(<span class="i">NTAccount</span>));
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the audit rules of the provided PSObject.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r18 r">instance</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The PSObject for which to obtain the audit rules.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The audit rules of the provided PSObject.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public static</b> <span class="i">AuthorizationRuleCollection</span> <a id="28f4ebcab85386af" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">GetAudit</a>(<a href="/System.Management.Automation/A.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r18 rd" class="r18 r">instance</span>)
        {
            <b>if</b> (<span class="r18 r">instance</span> == <b>null</b>)
            {
                <b>throw</b> <a href="/System.Management.Automation/A.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<span class="i">NewArgumentNullException</span>(<b>nameof</b>(<span class="r18 r">instance</span>));
            }
 
            <span class="i">ObjectSecurity</span> <span id="r19 rd" class="r19 r">sd</span> = <span class="r18 r">instance</span>.<a href="/System.Management.Automation/A.html#d854d13536b70a12" class="i property">BaseObject</a> <b>as</b> <span class="i">ObjectSecurity</span>;
            <b>if</b> (<span class="r19 r">sd</span> == <b>null</b>)
            {
                <a href="/System.Management.Automation/A.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<span class="i">NewArgumentException</span>(<b>nameof</b>(<span class="r18 r">instance</span>));
            }
 
            <span class="i">CommonObjectSecurity</span> <span id="r20 rd" class="r20 r">cos</span> = <span class="r19 r">sd</span> <b>as</b> <span class="i">CommonObjectSecurity</span>;
            <b>if</b> (<span class="r20 r">cos</span> != <b>null</b>)
            {
                <b>return</b> <span class="r20 r">cos</span>.<span class="i">GetAuditRules</span>(<b>true</b>, <b>true</b>, <b>typeof</b>(<span class="i">NTAccount</span>));
            }
            <b>else</b>
            {
                <span class="i">DirectoryObjectSecurity</span> <span id="r21 rd" class="r21 r">dos</span> = <span class="r19 r">sd</span> <b>as</b> <span class="i">DirectoryObjectSecurity</span>;
                <span class="i n">Dbg</span>.<span class="i">Diagnostics</span>.<span class="i">Assert</span>(<span class="r21 r">dos</span> != <b>null</b>, <span class="s">&quot;Acl should be of type CommonObjectSecurity or DirectoryObjectSecurity&quot;</span>);
                <b>return</b> <span class="r21 r">dos</span>.<span class="i">GetAuditRules</span>(<b>true</b>, <b>true</b>, <b>typeof</b>(<span class="i">NTAccount</span>));
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the central access policy ID of the provided PSObject.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r22 r">instance</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The PSObject for which to obtain the central access policy ID.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The central access policy ID of the provided PSObject.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public static</b> <span class="i">SecurityIdentifier</span> <a id="99423319b2f93f56" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">GetCentralAccessPolicyId</a>(<a href="/System.Management.Automation/A.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r22 rd" class="r22 r">instance</span>)
        {
            <a href="/System.Management.Automation/A.html#0a202aa6b2d52930" class="t t">SessionState</a> <span id="r23 rd" class="r23 r">sessionState</span> = <b>new</b>();
            <b>string</b> <span id="r24 rd" class="r24 r">path</span> = <span class="r23 r">sessionState</span>.<a href="/System.Management.Automation/A.html#3390cfbbdcffb036" class="i property">Path</a>.<span class="i">GetUnresolvedProviderPathFromPSPath</span>(
                <a href="#0f53d18201f929a4" class="i method">GetPath</a>(<span class="r22 r">instance</span>));
            <span class="i">IntPtr</span> <span id="r25 rd" class="r25 r">pSd</span> = <span class="i">IntPtr</span>.<span class="i">Zero</span>;
 
            <b>try</b>
            {
                <span class="c">// Get the file&#39;s SACL containing the CAPID ACE.</span>
                <b>uint</b> <span id="r26 rd" class="r26 r">rs</span> = <span class="i">NativeMethods</span>.<span class="i">GetNamedSecurityInfo</span>(
                    <span class="r24 r">path</span>,
                    <span class="i">NativeMethods</span>.<span class="i">SeObjectType</span>.<span class="i">SE_FILE_OBJECT</span>,
                    <span class="i">NativeMethods</span>.<span class="i">SecurityInformation</span>.<span class="i">SCOPE_SECURITY_INFORMATION</span>,
                    <b>out</b> <span class="i">IntPtr</span> <span id="r27 rd" class="r27 r">pOwner</span>,
                    <b>out</b> <span class="i">IntPtr</span> <span id="r28 rd" class="r28 r">pGroup</span>,
                    <b>out</b> <span class="i">IntPtr</span> <span id="r29 rd" class="r29 r">pDacl</span>,
                    <b>out</b> <span class="i">IntPtr</span> <span id="r30 rd" class="r30 r">pSacl</span>,
                    <b>out</b> <span class="r25 r">pSd</span>);
                <b>if</b> (<span class="r26 r">rs</span> != <span class="i">NativeMethods</span>.<span class="i">ERROR_SUCCESS</span>)
                {
                    <b>throw</b> <b>new</b> <span class="i">Win32Exception</span>((<b>int</b>)<span class="r26 r">rs</span>);
                }
 
                <b>if</b> (<span class="r30 r">pSacl</span> == <span class="i">IntPtr</span>.<span class="i">Zero</span>)
                {
                    <b>return</b> <b>null</b>;
                }
 
                <span class="i">NativeMethods</span>.<span class="i">ACL</span> <span id="r31 rd" class="r31 r">sacl</span> = <span class="i">Marshal</span>.<span class="i">PtrToStructure</span>&lt;<span class="i">NativeMethods</span>.<span class="i">ACL</span>&gt;(<span class="r30 r">pSacl</span>);
                <b>if</b> (<span class="r31 r">sacl</span>.<span class="i">AceCount</span> == 0)
                {
                    <b>return</b> <b>null</b>;
                }
 
                <span class="c">// Extract the first CAPID from the SACL that does not have INHERIT_ONLY_ACE flag set.</span>
                <span class="i">IntPtr</span> <span id="r32 rd" class="r32 r">pAce</span> = <span class="r30 r">pSacl</span> + <span class="i">Marshal</span>.<span class="i">SizeOf</span>(<b>new</b> <span class="i">NativeMethods</span>.<span class="i">ACL</span>());
                <b>for</b> (<b>ushort</b> <span id="r33 rd" class="r33 r">aceIdx</span> = 0; <span class="r33 r">aceIdx</span> &lt; <span class="r31 r">sacl</span>.<span class="i">AceCount</span>; <span class="r33 r">aceIdx</span>++)
                {
                    <span class="i">NativeMethods</span>.<span class="i">ACE_HEADER</span> <span id="r34 rd" class="r34 r">ace</span> = <span class="i">Marshal</span>.<span class="i">PtrToStructure</span>&lt;<span class="i">NativeMethods</span>.<span class="i">ACE_HEADER</span>&gt;(<span class="r32 r">pAce</span>);
                    <span class="i n">Dbg</span>.<span class="i">Diagnostics</span>.<span class="i">Assert</span>(<span class="r34 r">ace</span>.<span class="i">AceType</span> ==
                        <span class="i">NativeMethods</span>.<span class="i">SYSTEM_SCOPED_POLICY_ID_ACE_TYPE</span>,
                        <span class="s">&quot;Unexpected ACE type: &quot;</span> + <span class="r34 r">ace</span>.<span class="i">AceType</span>.<span class="i">ToString</span>(<span class="i">CultureInfo</span>.<span class="i">CurrentCulture</span>));
                    <b>if</b> ((<span class="r34 r">ace</span>.<span class="i">AceFlags</span> &amp; <span class="i">NativeMethods</span>.<span class="i">INHERIT_ONLY_ACE</span>) == 0)
                    {
                        <b>break</b>;
                    }
 
                    <span class="r32 r">pAce</span> += <span class="r34 r">ace</span>.<span class="i">AceSize</span>;
                }
 
                <span class="i">IntPtr</span> <span id="r35 rd" class="r35 r">pSid</span> = <span class="r32 r">pAce</span> + <span class="i">Marshal</span>.<span class="i">SizeOf</span>(<b>new</b> <span class="i">NativeMethods</span>.<span class="i">SYSTEM_AUDIT_ACE</span>()) -
                    <span class="i">Marshal</span>.<span class="i">SizeOf</span>(<b>new</b> <b>uint</b>());
                <b>bool</b> <span id="r36 rd" class="r36 r">ret</span> = <span class="i">NativeMethods</span>.<span class="i">IsValidSid</span>(<span class="r35 r">pSid</span>);
                <b>if</b> (!<span class="r36 r">ret</span>)
                {
                    <b>throw</b> <b>new</b> <span class="i">Win32Exception</span>(<span class="i">Marshal</span>.<span class="i">GetLastWin32Error</span>());
                }
 
                <b>return</b> <b>new</b> <span class="i">SecurityIdentifier</span>(<span class="r35 r">pSid</span>);
            }
            <b>finally</b>
            {
                <span class="i">NativeMethods</span>.<span class="i">LocalFree</span>(<span class="r25 r">pSd</span>);
            }
        }
 
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">CORECLR</span>
<span class="e">        /// &lt;summary&gt;
        /// Gets the central access policy name of the provided PSObject.
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        /// Function &#39;LsaQueryCAPs&#39; is not available in OneCoreUAP and NanoServer.
        /// &lt;/remarks&gt;
        /// &lt;param name=&quot;instance&quot;&gt;
        /// The PSObject for which to obtain the central access policy name.
        /// &lt;/param&gt;
        /// &lt;returns&gt;
        /// The central access policy name of the provided PSObject.
        /// &lt;/returns&gt;
        public static string GetCentralAccessPolicyName(PSObject instance)
        {
            SecurityIdentifier capId = GetCentralAccessPolicyId(instance);
            if (capId == null)
            {
                return null; // file does not have the scope ace
            }
 
            int capIdSize = capId.BinaryLength;
            byte[] capIdArray = new byte[capIdSize];
            capId.GetBinaryForm(capIdArray, 0);
            IntPtr caps = IntPtr.Zero;
            IntPtr pCapId = Marshal.AllocHGlobal(capIdSize);
 
            try
            {
                // Retrieve the CAP by CAPID.
                Marshal.Copy(capIdArray, 0, pCapId, capIdSize);
                IntPtr[] ppCapId = new IntPtr[1];
                ppCapId[0] = pCapId;
                uint rs = NativeMethods.LsaQueryCAPs(
                    ppCapId,
                    1,
                    out caps,
                    out uint capCount);
                if (rs != NativeMethods.STATUS_SUCCESS)
                {
                    throw new Win32Exception((int)rs);
                }
 
                if (capCount == 0 || caps == IntPtr.Zero)
                {
                    return null;
                }
 
                // Get the CAP name.
                NativeMethods.CENTRAL_ACCESS_POLICY cap = Marshal.PtrToStructure&lt;NativeMethods.CENTRAL_ACCESS_POLICY&gt;(caps);
                // LSA_UNICODE_STRING is composed of WCHARs, but its length is given in bytes.
                return Marshal.PtrToStringUni(cap.Name.Buffer, cap.Name.Length / 2);
            }
            finally
            {
                Marshal.FreeHGlobal(pCapId);
                uint rs = NativeMethods.LsaFreeMemory(caps);
                Dbg.Diagnostics.Assert(rs == NativeMethods.STATUS_SUCCESS,
                    &quot;LsaFreeMemory failed: &quot; + rs.ToString(CultureInfo.CurrentCulture));
            }
        }
 
        /// &lt;summary&gt;
        /// Gets the names and IDs of all central access policies available on the machine.
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        /// Function &#39;LsaQueryCAPs&#39; is not available in OneCoreUAP and NanoServer.
        /// &lt;/remarks&gt;
        /// &lt;param name=&quot;instance&quot;&gt;
        /// The PSObject argument is ignored.
        /// &lt;/param&gt;
        /// &lt;returns&gt;
        /// The names and IDs of all central access policies available on the machine.
        /// &lt;/returns&gt;
        public static string[] GetAllCentralAccessPolicies(PSObject instance)
        {
            IntPtr caps = IntPtr.Zero;
 
            try
            {
                // Retrieve all CAPs.
                uint rs = NativeMethods.LsaQueryCAPs(
                    null,
                    0,
                    out caps,
                    out uint capCount);
                if (rs != NativeMethods.STATUS_SUCCESS)
                {
                    throw new Win32Exception((int)rs);
                }
 
                Dbg.Diagnostics.Assert(capCount &lt; 0xFFFF,
                    &quot;Too many central access policies&quot;);
                if (capCount == 0 || caps == IntPtr.Zero)
                {
                    return null;
                }
 
                // Add CAP names and IDs to a string array.
                string[] policies = new string[capCount];
                IntPtr capPtr = caps;
                for (uint capIdx = 0; capIdx &lt; capCount; capIdx++)
                {
                    // Retrieve CAP name.
                    Dbg.Diagnostics.Assert(capPtr != IntPtr.Zero,
                        &quot;Invalid central access policies array&quot;);
                    NativeMethods.CENTRAL_ACCESS_POLICY cap = Marshal.PtrToStructure&lt;NativeMethods.CENTRAL_ACCESS_POLICY&gt;(capPtr);
                    // LSA_UNICODE_STRING is composed of WCHARs, but its length is given in bytes.
                    policies[capIdx] = &quot;\&quot;&quot; + Marshal.PtrToStringUni(
                        cap.Name.Buffer,
                        cap.Name.Length / 2) + &quot;\&quot;&quot;;
 
                    // Retrieve CAPID.
                    IntPtr pCapId = cap.CAPID;
                    Dbg.Diagnostics.Assert(pCapId != IntPtr.Zero,
                        &quot;Invalid central access policies array&quot;);
                    bool ret = NativeMethods.IsValidSid(pCapId);
                    if (!ret)
                    {
                        throw new Win32Exception(Marshal.GetLastWin32Error());
                    }
 
                    SecurityIdentifier sid = new SecurityIdentifier(pCapId);
                    policies[capIdx] += &quot; (&quot; + sid.ToString() + &quot;)&quot;;
 
                    capPtr += Marshal.SizeOf(cap);
                }
 
                return policies;
            }
            finally
            {
                uint rs = NativeMethods.LsaFreeMemory(caps);
                Dbg.Diagnostics.Assert(rs == NativeMethods.STATUS_SUCCESS,
                    &quot;LsaFreeMemory failed: &quot; + rs.ToString(CultureInfo.CurrentCulture));
            }
        }
</span><span class="k preprocess">#</span><span class="k preprocess">endif</span>
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the security descriptor (in SDDL form) of the</span>
        <span class="c">///</span><span class="c"> provided PSObject.  SDDL form is the Security Descriptor</span>
        <span class="c">///</span><span class="c"> Definition Language.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r37 r">instance</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The PSObject for which to obtain the security descriptor.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The security descriptor of the provided PSObject, in SDDL form.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public static string</b> <a id="3447457e046a3000" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">GetSddl</a>(<a href="/System.Management.Automation/A.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r37 rd" class="r37 r">instance</span>)
        {
            <b>if</b> (<span class="r37 r">instance</span> == <b>null</b>)
            {
                <b>throw</b> <a href="/System.Management.Automation/A.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<span class="i">NewArgumentNullException</span>(<b>nameof</b>(<span class="r37 r">instance</span>));
            }
 
            <b>if</b> (!(<span class="r37 r">instance</span>.<a href="/System.Management.Automation/A.html#d854d13536b70a12" class="i property">BaseObject</a> <b>is</b> <span class="i">ObjectSecurity</span> <span id="r38 rd" class="r38 r">sd</span>))
            {
                <b>throw</b> <a href="/System.Management.Automation/A.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<span class="i">NewArgumentNullException</span>(<b>nameof</b>(<span class="r37 r">instance</span>));
            }
 
            <b>string</b> <span id="r39 rd" class="r39 r">sddl</span> = <span class="r38 r">sd</span>.<span class="i">GetSecurityDescriptorSddlForm</span>(<span class="i">AccessControlSections</span>.<span class="i">All</span>);
            <b>return</b> <span class="r39 r">sddl</span>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> brokered properties
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The filter to be used to when globbing to get the item.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private string</b> <a id="a5b7cb72f6485388" href="../R/a5b7cb72f6485388.html" target="n" data-glyph="46,1" class="i field">_filter</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The glob string used to determine which items are included.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private string</b>[] <a id="1ea0ae17d0685c26" href="../R/1ea0ae17d0685c26.html" target="n" data-glyph="46,1" class="i field">_include</a> = <span class="i">Array</span>.<span class="i">Empty</span>&lt;<b>string</b>&gt;();
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The glob string used to determine which items are excluded.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private string</b>[] <a id="1a838cdf9f08e0e7" href="../R/1a838cdf9f08e0e7.html" target="n" data-glyph="46,1" class="i field">_exclude</a> = <span class="i">Array</span>.<span class="i">Empty</span>&lt;<b>string</b>&gt;();
    }
 
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">UNIX</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Defines the implementation of the &#39;get-acl&#39; cmdlet.</span>
    <span class="c">///</span><span class="c"> This cmdlet gets the security descriptor of an item at the specified path.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    [<span class="i">Cmdlet</span>(<a href="/System.Management.Automation/A.html#d056c4b8c99405e5" class="t t">VerbsCommon</a>.<a href="/System.Management.Automation/A.html#7ee9f5441476f642" class="i field">Get</a>, <span class="s">&quot;Acl&quot;</span>, <span class="i">SupportsTransactions</span> = <b>true</b>, <span class="i">DefaultParameterSetName</span> = <span class="s">&quot;ByPath&quot;</span>, <span class="i">HelpUri</span> = <span class="s">&quot;https://go.microsoft.com/fwlink/?LinkID=2096593&quot;</span>)]
    <b>public sealed class</b> <a id="9ac8816bded63433" href="../R/../../0000000000.html" target="n" data-glyph="0,0" class="t t">GetAclCommand</a> : <a href="#310a1f126fc0ee1a" class="t t">SecurityDescriptorCommandsBase</a>
    {
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Initializes a new instance of the GetAclCommand</span>
        <span class="c">///</span><span class="c"> class.  Sets the default path to the current location.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public</b> <a id="13fedee4117b77ee" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="t constructor">GetAclCommand</a>()
        {
            <span class="c">// Default for path is the current location</span>
            <a href="#e39e0902c4901072" class="i field">_path</a> = <b>new</b> <b>string</b>[] { <span class="s">&quot;.&quot;</span> };
        }
        <span class="k preprocess">#</span><span class="k preprocess">region</span> parameters
 
        <b>private string</b>[] <a id="e39e0902c4901072" href="../R/e39e0902c4901072.html" target="n" data-glyph="46,1" class="i field">_path</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets or sets the path of the item for which to obtain the</span>
        <span class="c">///</span><span class="c"> security descriptor.  Default is the current location.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>(<a href="/System.Management.Automation/A.html#19ccfeb1cdbdb967" class="i property">Position</a> = 0, <a href="/System.Management.Automation/A.html#4afbf5921ff6e967" class="i property">ValueFromPipeline</a> = <b>true</b>, <a href="/System.Management.Automation/A.html#aded474eaec9cde8" class="i property">ValueFromPipelineByPropertyName</a> = <b>true</b>, <a href="/System.Management.Automation/A.html#91bee819daab0925" class="i property">ParameterSetName</a> = <span class="s">&quot;ByPath&quot;</span>)]
        [<span class="i">ValidateNotNullOrEmpty</span>()]
        <b>public string</b>[] <a id="ca502067bb7cf1c9" href="../R/ca502067bb7cf1c9.html" target="n" data-glyph="102,1" class="i property">Path</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#e39e0902c4901072" class="i field">_path</a>;
            }
 
            <b>set</b>
            {
                <a href="#e39e0902c4901072" class="i field">_path</a> = <b>value</b>;
            }
        }
 
        <b>private</b> <a href="/System.Management.Automation/A.html#a3c2513aa3da07fa" class="t t">PSObject</a> <a id="759ce5bf657fa1d7" href="../R/759ce5bf657fa1d7.html" target="n" data-glyph="46,1" class="i field">_inputObject</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> InputObject Parameter</span>
        <span class="c">///</span><span class="c"> Gets or sets the inputObject for which to obtain the security descriptor.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>(<a href="/System.Management.Automation/A.html#d5ad471518092731" class="i property">Mandatory</a> = <b>true</b>, <a href="/System.Management.Automation/A.html#91bee819daab0925" class="i property">ParameterSetName</a> = <span class="s">&quot;ByInputObject&quot;</span>)]
        <b>public</b> <a href="/System.Management.Automation/A.html#a3c2513aa3da07fa" class="t t">PSObject</a> <a id="24fe57660d6eda52" href="../R/../../0000000000.html" target="n" data-glyph="102,1" class="i property">InputObject</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#759ce5bf657fa1d7" class="i field">_inputObject</a>;
            }
 
            <b>set</b>
            {
                <a href="#759ce5bf657fa1d7" class="i field">_inputObject</a> = <b>value</b>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets or sets the literal path of the item for which to obtain the</span>
        <span class="c">///</span><span class="c"> security descriptor.  Default is the current location.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>(<a href="/System.Management.Automation/A.html#4afbf5921ff6e967" class="i property">ValueFromPipeline</a> = <b>true</b>, <a href="/System.Management.Automation/A.html#aded474eaec9cde8" class="i property">ValueFromPipelineByPropertyName</a> = <b>true</b>, <a href="/System.Management.Automation/A.html#91bee819daab0925" class="i property">ParameterSetName</a> = <span class="s">&quot;ByLiteralPath&quot;</span>)]
        [<span class="i">Alias</span>(<span class="s">&quot;PSPath&quot;</span>)]
        [<span class="i">ValidateNotNullOrEmpty</span>()]
        [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Performance&quot;</span>, <span class="s">&quot;CA1819:PropertiesShouldNotReturnArrays&quot;</span>)]
        <b>public string</b>[] <a id="da6d545b6f2f110d" href="../R/../../0000000000.html" target="n" data-glyph="102,1" class="i property">LiteralPath</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#e39e0902c4901072" class="i field">_path</a>;
            }
 
            <b>set</b>
            {
                <a href="#e39e0902c4901072" class="i field">_path</a> = <b>value</b>;
                <a href="#5b4538c30b6ada80" class="i field">_isLiteralPath</a> = <b>true</b>;
            }
        }
 
        <b>private bool</b> <a id="5b4538c30b6ada80" href="../R/5b4538c30b6ada80.html" target="n" data-glyph="46,1" class="i field">_isLiteralPath</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets or sets the audit flag of the command.  This flag</span>
        <span class="c">///</span><span class="c"> determines if audit rules should also be retrieved.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>()]
        <b>public</b> <a href="/System.Management.Automation/A.html#8260026027378f6c" class="t t">SwitchParameter</a> <a id="84a6538a26b33cfd" href="../R/../../0000000000.html" target="n" data-glyph="102,1" class="i property">Audit</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#39db0f52f31c602b" class="i field">_audit</a>;
            }
 
            <b>set</b>
            {
                <a href="#39db0f52f31c602b" class="i field">_audit</a> = <b>value</b>;
            }
        }
 
        <b>private</b> <a href="/System.Management.Automation/A.html#8260026027378f6c" class="t t">SwitchParameter</a> <a id="39db0f52f31c602b" href="../R/39db0f52f31c602b.html" target="n" data-glyph="46,1" class="i field">_audit</a>;
 
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">CORECLR</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Parameter &#39;-AllCentralAccessPolicies&#39; is not supported in OneCore powershell,</span>
        <span class="c">///</span><span class="c"> because function &#39;LsaQueryCAPs&#39; is not available in OneCoreUAP and NanoServer.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private</b> <a href="/System.Management.Automation/A.html#8260026027378f6c" class="t t">SwitchParameter</a> <a id="5f9d31dbd9a88aab" href="../R/5f9d31dbd9a88aab.html" target="n" data-glyph="106,1" class="i property">AllCentralAccessPolicies</a>
        {
            <b>get</b>; <b>set</b>;
        }
<span class="k preprocess">#</span><span class="k preprocess">else</span>
<span class="e">        /// &lt;summary&gt;
        /// Gets or sets the AllCentralAccessPolicies flag of the command. This flag
        /// determines whether the information about all central access policies
        /// available on the machine should be displayed.
        /// &lt;/summary&gt;
        [Parameter()]
        public SwitchParameter AllCentralAccessPolicies
        {
            get
            {
                return allCentralAccessPolicies;
            }
 
            set
            {
                allCentralAccessPolicies = value;
            }
        }
 
        private SwitchParameter allCentralAccessPolicies;
</span><span class="k preprocess">#</span><span class="k preprocess">endif</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Processes records from the input pipeline.</span>
        <span class="c">///</span><span class="c"> For each input file, the command retrieves its</span>
        <span class="c">///</span><span class="c"> corresponding security descriptor.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>protected override void</b> <a id="fd0236a3656dc9bb" href="../R/fd0236a3656dc9bb.html" target="n" data-glyph="75,1" class="i method">ProcessRecord</a>()
        {
            <span class="i">AccessControlSections</span> <span id="r40 rd" class="r40 r">sections</span> =
                <span class="i">AccessControlSections</span>.<span class="i">Owner</span> |
                <span class="i">AccessControlSections</span>.<span class="i">Group</span> |
                <span class="i">AccessControlSections</span>.<span class="i">Access</span>;
            <b>if</b> (<a href="#39db0f52f31c602b" class="i field">_audit</a>)
            {
                <span class="r40 r">sections</span> |= <span class="i">AccessControlSections</span>.<span class="i">Audit</span>;
            }
 
            <b>if</b> (<a href="#759ce5bf657fa1d7" class="i field">_inputObject</a> != <b>null</b>)
            {
                <a href="/System.Management.Automation/A.html#19eeb66bf76c933c" class="t t">PSMethodInfo</a> <span id="r41 rd" class="r41 r">methodInfo</span> = <a href="#759ce5bf657fa1d7" class="i field">_inputObject</a>.<a href="/System.Management.Automation/A.html#6cb42c4e7cce30cd" class="i property">Methods</a>[<span class="s">&quot;GetSecurityDescriptor&quot;</span>];
 
                <b>if</b> (<span class="r41 r">methodInfo</span> != <b>null</b>)
                {
                    <b>object</b> <span id="r42 rd" class="r42 r">customDescriptor</span> = <b>null</b>;
 
                    <b>try</b>
                    {
                        <span class="r42 r">customDescriptor</span> = <a href="/System.Management.Automation/A.html#a3c2513aa3da07fa" class="t t">PSObject</a>.<span class="i">Base</span>(<span class="r41 r">methodInfo</span>.<span class="i">Invoke</span>());
 
                        <b>if</b> (<span class="r42 r">customDescriptor</span> <b>is not</b> <span class="i">FileSystemSecurity</span>)
                        {
                            <span class="r42 r">customDescriptor</span> = <b>new</b> <span class="i">CommonSecurityDescriptor</span>(<b>false</b>, <b>false</b>, <span class="r42 r">customDescriptor</span>.<span class="i">ToString</span>());
                        }
                    }
                    <b>catch</b> (<span class="i">Exception</span>)
                    {
                        <span class="c">// Calling user code, Catch-all OK</span>
                        <a href="/System.Management.Automation/A.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r43 rd" class="r43 r">er</span> =
                        <a href="Utils.cs.html#aac1e7d3ed49e313" class="t t">SecurityUtils</a>.<span class="i">CreateNotSupportedErrorRecord</span>(
                            <span class="i">UtilsStrings</span>.<span class="i">MethodInvokeFail</span>,
                            <span class="s">&quot;GetAcl_OperationNotSupported&quot;</span>
                            );
 
                        <span class="i">WriteError</span>(<span class="r43 r">er</span>);
                        <b>return</b>;
                    }
 
                    <span class="i">WriteObject</span>(<span class="r42 r">customDescriptor</span>, <b>true</b>);
                }
                <b>else</b>
                {
                    <a href="/System.Management.Automation/A.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r44 rd" class="r44 r">er</span> =
                        <a href="Utils.cs.html#aac1e7d3ed49e313" class="t t">SecurityUtils</a>.<span class="i">CreateNotSupportedErrorRecord</span>(
                            <span class="i">UtilsStrings</span>.<span class="i">GetMethodNotFound</span>,
                            <span class="s">&quot;GetAcl_OperationNotSupported&quot;</span>
                            );
 
                    <span class="i">WriteError</span>(<span class="r44 r">er</span>);
                }
            }
            <b>else</b>
            {
                <b>foreach</b> (<b>string</b> <span id="r45 rd" class="r45 r">p</span> <b>in</b> <a href="#ca502067bb7cf1c9" class="i property">Path</a>)
                {
                    <span class="i">List</span>&lt;<b>string</b>&gt; <span id="r46 rd" class="r46 r">pathsToProcess</span> = <b>new</b>();
 
                    <b>string</b> <span id="r47 rd" class="r47 r">currentPath</span> = <b>null</b>;
                    <b>try</b>
                    {
                        <b>if</b> (<a href="#5b4538c30b6ada80" class="i field">_isLiteralPath</a>)
                        {
                            <span class="r46 r">pathsToProcess</span>.<span class="i">Add</span>(<span class="r45 r">p</span>);
                        }
                        <b>else</b>
                        {
                            <span class="i">Collection</span>&lt;<a href="/System.Management.Automation/A.html#9504cfb54420cfd7" class="t t">PathInfo</a>&gt; <span id="r48 rd" class="r48 r">resolvedPaths</span> =
                                <a href="/System.Management.Automation/A.html#5078d443148de142" class="i property">SessionState</a>.<a href="/System.Management.Automation/A.html#3390cfbbdcffb036" class="i property">Path</a>.<span class="i">GetResolvedPSPathFromPSPath</span>(<span class="r45 r">p</span>, <a href="#678521eeda8094cc" class="i property">CmdletProviderContext</a>);
                            <b>foreach</b> (<a href="/System.Management.Automation/A.html#9504cfb54420cfd7" class="t t">PathInfo</a> <span id="r49 rd" class="r49 r">pi</span> <b>in</b> <span class="r48 r">resolvedPaths</span>)
                            {
                                <span class="r46 r">pathsToProcess</span>.<span class="i">Add</span>(<span class="r49 r">pi</span>.<a href="/System.Management.Automation/A.html#de00cd47bf0cf721" class="i property">Path</a>);
                            }
                        }
 
                        <b>foreach</b> (<b>string</b> <span id="r50 rd" class="r50 r">rp</span> <b>in</b> <span class="r46 r">pathsToProcess</span>)
                        {
                            <span class="r47 r">currentPath</span> = <span class="r50 r">rp</span>;
 
                            <span class="i">CmdletProviderContext</span> <span id="r51 rd" class="r51 r">context</span> = <b>new</b>(<a href="#9ac8816bded63433" class="k">this</a>.<span class="i">Context</span>);
                            <span class="r51 r">context</span>.<span class="i">SuppressWildcardExpansion</span> = <b>true</b>;
 
                            <b>if</b> (!<a href="/System.Management.Automation/A.html#0a0ac63de22d06f8" class="i property">InvokeProvider</a>.<a href="/System.Management.Automation/A.html#982f59c2f3f056cc" class="i property">Item</a>.<span class="i">Exists</span>(<span class="r50 r">rp</span>, <b>false</b>, <a href="#5b4538c30b6ada80" class="i field">_isLiteralPath</a>))
                            {
                                <a href="/System.Management.Automation/A.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r52 rd" class="r52 r">er</span> =
                                    <a href="Utils.cs.html#aac1e7d3ed49e313" class="t t">SecurityUtils</a>.<a href="Utils.cs.html#ca89d23d4186eedb" class="i method">CreatePathNotFoundErrorRecord</a>(
                                               <span class="r50 r">rp</span>,
                                               <span class="s">&quot;GetAcl_PathNotFound&quot;</span>
                                    );
 
                                <span class="i">WriteError</span>(<span class="r52 r">er</span>);
                                <b>continue</b>;
                            }
 
                            <a href="/System.Management.Automation/A.html#0a0ac63de22d06f8" class="i property">InvokeProvider</a>.<a href="/System.Management.Automation/A.html#8803a1d728bb633f" class="i property">SecurityDescriptor</a>.<span class="i">Get</span>(<span class="r50 r">rp</span>, <span class="r40 r">sections</span>, <span class="r51 r">context</span>);
 
                            <span class="i">Collection</span>&lt;<a href="/System.Management.Automation/A.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt; <span id="r53 rd" class="r53 r">sd</span> = <span class="r51 r">context</span>.<span class="i">GetAccumulatedObjects</span>();
                            <b>if</b> (<span class="r53 r">sd</span> != <b>null</b>)
                            {
                                <a href="#c96bba155ed550c0" class="i method">AddBrokeredProperties</a>(
                                    <span class="r53 r">sd</span>,
                                    <a href="#39db0f52f31c602b" class="i field">_audit</a>,
                                    <a href="#5f9d31dbd9a88aab" class="i property">AllCentralAccessPolicies</a>);
                                <span class="i">WriteObject</span>(<span class="r53 r">sd</span>, <b>true</b>);
                            }
                        }
                    }
                    <b>catch</b> (<span class="i">NotSupportedException</span>)
                    {
                        <a href="/System.Management.Automation/A.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r54 rd" class="r54 r">er</span> =
                            <a href="Utils.cs.html#aac1e7d3ed49e313" class="t t">SecurityUtils</a>.<span class="i">CreateNotSupportedErrorRecord</span>(
                                <span class="i">UtilsStrings</span>.<span class="i">OperationNotSupportedOnPath</span>,
                                <span class="s">&quot;GetAcl_OperationNotSupported&quot;</span>,
                                <span class="r47 r">currentPath</span>
                            );
 
                        <span class="i">WriteError</span>(<span class="r54 r">er</span>);
                    }
                    <b>catch</b> (<a href="/System.Management.Automation/A.html#9ed59df3c4c15193" class="t t">ItemNotFoundException</a>)
                    {
                        <a href="/System.Management.Automation/A.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r55 rd" class="r55 r">er</span> =
                            <a href="Utils.cs.html#aac1e7d3ed49e313" class="t t">SecurityUtils</a>.<a href="Utils.cs.html#ca89d23d4186eedb" class="i method">CreatePathNotFoundErrorRecord</a>(
                                <span class="r45 r">p</span>,
                                <span class="s">&quot;GetAcl_PathNotFound_Exception&quot;</span>
                            );
 
                        <span class="i">WriteError</span>(<span class="r55 r">er</span>);
                        <b>continue</b>;
                    }
                }
            }
        }
    }
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Defines the implementation of the &#39;set-acl&#39; cmdlet.</span>
    <span class="c">///</span><span class="c"> This cmdlet sets the security descriptor of an item at the specified path.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    [<span class="i">Cmdlet</span>(<a href="/System.Management.Automation/A.html#d056c4b8c99405e5" class="t t">VerbsCommon</a>.<a href="/System.Management.Automation/A.html#d881191bd45d8eb9" class="i field">Set</a>, <span class="s">&quot;Acl&quot;</span>, <span class="i">SupportsShouldProcess</span> = <b>true</b>, <span class="i">SupportsTransactions</span> = <b>true</b>, <span class="i">DefaultParameterSetName</span> = <span class="s">&quot;ByPath&quot;</span>,
            <span class="i">HelpUri</span> = <span class="s">&quot;https://go.microsoft.com/fwlink/?LinkID=2096600&quot;</span>)]
    <b>public sealed class</b> <a id="9bc17f1787578929" href="../R/../../0000000000.html" target="n" data-glyph="0,0" class="t t"><span id="87e0f7c0aa457001">SetAclCommand</span></a> : <a href="#310a1f126fc0ee1a" class="t t">SecurityDescriptorCommandsBase</a>
    {
        <b>private string</b>[] <a id="ccb58d50bef9c38c" href="../R/ccb58d50bef9c38c.html" target="n" data-glyph="46,1" class="i field">_path</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets or sets the path of the item for which to set the</span>
        <span class="c">///</span><span class="c"> security descriptor.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>(<a href="/System.Management.Automation/A.html#19ccfeb1cdbdb967" class="i property">Position</a> = 0, <a href="/System.Management.Automation/A.html#d5ad471518092731" class="i property">Mandatory</a> = <b>true</b>, <a href="/System.Management.Automation/A.html#aded474eaec9cde8" class="i property">ValueFromPipelineByPropertyName</a> = <b>true</b>, <a href="/System.Management.Automation/A.html#91bee819daab0925" class="i property">ParameterSetName</a> = <span class="s">&quot;ByPath&quot;</span>)]
        <b>public string</b>[] <a id="bb8b5524fbe61341" href="../R/bb8b5524fbe61341.html" target="n" data-glyph="102,1" class="i property">Path</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#ccb58d50bef9c38c" class="i field">_path</a>;
            }
 
            <b>set</b>
            {
                <a href="#ccb58d50bef9c38c" class="i field">_path</a> = <b>value</b>;
            }
        }
 
        <b>private</b> <a href="/System.Management.Automation/A.html#a3c2513aa3da07fa" class="t t">PSObject</a> <a id="9088ccd85b7ff35e" href="../R/9088ccd85b7ff35e.html" target="n" data-glyph="46,1" class="i field">_inputObject</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> InputObject Parameter</span>
        <span class="c">///</span><span class="c"> Gets or sets the inputObject for which to set the security descriptor.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>(<a href="/System.Management.Automation/A.html#19ccfeb1cdbdb967" class="i property">Position</a> = 0, <a href="/System.Management.Automation/A.html#d5ad471518092731" class="i property">Mandatory</a> = <b>true</b>, <a href="/System.Management.Automation/A.html#aded474eaec9cde8" class="i property">ValueFromPipelineByPropertyName</a> = <b>true</b>, <a href="/System.Management.Automation/A.html#91bee819daab0925" class="i property">ParameterSetName</a> = <span class="s">&quot;ByInputObject&quot;</span>)]
        <b>public</b> <a href="/System.Management.Automation/A.html#a3c2513aa3da07fa" class="t t">PSObject</a> <a id="ec7d19b7e566a730" href="../R/../../0000000000.html" target="n" data-glyph="102,1" class="i property">InputObject</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#9088ccd85b7ff35e" class="i field">_inputObject</a>;
            }
 
            <b>set</b>
            {
                <a href="#9088ccd85b7ff35e" class="i field">_inputObject</a> = <b>value</b>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets or sets the literal path of the item for which to set the</span>
        <span class="c">///</span><span class="c"> security descriptor.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>(<a href="/System.Management.Automation/A.html#d5ad471518092731" class="i property">Mandatory</a> = <b>true</b>, <a href="/System.Management.Automation/A.html#aded474eaec9cde8" class="i property">ValueFromPipelineByPropertyName</a> = <b>true</b>, <a href="/System.Management.Automation/A.html#91bee819daab0925" class="i property">ParameterSetName</a> = <span class="s">&quot;ByLiteralPath&quot;</span>)]
        [<span class="i">Alias</span>(<span class="s">&quot;PSPath&quot;</span>)]
        [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Performance&quot;</span>, <span class="s">&quot;CA1819:PropertiesShouldNotReturnArrays&quot;</span>)]
        <b>public string</b>[] <a id="b9d6a10ae21c295b" href="../R/../../0000000000.html" target="n" data-glyph="102,1" class="i property">LiteralPath</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#ccb58d50bef9c38c" class="i field">_path</a>;
            }
 
            <b>set</b>
            {
                <a href="#ccb58d50bef9c38c" class="i field">_path</a> = <b>value</b>;
                <a href="#ce38e49656fb7768" class="i field">_isLiteralPath</a> = <b>true</b>;
            }
        }
 
        <b>private bool</b> <a id="ce38e49656fb7768" href="../R/ce38e49656fb7768.html" target="n" data-glyph="46,1" class="i field">_isLiteralPath</a>;
 
        <b>private object</b> <a id="abc54c2b72cb7d74" href="../R/abc54c2b72cb7d74.html" target="n" data-glyph="46,1" class="i field">_securityDescriptor</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets or sets the security descriptor object to be</span>
        <span class="c">///</span><span class="c"> set on the target item(s).</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>(<a href="/System.Management.Automation/A.html#19ccfeb1cdbdb967" class="i property">Position</a> = 1, <a href="/System.Management.Automation/A.html#d5ad471518092731" class="i property">Mandatory</a> = <b>true</b>, <a href="/System.Management.Automation/A.html#4afbf5921ff6e967" class="i property">ValueFromPipeline</a> = <b>true</b>, <a href="/System.Management.Automation/A.html#91bee819daab0925" class="i property">ParameterSetName</a> = <span class="s">&quot;ByPath&quot;</span>)]
        [<span class="i">Parameter</span>(<a href="/System.Management.Automation/A.html#19ccfeb1cdbdb967" class="i property">Position</a> = 1, <a href="/System.Management.Automation/A.html#d5ad471518092731" class="i property">Mandatory</a> = <b>true</b>, <a href="/System.Management.Automation/A.html#4afbf5921ff6e967" class="i property">ValueFromPipeline</a> = <b>true</b>, <a href="/System.Management.Automation/A.html#91bee819daab0925" class="i property">ParameterSetName</a> = <span class="s">&quot;ByLiteralPath&quot;</span>)]
        [<span class="i">Parameter</span>(<a href="/System.Management.Automation/A.html#19ccfeb1cdbdb967" class="i property">Position</a> = 1, <a href="/System.Management.Automation/A.html#d5ad471518092731" class="i property">Mandatory</a> = <b>true</b>, <a href="/System.Management.Automation/A.html#4afbf5921ff6e967" class="i property">ValueFromPipeline</a> = <b>true</b>, <a href="/System.Management.Automation/A.html#91bee819daab0925" class="i property">ParameterSetName</a> = <span class="s">&quot;ByInputObject&quot;</span>)]
        <b>public object</b> <a id="b535fa95beb8748a" href="../R/b535fa95beb8748a.html" target="n" data-glyph="102,1" class="i property">AclObject</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#abc54c2b72cb7d74" class="i field">_securityDescriptor</a>;
            }
 
            <b>set</b>
            {
                <a href="#abc54c2b72cb7d74" class="i field">_securityDescriptor</a> = <a href="/System.Management.Automation/A.html#a3c2513aa3da07fa" class="t t">PSObject</a>.<span class="i">Base</span>(<b>value</b>);
            }
        }
 
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">CORECLR</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Parameter &#39;-CentralAccessPolicy&#39; is not supported in OneCore powershell,</span>
        <span class="c">///</span><span class="c"> because function &#39;LsaQueryCAPs&#39; is not available in OneCoreUAP and NanoServer.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private string</b> <a id="ba26861a6cbc8ba0" href="../R/ba26861a6cbc8ba0.html" target="n" data-glyph="106,1" class="i property">CentralAccessPolicy</a> { <b>get</b>; }
<span class="k preprocess">#</span><span class="k preprocess">else</span>
<span class="e">        private string centralAccessPolicy;
 
        /// &lt;summary&gt;
        /// Gets or sets the central access policy to be
        /// set on the target item(s).
        /// &lt;/summary&gt;
        [Parameter(Position = 2, Mandatory = false, ValueFromPipelineByPropertyName = true, ParameterSetName = &quot;ByPath&quot;)]
        [Parameter(Position = 2, Mandatory = false, ValueFromPipelineByPropertyName = true, ParameterSetName = &quot;ByLiteralPath&quot;)]
        public string CentralAccessPolicy
        {
            get
            {
                return centralAccessPolicy;
            }
 
            set
            {
                centralAccessPolicy = value;
            }
        }
</span><span class="k preprocess">#</span><span class="k preprocess">endif</span>
 
        <b>private</b> <a href="/System.Management.Automation/A.html#8260026027378f6c" class="t t">SwitchParameter</a> <a id="7d1e23c1c4134005" href="../R/7d1e23c1c4134005.html" target="n" data-glyph="46,1" class="i field">_clearCentralAccessPolicy</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Clears the central access policy applied on the target item(s).</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>(<a href="/System.Management.Automation/A.html#d5ad471518092731" class="i property">Mandatory</a> = <b>false</b>, <a href="/System.Management.Automation/A.html#91bee819daab0925" class="i property">ParameterSetName</a> = <span class="s">&quot;ByPath&quot;</span>)]
        [<span class="i">Parameter</span>(<a href="/System.Management.Automation/A.html#d5ad471518092731" class="i property">Mandatory</a> = <b>false</b>, <a href="/System.Management.Automation/A.html#91bee819daab0925" class="i property">ParameterSetName</a> = <span class="s">&quot;ByLiteralPath&quot;</span>)]
        <b>public</b> <a href="/System.Management.Automation/A.html#8260026027378f6c" class="t t">SwitchParameter</a> <a id="8c758ed63101c6df" href="../R/8c758ed63101c6df.html" target="n" data-glyph="102,1" class="i property">ClearCentralAccessPolicy</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#7d1e23c1c4134005" class="i field">_clearCentralAccessPolicy</a>;
            }
 
            <b>set</b>
            {
                <a href="#7d1e23c1c4134005" class="i field">_clearCentralAccessPolicy</a> = <b>value</b>;
            }
        }
 
        <b>private</b> <a href="/System.Management.Automation/A.html#8260026027378f6c" class="t t">SwitchParameter</a> <a id="283bf4b2bcfe9bfe" href="../R/283bf4b2bcfe9bfe.html" target="n" data-glyph="46,1" class="i field">_passthru</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets or sets the Passthru flag for the operation.</span>
        <span class="c">///</span><span class="c"> If true, the security descriptor is also passed</span>
        <span class="c">///</span><span class="c"> down the output pipeline.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>()]
        <b>public</b> <a href="/System.Management.Automation/A.html#8260026027378f6c" class="t t">SwitchParameter</a> <a id="e4ea69055bdcbd8b" href="../R/e4ea69055bdcbd8b.html" target="n" data-glyph="102,1" class="i property">Passthru</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#283bf4b2bcfe9bfe" class="i field">_passthru</a>;
            }
 
            <b>set</b>
            {
                <a href="#283bf4b2bcfe9bfe" class="i field">_passthru</a> = <b>value</b>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Returns a newly allocated SACL with no ACEs in it.</span>
        <span class="c">///</span><span class="c"> Free the returned SACL by calling Marshal.FreeHGlobal.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private static</b> <span class="i">IntPtr</span> <a id="1280f88d16207191" href="../R/1280f88d16207191.html" target="n" data-glyph="76,1" class="i method">GetEmptySacl</a>()
        {
            <span class="i">IntPtr</span> <span id="r56 rd" class="r56 r">pSacl</span> = <span class="i">IntPtr</span>.<span class="i">Zero</span>;
            <b>bool</b> <span id="r57 rd" class="r57 r">ret</span> = <b>true</b>;
 
            <b>try</b>
            {
                <span class="c">// Calculate the size of the empty SACL, align to DWORD.</span>
                <b>uint</b> <span id="r58 rd" class="r58 r">saclSize</span> = (<b>uint</b>)(<span class="i">Marshal</span>.<span class="i">SizeOf</span>(<b>new</b> <span class="i">NativeMethods</span>.<span class="i">ACL</span>()) +
                    <span class="i">Marshal</span>.<span class="i">SizeOf</span>(<b>new</b> <b>uint</b>()) - 1) &amp; 0xFFFFFFFC;
                <span class="i n">Dbg</span>.<span class="i">Diagnostics</span>.<span class="i">Assert</span>(<span class="r58 r">saclSize</span> &lt; 0xFFFF,
                    <span class="s">&quot;Acl size must be less than max SD size of 0xFFFF&quot;</span>);
 
                <span class="c">// Allocate and initialize the SACL.</span>
                <span class="r56 r">pSacl</span> = <span class="i">Marshal</span>.<span class="i">AllocHGlobal</span>((<b>int</b>)<span class="r58 r">saclSize</span>);
                <span class="r57 r">ret</span> = <span class="i">NativeMethods</span>.<span class="i">InitializeAcl</span>(
                    <span class="r56 r">pSacl</span>,
                    <span class="r58 r">saclSize</span>,
                    <span class="i">NativeMethods</span>.<span class="i">ACL_REVISION</span>);
                <b>if</b> (!<span class="r57 r">ret</span>)
                {
                    <b>throw</b> <b>new</b> <span class="i">Win32Exception</span>(<span class="i">Marshal</span>.<span class="i">GetLastWin32Error</span>());
                }
            }
            <b>finally</b>
            {
                <b>if</b> (!<span class="r57 r">ret</span>)
                {
                    <span class="i">Marshal</span>.<span class="i">FreeHGlobal</span>(<span class="r56 r">pSacl</span>);
                    <span class="r56 r">pSacl</span> = <span class="i">IntPtr</span>.<span class="i">Zero</span>;
                }
            }
 
            <b>return</b> <span class="r56 r">pSacl</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Returns a newly allocated SACL with the supplied CAPID in it.</span>
        <span class="c">///</span><span class="c"> Free the returned SACL by calling Marshal.FreeHGlobal.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Function &#39;LsaQueryCAPs&#39; is not available in OneCoreUAP and NanoServer.</span>
        <span class="c">///</span><span class="c"> So the parameter &quot;-CentralAccessPolicy&quot; is not supported on OneCore powershell,</span>
        <span class="c">///</span><span class="c"> and thus this method won&#39;t be hit in OneCore powershell.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>private</b> <span class="i">IntPtr</span> <a id="c00d7ab6dcda1897" href="../R/c00d7ab6dcda1897.html" target="n" data-glyph="76,1" class="i method">GetSaclWithCapId</a>(<b>string</b> <span id="r59 rd" class="r59 r">capStr</span>)
        {
            <span class="i">IntPtr</span> <span id="r60 rd" class="r60 r">pCapId</span> = <span class="i">IntPtr</span>.<span class="i">Zero</span>, <span id="r61 rd" class="r61 r">pSacl</span> = <span class="i">IntPtr</span>.<span class="i">Zero</span>;
            <span class="i">IntPtr</span> <span id="r62 rd" class="r62 r">caps</span> = <span class="i">IntPtr</span>.<span class="i">Zero</span>;
            <b>bool</b> <span id="r63 rd" class="r63 r">ret</span> = <b>true</b>, <span id="r64 rd" class="r64 r">freeCapId</span> = <b>true</b>;
            <b>uint</b> <span id="r65 rd" class="r65 r">rs</span> = <span class="i">NativeMethods</span>.<span class="i">STATUS_SUCCESS</span>;
 
            <b>try</b>
            {
                <span class="c">// Convert the supplied SID from string to binary form.</span>
                <span class="r63 r">ret</span> = <span class="i">NativeMethods</span>.<span class="i">ConvertStringSidToSid</span>(<span class="r59 r">capStr</span>, <b>out</b> <span class="r60 r">pCapId</span>);
                <b>if</b> (!<span class="r63 r">ret</span>)
                {
                    <span class="c">// We may have got a CAP friendly name instead of CAPID.</span>
                    <span class="c">// Enumerate all CAPs on the system and try to find one with</span>
                    <span class="c">// a matching friendly name.</span>
                    <span class="c">// If we retrieve the CAPID from the LSA, the CAPID need not</span>
                    <span class="c">// be deallocated separately (but with the entire buffer</span>
                    <span class="c">// returned by LsaQueryCAPs).</span>
                    <span class="r64 r">freeCapId</span> = <b>false</b>;
                    <span class="r65 r">rs</span> = <span class="i">NativeMethods</span>.<span class="i">LsaQueryCAPs</span>(
                        <b>null</b>,
                        0,
                        <b>out</b> <span class="r62 r">caps</span>,
                        <b>out uint</b> <span id="r66 rd" class="r66 r">capCount</span>);
                    <b>if</b> (<span class="r65 r">rs</span> != <span class="i">NativeMethods</span>.<span class="i">STATUS_SUCCESS</span>)
                    {
                        <b>throw</b> <b>new</b> <span class="i">Win32Exception</span>((<b>int</b>)<span class="r65 r">rs</span>);
                    }
 
                    <span class="i n">Dbg</span>.<span class="i">Diagnostics</span>.<span class="i">Assert</span>(<span class="r66 r">capCount</span> &lt; 0xFFFF,
                        <span class="s">&quot;Too many central access policies&quot;</span>);
                    <b>if</b> (<span class="r66 r">capCount</span> == 0 || <span class="r62 r">caps</span> == <span class="i">IntPtr</span>.<span class="i">Zero</span>)
                    {
                        <b>return</b> <span class="i">IntPtr</span>.<span class="i">Zero</span>;
                    }
 
                    <span class="c">// Find the supplied string among available CAP names, use the corresponding CAPID.</span>
                    <span class="i">IntPtr</span> <span id="r67 rd" class="r67 r">capPtr</span> = <span class="r62 r">caps</span>;
                    <b>for</b> (<b>uint</b> <span id="r68 rd" class="r68 r">capIdx</span> = 0; <span class="r68 r">capIdx</span> &lt; <span class="r66 r">capCount</span>; <span class="r68 r">capIdx</span>++)
                    {
                        <span class="i n">Dbg</span>.<span class="i">Diagnostics</span>.<span class="i">Assert</span>(<span class="r67 r">capPtr</span> != <span class="i">IntPtr</span>.<span class="i">Zero</span>,
                            <span class="s">&quot;Invalid central access policies array&quot;</span>);
                        <span class="i">NativeMethods</span>.<span class="i">CENTRAL_ACCESS_POLICY</span> <span id="r69 rd" class="r69 r">cap</span> = <span class="i">Marshal</span>.<span class="i">PtrToStructure</span>&lt;<span class="i">NativeMethods</span>.<span class="i">CENTRAL_ACCESS_POLICY</span>&gt;(<span class="r67 r">capPtr</span>);
                        <span class="c">// LSA_UNICODE_STRING is composed of WCHARs, but its length is given in bytes.</span>
                        <b>string</b> <span id="r70 rd" class="r70 r">capName</span> = <span class="i">Marshal</span>.<span class="i">PtrToStringUni</span>(
                            <span class="r69 r">cap</span>.<span class="i">Name</span>.<span class="i">Buffer</span>,
                            <span class="r69 r">cap</span>.<span class="i">Name</span>.<span class="i">Length</span> / 2);
                        <b>if</b> (<span class="r70 r">capName</span>.<span class="i">Equals</span>(<span class="r59 r">capStr</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
                        {
                            <span class="r60 r">pCapId</span> = <span class="r69 r">cap</span>.<span class="i">CAPID</span>;
                            <b>break</b>;
                        }
 
                        <span class="r67 r">capPtr</span> += <span class="i">Marshal</span>.<span class="i">SizeOf</span>(<span class="r69 r">cap</span>);
                    }
                }
 
                <b>if</b> (<span class="r60 r">pCapId</span> == <span class="i">IntPtr</span>.<span class="i">Zero</span>)
                {
                    <span class="i">Exception</span> <span id="r71 rd" class="r71 r">e</span> = <b>new</b> <span class="i">ArgumentException</span>(<span class="i">UtilsStrings</span>.<span class="i">InvalidCentralAccessPolicyIdentifier</span>);
                    <span class="i">WriteError</span>(<b>new</b> <span class="t">ErrorRecord</span>(
                        <span class="r71 r">e</span>,
                        <span class="s">&quot;SetAcl_CentralAccessPolicy&quot;</span>,
                        <a href="/System.Management.Automation/A.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="/System.Management.Automation/A.html#846d2b572f2c4820" class="i field">InvalidArgument</a>,
                        <a href="#b535fa95beb8748a" class="i property">AclObject</a>));
                    <b>return</b> <span class="i">IntPtr</span>.<span class="i">Zero</span>;
                }
 
                <span class="r63 r">ret</span> = <span class="i">NativeMethods</span>.<span class="i">IsValidSid</span>(<span class="r60 r">pCapId</span>);
                <b>if</b> (!<span class="r63 r">ret</span>)
                {
                    <b>throw</b> <b>new</b> <span class="i">Win32Exception</span>(<span class="i">Marshal</span>.<span class="i">GetLastWin32Error</span>());
                }
 
                <b>uint</b> <span id="r72 rd" class="r72 r">sidSize</span> = <span class="i">NativeMethods</span>.<span class="i">GetLengthSid</span>(<span class="r60 r">pCapId</span>);
 
                <span class="c">// Calculate the size of the SACL with one CAPID ACE, align to DWORD.</span>
                <b>uint</b> <span id="r73 rd" class="r73 r">saclSize</span> = (<b>uint</b>)(<span class="i">Marshal</span>.<span class="i">SizeOf</span>(<b>new</b> <span class="i">NativeMethods</span>.<span class="i">ACL</span>()) +
                    <span class="i">Marshal</span>.<span class="i">SizeOf</span>(<b>new</b> <span class="i">NativeMethods</span>.<span class="i">SYSTEM_AUDIT_ACE</span>()) +
                    <span class="r72 r">sidSize</span> - 1) &amp; 0xFFFFFFFC;
                <span class="i n">Dbg</span>.<span class="i">Diagnostics</span>.<span class="i">Assert</span>(<span class="r73 r">saclSize</span> &lt; 0xFFFF,
                    <span class="s">&quot;Acl size must be less than max SD size of 0xFFFF&quot;</span>);
 
                <span class="c">// Allocate and initialize the SACL.</span>
                <span class="r61 r">pSacl</span> = <span class="i">Marshal</span>.<span class="i">AllocHGlobal</span>((<b>int</b>)<span class="r73 r">saclSize</span>);
                <span class="r63 r">ret</span> = <span class="i">NativeMethods</span>.<span class="i">InitializeAcl</span>(
                    <span class="r61 r">pSacl</span>,
                    <span class="r73 r">saclSize</span>,
                    <span class="i">NativeMethods</span>.<span class="i">ACL_REVISION</span>);
                <b>if</b> (!<span class="r63 r">ret</span>)
                {
                    <b>throw</b> <b>new</b> <span class="i">Win32Exception</span>(<span class="i">Marshal</span>.<span class="i">GetLastWin32Error</span>());
                }
 
                <span class="c">// Add CAPID to the SACL.</span>
                <span class="r65 r">rs</span> = <span class="i">NativeMethods</span>.<span class="i">AddScopedPolicyIDAce</span>(
                    <span class="r61 r">pSacl</span>,
                    <span class="i">NativeMethods</span>.<span class="i">ACL_REVISION</span>,
                    <span class="i">NativeMethods</span>.<span class="i">SUB_CONTAINERS_AND_OBJECTS_INHERIT</span>,
                    0,
                    <span class="r60 r">pCapId</span>);
                <b>if</b> (<span class="r65 r">rs</span> != <span class="i">NativeMethods</span>.<span class="i">STATUS_SUCCESS</span>)
                {
                    <b>if</b> (<span class="r65 r">rs</span> == <span class="i">NativeMethods</span>.<span class="i">STATUS_INVALID_PARAMETER</span>)
                    {
                        <b>throw</b> <b>new</b> <span class="i">ArgumentException</span>(<span class="i">UtilsStrings</span>.<span class="i">InvalidCentralAccessPolicyIdentifier</span>);
                    }
                    <b>else</b>
                    {
                        <b>throw</b> <b>new</b> <span class="i">Win32Exception</span>((<b>int</b>)<span class="r65 r">rs</span>);
                    }
                }
            }
            <b>finally</b>
            {
                <b>if</b> (!<span class="r63 r">ret</span> || <span class="r65 r">rs</span> != <span class="i">NativeMethods</span>.<span class="i">STATUS_SUCCESS</span>)
                {
                    <span class="i">Marshal</span>.<span class="i">FreeHGlobal</span>(<span class="r61 r">pSacl</span>);
                    <span class="r61 r">pSacl</span> = <span class="i">IntPtr</span>.<span class="i">Zero</span>;
                }
 
                <span class="r65 r">rs</span> = <span class="i">NativeMethods</span>.<span class="i">LsaFreeMemory</span>(<span class="r62 r">caps</span>);
                <span class="i n">Dbg</span>.<span class="i">Diagnostics</span>.<span class="i">Assert</span>(<span class="r65 r">rs</span> == <span class="i">NativeMethods</span>.<span class="i">STATUS_SUCCESS</span>,
                    <span class="s">&quot;LsaFreeMemory failed: &quot;</span> + <span class="r65 r">rs</span>.<span class="i">ToString</span>(<span class="i">CultureInfo</span>.<span class="i">CurrentCulture</span>));
                <b>if</b> (<span class="r64 r">freeCapId</span>)
                {
                    <span class="i">NativeMethods</span>.<span class="i">LocalFree</span>(<span class="r60 r">pCapId</span>);
                }
            }
 
            <b>return</b> <span class="r61 r">pSacl</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Returns the current thread or process token with the specified privilege enabled</span>
        <span class="c">///</span><span class="c"> and the previous state of this privilege. Free the returned token</span>
        <span class="c">///</span><span class="c"> by calling NativeMethods.CloseHandle.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private static</b> <span class="i">IntPtr</span> <a id="e65bac9de7a80ba5" href="../R/e65bac9de7a80ba5.html" target="n" data-glyph="76,1" class="i method">GetTokenWithEnabledPrivilege</a>(
            <b>string</b> <span id="r74 rd" class="r74 r">privilege</span>,
            <span class="i">NativeMethods</span>.<span class="i">TOKEN_PRIVILEGE</span> <span id="r75 rd" class="r75 r">previousState</span>)
        {
            <span class="i">IntPtr</span> <span id="r76 rd" class="r76 r">pToken</span> = <span class="i">IntPtr</span>.<span class="i">Zero</span>;
            <b>bool</b> <span id="r77 rd" class="r77 r">ret</span> = <b>true</b>;
 
            <b>try</b>
            {
                <span class="c">// First try to open the thread token for privilege adjustment.</span>
                <span class="r77 r">ret</span> = <span class="i">NativeMethods</span>.<span class="i">OpenThreadToken</span>(
                    <span class="i">NativeMethods</span>.<span class="i">GetCurrentThread</span>(),
                    <span class="i">NativeMethods</span>.<span class="i">TOKEN_QUERY</span> | <span class="i">NativeMethods</span>.<span class="i">TOKEN_ADJUST_PRIVILEGES</span>,
                    <b>true</b>,
                    <b>out</b> <span class="r76 r">pToken</span>);
 
                <b>if</b> (!<span class="r77 r">ret</span>)
                {
                    <b>if</b> (<span class="i">Marshal</span>.<span class="i">GetLastWin32Error</span>() == <span class="i">NativeMethods</span>.<span class="i">ERROR_NO_TOKEN</span>)
                    {
                        <span class="c">// Client is not impersonating. Open the process token.</span>
                        <span class="r77 r">ret</span> = <span class="i">NativeMethods</span>.<span class="i">OpenProcessToken</span>(
                            <span class="i">NativeMethods</span>.<span class="i">GetCurrentProcess</span>(),
                            <span class="i">NativeMethods</span>.<span class="i">TOKEN_QUERY</span> | <span class="i">NativeMethods</span>.<span class="i">TOKEN_ADJUST_PRIVILEGES</span>,
                            <b>out</b> <span class="r76 r">pToken</span>);
                    }
 
                    <b>if</b> (!<span class="r77 r">ret</span>)
                    {
                        <b>throw</b> <b>new</b> <span class="i">Win32Exception</span>(<span class="i">Marshal</span>.<span class="i">GetLastWin32Error</span>());
                    }
                }
 
                <span class="c">// Get the LUID of the specified privilege.</span>
                <span class="i">NativeMethods</span>.<span class="i">LUID</span> <span id="r78 rd" class="r78 r">luid</span> = <b>new</b>();
                <span class="r77 r">ret</span> = <span class="i">NativeMethods</span>.<span class="i">LookupPrivilegeValue</span>(
                    <b>null</b>,
                    <span class="r74 r">privilege</span>,
                    <b>ref</b> <span class="r78 r">luid</span>);
                <b>if</b> (!<span class="r77 r">ret</span>)
                {
                    <b>throw</b> <b>new</b> <span class="i">Win32Exception</span>(<span class="i">Marshal</span>.<span class="i">GetLastWin32Error</span>());
                }
 
                <span class="c">// Enable the privilege.</span>
                <span class="i">NativeMethods</span>.<span class="i">TOKEN_PRIVILEGE</span> <span id="r79 rd" class="r79 r">newState</span> = <b>new</b>();
                <span class="r79 r">newState</span>.<span class="i">PrivilegeCount</span> = 1;
                <span class="r79 r">newState</span>.<span class="i">Privilege</span>.<span class="i">Attributes</span> = <span class="i">NativeMethods</span>.<span class="i">SE_PRIVILEGE_ENABLED</span>;
                <span class="r79 r">newState</span>.<span class="i">Privilege</span>.<span class="i">Luid</span> = <span class="r78 r">luid</span>;
                <b>uint</b> <span id="r80 rd" class="r80 r">previousSize</span> = 0;
                <span class="r77 r">ret</span> = <span class="i">NativeMethods</span>.<span class="i">AdjustTokenPrivileges</span>(
                    <span class="r76 r">pToken</span>,
                    <b>false</b>,
                    <b>ref</b> <span class="r79 r">newState</span>,
                    (<b>uint</b>)<span class="i">Marshal</span>.<span class="i">SizeOf</span>(<span class="r75 r">previousState</span>),
                    <b>ref</b> <span class="r75 r">previousState</span>,
                    <b>ref</b> <span class="r80 r">previousSize</span>);
                <b>if</b> (!<span class="r77 r">ret</span>)
                {
                    <b>throw</b> <b>new</b> <span class="i">Win32Exception</span>(<span class="i">Marshal</span>.<span class="i">GetLastWin32Error</span>());
                }
            }
            <b>finally</b>
            {
                <b>if</b> (!<span class="r77 r">ret</span>)
                {
                    <span class="i">NativeMethods</span>.<span class="i">CloseHandle</span>(<span class="r76 r">pToken</span>);
                    <span class="r76 r">pToken</span> = <span class="i">IntPtr</span>.<span class="i">Zero</span>;
                }
            }
 
            <b>return</b> <span class="r76 r">pToken</span>;
        }
 
        <span class="c">///</span><span class="c"> Processes records from the input pipeline.</span>
        <span class="c">///</span><span class="c"> For each input file, the command sets its</span>
        <span class="c">///</span><span class="c"> security descriptor to the specified</span>
        <span class="c">///</span><span class="c"> Access Control List (ACL).</span>
        <b>protected override void</b> <a id="052cdfdec4744514" href="../R/052cdfdec4744514.html" target="n" data-glyph="75,1" class="i method">ProcessRecord</a>()
        {
            <span class="i">ObjectSecurity</span> <span id="r81 rd" class="r81 r">aclObjectSecurity</span> = <a href="#abc54c2b72cb7d74" class="i field">_securityDescriptor</a> <b>as</b> <span class="i">ObjectSecurity</span>;
 
            <b>if</b> (<a href="#9088ccd85b7ff35e" class="i field">_inputObject</a> != <b>null</b>)
            {
                <a href="/System.Management.Automation/A.html#19eeb66bf76c933c" class="t t">PSMethodInfo</a> <span id="r82 rd" class="r82 r">methodInfo</span> = <a href="#9088ccd85b7ff35e" class="i field">_inputObject</a>.<a href="/System.Management.Automation/A.html#6cb42c4e7cce30cd" class="i property">Methods</a>[<span class="s">&quot;SetSecurityDescriptor&quot;</span>];
 
                <b>if</b> (<span class="r82 r">methodInfo</span> != <b>null</b>)
                {
                    <b>string</b> <span id="r83 rd" class="r83 r">sddl</span>;
 
                    <b>if</b> (<span class="r81 r">aclObjectSecurity</span> != <b>null</b>)
                    {
                        <span class="r83 r">sddl</span> = <span class="r81 r">aclObjectSecurity</span>.<span class="i">GetSecurityDescriptorSddlForm</span>(<span class="i">AccessControlSections</span>.<span class="i">All</span>);
                    }
                    <b>else</b> <b>if</b> (<a href="#abc54c2b72cb7d74" class="i field">_securityDescriptor</a> <b>is</b> <span class="i">CommonSecurityDescriptor</span> <span id="r84 rd" class="r84 r">aclCommonSD</span>)
                    {
                        <span class="r83 r">sddl</span> = <span class="r84 r">aclCommonSD</span>.<span class="i">GetSddlForm</span>(<span class="i">AccessControlSections</span>.<span class="i">All</span>);
                    }
                    <b>else</b>
                    {
                        <span class="i">Exception</span> <span id="r85 rd" class="r85 r">e</span> = <b>new</b> <span class="i">ArgumentException</span>(<span class="s">&quot;AclObject&quot;</span>);
                        <span class="i">WriteError</span>(<b>new</b> <span class="t">ErrorRecord</span>(
                            <span class="r85 r">e</span>,
                            <span class="s">&quot;SetAcl_AclObject&quot;</span>,
                            <a href="/System.Management.Automation/A.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="/System.Management.Automation/A.html#846d2b572f2c4820" class="i field">InvalidArgument</a>,
                            <a href="#b535fa95beb8748a" class="i property">AclObject</a>));
                        <b>return</b>;
                    }
 
                    <b>try</b>
                    {
                        <span class="r82 r">methodInfo</span>.<span class="i">Invoke</span>(<span class="r83 r">sddl</span>);
                    }
                    <b>catch</b> (<span class="i">Exception</span>)
                    {
                        <span class="c">// Calling user code, Catch-all OK</span>
                        <a href="/System.Management.Automation/A.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r86 rd" class="r86 r">er</span> =
                        <a href="Utils.cs.html#aac1e7d3ed49e313" class="t t">SecurityUtils</a>.<span class="i">CreateNotSupportedErrorRecord</span>(
                            <span class="i">UtilsStrings</span>.<span class="i">MethodInvokeFail</span>,
                            <span class="s">&quot;SetAcl_OperationNotSupported&quot;</span>
                            );
 
                        <span class="i">WriteError</span>(<span class="r86 r">er</span>);
                        <b>return</b>;
                    }
                }
                <b>else</b>
                {
                    <a href="/System.Management.Automation/A.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r87 rd" class="r87 r">er</span> =
                        <a href="Utils.cs.html#aac1e7d3ed49e313" class="t t">SecurityUtils</a>.<span class="i">CreateNotSupportedErrorRecord</span>(
                            <span class="i">UtilsStrings</span>.<span class="i">SetMethodNotFound</span>,
                            <span class="s">&quot;SetAcl_OperationNotSupported&quot;</span>
                            );
 
                    <span class="i">WriteError</span>(<span class="r87 r">er</span>);
                }
            }
            <b>else</b>
            {
                <b>if</b> (<a href="#bb8b5524fbe61341" class="i property">Path</a> == <b>null</b>)
                {
                    <span class="i">Exception</span> <span id="r88 rd" class="r88 r">e</span> = <b>new</b> <span class="i">ArgumentException</span>(<span class="s">&quot;Path&quot;</span>);
                    <span class="i">WriteError</span>(<b>new</b> <span class="t">ErrorRecord</span>(
                        <span class="r88 r">e</span>,
                        <span class="s">&quot;SetAcl_Path&quot;</span>,
                        <a href="/System.Management.Automation/A.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="/System.Management.Automation/A.html#846d2b572f2c4820" class="i field">InvalidArgument</a>,
                        <a href="#b535fa95beb8748a" class="i property">AclObject</a>));
                    <b>return</b>;
                }
 
                <b>if</b> (<span class="r81 r">aclObjectSecurity</span> == <b>null</b>)
                {
                    <span class="i">Exception</span> <span id="r89 rd" class="r89 r">e</span> = <b>new</b> <span class="i">ArgumentException</span>(<span class="s">&quot;AclObject&quot;</span>);
                    <span class="i">WriteError</span>(<b>new</b> <span class="t">ErrorRecord</span>(
                        <span class="r89 r">e</span>,
                        <span class="s">&quot;SetAcl_AclObject&quot;</span>,
                        <a href="/System.Management.Automation/A.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="/System.Management.Automation/A.html#846d2b572f2c4820" class="i field">InvalidArgument</a>,
                        <a href="#b535fa95beb8748a" class="i property">AclObject</a>));
                    <b>return</b>;
                }
 
                <b>if</b> (<a href="#ba26861a6cbc8ba0" class="i property">CentralAccessPolicy</a> != <b>null</b> || <a href="#8c758ed63101c6df" class="i property">ClearCentralAccessPolicy</a>)
                {
                    <b>if</b> (!<a href="CertificateProvider.cs.html#9088e9d56a46b577" class="t t">DownLevelHelper</a>.<a href="CertificateProvider.cs.html#f7281b68fbd9aaff" class="i method">IsWin8AndAbove</a>())
                    {
                        <span class="i">Exception</span> <span id="r90 rd" class="r90 r">e</span> = <b>new</b> <span class="t">ParameterBindingException</span>();
                        <span class="i">WriteError</span>(<b>new</b> <span class="t">ErrorRecord</span>(
                            <span class="r90 r">e</span>,
                            <span class="s">&quot;SetAcl_OperationNotSupported&quot;</span>,
                            <a href="/System.Management.Automation/A.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="/System.Management.Automation/A.html#846d2b572f2c4820" class="i field">InvalidArgument</a>,
                            <b>null</b>));
                        <b>return</b>;
                    }
                }
 
                <b>if</b> (<a href="#ba26861a6cbc8ba0" class="i property">CentralAccessPolicy</a> != <b>null</b> &amp;&amp; <a href="#8c758ed63101c6df" class="i property">ClearCentralAccessPolicy</a>)
                {
                    <span class="i">Exception</span> <span id="r91 rd" class="r91 r">e</span> = <b>new</b> <span class="i">ArgumentException</span>(<span class="i">UtilsStrings</span>.<span class="i">InvalidCentralAccessPolicyParameters</span>);
                    <a href="/System.Management.Automation/A.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r92 rd" class="r92 r">er</span> =
                    <a href="Utils.cs.html#aac1e7d3ed49e313" class="t t">SecurityUtils</a>.<a href="Utils.cs.html#634e74d2b11b83a7" class="i method">CreateInvalidArgumentErrorRecord</a>(
                        <span class="r91 r">e</span>,
                        <span class="s">&quot;SetAcl_OperationNotSupported&quot;</span>
                        );
 
                    <span class="i">WriteError</span>(<span class="r92 r">er</span>);
                    <b>return</b>;
                }
 
                <span class="i">IntPtr</span> <span id="r93 rd" class="r93 r">pSacl</span> = <span class="i">IntPtr</span>.<span class="i">Zero</span>;
                <span class="i">NativeMethods</span>.<span class="i">TOKEN_PRIVILEGE</span> <span id="r94 rd" class="r94 r">previousState</span> = <b>new</b>();
                <b>try</b>
                {
                    <b>if</b> (<a href="#ba26861a6cbc8ba0" class="i property">CentralAccessPolicy</a> != <b>null</b>)
                    {
                        <span class="r93 r">pSacl</span> = <a href="#c00d7ab6dcda1897" class="i method">GetSaclWithCapId</a>(<a href="#ba26861a6cbc8ba0" class="i property">CentralAccessPolicy</a>);
                        <b>if</b> (<span class="r93 r">pSacl</span> == <span class="i">IntPtr</span>.<span class="i">Zero</span>)
                        {
                            <span class="i">SystemException</span> <span id="r95 rd" class="r95 r">e</span> = <b>new</b>(<span class="i">UtilsStrings</span>.<span class="i">GetSaclWithCapIdFail</span>);
                            <span class="i">WriteError</span>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r95 r">e</span>,
                                                        <span class="s">&quot;SetAcl_CentralAccessPolicy&quot;</span>,
                                                        <a href="/System.Management.Automation/A.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="/System.Management.Automation/A.html#f33f25c3453e2e98" class="i field">InvalidResult</a>,
                                                        <b>null</b>));
                            <b>return</b>;
                        }
                    }
                    <b>else</b> <b>if</b> (<a href="#8c758ed63101c6df" class="i property">ClearCentralAccessPolicy</a>)
                    {
                        <span class="r93 r">pSacl</span> = <a href="#1280f88d16207191" class="i method">GetEmptySacl</a>();
                        <b>if</b> (<span class="r93 r">pSacl</span> == <span class="i">IntPtr</span>.<span class="i">Zero</span>)
                        {
                            <span class="i">SystemException</span> <span id="r96 rd" class="r96 r">e</span> = <b>new</b>(<span class="i">UtilsStrings</span>.<span class="i">GetEmptySaclFail</span>);
                            <span class="i">WriteError</span>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r96 r">e</span>,
                                                        <span class="s">&quot;SetAcl_ClearCentralAccessPolicy&quot;</span>,
                                                        <a href="/System.Management.Automation/A.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="/System.Management.Automation/A.html#f33f25c3453e2e98" class="i field">InvalidResult</a>,
                                                        <b>null</b>));
                            <b>return</b>;
                        }
                    }
 
                    <b>foreach</b> (<b>string</b> <span id="r97 rd" class="r97 r">p</span> <b>in</b> <a href="#bb8b5524fbe61341" class="i property">Path</a>)
                    {
                        <span class="i">Collection</span>&lt;<a href="/System.Management.Automation/A.html#9504cfb54420cfd7" class="t t">PathInfo</a>&gt; <span id="r98 rd" class="r98 r">pathsToProcess</span> = <b>new</b>();
 
                        <span class="i">CmdletProviderContext</span> <span id="r99 rd" class="r99 r">context</span> = <a href="#9bc17f1787578929" class="k">this</a>.<a href="#678521eeda8094cc" class="i property">CmdletProviderContext</a>;
                        <span class="r99 r">context</span>.<span class="i">PassThru</span> = <a href="#e4ea69055bdcbd8b" class="i property">Passthru</a>;
                        <b>if</b> (<a href="#ce38e49656fb7768" class="i field">_isLiteralPath</a>)
                        {
                            <b>string</b> <span id="r100 rd" class="r100 r">pathStr</span> = <a href="/System.Management.Automation/A.html#5078d443148de142" class="i property">SessionState</a>.<a href="/System.Management.Automation/A.html#3390cfbbdcffb036" class="i property">Path</a>.<span class="i">GetUnresolvedProviderPathFromPSPath</span>(
                                <span class="r97 r">p</span>, <b>out</b> <a href="/System.Management.Automation/A.html#dd4e1f2f8e73a1dd" class="t t">ProviderInfo</a> <span id="r101 rd" class="r101 r">Provider</span>, <b>out</b> <a href="/System.Management.Automation/A.html#2d16b26a541ba185" class="t t">PSDriveInfo</a> <span id="r102 rd" class="r102 r">Drive</span>);
                            <span class="r98 r">pathsToProcess</span>.<span class="i">Add</span>(<b>new</b> <span class="t">PathInfo</span>(<span class="r102 r">Drive</span>, <span class="r101 r">Provider</span>, <span class="r100 r">pathStr</span>, <a href="/System.Management.Automation/A.html#5078d443148de142" class="i property">SessionState</a>));
                            <span class="r99 r">context</span>.<span class="i">SuppressWildcardExpansion</span> = <b>true</b>;
                        }
                        <b>else</b>
                        {
                            <span class="r98 r">pathsToProcess</span> = <a href="/System.Management.Automation/A.html#5078d443148de142" class="i property">SessionState</a>.<a href="/System.Management.Automation/A.html#3390cfbbdcffb036" class="i property">Path</a>.<span class="i">GetResolvedPSPathFromPSPath</span>(<span class="r97 r">p</span>, <a href="#678521eeda8094cc" class="i property">CmdletProviderContext</a>);
                        }
 
                        <b>foreach</b> (<a href="/System.Management.Automation/A.html#9504cfb54420cfd7" class="t t">PathInfo</a> <span id="r103 rd" class="r103 r">pathInfo</span> <b>in</b> <span class="r98 r">pathsToProcess</span>)
                        {
                            <b>if</b> (<span class="i">ShouldProcess</span>(<span class="r103 r">pathInfo</span>.<a href="/System.Management.Automation/A.html#de00cd47bf0cf721" class="i property">Path</a>))
                            {
                                <b>try</b>
                                {
                                    <a href="/System.Management.Automation/A.html#0a0ac63de22d06f8" class="i property">InvokeProvider</a>.<a href="/System.Management.Automation/A.html#8803a1d728bb633f" class="i property">SecurityDescriptor</a>.<span class="i">Set</span>(<span class="r103 r">pathInfo</span>.<a href="/System.Management.Automation/A.html#de00cd47bf0cf721" class="i property">Path</a>,
                                                                          <span class="r81 r">aclObjectSecurity</span>,
                                                                          <span class="r99 r">context</span>);
 
                                    <b>if</b> (<a href="#ba26861a6cbc8ba0" class="i property">CentralAccessPolicy</a> != <b>null</b> || <a href="#8c758ed63101c6df" class="i property">ClearCentralAccessPolicy</a>)
                                    {
                                        <b>if</b> (!<span class="r103 r">pathInfo</span>.<a href="/System.Management.Automation/A.html#223c6ebf64760c0d" class="i property">Provider</a>.<span class="i">NameEquals</span>(<span class="i">Context</span>.<span class="i">ProviderNames</span>.<span class="i">FileSystem</span>))
                                        {
                                            <span class="i">Exception</span> <span id="r104 rd" class="r104 r">e</span> = <b>new</b> <span class="i">ArgumentException</span>(<span class="s">&quot;Path&quot;</span>);
                                            <span class="i">WriteError</span>(<b>new</b> <span class="t">ErrorRecord</span>(
                                                <span class="r104 r">e</span>,
                                                <span class="s">&quot;SetAcl_Path&quot;</span>,
                                                <a href="/System.Management.Automation/A.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="/System.Management.Automation/A.html#846d2b572f2c4820" class="i field">InvalidArgument</a>,
                                                <a href="#b535fa95beb8748a" class="i property">AclObject</a>));
                                            <b>continue</b>;
                                        }
 
                                        <span class="c">// Enable the security privilege required to set SCOPE_SECURITY_INFORMATION.</span>
                                        <span class="i">IntPtr</span> <span id="r105 rd" class="r105 r">pToken</span> = <a href="#e65bac9de7a80ba5" class="i method">GetTokenWithEnabledPrivilege</a>(<span class="s">&quot;SeSecurityPrivilege&quot;</span>, <span class="r94 r">previousState</span>);
                                        <b>if</b> (<span class="r105 r">pToken</span> == <span class="i">IntPtr</span>.<span class="i">Zero</span>)
                                        {
                                            <span class="i">SystemException</span> <span id="r106 rd" class="r106 r">e</span> = <b>new</b>(<span class="i">UtilsStrings</span>.<span class="i">GetTokenWithEnabledPrivilegeFail</span>);
                                            <span class="i">WriteError</span>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r106 r">e</span>,
                                                                        <span class="s">&quot;SetAcl_AdjustTokenPrivileges&quot;</span>,
                                                                        <a href="/System.Management.Automation/A.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="/System.Management.Automation/A.html#f33f25c3453e2e98" class="i field">InvalidResult</a>,
                                                                        <b>null</b>));
                                            <b>return</b>;
                                        }
 
                                        <span class="c">// Set the file&#39;s CAPID.</span>
                                        <b>uint</b> <span id="r107 rd" class="r107 r">rs</span> = <span class="i">NativeMethods</span>.<span class="i">SetNamedSecurityInfo</span>(
                                            <span class="r103 r">pathInfo</span>.<a href="/System.Management.Automation/A.html#16e3fcd7f95c1bfc" class="i property">ProviderPath</a>,
                                            <span class="i">NativeMethods</span>.<span class="i">SeObjectType</span>.<span class="i">SE_FILE_OBJECT</span>,
                                            <span class="i">NativeMethods</span>.<span class="i">SecurityInformation</span>.<span class="i">SCOPE_SECURITY_INFORMATION</span>,
                                            <span class="i">IntPtr</span>.<span class="i">Zero</span>,
                                            <span class="i">IntPtr</span>.<span class="i">Zero</span>,
                                            <span class="i">IntPtr</span>.<span class="i">Zero</span>,
                                            <span class="r93 r">pSacl</span>);
 
                                        <span class="c">// Restore privileges to the previous state.</span>
                                        <b>if</b> (<span class="r105 r">pToken</span> != <span class="i">IntPtr</span>.<span class="i">Zero</span>)
                                        {
                                            <span class="i">NativeMethods</span>.<span class="i">TOKEN_PRIVILEGE</span> <span id="r108 rd" class="r108 r">newState</span> = <b>new</b>();
                                            <b>uint</b> <span id="r109 rd" class="r109 r">newSize</span> = 0;
                                            <span class="i">NativeMethods</span>.<span class="i">AdjustTokenPrivileges</span>(
                                                <span class="r105 r">pToken</span>,
                                                <b>false</b>,
                                                <b>ref</b> <span class="r94 r">previousState</span>,
                                                (<b>uint</b>)<span class="i">Marshal</span>.<span class="i">SizeOf</span>(<span class="r108 r">newState</span>),
                                                <b>ref</b> <span class="r108 r">newState</span>,
                                                <b>ref</b> <span class="r109 r">newSize</span>);
 
                                            <span class="i">NativeMethods</span>.<span class="i">CloseHandle</span>(<span class="r105 r">pToken</span>);
                                            <span class="r105 r">pToken</span> = <span class="i">IntPtr</span>.<span class="i">Zero</span>;
                                        }
 
                                        <b>if</b> (<span class="r107 r">rs</span> != <span class="i">NativeMethods</span>.<span class="i">ERROR_SUCCESS</span>)
                                        {
                                            <span class="i">Exception</span> <span id="r110 rd" class="r110 r">e</span> = <b>new</b> <span class="i">Win32Exception</span>(
                                                (<b>int</b>)<span class="r107 r">rs</span>,
                                                <span class="i">UtilsStrings</span>.<span class="i">SetCentralAccessPolicyFail</span>);
                                            <span class="i">WriteError</span>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r110 r">e</span>,
                                                                       <span class="s">&quot;SetAcl_SetNamedSecurityInfo&quot;</span>,
                                                                       <a href="/System.Management.Automation/A.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="/System.Management.Automation/A.html#f33f25c3453e2e98" class="i field">InvalidResult</a>,
                                                                       <b>null</b>));
                                        }
                                    }
                                }
                                <b>catch</b> (<span class="i">NotSupportedException</span>)
                                {
                                    <a href="/System.Management.Automation/A.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r111 rd" class="r111 r">er</span> =
                                        <a href="Utils.cs.html#aac1e7d3ed49e313" class="t t">SecurityUtils</a>.<span class="i">CreateNotSupportedErrorRecord</span>(
                                            <span class="i">UtilsStrings</span>.<span class="i">OperationNotSupportedOnPath</span>,
                                            <span class="s">&quot;SetAcl_OperationNotSupported&quot;</span>,
                                            <span class="r103 r">pathInfo</span>.<a href="/System.Management.Automation/A.html#de00cd47bf0cf721" class="i property">Path</a>
                                        );
 
                                    <span class="i">WriteError</span>(<span class="r111 r">er</span>);
                                }
                            }
                        }
                    }
                }
                <b>finally</b>
                {
                    <span class="i">Marshal</span>.<span class="i">FreeHGlobal</span>(<span class="r93 r">pSacl</span>);
                }
            }
        }
    }
<span class="k preprocess">#</span><span class="k preprocess">endif</span> <span class="c">// !UNIX</span>
}
 
<span class="k preprocess">#</span><span class="k preprocess">pragma</span> <span class="k preprocess">warning</span> <span class="k preprocess">restore</span> 56506
</pre></td></tr></table></div></body></html>
