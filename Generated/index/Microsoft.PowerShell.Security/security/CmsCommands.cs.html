<!DOCTYPE html>
<html><head><title>CmsCommands.cs</title><link rel="stylesheet" href="../../styles.css"><script src="../../scripts.js"></script></head>
<body class="cB" onload="i(604);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#Microsoft.PowerShell.Security/security/CmsCommands.cs" target="_top">security\CmsCommands.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#Microsoft.PowerShell.Security" target="_top">src\Microsoft.PowerShell.Security\Microsoft.PowerShell.Security.csproj</a> (Microsoft.PowerShell.Security)</td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation.</span>
<span class="c">// Licensed under the MIT License.</span>
 
<b>using</b> <span class="i n">System</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Collections</span>.<span class="i">Generic</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Collections</span>.<span class="i">ObjectModel</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Globalization</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Security</span>.<span class="i">Cryptography</span>.<span class="i">Pkcs</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Security</span>.<span class="i">Cryptography</span>.<span class="i">X509Certificates</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Text</span>;
 
<b>namespace</b> <span class="i n">Microsoft</span>.<span class="i n">PowerShell</span>.<span class="i n">Commands</span>
{
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Defines the implementation of the &#39;Protect-CmsMessage&#39; cmdlet.</span>
    <span class="c">///</span>
    <span class="c">///</span><span class="c"> This cmdlet generates a new encrypted CMS message given the</span>
    <span class="c">///</span><span class="c"> recipient and content supplied.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    [<span class="i">Cmdlet</span>(<a href="/System.Management.Automation/A.html#89c65729d201ae54" class="t t">VerbsSecurity</a>.<a href="/System.Management.Automation/A.html#b38a15a15d41f939" class="i field">Protect</a>, <span class="s">&quot;CmsMessage&quot;</span>, <span class="i">HelpUri</span> = <span class="s">&quot;https://go.microsoft.com/fwlink/?LinkId=2096826&quot;</span>, <span class="i">DefaultParameterSetName</span> = <span class="s">&quot;ByContent&quot;</span>)]
    [<span class="i">OutputType</span>(<b>typeof</b>(<b>string</b>))]
    <b>public sealed class</b> <a id="989934d9b736bc3f" href="../R/../../0000000000.html" target="n" data-glyph="0,0" class="t t"><span id="7316abbdf587eee4">ProtectCmsMessageCommand</span></a> : <a href="/System.Management.Automation/A.html#30543a6971fed1fc" class="t t">PSCmdlet</a>
    {
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets or sets the recipient of the CMS Message.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>(<a href="/System.Management.Automation/A.html#19ccfeb1cdbdb967" class="i property">Position</a> = 0, <a href="/System.Management.Automation/A.html#d5ad471518092731" class="i property">Mandatory</a> = <b>true</b>)]
        <b>public</b> <a href="/System.Management.Automation/A.html#5c5b6fe96cf7c3f2" class="t t">CmsMessageRecipient</a>[] <a id="02af7fe001f46794" href="../R/02af7fe001f46794.html" target="n" data-glyph="102,1" class="i property">To</a>
        {
            <b>get</b>; <b>set</b>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets or sets the content of the CMS Message.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>(<a href="/System.Management.Automation/A.html#19ccfeb1cdbdb967" class="i property">Position</a> = 1, <a href="/System.Management.Automation/A.html#d5ad471518092731" class="i property">Mandatory</a> = <b>true</b>, <a href="/System.Management.Automation/A.html#4afbf5921ff6e967" class="i property">ValueFromPipeline</a> = <b>true</b>, <a href="/System.Management.Automation/A.html#91bee819daab0925" class="i property">ParameterSetName</a> = <span class="s">&quot;ByContent&quot;</span>)]
        [<span class="i">AllowNull</span>()]
        [<span class="i">AllowEmptyString</span>()]
        <b>public</b> <a href="/System.Management.Automation/A.html#a3c2513aa3da07fa" class="t t">PSObject</a> <a id="db9691da2d7e96dd" href="../R/db9691da2d7e96dd.html" target="n" data-glyph="102,1" class="i property">Content</a>
        {
            <b>get</b>;
            <b>set</b>;
        }
 
        <b>private readonly</b> <a href="/System.Management.Automation/A.html#52e2b209c10ec0a4" class="t t">PSDataCollection</a>&lt;<a href="/System.Management.Automation/A.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt; <a id="b53ad1a7820f7b48" href="../R/b53ad1a7820f7b48.html" target="n" data-glyph="46,1" class="i field">_inputObjects</a> = <b>new</b>();
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets or sets the content of the CMS Message by path.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>(<a href="/System.Management.Automation/A.html#19ccfeb1cdbdb967" class="i property">Position</a> = 1, <a href="/System.Management.Automation/A.html#d5ad471518092731" class="i property">Mandatory</a> = <b>true</b>, <a href="/System.Management.Automation/A.html#91bee819daab0925" class="i property">ParameterSetName</a> = <span class="s">&quot;ByPath&quot;</span>)]
        <b>public string</b> <a id="dfbef2b80be1ed75" href="../R/dfbef2b80be1ed75.html" target="n" data-glyph="102,1" class="i property">Path</a>
        {
            <b>get</b>;
            <b>set</b>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets or sets the content of the CMS Message by literal path.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>(<a href="/System.Management.Automation/A.html#19ccfeb1cdbdb967" class="i property">Position</a> = 1, <a href="/System.Management.Automation/A.html#d5ad471518092731" class="i property">Mandatory</a> = <b>true</b>, <a href="/System.Management.Automation/A.html#91bee819daab0925" class="i property">ParameterSetName</a> = <span class="s">&quot;ByLiteralPath&quot;</span>)]
        <b>public string</b> <a id="7027d0e99f0a1a0c" href="../R/7027d0e99f0a1a0c.html" target="n" data-glyph="102,1" class="i property">LiteralPath</a>
        {
            <b>get</b>;
            <b>set</b>;
        }
 
        <b>private string</b> <a id="9a30378c800e68bb" href="../R/9a30378c800e68bb.html" target="n" data-glyph="46,1" class="i field">_resolvedPath</a> = <b>null</b>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Emits the protected message to a file path.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>(<a href="/System.Management.Automation/A.html#19ccfeb1cdbdb967" class="i property">Position</a> = 2)]
        <b>public string</b> <a id="8a525710b51758b7" href="../R/8a525710b51758b7.html" target="n" data-glyph="102,1" class="i property">OutFile</a>
        {
            <b>get</b>;
            <b>set</b>;
        }
 
        <b>private string</b> <a id="2e17d1b711836577" href="../R/2e17d1b711836577.html" target="n" data-glyph="46,1" class="i field">_resolvedOutFile</a> = <b>null</b>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Validate / convert arguments.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>protected override void</b> <a id="5a72413585104c0c" href="../R/5a72413585104c0c.html" target="n" data-glyph="75,1" class="i method">BeginProcessing</a>()
        {
            <span class="c">// Validate Path</span>
            <b>if</b> (!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<a href="#dfbef2b80be1ed75" class="i property">Path</a>))
            {
                <a href="/System.Management.Automation/A.html#dd4e1f2f8e73a1dd" class="t t">ProviderInfo</a> <span id="r0 rd" class="r0 r">provider</span> = <b>null</b>;
                <span class="i">Collection</span>&lt;<b>string</b>&gt; <span id="r1 rd" class="r1 r">resolvedPaths</span> = <span class="i">GetResolvedProviderPathFromPSPath</span>(<a href="#dfbef2b80be1ed75" class="i property">Path</a>, <b>out</b> <span class="r0 r">provider</span>);
 
                <span class="c">// Ensure the path is a single path from the file system provider</span>
                <b>if</b> ((<span class="r1 r">resolvedPaths</span>.<span class="i">Count</span> &gt; 1) ||
                    (!<b>string</b>.<span class="i">Equals</span>(<span class="r0 r">provider</span>.<a href="/System.Management.Automation/A.html#2837d805ea30ef5c" class="i property">Name</a>, <span class="s">&quot;FileSystem&quot;</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>)))
                {
                    <a href="/System.Management.Automation/A.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r2 rd" class="r2 r">error</span> = <b>new</b>(
                        <b>new</b> <span class="i">ArgumentException</span>(
                            <b>string</b>.<span class="i">Format</span>(
                                <span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>,
                                <span class="i">CmsCommands</span>.<span class="i">FilePathMustBeFileSystemPath</span>,
                                <a href="#dfbef2b80be1ed75" class="i property">Path</a>)),
                        <span class="s">&quot;FilePathMustBeFileSystemPath&quot;</span>,
                        <a href="/System.Management.Automation/A.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="/System.Management.Automation/A.html#9a72a7d3051ac7c5" class="i field">ObjectNotFound</a>,
                        <span class="r0 r">provider</span>);
                    <span class="i">ThrowTerminatingError</span>(<span class="r2 r">error</span>);
                }
 
                <a href="#9a30378c800e68bb" class="i field">_resolvedPath</a> = <span class="r1 r">resolvedPaths</span>[0];
            }
 
            <b>if</b> (!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<a href="#7027d0e99f0a1a0c" class="i property">LiteralPath</a>))
            {
                <span class="c">// Validate that the path exists</span>
                <a href="/System.Management.Automation/A.html#5078d443148de142" class="i property">SessionState</a>.<a href="/System.Management.Automation/A.html#43a21166aa0ed2d8" class="i property">InvokeProvider</a>.<a href="/System.Management.Automation/A.html#982f59c2f3f056cc" class="i property">Item</a>.<span class="i">Get</span>(<b>new</b> <b>string</b>[] { <a href="#7027d0e99f0a1a0c" class="i property">LiteralPath</a> }, <b>false</b>, <b>true</b>);
                <a href="#9a30378c800e68bb" class="i field">_resolvedPath</a> = <a href="#7027d0e99f0a1a0c" class="i property">LiteralPath</a>;
            }
 
            <span class="c">// Validate OutFile</span>
            <b>if</b> (!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<a href="#8a525710b51758b7" class="i property">OutFile</a>))
            {
                <a href="#2e17d1b711836577" class="i field">_resolvedOutFile</a> = <span class="i">GetUnresolvedProviderPathFromPSPath</span>(<a href="#8a525710b51758b7" class="i property">OutFile</a>);
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Processes records from the input pipeline.</span>
        <span class="c">///</span><span class="c"> For each input object, the command encrypts</span>
        <span class="c">///</span><span class="c"> and exports the object.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>protected override void</b> <a id="33266438f2bb13f3" href="../R/33266438f2bb13f3.html" target="n" data-glyph="75,1" class="i method">ProcessRecord</a>()
        {
            <b>if</b> (<b>string</b>.<span class="i">Equals</span>(<span class="s">&quot;ByContent&quot;</span>, <a href="#989934d9b736bc3f" class="k">this</a>.<a href="/System.Management.Automation/A.html#f1ecb7c30328d049" class="i property">ParameterSetName</a>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
            {
                <a href="#b53ad1a7820f7b48" class="i field">_inputObjects</a>.<span class="i">Add</span>(<a href="#db9691da2d7e96dd" class="i property">Content</a>);
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Encrypts and outputs the message.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>protected override void</b> <a id="2ab5f8404b4d1f7a" href="../R/2ab5f8404b4d1f7a.html" target="n" data-glyph="75,1" class="i method">EndProcessing</a>()
        {
            <b>byte</b>[] <span id="r3 rd" class="r3 r">contentBytes</span> = <b>null</b>;
 
            <b>if</b> (<a href="#b53ad1a7820f7b48" class="i field">_inputObjects</a>.<a href="/System.Management.Automation/A.html#e7cb43bbebbb4aca" class="i property">Count</a> &gt; 0)
            {
                <span class="i">StringBuilder</span> <span id="r4 rd" class="r4 r">outputString</span> = <b>new</b>();
 
                <span class="i">Collection</span>&lt;<a href="/System.Management.Automation/A.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt; <span id="r5 rd" class="r5 r">output</span> = <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="/System.Management.Automation/A.html#3d1b346df3be574c" class="t t">PowerShell</a>.<a href="/System.Management.Automation/A.html#40345bc4625ff918" class="i method">Create</a>()
                    .<span class="i">AddCommand</span>(<span class="s">&quot;Microsoft.PowerShell.Utility\\Out-String&quot;</span>)
                    .<span class="i">AddParameter</span>(<span class="s">&quot;Stream&quot;</span>)
                    .<span class="i">Invoke</span>(<a href="#b53ad1a7820f7b48" class="i field">_inputObjects</a>);
 
                <b>foreach</b> (<a href="/System.Management.Automation/A.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r6 rd" class="r6 r">outputObject</span> <b>in</b> <span class="r5 r">output</span>)
                {
                    <b>if</b> (<span class="r4 r">outputString</span>.<span class="i">Length</span> &gt; 0)
                    {
                        <span class="r4 r">outputString</span>.<span class="i">AppendLine</span>();
                    }
 
                    <span class="r4 r">outputString</span>.<span class="i">Append</span>(<span class="r6 r">outputObject</span>);
                }
 
                <span class="r3 r">contentBytes</span> = <span class="i n">System</span>.<span class="i">Text</span>.<span class="i">Encoding</span>.<span class="i">UTF8</span>.<span class="i">GetBytes</span>(<span class="r4 r">outputString</span>.<span class="i">ToString</span>());
            }
            <b>else</b>
            {
                <span class="r3 r">contentBytes</span> = <span class="i n">System</span>.<span class="i">IO</span>.<span class="i">File</span>.<span class="i">ReadAllBytes</span>(<a href="#9a30378c800e68bb" class="i field">_resolvedPath</a>);
            }
 
            <a href="/System.Management.Automation/A.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r7 rd" class="r7 r">terminatingError</span> = <b>null</b>;
            <b>string</b> <span id="r8 rd" class="r8 r">encodedContent</span> = <span class="i">CmsUtils</span>.<span class="i">Encrypt</span>(<span class="r3 r">contentBytes</span>, <a href="#02af7fe001f46794" class="i property">To</a>, <a href="#989934d9b736bc3f" class="k">this</a>.<a href="/System.Management.Automation/A.html#5078d443148de142" class="i property">SessionState</a>, <b>out</b> <span class="r7 r">terminatingError</span>);
 
            <b>if</b> (<span class="r7 r">terminatingError</span> != <b>null</b>)
            {
                <span class="i">ThrowTerminatingError</span>(<span class="r7 r">terminatingError</span>);
            }
 
            <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<a href="#2e17d1b711836577" class="i field">_resolvedOutFile</a>))
            {
                <span class="i">WriteObject</span>(<span class="r8 r">encodedContent</span>);
            }
            <b>else</b>
            {
                <span class="i n">System</span>.<span class="i">IO</span>.<span class="i">File</span>.<span class="i">WriteAllText</span>(<a href="#2e17d1b711836577" class="i field">_resolvedOutFile</a>, <span class="r8 r">encodedContent</span>);
            }
        }
    }
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Defines the implementation of the &#39;Get-CmsMessage&#39; cmdlet.</span>
    <span class="c">///</span>
    <span class="c">///</span><span class="c"> This cmdlet retrieves information about an encrypted CMS</span>
    <span class="c">///</span><span class="c"> message.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    [<span class="i">Cmdlet</span>(<a href="/System.Management.Automation/A.html#d056c4b8c99405e5" class="t t">VerbsCommon</a>.<a href="/System.Management.Automation/A.html#7ee9f5441476f642" class="i field">Get</a>, <span class="s">&quot;CmsMessage&quot;</span>, <span class="i">HelpUri</span> = <span class="s">&quot;https://go.microsoft.com/fwlink/?LinkID=2096598&quot;</span>)]
    [<span class="i">OutputType</span>(<b>typeof</b>(<span class="i">EnvelopedCms</span>))]
    <b>public sealed class</b> <a id="6dded0cfb462eeb0" href="../R/../../0000000000.html" target="n" data-glyph="0,0" class="t t"><span id="9b0f734cdd413110">GetCmsMessageCommand</span></a> : <a href="/System.Management.Automation/A.html#30543a6971fed1fc" class="t t">PSCmdlet</a>
    {
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets or sets the content of the CMS Message.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>(<a href="/System.Management.Automation/A.html#19ccfeb1cdbdb967" class="i property">Position</a> = 0, <a href="/System.Management.Automation/A.html#d5ad471518092731" class="i property">Mandatory</a> = <b>true</b>, <a href="/System.Management.Automation/A.html#4afbf5921ff6e967" class="i property">ValueFromPipeline</a> = <b>true</b>, <a href="/System.Management.Automation/A.html#91bee819daab0925" class="i property">ParameterSetName</a> = <span class="s">&quot;ByContent&quot;</span>)]
        [<span class="i">AllowNull</span>()]
        [<span class="i">AllowEmptyString</span>()]
        <b>public string</b> <a id="e1d299076ff59985" href="../R/e1d299076ff59985.html" target="n" data-glyph="102,1" class="i property">Content</a>
        {
            <b>get</b>;
            <b>set</b>;
        }
 
        <b>private readonly</b> <span class="i">StringBuilder</span> <a id="793855de5516ad26" href="../R/793855de5516ad26.html" target="n" data-glyph="46,1" class="i field">_contentBuffer</a> = <b>new</b>();
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets or sets the CMS Message by path.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>(<a href="/System.Management.Automation/A.html#19ccfeb1cdbdb967" class="i property">Position</a> = 1, <a href="/System.Management.Automation/A.html#d5ad471518092731" class="i property">Mandatory</a> = <b>true</b>, <a href="/System.Management.Automation/A.html#91bee819daab0925" class="i property">ParameterSetName</a> = <span class="s">&quot;ByPath&quot;</span>)]
        <b>public string</b> <a id="a27176729e7b4eae" href="../R/a27176729e7b4eae.html" target="n" data-glyph="102,1" class="i property">Path</a>
        {
            <b>get</b>;
            <b>set</b>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets or sets the CMS Message by literal path.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>(<a href="/System.Management.Automation/A.html#19ccfeb1cdbdb967" class="i property">Position</a> = 1, <a href="/System.Management.Automation/A.html#d5ad471518092731" class="i property">Mandatory</a> = <b>true</b>, <a href="/System.Management.Automation/A.html#91bee819daab0925" class="i property">ParameterSetName</a> = <span class="s">&quot;ByLiteralPath&quot;</span>)]
        <b>public string</b> <a id="0a72c7e4d2476f72" href="../R/0a72c7e4d2476f72.html" target="n" data-glyph="102,1" class="i property">LiteralPath</a>
        {
            <b>get</b>;
            <b>set</b>;
        }
 
        <b>private string</b> <a id="b7983772f12969de" href="../R/b7983772f12969de.html" target="n" data-glyph="46,1" class="i field">_resolvedPath</a> = <b>null</b>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Validate / convert arguments.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>protected override void</b> <a id="1f8e75b79db2b806" href="../R/1f8e75b79db2b806.html" target="n" data-glyph="75,1" class="i method">BeginProcessing</a>()
        {
            <span class="c">// Validate Path</span>
            <b>if</b> (!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<a href="#a27176729e7b4eae" class="i property">Path</a>))
            {
                <a href="/System.Management.Automation/A.html#dd4e1f2f8e73a1dd" class="t t">ProviderInfo</a> <span id="r9 rd" class="r9 r">provider</span> = <b>null</b>;
                <span class="i">Collection</span>&lt;<b>string</b>&gt; <span id="r10 rd" class="r10 r">resolvedPaths</span> = <span class="i">GetResolvedProviderPathFromPSPath</span>(<a href="#a27176729e7b4eae" class="i property">Path</a>, <b>out</b> <span class="r9 r">provider</span>);
 
                <span class="c">// Ensure the path is a single path from the file system provider</span>
                <b>if</b> ((<span class="r10 r">resolvedPaths</span>.<span class="i">Count</span> &gt; 1) ||
                    (!<b>string</b>.<span class="i">Equals</span>(<span class="r9 r">provider</span>.<a href="/System.Management.Automation/A.html#2837d805ea30ef5c" class="i property">Name</a>, <span class="s">&quot;FileSystem&quot;</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>)))
                {
                    <a href="/System.Management.Automation/A.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r11 rd" class="r11 r">error</span> = <b>new</b>(
                        <b>new</b> <span class="i">ArgumentException</span>(
                            <b>string</b>.<span class="i">Format</span>(
                                <span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>,
                                <span class="i">CmsCommands</span>.<span class="i">FilePathMustBeFileSystemPath</span>,
                                <a href="#a27176729e7b4eae" class="i property">Path</a>)),
                        <span class="s">&quot;FilePathMustBeFileSystemPath&quot;</span>,
                        <a href="/System.Management.Automation/A.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="/System.Management.Automation/A.html#9a72a7d3051ac7c5" class="i field">ObjectNotFound</a>,
                        <span class="r9 r">provider</span>);
                    <span class="i">ThrowTerminatingError</span>(<span class="r11 r">error</span>);
                }
 
                <a href="#b7983772f12969de" class="i field">_resolvedPath</a> = <span class="r10 r">resolvedPaths</span>[0];
            }
 
            <b>if</b> (!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<a href="#0a72c7e4d2476f72" class="i property">LiteralPath</a>))
            {
                <span class="c">// Validate that the path exists</span>
                <a href="/System.Management.Automation/A.html#5078d443148de142" class="i property">SessionState</a>.<a href="/System.Management.Automation/A.html#43a21166aa0ed2d8" class="i property">InvokeProvider</a>.<a href="/System.Management.Automation/A.html#982f59c2f3f056cc" class="i property">Item</a>.<span class="i">Get</span>(<b>new</b> <b>string</b>[] { <a href="#0a72c7e4d2476f72" class="i property">LiteralPath</a> }, <b>false</b>, <b>true</b>);
                <a href="#b7983772f12969de" class="i field">_resolvedPath</a> = <a href="#0a72c7e4d2476f72" class="i property">LiteralPath</a>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Processes records from the input pipeline.</span>
        <span class="c">///</span><span class="c"> For each input object, the command gets the information</span>
        <span class="c">///</span><span class="c"> about the protected message and exports the object.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>protected override void</b> <a id="34cbe628544270d2" href="../R/34cbe628544270d2.html" target="n" data-glyph="75,1" class="i method">ProcessRecord</a>()
        {
            <b>if</b> (<b>string</b>.<span class="i">Equals</span>(<span class="s">&quot;ByContent&quot;</span>, <a href="#6dded0cfb462eeb0" class="k">this</a>.<a href="/System.Management.Automation/A.html#f1ecb7c30328d049" class="i property">ParameterSetName</a>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
            {
                <b>if</b> (<a href="#793855de5516ad26" class="i field">_contentBuffer</a>.<span class="i">Length</span> &gt; 0)
                {
                    <a href="#793855de5516ad26" class="i field">_contentBuffer</a>.<span class="i">Append</span>(<span class="i n">System</span>.<span class="i">Environment</span>.<span class="i">NewLine</span>);
                }
 
                <a href="#793855de5516ad26" class="i field">_contentBuffer</a>.<span class="i">Append</span>(<a href="#e1d299076ff59985" class="i property">Content</a>);
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the CMS Message object.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>protected override void</b> <a id="22b677580336bfcc" href="../R/22b677580336bfcc.html" target="n" data-glyph="75,1" class="i method">EndProcessing</a>()
        {
            <b>string</b> <span id="r12 rd" class="r12 r">actualContent</span> = <b>null</b>;
 
            <span class="c">// Read in the content</span>
            <b>if</b> (<b>string</b>.<span class="i">Equals</span>(<span class="s">&quot;ByContent&quot;</span>, <a href="#6dded0cfb462eeb0" class="k">this</a>.<a href="/System.Management.Automation/A.html#f1ecb7c30328d049" class="i property">ParameterSetName</a>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
            {
                <span class="r12 r">actualContent</span> = <a href="#793855de5516ad26" class="i field">_contentBuffer</a>.<span class="i">ToString</span>();
            }
            <b>else</b>
            {
                <span class="r12 r">actualContent</span> = <span class="i n">System</span>.<span class="i">IO</span>.<span class="i">File</span>.<span class="i">ReadAllText</span>(<a href="#b7983772f12969de" class="i field">_resolvedPath</a>);
            }
 
            <span class="c">// Extract out the bytes and Base64 decode them</span>
            <b>int</b> <span id="r13 rd" class="r13 r">startIndex</span>, <span id="r14 rd" class="r14 r">endIndex</span>;
            <b>byte</b>[] <span id="r15 rd" class="r15 r">contentBytes</span> = <span class="i">CmsUtils</span>.<span class="i">RemoveAsciiArmor</span>(<span class="r12 r">actualContent</span>, <span class="i">CmsUtils</span>.<span class="i">BEGIN_CMS_SIGIL</span>, <span class="i">CmsUtils</span>.<span class="i">END_CMS_SIGIL</span>, <b>out</b> <span class="r13 r">startIndex</span>, <b>out</b> <span class="r14 r">endIndex</span>);
            <b>if</b> (<span class="r15 r">contentBytes</span> == <b>null</b>)
            {
                <a href="/System.Management.Automation/A.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r16 rd" class="r16 r">error</span> = <b>new</b>(
                    <b>new</b> <span class="i">ArgumentException</span>(<span class="i">CmsCommands</span>.<span class="i">InputContainedNoEncryptedContent</span>),
                    <span class="s">&quot;InputContainedNoEncryptedContent&quot;</span>, <a href="/System.Management.Automation/A.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="/System.Management.Automation/A.html#9a72a7d3051ac7c5" class="i field">ObjectNotFound</a>, <b>null</b>);
                <span class="i">ThrowTerminatingError</span>(<span class="r16 r">error</span>);
            }
 
            <span class="i">EnvelopedCms</span> <span id="r17 rd" class="r17 r">cms</span> = <b>new</b>();
            <span class="r17 r">cms</span>.<span class="i">Decode</span>(<span class="r15 r">contentBytes</span>);
 
            <a href="/System.Management.Automation/A.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r18 rd" class="r18 r">result</span> = <b>new</b>(<span class="r17 r">cms</span>);
            <span class="i">List</span>&lt;<b>object</b>&gt; <span id="r19 rd" class="r19 r">recipients</span> = <b>new</b>();
            <b>foreach</b> (<span class="i">RecipientInfo</span> <span id="r20 rd" class="r20 r">recipient</span> <b>in</b> <span class="r17 r">cms</span>.<span class="i">RecipientInfos</span>)
            {
                <span class="r19 r">recipients</span>.<span class="i">Add</span>(<span class="r20 r">recipient</span>.<span class="i">RecipientIdentifier</span>.<span class="i">Value</span>);
            }
 
            <span class="r18 r">result</span>.<a href="/System.Management.Automation/A.html#59e9cd1ad57ccd34" class="i property">Properties</a>.<span class="i">Add</span>(
                <b>new</b> <span class="t">PSNoteProperty</span>(<span class="s">&quot;Recipients&quot;</span>, <span class="r19 r">recipients</span>));
            <span class="r18 r">result</span>.<a href="/System.Management.Automation/A.html#59e9cd1ad57ccd34" class="i property">Properties</a>.<span class="i">Add</span>(
                <b>new</b> <span class="t">PSNoteProperty</span>(<span class="s">&quot;Content&quot;</span>, <span class="r12 r">actualContent</span>));
 
            <span class="i">WriteObject</span>(<span class="r18 r">result</span>);
        }
    }
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Defines the implementation of the &#39;Unprotect-CmsMessage&#39; cmdlet.</span>
    <span class="c">///</span>
    <span class="c">///</span><span class="c"> This cmdlet retrieves the clear text content of an encrypted CMS</span>
    <span class="c">///</span><span class="c"> message.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    [<span class="i">Cmdlet</span>(<a href="/System.Management.Automation/A.html#89c65729d201ae54" class="t t">VerbsSecurity</a>.<a href="/System.Management.Automation/A.html#eca5884483482042" class="i field">Unprotect</a>, <span class="s">&quot;CmsMessage&quot;</span>, <span class="i">HelpUri</span> = <span class="s">&quot;https://go.microsoft.com/fwlink/?LinkId=2096701&quot;</span>, <span class="i">DefaultParameterSetName</span> = <span class="s">&quot;ByWinEvent&quot;</span>)]
    [<span class="i">OutputType</span>(<b>typeof</b>(<b>string</b>))]
    <b>public sealed class</b> <a id="6b7ec1f9b8c75f7a" href="../R/../../0000000000.html" target="n" data-glyph="0,0" class="t t"><span id="5899e546da95a7e5">UnprotectCmsMessageCommand</span></a> : <a href="/System.Management.Automation/A.html#30543a6971fed1fc" class="t t">PSCmdlet</a>
    {
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets or sets the content of the CMS Message.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>(<a href="/System.Management.Automation/A.html#19ccfeb1cdbdb967" class="i property">Position</a> = 0, <a href="/System.Management.Automation/A.html#d5ad471518092731" class="i property">Mandatory</a> = <b>true</b>, <a href="/System.Management.Automation/A.html#4afbf5921ff6e967" class="i property">ValueFromPipeline</a> = <b>true</b>, <a href="/System.Management.Automation/A.html#aded474eaec9cde8" class="i property">ValueFromPipelineByPropertyName</a> = <b>true</b>, <a href="/System.Management.Automation/A.html#91bee819daab0925" class="i property">ParameterSetName</a> = <span class="s">&quot;ByContent&quot;</span>)]
        [<span class="i">AllowNull</span>()]
        [<span class="i">AllowEmptyString</span>()]
        <b>public string</b> <a id="eab06eb434ce4bd8" href="../R/eab06eb434ce4bd8.html" target="n" data-glyph="102,1" class="i property">Content</a>
        {
            <b>get</b>;
            <b>set</b>;
        }
 
        <b>private readonly</b> <span class="i">StringBuilder</span> <a id="403c69b751363888" href="../R/403c69b751363888.html" target="n" data-glyph="46,1" class="i field">_contentBuffer</a> = <b>new</b>();
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets or sets the Windows Event Log Message with contents to be decrypted.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>(<a href="/System.Management.Automation/A.html#19ccfeb1cdbdb967" class="i property">Position</a> = 0, <a href="/System.Management.Automation/A.html#d5ad471518092731" class="i property">Mandatory</a> = <b>true</b>, <a href="/System.Management.Automation/A.html#4afbf5921ff6e967" class="i property">ValueFromPipeline</a> = <b>true</b>, <a href="/System.Management.Automation/A.html#91bee819daab0925" class="i property">ParameterSetName</a> = <span class="s">&quot;ByWinEvent&quot;</span>)]
        [<span class="i">PSTypeName</span>(<span class="s">&quot;System.Diagnostics.Eventing.Reader.EventLogRecord&quot;</span>)]
        <b>public</b> <a href="/System.Management.Automation/A.html#a3c2513aa3da07fa" class="t t">PSObject</a> <a id="97fd38cf72815d25" href="../R/97fd38cf72815d25.html" target="n" data-glyph="102,1" class="i property">EventLogRecord</a>
        {
            <b>get</b>;
            <b>set</b>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets or sets the CMS Message by path.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>(<a href="/System.Management.Automation/A.html#19ccfeb1cdbdb967" class="i property">Position</a> = 0, <a href="/System.Management.Automation/A.html#d5ad471518092731" class="i property">Mandatory</a> = <b>true</b>, <a href="/System.Management.Automation/A.html#91bee819daab0925" class="i property">ParameterSetName</a> = <span class="s">&quot;ByPath&quot;</span>)]
        <b>public string</b> <a id="dff8f0fdbdbad801" href="../R/dff8f0fdbdbad801.html" target="n" data-glyph="102,1" class="i property">Path</a>
        {
            <b>get</b>;
            <b>set</b>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets or sets the CMS Message by literal path.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>(<a href="/System.Management.Automation/A.html#19ccfeb1cdbdb967" class="i property">Position</a> = 0, <a href="/System.Management.Automation/A.html#d5ad471518092731" class="i property">Mandatory</a> = <b>true</b>, <a href="/System.Management.Automation/A.html#91bee819daab0925" class="i property">ParameterSetName</a> = <span class="s">&quot;ByLiteralPath&quot;</span>)]
        <b>public string</b> <a id="ee7df22d9132b4c6" href="../R/ee7df22d9132b4c6.html" target="n" data-glyph="102,1" class="i property">LiteralPath</a>
        {
            <b>get</b>;
            <b>set</b>;
        }
 
        <b>private string</b> <a id="6aa1d7fb5d7bea50" href="../R/6aa1d7fb5d7bea50.html" target="n" data-glyph="46,1" class="i field">_resolvedPath</a> = <b>null</b>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Determines whether to include the decrypted content in its original context,</span>
        <span class="c">///</span><span class="c"> rather than just output the decrypted content itself.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>()]
        <b>public</b> <a href="/System.Management.Automation/A.html#8260026027378f6c" class="t t">SwitchParameter</a> <a id="981d564994059fe5" href="../R/981d564994059fe5.html" target="n" data-glyph="102,1" class="i property">IncludeContext</a>
        {
            <b>get</b>;
            <b>set</b>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets or sets the recipient of the CMS Message.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>(<a href="/System.Management.Automation/A.html#19ccfeb1cdbdb967" class="i property">Position</a> = 1)]
        <b>public</b> <a href="/System.Management.Automation/A.html#5c5b6fe96cf7c3f2" class="t t">CmsMessageRecipient</a>[] <a id="b7e31a46e41df07f" href="../R/b7e31a46e41df07f.html" target="n" data-glyph="102,1" class="i property">To</a>
        {
            <b>get</b>;
            <b>set</b>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Validate / convert arguments.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>protected override void</b> <a id="6a86d616588e6132" href="../R/6a86d616588e6132.html" target="n" data-glyph="75,1" class="i method">BeginProcessing</a>()
        {
            <span class="c">// Validate Path</span>
            <b>if</b> (!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<a href="#dff8f0fdbdbad801" class="i property">Path</a>))
            {
                <a href="/System.Management.Automation/A.html#dd4e1f2f8e73a1dd" class="t t">ProviderInfo</a> <span id="r21 rd" class="r21 r">provider</span> = <b>null</b>;
                <span class="i">Collection</span>&lt;<b>string</b>&gt; <span id="r22 rd" class="r22 r">resolvedPaths</span> = <span class="i">GetResolvedProviderPathFromPSPath</span>(<a href="#dff8f0fdbdbad801" class="i property">Path</a>, <b>out</b> <span class="r21 r">provider</span>);
 
                <span class="c">// Ensure the path is a single path from the file system provider</span>
                <b>if</b> ((<span class="r22 r">resolvedPaths</span>.<span class="i">Count</span> &gt; 1) ||
                    (!<b>string</b>.<span class="i">Equals</span>(<span class="r21 r">provider</span>.<a href="/System.Management.Automation/A.html#2837d805ea30ef5c" class="i property">Name</a>, <span class="s">&quot;FileSystem&quot;</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>)))
                {
                    <a href="/System.Management.Automation/A.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r23 rd" class="r23 r">error</span> = <b>new</b>(
                        <b>new</b> <span class="i">ArgumentException</span>(
                            <b>string</b>.<span class="i">Format</span>(
                                <span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>,
                                <span class="i">CmsCommands</span>.<span class="i">FilePathMustBeFileSystemPath</span>,
                                <a href="#dff8f0fdbdbad801" class="i property">Path</a>)),
                        <span class="s">&quot;FilePathMustBeFileSystemPath&quot;</span>,
                        <a href="/System.Management.Automation/A.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="/System.Management.Automation/A.html#9a72a7d3051ac7c5" class="i field">ObjectNotFound</a>,
                        <span class="r21 r">provider</span>);
                    <span class="i">ThrowTerminatingError</span>(<span class="r23 r">error</span>);
                }
 
                <a href="#6aa1d7fb5d7bea50" class="i field">_resolvedPath</a> = <span class="r22 r">resolvedPaths</span>[0];
            }
 
            <b>if</b> (!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<a href="#ee7df22d9132b4c6" class="i property">LiteralPath</a>))
            {
                <span class="c">// Validate that the path exists</span>
                <a href="/System.Management.Automation/A.html#5078d443148de142" class="i property">SessionState</a>.<a href="/System.Management.Automation/A.html#43a21166aa0ed2d8" class="i property">InvokeProvider</a>.<a href="/System.Management.Automation/A.html#982f59c2f3f056cc" class="i property">Item</a>.<span class="i">Get</span>(<b>new</b> <b>string</b>[] { <a href="#ee7df22d9132b4c6" class="i property">LiteralPath</a> }, <b>false</b>, <b>true</b>);
                <a href="#6aa1d7fb5d7bea50" class="i field">_resolvedPath</a> = <a href="#ee7df22d9132b4c6" class="i property">LiteralPath</a>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Processes records from the input pipeline.</span>
        <span class="c">///</span><span class="c"> For each input object, the command gets the information</span>
        <span class="c">///</span><span class="c"> about the protected message and exports the object.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>protected override void</b> <a id="9bfa7c4cc0c7455a" href="../R/9bfa7c4cc0c7455a.html" target="n" data-glyph="75,1" class="i method">ProcessRecord</a>()
        {
            <span class="c">// If we&#39;re process by content, collect it.</span>
            <b>if</b> (<b>string</b>.<span class="i">Equals</span>(<span class="s">&quot;ByContent&quot;</span>, <a href="#6b7ec1f9b8c75f7a" class="k">this</a>.<a href="/System.Management.Automation/A.html#f1ecb7c30328d049" class="i property">ParameterSetName</a>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
            {
                <b>if</b> (<a href="#403c69b751363888" class="i field">_contentBuffer</a>.<span class="i">Length</span> &gt; 0)
                {
                    <a href="#403c69b751363888" class="i field">_contentBuffer</a>.<span class="i">Append</span>(<span class="i n">System</span>.<span class="i">Environment</span>.<span class="i">NewLine</span>);
                }
 
                <a href="#403c69b751363888" class="i field">_contentBuffer</a>.<span class="i">Append</span>(<a href="#eab06eb434ce4bd8" class="i property">Content</a>);
            }
 
            <span class="c">// If we&#39;re processing event log records, decrypt those inline.</span>
            <b>if</b> (<b>string</b>.<span class="i">Equals</span>(<span class="s">&quot;ByWinEvent&quot;</span>, <a href="#6b7ec1f9b8c75f7a" class="k">this</a>.<a href="/System.Management.Automation/A.html#f1ecb7c30328d049" class="i property">ParameterSetName</a>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
            {
                <b>string</b> <span id="r24 rd" class="r24 r">actualContent</span> = <a href="#97fd38cf72815d25" class="i property">EventLogRecord</a>.<a href="/System.Management.Automation/A.html#59e9cd1ad57ccd34" class="i property">Properties</a>[<span class="s">&quot;Message&quot;</span>].<a href="/System.Management.Automation/A.html#cd3a9989baedf3dd" class="i property">Value</a>.<span class="i">ToString</span>();
                <b>string</b> <span id="r25 rd" class="r25 r">decrypted</span> = <a href="#2c4d01d92e291b30" class="i method">Decrypt</a>(<span class="r24 r">actualContent</span>);
 
                <b>if</b> (!<a href="#981d564994059fe5" class="i property">IncludeContext</a>)
                {
                    <span class="i">WriteObject</span>(<span class="r25 r">decrypted</span>);
                }
                <b>else</b>
                {
                    <a href="#97fd38cf72815d25" class="i property">EventLogRecord</a>.<a href="/System.Management.Automation/A.html#59e9cd1ad57ccd34" class="i property">Properties</a>[<span class="s">&quot;Message&quot;</span>].<a href="/System.Management.Automation/A.html#cd3a9989baedf3dd" class="i property">Value</a> = <span class="r25 r">decrypted</span>;
                    <span class="i">WriteObject</span>(<a href="#97fd38cf72815d25" class="i property">EventLogRecord</a>);
                }
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Processes records from the input pipeline.</span>
        <span class="c">///</span><span class="c"> For each input object, the command gets the information</span>
        <span class="c">///</span><span class="c"> about the protected message and exports the object.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>protected override void</b> <a id="2217961be7a564ff" href="../R/2217961be7a564ff.html" target="n" data-glyph="75,1" class="i method">EndProcessing</a>()
        {
            <b>if</b> (<b>string</b>.<span class="i">Equals</span>(<span class="s">&quot;ByWinEvent&quot;</span>, <a href="#6b7ec1f9b8c75f7a" class="k">this</a>.<a href="/System.Management.Automation/A.html#f1ecb7c30328d049" class="i property">ParameterSetName</a>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
            {
                <b>return</b>;
            }
 
            <b>string</b> <span id="r26 rd" class="r26 r">actualContent</span> = <b>null</b>;
 
            <span class="c">// Read in the content</span>
            <b>if</b> (<b>string</b>.<span class="i">Equals</span>(<span class="s">&quot;ByContent&quot;</span>, <a href="#6b7ec1f9b8c75f7a" class="k">this</a>.<a href="/System.Management.Automation/A.html#f1ecb7c30328d049" class="i property">ParameterSetName</a>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
            {
                <span class="r26 r">actualContent</span> = <a href="#403c69b751363888" class="i field">_contentBuffer</a>.<span class="i">ToString</span>();
            }
            <b>else</b>
            {
                <span class="r26 r">actualContent</span> = <span class="i n">System</span>.<span class="i">IO</span>.<span class="i">File</span>.<span class="i">ReadAllText</span>(<a href="#6aa1d7fb5d7bea50" class="i field">_resolvedPath</a>);
            }
 
            <b>string</b> <span id="r27 rd" class="r27 r">decrypted</span> = <a href="#2c4d01d92e291b30" class="i method">Decrypt</a>(<span class="r26 r">actualContent</span>);
            <span class="i">WriteObject</span>(<span class="r27 r">decrypted</span>);
        }
 
        <b>private string</b> <a id="2c4d01d92e291b30" href="../R/2c4d01d92e291b30.html" target="n" data-glyph="76,1" class="i method">Decrypt</a>(<b>string</b> <span id="r28 rd" class="r28 r">actualContent</span>)
        {
            <span class="c">// Extract out the bytes and Base64 decode them</span>
            <b>int</b> <span id="r29 rd" class="r29 r">startIndex</span>, <span id="r30 rd" class="r30 r">endIndex</span>;
            <b>byte</b>[] <span id="r31 rd" class="r31 r">messageBytes</span> = <span class="i">CmsUtils</span>.<span class="i">RemoveAsciiArmor</span>(<span class="r28 r">actualContent</span>, <span class="i">CmsUtils</span>.<span class="i">BEGIN_CMS_SIGIL</span>, <span class="i">CmsUtils</span>.<span class="i">END_CMS_SIGIL</span>, <b>out</b> <span class="r29 r">startIndex</span>, <b>out</b> <span class="r30 r">endIndex</span>);
            <b>if</b> ((<span class="r31 r">messageBytes</span> == <b>null</b>) &amp;&amp; (!<a href="#981d564994059fe5" class="i property">IncludeContext</a>))
            {
                <a href="/System.Management.Automation/A.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r32 rd" class="r32 r">error</span> = <b>new</b>(
                    <b>new</b> <span class="i">ArgumentException</span>(
                        <b>string</b>.<span class="i">Format</span>(
                            <span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>,
                            <span class="i">CmsCommands</span>.<span class="i">InputContainedNoEncryptedContentIncludeContext</span>,
                            <span class="s">&quot;-IncludeContext&quot;</span>)),
                    <span class="s">&quot;InputContainedNoEncryptedContentIncludeContext&quot;</span>,
                    <a href="/System.Management.Automation/A.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="/System.Management.Automation/A.html#9a72a7d3051ac7c5" class="i field">ObjectNotFound</a>,
                    <span class="i">targetObject</span>: <b>null</b>);
                <span class="i">ThrowTerminatingError</span>(<span class="r32 r">error</span>);
            }
 
            <span class="c">// Capture the pre and post context, if there was any</span>
            <b>string</b> <span id="r33 rd" class="r33 r">preContext</span> = <b>null</b>;
            <b>string</b> <span id="r34 rd" class="r34 r">postContext</span> = <b>null</b>;
            <b>if</b> (<a href="#981d564994059fe5" class="i property">IncludeContext</a>)
            {
                <b>if</b> (<span class="r29 r">startIndex</span> &gt; -1)
                {
                    <span class="r33 r">preContext</span> = <span class="r28 r">actualContent</span>.<span class="i">Substring</span>(0, <span class="r29 r">startIndex</span>);
                }
 
                <b>if</b> (<span class="r30 r">endIndex</span> &gt; -1)
                {
                    <span class="r34 r">postContext</span> = <span class="r28 r">actualContent</span>.<span class="i">Substring</span>(<span class="r30 r">endIndex</span>);
                }
            }
 
            <span class="i">EnvelopedCms</span> <span id="r35 rd" class="r35 r">cms</span> = <b>new</b>();
            <span class="i">X509Certificate2Collection</span> <span id="r36 rd" class="r36 r">certificates</span> = <b>new</b>();
 
            <b>if</b> ((<a href="#b7e31a46e41df07f" class="i property">To</a> != <b>null</b>) &amp;&amp; (<a href="#b7e31a46e41df07f" class="i property">To</a>.<span class="i">Length</span> &gt; 0))
            {
                <a href="/System.Management.Automation/A.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r37 rd" class="r37 r">error</span> = <b>null</b>;
 
                <b>foreach</b> (<a href="/System.Management.Automation/A.html#5c5b6fe96cf7c3f2" class="t t">CmsMessageRecipient</a> <span id="r38 rd" class="r38 r">recipient</span> <b>in</b> <a href="#b7e31a46e41df07f" class="i property">To</a>)
                {
                    <span class="r38 r">recipient</span>.<span class="i">Resolve</span>(<a href="#6b7ec1f9b8c75f7a" class="k">this</a>.<a href="/System.Management.Automation/A.html#5078d443148de142" class="i property">SessionState</a>, <a href="/System.Management.Automation/A.html#1ce40ae4097eedd5" class="t t">ResolutionPurpose</a>.<a href="/System.Management.Automation/A.html#875957d96a754d49" class="i field">Decryption</a>, <b>out</b> <span class="r37 r">error</span>);
                    <b>if</b> (<span class="r37 r">error</span> != <b>null</b>)
                    {
                        <span class="i">ThrowTerminatingError</span>(<span class="r37 r">error</span>);
                        <b>return</b> <b>null</b>;
                    }
 
                    <b>foreach</b> (<span class="i">X509Certificate2</span> <span id="r39 rd" class="r39 r">certificate</span> <b>in</b> <span class="r38 r">recipient</span>.<a href="/System.Management.Automation/A.html#eedb5991913b91ce" class="i property">Certificates</a>)
                    {
                        <span class="r36 r">certificates</span>.<span class="i">Add</span>(<span class="r39 r">certificate</span>);
                    }
                }
            }
 
            <b>string</b> <span id="r40 rd" class="r40 r">resultString</span> = <span class="r28 r">actualContent</span>;
            <b>if</b> (<span class="r31 r">messageBytes</span> != <b>null</b>)
            {
                <span class="r35 r">cms</span>.<span class="i">Decode</span>(<span class="r31 r">messageBytes</span>);
                <span class="r35 r">cms</span>.<span class="i">Decrypt</span>(<span class="r36 r">certificates</span>);
 
                <span class="r40 r">resultString</span> = <span class="i n">System</span>.<span class="i">Text</span>.<span class="i">Encoding</span>.<span class="i">UTF8</span>.<span class="i">GetString</span>(<span class="r35 r">cms</span>.<span class="i">ContentInfo</span>.<span class="i">Content</span>);
            }
 
            <b>if</b> (<a href="#981d564994059fe5" class="i property">IncludeContext</a>)
            {
                <b>if</b> (<span class="r33 r">preContext</span> != <b>null</b>)
                {
                    <span class="r40 r">resultString</span> = <span class="r33 r">preContext</span> + <span class="r40 r">resultString</span>;
                }
 
                <b>if</b> (<span class="r34 r">postContext</span> != <b>null</b>)
                {
                    <span class="r40 r">resultString</span> += <span class="r34 r">postContext</span>;
                }
            }
 
            <b>return</b> <span class="r40 r">resultString</span>;
        }
    }
}
</pre></td></tr></table></div></body></html>
