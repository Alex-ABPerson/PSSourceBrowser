<!DOCTYPE html>
<html><head><title>ConsoleHostUserInterface.cs</title><link rel="stylesheet" href="../../../styles.css"><script src="../../../scripts.js"></script></head>
<body class="cB" onload="i(2261);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#Microsoft.PowerShell.ConsoleHost/host/msh/ConsoleHostUserInterface.cs" target="_top">host\msh\ConsoleHostUserInterface.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#Microsoft.PowerShell.ConsoleHost" target="_top">src\Microsoft.PowerShell.ConsoleHost\Microsoft.PowerShell.ConsoleHost.csproj</a> (Microsoft.PowerShell.ConsoleHost)</td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation.</span>
<span class="c">// Licensed under the MIT License.</span>
 
<b>using</b> <span class="i n">System</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Collections</span>.<span class="i">Generic</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Diagnostics</span>.<span class="i">CodeAnalysis</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">IO</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Linq</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Host</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Internal</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Runspaces</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Runtime</span>.<span class="i">CompilerServices</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Security</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Text</span>;
 
<b>using</b> <span class="i">Dbg</span> = <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i">Diagnostics</span>;
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">UNIX</span>
<b>using</b> <span class="i">ConsoleHandle</span> = <span class="i n">Microsoft</span>.<span class="i">Win32</span>.<span class="i">SafeHandles</span>.<span class="i">SafeFileHandle</span>;
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
 
<b>namespace</b> <span class="i n">Microsoft</span>.<span class="i n">PowerShell</span>
{
    <b>using</b> <span class="t">PowerShell</span> = <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="/System.Management.Automation/A.html#3d1b346df3be574c" class="t t">PowerShell</a>;
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> ConsoleHostUserInterface implements console-mode user interface for powershell.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Maintainability&quot;</span>, <span class="s">&quot;CA1506:AvoidExcessiveClassCoupling&quot;</span>)]
    <b>internal</b> <a href="../../P/b737197b2d219638.html" target="s" class="k">partial</a> <b>class</b> <a id="b737197b2d219638" href="../../R/b737197b2d219638.html" target="n" data-glyph="2,0" class="t t">ConsoleHostUserInterface</a> : <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Host</span>.<a href="/System.Management.Automation/A.html#3fd0cd9d58631820" class="t t">PSHostUserInterface</a>
    {
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This is the char that is echoed to the console when the input is masked. This not localizable.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private const char</b> <a id="87d0dc4a7e2a306b" href="../../R/87d0dc4a7e2a306b.html" target="n" data-glyph="10,1" class="i field">PrintToken</a> = <span class="s">&#39;*&#39;</span>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Command completion implementation object.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private</b> <a href="/System.Management.Automation/A.html#3d1b346df3be574c" class="t t">PowerShell</a> <a id="735667ca9bafaf9e" href="../../R/735667ca9bafaf9e.html" target="n" data-glyph="46,1" class="i field">_commandCompletionPowerShell</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This is a test hook for programmatically reading and writing ConsoleHost I/O.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private static readonly</b> <a href="/System.Management.Automation/A.html#3fd0cd9d58631820" class="t t">PSHostUserInterface</a> <a id="67f5bbca9042b4f7" href="../../R/67f5bbca9042b4f7.html" target="n" data-glyph="46,1" class="i field">s_h</a> = <b>null</b>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Return true if the console supports a VT100 like virtual terminal.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public override bool</b> <a id="5db1812edea1b244" href="../../R/5db1812edea1b244.html" target="n" data-glyph="102,1" class="i property">SupportsVirtualTerminal</a> { <b>get</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Constructs an instance.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r0 r">parent</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span><span class="c">/&gt;</span>
        <b>internal</b> <a id="1697543d01a650f1" href="../../R/1697543d01a650f1.html" target="n" data-glyph="74,1" class="t constructor">ConsoleHostUserInterface</a>(<a href="../../P/cda5e43a29a66e53.html#cda5e43a29a66e53" class="t t">ConsoleHost</a> <span id="r0 rd" class="r0 r">parent</span>)
        {
            <a href="/System.Management.Automation/A.html#c04955255430d32f" class="t t">Dbg</a>.<span class="i">Assert</span>(<span class="r0 r">parent</span> != <b>null</b>, <span class="s">&quot;parent may not be null&quot;</span>);
 
            <a href="#84b0fd621e4256ef" class="i field">_parent</a> = <span class="r0 r">parent</span>;
            <a href="#370e7f4dd3c19e58" class="i field">_rawui</a> = <b>new</b> <a href="ConsoleHostRawUserInterface.cs.html#9bcb5587b622c1b2" class="t constructor">ConsoleHostRawUserInterface</a>(<a href="../../P/b737197b2d219638.html#b737197b2d219638" class="k">this</a>);
            <a href="#5db1812edea1b244" class="i property">SupportsVirtualTerminal</a> = <b>true</b>;
            <a href="#142e9a50cad75382" class="i field">_isInteractiveTestToolListening</a> = <b>false</b>;
 
            <span class="c">// check if TERM env var is set</span>
            <span class="c">// `dumb` means explicitly don&#39;t use VT</span>
            <span class="c">// `xterm-mono` and `xtermm` means support VT, but emit plaintext</span>
            <b>switch</b> (<span class="i">Environment</span>.<span class="i">GetEnvironmentVariable</span>(<span class="s">&quot;TERM&quot;</span>))
            {
                <b>case</b> <span class="s">&quot;dumb&quot;</span>:
                    <a href="#5db1812edea1b244" class="i property">SupportsVirtualTerminal</a> = <b>false</b>;
                    <b>break</b>;
                <b>case</b> <span class="s">&quot;xterm-mono&quot;</span>:
                <b>case</b> <span class="s">&quot;xtermm&quot;</span>:
                    <a href="/System.Management.Automation/A.html#340d221c8aa09678" class="t t">PSStyle</a>.<a href="/System.Management.Automation/A.html#f7875006d0bc55f1" class="i property">Instance</a>.<span class="i">OutputRendering</span> = <a href="/System.Management.Automation/A.html#aaed168a484b0007" class="t t">OutputRendering</a>.<a href="/System.Management.Automation/A.html#bd2dfddf3028517b" class="i field">PlainText</a>;
                    <b>break</b>;
                <b>default</b>:
                    <b>break</b>;
            }
 
            <span class="c">// widely supported by CLI tools via https://no-color.org/</span>
            <b>if</b> (<span class="i">Environment</span>.<span class="i">GetEnvironmentVariable</span>(<span class="s">&quot;NO_COLOR&quot;</span>) != <b>null</b>)
            {
                <a href="/System.Management.Automation/A.html#340d221c8aa09678" class="t t">PSStyle</a>.<a href="/System.Management.Automation/A.html#f7875006d0bc55f1" class="i property">Instance</a>.<span class="i">OutputRendering</span> = <a href="/System.Management.Automation/A.html#aaed168a484b0007" class="t t">OutputRendering</a>.<a href="/System.Management.Automation/A.html#bd2dfddf3028517b" class="i field">PlainText</a>;
            }
 
            <b>if</b> (<a href="#5db1812edea1b244" class="i property">SupportsVirtualTerminal</a>)
            {
                <a href="#5db1812edea1b244" class="i property">SupportsVirtualTerminal</a> = <a href="#5755cc7d3307e2fa" class="i method">TryTurnOnVtMode</a>();
            }
        }
 
        <b>internal bool</b> <a id="5755cc7d3307e2fa" href="../../R/5755cc7d3307e2fa.html" target="n" data-glyph="74,1" class="i method">TryTurnOnVtMode</a>()
        {
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">UNIX</span>
<span class="e">            return true;
</span><span class="k preprocess">#</span><span class="k preprocess">else</span>
            <b>try</b>
            {
                <span class="c">// Turn on virtual terminal if possible.</span>
 
                <span class="c">// This might throw - not sure how exactly (no console), but if it does, we shouldn&#39;t fail to start.</span>
                <b>var</b> <span id="r1 rd" class="r1 r">handle</span> = <a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#d72136ddad017191" class="i method">GetActiveScreenBufferHandle</a>();
                <a href="ConsoleControl.cs.html#1d1eff9fb00ac8e2" class="k">var</a> <span id="r2 rd" class="r2 r">m</span> = <a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#133579be57ae9c3e" class="i method">GetMode</a>(<span class="r1 r">handle</span>);
                <b>if</b> (<a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#4ea030ef9c4281a7" class="t t">NativeMethods</a>.<span class="i">SetConsoleMode</span>(<span class="r1 r">handle</span>.<span class="i">DangerousGetHandle</span>(), (<b>uint</b>)(<span class="r2 r">m</span> | <a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#1d1eff9fb00ac8e2" class="t t">ConsoleModes</a>.<a href="ConsoleControl.cs.html#75b80d335eae6d9f" class="i field">VirtualTerminal</a>)))
                {
                    <span class="c">// We only know if vt100 is supported if the previous call actually set the new flag, older</span>
                    <span class="c">// systems ignore the setting.</span>
                    <span class="r2 r">m</span> = <a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#133579be57ae9c3e" class="i method">GetMode</a>(<span class="r1 r">handle</span>);
                    <b>return</b> (<span class="r2 r">m</span> &amp; <a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#1d1eff9fb00ac8e2" class="t t">ConsoleModes</a>.<a href="ConsoleControl.cs.html#75b80d335eae6d9f" class="i field">VirtualTerminal</a>) != 0;
                }
            }
            <b>catch</b>
            {
                <span class="c">// Do nothing if failed</span>
            }
 
            <b>return</b> <b>false</b>;
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Supplies an implementation of PSHostRawUserInterface that provides low-level console mode UI facilities.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">value</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">value</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span><span class="c">/&gt;</span>
        <b>public override</b> <a href="/System.Management.Automation/A.html#74913c6687237500" class="t t">PSHostRawUserInterface</a> <a id="33b028e308b5319d" href="../../R/33b028e308b5319d.html" target="n" data-glyph="102,1" class="i property">RawUI</a>
        {
            <b>get</b>
            {
                <a href="/System.Management.Automation/A.html#c04955255430d32f" class="t t">Dbg</a>.<span class="i">Assert</span>(<a href="#370e7f4dd3c19e58" class="i field">_rawui</a> != <b>null</b>, <span class="s">&quot;rawui should have been created by ctor&quot;</span>);
 
                <span class="c">// no locking because this is read-only, and allocated in the ctor.</span>
 
                <b>return</b> <a href="#370e7f4dd3c19e58" class="i field">_rawui</a>;
            }
        }
 
        <span class="c">// deadcode; but could be needed in the future.</span>
        <span class="c">///// &lt;summary&gt;</span>
        <span class="c">///// gets the PSHost instance that uses this ConsoleHostUserInterface instance</span>
        <span class="c">///// &lt;/summary&gt;</span>
        <span class="c">///// &lt;value&gt;&lt;/value&gt;</span>
        <span class="c">///// &lt;exception/&gt;</span>
 
        <span class="c">// internal</span>
        <span class="c">// PSHost</span>
        <span class="c">// Parent</span>
        <span class="c">// {</span>
        <span class="c">//    get</span>
        <span class="c">//    {</span>
        <span class="c">//        using (tracer.TraceProperty())</span>
        <span class="c">//        {</span>
        <span class="c">//            // no locking because this is read-only and set in the ctor.</span>
 
        <span class="c">//            return parent;</span>
        <span class="c">//        }</span>
        <span class="c">//    }</span>
        <span class="c">// }</span>
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> True if command completion is currently running.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal bool</b> <a id="1849b96268ceab63" href="../../R/1849b96268ceab63.html" target="n" data-glyph="104,1" class="i property">IsCommandCompletionRunning</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#735667ca9bafaf9e" class="i field">_commandCompletionPowerShell</a> != <b>null</b> &amp;&amp;
                       <a href="#735667ca9bafaf9e" class="i field">_commandCompletionPowerShell</a>.<a href="/System.Management.Automation/A.html#39b81acd3aeb1582" class="i property">InvocationStateInfo</a>.<a href="/System.Management.Automation/A.html#7a70ff5163d0f044" class="i property">State</a> == <a href="/System.Management.Automation/A.html#24cc37ccdc118b7a" class="t t">PSInvocationState</a>.<a href="/System.Management.Automation/A.html#7142407e9e49cf13" class="i field">Running</a>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> True if the Read* functions should read from the stdin stream instead of from the win32 console.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal bool</b> <a id="96bef84efdae9634" href="../../R/96bef84efdae9634.html" target="n" data-glyph="104,1" class="i property">ReadFromStdin</a> { <b>get</b>; <b>set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> True if the host shouldn&#39;t write out prompts.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal bool</b> <a id="3202c0ccb1155eb7" href="../../R/3202c0ccb1155eb7.html" target="n" data-glyph="104,1" class="i property">NoPrompt</a> { <b>get</b>; <b>set</b>; }
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Line-oriented interaction
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> See base class.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="/System.Management.Automation/A.html#4b15a598e99c7dd9" class="t t">HostException</a><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If Win32&#39;s SetConsoleMode fails</span>
        <span class="c">///</span><span class="c">    OR</span>
        <span class="c">///</span><span class="c">    Win32&#39;s ReadConsole fails</span>
        <span class="c">///</span><span class="c">    OR</span>
        <span class="c">///</span><span class="c">    obtaining information about the buffer failed</span>
        <span class="c">///</span><span class="c">    OR</span>
        <span class="c">///</span><span class="c">    Win32&#39;s SetConsoleCursorPosition failed</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>public override string</b> <a id="27494f8e85d67eec" href="../../R/27494f8e85d67eec.html" target="n" data-glyph="72,1" class="i method">ReadLine</a>()
        {
            <a href="#6f818c219520a810" class="i method">HandleThrowOnReadAndPrompt</a>();
 
            <span class="c">// call our internal version such that it does not end input on a tab</span>
            <a href="#0de1ff3de6688ce7" class="t t">ReadLineResult</a> <span id="r3 rd" class="r3 r">unused</span>;
 
            <b>return</b> <span class="i">ReadLine</span>(<b>false</b>, <b>string</b>.<span class="i">Empty</span>, <b>out</b> <span class="r3 r">unused</span>, <b>true</b>, <b>true</b>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> See base class.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="/System.Management.Automation/A.html#4b15a598e99c7dd9" class="t t">HostException</a><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If obtaining a handle to the active screen buffer failed</span>
        <span class="c">///</span><span class="c">    OR</span>
        <span class="c">///</span><span class="c">    Win32&#39;s setting input buffer mode to disregard window and mouse input failed</span>
        <span class="c">///</span><span class="c">    OR</span>
        <span class="c">///</span><span class="c">    Win32&#39;s ReadConsole failed</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="/System.Management.Automation/A.html#1b159d1cae338f33" class="t t">PipelineStoppedException</a><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If Ctrl-C is entered by user</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>public override</b> <span class="i">SecureString</span> <a id="b250499b1b6c3e4f" href="../../R/b250499b1b6c3e4f.html" target="n" data-glyph="72,1" class="i method">ReadLineAsSecureString</a>()
        {
            <a href="#6f818c219520a810" class="i method">HandleThrowOnReadAndPrompt</a>();
 
            <span class="c">// we lock here so that multiple threads won&#39;t interleave the various reads and writes here.</span>
 
            <b>object</b> <span id="r4 rd" class="r4 r">result</span> = <b>null</b>;
            <b>lock</b> (<a href="#dbd28972ee208717" class="i field">_instanceLock</a>)
            {
                <span class="r4 r">result</span> = <a href="#e225f9c63cff6be9" class="i method">ReadLineSafe</a>(<b>true</b>, <a href="#87d0dc4a7e2a306b" class="i field">PrintToken</a>);
            }
 
            <span class="i">SecureString</span> <span id="r5 rd" class="r5 r">secureResult</span> = <span class="r4 r">result</span> <b>as</b> <span class="i">SecureString</span>;
            <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i">Diagnostics</span>.<span class="i">Assert</span>(<span class="r5 r">secureResult</span> != <b>null</b>, <span class="s">&quot;ReadLineSafe did not return a SecureString&quot;</span>);
 
            <b>return</b> <span class="r5 r">secureResult</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Implementation based on NT CredUI&#39;s GetPasswdStr.</span>
        <span class="c">///</span><span class="c"> Use Win32.ReadConsole to construct a SecureString. The advantage of ReadConsole over ReadKey is</span>
        <span class="c">///</span><span class="c"> Alt-ddd where d is {0-9} is allowed.</span>
        <span class="c">///</span><span class="c"> It also manages the cursor as keys are entered and &quot;backspaced&quot;. However, it is possible that</span>
        <span class="c">///</span><span class="c"> while this method is running, the console buffer contents could change. Then, its cursor mgmt</span>
        <span class="c">///</span><span class="c"> will likely be messed up.</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> Secondary implementation for Unix based on Console.ReadKey(), where</span>
        <span class="c">///</span><span class="c"> the advantage is portability through abstraction. Does not support</span>
        <span class="c">///</span><span class="c"> arrow key movement, but supports backspace.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r6 r">isSecureString</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> True to specify reading a SecureString; false reading a string</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r7 r">printToken</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> string for output echo</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="/System.Management.Automation/A.html#4b15a598e99c7dd9" class="t t">HostException</a><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If obtaining a handle to the active screen buffer failed</span>
        <span class="c">///</span><span class="c">    OR</span>
        <span class="c">///</span><span class="c">    Win32&#39;s setting input buffer mode to disregard window and mouse input failed</span>
        <span class="c">///</span><span class="c">    OR</span>
        <span class="c">///</span><span class="c">    Win32&#39;s ReadConsole failed</span>
        <span class="c">///</span><span class="c">    OR</span>
        <span class="c">///</span><span class="c">    obtaining information about the buffer failed</span>
        <span class="c">///</span><span class="c">    OR</span>
        <span class="c">///</span><span class="c">    Win32&#39;s SetConsoleCursorPosition failed</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="/System.Management.Automation/A.html#1b159d1cae338f33" class="t t">PipelineStoppedException</a><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If Ctrl-C is entered by user</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>private object</b> <a id="e225f9c63cff6be9" href="../../R/e225f9c63cff6be9.html" target="n" data-glyph="76,1" class="i method">ReadLineSafe</a>(<b>bool</b> <span id="r6 rd" class="r6 r">isSecureString</span>, <b>char</b>? <span id="r7 rd" class="r7 r">printToken</span>)
        {
            <span class="c">// Don&#39;t lock (instanceLock) in here -- the caller needs to do that...</span>
 
            <a href="ConsoleHostUserInterfaceProgress.cs.html#adebfa50cfd2a343" class="i method">PreRead</a>();
            <b>string</b> <span id="r8 rd" class="r8 r">printTokenString</span> = <span class="r7 r">printToken</span>.<span class="i">HasValue</span> ?
                <span class="r7 r">printToken</span>.<span class="i">ToString</span>() :
                <b>null</b>;
            <span class="i">SecureString</span> <span id="r9 rd" class="r9 r">secureResult</span> = <b>new</b> <span class="i">SecureString</span>();
            <span class="i">StringBuilder</span> <span id="r10 rd" class="r10 r">result</span> = <b>new</b> <span class="i">StringBuilder</span>();
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">UNIX</span>
<span class="e">            bool treatControlCAsInput = Console.TreatControlCAsInput;
</span><span class="k preprocess">#</span><span class="k preprocess">else</span>
            <span class="i">ConsoleHandle</span> <span id="r11 rd" class="r11 r">handle</span> = <a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#082a79a70f5af6dc" class="i method">GetConioDeviceHandle</a>();
            <a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#1d1eff9fb00ac8e2" class="t t">ConsoleModes</a> <span id="r12 rd" class="r12 r">originalMode</span> = <a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#133579be57ae9c3e" class="i method">GetMode</a>(<span class="r11 r">handle</span>);
            <b>bool</b> <span id="r13 rd" class="r13 r">isModeChanged</span> = <b>true</b>; <span class="c">// assume ConsoleMode is changed so that if ReadLineSetMode</span>
            <span class="c">// fails to return the value correctly, the original mode is</span>
            <span class="c">// restored.</span>
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
 
            <b>try</b>
            {
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">UNIX</span>
<span class="e">                Console.TreatControlCAsInput = true;
</span><span class="k preprocess">#</span><span class="k preprocess">else</span>
                <span class="c">// Ensure that we&#39;re in the proper line-input mode.</span>
 
                <b>const</b> <a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#1d1eff9fb00ac8e2" class="t t">ConsoleModes</a> <span id="r14 rd" class="r14 r">DesiredMode</span> =
                    <a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#1d1eff9fb00ac8e2" class="t t">ConsoleModes</a>.<a href="ConsoleControl.cs.html#f91282e15d35c3f0" class="i field">Extended</a> |
                    <a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#1d1eff9fb00ac8e2" class="t t">ConsoleModes</a>.<a href="ConsoleControl.cs.html#9cf28d0a88dc851f" class="i field">QuickEdit</a>;
 
                <a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#1d1eff9fb00ac8e2" class="t t">ConsoleModes</a> <span id="r15 rd" class="r15 r">m</span> = <span class="r12 r">originalMode</span>;
                <b>bool</b> <span id="r16 rd" class="r16 r">shouldUnsetEchoInput</span> = <a href="#719815fc54ed1d21" class="i method">shouldUnsetMode</a>(<a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#1d1eff9fb00ac8e2" class="t t">ConsoleModes</a>.<a href="ConsoleControl.cs.html#adac23d1297e0802" class="i field">EchoInput</a>, <b>ref</b> <span class="r15 r">m</span>);
                <b>bool</b> <span id="r17 rd" class="r17 r">shouldUnsetLineInput</span> = <a href="#719815fc54ed1d21" class="i method">shouldUnsetMode</a>(<a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#1d1eff9fb00ac8e2" class="t t">ConsoleModes</a>.<a href="ConsoleControl.cs.html#6059b69bb324025e" class="i field">LineInput</a>, <b>ref</b> <span class="r15 r">m</span>);
                <b>bool</b> <span id="r18 rd" class="r18 r">shouldUnsetMouseInput</span> = <a href="#719815fc54ed1d21" class="i method">shouldUnsetMode</a>(<a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#1d1eff9fb00ac8e2" class="t t">ConsoleModes</a>.<a href="ConsoleControl.cs.html#ace876bd01ee480a" class="i field">MouseInput</a>, <b>ref</b> <span class="r15 r">m</span>);
                <b>bool</b> <span id="r19 rd" class="r19 r">shouldUnsetProcessInput</span> = <a href="#719815fc54ed1d21" class="i method">shouldUnsetMode</a>(<a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#1d1eff9fb00ac8e2" class="t t">ConsoleModes</a>.<a href="ConsoleControl.cs.html#dc342310a77c2d1f" class="i field">ProcessedInput</a>, <b>ref</b> <span class="r15 r">m</span>);
 
                <b>if</b> ((<span class="r15 r">m</span> &amp; <span class="r14 r">DesiredMode</span>) != <span class="r14 r">DesiredMode</span> ||
                    <span class="r18 r">shouldUnsetMouseInput</span> ||
                    <span class="r16 r">shouldUnsetEchoInput</span> ||
                    <span class="r17 r">shouldUnsetLineInput</span> ||
                    <span class="r19 r">shouldUnsetProcessInput</span>)
                {
                    <span class="r15 r">m</span> |= <span class="r14 r">DesiredMode</span>;
                    <a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#6c1ab9fc2b7085b1" class="i method">SetMode</a>(<span class="r11 r">handle</span>, <span class="r15 r">m</span>);
                }
                <b>else</b>
                {
                    <span class="r13 r">isModeChanged</span> = <b>false</b>;
                }
 
                <a href="#370e7f4dd3c19e58" class="i field">_rawui</a>.<a href="ConsoleHostRawUserInterface.cs.html#35a22fc56a5f740a" class="i method">ClearKeyCache</a>();
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
 
                <a href="/System.Management.Automation/A.html#c6f6da6e12de292e" class="t t">Coordinates</a> <span id="r20 rd" class="r20 r">originalCursorPos</span> = <a href="#370e7f4dd3c19e58" class="i field">_rawui</a>.<a href="ConsoleHostRawUserInterface.cs.html#1ceb2774733b1ee1" class="i property">CursorPosition</a>;
 
                <b>while</b> (<b>true</b>)
                {
                    <span class="c">//</span>
                    <span class="c">// read one char at a time so that we don&#39;t</span>
                    <span class="c">// end up having a immutable string holding the</span>
                    <span class="c">// secret in memory.</span>
                    <span class="c">//</span>
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">UNIX</span>
<span class="e">                    ConsoleKeyInfo keyInfo = Console.ReadKey(true);
</span><span class="k preprocess">#</span><span class="k preprocess">else</span>
                    <b>const int</b> <span id="r21 rd" class="r21 r">CharactersToRead</span> = 1;
<span class="k preprocess">#</span><span class="k preprocess">pragma</span> <span class="k preprocess">warning</span> <span class="k preprocess">disable</span> <span class="i">CA2014</span>
                    <span class="i">Span</span>&lt;<b>char</b>&gt; <span id="r22 rd" class="r22 r">inputBuffer</span> = <b>stackalloc char</b>[<span class="r21 r">CharactersToRead</span> + 1];
<span class="k preprocess">#</span><span class="k preprocess">pragma</span> <span class="k preprocess">warning</span> <span class="k preprocess">restore</span> <span class="i">CA2014</span>
                    <b>string</b> <span id="r23 rd" class="r23 r">key</span> = <a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#cc37450eec4d5e6d" class="i method">ReadConsole</a>(<span class="r11 r">handle</span>, <span class="r24 r">initialContentLength</span>: 0, <span class="r22 r">inputBuffer</span>, <span class="r25 r">charactersToRead</span>: <span class="r21 r">CharactersToRead</span>, <span class="r26 r">endOnTab</span>: <b>false</b>, <b>out _</b>);
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
 
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">UNIX</span>
<span class="e">                    // Handle Ctrl-C ending input
                    if (keyInfo.Key == ConsoleKey.C &amp;&amp; keyInfo.Modifiers.HasFlag(ConsoleModifiers.Control))
</span><span class="k preprocess">#</span><span class="k preprocess">else</span>
                    <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r23 r">key</span>) || <span class="r23 r">key</span>[0] == (<b>char</b>)3)
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
                    {
                        <a href="/System.Management.Automation/A.html#1b159d1cae338f33" class="t t">PipelineStoppedException</a> <span id="r27 rd" class="r27 r">e</span> = <b>new</b> <span class="t">PipelineStoppedException</span>();
                        <b>throw</b> <span class="r27 r">e</span>;
                    }
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">UNIX</span>
<span class="e">                    if (keyInfo.Key == ConsoleKey.Enter)
</span><span class="k preprocess">#</span><span class="k preprocess">else</span>
                    <b>if</b> (<span class="r23 r">key</span>[0] == (<b>char</b>)13)
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
                    {
                        <span class="c">//</span>
                        <span class="c">// we are done if user presses ENTER key</span>
                        <span class="c">//</span>
                        <b>break</b>;
                    }
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">UNIX</span>
<span class="e">                    if (keyInfo.Key == ConsoleKey.Backspace)
</span><span class="k preprocess">#</span><span class="k preprocess">else</span>
                    <b>if</b> (<span class="r23 r">key</span>[0] == (<b>char</b>)8)
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
                    {
                        <span class="c">//</span>
                        <span class="c">// for backspace, remove last char appended</span>
                        <span class="c">//</span>
                        <b>if</b> (<span class="r6 r">isSecureString</span> &amp;&amp; <span class="r9 r">secureResult</span>.<span class="i">Length</span> &gt; 0)
                        {
                            <span class="r9 r">secureResult</span>.<span class="i">RemoveAt</span>(<span class="r9 r">secureResult</span>.<span class="i">Length</span> - 1);
                            <a href="#ea295ac68d4ad614" class="i method">WriteBackSpace</a>(<span class="r20 r">originalCursorPos</span>);
                        }
                        <b>else</b> <b>if</b> (<span class="r10 r">result</span>.<span class="i">Length</span> &gt; 0)
                        {
                            <span class="r10 r">result</span>.<span class="i">Remove</span>(<span class="r10 r">result</span>.<span class="i">Length</span> - 1, 1);
                            <a href="#ea295ac68d4ad614" class="i method">WriteBackSpace</a>(<span class="r20 r">originalCursorPos</span>);
                        }
                    }
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">UNIX</span>
<span class="e">                    else if (char.IsControl(keyInfo.KeyChar))
                    {
                        // deny list control characters
                        continue;
                    }
</span><span class="k preprocess">#</span><span class="k preprocess">endif</span>
                    <b>else</b>
                    {
                        <span class="c">//</span>
                        <span class="c">// append the char to our string</span>
                        <span class="c">//</span>
                        <b>if</b> (<span class="r6 r">isSecureString</span>)
                        {
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">UNIX</span>
<span class="e">                            secureResult.AppendChar(keyInfo.KeyChar);
</span><span class="k preprocess">#</span><span class="k preprocess">else</span>
                            <span class="r9 r">secureResult</span>.<span class="i">AppendChar</span>(<span class="r23 r">key</span>[0]);
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
                        }
                        <b>else</b>
                        {
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">UNIX</span>
<span class="e">                            result.Append(keyInfo.KeyChar);
</span><span class="k preprocess">#</span><span class="k preprocess">else</span>
                            <span class="r10 r">result</span>.<span class="i">Append</span>(<span class="r23 r">key</span>);
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
                        }
 
                        <b>if</b> (!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r8 r">printTokenString</span>))
                        {
                            <a href="#b326bbe4372a2fca" class="i method">WritePrintToken</a>(<span class="r8 r">printTokenString</span>, <b>ref</b> <span class="r20 r">originalCursorPos</span>);
                        }
                    }
                }
            }
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">UNIX</span>
<span class="e">            catch (InvalidOperationException)
            {
                // ReadKey() failed so we stop
                throw new PipelineStoppedException();
            }
</span><span class="k preprocess">#</span><span class="k preprocess">endif</span>
            <b>finally</b>
            {
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">UNIX</span>
<span class="e">                Console.TreatControlCAsInput = treatControlCAsInput;
</span><span class="k preprocess">#</span><span class="k preprocess">else</span>
                <b>if</b> (<span class="r13 r">isModeChanged</span>)
                {
                    <a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#6c1ab9fc2b7085b1" class="i method">SetMode</a>(<span class="r11 r">handle</span>, <span class="r12 r">originalMode</span>);
                }
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
            }
 
            <a href="#8671ee03f8b400f1" class="i method">WriteLineToConsole</a>();
            <span class="i">PostRead</span>(<span class="r10 r">result</span>.<span class="i">ToString</span>());
            <b>if</b> (<span class="r6 r">isSecureString</span>)
            {
                <b>return</b> <span class="r9 r">secureResult</span>;
            }
            <b>else</b>
            {
                <b>return</b> <span class="r10 r">result</span>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Handle writing print token with proper cursor adjustment for ReadLineSafe.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r28 r">printToken</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> token output for each char input. It must be a one-char string</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r29 r">originalCursorPosition</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> it is the cursor position where ReadLineSafe begins</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="/System.Management.Automation/A.html#4b15a598e99c7dd9" class="t t">HostException</a><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If obtaining information about the buffer failed</span>
        <span class="c">///</span><span class="c">    OR</span>
        <span class="c">///</span><span class="c">    Win32&#39;s SetConsoleCursorPosition failed</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>private void</b> <a id="b326bbe4372a2fca" href="../../R/b326bbe4372a2fca.html" target="n" data-glyph="76,1" class="i method">WritePrintToken</a>(
            <b>string</b> <span id="r28 rd" class="r28 r">printToken</span>,
            <b>ref</b> <a href="/System.Management.Automation/A.html#c6f6da6e12de292e" class="t t">Coordinates</a> <span id="r29 rd" class="r29 r">originalCursorPosition</span>)
        {
            <a href="/System.Management.Automation/A.html#c04955255430d32f" class="t t">Dbg</a>.<span class="i">Assert</span>(!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r28 r">printToken</span>),
                <span class="s">&quot;Calling WritePrintToken with printToken being null or empty&quot;</span>);
            <a href="/System.Management.Automation/A.html#c04955255430d32f" class="t t">Dbg</a>.<span class="i">Assert</span>(<span class="r28 r">printToken</span>.<span class="i">Length</span> == 1,
                <span class="s">&quot;Calling WritePrintToken with printToken&#39;s Length being &quot;</span> + <span class="r28 r">printToken</span>.<span class="i">Length</span>);
            <a href="/System.Management.Automation/A.html#4d1d20b1c8ac2812" class="t t">Size</a> <span id="r30 rd" class="r30 r">consoleBufferSize</span> = <a href="#370e7f4dd3c19e58" class="i field">_rawui</a>.<a href="ConsoleHostRawUserInterface.cs.html#fd18ef5c5670be87" class="i property">BufferSize</a>;
            <a href="/System.Management.Automation/A.html#c6f6da6e12de292e" class="t t">Coordinates</a> <span id="r31 rd" class="r31 r">currentCursorPosition</span> = <a href="#370e7f4dd3c19e58" class="i field">_rawui</a>.<a href="ConsoleHostRawUserInterface.cs.html#1ceb2774733b1ee1" class="i property">CursorPosition</a>;
 
            <span class="c">// if the cursor is currently at the lower right corner, this write will cause the screen buffer to</span>
            <span class="c">// scroll up. So, it is necessary to adjust the original cursor position one row up.</span>
            <b>if</b> (<span class="r31 r">currentCursorPosition</span>.<a href="/System.Management.Automation/A.html#168280a926d1b9da" class="i property">Y</a> &gt;= <span class="r30 r">consoleBufferSize</span>.<a href="/System.Management.Automation/A.html#5ca800015fea1ce6" class="i property">Height</a> - 1 &amp;&amp; <span class="c">// last row</span>
                <span class="r31 r">currentCursorPosition</span>.<a href="/System.Management.Automation/A.html#62aff8c33e5f09b9" class="i property">X</a> &gt;= <span class="r30 r">consoleBufferSize</span>.<a href="/System.Management.Automation/A.html#cc1bb8de7549bf9d" class="i property">Width</a> - 1)  <span class="c">// last column</span>
            {
                <b>if</b> (<span class="r29 r">originalCursorPosition</span>.<a href="/System.Management.Automation/A.html#168280a926d1b9da" class="i property">Y</a> &gt; 0)
                {
                    <span class="r29 r">originalCursorPosition</span>.<a href="/System.Management.Automation/A.html#168280a926d1b9da" class="i property">Y</a>--;
                }
            }
 
            <span class="i">WriteToConsole</span>(<span class="r28 r">printToken</span>, <b>false</b>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Handle backspace with proper cursor adjustment for ReadLineSafe.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r32 r">originalCursorPosition</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> it is the cursor position where ReadLineSafe begins</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="/System.Management.Automation/A.html#4b15a598e99c7dd9" class="t t">HostException</a><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If obtaining information about the buffer failed</span>
        <span class="c">///</span><span class="c">    OR</span>
        <span class="c">///</span><span class="c">    Win32&#39;s SetConsoleCursorPosition failed</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>private void</b> <a id="ea295ac68d4ad614" href="../../R/ea295ac68d4ad614.html" target="n" data-glyph="76,1" class="i method">WriteBackSpace</a>(<a href="/System.Management.Automation/A.html#c6f6da6e12de292e" class="t t">Coordinates</a> <span id="r32 rd" class="r32 r">originalCursorPosition</span>)
        {
            <a href="/System.Management.Automation/A.html#c6f6da6e12de292e" class="t t">Coordinates</a> <span id="r33 rd" class="r33 r">cursorPosition</span> = <a href="#370e7f4dd3c19e58" class="i field">_rawui</a>.<a href="ConsoleHostRawUserInterface.cs.html#1ceb2774733b1ee1" class="i property">CursorPosition</a>;
            <b>if</b> (<span class="r33 r">cursorPosition</span> == <span class="r32 r">originalCursorPosition</span>)
            {
                <span class="c">// at originalCursorPosition, don&#39;t move</span>
                <b>return</b>;
            }
 
            <b>if</b> (<span class="r33 r">cursorPosition</span>.<a href="/System.Management.Automation/A.html#62aff8c33e5f09b9" class="i property">X</a> == 0)
            {
                <b>if</b> (<span class="r33 r">cursorPosition</span>.<a href="/System.Management.Automation/A.html#168280a926d1b9da" class="i property">Y</a> &lt;= <span class="r32 r">originalCursorPosition</span>.<a href="/System.Management.Automation/A.html#168280a926d1b9da" class="i property">Y</a>)
                {
                    <b>return</b>;
                }
                <span class="c">// BufferSize.Width is 1 larger than cursor position</span>
                <span class="r33 r">cursorPosition</span>.<a href="/System.Management.Automation/A.html#62aff8c33e5f09b9" class="i property">X</a> = <a href="#370e7f4dd3c19e58" class="i field">_rawui</a>.<a href="ConsoleHostRawUserInterface.cs.html#fd18ef5c5670be87" class="i property">BufferSize</a>.<a href="/System.Management.Automation/A.html#cc1bb8de7549bf9d" class="i property">Width</a> - 1;
                <span class="r33 r">cursorPosition</span>.<a href="/System.Management.Automation/A.html#168280a926d1b9da" class="i property">Y</a>--;
                <a href="#0f6c5131a0ac8ec0" class="i method">BlankAtCursor</a>(<span class="r33 r">cursorPosition</span>);
            }
            <b>else</b> <b>if</b> (<span class="r33 r">cursorPosition</span>.<a href="/System.Management.Automation/A.html#62aff8c33e5f09b9" class="i property">X</a> &gt; 0)
            {
                <span class="r33 r">cursorPosition</span>.<a href="/System.Management.Automation/A.html#62aff8c33e5f09b9" class="i property">X</a>--;
                <a href="#0f6c5131a0ac8ec0" class="i method">BlankAtCursor</a>(<span class="r33 r">cursorPosition</span>);
            }
            <span class="c">// do nothing if cursorPosition.X is left of screen</span>
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Blank out at and move rawui.CursorPosition to </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r34 r">cursorPosition</span><span class="c">&quot;</span><span class="c">/&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r34 r">cursorPosition</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Position to blank out.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>private void</b> <a id="0f6c5131a0ac8ec0" href="../../R/0f6c5131a0ac8ec0.html" target="n" data-glyph="76,1" class="i method">BlankAtCursor</a>(<a href="/System.Management.Automation/A.html#c6f6da6e12de292e" class="t t">Coordinates</a> <span id="r34 rd" class="r34 r">cursorPosition</span>)
        {
            <a href="#370e7f4dd3c19e58" class="i field">_rawui</a>.<a href="ConsoleHostRawUserInterface.cs.html#1ceb2774733b1ee1" class="i property">CursorPosition</a> = <span class="r34 r">cursorPosition</span>;
            <span class="i">WriteToConsole</span>(<span class="s">&quot; &quot;</span>, <b>true</b>);
            <a href="#370e7f4dd3c19e58" class="i field">_rawui</a>.<a href="ConsoleHostRawUserInterface.cs.html#1ceb2774733b1ee1" class="i property">CursorPosition</a> = <span class="r34 r">cursorPosition</span>;
        }
 
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">UNIX</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r35 r">m</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> is set on </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r36 r">flagToUnset</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c">, unset it and return true;</span>
        <span class="c">///</span><span class="c"> otherwise return false.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r36 r">flagToUnset</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> a flag in ConsoleControl.ConsoleModes to be unset in </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r35 r">m</span><span class="c">&quot;</span><span class="c">/&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r35 r">m</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> true if </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r35 r">m</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> is set on </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r36 r">flagToUnset</span><span class="c">&quot;</span><span class="c">/&gt;</span>
        <span class="c">///</span><span class="c"> false otherwise</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>private static bool</b> <a id="719815fc54ed1d21" href="../../R/719815fc54ed1d21.html" target="n" data-glyph="76,1" class="i method">shouldUnsetMode</a>(
            <a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#1d1eff9fb00ac8e2" class="t t">ConsoleModes</a> <span id="r36 rd" class="r36 r">flagToUnset</span>,
            <b>ref</b> <a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#1d1eff9fb00ac8e2" class="t t">ConsoleModes</a> <span id="r35 rd" class="r35 r">m</span>)
        {
            <b>if</b> ((<span class="r35 r">m</span> &amp; <span class="r36 r">flagToUnset</span>) &gt; 0)
            {
                <span class="r35 r">m</span> &amp;= ~<span class="r36 r">flagToUnset</span>;
                <b>return</b> <b>true</b>;
            }
 
            <b>return</b> <b>false</b>;
        }
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> WriteToConsole
 
        [<span class="i">MethodImpl</span>(<span class="i">MethodImplOptions</span>.<span class="i">AggressiveInlining</span>)]
        <b>internal void</b> <a id="7bbdf405250a2a18" href="../../R/7bbdf405250a2a18.html" target="n" data-glyph="74,1" class="i method">WriteToConsole</a>(<b>char</b> <span id="r37 rd" class="r37 r">c</span>, <b>bool</b> <span id="r38 rd" class="r38 r">transcribeResult</span>)
        {
            <span class="i">ReadOnlySpan</span>&lt;<b>char</b>&gt; <span id="r39 rd" class="r39 r">value</span> = <b>stackalloc char</b>[1] { <span class="r37 r">c</span> };
            <a href="#60237ce2b540bf10" class="i method">WriteToConsole</a>(<span class="r39 r">value</span>, <span class="r38 r">transcribeResult</span>);
        }
 
        [<span class="i">MethodImpl</span>(<span class="i">MethodImplOptions</span>.<span class="i">AggressiveInlining</span>)]
        <b>internal void</b> <a id="60237ce2b540bf10" href="../../R/60237ce2b540bf10.html" target="n" data-glyph="74,1" class="i method">WriteToConsole</a>(<span class="i">ReadOnlySpan</span>&lt;<b>char</b>&gt; <span id="r40 rd" class="r40 r">value</span>, <b>bool</b> <span id="r41 rd" class="r41 r">transcribeResult</span>)
        {
            <a href="#ab9689fce278f50f" class="i method">WriteToConsole</a>(<span class="r40 r">value</span>, <span class="r41 r">transcribeResult</span>, <span class="r42 r">newLine</span>: <b>false</b>);
        }
 
        <b>private void</b> <a id="ab9689fce278f50f" href="../../R/ab9689fce278f50f.html" target="n" data-glyph="76,1" class="i method">WriteToConsole</a>(<span class="i">ReadOnlySpan</span>&lt;<b>char</b>&gt; <span id="r43 rd" class="r43 r">value</span>, <b>bool</b> <span id="r44 rd" class="r44 r">transcribeResult</span>, <b>bool</b> <span id="r42 rd" class="r42 r">newLine</span>)
        {
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">UNIX</span>
            <span class="i">ConsoleHandle</span> <span id="r45 rd" class="r45 r">handle</span> = <a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#d72136ddad017191" class="i method">GetActiveScreenBufferHandle</a>();
 
            <span class="c">// Ensure that we&#39;re in the proper line-output mode.  We don&#39;t lock here as it does not matter if we</span>
            <span class="c">// attempt to set the mode from multiple threads at once.</span>
            <a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#1d1eff9fb00ac8e2" class="t t">ConsoleModes</a> <span id="r46 rd" class="r46 r">m</span> = <a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#133579be57ae9c3e" class="i method">GetMode</a>(<span class="r45 r">handle</span>);
 
            <b>const</b> <a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#1d1eff9fb00ac8e2" class="t t">ConsoleModes</a> <span id="r47 rd" class="r47 r">DesiredMode</span> =
                <a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#1d1eff9fb00ac8e2" class="t t">ConsoleModes</a>.<a href="ConsoleControl.cs.html#4e6e0e9e95f52938" class="i field">ProcessedOutput</a>
                | <a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#1d1eff9fb00ac8e2" class="t t">ConsoleModes</a>.<a href="ConsoleControl.cs.html#1143cb06c4507f89" class="i field">WrapEndOfLine</a>;
 
            <b>if</b> ((<span class="r46 r">m</span> &amp; <span class="r47 r">DesiredMode</span>) != <span class="r47 r">DesiredMode</span>)
            {
                <span class="r46 r">m</span> |= <span class="r47 r">DesiredMode</span>;
                <a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#6c1ab9fc2b7085b1" class="i method">SetMode</a>(<span class="r45 r">handle</span>, <span class="r46 r">m</span>);
            }
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
 
            <a href="ConsoleHostUserInterfaceProgress.cs.html#ef6e7c8608be1f7c" class="i method">PreWrite</a>();
 
            <span class="c">// This is atomic, so we don&#39;t lock here...</span>
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">UNIX</span>
            <a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#565a10751a537803" class="i method">WriteConsole</a>(<span class="r45 r">handle</span>, <span class="r43 r">value</span>, <span class="r42 r">newLine</span>);
<span class="k preprocess">#</span><span class="k preprocess">else</span>
<span class="e">            ConsoleOutWriteHelper(value, newLine);
</span><span class="k preprocess">#</span><span class="k preprocess">endif</span>
 
            <b>if</b> (<a href="#142e9a50cad75382" class="i field">_isInteractiveTestToolListening</a> &amp;&amp; <span class="i">Console</span>.<span class="i">IsOutputRedirected</span>)
            {
                <a href="#ba67f43d0e9cca67" class="i method">ConsoleOutWriteHelper</a>(<span class="r43 r">value</span>, <span class="r42 r">newLine</span>);
            }
 
            <b>if</b> (<span class="r44 r">transcribeResult</span>)
            {
                <a href="ConsoleHostUserInterfaceProgress.cs.html#637e35a2519542eb" class="i method">PostWrite</a>(<span class="r43 r">value</span>, <span class="r42 r">newLine</span>);
            }
            <b>else</b>
            {
                <a href="ConsoleHostUserInterfaceProgress.cs.html#c2d7efd21bf0d131" class="i method">PostWrite</a>();
            }
        }
 
        <b>private void</b> <a id="841785d96a0fadf2" href="../../R/841785d96a0fadf2.html" target="n" data-glyph="76,1" class="i method">WriteToConsole</a>(<span class="i">ConsoleColor</span> <span id="r48 rd" class="r48 r">foregroundColor</span>, <span class="i">ConsoleColor</span> <span id="r49 rd" class="r49 r">backgroundColor</span>, <b>string</b> <span id="r50 rd" class="r50 r">text</span>, <b>bool</b> <span id="r51 rd" class="r51 r">newLine</span> = <b>false</b>)
        {
            <span class="c">// Sync access so that we don&#39;t conflict on color settings if called from multiple threads.</span>
            <b>lock</b> (<a href="#dbd28972ee208717" class="i field">_instanceLock</a>)
            {
                <span class="i">ConsoleColor</span> <span id="r52 rd" class="r52 r">fg</span> = <a href="#33b028e308b5319d" class="i property">RawUI</a>.<a href="/System.Management.Automation/A.html#3a17cd9a690cee92" class="i property">ForegroundColor</a>;
                <span class="i">ConsoleColor</span> <span id="r53 rd" class="r53 r">bg</span> = <a href="#33b028e308b5319d" class="i property">RawUI</a>.<a href="/System.Management.Automation/A.html#e2891a44a8939f10" class="i property">BackgroundColor</a>;
 
                <a href="#33b028e308b5319d" class="i property">RawUI</a>.<a href="/System.Management.Automation/A.html#3a17cd9a690cee92" class="i property">ForegroundColor</a> = <span class="r48 r">foregroundColor</span>;
                <a href="#33b028e308b5319d" class="i property">RawUI</a>.<a href="/System.Management.Automation/A.html#e2891a44a8939f10" class="i property">BackgroundColor</a> = <span class="r49 r">backgroundColor</span>;
 
                <b>try</b>
                {
                    <span class="i">WriteToConsole</span>(<span class="r50 r">text</span>, <span class="i">transcribeResult</span>: <b>true</b>, <span class="r51 r">newLine</span>);
                }
                <b>finally</b>
                {
                    <a href="#33b028e308b5319d" class="i property">RawUI</a>.<a href="/System.Management.Automation/A.html#3a17cd9a690cee92" class="i property">ForegroundColor</a> = <span class="r52 r">fg</span>;
                    <a href="#33b028e308b5319d" class="i property">RawUI</a>.<a href="/System.Management.Automation/A.html#e2891a44a8939f10" class="i property">BackgroundColor</a> = <span class="r53 r">bg</span>;
                }
            }
        }
 
        [<span class="i">MethodImpl</span>(<span class="i">MethodImplOptions</span>.<span class="i">AggressiveInlining</span>)]
        <b>private static void</b> <a id="ba67f43d0e9cca67" href="../../R/ba67f43d0e9cca67.html" target="n" data-glyph="76,1" class="i method">ConsoleOutWriteHelper</a>(<span class="i">ReadOnlySpan</span>&lt;<b>char</b>&gt; <span id="r54 rd" class="r54 r">value</span>, <b>bool</b> <span id="r55 rd" class="r55 r">newLine</span>)
        {
            <b>if</b> (<span class="r55 r">newLine</span>)
            {
                <span class="i">Console</span>.<span class="i">Out</span>.<span class="i">WriteLine</span>(<span class="r54 r">value</span>);
            }
            <b>else</b>
            {
                <span class="i">Console</span>.<span class="i">Out</span>.<span class="i">Write</span>(<span class="r54 r">value</span>);
            }
        }
 
        [<span class="i">MethodImpl</span>(<span class="i">MethodImplOptions</span>.<span class="i">AggressiveInlining</span>)]
        <b>internal void</b> <a id="778b4806740d8c52" href="../../R/778b4806740d8c52.html" target="n" data-glyph="74,1" class="i method">WriteLineToConsole</a>(<span class="i">ReadOnlySpan</span>&lt;<b>char</b>&gt; <span id="r56 rd" class="r56 r">value</span>, <b>bool</b> <span id="r57 rd" class="r57 r">transcribeResult</span>)
        {
            <a href="#ab9689fce278f50f" class="i method">WriteToConsole</a>(<span class="r56 r">value</span>, <span class="r57 r">transcribeResult</span>, <span class="r42 r">newLine</span>: <b>true</b>);
        }
 
        [<span class="i">MethodImpl</span>(<span class="i">MethodImplOptions</span>.<span class="i">AggressiveInlining</span>)]
        <b>private void</b> <a id="a4212704d4eac0fe" href="../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">WriteLineToConsole</a>(<span class="i">ConsoleColor</span> <span id="r58 rd" class="r58 r">foregroundColor</span>, <span class="i">ConsoleColor</span> <span id="r59 rd" class="r59 r">backgroundColor</span>, <b>string</b> <span id="r60 rd" class="r60 r">text</span>)
        {
            <a href="#841785d96a0fadf2" class="i method">WriteToConsole</a>(<span class="r58 r">foregroundColor</span>, <span class="r59 r">backgroundColor</span>, <span class="r60 r">text</span>, <span class="r51 r">newLine</span>: <b>true</b>);
        }
 
        [<span class="i">MethodImpl</span>(<span class="i">MethodImplOptions</span>.<span class="i">AggressiveInlining</span>)]
        <b>private void</b> <a id="cc0b90f30a6d1624" href="../../R/cc0b90f30a6d1624.html" target="n" data-glyph="76,1" class="i method">WriteLineToConsole</a>(<b>string</b> <span id="r61 rd" class="r61 r">text</span>)
        {
            <span class="i">WriteLineToConsole</span>(<span class="r61 r">text</span>, <span class="i">transcribeResult</span>: <b>true</b>);
        }
 
        [<span class="i">MethodImpl</span>(<span class="i">MethodImplOptions</span>.<span class="i">AggressiveInlining</span>)]
        <b>private void</b> <a id="8671ee03f8b400f1" href="../../R/8671ee03f8b400f1.html" target="n" data-glyph="76,1" class="i method">WriteLineToConsole</a>()
        {
            <span class="i">WriteToConsole</span>(<span class="i">Environment</span>.<span class="i">NewLine</span>, <span class="i">transcribeResult</span>: <b>true</b>, <span class="i">newLine</span>: <b>false</b>);
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> WriteToConsole
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> See base class.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r62 r">value</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="/System.Management.Automation/A.html#4b15a598e99c7dd9" class="t t">HostException</a><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If Win32&#39;s CreateFile fails</span>
        <span class="c">///</span><span class="c">    OR</span>
        <span class="c">///</span><span class="c">    Win32&#39;s GetConsoleMode fails</span>
        <span class="c">///</span><span class="c">    OR</span>
        <span class="c">///</span><span class="c">    Win32&#39;s SetConsoleMode fails</span>
        <span class="c">///</span><span class="c">    OR</span>
        <span class="c">///</span><span class="c">    Win32&#39;s WriteConsole fails</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>public override void</b> <a id="195231463f5f905d" href="../../R/195231463f5f905d.html" target="n" data-glyph="72,1" class="i method">Write</a>(<b>string</b> <span id="r62 rd" class="r62 r">value</span>)
        {
            <a href="#b5a514283a20a609" class="i method">WriteImpl</a>(<span class="r62 r">value</span>, <span class="r63 r">newLine</span>: <b>false</b>);
        }
 
        <b>private void</b> <a id="b5a514283a20a609" href="../../R/b5a514283a20a609.html" target="n" data-glyph="76,1" class="i method">WriteImpl</a>(<b>string</b> <span id="r64 rd" class="r64 r">value</span>, <b>bool</b> <span id="r63 rd" class="r63 r">newLine</span>)
        {
            <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r64 r">value</span>) &amp;&amp; !<span class="r63 r">newLine</span>)
            {
                <b>return</b>;
            }
 
            <span class="c">// If the test hook is set, write to it and continue.</span>
            <b>if</b> (<a href="#67f5bbca9042b4f7" class="i field">s_h</a> != <b>null</b>)
            {
                <b>if</b> (<span class="r63 r">newLine</span>)
                {
                    <a href="#67f5bbca9042b4f7" class="i field">s_h</a>.<span class="i">WriteLine</span>(<span class="r64 r">value</span>);
                }
                <b>else</b>
                {
                    <a href="#67f5bbca9042b4f7" class="i field">s_h</a>.<span class="i">Write</span>(<span class="r64 r">value</span>);
                }
            }
 
            <span class="i">TextWriter</span> <span id="r65 rd" class="r65 r">writer</span> = <span class="i">Console</span>.<span class="i">IsOutputRedirected</span> ? <span class="i">Console</span>.<span class="i">Out</span> : <a href="#84b0fd621e4256ef" class="i field">_parent</a>.<a href="ConsoleHost.cs.html#242f4eeac16479ac" class="i property">ConsoleTextWriter</a>;
            <span class="r64 r">value</span> = <span class="i">Utils</span>.<span class="i">GetOutputString</span>(<span class="r64 r">value</span>, <span class="i">isHost</span>: <b>true</b>, <a href="#5db1812edea1b244" class="i property">SupportsVirtualTerminal</a>, <span class="i">Console</span>.<span class="i">IsOutputRedirected</span>);
 
            <b>if</b> (<a href="#84b0fd621e4256ef" class="i field">_parent</a>.<a href="ConsoleHost.cs.html#3aff0a908296b7f4" class="i property">IsRunningAsync</a>)
            {
                <a href="/System.Management.Automation/A.html#c04955255430d32f" class="t t">Dbg</a>.<span class="i">Assert</span>(<span class="r65 r">writer</span> == <a href="#84b0fd621e4256ef" class="i field">_parent</a>.<a href="ConsoleHost.cs.html#b73fdaa94687f263" class="i property">OutputSerializer</a>.<a href="Serialization.cs.html#8abd46b3df916b2c" class="i field">textWriter</a>, <span class="s">&quot;writers should be the same&quot;</span>);
 
                <a href="#84b0fd621e4256ef" class="i field">_parent</a>.<a href="ConsoleHost.cs.html#b73fdaa94687f263" class="i property">OutputSerializer</a>.<a href="Serialization.cs.html#0029de3a8b2e2b68" class="i method">Serialize</a>(<span class="r64 r">value</span>);
 
                <b>if</b> (<span class="r63 r">newLine</span>)
                {
                    <a href="#84b0fd621e4256ef" class="i field">_parent</a>.<a href="ConsoleHost.cs.html#b73fdaa94687f263" class="i property">OutputSerializer</a>.<span class="i">Serialize</span>(<span class="i">Environment</span>.<span class="i">NewLine</span>);
                }
            }
            <b>else</b>
            {
                <b>if</b> (<span class="r63 r">newLine</span>)
                {
                    <span class="r65 r">writer</span>.<span class="i">WriteLine</span>(<span class="r64 r">value</span>);
                }
                <b>else</b>
                {
                    <span class="r65 r">writer</span>.<span class="i">Write</span>(<span class="r64 r">value</span>);
                }
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> See base class.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r66 r">foregroundColor</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r67 r">backgroundColor</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r68 r">value</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="/System.Management.Automation/A.html#4b15a598e99c7dd9" class="t t">HostException</a><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If obtaining information about the buffer failed</span>
        <span class="c">///</span><span class="c">    OR</span>
        <span class="c">///</span><span class="c">    Win32&#39;s SetConsoleTextAttribute</span>
        <span class="c">///</span><span class="c">    OR</span>
        <span class="c">///</span><span class="c">    Win32&#39;s CreateFile fails</span>
        <span class="c">///</span><span class="c">    OR</span>
        <span class="c">///</span><span class="c">    Win32&#39;s GetConsoleMode fails</span>
        <span class="c">///</span><span class="c">    OR</span>
        <span class="c">///</span><span class="c">    Win32&#39;s SetConsoleMode fails</span>
        <span class="c">///</span><span class="c">    OR</span>
        <span class="c">///</span><span class="c">    Win32&#39;s WriteConsole fails</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>public override void</b> <a id="e05a3d6eeb57b1f8" href="../../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">Write</a>(<span class="i">ConsoleColor</span> <span id="r66 rd" class="r66 r">foregroundColor</span>, <span class="i">ConsoleColor</span> <span id="r67 rd" class="r67 r">backgroundColor</span>, <b>string</b> <span id="r68 rd" class="r68 r">value</span>)
        {
            <a href="#d90c61c8fa7e5aa3" class="i method">Write</a>(<span class="r66 r">foregroundColor</span>, <span class="r67 r">backgroundColor</span>, <span class="r68 r">value</span>, <span class="r69 r">newLine</span>: <b>false</b>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> See base class.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r70 r">foregroundColor</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r71 r">backgroundColor</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r72 r">value</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="/System.Management.Automation/A.html#4b15a598e99c7dd9" class="t t">HostException</a><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If obtaining information about the buffer failed</span>
        <span class="c">///</span><span class="c">    OR</span>
        <span class="c">///</span><span class="c">    Win32&#39;s SetConsoleTextAttribute</span>
        <span class="c">///</span><span class="c">    OR</span>
        <span class="c">///</span><span class="c">    Win32&#39;s CreateFile fails</span>
        <span class="c">///</span><span class="c">    OR</span>
        <span class="c">///</span><span class="c">    Win32&#39;s GetConsoleMode fails</span>
        <span class="c">///</span><span class="c">    OR</span>
        <span class="c">///</span><span class="c">    Win32&#39;s SetConsoleMode fails</span>
        <span class="c">///</span><span class="c">    OR</span>
        <span class="c">///</span><span class="c">    Win32&#39;s WriteConsole fails</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>public override void</b> <a id="9c3a74d382e85a6e" href="../../R/9c3a74d382e85a6e.html" target="n" data-glyph="72,1" class="i method">WriteLine</a>(<span class="i">ConsoleColor</span> <span id="r70 rd" class="r70 r">foregroundColor</span>, <span class="i">ConsoleColor</span> <span id="r71 rd" class="r71 r">backgroundColor</span>, <b>string</b> <span id="r72 rd" class="r72 r">value</span>)
        {
            <a href="#d90c61c8fa7e5aa3" class="i method">Write</a>(<span class="r70 r">foregroundColor</span>, <span class="r71 r">backgroundColor</span>, <span class="r72 r">value</span>, <span class="r69 r">newLine</span>: <b>true</b>);
        }
 
        <b>private void</b> <a id="d90c61c8fa7e5aa3" href="../../R/d90c61c8fa7e5aa3.html" target="n" data-glyph="76,1" class="i method">Write</a>(<span class="i">ConsoleColor</span> <span id="r73 rd" class="r73 r">foregroundColor</span>, <span class="i">ConsoleColor</span> <span id="r74 rd" class="r74 r">backgroundColor</span>, <b>string</b> <span id="r75 rd" class="r75 r">value</span>, <b>bool</b> <span id="r69 rd" class="r69 r">newLine</span>)
        {
            <span class="c">// Sync access so that we don&#39;t conflict on color settings if called from multiple threads.</span>
            <b>lock</b> (<a href="#dbd28972ee208717" class="i field">_instanceLock</a>)
            {
                <span class="i">ConsoleColor</span> <span id="r76 rd" class="r76 r">fg</span> = <a href="#33b028e308b5319d" class="i property">RawUI</a>.<a href="/System.Management.Automation/A.html#3a17cd9a690cee92" class="i property">ForegroundColor</a>;
                <span class="i">ConsoleColor</span> <span id="r77 rd" class="r77 r">bg</span> = <a href="#33b028e308b5319d" class="i property">RawUI</a>.<a href="/System.Management.Automation/A.html#e2891a44a8939f10" class="i property">BackgroundColor</a>;
 
                <a href="#33b028e308b5319d" class="i property">RawUI</a>.<a href="/System.Management.Automation/A.html#3a17cd9a690cee92" class="i property">ForegroundColor</a> = <span class="r73 r">foregroundColor</span>;
                <a href="#33b028e308b5319d" class="i property">RawUI</a>.<a href="/System.Management.Automation/A.html#e2891a44a8939f10" class="i property">BackgroundColor</a> = <span class="r74 r">backgroundColor</span>;
 
                <b>try</b>
                {
                    <a href="../../P/b737197b2d219638.html#b737197b2d219638" class="k">this</a>.<a href="#b5a514283a20a609" class="i method">WriteImpl</a>(<span class="r75 r">value</span>, <span class="r69 r">newLine</span>);
                }
                <b>finally</b>
                {
                    <a href="#33b028e308b5319d" class="i property">RawUI</a>.<a href="/System.Management.Automation/A.html#3a17cd9a690cee92" class="i property">ForegroundColor</a> = <span class="r76 r">fg</span>;
                    <a href="#33b028e308b5319d" class="i property">RawUI</a>.<a href="/System.Management.Automation/A.html#e2891a44a8939f10" class="i property">BackgroundColor</a> = <span class="r77 r">bg</span>;
                }
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> See base class.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r78 r">value</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="/System.Management.Automation/A.html#4b15a598e99c7dd9" class="t t">HostException</a><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">    Win32&#39;s CreateFile fails</span>
        <span class="c">///</span><span class="c">    OR</span>
        <span class="c">///</span><span class="c">    Win32&#39;s GetConsoleMode fails</span>
        <span class="c">///</span><span class="c">    OR</span>
        <span class="c">///</span><span class="c">    Win32&#39;s SetConsoleMode fails</span>
        <span class="c">///</span><span class="c">    OR</span>
        <span class="c">///</span><span class="c">    Win32&#39;s WriteConsole fails</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>public override void</b> <a id="07fd0950d75ee8ef" href="../../R/07fd0950d75ee8ef.html" target="n" data-glyph="72,1" class="i method">WriteLine</a>(<b>string</b> <span id="r78 rd" class="r78 r">value</span>)
        {
            <a href="../../P/b737197b2d219638.html#b737197b2d219638" class="k">this</a>.<a href="#b5a514283a20a609" class="i method">WriteImpl</a>(<span class="r78 r">value</span>, <span class="r63 r">newLine</span>: <b>true</b>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> See base class.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="/System.Management.Automation/A.html#4b15a598e99c7dd9" class="t t">HostException</a><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">    Win32&#39;s CreateFile fails</span>
        <span class="c">///</span><span class="c">    OR</span>
        <span class="c">///</span><span class="c">    Win32&#39;s GetConsoleMode fails</span>
        <span class="c">///</span><span class="c">    OR</span>
        <span class="c">///</span><span class="c">    Win32&#39;s SetConsoleMode fails</span>
        <span class="c">///</span><span class="c">    OR</span>
        <span class="c">///</span><span class="c">    Win32&#39;s WriteConsole fails</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>public override void</b> <a id="53186981e97affd9" href="../../R/53186981e97affd9.html" target="n" data-glyph="72,1" class="i method">WriteLine</a>()
        {
            <a href="../../P/b737197b2d219638.html#b737197b2d219638" class="k">this</a>.<span class="i">WriteImpl</span>(<span class="i">Environment</span>.<span class="i">NewLine</span>, <span class="i">newLine</span>: <b>false</b>);
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Word Wrapping
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This is a poor-man&#39;s word-wrapping routine.  It breaks a single string into segments small enough to fit within a</span>
        <span class="c">///</span><span class="c"> given number of cells.  A break is determined by the last occurrence of whitespace that allows all prior characters</span>
        <span class="c">///</span><span class="c"> on a line to be written within a given number of cells.  If there is no whitespace found within that span, then the</span>
        <span class="c">///</span><span class="c"> largest span that will fit in the bounds is used.</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> The problem is complicated by the fact that a single character may consume more than one cell.  Conceptually, this</span>
        <span class="c">///</span><span class="c"> is the same case as placing an upper bound on the length of a line while also having a strlen function that</span>
        <span class="c">///</span><span class="c"> arbitrarily considers the length of any single character to be 1 or greater.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r79 r">text</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Text to be emitted.</span>
        <span class="c">///</span><span class="c"> Each tab character in the text is replaced with a space in the results.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r80 r">maxWidthInBufferCells</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Max width, in buffer cells, of a single line.  Note that a single character may consume more than one cell.  The</span>
        <span class="c">///</span><span class="c"> number of cells consumed is determined by calling ConsoleHostRawUserInterface.LengthInBufferCells.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> A list of strings representing the text broken into &quot;lines&quot; each of which are guaranteed not to exceed</span>
        <span class="c">///</span><span class="c"> maxWidthInBufferCells.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal</b> <span class="i">List</span>&lt;<b>string</b>&gt; <a id="74d5b0d593670b64" href="../../R/../../0000000000.html" target="n" data-glyph="74,1" class="i method">WrapText</a>(<b>string</b> <span id="r79 rd" class="r79 r">text</span>, <b>int</b> <span id="r80 rd" class="r80 r">maxWidthInBufferCells</span>)
        {
            <span class="i">List</span>&lt;<b>string</b>&gt; <span id="r81 rd" class="r81 r">result</span> = <b>new</b> <span class="i">List</span>&lt;<b>string</b>&gt;();
 
            <span class="i">List</span>&lt;<a href="#cfb68e4c64390b3b" class="t t">Word</a>&gt; <span id="r82 rd" class="r82 r">words</span> = <a href="#b9fc9cac7d51cac7" class="i method">ChopTextIntoWords</a>(<span class="r79 r">text</span>, <span class="r80 r">maxWidthInBufferCells</span>);
            <b>if</b> (<span class="r82 r">words</span>.<span class="i">Count</span> &lt; 1)
            {
                <b>return</b> <span class="r81 r">result</span>;
            }
 
            <span class="i">IEnumerator</span>&lt;<a href="#cfb68e4c64390b3b" class="t t">Word</a>&gt; <span id="r83 rd" class="r83 r">e</span> = <span class="r82 r">words</span>.<span class="i">GetEnumerator</span>();
            <b>bool</b> <span id="r84 rd" class="r84 r">valid</span> = <b>false</b>;
            <b>int</b> <span id="r85 rd" class="r85 r">cellCounter</span> = 0;
            <span class="i">StringBuilder</span> <span id="r86 rd" class="r86 r">line</span> = <b>new</b> <span class="i">StringBuilder</span>();
            <b>string</b> <span id="r87 rd" class="r87 r">l</span> = <b>null</b>;
 
            <b>do</b>
            {
                <span class="r84 r">valid</span> = <span class="r83 r">e</span>.<span class="i">MoveNext</span>();
                <b>if</b> (!<span class="r84 r">valid</span>)
                {
                    <b>if</b> (<span class="r86 r">line</span>.<span class="i">Length</span> &gt; 0)
                    {
                        <span class="r87 r">l</span> = <span class="r86 r">line</span>.<span class="i">ToString</span>();
                        <a href="/System.Management.Automation/A.html#c04955255430d32f" class="t t">Dbg</a>.<span class="i">Assert</span>(<a href="#33b028e308b5319d" class="i property">RawUI</a>.<span class="i">LengthInBufferCells</span>(<span class="r87 r">l</span>) &lt;= <span class="r80 r">maxWidthInBufferCells</span>, <span class="s">&quot;line is too long&quot;</span>);
                        <span class="r81 r">result</span>.<span class="i">Add</span>(<span class="r87 r">l</span>);
                    }
 
                    <b>break</b>;
                }
 
                <b>if</b> ((<span class="r83 r">e</span>.<span class="i">Current</span>.<span class="i">Flags</span> &amp; <a href="#9f425d279f3c8644" class="t t">WordFlags</a>.<a href="#9014463100e8447e" class="i field">IsNewline</a>) &gt; 0)
                {
                    <span class="r87 r">l</span> = <span class="r86 r">line</span>.<span class="i">ToString</span>();
                    <a href="/System.Management.Automation/A.html#c04955255430d32f" class="t t">Dbg</a>.<span class="i">Assert</span>(<a href="#33b028e308b5319d" class="i property">RawUI</a>.<span class="i">LengthInBufferCells</span>(<span class="r87 r">l</span>) &lt;= <span class="r80 r">maxWidthInBufferCells</span>, <span class="s">&quot;line is too long&quot;</span>);
                    <span class="r81 r">result</span>.<span class="i">Add</span>(<span class="r87 r">l</span>);
 
                    <span class="c">// skip the newline &quot;words&quot;</span>
 
                    <span class="r86 r">line</span> = <b>new</b> <span class="i">StringBuilder</span>();
                    <span class="r85 r">cellCounter</span> = 0;
                    <b>continue</b>;
                }
 
                <span class="c">// will the word fit?</span>
 
                <b>if</b> (<span class="r85 r">cellCounter</span> + <span class="r83 r">e</span>.<span class="i">Current</span>.<span class="i">CellCount</span> &lt;= <span class="r80 r">maxWidthInBufferCells</span>)
                {
                    <span class="c">// yes, add it to the line.</span>
 
                    <span class="r86 r">line</span>.<span class="i">Append</span>(<span class="r83 r">e</span>.<span class="i">Current</span>.<span class="i">Text</span>);
                    <span class="r85 r">cellCounter</span> += <span class="r83 r">e</span>.<span class="i">Current</span>.<span class="i">CellCount</span>;
                }
                <b>else</b>
                {
                    <span class="c">// no: too long.  Either start a new line, or pick off as much whitespace as we need.</span>
 
                    <b>if</b> ((<span class="r83 r">e</span>.<span class="i">Current</span>.<span class="i">Flags</span> &amp; <a href="#9f425d279f3c8644" class="t t">WordFlags</a>.<a href="#c8d5df675d835849" class="i field">IsWhitespace</a>) == 0)
                    {
                        <span class="r87 r">l</span> = <span class="r86 r">line</span>.<span class="i">ToString</span>();
                        <a href="/System.Management.Automation/A.html#c04955255430d32f" class="t t">Dbg</a>.<span class="i">Assert</span>(<a href="#33b028e308b5319d" class="i property">RawUI</a>.<span class="i">LengthInBufferCells</span>(<span class="r87 r">l</span>) &lt;= <span class="r80 r">maxWidthInBufferCells</span>, <span class="s">&quot;line is too long&quot;</span>);
                        <span class="r81 r">result</span>.<span class="i">Add</span>(<span class="r87 r">l</span>);
 
                        <span class="r86 r">line</span> = <b>new</b> <span class="i">StringBuilder</span>(<span class="r83 r">e</span>.<span class="i">Current</span>.<span class="i">Text</span>);
                        <span class="r85 r">cellCounter</span> = <span class="r83 r">e</span>.<span class="i">Current</span>.<span class="i">CellCount</span>;
                        <b>continue</b>;
                    }
 
                    <span class="c">// chop the whitespace into bits.</span>
 
                    <b>int</b> <span id="r88 rd" class="r88 r">w</span> = <span class="r80 r">maxWidthInBufferCells</span> - <span class="r85 r">cellCounter</span>;
                    <a href="/System.Management.Automation/A.html#c04955255430d32f" class="t t">Dbg</a>.<span class="i">Assert</span>(<span class="r88 r">w</span> &lt; <span class="r83 r">e</span>.<span class="i">Current</span>.<span class="i">CellCount</span>, <span class="s">&quot;width remaining should be less than size of word&quot;</span>);
 
                    <span class="r86 r">line</span>.<span class="i">Append</span>(<span class="r83 r">e</span>.<span class="i">Current</span>.<span class="i">Text</span>.<span class="i">AsSpan</span>(0, <span class="r88 r">w</span>));
 
                    <span class="r87 r">l</span> = <span class="r86 r">line</span>.<span class="i">ToString</span>();
                    <a href="/System.Management.Automation/A.html#c04955255430d32f" class="t t">Dbg</a>.<span class="i">Assert</span>(<a href="#33b028e308b5319d" class="i property">RawUI</a>.<span class="i">LengthInBufferCells</span>(<span class="r87 r">l</span>) == <span class="r80 r">maxWidthInBufferCells</span>, <span class="s">&quot;line should exactly fit&quot;</span>);
                    <span class="r81 r">result</span>.<span class="i">Add</span>(<span class="r87 r">l</span>);
 
                    <b>string</b> <span id="r89 rd" class="r89 r">remaining</span> = <span class="r83 r">e</span>.<span class="i">Current</span>.<span class="i">Text</span>.<span class="i">Substring</span>(<span class="r88 r">w</span>);
                    <span class="r86 r">line</span> = <b>new</b> <span class="i">StringBuilder</span>(<span class="r89 r">remaining</span>);
                    <span class="r85 r">cellCounter</span> = <a href="#33b028e308b5319d" class="i property">RawUI</a>.<span class="i">LengthInBufferCells</span>(<span class="r89 r">remaining</span>);
                }
            } <b>while</b> (<span class="r84 r">valid</span>);
 
            <b>return</b> <span class="r81 r">result</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Struct used by WrapText.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Flags</span>]
        <b>internal enum</b> <a id="9f425d279f3c8644" href="../../R/9f425d279f3c8644.html" target="n" data-glyph="20,1" class="t t"><span id="97a6cbec98dcebc3">WordFlags</span></a>
        {
            <a id="c8d5df675d835849" href="../../R/c8d5df675d835849.html" target="n" data-glyph="24,2" class="i field">IsWhitespace</a> = 0x01,
            <a id="9014463100e8447e" href="../../R/9014463100e8447e.html" target="n" data-glyph="24,2" class="i field">IsNewline</a> = 0x02
        }
 
        <b>internal struct</b> <a id="cfb68e4c64390b3b" href="../../R/cfb68e4c64390b3b.html" target="n" data-glyph="110,1" class="t t"><span id="bce7b023e884f18f">Word</span></a>
        {
            <b>internal int</b> <a id="bc16d963a7d611ad" href="../../R/bc16d963a7d611ad.html" target="n" data-glyph="44,2" class="i field">CellCount</a>;
            <b>internal string</b> <a id="66a4d881e22e5661" href="../../R/66a4d881e22e5661.html" target="n" data-glyph="44,2" class="i field">Text</a>;
            <b>internal</b> <a href="#9f425d279f3c8644" class="t t">WordFlags</a> <a id="612932f100d8fce1" href="../../R/612932f100d8fce1.html" target="n" data-glyph="44,2" class="i field">Flags</a>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Chops text into &quot;words,&quot; where a word is defined to be a sequence of whitespace characters, or a sequence of</span>
        <span class="c">///</span><span class="c"> non-whitespace characters, each sequence being no longer than a given maximum.  Therefore, in the text &quot;this is a</span>
        <span class="c">///</span><span class="c"> string&quot; there are 7 words: 4 sequences of non-whitespace characters and 3 sequences of whitespace characters.</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> Whitespace is considered to be spaces or tabs.  Each tab character is replaced with a single space.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r90 r">text</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The text to be chopped up.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r91 r">maxWidthInBufferCells</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The maximum number of buffer cells that each word may consume.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> A list of words, in the same order they appear in the source text.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This can be made faster by, instead of creating little strings for each word, creating indices of the start and end</span>
        <span class="c">///</span><span class="c"> range of a word.  That would reduce the string allocations.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>internal</b> <span class="i">List</span>&lt;<a href="#cfb68e4c64390b3b" class="t t">Word</a>&gt; <a id="b9fc9cac7d51cac7" href="../../R/b9fc9cac7d51cac7.html" target="n" data-glyph="74,1" class="i method">ChopTextIntoWords</a>(<b>string</b> <span id="r90 rd" class="r90 r">text</span>, <b>int</b> <span id="r91 rd" class="r91 r">maxWidthInBufferCells</span>)
        {
            <span class="i">List</span>&lt;<a href="#cfb68e4c64390b3b" class="t t">Word</a>&gt; <span id="r92 rd" class="r92 r">result</span> = <b>new</b> <span class="i">List</span>&lt;<a href="#cfb68e4c64390b3b" class="t t">Word</a>&gt;();
 
            <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r90 r">text</span>))
            {
                <b>return</b> <span class="r92 r">result</span>;
            }
 
            <b>if</b> (<span class="r91 r">maxWidthInBufferCells</span> &lt; 1)
            {
                <b>return</b> <span class="r92 r">result</span>;
            }
 
            <span class="r90 r">text</span> = <span class="r90 r">text</span>.<span class="i">Replace</span>(<span class="s">&#39;\t&#39;</span>, <span class="s">&#39; &#39;</span>);
 
            <span class="r92 r">result</span> = <b>new</b> <span class="i">List</span>&lt;<a href="#cfb68e4c64390b3b" class="t t">Word</a>&gt;();
 
            <span class="c">// a &quot;word&quot; is a span of characters delimited by whitespace.  Contiguous whitespace, too, is a word.</span>
 
            <b>int</b> <span id="r93 rd" class="r93 r">startIndex</span> = 0;
            <b>int</b> <span id="r94 rd" class="r94 r">wordEnd</span> = 0;
            <b>bool</b> <span id="r95 rd" class="r95 r">inWs</span> = <b>false</b>;
 
            <b>while</b> (<span class="r94 r">wordEnd</span> &lt; <span class="r90 r">text</span>.<span class="i">Length</span>)
            {
                <b>if</b> (<span class="r90 r">text</span>[<span class="r94 r">wordEnd</span>] == <span class="s">&#39;\n&#39;</span>)
                {
                    <b>if</b> (<span class="r93 r">startIndex</span> &lt; <span class="r94 r">wordEnd</span>)
                    {
                        <span class="c">// the span up to this point needs to be saved off</span>
 
                        <a href="#6dcf5ddd3bb3d0c4" class="i method">AddWord</a>(<span class="r90 r">text</span>, <span class="r93 r">startIndex</span>, <span class="r94 r">wordEnd</span>, <span class="r91 r">maxWidthInBufferCells</span>, <span class="r95 r">inWs</span>, <b>ref</b> <span class="r92 r">result</span>);
                    }
 
                    <span class="c">// add a nl word</span>
 
                    <a href="#cfb68e4c64390b3b" class="t t">Word</a> <span id="r96 rd" class="r96 r">w</span> = <b>new</b> <span class="t">Word</span>();
                    <span class="r96 r">w</span>.<a href="#612932f100d8fce1" class="i field">Flags</a> = <a href="#9f425d279f3c8644" class="t t">WordFlags</a>.<a href="#9014463100e8447e" class="i field">IsNewline</a>;
                    <span class="r92 r">result</span>.<span class="i">Add</span>(<span class="r96 r">w</span>);
 
                    <span class="c">// skip the nl</span>
 
                    ++<span class="r94 r">wordEnd</span>;
                    <span class="r93 r">startIndex</span> = <span class="r94 r">wordEnd</span>;
 
                    <span class="r95 r">inWs</span> = <b>false</b>;
                    <b>continue</b>;
                }
                <b>else</b> <b>if</b> (<span class="r90 r">text</span>[<span class="r94 r">wordEnd</span>] == <span class="s">&#39; &#39;</span>)
                {
                    <b>if</b> (!<span class="r95 r">inWs</span>)
                    {
                        <span class="c">// span from startIndex..(wordEnd - 1) is a word</span>
 
                        <a href="#6dcf5ddd3bb3d0c4" class="i method">AddWord</a>(<span class="r90 r">text</span>, <span class="r93 r">startIndex</span>, <span class="r94 r">wordEnd</span>, <span class="r91 r">maxWidthInBufferCells</span>, <span class="r95 r">inWs</span>, <b>ref</b> <span class="r92 r">result</span>);
                        <span class="r93 r">startIndex</span> = <span class="r94 r">wordEnd</span>;
                    }
 
                    <span class="r95 r">inWs</span> = <b>true</b>;
                }
                <b>else</b>
                {
                    <span class="c">// not whitespace</span>
 
                    <b>if</b> (<span class="r95 r">inWs</span>)
                    {
                        <a href="#6dcf5ddd3bb3d0c4" class="i method">AddWord</a>(<span class="r90 r">text</span>, <span class="r93 r">startIndex</span>, <span class="r94 r">wordEnd</span>, <span class="r91 r">maxWidthInBufferCells</span>, <span class="r95 r">inWs</span>, <b>ref</b> <span class="r92 r">result</span>);
                        <span class="r93 r">startIndex</span> = <span class="r94 r">wordEnd</span>;
                    }
 
                    <span class="r95 r">inWs</span> = <b>false</b>;
                }
 
                ++<span class="r94 r">wordEnd</span>;
            }
 
            <b>if</b> (<span class="r93 r">startIndex</span> != <span class="r94 r">wordEnd</span>)
            {
                <span class="i">AddWord</span>(<span class="r90 r">text</span>, <span class="r93 r">startIndex</span>, <span class="r90 r">text</span>.<span class="i">Length</span>, <span class="r91 r">maxWidthInBufferCells</span>, <span class="r95 r">inWs</span>, <b>ref</b> <span class="r92 r">result</span>);
            }
 
            <b>return</b> <span class="r92 r">result</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Helper for ChopTextIntoWords.  Takes a span of characters in a string and adds it to the word list, further</span>
        <span class="c">///</span><span class="c"> subdividing the span as needed so that each subdivision fits within the limit.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r97 r">text</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The string of characters in which the span is to be extracted.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r98 r">startIndex</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> index into text of the start of the word to be added.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r99 r">endIndex</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> index of the char after the last char to be included in the word.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r100 r">maxWidthInBufferCells</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The maximum number of buffer cells that each word may consume.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r101 r">isWhitespace</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> true if the span is whitespace, false if not.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r102 r">result</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The list into which the words will be added.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="6dcf5ddd3bb3d0c4" href="../../R/6dcf5ddd3bb3d0c4.html" target="n" data-glyph="74,1" class="i method">AddWord</a>(<b>string</b> <span id="r97 rd" class="r97 r">text</span>, <b>int</b> <span id="r98 rd" class="r98 r">startIndex</span>, <b>int</b> <span id="r99 rd" class="r99 r">endIndex</span>,
            <b>int</b> <span id="r100 rd" class="r100 r">maxWidthInBufferCells</span>, <b>bool</b> <span id="r101 rd" class="r101 r">isWhitespace</span>, <b>ref</b> <span class="i">List</span>&lt;<a href="#cfb68e4c64390b3b" class="t t">Word</a>&gt; <span id="r102 rd" class="r102 r">result</span>)
        {
            <a href="/System.Management.Automation/A.html#c04955255430d32f" class="t t">Dbg</a>.<span class="i">Assert</span>(<span class="r99 r">endIndex</span> &gt;= <span class="r98 r">startIndex</span>, <span class="s">&quot;startIndex must be before endIndex&quot;</span>);
            <a href="/System.Management.Automation/A.html#c04955255430d32f" class="t t">Dbg</a>.<span class="i">Assert</span>(<span class="r99 r">endIndex</span> &gt;= 0, <span class="s">&quot;endIndex must be positive&quot;</span>);
            <a href="/System.Management.Automation/A.html#c04955255430d32f" class="t t">Dbg</a>.<span class="i">Assert</span>(<span class="r98 r">startIndex</span> &gt;= 0, <span class="s">&quot;startIndex must be positive&quot;</span>);
            <a href="/System.Management.Automation/A.html#c04955255430d32f" class="t t">Dbg</a>.<span class="i">Assert</span>(<span class="r98 r">startIndex</span> &lt; <span class="r97 r">text</span>.<span class="i">Length</span>, <span class="s">&quot;startIndex must be within the string&quot;</span>);
            <a href="/System.Management.Automation/A.html#c04955255430d32f" class="t t">Dbg</a>.<span class="i">Assert</span>(<span class="r99 r">endIndex</span> &lt;= <span class="r97 r">text</span>.<span class="i">Length</span>, <span class="s">&quot;endIndex must be within the string&quot;</span>);
 
            <b>while</b> (<span class="r98 r">startIndex</span> &lt; <span class="r99 r">endIndex</span>)
            {
                <b>int</b> <span id="r103 rd" class="r103 r">i</span> = <span class="i">Math</span>.<span class="i">Min</span>(<span class="r99 r">endIndex</span>, <span class="r98 r">startIndex</span> + <span class="r100 r">maxWidthInBufferCells</span>);
                <a href="#cfb68e4c64390b3b" class="t t">Word</a> <span id="r104 rd" class="r104 r">w</span> = <b>new</b> <span class="t">Word</span>();
                <b>if</b> (<span class="r101 r">isWhitespace</span>)
                {
                    <span class="r104 r">w</span>.<a href="#612932f100d8fce1" class="i field">Flags</a> = <a href="#9f425d279f3c8644" class="t t">WordFlags</a>.<a href="#c8d5df675d835849" class="i field">IsWhitespace</a>;
                }
 
                <b>while</b> (<b>true</b>)
                {
                    <span class="r104 r">w</span>.<a href="#66a4d881e22e5661" class="i field">Text</a> = <span class="r97 r">text</span>.<span class="i">Substring</span>(<span class="r98 r">startIndex</span>, <span class="r103 r">i</span> - <span class="r98 r">startIndex</span>);
                    <span class="r104 r">w</span>.<a href="#bc16d963a7d611ad" class="i field">CellCount</a> = <a href="#33b028e308b5319d" class="i property">RawUI</a>.<span class="i">LengthInBufferCells</span>(<span class="r104 r">w</span>.<a href="#66a4d881e22e5661" class="i field">Text</a>);
                    <b>if</b> (<span class="r104 r">w</span>.<a href="#bc16d963a7d611ad" class="i field">CellCount</a> &lt;= <span class="r100 r">maxWidthInBufferCells</span>)
                    {
                        <span class="c">// the segment from start..i fits</span>
 
                        <b>break</b>;
                    }
                    <b>else</b>
                    {
                        <span class="c">// The segment does not fit, back off a tad until it does</span>
 
                        --<span class="r103 r">i</span>;
                    }
                }
 
                <a href="/System.Management.Automation/A.html#c04955255430d32f" class="t t">Dbg</a>.<span class="i">Assert</span>(<a href="#33b028e308b5319d" class="i property">RawUI</a>.<span class="i">LengthInBufferCells</span>(<span class="r104 r">w</span>.<a href="#66a4d881e22e5661" class="i field">Text</a>) &lt;= <span class="r100 r">maxWidthInBufferCells</span>, <span class="s">&quot;word should not exceed max&quot;</span>);
                <span class="r102 r">result</span>.<span class="i">Add</span>(<span class="r104 r">w</span>);
 
                <span class="r98 r">startIndex</span> = <span class="r103 r">i</span>;
            }
        }
 
        <b>internal string</b> <a id="d7b1bb0a97b16be7" href="../../R/d7b1bb0a97b16be7.html" target="n" data-glyph="74,1" class="i method">WrapToCurrentWindowWidth</a>(<b>string</b> <span id="r105 rd" class="r105 r">text</span>)
        {
            <span class="i">StringBuilder</span> <span id="r106 rd" class="r106 r">sb</span> = <b>new</b> <span class="i">StringBuilder</span>();
 
            <span class="c">// we leave a 1-cell margin on the end because if the very last character butts up against the</span>
            <span class="c">// edge of the screen buffer, then the console will wrap the line.</span>
 
            <span class="i">List</span>&lt;<b>string</b>&gt; <span id="r107 rd" class="r107 r">lines</span> = <span class="i">WrapText</span>(<span class="r105 r">text</span>, <a href="#33b028e308b5319d" class="i property">RawUI</a>.<a href="/System.Management.Automation/A.html#e690f314a36b033e" class="i property">WindowSize</a>.<a href="/System.Management.Automation/A.html#cc1bb8de7549bf9d" class="i property">Width</a> - 1);
            <b>int</b> <span id="r108 rd" class="r108 r">count</span> = 0;
            <b>foreach</b> (<b>string</b> <span id="r109 rd" class="r109 r">s</span> <b>in</b> <span class="r107 r">lines</span>)
            {
                <span class="r106 r">sb</span>.<span class="i">Append</span>(<span class="r109 r">s</span>);
                <b>if</b> (++<span class="r108 r">count</span> != <span class="r107 r">lines</span>.<span class="i">Count</span>)
                {
                    <span class="r106 r">sb</span>.<span class="i">Append</span>(<span class="i">Environment</span>.<span class="i">NewLine</span>);
                }
            }
 
            <b>return</b> <span class="r106 r">sb</span>.<span class="i">ToString</span>();
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Word Wrapping
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> See base class.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r110 r">message</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="/System.Management.Automation/A.html#4b15a598e99c7dd9" class="t t">HostException</a><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If obtaining information about the buffer failed</span>
        <span class="c">///</span><span class="c">    OR</span>
        <span class="c">///</span><span class="c">    Win32&#39;s SetConsoleTextAttribute</span>
        <span class="c">///</span><span class="c">    OR</span>
        <span class="c">///</span><span class="c">    Win32&#39;s CreateFile fails</span>
        <span class="c">///</span><span class="c">    OR</span>
        <span class="c">///</span><span class="c">    Win32&#39;s GetConsoleMode fails</span>
        <span class="c">///</span><span class="c">    OR</span>
        <span class="c">///</span><span class="c">    Win32&#39;s SetConsoleMode fails</span>
        <span class="c">///</span><span class="c">    OR</span>
        <span class="c">///</span><span class="c">    Win32&#39;s WriteConsole fails</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>public override void</b> <a id="7b53bb627d74c990" href="../../R/7b53bb627d74c990.html" target="n" data-glyph="72,1" class="i method">WriteDebugLine</a>(<b>string</b> <span id="r110 rd" class="r110 r">message</span>)
        {
            <span class="c">// don&#39;t lock here as WriteLine is already protected.</span>
            <b>bool</b> <span id="r111 rd" class="r111 r">unused</span>;
            <span class="r110 r">message</span> = <a href="/System.Management.Automation/A.html#38cb736539b5d994" class="t t">HostUtilities</a>.<span class="i">RemoveGuidFromMessage</span>(<span class="r110 r">message</span>, <b>out</b> <span class="r111 r">unused</span>);
 
            <span class="c">// We should write debug to error stream only if debug is redirected.)</span>
            <b>if</b> (<a href="#84b0fd621e4256ef" class="i field">_parent</a>.<a href="ConsoleHost.cs.html#ec8b3d93dec73f8c" class="i property">ErrorFormat</a> == <a href="Serialization.cs.html#48289f9b2c3628de" class="t t">Serialization</a>.<a href="Serialization.cs.html#bf09ed02271085ca" class="t t">DataFormat</a>.<a href="Serialization.cs.html#370be72d9a1d0360" class="i field">XML</a>)
            {
                <a href="#84b0fd621e4256ef" class="i field">_parent</a>.<a href="ConsoleHost.cs.html#05a9e033aeedb67d" class="i property">ErrorSerializer</a>.<a href="Serialization.cs.html#10d44be988a80e81" class="i method">Serialize</a>(<span class="r110 r">message</span>, <span class="s">&quot;debug&quot;</span>);
            }
            <b>else</b>
            {
                <b>if</b> (<a href="#5db1812edea1b244" class="i property">SupportsVirtualTerminal</a>)
                {
                    <span class="i">WriteLine</span>(<span class="i">Utils</span>.<span class="i">GetFormatStyleString</span>(<span class="i">Utils</span>.<span class="i">FormatStyle</span>.<span class="i">Debug</span>) + <span class="i">StringUtil</span>.<span class="i">Format</span>(<span class="i">ConsoleHostUserInterfaceStrings</span>.<span class="i">DebugFormatString</span>, <span class="r110 r">message</span>) + <a href="/System.Management.Automation/A.html#340d221c8aa09678" class="t t">PSStyle</a>.<a href="/System.Management.Automation/A.html#f7875006d0bc55f1" class="i property">Instance</a>.<a href="/System.Management.Automation/A.html#0b1059dd37953926" class="i property">Reset</a>);
                }
                <b>else</b>
                {
                    <a href="#9c3a74d382e85a6e" class="i method">WriteLine</a>(
                        <a href="#623a8c52a8294d49" class="i property">DebugForegroundColor</a>,
                        <a href="#a02228912879cb09" class="i property">DebugBackgroundColor</a>,
                        <span class="i">StringUtil</span>.<span class="i">Format</span>(<span class="i">ConsoleHostUserInterfaceStrings</span>.<span class="i">DebugFormatString</span>, <span class="r110 r">message</span>));
                }
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> See base class.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r112 r">record</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>public override void</b> <a id="754d34aa9a294364" href="../../R/754d34aa9a294364.html" target="n" data-glyph="72,1" class="i method">WriteInformation</a>(<a href="/System.Management.Automation/A.html#508a9dbac37ec093" class="t t">InformationRecord</a> <span id="r112 rd" class="r112 r">record</span>)
        {
            <span class="c">// We should write information to error stream only if redirected.)</span>
            <b>if</b> (<a href="#84b0fd621e4256ef" class="i field">_parent</a>.<a href="ConsoleHost.cs.html#ec8b3d93dec73f8c" class="i property">ErrorFormat</a> == <a href="Serialization.cs.html#48289f9b2c3628de" class="t t">Serialization</a>.<a href="Serialization.cs.html#bf09ed02271085ca" class="t t">DataFormat</a>.<a href="Serialization.cs.html#370be72d9a1d0360" class="i field">XML</a>)
            {
                <a href="#84b0fd621e4256ef" class="i field">_parent</a>.<a href="ConsoleHost.cs.html#05a9e033aeedb67d" class="i property">ErrorSerializer</a>.<a href="Serialization.cs.html#10d44be988a80e81" class="i method">Serialize</a>(<span class="r112 r">record</span>, <span class="s">&quot;information&quot;</span>);
            }
            <b>else</b>
            {
                <span class="c">// Do nothing. The information stream is not visible by default</span>
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> See base class.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r113 r">message</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="/System.Management.Automation/A.html#4b15a598e99c7dd9" class="t t">HostException</a><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If obtaining information about the buffer failed</span>
        <span class="c">///</span><span class="c">    OR</span>
        <span class="c">///</span><span class="c">    Win32&#39;s SetConsoleTextAttribute</span>
        <span class="c">///</span><span class="c">    OR</span>
        <span class="c">///</span><span class="c">    Win32&#39;s CreateFile fails</span>
        <span class="c">///</span><span class="c">    OR</span>
        <span class="c">///</span><span class="c">    Win32&#39;s GetConsoleMode fails</span>
        <span class="c">///</span><span class="c">    OR</span>
        <span class="c">///</span><span class="c">    Win32&#39;s SetConsoleMode fails</span>
        <span class="c">///</span><span class="c">    OR</span>
        <span class="c">///</span><span class="c">    Win32&#39;s WriteConsole fails</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>public override void</b> <a id="7cb7037024b353c8" href="../../R/7cb7037024b353c8.html" target="n" data-glyph="72,1" class="i method">WriteVerboseLine</a>(<b>string</b> <span id="r113 rd" class="r113 r">message</span>)
        {
            <span class="c">// don&#39;t lock here as WriteLine is already protected.</span>
            <b>bool</b> <span id="r114 rd" class="r114 r">unused</span>;
            <span class="r113 r">message</span> = <a href="/System.Management.Automation/A.html#38cb736539b5d994" class="t t">HostUtilities</a>.<span class="i">RemoveGuidFromMessage</span>(<span class="r113 r">message</span>, <b>out</b> <span class="r114 r">unused</span>);
 
            <span class="c">// NTRAID#Windows OS Bugs-1061752-2004/12/15-sburns should read a skin setting here...)</span>
            <b>if</b> (<a href="#84b0fd621e4256ef" class="i field">_parent</a>.<a href="ConsoleHost.cs.html#ec8b3d93dec73f8c" class="i property">ErrorFormat</a> == <a href="Serialization.cs.html#48289f9b2c3628de" class="t t">Serialization</a>.<a href="Serialization.cs.html#bf09ed02271085ca" class="t t">DataFormat</a>.<a href="Serialization.cs.html#370be72d9a1d0360" class="i field">XML</a>)
            {
                <a href="#84b0fd621e4256ef" class="i field">_parent</a>.<a href="ConsoleHost.cs.html#05a9e033aeedb67d" class="i property">ErrorSerializer</a>.<a href="Serialization.cs.html#10d44be988a80e81" class="i method">Serialize</a>(<span class="r113 r">message</span>, <span class="s">&quot;verbose&quot;</span>);
            }
            <b>else</b>
            {
                <b>if</b> (<a href="#5db1812edea1b244" class="i property">SupportsVirtualTerminal</a>)
                {
                    <span class="i">WriteLine</span>(<span class="i">Utils</span>.<span class="i">GetFormatStyleString</span>(<span class="i">Utils</span>.<span class="i">FormatStyle</span>.<span class="i">Verbose</span>) + <span class="i">StringUtil</span>.<span class="i">Format</span>(<span class="i">ConsoleHostUserInterfaceStrings</span>.<span class="i">VerboseFormatString</span>, <span class="r113 r">message</span>) + <a href="/System.Management.Automation/A.html#340d221c8aa09678" class="t t">PSStyle</a>.<a href="/System.Management.Automation/A.html#f7875006d0bc55f1" class="i property">Instance</a>.<a href="/System.Management.Automation/A.html#0b1059dd37953926" class="i property">Reset</a>);
                }
                <b>else</b>
                {
                    <a href="#9c3a74d382e85a6e" class="i method">WriteLine</a>(
                        <a href="#33edb3f9d16b5c90" class="i property">VerboseForegroundColor</a>,
                        <a href="#9dd17db412bc3d30" class="i property">VerboseBackgroundColor</a>,
                        <span class="i">StringUtil</span>.<span class="i">Format</span>(<span class="i">ConsoleHostUserInterfaceStrings</span>.<span class="i">VerboseFormatString</span>, <span class="r113 r">message</span>));
                }
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> See base class.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r115 r">message</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="/System.Management.Automation/A.html#4b15a598e99c7dd9" class="t t">HostException</a><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If obtaining information about the buffer failed</span>
        <span class="c">///</span><span class="c">    OR</span>
        <span class="c">///</span><span class="c">    Win32&#39;s SetConsoleTextAttribute</span>
        <span class="c">///</span><span class="c">    OR</span>
        <span class="c">///</span><span class="c">    Win32&#39;s CreateFile fails</span>
        <span class="c">///</span><span class="c">    OR</span>
        <span class="c">///</span><span class="c">    Win32&#39;s GetConsoleMode fails</span>
        <span class="c">///</span><span class="c">    OR</span>
        <span class="c">///</span><span class="c">    Win32&#39;s SetConsoleMode fails</span>
        <span class="c">///</span><span class="c">    OR</span>
        <span class="c">///</span><span class="c">    Win32&#39;s WriteConsole fails</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>public override void</b> <a id="2047128e34fb3a98" href="../../R/2047128e34fb3a98.html" target="n" data-glyph="72,1" class="i method">WriteWarningLine</a>(<b>string</b> <span id="r115 rd" class="r115 r">message</span>)
        {
            <span class="c">// don&#39;t lock here as WriteLine is already protected.</span>
            <b>bool</b> <span id="r116 rd" class="r116 r">unused</span>;
            <span class="r115 r">message</span> = <a href="/System.Management.Automation/A.html#38cb736539b5d994" class="t t">HostUtilities</a>.<span class="i">RemoveGuidFromMessage</span>(<span class="r115 r">message</span>, <b>out</b> <span class="r116 r">unused</span>);
 
            <span class="c">// NTRAID#Windows OS Bugs-1061752-2004/12/15-sburns should read a skin setting here...)</span>
            <b>if</b> (<a href="#84b0fd621e4256ef" class="i field">_parent</a>.<a href="ConsoleHost.cs.html#ec8b3d93dec73f8c" class="i property">ErrorFormat</a> == <a href="Serialization.cs.html#48289f9b2c3628de" class="t t">Serialization</a>.<a href="Serialization.cs.html#bf09ed02271085ca" class="t t">DataFormat</a>.<a href="Serialization.cs.html#370be72d9a1d0360" class="i field">XML</a>)
            {
                <a href="#84b0fd621e4256ef" class="i field">_parent</a>.<a href="ConsoleHost.cs.html#05a9e033aeedb67d" class="i property">ErrorSerializer</a>.<a href="Serialization.cs.html#10d44be988a80e81" class="i method">Serialize</a>(<span class="r115 r">message</span>, <span class="s">&quot;warning&quot;</span>);
            }
            <b>else</b>
            {
                <b>if</b> (<a href="#5db1812edea1b244" class="i property">SupportsVirtualTerminal</a>)
                {
                    <span class="i">WriteLine</span>(<span class="i">Utils</span>.<span class="i">GetFormatStyleString</span>(<span class="i">Utils</span>.<span class="i">FormatStyle</span>.<span class="i">Warning</span>) + <span class="i">StringUtil</span>.<span class="i">Format</span>(<span class="i">ConsoleHostUserInterfaceStrings</span>.<span class="i">WarningFormatString</span>, <span class="r115 r">message</span>) + <a href="/System.Management.Automation/A.html#340d221c8aa09678" class="t t">PSStyle</a>.<a href="/System.Management.Automation/A.html#f7875006d0bc55f1" class="i property">Instance</a>.<a href="/System.Management.Automation/A.html#0b1059dd37953926" class="i property">Reset</a>);
                }
                <b>else</b>
                {
                    <a href="#9c3a74d382e85a6e" class="i method">WriteLine</a>(
                        <a href="#588e107faeb72a86" class="i property">WarningForegroundColor</a>,
                        <a href="#58f200eb8de00a89" class="i property">WarningBackgroundColor</a>,
                        <span class="i">StringUtil</span>.<span class="i">Format</span>(<span class="i">ConsoleHostUserInterfaceStrings</span>.<span class="i">WarningFormatString</span>, <span class="r115 r">message</span>));
                }
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Invoked by CommandBase.WriteProgress to display a progress record.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public override void</b> <a id="50ee89de7efdc476" href="../../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">WriteProgress</a>(<b>long</b> <span id="r117 rd" class="r117 r">sourceId</span>, <a href="/System.Management.Automation/A.html#d79b27687c6ed8c8" class="t t">ProgressRecord</a> <span id="r118 rd" class="r118 r">record</span>)
        {
            <a href="/System.Management.Automation/A.html#c04955255430d32f" class="t t">Dbg</a>.<span class="i">Assert</span>(<span class="r118 r">record</span> != <b>null</b>, <span class="s">&quot;WriteProgress called with null ProgressRecord&quot;</span>);
 
            <b>if</b> (<span class="i">Console</span>.<span class="i">IsOutputRedirected</span>)
            {
                <span class="c">// Do not write progress bar when the stdout is redirected.</span>
                <b>return</b>;
            }
 
            <b>bool</b> <span id="r119 rd" class="r119 r">matchPattern</span>;
            <b>string</b> <span id="r120 rd" class="r120 r">currentOperation</span> = <a href="/System.Management.Automation/A.html#38cb736539b5d994" class="t t">HostUtilities</a>.<span class="i">RemoveIdentifierInfoFromMessage</span>(<span class="r118 r">record</span>.<a href="/System.Management.Automation/A.html#f7d64fec26cd635a" class="i property">CurrentOperation</a>, <b>out</b> <span class="r119 r">matchPattern</span>);
            <b>if</b> (<span class="r119 r">matchPattern</span>)
            {
                <span class="r118 r">record</span> = <b>new</b> <span class="t">ProgressRecord</span>(<span class="r118 r">record</span>) { <a href="/System.Management.Automation/A.html#f7d64fec26cd635a" class="i property">CurrentOperation</a> = <span class="r120 r">currentOperation</span> };
            }
 
            <span class="c">// We allow only one thread at a time to update the progress state.)</span>
            <b>if</b> (<a href="#84b0fd621e4256ef" class="i field">_parent</a>.<a href="ConsoleHost.cs.html#ec8b3d93dec73f8c" class="i property">ErrorFormat</a> == <a href="Serialization.cs.html#48289f9b2c3628de" class="t t">Serialization</a>.<a href="Serialization.cs.html#bf09ed02271085ca" class="t t">DataFormat</a>.<a href="Serialization.cs.html#370be72d9a1d0360" class="i field">XML</a>)
            {
                <a href="/System.Management.Automation/A.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r121 rd" class="r121 r">obj</span> = <b>new</b> <span class="t">PSObject</span>();
                <span class="r121 r">obj</span>.<a href="/System.Management.Automation/A.html#59e9cd1ad57ccd34" class="i property">Properties</a>.<span class="i">Add</span>(<b>new</b> <span class="t">PSNoteProperty</span>(<span class="s">&quot;SourceId&quot;</span>, <span class="r117 r">sourceId</span>));
                <span class="r121 r">obj</span>.<a href="/System.Management.Automation/A.html#59e9cd1ad57ccd34" class="i property">Properties</a>.<span class="i">Add</span>(<b>new</b> <span class="t">PSNoteProperty</span>(<span class="s">&quot;Record&quot;</span>, <span class="r118 r">record</span>));
                <a href="#84b0fd621e4256ef" class="i field">_parent</a>.<a href="ConsoleHost.cs.html#05a9e033aeedb67d" class="i property">ErrorSerializer</a>.<a href="Serialization.cs.html#10d44be988a80e81" class="i method">Serialize</a>(<span class="r121 r">obj</span>, <span class="s">&quot;progress&quot;</span>);
            }
            <b>else</b>
            {
                <b>lock</b> (<a href="#dbd28972ee208717" class="i field">_instanceLock</a>)
                {
                    <a href="ConsoleHostUserInterfaceProgress.cs.html#dbd57b9daaa12369" class="i method">HandleIncomingProgressRecord</a>(<span class="r117 r">sourceId</span>, <span class="r118 r">record</span>);
                }
            }
        }
 
        <b>public override void</b> <a id="79384cc9e45dc2ca" href="../../R/79384cc9e45dc2ca.html" target="n" data-glyph="72,1" class="i method">WriteErrorLine</a>(<b>string</b> <span id="r122 rd" class="r122 r">value</span>)
        {
            <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r122 r">value</span>))
            {
                <b>return</b>;
            }
 
            <span class="i">TextWriter</span> <span id="r123 rd" class="r123 r">writer</span> = (!<span class="i">Console</span>.<span class="i">IsErrorRedirected</span> || <a href="#84b0fd621e4256ef" class="i field">_parent</a>.<a href="ConsoleHost.cs.html#1715457a129ccf20" class="i property">IsInteractive</a>)
                ? <a href="#84b0fd621e4256ef" class="i field">_parent</a>.<a href="ConsoleHost.cs.html#242f4eeac16479ac" class="i property">ConsoleTextWriter</a>
                : <span class="i">Console</span>.<span class="i">Error</span>;
 
            <b>if</b> (<a href="#84b0fd621e4256ef" class="i field">_parent</a>.<a href="ConsoleHost.cs.html#ec8b3d93dec73f8c" class="i property">ErrorFormat</a> == <a href="Serialization.cs.html#48289f9b2c3628de" class="t t">Serialization</a>.<a href="Serialization.cs.html#bf09ed02271085ca" class="t t">DataFormat</a>.<a href="Serialization.cs.html#370be72d9a1d0360" class="i field">XML</a>)
            {
                <a href="/System.Management.Automation/A.html#c04955255430d32f" class="t t">Dbg</a>.<span class="i">Assert</span>(<span class="r123 r">writer</span> == <a href="#84b0fd621e4256ef" class="i field">_parent</a>.<a href="ConsoleHost.cs.html#05a9e033aeedb67d" class="i property">ErrorSerializer</a>.<a href="Serialization.cs.html#8abd46b3df916b2c" class="i field">textWriter</a>, <span class="s">&quot;writers should be the same&quot;</span>);
 
                <a href="#84b0fd621e4256ef" class="i field">_parent</a>.<a href="ConsoleHost.cs.html#05a9e033aeedb67d" class="i property">ErrorSerializer</a>.<span class="i">Serialize</span>(<span class="r122 r">value</span> + <span class="i">Environment</span>.<span class="i">NewLine</span>);
            }
            <b>else</b>
            {
                <b>if</b> (<span class="r123 r">writer</span> == <a href="#84b0fd621e4256ef" class="i field">_parent</a>.<a href="ConsoleHost.cs.html#242f4eeac16479ac" class="i property">ConsoleTextWriter</a>)
                {
                    <b>if</b> (<a href="#5db1812edea1b244" class="i property">SupportsVirtualTerminal</a>)
                    {
                        <a href="#07fd0950d75ee8ef" class="i method">WriteLine</a>(<span class="r122 r">value</span>);
                    }
                    <b>else</b>
                    {
                        <a href="#9c3a74d382e85a6e" class="i method">WriteLine</a>(<a href="#46aac1f5890000d4" class="i property">ErrorForegroundColor</a>, <a href="#01ceb0b246ebdba1" class="i property">ErrorBackgroundColor</a>, <span class="r122 r">value</span>);
                    }
                }
                <b>else</b>
                {
                    <span class="i">Console</span>.<span class="i">Error</span>.<span class="i">WriteLine</span>(<span class="r122 r">value</span>);
                }
            }
        }
 
        <b>public</b> <span class="i">ConsoleColor</span> <a id="ea034a5214b0991b" href="../../R/ea034a5214b0991b.html" target="n" data-glyph="102,1" class="i property">FormatAccentColor</a> { <b>get</b>; <b>set</b>; } = <span class="i">ConsoleColor</span>.<span class="i">Green</span>;
 
        <b>public</b> <span class="i">ConsoleColor</span> <a id="51c7fc743b775c87" href="../../R/51c7fc743b775c87.html" target="n" data-glyph="102,1" class="i property">ErrorAccentColor</a> { <b>get</b>; <b>set</b>; } = <span class="i">ConsoleColor</span>.<span class="i">Cyan</span>;
 
        <b>public</b> <span class="i">ConsoleColor</span> <a id="46aac1f5890000d4" href="../../R/46aac1f5890000d4.html" target="n" data-glyph="102,1" class="i property">ErrorForegroundColor</a> { <b>get</b>; <b>set</b>; } = <span class="i">ConsoleColor</span>.<span class="i">Red</span>;
 
        <b>public</b> <span class="i">ConsoleColor</span> <a id="01ceb0b246ebdba1" href="../../R/01ceb0b246ebdba1.html" target="n" data-glyph="102,1" class="i property">ErrorBackgroundColor</a> { <b>get</b>; <b>set</b>; } = <span class="i">Console</span>.<span class="i">BackgroundColor</span>;
 
        <b>public</b> <span class="i">ConsoleColor</span> <a id="588e107faeb72a86" href="../../R/588e107faeb72a86.html" target="n" data-glyph="102,1" class="i property">WarningForegroundColor</a> { <b>get</b>; <b>set</b>; } = <span class="i">ConsoleColor</span>.<span class="i">Yellow</span>;
 
        <b>public</b> <span class="i">ConsoleColor</span> <a id="58f200eb8de00a89" href="../../R/58f200eb8de00a89.html" target="n" data-glyph="102,1" class="i property">WarningBackgroundColor</a> { <b>get</b>; <b>set</b>; } = <span class="i">Console</span>.<span class="i">BackgroundColor</span>;
 
        <b>public</b> <span class="i">ConsoleColor</span> <a id="623a8c52a8294d49" href="../../R/623a8c52a8294d49.html" target="n" data-glyph="102,1" class="i property">DebugForegroundColor</a> { <b>get</b>; <b>set</b>; } = <span class="i">ConsoleColor</span>.<span class="i">Yellow</span>;
 
        <b>public</b> <span class="i">ConsoleColor</span> <a id="a02228912879cb09" href="../../R/a02228912879cb09.html" target="n" data-glyph="102,1" class="i property">DebugBackgroundColor</a> { <b>get</b>; <b>set</b>; } = <span class="i">Console</span>.<span class="i">BackgroundColor</span>;
 
        <b>public</b> <span class="i">ConsoleColor</span> <a id="33edb3f9d16b5c90" href="../../R/33edb3f9d16b5c90.html" target="n" data-glyph="102,1" class="i property">VerboseForegroundColor</a> { <b>get</b>; <b>set</b>; } = <span class="i">ConsoleColor</span>.<span class="i">Yellow</span>;
 
        <b>public</b> <span class="i">ConsoleColor</span> <a id="9dd17db412bc3d30" href="../../R/9dd17db412bc3d30.html" target="n" data-glyph="102,1" class="i property">VerboseBackgroundColor</a> { <b>get</b>; <b>set</b>; } = <span class="i">Console</span>.<span class="i">BackgroundColor</span>;
 
        <b>public</b> <span class="i">ConsoleColor</span> <a id="259bd2bea05727b0" href="../../R/259bd2bea05727b0.html" target="n" data-glyph="102,1" class="i property">ProgressForegroundColor</a> { <b>get</b>; <b>set</b>; } = <span class="i">ConsoleColor</span>.<span class="i">Black</span>;
 
        <b>public</b> <span class="i">ConsoleColor</span> <a id="c19755f372facb5a" href="../../R/c19755f372facb5a.html" target="n" data-glyph="102,1" class="i property">ProgressBackgroundColor</a> { <b>get</b>; <b>set</b>; } = <span class="i">ConsoleColor</span>.<span class="i">Yellow</span>;
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Line-oriented interaction
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> implementation
 
        <span class="c">// We use System.Environment.NewLine because we are platform-agnostic</span>
 
        <b>internal static readonly string</b> <a id="cc4ddaff57d23d4b" href="../../R/../../0000000000.html" target="n" data-glyph="44,1" class="i field">Crlf</a> = <span class="i n">System</span>.<span class="i">Environment</span>.<span class="i">NewLine</span>;
 
        <b>private const string</b> <a id="74ce6416b6e0e017" href="../../R/74ce6416b6e0e017.html" target="n" data-glyph="10,1" class="i field">Tab</a> = <span class="s">&quot;\x0009&quot;</span>;
 
        <b>internal enum</b> <a id="0de1ff3de6688ce7" href="../../R/0de1ff3de6688ce7.html" target="n" data-glyph="20,1" class="t t"><span id="01804d65e939a7cc">ReadLineResult</span></a>
        {
            <a id="d0897a0829dfafd7" href="../../R/d0897a0829dfafd7.html" target="n" data-glyph="24,2" class="i field">endedOnEnter</a> = 0,
            <a id="4712e37fb521defe" href="../../R/4712e37fb521defe.html" target="n" data-glyph="24,2" class="i field">endedOnTab</a> = 1,
            <a id="b637643b3789d115" href="../../R/b637643b3789d115.html" target="n" data-glyph="24,2" class="i field">endedOnShiftTab</a> = 2,
            <a id="70cb86ce9cc6fa0a" href="../../R/70cb86ce9cc6fa0a.html" target="n" data-glyph="24,2" class="i field">endedOnBreak</a> = 3
        }
 
        <b>private const int</b> <a id="0d1ef7b721b88f17" href="../../R/0d1ef7b721b88f17.html" target="n" data-glyph="10,1" class="i field">MaxInputLineLength</a> = 1024;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Reads a line of input from the console.  Returns when the user hits enter, a break key, a break event occurs.  In</span>
        <span class="c">///</span><span class="c"> the case that stdin has been redirected, reads from the stdin stream instead of the console.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r124 r">endOnTab</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> true to end input when the user hits the tab or shift-tab keys, false to only end on the enter key (or a break</span>
        <span class="c">///</span><span class="c"> event). Ignored if not reading from the console device.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r125 r">initialContent</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The initial contents of the input buffer.  Nice if you want to have a default result. Ignored if not reading from the</span>
        <span class="c">///</span><span class="c"> console device.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r126 r">result</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Receives an enum value indicating how input was ended.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r127 r">calledFromPipeline</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> TBD</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r128 r">transcribeResult</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> true to include the results in any transcription that might be happening.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The string read from either the console or the stdin stream.  null if:</span>
        <span class="c">///</span><span class="c"> - stdin was read and EOF was reached on the stream, or</span>
        <span class="c">///</span><span class="c"> - the console was read, and input was terminated with Ctrl-C, Ctrl-Break, or Close.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="/System.Management.Automation/A.html#4b15a598e99c7dd9" class="t t">HostException</a><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If Win32&#39;s SetConsoleMode fails</span>
        <span class="c">///</span><span class="c">    OR</span>
        <span class="c">///</span><span class="c">    Win32&#39;s ReadConsole fails</span>
        <span class="c">///</span><span class="c">    OR</span>
        <span class="c">///</span><span class="c">    obtaining information about the buffer failed</span>
        <span class="c">///</span><span class="c">    OR</span>
        <span class="c">///</span><span class="c">    Win32&#39;s SetConsoleCursorPosition failed</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>internal string</b> <a id="67bd0565f50155f1" href="../../R/67bd0565f50155f1.html" target="n" data-glyph="74,1" class="i method">ReadLine</a>(<b>bool</b> <span id="r124 rd" class="r124 r">endOnTab</span>, <b>string</b> <span id="r125 rd" class="r125 r">initialContent</span>, <b>out</b> <a href="#0de1ff3de6688ce7" class="t t">ReadLineResult</a> <span id="r126 rd" class="r126 r">result</span>, <b>bool</b> <span id="r127 rd" class="r127 r">calledFromPipeline</span>, <b>bool</b> <span id="r128 rd" class="r128 r">transcribeResult</span>)
        {
            <span class="r126 r">result</span> = <a href="#0de1ff3de6688ce7" class="t t">ReadLineResult</a>.<a href="#d0897a0829dfafd7" class="i field">endedOnEnter</a>;
 
            <span class="c">// If the test hook is set, read from it.</span>
            <b>if</b> (<a href="#67f5bbca9042b4f7" class="i field">s_h</a> != <b>null</b>) <b>return</b> <a href="#67f5bbca9042b4f7" class="i field">s_h</a>.<span class="i">ReadLine</span>();
 
            <b>string</b> <span id="r129 rd" class="r129 r">restOfLine</span> = <b>null</b>;
 
            <b>string</b> <span id="r130 rd" class="r130 r">s</span> = <a href="#96bef84efdae9634" class="i property">ReadFromStdin</a>
                ? <a href="#9fc638bb6a5db7bc" class="i method">ReadLineFromFile</a>(<span class="r125 r">initialContent</span>)
                : <a href="#5c13c643539a1685" class="i method">ReadLineFromConsole</a>(<span class="r124 r">endOnTab</span>, <span class="r125 r">initialContent</span>, <span class="r127 r">calledFromPipeline</span>, <b>ref</b> <span class="r129 r">restOfLine</span>, <b>ref</b> <span class="r126 r">result</span>);
 
            <b>if</b> (<span class="r128 r">transcribeResult</span>)
            {
                <a href="ConsoleHostUserInterfaceProgress.cs.html#5cd8d560e20c0a54" class="i method">PostRead</a>(<span class="r130 r">s</span>);
            }
            <b>else</b>
            {
                <a href="ConsoleHostUserInterfaceProgress.cs.html#8d36648d91a58297" class="i method">PostRead</a>();
            }
 
            <b>if</b> (<span class="r129 r">restOfLine</span> != <b>null</b>)
                <span class="r130 r">s</span> += <span class="r129 r">restOfLine</span>;
 
            <b>return</b> <span class="r130 r">s</span>;
        }
 
        <b>private string</b> <a id="9fc638bb6a5db7bc" href="../../R/9fc638bb6a5db7bc.html" target="n" data-glyph="76,1" class="i method">ReadLineFromFile</a>(<b>string</b> <span id="r131 rd" class="r131 r">initialContent</span>)
        {
            <b>var</b> <span id="r132 rd" class="r132 r">sb</span> = <b>new</b> <span class="i">StringBuilder</span>();
            <b>if</b> (!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r131 r">initialContent</span>))
            {
                <span class="r132 r">sb</span>.<span class="i">Append</span>(<span class="r131 r">initialContent</span>);
                <span class="r132 r">sb</span>.<span class="i">Append</span>(<span class="s">&#39;\n&#39;</span>);
            }
 
            <b>var</b> <span id="r133 rd" class="r133 r">consoleIn</span> = <a href="#84b0fd621e4256ef" class="i field">_parent</a>.<a href="ConsoleHost.cs.html#9849256b9c8b3593" class="i property">ConsoleIn</a>.<span class="i">Value</span>;
            <b>while</b> (<b>true</b>)
            {
                <b>var</b> <span id="r134 rd" class="r134 r">inC</span> = <span class="r133 r">consoleIn</span>.<span class="i">Read</span>();
                <b>if</b> (<span class="r134 r">inC</span> == -1)
                {
                    <span class="c">// EOF - we return null which tells our caller to exit</span>
                    <span class="c">// but only if we don&#39;t have any input, we could have</span>
                    <span class="c">// input and then stdin was closed, but never saw a newline.</span>
                    <b>return</b> <span class="r132 r">sb</span>.<span class="i">Length</span> == 0 ? <b>null</b> : <span class="r132 r">sb</span>.<span class="i">ToString</span>();
                }
 
                <b>var</b> <span id="r135 rd" class="r135 r">c</span> = <b>unchecked</b>((<b>char</b>)<span class="r134 r">inC</span>);
                <b>if</b> (!<a href="#3202c0ccb1155eb7" class="i property">NoPrompt</a>) <span class="i">Console</span>.<span class="i">Out</span>.<span class="i">Write</span>(<span class="r135 r">c</span>);
 
                <b>if</b> (<span class="r135 r">c</span> == <span class="s">&#39;\r&#39;</span>)
                {
                    <span class="c">// Treat as newline, but consume \n if there is one.</span>
                    <b>if</b> (<span class="r133 r">consoleIn</span>.<span class="i">Peek</span>() == <span class="s">&#39;\n&#39;</span>)
                    {
                        <b>if</b> (!<a href="#3202c0ccb1155eb7" class="i property">NoPrompt</a>) <span class="i">Console</span>.<span class="i">Out</span>.<span class="i">Write</span>(<span class="s">&#39;\n&#39;</span>);
                        <span class="r133 r">consoleIn</span>.<span class="i">Read</span>();
                    }
 
                    <b>break</b>;
                }
 
                <b>if</b> (<span class="r135 r">c</span> == <span class="s">&#39;\n&#39;</span>)
                {
                    <b>break</b>;
                }
 
                <span class="c">// If NoPrompt is true, we are in a sort of server mode where we shouldn&#39;t</span>
                <span class="c">// do anything like edit the command line - every character is part of the input.</span>
                <b>if</b> (<span class="r135 r">c</span> == <span class="s">&#39;\b&#39;</span> &amp;&amp; !<a href="#3202c0ccb1155eb7" class="i property">NoPrompt</a>)
                {
                    <span class="r132 r">sb</span>.<span class="i">Remove</span>(<span class="r132 r">sb</span>.<span class="i">Length</span> - 1, 1);
                }
                <b>else</b>
                {
                    <span class="r132 r">sb</span>.<span class="i">Append</span>(<span class="r135 r">c</span>);
                }
            }
 
            <b>return</b> <span class="r132 r">sb</span>.<span class="i">ToString</span>();
        }
 
        <b>private string</b> <a id="5c13c643539a1685" href="../../R/5c13c643539a1685.html" target="n" data-glyph="76,1" class="i method">ReadLineFromConsole</a>(<b>bool</b> <span id="r136 rd" class="r136 r">endOnTab</span>, <b>string</b> <span id="r137 rd" class="r137 r">initialContent</span>, <b>bool</b> <span id="r138 rd" class="r138 r">calledFromPipeline</span>, <b>ref string</b> <span id="r139 rd" class="r139 r">restOfLine</span>, <b>ref</b> <a href="#0de1ff3de6688ce7" class="t t">ReadLineResult</a> <span id="r140 rd" class="r140 r">result</span>)
        {
            <a href="ConsoleHostUserInterfaceProgress.cs.html#adebfa50cfd2a343" class="i method">PreRead</a>();
            <span class="c">// Ensure that we&#39;re in the proper line-input mode.</span>
 
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">UNIX</span>
            <span class="i">ConsoleHandle</span> <span id="r141 rd" class="r141 r">handle</span> = <a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#082a79a70f5af6dc" class="i method">GetConioDeviceHandle</a>();
            <a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#1d1eff9fb00ac8e2" class="t t">ConsoleModes</a> <span id="r142 rd" class="r142 r">m</span> = <a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#133579be57ae9c3e" class="i method">GetMode</a>(<span class="r141 r">handle</span>);
 
            <b>const</b> <a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#1d1eff9fb00ac8e2" class="t t">ConsoleModes</a> <span id="r143 rd" class="r143 r">DesiredMode</span> =
                <a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#1d1eff9fb00ac8e2" class="t t">ConsoleModes</a>.<a href="ConsoleControl.cs.html#6059b69bb324025e" class="i field">LineInput</a>
                | <a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#1d1eff9fb00ac8e2" class="t t">ConsoleModes</a>.<a href="ConsoleControl.cs.html#adac23d1297e0802" class="i field">EchoInput</a>
                | <a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#1d1eff9fb00ac8e2" class="t t">ConsoleModes</a>.<a href="ConsoleControl.cs.html#dc342310a77c2d1f" class="i field">ProcessedInput</a>;
 
            <b>if</b> ((<span class="r142 r">m</span> &amp; <span class="r143 r">DesiredMode</span>) != <span class="r143 r">DesiredMode</span> || (<span class="r142 r">m</span> &amp; <a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#1d1eff9fb00ac8e2" class="t t">ConsoleModes</a>.<a href="ConsoleControl.cs.html#ace876bd01ee480a" class="i field">MouseInput</a>) &gt; 0)
            {
                <span class="r142 r">m</span> &amp;= ~<a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#1d1eff9fb00ac8e2" class="t t">ConsoleModes</a>.<a href="ConsoleControl.cs.html#ace876bd01ee480a" class="i field">MouseInput</a>;
                <span class="r142 r">m</span> |= <span class="r143 r">DesiredMode</span>;
                <a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#6c1ab9fc2b7085b1" class="i method">SetMode</a>(<span class="r141 r">handle</span>, <span class="r142 r">m</span>);
            }
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
 
            <span class="c">// If more characters are typed than you asked, then the next call to ReadConsole will return the</span>
            <span class="c">// additional characters beyond those you requested.</span>
            <span class="c">//</span>
            <span class="c">// If input is terminated with a tab key, then the buffer returned will have a tab (ascii 0x9) at the</span>
            <span class="c">// position where the tab key was hit.  If the user has arrowed backward over existing input in the line</span>
            <span class="c">// buffer, the tab will overwrite whatever character was in that position. That character will be lost in</span>
            <span class="c">// the input buffer, but since we echo each character the user types, it&#39;s still in the active screen buffer</span>
            <span class="c">// and we can read the console output to get that character.</span>
            <span class="c">//</span>
            <span class="c">// If input is terminated with an enter key, then the buffer returned will have ascii 0x0D and 0x0A</span>
            <span class="c">// (Carriage Return and Line Feed) as the last two characters of the buffer.</span>
            <span class="c">//</span>
            <span class="c">// If input is terminated with a break key (Ctrl-C, Ctrl-Break, Close, etc.), then the buffer will be</span>
            <span class="c">// the empty string.</span>
 
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">UNIX</span>
<span class="e">            // For Unix systems, we implement a basic readline loop around Console.ReadKey(), that
            // supports backspace, arrow keys, Ctrl-C, and Ctrl-D. This readline is only used for
            // interactive prompts (like Read-Host), otherwise it is assumed that PSReadLine is
            // available. Therefore this explicitly does not support history or tab completion.
 
            bool treatControlCAsInput = Console.TreatControlCAsInput;
 
            try
            {
 
                ConsoleKeyInfo keyInfo;
                string s = string.Empty;
                int index = 0;
                int cursorLeft = Console.CursorLeft;
                int cursorCurrent = cursorLeft;
                bool insertMode = true;
                Console.TreatControlCAsInput = true;
</span><span class="k preprocess">#</span><span class="k preprocess">else</span>
            <a href="#370e7f4dd3c19e58" class="i field">_rawui</a>.<a href="ConsoleHostRawUserInterface.cs.html#35a22fc56a5f740a" class="i method">ClearKeyCache</a>();
            <b>uint</b> <span id="r144 rd" class="r144 r">keyState</span> = 0;
            <b>string</b> <span id="r145 rd" class="r145 r">s</span> = <b>string</b>.<span class="i">Empty</span>;
            <span class="i">Span</span>&lt;<b>char</b>&gt; <span id="r146 rd" class="r146 r">inputBuffer</span> = <b>stackalloc char</b>[<a href="#0d1ef7b721b88f17" class="i field">MaxInputLineLength</a> + 1];
            <b>if</b> (<span class="r137 r">initialContent</span>.<span class="i">Length</span> &gt; 0)
            {
                <span class="r137 r">initialContent</span>.<span class="i">AsSpan</span>().<span class="i">CopyTo</span>(<span class="r146 r">inputBuffer</span>);
            }
 
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
            <b>while</b> (<b>true</b>)
            {
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">UNIX</span>
<span class="e">                    keyInfo = Console.ReadKey(true);
</span><span class="k preprocess">#</span><span class="k preprocess">else</span>
                <span class="r145 r">s</span> += <a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<span class="i">ReadConsole</span>(<span class="r141 r">handle</span>, <span class="r137 r">initialContent</span>.<span class="i">Length</span>, <span class="r146 r">inputBuffer</span>, <a href="#0d1ef7b721b88f17" class="i field">MaxInputLineLength</a>, <span class="r136 r">endOnTab</span>, <b>out</b> <span class="r144 r">keyState</span>);
                <a href="/System.Management.Automation/A.html#c04955255430d32f" class="t t">Dbg</a>.<span class="i">Assert</span>(<span class="r145 r">s</span> != <b>null</b>, <span class="s">&quot;s should never be null&quot;</span>);
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
 
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">UNIX</span>
<span class="e">                    // Handle Ctrl-C ending input
                    if (keyInfo.Key == ConsoleKey.C &amp;&amp; keyInfo.Modifiers.HasFlag(ConsoleModifiers.Control))
</span><span class="k preprocess">#</span><span class="k preprocess">else</span>
                <b>if</b> (<span class="r145 r">s</span>.<span class="i">Length</span> == 0)
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
                {
                    <span class="r140 r">result</span> = <a href="#0de1ff3de6688ce7" class="t t">ReadLineResult</a>.<a href="#70cb86ce9cc6fa0a" class="i field">endedOnBreak</a>;
                    <span class="r145 r">s</span> = <b>null</b>;
 
                    <b>if</b> (<span class="r138 r">calledFromPipeline</span>)
                    {
                        <span class="c">// make sure that the pipeline that called us is stopped</span>
 
                        <b>throw</b> <b>new</b> <span class="t">PipelineStoppedException</span>();
                    }
 
                    <b>break</b>;
                }
 
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">UNIX</span>
<span class="e">                    if (keyInfo.Key == ConsoleKey.Enter)
</span><span class="k preprocess">#</span><span class="k preprocess">else</span>
                <b>if</b> (<span class="r145 r">s</span>.<span class="i">EndsWith</span>(<span class="i">Environment</span>.<span class="i">NewLine</span>, <span class="i">StringComparison</span>.<span class="i">Ordinal</span>))
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
                {
                    <span class="r140 r">result</span> = <a href="#0de1ff3de6688ce7" class="t t">ReadLineResult</a>.<a href="#d0897a0829dfafd7" class="i field">endedOnEnter</a>;
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">UNIX</span>
<span class="e">                        // We&#39;re intercepting characters, so we need to echo the newline
                        Console.Out.WriteLine();
</span><span class="k preprocess">#</span><span class="k preprocess">else</span>
                    <span class="r145 r">s</span> = <span class="r145 r">s</span>.<span class="i">Remove</span>(<span class="r145 r">s</span>.<span class="i">Length</span> - <span class="i">Environment</span>.<span class="i">NewLine</span>.<span class="i">Length</span>);
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
                    <b>break</b>;
                }
 
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">UNIX</span>
<span class="e">                    if (keyInfo.Key == ConsoleKey.Tab)
                    {
                        // This is unsupported
                        continue;
                    }
</span><span class="k preprocess">#</span><span class="k preprocess">else</span>
                <b>int</b> <span id="r147 rd" class="r147 r">i</span> = <span class="r145 r">s</span>.<span class="i">IndexOf</span>(<a href="#74ce6416b6e0e017" class="i field">Tab</a>, <span class="i">StringComparison</span>.<span class="i">Ordinal</span>);
 
                <b>if</b> (<span class="r136 r">endOnTab</span> &amp;&amp; <span class="r147 r">i</span> != -1)
                {
                    <span class="c">// then the tab we found is the completion character.  bit 0x10 is set if the shift key was down</span>
                    <span class="c">// when the key was hit.</span>
 
                    <b>if</b> ((<span class="r144 r">keyState</span> &amp; 0x10) == 0)
                    {
                        <span class="r140 r">result</span> = <a href="#0de1ff3de6688ce7" class="t t">ReadLineResult</a>.<a href="#4712e37fb521defe" class="i field">endedOnTab</a>;
                    }
                    <b>else</b> <b>if</b> ((<span class="r144 r">keyState</span> &amp; 0x10) &gt; 0)
                    {
                        <span class="r140 r">result</span> = <a href="#0de1ff3de6688ce7" class="t t">ReadLineResult</a>.<a href="#b637643b3789d115" class="i field">endedOnShiftTab</a>;
                    }
                    <b>else</b>
                    {
                        <span class="c">// do nothing: leave the result state as it was. This is the circumstance when we&#39;ve have to</span>
                        <span class="c">// do more than one iteration and the input ended on a tab or shift-tab, or the user hit</span>
                        <span class="c">// enter, or the user hit ctrl-c</span>
                    }
 
                    <span class="c">// also clean up the screen -- if the cursor was positioned somewhere before the last character</span>
                    <span class="c">// in the input buffer, then the characters from the tab to the end of the buffer need to be</span>
                    <span class="c">// erased.</span>
                    <b>int</b> <span id="r148 rd" class="r148 r">leftover</span> = <a href="#33b028e308b5319d" class="i property">RawUI</a>.<span class="i">LengthInBufferCells</span>(<span class="r145 r">s</span>.<span class="i">Substring</span>(<span class="r147 r">i</span> + 1));
 
                    <b>if</b> (<span class="r148 r">leftover</span> &gt; 0)
                    {
                        <a href="/System.Management.Automation/A.html#c6f6da6e12de292e" class="t t">Coordinates</a> <span id="r149 rd" class="r149 r">c</span> = <a href="#33b028e308b5319d" class="i property">RawUI</a>.<a href="/System.Management.Automation/A.html#1096ecedf81a22c3" class="i property">CursorPosition</a>;
 
                        <span class="c">// before cleaning up the screen, read the active screen buffer to retrieve the character that</span>
                        <span class="c">// is overridden by the tab</span>
                        <b>char</b> <span id="r150 rd" class="r150 r">charUnderCursor</span> = <a href="#c43d36ccb42b3240" class="i method">GetCharacterUnderCursor</a>(<span class="r149 r">c</span>);
 
                        <a href="#195231463f5f905d" class="i method">Write</a>(<span class="i">StringUtil</span>.<span class="i">Padding</span>(<span class="r148 r">leftover</span>));
                        <a href="#33b028e308b5319d" class="i property">RawUI</a>.<span class="i">CursorPosition</span> = <span class="r149 r">c</span>;
 
                        <span class="r139 r">restOfLine</span> = <span class="r145 r">s</span>[<span class="r147 r">i</span>] + (<span class="r150 r">charUnderCursor</span> + <span class="r145 r">s</span>.<span class="i">Substring</span>(<span class="r147 r">i</span> + 1));
                    }
                    <b>else</b>
                    {
                        <span class="r139 r">restOfLine</span> += <span class="r145 r">s</span>[<span class="r147 r">i</span>];
                    }
 
                    <span class="r145 r">s</span> = <span class="r145 r">s</span>.<span class="i">Remove</span>(<span class="r147 r">i</span>);
 
                    <b>break</b>;
                }
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">UNIX</span>
<span class="e">                    if (keyInfo.Key == ConsoleKey.Backspace)
                    {
                        if (index &gt; 0)
                        {
                            int length = s.Length;
                            s = s.Remove(index - 1, 1);
                            index--;
                            cursorCurrent = Console.CursorLeft;
                            Console.CursorLeft = cursorLeft;
                            Console.Out.Write(s.PadRight(length));
                            Console.CursorLeft = cursorCurrent - 1;
                        }
 
                        continue;
                    }
 
                    if (keyInfo.Key == ConsoleKey.Delete
                        || (keyInfo.Key == ConsoleKey.D &amp;&amp; keyInfo.Modifiers.HasFlag(ConsoleModifiers.Control)))
                    {
                        if (index &lt; s.Length)
                        {
                            int length = s.Length;
                            s = s.Remove(index, 1);
                            cursorCurrent = Console.CursorLeft;
                            Console.CursorLeft = cursorLeft;
                            Console.Out.Write(s.PadRight(length));
                            Console.CursorLeft = cursorCurrent;
                        }
 
                        continue;
                    }
 
                    if (keyInfo.Key == ConsoleKey.LeftArrow
                        || (keyInfo.Key == ConsoleKey.B &amp;&amp; keyInfo.Modifiers.HasFlag(ConsoleModifiers.Control)))
                    {
                        if (Console.CursorLeft &gt; cursorLeft)
                        {
                            Console.CursorLeft--;
                            index--;
                        }
 
                        continue;
                    }
 
                    if (keyInfo.Key == ConsoleKey.RightArrow
                        || (keyInfo.Key == ConsoleKey.F &amp;&amp; keyInfo.Modifiers.HasFlag(ConsoleModifiers.Control)))
                    {
                        if (Console.CursorLeft &lt; cursorLeft + s.Length)
                        {
                            Console.CursorLeft++;
                            index++;
                        }
 
                        continue;
                    }
 
                    if (keyInfo.Key == ConsoleKey.UpArrow
                        || keyInfo.Key == ConsoleKey.DownArrow
                        || keyInfo.Key == ConsoleKey.PageUp
                        || keyInfo.Key == ConsoleKey.PageDown)
                    {
                        // Arrow/Page Up/down is unimplemented, so fail gracefully
                        continue;
                    }
 
                    if (keyInfo.Key == ConsoleKey.Home
                        || (keyInfo.Key == ConsoleKey.A &amp;&amp; keyInfo.Modifiers.HasFlag(ConsoleModifiers.Control)))
                    {
                        Console.CursorLeft = cursorLeft;
                        index = 0;
                        continue;
                    }
 
                    if (keyInfo.Key == ConsoleKey.End
                        || (keyInfo.Key == ConsoleKey.E &amp;&amp; keyInfo.Modifiers.HasFlag(ConsoleModifiers.Control)))
                    {
                        Console.CursorLeft = cursorLeft + s.Length;
                        index = s.Length;
                        continue;
                    }
 
                    if (keyInfo.Key == ConsoleKey.Escape)
                    {
                        Console.CursorLeft = cursorLeft;
                        index = s.Length;
                        s = string.Empty;
                        continue;
                    }
 
                    if (keyInfo.Key == ConsoleKey.Insert)
                    {
                        // Toggle insert/overwrite mode
                        insertMode = !insertMode;
                        continue;
                    }
 
                    if (char.IsControl(keyInfo.KeyChar))
                    {
                        // deny list control characters
                        continue;
                    }
 
                    // Handle case where terminal gets reset and the index is outside of the buffer
                    if (index &gt; s.Length)
                    {
                        index = s.Length;
                    }
 
                    // Modify string
                    if (!insertMode &amp;&amp; index &lt; s.Length) // then overwrite mode
                    {
                        s = s.Remove(index, 1);
                    }
 
                    s = s.Insert(index, keyInfo.KeyChar.ToString());
                    index++;
 
                    // Redisplay string
                    cursorCurrent = Console.CursorLeft;
                    Console.CursorLeft = cursorLeft;
                    Console.Out.Write(s);
                    Console.CursorLeft = cursorCurrent + 1;
</span><span class="k preprocess">#</span><span class="k preprocess">endif</span>
            }
 
            <a href="/System.Management.Automation/A.html#c04955255430d32f" class="t t">Dbg</a>.<span class="i">Assert</span>(
                       (<span class="r145 r">s</span> == <b>null</b> &amp;&amp; <span class="r140 r">result</span> == <a href="#0de1ff3de6688ce7" class="t t">ReadLineResult</a>.<a href="#70cb86ce9cc6fa0a" class="i field">endedOnBreak</a>)
                       || (<span class="r145 r">s</span> != <b>null</b> &amp;&amp; <span class="r140 r">result</span> != <a href="#0de1ff3de6688ce7" class="t t">ReadLineResult</a>.<a href="#70cb86ce9cc6fa0a" class="i field">endedOnBreak</a>),
                       <span class="s">&quot;s should only be null if input ended with a break&quot;</span>);
 
            <b>return</b> <span class="r145 r">s</span>;
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">UNIX</span>
<span class="e">            }
            finally
            {
                Console.TreatControlCAsInput = treatControlCAsInput;
            }
</span><span class="k preprocess">#</span><span class="k preprocess">endif</span>
        }
 
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">UNIX</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Get the character at the cursor when the user types &#39;tab&#39; in the middle of line.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r151 r">cursorPosition</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The cursor position where &#39;tab&#39; is hit.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>private char</b> <a id="c43d36ccb42b3240" href="../../R/c43d36ccb42b3240.html" target="n" data-glyph="76,1" class="i method">GetCharacterUnderCursor</a>(<a href="/System.Management.Automation/A.html#c6f6da6e12de292e" class="t t">Coordinates</a> <span id="r151 rd" class="r151 r">cursorPosition</span>)
        {
            <a href="/System.Management.Automation/A.html#bf950e0fd28033b0" class="t t">Rectangle</a> <span id="r152 rd" class="r152 r">region</span> = <b>new</b> <span class="t">Rectangle</span>(0, <span class="r151 r">cursorPosition</span>.<a href="/System.Management.Automation/A.html#168280a926d1b9da" class="i property">Y</a>, <a href="#33b028e308b5319d" class="i property">RawUI</a>.<a href="/System.Management.Automation/A.html#fb00d782b83e287c" class="i property">BufferSize</a>.<a href="/System.Management.Automation/A.html#cc1bb8de7549bf9d" class="i property">Width</a> - 1, <span class="r151 r">cursorPosition</span>.<a href="/System.Management.Automation/A.html#168280a926d1b9da" class="i property">Y</a>);
            <a href="/System.Management.Automation/A.html#9e00d99644eab7e7" class="t t">BufferCell</a>[,] <span id="r153 rd" class="r153 r">content</span> = <a href="#33b028e308b5319d" class="i property">RawUI</a>.<a href="/System.Management.Automation/A.html#02aa83fed0f18b62" class="i method">GetBufferContents</a>(<span class="r152 r">region</span>);
 
            <b>for</b> (<b>int</b> <span id="r154 rd" class="r154 r">index</span> = 0, <span id="r155 rd" class="r155 r">column</span> = 0; <span class="r155 r">column</span> &lt;= <span class="r151 r">cursorPosition</span>.<a href="/System.Management.Automation/A.html#62aff8c33e5f09b9" class="i property">X</a>; <span class="r154 r">index</span>++)
            {
                <a href="/System.Management.Automation/A.html#9e00d99644eab7e7" class="t t">BufferCell</a> <span id="r156 rd" class="r156 r">cell</span> = <span class="r153 r">content</span>[0, <span class="r154 r">index</span>];
                <b>if</b> (<span class="r156 r">cell</span>.<a href="/System.Management.Automation/A.html#2dbed14bfac26d72" class="i property">BufferCellType</a> == <a href="/System.Management.Automation/A.html#3c3f2b2b5dfb7582" class="t t">BufferCellType</a>.<a href="/System.Management.Automation/A.html#09bc52b9f7ebe144" class="i field">Complete</a> || <span class="r156 r">cell</span>.<a href="/System.Management.Automation/A.html#2dbed14bfac26d72" class="i property">BufferCellType</a> == <a href="/System.Management.Automation/A.html#3c3f2b2b5dfb7582" class="t t">BufferCellType</a>.<a href="/System.Management.Automation/A.html#f6d6d49b392106b7" class="i field">Leading</a>)
                {
                    <b>if</b> (<span class="r155 r">column</span> == <span class="r151 r">cursorPosition</span>.<a href="/System.Management.Automation/A.html#62aff8c33e5f09b9" class="i property">X</a>)
                    {
                        <b>return</b> <span class="r156 r">cell</span>.<a href="/System.Management.Automation/A.html#b94f4479d2cd5557" class="i property">Character</a>;
                    }
 
                    <span class="r155 r">column</span> += <a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#e26e981e21022d34" class="i method">LengthInBufferCells</a>(<span class="r156 r">cell</span>.<a href="/System.Management.Automation/A.html#b94f4479d2cd5557" class="i property">Character</a>);
                }
            }
 
            <a href="/System.Management.Automation/A.html#c04955255430d32f" class="t t">Dbg</a>.<span class="i">Assert</span>(<b>false</b>, <span class="s">&quot;the character at the cursor should be retrieved, never gets to here&quot;</span>);
            <b>return</b> <span class="s">&#39;\0&#39;</span>;
        }
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Strip nulls from a string...</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r157 r">input</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The string to process.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">The string with any \0 characters removed...</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>private static string</b> <a id="4f09cd243a3972bc" href="../../R/4f09cd243a3972bc.html" target="n" data-glyph="76,1" class="i method">RemoveNulls</a>(<b>string</b> <span id="r157 rd" class="r157 r">input</span>)
        {
            <b>if</b> (<span class="r157 r">input</span>.<span class="i">Contains</span>(<span class="s">&#39;\0&#39;</span>))
            {
                <b>return</b> <span class="r157 r">input</span>;
            }
 
            <span class="i">StringBuilder</span> <span id="r158 rd" class="r158 r">sb</span> = <b>new</b> <span class="i">StringBuilder</span>();
            <b>foreach</b> (<b>char</b> <span id="r159 rd" class="r159 r">c</span> <b>in</b> <span class="r157 r">input</span>)
            {
                <b>if</b> (<span class="r159 r">c</span> != <span class="s">&#39;\0&#39;</span>)
                    <span class="r158 r">sb</span>.<span class="i">Append</span>(<span class="r159 r">c</span>);
            }
 
            <b>return</b> <span class="r158 r">sb</span>.<span class="i">ToString</span>();
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Reads a line, and completes the input for the user if they hit tab.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r160 r">exec</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The Executor instance on which to run any pipelines that are needed to find matches</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> null on a break event</span>
        <span class="c">///</span><span class="c"> the completed line otherwise</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal string</b> <a id="b72e249bacf9760b" href="../../R/b72e249bacf9760b.html" target="n" data-glyph="74,1" class="i method">ReadLineWithTabCompletion</a>(<a href="Executor.cs.html#c4a69b641f3e390e" class="t t">Executor</a> <span id="r160 rd" class="r160 r">exec</span>)
        {
            <b>string</b> <span id="r161 rd" class="r161 r">input</span> = <b>null</b>;
            <b>string</b> <span id="r162 rd" class="r162 r">lastInput</span> = <b>string</b>.<span class="i">Empty</span>;
 
            <a href="#0de1ff3de6688ce7" class="t t">ReadLineResult</a> <span id="r163 rd" class="r163 r">rlResult</span> = <a href="#0de1ff3de6688ce7" class="t t">ReadLineResult</a>.<a href="#d0897a0829dfafd7" class="i field">endedOnEnter</a>;
 
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">UNIX</span>
            <span class="i">ConsoleHandle</span> <span id="r164 rd" class="r164 r">handle</span> = <a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#d72136ddad017191" class="i method">GetActiveScreenBufferHandle</a>();
 
            <b>string</b> <span id="r165 rd" class="r165 r">lastCompletion</span> = <b>string</b>.<span class="i">Empty</span>;
            <a href="/System.Management.Automation/A.html#4d1d20b1c8ac2812" class="t t">Size</a> <span id="r166 rd" class="r166 r">screenBufferSize</span> = <a href="#33b028e308b5319d" class="i property">RawUI</a>.<a href="/System.Management.Automation/A.html#fb00d782b83e287c" class="i property">BufferSize</a>;
 
            <span class="c">// Save the cursor position at the end of the prompt string so that we can restore it later to write the</span>
            <span class="c">// completed input.</span>
 
            <a href="/System.Management.Automation/A.html#c6f6da6e12de292e" class="t t">Coordinates</a> <span id="r167 rd" class="r167 r">endOfPromptCursorPos</span> = <a href="#33b028e308b5319d" class="i property">RawUI</a>.<a href="/System.Management.Automation/A.html#1096ecedf81a22c3" class="i property">CursorPosition</a>;
 
            <a href="/System.Management.Automation/A.html#a9d35cade4030f50" class="t t">CommandCompletion</a> <span id="r168 rd" class="r168 r">commandCompletion</span> = <b>null</b>;
            <b>string</b> <span id="r169 rd" class="r169 r">completionInput</span> = <b>null</b>;
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
 
            <b>while</b> (<b>true</b>)
            {
                <b>if</b> (<a href="#bc8ef9b9eba487df" class="i method">TryInvokeUserDefinedReadLine</a>(<b>out</b> <span class="r161 r">input</span>))
                {
                    <b>break</b>;
                }
 
                <span class="r161 r">input</span> = <a href="#67bd0565f50155f1" class="i method">ReadLine</a>(<b>true</b>, <span class="r162 r">lastInput</span>, <b>out</b> <span class="r163 r">rlResult</span>, <b>false</b>, <b>false</b>);
 
                <b>if</b> (<span class="r161 r">input</span> == <b>null</b>)
                {
                    <b>break</b>;
                }
 
                <b>if</b> (<span class="r163 r">rlResult</span> == <a href="#0de1ff3de6688ce7" class="t t">ReadLineResult</a>.<a href="#d0897a0829dfafd7" class="i field">endedOnEnter</a>)
                {
                    <b>break</b>;
                }
 
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">UNIX</span> <span class="c">// Portable code only ends on enter (or no input), so tab is not processed</span>
<span class="e">                throw new PlatformNotSupportedException(&quot;This readline state is unsupported in portable code!&quot;);
</span><span class="k preprocess">#</span><span class="k preprocess">else</span>
 
                <a href="/System.Management.Automation/A.html#c6f6da6e12de292e" class="t t">Coordinates</a> <span id="r170 rd" class="r170 r">endOfInputCursorPos</span> = <a href="#33b028e308b5319d" class="i property">RawUI</a>.<a href="/System.Management.Automation/A.html#1096ecedf81a22c3" class="i property">CursorPosition</a>;
                <b>string</b> <span id="r171 rd" class="r171 r">completedInput</span> = <b>null</b>;
 
                <b>if</b> (<span class="r163 r">rlResult</span> == <a href="#0de1ff3de6688ce7" class="t t">ReadLineResult</a>.<a href="#4712e37fb521defe" class="i field">endedOnTab</a> || <span class="r163 r">rlResult</span> == <a href="#0de1ff3de6688ce7" class="t t">ReadLineResult</a>.<a href="#b637643b3789d115" class="i field">endedOnShiftTab</a>)
                {
                    <b>int</b> <span id="r172 rd" class="r172 r">tabIndex</span> = <span class="r161 r">input</span>.<span class="i">IndexOf</span>(<a href="#74ce6416b6e0e017" class="i field">Tab</a>, <span class="i">StringComparison</span>.<span class="i">Ordinal</span>);
                    <a href="/System.Management.Automation/A.html#c04955255430d32f" class="t t">Dbg</a>.<span class="i">Assert</span>(<span class="r172 r">tabIndex</span> != -1, <span class="s">&quot;tab should appear in the input&quot;</span>);
 
                    <b>string</b> <span id="r173 rd" class="r173 r">restOfLine</span> = <b>string</b>.<span class="i">Empty</span>;
                    <b>int</b> <span id="r174 rd" class="r174 r">leftover</span> = <span class="r161 r">input</span>.<span class="i">Length</span> - <span class="r172 r">tabIndex</span> - 1;
                    <b>if</b> (<span class="r174 r">leftover</span> &gt; 0)
                    {
                        <span class="c">// We are reading from the console (not redirected, b/c we don&#39;t end on tab when redirected)</span>
                        <span class="c">// If the cursor is at the end of a line, there is actually a space character at the cursor&#39;s position and when we type tab</span>
                        <span class="c">// at the end of a line, that space character is replaced by the tab. But when we type tab at the middle of a line, the space</span>
                        <span class="c">// character at the end is preserved, we should remove that space character because it&#39;s not provided by the user.</span>
                        <span class="r161 r">input</span> = <span class="r161 r">input</span>.<span class="i">Remove</span>(<span class="r161 r">input</span>.<span class="i">Length</span> - 1);
                        <span class="r173 r">restOfLine</span> = <span class="r161 r">input</span>.<span class="i">Substring</span>(<span class="r172 r">tabIndex</span> + 1);
                    }
 
                    <span class="r161 r">input</span> = <span class="r161 r">input</span>.<span class="i">Remove</span>(<span class="r172 r">tabIndex</span>);
 
                    <b>if</b> (<span class="r161 r">input</span> != <span class="r165 r">lastCompletion</span> || <span class="r168 r">commandCompletion</span> == <b>null</b>)
                    {
                        <span class="r169 r">completionInput</span> = <span class="r161 r">input</span>;
                        <span class="r168 r">commandCompletion</span> = <a href="#967ca1960c62816d" class="i method">GetNewCompletionResults</a>(<span class="r161 r">input</span>);
                    }
 
                    <a href="/System.Management.Automation/A.html#a4c553f80d9e648c" class="k">var</a> <span id="r175 rd" class="r175 r">completionResult</span> = <span class="r168 r">commandCompletion</span>.<span class="i">GetNextResult</span>(<span class="r163 r">rlResult</span> == <a href="#0de1ff3de6688ce7" class="t t">ReadLineResult</a>.<a href="#4712e37fb521defe" class="i field">endedOnTab</a>);
                    <b>if</b> (<span class="r175 r">completionResult</span> != <b>null</b>)
                    {
                        <span class="r171 r">completedInput</span> = <b>string</b>.<span class="i">Concat</span>(<span class="r169 r">completionInput</span>.<span class="i">AsSpan</span>(0, <span class="r168 r">commandCompletion</span>.<a href="/System.Management.Automation/A.html#f76230ac471e920e" class="i property">ReplacementIndex</a>), <span class="r175 r">completionResult</span>.<a href="/System.Management.Automation/A.html#536dd0f937b80f9b" class="i property">CompletionText</a>);
                    }
                    <b>else</b>
                    {
                        <span class="r171 r">completedInput</span> = <span class="r169 r">completionInput</span>;
                    }
 
                    <b>if</b> (<span class="r173 r">restOfLine</span> != <b>string</b>.<span class="i">Empty</span>)
                    {
                        <span class="r171 r">completedInput</span> += <span class="r173 r">restOfLine</span>;
                    }
 
                    <b>if</b> (<span class="r171 r">completedInput</span>.<span class="i">Length</span> &gt; (<a href="#0d1ef7b721b88f17" class="i field">MaxInputLineLength</a> - 2))
                    {
                        <span class="r171 r">completedInput</span> = <span class="r171 r">completedInput</span>.<span class="i">Substring</span>(0, <a href="#0d1ef7b721b88f17" class="i field">MaxInputLineLength</a> - 2);
                    }
 
                    <span class="c">// Remove any nulls from the string...</span>
                    <span class="r171 r">completedInput</span> = <a href="#4f09cd243a3972bc" class="i method">RemoveNulls</a>(<span class="r171 r">completedInput</span>);
 
                    <span class="c">// adjust the saved cursor position if the buffer scrolled as the user was typing (i.e. the user</span>
                    <span class="c">// typed past the end of the buffer).</span>
 
                    <b>int</b> <span id="r176 rd" class="r176 r">linesOfInput</span> = (<span class="r167 r">endOfPromptCursorPos</span>.<a href="/System.Management.Automation/A.html#62aff8c33e5f09b9" class="i property">X</a> + <span class="r161 r">input</span>.<span class="i">Length</span>) / <span class="r166 r">screenBufferSize</span>.<a href="/System.Management.Automation/A.html#cc1bb8de7549bf9d" class="i property">Width</a>;
                    <span class="r167 r">endOfPromptCursorPos</span>.<a href="/System.Management.Automation/A.html#168280a926d1b9da" class="i property">Y</a> = <span class="r170 r">endOfInputCursorPos</span>.<a href="/System.Management.Automation/A.html#168280a926d1b9da" class="i property">Y</a> - <span class="r176 r">linesOfInput</span>;
 
                    <span class="c">// replace the displayed input with the new input</span>
                    <b>try</b>
                    {
                        <a href="#33b028e308b5319d" class="i property">RawUI</a>.<span class="i">CursorPosition</span> = <span class="r167 r">endOfPromptCursorPos</span>;
                    }
                    <b>catch</b> (<a href="/System.Management.Automation/A.html#30c91f7bd86d4aba" class="t t">PSArgumentOutOfRangeException</a>)
                    {
                        <span class="c">// If we go a range exception, it&#39;s because</span>
                        <span class="c">// there&#39;s no room in the buffer for the completed</span>
                        <span class="c">// line so we&#39;ll just pretend that there was no match...</span>
                        <b>break</b>;
                    }
 
                    <span class="c">// When the string is written to the console, a space character is actually appended to the string</span>
                    <span class="c">// and the cursor will flash at the position of that space character.</span>
                    <span class="i">WriteToConsole</span>(<span class="r171 r">completedInput</span>, <b>false</b>);
 
                    <a href="/System.Management.Automation/A.html#c6f6da6e12de292e" class="t t">Coordinates</a> <span id="r177 rd" class="r177 r">endOfCompletionCursorPos</span> = <a href="#33b028e308b5319d" class="i property">RawUI</a>.<a href="/System.Management.Automation/A.html#1096ecedf81a22c3" class="i property">CursorPosition</a>;
 
                    <span class="c">// adjust the starting cursor position if the screen buffer has scrolled as a result of writing the</span>
                    <span class="c">// completed input (i.e. writing the completed input ran past the end of the buffer).</span>
 
                    <b>int</b> <span id="r178 rd" class="r178 r">linesOfCompletedInput</span> = (<span class="r167 r">endOfPromptCursorPos</span>.<a href="/System.Management.Automation/A.html#62aff8c33e5f09b9" class="i property">X</a> + <span class="r171 r">completedInput</span>.<span class="i">Length</span>) / <span class="r166 r">screenBufferSize</span>.<a href="/System.Management.Automation/A.html#cc1bb8de7549bf9d" class="i property">Width</a>;
                    <span class="r167 r">endOfPromptCursorPos</span>.<a href="/System.Management.Automation/A.html#168280a926d1b9da" class="i property">Y</a> = <span class="r177 r">endOfCompletionCursorPos</span>.<a href="/System.Management.Automation/A.html#168280a926d1b9da" class="i property">Y</a> - <span class="r178 r">linesOfCompletedInput</span>;
 
                    <span class="c">// blank out any &quot;leftover&quot; old input.  That&#39;s everything between the cursor position at the time</span>
                    <span class="c">// the user hit tab up to the current cursor position after writing the completed text.</span>
 
                    <b>int</b> <span id="r179 rd" class="r179 r">deltaInput</span> =
                        (<span class="r170 r">endOfInputCursorPos</span>.<a href="/System.Management.Automation/A.html#168280a926d1b9da" class="i property">Y</a> * <span class="r166 r">screenBufferSize</span>.<a href="/System.Management.Automation/A.html#cc1bb8de7549bf9d" class="i property">Width</a> + <span class="r170 r">endOfInputCursorPos</span>.<a href="/System.Management.Automation/A.html#62aff8c33e5f09b9" class="i property">X</a>)
                        - (<span class="r177 r">endOfCompletionCursorPos</span>.<a href="/System.Management.Automation/A.html#168280a926d1b9da" class="i property">Y</a> * <span class="r166 r">screenBufferSize</span>.<a href="/System.Management.Automation/A.html#cc1bb8de7549bf9d" class="i property">Width</a> + <span class="r177 r">endOfCompletionCursorPos</span>.<a href="/System.Management.Automation/A.html#62aff8c33e5f09b9" class="i property">X</a>);
 
                    <b>if</b> (<span class="r179 r">deltaInput</span> &gt; 0)
                    {
                        <a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#a6a910c01b3d8537" class="i method">FillConsoleOutputCharacter</a>(<span class="r164 r">handle</span>, <span class="s">&#39; &#39;</span>, <span class="r179 r">deltaInput</span>, <span class="r177 r">endOfCompletionCursorPos</span>);
                    }
 
                    <b>if</b> (<span class="r173 r">restOfLine</span> != <b>string</b>.<span class="i">Empty</span>)
                    {
                        <span class="r165 r">lastCompletion</span> = <span class="r171 r">completedInput</span>.<span class="i">Remove</span>(<span class="r171 r">completedInput</span>.<span class="i">Length</span> - <span class="r173 r">restOfLine</span>.<span class="i">Length</span>);
                        <span class="i">SendLeftArrows</span>(<span class="r173 r">restOfLine</span>.<span class="i">Length</span>);
                    }
                    <b>else</b>
                    {
                        <span class="r165 r">lastCompletion</span> = <span class="r171 r">completedInput</span>;
                    }
 
                    <span class="r162 r">lastInput</span> = <span class="r171 r">completedInput</span>;
                }
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
            }
 
            <span class="c">// Since we did not transcribe any call to ReadLine, transcribe the results here.</span>
 
            <b>if</b> (<a href="#84b0fd621e4256ef" class="i field">_parent</a>.<a href="ConsoleHostTranscript.cs.html#ec2c25c02b262216" class="i property">IsTranscribing</a>)
            {
                <span class="c">// Reads always terminate with the enter key, so add that.</span>
 
                <a href="#84b0fd621e4256ef" class="i field">_parent</a>.<span class="i">WriteLineToTranscript</span>(<span class="r161 r">input</span>);
            }
 
            <b>return</b> <span class="r161 r">input</span>;
        }
 
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">UNIX</span>
        <b>private static void</b> <a id="5d2e3387f15148f5" href="../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">SendLeftArrows</a>(<b>int</b> <span id="r180 rd" class="r180 r">length</span>)
        {
            <b>var</b> <span id="r181 rd" class="r181 r">inputs</span> = <b>new</b> <a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#f9880a1b43685c6d" class="t t">INPUT</a>[<span class="r180 r">length</span> * 2];
            <b>for</b> (<b>int</b> <span id="r182 rd" class="r182 r">i</span> = 0; <span class="r182 r">i</span> &lt; <span class="r180 r">length</span>; <span class="r182 r">i</span>++)
            {
                <a href="ConsoleControl.cs.html#f9880a1b43685c6d" class="k">var</a> <span id="r183 rd" class="r183 r">down</span> = <b>new</b> <a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<span class="t">INPUT</span>();
                <span class="r183 r">down</span>.<a href="ConsoleControl.cs.html#ce335fdef2c721a9" class="i field">Type</a> = (<b>uint</b>)<a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#e06451988aa64b8c" class="t t">InputType</a>.<a href="ConsoleControl.cs.html#cdbc39ccfc5c93cb" class="i field">Keyboard</a>;
                <span class="r183 r">down</span>.<a href="ConsoleControl.cs.html#50f79363f245deb1" class="i field">Data</a>.<a href="ConsoleControl.cs.html#b7b4173067eaeced" class="i field">Keyboard</a> = <b>new</b> <a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<span class="t">KeyboardInput</span>();
                <span class="r183 r">down</span>.<a href="ConsoleControl.cs.html#50f79363f245deb1" class="i field">Data</a>.<a href="ConsoleControl.cs.html#b7b4173067eaeced" class="i field">Keyboard</a>.<a href="ConsoleControl.cs.html#8d2f2a2119c335ee" class="i field">Vk</a> = (<b>ushort</b>)<a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#7a58bff344498f46" class="t t">VirtualKeyCode</a>.<a href="ConsoleControl.cs.html#985ab494f27304a2" class="i field">Left</a>;
                <span class="r183 r">down</span>.<a href="ConsoleControl.cs.html#50f79363f245deb1" class="i field">Data</a>.<a href="ConsoleControl.cs.html#b7b4173067eaeced" class="i field">Keyboard</a>.<a href="ConsoleControl.cs.html#d9869f6782de9b79" class="i field">Scan</a> = 0;
                <span class="r183 r">down</span>.<a href="ConsoleControl.cs.html#50f79363f245deb1" class="i field">Data</a>.<a href="ConsoleControl.cs.html#b7b4173067eaeced" class="i field">Keyboard</a>.<a href="ConsoleControl.cs.html#c4b5e9e335280c46" class="i field">Flags</a> = 0;
                <span class="r183 r">down</span>.<a href="ConsoleControl.cs.html#50f79363f245deb1" class="i field">Data</a>.<a href="ConsoleControl.cs.html#b7b4173067eaeced" class="i field">Keyboard</a>.<a href="ConsoleControl.cs.html#66b7780b0c48a6e0" class="i field">Time</a> = 0;
                <span class="r183 r">down</span>.<a href="ConsoleControl.cs.html#50f79363f245deb1" class="i field">Data</a>.<a href="ConsoleControl.cs.html#b7b4173067eaeced" class="i field">Keyboard</a>.<a href="ConsoleControl.cs.html#495a9cb2c5d30f02" class="i field">ExtraInfo</a> = <span class="i">IntPtr</span>.<span class="i">Zero</span>;
 
                <a href="ConsoleControl.cs.html#f9880a1b43685c6d" class="k">var</a> <span id="r184 rd" class="r184 r">up</span> = <b>new</b> <a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<span class="t">INPUT</span>();
                <span class="r184 r">up</span>.<a href="ConsoleControl.cs.html#ce335fdef2c721a9" class="i field">Type</a> = (<b>uint</b>)<a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#e06451988aa64b8c" class="t t">InputType</a>.<a href="ConsoleControl.cs.html#cdbc39ccfc5c93cb" class="i field">Keyboard</a>;
                <span class="r184 r">up</span>.<a href="ConsoleControl.cs.html#50f79363f245deb1" class="i field">Data</a>.<a href="ConsoleControl.cs.html#b7b4173067eaeced" class="i field">Keyboard</a> = <b>new</b> <a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<span class="t">KeyboardInput</span>();
                <span class="r184 r">up</span>.<a href="ConsoleControl.cs.html#50f79363f245deb1" class="i field">Data</a>.<a href="ConsoleControl.cs.html#b7b4173067eaeced" class="i field">Keyboard</a>.<a href="ConsoleControl.cs.html#8d2f2a2119c335ee" class="i field">Vk</a> = (<b>ushort</b>)<a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#7a58bff344498f46" class="t t">VirtualKeyCode</a>.<a href="ConsoleControl.cs.html#985ab494f27304a2" class="i field">Left</a>;
                <span class="r184 r">up</span>.<a href="ConsoleControl.cs.html#50f79363f245deb1" class="i field">Data</a>.<a href="ConsoleControl.cs.html#b7b4173067eaeced" class="i field">Keyboard</a>.<a href="ConsoleControl.cs.html#d9869f6782de9b79" class="i field">Scan</a> = 0;
                <span class="r184 r">up</span>.<a href="ConsoleControl.cs.html#50f79363f245deb1" class="i field">Data</a>.<a href="ConsoleControl.cs.html#b7b4173067eaeced" class="i field">Keyboard</a>.<a href="ConsoleControl.cs.html#c4b5e9e335280c46" class="i field">Flags</a> = (<b>uint</b>)<a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#ce9a35f070d2961b" class="t t">KeyboardFlag</a>.<a href="ConsoleControl.cs.html#dc31d1ea217fc8f5" class="i field">KeyUp</a>;
                <span class="r184 r">up</span>.<a href="ConsoleControl.cs.html#50f79363f245deb1" class="i field">Data</a>.<a href="ConsoleControl.cs.html#b7b4173067eaeced" class="i field">Keyboard</a>.<a href="ConsoleControl.cs.html#66b7780b0c48a6e0" class="i field">Time</a> = 0;
                <span class="r184 r">up</span>.<a href="ConsoleControl.cs.html#50f79363f245deb1" class="i field">Data</a>.<a href="ConsoleControl.cs.html#b7b4173067eaeced" class="i field">Keyboard</a>.<a href="ConsoleControl.cs.html#495a9cb2c5d30f02" class="i field">ExtraInfo</a> = <span class="i">IntPtr</span>.<span class="i">Zero</span>;
 
                <span class="r181 r">inputs</span>[2 * <span class="r182 r">i</span>] = <span class="r183 r">down</span>;
                <span class="r181 r">inputs</span>[2 * <span class="r182 r">i</span> + 1] = <span class="r184 r">up</span>;
            }
 
            <a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#1b0107cd8bcfa099" class="i method">MimicKeyPress</a>(<span class="r181 r">inputs</span>);
        }
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
 
        <b>private</b> <a href="/System.Management.Automation/A.html#a9d35cade4030f50" class="t t">CommandCompletion</a> <a id="967ca1960c62816d" href="../../R/967ca1960c62816d.html" target="n" data-glyph="76,1" class="i method">GetNewCompletionResults</a>(<b>string</b> <span id="r185 rd" class="r185 r">input</span>)
        {
            <b>try</b>
            {
                <a href="/System.Management.Automation/A.html#7e5b8eab1aa16fd7" class="k">var</a> <span id="r186 rd" class="r186 r">runspace</span> = <a href="#84b0fd621e4256ef" class="i field">_parent</a>.<a href="ConsoleHost.cs.html#392ae36c563f0bce" class="i property">Runspace</a>;
                <a href="/System.Management.Automation/A.html#9e8f0b396592e65c" class="k">var</a> <span id="r187 rd" class="r187 r">debugger</span> = <span class="r186 r">runspace</span>.<a href="/System.Management.Automation/A.html#d6610640d00b19f5" class="i property">Debugger</a>;
 
                <b>if</b> ((<span class="r187 r">debugger</span> != <b>null</b>) &amp;&amp; <span class="r187 r">debugger</span>.<a href="/System.Management.Automation/A.html#564232f4b51d11aa" class="i property">InBreakpoint</a>)
                {
                    <span class="c">// If in debug stop mode do command completion though debugger process command.</span>
                    <b>try</b>
                    {
                        <b>return</b> <a href="/System.Management.Automation/A.html#a9d35cade4030f50" class="t t">CommandCompletion</a>.<span class="i">CompleteInputInDebugger</span>(<span class="r185 r">input</span>, <span class="r185 r">input</span>.<span class="i">Length</span>, <b>null</b>, <span class="r187 r">debugger</span>);
                    }
                    <b>catch</b> (<a href="/System.Management.Automation/A.html#259a38c8b594783c" class="t t">PSInvalidOperationException</a>)
                    { }
                }
 
                <b>if</b> (<span class="r186 r">runspace</span> <b>is</b> <span class="i">LocalRunspace</span> &amp;&amp;
                    <span class="r186 r">runspace</span>.<span class="i">ExecutionContext</span>.<span class="i">EngineHostInterface</span>.<span class="i">NestedPromptCount</span> &gt; 0)
                {
                    <a href="#735667ca9bafaf9e" class="i field">_commandCompletionPowerShell</a> = <a href="/System.Management.Automation/A.html#3d1b346df3be574c" class="t t">PowerShell</a>.<a href="/System.Management.Automation/A.html#1c6a51d3c837bb4d" class="i method">Create</a>(<a href="/System.Management.Automation/A.html#c3c0f0e5e0b337ff" class="t t">RunspaceMode</a>.<a href="/System.Management.Automation/A.html#75d224de5df87e75" class="i field">CurrentRunspace</a>);
                }
                <b>else</b>
                {
                    <a href="#735667ca9bafaf9e" class="i field">_commandCompletionPowerShell</a> = <a href="/System.Management.Automation/A.html#3d1b346df3be574c" class="t t">PowerShell</a>.<a href="/System.Management.Automation/A.html#40345bc4625ff918" class="i method">Create</a>();
                    <a href="#735667ca9bafaf9e" class="i field">_commandCompletionPowerShell</a>.<span class="i">SetIsNested</span>(<a href="#84b0fd621e4256ef" class="i field">_parent</a>.<a href="ConsoleHost.cs.html#a0d6e5e20f7e47b4" class="i property">IsNested</a>);
                    <a href="#735667ca9bafaf9e" class="i field">_commandCompletionPowerShell</a>.<span class="i">Runspace</span> = <span class="r186 r">runspace</span>;
                }
 
                <b>return</b> <a href="/System.Management.Automation/A.html#a9d35cade4030f50" class="t t">CommandCompletion</a>.<span class="i">CompleteInput</span>(<span class="r185 r">input</span>, <span class="r185 r">input</span>.<span class="i">Length</span>, <b>null</b>, <a href="#735667ca9bafaf9e" class="i field">_commandCompletionPowerShell</a>);
            }
            <b>finally</b>
            {
                <a href="#735667ca9bafaf9e" class="i field">_commandCompletionPowerShell</a> = <b>null</b>;
            }
        }
 
        <b>private const string</b> <a id="50d1d14956482514" href="../../R/50d1d14956482514.html" target="n" data-glyph="10,1" class="i field">CustomReadlineCommand</a> = <span class="s">&quot;PSConsoleHostReadLine&quot;</span>;
 
        <b>private bool</b> <a id="bc8ef9b9eba487df" href="../../R/bc8ef9b9eba487df.html" target="n" data-glyph="76,1" class="i method">TryInvokeUserDefinedReadLine</a>(<b>out string</b> <span id="r188 rd" class="r188 r">input</span>)
        {
            <span class="c">// We&#39;re using GetCommands instead of GetCommand so we don&#39;t auto-load a module should the command exist, but isn&#39;t loaded.</span>
            <span class="c">// The idea is that if someone hasn&#39;t defined the command (say because they started -noprofile), we shouldn&#39;t auto-load</span>
            <span class="c">// this function.</span>
 
            <b>var</b> <span id="r189 rd" class="r189 r">runspace</span> = <a href="#84b0fd621e4256ef" class="i field">_parent</a>.<a href="ConsoleHost.cs.html#49ea483a58dc357d" class="i property">LocalRunspace</a>;
            <b>if</b> (<span class="r189 r">runspace</span> != <b>null</b> &amp;&amp;
                <span class="r189 r">runspace</span>.<span class="i">Engine</span>.<span class="i">Context</span>.<span class="i">EngineIntrinsics</span>.<span class="i">InvokeCommand</span>.<span class="i">GetCommands</span>(<a href="#50d1d14956482514" class="i field">CustomReadlineCommand</a>,
                    <a href="/System.Management.Automation/A.html#3699fe79fa6969b5" class="t t">CommandTypes</a>.<a href="/System.Management.Automation/A.html#8a4bdbbd93f182bf" class="i field">Function</a> | <a href="/System.Management.Automation/A.html#3699fe79fa6969b5" class="t t">CommandTypes</a>.<a href="/System.Management.Automation/A.html#e95f2e5deaaf9b93" class="i field">Cmdlet</a>, <span class="i">nameIsPattern</span>: <b>false</b>).<span class="i">Any</span>())
            {
                <b>try</b>
                {
                    <a href="/System.Management.Automation/A.html#3d1b346df3be574c" class="t t">PowerShell</a> <span id="r190 rd" class="r190 r">ps</span>;
                    <b>if</b> ((<span class="r189 r">runspace</span>.<span class="i">ExecutionContext</span>.<span class="i">EngineHostInterface</span>.<span class="i">NestedPromptCount</span> &gt; 0) &amp;&amp;
                        (<a href="/System.Management.Automation/A.html#7e5b8eab1aa16fd7" class="t t">Runspace</a>.<a href="/System.Management.Automation/A.html#efcd2ba43103de17" class="i property">DefaultRunspace</a> != <b>null</b>))
                    {
                        <span class="r190 r">ps</span> = <a href="/System.Management.Automation/A.html#3d1b346df3be574c" class="t t">PowerShell</a>.<a href="/System.Management.Automation/A.html#1c6a51d3c837bb4d" class="i method">Create</a>(<a href="/System.Management.Automation/A.html#c3c0f0e5e0b337ff" class="t t">RunspaceMode</a>.<a href="/System.Management.Automation/A.html#75d224de5df87e75" class="i field">CurrentRunspace</a>);
                    }
                    <b>else</b>
                    {
                        <span class="r190 r">ps</span> = <a href="/System.Management.Automation/A.html#3d1b346df3be574c" class="t t">PowerShell</a>.<a href="/System.Management.Automation/A.html#40345bc4625ff918" class="i method">Create</a>();
                        <span class="r190 r">ps</span>.<span class="i">Runspace</span> = <span class="r189 r">runspace</span>;
                    }
 
                    <b>var</b> <span id="r191 rd" class="r191 r">result</span> = <span class="r190 r">ps</span>.<span class="i">AddCommand</span>(<a href="#50d1d14956482514" class="i field">CustomReadlineCommand</a>).<span class="i">Invoke</span>();
                    <b>if</b> (<span class="r191 r">result</span>.<span class="i">Count</span> == 1)
                    {
                        <span class="r188 r">input</span> = <a href="/System.Management.Automation/A.html#a3c2513aa3da07fa" class="t t">PSObject</a>.<span class="i">Base</span>(<span class="r191 r">result</span>[0]) <b>as string</b>;
                        <b>return</b> <b>true</b>;
                    }
                }
                <b>catch</b> (<span class="i">Exception</span>)
                {
                }
            }
 
            <span class="r188 r">input</span> = <b>null</b>;
            <b>return</b> <b>false</b>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> implementation
 
        <span class="c">// used to serialize access to instance data</span>
 
        <b>private readonly object</b> <a id="dbd28972ee208717" href="../../R/dbd28972ee208717.html" target="n" data-glyph="46,1" class="i field">_instanceLock</a> = <b>new</b> <b>object</b>();
 
        <span class="c">// If this is true, class throws on read or prompt method which require</span>
        <span class="c">// access to console.</span>
        <b>internal bool</b> <a id="cb46812cffc140ff" href="../../R/cb46812cffc140ff.html" target="n" data-glyph="104,1" class="i property">ThrowOnReadAndPrompt</a>
        {
            <b>set</b>
            {
                <a href="#2407f47d0671df0d" class="i field">_throwOnReadAndPrompt</a> = <b>value</b>;
            }
        }
 
        <b>private bool</b> <a id="2407f47d0671df0d" href="../../R/2407f47d0671df0d.html" target="n" data-glyph="46,1" class="i field">_throwOnReadAndPrompt</a>;
 
        <b>internal void</b> <a id="6f818c219520a810" href="../../R/6f818c219520a810.html" target="n" data-glyph="74,1" class="i method">HandleThrowOnReadAndPrompt</a>()
        {
            <b>if</b> (<a href="#2407f47d0671df0d" class="i field">_throwOnReadAndPrompt</a>)
            {
                <b>throw</b> <a href="/System.Management.Automation/A.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<span class="i">NewInvalidOperationException</span>(<span class="i">ConsoleHostUserInterfaceStrings</span>.<span class="i">ReadFailsOnNonInteractiveFlag</span>);
            }
        }
 
        <span class="c">// this is a test hook for the ConsoleInteractiveTestTool, which sets this field to true.</span>
 
        <b>private readonly bool</b> <a id="142e9a50cad75382" href="../../R/142e9a50cad75382.html" target="n" data-glyph="46,1" class="i field">_isInteractiveTestToolListening</a>;
 
        <span class="c">// This instance data is &quot;read-only&quot; and need not have access serialized.</span>
 
        <b>private readonly</b> <a href="ConsoleHostRawUserInterface.cs.html#718850df43965d9a" class="t t">ConsoleHostRawUserInterface</a> <a id="370e7f4dd3c19e58" href="../../R/370e7f4dd3c19e58.html" target="n" data-glyph="46,1" class="i field">_rawui</a>;
        <b>private readonly</b> <a href="../../P/cda5e43a29a66e53.html#cda5e43a29a66e53" class="t t">ConsoleHost</a> <a id="84b0fd621e4256ef" href="../../R/84b0fd621e4256ef.html" target="n" data-glyph="46,1" class="i field">_parent</a>;
 
        [<span class="i">TraceSourceAttribute</span>(<span class="s">&quot;ConsoleHostUserInterface&quot;</span>, <span class="s">&quot;Console host&#39;s subclass of S.M.A.Host.Console&quot;</span>)]
        <b>private static readonly</b> <a href="/System.Management.Automation/A.html#6de812d1f374e1ae" class="t t">PSTraceSource</a> <a id="91d216330b410554" href="../../R/91d216330b410554.html" target="n" data-glyph="46,1" class="i field">s_tracer</a> = <a href="/System.Management.Automation/A.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<span class="i">GetTracer</span>(<span class="s">&quot;ConsoleHostUserInterface&quot;</span>, <span class="s">&quot;Console host&#39;s subclass of S.M.A.Host.Console&quot;</span>);
    }
}   <span class="c">// namespace</span>
</pre></td></tr></table></div></body></html>
