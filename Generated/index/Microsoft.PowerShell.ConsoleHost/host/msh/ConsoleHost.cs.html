<!DOCTYPE html>
<html><head><title>ConsoleHost.cs</title><link rel="stylesheet" href="../../../styles.css"><script src="../../../scripts.js"></script></head>
<body class="cB" onload="i(3044);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#Microsoft.PowerShell.ConsoleHost/host/msh/ConsoleHost.cs" target="_top">host\msh\ConsoleHost.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#Microsoft.PowerShell.ConsoleHost" target="_top">src\Microsoft.PowerShell.ConsoleHost\Microsoft.PowerShell.ConsoleHost.csproj</a> (Microsoft.PowerShell.ConsoleHost)</td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation.</span>
<span class="c">// Licensed under the MIT License.</span>
 
<span class="k preprocess">#</span><span class="k preprocess">pragma</span> <span class="k preprocess">warning</span> <span class="k preprocess">disable</span> 1634, 1691
 
<b>using</b> <span class="i n">System</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Collections</span>.<span class="i">Generic</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Collections</span>.<span class="i">ObjectModel</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Diagnostics</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Diagnostics</span>.<span class="i">CodeAnalysis</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Globalization</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">IO</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Configuration</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Host</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Internal</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Language</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Remoting</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Runspaces</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Tracing</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Reflection</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Runtime</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Runtime</span>.<span class="i">InteropServices</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Text</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Threading</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">PowerShell</span>.<span class="i n">Commands</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">PowerShell</span>.<span class="i n">Telemetry</span>;
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">LEGACYTELEMETRY</span>
<span class="e">using Microsoft.PowerShell.Telemetry.Internal;
</span><span class="k preprocess">#</span><span class="k preprocess">endif</span>
<b>using</b> <span class="i">ConsoleHandle</span> = <span class="i n">Microsoft</span>.<span class="i">Win32</span>.<span class="i">SafeHandles</span>.<span class="i">SafeFileHandle</span>;
<b>using</b> <span class="i">Dbg</span> = <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i">Diagnostics</span>;
<b>using</b> <span class="t">Debugger</span> = <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="/System.Management.Automation/A.html#9e8f0b396592e65c" class="t t">Debugger</a>;
 
<b>namespace</b> <span class="i n">Microsoft</span>.<span class="i n">PowerShell</span>
{
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Subclasses S.M.A.Host to implement a console-mode monad host.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Maintainability&quot;</span>, <span class="s">&quot;CA1506:AvoidExcessiveClassCoupling&quot;</span>)]
    <b>internal sealed</b> <a href="../../P/cda5e43a29a66e53.html" target="s" class="k">partial</a> <b>class</b> <a id="cda5e43a29a66e53" href="../../R/cda5e43a29a66e53.html" target="n" data-glyph="2,0" class="t t">ConsoleHost</a>
        :
        <a href="/System.Management.Automation/A.html#7b79cd90e035740e" class="t t">PSHost</a>,
        <span class="i">IDisposable</span>,
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">LEGACYTELEMETRY</span>
<span class="e">        IHostProvidesTelemetryData,
</span><span class="k preprocess">#</span><span class="k preprocess">endif</span>
        <a href="/System.Management.Automation/A.html#8baf67daeba803e8" class="t t">IHostSupportsInteractiveSession</a>
    {
        <span class="k preprocess">#</span><span class="k preprocess">region</span> static methods
 
        <b>internal const int</b> <a id="3e33bebb0392ce42" href="../../R/3e33bebb0392ce42.html" target="n" data-glyph="8,1" class="i field">ExitCodeSuccess</a> = 0;
        <b>internal const int</b> <a id="c55bfb7757e83018" href="../../R/../../0000000000.html" target="n" data-glyph="8,1" class="i field">ExitCodeCtrlBreak</a> = 128 + 21; <span class="c">// SIGBREAK</span>
        <b>internal const int</b> <a id="86d4e95f5b29b6b8" href="../../R/86d4e95f5b29b6b8.html" target="n" data-glyph="8,1" class="i field">ExitCodeInitFailure</a> = 70; <span class="c">// Internal Software Error</span>
        <b>internal const int</b> <a id="83561e4ffc7a11d9" href="../../R/83561e4ffc7a11d9.html" target="n" data-glyph="8,1" class="i field">ExitCodeBadCommandLineParameter</a> = 64; <span class="c">// Command Line Usage Error</span>
        <b>private const uint</b> <a id="6b851b8c7a53fda6" href="../../R/6b851b8c7a53fda6.html" target="n" data-glyph="10,1" class="i field">SPI_GETSCREENREADER</a> = 0x0046;
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">UNIX</span>
<span class="e">        internal const string DECCKM_ON = &quot;\x1b[?1h&quot;;
        internal const string DECCKM_OFF = &quot;\x1b[?1l&quot;;
</span><span class="k preprocess">#</span><span class="k preprocess">endif</span>
 
        [<span class="i">DllImport</span>(<span class="s">&quot;user32.dll&quot;</span>, <span class="i">SetLastError</span> = <b>true</b>)]
        [<b>return</b>: <span class="i">MarshalAs</span>(<span class="i">UnmanagedType</span>.<span class="i">Bool</span>)]
        <b>private static extern bool</b> <a id="f7d551a7289f5e05" href="../../R/f7d551a7289f5e05.html" target="n" data-glyph="76,1" class="i method">SystemParametersInfo</a>(<b>uint</b> <span id="r0 rd" class="r0 r">uiAction</span>, <b>uint</b> <span id="r1 rd" class="r1 r">uiParam</span>, <b>ref bool</b> <span id="r2 rd" class="r2 r">pvParam</span>, <b>uint</b> <span id="r3 rd" class="r3 r">fWinIni</span>);
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Internal Entry point in msh console host implementation.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r4 r">bannerText</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Banner text to be displayed by ConsoleHost</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r5 r">helpText</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Help text for minishell. This is displayed on &#39;minishell -?&#39;.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The exit code for the shell.</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> The behavior here is related to monitor work.</span>
        <span class="c">///</span><span class="c"> The low word of the exit code is available for the user.  The high word is reserved for the shell and monitor.</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> The shell process needs to return:</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> - if the shell.exe fails init, 0xFFFF0000</span>
        <span class="c">///</span><span class="c"> - if the exit keyword is called with no parameter at the point of top-level prompt, 0x80000000 (e.g. 0 with the high</span>
        <span class="c">///</span><span class="c"> bit set)</span>
        <span class="c">///</span><span class="c"> - if the exit keyword is called with any int param less than or equal to 0xFFFF, then that int masked with the high</span>
        <span class="c">///</span><span class="c"> bit set.  e.g. &quot;exit 3&quot; results in 0x80000003</span>
        <span class="c">///</span><span class="c"> - if the script ends (in the case of msh -command or msh -commandfile), then 0x80000000.</span>
        <span class="c">///</span><span class="c"> - if ctrl-break is pressed, with 0xFFFE0000</span>
        <span class="c">///</span><span class="c"> - if the shell.exe is passed a bad command-line parameter, with 0xFFFD0000.</span>
        <span class="c">///</span><span class="c"> - if the shell.exe crashes, with 0x00000000</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> The monitor process gets the exit code.  If the high bit is set, then the shell process exited normally (though</span>
        <span class="c">///</span><span class="c"> possibly due to an error).  If not, the shell process crashed.  If the shell.exe exit code is x00000000 (crashed)</span>
        <span class="c">///</span><span class="c"> or 0xFFFE0000 (user hit ctrl-break), the monitor should restart the shell.exe. Otherwise, the monitor should exit</span>
        <span class="c">///</span><span class="c"> with the same exit code as the shell.exe.</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> Anyone checking the exit code of the shell or monitor can mask off the high word to determine the exit code passed</span>
        <span class="c">///</span><span class="c"> by the script that the shell last executed.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal static int</b> <a id="5899eb4531b21b93" href="../../R/../../0000000000.html" target="n" data-glyph="74,1" class="i method">Start</a>(<b>string</b> <span id="r4 rd" class="r4 r">bannerText</span>, <b>string</b> <span id="r5 rd" class="r5 r">helpText</span>)
        {
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">DEBUG</span>
            <b>if</b> (<span class="i">Environment</span>.<span class="i">GetEnvironmentVariable</span>(<span class="s">&quot;POWERSHELL_DEBUG_STARTUP&quot;</span>) != <b>null</b>)
            {
                <b>while</b> (!<span class="i n">System</span>.<span class="i">Diagnostics</span>.<span class="i">Debugger</span>.<span class="i">IsAttached</span>)
                {
                    <span class="i">Thread</span>.<span class="i">Sleep</span>(1000);
                }
            }
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
 
            <span class="c">// put PSHOME in front of PATH so that calling `powershell` within `powershell` always starts the same running version</span>
            <b>string</b> <span id="r6 rd" class="r6 r">path</span> = <span class="i">Environment</span>.<span class="i">GetEnvironmentVariable</span>(<span class="s">&quot;PATH&quot;</span>);
            <b>string</b> <span id="r7 rd" class="r7 r">pshome</span> = <span class="i">Utils</span>.<span class="i">DefaultPowerShellAppBase</span> + <span class="i">Path</span>.<span class="i">PathSeparator</span>;
 
            <span class="c">// to not impact startup perf, we don&#39;t remove duplicates, but we avoid adding a duplicate to the front</span>
            <span class="c">// we also don&#39;t handle the edge case where PATH only contains $PSHOME</span>
            <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r6 r">path</span>))
            {
                <span class="i">Environment</span>.<span class="i">SetEnvironmentVariable</span>(<span class="s">&quot;PATH&quot;</span>, <span class="r7 r">pshome</span>);
            }
            <b>else</b> <b>if</b> (!<span class="r6 r">path</span>.<span class="i">StartsWith</span>(<span class="r7 r">pshome</span>, <span class="i">StringComparison</span>.<span class="i">Ordinal</span>))
            {
                <span class="i">Environment</span>.<span class="i">SetEnvironmentVariable</span>(<span class="s">&quot;PATH&quot;</span>, <span class="r7 r">pshome</span> + <span class="r6 r">path</span>);
            }
 
            <b>try</b>
            {
                <b>string</b> <span id="r8 rd" class="r8 r">profileDir</span> = <a href="/System.Management.Automation/A.html#693813241122eb45" class="t t">Platform</a>.<span class="i">CacheDirectory</span>;
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">UNIX</span>
                <b>if</b> (!<span class="i">Directory</span>.<span class="i">Exists</span>(<span class="r8 r">profileDir</span>))
                {
                    <span class="i">Directory</span>.<span class="i">CreateDirectory</span>(<span class="r8 r">profileDir</span>);
                }
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
                <span class="i">ProfileOptimization</span>.<span class="i">SetProfileRoot</span>(<span class="r8 r">profileDir</span>);
            }
            <b>catch</b>
            {
                <span class="c">// It&#39;s safe to ignore errors, the guarded code is just there to try and</span>
                <span class="c">// improve startup performance.</span>
            }
 
            <b>uint</b> <span id="r9 rd" class="r9 r">exitCode</span> = <a href="#3e33bebb0392ce42" class="i field">ExitCodeSuccess</a>;
 
            <span class="i">Thread</span>.<span class="i">CurrentThread</span>.<span class="i">Name</span> = <span class="s">&quot;ConsoleHost main thread&quot;</span>;
 
            <b>try</b>
            {
                <span class="c">// We might be able to ignore console host creation error if we are running in</span>
                <span class="c">// server mode, which does not require a console.</span>
                <a href="/System.Management.Automation/A.html#4b15a598e99c7dd9" class="t t">HostException</a> <span id="r10 rd" class="r10 r">hostException</span> = <b>null</b>;
                <b>try</b>
                {
                    <a href="#7eceed901a882a5f" class="i field">s_theConsoleHost</a> = <a href="../../P/cda5e43a29a66e53.html#cda5e43a29a66e53" class="t t">ConsoleHost</a>.<a href="#995101b88c1080b8" class="i method">CreateSingletonInstance</a>();
                }
                <b>catch</b> (<a href="/System.Management.Automation/A.html#4b15a598e99c7dd9" class="t t">HostException</a> <span id="r11 rd" class="r11 r">e</span>)
                {
                    <span class="r10 r">hostException</span> = <span class="r11 r">e</span>;
                }
 
                <a href="/System.Management.Automation/A.html#3fd0cd9d58631820" class="t t">PSHostUserInterface</a> <span id="r12 rd" class="r12 r">hostUI</span> = <a href="#7eceed901a882a5f" class="i field">s_theConsoleHost</a>?.<a href="#991bf1f27a36f054" class="i property">UI</a> ?? <b>new</b> <span class="t">NullHostUserInterface</span>();
                <a href="#43bd20a0a6b88977" class="i field">s_cpp</a>.<span class="i">ShowErrorHelpBanner</span>(<span class="r12 r">hostUI</span>, <span class="r4 r">bannerText</span>, <span class="r5 r">helpText</span>);
 
                <b>if</b> (<a href="#43bd20a0a6b88977" class="i field">s_cpp</a>.<a href="CommandLineParameterParser.cs.html#b5f7ac7d5f0e2df3" class="i property">ShowVersion</a>)
                {
                    <span class="c">// Alternatively, we could call s_theConsoleHost.UI.WriteLine(s_theConsoleHost.Version.ToString());</span>
                    <span class="c">// or start up the engine and retrieve the information via $psversiontable.GitCommitId</span>
                    <span class="c">// but this returns the semantic version and avoids executing a script</span>
                    <a href="#7eceed901a882a5f" class="i field">s_theConsoleHost</a>.<a href="#991bf1f27a36f054" class="i property">UI</a>.<span class="i">WriteLine</span>(<span class="s">&quot;PowerShell &quot;</span> + <a href="/System.Management.Automation/A.html#be287f9ea52b8d2f" class="t t">PSVersionInfo</a>.<span class="i">GitCommitId</span>);
                    <b>return</b> 0;
                }
 
                <span class="c">// Servermode parameter validation check.</span>
                <b>if</b> ((<a href="#43bd20a0a6b88977" class="i field">s_cpp</a>.<a href="CommandLineParameterParser.cs.html#0aeffc056bd92f1c" class="i property">ServerMode</a> &amp;&amp; <a href="#43bd20a0a6b88977" class="i field">s_cpp</a>.<a href="CommandLineParameterParser.cs.html#3b3ccc4a28acefa7" class="i property">NamedPipeServerMode</a>) || (<a href="#43bd20a0a6b88977" class="i field">s_cpp</a>.<a href="CommandLineParameterParser.cs.html#0aeffc056bd92f1c" class="i property">ServerMode</a> &amp;&amp; <a href="#43bd20a0a6b88977" class="i field">s_cpp</a>.<a href="CommandLineParameterParser.cs.html#7c2f959e1254d940" class="i property">SocketServerMode</a>) || (<a href="#43bd20a0a6b88977" class="i field">s_cpp</a>.<a href="CommandLineParameterParser.cs.html#3b3ccc4a28acefa7" class="i property">NamedPipeServerMode</a> &amp;&amp; <a href="#43bd20a0a6b88977" class="i field">s_cpp</a>.<a href="CommandLineParameterParser.cs.html#7c2f959e1254d940" class="i property">SocketServerMode</a>))
                {
                    <a href="#19a35abc23dbcc28" class="i field">s_tracer</a>.<span class="i">TraceError</span>(<span class="s">&quot;Conflicting server mode parameters, parameters must be used exclusively.&quot;</span>);
                    <b>if</b> (<a href="#7eceed901a882a5f" class="i field">s_theConsoleHost</a> != <b>null</b>)
                    {
                        <a href="#7eceed901a882a5f" class="i field">s_theConsoleHost</a>.<a href="#9579865b1d1857cb" class="i field">ui</a>.<span class="i">WriteErrorLine</span>(<span class="i">ConsoleHostStrings</span>.<span class="i">ConflictingServerModeParameters</span>);
                    }
 
                    <b>return</b> <a href="#83561e4ffc7a11d9" class="i field">ExitCodeBadCommandLineParameter</a>;
                }
 
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">UNIX</span>
                <a href="../../WindowsTaskbarJumpList/TaskbarJumpList.cs.html#6627107ae0784c47" class="t t">TaskbarJumpList</a>.<a href="../../WindowsTaskbarJumpList/TaskbarJumpList.cs.html#05518c1fe475d15d" class="i method">CreateRunAsAdministratorJumpList</a>();
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
 
                <span class="c">// First check for and handle PowerShell running in a server mode.</span>
                <b>if</b> (<a href="#43bd20a0a6b88977" class="i field">s_cpp</a>.<a href="CommandLineParameterParser.cs.html#0aeffc056bd92f1c" class="i property">ServerMode</a>)
                {
                    <a href="/System.Management.Automation/A.html#9832071d08aec551" class="t t">ApplicationInsightsTelemetry</a>.<span class="i">SendPSCoreStartupTelemetry</span>(<span class="s">&quot;ServerMode&quot;</span>);
                    <span class="i">ProfileOptimization</span>.<span class="i">StartProfile</span>(<span class="s">&quot;StartupProfileData-ServerMode&quot;</span>);
                    <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Remoting</span>.<span class="i n">Server</span>.<span class="i">StdIOProcessMediator</span>.<span class="i">Run</span>(
                        <span class="i">initialCommand</span>: <a href="#43bd20a0a6b88977" class="i field">s_cpp</a>.<a href="CommandLineParameterParser.cs.html#03e4079fd1301a6f" class="i property">InitialCommand</a>,
                        <span class="i">workingDirectory</span>: <a href="#43bd20a0a6b88977" class="i field">s_cpp</a>.<a href="CommandLineParameterParser.cs.html#71f2d9cf077930c3" class="i property">WorkingDirectory</a>,
                        <span class="i">configurationName</span>: <b>null</b>);
                    <span class="r9 r">exitCode</span> = 0;
                }
                <b>else</b> <b>if</b> (<a href="#43bd20a0a6b88977" class="i field">s_cpp</a>.<a href="CommandLineParameterParser.cs.html#5529f9b8681ccdfa" class="i property">SSHServerMode</a>)
                {
                    <a href="/System.Management.Automation/A.html#9832071d08aec551" class="t t">ApplicationInsightsTelemetry</a>.<span class="i">SendPSCoreStartupTelemetry</span>(<span class="s">&quot;SSHServer&quot;</span>);
                    <span class="i">ProfileOptimization</span>.<span class="i">StartProfile</span>(<span class="s">&quot;StartupProfileData-SSHServerMode&quot;</span>);
                    <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Remoting</span>.<span class="i n">Server</span>.<span class="i">StdIOProcessMediator</span>.<span class="i">Run</span>(
                        <span class="i">initialCommand</span>: <a href="#43bd20a0a6b88977" class="i field">s_cpp</a>.<a href="CommandLineParameterParser.cs.html#03e4079fd1301a6f" class="i property">InitialCommand</a>,
                        <span class="i">workingDirectory</span>: <b>null</b>,
                        <span class="i">configurationName</span>: <b>null</b>);
                    <span class="r9 r">exitCode</span> = 0;
                }
                <b>else</b> <b>if</b> (<a href="#43bd20a0a6b88977" class="i field">s_cpp</a>.<a href="CommandLineParameterParser.cs.html#3b3ccc4a28acefa7" class="i property">NamedPipeServerMode</a>)
                {
                    <a href="/System.Management.Automation/A.html#9832071d08aec551" class="t t">ApplicationInsightsTelemetry</a>.<span class="i">SendPSCoreStartupTelemetry</span>(<span class="s">&quot;NamedPipe&quot;</span>);
                    <span class="i">ProfileOptimization</span>.<span class="i">StartProfile</span>(<span class="s">&quot;StartupProfileData-NamedPipeServerMode&quot;</span>);
                    <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Remoting</span>.<a href="/System.Management.Automation/A.html#c14a08ba7cdb8bb2" class="t t">RemoteSessionNamedPipeServer</a>.<span class="i">RunServerMode</span>(
                        <span class="i">configurationName</span>: <a href="#43bd20a0a6b88977" class="i field">s_cpp</a>.<a href="CommandLineParameterParser.cs.html#c5f5a15ff218a892" class="i property">ConfigurationName</a>);
                    <span class="r9 r">exitCode</span> = 0;
                }
                <b>else</b> <b>if</b> (<a href="#43bd20a0a6b88977" class="i field">s_cpp</a>.<a href="CommandLineParameterParser.cs.html#7c2f959e1254d940" class="i property">SocketServerMode</a>)
                {
                    <a href="/System.Management.Automation/A.html#9832071d08aec551" class="t t">ApplicationInsightsTelemetry</a>.<span class="i">SendPSCoreStartupTelemetry</span>(<span class="s">&quot;SocketServerMode&quot;</span>);
                    <span class="i">ProfileOptimization</span>.<span class="i">StartProfile</span>(<span class="s">&quot;StartupProfileData-SocketServerMode&quot;</span>);
                    <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Remoting</span>.<span class="i n">Server</span>.<span class="i">HyperVSocketMediator</span>.<span class="i">Run</span>(
                        <span class="i">initialCommand</span>: <a href="#43bd20a0a6b88977" class="i field">s_cpp</a>.<a href="CommandLineParameterParser.cs.html#03e4079fd1301a6f" class="i property">InitialCommand</a>,
                        <span class="i">configurationName</span>: <a href="#43bd20a0a6b88977" class="i field">s_cpp</a>.<a href="CommandLineParameterParser.cs.html#c5f5a15ff218a892" class="i property">ConfigurationName</a>);
                    <span class="r9 r">exitCode</span> = 0;
                }
                <b>else</b>
                {
                    <span class="c">// Run PowerShell in normal console mode.</span>
                    <b>if</b> (<span class="r10 r">hostException</span> != <b>null</b>)
                    {
                        <span class="c">// Unable to create console host.</span>
                        <b>throw</b> <span class="r10 r">hostException</span>;
                    }
 
                    <b>if</b> (<a href="#f1bcf8bc2690f523" class="i method">LoadPSReadline</a>())
                    {
                        <span class="i">ProfileOptimization</span>.<span class="i">StartProfile</span>(<span class="s">&quot;StartupProfileData-Interactive&quot;</span>);
 
                        <b>if</b> (<a href="UpdatesNotification.cs.html#d4942265f85629c5" class="t t">UpdatesNotification</a>.<a href="UpdatesNotification.cs.html#86b3923279114d5f" class="i field">CanNotifyUpdates</a>)
                        {
                            <span class="c">// Start a task in the background to check for the update release.</span>
                            <b>_</b> = <a href="UpdatesNotification.cs.html#d4942265f85629c5" class="t t">UpdatesNotification</a>.<a href="UpdatesNotification.cs.html#fc398690c366c8c0" class="i method">CheckForUpdates</a>();
                        }
                    }
                    <b>else</b>
                    {
                        <span class="i">ProfileOptimization</span>.<span class="i">StartProfile</span>(<span class="s">&quot;StartupProfileData-NonInteractive&quot;</span>);
                    }
 
                    <a href="#7eceed901a882a5f" class="i field">s_theConsoleHost</a>.<a href="#2009b6c1e744d2d8" class="i method">BindBreakHandler</a>();
                    <a href="/System.Management.Automation/A.html#7b79cd90e035740e" class="t t">PSHost</a>.<span class="i">IsStdOutputRedirected</span> = <span class="i">Console</span>.<span class="i">IsOutputRedirected</span>;
 
                    <span class="c">// Send startup telemetry for ConsoleHost startup</span>
                    <a href="/System.Management.Automation/A.html#9832071d08aec551" class="t t">ApplicationInsightsTelemetry</a>.<span class="i">SendPSCoreStartupTelemetry</span>(<span class="s">&quot;Normal&quot;</span>);
 
                    <span class="r9 r">exitCode</span> = <a href="#7eceed901a882a5f" class="i field">s_theConsoleHost</a>.<a href="#1a318be2b2b59cb1" class="i method">Run</a>(<a href="#43bd20a0a6b88977" class="i field">s_cpp</a>, <b>false</b>);
                }
            }
            <b>finally</b>
            {
                <b>if</b> (<a href="#7eceed901a882a5f" class="i field">s_theConsoleHost</a> != <b>null</b>)
                {
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">LEGACYTELEMETRY</span>
<span class="e">                    TelemetryAPI.ReportExitTelemetry(s_theConsoleHost);
</span><span class="k preprocess">#</span><span class="k preprocess">endif</span>
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">UNIX</span>
<span class="e">                    if (s_theConsoleHost.IsInteractive &amp;&amp; s_theConsoleHost.UI.SupportsVirtualTerminal)
                    {
                        // https://github.com/dotnet/runtime/issues/27626 leaves terminal in application mode
                        // for now, we explicitly emit DECRST 1 sequence
                        s_theConsoleHost.UI.Write(DECCKM_OFF);
                    }
</span><span class="k preprocess">#</span><span class="k preprocess">endif</span>
                    <a href="#7eceed901a882a5f" class="i field">s_theConsoleHost</a>.<a href="#ce2c0b5954e7ee84" class="i method">Dispose</a>();
                }
            }
 
            <b>unchecked</b>
            {
                <b>return</b> (<b>int</b>)<span class="r9 r">exitCode</span>;
            }
        }
 
        <b>internal static void</b> <a id="e1482a2b76f65b2e" href="../../R/e1482a2b76f65b2e.html" target="n" data-glyph="74,1" class="i method">ParseCommandLine</a>(<b>string</b>[] <span id="r13 rd" class="r13 r">args</span>)
        {
            <a href="#43bd20a0a6b88977" class="i field">s_cpp</a>.<a href="CommandLineParameterParser.cs.html#8f51c69fd8a0c155" class="i method">Parse</a>(<span class="r13 r">args</span>);
 
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">UNIX</span>
            <b>if</b> (<a href="#43bd20a0a6b88977" class="i field">s_cpp</a>.<a href="CommandLineParameterParser.cs.html#8c7359b2a44d5c85" class="i property">WindowStyle</a>.<span class="i">HasValue</span>)
            {
                <a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<span class="i">SetConsoleMode</span>(<a href="#43bd20a0a6b88977" class="i field">s_cpp</a>.<a href="CommandLineParameterParser.cs.html#8c7359b2a44d5c85" class="i property">WindowStyle</a>.<span class="i">Value</span>);
            }
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
 
            <b>if</b> (<a href="#43bd20a0a6b88977" class="i field">s_cpp</a>.<a href="CommandLineParameterParser.cs.html#94bf485e11ac7326" class="i property">SettingsFile</a> <b>is not null</b>)
            {
                <span class="i">PowerShellConfig</span>.<span class="i">Instance</span>.<span class="i">SetSystemConfigFilePath</span>(<a href="#43bd20a0a6b88977" class="i field">s_cpp</a>.<a href="CommandLineParameterParser.cs.html#94bf485e11ac7326" class="i property">SettingsFile</a>);
            }
 
            <span class="c">// Check registry setting for a Group Policy ConfigurationName entry and</span>
            <span class="c">// use it to override anything set by the user.</span>
            <span class="c">// It depends on setting file so &#39;SetSystemConfigFilePath()&#39; should be called before.</span>
            <a href="#43bd20a0a6b88977" class="i field">s_cpp</a>.<a href="CommandLineParameterParser.cs.html#c5f5a15ff218a892" class="i property">ConfigurationName</a> = <a href="CommandLineParameterParser.cs.html#2b98c95fb32ff888" class="t t">CommandLineParameterParser</a>.<a href="CommandLineParameterParser.cs.html#63871e4e55fbaef1" class="i method">GetConfigurationNameFromGroupPolicy</a>();
        }
 
        <b>private static readonly</b> <a href="CommandLineParameterParser.cs.html#2b98c95fb32ff888" class="t t">CommandLineParameterParser</a> <a id="43bd20a0a6b88977" href="../../R/43bd20a0a6b88977.html" target="n" data-glyph="46,1" class="i field">s_cpp</a> = <b>new</b> <a href="CommandLineParameterParser.cs.html#a71bcfaa56180a48" class="t constructor">CommandLineParameterParser</a>();
 
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">UNIX</span>
<span class="e">        /// &lt;summary&gt;
        /// The break handler for the program.  Dispatches a break event to the current Executor.
        /// &lt;/summary&gt;
        private static void MyBreakHandler(object sender, ConsoleCancelEventArgs args)
        {
            // Set the Cancel property to true to prevent the process from terminating.
            args.Cancel = true;
            switch (args.SpecialKey)
            {
                case ConsoleSpecialKey.ControlC:
                    SpinUpBreakHandlerThread(shouldEndSession: false);
                    return;
                case ConsoleSpecialKey.ControlBreak:
                    if (s_cpp.NonInteractive)
                    {
                        // ControlBreak mimics ControlC in Noninteractive shells
                        SpinUpBreakHandlerThread(shouldEndSession: true);
                    }
                    else
                    {
                        // Break into script debugger.
                        BreakIntoDebugger();
                    }
 
                    return;
            }
        }
</span><span class="k preprocess">#</span><span class="k preprocess">else</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The break handler for the program.  Dispatches a break event to the current Executor.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r14 r">signal</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>private static bool</b> <a id="365af592ea6287a7" href="../../R/365af592ea6287a7.html" target="n" data-glyph="76,1" class="i method">MyBreakHandler</a>(<a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#7afb579825643d15" class="t t">ConsoleBreakSignal</a> <span id="r14 rd" class="r14 r">signal</span>)
        {
            <b>switch</b> (<span class="r14 r">signal</span>)
            {
                <b>case</b> <a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#7afb579825643d15" class="t t">ConsoleBreakSignal</a>.<a href="ConsoleControl.cs.html#dac5377417c719a9" class="i field">CtrlBreak</a>:
                    <b>if</b> (<a href="#43bd20a0a6b88977" class="i field">s_cpp</a>.<a href="CommandLineParameterParser.cs.html#20444cbb354c0a21" class="i property">NonInteractive</a>)
                    {
                        <span class="c">// ControlBreak mimics ControlC in Noninteractive shells</span>
                        <a href="#145027ef57b9db6b" class="i method">SpinUpBreakHandlerThread</a>(<span class="r15 r">shouldEndSession</span>: <b>true</b>);
                    }
                    <b>else</b>
                    {
                        <span class="c">// Break into script debugger.</span>
                        <a href="#7fe9192c8501b5a3" class="i method">BreakIntoDebugger</a>();
                    }
 
                    <b>return</b> <b>true</b>;
 
                <span class="c">// Run the break handler...</span>
                <b>case</b> <a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#7afb579825643d15" class="t t">ConsoleBreakSignal</a>.<a href="ConsoleControl.cs.html#a31c8c0984b618f5" class="i field">CtrlC</a>:
                    <a href="#145027ef57b9db6b" class="i method">SpinUpBreakHandlerThread</a>(<span class="r15 r">shouldEndSession</span>: <b>false</b>);
                    <b>return</b> <b>true</b>;
 
                <b>case</b> <a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#7afb579825643d15" class="t t">ConsoleBreakSignal</a>.<a href="ConsoleControl.cs.html#7cac9bb10563241c" class="i field">Logoff</a>:
                    <span class="c">// Just ignore the logoff signal. This signal is sent to console</span>
                    <span class="c">// apps running as service anytime *any* user logs off which means</span>
                    <span class="c">// that PowerShell couldn&#39;t be used in services/tasks if we didn&#39;t</span>
                    <span class="c">// suppress this signal...</span>
                    <b>return</b> <b>true</b>;
 
                <b>case</b> <a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#7afb579825643d15" class="t t">ConsoleBreakSignal</a>.<a href="ConsoleControl.cs.html#124ac64f4a8763c2" class="i field">Close</a>:
                <b>case</b> <a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#7afb579825643d15" class="t t">ConsoleBreakSignal</a>.<a href="ConsoleControl.cs.html#6ceaa93d1c6410be" class="i field">Shutdown</a>:
                    <a href="#145027ef57b9db6b" class="i method">SpinUpBreakHandlerThread</a>(<span class="r15 r">shouldEndSession</span>: <b>true</b>);
                    <b>return</b> <b>false</b>;
 
                <b>default</b>:
                    <span class="c">// Log as much sqm data as possible before we exit.</span>
                    <a href="#145027ef57b9db6b" class="i method">SpinUpBreakHandlerThread</a>(<span class="r15 r">shouldEndSession</span>: <b>true</b>);
                    <b>return</b> <b>false</b>;
            }
        }
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
 
        <b>private static bool</b> <a id="7fe9192c8501b5a3" href="../../R/7fe9192c8501b5a3.html" target="n" data-glyph="76,1" class="i method">BreakIntoDebugger</a>()
        {
            <a href="../../P/cda5e43a29a66e53.html#cda5e43a29a66e53" class="t t">ConsoleHost</a> <span id="r16 rd" class="r16 r">host</span> = <a href="../../P/cda5e43a29a66e53.html#cda5e43a29a66e53" class="t t">ConsoleHost</a>.<a href="#79b4e4eb73132bf9" class="i property">SingletonInstance</a>;
            <a href="/System.Management.Automation/A.html#9e8f0b396592e65c" class="t t">Debugger</a> <span id="r17 rd" class="r17 r">debugger</span> = <b>null</b>;
            <b>lock</b> (<span class="r16 r">host</span>.<a href="#55f653f715aa2431" class="i field">hostGlobalLock</a>)
            {
                <b>if</b> (<span class="r16 r">host</span>.<a href="#8e1330b3ad99e179" class="i field">_runspaceRef</a>.<span class="i">Runspace</span> != <b>null</b> &amp;&amp;
                    <span class="r16 r">host</span>.<a href="#8e1330b3ad99e179" class="i field">_runspaceRef</a>.<span class="i">Runspace</span>.<span class="i">GetCurrentlyRunningPipeline</span>() != <b>null</b>)
                {
                    <span class="r17 r">debugger</span> = <span class="r16 r">host</span>.<a href="#8e1330b3ad99e179" class="i field">_runspaceRef</a>.<span class="i">Runspace</span>.<span class="i">Debugger</span>;
                }
            }
 
            <b>if</b> (<span class="r17 r">debugger</span> != <b>null</b>)
            {
                <span class="r17 r">debugger</span>.<span class="i">SetDebuggerStepMode</span>(<b>true</b>);
                <b>return</b> <b>true</b>;
            }
 
            <b>return</b> <b>false</b>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Spin up a new thread to cancel the current pipeline.  This will allow subsequent break interrupts to be received even</span>
        <span class="c">///</span><span class="c"> if the cancellation is blocked (which can be the case when the pipeline blocks and nothing implements Cmdlet.Stop</span>
        <span class="c">///</span><span class="c"> properly).  That is because the OS will not inject another thread when a break event occurs if one has already been</span>
        <span class="c">///</span><span class="c"> injected and is running.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r15 r">shouldEndSession</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> if true, then flag the parent ConsoleHost that it should shutdown the session.  If false, then only the current</span>
        <span class="c">///</span><span class="c"> executing instance is stopped.</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>private static void</b> <a id="145027ef57b9db6b" href="../../R/145027ef57b9db6b.html" target="n" data-glyph="76,1" class="i method">SpinUpBreakHandlerThread</a>(<b>bool</b> <span id="r15 rd" class="r15 r">shouldEndSession</span>)
        {
            <a href="../../P/cda5e43a29a66e53.html#cda5e43a29a66e53" class="t t">ConsoleHost</a> <span id="r18 rd" class="r18 r">host</span> = <a href="../../P/cda5e43a29a66e53.html#cda5e43a29a66e53" class="t t">ConsoleHost</a>.<a href="#79b4e4eb73132bf9" class="i property">SingletonInstance</a>;
 
            <span class="i">Thread</span> <span id="r19 rd" class="r19 r">bht</span> = <b>null</b>;
 
            <b>lock</b> (<span class="r18 r">host</span>.<a href="#55f653f715aa2431" class="i field">hostGlobalLock</a>)
            {
                <span class="r19 r">bht</span> = <span class="r18 r">host</span>.<a href="#ded7d03167f947b9" class="i field">_breakHandlerThread</a>;
                <b>if</b> (!<span class="r18 r">host</span>.<a href="#ab61e63581cd3e32" class="i property">ShouldEndSession</a> &amp;&amp; <span class="r15 r">shouldEndSession</span>)
                {
                    <span class="r18 r">host</span>.<a href="#ab61e63581cd3e32" class="i property">ShouldEndSession</a> = <span class="r15 r">shouldEndSession</span>;
                }
 
                <span class="c">// Creation of the tread and starting it should be an atomic operation.</span>
                <span class="c">// otherwise the code in Run method can get instance of the breakhandlerThread</span>
                <span class="c">// after it is created and before started and call join on it. This will result</span>
                <span class="c">// in ThreadStateException.</span>
                <span class="c">// NTRAID#Windows OutofBand Bugs-938289-2006/07/27-hiteshr</span>
                <b>if</b> (<span class="r19 r">bht</span> == <b>null</b>)
                {
                    <span class="c">// we&#39;re not already running HandleBreak on a separate thread, so run it now.</span>
 
                    <span class="r18 r">host</span>.<a href="#ded7d03167f947b9" class="i field">_breakHandlerThread</a> = <b>new</b> <span class="i">Thread</span>(<b>new</b> <span class="i">ThreadStart</span>(<a href="../../P/cda5e43a29a66e53.html#cda5e43a29a66e53" class="t t">ConsoleHost</a>.<span class="i">HandleBreak</span>));
                    <span class="r18 r">host</span>.<a href="#ded7d03167f947b9" class="i field">_breakHandlerThread</a>.<span class="i">Name</span> = <span class="s">&quot;ConsoleHost.HandleBreak&quot;</span>;
                    <span class="r18 r">host</span>.<a href="#ded7d03167f947b9" class="i field">_breakHandlerThread</a>.<span class="i">Start</span>();
                }
            }
        }
 
        <b>private static void</b> <a id="41d39e0833a4ded8" href="../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">HandleBreak</a>()
        {
            <a href="../../P/cda5e43a29a66e53.html#cda5e43a29a66e53" class="t t">ConsoleHost</a> <span id="r20 rd" class="r20 r">consoleHost</span> = <a href="#7eceed901a882a5f" class="i field">s_theConsoleHost</a>;
            <b>if</b> (<span class="r20 r">consoleHost</span> != <b>null</b>)
            {
                <b>if</b> (<span class="r20 r">consoleHost</span>.<a href="#5c77214aa34523a4" class="i property">InDebugMode</a>)
                {
                    <span class="c">// Only stop a running user command, ignore prompt evaluation.</span>
                    <b>if</b> (<span class="r20 r">consoleHost</span>.<a href="#069a6e14ef665629" class="i property">DebuggerCanStopCommand</a>)
                    {
                        <span class="c">// Cancel any executing debugger command if in debug mode.</span>
                        <b>try</b>
                        {
                            <span class="r20 r">consoleHost</span>.<a href="#392ae36c563f0bce" class="i property">Runspace</a>.<a href="/System.Management.Automation/A.html#d6610640d00b19f5" class="i property">Debugger</a>.<span class="i">StopProcessCommand</span>();
                        }
                        <b>catch</b> (<span class="i">Exception</span>)
                        {
                        }
                    }
                }
                <b>else</b>
                {
                    <span class="c">// Cancel the reconnected debugged running pipeline command.</span>
                    <b>if</b> (!<a href="#3e62dae1b880e47b" class="i method">StopPipeline</a>(<span class="r20 r">consoleHost</span>.<a href="#76c448234ea04c11" class="i field">runningCmd</a>))
                    {
                        <a href="Executor.cs.html#c4a69b641f3e390e" class="t t">Executor</a>.<a href="Executor.cs.html#6c1cc1690a616634" class="i method">CancelCurrentExecutor</a>();
                    }
                }
 
                <b>if</b> (<span class="r20 r">consoleHost</span>.<a href="#ab61e63581cd3e32" class="i property">ShouldEndSession</a>)
                {
                    <b>var</b> <span id="r21 rd" class="r21 r">runspaceRef</span> = <a href="../../P/cda5e43a29a66e53.html#cda5e43a29a66e53" class="t t">ConsoleHost</a>.<a href="#79b4e4eb73132bf9" class="i property">SingletonInstance</a>.<a href="#8e1330b3ad99e179" class="i field">_runspaceRef</a>;
                    <b>if</b> (<span class="r21 r">runspaceRef</span> != <b>null</b>)
                    {
                        <a href="/System.Management.Automation/A.html#7e5b8eab1aa16fd7" class="k">var</a> <span id="r22 rd" class="r22 r">runspace</span> = <span class="r21 r">runspaceRef</span>.<span class="i">Runspace</span>;
                        <b>if</b> (<span class="r22 r">runspace</span> != <b>null</b>)
                        {
                            <span class="r22 r">runspace</span>.<span class="i">Close</span>();
                        }
                    }
                }
            }
 
            <span class="c">// call the console APIs directly, instead of ui.rawui.FlushInputHandle, as ui may be finalized</span>
            <span class="c">// already if this thread is lagging behind the main thread.</span>
 
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">UNIX</span>
            <span class="i">ConsoleHandle</span> <span id="r23 rd" class="r23 r">handle</span> = <a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#082a79a70f5af6dc" class="i method">GetConioDeviceHandle</a>();
            <a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#b6792028911d4516" class="i method">FlushConsoleInputBuffer</a>(<span class="r23 r">handle</span>);
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
 
            <a href="../../P/cda5e43a29a66e53.html#cda5e43a29a66e53" class="t t">ConsoleHost</a>.<a href="#79b4e4eb73132bf9" class="i property">SingletonInstance</a>.<a href="#ded7d03167f947b9" class="i field">_breakHandlerThread</a> = <b>null</b>;
        }
 
        <b>private static bool</b> <a id="3e62dae1b880e47b" href="../../R/3e62dae1b880e47b.html" target="n" data-glyph="76,1" class="i method">StopPipeline</a>(<a href="/System.Management.Automation/A.html#c607964c20793ea5" class="t t">Pipeline</a> <span id="r24 rd" class="r24 r">cmd</span>)
        {
            <b>if</b> (<span class="r24 r">cmd</span> != <b>null</b> &amp;&amp;
                (<span class="r24 r">cmd</span>.<a href="/System.Management.Automation/A.html#443fd1d03c8335df" class="i property">PipelineStateInfo</a>.<a href="/System.Management.Automation/A.html#2589f8c7203969a0" class="i property">State</a> == <a href="/System.Management.Automation/A.html#03704abc5975cfc4" class="t t">PipelineState</a>.<a href="/System.Management.Automation/A.html#d0f3cf00cd5762f1" class="i field">Running</a> ||
                 <span class="r24 r">cmd</span>.<a href="/System.Management.Automation/A.html#443fd1d03c8335df" class="i property">PipelineStateInfo</a>.<a href="/System.Management.Automation/A.html#2589f8c7203969a0" class="i property">State</a> == <a href="/System.Management.Automation/A.html#03704abc5975cfc4" class="t t">PipelineState</a>.<a href="/System.Management.Automation/A.html#401ea10f45569c67" class="i field">Disconnected</a>))
            {
                <b>try</b>
                {
                    <span class="r24 r">cmd</span>.<span class="i">StopAsync</span>();
                    <b>return</b> <b>true</b>;
                }
                <b>catch</b> (<span class="i">Exception</span>)
                {
                }
            }
 
            <b>return</b> <b>false</b>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Create single instance of ConsoleHost.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal static</b> <a href="../../P/cda5e43a29a66e53.html#cda5e43a29a66e53" class="t t">ConsoleHost</a> <a id="995101b88c1080b8" href="../../R/995101b88c1080b8.html" target="n" data-glyph="74,1" class="i method">CreateSingletonInstance</a>()
        {
            <a href="/System.Management.Automation/A.html#c04955255430d32f" class="t t">Dbg</a>.<span class="i">Assert</span>(<a href="#7eceed901a882a5f" class="i field">s_theConsoleHost</a> == <b>null</b>, <span class="s">&quot;CreateSingletonInstance should not be called multiple times&quot;</span>);
            <a href="#7eceed901a882a5f" class="i field">s_theConsoleHost</a> = <b>new</b> <a href="#510c680958eec2cf" class="t constructor">ConsoleHost</a>();
            <b>return</b> <a href="#7eceed901a882a5f" class="i field">s_theConsoleHost</a>;
        }
 
        <b>internal static</b> <a href="../../P/cda5e43a29a66e53.html#cda5e43a29a66e53" class="t t">ConsoleHost</a> <a id="79b4e4eb73132bf9" href="../../R/79b4e4eb73132bf9.html" target="n" data-glyph="104,1" class="i property">SingletonInstance</a>
        {
            <b>get</b>
            {
                <a href="/System.Management.Automation/A.html#c04955255430d32f" class="t t">Dbg</a>.<span class="i">Assert</span>(<a href="#7eceed901a882a5f" class="i field">s_theConsoleHost</a> != <b>null</b>, <span class="s">&quot;CreateSingletonInstance should be called before calling this method&quot;</span>);
                <b>return</b> <a href="#7eceed901a882a5f" class="i field">s_theConsoleHost</a>;
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> static methods
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> overrides
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> See base class.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">value</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">value</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span><span class="c">/&gt;</span>
        <b>public override string</b> <a id="6a41744ea2468b83" href="../../R/6a41744ea2468b83.html" target="n" data-glyph="102,1" class="i property">Name</a>
        {
            <b>get</b>
            {
                <b>const string</b> <span id="r25 rd" class="r25 r">myName</span> = <span class="s">&quot;ConsoleHost&quot;</span>;
 
                <span class="c">// const, no lock needed.</span>
                <b>return</b> <span class="r25 r">myName</span>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> See base class.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">value</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">value</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span><span class="c">/&gt;</span>
        <b>public override</b> <span class="i n">System</span>.<span class="i">Version</span> <a id="9bc654047cc05bb2" href="../../R/9bc654047cc05bb2.html" target="n" data-glyph="102,1" class="i property">Version</a>
        {
            <b>get</b>
            {
                <span class="c">// const, no lock needed.</span>
                <b>return</b> <a href="#f7cbac4d85d72437" class="i field">_ver</a>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> See base class.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">value</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">value</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span><span class="c">/&gt;</span>
        <b>public override</b> <span class="i n">System</span>.<span class="i">Guid</span> <a id="4e497443d6bfa534" href="../../R/4e497443d6bfa534.html" target="n" data-glyph="102,1" class="i property">InstanceId</a> { <b>get</b>; } = <span class="i">Guid</span>.<span class="i">NewGuid</span>();
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> See base class.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">value</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">value</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span><span class="c">/&gt;</span>
        <b>public override</b> <a href="/System.Management.Automation/A.html#3fd0cd9d58631820" class="t t">PSHostUserInterface</a> <a id="991bf1f27a36f054" href="../../R/991bf1f27a36f054.html" target="n" data-glyph="102,1" class="i property">UI</a>
        {
            <b>get</b>
            {
                <a href="/System.Management.Automation/A.html#c04955255430d32f" class="t t">Dbg</a>.<span class="i">Assert</span>(<a href="#9579865b1d1857cb" class="i field">ui</a> != <b>null</b>, <span class="s">&quot;ui should have been allocated in ctor&quot;</span>);
                <b>return</b> <a href="#9579865b1d1857cb" class="i field">ui</a>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> See base class.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public void</b> <a id="41ec1f497ca3d281" href="../../R/41ec1f497ca3d281.html" target="n" data-glyph="72,1" class="i method">PushRunspace</a>(<a href="/System.Management.Automation/A.html#7e5b8eab1aa16fd7" class="t t">Runspace</a> <span id="r26 rd" class="r26 r">newRunspace</span>)
        {
            <b>if</b> (<a href="#8e1330b3ad99e179" class="i field">_runspaceRef</a> == <b>null</b>) { <b>return</b>; }
 
            <span class="i">RemoteRunspace</span> <span id="r27 rd" class="r27 r">remoteRunspace</span> = <span class="r26 r">newRunspace</span> <b>as</b> <span class="i">RemoteRunspace</span>;
            <a href="/System.Management.Automation/A.html#c04955255430d32f" class="t t">Dbg</a>.<span class="i">Assert</span>(<span class="r27 r">remoteRunspace</span> != <b>null</b>, <span class="s">&quot;Expected remoteRunspace != null&quot;</span>);
            <span class="r27 r">remoteRunspace</span>.<a href="/System.Management.Automation/A.html#6866e88f64eb13d6" class="i">StateChanged</a> += <span class="i">HandleRemoteRunspaceStateChanged</span>;
 
            <span class="c">// Unsubscribe the local session debugger.</span>
            <b>if</b> (<a href="#8e1330b3ad99e179" class="i field">_runspaceRef</a>.<span class="i">Runspace</span>.<span class="i">Debugger</span> != <b>null</b>)
            {
                <a href="#8e1330b3ad99e179" class="i field">_runspaceRef</a>.<span class="i">Runspace</span>.<span class="i">Debugger</span>.<span class="i">DebuggerStop</span> -= <span class="i">OnExecutionSuspended</span>;
            }
 
            <span class="c">// Subscribe to debugger stop event.</span>
            <b>if</b> (<span class="r27 r">remoteRunspace</span>.<a href="/System.Management.Automation/A.html#d6610640d00b19f5" class="i property">Debugger</a> != <b>null</b>)
            {
                <span class="r27 r">remoteRunspace</span>.<a href="/System.Management.Automation/A.html#d6610640d00b19f5" class="i property">Debugger</a>.<a href="/System.Management.Automation/A.html#4cf8436684b1ce9c" class="i">DebuggerStop</a> += <span class="i">OnExecutionSuspended</span>;
            }
 
            <span class="c">// Connect a disconnected command.</span>
            <a href="../../P/cda5e43a29a66e53.html#cda5e43a29a66e53" class="k">this</a>.<a href="#76c448234ea04c11" class="i field">runningCmd</a> = <a href="/System.Management.Automation/A.html#6473c5d5c4356c4e" class="t t">EnterPSSessionCommand</a>.<span class="i">ConnectRunningPipeline</span>(<span class="r27 r">remoteRunspace</span>);
 
            <span class="c">// Push runspace.</span>
            <a href="#8e1330b3ad99e179" class="i field">_runspaceRef</a>.<span class="i">Override</span>(<span class="r27 r">remoteRunspace</span>, <a href="#55f653f715aa2431" class="i field">hostGlobalLock</a>, <b>out</b> <a href="#0182e21021323992" class="i field">_isRunspacePushed</a>);
            <a href="#c6ede5e854e60d72" class="i">RunspacePushed</a>.<span class="i">SafeInvoke</span>(<a href="../../P/cda5e43a29a66e53.html#cda5e43a29a66e53" class="k">this</a>, <span class="i">EventArgs</span>.<span class="i">Empty</span>);
 
            <b>if</b> (<a href="../../P/cda5e43a29a66e53.html#cda5e43a29a66e53" class="k">this</a>.<a href="#76c448234ea04c11" class="i field">runningCmd</a> != <b>null</b>)
            {
                <a href="/System.Management.Automation/A.html#6473c5d5c4356c4e" class="t t">EnterPSSessionCommand</a>.<span class="i">ContinueCommand</span>(
                    <span class="r27 r">remoteRunspace</span>,
                    <a href="../../P/cda5e43a29a66e53.html#cda5e43a29a66e53" class="k">this</a>.<a href="#76c448234ea04c11" class="i field">runningCmd</a>,
                    <a href="../../P/cda5e43a29a66e53.html#cda5e43a29a66e53" class="k">this</a>,
                    <a href="#5c77214aa34523a4" class="i property">InDebugMode</a>,
                    <a href="#8e1330b3ad99e179" class="i field">_runspaceRef</a>.<span class="i">OldRunspace</span>.<span class="i">ExecutionContext</span>);
            }
 
            <a href="../../P/cda5e43a29a66e53.html#cda5e43a29a66e53" class="k">this</a>.<a href="#76c448234ea04c11" class="i field">runningCmd</a> = <b>null</b>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Handles state changed event of the remote runspace. If the remote runspace</span>
        <span class="c">///</span><span class="c"> gets into a broken or closed state, writes a message and pops out the</span>
        <span class="c">///</span><span class="c"> runspace.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r28 r">sender</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Not sure.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r29 r">eventArgs</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Arguments describing this event.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>private void</b> <a id="27a63fd8323100bc" href="../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">HandleRemoteRunspaceStateChanged</a>(<b>object</b> <span id="r28 rd" class="r28 r">sender</span>, <a href="/System.Management.Automation/A.html#24ce8f9c69bf1c4a" class="t t">RunspaceStateEventArgs</a> <span id="r29 rd" class="r29 r">eventArgs</span>)
        {
            <a href="/System.Management.Automation/A.html#5da9dc65e996a685" class="t t">RunspaceState</a> <span id="r30 rd" class="r30 r">state</span> = <span class="r29 r">eventArgs</span>.<a href="/System.Management.Automation/A.html#efb5571439376cca" class="i property">RunspaceStateInfo</a>.<a href="/System.Management.Automation/A.html#41627f067662d11c" class="i property">State</a>;
 
            <b>switch</b> (<span class="r30 r">state</span>)
            {
                <b>case</b> <a href="/System.Management.Automation/A.html#5da9dc65e996a685" class="t t">RunspaceState</a>.<a href="/System.Management.Automation/A.html#3990ad8b3e3feec7" class="i field">Opening</a>:
                <b>case</b> <a href="/System.Management.Automation/A.html#5da9dc65e996a685" class="t t">RunspaceState</a>.<a href="/System.Management.Automation/A.html#9a99efb0eaa3c3db" class="i field">Opened</a>:
                    {
                        <b>return</b>;
                    }
                <b>case</b> <a href="/System.Management.Automation/A.html#5da9dc65e996a685" class="t t">RunspaceState</a>.<a href="/System.Management.Automation/A.html#fb276cb28f922b8e" class="i field">Closing</a>:
                <b>case</b> <a href="/System.Management.Automation/A.html#5da9dc65e996a685" class="t t">RunspaceState</a>.<a href="/System.Management.Automation/A.html#45de84b67ba18f3f" class="i field">Closed</a>:
                <b>case</b> <a href="/System.Management.Automation/A.html#5da9dc65e996a685" class="t t">RunspaceState</a>.<a href="/System.Management.Automation/A.html#e4c76740d99e58bd" class="i field">Broken</a>:
                <b>case</b> <a href="/System.Management.Automation/A.html#5da9dc65e996a685" class="t t">RunspaceState</a>.<a href="/System.Management.Automation/A.html#0a8fc62a22d129a1" class="i field">Disconnected</a>:
                    {
                        <a href="#61d2e5015e80c497" class="i method">PopRunspace</a>();
                    }
 
                    <b>break</b>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> See base class.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public void</b> <a id="61d2e5015e80c497" href="../../R/61d2e5015e80c497.html" target="n" data-glyph="72,1" class="i method">PopRunspace</a>()
        {
            <b>if</b> (<a href="#8e1330b3ad99e179" class="i field">_runspaceRef</a> == <b>null</b> ||
                !<a href="#8e1330b3ad99e179" class="i field">_runspaceRef</a>.<span class="i">IsRunspaceOverridden</span>)
            {
                <b>return</b>;
            }
 
            <b>if</b> (<a href="#4df2325754acd4f9" class="i field">_inPushedConfiguredSession</a>)
            {
                <span class="c">// For configured endpoint sessions, end session when configured runspace is popped.</span>
                <a href="../../P/cda5e43a29a66e53.html#cda5e43a29a66e53" class="k">this</a>.<a href="#ab61e63581cd3e32" class="i property">ShouldEndSession</a> = <b>true</b>;
            }
 
            <b>if</b> (<a href="#8e1330b3ad99e179" class="i field">_runspaceRef</a>.<span class="i">Runspace</span>.<span class="i">Debugger</span> != <b>null</b>)
            {
                <span class="c">// Unsubscribe pushed runspace debugger.</span>
                <a href="#8e1330b3ad99e179" class="i field">_runspaceRef</a>.<span class="i">Runspace</span>.<span class="i">Debugger</span>.<span class="i">DebuggerStop</span> -= <span class="i">OnExecutionSuspended</span>;
 
                <a href="#3e62dae1b880e47b" class="i method">StopPipeline</a>(<a href="../../P/cda5e43a29a66e53.html#cda5e43a29a66e53" class="k">this</a>.<a href="#76c448234ea04c11" class="i field">runningCmd</a>);
 
                <b>if</b> (<a href="../../P/cda5e43a29a66e53.html#cda5e43a29a66e53" class="k">this</a>.<a href="#5c77214aa34523a4" class="i property">InDebugMode</a>)
                {
                    <a href="#133b48542f47f0e3" class="i method">ExitDebugMode</a>(<a href="/System.Management.Automation/A.html#470618169485a70e" class="t t">DebuggerResumeAction</a>.<a href="/System.Management.Automation/A.html#c35cb32c2ab7ed0d" class="i field">Continue</a>);
                }
            }
 
            <a href="../../P/cda5e43a29a66e53.html#cda5e43a29a66e53" class="k">this</a>.<a href="#76c448234ea04c11" class="i field">runningCmd</a> = <b>null</b>;
 
            <b>lock</b> (<a href="#55f653f715aa2431" class="i field">hostGlobalLock</a>)
            {
                <a href="#8e1330b3ad99e179" class="i field">_runspaceRef</a>.<span class="i">Revert</span>();
                <a href="#0182e21021323992" class="i field">_isRunspacePushed</a> = <b>false</b>;
            }
 
            <span class="c">// Re-subscribe local runspace debugger.</span>
            <a href="#8e1330b3ad99e179" class="i field">_runspaceRef</a>.<span class="i">Runspace</span>.<span class="i">Debugger</span>.<span class="i">DebuggerStop</span> += <span class="i">OnExecutionSuspended</span>;
 
            <span class="c">// raise events outside the lock</span>
            <a href="#0b1f987d76921772" class="i">RunspacePopped</a>.<span class="i">SafeInvoke</span>(<a href="../../P/cda5e43a29a66e53.html#cda5e43a29a66e53" class="k">this</a>, <span class="i">EventArgs</span>.<span class="i">Empty</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> True if a runspace is pushed; false otherwise.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public bool</b> <a id="a43561eac56deab3" href="../../R/a43561eac56deab3.html" target="n" data-glyph="102,1" class="i property">IsRunspacePushed</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#0182e21021323992" class="i field">_isRunspacePushed</a>;
            }
        }
 
        <b>private bool</b> <a id="0182e21021323992" href="../../R/0182e21021323992.html" target="n" data-glyph="46,1" class="i field">_isRunspacePushed</a> = <b>false</b>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Returns the current runspace associated with this host.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public</b> <a href="/System.Management.Automation/A.html#7e5b8eab1aa16fd7" class="t t">Runspace</a> <a id="392ae36c563f0bce" href="../../R/392ae36c563f0bce.html" target="n" data-glyph="102,1" class="i property">Runspace</a>
        {
            <b>get</b>
            {
                <b>if</b> (<a href="../../P/cda5e43a29a66e53.html#cda5e43a29a66e53" class="k">this</a>.<a href="#3b80b4197e85d182" class="i property">RunspaceRef</a> == <b>null</b>) { <b>return</b> <b>null</b>; }
 
                <b>return</b> <a href="../../P/cda5e43a29a66e53.html#cda5e43a29a66e53" class="k">this</a>.<a href="#3b80b4197e85d182" class="i property">RunspaceRef</a>.<span class="i">Runspace</span>;
            }
        }
 
        <b>internal</b> <span class="i">LocalRunspace</span> <a id="49ea483a58dc357d" href="../../R/49ea483a58dc357d.html" target="n" data-glyph="104,1" class="i property">LocalRunspace</a>
        {
            <b>get</b>
            {
                <b>if</b> (<a href="#0182e21021323992" class="i field">_isRunspacePushed</a>)
                {
                    <b>return</b> <a href="#3b80b4197e85d182" class="i property">RunspaceRef</a>.<span class="i">OldRunspace</span> <b>as</b> <span class="i">LocalRunspace</span>;
                }
 
                <b>if</b> (<a href="#3b80b4197e85d182" class="i property">RunspaceRef</a> == <b>null</b>) { <b>return</b> <b>null</b>; }
 
                <b>return</b> <a href="#3b80b4197e85d182" class="i property">RunspaceRef</a>.<span class="i">Runspace</span> <b>as</b> <span class="i">LocalRunspace</span>;
            }
        }
 
        <b>public class</b> <a id="376edd0e3db62e94" href="../../R/376edd0e3db62e94.html" target="n" data-glyph="0,1" class="t t">ConsoleColorProxy</a>
        {
            <b>private readonly</b> <a href="../../P/b737197b2d219638.html#b737197b2d219638" class="t t">ConsoleHostUserInterface</a> <a id="15b9508b6d5ca0e3" href="../../R/15b9508b6d5ca0e3.html" target="n" data-glyph="46,2" class="i field">_ui</a>;
 
            <b>public</b> <a id="7ae941e2202c8c24" href="../../R/7ae941e2202c8c24.html" target="n" data-glyph="72,2" class="t constructor">ConsoleColorProxy</a>(<a href="../../P/b737197b2d219638.html#b737197b2d219638" class="t t">ConsoleHostUserInterface</a> <span id="r31 rd" class="r31 r">ui</span>)
            {
                <b>if</b> (<span class="r31 r">ui</span> == <b>null</b>) <b>throw</b> <b>new</b> <span class="i">ArgumentNullException</span>(<b>nameof</b>(<span class="r31 r">ui</span>));
                <a href="#15b9508b6d5ca0e3" class="i field">_ui</a> = <span class="r31 r">ui</span>;
            }
 
            <b>public</b> <span class="i">ConsoleColor</span> <a id="9076600aa4488037" href="../../R/../../0000000000.html" target="n" data-glyph="102,2" class="i property">FormatAccentColor</a>
            {
                [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Performance&quot;</span>, <span class="s">&quot;CA1811:AvoidUncalledPrivateCode&quot;</span>)]
                <b>get</b>
                {
                    <b>return</b> <a href="#15b9508b6d5ca0e3" class="i field">_ui</a>.<a href="ConsoleHostUserInterface.cs.html#ea034a5214b0991b" class="i property">FormatAccentColor</a>;
                }
 
                [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Performance&quot;</span>, <span class="s">&quot;CA1811:AvoidUncalledPrivateCode&quot;</span>)]
                <b>set</b>
                {
                    <a href="#15b9508b6d5ca0e3" class="i field">_ui</a>.<a href="ConsoleHostUserInterface.cs.html#ea034a5214b0991b" class="i property">FormatAccentColor</a> = <b>value</b>;
                }
            }
 
            <b>public</b> <span class="i">ConsoleColor</span> <a id="7001eb9de030e9e6" href="../../R/../../0000000000.html" target="n" data-glyph="102,2" class="i property">ErrorAccentColor</a>
            {
                [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Performance&quot;</span>, <span class="s">&quot;CA1811:AvoidUncalledPrivateCode&quot;</span>)]
                <b>get</b>
                {
                    <b>return</b> <a href="#15b9508b6d5ca0e3" class="i field">_ui</a>.<a href="ConsoleHostUserInterface.cs.html#51c7fc743b775c87" class="i property">ErrorAccentColor</a>;
                }
 
                [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Performance&quot;</span>, <span class="s">&quot;CA1811:AvoidUncalledPrivateCode&quot;</span>)]
                <b>set</b>
                {
                    <a href="#15b9508b6d5ca0e3" class="i field">_ui</a>.<a href="ConsoleHostUserInterface.cs.html#51c7fc743b775c87" class="i property">ErrorAccentColor</a> = <b>value</b>;
                }
            }
 
            <b>public</b> <span class="i">ConsoleColor</span> <a id="617da2d3db52e265" href="../../R/../../0000000000.html" target="n" data-glyph="102,2" class="i property">ErrorForegroundColor</a>
            {
                [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Performance&quot;</span>, <span class="s">&quot;CA1811:AvoidUncalledPrivateCode&quot;</span>)]
                <b>get</b>
                {
                    <b>return</b> <a href="#15b9508b6d5ca0e3" class="i field">_ui</a>.<a href="ConsoleHostUserInterface.cs.html#46aac1f5890000d4" class="i property">ErrorForegroundColor</a>;
                }
 
                [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Performance&quot;</span>, <span class="s">&quot;CA1811:AvoidUncalledPrivateCode&quot;</span>)]
                <b>set</b>
                {
                    <a href="#15b9508b6d5ca0e3" class="i field">_ui</a>.<a href="ConsoleHostUserInterface.cs.html#46aac1f5890000d4" class="i property">ErrorForegroundColor</a> = <b>value</b>;
                }
            }
 
            <b>public</b> <span class="i">ConsoleColor</span> <a id="59e75edb64b52c41" href="../../R/../../0000000000.html" target="n" data-glyph="102,2" class="i property">ErrorBackgroundColor</a>
            {
                [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Performance&quot;</span>, <span class="s">&quot;CA1811:AvoidUncalledPrivateCode&quot;</span>)]
                <b>get</b>
                {
                    <b>return</b> <a href="#15b9508b6d5ca0e3" class="i field">_ui</a>.<a href="ConsoleHostUserInterface.cs.html#01ceb0b246ebdba1" class="i property">ErrorBackgroundColor</a>;
                }
 
                [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Performance&quot;</span>, <span class="s">&quot;CA1811:AvoidUncalledPrivateCode&quot;</span>)]
                <b>set</b>
                {
                    <a href="#15b9508b6d5ca0e3" class="i field">_ui</a>.<a href="ConsoleHostUserInterface.cs.html#01ceb0b246ebdba1" class="i property">ErrorBackgroundColor</a> = <b>value</b>;
                }
            }
 
            <b>public</b> <span class="i">ConsoleColor</span> <a id="0503f288998361c9" href="../../R/../../0000000000.html" target="n" data-glyph="102,2" class="i property">WarningForegroundColor</a>
            {
                [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Performance&quot;</span>, <span class="s">&quot;CA1811:AvoidUncalledPrivateCode&quot;</span>)]
                <b>get</b>
                {
                    <b>return</b> <a href="#15b9508b6d5ca0e3" class="i field">_ui</a>.<a href="ConsoleHostUserInterface.cs.html#588e107faeb72a86" class="i property">WarningForegroundColor</a>;
                }
 
                [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Performance&quot;</span>, <span class="s">&quot;CA1811:AvoidUncalledPrivateCode&quot;</span>)]
                <b>set</b>
                {
                    <a href="#15b9508b6d5ca0e3" class="i field">_ui</a>.<a href="ConsoleHostUserInterface.cs.html#588e107faeb72a86" class="i property">WarningForegroundColor</a> = <b>value</b>;
                }
            }
 
            <b>public</b> <span class="i">ConsoleColor</span> <a id="5eb2228dbcd1c5d4" href="../../R/../../0000000000.html" target="n" data-glyph="102,2" class="i property">WarningBackgroundColor</a>
            {
                [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Performance&quot;</span>, <span class="s">&quot;CA1811:AvoidUncalledPrivateCode&quot;</span>)]
                <b>get</b>
                {
                    <b>return</b> <a href="#15b9508b6d5ca0e3" class="i field">_ui</a>.<a href="ConsoleHostUserInterface.cs.html#58f200eb8de00a89" class="i property">WarningBackgroundColor</a>;
                }
 
                [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Performance&quot;</span>, <span class="s">&quot;CA1811:AvoidUncalledPrivateCode&quot;</span>)]
                <b>set</b>
                {
                    <a href="#15b9508b6d5ca0e3" class="i field">_ui</a>.<a href="ConsoleHostUserInterface.cs.html#58f200eb8de00a89" class="i property">WarningBackgroundColor</a> = <b>value</b>;
                }
            }
 
            <b>public</b> <span class="i">ConsoleColor</span> <a id="68d903d22c79d927" href="../../R/../../0000000000.html" target="n" data-glyph="102,2" class="i property">DebugForegroundColor</a>
            {
                [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Performance&quot;</span>, <span class="s">&quot;CA1811:AvoidUncalledPrivateCode&quot;</span>)]
                <b>get</b>
                {
                    <b>return</b> <a href="#15b9508b6d5ca0e3" class="i field">_ui</a>.<a href="ConsoleHostUserInterface.cs.html#623a8c52a8294d49" class="i property">DebugForegroundColor</a>;
                }
 
                [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Performance&quot;</span>, <span class="s">&quot;CA1811:AvoidUncalledPrivateCode&quot;</span>)]
                <b>set</b>
                {
                    <a href="#15b9508b6d5ca0e3" class="i field">_ui</a>.<a href="ConsoleHostUserInterface.cs.html#623a8c52a8294d49" class="i property">DebugForegroundColor</a> = <b>value</b>;
                }
            }
 
            <b>public</b> <span class="i">ConsoleColor</span> <a id="1c79a128c4603cab" href="../../R/../../0000000000.html" target="n" data-glyph="102,2" class="i property">DebugBackgroundColor</a>
            {
                [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Performance&quot;</span>, <span class="s">&quot;CA1811:AvoidUncalledPrivateCode&quot;</span>)]
                <b>get</b>
                {
                    <b>return</b> <a href="#15b9508b6d5ca0e3" class="i field">_ui</a>.<a href="ConsoleHostUserInterface.cs.html#a02228912879cb09" class="i property">DebugBackgroundColor</a>;
                }
 
                [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Performance&quot;</span>, <span class="s">&quot;CA1811:AvoidUncalledPrivateCode&quot;</span>)]
                <b>set</b>
                {
                    <a href="#15b9508b6d5ca0e3" class="i field">_ui</a>.<a href="ConsoleHostUserInterface.cs.html#a02228912879cb09" class="i property">DebugBackgroundColor</a> = <b>value</b>;
                }
            }
 
            <b>public</b> <span class="i">ConsoleColor</span> <a id="1329e3864575eddb" href="../../R/../../0000000000.html" target="n" data-glyph="102,2" class="i property">VerboseForegroundColor</a>
            {
                [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Performance&quot;</span>, <span class="s">&quot;CA1811:AvoidUncalledPrivateCode&quot;</span>)]
                <b>get</b>
                {
                    <b>return</b> <a href="#15b9508b6d5ca0e3" class="i field">_ui</a>.<a href="ConsoleHostUserInterface.cs.html#33edb3f9d16b5c90" class="i property">VerboseForegroundColor</a>;
                }
 
                [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Performance&quot;</span>, <span class="s">&quot;CA1811:AvoidUncalledPrivateCode&quot;</span>)]
                <b>set</b>
                {
                    <a href="#15b9508b6d5ca0e3" class="i field">_ui</a>.<a href="ConsoleHostUserInterface.cs.html#33edb3f9d16b5c90" class="i property">VerboseForegroundColor</a> = <b>value</b>;
                }
            }
 
            <b>public</b> <span class="i">ConsoleColor</span> <a id="809b9d3e78ec83d4" href="../../R/../../0000000000.html" target="n" data-glyph="102,2" class="i property">VerboseBackgroundColor</a>
            {
                [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Performance&quot;</span>, <span class="s">&quot;CA1811:AvoidUncalledPrivateCode&quot;</span>)]
                <b>get</b>
                {
                    <b>return</b> <a href="#15b9508b6d5ca0e3" class="i field">_ui</a>.<a href="ConsoleHostUserInterface.cs.html#9dd17db412bc3d30" class="i property">VerboseBackgroundColor</a>;
                }
 
                [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Performance&quot;</span>, <span class="s">&quot;CA1811:AvoidUncalledPrivateCode&quot;</span>)]
                <b>set</b>
                {
                    <a href="#15b9508b6d5ca0e3" class="i field">_ui</a>.<a href="ConsoleHostUserInterface.cs.html#9dd17db412bc3d30" class="i property">VerboseBackgroundColor</a> = <b>value</b>;
                }
            }
 
            <b>public</b> <span class="i">ConsoleColor</span> <a id="99da32109c713028" href="../../R/../../0000000000.html" target="n" data-glyph="102,2" class="i property">ProgressForegroundColor</a>
            {
                [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Performance&quot;</span>, <span class="s">&quot;CA1811:AvoidUncalledPrivateCode&quot;</span>)]
                <b>get</b>
                {
                    <b>return</b> <a href="#15b9508b6d5ca0e3" class="i field">_ui</a>.<a href="ConsoleHostUserInterface.cs.html#259bd2bea05727b0" class="i property">ProgressForegroundColor</a>;
                }
 
                [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Performance&quot;</span>, <span class="s">&quot;CA1811:AvoidUncalledPrivateCode&quot;</span>)]
                <b>set</b>
                {
                    <a href="#15b9508b6d5ca0e3" class="i field">_ui</a>.<a href="ConsoleHostUserInterface.cs.html#259bd2bea05727b0" class="i property">ProgressForegroundColor</a> = <b>value</b>;
                }
            }
 
            <b>public</b> <span class="i">ConsoleColor</span> <a id="63eeb4c227ad7c0a" href="../../R/../../0000000000.html" target="n" data-glyph="102,2" class="i property">ProgressBackgroundColor</a>
            {
                [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Performance&quot;</span>, <span class="s">&quot;CA1811:AvoidUncalledPrivateCode&quot;</span>)]
                <b>get</b>
                {
                    <b>return</b> <a href="#15b9508b6d5ca0e3" class="i field">_ui</a>.<a href="ConsoleHostUserInterface.cs.html#c19755f372facb5a" class="i property">ProgressBackgroundColor</a>;
                }
 
                [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Performance&quot;</span>, <span class="s">&quot;CA1811:AvoidUncalledPrivateCode&quot;</span>)]
                <b>set</b>
                {
                    <a href="#15b9508b6d5ca0e3" class="i field">_ui</a>.<a href="ConsoleHostUserInterface.cs.html#c19755f372facb5a" class="i property">ProgressBackgroundColor</a> = <b>value</b>;
                }
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Return the actual console host object so that the user can get at</span>
        <span class="c">///</span><span class="c"> the unproxied methods.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public override</b> <a href="/System.Management.Automation/A.html#a3c2513aa3da07fa" class="t t">PSObject</a> <a id="fb59893b50a2f306" href="../../R/fb59893b50a2f306.html" target="n" data-glyph="102,1" class="i property">PrivateData</a>
        {
            <b>get</b>
            {
                <b>if</b> (<a href="#9579865b1d1857cb" class="i field">ui</a> == <b>null</b>) <b>return</b> <b>null</b>;
                <b>return</b> <a href="#deb2d107bf48886a" class="i field">_consoleColorProxy</a> ??= <a href="/System.Management.Automation/A.html#a3c2513aa3da07fa" class="t t">PSObject</a>.<span class="i">AsPSObject</span>(<b>new</b> <a href="#7ae941e2202c8c24" class="t constructor">ConsoleColorProxy</a>(<a href="#9579865b1d1857cb" class="i field">ui</a>));
            }
        }
 
        <b>private</b> <a href="/System.Management.Automation/A.html#a3c2513aa3da07fa" class="t t">PSObject</a> <a id="deb2d107bf48886a" href="../../R/deb2d107bf48886a.html" target="n" data-glyph="46,1" class="i field">_consoleColorProxy</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> See base class.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">value</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">value</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span><span class="c">/&gt;</span>
        <b>public override</b> <span class="i n">System</span>.<span class="i">Globalization</span>.<span class="i">CultureInfo</span> <a id="7c572f1928788751" href="../../R/7c572f1928788751.html" target="n" data-glyph="102,1" class="i property">CurrentCulture</a>
        {
            <b>get</b>
            {
                <b>lock</b> (<a href="#55f653f715aa2431" class="i field">hostGlobalLock</a>)
                {
                    <b>return</b> <span class="i">CultureInfo</span>.<span class="i">CurrentCulture</span>;
                }
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> See base class.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">value</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">value</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span><span class="c">/&gt;</span>
        <b>public override</b> <span class="i n">System</span>.<span class="i">Globalization</span>.<span class="i">CultureInfo</span> <a id="dc2cef205a2a034a" href="../../R/dc2cef205a2a034a.html" target="n" data-glyph="102,1" class="i property">CurrentUICulture</a>
        {
            <b>get</b>
            {
                <b>lock</b> (<a href="#55f653f715aa2431" class="i field">hostGlobalLock</a>)
                {
                    <b>return</b> <span class="i">CultureInfo</span>.<span class="i">CurrentUICulture</span>;
                }
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span><span class="c">/&gt;</span>
        <b>public override void</b> <a id="1985d3a239cd7de2" href="../../R/1985d3a239cd7de2.html" target="n" data-glyph="72,1" class="i method">SetShouldExit</a>(<b>int</b> <span id="r32 rd" class="r32 r">exitCode</span>)
        {
            <b>lock</b> (<a href="#55f653f715aa2431" class="i field">hostGlobalLock</a>)
            {
                <span class="c">// Check for the pushed runspace scenario.</span>
                <b>if</b> (<a href="../../P/cda5e43a29a66e53.html#cda5e43a29a66e53" class="k">this</a>.<a href="#a43561eac56deab3" class="i property">IsRunspacePushed</a>)
                {
                    <a href="../../P/cda5e43a29a66e53.html#cda5e43a29a66e53" class="k">this</a>.<a href="#61d2e5015e80c497" class="i method">PopRunspace</a>();
                }
                <b>else</b> <b>if</b> (<a href="#5c77214aa34523a4" class="i property">InDebugMode</a>)
                {
                    <a href="#133b48542f47f0e3" class="i method">ExitDebugMode</a>(<a href="/System.Management.Automation/A.html#470618169485a70e" class="t t">DebuggerResumeAction</a>.<a href="/System.Management.Automation/A.html#c35cb32c2ab7ed0d" class="i field">Continue</a>);
                }
                <b>else</b>
                {
                    <a href="#2b143329684986ff" class="i field">_setShouldExitCalled</a> = <b>true</b>;
                    <a href="#564645f4f83dd343" class="i field">_exitCodeFromRunspace</a> = <span class="r32 r">exitCode</span>;
                    <a href="#ab61e63581cd3e32" class="i property">ShouldEndSession</a> = <b>true</b>;
                }
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If an input loop is running, then starts a new, nested input loop.  If an input loop is not running,</span>
        <span class="c">///</span><span class="c"> throws an exception.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">InvalidOperationException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If a nested prompt is entered while the host is not running at least one prompt loop.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>public override void</b> <a id="142bc6b643651235" href="../../R/142bc6b643651235.html" target="n" data-glyph="72,1" class="i method">EnterNestedPrompt</a>()
        {
            <span class="c">// save the old Executor, then clear it so that a break does not cancel the pipeline from which this method</span>
            <span class="c">// might be called.</span>
 
            <a href="Executor.cs.html#c4a69b641f3e390e" class="t t">Executor</a> <span id="r33 rd" class="r33 r">oldCurrent</span> = <a href="Executor.cs.html#c4a69b641f3e390e" class="t t">Executor</a>.<a href="Executor.cs.html#ac525ce39121e57c" class="i property">CurrentExecutor</a>;
 
            <b>try</b>
            {
                <span class="c">// this assignment is threadsafe -- protected in CurrentExecutor property</span>
 
                <a href="Executor.cs.html#c4a69b641f3e390e" class="t t">Executor</a>.<a href="Executor.cs.html#ac525ce39121e57c" class="i property">CurrentExecutor</a> = <b>null</b>;
                <b>lock</b> (<a href="#55f653f715aa2431" class="i field">hostGlobalLock</a>)
                {
                    <a href="#a0d6e5e20f7e47b4" class="i property">IsNested</a> = <span class="r33 r">oldCurrent</span> != <b>null</b> || <a href="../../P/cda5e43a29a66e53.html#cda5e43a29a66e53" class="k">this</a>.<a href="#9579865b1d1857cb" class="i field">ui</a>.<a href="ConsoleHostUserInterface.cs.html#1849b96268ceab63" class="i property">IsCommandCompletionRunning</a>;
                }
 
                <a href="#fc2e72f9ce5a4a20" class="t t">InputLoop</a>.<a href="#dc3ca7fea93e7b81" class="i method">RunNewInputLoop</a>(<a href="../../P/cda5e43a29a66e53.html#cda5e43a29a66e53" class="k">this</a>, <a href="#a0d6e5e20f7e47b4" class="i property">IsNested</a>);
            }
            <b>finally</b>
            {
                <a href="Executor.cs.html#c4a69b641f3e390e" class="t t">Executor</a>.<a href="Executor.cs.html#ac525ce39121e57c" class="i property">CurrentExecutor</a> = <span class="r33 r">oldCurrent</span>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> See base class.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">InvalidOperationException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If there is no nested prompt.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>public override void</b> <a id="4d9695da5d9c07b7" href="../../R/4d9695da5d9c07b7.html" target="n" data-glyph="72,1" class="i method">ExitNestedPrompt</a>()
        {
            <b>lock</b> (<a href="#55f653f715aa2431" class="i field">hostGlobalLock</a>)
            {
                <a href="#a0d6e5e20f7e47b4" class="i property">IsNested</a> = <a href="#fc2e72f9ce5a4a20" class="t t">InputLoop</a>.<a href="#a3267b96e3299fb4" class="i method">ExitCurrentLoop</a>();
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> See base class.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public override void</b> <a id="8c6597f1e02172ae" href="../../R/8c6597f1e02172ae.html" target="n" data-glyph="72,1" class="i method">NotifyBeginApplication</a>()
        {
            <b>lock</b> (<a href="#55f653f715aa2431" class="i field">hostGlobalLock</a>)
            {
                ++<a href="#4b5d9ddd4e836311" class="i field">_beginApplicationNotifyCount</a>;
                <b>if</b> (<a href="#4b5d9ddd4e836311" class="i field">_beginApplicationNotifyCount</a> == 1)
                {
                    <span class="c">// save the window title when first notified.</span>
 
                    <a href="#8c9e2618b5fc682f" class="i field">_savedWindowTitle</a> = <a href="#9579865b1d1857cb" class="i field">ui</a>.<a href="ConsoleHostUserInterface.cs.html#33b028e308b5319d" class="i property">RawUI</a>.<a href="/System.Management.Automation/A.html#4147d92d53afa5ad" class="i property">WindowTitle</a>;
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">UNIX</span>
                    <b>if</b> (<a href="#5520e9152dd20c82" class="i field">_initialConsoleMode</a> != <a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#1d1eff9fb00ac8e2" class="t t">ConsoleModes</a>.<a href="ConsoleControl.cs.html#fc3ca3fb0292ebf8" class="i field">Unknown</a>)
                    {
                        <b>var</b> <span id="r34 rd" class="r34 r">activeScreenBufferHandle</span> = <a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#d72136ddad017191" class="i method">GetActiveScreenBufferHandle</a>();
                        <a href="#efee48109d746f70" class="i field">_savedConsoleMode</a> = <a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#133579be57ae9c3e" class="i method">GetMode</a>(<span class="r34 r">activeScreenBufferHandle</span>);
                        <a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#6c1ab9fc2b7085b1" class="i method">SetMode</a>(<span class="r34 r">activeScreenBufferHandle</span>, <a href="#5520e9152dd20c82" class="i field">_initialConsoleMode</a>);
                    }
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
                }
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> See base class</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">seealso</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="#8c6597f1e02172ae" class="i method">NotifyBeginApplication</a><span class="c">&quot;</span><span class="c">/&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public override void</b> <a id="b9fe1e76b46a242c" href="../../R/b9fe1e76b46a242c.html" target="n" data-glyph="72,1" class="i method">NotifyEndApplication</a>()
        {
            <b>lock</b> (<a href="#55f653f715aa2431" class="i field">hostGlobalLock</a>)
            {
                <a href="/System.Management.Automation/A.html#c04955255430d32f" class="t t">Dbg</a>.<span class="i">Assert</span>(<a href="#4b5d9ddd4e836311" class="i field">_beginApplicationNotifyCount</a> &gt; 0, <span class="s">&quot;Not running an executable - NotifyBeginApplication was not called!&quot;</span>);
                --<a href="#4b5d9ddd4e836311" class="i field">_beginApplicationNotifyCount</a>;
                <b>if</b> (<a href="#4b5d9ddd4e836311" class="i field">_beginApplicationNotifyCount</a> == 0)
                {
                    <span class="c">// restore the window title when the last application started has ended.</span>
 
                    <a href="#9579865b1d1857cb" class="i field">ui</a>.<a href="ConsoleHostUserInterface.cs.html#33b028e308b5319d" class="i property">RawUI</a>.<a href="/System.Management.Automation/A.html#4147d92d53afa5ad" class="i property">WindowTitle</a> = <a href="#8c9e2618b5fc682f" class="i field">_savedWindowTitle</a>;
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">UNIX</span>
                    <b>if</b> (<a href="#efee48109d746f70" class="i field">_savedConsoleMode</a> != <a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#1d1eff9fb00ac8e2" class="t t">ConsoleModes</a>.<a href="ConsoleControl.cs.html#fc3ca3fb0292ebf8" class="i field">Unknown</a>)
                    {
                        <a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#6c1ab9fc2b7085b1" class="i method">SetMode</a>(<a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#d72136ddad017191" class="i method">GetActiveScreenBufferHandle</a>(), <a href="#efee48109d746f70" class="i field">_savedConsoleMode</a>);
                    }
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
                }
            }
        }
 
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">LEGACYTELEMETRY</span>
<span class="e">        bool IHostProvidesTelemetryData.HostIsInteractive
        {
            get
            {
                return !s_cpp.NonInteractive &amp;&amp; !s_cpp.AbortStartup &amp;&amp;
                       ((s_cpp.InitialCommand == null &amp;&amp; s_cpp.File == null) || s_cpp.NoExit);
            }
        }
 
        double IHostProvidesTelemetryData.ProfileLoadTimeInMS { get { return _profileLoadTimeInMS; } }
 
        double IHostProvidesTelemetryData.ReadyForInputTimeInMS { get { return _readyForInputTimeInMS; } }
 
        int IHostProvidesTelemetryData.InteractiveCommandCount { get { return _interactiveCommandCount; } }
 
        private double _readyForInputTimeInMS;
        private int _interactiveCommandCount;
</span><span class="k preprocess">#</span><span class="k preprocess">endif</span>
 
        <b>private double</b> <a id="1b36d89c3104ef64" href="../../R/1b36d89c3104ef64.html" target="n" data-glyph="46,1" class="i field">_profileLoadTimeInMS</a>;
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> overrides
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> non-overrides
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Constructs a new instance.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal</b> <a id="510c680958eec2cf" href="../../R/510c680958eec2cf.html" target="n" data-glyph="74,1" class="t constructor">ConsoleHost</a>()
        {
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">UNIX</span>
            <b>try</b>
            {
                <span class="c">// Capture the initial console mode before constructing our ui - that constructor</span>
                <span class="c">// will change the console mode to turn on VT100 support.</span>
                <a href="#5520e9152dd20c82" class="i field">_initialConsoleMode</a> = <a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#133579be57ae9c3e" class="i method">GetMode</a>(<a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#d72136ddad017191" class="i method">GetActiveScreenBufferHandle</a>());
            }
            <b>catch</b> (<span class="i">Exception</span>)
            {
                <span class="c">// Make sure we skip setting the console mode later.</span>
                <a href="#efee48109d746f70" class="i field">_savedConsoleMode</a> = <a href="#5520e9152dd20c82" class="i field">_initialConsoleMode</a> = <a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#1d1eff9fb00ac8e2" class="t t">ConsoleModes</a>.<a href="ConsoleControl.cs.html#fc3ca3fb0292ebf8" class="i field">Unknown</a>;
            }
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
 
            <span class="i">Thread</span>.<span class="i">CurrentThread</span>.<span class="i">CurrentUICulture</span> = <a href="../../P/cda5e43a29a66e53.html#cda5e43a29a66e53" class="k">this</a>.<a href="#dc2cef205a2a034a" class="i property">CurrentUICulture</a>;
            <span class="i">Thread</span>.<span class="i">CurrentThread</span>.<span class="i">CurrentCulture</span> = <a href="../../P/cda5e43a29a66e53.html#cda5e43a29a66e53" class="k">this</a>.<a href="#7c572f1928788751" class="i property">CurrentCulture</a>;
            <span class="c">// BUG: 610329. Tell PowerShell engine to apply console</span>
            <span class="c">// related properties while launching Pipeline Execution</span>
            <span class="c">// Thread.</span>
            <a href="/System.Management.Automation/A.html#7b79cd90e035740e" class="k">base</a>.<span class="i">ShouldSetThreadUILanguageToZero</span> = <b>true</b>;
 
            <a href="#5c77214aa34523a4" class="i property">InDebugMode</a> = <b>false</b>;
            <a href="#44e202f47082879d" class="i field">_displayDebuggerBanner</a> = <b>true</b>;
 
            <a href="../../P/cda5e43a29a66e53.html#cda5e43a29a66e53" class="k">this</a>.<a href="#9579865b1d1857cb" class="i field">ui</a> = <b>new</b> <a href="ConsoleHostUserInterface.cs.html#1697543d01a650f1" class="t constructor">ConsoleHostUserInterface</a>(<a href="../../P/cda5e43a29a66e53.html#cda5e43a29a66e53" class="k">this</a>);
            <a href="#8c66038937fbdefe" class="i field">_consoleWriter</a> = <b>new</b> <a href="ConsoleTextWriter.cs.html#e23eb5b91ed43f36" class="t constructor">ConsoleTextWriter</a>(<a href="#9579865b1d1857cb" class="i field">ui</a>);
 
            <span class="i">UnhandledExceptionEventHandler</span> <span id="r35 rd" class="r35 r">handler</span> = <b>new</b> <span class="i">UnhandledExceptionEventHandler</span>(<span class="i">UnhandledExceptionHandler</span>);
            <span class="i">AppDomain</span>.<span class="i">CurrentDomain</span>.<span class="i">UnhandledException</span> += <span class="r35 r">handler</span>;
        }
 
        [<span class="i n">System</span>.<span class="i">Diagnostics</span>.<span class="i">CodeAnalysis</span>.<span class="i">SuppressMessage</span>(
            <span class="s">&quot;Performance&quot;</span>,
            <span class="s">&quot;CA1822:Mark members as static&quot;</span>,
            <span class="i">Justification</span> = <span class="s">&quot;Accesses instance members in preprocessor branch.&quot;</span>)]
        <b>private void</b> <a id="2009b6c1e744d2d8" href="../../R/2009b6c1e744d2d8.html" target="n" data-glyph="76,1" class="i method">BindBreakHandler</a>()
        {
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">UNIX</span>
<span class="e">            Console.CancelKeyPress += new ConsoleCancelEventHandler(MyBreakHandler);
</span><span class="k preprocess">#</span><span class="k preprocess">else</span>
            <a href="#7f0525ecd3ab98b7" class="i field">breakHandlerGcHandle</a> = <span class="i">GCHandle</span>.<span class="i">Alloc</span>(<b>new</b> <a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<span class="t">BreakHandler</span>(<a href="#365af592ea6287a7" class="i method">MyBreakHandler</a>));
            <a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#ccd3e9fc5b2c706d" class="i method">AddBreakHandler</a>((<a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#fc771999e869a2f6" class="t t">BreakHandler</a>)<a href="#7f0525ecd3ab98b7" class="i field">breakHandlerGcHandle</a>.<span class="i">Target</span>);
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
        }
 
        <b>private void</b> <a id="664c60a46a94c9ff" href="../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">UnhandledExceptionHandler</a>(<b>object</b> <span id="r36 rd" class="r36 r">sender</span>, <span class="i">UnhandledExceptionEventArgs</span> <span id="r37 rd" class="r37 r">args</span>)
        {
            <span class="c">// FYI: sender is a reference to the source app domain</span>
 
            <span class="c">// The CLR will shut down the app as soon as this handler is complete, but just in case, we want</span>
            <span class="c">// to exit at our next opportunity.</span>
 
            <a href="#d4595d95de65ba3c" class="i field">_shouldEndSession</a> = <b>true</b>;
 
            <span class="i">Exception</span> <span id="r38 rd" class="r38 r">e</span> = <b>null</b>;
 
            <b>if</b> (<span class="r37 r">args</span> != <b>null</b>)
            {
                <span class="r38 r">e</span> = (<span class="i">Exception</span>)<span class="r37 r">args</span>.<span class="i">ExceptionObject</span>;
            }
 
            <a href="#9579865b1d1857cb" class="i field">ui</a>.<a href="ConsoleHostUserInterface.cs.html#53186981e97affd9" class="i method">WriteLine</a>();
            <a href="#9579865b1d1857cb" class="i field">ui</a>.<span class="i">Write</span>(
                <span class="i">ConsoleColor</span>.<span class="i">Red</span>,
                <a href="#9579865b1d1857cb" class="i field">ui</a>.<a href="ConsoleHostUserInterface.cs.html#33b028e308b5319d" class="i property">RawUI</a>.<a href="/System.Management.Automation/A.html#e2891a44a8939f10" class="i property">BackgroundColor</a>,
                <span class="i">ConsoleHostStrings</span>.<span class="i">UnhandledExceptionShutdownMessage</span>);
            <a href="#9579865b1d1857cb" class="i field">ui</a>.<a href="ConsoleHostUserInterface.cs.html#53186981e97affd9" class="i method">WriteLine</a>();
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Disposes of this instance, per the IDisposable pattern.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public void</b> <a id="ce2c0b5954e7ee84" href="../../R/ce2c0b5954e7ee84.html" target="n" data-glyph="72,1" class="i method">Dispose</a>()
        {
            <a href="#eccd1d3341a602a0" class="i method">Dispose</a>(<b>true</b>);
            <span class="i">GC</span>.<span class="i">SuppressFinalize</span>(<a href="../../P/cda5e43a29a66e53.html#cda5e43a29a66e53" class="k">this</a>);
        }
 
        <b>private void</b> <a id="eccd1d3341a602a0" href="../../R/eccd1d3341a602a0.html" target="n" data-glyph="76,1" class="i method">Dispose</a>(<b>bool</b> <span id="r39 rd" class="r39 r">isDisposingNotFinalizing</span>)
        {
            <b>if</b> (!<a href="#6be914d776bb5e09" class="i field">_isDisposed</a>)
            {
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">UNIX</span>
                <a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#bfb4ee3c70af3cfe" class="i method">RemoveBreakHandler</a>();
                <b>if</b> (<a href="#7f0525ecd3ab98b7" class="i field">breakHandlerGcHandle</a>.<span class="i">IsAllocated</span>)
                {
                    <a href="#7f0525ecd3ab98b7" class="i field">breakHandlerGcHandle</a>.<span class="i">Free</span>();
                }
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
 
                <b>if</b> (<span class="r39 r">isDisposingNotFinalizing</span>)
                {
                    <b>if</b> (<a href="ConsoleHostTranscript.cs.html#ec2c25c02b262216" class="i property">IsTranscribing</a>)
                    {
                        <a href="ConsoleHostTranscript.cs.html#a64e7f4e995a4a75" class="i method">StopTranscribing</a>();
                    }
 
                    <b>if</b> (<a href="#b68b707c6568a994" class="i field">_outputSerializer</a> != <b>null</b>)
                    {
                        <a href="#b68b707c6568a994" class="i field">_outputSerializer</a>.<a href="Serialization.cs.html#8dd870d15d1b0afe" class="i method">End</a>();
                    }
 
                    <b>if</b> (<a href="#e730d6c0ab156b4c" class="i field">_errorSerializer</a> != <b>null</b>)
                    {
                        <a href="#e730d6c0ab156b4c" class="i field">_errorSerializer</a>.<a href="Serialization.cs.html#8dd870d15d1b0afe" class="i method">End</a>();
                    }
 
                    <b>if</b> (<a href="#8e1330b3ad99e179" class="i field">_runspaceRef</a> != <b>null</b>)
                    {
                        <span class="c">// NTRAID#Windows Out Of Band Releases-925297-2005/12/14</span>
                        <b>try</b>
                        {
                            <a href="#8e1330b3ad99e179" class="i field">_runspaceRef</a>.<span class="i">Runspace</span>.<span class="i">Dispose</span>();
                        }
                        <b>catch</b> (<a href="/System.Management.Automation/A.html#340ccbbd1c6e8b87" class="t t">InvalidRunspaceStateException</a>)
                        {
                        }
                    }
 
                    <a href="#8e1330b3ad99e179" class="i field">_runspaceRef</a> = <b>null</b>;
                    <a href="#9579865b1d1857cb" class="i field">ui</a> = <b>null</b>;
                }
            }
 
            <a href="#6be914d776bb5e09" class="i field">_isDisposed</a> = <b>true</b>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Finalizes an instance of the </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="../../P/cda5e43a29a66e53.html#cda5e43a29a66e53" class="t t">ConsoleHost</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> class.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        ~<a id="2bcf6e8583606ab7" href="../../R/../../0000000000.html" target="n" data-glyph="75,1" class="t method">ConsoleHost</a>()
        {
            <a href="#eccd1d3341a602a0" class="i method">Dispose</a>(<b>false</b>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Indicates if the session should be terminated or not.  Typically set by the break handler for Close, Logoff, and</span>
        <span class="c">///</span><span class="c"> Shutdown events.  Note that the only valid transition for this property is from false to true: it is not legal to</span>
        <span class="c">///</span><span class="c"> try to set it to false after is was set to true.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">value</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> true to shut down the session.  false is only allowed if the property is already false.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">value</span><span class="c">&gt;</span>
        <b>internal bool</b> <a id="ab61e63581cd3e32" href="../../R/ab61e63581cd3e32.html" target="n" data-glyph="104,1" class="i property">ShouldEndSession</a>
        {
            <span class="c">// This might get called from the main thread, or from the pipeline thread, or from a break handler thread.</span>
            <b>get</b>
            {
                <b>bool</b> <span id="r40 rd" class="r40 r">result</span> = <b>false</b>;
 
                <b>lock</b> (<a href="#55f653f715aa2431" class="i field">hostGlobalLock</a>)
                {
                    <span class="r40 r">result</span> = <a href="#d4595d95de65ba3c" class="i field">_shouldEndSession</a>;
                }
 
                <b>return</b> <span class="r40 r">result</span>;
            }
 
            <b>set</b>
            {
                <b>lock</b> (<a href="#55f653f715aa2431" class="i field">hostGlobalLock</a>)
                {
                    <span class="c">// If ShouldEndSession is already true, you can&#39;t set it back</span>
 
                    <a href="/System.Management.Automation/A.html#c04955255430d32f" class="t t">Dbg</a>.<span class="i">Assert</span>(!<a href="#d4595d95de65ba3c" class="i field">_shouldEndSession</a> || <b>value</b>,
                        <span class="s">&quot;ShouldEndSession can only be set from false to true&quot;</span>);
 
                    <a href="#d4595d95de65ba3c" class="i field">_shouldEndSession</a> = <b>value</b>;
                }
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The Runspace ref object being used by this Host instance.  A host only opens one Runspace.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">value</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">value</span><span class="c">&gt;</span>
        <b>internal</b> <span class="i">RunspaceRef</span> <a id="3b80b4197e85d182" href="../../R/3b80b4197e85d182.html" target="n" data-glyph="104,1" class="i property">RunspaceRef</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#8e1330b3ad99e179" class="i field">_runspaceRef</a>;
            }
        }
 
        <b>internal</b> <a href="Serialization.cs.html#4e9b6b767ad54ab8" class="t t">WrappedSerializer</a>.<a href="Serialization.cs.html#bf09ed02271085ca" class="t t">DataFormat</a> <a id="e2b8ad929b0e9732" href="../../R/e2b8ad929b0e9732.html" target="n" data-glyph="104,1" class="i property">OutputFormat</a> { <b>get</b>; <b>private set</b>; }
 
        <b>internal bool</b> <a id="7dda64acfdb618f5" href="../../R/7dda64acfdb618f5.html" target="n" data-glyph="104,1" class="i property">OutputFormatSpecified</a> { <b>get</b>; <b>private set</b>; }
 
        <b>internal</b> <a href="Serialization.cs.html#4e9b6b767ad54ab8" class="t t">WrappedSerializer</a>.<a href="Serialization.cs.html#bf09ed02271085ca" class="t t">DataFormat</a> <a id="93875981d7aafca4" href="../../R/93875981d7aafca4.html" target="n" data-glyph="104,1" class="i property">InputFormat</a> { <b>get</b>; <b>private set</b>; }
 
        <b>internal</b> <a href="Serialization.cs.html#0d69079b317fdfe2" class="t t">WrappedDeserializer</a>.<a href="Serialization.cs.html#bf09ed02271085ca" class="t t">DataFormat</a> <a id="ec8b3d93dec73f8c" href="../../R/ec8b3d93dec73f8c.html" target="n" data-glyph="104,1" class="i property">ErrorFormat</a>
        {
            <b>get</b>
            {
                <a href="Serialization.cs.html#0d69079b317fdfe2" class="t t">WrappedDeserializer</a>.<a href="Serialization.cs.html#bf09ed02271085ca" class="t t">DataFormat</a> <span id="r41 rd" class="r41 r">format</span> = <a href="#e2b8ad929b0e9732" class="i property">OutputFormat</a>;
 
                <span class="c">// If this shell is invoked in non-interactive, error is redirected, and OutputFormat was not</span>
                <span class="c">// specified write data in error stream in xml format assuming PowerShell-&gt;PowerShell usage.</span>
                <b>if</b> (!<a href="#7dda64acfdb618f5" class="i property">OutputFormatSpecified</a> &amp;&amp; !<a href="#1715457a129ccf20" class="i property">IsInteractive</a> &amp;&amp; <span class="i">Console</span>.<span class="i">IsErrorRedirected</span> &amp;&amp; <a href="#98c78bba86bd3aba" class="i field">_wasInitialCommandEncoded</a>)
                {
                    <span class="r41 r">format</span> = <a href="Serialization.cs.html#48289f9b2c3628de" class="t t">Serialization</a>.<a href="Serialization.cs.html#bf09ed02271085ca" class="t t">DataFormat</a>.<a href="Serialization.cs.html#370be72d9a1d0360" class="i field">XML</a>;
                }
 
                <b>return</b> <span class="r41 r">format</span>;
            }
        }
 
        <b>internal bool</b> <a id="3aff0a908296b7f4" href="../../R/3aff0a908296b7f4.html" target="n" data-glyph="104,1" class="i property">IsRunningAsync</a>
        {
            <b>get</b>
            {
                <b>return</b> !<a href="#1715457a129ccf20" class="i property">IsInteractive</a> &amp;&amp; ((<a href="#e2b8ad929b0e9732" class="i property">OutputFormat</a> != <a href="Serialization.cs.html#48289f9b2c3628de" class="t t">Serialization</a>.<a href="Serialization.cs.html#bf09ed02271085ca" class="t t">DataFormat</a>.<a href="Serialization.cs.html#b9edeb2597b5e6a8" class="i field">Text</a>) || <span class="i">Console</span>.<span class="i">IsInputRedirected</span>);
            }
        }
 
        <b>internal bool</b> <a id="a0d6e5e20f7e47b4" href="../../R/a0d6e5e20f7e47b4.html" target="n" data-glyph="104,1" class="i property">IsNested</a> { <b>get</b>; <b>private set</b>; }
 
        <b>internal</b> <a href="Serialization.cs.html#4e9b6b767ad54ab8" class="t t">WrappedSerializer</a> <a id="b73fdaa94687f263" href="../../R/b73fdaa94687f263.html" target="n" data-glyph="104,1" class="i property">OutputSerializer</a>
        {
            <b>get</b>
            {
                <b>if</b> (<a href="#b68b707c6568a994" class="i field">_outputSerializer</a> == <b>null</b>)
                {
                    <a href="#b68b707c6568a994" class="i field">_outputSerializer</a> =
                        <b>new</b> <span class="t">WrappedSerializer</span>(
                            <a href="#e2b8ad929b0e9732" class="i property">OutputFormat</a>,
                            <span class="s">&quot;Output&quot;</span>,
                            <span class="i">Console</span>.<span class="i">IsOutputRedirected</span> ? <span class="i">Console</span>.<span class="i">Out</span> : <a href="#242f4eeac16479ac" class="i property">ConsoleTextWriter</a>);
                }
 
                <b>return</b> <a href="#b68b707c6568a994" class="i field">_outputSerializer</a>;
            }
        }
 
        <b>internal</b> <a href="Serialization.cs.html#4e9b6b767ad54ab8" class="t t">WrappedSerializer</a> <a id="05a9e033aeedb67d" href="../../R/05a9e033aeedb67d.html" target="n" data-glyph="104,1" class="i property">ErrorSerializer</a>
        {
            <b>get</b>
            {
                <b>if</b> (<a href="#e730d6c0ab156b4c" class="i field">_errorSerializer</a> == <b>null</b>)
                {
                    <a href="#e730d6c0ab156b4c" class="i field">_errorSerializer</a> =
                        <b>new</b> <span class="t">WrappedSerializer</span>(
                            <a href="#ec8b3d93dec73f8c" class="i property">ErrorFormat</a>,
                            <span class="s">&quot;Error&quot;</span>,
                            <span class="i">Console</span>.<span class="i">IsErrorRedirected</span> ? <span class="i">Console</span>.<span class="i">Error</span> : <a href="#242f4eeac16479ac" class="i property">ConsoleTextWriter</a>);
                }
 
                <b>return</b> <a href="#e730d6c0ab156b4c" class="i field">_errorSerializer</a>;
            }
        }
 
        <b>internal bool</b> <a id="1715457a129ccf20" href="../../R/1715457a129ccf20.html" target="n" data-glyph="104,1" class="i property">IsInteractive</a>
        {
            <b>get</b>
            {
                <span class="c">// we&#39;re running interactive if we&#39;re in a prompt loop, and we&#39;re not reading keyboard input from stdin.</span>
 
                <b>return</b> <a href="#2c36f3a1db91c903" class="i field">_isRunningPromptLoop</a> &amp;&amp; !<a href="#9579865b1d1857cb" class="i field">ui</a>.<a href="ConsoleHostUserInterface.cs.html#96bef84efdae9634" class="i property">ReadFromStdin</a>;
            }
        }
 
        <b>internal</b> <span class="i">TextWriter</span> <a id="242f4eeac16479ac" href="../../R/242f4eeac16479ac.html" target="n" data-glyph="104,1" class="i property">ConsoleTextWriter</a>
        {
            <b>get</b>
            {
                <a href="/System.Management.Automation/A.html#c04955255430d32f" class="t t">Dbg</a>.<span class="i">Assert</span>(<a href="#8c66038937fbdefe" class="i field">_consoleWriter</a> != <b>null</b>, <span class="s">&quot;consoleWriter should have been initialized&quot;</span>);
                <b>return</b> <a href="#8c66038937fbdefe" class="i field">_consoleWriter</a>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The main run loop of the program: processes command line parameters, and starts up a runspace.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r42 r">cpp</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Commandline parameter parser. The commandline parameter parser is expected to parse all the</span>
        <span class="c">///</span><span class="c"> arguments before calling this method.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r43 r">isPrestartWarned</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Is there any warning at startup</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The process exit code to be returned by Main.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>private uint</b> <a id="1a318be2b2b59cb1" href="../../R/1a318be2b2b59cb1.html" target="n" data-glyph="76,1" class="i method">Run</a>(<a href="CommandLineParameterParser.cs.html#2b98c95fb32ff888" class="t t">CommandLineParameterParser</a> <span id="r42 rd" class="r42 r">cpp</span>, <b>bool</b> <span id="r43 rd" class="r43 r">isPrestartWarned</span>)
        {
            <a href="/System.Management.Automation/A.html#c04955255430d32f" class="t t">Dbg</a>.<span class="i">Assert</span>(<span class="r42 r">cpp</span> != <b>null</b>, <span class="s">&quot;CommandLine parameter parser cannot be null.&quot;</span>);
            <b>uint</b> <span id="r44 rd" class="r44 r">exitCode</span> = <a href="#3e33bebb0392ce42" class="i field">ExitCodeSuccess</a>;
 
            <b>do</b>
            {
                <a href="#eaeace8ff695e418" class="i field">s_runspaceInitTracer</a>.<span class="i">WriteLine</span>(<span class="s">&quot;starting parse of command line parameters&quot;</span>);
 
                <span class="r44 r">exitCode</span> = <a href="#3e33bebb0392ce42" class="i field">ExitCodeSuccess</a>;
                <b>if</b> (!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r42 r">cpp</span>.<a href="CommandLineParameterParser.cs.html#03e4079fd1301a6f" class="i property">InitialCommand</a>) &amp;&amp; <span class="r43 r">isPrestartWarned</span>)
                {
                    <a href="#19a35abc23dbcc28" class="i field">s_tracer</a>.<span class="i">TraceError</span>(<span class="s">&quot;Start up warnings made command \&quot;{0}\&quot; not executed&quot;</span>, <span class="r42 r">cpp</span>.<a href="CommandLineParameterParser.cs.html#03e4079fd1301a6f" class="i property">InitialCommand</a>);
                    <b>string</b> <span id="r45 rd" class="r45 r">msg</span> = <span class="i">StringUtil</span>.<span class="i">Format</span>(<span class="i">ConsoleHostStrings</span>.<span class="i">InitialCommandNotExecuted</span>, <span class="r42 r">cpp</span>.<a href="CommandLineParameterParser.cs.html#03e4079fd1301a6f" class="i property">InitialCommand</a>);
                    <a href="#9579865b1d1857cb" class="i field">ui</a>.<a href="ConsoleHostUserInterface.cs.html#79384cc9e45dc2ca" class="i method">WriteErrorLine</a>(<span class="r45 r">msg</span>);
                    <span class="r44 r">exitCode</span> = <a href="#86d4e95f5b29b6b8" class="i field">ExitCodeInitFailure</a>;
                    <b>break</b>;
                }
 
                <b>if</b> (<span class="r42 r">cpp</span>.<a href="CommandLineParameterParser.cs.html#4f553a42f3c7484b" class="i property">AbortStartup</a>)
                {
                    <a href="#19a35abc23dbcc28" class="i field">s_tracer</a>.<span class="i">WriteLine</span>(<span class="s">&quot;processing of cmdline args failed, exiting&quot;</span>);
                    <span class="r44 r">exitCode</span> = <span class="r42 r">cpp</span>.<a href="CommandLineParameterParser.cs.html#2d4a51ed47ac3112" class="i property">ExitCode</a>;
                    <b>break</b>;
                }
 
                <a href="#e2b8ad929b0e9732" class="i property">OutputFormat</a> = <span class="r42 r">cpp</span>.<a href="CommandLineParameterParser.cs.html#ef859722fb9315ff" class="i property">OutputFormat</a>;
                <a href="#7dda64acfdb618f5" class="i property">OutputFormatSpecified</a> = <span class="r42 r">cpp</span>.<a href="CommandLineParameterParser.cs.html#c1d2d07a9ac43560" class="i property">OutputFormatSpecified</a>;
                <a href="#93875981d7aafca4" class="i property">InputFormat</a> = <span class="r42 r">cpp</span>.<a href="CommandLineParameterParser.cs.html#5a88f84fb6d2d7e5" class="i property">InputFormat</a>;
                <a href="#98c78bba86bd3aba" class="i field">_wasInitialCommandEncoded</a> = <span class="r42 r">cpp</span>.<a href="CommandLineParameterParser.cs.html#2c3842659137fe39" class="i property">WasInitialCommandEncoded</a>;
 
                <a href="#9579865b1d1857cb" class="i field">ui</a>.<a href="ConsoleHostUserInterface.cs.html#96bef84efdae9634" class="i property">ReadFromStdin</a> = <span class="r42 r">cpp</span>.<a href="CommandLineParameterParser.cs.html#9ad87c25b2b21a0e" class="i property">ExplicitReadCommandsFromStdin</a> || <span class="i">Console</span>.<span class="i">IsInputRedirected</span>;
                <a href="#9579865b1d1857cb" class="i field">ui</a>.<a href="ConsoleHostUserInterface.cs.html#3202c0ccb1155eb7" class="i property">NoPrompt</a> = <span class="r42 r">cpp</span>.<a href="CommandLineParameterParser.cs.html#f4fce703679e867a" class="i property">NoPrompt</a>;
                <a href="#9579865b1d1857cb" class="i field">ui</a>.<a href="ConsoleHostUserInterface.cs.html#cb46812cffc140ff" class="i property">ThrowOnReadAndPrompt</a> = <span class="r42 r">cpp</span>.<a href="CommandLineParameterParser.cs.html#4f9be7be19fef953" class="i property">ThrowOnReadAndPrompt</a>;
                <a href="#fc7c91defac6c6aa" class="i field">_noExit</a> = <span class="r42 r">cpp</span>.<a href="CommandLineParameterParser.cs.html#da1b01721c3615bb" class="i property">NoExit</a>;
 
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">UNIX</span>
                <span class="c">// See if we need to change the process-wide execution</span>
                <span class="c">// policy</span>
                <b>if</b> (!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r42 r">cpp</span>.<a href="CommandLineParameterParser.cs.html#9af05d0453660824" class="i property">ExecutionPolicy</a>))
                {
                    <a href="/System.Management.Automation/A.html#73c2048fc177fabf" class="t t">ExecutionPolicy</a> <span id="r46 rd" class="r46 r">executionPolicy</span> = <a href="/System.Management.Automation/A.html#5c234bd2337db61c" class="t t">SecuritySupport</a>.<span class="i">ParseExecutionPolicy</span>(<span class="r42 r">cpp</span>.<a href="CommandLineParameterParser.cs.html#9af05d0453660824" class="i property">ExecutionPolicy</a>);
                    <a href="/System.Management.Automation/A.html#5c234bd2337db61c" class="t t">SecuritySupport</a>.<span class="i">SetExecutionPolicy</span>(<a href="/System.Management.Automation/A.html#a2a8c6696f673043" class="t t">ExecutionPolicyScope</a>.<a href="/System.Management.Automation/A.html#0b046bc9f6673ceb" class="i field">Process</a>, <span class="r46 r">executionPolicy</span>, <b>null</b>);
                }
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
 
                <span class="c">// If the debug pipe name was specified, create the custom IPC channel.</span>
                <b>if</b> (!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r42 r">cpp</span>.<a href="CommandLineParameterParser.cs.html#86e7cab2719bddc3" class="i property">CustomPipeName</a>))
                {
                    <a href="/System.Management.Automation/A.html#c14a08ba7cdb8bb2" class="t t">RemoteSessionNamedPipeServer</a>.<span class="i">CreateCustomNamedPipeServer</span>(<span class="r42 r">cpp</span>.<a href="CommandLineParameterParser.cs.html#86e7cab2719bddc3" class="i property">CustomPipeName</a>);
                }
 
                <span class="c">// NTRAID#Windows Out Of Band Releases-915506-2005/09/09</span>
                <span class="c">// Removed HandleUnexpectedExceptions infrastructure</span>
                <span class="r44 r">exitCode</span> = <span class="i">DoRunspaceLoop</span>(<span class="r42 r">cpp</span>.<a href="CommandLineParameterParser.cs.html#03e4079fd1301a6f" class="i property">InitialCommand</a>, <span class="r42 r">cpp</span>.<a href="CommandLineParameterParser.cs.html#d6f9d15cda0054c9" class="i property">SkipProfiles</a>, <span class="r42 r">cpp</span>.<a href="CommandLineParameterParser.cs.html#9a366abebd6747a2" class="i property">Args</a>, <span class="r42 r">cpp</span>.<a href="CommandLineParameterParser.cs.html#ccdd2a6417747f95" class="i property">StaMode</a>, <span class="r42 r">cpp</span>.<a href="CommandLineParameterParser.cs.html#c5f5a15ff218a892" class="i property">ConfigurationName</a>);
            }
            <b>while</b> (<b>false</b>);
 
            <b>return</b> <span class="r44 r">exitCode</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Loops over the Host&#39;s sole Runspace; opens the runspace, initializes it, then recycles it if the Runspace fails.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The process exit code to be returned by Main.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>private uint</b> <a id="995c080ede4df47e" href="../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">DoRunspaceLoop</a>(<b>string</b> <span id="r47 rd" class="r47 r">initialCommand</span>, <b>bool</b> <span id="r48 rd" class="r48 r">skipProfiles</span>, <span class="i">Collection</span>&lt;<a href="/System.Management.Automation/A.html#4ce3ff8da8a0f8d9" class="t t">CommandParameter</a>&gt; <span id="r49 rd" class="r49 r">initialCommandArgs</span>, <b>bool</b> <span id="r50 rd" class="r50 r">staMode</span>, <b>string</b> <span id="r51 rd" class="r51 r">configurationName</span>)
        {
            <a href="#6eabbc9b14c85676" class="i field">ExitCode</a> = <a href="#3e33bebb0392ce42" class="i field">ExitCodeSuccess</a>;
 
            <b>while</b> (!<a href="#ab61e63581cd3e32" class="i property">ShouldEndSession</a>)
            {
                <a href="#ec8d2265cb93bc42" class="t t">RunspaceCreationEventArgs</a> <span id="r52 rd" class="r52 r">args</span> = <b>new</b> <a href="#29531c768dfc5873" class="t constructor">RunspaceCreationEventArgs</a>(<span class="r47 r">initialCommand</span>, <span class="r48 r">skipProfiles</span>, <span class="r50 r">staMode</span>, <span class="r51 r">configurationName</span>, <span class="r49 r">initialCommandArgs</span>);
                <a href="#c7856db461008a85" class="i method">CreateRunspace</a>(<span class="r52 r">args</span>);
 
                <b>if</b> (<a href="#6eabbc9b14c85676" class="i field">ExitCode</a> == <a href="#86d4e95f5b29b6b8" class="i field">ExitCodeInitFailure</a>) { <b>break</b>; }
 
                <b>if</b> (!<a href="#fc7c91defac6c6aa" class="i field">_noExit</a>)
                {
                    <span class="c">// Wait for runspace to open, init, and run init script before</span>
                    <span class="c">// setting ShouldEndSession, to allow debugger to work.</span>
                    <a href="#ab61e63581cd3e32" class="i property">ShouldEndSession</a> = <b>true</b>;
                }
                <b>else</b>
                {
                    <span class="c">// Start nested prompt loop.</span>
                    <a href="#142bc6b643651235" class="i method">EnterNestedPrompt</a>();
                }
 
                <b>if</b> (<a href="#2b143329684986ff" class="i field">_setShouldExitCalled</a>)
                {
                    <a href="#6eabbc9b14c85676" class="i field">ExitCode</a> = <b>unchecked</b>((<b>uint</b>)<a href="#564645f4f83dd343" class="i field">_exitCodeFromRunspace</a>);
                }
                <b>else</b>
                {
                    <a href="Executor.cs.html#c4a69b641f3e390e" class="t t">Executor</a> <span id="r53 rd" class="r53 r">exec</span> = <b>new</b> <a href="Executor.cs.html#60b4a34d8fa00a39" class="t constructor">Executor</a>(<a href="../../P/cda5e43a29a66e53.html#cda5e43a29a66e53" class="k">this</a>, <b>false</b>, <b>false</b>);
 
                    <b>bool</b> <span id="r54 rd" class="r54 r">dollarHook</span> = <span class="r53 r">exec</span>.<a href="Executor.cs.html#cb328fd2d481ab4c" class="i method">ExecuteCommandAndGetResultAsBool</a>(<span class="s">&quot;$global:?&quot;</span>) ?? <b>false</b>;
 
                    <b>if</b> (<span class="r54 r">dollarHook</span> &amp;&amp; (<a href="#8bce7ff72e372a58" class="i field">_lastRunspaceInitializationException</a> == <b>null</b>))
                    {
                        <a href="#6eabbc9b14c85676" class="i field">ExitCode</a> = <a href="#3e33bebb0392ce42" class="i field">ExitCodeSuccess</a>;
                    }
                    <b>else</b>
                    {
                        <a href="#6eabbc9b14c85676" class="i field">ExitCode</a> = <a href="#3e33bebb0392ce42" class="i field">ExitCodeSuccess</a> | 0x1;
                    }
                }
 
                <a href="#8e1330b3ad99e179" class="i field">_runspaceRef</a>.<span class="i">Runspace</span>.<span class="i">Close</span>();
                <a href="#8e1330b3ad99e179" class="i field">_runspaceRef</a> = <b>null</b>;
 
                <b>if</b> (<span class="r50 r">staMode</span>)
                {
                    <span class="c">// don&#39;t continue the session in STA mode</span>
                    <a href="#ab61e63581cd3e32" class="i property">ShouldEndSession</a> = <b>true</b>;
                }
            }
 
            <b>return</b> <a href="#6eabbc9b14c85676" class="i field">ExitCode</a>;
        }
 
        <b>private</b> <span class="i">Exception</span> <a id="112fd9ed918c9d39" href="../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">InitializeRunspaceHelper</a>(<b>string</b> <span id="r55 rd" class="r55 r">command</span>, <a href="Executor.cs.html#c4a69b641f3e390e" class="t t">Executor</a> <span id="r56 rd" class="r56 r">exec</span>, <a href="Executor.cs.html#c4a69b641f3e390e" class="t t">Executor</a>.<a href="Executor.cs.html#358f021732ebaa99" class="t t">ExecutionOptions</a> <span id="r57 rd" class="r57 r">options</span>)
        {
            <a href="/System.Management.Automation/A.html#c04955255430d32f" class="t t">Dbg</a>.<span class="i">Assert</span>(!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r55 r">command</span>), <span class="s">&quot;command should have a value&quot;</span>);
            <a href="/System.Management.Automation/A.html#c04955255430d32f" class="t t">Dbg</a>.<span class="i">Assert</span>(<span class="r56 r">exec</span> != <b>null</b>, <span class="s">&quot;non-null Executor instance needed&quot;</span>);
 
            <a href="#eaeace8ff695e418" class="i field">s_runspaceInitTracer</a>.<span class="i">WriteLine</span>(<span class="s">&quot;running command {0}&quot;</span>, <span class="r55 r">command</span>);
 
            <span class="i">Exception</span> <span id="r58 rd" class="r58 r">e</span> = <b>null</b>;
 
            <b>if</b> (<a href="#3aff0a908296b7f4" class="i property">IsRunningAsync</a>)
            {
                <span class="r56 r">exec</span>.<a href="Executor.cs.html#9b0c70493a8c714d" class="i method">ExecuteCommandAsync</a>(<span class="r55 r">command</span>, <b>out</b> <span class="r58 r">e</span>, <span class="r57 r">options</span>);
            }
            <b>else</b>
            {
                <span class="r56 r">exec</span>.<a href="Executor.cs.html#48bc1dbfcd4f0d92" class="i method">ExecuteCommand</a>(<span class="r55 r">command</span>, <b>out</b> <span class="r58 r">e</span>, <span class="r57 r">options</span>);
            }
 
            <b>if</b> (<span class="r58 r">e</span> != <b>null</b>)
            {
                <a href="#c37ffda789fa5b0c" class="i method">ReportException</a>(<span class="r58 r">e</span>, <span class="r56 r">exec</span>);
            }
 
            <b>return</b> <span class="r58 r">e</span>;
        }
 
        <b>private void</b> <a id="c7856db461008a85" href="../../R/c7856db461008a85.html" target="n" data-glyph="76,1" class="i method">CreateRunspace</a>(<b>object</b> <span id="r59 rd" class="r59 r">runspaceCreationArgs</span>)
        {
            <a href="#ec8d2265cb93bc42" class="t t">RunspaceCreationEventArgs</a> <span id="r60 rd" class="r60 r">args</span> = <b>null</b>;
            <b>try</b>
            {
                <span class="r60 r">args</span> = <span class="r59 r">runspaceCreationArgs</span> <b>as</b> <a href="#ec8d2265cb93bc42" class="t t">RunspaceCreationEventArgs</a>;
                <a href="/System.Management.Automation/A.html#c04955255430d32f" class="t t">Dbg</a>.<span class="i">Assert</span>(<span class="r60 r">args</span> != <b>null</b>, <span class="s">&quot;Event Arguments to CreateRunspace should not be null&quot;</span>);
                <a href="#f531a1bf5511fda8" class="i method">DoCreateRunspace</a>(<span class="r60 r">args</span>.<a href="#5ce015d0d7accc35" class="i property">InitialCommand</a>, <span class="r60 r">args</span>.<a href="#40d9845b255f1059" class="i property">SkipProfiles</a>, <span class="r60 r">args</span>.<a href="#28a1df3e792cae37" class="i property">StaMode</a>, <span class="r60 r">args</span>.<a href="#84fb7db354406250" class="i property">ConfigurationName</a>, <span class="r60 r">args</span>.<a href="#daf6576ddbea39d9" class="i property">InitialCommandArgs</a>);
            }
            <b>catch</b> (<a href="#5ac508b1baf9a55f" class="t t">ConsoleHostStartupException</a> <span id="r61 rd" class="r61 r">startupException</span>)
            {
                <span class="i">ReportExceptionFallback</span>(<span class="r61 r">startupException</span>.<span class="i">InnerException</span>, <span class="r61 r">startupException</span>.<span class="i">Message</span>);
                <a href="#6eabbc9b14c85676" class="i field">ExitCode</a> = <a href="#86d4e95f5b29b6b8" class="i field">ExitCodeInitFailure</a>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Check if a screen reviewer utility is running.</span>
        <span class="c">///</span><span class="c"> When a screen reader is running, we don&#39;t auto-load the PSReadLine module at startup,</span>
        <span class="c">///</span><span class="c"> since PSReadLine is not accessibility-firendly enough as of today.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private bool</b> <a id="35e6d6459e2f1f48" href="../../R/35e6d6459e2f1f48.html" target="n" data-glyph="76,1" class="i method">IsScreenReaderActive</a>()
        {
            <b>if</b> (<a href="#e48b6838e2fca4e8" class="i field">_screenReaderActive</a>.<span class="i">HasValue</span>)
            {
                <b>return</b> <a href="#e48b6838e2fca4e8" class="i field">_screenReaderActive</a>.<span class="i">Value</span>;
            }
 
            <a href="#e48b6838e2fca4e8" class="i field">_screenReaderActive</a> = <b>false</b>;
            <b>if</b> (<a href="/System.Management.Automation/A.html#693813241122eb45" class="t t">Platform</a>.<a href="/System.Management.Automation/A.html#527d8835d493a8d0" class="i property">IsWindowsDesktop</a>)
            {
                <span class="c">// Note: this API can detect if a third-party screen reader is active, such as NVDA, but not the in-box Windows Narrator.</span>
                <span class="c">// Quoted from https://docs.microsoft.com/windows/win32/api/winuser/nf-winuser-systemparametersinfoa about the</span>
                <span class="c">// accessibility parameter &#39;SPI_GETSCREENREADER&#39;:</span>
                <span class="c">// &quot;Narrator, the screen reader that is included with Windows, does not set the SPI_SETSCREENREADER or SPI_GETSCREENREADER flags.&quot;</span>
                <b>bool</b> <span id="r62 rd" class="r62 r">enabled</span> = <b>false</b>;
                <b>if</b> (<a href="#f7d551a7289f5e05" class="i method">SystemParametersInfo</a>(<a href="#6b851b8c7a53fda6" class="i field">SPI_GETSCREENREADER</a>, 0, <b>ref</b> <span class="r62 r">enabled</span>, 0))
                {
                    <a href="#e48b6838e2fca4e8" class="i field">_screenReaderActive</a> = <span class="r62 r">enabled</span>;
                }
            }
 
            <b>return</b> <a href="#e48b6838e2fca4e8" class="i field">_screenReaderActive</a>.<span class="i">Value</span>;
        }
 
        <b>private static bool</b> <a id="f1bcf8bc2690f523" href="../../R/f1bcf8bc2690f523.html" target="n" data-glyph="76,1" class="i method">LoadPSReadline</a>()
        {
            <span class="c">// Don&#39;t load PSReadline if:</span>
            <span class="c">//   * we don&#39;t think the process will be interactive, e.g. -command or -file</span>
            <span class="c">//     - exception: when -noexit is specified, we will be interactive after the command/file finishes</span>
            <span class="c">//   * -noninteractive: this should be obvious, they&#39;ve asked that we don&#39;t ever prompt</span>
            <span class="c">//</span>
            <span class="c">// Note that PSReadline doesn&#39;t support redirected stdin/stdout, but we don&#39;t check that here because</span>
            <span class="c">// a future version might, and we should automatically load it at that unknown point in the future.</span>
            <span class="c">// PSReadline will ideally fall back to Console.ReadLine or whatever when stdin/stdout is redirected.</span>
            <b>return</b> ((<a href="#43bd20a0a6b88977" class="i field">s_cpp</a>.<a href="CommandLineParameterParser.cs.html#03e4079fd1301a6f" class="i property">InitialCommand</a> == <b>null</b> &amp;&amp; <a href="#43bd20a0a6b88977" class="i field">s_cpp</a>.<a href="CommandLineParameterParser.cs.html#34cd1698822fe6e0" class="i property">File</a> == <b>null</b>) || <a href="#43bd20a0a6b88977" class="i field">s_cpp</a>.<a href="CommandLineParameterParser.cs.html#da1b01721c3615bb" class="i property">NoExit</a>) &amp;&amp; !<a href="#43bd20a0a6b88977" class="i field">s_cpp</a>.<a href="CommandLineParameterParser.cs.html#20444cbb354c0a21" class="i property">NonInteractive</a>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Opens and Initializes the Host&#39;s sole Runspace.  Processes the startup scripts and runs any command passed on the</span>
        <span class="c">///</span><span class="c"> command line.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private void</b> <a id="f531a1bf5511fda8" href="../../R/f531a1bf5511fda8.html" target="n" data-glyph="76,1" class="i method">DoCreateRunspace</a>(<b>string</b> <span id="r63 rd" class="r63 r">initialCommand</span>, <b>bool</b> <span id="r64 rd" class="r64 r">skipProfiles</span>, <b>bool</b> <span id="r65 rd" class="r65 r">staMode</span>, <b>string</b> <span id="r66 rd" class="r66 r">configurationName</span>, <span class="i">Collection</span>&lt;<a href="/System.Management.Automation/A.html#4ce3ff8da8a0f8d9" class="t t">CommandParameter</a>&gt; <span id="r67 rd" class="r67 r">initialCommandArgs</span>)
        {
            <a href="/System.Management.Automation/A.html#c04955255430d32f" class="t t">Dbg</a>.<span class="i">Assert</span>(<a href="#8e1330b3ad99e179" class="i field">_runspaceRef</a> == <b>null</b>, <span class="s">&quot;runspace should be null&quot;</span>);
            <a href="/System.Management.Automation/A.html#c04955255430d32f" class="t t">Dbg</a>.<span class="i">Assert</span>(<a href="#f5fac40895dd209a" class="i field">DefaultInitialSessionState</a> != <b>null</b>, <span class="s">&quot;DefaultInitialSessionState should not be null&quot;</span>);
            <a href="#eaeace8ff695e418" class="i field">s_runspaceInitTracer</a>.<span class="i">WriteLine</span>(<span class="s">&quot;Calling RunspaceFactory.CreateRunspace&quot;</span>);
 
            <b>try</b>
            {
                <a href="/System.Management.Automation/A.html#7e5b8eab1aa16fd7" class="t t">Runspace</a> <span id="r68 rd" class="r68 r">consoleRunspace</span> = <b>null</b>;
                <b>bool</b> <span id="r69 rd" class="r69 r">psReadlineFailed</span> = <b>false</b>;
 
                <span class="c">// Load PSReadline by default unless there is no use:</span>
                <span class="c">//    - screen reader is active, such as NVDA, indicating non-visual access</span>
                <span class="c">//    - we&#39;re running a command/file and just exiting</span>
                <span class="c">//    - stdin is redirected by a parent process</span>
                <span class="c">//    - we&#39;re not interactive</span>
                <span class="c">//    - we&#39;re explicitly reading from stdin (the &#39;-&#39; argument)</span>
                <span class="c">// It&#39;s also important to have a scenario where PSReadline is not loaded so it can be updated, e.g.</span>
                <span class="c">//    powershell -command &quot;Update-Module PSReadline&quot;</span>
                <span class="c">// This should work just fine as long as no other instances of PowerShell are running.</span>
                <span class="i">ReadOnlyCollection</span>&lt;<a href="/System.Management.Automation/A.html#1fd961b021940b6a" class="t t">ModuleSpecification</a>&gt; <span id="r70 rd" class="r70 r">defaultImportModulesList</span> = <b>null</b>;
                <b>if</b> (<a href="#f1bcf8bc2690f523" class="i method">LoadPSReadline</a>())
                {
                    <b>if</b> (<a href="#35e6d6459e2f1f48" class="i method">IsScreenReaderActive</a>())
                    {
                        <a href="#7eceed901a882a5f" class="i field">s_theConsoleHost</a>.<a href="#991bf1f27a36f054" class="i property">UI</a>.<span class="i">WriteLine</span>(<span class="i">ManagedEntranceStrings</span>.<span class="i">PSReadLineDisabledWhenScreenReaderIsActive</span>);
                        <a href="#7eceed901a882a5f" class="i field">s_theConsoleHost</a>.<a href="#991bf1f27a36f054" class="i property">UI</a>.<span class="i">WriteLine</span>();
                    }
                    <b>else</b>
                    {
                        <span class="c">// Create and open Runspace with PSReadline.</span>
                        <span class="r70 r">defaultImportModulesList</span> = <a href="#f5fac40895dd209a" class="i field">DefaultInitialSessionState</a>.<a href="/System.Management.Automation/A.html#13bb2417a9e5277e" class="i property">Modules</a>;
                        <a href="#f5fac40895dd209a" class="i field">DefaultInitialSessionState</a>.<span class="i">ImportPSModule</span>(<b>new</b>[] { <span class="s">&quot;PSReadLine&quot;</span> });
                        <span class="r68 r">consoleRunspace</span> = <a href="/System.Management.Automation/A.html#c5fbe142e4e21218" class="t t">RunspaceFactory</a>.<a href="/System.Management.Automation/A.html#5099763308995719" class="i method">CreateRunspace</a>(<a href="../../P/cda5e43a29a66e53.html#cda5e43a29a66e53" class="k">this</a>, <a href="#f5fac40895dd209a" class="i field">DefaultInitialSessionState</a>);
                        <b>try</b>
                        {
                            <a href="#5ddb5ad3a6ca8970" class="i method">OpenConsoleRunspace</a>(<span class="r68 r">consoleRunspace</span>, <span class="r65 r">staMode</span>);
                        }
                        <b>catch</b> (<span class="i">Exception</span>)
                        {
                            <span class="r68 r">consoleRunspace</span> = <b>null</b>;
                            <span class="r69 r">psReadlineFailed</span> = <b>true</b>;
                        }
                    }
                }
 
                <b>if</b> (<span class="r68 r">consoleRunspace</span> == <b>null</b>)
                {
                    <b>if</b> (<span class="r69 r">psReadlineFailed</span>)
                    {
                        <span class="c">// Try again but without importing the PSReadline module.</span>
                        <a href="#f5fac40895dd209a" class="i field">DefaultInitialSessionState</a>.<span class="i">ClearPSModules</span>();
                        <a href="#f5fac40895dd209a" class="i field">DefaultInitialSessionState</a>.<span class="i">ImportPSModule</span>(<span class="r70 r">defaultImportModulesList</span>);
                    }
 
                    <span class="r68 r">consoleRunspace</span> = <a href="/System.Management.Automation/A.html#c5fbe142e4e21218" class="t t">RunspaceFactory</a>.<a href="/System.Management.Automation/A.html#5099763308995719" class="i method">CreateRunspace</a>(<a href="../../P/cda5e43a29a66e53.html#cda5e43a29a66e53" class="k">this</a>, <a href="#f5fac40895dd209a" class="i field">DefaultInitialSessionState</a>);
                    <a href="#5ddb5ad3a6ca8970" class="i method">OpenConsoleRunspace</a>(<span class="r68 r">consoleRunspace</span>, <span class="r65 r">staMode</span>);
                }
 
                <a href="#392ae36c563f0bce" class="i property">Runspace</a>.<span class="i">PrimaryRunspace</span> = <span class="r68 r">consoleRunspace</span>;
                <a href="#8e1330b3ad99e179" class="i field">_runspaceRef</a> = <b>new</b> <span class="i">RunspaceRef</span>(<span class="r68 r">consoleRunspace</span>);
 
                <b>if</b> (<span class="r69 r">psReadlineFailed</span>)
                {
                    <span class="c">// Notify the user that PSReadline could not be loaded.</span>
                    <span class="i">Console</span>.<span class="i">Error</span>.<span class="i">WriteLine</span>(<span class="i">ConsoleHostStrings</span>.<span class="i">CannotLoadPSReadline</span>);
                }
            }
            <b>catch</b> (<span class="i">Exception</span> <span id="r71 rd" class="r71 r">e</span>)
            {
                <span class="c">// no need to do CheckForSevereException here</span>
                <span class="c">// since the ConsoleHostStartupException is uncaught</span>
                <span class="c">// higher in the call stack and the whole process</span>
                <span class="c">// will exit soon</span>
                <b>throw</b> <b>new</b> <span class="t">ConsoleHostStartupException</span>(<span class="i">ConsoleHostStrings</span>.<span class="i">ShellCannotBeStarted</span>, <span class="r71 r">e</span>);
            }
            <b>finally</b>
            {
                <span class="c">// Stop PerfTrack</span>
                <span class="i">PSEtwLog</span>.<span class="i">LogOperationalInformation</span>(<span class="i">PSEventId</span>.<span class="i">Perftrack_ConsoleStartupStop</span>, <span class="i">PSOpcode</span>.<span class="i">WinStop</span>,
                                                   <span class="i">PSTask</span>.<span class="i">PowershellConsoleStartup</span>, <span class="i">PSKeyword</span>.<span class="i">UseAlwaysOperational</span>);
            }
 
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">LEGACYTELEMETRY</span>
<span class="e">            // Record how long it took from process start to runspace open for telemetry.
            _readyForInputTimeInMS = (DateTime.Now - Process.GetCurrentProcess().StartTime).TotalMilliseconds;
</span><span class="k preprocess">#</span><span class="k preprocess">endif</span>
 
            <a href="#2da33c9e20e0dc4a" class="i method">DoRunspaceInitialization</a>(<span class="r64 r">skipProfiles</span>, <span class="r63 r">initialCommand</span>, <span class="r66 r">configurationName</span>, <span class="r67 r">initialCommandArgs</span>);
        }
 
        <b>private static void</b> <a id="5ddb5ad3a6ca8970" href="../../R/5ddb5ad3a6ca8970.html" target="n" data-glyph="76,1" class="i method">OpenConsoleRunspace</a>(<a href="/System.Management.Automation/A.html#7e5b8eab1aa16fd7" class="t t">Runspace</a> <span id="r72 rd" class="r72 r">runspace</span>, <b>bool</b> <span id="r73 rd" class="r73 r">staMode</span>)
        {
            <b>if</b> (<span class="r73 r">staMode</span> &amp;&amp; <a href="/System.Management.Automation/A.html#693813241122eb45" class="t t">Platform</a>.<a href="/System.Management.Automation/A.html#527d8835d493a8d0" class="i property">IsWindowsDesktop</a>)
            {
                <span class="r72 r">runspace</span>.<a href="/System.Management.Automation/A.html#7483ec8556438ee9" class="i property">ApartmentState</a> = <span class="i">ApartmentState</span>.<span class="i">STA</span>;
            }
 
            <span class="r72 r">runspace</span>.<span class="i">ThreadOptions</span> = <a href="/System.Management.Automation/A.html#e3e452d2492397a5" class="t t">PSThreadOptions</a>.<a href="/System.Management.Automation/A.html#d11fc99ab087227d" class="i field">ReuseThread</a>;
            <span class="r72 r">runspace</span>.<span class="i">EngineActivityId</span> = <a href="/System.Management.Automation/A.html#f0b7f321c8221b4f" class="t t">EtwActivity</a>.<span class="i">GetActivityId</span>();
 
            <a href="#eaeace8ff695e418" class="i field">s_runspaceInitTracer</a>.<span class="i">WriteLine</span>(<span class="s">&quot;Calling Runspace.Open&quot;</span>);
            <span class="r72 r">runspace</span>.<span class="i">Open</span>();
        }
 
        <b>private void</b> <a id="2da33c9e20e0dc4a" href="../../R/2da33c9e20e0dc4a.html" target="n" data-glyph="76,1" class="i method">DoRunspaceInitialization</a>(<b>bool</b> <span id="r74 rd" class="r74 r">skipProfiles</span>, <b>string</b> <span id="r75 rd" class="r75 r">initialCommand</span>, <b>string</b> <span id="r76 rd" class="r76 r">configurationName</span>, <span class="i">Collection</span>&lt;<a href="/System.Management.Automation/A.html#4ce3ff8da8a0f8d9" class="t t">CommandParameter</a>&gt; <span id="r77 rd" class="r77 r">initialCommandArgs</span>)
        {
            <b>if</b> (<a href="#8e1330b3ad99e179" class="i field">_runspaceRef</a>.<span class="i">Runspace</span>.<span class="i">Debugger</span> != <b>null</b>)
            {
                <a href="#8e1330b3ad99e179" class="i field">_runspaceRef</a>.<span class="i">Runspace</span>.<span class="i">Debugger</span>.<span class="i">SetDebugMode</span>(<a href="/System.Management.Automation/A.html#7e71da719f103cfd" class="t t">DebugModes</a>.<a href="/System.Management.Automation/A.html#8f7455ad81a2c081" class="i field">LocalScript</a> | <a href="/System.Management.Automation/A.html#7e71da719f103cfd" class="t t">DebugModes</a>.<a href="/System.Management.Automation/A.html#36492991f477f6e1" class="i field">RemoteScript</a>);
                <a href="#8e1330b3ad99e179" class="i field">_runspaceRef</a>.<span class="i">Runspace</span>.<span class="i">Debugger</span>.<span class="i">DebuggerStop</span> += <a href="../../P/cda5e43a29a66e53.html#cda5e43a29a66e53" class="k">this</a>.<span class="i">OnExecutionSuspended</span>;
            }
 
            <a href="Executor.cs.html#c4a69b641f3e390e" class="t t">Executor</a> <span id="r78 rd" class="r78 r">exec</span> = <b>new</b> <a href="Executor.cs.html#60b4a34d8fa00a39" class="t constructor">Executor</a>(<a href="../../P/cda5e43a29a66e53.html#cda5e43a29a66e53" class="k">this</a>, <b>false</b>, <b>false</b>);
 
            <span class="c">// If working directory was specified, set it</span>
            <b>if</b> (<a href="#43bd20a0a6b88977" class="i field">s_cpp</a> != <b>null</b> &amp;&amp; <a href="#43bd20a0a6b88977" class="i field">s_cpp</a>.<a href="CommandLineParameterParser.cs.html#71f2d9cf077930c3" class="i property">WorkingDirectory</a> != <b>null</b>)
            {
                <a href="/System.Management.Automation/A.html#c607964c20793ea5" class="t t">Pipeline</a> <span id="r79 rd" class="r79 r">tempPipeline</span> = <span class="r78 r">exec</span>.<a href="Executor.cs.html#d41c5d6e35a066b1" class="i method">CreatePipeline</a>();
                <a href="/System.Management.Automation/A.html#b55b68a3bf75e612" class="k">var</a> <span id="r80 rd" class="r80 r">command</span> = <b>new</b> <span class="t">Command</span>(<span class="s">&quot;Set-Location&quot;</span>);
                <span class="r80 r">command</span>.<a href="/System.Management.Automation/A.html#ba1074ca05aadff5" class="i property">Parameters</a>.<span class="i">Add</span>(<span class="s">&quot;LiteralPath&quot;</span>, <a href="#43bd20a0a6b88977" class="i field">s_cpp</a>.<a href="CommandLineParameterParser.cs.html#71f2d9cf077930c3" class="i property">WorkingDirectory</a>);
                <span class="r79 r">tempPipeline</span>.<a href="/System.Management.Automation/A.html#55623b34b6a2a65a" class="i property">Commands</a>.<span class="i">Add</span>(<span class="r80 r">command</span>);
 
                <span class="i">Exception</span> <span id="r81 rd" class="r81 r">exception</span>;
                <b>if</b> (<a href="#3aff0a908296b7f4" class="i property">IsRunningAsync</a>)
                {
                    <span class="r78 r">exec</span>.<a href="Executor.cs.html#765418ab1ad41344" class="i method">ExecuteCommandAsyncHelper</a>(<span class="r79 r">tempPipeline</span>, <b>out</b> <span class="r81 r">exception</span>, <a href="Executor.cs.html#c4a69b641f3e390e" class="t t">Executor</a>.<a href="Executor.cs.html#358f021732ebaa99" class="t t">ExecutionOptions</a>.<a href="Executor.cs.html#8f28a9f5599c4384" class="i field">AddOutputter</a>);
                }
                <b>else</b>
                {
                    <span class="r78 r">exec</span>.<a href="Executor.cs.html#8252224d94665896" class="i method">ExecuteCommandHelper</a>(<span class="r79 r">tempPipeline</span>, <b>out</b> <span class="r81 r">exception</span>, <a href="Executor.cs.html#c4a69b641f3e390e" class="t t">Executor</a>.<a href="Executor.cs.html#358f021732ebaa99" class="t t">ExecutionOptions</a>.<a href="Executor.cs.html#8f28a9f5599c4384" class="i field">AddOutputter</a>);
                }
 
                <b>if</b> (<span class="r81 r">exception</span> != <b>null</b>)
                {
                    <a href="#8bce7ff72e372a58" class="i field">_lastRunspaceInitializationException</a> = <span class="r81 r">exception</span>;
                    <a href="#c37ffda789fa5b0c" class="i method">ReportException</a>(<span class="r81 r">exception</span>, <span class="r78 r">exec</span>);
                }
            }
 
            <b>if</b> (!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r76 r">configurationName</span>))
            {
                <span class="c">// If an endpoint configuration is specified then create a loop-back remote runspace targeting</span>
                <span class="c">// the endpoint and push onto runspace ref stack.  Ignore profile and configuration scripts.</span>
                <b>try</b>
                {
                    <span class="i">RemoteRunspace</span> <span id="r82 rd" class="r82 r">remoteRunspace</span> = <a href="/System.Management.Automation/A.html#38cb736539b5d994" class="t t">HostUtilities</a>.<span class="i">CreateConfiguredRunspace</span>(<span class="r76 r">configurationName</span>, <a href="../../P/cda5e43a29a66e53.html#cda5e43a29a66e53" class="k">this</a>);
                    <span class="r82 r">remoteRunspace</span>.<span class="i">ShouldCloseOnPop</span> = <b>true</b>;
                    <span class="i">PushRunspace</span>(<span class="r82 r">remoteRunspace</span>);
 
                    <span class="c">// Ensure that session ends when configured remote runspace is popped.</span>
                    <a href="#4df2325754acd4f9" class="i field">_inPushedConfiguredSession</a> = <b>true</b>;
                }
                <b>catch</b> (<span class="i">Exception</span> <span id="r83 rd" class="r83 r">e</span>)
                {
                    <b>throw</b> <b>new</b> <span class="t">ConsoleHostStartupException</span>(<span class="i">ConsoleHostStrings</span>.<span class="i">ShellCannotBeStarted</span>, <span class="r83 r">e</span>);
                }
            }
            <b>else</b>
            {
                <b>const string</b> <span id="r84 rd" class="r84 r">shellId</span> = <span class="s">&quot;Microsoft.PowerShell&quot;</span>;
 
                <span class="c">// If the system lockdown policy says &quot;Enforce&quot;, do so. Do this after types / formatting, default functions, etc</span>
                <span class="c">// are loaded so that they are trusted. (Validation of their signatures is done in F&amp;O)</span>
                <span class="i">Utils</span>.<span class="i">EnforceSystemLockDownLanguageMode</span>(<a href="#8e1330b3ad99e179" class="i field">_runspaceRef</a>.<span class="i">Runspace</span>.<span class="i">ExecutionContext</span>);
 
                <b>string</b> <span id="r85 rd" class="r85 r">allUsersProfile</span> = <a href="/System.Management.Automation/A.html#38cb736539b5d994" class="t t">HostUtilities</a>.<span class="i">GetFullProfileFileName</span>(<b>null</b>, <b>false</b>);
                <b>string</b> <span id="r86 rd" class="r86 r">allUsersHostSpecificProfile</span> = <a href="/System.Management.Automation/A.html#38cb736539b5d994" class="t t">HostUtilities</a>.<span class="i">GetFullProfileFileName</span>(<span class="r84 r">shellId</span>, <b>false</b>);
                <b>string</b> <span id="r87 rd" class="r87 r">currentUserProfile</span> = <a href="/System.Management.Automation/A.html#38cb736539b5d994" class="t t">HostUtilities</a>.<span class="i">GetFullProfileFileName</span>(<b>null</b>, <b>true</b>);
                <b>string</b> <span id="r88 rd" class="r88 r">currentUserHostSpecificProfile</span> = <a href="/System.Management.Automation/A.html#38cb736539b5d994" class="t t">HostUtilities</a>.<span class="i">GetFullProfileFileName</span>(<span class="r84 r">shellId</span>, <b>true</b>);
 
                <span class="c">// $PROFILE has to be set from the host</span>
                <span class="c">// Should be &quot;per-user,host-specific profile.ps1&quot;</span>
                <span class="c">// This should be set even if -noprofile is specified</span>
                <a href="#8e1330b3ad99e179" class="i field">_runspaceRef</a>.<span class="i">Runspace</span>.<span class="i">SessionStateProxy</span>.<span class="i">SetVariable</span>(<span class="s">&quot;PROFILE&quot;</span>,
                    <a href="/System.Management.Automation/A.html#38cb736539b5d994" class="t t">HostUtilities</a>.<span class="i">GetDollarProfile</span>(
                        <span class="r85 r">allUsersProfile</span>,
                        <span class="r86 r">allUsersHostSpecificProfile</span>,
                        <span class="r87 r">currentUserProfile</span>,
                        <span class="r88 r">currentUserHostSpecificProfile</span>));
 
                <b>if</b> (!<span class="r74 r">skipProfiles</span>)
                {
                    <span class="c">// Run the profiles.</span>
                    <span class="c">// Profiles are run in the following order:</span>
                    <span class="c">// 1. host independent profile meant for all users</span>
                    <span class="c">// 2. host specific profile meant for all users</span>
                    <span class="c">// 3. host independent profile of the current user</span>
                    <span class="c">// 4. host specific profile of the current user</span>
 
                    <b>var</b> <span id="r89 rd" class="r89 r">sw</span> = <b>new</b> <span class="i">Stopwatch</span>();
                    <span class="r89 r">sw</span>.<span class="i">Start</span>();
                    <a href="#7a9b195ebc02cdf4" class="i method">RunProfile</a>(<span class="r85 r">allUsersProfile</span>, <span class="r78 r">exec</span>);
                    <a href="#7a9b195ebc02cdf4" class="i method">RunProfile</a>(<span class="r86 r">allUsersHostSpecificProfile</span>, <span class="r78 r">exec</span>);
                    <a href="#7a9b195ebc02cdf4" class="i method">RunProfile</a>(<span class="r87 r">currentUserProfile</span>, <span class="r78 r">exec</span>);
                    <a href="#7a9b195ebc02cdf4" class="i method">RunProfile</a>(<span class="r88 r">currentUserHostSpecificProfile</span>, <span class="r78 r">exec</span>);
                    <span class="r89 r">sw</span>.<span class="i">Stop</span>();
 
                    <b>var</b> <span id="r90 rd" class="r90 r">profileLoadTimeInMs</span> = <span class="r89 r">sw</span>.<span class="i">ElapsedMilliseconds</span>;
                    <b>if</b> (<span class="r90 r">profileLoadTimeInMs</span> &gt; 500 &amp;&amp; <a href="#43bd20a0a6b88977" class="i field">s_cpp</a>.<a href="CommandLineParameterParser.cs.html#b890f565ffab47db" class="i property">ShowBanner</a>)
                    {
                        <span class="i">Console</span>.<span class="i">Error</span>.<span class="i">WriteLine</span>(<span class="i">ConsoleHostStrings</span>.<span class="i">SlowProfileLoadingMessage</span>, <span class="r90 r">profileLoadTimeInMs</span>);
                    }
 
                    <a href="#1b36d89c3104ef64" class="i field">_profileLoadTimeInMS</a> = <span class="r90 r">profileLoadTimeInMs</span>;
                }
                <b>else</b>
                {
                    <a href="#19a35abc23dbcc28" class="i field">s_tracer</a>.<span class="i">WriteLine</span>(<span class="s">&quot;-noprofile option specified: skipping profiles&quot;</span>);
                }
            }
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">LEGACYTELEMETRY</span>
<span class="e">            // Startup is reported after possibly running the profile, but before running the initial command (or file)
            // if one is specified.
            TelemetryAPI.ReportStartupTelemetry(this);
</span><span class="k preprocess">#</span><span class="k preprocess">endif</span>
 
            <span class="c">// If a file was specified as the argument to run, then run it...</span>
            <b>if</b> (<a href="#43bd20a0a6b88977" class="i field">s_cpp</a> != <b>null</b> &amp;&amp; <a href="#43bd20a0a6b88977" class="i field">s_cpp</a>.<a href="CommandLineParameterParser.cs.html#34cd1698822fe6e0" class="i property">File</a> != <b>null</b>)
            {
                <b>string</b> <span id="r91 rd" class="r91 r">filePath</span> = <a href="#43bd20a0a6b88977" class="i field">s_cpp</a>.<a href="CommandLineParameterParser.cs.html#34cd1698822fe6e0" class="i property">File</a>;
 
                <a href="#19a35abc23dbcc28" class="i field">s_tracer</a>.<span class="i">WriteLine</span>(<span class="s">&quot;running -file &#39;{0}&#39;&quot;</span>, <span class="r91 r">filePath</span>);
 
                <a href="/System.Management.Automation/A.html#c607964c20793ea5" class="t t">Pipeline</a> <span id="r92 rd" class="r92 r">tempPipeline</span> = <span class="r78 r">exec</span>.<a href="Executor.cs.html#d41c5d6e35a066b1" class="i method">CreatePipeline</a>();
                <a href="/System.Management.Automation/A.html#b55b68a3bf75e612" class="t t">Command</a> <span id="r93 rd" class="r93 r">c</span>;
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">UNIX</span>
<span class="e">                // if file doesn&#39;t have .ps1 extension, we read the contents and treat it as a script to support shebang with no .ps1 extension usage
                if (!filePath.EndsWith(&quot;.ps1&quot;, StringComparison.OrdinalIgnoreCase))
                {
                    string script = File.ReadAllText(filePath);
                    c = new Command(script, isScript: true, useLocalScope: false);
                }
                else
</span><span class="k preprocess">#</span><span class="k preprocess">endif</span>
                {
                    <span class="r93 r">c</span> = <b>new</b> <span class="t">Command</span>(<span class="r91 r">filePath</span>, <b>false</b>, <b>false</b>);
                }
 
                <span class="r92 r">tempPipeline</span>.<a href="/System.Management.Automation/A.html#55623b34b6a2a65a" class="i property">Commands</a>.<span class="i">Add</span>(<span class="r93 r">c</span>);
 
                <b>if</b> (<span class="r77 r">initialCommandArgs</span> != <b>null</b>)
                {
                    <span class="c">// add the args passed to the command.</span>
 
                    <b>foreach</b> (<a href="/System.Management.Automation/A.html#4ce3ff8da8a0f8d9" class="t t">CommandParameter</a> <span id="r94 rd" class="r94 r">p</span> <b>in</b> <span class="r77 r">initialCommandArgs</span>)
                    {
                        <span class="r93 r">c</span>.<a href="/System.Management.Automation/A.html#ba1074ca05aadff5" class="i property">Parameters</a>.<span class="i">Add</span>(<span class="r94 r">p</span>);
                    }
                }
 
                <span class="c">// If we&#39;re not going to continue, then get the exit code out of the runspace and</span>
                <span class="c">// and indicate that it should be returned...</span>
                <b>if</b> (!<a href="#fc7c91defac6c6aa" class="i field">_noExit</a> &amp;&amp; <a href="../../P/cda5e43a29a66e53.html#cda5e43a29a66e53" class="k">this</a>.<a href="#392ae36c563f0bce" class="i property">Runspace</a> <b>is not</b> <span class="i">RemoteRunspace</span>)
                {
                    <a href="../../P/cda5e43a29a66e53.html#cda5e43a29a66e53" class="k">this</a>.<a href="#392ae36c563f0bce" class="i property">Runspace</a>.<span class="i">ExecutionContext</span>.<span class="i">ScriptCommandProcessorShouldRethrowExit</span> = <b>true</b>;
                }
 
                <span class="i">Exception</span> <span id="r95 rd" class="r95 r">e1</span>;
 
                <b>if</b> (<a href="#3aff0a908296b7f4" class="i property">IsRunningAsync</a>)
                {
                    <a href="Executor.cs.html#c4a69b641f3e390e" class="t t">Executor</a>.<a href="Executor.cs.html#358f021732ebaa99" class="t t">ExecutionOptions</a> <span id="r96 rd" class="r96 r">executionOptions</span> = <a href="Executor.cs.html#c4a69b641f3e390e" class="t t">Executor</a>.<a href="Executor.cs.html#358f021732ebaa99" class="t t">ExecutionOptions</a>.<a href="Executor.cs.html#8f28a9f5599c4384" class="i field">AddOutputter</a>;
 
                    <a href="/System.Management.Automation/A.html#ec5d9ac6a36d920c" class="t t">Token</a>[] <span id="r97 rd" class="r97 r">tokens</span>;
                    <a href="/System.Management.Automation/A.html#3b2ee49e322daa35" class="t t">ParseError</a>[] <span id="r98 rd" class="r98 r">errors</span>;
 
                    <span class="c">// Detect if they&#39;re using input. If so, read from it.</span>
                    <a href="/System.Management.Automation/A.html#d47621d83efd14de" class="t t">Ast</a> <span id="r99 rd" class="r99 r">parsedInput</span> = <a href="/System.Management.Automation/A.html#bbf5e856fb3215c5" class="t t">Parser</a>.<span class="i">ParseFile</span>(<span class="r91 r">filePath</span>, <b>out</b> <span class="r97 r">tokens</span>, <b>out</b> <span class="r98 r">errors</span>);
                    <b>if</b> (<span class="i">AstSearcher</span>.<span class="i">IsUsingDollarInput</span>(<span class="r99 r">parsedInput</span>))
                    {
                        <span class="r96 r">executionOptions</span> |= <a href="Executor.cs.html#c4a69b641f3e390e" class="t t">Executor</a>.<a href="Executor.cs.html#358f021732ebaa99" class="t t">ExecutionOptions</a>.<a href="Executor.cs.html#052ca21a155ed613" class="i field">ReadInputObjects</a>;
 
                        <span class="c">// We will consume all of the input to pass to the script, so don&#39;t try to read commands from stdin.</span>
                        <a href="#9579865b1d1857cb" class="i field">ui</a>.<a href="ConsoleHostUserInterface.cs.html#96bef84efdae9634" class="i property">ReadFromStdin</a> = <b>false</b>;
                    }
 
                    <span class="r78 r">exec</span>.<a href="Executor.cs.html#765418ab1ad41344" class="i method">ExecuteCommandAsyncHelper</a>(<span class="r92 r">tempPipeline</span>, <b>out</b> <span class="r95 r">e1</span>, <span class="r96 r">executionOptions</span>);
                }
                <b>else</b>
                {
                    <span class="r78 r">exec</span>.<a href="Executor.cs.html#8252224d94665896" class="i method">ExecuteCommandHelper</a>(<span class="r92 r">tempPipeline</span>, <b>out</b> <span class="r95 r">e1</span>, <a href="Executor.cs.html#c4a69b641f3e390e" class="t t">Executor</a>.<a href="Executor.cs.html#358f021732ebaa99" class="t t">ExecutionOptions</a>.<a href="Executor.cs.html#8f28a9f5599c4384" class="i field">AddOutputter</a>);
                }
 
                <span class="c">// Pipeline.Invoke has thrown, that&#39;s bad. It means the script did not actually</span>
                <span class="c">// execute properly. These exceptions should be reflected in the exit code</span>
                <b>if</b> (<span class="r95 r">e1</span> != <b>null</b>)
                {
                    <b>if</b> (!<a href="#fc7c91defac6c6aa" class="i field">_noExit</a>)
                    {
                        <span class="c">// Set ExitCode to 0x1</span>
                        <b>lock</b> (<a href="#55f653f715aa2431" class="i field">hostGlobalLock</a>)
                        {
                            <a href="#2b143329684986ff" class="i field">_setShouldExitCalled</a> = <b>true</b>;
                            <a href="#564645f4f83dd343" class="i field">_exitCodeFromRunspace</a> = 0x1;
                            <a href="#ab61e63581cd3e32" class="i property">ShouldEndSession</a> = <b>true</b>;
                        }
                    }
 
                    <a href="#c37ffda789fa5b0c" class="i method">ReportException</a>(<span class="r95 r">e1</span>, <span class="r78 r">exec</span>);
                }
            }
            <b>else</b> <b>if</b> (!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r75 r">initialCommand</span>))
            {
                <span class="c">// Run the command passed on the command line</span>
 
                <a href="#19a35abc23dbcc28" class="i field">s_tracer</a>.<span class="i">WriteLine</span>(<span class="s">&quot;running initial command&quot;</span>);
 
                <a href="/System.Management.Automation/A.html#c607964c20793ea5" class="t t">Pipeline</a> <span id="r100 rd" class="r100 r">tempPipeline</span> = <span class="r78 r">exec</span>.<a href="Executor.cs.html#17982cb03d3d9f6b" class="i method">CreatePipeline</a>(<span class="r75 r">initialCommand</span>, <b>true</b>);
 
                <b>if</b> (<span class="r77 r">initialCommandArgs</span> != <b>null</b>)
                {
                    <span class="c">// add the args passed to the command.</span>
 
                    <b>foreach</b> (<a href="/System.Management.Automation/A.html#4ce3ff8da8a0f8d9" class="t t">CommandParameter</a> <span id="r101 rd" class="r101 r">p</span> <b>in</b> <span class="r77 r">initialCommandArgs</span>)
                    {
                        <span class="r100 r">tempPipeline</span>.<a href="/System.Management.Automation/A.html#55623b34b6a2a65a" class="i property">Commands</a>[0].<span class="i">Parameters</span>.<span class="i">Add</span>(<span class="r101 r">p</span>);
                    }
                }
 
                <span class="i">Exception</span> <span id="r102 rd" class="r102 r">e1</span>;
 
                <b>if</b> (<a href="#3aff0a908296b7f4" class="i property">IsRunningAsync</a>)
                {
                    <a href="Executor.cs.html#c4a69b641f3e390e" class="t t">Executor</a>.<a href="Executor.cs.html#358f021732ebaa99" class="t t">ExecutionOptions</a> <span id="r103 rd" class="r103 r">executionOptions</span> = <a href="Executor.cs.html#c4a69b641f3e390e" class="t t">Executor</a>.<a href="Executor.cs.html#358f021732ebaa99" class="t t">ExecutionOptions</a>.<a href="Executor.cs.html#8f28a9f5599c4384" class="i field">AddOutputter</a>;
 
                    <a href="/System.Management.Automation/A.html#ec5d9ac6a36d920c" class="t t">Token</a>[] <span id="r104 rd" class="r104 r">tokens</span>;
                    <a href="/System.Management.Automation/A.html#3b2ee49e322daa35" class="t t">ParseError</a>[] <span id="r105 rd" class="r105 r">errors</span>;
 
                    <span class="c">// Detect if they&#39;re using input. If so, read from it.</span>
                    <a href="/System.Management.Automation/A.html#d47621d83efd14de" class="t t">Ast</a> <span id="r106 rd" class="r106 r">parsedInput</span> = <a href="/System.Management.Automation/A.html#bbf5e856fb3215c5" class="t t">Parser</a>.<span class="i">ParseInput</span>(<span class="r75 r">initialCommand</span>, <b>out</b> <span class="r104 r">tokens</span>, <b>out</b> <span class="r105 r">errors</span>);
                    <b>if</b> (<span class="i">AstSearcher</span>.<span class="i">IsUsingDollarInput</span>(<span class="r106 r">parsedInput</span>))
                    {
                        <span class="r103 r">executionOptions</span> |= <a href="Executor.cs.html#c4a69b641f3e390e" class="t t">Executor</a>.<a href="Executor.cs.html#358f021732ebaa99" class="t t">ExecutionOptions</a>.<a href="Executor.cs.html#052ca21a155ed613" class="i field">ReadInputObjects</a>;
 
                        <span class="c">// We will consume all of the input to pass to the script, so don&#39;t try to read commands from stdin.</span>
                        <a href="#9579865b1d1857cb" class="i field">ui</a>.<a href="ConsoleHostUserInterface.cs.html#96bef84efdae9634" class="i property">ReadFromStdin</a> = <b>false</b>;
                    }
 
                    <span class="r78 r">exec</span>.<a href="Executor.cs.html#765418ab1ad41344" class="i method">ExecuteCommandAsyncHelper</a>(<span class="r100 r">tempPipeline</span>, <b>out</b> <span class="r102 r">e1</span>, <span class="r103 r">executionOptions</span>);
                }
                <b>else</b>
                {
                    <span class="r78 r">exec</span>.<a href="Executor.cs.html#8252224d94665896" class="i method">ExecuteCommandHelper</a>(<span class="r100 r">tempPipeline</span>, <b>out</b> <span class="r102 r">e1</span>, <a href="Executor.cs.html#c4a69b641f3e390e" class="t t">Executor</a>.<a href="Executor.cs.html#358f021732ebaa99" class="t t">ExecutionOptions</a>.<a href="Executor.cs.html#8f28a9f5599c4384" class="i field">AddOutputter</a>);
                }
 
                <b>if</b> (<span class="r102 r">e1</span> != <b>null</b>)
                {
                    <span class="c">// Remember last exception</span>
                    <a href="#8bce7ff72e372a58" class="i field">_lastRunspaceInitializationException</a> = <span class="r102 r">e1</span>;
                    <a href="#c37ffda789fa5b0c" class="i method">ReportException</a>(<span class="r102 r">e1</span>, <span class="r78 r">exec</span>);
                }
            }
        }
 
        <b>private void</b> <a id="7a9b195ebc02cdf4" href="../../R/7a9b195ebc02cdf4.html" target="n" data-glyph="76,1" class="i method">RunProfile</a>(<b>string</b> <span id="r107 rd" class="r107 r">profileFileName</span>, <a href="Executor.cs.html#c4a69b641f3e390e" class="t t">Executor</a> <span id="r108 rd" class="r108 r">exec</span>)
        {
            <b>if</b> (!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r107 r">profileFileName</span>))
            {
                <a href="#eaeace8ff695e418" class="i field">s_runspaceInitTracer</a>.<span class="i">WriteLine</span>(<span class="s">&quot;checking profile&quot;</span> + <span class="r107 r">profileFileName</span>);
 
                <b>try</b>
                {
                    <b>if</b> (<span class="i">File</span>.<span class="i">Exists</span>(<span class="r107 r">profileFileName</span>))
                    {
                        <span class="i">InitializeRunspaceHelper</span>(
                            <span class="s">&quot;. &#39;&quot;</span> + <a href="#8785b7e515b64b41" class="i method">EscapeSingleQuotes</a>(<span class="r107 r">profileFileName</span>) + <span class="s">&quot;&#39;&quot;</span>,
                            <span class="r108 r">exec</span>,
                            <a href="Executor.cs.html#c4a69b641f3e390e" class="t t">Executor</a>.<a href="Executor.cs.html#358f021732ebaa99" class="t t">ExecutionOptions</a>.<a href="Executor.cs.html#8f28a9f5599c4384" class="i field">AddOutputter</a>);
                    }
                    <b>else</b>
                    {
                        <a href="#eaeace8ff695e418" class="i field">s_runspaceInitTracer</a>.<span class="i">WriteLine</span>(<span class="s">&quot;profile file not found&quot;</span>);
                    }
                }
                <b>catch</b> (<span class="i">Exception</span> <span id="r109 rd" class="r109 r">e</span>) <span class="c">// Catch-all OK, 3rd party callout</span>
                {
                    <a href="#c37ffda789fa5b0c" class="i method">ReportException</a>(<span class="r109 r">e</span>, <span class="r108 r">exec</span>);
 
                    <a href="#eaeace8ff695e418" class="i field">s_runspaceInitTracer</a>.<span class="i">WriteLine</span>(<span class="s">&quot;Could not load profile.&quot;</span>);
                }
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Escapes backtick and tick characters with a backtick, returns the result.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r110 r">str</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal static string</b> <a id="8785b7e515b64b41" href="../../R/8785b7e515b64b41.html" target="n" data-glyph="74,1" class="i method">EscapeSingleQuotes</a>(<b>string</b> <span id="r110 rd" class="r110 r">str</span>)
        {
            <span class="c">// worst case we have to escape every character, so capacity is twice as large as input length</span>
            <span class="i">StringBuilder</span> <span id="r111 rd" class="r111 r">sb</span> = <b>new</b> <span class="i">StringBuilder</span>(<span class="r110 r">str</span>.<span class="i">Length</span> * 2);
 
            <b>for</b> (<b>int</b> <span id="r112 rd" class="r112 r">i</span> = 0; <span class="r112 r">i</span> &lt; <span class="r110 r">str</span>.<span class="i">Length</span>; ++<span class="r112 r">i</span>)
            {
                <b>char</b> <span id="r113 rd" class="r113 r">c</span> = <span class="r110 r">str</span>[<span class="r112 r">i</span>];
                <b>if</b> (<span class="r113 r">c</span> == <span class="s">&#39;\&#39;&#39;</span>)
                {
                    <span class="r111 r">sb</span>.<span class="i">Append</span>(<span class="r113 r">c</span>);
                }
 
                <span class="r111 r">sb</span>.<span class="i">Append</span>(<span class="r113 r">c</span>);
            }
 
            <b>string</b> <span id="r114 rd" class="r114 r">result</span> = <span class="r111 r">sb</span>.<span class="i">ToString</span>();
 
            <b>return</b> <span class="r114 r">result</span>;
        }
 
        <b>private void</b> <a id="1bacca9fb6c62ed2" href="../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">WriteErrorLine</a>(<b>string</b> <span id="r115 rd" class="r115 r">line</span>)
        {
            <b>const</b> <span class="i">ConsoleColor</span> <span id="r116 rd" class="r116 r">fg</span> = <span class="i">ConsoleColor</span>.<span class="i">Red</span>;
            <span class="i">ConsoleColor</span> <span id="r117 rd" class="r117 r">bg</span> = <a href="#991bf1f27a36f054" class="i property">UI</a>.<a href="/System.Management.Automation/A.html#9f0fd1e53edb6283" class="i property">RawUI</a>.<a href="/System.Management.Automation/A.html#e2891a44a8939f10" class="i property">BackgroundColor</a>;
 
            <a href="#991bf1f27a36f054" class="i property">UI</a>.<span class="i">WriteLine</span>(<span class="r116 r">fg</span>, <span class="r117 r">bg</span>, <span class="r115 r">line</span>);
        }
 
        <span class="c">// NTRAID#Windows Out Of Band Releases-915506-2005/09/09</span>
        <span class="c">// Removed HandleUnexpectedExceptions infrastructure</span>
        <b>private void</b> <a id="c37ffda789fa5b0c" href="../../R/c37ffda789fa5b0c.html" target="n" data-glyph="76,1" class="i method">ReportException</a>(<span class="i">Exception</span> <span id="r118 rd" class="r118 r">e</span>, <a href="Executor.cs.html#c4a69b641f3e390e" class="t t">Executor</a> <span id="r119 rd" class="r119 r">exec</span>)
        {
            <a href="/System.Management.Automation/A.html#c04955255430d32f" class="t t">Dbg</a>.<span class="i">Assert</span>(<span class="r118 r">e</span> != <b>null</b>, <span class="s">&quot;must supply an Exception&quot;</span>);
            <a href="/System.Management.Automation/A.html#c04955255430d32f" class="t t">Dbg</a>.<span class="i">Assert</span>(<span class="r119 r">exec</span> != <b>null</b>, <span class="s">&quot;must supply an Executor&quot;</span>);
 
            <span class="c">// NTRAID#Windows Out Of Band Releases-915506-2005/09/09</span>
            <span class="c">// Removed HandleUnexpectedExceptions infrastructure</span>
 
            <span class="c">// Attempt to write the exception into the error stream so that the normal F&amp;O machinery will</span>
            <span class="c">// display it according to preferences.</span>
 
            <b>object</b> <span id="r120 rd" class="r120 r">error</span> = <b>null</b>;
            <a href="/System.Management.Automation/A.html#c607964c20793ea5" class="t t">Pipeline</a> <span id="r121 rd" class="r121 r">tempPipeline</span> = <span class="r119 r">exec</span>.<a href="Executor.cs.html#d41c5d6e35a066b1" class="i method">CreatePipeline</a>();
 
            <span class="c">// NTRAID#Windows OS Bugs-1143621-2005/04/08-sburns</span>
 
            <a href="/System.Management.Automation/A.html#2d342e12f9600886" class="t t">IContainsErrorRecord</a> <span id="r122 rd" class="r122 r">icer</span> = <span class="r118 r">e</span> <b>as</b> <a href="/System.Management.Automation/A.html#2d342e12f9600886" class="t t">IContainsErrorRecord</a>;
 
            <b>if</b> (<span class="r122 r">icer</span> != <b>null</b>)
            {
                <span class="r120 r">error</span> = <span class="r122 r">icer</span>.<a href="/System.Management.Automation/A.html#cef340f272a30c6b" class="i property">ErrorRecord</a>;
            }
            <b>else</b>
            {
                <span class="r120 r">error</span> = (<b>object</b>)<b>new</b> <span class="t">ErrorRecord</span>(<span class="r118 r">e</span>, <span class="s">&quot;ConsoleHost.ReportException&quot;</span>, <a href="/System.Management.Automation/A.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="/System.Management.Automation/A.html#707bbec7a1bb5ead" class="i field">NotSpecified</a>, <b>null</b>);
            }
 
            <a href="/System.Management.Automation/A.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r123 rd" class="r123 r">wrappedError</span> = <b>new</b> <span class="t">PSObject</span>(<span class="r120 r">error</span>)
            {
                <span class="i">WriteStream</span> = <span class="i">WriteStreamType</span>.<span class="i">Error</span>
            };
 
            <span class="i">Exception</span> <span id="r124 rd" class="r124 r">e1</span> = <b>null</b>;
 
            <span class="r121 r">tempPipeline</span>.<a href="/System.Management.Automation/A.html#fc605284c85d0dc9" class="i property">Input</a>.<span class="i">Write</span>(<span class="r123 r">wrappedError</span>);
            <b>if</b> (<a href="#3aff0a908296b7f4" class="i property">IsRunningAsync</a>)
            {
                <span class="r119 r">exec</span>.<a href="Executor.cs.html#765418ab1ad41344" class="i method">ExecuteCommandAsyncHelper</a>(<span class="r121 r">tempPipeline</span>, <b>out</b> <span class="r124 r">e1</span>, <a href="Executor.cs.html#c4a69b641f3e390e" class="t t">Executor</a>.<a href="Executor.cs.html#358f021732ebaa99" class="t t">ExecutionOptions</a>.<a href="Executor.cs.html#8f28a9f5599c4384" class="i field">AddOutputter</a>);
            }
            <b>else</b>
            {
                <span class="r119 r">exec</span>.<a href="Executor.cs.html#8252224d94665896" class="i method">ExecuteCommandHelper</a>(<span class="r121 r">tempPipeline</span>, <b>out</b> <span class="r124 r">e1</span>, <a href="Executor.cs.html#c4a69b641f3e390e" class="t t">Executor</a>.<a href="Executor.cs.html#358f021732ebaa99" class="t t">ExecutionOptions</a>.<a href="Executor.cs.html#8f28a9f5599c4384" class="i field">AddOutputter</a>);
            }
 
            <b>if</b> (<span class="r124 r">e1</span> != <b>null</b>)
            {
                <span class="c">// that didn&#39;t work.  Write out the error ourselves as a last resort.</span>
 
                <a href="#d2803288c063c732" class="i method">ReportExceptionFallback</a>(<span class="r118 r">e</span>, <b>null</b>);
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Reports an exception according to the exception reporting settings in effect.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r125 r">e</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The exception to report.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r126 r">header</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Optional header message.  Empty or null means &quot;no header&quot;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>private void</b> <a id="d2803288c063c732" href="../../R/d2803288c063c732.html" target="n" data-glyph="76,1" class="i method">ReportExceptionFallback</a>(<span class="i">Exception</span> <span id="r125 rd" class="r125 r">e</span>, <b>string</b> <span id="r126 rd" class="r126 r">header</span>)
        {
            <b>if</b> (!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r126 r">header</span>))
            {
                <span class="i">Console</span>.<span class="i">Error</span>.<span class="i">WriteLine</span>(<span class="r126 r">header</span>);
            }
 
            <b>if</b> (<span class="r125 r">e</span> == <b>null</b>)
            {
                <b>return</b>;
            }
 
            <span class="c">// See if the exception has an error record attached to it...</span>
            <a href="/System.Management.Automation/A.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r127 rd" class="r127 r">er</span> = <b>null</b>;
            <a href="/System.Management.Automation/A.html#2d342e12f9600886" class="t t">IContainsErrorRecord</a> <span id="r128 rd" class="r128 r">icer</span> = <span class="r125 r">e</span> <b>as</b> <a href="/System.Management.Automation/A.html#2d342e12f9600886" class="t t">IContainsErrorRecord</a>;
            <b>if</b> (<span class="r128 r">icer</span> != <b>null</b>)
                <span class="r127 r">er</span> = <span class="r128 r">icer</span>.<a href="/System.Management.Automation/A.html#cef340f272a30c6b" class="i property">ErrorRecord</a>;
 
            <b>if</b> (<span class="r125 r">e</span> <b>is</b> <a href="/System.Management.Automation/A.html#0bb8687f97d91059" class="t t">PSRemotingTransportException</a>)
            {
                <span class="c">// For remoting errors use full fidelity error writer.</span>
                <a href="#991bf1f27a36f054" class="i property">UI</a>.<span class="i">WriteErrorLine</span>(<span class="r125 r">e</span>.<span class="i">Message</span>);
            }
            <b>else</b> <b>if</b> (<span class="r125 r">e</span> <b>is</b> <span class="i">TargetInvocationException</span>)
            {
                <span class="i">Console</span>.<span class="i">Error</span>.<span class="i">WriteLine</span>(<span class="r125 r">e</span>.<span class="i">InnerException</span>.<span class="i">Message</span>);
            }
            <b>else</b>
            {
                <span class="i">Console</span>.<span class="i">Error</span>.<span class="i">WriteLine</span>(<span class="r125 r">e</span>.<span class="i">Message</span>);
            }
 
            <span class="c">// Add the position message for the error if it&#39;s available.</span>
            <b>if</b> (<span class="r127 r">er</span> != <b>null</b> &amp;&amp; <span class="r127 r">er</span>.<a href="/System.Management.Automation/A.html#fd1ac7b3462d4426" class="i property">InvocationInfo</a> != <b>null</b>)
                <span class="i">Console</span>.<span class="i">Error</span>.<span class="i">WriteLine</span>(<span class="r127 r">er</span>.<a href="/System.Management.Automation/A.html#fd1ac7b3462d4426" class="i property">InvocationInfo</a>.<a href="/System.Management.Automation/A.html#c6e9275e22dd1db0" class="i property">PositionMessage</a>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Raised when the host pops a runspace.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal event</b> <span class="i">EventHandler</span> <a id="0b1f987d76921772" href="../../R/0b1f987d76921772.html" target="n" data-glyph="32,1" class="i">RunspacePopped</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Raised when the host pushes a runspace.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal event</b> <span class="i">EventHandler</span> <a id="c6ede5e854e60d72" href="../../R/c6ede5e854e60d72.html" target="n" data-glyph="32,1" class="i">RunspacePushed</a>;
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> non-overrides
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> debugger
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Handler for debugger events.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private void</b> <a id="397a10aac633f385" href="../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">OnExecutionSuspended</a>(<b>object</b> <span id="r129 rd" class="r129 r">sender</span>, <a href="/System.Management.Automation/A.html#13c865e6481e16a2" class="t t">DebuggerStopEventArgs</a> <span id="r130 rd" class="r130 r">e</span>)
        {
            <span class="c">// Check local runspace internalHost to see if debugging is enabled.</span>
            <span class="i">LocalRunspace</span> <span id="r131 rd" class="r131 r">localrunspace</span> = <a href="#49ea483a58dc357d" class="i property">LocalRunspace</a>;
            <b>if</b> ((<span class="r131 r">localrunspace</span> != <b>null</b>) &amp;&amp; !<span class="r131 r">localrunspace</span>.<span class="i">ExecutionContext</span>.<span class="i">EngineHostInterface</span>.<span class="i">DebuggerEnabled</span>) { <b>return</b>; }
 
            <a href="#d363c0dc6e9e8305" class="i field">_debuggerStopEventArgs</a> = <span class="r130 r">e</span>;
            <a href="#fc2e72f9ce5a4a20" class="t t">InputLoop</a> <span id="r132 rd" class="r132 r">baseLoop</span> = <b>null</b>;
 
            <b>try</b>
            {
                <b>if</b> (<a href="../../P/cda5e43a29a66e53.html#cda5e43a29a66e53" class="k">this</a>.<a href="#a43561eac56deab3" class="i property">IsRunspacePushed</a>)
                {
                    <span class="c">// For remote debugging block data coming from the main (not-nested)</span>
                    <span class="c">// running command.</span>
                    <span class="r132 r">baseLoop</span> = <a href="#fc2e72f9ce5a4a20" class="t t">InputLoop</a>.<a href="#23605f459ba7d72e" class="i method">GetNonNestedLoop</a>();
                    <b>if</b> (<span class="r132 r">baseLoop</span> != <b>null</b>)
                    {
                        <span class="r132 r">baseLoop</span>.<a href="#5b0c8f658ea8142a" class="i method">BlockCommandOutput</a>();
                    }
                }
 
                <span class="c">//</span>
                <span class="c">// Display the banner only once per session</span>
                <span class="c">//</span>
                <b>if</b> (<a href="#44e202f47082879d" class="i field">_displayDebuggerBanner</a>)
                {
                    <span class="i">WriteDebuggerMessage</span>(<span class="i">ConsoleHostStrings</span>.<span class="i">EnteringDebugger</span>);
                    <span class="i">WriteDebuggerMessage</span>(<b>string</b>.<span class="i">Empty</span>);
                    <a href="#44e202f47082879d" class="i field">_displayDebuggerBanner</a> = <b>false</b>;
                }
 
                <span class="c">//</span>
                <span class="c">// If we hit a breakpoint output its info</span>
                <span class="c">//</span>
                <b>if</b> (<span class="r130 r">e</span>.<a href="/System.Management.Automation/A.html#745a4c67d985896b" class="i property">Breakpoints</a>.<span class="i">Count</span> &gt; 0)
                {
                    <b>string</b> <span id="r133 rd" class="r133 r">format</span> = <span class="i">ConsoleHostStrings</span>.<span class="i">HitBreakpoint</span>;
 
                    <b>foreach</b> (<a href="/System.Management.Automation/A.html#9deaac83de6a8f2c" class="t t">Breakpoint</a> <span id="r134 rd" class="r134 r">breakpoint</span> <b>in</b> <span class="r130 r">e</span>.<a href="/System.Management.Automation/A.html#745a4c67d985896b" class="i property">Breakpoints</a>)
                    {
                        <span class="i">WriteDebuggerMessage</span>(<b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">CurrentCulture</span>, <span class="r133 r">format</span>, <span class="r134 r">breakpoint</span>));
                    }
 
                    <span class="i">WriteDebuggerMessage</span>(<b>string</b>.<span class="i">Empty</span>);
                }
 
                <span class="c">//</span>
                <span class="c">// Write the source line</span>
                <span class="c">//</span>
                <b>if</b> (<span class="r130 r">e</span>.<a href="/System.Management.Automation/A.html#bf5b2fd8de78c287" class="i property">InvocationInfo</a> != <b>null</b>)
                {
                    <span class="c">//    line = StringUtil.Format(ConsoleHostStrings.DebuggerSourceCodeFormat, scriptFileName, e.InvocationInfo.ScriptLineNumber, e.InvocationInfo.Line);</span>
                    <a href="#2fcf8a19e4749179" class="i method">WriteDebuggerMessage</a>(<span class="r130 r">e</span>.<a href="/System.Management.Automation/A.html#bf5b2fd8de78c287" class="i property">InvocationInfo</a>.<a href="/System.Management.Automation/A.html#c6e9275e22dd1db0" class="i property">PositionMessage</a>);
                }
 
                <span class="c">//</span>
                <span class="c">// Start the debug mode</span>
                <span class="c">//</span>
                <a href="#baaded27ccb3847f" class="i method">EnterDebugMode</a>();
            }
            <b>finally</b>
            {
                <a href="#d363c0dc6e9e8305" class="i field">_debuggerStopEventArgs</a> = <b>null</b>;
                <b>if</b> (<span class="r132 r">baseLoop</span> != <b>null</b>)
                {
                    <span class="r132 r">baseLoop</span>.<a href="#7e14690ea4b335a2" class="i method">ResumeCommandOutput</a>();
                }
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Returns true if the host is in debug mode.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private bool</b> <a id="5c77214aa34523a4" href="../../R/5c77214aa34523a4.html" target="n" data-glyph="106,1" class="i property">InDebugMode</a> { <b>get</b>; <b>set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> True when debugger command is user and available</span>
        <span class="c">///</span><span class="c"> for stopping.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal bool</b> <a id="069a6e14ef665629" href="../../R/069a6e14ef665629.html" target="n" data-glyph="104,1" class="i property">DebuggerCanStopCommand</a>
        {
            <b>get</b>;
            <b>set</b>;
        }
 
        <b>private</b> <span class="i">Exception</span> <a id="8bce7ff72e372a58" href="../../R/8bce7ff72e372a58.html" target="n" data-glyph="46,1" class="i field">_lastRunspaceInitializationException</a> = <b>null</b>;
        <b>internal uint</b> <a id="6eabbc9b14c85676" href="../../R/6eabbc9b14c85676.html" target="n" data-glyph="44,1" class="i field">ExitCode</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Sets the host to debug mode and enters a nested prompt.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private void</b> <a id="baaded27ccb3847f" href="../../R/baaded27ccb3847f.html" target="n" data-glyph="76,1" class="i method">EnterDebugMode</a>()
        {
            <a href="#5c77214aa34523a4" class="i property">InDebugMode</a> = <b>true</b>;
 
            <b>try</b>
            {
                <span class="c">//</span>
                <span class="c">// Note that we need to enter the nested prompt via the InternalHost interface.</span>
                <span class="c">//</span>
 
                <span class="c">// EnterNestedPrompt must always be run on the local runspace.</span>
                <a href="/System.Management.Automation/A.html#7e5b8eab1aa16fd7" class="t t">Runspace</a> <span id="r135 rd" class="r135 r">runspace</span> = <a href="#8e1330b3ad99e179" class="i field">_runspaceRef</a>.<span class="i">OldRunspace</span> ?? <a href="../../P/cda5e43a29a66e53.html#cda5e43a29a66e53" class="k">this</a>.<a href="#3b80b4197e85d182" class="i property">RunspaceRef</a>.<span class="i">Runspace</span>;
                <span class="r135 r">runspace</span>.<span class="i">ExecutionContext</span>.<span class="i">EngineHostInterface</span>.<span class="i">EnterNestedPrompt</span>();
            }
            <b>catch</b> (<a href="/System.Management.Automation/A.html#ddab2b46a60907f3" class="t t">PSNotImplementedException</a>)
            {
                <span class="i">WriteDebuggerMessage</span>(<span class="i">ConsoleHostStrings</span>.<span class="i">SessionDoesNotSupportDebugger</span>);
            }
            <b>finally</b>
            {
                <a href="#5c77214aa34523a4" class="i property">InDebugMode</a> = <b>false</b>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Exits the debugger&#39;s nested prompt.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private void</b> <a id="133b48542f47f0e3" href="../../R/133b48542f47f0e3.html" target="n" data-glyph="76,1" class="i method">ExitDebugMode</a>(<a href="/System.Management.Automation/A.html#470618169485a70e" class="t t">DebuggerResumeAction</a> <span id="r136 rd" class="r136 r">resumeAction</span>)
        {
            <a href="#d363c0dc6e9e8305" class="i field">_debuggerStopEventArgs</a>.<span class="i">ResumeAction</span> = <span class="r136 r">resumeAction</span>;
 
            <b>try</b>
            {
                <span class="c">//</span>
                <span class="c">// Note that we need to exit the nested prompt via the InternalHost interface.</span>
                <span class="c">//</span>
 
                <span class="c">// ExitNestedPrompt must always be run on the local runspace.</span>
                <a href="/System.Management.Automation/A.html#7e5b8eab1aa16fd7" class="t t">Runspace</a> <span id="r137 rd" class="r137 r">runspace</span> = <a href="#8e1330b3ad99e179" class="i field">_runspaceRef</a>.<span class="i">OldRunspace</span> ?? <a href="../../P/cda5e43a29a66e53.html#cda5e43a29a66e53" class="k">this</a>.<a href="#3b80b4197e85d182" class="i property">RunspaceRef</a>.<span class="i">Runspace</span>;
                <span class="r137 r">runspace</span>.<span class="i">ExecutionContext</span>.<span class="i">EngineHostInterface</span>.<span class="i">ExitNestedPrompt</span>();
            }
            <b>catch</b> (<span class="i">ExitNestedPromptException</span>)
            {
                <span class="c">// ignore the exception</span>
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Writes a line using the debugger colors.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private void</b> <a id="2fcf8a19e4749179" href="../../R/2fcf8a19e4749179.html" target="n" data-glyph="76,1" class="i method">WriteDebuggerMessage</a>(<b>string</b> <span id="r138 rd" class="r138 r">line</span>)
        {
            <a href="../../P/cda5e43a29a66e53.html#cda5e43a29a66e53" class="k">this</a>.<a href="#9579865b1d1857cb" class="i field">ui</a>.<a href="ConsoleHostUserInterface.cs.html#9c3a74d382e85a6e" class="i method">WriteLine</a>(<a href="../../P/cda5e43a29a66e53.html#cda5e43a29a66e53" class="k">this</a>.<a href="#9579865b1d1857cb" class="i field">ui</a>.<a href="ConsoleHostUserInterface.cs.html#623a8c52a8294d49" class="i property">DebugForegroundColor</a>, <a href="../../P/cda5e43a29a66e53.html#cda5e43a29a66e53" class="k">this</a>.<a href="#9579865b1d1857cb" class="i field">ui</a>.<a href="ConsoleHostUserInterface.cs.html#a02228912879cb09" class="i property">DebugBackgroundColor</a>, <span class="r138 r">line</span>);
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> debugger
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> aux classes
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> InputLoop represents the prompt-input-execute loop of the interactive host.  Input loops can be nested, meaning that</span>
        <span class="c">///</span><span class="c"> one input loop can be interrupted and another started; when the second ends, the first resumes.</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> Neither this class&#39; instances nor its static data is threadsafe.  Caller is responsible for ensuring threadsafe</span>
        <span class="c">///</span><span class="c"> access.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private sealed class</b> <a id="fc2e72f9ce5a4a20" href="../../R/fc2e72f9ce5a4a20.html" target="n" data-glyph="4,1" class="t t">InputLoop</a>
        {
            <b>internal static void</b> <a id="dc3ca7fea93e7b81" href="../../R/dc3ca7fea93e7b81.html" target="n" data-glyph="74,2" class="i method">RunNewInputLoop</a>(<a href="../../P/cda5e43a29a66e53.html#cda5e43a29a66e53" class="t t">ConsoleHost</a> <span id="r139 rd" class="r139 r">parent</span>, <b>bool</b> <span id="r140 rd" class="r140 r">isNested</span>)
            {
                <span class="c">// creates an instance and adds it to the stack and starts it running.</span>
 
                <b>int</b> <span id="r141 rd" class="r141 r">stackCount</span> = <a href="#aaf6355cca674b01" class="i field">s_instanceStack</a>.<span class="i">Count</span>;
 
                <b>if</b> (<span class="r141 r">stackCount</span> == <a href="/System.Management.Automation/A.html#7b79cd90e035740e" class="t t">PSHost</a>.<span class="i">MaximumNestedPromptLevel</span>)
                {
                    <b>throw</b> <a href="/System.Management.Automation/A.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<span class="i">NewInvalidOperationException</span>(<span class="i">ConsoleHostStrings</span>.<span class="i">TooManyNestedPromptsError</span>);
                }
 
                <a href="#fc2e72f9ce5a4a20" class="t t">InputLoop</a> <span id="r142 rd" class="r142 r">il</span> = <b>new</b> <a href="#13052a34f0e6bf62" class="t constructor">InputLoop</a>(<span class="r139 r">parent</span>, <span class="r140 r">isNested</span>);
 
                <a href="#aaf6355cca674b01" class="i field">s_instanceStack</a>.<span class="i">Push</span>(<span class="r142 r">il</span>);
                <span class="r142 r">il</span>.<a href="#5d86a85b1a7b4a8d" class="i method">Run</a>(<a href="#aaf6355cca674b01" class="i field">s_instanceStack</a>.<span class="i">Count</span> &gt; 1);
 
                <span class="c">// Once the loop has finished running, remove it from the instance stack.</span>
 
                <a href="#fc2e72f9ce5a4a20" class="t t">InputLoop</a> <span id="r143 rd" class="r143 r">il2</span> = <a href="#aaf6355cca674b01" class="i field">s_instanceStack</a>.<span class="i">Pop</span>();
 
                <a href="/System.Management.Automation/A.html#c04955255430d32f" class="t t">Dbg</a>.<span class="i">Assert</span>(<span class="r142 r">il</span> == <span class="r143 r">il2</span>, <span class="s">&quot;top of instance stack does not correspond to the instance pushed&quot;</span>);
            }
 
            <span class="c">// Presently, this will not work if the Run loop is blocked on a ReadLine call.  Whether that&#39;s a</span>
            <span class="c">// problem or not depends on when we expect calls to this function to be made.</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">True if next input loop is nested, False otherwise.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">InvalidOperationException</span><span class="c">&quot;</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c">  when there is no instanceStack.Count == 0</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
            <b>internal static bool</b> <a id="a3267b96e3299fb4" href="../../R/a3267b96e3299fb4.html" target="n" data-glyph="74,2" class="i method">ExitCurrentLoop</a>()
            {
                <b>if</b> (<a href="#aaf6355cca674b01" class="i field">s_instanceStack</a>.<span class="i">Count</span> == 0)
                {
                    <b>throw</b> <a href="/System.Management.Automation/A.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<span class="i">NewInvalidOperationException</span>(<span class="i">ConsoleHostStrings</span>.<span class="i">InputExitCurrentLoopOutOfSyncError</span>);
                }
 
                <a href="#fc2e72f9ce5a4a20" class="t t">InputLoop</a> <span id="r144 rd" class="r144 r">il</span> = <a href="#aaf6355cca674b01" class="i field">s_instanceStack</a>.<span class="i">Peek</span>();
                <span class="r144 r">il</span>.<a href="#d68a084cf967fa9f" class="i field">_shouldExit</a> = <b>true</b>;
 
                <span class="c">// The main (non-nested) input loop has Count == 1,</span>
                <span class="c">// so Count == 2 is the value that indicates the next</span>
                <span class="c">// popped stack input loop is non-nested.</span>
                <b>return</b> (<a href="#aaf6355cca674b01" class="i field">s_instanceStack</a>.<span class="i">Count</span> &gt; 2);
            }
 
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> Returns current root (non-nested) loop only if there is no</span>
            <span class="c">///</span><span class="c"> nesting.  This is used *only* by the debugger for remote debugging</span>
            <span class="c">///</span><span class="c"> where data handling on the base commands needs to be blocked</span>
            <span class="c">///</span><span class="c"> during remote debug stop handling.</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
            <b>internal static</b> <a href="#fc2e72f9ce5a4a20" class="t t">InputLoop</a> <a id="23605f459ba7d72e" href="../../R/23605f459ba7d72e.html" target="n" data-glyph="74,2" class="i method">GetNonNestedLoop</a>()
            {
                <b>if</b> (<a href="#aaf6355cca674b01" class="i field">s_instanceStack</a>.<span class="i">Count</span> == 1)
                {
                    <b>return</b> <a href="#aaf6355cca674b01" class="i field">s_instanceStack</a>.<span class="i">Peek</span>();
                }
 
                <b>return</b> <b>null</b>;
            }
 
            <b>private</b> <a id="13052a34f0e6bf62" href="../../R/13052a34f0e6bf62.html" target="n" data-glyph="76,2" class="t constructor">InputLoop</a>(<a href="../../P/cda5e43a29a66e53.html#cda5e43a29a66e53" class="t t">ConsoleHost</a> <span id="r145 rd" class="r145 r">parent</span>, <b>bool</b> <span id="r146 rd" class="r146 r">isNested</span>)
            {
                <a href="#c4405fb243959b3f" class="i field">_parent</a> = <span class="r145 r">parent</span>;
                <a href="#b72067a638ecf609" class="i field">_isNested</a> = <span class="r146 r">isNested</span>;
                <a href="#c7889a061d230f67" class="i field">_isRunspacePushed</a> = <span class="r145 r">parent</span>.<a href="#a43561eac56deab3" class="i property">IsRunspacePushed</a>;
                <span class="r145 r">parent</span>.<a href="#0b1f987d76921772" class="i">RunspacePopped</a> += <span class="i">HandleRunspacePopped</span>;
                <span class="r145 r">parent</span>.<a href="#c6ede5e854e60d72" class="i">RunspacePushed</a> += <span class="i">HandleRunspacePushed</span>;
                <a href="#6c4fa0f24b14c74e" class="i field">_exec</a> = <b>new</b> <a href="Executor.cs.html#60b4a34d8fa00a39" class="t constructor">Executor</a>(<span class="r145 r">parent</span>, <span class="r146 r">isNested</span>, <b>false</b>);
                <a href="#b0d0a6de3cb11d39" class="i field">_promptExec</a> = <b>new</b> <a href="Executor.cs.html#60b4a34d8fa00a39" class="t constructor">Executor</a>(<span class="r145 r">parent</span>, <span class="r146 r">isNested</span>, <b>true</b>);
            }
 
            <b>private void</b> <a id="72a83e904e3df17f" href="../../R/../../0000000000.html" target="n" data-glyph="76,2" class="i method">HandleRunspacePushed</a>(<b>object</b> <span id="r147 rd" class="r147 r">sender</span>, <span class="i">EventArgs</span> <span id="r148 rd" class="r148 r">e</span>)
            {
                <b>lock</b> (<a href="#9eb0fca7434ef449" class="i field">_syncObject</a>)
                {
                    <a href="#c7889a061d230f67" class="i field">_isRunspacePushed</a> = <b>true</b>;
                    <a href="#8e2f75b6c3393cb5" class="i field">_runspacePopped</a> = <b>false</b>;
                }
            }
 
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> When a runspace is popped, we need to reevaluate the</span>
            <span class="c">///</span><span class="c"> prompt.</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r149 r">sender</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Sender of this event, unused.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r150 r">eventArgs</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Arguments describing this event, unused.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
            <b>private void</b> <a id="6437c0c712322513" href="../../R/../../0000000000.html" target="n" data-glyph="76,2" class="i method">HandleRunspacePopped</a>(<b>object</b> <span id="r149 rd" class="r149 r">sender</span>, <span class="i">EventArgs</span> <span id="r150 rd" class="r150 r">eventArgs</span>)
            {
                <b>lock</b> (<a href="#9eb0fca7434ef449" class="i field">_syncObject</a>)
                {
                    <a href="#c7889a061d230f67" class="i field">_isRunspacePushed</a> = <b>false</b>;
                    <a href="#8e2f75b6c3393cb5" class="i field">_runspacePopped</a> = <b>true</b>;
                }
            }
 
            <span class="c">// NTRAID#Windows Out Of Band Releases-915506-2005/09/09</span>
            <span class="c">// Removed HandleUnexpectedExceptions infrastructure</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> Evaluates the prompt, displays it, gets a command from the console, and executes it.  Repeats until the command</span>
            <span class="c">///</span><span class="c"> is &quot;exit&quot;, or until the shutdown flag is set.</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
            <b>internal void</b> <a id="5d86a85b1a7b4a8d" href="../../R/5d86a85b1a7b4a8d.html" target="n" data-glyph="74,2" class="i method">Run</a>(<b>bool</b> <span id="r151 rd" class="r151 r">inputLoopIsNested</span>)
            {
                <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Host</span>.<a href="/System.Management.Automation/A.html#3fd0cd9d58631820" class="t t">PSHostUserInterface</a> <span id="r152 rd" class="r152 r">c</span> = <a href="#c4405fb243959b3f" class="i field">_parent</a>.<a href="#991bf1f27a36f054" class="i property">UI</a>;
                <a href="../../P/b737197b2d219638.html#b737197b2d219638" class="t t">ConsoleHostUserInterface</a> <span id="r153 rd" class="r153 r">ui</span> = <span class="r152 r">c</span> <b>as</b> <a href="../../P/b737197b2d219638.html#b737197b2d219638" class="t t">ConsoleHostUserInterface</a>;
 
                <a href="/System.Management.Automation/A.html#c04955255430d32f" class="t t">Dbg</a>.<span class="i">Assert</span>(<span class="r153 r">ui</span> != <b>null</b>, <span class="s">&quot;Host.UI should return an instance.&quot;</span>);
 
                <b>bool</b> <span id="r154 rd" class="r154 r">inBlockMode</span> = <b>false</b>;
                <b>bool</b> <span id="r155 rd" class="r155 r">previousResponseWasEmpty</span> = <b>false</b>;
                <span class="i">StringBuilder</span> <span id="r156 rd" class="r156 r">inputBlock</span> = <b>new</b> <span class="i">StringBuilder</span>();
 
                <b>while</b> (!<a href="#c4405fb243959b3f" class="i field">_parent</a>.<a href="#ab61e63581cd3e32" class="i property">ShouldEndSession</a> &amp;&amp; !<a href="#d68a084cf967fa9f" class="i field">_shouldExit</a>)
                {
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">UNIX</span>
                    <b>if</b> (<span class="r153 r">ui</span>.<a href="ConsoleHostUserInterface.cs.html#5db1812edea1b244" class="i property">SupportsVirtualTerminal</a>)
                    {
                        <span class="c">// need to re-enable VT mode if it was previously enabled as native commands may have turned it off</span>
                        <span class="r153 r">ui</span>.<a href="ConsoleHostUserInterface.cs.html#5755cc7d3307e2fa" class="i method">TryTurnOnVtMode</a>();
                    }
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
 
                    <b>try</b>
                    {
                        <a href="#c4405fb243959b3f" class="i field">_parent</a>.<a href="#2c36f3a1db91c903" class="i field">_isRunningPromptLoop</a> = <b>true</b>;
 
                        <b>string</b> <span id="r157 rd" class="r157 r">prompt</span> = <b>null</b>;
                        <b>string</b> <span id="r158 rd" class="r158 r">line</span> = <b>null</b>;
 
                        <b>if</b> (!<span class="r153 r">ui</span>.<a href="ConsoleHostUserInterface.cs.html#3202c0ccb1155eb7" class="i property">NoPrompt</a>)
                        {
                            <b>if</b> (<span class="r154 r">inBlockMode</span>)
                            {
                                <span class="c">// use a special prompt that denotes block mode</span>
 
                                <span class="r157 r">prompt</span> = <span class="s">&quot;&gt;&gt; &quot;</span>;
                            }
                            <b>else</b>
                            {
                                <span class="c">// Make sure the cursor is at the start of the line - some external programs don&#39;t</span>
                                <span class="c">// write a newline, so we do that for them.</span>
                                <b>if</b> (<span class="r153 r">ui</span>.<a href="ConsoleHostUserInterface.cs.html#33b028e308b5319d" class="i property">RawUI</a>.<a href="/System.Management.Automation/A.html#1096ecedf81a22c3" class="i property">CursorPosition</a>.<a href="/System.Management.Automation/A.html#62aff8c33e5f09b9" class="i property">X</a> != 0)
                                    <span class="r153 r">ui</span>.<a href="ConsoleHostUserInterface.cs.html#53186981e97affd9" class="i method">WriteLine</a>();
 
                                <span class="c">// Evaluate any suggestions</span>
                                <b>if</b> (!<span class="r155 r">previousResponseWasEmpty</span>)
                                {
                                    <a href="#89175d3f02f5597e" class="i method">EvaluateSuggestions</a>(<span class="r153 r">ui</span>);
                                }
 
                                <span class="c">// Then output the prompt</span>
                                <b>if</b> (<a href="#c4405fb243959b3f" class="i field">_parent</a>.<a href="#5c77214aa34523a4" class="i property">InDebugMode</a>)
                                {
                                    <span class="r157 r">prompt</span> = <a href="#db080bd5d2b92869" class="i method">EvaluateDebugPrompt</a>();
                                }
 
                                <b>if</b> (<span class="r157 r">prompt</span> == <b>null</b>)
                                {
                                    <span class="r157 r">prompt</span> = <a href="#80e157f256f0c0c3" class="i method">EvaluatePrompt</a>();
                                }
                            }
 
                            <span class="r153 r">ui</span>.<a href="ConsoleHostUserInterface.cs.html#195231463f5f905d" class="i method">Write</a>(<span class="r157 r">prompt</span>);
                        }
 
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">UNIX</span>
<span class="e">                        if (c.SupportsVirtualTerminal)
                        {
                            // enable DECCKM as .NET requires cursor keys to emit VT for Console class
                            c.Write(DECCKM_ON);
                        }
</span><span class="k preprocess">#</span><span class="k preprocess">endif</span>
 
                        <span class="r155 r">previousResponseWasEmpty</span> = <b>false</b>;
                        <span class="c">// There could be a profile. So there could be a user defined custom readline command</span>
                        <span class="r158 r">line</span> = <span class="r153 r">ui</span>.<a href="ConsoleHostUserInterface.cs.html#b72e249bacf9760b" class="i method">ReadLineWithTabCompletion</a>(<a href="#6c4fa0f24b14c74e" class="i field">_exec</a>);
 
                        <span class="c">// line will be null in the case that Ctrl-C terminated the input</span>
 
                        <b>if</b> (<span class="r158 r">line</span> == <b>null</b>)
                        {
                            <span class="r155 r">previousResponseWasEmpty</span> = <b>true</b>;
 
                            <a href="#19a35abc23dbcc28" class="i field">s_tracer</a>.<span class="i">WriteLine</span>(<span class="s">&quot;line is null&quot;</span>);
                            <b>if</b> (!<span class="r153 r">ui</span>.<a href="ConsoleHostUserInterface.cs.html#96bef84efdae9634" class="i property">ReadFromStdin</a>)
                            {
                                <span class="c">// If we&#39;re not reading from stdin, the we probably got here</span>
                                <span class="c">// because the user hit ctrl-C. Do a writeline to clean up</span>
                                <span class="c">// the output...</span>
                                <span class="r153 r">ui</span>.<a href="ConsoleHostUserInterface.cs.html#53186981e97affd9" class="i method">WriteLine</a>();
                            }
 
                            <span class="r154 r">inBlockMode</span> = <b>false</b>;
 
                            <b>if</b> (<span class="i">Console</span>.<span class="i">IsInputRedirected</span>)
                            {
                                <span class="c">// null is also the result of reading stdin to EOF.</span>
                                <a href="#c4405fb243959b3f" class="i field">_parent</a>.<a href="#ab61e63581cd3e32" class="i property">ShouldEndSession</a> = <b>true</b>;
                                <b>break</b>;
                            }
 
                            <b>continue</b>;
                        }
 
                        <b>if</b> (<b>string</b>.<span class="i">IsNullOrWhiteSpace</span>(<span class="r158 r">line</span>))
                        {
                            <b>if</b> (<span class="r154 r">inBlockMode</span>)
                            {
                                <span class="c">// end block mode and execute the block accumulated block</span>
 
                                <a href="#19a35abc23dbcc28" class="i field">s_tracer</a>.<span class="i">WriteLine</span>(<span class="s">&quot;exiting block mode&quot;</span>);
                                <span class="r158 r">line</span> = <span class="r156 r">inputBlock</span>.<span class="i">ToString</span>();
                                <span class="r154 r">inBlockMode</span> = <b>false</b>;
                            }
                            <b>else</b> <b>if</b> (!<a href="#c4405fb243959b3f" class="i field">_parent</a>.<a href="#5c77214aa34523a4" class="i property">InDebugMode</a>)
                            {
                                <span class="r155 r">previousResponseWasEmpty</span> = <b>true</b>;
                                <b>continue</b>;
                            }
                        }
                        <b>else</b>
                        {
                            <b>if</b> (<span class="r154 r">inBlockMode</span>)
                            {
                                <a href="#19a35abc23dbcc28" class="i field">s_tracer</a>.<span class="i">WriteLine</span>(<span class="s">&quot;adding line to block&quot;</span>);
                                <span class="r156 r">inputBlock</span>.<span class="i">Append</span>(<span class="s">&#39;\n&#39;</span>);
                                <span class="r156 r">inputBlock</span>.<span class="i">Append</span>(<span class="r158 r">line</span>);
                                <b>continue</b>;
                            }
                        }
 
                        <a href="/System.Management.Automation/A.html#c04955255430d32f" class="t t">Dbg</a>.<span class="i">Assert</span>(<span class="r158 r">line</span> != <b>null</b>, <span class="s">&quot;line should not be null&quot;</span>);
                        <a href="/System.Management.Automation/A.html#c04955255430d32f" class="t t">Dbg</a>.<span class="i">Assert</span>(<span class="r158 r">line</span>.<span class="i">Length</span> &gt; 0 || <a href="#c4405fb243959b3f" class="i field">_parent</a>.<a href="#5c77214aa34523a4" class="i property">InDebugMode</a>, <span class="s">&quot;line should not be empty unless the host is in debug mode&quot;</span>);
                        <a href="/System.Management.Automation/A.html#c04955255430d32f" class="t t">Dbg</a>.<span class="i">Assert</span>(!<span class="r154 r">inBlockMode</span>, <span class="s">&quot;should not be in block mode at point of pipeline execution&quot;</span>);
 
                        <span class="i">Exception</span> <span id="r159 rd" class="r159 r">e</span> = <b>null</b>;
 
                        <b>if</b> (<a href="#c4405fb243959b3f" class="i field">_parent</a>.<a href="#5c77214aa34523a4" class="i property">InDebugMode</a>)
                        {
                            <a href="/System.Management.Automation/A.html#279d714bfd5743f3" class="t t">DebuggerCommandResults</a> <span id="r160 rd" class="r160 r">results</span> = <a href="#40d460d32975a16c" class="i method">ProcessDebugCommand</a>(<span class="r158 r">line</span>, <b>out</b> <span class="r159 r">e</span>);
 
                            <b>if</b> (<span class="r160 r">results</span>.<a href="/System.Management.Automation/A.html#9f60fc13442f915a" class="i property">ResumeAction</a> != <b>null</b>)
                            {
                                <a href="#c4405fb243959b3f" class="i field">_parent</a>.<span class="i">ExitDebugMode</span>(<span class="r160 r">results</span>.<a href="/System.Management.Automation/A.html#9f60fc13442f915a" class="i property">ResumeAction</a>.<span class="i">Value</span>);
                            }
 
                            <b>if</b> (<span class="r159 r">e</span> != <b>null</b>)
                            {
                                <a href="/System.Management.Automation/A.html#259a38c8b594783c" class="k">var</a> <span id="r161 rd" class="r161 r">ex</span> = <span class="r159 r">e</span> <b>as</b> <a href="/System.Management.Automation/A.html#259a38c8b594783c" class="t t">PSInvalidOperationException</a>;
                                <b>if</b> (<span class="r159 r">e</span> <b>is</b> <a href="/System.Management.Automation/A.html#0bb8687f97d91059" class="t t">PSRemotingTransportException</a> ||
                                    <span class="r159 r">e</span> <b>is</b> <a href="/System.Management.Automation/A.html#d56edc1842249736" class="t t">RemoteException</a> ||
                                    (<span class="r161 r">ex</span> != <b>null</b> &amp;&amp;
                                     <span class="r161 r">ex</span>.<a href="/System.Management.Automation/A.html#cf42d4181b27e3c1" class="i property">ErrorRecord</a> != <b>null</b> &amp;&amp;
                                     <span class="r161 r">ex</span>.<a href="/System.Management.Automation/A.html#cf42d4181b27e3c1" class="i property">ErrorRecord</a>.<a href="/System.Management.Automation/A.html#80d40f16f77d32bb" class="i property">FullyQualifiedErrorId</a>.<span class="i">Equals</span>(<span class="s">&quot;Debugger:CannotProcessCommandNotStopped&quot;</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>)))
                                {
                                    <span class="c">// Debugger session is broken.  Exit nested loop.</span>
                                    <a href="#c4405fb243959b3f" class="i field">_parent</a>.<a href="#133b48542f47f0e3" class="i method">ExitDebugMode</a>(<a href="/System.Management.Automation/A.html#470618169485a70e" class="t t">DebuggerResumeAction</a>.<a href="/System.Management.Automation/A.html#c35cb32c2ab7ed0d" class="i field">Continue</a>);
                                }
                                <b>else</b>
                                {
                                    <span class="c">// Handle incomplete parse and other errors.</span>
                                    <span class="r154 r">inBlockMode</span> = <a href="#1e45e0b0d0553f04" class="i method">HandleErrors</a>(<span class="r159 r">e</span>, <span class="r158 r">line</span>, <span class="r154 r">inBlockMode</span>, <b>ref</b> <span class="r156 r">inputBlock</span>);
                                }
                            }
 
                            <b>continue</b>;
                        }
 
                        <b>if</b> (<a href="#8e2f75b6c3393cb5" class="i field">_runspacePopped</a>)
                        {
                            <b>string</b> <span id="r162 rd" class="r162 r">msg</span> = <span class="i">StringUtil</span>.<span class="i">Format</span>(<span class="i">ConsoleHostStrings</span>.<span class="i">CommandNotExecuted</span>, <span class="r158 r">line</span>);
                            <span class="r153 r">ui</span>.<a href="ConsoleHostUserInterface.cs.html#79384cc9e45dc2ca" class="i method">WriteErrorLine</a>(<span class="r162 r">msg</span>);
                            <a href="#8e2f75b6c3393cb5" class="i field">_runspacePopped</a> = <b>false</b>;
                        }
                        <b>else</b>
                        {
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">UNIX</span>
<span class="e">                            if (c.SupportsVirtualTerminal)
                            {
                                // disable DECCKM to standard mode as applications may not expect VT for cursor keys
                                c.Write(DECCKM_OFF);
                            }
</span><span class="k preprocess">#</span><span class="k preprocess">endif</span>
 
                            <b>if</b> (<a href="#c4405fb243959b3f" class="i field">_parent</a>.<a href="#3aff0a908296b7f4" class="i property">IsRunningAsync</a> &amp;&amp; !<a href="#c4405fb243959b3f" class="i field">_parent</a>.<a href="#a0d6e5e20f7e47b4" class="i property">IsNested</a>)
                            {
                                <a href="#6c4fa0f24b14c74e" class="i field">_exec</a>.<a href="Executor.cs.html#9b0c70493a8c714d" class="i method">ExecuteCommandAsync</a>(<span class="r158 r">line</span>, <b>out</b> <span class="r159 r">e</span>, <a href="Executor.cs.html#c4a69b641f3e390e" class="t t">Executor</a>.<a href="Executor.cs.html#358f021732ebaa99" class="t t">ExecutionOptions</a>.<a href="Executor.cs.html#8f28a9f5599c4384" class="i field">AddOutputter</a> | <a href="Executor.cs.html#c4a69b641f3e390e" class="t t">Executor</a>.<a href="Executor.cs.html#358f021732ebaa99" class="t t">ExecutionOptions</a>.<a href="Executor.cs.html#0ec3b21cc66e7d88" class="i field">AddToHistory</a>);
                            }
                            <b>else</b>
                            {
                                <a href="#6c4fa0f24b14c74e" class="i field">_exec</a>.<a href="Executor.cs.html#48bc1dbfcd4f0d92" class="i method">ExecuteCommand</a>(<span class="r158 r">line</span>, <b>out</b> <span class="r159 r">e</span>, <a href="Executor.cs.html#c4a69b641f3e390e" class="t t">Executor</a>.<a href="Executor.cs.html#358f021732ebaa99" class="t t">ExecutionOptions</a>.<a href="Executor.cs.html#8f28a9f5599c4384" class="i field">AddOutputter</a> | <a href="Executor.cs.html#c4a69b641f3e390e" class="t t">Executor</a>.<a href="Executor.cs.html#358f021732ebaa99" class="t t">ExecutionOptions</a>.<a href="Executor.cs.html#0ec3b21cc66e7d88" class="i field">AddToHistory</a>);
                            }
 
                            <span class="i">Thread</span> <span id="r163 rd" class="r163 r">bht</span> = <b>null</b>;
 
                            <b>lock</b> (<a href="#c4405fb243959b3f" class="i field">_parent</a>.<a href="#55f653f715aa2431" class="i field">hostGlobalLock</a>)
                            {
                                <span class="r163 r">bht</span> = <a href="#c4405fb243959b3f" class="i field">_parent</a>.<a href="#ded7d03167f947b9" class="i field">_breakHandlerThread</a>;
                            }
 
                            <b>if</b> (<span class="r163 r">bht</span> != <b>null</b>)
                            {
                                <span class="r163 r">bht</span>.<span class="i">Join</span>();
                            }
 
                            <span class="c">// Once the pipeline has been executed, we toss any outstanding progress data and</span>
                            <span class="c">// take down the display.</span>
 
                            <span class="r153 r">ui</span>.<a href="ConsoleHostUserInterfaceProgress.cs.html#fc935a2340899864" class="i method">ResetProgress</a>();
 
                            <b>if</b> (<span class="r159 r">e</span> != <b>null</b>)
                            {
                                <span class="c">// Handle incomplete parse and other errors.</span>
                                <span class="r154 r">inBlockMode</span> = <a href="#1e45e0b0d0553f04" class="i method">HandleErrors</a>(<span class="r159 r">e</span>, <span class="r158 r">line</span>, <span class="r154 r">inBlockMode</span>, <b>ref</b> <span class="r156 r">inputBlock</span>);
 
                                <span class="c">// If a remote runspace is pushed and it is not in a good state</span>
                                <span class="c">// then pop it.</span>
                                <b>if</b> (<a href="#c7889a061d230f67" class="i field">_isRunspacePushed</a> &amp;&amp; (<a href="#c4405fb243959b3f" class="i field">_parent</a>.<a href="#392ae36c563f0bce" class="i property">Runspace</a> != <b>null</b>) &amp;&amp;
                                    ((<a href="#c4405fb243959b3f" class="i field">_parent</a>.<a href="#392ae36c563f0bce" class="i property">Runspace</a>.<a href="/System.Management.Automation/A.html#01b12fbdab6c561a" class="i property">RunspaceStateInfo</a>.<a href="/System.Management.Automation/A.html#41627f067662d11c" class="i property">State</a> != <a href="/System.Management.Automation/A.html#5da9dc65e996a685" class="t t">RunspaceState</a>.<a href="/System.Management.Automation/A.html#9a99efb0eaa3c3db" class="i field">Opened</a>) ||
                                     (<a href="#c4405fb243959b3f" class="i field">_parent</a>.<a href="#392ae36c563f0bce" class="i property">Runspace</a>.<a href="/System.Management.Automation/A.html#c8bea13c75bd3198" class="i property">RunspaceAvailability</a> != <a href="/System.Management.Automation/A.html#bd6944cab8dcc583" class="t t">RunspaceAvailability</a>.<a href="/System.Management.Automation/A.html#64bc5c5290cfb16d" class="i field">Available</a>)))
                                {
                                    <a href="#c4405fb243959b3f" class="i field">_parent</a>.<a href="#61d2e5015e80c497" class="i method">PopRunspace</a>();
                                }
                            }
 
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">LEGACYTELEMETRY</span>
<span class="e">                            if (!inBlockMode)
                                s_theConsoleHost._interactiveCommandCount += 1;
</span><span class="k preprocess">#</span><span class="k preprocess">endif</span>
                        }
                    }
                    <span class="c">// NTRAID#Windows Out Of Band Releases-915506-2005/09/09</span>
                    <span class="c">// Removed HandleUnexpectedExceptions infrastructure</span>
                    <b>finally</b>
                    {
                        <a href="#c4405fb243959b3f" class="i field">_parent</a>.<a href="#2c36f3a1db91c903" class="i field">_isRunningPromptLoop</a> = <b>false</b>;
                    }
                }
            }
 
            <b>internal void</b> <a id="5b0c8f658ea8142a" href="../../R/5b0c8f658ea8142a.html" target="n" data-glyph="74,2" class="i method">BlockCommandOutput</a>()
            {
                <span class="i">RemotePipeline</span> <span id="r164 rd" class="r164 r">rCmdPipeline</span> = <a href="#c4405fb243959b3f" class="i field">_parent</a>.<a href="#76c448234ea04c11" class="i field">runningCmd</a> <b>as</b> <span class="i">RemotePipeline</span>;
                <b>if</b> (<span class="r164 r">rCmdPipeline</span> != <b>null</b>)
                {
                    <span class="r164 r">rCmdPipeline</span>.<span class="i">DrainIncomingData</span>();
                    <span class="r164 r">rCmdPipeline</span>.<span class="i">SuspendIncomingData</span>();
                }
                <b>else</b>
                {
                    <a href="#6c4fa0f24b14c74e" class="i field">_exec</a>.<a href="Executor.cs.html#6af679ffae197454" class="i method">BlockCommandOutput</a>();
                }
            }
 
            <b>internal void</b> <a id="7e14690ea4b335a2" href="../../R/7e14690ea4b335a2.html" target="n" data-glyph="74,2" class="i method">ResumeCommandOutput</a>()
            {
                <span class="i">RemotePipeline</span> <span id="r165 rd" class="r165 r">rCmdPipeline</span> = <a href="#c4405fb243959b3f" class="i field">_parent</a>.<a href="#76c448234ea04c11" class="i field">runningCmd</a> <b>as</b> <span class="i">RemotePipeline</span>;
                <b>if</b> (<span class="r165 r">rCmdPipeline</span> != <b>null</b>)
                {
                    <span class="r165 r">rCmdPipeline</span>.<span class="i">ResumeIncomingData</span>();
                }
                <b>else</b>
                {
                    <a href="#6c4fa0f24b14c74e" class="i field">_exec</a>.<a href="Executor.cs.html#ef12ea39b5c2c7dd" class="i method">ResumeCommandOutput</a>();
                }
            }
 
            <b>private bool</b> <a id="1e45e0b0d0553f04" href="../../R/1e45e0b0d0553f04.html" target="n" data-glyph="76,2" class="i method">HandleErrors</a>(<span class="i">Exception</span> <span id="r166 rd" class="r166 r">e</span>, <b>string</b> <span id="r167 rd" class="r167 r">line</span>, <b>bool</b> <span id="r168 rd" class="r168 r">inBlockMode</span>, <b>ref</b> <span class="i">StringBuilder</span> <span id="r169 rd" class="r169 r">inputBlock</span>)
            {
                <a href="/System.Management.Automation/A.html#c04955255430d32f" class="t t">Dbg</a>.<span class="i">Assert</span>(<span class="r166 r">e</span> != <b>null</b>, <span class="s">&quot;Exception reference should not be null.&quot;</span>);
 
                <b>if</b> (<a href="#e1ec09294309b055" class="i method">IsIncompleteParseException</a>(<span class="r166 r">e</span>))
                {
                    <b>if</b> (!<span class="r168 r">inBlockMode</span>)
                    {
                        <span class="r168 r">inBlockMode</span> = <b>true</b>;
                        <span class="r169 r">inputBlock</span> = <b>new</b> <span class="i">StringBuilder</span>(<span class="r167 r">line</span>);
                    }
                    <b>else</b>
                    {
                        <span class="r169 r">inputBlock</span>.<span class="i">Append</span>(<span class="r167 r">line</span>);
                    }
                }
                <b>else</b>
                {
                    <span class="c">// an exception occurred when the command was executed.  Tell the user about it.</span>
                    <a href="#c4405fb243959b3f" class="i field">_parent</a>.<a href="#c37ffda789fa5b0c" class="i method">ReportException</a>(<span class="r166 r">e</span>, <a href="#6c4fa0f24b14c74e" class="i field">_exec</a>);
                }
 
                <b>return</b> <span class="r168 r">inBlockMode</span>;
            }
 
            <b>private</b> <a href="/System.Management.Automation/A.html#279d714bfd5743f3" class="t t">DebuggerCommandResults</a> <a id="40d460d32975a16c" href="../../R/40d460d32975a16c.html" target="n" data-glyph="76,2" class="i method">ProcessDebugCommand</a>(<b>string</b> <span id="r170 rd" class="r170 r">cmd</span>, <b>out</b> <span class="i">Exception</span> <span id="r171 rd" class="r171 r">e</span>)
            {
                <a href="/System.Management.Automation/A.html#279d714bfd5743f3" class="t t">DebuggerCommandResults</a> <span id="r172 rd" class="r172 r">results</span> = <b>null</b>;
 
                <b>try</b>
                {
                    <a href="#c4405fb243959b3f" class="i field">_parent</a>.<a href="#069a6e14ef665629" class="i property">DebuggerCanStopCommand</a> = <b>true</b>;
 
                    <span class="c">// Use PowerShell object to write streaming data to host.</span>
                    <b>using</b> (<span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="/System.Management.Automation/A.html#3d1b346df3be574c" class="t t">PowerShell</a> <span id="r173 rd" class="r173 r">ps</span> = <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="/System.Management.Automation/A.html#3d1b346df3be574c" class="t t">PowerShell</a>.<a href="/System.Management.Automation/A.html#40345bc4625ff918" class="i method">Create</a>())
                    {
                        <a href="/System.Management.Automation/A.html#ce65c0834aa6f0ea" class="t t">PSInvocationSettings</a> <span id="r174 rd" class="r174 r">settings</span> = <b>new</b> <span class="t">PSInvocationSettings</span>()
                        {
                            <span class="i">Host</span> = <a href="#c4405fb243959b3f" class="i field">_parent</a>
                        };
 
                        <a href="/System.Management.Automation/A.html#52e2b209c10ec0a4" class="t t">PSDataCollection</a>&lt;<a href="/System.Management.Automation/A.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt; <span id="r175 rd" class="r175 r">output</span> = <b>new</b> <span class="t">PSDataCollection</span>&lt;<a href="/System.Management.Automation/A.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt;();
                        <span class="r173 r">ps</span>.<span class="i">AddCommand</span>(<span class="s">&quot;Out-Default&quot;</span>);
                        <span class="i">IAsyncResult</span> <span id="r176 rd" class="r176 r">async</span> = <span class="r173 r">ps</span>.<span class="i">BeginInvoke</span>&lt;<a href="/System.Management.Automation/A.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt;(<span class="r175 r">output</span>, <span class="r174 r">settings</span>, <b>null</b>, <b>null</b>);
 
                        <span class="c">// Let debugger evaluate command and stream output data.</span>
                        <span class="r172 r">results</span> = <a href="#c4405fb243959b3f" class="i field">_parent</a>.<a href="#392ae36c563f0bce" class="i property">Runspace</a>.<a href="/System.Management.Automation/A.html#d6610640d00b19f5" class="i property">Debugger</a>.<a href="/System.Management.Automation/A.html#f752da7b39207812" class="i method">ProcessCommand</a>(
                            <b>new</b> <span class="t">PSCommand</span>(
                                <b>new</b> <span class="t">Command</span>(<span class="r170 r">cmd</span>, <b>true</b>)),
                            <span class="r175 r">output</span>);
 
                        <span class="r175 r">output</span>.<span class="i">Complete</span>();
                        <span class="r173 r">ps</span>.<span class="i">EndInvoke</span>(<span class="r176 r">async</span>);
                    }
 
                    <span class="r171 r">e</span> = <b>null</b>;
                }
                <b>catch</b> (<span class="i">Exception</span> <span id="r177 rd" class="r177 r">ex</span>)
                {
                    <span class="r171 r">e</span> = <span class="r177 r">ex</span>;
                    <span class="r172 r">results</span> = <b>new</b> <span class="t">DebuggerCommandResults</span>(<b>null</b>, <b>false</b>);
                }
                <b>finally</b>
                {
                    <a href="#c4405fb243959b3f" class="i field">_parent</a>.<a href="#069a6e14ef665629" class="i property">DebuggerCanStopCommand</a> = <b>false</b>;
                }
 
                <span class="c">// Exit debugger if command fails to evaluate.</span>
                <b>return</b> <span class="r172 r">results</span> ?? <b>new</b> <span class="t">DebuggerCommandResults</span>(<a href="/System.Management.Automation/A.html#470618169485a70e" class="t t">DebuggerResumeAction</a>.<a href="/System.Management.Automation/A.html#c35cb32c2ab7ed0d" class="i field">Continue</a>, <b>false</b>);
            }
 
            <b>private static bool</b> <a id="e1ec09294309b055" href="../../R/e1ec09294309b055.html" target="n" data-glyph="76,2" class="i method">IsIncompleteParseException</a>(<span class="i">Exception</span> <span id="r178 rd" class="r178 r">e</span>)
            {
                <span class="c">// Check e&#39;s type.</span>
                <b>if</b> (<span class="r178 r">e</span> <b>is</b> <a href="/System.Management.Automation/A.html#35541cbf972c98ee" class="t t">IncompleteParseException</a>)
                {
                    <b>return</b> <b>true</b>;
                }
 
                <span class="c">// If it is remote exception ferret out the real exception.</span>
                <a href="/System.Management.Automation/A.html#d56edc1842249736" class="t t">RemoteException</a> <span id="r179 rd" class="r179 r">remoteException</span> = <span class="r178 r">e</span> <b>as</b> <a href="/System.Management.Automation/A.html#d56edc1842249736" class="t t">RemoteException</a>;
                <b>if</b> (<span class="r179 r">remoteException</span> == <b>null</b> || <span class="r179 r">remoteException</span>.<a href="/System.Management.Automation/A.html#ae7bb0007ca4088a" class="i property">ErrorRecord</a> == <b>null</b>)
                {
                    <b>return</b> <b>false</b>;
                }
 
                <b>return</b> <span class="r179 r">remoteException</span>.<a href="/System.Management.Automation/A.html#ae7bb0007ca4088a" class="i property">ErrorRecord</a>.<a href="/System.Management.Automation/A.html#ad21d23bc150cd3b" class="i property">CategoryInfo</a>.<a href="/System.Management.Automation/A.html#fc99e636c67fec35" class="i property">Reason</a> == <b>nameof</b>(<a href="/System.Management.Automation/A.html#35541cbf972c98ee" class="t t">IncompleteParseException</a>);
            }
 
            <b>private void</b> <a id="89175d3f02f5597e" href="../../R/89175d3f02f5597e.html" target="n" data-glyph="76,2" class="i method">EvaluateSuggestions</a>(<a href="../../P/b737197b2d219638.html#b737197b2d219638" class="t t">ConsoleHostUserInterface</a> <span id="r180 rd" class="r180 r">ui</span>)
            {
                <span class="c">// Output any training suggestions</span>
                <b>try</b>
                {
                    <span class="i">List</span>&lt;<b>string</b>&gt; <span id="r181 rd" class="r181 r">suggestions</span> = <a href="/System.Management.Automation/A.html#38cb736539b5d994" class="t t">HostUtilities</a>.<span class="i">GetSuggestion</span>(<a href="#c4405fb243959b3f" class="i field">_parent</a>.<a href="#392ae36c563f0bce" class="i property">Runspace</a>);
 
                    <b>if</b> (<span class="r181 r">suggestions</span>.<span class="i">Count</span> &gt; 0)
                    {
                        <span class="r180 r">ui</span>.<a href="ConsoleHostUserInterface.cs.html#53186981e97affd9" class="i method">WriteLine</a>();
                    }
 
                    <b>bool</b> <span id="r182 rd" class="r182 r">first</span> = <b>true</b>;
                    <b>foreach</b> (<b>string</b> <span id="r183 rd" class="r183 r">suggestion</span> <b>in</b> <span class="r181 r">suggestions</span>)
                    {
                        <b>if</b> (!<span class="r182 r">first</span>)
                            <span class="r180 r">ui</span>.<a href="ConsoleHostUserInterface.cs.html#53186981e97affd9" class="i method">WriteLine</a>();
 
                        <span class="r180 r">ui</span>.<a href="ConsoleHostUserInterface.cs.html#07fd0950d75ee8ef" class="i method">WriteLine</a>(<span class="r183 r">suggestion</span>);
 
                        <span class="r182 r">first</span> = <b>false</b>;
                    }
                }
                <b>catch</b> (<a href="/System.Management.Automation/A.html#4ea179424ce76612" class="t t">TerminateException</a>)
                {
                    <span class="c">// A variable breakpoint may be hit by HostUtilities.GetSuggestion. The debugger throws TerminateExceptions to stop the execution</span>
                    <span class="c">// of the current statement; we do not want to treat these exceptions as errors.</span>
                }
                <b>catch</b> (<span class="i">Exception</span> <span id="r184 rd" class="r184 r">e</span>)
                {
                    <span class="c">// Catch-all OK. This is a third-party call-out.</span>
                    <span class="r180 r">ui</span>.<span class="i">WriteErrorLine</span>(<span class="r184 r">e</span>.<span class="i">Message</span>);
 
                    <span class="i">LocalRunspace</span> <span id="r185 rd" class="r185 r">localRunspace</span> = (<span class="i">LocalRunspace</span>)<a href="#c4405fb243959b3f" class="i field">_parent</a>.<a href="#392ae36c563f0bce" class="i property">Runspace</a>;
                    <span class="r185 r">localRunspace</span>.<span class="i">GetExecutionContext</span>.<span class="i">AppendDollarError</span>(<span class="r184 r">e</span>);
                }
            }
 
            <b>private string</b> <a id="80e157f256f0c0c3" href="../../R/80e157f256f0c0c3.html" target="n" data-glyph="76,2" class="i method">EvaluatePrompt</a>()
            {
                <span class="i">Exception</span> <span id="r186 rd" class="r186 r">unused</span> = <b>null</b>;
                <b>string</b> <span id="r187 rd" class="r187 r">promptString</span> = <a href="#b0d0a6de3cb11d39" class="i field">_promptExec</a>.<a href="Executor.cs.html#48f21f3791ff6dc0" class="i method">ExecuteCommandAndGetResultAsString</a>(<span class="s">&quot;prompt&quot;</span>, <b>out</b> <span class="r186 r">unused</span>);
 
                <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r187 r">promptString</span>))
                {
                    <span class="r187 r">promptString</span> = <span class="i">ConsoleHostStrings</span>.<span class="i">DefaultPrompt</span>;
                }
 
                <span class="c">// Check for the pushed runspace scenario.</span>
                <b>if</b> (<a href="#c7889a061d230f67" class="i field">_isRunspacePushed</a>)
                {
                    <span class="i">RemoteRunspace</span> <span id="r188 rd" class="r188 r">remoteRunspace</span> = <a href="#c4405fb243959b3f" class="i field">_parent</a>.<a href="#392ae36c563f0bce" class="i property">Runspace</a> <b>as</b> <span class="i">RemoteRunspace</span>;
                    <b>if</b> (<span class="r188 r">remoteRunspace</span> != <b>null</b>)
                    {
                        <span class="r187 r">promptString</span> = <a href="/System.Management.Automation/A.html#38cb736539b5d994" class="t t">HostUtilities</a>.<span class="i">GetRemotePrompt</span>(<span class="r188 r">remoteRunspace</span>, <span class="r187 r">promptString</span>, <a href="#c4405fb243959b3f" class="i field">_parent</a>.<a href="#4df2325754acd4f9" class="i field">_inPushedConfiguredSession</a>);
                    }
                }
                <b>else</b>
                {
                    <b>if</b> (<a href="#8e2f75b6c3393cb5" class="i field">_runspacePopped</a>)
                    {
                        <a href="#8e2f75b6c3393cb5" class="i field">_runspacePopped</a> = <b>false</b>;
                    }
                }
 
                <span class="c">// Return composed prompt string.</span>
                <b>return</b> <span class="r187 r">promptString</span>;
            }
 
            <b>private string</b> <a id="db080bd5d2b92869" href="../../R/db080bd5d2b92869.html" target="n" data-glyph="76,2" class="i method">EvaluateDebugPrompt</a>()
            {
                <a href="/System.Management.Automation/A.html#52e2b209c10ec0a4" class="t t">PSDataCollection</a>&lt;<a href="/System.Management.Automation/A.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt; <span id="r189 rd" class="r189 r">output</span> = <b>new</b> <span class="t">PSDataCollection</span>&lt;<a href="/System.Management.Automation/A.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt;();
 
                <b>try</b>
                {
                    <a href="#c4405fb243959b3f" class="i field">_parent</a>.<a href="#392ae36c563f0bce" class="i property">Runspace</a>.<a href="/System.Management.Automation/A.html#d6610640d00b19f5" class="i property">Debugger</a>.<a href="/System.Management.Automation/A.html#f752da7b39207812" class="i method">ProcessCommand</a>(
                        <b>new</b> <span class="t">PSCommand</span>(<b>new</b> <span class="t">Command</span>(<span class="s">&quot;prompt&quot;</span>)),
                        <span class="r189 r">output</span>);
                }
                <b>catch</b> (<span class="i">Exception</span> <span id="r190 rd" class="r190 r">ex</span>)
                {
                    <a href="#c4405fb243959b3f" class="i field">_parent</a>.<a href="#c37ffda789fa5b0c" class="i method">ReportException</a>(<span class="r190 r">ex</span>, <a href="#6c4fa0f24b14c74e" class="i field">_exec</a>);
                }
 
                <a href="/System.Management.Automation/A.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r191 rd" class="r191 r">prompt</span> = <span class="r189 r">output</span>.<span class="i">ReadAndRemoveAt0</span>();
                <b>string</b> <span id="r192 rd" class="r192 r">promptString</span> = (<span class="r191 r">prompt</span> != <b>null</b>) ? (<span class="r191 r">prompt</span>.<a href="/System.Management.Automation/A.html#d854d13536b70a12" class="i property">BaseObject</a> <b>as string</b>) : <b>null</b>;
                <b>if</b> (<span class="r192 r">promptString</span> != <b>null</b>)
                {
                    <span class="i">RemoteRunspace</span> <span id="r193 rd" class="r193 r">remoteRunspace</span> = <a href="#c4405fb243959b3f" class="i field">_parent</a>.<a href="#392ae36c563f0bce" class="i property">Runspace</a> <b>as</b> <span class="i">RemoteRunspace</span>;
                    <b>if</b> (<span class="r193 r">remoteRunspace</span> != <b>null</b>)
                    {
                        <span class="r192 r">promptString</span> = <a href="/System.Management.Automation/A.html#38cb736539b5d994" class="t t">HostUtilities</a>.<span class="i">GetRemotePrompt</span>(<span class="r193 r">remoteRunspace</span>, <span class="r192 r">promptString</span>, <a href="#c4405fb243959b3f" class="i field">_parent</a>.<a href="#4df2325754acd4f9" class="i field">_inPushedConfiguredSession</a>);
                    }
                }
 
                <b>return</b> <span class="r192 r">promptString</span>;
            }
 
            <b>private readonly</b> <a href="../../P/cda5e43a29a66e53.html#cda5e43a29a66e53" class="t t">ConsoleHost</a> <a id="c4405fb243959b3f" href="../../R/c4405fb243959b3f.html" target="n" data-glyph="46,2" class="i field">_parent</a>;
            <b>private readonly bool</b> <a id="b72067a638ecf609" href="../../R/b72067a638ecf609.html" target="n" data-glyph="46,2" class="i field">_isNested</a>;
            <b>private bool</b> <a id="d68a084cf967fa9f" href="../../R/d68a084cf967fa9f.html" target="n" data-glyph="46,2" class="i field">_shouldExit</a>;
            <b>private readonly</b> <a href="Executor.cs.html#c4a69b641f3e390e" class="t t">Executor</a> <a id="6c4fa0f24b14c74e" href="../../R/6c4fa0f24b14c74e.html" target="n" data-glyph="46,2" class="i field">_exec</a>;
            <b>private readonly</b> <a href="Executor.cs.html#c4a69b641f3e390e" class="t t">Executor</a> <a id="b0d0a6de3cb11d39" href="../../R/b0d0a6de3cb11d39.html" target="n" data-glyph="46,2" class="i field">_promptExec</a>;
            <b>private readonly object</b> <a id="9eb0fca7434ef449" href="../../R/9eb0fca7434ef449.html" target="n" data-glyph="46,2" class="i field">_syncObject</a> = <b>new</b> <b>object</b>();
            <b>private bool</b> <a id="c7889a061d230f67" href="../../R/c7889a061d230f67.html" target="n" data-glyph="46,2" class="i field">_isRunspacePushed</a> = <b>false</b>;
            <b>private bool</b> <a id="8e2f75b6c3393cb5" href="../../R/8e2f75b6c3393cb5.html" target="n" data-glyph="46,2" class="i field">_runspacePopped</a> = <b>false</b>;
 
            <span class="c">// The instance stack is used to keep track of which InputLoop instance should be told to exit</span>
            <span class="c">// when PSHost.ExitNestedPrompt is called.</span>
 
            <span class="c">// threadsafety guaranteed by enclosing class</span>
 
            <b>private static readonly</b> <span class="i">Stack</span>&lt;<a href="#fc2e72f9ce5a4a20" class="t t">InputLoop</a>&gt; <a id="aaf6355cca674b01" href="../../R/aaf6355cca674b01.html" target="n" data-glyph="46,2" class="i field">s_instanceStack</a> = <b>new</b> <span class="i">Stack</span>&lt;<a href="#fc2e72f9ce5a4a20" class="t t">InputLoop</a>&gt;();
        }
 
        [<span class="i">Serializable</span>]
        [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Design&quot;</span>, <span class="s">&quot;CA1064:ExceptionsShouldBePublic&quot;</span>, <span class="i">Justification</span> =
            <span class="s">&quot;This exception cannot be used outside of the console host application. It is not thrown by a library routine, only by an application.&quot;</span>)]
        <b>private sealed class</b> <a id="5ac508b1baf9a55f" href="../../R/5ac508b1baf9a55f.html" target="n" data-glyph="4,1" class="t t">ConsoleHostStartupException</a> : <span class="i">Exception</span>
        {
            <b>internal</b>
            <a id="46d83ecaa3970c39" href="../../R/../../0000000000.html" target="n" data-glyph="74,2" class="t constructor">ConsoleHostStartupException</a>()
                : <b>base</b>()
            {
            }
 
            <b>internal</b>
            <a id="08070d161de16a09" href="../../R/../../0000000000.html" target="n" data-glyph="74,2" class="t constructor">ConsoleHostStartupException</a>(<b>string</b> <span id="r194 rd" class="r194 r">message</span>)
                : <b>base</b>(<span class="r194 r">message</span>)
            {
            }
 
            <b>private</b>
            <a id="85f3097d871b8a4d" href="../../R/../../0000000000.html" target="n" data-glyph="76,2" class="t constructor">ConsoleHostStartupException</a>(
                <span class="i n">System</span>.<span class="i">Runtime</span>.<span class="i">Serialization</span>.<span class="i">SerializationInfo</span> <span id="r195 rd" class="r195 r">info</span>,
                <span class="i n">System</span>.<span class="i">Runtime</span>.<span class="i">Serialization</span>.<span class="i">StreamingContext</span> <span id="r196 rd" class="r196 r">context</span>)
                : <b>base</b>(<span class="r195 r">info</span>, <span class="r196 r">context</span>)
            {
            }
 
            <b>internal</b>
            <a id="bd7a129e0b6294f3" href="../../R/../../0000000000.html" target="n" data-glyph="74,2" class="t constructor">ConsoleHostStartupException</a>(<b>string</b> <span id="r197 rd" class="r197 r">message</span>, <span class="i">Exception</span> <span id="r198 rd" class="r198 r">innerException</span>)
                : <b>base</b>(<span class="r197 r">message</span>, <span class="r198 r">innerException</span>)
            {
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> aux classes
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> By declaring runspace as ObjectRef</span><span class="c">&amp;lt;</span><span class="c">Runspace</span><span class="c">&amp;gt;</span><span class="c"> we are able to hide the real runspace with</span>
        <span class="c">///</span><span class="c"> a remote runspace in the PushRunspace scenario. By declaring it as a mask, the variable</span>
        <span class="c">///</span><span class="c"> runspace becomes an indirect reference to the actual runspace which we can override with</span>
        <span class="c">///</span><span class="c"> a remote runspace while it is pushed. Also we can easily revert back to the original</span>
        <span class="c">///</span><span class="c"> runspace when the PopRunspace command is invoked.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private</b> <span class="i">RunspaceRef</span> <a id="8e1330b3ad99e179" href="../../R/8e1330b3ad99e179.html" target="n" data-glyph="46,1" class="i field">_runspaceRef</a>;
 
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">UNIX</span>
        <b>private</b> <span class="i">GCHandle</span> <a id="7f0525ecd3ab98b7" href="../../R/7f0525ecd3ab98b7.html" target="n" data-glyph="46,1" class="i field">breakHandlerGcHandle</a>;
 
        <span class="c">// Set to Unknown so that we avoid saving/restoring the console mode if we don&#39;t have a console.</span>
        <b>private</b> <a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#1d1eff9fb00ac8e2" class="t t">ConsoleModes</a> <a id="efee48109d746f70" href="../../R/efee48109d746f70.html" target="n" data-glyph="46,1" class="i field">_savedConsoleMode</a> = <a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#1d1eff9fb00ac8e2" class="t t">ConsoleModes</a>.<a href="ConsoleControl.cs.html#fc3ca3fb0292ebf8" class="i field">Unknown</a>;
        <b>private readonly</b> <a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#1d1eff9fb00ac8e2" class="t t">ConsoleModes</a> <a id="5520e9152dd20c82" href="../../R/5520e9152dd20c82.html" target="n" data-glyph="46,1" class="i field">_initialConsoleMode</a> = <a href="ConsoleControl.cs.html#e8b5dc8576b8da6f" class="t t">ConsoleControl</a>.<a href="ConsoleControl.cs.html#1d1eff9fb00ac8e2" class="t t">ConsoleModes</a>.<a href="ConsoleControl.cs.html#fc3ca3fb0292ebf8" class="i field">Unknown</a>;
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
        <b>private</b> <span class="i">Thread</span> <a id="ded7d03167f947b9" href="../../R/ded7d03167f947b9.html" target="n" data-glyph="46,1" class="i field">_breakHandlerThread</a>;
        <b>private bool</b> <a id="6be914d776bb5e09" href="../../R/6be914d776bb5e09.html" target="n" data-glyph="46,1" class="i field">_isDisposed</a>;
        <b>internal</b> <a href="../../P/b737197b2d219638.html#b737197b2d219638" class="t t">ConsoleHostUserInterface</a> <a id="9579865b1d1857cb" href="../../R/9579865b1d1857cb.html" target="n" data-glyph="44,1" class="i field">ui</a>;
 
        <b>internal</b> <span class="i">Lazy</span>&lt;<span class="i">TextReader</span>&gt; <a id="9849256b9c8b3593" href="../../R/9849256b9c8b3593.html" target="n" data-glyph="104,1" class="i property">ConsoleIn</a> { <b>get</b>; } = <b>new</b> <span class="i">Lazy</span>&lt;<span class="i">TextReader</span>&gt;(<b>static</b> () =&gt; <span class="i">Console</span>.<span class="i">In</span>);
 
        <b>private string</b> <a id="8c9e2618b5fc682f" href="../../R/8c9e2618b5fc682f.html" target="n" data-glyph="46,1" class="i field">_savedWindowTitle</a> = <b>string</b>.<span class="i">Empty</span>;
        <b>private readonly</b> <span class="i">Version</span> <a id="f7cbac4d85d72437" href="../../R/f7cbac4d85d72437.html" target="n" data-glyph="46,1" class="i field">_ver</a> = <a href="/System.Management.Automation/A.html#be287f9ea52b8d2f" class="t t">PSVersionInfo</a>.<a href="/System.Management.Automation/A.html#ad63365ac7690eeb" class="i property">PSVersion</a>;
        <b>private int</b> <a id="564645f4f83dd343" href="../../R/564645f4f83dd343.html" target="n" data-glyph="46,1" class="i field">_exitCodeFromRunspace</a>;
        <b>private bool</b> <a id="fc7c91defac6c6aa" href="../../R/fc7c91defac6c6aa.html" target="n" data-glyph="46,1" class="i field">_noExit</a> = <b>true</b>;
        <b>private bool</b> <a id="2b143329684986ff" href="../../R/2b143329684986ff.html" target="n" data-glyph="46,1" class="i field">_setShouldExitCalled</a>;
        <b>private bool</b> <a id="2c36f3a1db91c903" href="../../R/2c36f3a1db91c903.html" target="n" data-glyph="46,1" class="i field">_isRunningPromptLoop</a>;
        <b>private bool</b> <a id="98c78bba86bd3aba" href="../../R/98c78bba86bd3aba.html" target="n" data-glyph="46,1" class="i field">_wasInitialCommandEncoded</a>;
        <b>private bool</b>? <a id="e48b6838e2fca4e8" href="../../R/e48b6838e2fca4e8.html" target="n" data-glyph="46,1" class="i field">_screenReaderActive</a>;
 
        <span class="c">// hostGlobalLock is used to sync public method calls (in case multiple threads call into the host) and access to</span>
        <span class="c">// state that persists across method calls, like progress data. It&#39;s internal because the ui object also</span>
        <span class="c">// uses this same object.</span>
 
        <b>internal object</b> <a id="55f653f715aa2431" href="../../R/55f653f715aa2431.html" target="n" data-glyph="44,1" class="i field">hostGlobalLock</a> = <b>new</b> <b>object</b>();
 
        <span class="c">// These members are possibly accessed from multiple threads (the break handler thread, a pipeline thread, or the main</span>
        <span class="c">// thread). We use hostGlobalLock to sync access to them.</span>
 
        <b>private bool</b> <a id="d4595d95de65ba3c" href="../../R/d4595d95de65ba3c.html" target="n" data-glyph="46,1" class="i field">_shouldEndSession</a>;
        <b>private int</b> <a id="4b5d9ddd4e836311" href="../../R/4b5d9ddd4e836311.html" target="n" data-glyph="46,1" class="i field">_beginApplicationNotifyCount</a>;
 
        <b>private readonly</b> <a href="ConsoleTextWriter.cs.html#051d9aa933d9c522" class="t t">ConsoleTextWriter</a> <a id="8c66038937fbdefe" href="../../R/8c66038937fbdefe.html" target="n" data-glyph="46,1" class="i field">_consoleWriter</a>;
        <b>private</b> <a href="Serialization.cs.html#4e9b6b767ad54ab8" class="t t">WrappedSerializer</a> <a id="b68b707c6568a994" href="../../R/b68b707c6568a994.html" target="n" data-glyph="46,1" class="i field">_outputSerializer</a>;
        <b>private</b> <a href="Serialization.cs.html#4e9b6b767ad54ab8" class="t t">WrappedSerializer</a> <a id="e730d6c0ab156b4c" href="../../R/e730d6c0ab156b4c.html" target="n" data-glyph="46,1" class="i field">_errorSerializer</a>;
        <b>private bool</b> <a id="44e202f47082879d" href="../../R/44e202f47082879d.html" target="n" data-glyph="46,1" class="i field">_displayDebuggerBanner</a>;
        <b>private</b> <a href="/System.Management.Automation/A.html#13c865e6481e16a2" class="t t">DebuggerStopEventArgs</a> <a id="d363c0dc6e9e8305" href="../../R/d363c0dc6e9e8305.html" target="n" data-glyph="46,1" class="i field">_debuggerStopEventArgs</a>;
        <b>private bool</b> <a id="4df2325754acd4f9" href="../../R/4df2325754acd4f9.html" target="n" data-glyph="46,1" class="i field">_inPushedConfiguredSession</a>;
        <b>internal</b> <a href="/System.Management.Automation/A.html#c607964c20793ea5" class="t t">Pipeline</a> <a id="76c448234ea04c11" href="../../R/76c448234ea04c11.html" target="n" data-glyph="44,1" class="i field">runningCmd</a>;
 
        <span class="c">// The ConsoleHost class is a singleton.  Note that there is not a thread-safety issue with these statics as there can</span>
        <span class="c">// only be one console host per process.</span>
 
        <b>private static</b> <a href="../../P/cda5e43a29a66e53.html#cda5e43a29a66e53" class="t t">ConsoleHost</a> <a id="7eceed901a882a5f" href="../../R/7eceed901a882a5f.html" target="n" data-glyph="46,1" class="i field">s_theConsoleHost</a>;
 
        <b>internal static</b> <a href="/System.Management.Automation/A.html#b17f88d4755d5fd7" class="t t">InitialSessionState</a> <a id="f5fac40895dd209a" href="../../R/f5fac40895dd209a.html" target="n" data-glyph="44,1" class="i field">DefaultInitialSessionState</a>;
 
        [<span class="i">TraceSource</span>(<span class="s">&quot;ConsoleHost&quot;</span>, <span class="s">&quot;ConsoleHost subclass of S.M.A.PSHost&quot;</span>)]
        <b>private static readonly</b> <a href="/System.Management.Automation/A.html#6de812d1f374e1ae" class="t t">PSTraceSource</a> <a id="19a35abc23dbcc28" href="../../R/19a35abc23dbcc28.html" target="n" data-glyph="46,1" class="i field">s_tracer</a> = <a href="/System.Management.Automation/A.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<span class="i">GetTracer</span>(<span class="s">&quot;ConsoleHost&quot;</span>, <span class="s">&quot;ConsoleHost subclass of S.M.A.PSHost&quot;</span>);
 
        [<span class="i">TraceSource</span>(<span class="s">&quot;ConsoleHostRunspaceInit&quot;</span>, <span class="s">&quot;Initialization code for ConsoleHost&#39;s Runspace&quot;</span>)]
        <b>private static readonly</b> <a href="/System.Management.Automation/A.html#6de812d1f374e1ae" class="t t">PSTraceSource</a> <a id="eaeace8ff695e418" href="../../R/eaeace8ff695e418.html" target="n" data-glyph="46,1" class="i field">s_runspaceInitTracer</a> =
            <a href="/System.Management.Automation/A.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<span class="i">GetTracer</span>(<span class="s">&quot;ConsoleHostRunspaceInit&quot;</span>, <span class="s">&quot;Initialization code for ConsoleHost&#39;s Runspace&quot;</span>, <b>false</b>);
    }
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Defines arguments passed to ConsoleHost.CreateRunspace.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>internal sealed class</b> <a id="ec8d2265cb93bc42" href="../../R/ec8d2265cb93bc42.html" target="n" data-glyph="2,0" class="t t">RunspaceCreationEventArgs</a> : <span class="i">EventArgs</span>
    {
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Constructs RunspaceCreationEventArgs.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal</b> <a id="29531c768dfc5873" href="../../R/29531c768dfc5873.html" target="n" data-glyph="74,1" class="t constructor">RunspaceCreationEventArgs</a>(
            <b>string</b> <span id="r199 rd" class="r199 r">initialCommand</span>,
            <b>bool</b> <span id="r200 rd" class="r200 r">skipProfiles</span>,
            <b>bool</b> <span id="r201 rd" class="r201 r">staMode</span>,
            <b>string</b> <span id="r202 rd" class="r202 r">configurationName</span>,
            <span class="i">Collection</span>&lt;<a href="/System.Management.Automation/A.html#4ce3ff8da8a0f8d9" class="t t">CommandParameter</a>&gt; <span id="r203 rd" class="r203 r">initialCommandArgs</span>)
        {
            <a href="#5ce015d0d7accc35" class="i property">InitialCommand</a> = <span class="r199 r">initialCommand</span>;
            <a href="#40d9845b255f1059" class="i property">SkipProfiles</a> = <span class="r200 r">skipProfiles</span>;
            <a href="#28a1df3e792cae37" class="i property">StaMode</a> = <span class="r201 r">staMode</span>;
            <a href="#84fb7db354406250" class="i property">ConfigurationName</a> = <span class="r202 r">configurationName</span>;
            <a href="#daf6576ddbea39d9" class="i property">InitialCommandArgs</a> = <span class="r203 r">initialCommandArgs</span>;
        }
 
        <b>internal string</b> <a id="5ce015d0d7accc35" href="../../R/5ce015d0d7accc35.html" target="n" data-glyph="104,1" class="i property">InitialCommand</a> { <b>get</b>; <b>set</b>; }
 
        <b>internal bool</b> <a id="40d9845b255f1059" href="../../R/40d9845b255f1059.html" target="n" data-glyph="104,1" class="i property">SkipProfiles</a> { <b>get</b>; <b>set</b>; }
 
        <b>internal bool</b> <a id="28a1df3e792cae37" href="../../R/28a1df3e792cae37.html" target="n" data-glyph="104,1" class="i property">StaMode</a> { <b>get</b>; <b>set</b>; }
 
        <b>internal string</b> <a id="84fb7db354406250" href="../../R/84fb7db354406250.html" target="n" data-glyph="104,1" class="i property">ConfigurationName</a> { <b>get</b>; <b>set</b>; }
 
        <b>internal</b> <span class="i">Collection</span>&lt;<a href="/System.Management.Automation/A.html#4ce3ff8da8a0f8d9" class="t t">CommandParameter</a>&gt; <a id="daf6576ddbea39d9" href="../../R/daf6576ddbea39d9.html" target="n" data-glyph="104,1" class="i property">InitialCommandArgs</a> { <b>get</b>; <b>set</b>; }
    }
}   <span class="c">// namespace</span>
</pre></td></tr></table></div></body></html>
