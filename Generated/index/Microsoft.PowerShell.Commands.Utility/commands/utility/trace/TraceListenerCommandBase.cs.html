<!DOCTYPE html>
<html><head><title>TraceListenerCommandBase.cs</title><link rel="stylesheet" href="../../../../styles.css"><script src="../../../../scripts.js"></script></head>
<body class="cB" onload="i(610);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#Microsoft.PowerShell.Commands.Utility/commands/utility/trace/TraceListenerCommandBase.cs" target="_top">commands\utility\trace\TraceListenerCommandBase.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#Microsoft.PowerShell.Commands.Utility" target="_top">src\Microsoft.PowerShell.Commands.Utility\Microsoft.PowerShell.Commands.Utility.csproj</a> (Microsoft.PowerShell.Commands.Utility)</td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation.</span>
<span class="c">// Licensed under the MIT License.</span>
 
<b>using</b> <span class="i n">System</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Collections</span>.<span class="i">Generic</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Collections</span>.<span class="i">ObjectModel</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Diagnostics</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">IO</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Internal</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Security</span>;
 
<b>namespace</b> <span class="i n">Microsoft</span>.<span class="i n">PowerShell</span>.<span class="i n">Commands</span>
{
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> A base class for the trace cmdlets that allow you to specify</span>
    <span class="c">///</span><span class="c"> which trace listeners to add to a TraceSource.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>public class</b> <a id="086614238a740750" href="../../../R/086614238a740750.html" target="n" data-glyph="0,0" class="t t"><span id="8b6e799ff1ae80f8">TraceListenerCommandBase</span></a> : <a href="TraceCommandBase.cs.html#c863d9dd8c32f118" class="t t">TraceCommandBase</a>
    {
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Parameters
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The TraceSource parameter determines which TraceSource categories the</span>
        <span class="c">///</span><span class="c"> operation will take place on.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal string</b>[] <a id="b4da37622e97c65b" href="../../../R/b4da37622e97c65b.html" target="n" data-glyph="104,1" class="i property">NameInternal</a> { <b>get</b>; <b>set</b>; } = <span class="i">Array</span>.<span class="i">Empty</span>&lt;<b>string</b>&gt;();
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The flags to be set on the TraceSource.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">value</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">value</span><span class="c">&gt;</span>
        <b>internal</b> <a href="/System.Management.Automation/A.html#8dccd9e1e9512b25" class="t t">PSTraceSourceOptions</a> <a id="797cac9a7957a8b3" href="../../../R/797cac9a7957a8b3.html" target="n" data-glyph="104,1" class="i property">OptionsInternal</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#9fdaa2777162f1c0" class="i field">_options</a>;
            }
 
            <b>set</b>
            {
                <a href="#9fdaa2777162f1c0" class="i field">_options</a> = <b>value</b>;
                <a href="#72e1e616d283a404" class="i field">optionsSpecified</a> = <b>true</b>;
            }
        }
 
        <b>private</b> <a href="/System.Management.Automation/A.html#8dccd9e1e9512b25" class="t t">PSTraceSourceOptions</a> <a id="9fdaa2777162f1c0" href="../../../R/9fdaa2777162f1c0.html" target="n" data-glyph="46,1" class="i field">_options</a> = <a href="/System.Management.Automation/A.html#8dccd9e1e9512b25" class="t t">PSTraceSourceOptions</a>.<a href="/System.Management.Automation/A.html#2d29191f68950280" class="i field">All</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> True if the Options parameter has been set, or false otherwise.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal bool</b> <a id="72e1e616d283a404" href="../../../R/72e1e616d283a404.html" target="n" data-glyph="44,1" class="i field">optionsSpecified</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The parameter which determines the options for output from the trace listeners.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal</b> <span class="i">TraceOptions</span> <a id="c8c7ca350a8368ac" href="../../../R/c8c7ca350a8368ac.html" target="n" data-glyph="104,1" class="i property">ListenerOptionsInternal</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#9c8a077aede7c76a" class="i field">_traceOptions</a>;
            }
 
            <b>set</b>
            {
                <a href="#b5fde0c888f4879c" class="i field">traceOptionsSpecified</a> = <b>true</b>;
                <a href="#9c8a077aede7c76a" class="i field">_traceOptions</a> = <b>value</b>;
            }
        }
 
        <b>private</b> <span class="i">TraceOptions</span> <a id="9c8a077aede7c76a" href="../../../R/9c8a077aede7c76a.html" target="n" data-glyph="46,1" class="i field">_traceOptions</a> = <span class="i">TraceOptions</span>.<span class="i">None</span>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> True if the TraceOptions parameter was specified, or false otherwise.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal bool</b> <a id="b5fde0c888f4879c" href="../../../R/b5fde0c888f4879c.html" target="n" data-glyph="44,1" class="i field">traceOptionsSpecified</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Adds the file trace listener using the specified file.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">value</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">value</span><span class="c">&gt;</span>
        <b>internal string</b> <a id="90a66c8d97c7880d" href="../../../R/90a66c8d97c7880d.html" target="n" data-glyph="104,1" class="i property">FileListener</a> { <b>get</b>; <b>set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Property that sets force parameter.  This will clear the</span>
        <span class="c">///</span><span class="c"> read-only attribute on an existing file if present.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Note that we do not attempt to reset the read-only attribute.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>public bool</b> <a id="e94b01aecb4de5fa" href="../../../R/e94b01aecb4de5fa.html" target="n" data-glyph="102,1" class="i property">ForceWrite</a> { <b>get</b>; <b>set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If this parameter is specified the Debugger trace listener will be added.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">value</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">value</span><span class="c">&gt;</span>
        <b>internal bool</b> <a id="28da4ac3e203c31e" href="../../../R/28da4ac3e203c31e.html" target="n" data-glyph="104,1" class="i property">DebuggerListener</a> { <b>get</b>; <b>set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If this parameter is specified the Msh Host trace listener will be added.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">value</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">value</span><span class="c">&gt;</span>
        <b>internal</b> <a href="/System.Management.Automation/A.html#8260026027378f6c" class="t t">SwitchParameter</a> <a id="f4725f6f03d8aff7" href="../../../R/f4725f6f03d8aff7.html" target="n" data-glyph="104,1" class="i property">PSHostListener</a>
        {
            <b>get</b> { <b>return</b> <a href="#83698cc05ae12e9d" class="i field">_host</a>; }
 
            <b>set</b> { <a href="#83698cc05ae12e9d" class="i field">_host</a> = <b>value</b>; }
        }
 
        <b>private bool</b> <a id="83698cc05ae12e9d" href="../../../R/83698cc05ae12e9d.html" target="n" data-glyph="46,1" class="i field">_host</a> = <b>false</b>;
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Parameters
 
        <b>internal</b> <span class="i">Collection</span>&lt;<a href="/System.Management.Automation/A.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>&gt; <a id="e9e2eb30313cc955" href="../../../R/e9e2eb30313cc955.html" target="n" data-glyph="74,1" class="i method">ConfigureTraceSource</a>(
            <b>string</b>[] <span id="r0 rd" class="r0 r">sourceNames</span>,
            <b>bool</b> <span id="r1 rd" class="r1 r">preConfigure</span>,
            <b>out</b> <span class="i">Collection</span>&lt;<a href="/System.Management.Automation/A.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>&gt; <span id="r2 rd" class="r2 r">preconfiguredSources</span>)
        {
            <span class="r2 r">preconfiguredSources</span> = <b>new</b> <span class="i">Collection</span>&lt;<a href="/System.Management.Automation/A.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>&gt;();
 
            <span class="c">// Find the matching and unmatched trace sources.</span>
 
            <span class="i">Collection</span>&lt;<b>string</b>&gt; <span id="r3 rd" class="r3 r">notMatched</span> = <b>null</b>;
            <span class="i">Collection</span>&lt;<a href="/System.Management.Automation/A.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>&gt; <span id="r4 rd" class="r4 r">matchingSources</span> = <a href="TraceCommandBase.cs.html#94438e8df2755c22" class="i method">GetMatchingTraceSource</a>(<span class="r0 r">sourceNames</span>, <b>false</b>, <b>out</b> <span class="r3 r">notMatched</span>);
 
            <b>if</b> (<span class="r1 r">preConfigure</span>)
            {
                <span class="c">// Set the flags if they were specified</span>
                <b>if</b> (<a href="#72e1e616d283a404" class="i field">optionsSpecified</a>)
                {
                    <a href="#19f162815f8be736" class="i method">SetFlags</a>(<span class="r4 r">matchingSources</span>);
                }
 
                <a href="#d189a4b7231ece73" class="i method">AddTraceListenersToSources</a>(<span class="r4 r">matchingSources</span>);
                <a href="#3c79396bea1aec5a" class="i method">SetTraceListenerOptions</a>(<span class="r4 r">matchingSources</span>);
            }
 
            <span class="c">// Now try to preset options for sources which have not yet been</span>
            <span class="c">// constructed.</span>
 
            <b>foreach</b> (<b>string</b> <span id="r5 rd" class="r5 r">notMatchedName</span> <b>in</b> <span class="r3 r">notMatched</span>)
            {
                <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r5 r">notMatchedName</span>))
                {
                    <b>continue</b>;
                }
 
                <b>if</b> (<a href="/System.Management.Automation/A.html#d450e739ff28e660" class="t t">WildcardPattern</a>.<span class="i">ContainsWildcardCharacters</span>(<span class="r5 r">notMatchedName</span>))
                {
                    <b>continue</b>;
                }
 
                <a href="/System.Management.Automation/A.html#6de812d1f374e1ae" class="t t">PSTraceSource</a> <span id="r6 rd" class="r6 r">newTraceSource</span> =
                    <a href="/System.Management.Automation/A.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<span class="i">GetNewTraceSource</span>(
                        <span class="r5 r">notMatchedName</span>,
                        <b>string</b>.<span class="i">Empty</span>,
                        <b>true</b>);
 
                <span class="r2 r">preconfiguredSources</span>.<span class="i">Add</span>(<span class="r6 r">newTraceSource</span>);
            }
 
            <span class="c">// Preconfigure any trace sources that were not already present</span>
 
            <b>if</b> (<span class="r2 r">preconfiguredSources</span>.<span class="i">Count</span> &gt; 0)
            {
                <b>if</b> (<span class="r1 r">preConfigure</span>)
                {
                    <span class="c">// Set the flags if they were specified</span>
                    <b>if</b> (<a href="#72e1e616d283a404" class="i field">optionsSpecified</a>)
                    {
                        <a href="#19f162815f8be736" class="i method">SetFlags</a>(<span class="r2 r">preconfiguredSources</span>);
                    }
 
                    <a href="#d189a4b7231ece73" class="i method">AddTraceListenersToSources</a>(<span class="r2 r">preconfiguredSources</span>);
                    <a href="#3c79396bea1aec5a" class="i method">SetTraceListenerOptions</a>(<span class="r2 r">preconfiguredSources</span>);
                }
 
                <span class="c">// Add the sources to the preconfigured table so that they are found</span>
                <span class="c">// when the trace source finally gets created by the system.</span>
 
                <b>foreach</b> (<a href="/System.Management.Automation/A.html#6de812d1f374e1ae" class="t t">PSTraceSource</a> <span id="r7 rd" class="r7 r">sourceToPreconfigure</span> <b>in</b> <span class="r2 r">preconfiguredSources</span>)
                {
                    <b>if</b> (!<a href="/System.Management.Automation/A.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<span class="i">PreConfiguredTraceSource</span>.<span class="i">ContainsKey</span>(<span class="r7 r">sourceToPreconfigure</span>.<a href="/System.Management.Automation/A.html#37a68a19537ce71f" class="i property">Name</a>))
                    {
                        <a href="/System.Management.Automation/A.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<span class="i">PreConfiguredTraceSource</span>.<span class="i">Add</span>(<span class="r7 r">sourceToPreconfigure</span>.<a href="/System.Management.Automation/A.html#37a68a19537ce71f" class="i property">Name</a>, <span class="r7 r">sourceToPreconfigure</span>);
                    }
                }
            }
 
            <b>return</b> <span class="r4 r">matchingSources</span>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> AddTraceListeners
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Adds the console, debugger, file, or host listener if requested.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="d189a4b7231ece73" href="../../../R/d189a4b7231ece73.html" target="n" data-glyph="74,1" class="i method">AddTraceListenersToSources</a>(<span class="i">Collection</span>&lt;<a href="/System.Management.Automation/A.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>&gt; <span id="r8 rd" class="r8 r">matchingSources</span>)
        {
            <b>if</b> (<a href="#28da4ac3e203c31e" class="i property">DebuggerListener</a>)
            {
                <b>if</b> (<a href="#a1dcc6e55ce02f18" class="i field">_defaultListener</a> == <b>null</b>)
                {
                    <a href="#a1dcc6e55ce02f18" class="i field">_defaultListener</a> =
                        <b>new</b> <span class="i">DefaultTraceListener</span>();
 
                    <span class="c">// Note, this is not meant to be localized.</span>
                    <a href="#a1dcc6e55ce02f18" class="i field">_defaultListener</a>.<span class="i">Name</span> = <span class="s">&quot;Debug&quot;</span>;
                }
 
                <span class="i">AddListenerToSources</span>(<span class="r8 r">matchingSources</span>, <a href="#a1dcc6e55ce02f18" class="i field">_defaultListener</a>);
            }
 
            <b>if</b> (<a href="#f4725f6f03d8aff7" class="i property">PSHostListener</a>)
            {
                <b>if</b> (<a href="#3f4f3eb341734d0c" class="i field">_hostListener</a> == <b>null</b>)
                {
                    ((<span class="i">MshCommandRuntime</span>)<a href="#086614238a740750" class="k">this</a>.<a href="/System.Management.Automation/A.html#fa3830ca3ad4b256" class="i property">CommandRuntime</a>).<span class="i">DebugPreference</span> = <a href="/System.Management.Automation/A.html#18f88a0529e26331" class="t t">ActionPreference</a>.<a href="/System.Management.Automation/A.html#0d6a3114b77f011d" class="i field">Continue</a>;
                    <a href="#3f4f3eb341734d0c" class="i field">_hostListener</a> = <b>new</b> <a href="MshHostTraceListener.cs.html#4c59ae7641e0517d" class="t constructor">PSHostTraceListener</a>(<a href="#086614238a740750" class="k">this</a>);
 
                    <span class="c">// Note, this is not meant to be localized.</span>
                    <a href="#3f4f3eb341734d0c" class="i field">_hostListener</a>.<span class="i">Name</span> = <span class="s">&quot;Host&quot;</span>;
                }
 
                <span class="i">AddListenerToSources</span>(<span class="r8 r">matchingSources</span>, <a href="#3f4f3eb341734d0c" class="i field">_hostListener</a>);
            }
 
            <b>if</b> (<a href="#90a66c8d97c7880d" class="i property">FileListener</a> != <b>null</b>)
            {
                <b>if</b> (<a href="#05f4c451e28f189b" class="i field">_fileListeners</a> == <b>null</b>)
                {
                    <a href="#05f4c451e28f189b" class="i field">_fileListeners</a> = <b>new</b> <span class="i">Collection</span>&lt;<span class="i">TextWriterTraceListener</span>&gt;();
                    <a href="#fd0d3567d43e3d34" class="i property">FileStreams</a> = <b>new</b> <span class="i">Collection</span>&lt;<span class="i">FileStream</span>&gt;();
 
                    <span class="i">Exception</span> <span id="r9 rd" class="r9 r">error</span> = <b>null</b>;
 
                    <b>try</b>
                    {
                        <span class="i">Collection</span>&lt;<b>string</b>&gt; <span id="r10 rd" class="r10 r">resolvedPaths</span> = <b>new</b>();
                        <b>try</b>
                        {
                            <span class="c">// Resolve the file path</span>
                            <a href="/System.Management.Automation/A.html#dd4e1f2f8e73a1dd" class="t t">ProviderInfo</a> <span id="r11 rd" class="r11 r">provider</span> = <b>null</b>;
                            <span class="r10 r">resolvedPaths</span> = <a href="#086614238a740750" class="k">this</a>.<a href="/System.Management.Automation/A.html#5078d443148de142" class="i property">SessionState</a>.<a href="/System.Management.Automation/A.html#3390cfbbdcffb036" class="i property">Path</a>.<span class="i">GetResolvedProviderPathFromPSPath</span>(<a href="#90a66c8d97c7880d" class="i property">FileListener</a>, <b>out</b> <span class="r11 r">provider</span>);
 
                            <span class="c">// We can only export aliases to the file system</span>
                            <b>if</b> (!<span class="r11 r">provider</span>.<span class="i">NameEquals</span>(<a href="#086614238a740750" class="k">this</a>.<span class="i">Context</span>.<span class="i">ProviderNames</span>.<span class="i">FileSystem</span>))
                            {
                                <b>throw</b>
                                    <b>new</b> <span class="t">PSNotSupportedException</span>(
                                        <span class="i">StringUtil</span>.<span class="i">Format</span>(<span class="i">TraceCommandStrings</span>.<span class="i">TraceFileOnly</span>,
                                            <a href="#90a66c8d97c7880d" class="i property">FileListener</a>,
                                            <span class="r11 r">provider</span>.<span class="i">FullName</span>));
                            }
                        }
                        <b>catch</b> (<a href="/System.Management.Automation/A.html#9ed59df3c4c15193" class="t t">ItemNotFoundException</a>)
                        {
                            <span class="c">// Since the file wasn&#39;t found, just make a provider-qualified path out if it</span>
                            <span class="c">// and use that.</span>
 
                            <a href="/System.Management.Automation/A.html#2d16b26a541ba185" class="t t">PSDriveInfo</a> <span id="r12 rd" class="r12 r">driveInfo</span> = <b>null</b>;
                            <a href="/System.Management.Automation/A.html#dd4e1f2f8e73a1dd" class="t t">ProviderInfo</a> <span id="r13 rd" class="r13 r">provider</span> = <b>null</b>;
                            <b>string</b> <span id="r14 rd" class="r14 r">path</span> =
                                <a href="#086614238a740750" class="k">this</a>.<a href="/System.Management.Automation/A.html#5078d443148de142" class="i property">SessionState</a>.<a href="/System.Management.Automation/A.html#3390cfbbdcffb036" class="i property">Path</a>.<span class="i">GetUnresolvedProviderPathFromPSPath</span>(
                                    <a href="#90a66c8d97c7880d" class="i property">FileListener</a>,
                                    <b>new</b> <span class="i">CmdletProviderContext</span>(<a href="#086614238a740750" class="k">this</a>.<span class="i">Context</span>),
                                    <b>out</b> <span class="r13 r">provider</span>,
                                    <b>out</b> <span class="r12 r">driveInfo</span>);
 
                            <span class="c">// We can only export aliases to the file system</span>
                            <b>if</b> (!<span class="r13 r">provider</span>.<span class="i">NameEquals</span>(<a href="#086614238a740750" class="k">this</a>.<span class="i">Context</span>.<span class="i">ProviderNames</span>.<span class="i">FileSystem</span>))
                            {
                                <b>throw</b>
                                    <b>new</b> <span class="t">PSNotSupportedException</span>(
                                        <span class="i">StringUtil</span>.<span class="i">Format</span>(<span class="i">TraceCommandStrings</span>.<span class="i">TraceFileOnly</span>,
                                            <a href="#90a66c8d97c7880d" class="i property">FileListener</a>,
                                            <span class="r13 r">provider</span>.<span class="i">FullName</span>));
                            }
 
                            <span class="r10 r">resolvedPaths</span>.<span class="i">Add</span>(<span class="r14 r">path</span>);
                        }
 
                        <b>if</b> (<span class="r10 r">resolvedPaths</span>.<span class="i">Count</span> &gt; 1)
                        {
                            <b>throw</b>
                                <b>new</b> <span class="t">PSNotSupportedException</span>(<span class="i">StringUtil</span>.<span class="i">Format</span>(<span class="i">TraceCommandStrings</span>.<span class="i">TraceSingleFileOnly</span>, <a href="#90a66c8d97c7880d" class="i property">FileListener</a>));
                        }
 
                        <b>string</b> <span id="r15 rd" class="r15 r">resolvedPath</span> = <span class="r10 r">resolvedPaths</span>[0];
 
                        <span class="i">Exception</span> <span id="r16 rd" class="r16 r">fileOpenError</span> = <b>null</b>;
                        <b>try</b>
                        {
                            <b>if</b> (<a href="#e94b01aecb4de5fa" class="i property">ForceWrite</a> &amp;&amp; <span class="i n">System</span>.<span class="i">IO</span>.<span class="i">File</span>.<span class="i">Exists</span>(<span class="r15 r">resolvedPath</span>))
                            {
                                <span class="c">// remove readonly attributes on the file</span>
                                <span class="i n">System</span>.<span class="i">IO</span>.<span class="i">FileInfo</span> <span id="r17 rd" class="r17 r">fInfo</span> = <b>new</b>(<span class="r15 r">resolvedPath</span>);
                                <b>if</b> (<span class="r17 r">fInfo</span> != <b>null</b>)
                                {
                                    <span class="c">// Save some disk write time by checking whether file is readonly..</span>
                                    <b>if</b> ((<span class="r17 r">fInfo</span>.<span class="i">Attributes</span> &amp; <span class="i">FileAttributes</span>.<span class="i">ReadOnly</span>) == <span class="i">FileAttributes</span>.<span class="i">ReadOnly</span>)
                                    {
                                        <span class="c">// Make sure the file is not read only</span>
                                        <span class="r17 r">fInfo</span>.<span class="i">Attributes</span> &amp;= ~(<span class="i">FileAttributes</span>.<span class="i">ReadOnly</span>);
                                    }
                                }
                            }
 
                            <span class="c">// Trace commands always append..So there is no need to set overwrite with force..</span>
                            <span class="i">FileStream</span> <span id="r18 rd" class="r18 r">fileStream</span> = <b>new</b>(<span class="r15 r">resolvedPath</span>, <span class="i">FileMode</span>.<span class="i">Append</span>, <span class="i">FileAccess</span>.<span class="i">Write</span>, <span class="i">FileShare</span>.<span class="i">ReadWrite</span>);
                            <a href="#fd0d3567d43e3d34" class="i property">FileStreams</a>.<span class="i">Add</span>(<span class="r18 r">fileStream</span>);
 
                            <span class="c">// Open the file stream</span>
 
                            <span class="i">TextWriterTraceListener</span> <span id="r19 rd" class="r19 r">fileListener</span> =
                                    <b>new</b>(<span class="r18 r">fileStream</span>, <span class="r15 r">resolvedPath</span>);
 
                            <span class="r19 r">fileListener</span>.<span class="i">Name</span> = <a href="#90a66c8d97c7880d" class="i property">FileListener</a>;
 
                            <a href="#05f4c451e28f189b" class="i field">_fileListeners</a>.<span class="i">Add</span>(<span class="r19 r">fileListener</span>);
                        }
                        <b>catch</b> (<span class="i">IOException</span> <span id="r20 rd" class="r20 r">ioException</span>)
                        {
                            <span class="r16 r">fileOpenError</span> = <span class="r20 r">ioException</span>;
                        }
                        <b>catch</b> (<span class="i">SecurityException</span> <span id="r21 rd" class="r21 r">securityException</span>)
                        {
                            <span class="r16 r">fileOpenError</span> = <span class="r21 r">securityException</span>;
                        }
                        <b>catch</b> (<span class="i">UnauthorizedAccessException</span> <span id="r22 rd" class="r22 r">unauthorized</span>)
                        {
                            <span class="r16 r">fileOpenError</span> = <span class="r22 r">unauthorized</span>;
                        }
 
                        <b>if</b> (<span class="r16 r">fileOpenError</span> != <b>null</b>)
                        {
                            <a href="/System.Management.Automation/A.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r23 rd" class="r23 r">errorRecord</span> =
                                <b>new</b>(
                                    <span class="r16 r">fileOpenError</span>,
                                    <span class="s">&quot;FileListenerPathResolutionFailed&quot;</span>,
                                    <a href="/System.Management.Automation/A.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="/System.Management.Automation/A.html#7650567b7604bddc" class="i field">OpenError</a>,
                                    <span class="r15 r">resolvedPath</span>);
 
                            <span class="i">WriteError</span>(<span class="r23 r">errorRecord</span>);
                        }
                    }
                    <b>catch</b> (<a href="/System.Management.Automation/A.html#a58038dc730da896" class="t t">ProviderNotFoundException</a> <span id="r24 rd" class="r24 r">providerNotFound</span>)
                    {
                        <span class="r9 r">error</span> = <span class="r24 r">providerNotFound</span>;
                    }
                    <b>catch</b> (<span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="/System.Management.Automation/A.html#09140e6dc875019b" class="t t">DriveNotFoundException</a> <span id="r25 rd" class="r25 r">driveNotFound</span>)
                    {
                        <span class="r9 r">error</span> = <span class="r25 r">driveNotFound</span>;
                    }
                    <b>catch</b> (<span class="i">NotSupportedException</span> <span id="r26 rd" class="r26 r">notSupported</span>)
                    {
                        <span class="r9 r">error</span> = <span class="r26 r">notSupported</span>;
                    }
 
                    <b>if</b> (<span class="r9 r">error</span> != <b>null</b>)
                    {
                        <a href="/System.Management.Automation/A.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r27 rd" class="r27 r">errorRecord</span> =
                            <b>new</b>(
                                <span class="r9 r">error</span>,
                                <span class="s">&quot;FileListenerPathResolutionFailed&quot;</span>,
                                <a href="/System.Management.Automation/A.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="/System.Management.Automation/A.html#846d2b572f2c4820" class="i field">InvalidArgument</a>,
                                <a href="#90a66c8d97c7880d" class="i property">FileListener</a>);
 
                        <span class="i">WriteError</span>(<span class="r27 r">errorRecord</span>);
                    }
                }
 
                <b>foreach</b> (<span class="i">TraceListener</span> <span id="r28 rd" class="r28 r">listener</span> <b>in</b> <a href="#05f4c451e28f189b" class="i field">_fileListeners</a>)
                {
                    <a href="#b95de30fdee8cfb6" class="i method">AddListenerToSources</a>(<span class="r8 r">matchingSources</span>, <span class="r28 r">listener</span>);
                }
            }
        }
 
        <b>private</b> <span class="i">DefaultTraceListener</span> <a id="a1dcc6e55ce02f18" href="../../../R/a1dcc6e55ce02f18.html" target="n" data-glyph="46,1" class="i field">_defaultListener</a>;
        <b>private</b> <a href="MshHostTraceListener.cs.html#6aa890eef7420db5" class="t t">PSHostTraceListener</a> <a id="3f4f3eb341734d0c" href="../../../R/3f4f3eb341734d0c.html" target="n" data-glyph="46,1" class="i field">_hostListener</a>;
        <b>private</b> <span class="i">Collection</span>&lt;<span class="i">TextWriterTraceListener</span>&gt; <a id="05f4c451e28f189b" href="../../../R/05f4c451e28f189b.html" target="n" data-glyph="46,1" class="i field">_fileListeners</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The file streams that were open by this command.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal</b> <span class="i">Collection</span>&lt;<span class="i">FileStream</span>&gt; <a id="fd0d3567d43e3d34" href="../../../R/fd0d3567d43e3d34.html" target="n" data-glyph="104,1" class="i property">FileStreams</a> { <b>get</b>; <b>private set</b>; }
 
        <b>private static void</b> <a id="b95de30fdee8cfb6" href="../../../R/b95de30fdee8cfb6.html" target="n" data-glyph="76,1" class="i method">AddListenerToSources</a>(<span class="i">Collection</span>&lt;<a href="/System.Management.Automation/A.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>&gt; <span id="r29 rd" class="r29 r">matchingSources</span>, <span class="i">TraceListener</span> <span id="r30 rd" class="r30 r">listener</span>)
        {
            <span class="c">// Now add the listener to all the sources</span>
            <b>foreach</b> (<a href="/System.Management.Automation/A.html#6de812d1f374e1ae" class="t t">PSTraceSource</a> <span id="r31 rd" class="r31 r">source</span> <b>in</b> <span class="r29 r">matchingSources</span>)
            {
                <span class="r31 r">source</span>.<a href="/System.Management.Automation/A.html#3f62365c6014f09a" class="i property">Listeners</a>.<span class="i">Add</span>(<span class="r30 r">listener</span>);
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> AddTraceListeners
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> RemoveTraceListeners
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Removes the tracelisteners from the specified trace sources.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal static void</b> <a id="f2796ab49cd0a6ea" href="../../../R/f2796ab49cd0a6ea.html" target="n" data-glyph="74,1" class="i method">RemoveListenersByName</a>(
            <span class="i">Collection</span>&lt;<a href="/System.Management.Automation/A.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>&gt; <span id="r32 rd" class="r32 r">matchingSources</span>,
            <b>string</b>[] <span id="r33 rd" class="r33 r">listenerNames</span>,
            <b>bool</b> <span id="r34 rd" class="r34 r">fileListenersOnly</span>)
        {
            <span class="i">Collection</span>&lt;<a href="/System.Management.Automation/A.html#d450e739ff28e660" class="t t">WildcardPattern</a>&gt; <span id="r35 rd" class="r35 r">listenerMatcher</span> =
                <span class="i">SessionStateUtilities</span>.<span class="i">CreateWildcardsFromStrings</span>(
                    <span class="r33 r">listenerNames</span>,
                    <a href="/System.Management.Automation/A.html#4e788ab2470b3632" class="t t">WildcardOptions</a>.<a href="/System.Management.Automation/A.html#2d0521a6986208d3" class="i field">IgnoreCase</a>);
 
            <span class="c">// Loop through all the matching sources and remove the matching listeners</span>
 
            <b>foreach</b> (<a href="/System.Management.Automation/A.html#6de812d1f374e1ae" class="t t">PSTraceSource</a> <span id="r36 rd" class="r36 r">source</span> <b>in</b> <span class="r32 r">matchingSources</span>)
            {
                <span class="c">// Get the indexes of the listeners that need to be removed.</span>
                <span class="c">// This is done because we cannot remove the listeners while</span>
                <span class="c">// we are enumerating them.</span>
 
                <b>for</b> (<b>int</b> <span id="r37 rd" class="r37 r">index</span> = <span class="r36 r">source</span>.<a href="/System.Management.Automation/A.html#3f62365c6014f09a" class="i property">Listeners</a>.<span class="i">Count</span> - 1; <span class="r37 r">index</span> &gt;= 0; --<span class="r37 r">index</span>)
                {
                    <span class="i">TraceListener</span> <span id="r38 rd" class="r38 r">listenerToRemove</span> = <span class="r36 r">source</span>.<a href="/System.Management.Automation/A.html#3f62365c6014f09a" class="i property">Listeners</a>[<span class="r37 r">index</span>];
 
                    <b>if</b> (<span class="r34 r">fileListenersOnly</span> &amp;&amp; <span class="r38 r">listenerToRemove</span> <b>is not</b> <span class="i">TextWriterTraceListener</span>)
                    {
                        <span class="c">// Since we only want to remove file listeners, skip any that</span>
                        <span class="c">// aren&#39;t file listeners</span>
                        <b>continue</b>;
                    }
 
                    <span class="c">// Now match the names</span>
 
                    <b>if</b> (<span class="i">SessionStateUtilities</span>.<span class="i">MatchesAnyWildcardPattern</span>(
                            <span class="r38 r">listenerToRemove</span>.<span class="i">Name</span>,
                            <span class="r35 r">listenerMatcher</span>,
                            <b>true</b>))
                    {
                        <span class="r38 r">listenerToRemove</span>.<span class="i">Flush</span>();
                        <span class="r38 r">listenerToRemove</span>.<span class="i">Dispose</span>();
                        <span class="r36 r">source</span>.<a href="/System.Management.Automation/A.html#3f62365c6014f09a" class="i property">Listeners</a>.<span class="i">RemoveAt</span>(<span class="r37 r">index</span>);
                    }
                }
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> RemoveTraceListeners
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> SetTraceListenerOptions
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Sets the trace listener options based on the ListenerOptions parameter.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="3c79396bea1aec5a" href="../../../R/3c79396bea1aec5a.html" target="n" data-glyph="74,1" class="i method">SetTraceListenerOptions</a>(<span class="i">Collection</span>&lt;<a href="/System.Management.Automation/A.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>&gt; <span id="r39 rd" class="r39 r">matchingSources</span>)
        {
            <span class="c">// Set the trace options if they were specified</span>
            <b>if</b> (<a href="#b5fde0c888f4879c" class="i field">traceOptionsSpecified</a>)
            {
                <b>foreach</b> (<a href="/System.Management.Automation/A.html#6de812d1f374e1ae" class="t t">PSTraceSource</a> <span id="r40 rd" class="r40 r">source</span> <b>in</b> <span class="r39 r">matchingSources</span>)
                {
                    <b>foreach</b> (<span class="i">TraceListener</span> <span id="r41 rd" class="r41 r">listener</span> <b>in</b> <span class="r40 r">source</span>.<a href="/System.Management.Automation/A.html#3f62365c6014f09a" class="i property">Listeners</a>)
                    {
                        <span class="r41 r">listener</span>.<span class="i">TraceOutputOptions</span> = <a href="#086614238a740750" class="k">this</a>.<a href="#c8c7ca350a8368ac" class="i property">ListenerOptionsInternal</a>;
                    }
                }
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> SetTraceListenerOptions
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> SetFlags
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Sets the flags for all the specified TraceSources.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="19f162815f8be736" href="../../../R/19f162815f8be736.html" target="n" data-glyph="74,1" class="i method">SetFlags</a>(<span class="i">Collection</span>&lt;<a href="/System.Management.Automation/A.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>&gt; <span id="r42 rd" class="r42 r">matchingSources</span>)
        {
            <b>foreach</b> (<a href="/System.Management.Automation/A.html#6de812d1f374e1ae" class="t t">PSTraceSource</a> <span id="r43 rd" class="r43 r">structuredSource</span> <b>in</b> <span class="r42 r">matchingSources</span>)
            {
                <span class="r43 r">structuredSource</span>.<span class="i">Options</span> = <a href="#086614238a740750" class="k">this</a>.<a href="#797cac9a7957a8b3" class="i property">OptionsInternal</a>;
            }
        }
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> SetFlags
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> TurnOnTracing
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Turns on tracing for the TraceSources, flags, and listeners defined by the parameters.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="aa346bae7f33153f" href="../../../R/aa346bae7f33153f.html" target="n" data-glyph="74,1" class="i method">TurnOnTracing</a>(<span class="i">Collection</span>&lt;<a href="/System.Management.Automation/A.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>&gt; <span id="r44 rd" class="r44 r">matchingSources</span>, <b>bool</b> <span id="r45 rd" class="r45 r">preConfigured</span>)
        {
            <b>foreach</b> (<a href="/System.Management.Automation/A.html#6de812d1f374e1ae" class="t t">PSTraceSource</a> <span id="r46 rd" class="r46 r">source</span> <b>in</b> <span class="r44 r">matchingSources</span>)
            {
                <span class="c">// Store the current state of the TraceSource</span>
                <b>if</b> (!<a href="#27678b0917bd35da" class="i field">_storedTraceSourceState</a>.<span class="i">ContainsKey</span>(<span class="r46 r">source</span>))
                {
                    <span class="c">// Copy the listeners into a different collection</span>
 
                    <span class="i">Collection</span>&lt;<span class="i">TraceListener</span>&gt; <span id="r47 rd" class="r47 r">listenerCollection</span> = <b>new</b>();
                    <b>foreach</b> (<span class="i">TraceListener</span> <span id="r48 rd" class="r48 r">listener</span> <b>in</b> <span class="r46 r">source</span>.<a href="/System.Management.Automation/A.html#3f62365c6014f09a" class="i property">Listeners</a>)
                    {
                        <span class="r47 r">listenerCollection</span>.<span class="i">Add</span>(<span class="r48 r">listener</span>);
                    }
 
                    <b>if</b> (<span class="r45 r">preConfigured</span>)
                    {
                        <span class="c">// If the source is a preconfigured source, then the default options</span>
                        <span class="c">// and listeners should be stored as the existing state.</span>
 
                        <a href="#27678b0917bd35da" class="i field">_storedTraceSourceState</a>[<span class="r46 r">source</span>] =
                            <b>new</b> <span class="i">KeyValuePair</span>&lt;<a href="/System.Management.Automation/A.html#8dccd9e1e9512b25" class="t t">PSTraceSourceOptions</a>, <span class="i">Collection</span>&lt;<span class="i">TraceListener</span>&gt;&gt;(
                                <a href="/System.Management.Automation/A.html#8dccd9e1e9512b25" class="t t">PSTraceSourceOptions</a>.<a href="/System.Management.Automation/A.html#a1342943109aa29f" class="i field">None</a>,
                                <b>new</b> <span class="i">Collection</span>&lt;<span class="i">TraceListener</span>&gt;());
                    }
                    <b>else</b>
                    {
                        <a href="#27678b0917bd35da" class="i field">_storedTraceSourceState</a>[<span class="r46 r">source</span>] =
                            <b>new</b> <span class="i">KeyValuePair</span>&lt;<a href="/System.Management.Automation/A.html#8dccd9e1e9512b25" class="t t">PSTraceSourceOptions</a>, <span class="i">Collection</span>&lt;<span class="i">TraceListener</span>&gt;&gt;(
                                <span class="r46 r">source</span>.<a href="/System.Management.Automation/A.html#39a46fbab64bf75b" class="i property">Options</a>,
                                <span class="r47 r">listenerCollection</span>);
                    }
                }
 
                <span class="c">// Now set the new flags</span>
                <span class="r46 r">source</span>.<span class="i">Options</span> = <a href="#086614238a740750" class="k">this</a>.<a href="#797cac9a7957a8b3" class="i property">OptionsInternal</a>;
            }
 
            <span class="c">// Now turn on the listeners</span>
 
            <a href="#d189a4b7231ece73" class="i method">AddTraceListenersToSources</a>(<span class="r44 r">matchingSources</span>);
            <a href="#3c79396bea1aec5a" class="i method">SetTraceListenerOptions</a>(<span class="r44 r">matchingSources</span>);
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> TurnOnTracing
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> ResetTracing
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Resets tracing to the previous level for the TraceSources defined by the parameters.</span>
        <span class="c">///</span><span class="c"> Note, TurnOnTracing must be called before calling ResetTracing or else all</span>
        <span class="c">///</span><span class="c"> TraceSources will be turned off.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="6d8c8bfaeee6d0ed" href="../../../R/6d8c8bfaeee6d0ed.html" target="n" data-glyph="74,1" class="i method">ResetTracing</a>(<span class="i">Collection</span>&lt;<a href="/System.Management.Automation/A.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>&gt; <span id="r49 rd" class="r49 r">matchingSources</span>)
        {
            <b>foreach</b> (<a href="/System.Management.Automation/A.html#6de812d1f374e1ae" class="t t">PSTraceSource</a> <span id="r50 rd" class="r50 r">source</span> <b>in</b> <span class="r49 r">matchingSources</span>)
            {
                <span class="c">// First flush all the existing trace listeners</span>
 
                <b>foreach</b> (<span class="i">TraceListener</span> <span id="r51 rd" class="r51 r">listener</span> <b>in</b> <span class="r50 r">source</span>.<a href="/System.Management.Automation/A.html#3f62365c6014f09a" class="i property">Listeners</a>)
                {
                    <span class="r51 r">listener</span>.<span class="i">Flush</span>();
                }
 
                <b>if</b> (<a href="#27678b0917bd35da" class="i field">_storedTraceSourceState</a>.<span class="i">ContainsKey</span>(<span class="r50 r">source</span>))
                {
                    <span class="c">// Restore the TraceSource to its original state</span>
 
                    <span class="i">KeyValuePair</span>&lt;<a href="/System.Management.Automation/A.html#8dccd9e1e9512b25" class="t t">PSTraceSourceOptions</a>, <span class="i">Collection</span>&lt;<span class="i">TraceListener</span>&gt;&gt; <span id="r52 rd" class="r52 r">storedState</span> =
                        <a href="#27678b0917bd35da" class="i field">_storedTraceSourceState</a>[<span class="r50 r">source</span>];
 
                    <span class="r50 r">source</span>.<a href="/System.Management.Automation/A.html#3f62365c6014f09a" class="i property">Listeners</a>.<span class="i">Clear</span>();
                    <b>foreach</b> (<span class="i">TraceListener</span> <span id="r53 rd" class="r53 r">listener</span> <b>in</b> <span class="r52 r">storedState</span>.<span class="i">Value</span>)
                    {
                        <span class="r50 r">source</span>.<a href="/System.Management.Automation/A.html#3f62365c6014f09a" class="i property">Listeners</a>.<span class="i">Add</span>(<span class="r53 r">listener</span>);
                    }
 
                    <span class="r50 r">source</span>.<span class="i">Options</span> = <span class="r52 r">storedState</span>.<span class="i">Key</span>;
                }
                <b>else</b>
                {
                    <span class="c">// Since we don&#39;t have any stored state for this TraceSource,</span>
                    <span class="c">// just turn it off.</span>
 
                    <span class="r50 r">source</span>.<a href="/System.Management.Automation/A.html#3f62365c6014f09a" class="i property">Listeners</a>.<span class="i">Clear</span>();
                    <span class="r50 r">source</span>.<span class="i">Options</span> = <a href="/System.Management.Automation/A.html#8dccd9e1e9512b25" class="t t">PSTraceSourceOptions</a>.<a href="/System.Management.Automation/A.html#a1342943109aa29f" class="i field">None</a>;
                }
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> ResetTracing
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> stored state
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Clears the store TraceSource state.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>protected void</b> <a id="f772ee89ee9b1ff7" href="../../../R/f772ee89ee9b1ff7.html" target="n" data-glyph="75,1" class="i method">ClearStoredState</a>()
        {
            <span class="c">// First close all listeners</span>
 
            <b>foreach</b> (<span class="i">KeyValuePair</span>&lt;<a href="/System.Management.Automation/A.html#8dccd9e1e9512b25" class="t t">PSTraceSourceOptions</a>, <span class="i">Collection</span>&lt;<span class="i">TraceListener</span>&gt;&gt; <span id="r54 rd" class="r54 r">pair</span> <b>in</b> <a href="#27678b0917bd35da" class="i field">_storedTraceSourceState</a>.<span class="i">Values</span>)
            {
                <b>foreach</b> (<span class="i">TraceListener</span> <span id="r55 rd" class="r55 r">listener</span> <b>in</b> <span class="r54 r">pair</span>.<span class="i">Value</span>)
                {
                    <span class="r55 r">listener</span>.<span class="i">Flush</span>();
                    <span class="r55 r">listener</span>.<span class="i">Dispose</span>();
                }
            }
 
            <a href="#27678b0917bd35da" class="i field">_storedTraceSourceState</a>.<span class="i">Clear</span>();
        }
 
        <b>private readonly</b> <span class="i">Dictionary</span>&lt;<a href="/System.Management.Automation/A.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>, <span class="i">KeyValuePair</span>&lt;<a href="/System.Management.Automation/A.html#8dccd9e1e9512b25" class="t t">PSTraceSourceOptions</a>, <span class="i">Collection</span>&lt;<span class="i">TraceListener</span>&gt;&gt;&gt; <a id="27678b0917bd35da" href="../../../R/27678b0917bd35da.html" target="n" data-glyph="46,1" class="i field">_storedTraceSourceState</a> =
            <b>new</b>();
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> stored state
    }
}
</pre></td></tr></table></div></body></html>
