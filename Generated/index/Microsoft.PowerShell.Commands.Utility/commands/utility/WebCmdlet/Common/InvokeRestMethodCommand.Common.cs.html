<!DOCTYPE html>
<html><head><title>InvokeRestMethodCommand.Common.cs</title><link rel="stylesheet" href="../../../../../styles.css"><script src="../../../../../scripts.js"></script></head>
<body class="cB" onload="i(506);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#Microsoft.PowerShell.Commands.Utility/commands/utility/WebCmdlet/Common/InvokeRestMethodCommand.Common.cs" target="_top">commands\utility\WebCmdlet\Common\InvokeRestMethodCommand.Common.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#Microsoft.PowerShell.Commands.Utility" target="_top">src\Microsoft.PowerShell.Commands.Utility\Microsoft.PowerShell.Commands.Utility.csproj</a> (Microsoft.PowerShell.Commands.Utility)</td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation.</span>
<span class="c">// Licensed under the MIT License.</span>
 
<b>using</b> <span class="i n">System</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">IO</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Net</span>.<span class="i">Http</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Text</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Xml</span>;
 
<b>using</b> <span class="i">Newtonsoft</span>.<span class="i">Json</span>;
<b>using</b> <span class="i">Newtonsoft</span>.<span class="i">Json</span>.<span class="i">Linq</span>;
 
<b>namespace</b> <span class="i n">Microsoft</span>.<span class="i n">PowerShell</span>.<span class="i n">Commands</span>
{
    <b>public</b> <a href="../../../../P/d065ea9052e26dc0.html" target="s" class="k">partial</a> <b>class</b> <a id="d065ea9052e26dc0" href="../../../../R/../../0000000000.html" target="n" data-glyph="0,0" class="t t"><span id="bd88b3fe41715164">InvokeRestMethodCommand</span></a>
    {
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Parameters
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets or sets the parameter Method.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>(<a href="/System.Management.Automation/A.html#91bee819daab0925" class="i property">ParameterSetName</a> = <span class="s">&quot;StandardMethod&quot;</span>)]
        [<span class="i">Parameter</span>(<a href="/System.Management.Automation/A.html#91bee819daab0925" class="i property">ParameterSetName</a> = <span class="s">&quot;StandardMethodNoProxy&quot;</span>)]
        <b>public override</b> <a href="../WebRequestMethod.cs.html#15888b144941534b" class="t t">WebRequestMethod</a> <a id="fd7e1ced622e8a61" href="../../../../R/fd7e1ced622e8a61.html" target="n" data-glyph="102,1" class="i property">Method</a>
        {
            <b>get</b> { <b>return</b> <a href="../../../../P/662e7ae18a2eef77.html#662e7ae18a2eef77" class="k">base</a>.<a href="WebRequestPSCmdlet.Common.cs.html#74e585d369a3c020" class="i property">Method</a>; }
 
            <b>set</b> { <a href="../../../../P/662e7ae18a2eef77.html#662e7ae18a2eef77" class="k">base</a>.<a href="WebRequestPSCmdlet.Common.cs.html#74e585d369a3c020" class="i property">Method</a> = <b>value</b>; }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets or sets the parameter CustomMethod.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>(<a href="/System.Management.Automation/A.html#d5ad471518092731" class="i property">Mandatory</a> = <b>true</b>, <a href="/System.Management.Automation/A.html#91bee819daab0925" class="i property">ParameterSetName</a> = <span class="s">&quot;CustomMethod&quot;</span>)]
        [<span class="i">Parameter</span>(<a href="/System.Management.Automation/A.html#d5ad471518092731" class="i property">Mandatory</a> = <b>true</b>, <a href="/System.Management.Automation/A.html#91bee819daab0925" class="i property">ParameterSetName</a> = <span class="s">&quot;CustomMethodNoProxy&quot;</span>)]
        [<span class="i">Alias</span>(<span class="s">&quot;CM&quot;</span>)]
        [<span class="i">ValidateNotNullOrEmpty</span>]
        <b>public override string</b> <a id="e671181351f66c6f" href="../../../../R/e671181351f66c6f.html" target="n" data-glyph="102,1" class="i property">CustomMethod</a>
        {
            <b>get</b> { <b>return</b> <a href="../../../../P/662e7ae18a2eef77.html#662e7ae18a2eef77" class="k">base</a>.<a href="WebRequestPSCmdlet.Common.cs.html#379786a8f95d3483" class="i property">CustomMethod</a>; }
 
            <b>set</b> { <a href="../../../../P/662e7ae18a2eef77.html#662e7ae18a2eef77" class="k">base</a>.<a href="WebRequestPSCmdlet.Common.cs.html#379786a8f95d3483" class="i property">CustomMethod</a> = <b>value</b>; }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Enable automatic following of rel links.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>]
        [<span class="i">Alias</span>(<span class="s">&quot;FL&quot;</span>)]
        <b>public</b> <a href="/System.Management.Automation/A.html#8260026027378f6c" class="t t">SwitchParameter</a> <a id="c9cfd74e61b8717d" href="../../../../R/../../0000000000.html" target="n" data-glyph="102,1" class="i property">FollowRelLink</a>
        {
            <b>get</b> { <b>return</b> <a href="../../../../P/662e7ae18a2eef77.html#662e7ae18a2eef77" class="k">base</a>.<a href="WebRequestPSCmdlet.Common.cs.html#5c2134156fa5eee2" class="i field">_followRelLink</a>; }
 
            <b>set</b> { <a href="../../../../P/662e7ae18a2eef77.html#662e7ae18a2eef77" class="k">base</a>.<a href="WebRequestPSCmdlet.Common.cs.html#5c2134156fa5eee2" class="i field">_followRelLink</a> = <b>value</b>; }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets or sets the maximum number of rel links to follow.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>]
        [<span class="i">Alias</span>(<span class="s">&quot;ML&quot;</span>)]
        [<span class="i">ValidateRange</span>(1, <b>int</b>.<span class="i">MaxValue</span>)]
        <b>public int</b> <a id="0f5d47597e0d8c6f" href="../../../../R/../../0000000000.html" target="n" data-glyph="102,1" class="i property">MaximumFollowRelLink</a>
        {
            <b>get</b> { <b>return</b> <a href="../../../../P/662e7ae18a2eef77.html#662e7ae18a2eef77" class="k">base</a>.<a href="WebRequestPSCmdlet.Common.cs.html#2c0a1ccaad7bbcdc" class="i field">_maximumFollowRelLink</a>; }
 
            <b>set</b> { <a href="../../../../P/662e7ae18a2eef77.html#662e7ae18a2eef77" class="k">base</a>.<a href="WebRequestPSCmdlet.Common.cs.html#2c0a1ccaad7bbcdc" class="i field">_maximumFollowRelLink</a> = <b>value</b>; }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets or sets the ResponseHeadersVariable property.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>]
        [<span class="i">Alias</span>(<span class="s">&quot;RHV&quot;</span>)]
        <b>public string</b> <a id="400ebf69794902d7" href="../../../../R/400ebf69794902d7.html" target="n" data-glyph="102,1" class="i property">ResponseHeadersVariable</a> { <b>get</b>; <b>set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets or sets the variable name to use for storing the status code from the response.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>]
        <b>public string</b> <a id="ed4b89c8b4caa57d" href="../../../../R/ed4b89c8b4caa57d.html" target="n" data-glyph="102,1" class="i property">StatusCodeVariable</a> { <b>get</b>; <b>set</b>; }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Parameters
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Helper Methods
 
        <b>private bool</b> <a id="423af25c08363429" href="../../../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">TryProcessFeedStream</a>(<span class="i">Stream</span> <span id="r0 rd" class="r0 r">responseStream</span>)
        {
            <b>bool</b> <span id="r1 rd" class="r1 r">isRssOrFeed</span> = <b>false</b>;
 
            <b>try</b>
            {
                <span class="i">XmlReaderSettings</span> <span id="r2 rd" class="r2 r">readerSettings</span> = <a href="#e9c8989250129b46" class="i method">GetSecureXmlReaderSettings</a>();
                <span class="i">XmlReader</span> <span id="r3 rd" class="r3 r">reader</span> = <span class="i">XmlReader</span>.<span class="i">Create</span>(<span class="r0 r">responseStream</span>, <span class="r2 r">readerSettings</span>);
 
                <span class="c">// See if the reader contained an &quot;RSS&quot; or &quot;Feed&quot; in the first 10 elements (RSS and Feed are normally 2 or 3)</span>
                <b>int</b> <span id="r4 rd" class="r4 r">readCount</span> = 0;
                <b>while</b> ((<span class="r4 r">readCount</span> &lt; 10) &amp;&amp; <span class="r3 r">reader</span>.<span class="i">Read</span>())
                {
                    <b>if</b> (<b>string</b>.<span class="i">Equals</span>(<span class="s">&quot;rss&quot;</span>, <span class="r3 r">reader</span>.<span class="i">Name</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>) ||
                        <b>string</b>.<span class="i">Equals</span>(<span class="s">&quot;feed&quot;</span>, <span class="r3 r">reader</span>.<span class="i">Name</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
                    {
                        <span class="r1 r">isRssOrFeed</span> = <b>true</b>;
                        <b>break</b>;
                    }
 
                    <span class="r4 r">readCount</span>++;
                }
 
                <b>if</b> (<span class="r1 r">isRssOrFeed</span>)
                {
                    <span class="i">XmlDocument</span> <span id="r5 rd" class="r5 r">workingDocument</span> = <b>new</b>();
                    <span class="c">// performing a Read() here to avoid rrechecking</span>
                    <span class="c">// &quot;rss&quot; or &quot;feed&quot; items</span>
                    <span class="r3 r">reader</span>.<span class="i">Read</span>();
                    <b>while</b> (!<span class="r3 r">reader</span>.<span class="i">EOF</span>)
                    {
                        <span class="c">// If node is Element and it&#39;s the &#39;Item&#39; or &#39;Entry&#39; node, emit that node.</span>
                        <b>if</b> ((<span class="r3 r">reader</span>.<span class="i">NodeType</span> == <span class="i">XmlNodeType</span>.<span class="i">Element</span>) &amp;&amp;
                            (<b>string</b>.<span class="i">Equals</span>(<span class="s">&quot;Item&quot;</span>, <span class="r3 r">reader</span>.<span class="i">Name</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>) ||
                             <b>string</b>.<span class="i">Equals</span>(<span class="s">&quot;Entry&quot;</span>, <span class="r3 r">reader</span>.<span class="i">Name</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
                           )
                        {
                            <span class="c">// this one will do reader.Read() internally</span>
                            <span class="i">XmlNode</span> <span id="r6 rd" class="r6 r">result</span> = <span class="r5 r">workingDocument</span>.<span class="i">ReadNode</span>(<span class="r3 r">reader</span>);
                            <span class="i">WriteObject</span>(<span class="r6 r">result</span>);
                        }
                        <b>else</b>
                        {
                            <span class="r3 r">reader</span>.<span class="i">Read</span>();
                        }
                    }
                }
            }
            <b>catch</b> (<span class="i">XmlException</span>) { }
            <b>finally</b>
            {
                <span class="r0 r">responseStream</span>.<span class="i">Seek</span>(0, <span class="i">SeekOrigin</span>.<span class="i">Begin</span>);
            }
 
            <b>return</b> <span class="r1 r">isRssOrFeed</span>;
        }
 
        <span class="c">// Mostly cribbed from Serialization.cs#GetXmlReaderSettingsForCliXml()</span>
        <b>private static</b> <span class="i">XmlReaderSettings</span> <a id="e9c8989250129b46" href="../../../../R/e9c8989250129b46.html" target="n" data-glyph="76,1" class="i method">GetSecureXmlReaderSettings</a>()
        {
            <span class="i">XmlReaderSettings</span> <span id="r7 rd" class="r7 r">xrs</span> = <b>new</b>();
 
            <span class="r7 r">xrs</span>.<span class="i">CheckCharacters</span> = <b>false</b>;
            <span class="r7 r">xrs</span>.<span class="i">CloseInput</span> = <b>false</b>;
 
            <span class="c">// The XML data needs to be in conformance to the rules for a well-formed XML 1.0 document.</span>
            <span class="r7 r">xrs</span>.<span class="i">IgnoreProcessingInstructions</span> = <b>true</b>;
            <span class="r7 r">xrs</span>.<span class="i">MaxCharactersFromEntities</span> = 1024;
            <span class="r7 r">xrs</span>.<span class="i">DtdProcessing</span> = <span class="i">DtdProcessing</span>.<span class="i">Ignore</span>;
            <span class="r7 r">xrs</span>.<span class="i">XmlResolver</span> = <b>null</b>;
 
            <b>return</b> <span class="r7 r">xrs</span>;
        }
 
        <b>private static bool</b> <a id="0f3410079b187393" href="../../../../R/0f3410079b187393.html" target="n" data-glyph="76,1" class="i method">TryConvertToXml</a>(<b>string</b> <span id="r8 rd" class="r8 r">xml</span>, <b>out object</b> <span id="r9 rd" class="r9 r">doc</span>, <b>ref</b> <span class="i">Exception</span> <span id="r10 rd" class="r10 r">exRef</span>)
        {
            <b>try</b>
            {
                <span class="i">XmlReaderSettings</span> <span id="r11 rd" class="r11 r">settings</span> = <a href="#e9c8989250129b46" class="i method">GetSecureXmlReaderSettings</a>();
                <span class="i">XmlReader</span> <span id="r12 rd" class="r12 r">xmlReader</span> = <span class="i">XmlReader</span>.<span class="i">Create</span>(<b>new</b> <span class="i">StringReader</span>(<span class="r8 r">xml</span>), <span class="r11 r">settings</span>);
 
                <b>var</b> <span id="r13 rd" class="r13 r">xmlDoc</span> = <b>new</b> <span class="i">XmlDocument</span>();
                <span class="r13 r">xmlDoc</span>.<span class="i">PreserveWhitespace</span> = <b>true</b>;
                <span class="r13 r">xmlDoc</span>.<span class="i">Load</span>(<span class="r12 r">xmlReader</span>);
 
                <span class="r9 r">doc</span> = <span class="r13 r">xmlDoc</span>;
            }
            <b>catch</b> (<span class="i">XmlException</span> <span id="r14 rd" class="r14 r">ex</span>)
            {
                <span class="r10 r">exRef</span> = <span class="r14 r">ex</span>;
                <span class="r9 r">doc</span> = <b>null</b>;
            }
 
            <b>return</b> (<span class="r9 r">doc</span> != <b>null</b>);
        }
 
        <b>private static bool</b> <a id="c43aa225d45c0218" href="../../../../R/c43aa225d45c0218.html" target="n" data-glyph="76,1" class="i method">TryConvertToJson</a>(<b>string</b> <span id="r15 rd" class="r15 r">json</span>, <b>out object</b> <span id="r16 rd" class="r16 r">obj</span>, <b>ref</b> <span class="i">Exception</span> <span id="r17 rd" class="r17 r">exRef</span>)
        {
            <b>bool</b> <span id="r18 rd" class="r18 r">converted</span> = <b>false</b>;
            <b>try</b>
            {
                <a href="/System.Management.Automation/A.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r19 rd" class="r19 r">error</span>;
                <span class="r16 r">obj</span> = <a href="../JsonObject.cs.html#69e58ea29065a85e" class="t t">JsonObject</a>.<a href="../JsonObject.cs.html#3116fbed4ad5782e" class="i method">ConvertFromJson</a>(<span class="r15 r">json</span>, <b>out</b> <span class="r19 r">error</span>);
 
                <b>if</b> (<span class="r16 r">obj</span> == <b>null</b>)
                {
                    <span class="c">// This ensures that a null returned by ConvertFromJson() is the actual JSON null literal.</span>
                    <span class="c">// if not, the ArgumentException will be caught.</span>
                    <span class="i">JToken</span>.<span class="i">Parse</span>(<span class="r15 r">json</span>);
                }
 
                <b>if</b> (<span class="r19 r">error</span> != <b>null</b>)
                {
                    <span class="r17 r">exRef</span> = <span class="r19 r">error</span>.<a href="/System.Management.Automation/A.html#2c2498db91e737eb" class="i property">Exception</a>;
                    <span class="r16 r">obj</span> = <b>null</b>;
                }
                <b>else</b>
                {
                    <span class="r18 r">converted</span> = <b>true</b>;
                }
            }
            <b>catch</b> (<span class="i">ArgumentException</span> <span id="r20 rd" class="r20 r">ex</span>)
            {
                <span class="r17 r">exRef</span> = <span class="r20 r">ex</span>;
                <span class="r16 r">obj</span> = <b>null</b>;
            }
            <b>catch</b> (<span class="i">InvalidOperationException</span> <span id="r21 rd" class="r21 r">ex</span>)
            {
                <span class="r17 r">exRef</span> = <span class="r21 r">ex</span>;
                <span class="r16 r">obj</span> = <b>null</b>;
            }
            <b>catch</b> (<span class="i">JsonException</span> <span id="r22 rd" class="r22 r">ex</span>)
            {
                <b>var</b> <span id="r23 rd" class="r23 r">msg</span> = <b>string</b>.<span class="i">Format</span>(<span class="i n">System</span>.<span class="i">Globalization</span>.<span class="i">CultureInfo</span>.<span class="i">CurrentCulture</span>, <span class="i">WebCmdletStrings</span>.<span class="i">JsonDeserializationFailed</span>, <span class="r22 r">ex</span>.<span class="i">Message</span>);
                <span class="r17 r">exRef</span> = <b>new</b> <span class="i">ArgumentException</span>(<span class="r23 r">msg</span>, <span class="r22 r">ex</span>);
                <span class="r16 r">obj</span> = <b>null</b>;
            }
 
            <b>return</b> <span class="r18 r">converted</span>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Enum for rest return type.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public enum</b> <a id="027d8c20941b2245" href="../../../../R/027d8c20941b2245.html" target="n" data-glyph="18,1" class="t t"><span id="db43528e8b901d4e">RestReturnType</span></a>
        {
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> Return type not defined in response,</span>
            <span class="c">///</span><span class="c"> best effort detect.</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
            <a id="5dd641d380bab4b9" href="../../../../R/5dd641d380bab4b9.html" target="n" data-glyph="24,2" class="i field">Detect</a>,
 
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> Json return type.</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
            [<span class="i n">System</span>.<span class="i">Diagnostics</span>.<span class="i">CodeAnalysis</span>.<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Naming&quot;</span>, <span class="s">&quot;CA1704:IdentifiersShouldBeSpelledCorrectly&quot;</span>)]
            <a id="16b73c53f44b6254" href="../../../../R/16b73c53f44b6254.html" target="n" data-glyph="24,2" class="i field">Json</a>,
 
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> Xml return type.</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
            <a id="f9980d2d81045e28" href="../../../../R/f9980d2d81045e28.html" target="n" data-glyph="24,2" class="i field">Xml</a>,
        }
 
        <b>internal class</b> <a id="30bbe6976a0b643a" href="../../../../R/30bbe6976a0b643a.html" target="n" data-glyph="2,1" class="t t">BufferingStreamReader</a> : <span class="i">Stream</span>
        {
            <b>internal</b> <a id="0cef576156b4b5a1" href="../../../../R/0cef576156b4b5a1.html" target="n" data-glyph="74,2" class="t constructor">BufferingStreamReader</a>(<span class="i">Stream</span> <span id="r24 rd" class="r24 r">baseStream</span>)
            {
                <a href="#1ca2439a935857d8" class="i field">_baseStream</a> = <span class="r24 r">baseStream</span>;
                <a href="#a949d62e0e7d1458" class="i field">_streamBuffer</a> = <b>new</b> <span class="i">MemoryStream</span>();
                <a href="#25d4c99c4936070e" class="i field">_length</a> = <b>long</b>.<span class="i">MaxValue</span>;
                <a href="#3022a6a718c6ec9e" class="i field">_copyBuffer</a> = <b>new</b> <b>byte</b>[4096];
            }
 
            <b>private readonly</b> <span class="i">Stream</span> <a id="1ca2439a935857d8" href="../../../../R/1ca2439a935857d8.html" target="n" data-glyph="46,2" class="i field">_baseStream</a>;
            <b>private readonly</b> <span class="i">MemoryStream</span> <a id="a949d62e0e7d1458" href="../../../../R/a949d62e0e7d1458.html" target="n" data-glyph="46,2" class="i field">_streamBuffer</a>;
            <b>private readonly byte</b>[] <a id="3022a6a718c6ec9e" href="../../../../R/3022a6a718c6ec9e.html" target="n" data-glyph="46,2" class="i field">_copyBuffer</a>;
 
            <b>public override bool</b> <a id="911327d1237461a9" href="../../../../R/../../0000000000.html" target="n" data-glyph="102,2" class="i property">CanRead</a>
            {
                <b>get</b> { <b>return</b> <b>true</b>; }
            }
 
            <b>public override bool</b> <a id="17837140879b3e84" href="../../../../R/../../0000000000.html" target="n" data-glyph="102,2" class="i property">CanSeek</a>
            {
                <b>get</b> { <b>return</b> <b>true</b>; }
            }
 
            <b>public override bool</b> <a id="e769f1d1ab640e93" href="../../../../R/../../0000000000.html" target="n" data-glyph="102,2" class="i property">CanWrite</a>
            {
                <b>get</b> { <b>return</b> <b>false</b>; }
            }
 
            <b>public override void</b> <a id="3258a32b3fca8715" href="../../../../R/../../0000000000.html" target="n" data-glyph="72,2" class="i method">Flush</a>()
            {
                <a href="#a949d62e0e7d1458" class="i field">_streamBuffer</a>.<span class="i">SetLength</span>(0);
            }
 
            <b>public override long</b> <a id="34b7e03dd38a0238" href="../../../../R/../../0000000000.html" target="n" data-glyph="102,2" class="i property">Length</a>
            {
                <b>get</b> { <b>return</b> <a href="#25d4c99c4936070e" class="i field">_length</a>; }
            }
 
            <b>private long</b> <a id="25d4c99c4936070e" href="../../../../R/25d4c99c4936070e.html" target="n" data-glyph="46,2" class="i field">_length</a>;
 
            <b>public override long</b> <a id="80997d4f7511fffd" href="../../../../R/80997d4f7511fffd.html" target="n" data-glyph="102,2" class="i property">Position</a>
            {
                <b>get</b> { <b>return</b> <a href="#a949d62e0e7d1458" class="i field">_streamBuffer</a>.<span class="i">Position</span>; }
 
                <b>set</b> { <a href="#a949d62e0e7d1458" class="i field">_streamBuffer</a>.<span class="i">Position</span> = <b>value</b>; }
            }
 
            <b>public override int</b> <a id="cb7948084fe2ed8e" href="../../../../R/../../0000000000.html" target="n" data-glyph="72,2" class="i method">Read</a>(<b>byte</b>[] <span id="r25 rd" class="r25 r">buffer</span>, <b>int</b> <span id="r26 rd" class="r26 r">offset</span>, <b>int</b> <span id="r27 rd" class="r27 r">count</span>)
            {
                <b>long</b> <span id="r28 rd" class="r28 r">previousPosition</span> = <a href="#80997d4f7511fffd" class="i property">Position</a>;
                <b>bool</b> <span id="r29 rd" class="r29 r">consumedStream</span> = <b>false</b>;
                <b>int</b> <span id="r30 rd" class="r30 r">totalCount</span> = <span class="r27 r">count</span>;
                <b>while</b> ((!<span class="r29 r">consumedStream</span>) &amp;&amp;
                    ((<a href="#80997d4f7511fffd" class="i property">Position</a> + <span class="r30 r">totalCount</span>) &gt; <a href="#a949d62e0e7d1458" class="i field">_streamBuffer</a>.<span class="i">Length</span>))
                {
                    <span class="c">// If we don&#39;t have enough data to fill this from memory, cache more.</span>
                    <span class="c">// We try to read 4096 bytes from base stream every time, so at most we</span>
                    <span class="c">// may cache 4095 bytes more than what is required by the Read operation.</span>
                    <b>int</b> <span id="r31 rd" class="r31 r">bytesRead</span> = <a href="#1ca2439a935857d8" class="i field">_baseStream</a>.<span class="i">Read</span>(<a href="#3022a6a718c6ec9e" class="i field">_copyBuffer</a>, 0, <a href="#3022a6a718c6ec9e" class="i field">_copyBuffer</a>.<span class="i">Length</span>);
 
                    <b>if</b> (<a href="#a949d62e0e7d1458" class="i field">_streamBuffer</a>.<span class="i">Position</span> &lt; <a href="#a949d62e0e7d1458" class="i field">_streamBuffer</a>.<span class="i">Length</span>)
                    {
                        <span class="c">// Win8: 651902 no need to -1 here as Position refers to the place</span>
                        <span class="c">// where we can start writing from.</span>
                        <a href="#a949d62e0e7d1458" class="i field">_streamBuffer</a>.<span class="i">Position</span> = <a href="#a949d62e0e7d1458" class="i field">_streamBuffer</a>.<span class="i">Length</span>;
                    }
 
                    <a href="#a949d62e0e7d1458" class="i field">_streamBuffer</a>.<span class="i">Write</span>(<a href="#3022a6a718c6ec9e" class="i field">_copyBuffer</a>, 0, <span class="r31 r">bytesRead</span>);
 
                    <span class="r30 r">totalCount</span> -= <span class="r31 r">bytesRead</span>;
                    <b>if</b> (<span class="r31 r">bytesRead</span> &lt; <a href="#3022a6a718c6ec9e" class="i field">_copyBuffer</a>.<span class="i">Length</span>)
                    {
                        <span class="r29 r">consumedStream</span> = <b>true</b>;
                    }
                }
 
                <span class="c">// Reset our backing store to its official position, as reading</span>
                <span class="c">// for the CopyTo updates the position.</span>
                <a href="#a949d62e0e7d1458" class="i field">_streamBuffer</a>.<span class="i">Seek</span>(<span class="r28 r">previousPosition</span>, <span class="i">SeekOrigin</span>.<span class="i">Begin</span>);
 
                <span class="c">// Read from the backing store into the requested buffer.</span>
                <b>int</b> <span id="r32 rd" class="r32 r">read</span> = <a href="#a949d62e0e7d1458" class="i field">_streamBuffer</a>.<span class="i">Read</span>(<span class="r25 r">buffer</span>, <span class="r26 r">offset</span>, <span class="r27 r">count</span>);
 
                <b>if</b> (<span class="r32 r">read</span> &lt; <span class="r27 r">count</span>)
                {
                    <a href="#18dfa1f5eb3e6035" class="i method">SetLength</a>(<a href="#80997d4f7511fffd" class="i property">Position</a>);
                }
 
                <b>return</b> <span class="r32 r">read</span>;
            }
 
            <b>public override long</b> <a id="69ca32d5efbb77ff" href="../../../../R/../../0000000000.html" target="n" data-glyph="72,2" class="i method">Seek</a>(<b>long</b> <span id="r33 rd" class="r33 r">offset</span>, <span class="i">SeekOrigin</span> <span id="r34 rd" class="r34 r">origin</span>)
            {
                <b>return</b> <a href="#a949d62e0e7d1458" class="i field">_streamBuffer</a>.<span class="i">Seek</span>(<span class="r33 r">offset</span>, <span class="r34 r">origin</span>);
            }
 
            <b>public override void</b> <a id="18dfa1f5eb3e6035" href="../../../../R/18dfa1f5eb3e6035.html" target="n" data-glyph="72,2" class="i method">SetLength</a>(<b>long</b> <span id="r35 rd" class="r35 r">value</span>)
            {
                <a href="#25d4c99c4936070e" class="i field">_length</a> = <span class="r35 r">value</span>;
            }
 
            <b>public override void</b> <a id="41ed65edcff97e0c" href="../../../../R/../../0000000000.html" target="n" data-glyph="72,2" class="i method">Write</a>(<b>byte</b>[] <span id="r36 rd" class="r36 r">buffer</span>, <b>int</b> <span id="r37 rd" class="r37 r">offset</span>, <b>int</b> <span id="r38 rd" class="r38 r">count</span>)
            {
                <b>throw</b> <b>new</b> <span class="i">NotSupportedException</span>();
            }
        }
    }
 
    <span class="c">// TODO: Merge Partials</span>
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> The Invoke-RestMethod command</span>
    <span class="c">///</span><span class="c"> This command makes an HTTP or HTTPS request to a web service,</span>
    <span class="c">///</span><span class="c"> and returns the response in an appropriate way.</span>
    <span class="c">///</span><span class="c"> Intended to work against the wide spectrum of &quot;RESTful&quot; web services</span>
    <span class="c">///</span><span class="c"> currently deployed across the web.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    [<span class="i">Cmdlet</span>(<a href="/System.Management.Automation/A.html#1a8e85c66f6fff18" class="t t">VerbsLifecycle</a>.<a href="/System.Management.Automation/A.html#b5f3af3d6aa6e852" class="i field">Invoke</a>, <span class="s">&quot;RestMethod&quot;</span>, <span class="i">HelpUri</span> = <span class="s">&quot;https://go.microsoft.com/fwlink/?LinkID=2096706&quot;</span>, <span class="i">DefaultParameterSetName</span> = <span class="s">&quot;StandardMethod&quot;</span>)]
    <b>public</b> <a href="../../../../P/d065ea9052e26dc0.html" target="s" class="k">partial</a> <b>class</b> <span class="t t">InvokeRestMethodCommand</span> : <a href="../../../../P/662e7ae18a2eef77.html#662e7ae18a2eef77" class="t t">WebRequestPSCmdlet</a>
    {
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Virtual Method Overrides
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Process the web response and output corresponding objects.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r39 r">response</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal override void</b> <a id="0dcafa1b9a7084ab" href="../../../../R/0dcafa1b9a7084ab.html" target="n" data-glyph="74,1" class="i method">ProcessResponse</a>(<span class="i">HttpResponseMessage</span> <span id="r39 rd" class="r39 r">response</span>)
        {
            <b>if</b> (<span class="r39 r">response</span> == <b>null</b>) { <b>throw</b> <b>new</b> <span class="i">ArgumentNullException</span>(<b>nameof</b>(<span class="r39 r">response</span>)); }
 
            <b>var</b> <span id="r40 rd" class="r40 r">baseResponseStream</span> = <a href="../StreamHelper.cs.html#feacf5faafa43405" class="t t">StreamHelper</a>.<a href="../StreamHelper.cs.html#2ba676a5705cd62c" class="i method">GetResponseStream</a>(<span class="r39 r">response</span>);
 
            <b>if</b> (<a href="WebRequestPSCmdlet.Common.cs.html#c1feb55e5689bdb8" class="i property">ShouldWriteToPipeline</a>)
            {
                <b>using</b> <a href="#30bbe6976a0b643a" class="k">var</a> <span id="r41 rd" class="r41 r">responseStream</span> = <b>new</b> <a href="#0cef576156b4b5a1" class="t constructor">BufferingStreamReader</a>(<span class="r40 r">baseResponseStream</span>);
 
                <span class="c">// First see if it is an RSS / ATOM feed, in which case we can</span>
                <span class="c">// stream it - unless the user has overridden it with a return type of &quot;XML&quot;</span>
                <b>if</b> (<span class="i">TryProcessFeedStream</span>(<span class="r41 r">responseStream</span>))
                {
                    <span class="c">// Do nothing, content has been processed.</span>
                }
                <b>else</b>
                {
                    <span class="c">// determine the response type</span>
                    <a href="#027d8c20941b2245" class="t t">RestReturnType</a> <span id="r42 rd" class="r42 r">returnType</span> = <a href="#fc24f02aa07ea737" class="i method">CheckReturnType</a>(<span class="r39 r">response</span>);
 
                    <span class="c">// Try to get the response encoding from the ContentType header.</span>
                    <span class="i">Encoding</span> <span id="r43 rd" class="r43 r">encoding</span> = <b>null</b>;
                    <b>string</b> <span id="r44 rd" class="r44 r">charSet</span> = <span class="r39 r">response</span>.<span class="i">Content</span>.<span class="i">Headers</span>.<span class="i">ContentType</span>?.<span class="i">CharSet</span>;
                    <b>if</b> (!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r44 r">charSet</span>))
                    {
                        <span class="c">// NOTE: Don&#39;t use ContentHelper.GetEncoding; it returns a</span>
                        <span class="c">// default which bypasses checking for a meta charset value.</span>
                        <a href="../StreamHelper.cs.html#feacf5faafa43405" class="t t">StreamHelper</a>.<a href="../StreamHelper.cs.html#8f3537a86438fe87" class="i method">TryGetEncoding</a>(<span class="r44 r">charSet</span>, <b>out</b> <span class="r43 r">encoding</span>);
                    }
 
                    <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r44 r">charSet</span>) &amp;&amp; <span class="r42 r">returnType</span> == <a href="#027d8c20941b2245" class="t t">RestReturnType</a>.<a href="#16b73c53f44b6254" class="i field">Json</a>)
                    {
                        <span class="r43 r">encoding</span> = <span class="i">Encoding</span>.<span class="i">UTF8</span>;
                    }
 
                    <b>object</b> <span id="r45 rd" class="r45 r">obj</span> = <b>null</b>;
                    <span class="i">Exception</span> <span id="r46 rd" class="r46 r">ex</span> = <b>null</b>;
 
                    <b>string</b> <span id="r47 rd" class="r47 r">str</span> = <a href="../StreamHelper.cs.html#feacf5faafa43405" class="t t">StreamHelper</a>.<span class="i">DecodeStream</span>(<span class="r41 r">responseStream</span>, <b>ref</b> <span class="r43 r">encoding</span>);
 
                    <b>string</b> <span id="r48 rd" class="r48 r">encodingVerboseName</span>;
                    <b>try</b>
                    {
                        <span class="r48 r">encodingVerboseName</span> = <b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r43 r">encoding</span>.<span class="i">HeaderName</span>) ? <span class="r43 r">encoding</span>.<span class="i">EncodingName</span> : <span class="r43 r">encoding</span>.<span class="i">HeaderName</span>;
                    }
                    <b>catch</b> (<span class="i">NotSupportedException</span>)
                    {
                        <span class="r48 r">encodingVerboseName</span> = <span class="r43 r">encoding</span>.<span class="i">EncodingName</span>;
                    }
                    <span class="c">// NOTE: Tests use this verbose output to verify the encoding.</span>
                    <span class="i">WriteVerbose</span>(<b>string</b>.<span class="i">Format</span>
                    (
                        <span class="i n">System</span>.<span class="i">Globalization</span>.<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>,
                        <span class="s">&quot;Content encoding: {0}&quot;</span>,
                        <span class="r48 r">encodingVerboseName</span>)
                    );
                    <b>bool</b> <span id="r49 rd" class="r49 r">convertSuccess</span> = <b>false</b>;
 
                    <b>if</b> (<span class="r42 r">returnType</span> == <a href="#027d8c20941b2245" class="t t">RestReturnType</a>.<a href="#16b73c53f44b6254" class="i field">Json</a>)
                    {
                        <span class="r49 r">convertSuccess</span> = <a href="#c43aa225d45c0218" class="i method">TryConvertToJson</a>(<span class="r47 r">str</span>, <b>out</b> <span class="r45 r">obj</span>, <b>ref</b> <span class="r46 r">ex</span>) || <a href="#0f3410079b187393" class="i method">TryConvertToXml</a>(<span class="r47 r">str</span>, <b>out</b> <span class="r45 r">obj</span>, <b>ref</b> <span class="r46 r">ex</span>);
                    }
                    <span class="c">// default to try xml first since it&#39;s more common</span>
                    <b>else</b>
                    {
                        <span class="r49 r">convertSuccess</span> = <a href="#0f3410079b187393" class="i method">TryConvertToXml</a>(<span class="r47 r">str</span>, <b>out</b> <span class="r45 r">obj</span>, <b>ref</b> <span class="r46 r">ex</span>) || <a href="#c43aa225d45c0218" class="i method">TryConvertToJson</a>(<span class="r47 r">str</span>, <b>out</b> <span class="r45 r">obj</span>, <b>ref</b> <span class="r46 r">ex</span>);
                    }
 
                    <b>if</b> (!<span class="r49 r">convertSuccess</span>)
                    {
                        <span class="c">// fallback to string</span>
                        <span class="r45 r">obj</span> = <span class="r47 r">str</span>;
                    }
 
                    <span class="i">WriteObject</span>(<span class="r45 r">obj</span>);
                }
            }
            <b>else</b> <b>if</b> (<a href="WebRequestPSCmdlet.Common.cs.html#9f22bf862539cda0" class="i property">ShouldSaveToOutFile</a>)
            {
                <a href="../StreamHelper.cs.html#feacf5faafa43405" class="t t">StreamHelper</a>.<span class="i">SaveStreamToFile</span>(<span class="r40 r">baseResponseStream</span>, <a href="WebRequestPSCmdlet.Common.cs.html#862b1a7c65f11752" class="i property">QualifiedOutFile</a>, <a href="../../../../P/d065ea9052e26dc0.html#d065ea9052e26dc0" class="k">this</a>, <a href="WebRequestPSCmdlet.Common.cs.html#0cceefd1240619f1" class="i field">_cancelToken</a>.<span class="i">Token</span>);
            }
 
            <b>if</b> (!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<a href="#ed4b89c8b4caa57d" class="i property">StatusCodeVariable</a>))
            {
                <a href="/System.Management.Automation/A.html#a66e215a6e6c92d5" class="t t">PSVariableIntrinsics</a> <span id="r50 rd" class="r50 r">vi</span> = <a href="/System.Management.Automation/A.html#5078d443148de142" class="i property">SessionState</a>.<a href="/System.Management.Automation/A.html#0198da5eba13cb75" class="i property">PSVariable</a>;
                <span class="r50 r">vi</span>.<span class="i">Set</span>(<a href="#ed4b89c8b4caa57d" class="i property">StatusCodeVariable</a>, (<b>int</b>)<span class="r39 r">response</span>.<span class="i">StatusCode</span>);
            }
 
            <b>if</b> (!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<a href="#400ebf69794902d7" class="i property">ResponseHeadersVariable</a>))
            {
                <a href="/System.Management.Automation/A.html#a66e215a6e6c92d5" class="t t">PSVariableIntrinsics</a> <span id="r51 rd" class="r51 r">vi</span> = <a href="/System.Management.Automation/A.html#5078d443148de142" class="i property">SessionState</a>.<a href="/System.Management.Automation/A.html#0198da5eba13cb75" class="i property">PSVariable</a>;
                <span class="r51 r">vi</span>.<span class="i">Set</span>(<a href="#400ebf69794902d7" class="i property">ResponseHeadersVariable</a>, <a href="../CoreCLR/WebResponseHelper.CoreClr.cs.html#27222f3f82d0577c" class="t t">WebResponseHelper</a>.<a href="../CoreCLR/WebResponseHelper.CoreClr.cs.html#dfcaea3a8b0abaf7" class="i method">GetHeadersDictionary</a>(<span class="r39 r">response</span>));
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Virtual Method Overrides
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Helper Methods
 
        <b>private static</b> <a href="#027d8c20941b2245" class="t t">RestReturnType</a> <a id="fc24f02aa07ea737" href="../../../../R/fc24f02aa07ea737.html" target="n" data-glyph="76,1" class="i method">CheckReturnType</a>(<span class="i">HttpResponseMessage</span> <span id="r52 rd" class="r52 r">response</span>)
        {
            <b>if</b> (<span class="r52 r">response</span> == <b>null</b>) { <b>throw</b> <b>new</b> <span class="i">ArgumentNullException</span>(<b>nameof</b>(<span class="r52 r">response</span>)); }
 
            <a href="#027d8c20941b2245" class="t t">RestReturnType</a> <span id="r53 rd" class="r53 r">rt</span> = <a href="#027d8c20941b2245" class="t t">RestReturnType</a>.<a href="#5dd641d380bab4b9" class="i field">Detect</a>;
            <b>string</b> <span id="r54 rd" class="r54 r">contentType</span> = <a href="ContentHelper.Common.cs.html#a2c3d2d23cfdf964" class="t t">ContentHelper</a>.<a href="ContentHelper.Common.cs.html#44e28e8c2b9a8884" class="i method">GetContentType</a>(<span class="r52 r">response</span>);
            <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r54 r">contentType</span>))
            {
                <span class="r53 r">rt</span> = <a href="#027d8c20941b2245" class="t t">RestReturnType</a>.<a href="#5dd641d380bab4b9" class="i field">Detect</a>;
            }
            <b>else</b> <b>if</b> (<a href="ContentHelper.Common.cs.html#a2c3d2d23cfdf964" class="t t">ContentHelper</a>.<a href="ContentHelper.Common.cs.html#f054f877be3fad32" class="i method">IsJson</a>(<span class="r54 r">contentType</span>))
            {
                <span class="r53 r">rt</span> = <a href="#027d8c20941b2245" class="t t">RestReturnType</a>.<a href="#16b73c53f44b6254" class="i field">Json</a>;
            }
            <b>else</b> <b>if</b> (<a href="ContentHelper.Common.cs.html#a2c3d2d23cfdf964" class="t t">ContentHelper</a>.<a href="ContentHelper.Common.cs.html#af6b2808decdd880" class="i method">IsXml</a>(<span class="r54 r">contentType</span>))
            {
                <span class="r53 r">rt</span> = <a href="#027d8c20941b2245" class="t t">RestReturnType</a>.<a href="#f9980d2d81045e28" class="i field">Xml</a>;
            }
 
            <b>return</b> (<span class="r53 r">rt</span>);
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Helper Methods
    }
}
</pre></td></tr></table></div></body></html>
