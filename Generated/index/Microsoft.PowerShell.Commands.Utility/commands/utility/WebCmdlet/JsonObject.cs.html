<!DOCTYPE html>
<html><head><title>JsonObject.cs</title><link rel="stylesheet" href="../../../../styles.css"><script src="../../../../scripts.js"></script></head>
<body class="cB" onload="i(823);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#Microsoft.PowerShell.Commands.Utility/commands/utility/WebCmdlet/JsonObject.cs" target="_top">commands\utility\WebCmdlet\JsonObject.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#Microsoft.PowerShell.Commands.Utility" target="_top">src\Microsoft.PowerShell.Commands.Utility\Microsoft.PowerShell.Commands.Utility.csproj</a> (Microsoft.PowerShell.Commands.Utility)</td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation.</span>
<span class="c">// Licensed under the MIT License.</span>
 
<b>using</b> <span class="i n">System</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Collections</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Collections</span>.<span class="i">Generic</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Diagnostics</span>.<span class="i">CodeAnalysis</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Globalization</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Language</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Reflection</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Text</span>.<span class="i">RegularExpressions</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Threading</span>;
 
<b>using</b> <span class="i">Newtonsoft</span>.<span class="i">Json</span>;
<b>using</b> <span class="i">Newtonsoft</span>.<span class="i">Json</span>.<span class="i">Converters</span>;
<b>using</b> <span class="i">Newtonsoft</span>.<span class="i">Json</span>.<span class="i">Linq</span>;
 
<b>namespace</b> <span class="i n">Microsoft</span>.<span class="i n">PowerShell</span>.<span class="i n">Commands</span>
{
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> JsonObject class.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Naming&quot;</span>, <span class="s">&quot;CA1704:IdentifiersShouldBeSpelledCorrectly&quot;</span>, <span class="i">Justification</span> = <span class="s">&quot;Preferring Json over JSON&quot;</span>)]
    <b>public static class</b> <a id="69e58ea29065a85e" href="../../../R/69e58ea29065a85e.html" target="n" data-glyph="0,0" class="t t">JsonObject</a>
    {
        <span class="k preprocess">#</span><span class="k preprocess">region</span> HelperTypes
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Context for convert-to-json operation.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public readonly struct</b> <a id="612020afe9d908eb" href="../../../R/612020afe9d908eb.html" target="n" data-glyph="108,1" class="t t"><span id="ec1d6d0716447bdf">ConvertToJsonContext</span></a>
        {
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> Gets the maximum depth for walking the object graph.</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
            <b>public readonly int</b> <a id="efb01dae7c8ae813" href="../../../R/efb01dae7c8ae813.html" target="n" data-glyph="42,2" class="i field">MaxDepth</a>;
 
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> Gets the cancellation token.</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
            <b>public readonly</b> <span class="i">CancellationToken</span> <a id="16af385b1fd04e28" href="../../../R/16af385b1fd04e28.html" target="n" data-glyph="42,2" class="i field">CancellationToken</a>;
 
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> Gets the StringEscapeHandling setting.</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
            <b>public readonly</b> <span class="i">StringEscapeHandling</span> <a id="cd64043299c258b4" href="../../../R/cd64043299c258b4.html" target="n" data-glyph="42,2" class="i field">StringEscapeHandling</a>;
 
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> Gets the EnumsAsStrings setting.</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
            <b>public readonly bool</b> <a id="ad8057060bde7583" href="../../../R/ad8057060bde7583.html" target="n" data-glyph="42,2" class="i field">EnumsAsStrings</a>;
 
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> Gets the CompressOutput setting.</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
            <b>public readonly bool</b> <a id="914ae0958d0f56f1" href="../../../R/914ae0958d0f56f1.html" target="n" data-glyph="42,2" class="i field">CompressOutput</a>;
 
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> Gets the target cmdlet that is doing the convert-to-json operation.</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
            <b>public readonly</b> <a href="/System.Management.Automation/A.html#30543a6971fed1fc" class="t t">PSCmdlet</a> <a id="33d606bca96a749a" href="../../../R/33d606bca96a749a.html" target="n" data-glyph="42,2" class="i field">Cmdlet</a>;
 
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> Initializes a new instance of the </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="#612020afe9d908eb" class="t t">ConvertToJsonContext</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> struct.</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r0 r">maxDepth</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The maximum depth to visit the object.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r1 r">enumsAsStrings</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Indicates whether to use enum names for the JSON conversion.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r2 r">compressOutput</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Indicates whether to get the compressed output.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
            <b>public</b> <a id="d87c4df34495ede0" href="../../../R/../../0000000000.html" target="n" data-glyph="72,2" class="t constructor">ConvertToJsonContext</a>(<b>int</b> <span id="r0 rd" class="r0 r">maxDepth</span>, <b>bool</b> <span id="r1 rd" class="r1 r">enumsAsStrings</span>, <b>bool</b> <span id="r2 rd" class="r2 r">compressOutput</span>)
                : <b>this</b>(<span class="r0 r">maxDepth</span>, <span class="r1 r">enumsAsStrings</span>, <span class="r2 r">compressOutput</span>, <a href="#cd64043299c258b4" class="i field">StringEscapeHandling</a>.<span class="i">Default</span>, <span class="i">targetCmdlet</span>: <b>null</b>, <a href="#16af385b1fd04e28" class="i field">CancellationToken</a>.<span class="i">None</span>)
            {
            }
 
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> Initializes a new instance of the </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="#612020afe9d908eb" class="t t">ConvertToJsonContext</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> struct.</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r3 r">maxDepth</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The maximum depth to visit the object.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r4 r">enumsAsStrings</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Indicates whether to use enum names for the JSON conversion.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r5 r">compressOutput</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Indicates whether to get the compressed output.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r6 r">stringEscapeHandling</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Specifies how strings are escaped when writing JSON text.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r7 r">targetCmdlet</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Specifies the cmdlet that is calling this method.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r8 r">cancellationToken</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Specifies the cancellation token for cancelling the operation.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
            <b>public</b> <a id="93d5e5e792ae735d" href="../../../R/../../0000000000.html" target="n" data-glyph="72,2" class="t constructor">ConvertToJsonContext</a>(
                <b>int</b> <span id="r3 rd" class="r3 r">maxDepth</span>,
                <b>bool</b> <span id="r4 rd" class="r4 r">enumsAsStrings</span>,
                <b>bool</b> <span id="r5 rd" class="r5 r">compressOutput</span>,
                <span class="i">StringEscapeHandling</span> <span id="r6 rd" class="r6 r">stringEscapeHandling</span>,
                <a href="/System.Management.Automation/A.html#30543a6971fed1fc" class="t t">PSCmdlet</a> <span id="r7 rd" class="r7 r">targetCmdlet</span>,
                <span class="i">CancellationToken</span> <span id="r8 rd" class="r8 r">cancellationToken</span>)
            {
                <a href="#612020afe9d908eb" class="k">this</a>.<a href="#efb01dae7c8ae813" class="i field">MaxDepth</a> = <span class="r3 r">maxDepth</span>;
                <a href="#612020afe9d908eb" class="k">this</a>.<a href="#16af385b1fd04e28" class="i field">CancellationToken</a> = <span class="r8 r">cancellationToken</span>;
                <a href="#612020afe9d908eb" class="k">this</a>.<a href="#cd64043299c258b4" class="i field">StringEscapeHandling</a> = <span class="r6 r">stringEscapeHandling</span>;
                <a href="#612020afe9d908eb" class="k">this</a>.<a href="#ad8057060bde7583" class="i field">EnumsAsStrings</a> = <span class="r4 r">enumsAsStrings</span>;
                <a href="#612020afe9d908eb" class="k">this</a>.<a href="#914ae0958d0f56f1" class="i field">CompressOutput</a> = <span class="r5 r">compressOutput</span>;
                <a href="#612020afe9d908eb" class="k">this</a>.<a href="#33d606bca96a749a" class="i field">Cmdlet</a> = <span class="r7 r">targetCmdlet</span>;
            }
        }
 
        <b>private sealed class</b> <a id="8f7e67c2762e436d" href="../../../R/8f7e67c2762e436d.html" target="n" data-glyph="4,1" class="t t">DuplicateMemberHashSet</a> : <span class="i">HashSet</span>&lt;<b>string</b>&gt;
        {
            <b>public</b> <a id="ebb130d744d2ac56" href="../../../R/../../0000000000.html" target="n" data-glyph="72,2" class="t constructor">DuplicateMemberHashSet</a>(<b>int</b> <span id="r9 rd" class="r9 r">capacity</span>)
                : <b>base</b>(<span class="r9 r">capacity</span>, <span class="i">StringComparer</span>.<span class="i">OrdinalIgnoreCase</span>)
            {
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> HelperTypes
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> ConvertFromJson
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Convert a Json string back to an object of type PSObject.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r10 r">input</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The json text to convert.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r11 r">error</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">An error record if the conversion failed.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">A PSObject.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Naming&quot;</span>, <span class="s">&quot;CA1704:IdentifiersShouldBeSpelledCorrectly&quot;</span>, <span class="i">Justification</span> = <span class="s">&quot;Preferring Json over JSON&quot;</span>)]
        <b>public static object</b> <a id="3116fbed4ad5782e" href="../../../R/3116fbed4ad5782e.html" target="n" data-glyph="72,1" class="i method">ConvertFromJson</a>(<b>string</b> <span id="r10 rd" class="r10 r">input</span>, <b>out</b> <a href="/System.Management.Automation/A.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r11 rd" class="r11 r">error</span>)
        {
            <b>return</b> <a href="#3ed72335edc47569" class="i method">ConvertFromJson</a>(<span class="r10 r">input</span>, <span class="r12 r">returnHashtable</span>: <b>false</b>, <b>out</b> <span class="r11 r">error</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Convert a Json string back to an object of type </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="/System.Management.Automation/A.html#a3c2513aa3da07fa" class="t t">PSObject</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> or</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">System</span>.<span class="i">Collections</span>.<span class="i">Hashtable</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> depending on parameter </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r12 r">returnHashtable</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c">.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r13 r">input</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The json text to convert.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r12 r">returnHashtable</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">True if the result should be returned as a </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">System</span>.<span class="i">Collections</span>.<span class="i">Hashtable</span><span class="c">&quot;</span><span class="c">/&gt;</span>
        <span class="c">///</span><span class="c"> instead of a </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="/System.Management.Automation/A.html#a3c2513aa3da07fa" class="t t">PSObject</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r14 r">error</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">An error record if the conversion failed.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">A </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="/System.Management.Automation/A.html#a3c2513aa3da07fa" class="t t">PSObject</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> or a </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">System</span>.<span class="i">Collections</span>.<span class="i">Hashtable</span><span class="c">&quot;</span><span class="c">/&gt;</span>
        <span class="c">///</span><span class="c"> if the </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r12 r">returnHashtable</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> parameter is true.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Naming&quot;</span>, <span class="s">&quot;CA1704:IdentifiersShouldBeSpelledCorrectly&quot;</span>, <span class="i">Justification</span> = <span class="s">&quot;Preferring Json over JSON&quot;</span>)]
        <b>public static object</b> <a id="3ed72335edc47569" href="../../../R/3ed72335edc47569.html" target="n" data-glyph="72,1" class="i method">ConvertFromJson</a>(<b>string</b> <span id="r13 rd" class="r13 r">input</span>, <b>bool</b> <span id="r12 rd" class="r12 r">returnHashtable</span>, <b>out</b> <a href="/System.Management.Automation/A.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r14 rd" class="r14 r">error</span>)
        {
            <b>return</b> <a href="#abf6ce027db4fcba" class="i method">ConvertFromJson</a>(<span class="r13 r">input</span>, <span class="r12 r">returnHashtable</span>, <span class="r15 r">maxDepth</span>: 1024, <b>out</b> <span class="r14 r">error</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Convert a JSON string back to an object of type </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="/System.Management.Automation/A.html#a3c2513aa3da07fa" class="t t">PSObject</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> or</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">System</span>.<span class="i">Collections</span>.<span class="i">Hashtable</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> depending on parameter </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r16 r">returnHashtable</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c">.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r17 r">input</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The JSON text to convert.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r16 r">returnHashtable</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">True if the result should be returned as a </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">System</span>.<span class="i">Collections</span>.<span class="i">Hashtable</span><span class="c">&quot;</span><span class="c">/&gt;</span>
        <span class="c">///</span><span class="c"> instead of a </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="/System.Management.Automation/A.html#a3c2513aa3da07fa" class="t t">PSObject</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c">.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r15 r">maxDepth</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The max depth allowed when deserializing the json input. Set to null for no maximum.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r18 r">error</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">An error record if the conversion failed.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">A </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="/System.Management.Automation/A.html#a3c2513aa3da07fa" class="t t">PSObject</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> or a </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">System</span>.<span class="i">Collections</span>.<span class="i">Hashtable</span><span class="c">&quot;</span><span class="c">/&gt;</span>
        <span class="c">///</span><span class="c"> if the </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r16 r">returnHashtable</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> parameter is true.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Naming&quot;</span>, <span class="s">&quot;CA1704:IdentifiersShouldBeSpelledCorrectly&quot;</span>, <span class="i">Justification</span> = <span class="s">&quot;Preferring Json over JSON&quot;</span>)]
        <b>public static object</b> <a id="abf6ce027db4fcba" href="../../../R/abf6ce027db4fcba.html" target="n" data-glyph="72,1" class="i method">ConvertFromJson</a>(<b>string</b> <span id="r17 rd" class="r17 r">input</span>, <b>bool</b> <span id="r16 rd" class="r16 r">returnHashtable</span>, <b>int</b>? <span id="r15 rd" class="r15 r">maxDepth</span>, <b>out</b> <a href="/System.Management.Automation/A.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r18 rd" class="r18 r">error</span>)
        {
            <b>if</b> (<span class="r17 r">input</span> == <b>null</b>)
            {
                <b>throw</b> <b>new</b> <span class="i">ArgumentNullException</span>(<b>nameof</b>(<span class="r17 r">input</span>));
            }
 
            <span class="r18 r">error</span> = <b>null</b>;
            <b>try</b>
            {
                <span class="c">// JsonConvert.DeserializeObject does not throw an exception when an invalid Json array is passed.</span>
                <span class="c">// This issue is being tracked by https://github.com/JamesNK/Newtonsoft.Json/issues/1930.</span>
                <span class="c">// To work around this, we need to identify when input is a Json array, and then try to parse it via JArray.Parse().</span>
 
                <span class="c">// If input starts with &#39;[&#39; (ignoring white spaces).</span>
                <b>if</b> (<span class="i">Regex</span>.<span class="i">Match</span>(<span class="r17 r">input</span>, <span class="s">@&quot;^\s*\[&quot;</span>).<span class="i">Success</span>)
                {
                    <span class="c">// JArray.Parse() will throw a JsonException if the array is invalid.</span>
                    <span class="c">// This will be caught by the catch block below, and then throw an</span>
                    <span class="c">// ArgumentException - this is done to have same behavior as the JavaScriptSerializer.</span>
                    <span class="i">JArray</span>.<span class="i">Parse</span>(<span class="r17 r">input</span>);
 
                    <span class="c">// Please note that if the Json array is valid, we don&#39;t do anything,</span>
                    <span class="c">// we just continue the deserialization.</span>
                }
 
                <b>var</b> <span id="r19 rd" class="r19 r">obj</span> = <span class="i">JsonConvert</span>.<span class="i">DeserializeObject</span>(
                    <span class="r17 r">input</span>,
                    <b>new</b> <span class="i">JsonSerializerSettings</span>
                    {
                        <span class="c">// This TypeNameHandling setting is required to be secure.</span>
                        <span class="i">TypeNameHandling</span> = <span class="i">TypeNameHandling</span>.<span class="i">None</span>,
                        <span class="i">MetadataPropertyHandling</span> = <span class="i">MetadataPropertyHandling</span>.<span class="i">Ignore</span>,
                        <span class="i">MaxDepth</span> = <span class="r15 r">maxDepth</span>
                    });
 
                <b>switch</b> (<span class="r19 r">obj</span>)
                {
                    <b>case</b> <span class="i">JObject</span> <span id="r20 rd" class="r20 r">dictionary</span>:
                        <span class="c">// JObject is a IDictionary</span>
                        <b>return</b> <span class="r16 r">returnHashtable</span>
                                   ? <a href="#5bf9bc69b6c3cd9f" class="i method">PopulateHashTableFromJDictionary</a>(<span class="r20 r">dictionary</span>, <b>out</b> <span class="r18 r">error</span>)
                                   : <a href="#6fc72828f26f742e" class="i method">PopulateFromJDictionary</a>(<span class="r20 r">dictionary</span>, <b>new</b> <span class="t">DuplicateMemberHashSet</span>(<span class="r20 r">dictionary</span>.<span class="i">Count</span>), <b>out</b> <span class="r18 r">error</span>);
                    <b>case</b> <span class="i">JArray</span> <span id="r21 rd" class="r21 r">list</span>:
                        <b>return</b> <span class="r16 r">returnHashtable</span>
                                   ? <a href="#8b6baccedd34d6cb" class="i method">PopulateHashTableFromJArray</a>(<span class="r21 r">list</span>, <b>out</b> <span class="r18 r">error</span>)
                                   : <a href="#ce420eb773094ccf" class="i method">PopulateFromJArray</a>(<span class="r21 r">list</span>, <b>out</b> <span class="r18 r">error</span>);
                    <b>default</b>:
                        <b>return</b> <span class="r19 r">obj</span>;
                }
            }
            <b>catch</b> (<span class="i">JsonException</span> <span id="r22 rd" class="r22 r">je</span>)
            {
                <b>var</b> <span id="r23 rd" class="r23 r">msg</span> = <b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">CurrentCulture</span>, <span class="i">WebCmdletStrings</span>.<span class="i">JsonDeserializationFailed</span>, <span class="r22 r">je</span>.<span class="i">Message</span>);
 
                <span class="c">// the same as JavaScriptSerializer does</span>
                <b>throw</b> <b>new</b> <span class="i">ArgumentException</span>(<span class="r23 r">msg</span>, <span class="r22 r">je</span>);
            }
        }
 
        <span class="c">// This function is a clone of PopulateFromDictionary using JObject as an input.</span>
        <b>private static</b> <a href="/System.Management.Automation/A.html#a3c2513aa3da07fa" class="t t">PSObject</a> <a id="6fc72828f26f742e" href="../../../R/6fc72828f26f742e.html" target="n" data-glyph="76,1" class="i method">PopulateFromJDictionary</a>(<span class="i">JObject</span> <span id="r24 rd" class="r24 r">entries</span>, <a href="#8f7e67c2762e436d" class="t t">DuplicateMemberHashSet</a> <span id="r25 rd" class="r25 r">memberHashTracker</span>, <b>out</b> <a href="/System.Management.Automation/A.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r26 rd" class="r26 r">error</span>)
        {
            <span class="r26 r">error</span> = <b>null</b>;
            <a href="/System.Management.Automation/A.html#a3c2513aa3da07fa" class="k">var</a> <span id="r27 rd" class="r27 r">result</span> = <b>new</b> <span class="t">PSObject</span>(<span class="r24 r">entries</span>.<span class="i">Count</span>);
            <b>foreach</b> (<b>var</b> <span id="r28 rd" class="r28 r">entry</span> <b>in</b> <span class="r24 r">entries</span>)
            {
                <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r28 r">entry</span>.<span class="i">Key</span>))
                {
                    <b>var</b> <span id="r29 rd" class="r29 r">errorMsg</span> = <b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">CurrentCulture</span>, <span class="i">WebCmdletStrings</span>.<span class="i">EmptyKeyInJsonString</span>);
                    <span class="r26 r">error</span> = <b>new</b> <span class="t">ErrorRecord</span>(
                        <b>new</b> <span class="i">InvalidOperationException</span>(<span class="r29 r">errorMsg</span>),
                        <span class="s">&quot;EmptyKeyInJsonString&quot;</span>,
                        <a href="/System.Management.Automation/A.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="/System.Management.Automation/A.html#b5cba3d51f976bb3" class="i field">InvalidOperation</a>,
                        <b>null</b>);
                    <b>return</b> <b>null</b>;
                }
 
                <span class="c">// Case sensitive duplicates should normally not occur since JsonConvert.DeserializeObject</span>
                <span class="c">// does not throw when encountering duplicates and just uses the last entry.</span>
                <b>if</b> (<span class="r25 r">memberHashTracker</span>.<span class="i">TryGetValue</span>(<span class="r28 r">entry</span>.<span class="i">Key</span>, <b>out</b> <b>var</b> <span id="r30 rd" class="r30 r">maybePropertyName</span>)
                    &amp;&amp; <b>string</b>.<span class="i">Equals</span>(<span class="r28 r">entry</span>.<span class="i">Key</span>, <span class="r30 r">maybePropertyName</span>, <span class="i">StringComparison</span>.<span class="i">Ordinal</span>))
                {
                    <b>var</b> <span id="r31 rd" class="r31 r">errorMsg</span> = <b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">CurrentCulture</span>, <span class="i">WebCmdletStrings</span>.<span class="i">DuplicateKeysInJsonString</span>, <span class="r28 r">entry</span>.<span class="i">Key</span>);
                    <span class="r26 r">error</span> = <b>new</b> <span class="t">ErrorRecord</span>(
                        <b>new</b> <span class="i">InvalidOperationException</span>(<span class="r31 r">errorMsg</span>),
                        <span class="s">&quot;DuplicateKeysInJsonString&quot;</span>,
                        <a href="/System.Management.Automation/A.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="/System.Management.Automation/A.html#b5cba3d51f976bb3" class="i field">InvalidOperation</a>,
                        <b>null</b>);
                    <b>return</b> <b>null</b>;
                }
 
                <span class="c">// Compare case insensitive to tell the user to use the -AsHashTable option instead.</span>
                <span class="c">// This is because PSObject cannot have keys with different casing.</span>
                <b>if</b> (<span class="r25 r">memberHashTracker</span>.<span class="i">TryGetValue</span>(<span class="r28 r">entry</span>.<span class="i">Key</span>, <b>out</b> <b>var</b> <span id="r32 rd" class="r32 r">propertyName</span>))
                {
                    <b>var</b> <span id="r33 rd" class="r33 r">errorMsg</span> = <b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">CurrentCulture</span>, <span class="i">WebCmdletStrings</span>.<span class="i">KeysWithDifferentCasingInJsonString</span>, <span class="r32 r">propertyName</span>, <span class="r28 r">entry</span>.<span class="i">Key</span>);
                    <span class="r26 r">error</span> = <b>new</b> <span class="t">ErrorRecord</span>(
                        <b>new</b> <span class="i">InvalidOperationException</span>(<span class="r33 r">errorMsg</span>),
                        <span class="s">&quot;KeysWithDifferentCasingInJsonString&quot;</span>,
                        <a href="/System.Management.Automation/A.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="/System.Management.Automation/A.html#b5cba3d51f976bb3" class="i field">InvalidOperation</a>,
                        <b>null</b>);
                    <b>return</b> <b>null</b>;
                }
 
                <span class="c">// Array</span>
                <b>switch</b> (<span class="r28 r">entry</span>.<span class="i">Value</span>)
                {
                    <b>case</b> <span class="i">JArray</span> <span id="r34 rd" class="r34 r">list</span>:
                        {
                            <b>var</b> <span id="r35 rd" class="r35 r">listResult</span> = <a href="#ce420eb773094ccf" class="i method">PopulateFromJArray</a>(<span class="r34 r">list</span>, <b>out</b> <span class="r26 r">error</span>);
                            <b>if</b> (<span class="r26 r">error</span> != <b>null</b>)
                            {
                                <b>return</b> <b>null</b>;
                            }
 
                            <span class="r27 r">result</span>.<a href="/System.Management.Automation/A.html#59e9cd1ad57ccd34" class="i property">Properties</a>.<span class="i">Add</span>(<b>new</b> <span class="t">PSNoteProperty</span>(<span class="r28 r">entry</span>.<span class="i">Key</span>, <span class="r35 r">listResult</span>));
                            <b>break</b>;
                        }
                    <b>case</b> <span class="i">JObject</span> <span id="r36 rd" class="r36 r">dic</span>:
                        {
                            <span class="c">// Dictionary</span>
                            <a href="/System.Management.Automation/A.html#a3c2513aa3da07fa" class="k">var</a> <span id="r37 rd" class="r37 r">dicResult</span> = <a href="#6fc72828f26f742e" class="i method">PopulateFromJDictionary</a>(<span class="r36 r">dic</span>, <b>new</b> <span class="t">DuplicateMemberHashSet</span>(<span class="r36 r">dic</span>.<span class="i">Count</span>), <b>out</b> <span class="r26 r">error</span>);
                            <b>if</b> (<span class="r26 r">error</span> != <b>null</b>)
                            {
                                <b>return</b> <b>null</b>;
                            }
 
                            <span class="r27 r">result</span>.<a href="/System.Management.Automation/A.html#59e9cd1ad57ccd34" class="i property">Properties</a>.<span class="i">Add</span>(<b>new</b> <span class="t">PSNoteProperty</span>(<span class="r28 r">entry</span>.<span class="i">Key</span>, <span class="r37 r">dicResult</span>));
                            <b>break</b>;
                        }
                    <b>case</b> <span class="i">JValue</span> <span id="r38 rd" class="r38 r">value</span>:
                        {
                            <span class="r27 r">result</span>.<a href="/System.Management.Automation/A.html#59e9cd1ad57ccd34" class="i property">Properties</a>.<span class="i">Add</span>(<b>new</b> <span class="t">PSNoteProperty</span>(<span class="r28 r">entry</span>.<span class="i">Key</span>, <span class="r38 r">value</span>.<span class="i">Value</span>));
                            <b>break</b>;
                        }
                }
 
                <span class="r25 r">memberHashTracker</span>.<span class="i">Add</span>(<span class="r28 r">entry</span>.<span class="i">Key</span>);
            }
 
            <b>return</b> <span class="r27 r">result</span>;
        }
 
        <span class="c">// This function is a clone of PopulateFromList using JArray as input.</span>
        <b>private static</b> <span class="i">ICollection</span>&lt;<b>object</b>&gt; <a id="ce420eb773094ccf" href="../../../R/ce420eb773094ccf.html" target="n" data-glyph="76,1" class="i method">PopulateFromJArray</a>(<span class="i">JArray</span> <span id="r39 rd" class="r39 r">list</span>, <b>out</b> <a href="/System.Management.Automation/A.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r40 rd" class="r40 r">error</span>)
        {
            <span class="r40 r">error</span> = <b>null</b>;
            <b>var</b> <span id="r41 rd" class="r41 r">result</span> = <b>new</b> <b>object</b>[<span class="r39 r">list</span>.<span class="i">Count</span>];
 
            <b>for</b> (<b>var</b> <span id="r42 rd" class="r42 r">index</span> = 0; <span class="r42 r">index</span> &lt; <span class="r39 r">list</span>.<span class="i">Count</span>; <span class="r42 r">index</span>++)
            {
                <b>var</b> <span id="r43 rd" class="r43 r">element</span> = <span class="r39 r">list</span>[<span class="r42 r">index</span>];
                <b>switch</b> (<span class="r43 r">element</span>)
                {
                    <b>case</b> <span class="i">JArray</span> <span id="r44 rd" class="r44 r">subList</span>:
                        {
                            <span class="c">// Array</span>
                            <b>var</b> <span id="r45 rd" class="r45 r">listResult</span> = <a href="#ce420eb773094ccf" class="i method">PopulateFromJArray</a>(<span class="r44 r">subList</span>, <b>out</b> <span class="r40 r">error</span>);
                            <b>if</b> (<span class="r40 r">error</span> != <b>null</b>)
                            {
                                <b>return</b> <b>null</b>;
                            }
 
                            <span class="r41 r">result</span>[<span class="r42 r">index</span>] = <span class="r45 r">listResult</span>;
                            <b>break</b>;
                        }
                    <b>case</b> <span class="i">JObject</span> <span id="r46 rd" class="r46 r">dic</span>:
                        {
                            <span class="c">// Dictionary</span>
                            <a href="/System.Management.Automation/A.html#a3c2513aa3da07fa" class="k">var</a> <span id="r47 rd" class="r47 r">dicResult</span> = <a href="#6fc72828f26f742e" class="i method">PopulateFromJDictionary</a>(<span class="r46 r">dic</span>, <b>new</b> <span class="t">DuplicateMemberHashSet</span>(<span class="r46 r">dic</span>.<span class="i">Count</span>), <b>out</b> <span class="r40 r">error</span>);
                            <b>if</b> (<span class="r40 r">error</span> != <b>null</b>)
                            {
                                <b>return</b> <b>null</b>;
                            }
 
                            <span class="r41 r">result</span>[<span class="r42 r">index</span>] = <span class="r47 r">dicResult</span>;
                            <b>break</b>;
                        }
                    <b>case</b> <span class="i">JValue</span> <span id="r48 rd" class="r48 r">value</span>:
                        {
                            <span class="r41 r">result</span>[<span class="r42 r">index</span>] = <span class="r48 r">value</span>.<span class="i">Value</span>;
                            <b>break</b>;
                        }
                }
            }
 
            <b>return</b> <span class="r41 r">result</span>;
        }
 
        <span class="c">// This function is a clone of PopulateFromDictionary using JObject as an input.</span>
        <b>private static</b> <span class="i">Hashtable</span> <a id="5bf9bc69b6c3cd9f" href="../../../R/5bf9bc69b6c3cd9f.html" target="n" data-glyph="76,1" class="i method">PopulateHashTableFromJDictionary</a>(<span class="i">JObject</span> <span id="r49 rd" class="r49 r">entries</span>, <b>out</b> <a href="/System.Management.Automation/A.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r50 rd" class="r50 r">error</span>)
        {
            <span class="r50 r">error</span> = <b>null</b>;
            <span class="i">Hashtable</span> <span id="r51 rd" class="r51 r">result</span> = <b>new</b>(<span class="r49 r">entries</span>.<span class="i">Count</span>);
            <b>foreach</b> (<b>var</b> <span id="r52 rd" class="r52 r">entry</span> <b>in</b> <span class="r49 r">entries</span>)
            {
                <span class="c">// Case sensitive duplicates should normally not occur since JsonConvert.DeserializeObject</span>
                <span class="c">// does not throw when encountering duplicates and just uses the last entry.</span>
                <b>if</b> (<span class="r51 r">result</span>.<span class="i">ContainsKey</span>(<span class="r52 r">entry</span>.<span class="i">Key</span>))
                {
                    <b>string</b> <span id="r53 rd" class="r53 r">errorMsg</span> = <b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">CurrentCulture</span>, <span class="i">WebCmdletStrings</span>.<span class="i">DuplicateKeysInJsonString</span>, <span class="r52 r">entry</span>.<span class="i">Key</span>);
                    <span class="r50 r">error</span> = <b>new</b> <span class="t">ErrorRecord</span>(
                        <b>new</b> <span class="i">InvalidOperationException</span>(<span class="r53 r">errorMsg</span>),
                        <span class="s">&quot;DuplicateKeysInJsonString&quot;</span>,
                        <a href="/System.Management.Automation/A.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="/System.Management.Automation/A.html#b5cba3d51f976bb3" class="i field">InvalidOperation</a>,
                        <b>null</b>);
                    <b>return</b> <b>null</b>;
                }
 
                <b>switch</b> (<span class="r52 r">entry</span>.<span class="i">Value</span>)
                {
                    <b>case</b> <span class="i">JArray</span> <span id="r54 rd" class="r54 r">list</span>:
                        {
                            <span class="c">// Array</span>
                            <b>var</b> <span id="r55 rd" class="r55 r">listResult</span> = <a href="#8b6baccedd34d6cb" class="i method">PopulateHashTableFromJArray</a>(<span class="r54 r">list</span>, <b>out</b> <span class="r50 r">error</span>);
                            <b>if</b> (<span class="r50 r">error</span> != <b>null</b>)
                            {
                                <b>return</b> <b>null</b>;
                            }
 
                            <span class="r51 r">result</span>.<span class="i">Add</span>(<span class="r52 r">entry</span>.<span class="i">Key</span>, <span class="r55 r">listResult</span>);
                            <b>break</b>;
                        }
                    <b>case</b> <span class="i">JObject</span> <span id="r56 rd" class="r56 r">dic</span>:
                        {
                            <span class="c">// Dictionary</span>
                            <b>var</b> <span id="r57 rd" class="r57 r">dicResult</span> = <a href="#5bf9bc69b6c3cd9f" class="i method">PopulateHashTableFromJDictionary</a>(<span class="r56 r">dic</span>, <b>out</b> <span class="r50 r">error</span>);
                            <b>if</b> (<span class="r50 r">error</span> != <b>null</b>)
                            {
                                <b>return</b> <b>null</b>;
                            }
 
                            <span class="r51 r">result</span>.<span class="i">Add</span>(<span class="r52 r">entry</span>.<span class="i">Key</span>, <span class="r57 r">dicResult</span>);
                            <b>break</b>;
                        }
                    <b>case</b> <span class="i">JValue</span> <span id="r58 rd" class="r58 r">value</span>:
                        {
                            <span class="r51 r">result</span>.<span class="i">Add</span>(<span class="r52 r">entry</span>.<span class="i">Key</span>, <span class="r58 r">value</span>.<span class="i">Value</span>);
                            <b>break</b>;
                        }
                }
            }
 
            <b>return</b> <span class="r51 r">result</span>;
        }
 
        <span class="c">// This function is a clone of PopulateFromList using JArray as input.</span>
        <b>private static</b> <span class="i">ICollection</span>&lt;<b>object</b>&gt; <a id="8b6baccedd34d6cb" href="../../../R/8b6baccedd34d6cb.html" target="n" data-glyph="76,1" class="i method">PopulateHashTableFromJArray</a>(<span class="i">JArray</span> <span id="r59 rd" class="r59 r">list</span>, <b>out</b> <a href="/System.Management.Automation/A.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r60 rd" class="r60 r">error</span>)
        {
            <span class="r60 r">error</span> = <b>null</b>;
            <b>var</b> <span id="r61 rd" class="r61 r">result</span> = <b>new</b> <b>object</b>[<span class="r59 r">list</span>.<span class="i">Count</span>];
 
            <b>for</b> (<b>var</b> <span id="r62 rd" class="r62 r">index</span> = 0; <span class="r62 r">index</span> &lt; <span class="r59 r">list</span>.<span class="i">Count</span>; <span class="r62 r">index</span>++)
            {
                <b>var</b> <span id="r63 rd" class="r63 r">element</span> = <span class="r59 r">list</span>[<span class="r62 r">index</span>];
 
                <b>switch</b> (<span class="r63 r">element</span>)
                {
                    <b>case</b> <span class="i">JArray</span> <span id="r64 rd" class="r64 r">array</span>:
                        {
                            <span class="c">// Array</span>
                            <b>var</b> <span id="r65 rd" class="r65 r">listResult</span> = <a href="#8b6baccedd34d6cb" class="i method">PopulateHashTableFromJArray</a>(<span class="r64 r">array</span>, <b>out</b> <span class="r60 r">error</span>);
                            <b>if</b> (<span class="r60 r">error</span> != <b>null</b>)
                            {
                                <b>return</b> <b>null</b>;
                            }
 
                            <span class="r61 r">result</span>[<span class="r62 r">index</span>] = <span class="r65 r">listResult</span>;
                            <b>break</b>;
                        }
                    <b>case</b> <span class="i">JObject</span> <span id="r66 rd" class="r66 r">dic</span>:
                        {
                            <span class="c">// Dictionary</span>
                            <b>var</b> <span id="r67 rd" class="r67 r">dicResult</span> = <a href="#5bf9bc69b6c3cd9f" class="i method">PopulateHashTableFromJDictionary</a>(<span class="r66 r">dic</span>, <b>out</b> <span class="r60 r">error</span>);
                            <b>if</b> (<span class="r60 r">error</span> != <b>null</b>)
                            {
                                <b>return</b> <b>null</b>;
                            }
 
                            <span class="r61 r">result</span>[<span class="r62 r">index</span>] = <span class="r67 r">dicResult</span>;
                            <b>break</b>;
                        }
                    <b>case</b> <span class="i">JValue</span> <span id="r68 rd" class="r68 r">value</span>:
                        {
                            <span class="r61 r">result</span>[<span class="r62 r">index</span>] = <span class="r68 r">value</span>.<span class="i">Value</span>;
                            <b>break</b>;
                        }
                }
            }
 
            <b>return</b> <span class="r61 r">result</span>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> ConvertFromJson
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> ConvertToJson
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Convert an object to JSON string.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public static string</b> <a id="2fcb67a355b8744b" href="../../../R/2fcb67a355b8744b.html" target="n" data-glyph="72,1" class="i method">ConvertToJson</a>(<b>object</b> <span id="r69 rd" class="r69 r">objectToProcess</span>, <b>in</b> <a href="#612020afe9d908eb" class="t t">ConvertToJsonContext</a> <span id="r70 rd" class="r70 r">context</span>)
        {
            <b>try</b>
            {
                <span class="c">// Pre-process the object so that it serializes the same, except that properties whose</span>
                <span class="c">// values cannot be evaluated are treated as having the value null.</span>
                <a href="#314802032f409c65" class="i field">_maxDepthWarningWritten</a> = <b>false</b>;
                <b>object</b> <span id="r71 rd" class="r71 r">preprocessedObject</span> = <a href="#5c9a35514b08ac06" class="i method">ProcessValue</a>(<span class="r69 r">objectToProcess</span>, <span class="r72 r">currentDepth</span>: 0, <b>in</b> <span class="r70 r">context</span>);
                <b>var</b> <span id="r73 rd" class="r73 r">jsonSettings</span> = <b>new</b> <span class="i">JsonSerializerSettings</span>
                {
                    <span class="c">// This TypeNameHandling setting is required to be secure.</span>
                    <span class="i">TypeNameHandling</span> = <span class="i">TypeNameHandling</span>.<span class="i">None</span>,
                    <span class="i">MaxDepth</span> = 1024,
                    <span class="i">StringEscapeHandling</span> = <span class="r70 r">context</span>.<a href="#cd64043299c258b4" class="i field">StringEscapeHandling</a>
                };
 
                <b>if</b> (<span class="r70 r">context</span>.<a href="#ad8057060bde7583" class="i field">EnumsAsStrings</a>)
                {
                    <span class="r73 r">jsonSettings</span>.<span class="i">Converters</span>.<span class="i">Add</span>(<b>new</b> <span class="i">StringEnumConverter</span>());
                }
 
                <b>if</b> (!<span class="r70 r">context</span>.<a href="#914ae0958d0f56f1" class="i field">CompressOutput</a>)
                {
                    <span class="r73 r">jsonSettings</span>.<span class="i">Formatting</span> = <span class="i">Formatting</span>.<span class="i">Indented</span>;
                }
 
                <b>return</b> <span class="i">JsonConvert</span>.<span class="i">SerializeObject</span>(<span class="r71 r">preprocessedObject</span>, <span class="r73 r">jsonSettings</span>);
            }
            <b>catch</b> (<span class="i">OperationCanceledException</span>)
            {
                <b>return</b> <b>null</b>;
            }
        }
 
        <b>private static bool</b> <a id="314802032f409c65" href="../../../R/314802032f409c65.html" target="n" data-glyph="46,1" class="i field">_maxDepthWarningWritten</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Return an alternate representation of the specified object that serializes the same JSON, except</span>
        <span class="c">///</span><span class="c"> that properties that cannot be evaluated are treated as having the value null.</span>
        <span class="c">///</span><span class="c"> Primitive types are returned verbatim.  Aggregate types are processed recursively.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r74 r">obj</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The object to be processed.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r72 r">currentDepth</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The current depth into the object graph.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r75 r">context</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The context to use for the convert-to-json operation.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">An object suitable for serializing to JSON.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>private static object</b> <a id="5c9a35514b08ac06" href="../../../R/5c9a35514b08ac06.html" target="n" data-glyph="76,1" class="i method">ProcessValue</a>(<b>object</b> <span id="r74 rd" class="r74 r">obj</span>, <b>int</b> <span id="r72 rd" class="r72 r">currentDepth</span>, <b>in</b> <a href="#612020afe9d908eb" class="t t">ConvertToJsonContext</a> <span id="r75 rd" class="r75 r">context</span>)
        {
            <span class="r75 r">context</span>.<a href="#16af385b1fd04e28" class="i field">CancellationToken</a>.<span class="i">ThrowIfCancellationRequested</span>();
 
            <b>if</b> (<a href="/System.Management.Automation/A.html#6dac09d64da9900c" class="t t">LanguagePrimitives</a>.<span class="i">IsNull</span>(<span class="r74 r">obj</span>))
            {
                <b>return</b> <b>null</b>;
            }
 
            <a href="/System.Management.Automation/A.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r76 rd" class="r76 r">pso</span> = <span class="r74 r">obj</span> <b>as</b> <a href="/System.Management.Automation/A.html#a3c2513aa3da07fa" class="t t">PSObject</a>;
 
            <b>if</b> (<span class="r76 r">pso</span> != <b>null</b>)
            {
                <span class="r74 r">obj</span> = <span class="r76 r">pso</span>.<a href="/System.Management.Automation/A.html#d854d13536b70a12" class="i property">BaseObject</a>;
            }
 
            <b>object</b> <span id="r77 rd" class="r77 r">rv</span> = <span class="r74 r">obj</span>;
            <b>bool</b> <span id="r78 rd" class="r78 r">isPurePSObj</span> = <b>false</b>;
            <b>bool</b> <span id="r79 rd" class="r79 r">isCustomObj</span> = <b>false</b>;
 
            <b>if</b> (<span class="r74 r">obj</span> == <a href="/System.Management.Automation/A.html#6505e7ba37d945c1" class="t t">NullString</a>.<a href="/System.Management.Automation/A.html#c6e89370d6a0b11d" class="i property">Value</a>
                || <span class="r74 r">obj</span> == <span class="i">DBNull</span>.<span class="i">Value</span>)
            {
                <span class="r77 r">rv</span> = <b>null</b>;
            }
            <b>else</b> <b>if</b> (<span class="r74 r">obj</span> <b>is string</b>
                    || <span class="r74 r">obj</span> <b>is char</b>
                    || <span class="r74 r">obj</span> <b>is bool</b>
                    || <span class="r74 r">obj</span> <b>is</b> <span class="i">DateTime</span>
                    || <span class="r74 r">obj</span> <b>is</b> <span class="i">DateTimeOffset</span>
                    || <span class="r74 r">obj</span> <b>is</b> <span class="i">Guid</span>
                    || <span class="r74 r">obj</span> <b>is</b> <span class="i">Uri</span>
                    || <span class="r74 r">obj</span> <b>is double</b>
                    || <span class="r74 r">obj</span> <b>is float</b>
                    || <span class="r74 r">obj</span> <b>is decimal</b>)
            {
                <span class="r77 r">rv</span> = <span class="r74 r">obj</span>;
            }
            <b>else</b> <b>if</b> (<span class="r74 r">obj</span> <b>is</b> <span class="i">Newtonsoft</span>.<span class="i">Json</span>.<span class="i">Linq</span>.<span class="i">JObject</span> <span id="r80 rd" class="r80 r">jObject</span>)
            {
                <span class="r77 r">rv</span> = <span class="r80 r">jObject</span>.<span class="i">ToObject</span>&lt;<span class="i">Dictionary</span>&lt;<b>object</b>, <b>object</b>&gt;&gt;();
            }
            <b>else</b>
            {
                <span class="i">Type</span> <span id="r81 rd" class="r81 r">t</span> = <span class="r74 r">obj</span>.<span class="i">GetType</span>();
 
                <b>if</b> (<span class="r81 r">t</span>.<span class="i">IsPrimitive</span>)
                {
                    <span class="r77 r">rv</span> = <span class="r74 r">obj</span>;
                }
                <b>else</b> <b>if</b> (<span class="r81 r">t</span>.<span class="i">IsEnum</span>)
                {
                    <span class="c">// Win8:378368 Enums based on System.Int64 or System.UInt64 are not JSON-serializable</span>
                    <span class="c">// because JavaScript does not support the necessary precision.</span>
                    <span class="i">Type</span> <span id="r82 rd" class="r82 r">enumUnderlyingType</span> = <span class="i">Enum</span>.<span class="i">GetUnderlyingType</span>(<span class="r74 r">obj</span>.<span class="i">GetType</span>());
                    <b>if</b> (<span class="r82 r">enumUnderlyingType</span>.<span class="i">Equals</span>(<b>typeof</b>(<b>long</b>)) || <span class="r82 r">enumUnderlyingType</span>.<span class="i">Equals</span>(<b>typeof</b>(<b>ulong</b>)))
                    {
                        <span class="r77 r">rv</span> = <span class="r74 r">obj</span>.<span class="i">ToString</span>();
                    }
                    <b>else</b>
                    {
                        <span class="r77 r">rv</span> = <span class="r74 r">obj</span>;
                    }
                }
                <b>else</b>
                {
                    <b>if</b> (<span class="r72 r">currentDepth</span> &gt; <span class="r75 r">context</span>.<a href="#efb01dae7c8ae813" class="i field">MaxDepth</a>)
                    {
                        <b>if</b> (!<a href="#314802032f409c65" class="i field">_maxDepthWarningWritten</a> &amp;&amp; <span class="r75 r">context</span>.<a href="#33d606bca96a749a" class="i field">Cmdlet</a> != <b>null</b>)
                        {
                            <a href="#314802032f409c65" class="i field">_maxDepthWarningWritten</a> = <b>true</b>;
                            <b>string</b> <span id="r83 rd" class="r83 r">maxDepthMessage</span> = <b>string</b>.<span class="i">Format</span>(
                                <span class="i">CultureInfo</span>.<span class="i">CurrentCulture</span>,
                                <span class="i">WebCmdletStrings</span>.<span class="i">JsonMaxDepthReached</span>,
                                <span class="r75 r">context</span>.<a href="#efb01dae7c8ae813" class="i field">MaxDepth</a>);
                            <span class="r75 r">context</span>.<a href="#33d606bca96a749a" class="i field">Cmdlet</a>.<span class="i">WriteWarning</span>(<span class="r83 r">maxDepthMessage</span>);
                        }
 
                        <b>if</b> (<span class="r76 r">pso</span> != <b>null</b> &amp;&amp; <span class="r76 r">pso</span>.<span class="i">ImmediateBaseObjectIsEmpty</span>)
                        {
                            <span class="c">// The obj is a pure PSObject, we convert the original PSObject to a string,</span>
                            <span class="c">// instead of its base object in this case</span>
                            <span class="r77 r">rv</span> = <a href="/System.Management.Automation/A.html#6dac09d64da9900c" class="t t">LanguagePrimitives</a>.<span class="i">ConvertTo</span>(<span class="r76 r">pso</span>, <b>typeof</b>(<b>string</b>),
                                <span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>);
                            <span class="r78 r">isPurePSObj</span> = <b>true</b>;
                        }
                        <b>else</b>
                        {
                            <span class="r77 r">rv</span> = <a href="/System.Management.Automation/A.html#6dac09d64da9900c" class="t t">LanguagePrimitives</a>.<span class="i">ConvertTo</span>(<span class="r74 r">obj</span>, <b>typeof</b>(<b>string</b>),
                                <span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>);
                        }
                    }
                    <b>else</b>
                    {
                        <span class="i">IDictionary</span> <span id="r84 rd" class="r84 r">dict</span> = <span class="r74 r">obj</span> <b>as</b> <span class="i">IDictionary</span>;
                        <b>if</b> (<span class="r84 r">dict</span> != <b>null</b>)
                        {
                            <span class="r77 r">rv</span> = <a href="#4d76171e49afeb83" class="i method">ProcessDictionary</a>(<span class="r84 r">dict</span>, <span class="r72 r">currentDepth</span>, <b>in</b> <span class="r75 r">context</span>);
                        }
                        <b>else</b>
                        {
                            <span class="i">IEnumerable</span> <span id="r85 rd" class="r85 r">enumerable</span> = <span class="r74 r">obj</span> <b>as</b> <span class="i">IEnumerable</span>;
                            <b>if</b> (<span class="r85 r">enumerable</span> != <b>null</b>)
                            {
                                <span class="r77 r">rv</span> = <a href="#6777a695ab806751" class="i method">ProcessEnumerable</a>(<span class="r85 r">enumerable</span>, <span class="r72 r">currentDepth</span>, <b>in</b> <span class="r75 r">context</span>);
                            }
                            <b>else</b>
                            {
                                <span class="r77 r">rv</span> = <a href="#55c446d7049df137" class="i method">ProcessCustomObject</a>&lt;<span class="i">JsonIgnoreAttribute</span>&gt;(<span class="r74 r">obj</span>, <span class="r72 r">currentDepth</span>, <b>in</b> <span class="r75 r">context</span>);
                                <span class="r79 r">isCustomObj</span> = <b>true</b>;
                            }
                        }
                    }
                }
            }
 
            <span class="r77 r">rv</span> = <a href="#b40151cc36d51b3f" class="i method">AddPsProperties</a>(<span class="r76 r">pso</span>, <span class="r77 r">rv</span>, <span class="r72 r">currentDepth</span>, <span class="r78 r">isPurePSObj</span>, <span class="r79 r">isCustomObj</span>, <b>in</b> <span class="r75 r">context</span>);
 
            <b>return</b> <span class="r77 r">rv</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Add to a base object any properties that might have been added to an object (via PSObject) through the Add-Member cmdlet.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r86 r">psObj</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The containing PSObject, or null if the base object was not contained in a PSObject.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r87 r">obj</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The base object that might have been decorated with additional properties.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r88 r">depth</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The current depth into the object graph.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r89 r">isPurePSObj</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The processed object is a pure PSObject.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r90 r">isCustomObj</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The processed object is a custom object.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r91 r">context</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The context for the operation.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The original base object if no additional properties had been added,</span>
        <span class="c">///</span><span class="c"> otherwise a dictionary containing the value of the original base object in the &quot;value&quot; key</span>
        <span class="c">///</span><span class="c"> as well as the names and values of an additional properties.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>private static object</b> <a id="b40151cc36d51b3f" href="../../../R/b40151cc36d51b3f.html" target="n" data-glyph="76,1" class="i method">AddPsProperties</a>(<b>object</b> <span id="r86 rd" class="r86 r">psObj</span>, <b>object</b> <span id="r87 rd" class="r87 r">obj</span>, <b>int</b> <span id="r88 rd" class="r88 r">depth</span>, <b>bool</b> <span id="r89 rd" class="r89 r">isPurePSObj</span>, <b>bool</b> <span id="r90 rd" class="r90 r">isCustomObj</span>, <b>in</b> <a href="#612020afe9d908eb" class="t t">ConvertToJsonContext</a> <span id="r91 rd" class="r91 r">context</span>)
        {
            <b>if</b> (!(<span class="r86 r">psObj</span> <b>is</b> <a href="/System.Management.Automation/A.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r92 rd" class="r92 r">pso</span>))
            {
                <b>return</b> <span class="r87 r">obj</span>;
            }
 
            <span class="c">// when isPurePSObj is true, the obj is guaranteed to be a string converted by LanguagePrimitives</span>
            <b>if</b> (<span class="r89 r">isPurePSObj</span>)
            {
                <b>return</b> <span class="r87 r">obj</span>;
            }
 
            <b>bool</b> <span id="r93 rd" class="r93 r">wasDictionary</span> = <b>true</b>;
            <span class="i">IDictionary</span> <span id="r94 rd" class="r94 r">dict</span> = <span class="r87 r">obj</span> <b>as</b> <span class="i">IDictionary</span>;
 
            <b>if</b> (<span class="r94 r">dict</span> == <b>null</b>)
            {
                <span class="r93 r">wasDictionary</span> = <b>false</b>;
                <span class="r94 r">dict</span> = <b>new</b> <span class="i">Dictionary</span>&lt;<b>string</b>, <b>object</b>&gt;();
                <span class="r94 r">dict</span>.<span class="i">Add</span>(<span class="s">&quot;value&quot;</span>, <span class="r87 r">obj</span>);
            }
 
            <a href="#d1f93236eabaf472" class="i method">AppendPsProperties</a>(<span class="r92 r">pso</span>, <span class="r94 r">dict</span>, <span class="r88 r">depth</span>, <span class="r90 r">isCustomObj</span>, <b>in</b> <span class="r91 r">context</span>);
 
            <b>if</b> (!<span class="r93 r">wasDictionary</span> &amp;&amp; <span class="r94 r">dict</span>.<span class="i">Count</span> == 1)
            {
                <b>return</b> <span class="r87 r">obj</span>;
            }
 
            <b>return</b> <span class="r94 r">dict</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Append to a dictionary any properties that might have been added to an object (via PSObject) through the Add-Member cmdlet.</span>
        <span class="c">///</span><span class="c"> If the passed in object is a custom object (not a simple object, not a dictionary, not a list, get processed in ProcessCustomObject method),</span>
        <span class="c">///</span><span class="c"> we also take Adapted properties into account. Otherwise, we only consider the Extended properties.</span>
        <span class="c">///</span><span class="c"> When the object is a pure PSObject, it also gets processed in &quot;ProcessCustomObject&quot; before reaching this method, so we will</span>
        <span class="c">///</span><span class="c"> iterate both extended and adapted properties for it. Since it&#39;s a pure PSObject, there will be no adapted properties.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r95 r">psObj</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The containing PSObject, or null if the base object was not contained in a PSObject.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r96 r">receiver</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The dictionary to which any additional properties will be appended.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r97 r">depth</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The current depth into the object graph.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r98 r">isCustomObject</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The processed object is a custom object.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r99 r">context</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The context for the operation.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>private static void</b> <a id="d1f93236eabaf472" href="../../../R/d1f93236eabaf472.html" target="n" data-glyph="76,1" class="i method">AppendPsProperties</a>(<a href="/System.Management.Automation/A.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r95 rd" class="r95 r">psObj</span>, <span class="i">IDictionary</span> <span id="r96 rd" class="r96 r">receiver</span>, <b>int</b> <span id="r97 rd" class="r97 r">depth</span>, <b>bool</b> <span id="r98 rd" class="r98 r">isCustomObject</span>, <b>in</b> <a href="#612020afe9d908eb" class="t t">ConvertToJsonContext</a> <span id="r99 rd" class="r99 r">context</span>)
        {
            <span class="c">// if the psObj is a DateTime or String type, we don&#39;t serialize any extended or adapted properties</span>
            <b>if</b> (<span class="r95 r">psObj</span>.<a href="/System.Management.Automation/A.html#d854d13536b70a12" class="i property">BaseObject</a> <b>is string</b> || <span class="r95 r">psObj</span>.<a href="/System.Management.Automation/A.html#d854d13536b70a12" class="i property">BaseObject</a> <b>is</b> <span class="i">DateTime</span>)
            {
                <b>return</b>;
            }
 
            <span class="c">// serialize only Extended and Adapted properties..</span>
            <a href="/System.Management.Automation/A.html#7dc9937a68c9af8c" class="t t">PSMemberInfoCollection</a>&lt;<a href="/System.Management.Automation/A.html#13ab3796654e613c" class="t t">PSPropertyInfo</a>&gt; <span id="r100 rd" class="r100 r">srcPropertiesToSearch</span> =
                <b>new</b> <span class="i">PSMemberInfoIntegratingCollection</span>&lt;<a href="/System.Management.Automation/A.html#13ab3796654e613c" class="t t">PSPropertyInfo</a>&gt;(<span class="r95 r">psObj</span>,
                    <span class="r98 r">isCustomObject</span> ? <a href="/System.Management.Automation/A.html#a3c2513aa3da07fa" class="t t">PSObject</a>.<span class="i">GetPropertyCollection</span>(<a href="/System.Management.Automation/A.html#a6b111b024363c1f" class="t t">PSMemberViewTypes</a>.<a href="/System.Management.Automation/A.html#9a5e7eb3c8a4bb72" class="i field">Extended</a> | <a href="/System.Management.Automation/A.html#a6b111b024363c1f" class="t t">PSMemberViewTypes</a>.<a href="/System.Management.Automation/A.html#3c776c2dab2d739b" class="i field">Adapted</a>) :
                    <a href="/System.Management.Automation/A.html#a3c2513aa3da07fa" class="t t">PSObject</a>.<span class="i">GetPropertyCollection</span>(<a href="/System.Management.Automation/A.html#a6b111b024363c1f" class="t t">PSMemberViewTypes</a>.<a href="/System.Management.Automation/A.html#9a5e7eb3c8a4bb72" class="i field">Extended</a>));
 
            <b>foreach</b> (<a href="/System.Management.Automation/A.html#13ab3796654e613c" class="t t">PSPropertyInfo</a> <span id="r101 rd" class="r101 r">prop</span> <b>in</b> <span class="r100 r">srcPropertiesToSearch</span>)
            {
                <b>object</b> <span id="r102 rd" class="r102 r">value</span> = <b>null</b>;
                <b>try</b>
                {
                    <span class="r102 r">value</span> = <span class="r101 r">prop</span>.<a href="/System.Management.Automation/A.html#cd3a9989baedf3dd" class="i property">Value</a>;
                }
                <b>catch</b> (<span class="i">Exception</span>)
                {
                }
 
                <b>if</b> (!<span class="r96 r">receiver</span>.<span class="i">Contains</span>(<span class="r101 r">prop</span>.<a href="/System.Management.Automation/A.html#02d8236d3d236301" class="i property">Name</a>))
                {
                    <span class="r96 r">receiver</span>[<span class="r101 r">prop</span>.<a href="/System.Management.Automation/A.html#02d8236d3d236301" class="i property">Name</a>] = <span class="i">ProcessValue</span>(<span class="r102 r">value</span>, <span class="r97 r">depth</span> + 1, <b>in</b> <span class="r99 r">context</span>);
                }
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Return an alternate representation of the specified dictionary that serializes the same JSON, except</span>
        <span class="c">///</span><span class="c"> that any contained properties that cannot be evaluated are treated as having the value null.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private static object</b> <a id="4d76171e49afeb83" href="../../../R/4d76171e49afeb83.html" target="n" data-glyph="76,1" class="i method">ProcessDictionary</a>(<span class="i">IDictionary</span> <span id="r103 rd" class="r103 r">dict</span>, <b>int</b> <span id="r104 rd" class="r104 r">depth</span>, <b>in</b> <a href="#612020afe9d908eb" class="t t">ConvertToJsonContext</a> <span id="r105 rd" class="r105 r">context</span>)
        {
            <span class="i">Dictionary</span>&lt;<b>string</b>, <b>object</b>&gt; <span id="r106 rd" class="r106 r">result</span> = <b>new</b>(<span class="r103 r">dict</span>.<span class="i">Count</span>);
 
            <b>foreach</b> (<span class="i">DictionaryEntry</span> <span id="r107 rd" class="r107 r">entry</span> <b>in</b> <span class="r103 r">dict</span>)
            {
                <b>string</b> <span id="r108 rd" class="r108 r">name</span> = <span class="r107 r">entry</span>.<span class="i">Key</span> <b>as string</b>;
                <b>if</b> (<span class="r108 r">name</span> == <b>null</b>)
                {
                    <span class="c">// use the error string that matches the message from JavaScriptSerializer</span>
                    <b>string</b> <span id="r109 rd" class="r109 r">errorMsg</span> = <b>string</b>.<span class="i">Format</span>(
                        <span class="i">CultureInfo</span>.<span class="i">CurrentCulture</span>,
                        <span class="i">WebCmdletStrings</span>.<span class="i">NonStringKeyInDictionary</span>,
                        <span class="r103 r">dict</span>.<span class="i">GetType</span>().<span class="i">FullName</span>);
 
                    <b>var</b> <span id="r110 rd" class="r110 r">exception</span> = <b>new</b> <span class="i">InvalidOperationException</span>(<span class="r109 r">errorMsg</span>);
                    <b>if</b> (<span class="r105 r">context</span>.<a href="#33d606bca96a749a" class="i field">Cmdlet</a> != <b>null</b>)
                    {
                        <a href="/System.Management.Automation/A.html#fe2b46733a081db9" class="k">var</a> <span id="r111 rd" class="r111 r">errorRecord</span> = <b>new</b> <span class="t">ErrorRecord</span>(<span class="r110 r">exception</span>, <span class="s">&quot;NonStringKeyInDictionary&quot;</span>, <a href="/System.Management.Automation/A.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="/System.Management.Automation/A.html#b5cba3d51f976bb3" class="i field">InvalidOperation</a>, <span class="r103 r">dict</span>);
                        <span class="r105 r">context</span>.<a href="#33d606bca96a749a" class="i field">Cmdlet</a>.<span class="i">ThrowTerminatingError</span>(<span class="r111 r">errorRecord</span>);
                    }
                    <b>else</b>
                    {
                        <b>throw</b> <span class="r110 r">exception</span>;
                    }
                }
 
                <span class="r106 r">result</span>.<span class="i">Add</span>(<span class="r108 r">name</span>, <span class="i">ProcessValue</span>(<span class="r107 r">entry</span>.<span class="i">Value</span>, <span class="r104 r">depth</span> + 1, <b>in</b> <span class="r105 r">context</span>));
            }
 
            <b>return</b> <span class="r106 r">result</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Return an alternate representation of the specified collection that serializes the same JSON, except</span>
        <span class="c">///</span><span class="c"> that any contained properties that cannot be evaluated are treated as having the value null.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private static object</b> <a id="6777a695ab806751" href="../../../R/6777a695ab806751.html" target="n" data-glyph="76,1" class="i method">ProcessEnumerable</a>(<span class="i">IEnumerable</span> <span id="r112 rd" class="r112 r">enumerable</span>, <b>int</b> <span id="r113 rd" class="r113 r">depth</span>, <b>in</b> <a href="#612020afe9d908eb" class="t t">ConvertToJsonContext</a> <span id="r114 rd" class="r114 r">context</span>)
        {
            <span class="i">List</span>&lt;<b>object</b>&gt; <span id="r115 rd" class="r115 r">result</span> = <b>new</b>();
 
            <b>foreach</b> (<b>object</b> <span id="r116 rd" class="r116 r">o</span> <b>in</b> <span class="r112 r">enumerable</span>)
            {
                <span class="r115 r">result</span>.<span class="i">Add</span>(<span class="i">ProcessValue</span>(<span class="r116 r">o</span>, <span class="r113 r">depth</span> + 1, <b>in</b> <span class="r114 r">context</span>));
            }
 
            <b>return</b> <span class="r115 r">result</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Return an alternate representation of the specified aggregate object that serializes the same JSON, except</span>
        <span class="c">///</span><span class="c"> that any contained properties that cannot be evaluated are treated as having the value null.</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> The result is a dictionary in which all public fields and public gettable properties of the original object</span>
        <span class="c">///</span><span class="c"> are represented.  If any exception occurs while retrieving the value of a field or property, that entity</span>
        <span class="c">///</span><span class="c"> is included in the output dictionary with a value of null.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private static object</b> <a id="55c446d7049df137" href="../../../R/55c446d7049df137.html" target="n" data-glyph="76,1" class="i method">ProcessCustomObject</a>&lt;<span id="r117 rd t" class="r117 r t">T</span>&gt;(<b>object</b> <span id="r118 rd" class="r118 r">o</span>, <b>int</b> <span id="r119 rd" class="r119 r">depth</span>, <b>in</b> <a href="#612020afe9d908eb" class="t t">ConvertToJsonContext</a> <span id="r120 rd" class="r120 r">context</span>)
        {
            <span class="i">Dictionary</span>&lt;<b>string</b>, <b>object</b>&gt; <span id="r121 rd" class="r121 r">result</span> = <b>new</b>();
            <span class="i">Type</span> <span id="r122 rd" class="r122 r">t</span> = <span class="r118 r">o</span>.<span class="i">GetType</span>();
 
            <b>foreach</b> (<span class="i">FieldInfo</span> <span id="r123 rd" class="r123 r">info</span> <b>in</b> <span class="r122 r">t</span>.<span class="i">GetFields</span>(<span class="i">BindingFlags</span>.<span class="i">Public</span> | <span class="i">BindingFlags</span>.<span class="i">Instance</span>))
            {
                <b>if</b> (!<span class="r123 r">info</span>.<span class="i">IsDefined</span>(<b>typeof</b>(<span class="r117 r t">T</span>), <b>true</b>))
                {
                    <b>object</b> <span id="r124 rd" class="r124 r">value</span>;
                    <b>try</b>
                    {
                        <span class="r124 r">value</span> = <span class="r123 r">info</span>.<span class="i">GetValue</span>(<span class="r118 r">o</span>);
                    }
                    <b>catch</b> (<span class="i">Exception</span>)
                    {
                        <span class="r124 r">value</span> = <b>null</b>;
                    }
 
                    <span class="r121 r">result</span>.<span class="i">Add</span>(<span class="r123 r">info</span>.<span class="i">Name</span>, <span class="i">ProcessValue</span>(<span class="r124 r">value</span>, <span class="r119 r">depth</span> + 1, <b>in</b> <span class="r120 r">context</span>));
                }
            }
 
            <b>foreach</b> (<span class="i">PropertyInfo</span> <span id="r125 rd" class="r125 r">info2</span> <b>in</b> <span class="r122 r">t</span>.<span class="i">GetProperties</span>(<span class="i">BindingFlags</span>.<span class="i">Public</span> | <span class="i">BindingFlags</span>.<span class="i">Instance</span>))
            {
                <b>if</b> (!<span class="r125 r">info2</span>.<span class="i">IsDefined</span>(<b>typeof</b>(<span class="r117 r t">T</span>), <b>true</b>))
                {
                    <span class="i">MethodInfo</span> <span id="r126 rd" class="r126 r">getMethod</span> = <span class="r125 r">info2</span>.<span class="i">GetGetMethod</span>();
                    <b>if</b> ((<span class="r126 r">getMethod</span> != <b>null</b>) &amp;&amp; (<span class="r126 r">getMethod</span>.<span class="i">GetParameters</span>().<span class="i">Length</span> == 0))
                    {
                        <b>object</b> <span id="r127 rd" class="r127 r">value</span>;
                        <b>try</b>
                        {
                            <span class="r127 r">value</span> = <span class="r126 r">getMethod</span>.<span class="i">Invoke</span>(<span class="r118 r">o</span>, <span class="i">Array</span>.<span class="i">Empty</span>&lt;<b>object</b>&gt;());
                        }
                        <b>catch</b> (<span class="i">Exception</span>)
                        {
                            <span class="r127 r">value</span> = <b>null</b>;
                        }
 
                        <span class="r121 r">result</span>.<span class="i">Add</span>(<span class="r125 r">info2</span>.<span class="i">Name</span>, <span class="i">ProcessValue</span>(<span class="r127 r">value</span>, <span class="r119 r">depth</span> + 1, <b>in</b> <span class="r120 r">context</span>));
                    }
                }
            }
 
            <b>return</b> <span class="r121 r">result</span>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> ConvertToJson
    }
}
</pre></td></tr></table></div></body></html>
