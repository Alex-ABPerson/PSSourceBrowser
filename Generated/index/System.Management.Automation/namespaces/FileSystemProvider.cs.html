<!DOCTYPE html>
<html><head><title>FileSystemProvider.cs</title><link rel="stylesheet" href="../../styles.css"><script src="../../scripts.js"></script></head>
<body class="cB" onload="i(10074);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#System.Management.Automation/namespaces/FileSystemProvider.cs" target="_top">namespaces\FileSystemProvider.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#System.Management.Automation" target="_top">src\System.Management.Automation\System.Management.Automation.csproj</a> (System.Management.Automation)</td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation.</span>
<span class="c">// Licensed under the MIT License.</span>
 
<b>using</b> <span class="i n">System</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Collections</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Collections</span>.<span class="i">Generic</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Collections</span>.<span class="i">ObjectModel</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">ComponentModel</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Diagnostics</span>.<span class="i">CodeAnalysis</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Globalization</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">IO</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Linq</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Internal</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Provider</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Runspaces</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Runtime</span>.<span class="i">InteropServices</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Security</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Security</span>.<span class="i">AccessControl</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Text</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Xml</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Xml</span>.<span class="i">XPath</span>;
 
<b>using</b> <span class="i n">Microsoft</span>.<span class="i">Win32</span>.<span class="i">SafeHandles</span>;
 
<b>using</b> <span class="i">Dbg</span> = <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>;
 
<b>namespace</b> <span class="i n">Microsoft</span>.<span class="i n">PowerShell</span>.<span class="i n">Commands</span>
{
    <span class="k preprocess">#</span><span class="k preprocess">region</span> FileSystemProvider
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Defines the implementation of a File System Provider.  This provider</span>
    <span class="c">///</span><span class="c"> allows for stateless namespace navigation of the file system.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    [<span class="i">CmdletProvider</span>(<a href="../P/64a92af39f1cd630.html#64a92af39f1cd630" class="t t">FileSystemProvider</a>.<a href="#10b665caf52d3382" class="i field">ProviderName</a>, <a href="ProviderDeclarationAttribute.cs.html#a29c0c50418632fb" class="t t">ProviderCapabilities</a>.<a href="ProviderDeclarationAttribute.cs.html#8969d2fbdec34d82" class="i field">Credentials</a> | <a href="ProviderDeclarationAttribute.cs.html#a29c0c50418632fb" class="t t">ProviderCapabilities</a>.<a href="ProviderDeclarationAttribute.cs.html#f3753cb333779175" class="i field">Filter</a> | <a href="ProviderDeclarationAttribute.cs.html#a29c0c50418632fb" class="t t">ProviderCapabilities</a>.<a href="ProviderDeclarationAttribute.cs.html#1c74e44e7cb58abe" class="i field">ShouldProcess</a>)]
    [<span class="i">OutputType</span>(<b>typeof</b>(<span class="i">FileSecurity</span>), <a href="../engine/Attributes.cs.html#d8d80d601118095c" class="i property">ProviderCmdlet</a> = <a href="../utils/CoreProviderCmdlets.cs.html#148012d7a65af04c" class="t t">ProviderCmdlet</a>.<a href="../utils/CoreProviderCmdlets.cs.html#f5990d93b900ded5" class="i field">SetAcl</a>)]
    [<span class="i">OutputType</span>(<b>typeof</b>(<b>string</b>), <b>typeof</b>(<a href="PathInfo.cs.html#9504cfb54420cfd7" class="t t">PathInfo</a>), <a href="../engine/Attributes.cs.html#d8d80d601118095c" class="i property">ProviderCmdlet</a> = <a href="../utils/CoreProviderCmdlets.cs.html#148012d7a65af04c" class="t t">ProviderCmdlet</a>.<a href="../utils/CoreProviderCmdlets.cs.html#4e62cf10a09d1e17" class="i field">ResolvePath</a>)]
    [<span class="i">OutputType</span>(<b>typeof</b>(<a href="PathInfo.cs.html#9504cfb54420cfd7" class="t t">PathInfo</a>), <a href="../engine/Attributes.cs.html#d8d80d601118095c" class="i property">ProviderCmdlet</a> = <a href="../utils/CoreProviderCmdlets.cs.html#148012d7a65af04c" class="t t">ProviderCmdlet</a>.<a href="../utils/CoreProviderCmdlets.cs.html#6178e5d7b1d2527a" class="i field">PushLocation</a>)]
    [<span class="i">OutputType</span>(<b>typeof</b>(<b>byte</b>), <b>typeof</b>(<b>string</b>), <a href="../engine/Attributes.cs.html#d8d80d601118095c" class="i property">ProviderCmdlet</a> = <a href="../utils/CoreProviderCmdlets.cs.html#148012d7a65af04c" class="t t">ProviderCmdlet</a>.<a href="../utils/CoreProviderCmdlets.cs.html#d266edfa3945a3b9" class="i field">GetContent</a>)]
    [<span class="i">OutputType</span>(<b>typeof</b>(<span class="i">FileInfo</span>), <a href="../engine/Attributes.cs.html#d8d80d601118095c" class="i property">ProviderCmdlet</a> = <a href="../utils/CoreProviderCmdlets.cs.html#148012d7a65af04c" class="t t">ProviderCmdlet</a>.<a href="../utils/CoreProviderCmdlets.cs.html#d5a1345545ad36b3" class="i field">GetItem</a>)]
    [<span class="i">OutputType</span>(<b>typeof</b>(<span class="i">FileInfo</span>), <b>typeof</b>(<span class="i">DirectoryInfo</span>), <a href="../engine/Attributes.cs.html#d8d80d601118095c" class="i property">ProviderCmdlet</a> = <a href="../utils/CoreProviderCmdlets.cs.html#148012d7a65af04c" class="t t">ProviderCmdlet</a>.<a href="../utils/CoreProviderCmdlets.cs.html#077ace411238b46a" class="i field">GetChildItem</a>)]
    [<span class="i">OutputType</span>(<b>typeof</b>(<span class="i">FileSecurity</span>), <b>typeof</b>(<span class="i">DirectorySecurity</span>), <a href="../engine/Attributes.cs.html#d8d80d601118095c" class="i property">ProviderCmdlet</a> = <a href="../utils/CoreProviderCmdlets.cs.html#148012d7a65af04c" class="t t">ProviderCmdlet</a>.<a href="../utils/CoreProviderCmdlets.cs.html#455f2e7a3536bee8" class="i field">GetAcl</a>)]
    [<span class="i">OutputType</span>(<b>typeof</b>(<b>bool</b>), <b>typeof</b>(<b>string</b>), <b>typeof</b>(<span class="i">FileInfo</span>), <b>typeof</b>(<span class="i">DirectoryInfo</span>), <a href="../engine/Attributes.cs.html#d8d80d601118095c" class="i property">ProviderCmdlet</a> = <a href="../utils/CoreProviderCmdlets.cs.html#148012d7a65af04c" class="t t">ProviderCmdlet</a>.<a href="../utils/CoreProviderCmdlets.cs.html#d5a1345545ad36b3" class="i field">GetItem</a>)]
    [<span class="i">OutputType</span>(<b>typeof</b>(<b>bool</b>), <b>typeof</b>(<b>string</b>), <b>typeof</b>(<span class="i">DateTime</span>), <b>typeof</b>(<span class="i n">System</span>.<span class="i">IO</span>.<span class="i">FileInfo</span>), <b>typeof</b>(<span class="i n">System</span>.<span class="i">IO</span>.<span class="i">DirectoryInfo</span>), <a href="../engine/Attributes.cs.html#d8d80d601118095c" class="i property">ProviderCmdlet</a> = <a href="../utils/CoreProviderCmdlets.cs.html#148012d7a65af04c" class="t t">ProviderCmdlet</a>.<a href="../utils/CoreProviderCmdlets.cs.html#90caa5e4e47f72e3" class="i field">GetItemProperty</a>)]
    [<span class="i">OutputType</span>(<b>typeof</b>(<b>string</b>), <b>typeof</b>(<span class="i n">System</span>.<span class="i">IO</span>.<span class="i">FileInfo</span>), <a href="../engine/Attributes.cs.html#d8d80d601118095c" class="i property">ProviderCmdlet</a> = <a href="../utils/CoreProviderCmdlets.cs.html#148012d7a65af04c" class="t t">ProviderCmdlet</a>.<a href="../utils/CoreProviderCmdlets.cs.html#2b8534a269ab6547" class="i field">NewItem</a>)]
    [<span class="i n">System</span>.<span class="i n">Diagnostics</span>.<span class="i">CodeAnalysis</span>.<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Maintainability&quot;</span>, <span class="s">&quot;CA1506:AvoidExcessiveClassCoupling&quot;</span>, <span class="i">Justification</span> = <span class="s">&quot;This coupling is required&quot;</span>)]
    <b>public sealed</b> <a href="../P/64a92af39f1cd630.html" target="s" class="k">partial</a> <b>class</b> <a id="64a92af39f1cd630" href="../R/64a92af39f1cd630.html" target="n" data-glyph="0,0" class="t t">FileSystemProvider</a> : <a href="NavigationProviderBase.cs.html#7d31476313596b0b" class="t t">NavigationCmdletProvider</a>,
                                                     <a href="IContentProvider.cs.html#de8fa6e31965ef50" class="t t">IContentCmdletProvider</a>,
                                                     <a href="IPropertiesProvider.cs.html#c7893da413e1ec16" class="t t">IPropertyCmdletProvider</a>,
                                                     <a href="IPermissionProvider.cs.html#355bd4bb5306aef0" class="t t">ISecurityDescriptorCmdletProvider</a>,
                                                     <a href="ProviderBase.cs.html#3e872a90de02a9b2" class="t t">ICmdletProviderSupportsHelp</a>
    {
        <span class="c">// 4MB gives the best results without spiking the resources on the remote connection for file transfers between pssessions.</span>
        <span class="c">// NOTE: The script used to copy file data from session (PSCopyFromSessionHelper) has a</span>
        <span class="c">// maximum fragment size value for security.  If FILETRANSFERSIZE changes make sure the</span>
        <span class="c">// copy script will accommodate the new value.</span>
        <b>private const int</b> <a id="be0b26e88f63b3fb" href="../R/be0b26e88f63b3fb.html" target="n" data-glyph="10,1" class="i field">FILETRANSFERSIZE</a> = 4 * 1024 * 1024;
 
        <span class="c">// The name of the key in an exception&#39;s Data dictionary when attempting</span>
        <span class="c">// to copy an item onto itself.</span>
        <b>private const string</b> <a id="941facd9edebd126" href="../R/941facd9edebd126.html" target="n" data-glyph="10,1" class="i field">SelfCopyDataKey</a> = <span class="s">&quot;SelfCopy&quot;</span>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> An instance of the PSTraceSource class used for trace output</span>
        <span class="c">///</span><span class="c"> using &quot;FileSystemProvider&quot; as the category.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i n">Dbg</span>.<span class="i">TraceSourceAttribute</span>(<span class="s">&quot;FileSystemProvider&quot;</span>, <span class="s">&quot;The namespace navigation provider for the file system&quot;</span>)]
        <b>private static readonly</b> <span class="i n">Dbg</span>.<a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a> <a id="3b3990865d6b9e3a" href="../R/3b3990865d6b9e3a.html" target="n" data-glyph="46,1" class="i field">s_tracer</a> =
            <span class="i n">Dbg</span>.<a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../utils/MshTraceSource.cs.html#697b06ec70e3c537" class="i method">GetTracer</a>(<span class="s">&quot;FileSystemProvider&quot;</span>, <span class="s">&quot;The namespace navigation provider for the file system&quot;</span>);
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the name of the provider.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public const string</b> <a id="10b665caf52d3382" href="../R/10b665caf52d3382.html" target="n" data-glyph="6,1" class="i field">ProviderName</a> = <span class="s">&quot;FileSystem&quot;</span>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Initializes a new instance of the FileSystemProvider class. Since this</span>
        <span class="c">///</span><span class="c"> object needs to be stateless, the constructor does nothing.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public</b> <a id="0b8b9638ec511340" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="t constructor">FileSystemProvider</a>()
        {
        }
 
        <b>private</b> <span class="i">Collection</span>&lt;<a href="../engine/regex.cs.html#d450e739ff28e660" class="t t">WildcardPattern</a>&gt; <a id="27e7d5cf314c5db2" href="../R/27e7d5cf314c5db2.html" target="n" data-glyph="46,1" class="i field">_excludeMatcher</a> = <b>null</b>;
 
        <b>private static readonly</b> <span class="i n">System</span>.<span class="i">IO</span>.<span class="i">EnumerationOptions</span> <a id="c212b0b5c9beb587" href="../R/c212b0b5c9beb587.html" target="n" data-glyph="46,1" class="i field">_enumerationOptions</a> = <b>new</b> <span class="i n">System</span>.<span class="i">IO</span>.<span class="i">EnumerationOptions</span>
        {
            <span class="i">MatchType</span> = <span class="i">MatchType</span>.<span class="i">Win32</span>,
            <span class="i">MatchCasing</span> = <span class="i">MatchCasing</span>.<span class="i">CaseInsensitive</span>,
            <span class="i">AttributesToSkip</span> = 0 <span class="c">// Default is to skip Hidden and System files, so we clear this to retain existing behavior</span>
        };
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Converts all / in the path to \</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r0 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The path to normalize.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The path with all / normalized to \</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>private static string</b> <a id="2679b47e3c6ebedc" href="../R/2679b47e3c6ebedc.html" target="n" data-glyph="76,1" class="i method">NormalizePath</a>(<b>string</b> <span id="r0 rd" class="r0 r">path</span>)
        {
            <b>return</b> <span class="i">GetCorrectCasedPath</span>(<span class="r0 r">path</span>.<span class="i">Replace</span>(<a href="../engine/SessionStateStrings.cs.html#55ee11e42c7cf459" class="t t">StringLiterals</a>.<a href="../engine/SessionStateStrings.cs.html#f2548f0f61690656" class="i field">AlternatePathSeparator</a>, <a href="../engine/SessionStateStrings.cs.html#55ee11e42c7cf459" class="t t">StringLiterals</a>.<a href="../engine/SessionStateStrings.cs.html#88fdd102fa325178" class="i field">DefaultPathSeparator</a>));
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Get the correct casing for a path.  This method assumes it&#39;s being called by NormalizePath()</span>
        <span class="c">///</span><span class="c"> so that the path is already normalized.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r1 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The path to retrieve.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The path with accurate casing if item exists, otherwise it returns path that was passed in.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>private static string</b> <a id="415dc28e83d84756" href="../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">GetCorrectCasedPath</a>(<b>string</b> <span id="r1 rd" class="r1 r">path</span>)
        {
            <span class="c">// Only apply to directories where there are issues with some tools if the casing</span>
            <span class="c">// doesn&#39;t match the source like git</span>
            <b>if</b> (<span class="i">Directory</span>.<span class="i">Exists</span>(<span class="r1 r">path</span>))
            {
                <b>string</b> <span id="r2 rd" class="r2 r">exactPath</span> = <b>string</b>.<span class="i">Empty</span>;
                <b>int</b> <span id="r3 rd" class="r3 r">itemsToSkip</span> = 0;
                <b>if</b> (<a href="../engine/Utils.cs.html#9185d6ecbaebbec0" class="t t">Utils</a>.<a href="../engine/Utils.cs.html#035be1ae91f35c16" class="i method">PathIsUnc</a>(<span class="r1 r">path</span>))
                {
                    <span class="c">// With the Split method, a UNC path like \\server\share, we need to skip</span>
                    <span class="c">// trying to enumerate the server and share, so skip the first two empty</span>
                    <span class="c">// strings, then server, and finally share name.</span>
                    <span class="r3 r">itemsToSkip</span> = 4;
                }
 
                <b>foreach</b> (<b>string</b> <span id="r4 rd" class="r4 r">item</span> <b>in</b> <span class="r1 r">path</span>.<span class="i">Split</span>(<a href="../engine/SessionStateStrings.cs.html#55ee11e42c7cf459" class="t t">StringLiterals</a>.<a href="../engine/SessionStateStrings.cs.html#88fdd102fa325178" class="i field">DefaultPathSeparator</a>))
                {
                    <b>if</b> (<span class="r3 r">itemsToSkip</span>-- &gt; 0)
                    {
                        <span class="c">// This handles the UNC server and share and 8.3 short path syntax</span>
                        <span class="r2 r">exactPath</span> += <span class="r4 r">item</span> + <a href="../engine/SessionStateStrings.cs.html#55ee11e42c7cf459" class="t t">StringLiterals</a>.<a href="../engine/SessionStateStrings.cs.html#88fdd102fa325178" class="i field">DefaultPathSeparator</a>;
                        <b>continue</b>;
                    }
                    <b>else</b> <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r2 r">exactPath</span>))
                    {
                        <span class="c">// This handles the drive letter or / root path start</span>
                        <span class="r2 r">exactPath</span> = <span class="r4 r">item</span> + <a href="../engine/SessionStateStrings.cs.html#55ee11e42c7cf459" class="t t">StringLiterals</a>.<a href="../engine/SessionStateStrings.cs.html#88fdd102fa325178" class="i field">DefaultPathSeparator</a>;
                    }
                    <b>else</b> <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r4 r">item</span>))
                    {
                        <span class="c">// This handles the trailing slash case</span>
                        <b>if</b> (!<span class="r2 r">exactPath</span>.<span class="i">EndsWith</span>(<a href="../engine/SessionStateStrings.cs.html#55ee11e42c7cf459" class="t t">StringLiterals</a>.<a href="../engine/SessionStateStrings.cs.html#88fdd102fa325178" class="i field">DefaultPathSeparator</a>))
                        {
                            <span class="r2 r">exactPath</span> += <a href="../engine/SessionStateStrings.cs.html#55ee11e42c7cf459" class="t t">StringLiterals</a>.<a href="../engine/SessionStateStrings.cs.html#88fdd102fa325178" class="i field">DefaultPathSeparator</a>;
                        }
 
                        <b>break</b>;
                    }
                    <b>else</b> <b>if</b> (<span class="r4 r">item</span>.<span class="i">Contains</span>(<span class="s">&#39;~&#39;</span>))
                    {
                        <span class="c">// This handles short path names</span>
                        <span class="r2 r">exactPath</span> += <a href="../engine/SessionStateStrings.cs.html#55ee11e42c7cf459" class="t t">StringLiterals</a>.<a href="../engine/SessionStateStrings.cs.html#88fdd102fa325178" class="i field">DefaultPathSeparator</a> + <span class="r4 r">item</span>;
                    }
                    <b>else</b>
                    {
                        <span class="c">// Use GetFileSystemEntries to get the correct casing of this element</span>
                        <b>try</b>
                        {
                            <b>var</b> <span id="r5 rd" class="r5 r">entries</span> = <span class="i">Directory</span>.<span class="i">GetFileSystemEntries</span>(<span class="r2 r">exactPath</span>, <span class="r4 r">item</span>);
                            <b>if</b> (<span class="r5 r">entries</span>.<span class="i">Length</span> &gt; 0)
                            {
                                <span class="r2 r">exactPath</span> = <span class="r5 r">entries</span>[0];
                            }
                            <b>else</b>
                            {
                                <span class="c">// If previous call didn&#39;t return anything, something failed so we just return the path we were given</span>
                                <b>return</b> <span class="r1 r">path</span>;
                            }
                        }
                        <b>catch</b>
                        {
                            <span class="c">// If we can&#39;t enumerate, we stop and just return the original path</span>
                            <b>return</b> <span class="r1 r">path</span>;
                        }
                    }
                }
 
                <b>return</b> <span class="r2 r">exactPath</span>;
            }
            <b>else</b>
            {
                <b>return</b> <span class="r1 r">path</span>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Checks if the item exist at the specified path. if it exists then creates</span>
        <span class="c">///</span><span class="c"> appropriate directoryinfo or fileinfo object.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r6 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Refers to the item for which we are checking for existence and creating filesysteminfo object.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r7 r">isContainer</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Return true if path points to a directory else returns false.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">FileInfo or DirectoryInfo object.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">System</span>.<span class="i">ArgumentNullException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The path is null.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">System</span>.<span class="i">IO</span>.<span class="i">IOException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> I/O error occurs.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">System</span>.<span class="i">UnauthorizedAccessException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> An I/O error or a specific type of security error.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>private static</b> <span class="i">FileSystemInfo</span> <a id="03417d6757ea1d51" href="../R/03417d6757ea1d51.html" target="n" data-glyph="76,1" class="i method">GetFileSystemInfo</a>(<b>string</b> <span id="r6 rd" class="r6 r">path</span>, <b>out bool</b> <span id="r7 rd" class="r7 r">isContainer</span>)
        {
            <span class="c">// We use &#39;FileInfo.Attributes&#39; (not &#39;FileInfo.Exist&#39;)</span>
            <span class="c">// because we want to get exceptions</span>
            <span class="c">// like UnauthorizedAccessException or IOException.</span>
            <span class="i">FileSystemInfo</span> <span id="r8 rd" class="r8 r">fsinfo</span> = <b>new</b> <span class="i">FileInfo</span>(<span class="r6 r">path</span>);
            <b>var</b> <span id="r9 rd" class="r9 r">attr</span> = <span class="r8 r">fsinfo</span>.<span class="i">Attributes</span>;
            <b>var</b> <span id="r10 rd" class="r10 r">exists</span> = (<b>int</b>)<span class="r9 r">attr</span> != -1;
            <span class="r7 r">isContainer</span> = <span class="r10 r">exists</span> &amp;&amp; <span class="r9 r">attr</span>.<span class="i">HasFlag</span>(<span class="i">FileAttributes</span>.<span class="i">Directory</span>);
 
            <b>if</b> (<span class="r10 r">exists</span>)
            {
                <b>if</b> (<span class="r7 r">isContainer</span>)
                {
                    <b>return</b> <b>new</b> <span class="i">DirectoryInfo</span>(<span class="r6 r">path</span>);
                }
                <b>else</b>
                {
                    <b>return</b> <span class="r8 r">fsinfo</span>;
                }
            }
 
            <b>return</b> <b>null</b>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Overrides the method of CmdletProvider, considering the additional</span>
        <span class="c">///</span><span class="c"> dynamic parameters of FileSystemProvider.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> whether the filter or attribute filter is set.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal override bool</b> <a id="96af30f6400d35ad" href="../R/96af30f6400d35ad.html" target="n" data-glyph="74,1" class="i method">IsFilterSet</a>()
        {
            <b>bool</b> <span id="r11 rd" class="r11 r">attributeFilterSet</span> = <b>false</b>;
            <a href="#5d2564feefe2a3d0" class="t t">GetChildDynamicParameters</a> <span id="r12 rd" class="r12 r">fspDynamicParam</span> = <a href="ProviderBase.cs.html#57d60aa2d2bc908d" class="i property">DynamicParameters</a> <b>as</b> <a href="#5d2564feefe2a3d0" class="t t">GetChildDynamicParameters</a>;
            <b>if</b> (<span class="r12 r">fspDynamicParam</span> != <b>null</b>)
            {
                <span class="r11 r">attributeFilterSet</span> = (
                    (<span class="r12 r">fspDynamicParam</span>.<a href="#9b94c5e245d1e7bf" class="i property">Attributes</a> != <b>null</b>)
                        || (<span class="r12 r">fspDynamicParam</span>.<a href="#2ca1b1c968849c67" class="i property">Directory</a>)
                        || (<span class="r12 r">fspDynamicParam</span>.<a href="#0e064e4e6a94c210" class="i property">File</a>)
                        || (<span class="r12 r">fspDynamicParam</span>.<a href="#e392319a284f39a1" class="i property">Hidden</a>)
                        || (<span class="r12 r">fspDynamicParam</span>.<a href="#1fe8b85002b76adf" class="i property">ReadOnly</a>)
                        || (<span class="r12 r">fspDynamicParam</span>.<a href="#eb2215f497d83bec" class="i property">System</a>));
            }
 
            <b>return</b> (<span class="r11 r">attributeFilterSet</span> || <a href="NavigationProviderBase.cs.html#7d31476313596b0b" class="k">base</a>.<a href="ProviderBase.cs.html#d5dc996dd62a0823" class="i method">IsFilterSet</a>());
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the dynamic parameters for get-childnames on the</span>
        <span class="c">///</span><span class="c"> FileSystemProvider.</span>
        <span class="c">///</span><span class="c"> We currently only support one dynamic parameter,</span>
        <span class="c">///</span><span class="c"> &quot;Attributes&quot; that returns an enum evaluator for the</span>
        <span class="c">///</span><span class="c"> given expression.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r13 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If the path was specified on the command line, this is the path</span>
        <span class="c">///</span><span class="c"> to the item for which to get the dynamic parameters.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> An object that has properties and fields decorated with</span>
        <span class="c">///</span><span class="c"> parsing attributes similar to a cmdlet class.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>protected override object</b> <a id="9a98ef8f60495f06" href="../R/9a98ef8f60495f06.html" target="n" data-glyph="75,1" class="i method">GetChildNamesDynamicParameters</a>(<b>string</b> <span id="r13 rd" class="r13 r">path</span>)
        {
            <b>return</b> <b>new</b> <span class="t">GetChildDynamicParameters</span>();
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the dynamic parameters for get-childitems on the</span>
        <span class="c">///</span><span class="c"> FileSystemProvider.</span>
        <span class="c">///</span><span class="c"> We currently only support one dynamic parameter,</span>
        <span class="c">///</span><span class="c"> &quot;Attributes&quot; that returns an enum evaluator for the</span>
        <span class="c">///</span><span class="c"> given expression.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r14 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If the path was specified on the command line, this is the path</span>
        <span class="c">///</span><span class="c"> to the item for which to get the dynamic parameters.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r15 r">recurse</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Ignored.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> An object that has properties and fields decorated with</span>
        <span class="c">///</span><span class="c"> parsing attributes similar to a cmdlet class.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>protected override object</b> <a id="f2893d679dd183c5" href="../R/f2893d679dd183c5.html" target="n" data-glyph="75,1" class="i method">GetChildItemsDynamicParameters</a>(<b>string</b> <span id="r14 rd" class="r14 r">path</span>, <b>bool</b> <span id="r15 rd" class="r15 r">recurse</span>)
        {
            <b>return</b> <b>new</b> <span class="t">GetChildDynamicParameters</span>();
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the dynamic parameters for Copy-Item on the FileSystemProvider.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r16 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Source for the copy operation.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r17 r">destination</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Destination for the copy operation.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r18 r">recurse</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Whether to recurse.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>protected override object</b> <a id="72e872e270b2299d" href="../R/72e872e270b2299d.html" target="n" data-glyph="75,1" class="i method">CopyItemDynamicParameters</a>(<b>string</b> <span id="r16 rd" class="r16 r">path</span>, <b>string</b> <span id="r17 rd" class="r17 r">destination</span>, <b>bool</b> <span id="r18 rd" class="r18 r">recurse</span>)
        {
            <b>return</b> <b>new</b> <span class="t">CopyItemDynamicParameters</span>();
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> ICmdletProviderSupportsHelp members
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Implementation of ICmdletProviderSupportsHelp interface.</span>
        <span class="c">///</span><span class="c"> Gets provider-specific help content for the corresponding cmdlet.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r19 r">helpItemName</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Name of command that the help is requested for.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r20 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Not used here.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The MAML help XML that should be presented to the user.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public string</b> <a id="45d449032e323537" href="../R/45d449032e323537.html" target="n" data-glyph="72,1" class="i method">GetHelpMaml</a>(<b>string</b> <span id="r19 rd" class="r19 r">helpItemName</span>, <b>string</b> <span id="r20 rd" class="r20 r">path</span>)
        {
            <span class="c">// Get the verb and noun from helpItemName</span>
            <span class="c">//</span>
            <b>string</b> <span id="r21 rd" class="r21 r">verb</span> = <b>null</b>;
            <b>string</b> <span id="r22 rd" class="r22 r">noun</span> = <b>null</b>;
            <span class="i">XmlReader</span> <span id="r23 rd" class="r23 r">reader</span> = <b>null</b>;
 
            <b>try</b>
            {
                <b>if</b> (!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r19 r">helpItemName</span>))
                {
                    <a href="../engine/CmdletInfo.cs.html#9492ffc9968f644d" class="t t">CmdletInfo</a>.<a href="../engine/CmdletInfo.cs.html#a59d626fb41db059" class="i method">SplitCmdletName</a>(<span class="r19 r">helpItemName</span>, <b>out</b> <span class="r21 r">verb</span>, <b>out</b> <span class="r22 r">noun</span>);
                }
                <b>else</b>
                {
                    <b>return</b> <b>string</b>.<span class="i">Empty</span>;
                }
 
                <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r21 r">verb</span>) || <b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r22 r">noun</span>))
                {
                    <b>return</b> <b>string</b>.<span class="i">Empty</span>;
                }
 
                <span class="c">// Load the help file from the current UI culture subfolder</span>
                <span class="i">XmlDocument</span> <span id="r24 rd" class="r24 r">document</span> = <b>new</b> <span class="i">XmlDocument</span>();
                <span class="i">CultureInfo</span> <span id="r25 rd" class="r25 r">currentUICulture</span> = <span class="i">CultureInfo</span>.<span class="i">CurrentUICulture</span>;
                <b>string</b> <span id="r26 rd" class="r26 r">fullHelpPath</span> = <span class="i">Path</span>.<span class="i">Combine</span>(
                    <b>string</b>.<span class="i">IsNullOrEmpty</span>(<a href="../P/64a92af39f1cd630.html#64a92af39f1cd630" class="k">this</a>.<a href="ProviderBase.cs.html#6129ef83671ead76" class="i property">ProviderInfo</a>.<a href="../engine/DataStoreAdapterProvider.cs.html#0cf1bb606b56219c" class="i property">ApplicationBase</a>) ? <b>string</b>.<span class="i">Empty</span> : <a href="../P/64a92af39f1cd630.html#64a92af39f1cd630" class="k">this</a>.<a href="ProviderBase.cs.html#6129ef83671ead76" class="i property">ProviderInfo</a>.<a href="../engine/DataStoreAdapterProvider.cs.html#0cf1bb606b56219c" class="i property">ApplicationBase</a>,
                    <span class="r25 r">currentUICulture</span>.<span class="i">ToString</span>(),
                    <b>string</b>.<span class="i">IsNullOrEmpty</span>(<a href="../P/64a92af39f1cd630.html#64a92af39f1cd630" class="k">this</a>.<a href="ProviderBase.cs.html#6129ef83671ead76" class="i property">ProviderInfo</a>.<a href="../engine/DataStoreAdapterProvider.cs.html#f3d7084f8a70f287" class="i property">HelpFile</a>) ? <b>string</b>.<span class="i">Empty</span> : <a href="../P/64a92af39f1cd630.html#64a92af39f1cd630" class="k">this</a>.<a href="ProviderBase.cs.html#6129ef83671ead76" class="i property">ProviderInfo</a>.<a href="../engine/DataStoreAdapterProvider.cs.html#f3d7084f8a70f287" class="i property">HelpFile</a>);
 
                <span class="i">XmlReaderSettings</span> <span id="r27 rd" class="r27 r">settings</span> = <b>new</b> <span class="i">XmlReaderSettings</span>();
                <span class="r27 r">settings</span>.<span class="i">XmlResolver</span> = <b>null</b>;
                <span class="r23 r">reader</span> = <span class="i">XmlReader</span>.<span class="i">Create</span>(<span class="r26 r">fullHelpPath</span>, <span class="r27 r">settings</span>);
                <span class="r24 r">document</span>.<span class="i">Load</span>(<span class="r23 r">reader</span>);
 
                <span class="c">// Add &quot;msh&quot; and &quot;command&quot; namespaces from the MAML schema</span>
                <span class="i">XmlNamespaceManager</span> <span id="r28 rd" class="r28 r">nsMgr</span> = <b>new</b> <span class="i">XmlNamespaceManager</span>(<span class="r24 r">document</span>.<span class="i">NameTable</span>);
                <span class="r28 r">nsMgr</span>.<span class="i">AddNamespace</span>(<span class="s">&quot;msh&quot;</span>, <a href="../help/HelpCommentsParser.cs.html#9f10a00eb0f83566" class="t t">HelpCommentsParser</a>.<a href="../help/HelpCommentsParser.cs.html#086204f0b0016f51" class="i field">mshURI</a>);
                <span class="r28 r">nsMgr</span>.<span class="i">AddNamespace</span>(<span class="s">&quot;command&quot;</span>, <a href="../help/HelpCommentsParser.cs.html#9f10a00eb0f83566" class="t t">HelpCommentsParser</a>.<a href="../help/HelpCommentsParser.cs.html#8de853a35abeb375" class="i field">commandURI</a>);
 
                <span class="c">// Compose XPath query to select the appropriate node based on the cmdlet</span>
                <b>string</b> <span id="r29 rd" class="r29 r">xpathQuery</span> = <b>string</b>.<span class="i">Format</span>(
                    <span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>,
                    <a href="../help/HelpCommentsParser.cs.html#9f10a00eb0f83566" class="t t">HelpCommentsParser</a>.<a href="../help/HelpCommentsParser.cs.html#cdf02d4cd6b303cb" class="i field">ProviderHelpCommandXPath</a>,
                    <span class="s">&quot;[@id=&#39;FileSystem&#39;]&quot;</span>,
                    <span class="r21 r">verb</span>,
                    <span class="r22 r">noun</span>);
 
                <span class="c">// Execute the XPath query and return its MAML snippet</span>
                <span class="i">XmlNode</span> <span id="r30 rd" class="r30 r">result</span> = <span class="r24 r">document</span>.<span class="i">SelectSingleNode</span>(<span class="r29 r">xpathQuery</span>, <span class="r28 r">nsMgr</span>);
                <b>if</b> (<span class="r30 r">result</span> != <b>null</b>)
                {
                    <b>return</b> <span class="r30 r">result</span>.<span class="i">OuterXml</span>;
                }
            }
            <b>catch</b> (<span class="i">XmlException</span>)
            {
                <b>return</b> <b>string</b>.<span class="i">Empty</span>;
            }
            <b>catch</b> (<span class="i">PathTooLongException</span>)
            {
                <b>return</b> <b>string</b>.<span class="i">Empty</span>;
            }
            <b>catch</b> (<span class="i">IOException</span>)
            {
                <b>return</b> <b>string</b>.<span class="i">Empty</span>;
            }
            <b>catch</b> (<span class="i">UnauthorizedAccessException</span>)
            {
                <b>return</b> <b>string</b>.<span class="i">Empty</span>;
            }
            <b>catch</b> (<span class="i">NotSupportedException</span>)
            {
                <b>return</b> <b>string</b>.<span class="i">Empty</span>;
            }
            <b>catch</b> (<span class="i">SecurityException</span>)
            {
                <b>return</b> <b>string</b>.<span class="i">Empty</span>;
            }
            <b>catch</b> (<span class="i">XPathException</span>)
            {
                <b>return</b> <b>string</b>.<span class="i">Empty</span>;
            }
            <b>finally</b>
            {
                <b>if</b> (<span class="r23 r">reader</span> != <b>null</b>)
                {
                    ((<span class="i">IDisposable</span>)<span class="r23 r">reader</span>).<span class="i">Dispose</span>();
                }
            }
 
            <b>return</b> <b>string</b>.<span class="i">Empty</span>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> CmdletProvider members
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Starts the File System provider. This method sets the Home for the</span>
        <span class="c">///</span><span class="c"> provider to providerInfo.Home if specified, and %USERPROFILE%</span>
        <span class="c">///</span><span class="c"> otherwise.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r31 r">providerInfo</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The ProviderInfo object that holds the provider&#39;s configuration.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The updated ProviderInfo object that holds the provider&#39;s configuration.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>protected override</b> <a href="../engine/DataStoreAdapterProvider.cs.html#dd4e1f2f8e73a1dd" class="t t">ProviderInfo</a> <a id="2a05fb4822737502" href="../R/2a05fb4822737502.html" target="n" data-glyph="75,1" class="i method">Start</a>(<a href="../engine/DataStoreAdapterProvider.cs.html#dd4e1f2f8e73a1dd" class="t t">ProviderInfo</a> <span id="r31 rd" class="r31 r">providerInfo</span>)
        {
            <span class="c">// Set the home folder for the user</span>
            <b>if</b> (<span class="r31 r">providerInfo</span> != <b>null</b> &amp;&amp; <b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r31 r">providerInfo</span>.<a href="../engine/DataStoreAdapterProvider.cs.html#589a26e592ac4153" class="i property">Home</a>))
            {
                <span class="c">// %USERPROFILE% - indicate where a user&#39;s home directory is located in the file system.</span>
                <b>string</b> <span id="r32 rd" class="r32 r">homeDirectory</span> = <span class="i">Environment</span>.<span class="i">GetEnvironmentVariable</span>(<a href="../CoreCLR/CorePsPlatform.cs.html#693813241122eb45" class="t t">Platform</a>.<a href="../CoreCLR/CorePsPlatform.cs.html#2ec531e5b2c821e4" class="t t">CommonEnvVariableNames</a>.<a href="../CoreCLR/CorePsPlatform.cs.html#7bda162e9185ce4e" class="i field">Home</a>);
 
                <b>if</b> (!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r32 r">homeDirectory</span>))
                {
                    <b>if</b> (<span class="i">Directory</span>.<span class="i">Exists</span>(<span class="r32 r">homeDirectory</span>))
                    {
                        <a href="#3b3990865d6b9e3a" class="i field">s_tracer</a>.<a href="../utils/StructuredTraceSource.cs.html#25b8416175e53218" class="i method">WriteLine</a>(<span class="s">&quot;Home = {0}&quot;</span>, <span class="r32 r">homeDirectory</span>);
                        <span class="r31 r">providerInfo</span>.<a href="../engine/DataStoreAdapterProvider.cs.html#589a26e592ac4153" class="i property">Home</a> = <span class="r32 r">homeDirectory</span>;
                    }
                    <b>else</b>
                    {
                        <a href="#3b3990865d6b9e3a" class="i field">s_tracer</a>.<a href="../utils/StructuredTraceSource.cs.html#25b8416175e53218" class="i method">WriteLine</a>(<span class="s">&quot;Not setting home directory {0} - does not exist&quot;</span>, <span class="r32 r">homeDirectory</span>);
                    }
                }
            }
 
            <span class="c">// OneDrive placeholder support (issue #8315)</span>
            <span class="c">// make it so OneDrive placeholders are perceived as such with *all* their attributes accessible</span>
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">UNIX</span>
            <span class="c">// The placeholder mode management APIs Rtl(Set|Query)(Process|Thread)PlaceholderCompatibilityMode</span>
            <span class="c">// are only supported starting with Windows 10 version 1803 (build 17134)</span>
            <span class="i">Version</span> <span id="r33 rd" class="r33 r">minBuildForPlaceHolderAPIs</span> = <b>new</b> <span class="i">Version</span>(10, 0, 17134, 0);
 
            <b>if</b> (<span class="i">Environment</span>.<span class="i">OSVersion</span>.<span class="i">Version</span> &gt;= <span class="r33 r">minBuildForPlaceHolderAPIs</span>)
            {
                <span class="c">// let&#39;s be safe, don&#39;t change the PlaceHolderCompatibilityMode if the current one is not what we expect</span>
                <b>if</b> (<a href="#f0fcb2141ba63e82" class="t t">NativeMethods</a>.<a href="#e16ba683bb0b7670" class="i method">RtlQueryProcessPlaceholderCompatibilityMode</a>() == <a href="#f0fcb2141ba63e82" class="t t">NativeMethods</a>.<a href="#1b92af2559c918a6" class="i field">PHCM_DISGUISE_PLACEHOLDER</a>)
                {
                    <a href="#f0fcb2141ba63e82" class="t t">NativeMethods</a>.<a href="#ffa63bc15ea68838" class="i method">RtlSetProcessPlaceholderCompatibilityMode</a>(<a href="#f0fcb2141ba63e82" class="t t">NativeMethods</a>.<a href="#09adb9e8d12f3700" class="i field">PHCM_EXPOSE_PLACEHOLDERS</a>);
                }
            }
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
 
            <b>return</b> <span class="r31 r">providerInfo</span>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> CmdletProvider members
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> DriveCmdletProvider members
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Determines if the specified drive can be mounted.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r34 r">drive</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The drive that is going to be mounted.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The same drive that was passed in, if the drive can be mounted.</span>
        <span class="c">///</span><span class="c"> null if the drive cannot be mounted.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">System</span>.<span class="i">ArgumentNullException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> drive is null.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">System</span>.<span class="i">ArgumentException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> drive root is null or empty.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>protected override</b> <a href="../engine/DataStoreAdapter.cs.html#2d16b26a541ba185" class="t t">PSDriveInfo</a> <a id="f617d42b61c7b5ab" href="../R/f617d42b61c7b5ab.html" target="n" data-glyph="75,1" class="i method">NewDrive</a>(<a href="../engine/DataStoreAdapter.cs.html#2d16b26a541ba185" class="t t">PSDriveInfo</a> <span id="r34 rd" class="r34 r">drive</span>)
        {
            <span class="c">// verify parameters</span>
            <b>if</b> (<span class="r34 r">drive</span> == <b>null</b>)
            {
                <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../utils/MshTraceSource.cs.html#fbe67220ad7522a0" class="i method">NewArgumentNullException</a>(<b>nameof</b>(<span class="r34 r">drive</span>));
            }
 
            <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r34 r">drive</span>.<a href="../engine/DataStoreAdapter.cs.html#6c8f4db73167e8f9" class="i property">Root</a>))
            {
                <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../utils/MshTraceSource.cs.html#fed5f40dc0075d41" class="i method">NewArgumentException</a>(<span class="s">&quot;drive.Root&quot;</span>);
            }
 
            <span class="c">// -Persist switch parameter is supported only for Network paths.</span>
            <b>if</b> (<span class="r34 r">drive</span>.<a href="../engine/DataStoreAdapter.cs.html#c468fe7b01f8a1b7" class="i property">Persist</a> &amp;&amp; !<a href="#fabdfaa176fe57d0" class="i method">PathIsNetworkPath</a>(<span class="r34 r">drive</span>.<a href="../engine/DataStoreAdapter.cs.html#6c8f4db73167e8f9" class="i property">Root</a>))
            {
                <a href="../engine/ErrorPackage.cs.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r35 rd" class="r35 r">er</span> = <b>new</b> <span class="t">ErrorRecord</span>(<b>new</b> <span class="i">NotSupportedException</span>(<span class="i">FileSystemProviderStrings</span>.<span class="i">PersistNotSupported</span>), <span class="s">&quot;DriveRootNotNetworkPath&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#846d2b572f2c4820" class="i field">InvalidArgument</a>, <span class="r34 r">drive</span>);
                <a href="ProviderBase.cs.html#0c753abd524c8d46" class="i method">ThrowTerminatingError</a>(<span class="r35 r">er</span>);
            }
 
            <b>if</b> (<a href="#f8c7abf85942d294" class="i method">IsNetworkMappedDrive</a>(<span class="r34 r">drive</span>))
            {
                <span class="c">// MapNetworkDrive facilitates to map the newly</span>
                <span class="c">// created PS Drive to a network share.</span>
                <a href="../P/64a92af39f1cd630.html#64a92af39f1cd630" class="k">this</a>.<a href="#2e5920e6f7bdb41e" class="i method">MapNetworkDrive</a>(<span class="r34 r">drive</span>);
            }
 
            <span class="c">// The drive is valid if the item exists or the</span>
            <span class="c">// drive is not a fixed drive.  We want to allow</span>
            <span class="c">// a drive to exist for floppies and other such\</span>
            <span class="c">// removable media, even if the media isn&#39;t in place.</span>
            <b>bool</b> <span id="r36 rd" class="r36 r">driveIsFixed</span> = <b>true</b>;
            <a href="../engine/DataStoreAdapter.cs.html#2d16b26a541ba185" class="t t">PSDriveInfo</a> <span id="r37 rd" class="r37 r">result</span> = <b>null</b>;
 
            <b>try</b>
            {
                <span class="c">// See if the drive is a fixed drive.</span>
                <b>string</b> <span id="r38 rd" class="r38 r">pathRoot</span> = <span class="i">Path</span>.<span class="i">GetPathRoot</span>(<span class="r34 r">drive</span>.<a href="../engine/DataStoreAdapter.cs.html#6c8f4db73167e8f9" class="i property">Root</a>);
                <span class="i">DriveInfo</span> <span id="r39 rd" class="r39 r">driveInfo</span> = <b>new</b> <span class="i">DriveInfo</span>(<span class="r38 r">pathRoot</span>);
 
                <b>if</b> (<span class="r39 r">driveInfo</span>.<span class="i">DriveType</span> != <span class="i">DriveType</span>.<span class="i">Fixed</span>)
                {
                    <span class="r36 r">driveIsFixed</span> = <b>false</b>;
                }
 
                <span class="c">// The current drive is a network drive.</span>
                <b>if</b> (<span class="r39 r">driveInfo</span>.<span class="i">DriveType</span> == <span class="i">DriveType</span>.<span class="i">Network</span>)
                {
                    <span class="r34 r">drive</span>.<a href="../engine/DataStoreAdapter.cs.html#c50685ff8ad27035" class="i property">IsNetworkDrive</a> = <b>true</b>;
                }
            }
            <b>catch</b> (<span class="i">ArgumentException</span>) <span class="c">// swallow ArgumentException incl. ArgumentNullException</span>
            {
            }
 
            <b>bool</b> <span id="r40 rd" class="r40 r">validDrive</span> = <b>true</b>;
 
            <b>if</b> (<span class="r36 r">driveIsFixed</span>)
            {
                <span class="c">// Since the drive is fixed, ensure the root is valid.</span>
                <span class="r40 r">validDrive</span> = <span class="i">Directory</span>.<span class="i">Exists</span>(<span class="r34 r">drive</span>.<a href="../engine/DataStoreAdapter.cs.html#6c8f4db73167e8f9" class="i property">Root</a>);
            }
 
            <b>if</b> (<span class="r40 r">validDrive</span>)
            {
                <span class="r37 r">result</span> = <span class="r34 r">drive</span>;
            }
            <b>else</b>
            {
                <b>string</b> <span id="r41 rd" class="r41 r">error</span> = <a href="../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">FileSystemProviderStrings</span>.<span class="i">DriveRootError</span>, <span class="r34 r">drive</span>.<a href="../engine/DataStoreAdapter.cs.html#6c8f4db73167e8f9" class="i property">Root</a>);
                <span class="i">Exception</span> <span id="r42 rd" class="r42 r">e</span> = <b>new</b> <span class="i">IOException</span>(<span class="r41 r">error</span>);
                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <a href="../engine/ErrorPackage.cs.html#e9334565e5136f43" class="t constructor">ErrorRecord</a>(<span class="r42 r">e</span>, <span class="s">&quot;DriveRootError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#cad1e0e3e13dc1f3" class="i field">ReadError</a>, <span class="r34 r">drive</span>));
            }
 
            <span class="r34 r">drive</span>.<a href="../engine/DataStoreAdapter.cs.html#08d17657703b081f" class="i method">Trace</a>();
 
            <b>return</b> <span class="r37 r">result</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> MapNetworkDrive facilitates to map the newly created PS Drive to a network share.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r43 r">drive</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The PSDrive info that would be used to create a new PS drive.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>private void</b> <a id="2e5920e6f7bdb41e" href="../R/2e5920e6f7bdb41e.html" target="n" data-glyph="76,1" class="i method">MapNetworkDrive</a>(<a href="../engine/DataStoreAdapter.cs.html#2d16b26a541ba185" class="t t">PSDriveInfo</a> <span id="r43 rd" class="r43 r">drive</span>)
        {
            <span class="c">// Porting note: mapped network drives are only supported on Windows</span>
            <b>if</b> (<a href="../CoreCLR/CorePsPlatform.cs.html#693813241122eb45" class="t t">Platform</a>.<a href="../CoreCLR/CorePsPlatform.cs.html#a0395f876114b36d" class="i property">IsWindows</a>)
            {
                <a href="#fb819435df5a467e" class="i method">WinMapNetworkDrive</a>(<span class="r43 r">drive</span>);
            }
            <b>else</b>
            {
                <b>throw</b> <b>new</b> <span class="i">PlatformNotSupportedException</span>();
            }
        }
 
        <b>private static bool</b> <a id="b22c7f17b7e47558" href="../R/b22c7f17b7e47558.html" target="n" data-glyph="46,1" class="i field">_WNetApiAvailable</a> = <b>true</b>;
 
        <b>private void</b> <a id="fb819435df5a467e" href="../R/fb819435df5a467e.html" target="n" data-glyph="76,1" class="i method">WinMapNetworkDrive</a>(<a href="../engine/DataStoreAdapter.cs.html#2d16b26a541ba185" class="t t">PSDriveInfo</a> <span id="r44 rd" class="r44 r">drive</span>)
        {
            <b>if</b> (<span class="r44 r">drive</span> != <b>null</b> &amp;&amp; !<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r44 r">drive</span>.<a href="../engine/DataStoreAdapter.cs.html#6c8f4db73167e8f9" class="i property">Root</a>))
            {
                <b>const int</b> <span id="r45 rd" class="r45 r">CONNECT_UPDATE_PROFILE</span> = 0x00000001;
                <b>const int</b> <span id="r46 rd" class="r46 r">CONNECT_NOPERSIST</span> = 0x00000000;
                <b>const int</b> <span id="r47 rd" class="r47 r">RESOURCE_GLOBALNET</span> = 0x00000002;
                <b>const int</b> <span id="r48 rd" class="r48 r">RESOURCETYPE_ANY</span> = 0x00000000;
                <b>const int</b> <span id="r49 rd" class="r49 r">RESOURCEDISPLAYTYPE_GENERIC</span> = 0x00000000;
                <b>const int</b> <span id="r50 rd" class="r50 r">RESOURCEUSAGE_CONNECTABLE</span> = 0x00000001;
                <b>const int</b> <span id="r51 rd" class="r51 r">ERROR_NO_NETWORK</span> = 1222;
 
                <span class="c">// By default the connection is not persisted.</span>
                <b>int</b> <span id="r52 rd" class="r52 r">CONNECT_TYPE</span> = <span class="r46 r">CONNECT_NOPERSIST</span>;
 
                <b>string</b> <span id="r53 rd" class="r53 r">driveName</span> = <b>null</b>;
                <b>byte</b>[] <span id="r54 rd" class="r54 r">passwd</span> = <b>null</b>;
                <b>string</b> <span id="r55 rd" class="r55 r">userName</span> = <b>null</b>;
 
                <b>if</b> (<span class="r44 r">drive</span>.<a href="../engine/DataStoreAdapter.cs.html#c468fe7b01f8a1b7" class="i property">Persist</a>)
                {
                    <b>if</b> (<a href="#b2e29f3eb088ce7b" class="i method">IsSupportedDriveForPersistence</a>(<span class="r44 r">drive</span>))
                    {
                        <span class="r52 r">CONNECT_TYPE</span> = <span class="r45 r">CONNECT_UPDATE_PROFILE</span>;
                        <span class="r53 r">driveName</span> = <span class="r44 r">drive</span>.<a href="../engine/DataStoreAdapter.cs.html#7c2d83a1b2b425a9" class="i property">Name</a> + <span class="s">&quot;:&quot;</span>;
                        <span class="r44 r">drive</span>.<a href="../engine/DataStoreAdapter.cs.html#5341a582b3d53919" class="i property">DisplayRoot</a> = <span class="r44 r">drive</span>.<a href="../engine/DataStoreAdapter.cs.html#6c8f4db73167e8f9" class="i property">Root</a>;
                    }
                    <b>else</b>
                    {
                        <span class="c">// error.</span>
                        <a href="../engine/ErrorPackage.cs.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r56 rd" class="r56 r">er</span> = <b>new</b> <span class="t">ErrorRecord</span>(<b>new</b> <span class="i">InvalidOperationException</span>(<span class="i">FileSystemProviderStrings</span>.<span class="i">InvalidDriveName</span>), <span class="s">&quot;DriveNameNotSupportedForPersistence&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#b5cba3d51f976bb3" class="i field">InvalidOperation</a>, <span class="r44 r">drive</span>);
                        <a href="ProviderBase.cs.html#0c753abd524c8d46" class="i method">ThrowTerminatingError</a>(<span class="r56 r">er</span>);
                    }
                }
 
                <span class="c">// If alternate credentials is supplied then use them to get connected to network share.</span>
                <b>if</b> (<span class="r44 r">drive</span>.<a href="../engine/DataStoreAdapter.cs.html#3933458893b044e7" class="i property">Credential</a> != <b>null</b> &amp;&amp; !<span class="r44 r">drive</span>.<a href="../engine/DataStoreAdapter.cs.html#3933458893b044e7" class="i property">Credential</a>.<span class="i">Equals</span>(<a href="../engine/Credential.cs.html#6245dc122e2f1916" class="t t">PSCredential</a>.<a href="../engine/Credential.cs.html#8c5314944c80f8ac" class="i property">Empty</a>))
                {
                    <span class="r55 r">userName</span> = <span class="r44 r">drive</span>.<a href="../engine/DataStoreAdapter.cs.html#3933458893b044e7" class="i property">Credential</a>.<a href="../engine/Credential.cs.html#3fca673651eaeaff" class="i property">UserName</a>;
 
                    <span class="r54 r">passwd</span> = <a href="../security/SecureStringHelper.cs.html#01b0e2a85ff89895" class="t t">SecureStringHelper</a>.<a href="../security/SecureStringHelper.cs.html#d19ff3d308142038" class="i method">GetData</a>(<span class="r44 r">drive</span>.<a href="../engine/DataStoreAdapter.cs.html#3933458893b044e7" class="i property">Credential</a>.<a href="../engine/Credential.cs.html#828d5fa008f1755c" class="i property">Password</a>);
                }
 
                <b>try</b>
                {
                    <a href="#62db5386db62a54d" class="t t">NetResource</a> <span id="r57 rd" class="r57 r">resource</span> = <b>new</b> <span class="t">NetResource</span>();
                    <span class="r57 r">resource</span>.<a href="#8fd485e3a5a59659" class="i field">Comment</a> = <b>null</b>;
                    <span class="r57 r">resource</span>.<a href="#a49581a14cbc6e28" class="i field">DisplayType</a> = <span class="r49 r">RESOURCEDISPLAYTYPE_GENERIC</span>;
                    <span class="r57 r">resource</span>.<a href="#b883cb13898c562f" class="i field">LocalName</a> = <span class="r53 r">driveName</span>;
                    <span class="r57 r">resource</span>.<a href="#c6dcab103b697cc6" class="i field">Provider</a> = <b>null</b>;
                    <span class="r57 r">resource</span>.<a href="#8a812494402cf999" class="i field">RemoteName</a> = <span class="r44 r">drive</span>.<a href="../engine/DataStoreAdapter.cs.html#6c8f4db73167e8f9" class="i property">Root</a>;
                    <span class="r57 r">resource</span>.<a href="#89dcbed515b54429" class="i field">Scope</a> = <span class="r47 r">RESOURCE_GLOBALNET</span>;
                    <span class="r57 r">resource</span>.<a href="#5ed2ae11151a493e" class="i field">Type</a> = <span class="r48 r">RESOURCETYPE_ANY</span>;
                    <span class="r57 r">resource</span>.<a href="#f7793deae66f702c" class="i field">Usage</a> = <span class="r50 r">RESOURCEUSAGE_CONNECTABLE</span>;
 
                    <b>int</b> <span id="r58 rd" class="r58 r">code</span> = <span class="r51 r">ERROR_NO_NETWORK</span>;
 
                    <b>if</b> (<a href="#b22c7f17b7e47558" class="i field">_WNetApiAvailable</a>)
                    {
                        <b>try</b>
                        {
                            <span class="r58 r">code</span> = <a href="#f0fcb2141ba63e82" class="t t">NativeMethods</a>.<a href="#8fc3ce8fb6eb99ce" class="i method">WNetAddConnection2</a>(<b>ref</b> <span class="r57 r">resource</span>, <span class="r54 r">passwd</span>, <span class="r55 r">userName</span>, <span class="r52 r">CONNECT_TYPE</span>);
                        }
                        <b>catch</b> (<span class="i n">System</span>.<span class="i">DllNotFoundException</span>)
                        {
                            <a href="#b22c7f17b7e47558" class="i field">_WNetApiAvailable</a> = <b>false</b>;
                        }
                    }
 
                    <b>if</b> (<span class="r58 r">code</span> != 0)
                    {
                        <a href="../engine/ErrorPackage.cs.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r59 rd" class="r59 r">er</span> = <b>new</b> <span class="t">ErrorRecord</span>(<b>new</b> <span class="i n">System</span>.<span class="i">ComponentModel</span>.<span class="i">Win32Exception</span>(<span class="r58 r">code</span>), <span class="s">&quot;CouldNotMapNetworkDrive&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#b5cba3d51f976bb3" class="i field">InvalidOperation</a>, <span class="r44 r">drive</span>);
                        <a href="ProviderBase.cs.html#0c753abd524c8d46" class="i method">ThrowTerminatingError</a>(<span class="r59 r">er</span>);
                    }
 
                    <b>if</b> (<span class="r52 r">CONNECT_TYPE</span> == <span class="r45 r">CONNECT_UPDATE_PROFILE</span>)
                    {
                        <span class="c">// Update the current PSDrive to be a persisted drive.</span>
                        <span class="r44 r">drive</span>.<a href="../engine/DataStoreAdapter.cs.html#c50685ff8ad27035" class="i property">IsNetworkDrive</a> = <b>true</b>;
 
                        <span class="c">// PsDrive.Root is updated to the name of the Drive for</span>
                        <span class="c">// drives targeting network path and being persisted.</span>
                        <span class="r44 r">drive</span>.<a href="../engine/DataStoreAdapter.cs.html#6c8f4db73167e8f9" class="i property">Root</a> = <span class="r53 r">driveName</span> + <span class="s">@&quot;\&quot;</span>;
                    }
                }
                <b>finally</b>
                {
                    <span class="c">// Clear the password in the memory.</span>
                    <b>if</b> (<span class="r54 r">passwd</span> != <b>null</b>)
                    {
                        <span class="i">Array</span>.<span class="i">Clear</span>(<span class="r54 r">passwd</span>, 0, <span class="r54 r">passwd</span>.<span class="i">Length</span> - 1);
                    }
                }
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> ShouldMapNetworkDrive is a helper function used to detect if the</span>
        <span class="c">///</span><span class="c"> requested PSDrive to be created has to be mapped to a network drive.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r60 r">drive</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>private static bool</b> <a id="f8c7abf85942d294" href="../R/f8c7abf85942d294.html" target="n" data-glyph="76,1" class="i method">IsNetworkMappedDrive</a>(<a href="../engine/DataStoreAdapter.cs.html#2d16b26a541ba185" class="t t">PSDriveInfo</a> <span id="r60 rd" class="r60 r">drive</span>)
        {
            <b>bool</b> <span id="r61 rd" class="r61 r">shouldMapNetworkDrive</span> = (<span class="r60 r">drive</span> != <b>null</b> &amp;&amp; !<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r60 r">drive</span>.<a href="../engine/DataStoreAdapter.cs.html#6c8f4db73167e8f9" class="i property">Root</a>) &amp;&amp; <a href="#fabdfaa176fe57d0" class="i method">PathIsNetworkPath</a>(<span class="r60 r">drive</span>.<a href="../engine/DataStoreAdapter.cs.html#6c8f4db73167e8f9" class="i property">Root</a>)) &amp;&amp;
                                         (<span class="r60 r">drive</span>.<a href="../engine/DataStoreAdapter.cs.html#c468fe7b01f8a1b7" class="i property">Persist</a> || (<span class="r60 r">drive</span>.<a href="../engine/DataStoreAdapter.cs.html#3933458893b044e7" class="i property">Credential</a> != <b>null</b> &amp;&amp; !<span class="r60 r">drive</span>.<a href="../engine/DataStoreAdapter.cs.html#3933458893b044e7" class="i property">Credential</a>.<span class="i">Equals</span>(<a href="../engine/Credential.cs.html#6245dc122e2f1916" class="t t">PSCredential</a>.<a href="../engine/Credential.cs.html#8c5314944c80f8ac" class="i property">Empty</a>)));
 
            <b>return</b> <span class="r61 r">shouldMapNetworkDrive</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> RemoveDrive facilitates to remove network mapped persisted PSDrvie.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r62 r">drive</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> PSDrive info.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">PSDrive info.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>protected override</b> <a href="../engine/DataStoreAdapter.cs.html#2d16b26a541ba185" class="t t">PSDriveInfo</a> <a id="d83685a06f7553f0" href="../R/d83685a06f7553f0.html" target="n" data-glyph="75,1" class="i method">RemoveDrive</a>(<a href="../engine/DataStoreAdapter.cs.html#2d16b26a541ba185" class="t t">PSDriveInfo</a> <span id="r62 rd" class="r62 r">drive</span>)
        {
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">UNIX</span>
<span class="e">            return drive;
</span><span class="k preprocess">#</span><span class="k preprocess">else</span>
            <b>return</b> <a href="#5c8ef6b5742882dd" class="i method">WinRemoveDrive</a>(<span class="r62 r">drive</span>);
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
        }
 
        <b>private</b> <a href="../engine/DataStoreAdapter.cs.html#2d16b26a541ba185" class="t t">PSDriveInfo</a> <a id="5c8ef6b5742882dd" href="../R/5c8ef6b5742882dd.html" target="n" data-glyph="76,1" class="i method">WinRemoveDrive</a>(<a href="../engine/DataStoreAdapter.cs.html#2d16b26a541ba185" class="t t">PSDriveInfo</a> <span id="r63 rd" class="r63 r">drive</span>)
        {
            <b>if</b> (<a href="#f8c7abf85942d294" class="i method">IsNetworkMappedDrive</a>(<span class="r63 r">drive</span>))
            {
                <b>const int</b> <span id="r64 rd" class="r64 r">CONNECT_UPDATE_PROFILE</span> = 0x00000001;
                <b>const int</b> <span id="r65 rd" class="r65 r">ERROR_NO_NETWORK</span> = 1222;
 
                <b>int</b> <span id="r66 rd" class="r66 r">flags</span> = 0;
                <b>string</b> <span id="r67 rd" class="r67 r">driveName</span>;
                <b>if</b> (<span class="r63 r">drive</span>.<a href="../engine/DataStoreAdapter.cs.html#c50685ff8ad27035" class="i property">IsNetworkDrive</a>)
                {
                    <span class="c">// Here we are removing only persisted network drives.</span>
                    <span class="r66 r">flags</span> = <span class="r64 r">CONNECT_UPDATE_PROFILE</span>;
                    <span class="r67 r">driveName</span> = <span class="r63 r">drive</span>.<a href="../engine/DataStoreAdapter.cs.html#7c2d83a1b2b425a9" class="i property">Name</a> + <span class="s">&quot;:&quot;</span>;
                }
                <b>else</b>
                {
                    <span class="c">// OSGTFS: 608188 PSDrive leaves a connection open after the drive is removed</span>
                    <span class="c">// if a drive is not persisted or networkdrive, we need to use the actual root to remove the drive.</span>
                    <span class="r67 r">driveName</span> = <span class="r63 r">drive</span>.<a href="../engine/DataStoreAdapter.cs.html#6c8f4db73167e8f9" class="i property">Root</a>;
                }
 
                <span class="c">// You need to actually remove the drive.</span>
                <b>int</b> <span id="r68 rd" class="r68 r">code</span> = <span class="r65 r">ERROR_NO_NETWORK</span>;
 
                <b>if</b> (<a href="#b22c7f17b7e47558" class="i field">_WNetApiAvailable</a>)
                {
                    <b>try</b>
                    {
                        <span class="r68 r">code</span> = <a href="#f0fcb2141ba63e82" class="t t">NativeMethods</a>.<a href="#c0450c8f0d10f87e" class="i method">WNetCancelConnection2</a>(<span class="r67 r">driveName</span>, <span class="r66 r">flags</span>, <b>true</b>);
                    }
                    <b>catch</b> (<span class="i n">System</span>.<span class="i">DllNotFoundException</span>)
                    {
                        <a href="#b22c7f17b7e47558" class="i field">_WNetApiAvailable</a> = <b>false</b>;
                    }
                }
 
                <b>if</b> (<span class="r68 r">code</span> != 0)
                {
                    <a href="../engine/ErrorPackage.cs.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r69 rd" class="r69 r">er</span> = <b>new</b> <span class="t">ErrorRecord</span>(<b>new</b> <span class="i n">System</span>.<span class="i">ComponentModel</span>.<span class="i">Win32Exception</span>(<span class="r68 r">code</span>), <span class="s">&quot;CouldRemoveNetworkDrive&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#b5cba3d51f976bb3" class="i field">InvalidOperation</a>, <span class="r63 r">drive</span>);
                    <a href="ProviderBase.cs.html#0c753abd524c8d46" class="i method">ThrowTerminatingError</a>(<span class="r69 r">er</span>);
                }
            }
 
            <b>return</b> <span class="r63 r">drive</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> IsSupportedDriveForPersistence is a helper method used to</span>
        <span class="c">///</span><span class="c"> check if the psdrive can be persisted or not.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r70 r">drive</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> PS Drive Info.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">True if the drive can be persisted or else false.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>private static bool</b> <a id="b2e29f3eb088ce7b" href="../R/b2e29f3eb088ce7b.html" target="n" data-glyph="76,1" class="i method">IsSupportedDriveForPersistence</a>(<a href="../engine/DataStoreAdapter.cs.html#2d16b26a541ba185" class="t t">PSDriveInfo</a> <span id="r70 rd" class="r70 r">drive</span>)
        {
            <b>bool</b> <span id="r71 rd" class="r71 r">isSupportedDriveForPersistence</span> = <b>false</b>;
            <b>if</b> (<span class="r70 r">drive</span> != <b>null</b> &amp;&amp; !<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r70 r">drive</span>.<a href="../engine/DataStoreAdapter.cs.html#7c2d83a1b2b425a9" class="i property">Name</a>) &amp;&amp; <span class="r70 r">drive</span>.<a href="../engine/DataStoreAdapter.cs.html#7c2d83a1b2b425a9" class="i property">Name</a>.<span class="i">Length</span> == 1)
            {
                <b>char</b> <span id="r72 rd" class="r72 r">driveChar</span> = <span class="i">Convert</span>.<span class="i">ToChar</span>(<span class="r70 r">drive</span>.<a href="../engine/DataStoreAdapter.cs.html#7c2d83a1b2b425a9" class="i property">Name</a>, <span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>);
 
                <b>if</b> (<b>char</b>.<span class="i">ToUpperInvariant</span>(<span class="r72 r">driveChar</span>) &gt;= <span class="s">&#39;A&#39;</span> &amp;&amp; <b>char</b>.<span class="i">ToUpperInvariant</span>(<span class="r72 r">driveChar</span>) &lt;= <span class="s">&#39;Z&#39;</span>)
                {
                    <span class="r71 r">isSupportedDriveForPersistence</span> = <b>true</b>;
                }
            }
 
            <b>return</b> <span class="r71 r">isSupportedDriveForPersistence</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Return the UNC path for a given network drive</span>
        <span class="c">///</span><span class="c"> using the Windows API.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r73 r">driveName</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal static string</b> <a id="ae0808b43b0b4826" href="../R/ae0808b43b0b4826.html" target="n" data-glyph="74,1" class="i method">GetUNCForNetworkDrive</a>(<b>string</b> <span id="r73 rd" class="r73 r">driveName</span>)
        {
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">UNIX</span>
<span class="e">            return driveName;
</span><span class="k preprocess">#</span><span class="k preprocess">else</span>
            <b>return</b> <a href="#60490811be878a91" class="i method">WinGetUNCForNetworkDrive</a>(<span class="r73 r">driveName</span>);
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
        }
 
        <b>private static string</b> <a id="60490811be878a91" href="../R/60490811be878a91.html" target="n" data-glyph="76,1" class="i method">WinGetUNCForNetworkDrive</a>(<b>string</b> <span id="r74 rd" class="r74 r">driveName</span>)
        {
            <b>const int</b> <span id="r75 rd" class="r75 r">ERROR_NO_NETWORK</span> = 1222;
            <b>string</b> <span id="r76 rd" class="r76 r">uncPath</span> = <b>null</b>;
            <b>if</b> (!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r74 r">driveName</span>) &amp;&amp; <span class="r74 r">driveName</span>.<span class="i">Length</span> == 1)
            {
                <span class="c">// By default buffer size is set to 300 which would generally be sufficient in most of the cases.</span>
                <b>int</b> <span id="r77 rd" class="r77 r">bufferSize</span> = 300;
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">DEBUG</span>
                <span class="c">// In Debug mode buffer size is initially set to 3 and if additional buffer is required, the</span>
                <span class="c">// required buffer size is allocated and the WNetGetConnection API is executed with the newly</span>
                <span class="c">// allocated buffer size.</span>
                <span class="r77 r">bufferSize</span> = 3;
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
 
                <span class="i">StringBuilder</span> <span id="r78 rd" class="r78 r">uncBuffer</span> = <b>new</b> <span class="i">StringBuilder</span>(<span class="r77 r">bufferSize</span>);
                <span class="r74 r">driveName</span> += <span class="s">&#39;:&#39;</span>;
 
                <span class="c">// Call the windows API</span>
                <b>int</b> <span id="r79 rd" class="r79 r">errorCode</span> = <span class="r75 r">ERROR_NO_NETWORK</span>;
 
                <b>try</b>
                {
                    <span class="r79 r">errorCode</span> = <a href="#f0fcb2141ba63e82" class="t t">NativeMethods</a>.<a href="#5615424d0bdd9184" class="i method">WNetGetConnection</a>(<span class="r74 r">driveName</span>, <span class="r78 r">uncBuffer</span>, <b>ref</b> <span class="r77 r">bufferSize</span>);
                }
                <b>catch</b> (<span class="i n">System</span>.<span class="i">DllNotFoundException</span>)
                {
                    <b>return</b> <b>null</b>;
                }
 
                <span class="c">// error code 234 is returned whenever the required buffer size is greater</span>
                <span class="c">// than the specified buffer size.</span>
                <b>if</b> (<span class="r79 r">errorCode</span> == 234)
                {
                    <span class="r78 r">uncBuffer</span> = <b>new</b> <span class="i">StringBuilder</span>(<span class="r77 r">bufferSize</span>);
                    <span class="r79 r">errorCode</span> = <a href="#f0fcb2141ba63e82" class="t t">NativeMethods</a>.<a href="#5615424d0bdd9184" class="i method">WNetGetConnection</a>(<span class="r74 r">driveName</span>, <span class="r78 r">uncBuffer</span>, <b>ref</b> <span class="r77 r">bufferSize</span>);
                }
 
                <b>if</b> (<span class="r79 r">errorCode</span> != 0)
                {
                    <b>throw</b> <b>new</b> <span class="i n">System</span>.<span class="i">ComponentModel</span>.<span class="i">Win32Exception</span>(<span class="r79 r">errorCode</span>);
                }
 
                <span class="r76 r">uncPath</span> = <span class="r78 r">uncBuffer</span>.<span class="i">ToString</span>();
            }
 
            <b>return</b> <span class="r76 r">uncPath</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Get the substituted path of a NetWork type MS-DOS device that is created by &#39;subst&#39; command.</span>
        <span class="c">///</span><span class="c"> When a MS-DOS device is of NetWork type, it could be:</span>
        <span class="c">///</span><span class="c">   1. Substitute a path in a drive that maps to a network location. For example:</span>
        <span class="c">///</span><span class="c">         net use z: \\scratch2\scratch\</span>
        <span class="c">///</span><span class="c">         subst y: z:\abc\</span>
        <span class="c">///</span><span class="c">   2. Substitute a network location directly. For example:</span>
        <span class="c">///</span><span class="c">         subst y: \\scratch2\scratch\</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r80 r">driveName</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal static string</b> <a id="efd84ef8849e7ba2" href="../R/efd84ef8849e7ba2.html" target="n" data-glyph="74,1" class="i method">GetSubstitutedPathForNetworkDosDevice</a>(<b>string</b> <span id="r80 rd" class="r80 r">driveName</span>)
        {
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">UNIX</span>
<span class="e">            throw new PlatformNotSupportedException();
</span><span class="k preprocess">#</span><span class="k preprocess">else</span>
            <b>return</b> <a href="#06713bb629535d43" class="i method">WinGetSubstitutedPathForNetworkDosDevice</a>(<span class="r80 r">driveName</span>);
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
        }
 
        <b>private static string</b> <a id="06713bb629535d43" href="../R/06713bb629535d43.html" target="n" data-glyph="76,1" class="i method">WinGetSubstitutedPathForNetworkDosDevice</a>(<b>string</b> <span id="r81 rd" class="r81 r">driveName</span>)
        {
            <b>string</b> <span id="r82 rd" class="r82 r">associatedPath</span> = <b>null</b>;
            <b>if</b> (!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r81 r">driveName</span>) &amp;&amp; <span class="r81 r">driveName</span>.<span class="i">Length</span> == 1)
            {
                <span class="c">// By default buffer size is set to 300 which would generally be sufficient in most of the cases.</span>
                <b>int</b> <span id="r83 rd" class="r83 r">bufferSize</span> = 300;
                <b>var</b> <span id="r84 rd" class="r84 r">pathInfo</span> = <b>new</b> <span class="i">StringBuilder</span>(<span class="r83 r">bufferSize</span>);
                <span class="r81 r">driveName</span> += <span class="s">&#39;:&#39;</span>;
 
                <span class="c">// Call the windows API</span>
                <b>while</b> (<b>true</b>)
                {
                    <span class="r84 r">pathInfo</span>.<span class="i">EnsureCapacity</span>(<span class="r83 r">bufferSize</span>);
                    <b>int</b> <span id="r85 rd" class="r85 r">retValue</span> = <a href="#f0fcb2141ba63e82" class="t t">NativeMethods</a>.<a href="#83e0d4edeb60f583" class="i method">QueryDosDevice</a>(<span class="r81 r">driveName</span>, <span class="r84 r">pathInfo</span>, <span class="r83 r">bufferSize</span>);
                    <b>if</b> (<span class="r85 r">retValue</span> &gt; 0)
                    {
                        <span class="c">// If the drive letter is a substed path, the result will be in the format of</span>
                        <span class="c">//  - &quot;\??\C:\RealPath&quot; for local path</span>
                        <span class="c">//  - &quot;\??\UNC\RealPath&quot; for network path</span>
                        <span class="r82 r">associatedPath</span> = <span class="r84 r">pathInfo</span>.<span class="i">ToString</span>();
                        <b>if</b> (<span class="r82 r">associatedPath</span>.<span class="i">StartsWith</span>(<span class="s">&quot;\\??\\&quot;</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
                        {
                            <span class="r82 r">associatedPath</span> = <span class="r82 r">associatedPath</span>.<span class="i">Remove</span>(0, 4);
                            <b>if</b> (<span class="r82 r">associatedPath</span>.<span class="i">StartsWith</span>(<span class="s">&quot;UNC&quot;</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
                            {
                                <span class="r82 r">associatedPath</span> = <span class="r82 r">associatedPath</span>.<span class="i">Remove</span>(0, 3);
                                <span class="r82 r">associatedPath</span> = <span class="s">&quot;\\&quot;</span> + <span class="r82 r">associatedPath</span>;
                            }
                            <b>else</b> <b>if</b> (<span class="r82 r">associatedPath</span>.<span class="i">EndsWith</span>(<span class="s">&#39;:&#39;</span>))
                            {
                                <span class="c">// The substed path is the root path of a drive. For example: subst Y: C:\</span>
                                <span class="r82 r">associatedPath</span> += <span class="i">Path</span>.<span class="i">DirectorySeparatorChar</span>;
                            }
                        }
                        <b>else</b>
                        {
                            <span class="c">// The drive name is not a substed path, then we return the root path of the drive</span>
                            <span class="r82 r">associatedPath</span> = <span class="r81 r">driveName</span> + <span class="s">&quot;\\&quot;</span>;
                        }
 
                        <b>break</b>;
                    }
 
                    <span class="c">// Windows API call failed</span>
                    <b>int</b> <span id="r86 rd" class="r86 r">errorCode</span> = <span class="i">Marshal</span>.<span class="i">GetLastWin32Error</span>();
                    <b>if</b> (<span class="r86 r">errorCode</span> != 122)
                    {
                        <span class="c">// ERROR_INSUFFICIENT_BUFFER = 122</span>
                        <span class="c">// For an error other than &quot;insufficient buffer&quot;, throw it</span>
                        <b>throw</b> <b>new</b> <span class="i">Win32Exception</span>((<b>int</b>)<span class="r86 r">errorCode</span>);
                    }
 
                    <span class="c">// We got the &quot;insufficient buffer&quot; error. In this case we extend</span>
                    <span class="c">// the buffer size, unless it&#39;s unreasonably too large.</span>
                    <b>if</b> (<span class="r83 r">bufferSize</span> &gt;= 32767)
                    {
                        <span class="c">// &quot;The Windows API has many functions that also have Unicode versions to permit</span>
                        <span class="c">// an extended-length path for a maximum total path length of 32,767 characters&quot;</span>
                        <span class="c">// See https://msdn.microsoft.com/library/aa365247.aspx#maxpath</span>
                        <b>string</b> <span id="r87 rd" class="r87 r">errorMsg</span> = <a href="../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">FileSystemProviderStrings</span>.<span class="i">SubstitutePathTooLong</span>, <span class="r81 r">driveName</span>);
                        <b>throw</b> <b>new</b> <span class="i">InvalidOperationException</span>(<span class="r87 r">errorMsg</span>);
                    }
 
                    <span class="c">// Extend the buffer size and try again.</span>
                    <span class="r83 r">bufferSize</span> *= 10;
                    <b>if</b> (<span class="r83 r">bufferSize</span> &gt; 32767)
                    {
                        <span class="r83 r">bufferSize</span> = 32767;
                    }
                }
            }
 
            <b>return</b> <span class="r82 r">associatedPath</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Get the root path for a network drive or MS-DOS device.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r88 r">driveInfo</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal static string</b> <a id="976211c77a4c94a0" href="../R/976211c77a4c94a0.html" target="n" data-glyph="74,1" class="i method">GetRootPathForNetworkDriveOrDosDevice</a>(<span class="i">DriveInfo</span> <span id="r88 rd" class="r88 r">driveInfo</span>)
        {
            <span class="i n">Dbg</span>.<a href="../utils/assert.cs.html#c04955255430d32f" class="t t">Diagnostics</a>.<a href="../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r88 r">driveInfo</span>.<span class="i">DriveType</span> == <span class="i">DriveType</span>.<span class="i">Network</span>, <span class="s">&quot;Caller should make sure it is a network drive.&quot;</span>);
 
            <b>string</b> <span id="r89 rd" class="r89 r">driveName</span> = <span class="r88 r">driveInfo</span>.<span class="i">Name</span>.<span class="i">Substring</span>(0, 1);
            <b>string</b> <span id="r90 rd" class="r90 r">rootPath</span> = <b>null</b>;
 
            <b>try</b>
            {
                <span class="r90 r">rootPath</span> = <a href="#ae0808b43b0b4826" class="i method">GetUNCForNetworkDrive</a>(<span class="r89 r">driveName</span>);
            }
            <b>catch</b> (<span class="i">Win32Exception</span>)
            {
                <b>if</b> (<span class="r88 r">driveInfo</span>.<span class="i">IsReady</span>)
                {
                    <span class="c">// The drive is ready but we failed to find the UNC path based on the drive name.</span>
                    <span class="c">// In this case, it&#39;s possibly a MS-DOS device created by &#39;subst&#39; command that</span>
                    <span class="c">//  - substitutes a network location directly, or</span>
                    <span class="c">//  - substitutes a path in a drive that maps to a network location</span>
                    <span class="r90 r">rootPath</span> = <a href="#efd84ef8849e7ba2" class="i method">GetSubstitutedPathForNetworkDosDevice</a>(<span class="r89 r">driveName</span>);
                }
                <b>else</b>
                {
                    <b>throw</b>;
                }
            }
 
            <b>return</b> <span class="r90 r">rootPath</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Returns a collection of all logical drives in the system.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> A collection of PSDriveInfo objects, one for each logical drive returned from</span>
        <span class="c">///</span><span class="c"> System.Environment.GetLogicalDrives().</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>protected override</b> <span class="i">Collection</span>&lt;<a href="../engine/DataStoreAdapter.cs.html#2d16b26a541ba185" class="t t">PSDriveInfo</a>&gt; <a id="beb3177f35aa4734" href="../R/beb3177f35aa4734.html" target="n" data-glyph="75,1" class="i method">InitializeDefaultDrives</a>()
        {
            <span class="i">Collection</span>&lt;<a href="../engine/DataStoreAdapter.cs.html#2d16b26a541ba185" class="t t">PSDriveInfo</a>&gt; <span id="r91 rd" class="r91 r">results</span> = <b>new</b> <span class="i">Collection</span>&lt;<a href="../engine/DataStoreAdapter.cs.html#2d16b26a541ba185" class="t t">PSDriveInfo</a>&gt;();
 
            <span class="i">DriveInfo</span>[] <span id="r92 rd" class="r92 r">logicalDrives</span> = <span class="i">DriveInfo</span>.<span class="i">GetDrives</span>();
            <b>if</b> (<span class="r92 r">logicalDrives</span> != <b>null</b>)
            {
                <b>foreach</b> (<span class="i">DriveInfo</span> <span id="r93 rd" class="r93 r">newDrive</span> <b>in</b> <span class="r92 r">logicalDrives</span>)
                {
                    <span class="c">// Making sure to obey the StopProcessing.</span>
                    <b>if</b> (<a href="ProviderBase.cs.html#7f198513b75d23b5" class="i property">Stopping</a>)
                    {
                        <span class="r91 r">results</span>.<span class="i">Clear</span>();
                        <b>break</b>;
                    }
 
                    <span class="c">// cover everything by the try-catch block, because some of the</span>
                    <span class="c">// DriveInfo properties may throw exceptions</span>
                    <b>try</b>
                    {
                        <b>string</b> <span id="r94 rd" class="r94 r">newDriveName</span> = <span class="r93 r">newDrive</span>.<span class="i">Name</span>.<span class="i">Substring</span>(0, 1);
 
                        <b>string</b> <span id="r95 rd" class="r95 r">description</span> = <b>string</b>.<span class="i">Empty</span>;
                        <b>string</b> <span id="r96 rd" class="r96 r">root</span> = <span class="r93 r">newDrive</span>.<span class="i">Name</span>;
                        <b>string</b> <span id="r97 rd" class="r97 r">displayRoot</span> = <b>null</b>;
 
                        <b>if</b> (<span class="r93 r">newDrive</span>.<span class="i">DriveType</span> == <span class="i">DriveType</span>.<span class="i">Fixed</span>)
                        {
                            <b>try</b>
                            {
                                <span class="r95 r">description</span> = <span class="r93 r">newDrive</span>.<span class="i">VolumeLabel</span>;
                            }
                            <span class="c">// trying to read the volume label may cause an</span>
                            <span class="c">// IOException or SecurityException. Just default</span>
                            <span class="c">// to an empty description.</span>
                            <b>catch</b> (<span class="i">IOException</span>)
                            {
                            }
                            <b>catch</b> (<span class="i n">System</span>.<span class="i">Security</span>.<span class="i">SecurityException</span>)
                            {
                            }
                            <b>catch</b> (<span class="i n">System</span>.<span class="i">UnauthorizedAccessException</span>)
                            {
                            }
                        }
 
                        <b>if</b> (<span class="r93 r">newDrive</span>.<span class="i">DriveType</span> == <span class="i">DriveType</span>.<span class="i">Network</span>)
                        {
                            <span class="c">// Platform notes: This is important because certain mount</span>
                            <span class="c">// points on non-Windows are enumerated as drives by .NET, but</span>
                            <span class="c">// the platform itself then has no real network drive support</span>
                            <span class="c">// as required by this context. Solution: check for network</span>
                            <span class="c">// drive support before using it.</span>
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">UNIX</span>
<span class="e">                            continue;
</span><span class="k preprocess">#</span><span class="k preprocess">else</span>
                            <span class="r97 r">displayRoot</span> = <a href="#976211c77a4c94a0" class="i method">GetRootPathForNetworkDriveOrDosDevice</a>(<span class="r93 r">newDrive</span>);
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
                        }
 
                        <b>if</b> (<span class="r93 r">newDrive</span>.<span class="i">DriveType</span> == <span class="i">DriveType</span>.<span class="i">Fixed</span>)
                        {
                            <b>if</b> (!<span class="r93 r">newDrive</span>.<span class="i">RootDirectory</span>.<span class="i">Exists</span>)
                            {
                                <b>continue</b>;
                            }
 
                            <span class="r96 r">root</span> = <span class="r93 r">newDrive</span>.<span class="i">RootDirectory</span>.<span class="i">FullName</span>;
                        }
 
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">UNIX</span>
<span class="e">                        // Porting notes: On platforms with single root filesystems, ensure
                        // that we add a filesystem with the root &quot;/&quot; to the initial drive list,
                        // otherwise path handling will not work correctly because there
                        // is no : available to separate the filesystems from each other
                        if (root != StringLiterals.DefaultPathSeparatorString
                            &amp;&amp; newDriveName == StringLiterals.DefaultPathSeparatorString)
                        {
                            root = StringLiterals.DefaultPathSeparatorString;
                        }
</span><span class="k preprocess">#</span><span class="k preprocess">endif</span>
 
                        <span class="c">// Porting notes: On non-windows platforms .net can report two</span>
                        <span class="c">// drives with the same root, make sure to only add one of those</span>
                        <b>bool</b> <span id="r98 rd" class="r98 r">skipDuplicate</span> = <b>false</b>;
                        <b>foreach</b> (<a href="../engine/DataStoreAdapter.cs.html#2d16b26a541ba185" class="t t">PSDriveInfo</a> <span id="r99 rd" class="r99 r">driveInfo</span> <b>in</b> <span class="r91 r">results</span>)
                        {
                            <b>if</b> (<span class="r99 r">driveInfo</span>.<a href="../engine/DataStoreAdapter.cs.html#6c8f4db73167e8f9" class="i property">Root</a> == <span class="r96 r">root</span>)
                            {
                                <span class="r98 r">skipDuplicate</span> = <b>true</b>;
                                <b>break</b>;
                            }
                        }
 
                        <b>if</b> (<span class="r98 r">skipDuplicate</span>)
                        {
                            <b>continue</b>;
                        }
 
                        <span class="c">// Create a new VirtualDrive for each logical drive</span>
                        <a href="../engine/DataStoreAdapter.cs.html#2d16b26a541ba185" class="t t">PSDriveInfo</a> <span id="r100 rd" class="r100 r">newPSDriveInfo</span> =
                            <b>new</b> <a href="../engine/DataStoreAdapter.cs.html#efa779fdecdcde69" class="t constructor">PSDriveInfo</a>(
                                <span class="r94 r">newDriveName</span>,
                                <a href="ProviderBase.cs.html#6129ef83671ead76" class="i property">ProviderInfo</a>,
                                <span class="r96 r">root</span>,
                                <span class="r95 r">description</span>,
                                <b>null</b>,
                                <span class="r97 r">displayRoot</span>);
 
                        <span class="c">// The network drive is detected when PowerShell is launched.</span>
                        <span class="c">// Hence it has been persisted during one of the earlier sessions,</span>
                        <b>if</b> (<span class="r93 r">newDrive</span>.<span class="i">DriveType</span> == <span class="i">DriveType</span>.<span class="i">Network</span>)
                        {
                            <span class="r100 r">newPSDriveInfo</span>.<a href="../engine/DataStoreAdapter.cs.html#c50685ff8ad27035" class="i property">IsNetworkDrive</a> = <b>true</b>;
                        }
 
                        <b>if</b> (<span class="r93 r">newDrive</span>.<span class="i">DriveType</span> != <span class="i">DriveType</span>.<span class="i">Fixed</span>)
                        {
                            <span class="r100 r">newPSDriveInfo</span>.<a href="../engine/DataStoreAdapter.cs.html#84a02b38509aa94e" class="i property">IsAutoMounted</a> = <b>true</b>;
                        }
 
                        <span class="c">// Porting notes: on the non-Windows platforms, the drive never</span>
                        <span class="c">// uses : as a separator between drive and path</span>
                        <b>if</b> (!<a href="../CoreCLR/CorePsPlatform.cs.html#693813241122eb45" class="t t">Platform</a>.<a href="../CoreCLR/CorePsPlatform.cs.html#a0395f876114b36d" class="i property">IsWindows</a>)
                        {
                            <span class="r100 r">newPSDriveInfo</span>.<a href="../engine/DataStoreAdapter.cs.html#70ae98926d1292a8" class="i property">VolumeSeparatedByColon</a> = <b>false</b>;
                        }
 
                        <span class="r91 r">results</span>.<span class="i">Add</span>(<span class="r100 r">newPSDriveInfo</span>);
                    }
                    <span class="c">// If there are issues accessing properties of the DriveInfo, do</span>
                    <span class="c">// not add the drive</span>
                    <b>catch</b> (<span class="i">IOException</span>)
                    {
                    }
                    <b>catch</b> (<span class="i n">System</span>.<span class="i">Security</span>.<span class="i">SecurityException</span>)
                    {
                    }
                    <b>catch</b> (<span class="i n">System</span>.<span class="i">UnauthorizedAccessException</span>)
                    {
                    }
                }
            }
 
            <span class="r91 r">results</span>.<span class="i">Add</span>(
                <b>new</b> <span class="t">PSDriveInfo</span>(
                    <a href="../engine/DriveNames.cs.html#00aef61a46dad828" class="t t">DriveNames</a>.<a href="../engine/DriveNames.cs.html#68d6b12001289168" class="i field">TempDrive</a>,
                    <a href="ProviderBase.cs.html#6129ef83671ead76" class="i property">ProviderInfo</a>,
                    <span class="i">Path</span>.<span class="i">GetTempPath</span>(),
                    <span class="i">SessionStateStrings</span>.<span class="i">TempDriveDescription</span>,
                    <span class="i">credential</span>: <b>null</b>,
                    <span class="i">displayRoot</span>: <b>null</b>)
            );
 
            <b>return</b> <span class="r91 r">results</span>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> DriveCmdletProvider methods
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> ItemCmdletProvider methods
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Retrieves the dynamic parameters required for the Get-Item cmdlet.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r101 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The path of the file to process.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">An instance of the FileSystemProviderGetItemDynamicParameters class that represents the dynamic parameters.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>protected override object</b> <a id="f6d81d0af47f5243" href="../R/f6d81d0af47f5243.html" target="n" data-glyph="75,1" class="i method">GetItemDynamicParameters</a>(<b>string</b> <span id="r101 rd" class="r101 r">path</span>)
        {
            <b>return</b> <b>new</b> <span class="t">FileSystemProviderGetItemDynamicParameters</span>();
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Determines if the specified path is syntactically and semantically valid.</span>
        <span class="c">///</span><span class="c"> An example path looks like this</span>
        <span class="c">///</span><span class="c">     C:\WINNT\Media\chimes.wav.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r102 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The fully qualified path to validate.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> True if the path is valid, false otherwise.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>protected override bool</b> <a id="5c5e8a134ef48ff4" href="../R/5c5e8a134ef48ff4.html" target="n" data-glyph="75,1" class="i method">IsValidPath</a>(<b>string</b> <span id="r102 rd" class="r102 r">path</span>)
        {
            <span class="c">// Path passed should be fully qualified path.</span>
            <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r102 r">path</span>))
            {
                <b>return</b> <b>false</b>;
            }
 
            <span class="c">// Normalize the path</span>
            <span class="r102 r">path</span> = <a href="#2679b47e3c6ebedc" class="i method">NormalizePath</a>(<span class="r102 r">path</span>);
            <span class="r102 r">path</span> = <a href="#23abd537fda56143" class="i method">EnsureDriveIsRooted</a>(<span class="r102 r">path</span>);
 
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">UNIX</span>
            <span class="c">// Remove alternate data stream references</span>
            <span class="c">// See if they&#39;ve used the inline stream syntax. They have more than one colon.</span>
            <b>int</b> <span id="r103 rd" class="r103 r">firstColon</span> = <span class="r102 r">path</span>.<span class="i">IndexOf</span>(<span class="s">&#39;:&#39;</span>);
            <b>int</b> <span id="r104 rd" class="r104 r">secondColon</span> = <span class="r102 r">path</span>.<span class="i">IndexOf</span>(<span class="s">&#39;:&#39;</span>, <span class="r103 r">firstColon</span> + 1);
            <b>if</b> (<span class="r104 r">secondColon</span> &gt; 0)
            {
                <span class="r102 r">path</span> = <span class="r102 r">path</span>.<span class="i">Substring</span>(0, <span class="r104 r">secondColon</span>);
            }
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
 
            <span class="c">// Make sure the path is either drive rooted or UNC Path</span>
            <b>if</b> (!<a href="#ab87c5ca4d4c6949" class="i method">IsAbsolutePath</a>(<span class="r102 r">path</span>) &amp;&amp; !<a href="../engine/Utils.cs.html#9185d6ecbaebbec0" class="t t">Utils</a>.<a href="../engine/Utils.cs.html#035be1ae91f35c16" class="i method">PathIsUnc</a>(<span class="r102 r">path</span>))
            {
                <b>return</b> <b>false</b>;
            }
 
            <span class="c">// Exceptions should only deal with exceptional circumstances,</span>
            <span class="c">// but unfortunately, FileInfo offers no Try() methods that</span>
            <span class="c">// let us check if we _could_ open the file.</span>
            <b>try</b>
            {
                <span class="i">FileInfo</span> <span id="r105 rd" class="r105 r">testFile</span> = <b>new</b> <span class="i">FileInfo</span>(<span class="r102 r">path</span>);
            }
            <b>catch</b> (<span class="i">Exception</span> <span id="r106 rd" class="r106 r">e</span>)
            {
                <b>if</b> ((<span class="r106 r">e</span> <b>is</b> <span class="i">ArgumentNullException</span>) ||
                    (<span class="r106 r">e</span> <b>is</b> <span class="i">ArgumentException</span>) ||
                    (<span class="r106 r">e</span> <b>is</b> <span class="i n">System</span>.<span class="i">Security</span>.<span class="i">SecurityException</span>) ||
                    (<span class="r106 r">e</span> <b>is</b> <span class="i">UnauthorizedAccessException</span>) ||
                    (<span class="r106 r">e</span> <b>is</b> <span class="i">PathTooLongException</span>) ||
                    (<span class="r106 r">e</span> <b>is</b> <span class="i">NotSupportedException</span>))
                {
                    <b>return</b> <b>false</b>;
                }
                <b>else</b>
                {
                    <b>throw</b>;
                }
            }
 
            <b>return</b> <b>true</b>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the item at the specified path.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r107 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> A fully qualified path representing a file or directory in the</span>
        <span class="c">///</span><span class="c"> file system.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Nothing.  FileInfo and DirectoryInfo objects are written to the</span>
        <span class="c">///</span><span class="c"> context&#39;s pipeline.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">System</span>.<span class="i">ArgumentException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">     path is null or empty.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>protected override void</b> <a id="6c313ad23eb5b365" href="../R/6c313ad23eb5b365.html" target="n" data-glyph="75,1" class="i method">GetItem</a>(<b>string</b> <span id="r107 rd" class="r107 r">path</span>)
        {
            <span class="c">// Validate the argument</span>
            <b>bool</b> <span id="r108 rd" class="r108 r">isContainer</span> = <b>false</b>;
 
            <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r107 r">path</span>))
            {
                <span class="c">// The parameter was null, throw an exception</span>
                <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../utils/MshTraceSource.cs.html#fed5f40dc0075d41" class="i method">NewArgumentException</a>(<b>nameof</b>(<span class="r107 r">path</span>));
            }
 
            <b>try</b>
            {
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">UNIX</span>
                <b>bool</b> <span id="r109 rd" class="r109 r">retrieveStreams</span> = <b>false</b>;
                <a href="#187ca243c9c08a1e" class="t t">FileSystemProviderGetItemDynamicParameters</a> <span id="r110 rd" class="r110 r">dynamicParameters</span> = <b>null</b>;
 
                <b>if</b> (<a href="ProviderBase.cs.html#57d60aa2d2bc908d" class="i property">DynamicParameters</a> != <b>null</b>)
                {
                    <span class="r110 r">dynamicParameters</span> = <a href="ProviderBase.cs.html#57d60aa2d2bc908d" class="i property">DynamicParameters</a> <b>as</b> <a href="#187ca243c9c08a1e" class="t t">FileSystemProviderGetItemDynamicParameters</a>;
                    <b>if</b> (<span class="r110 r">dynamicParameters</span> != <b>null</b>)
                    {
                        <b>if</b> ((<span class="r110 r">dynamicParameters</span>.<a href="#6fc3e642a4cf1972" class="i property">Stream</a> != <b>null</b>) &amp;&amp; (<span class="r110 r">dynamicParameters</span>.<a href="#6fc3e642a4cf1972" class="i property">Stream</a>.<span class="i">Length</span> &gt; 0))
                        {
                            <span class="r109 r">retrieveStreams</span> = <b>true</b>;
                        }
                        <b>else</b>
                        {
                            <span class="c">// See if they&#39;ve used the inline stream syntax. They have more than one colon.</span>
                            <b>int</b> <span id="r111 rd" class="r111 r">firstColon</span> = <span class="r107 r">path</span>.<span class="i">IndexOf</span>(<span class="s">&#39;:&#39;</span>);
                            <b>int</b> <span id="r112 rd" class="r112 r">secondColon</span> = <span class="r107 r">path</span>.<span class="i">IndexOf</span>(<span class="s">&#39;:&#39;</span>, <span class="r111 r">firstColon</span> + 1);
                            <b>if</b> (<span class="r112 r">secondColon</span> &gt; 0)
                            {
                                <b>string</b> <span id="r113 rd" class="r113 r">streamName</span> = <span class="r107 r">path</span>.<span class="i">Substring</span>(<span class="r112 r">secondColon</span> + 1);
                                <span class="r107 r">path</span> = <span class="r107 r">path</span>.<span class="i">Remove</span>(<span class="r112 r">secondColon</span>);
 
                                <span class="r109 r">retrieveStreams</span> = <b>true</b>;
                                <span class="r110 r">dynamicParameters</span> = <b>new</b> <span class="t">FileSystemProviderGetItemDynamicParameters</span>();
                                <span class="r110 r">dynamicParameters</span>.<a href="#6fc3e642a4cf1972" class="i property">Stream</a> = <b>new</b> <b>string</b>[] { <span class="r113 r">streamName</span> };
                            }
                        }
                    }
                }
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
 
                <span class="i">FileSystemInfo</span> <span id="r114 rd" class="r114 r">result</span> = <a href="#0ee3f4e33785948c" class="i method">GetFileSystemItem</a>(<span class="r107 r">path</span>, <b>ref</b> <span class="r108 r">isContainer</span>, <b>false</b>);
                <b>if</b> (<span class="r114 r">result</span> != <b>null</b>)
                {
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">UNIX</span>
                    <span class="c">// If we want to retrieve the file streams, retrieve them.</span>
                    <b>if</b> (<span class="r109 r">retrieveStreams</span>)
                    {
                        <b>foreach</b> (<b>string</b> <span id="r115 rd" class="r115 r">desiredStream</span> <b>in</b> <span class="r110 r">dynamicParameters</span>.<a href="#6fc3e642a4cf1972" class="i property">Stream</a>)
                        {
                            <span class="c">// See that it matches the name specified</span>
                            <a href="../engine/regex.cs.html#d450e739ff28e660" class="t t">WildcardPattern</a> <span id="r116 rd" class="r116 r">p</span> = <a href="../engine/regex.cs.html#d450e739ff28e660" class="t t">WildcardPattern</a>.<a href="../engine/regex.cs.html#03cc3ceece086129" class="i method">Get</a>(<span class="r115 r">desiredStream</span>, <a href="../engine/regex.cs.html#4e788ab2470b3632" class="t t">WildcardOptions</a>.<a href="../engine/regex.cs.html#2d0521a6986208d3" class="i field">IgnoreCase</a> | <a href="../engine/regex.cs.html#4e788ab2470b3632" class="t t">WildcardOptions</a>.<a href="../engine/regex.cs.html#c83c96a47a1cc99d" class="i field">CultureInvariant</a>);
                            <b>bool</b> <span id="r117 rd" class="r117 r">foundStream</span> = <b>false</b>;
 
                            <b>foreach</b> (<a href="#bed6b027cd443111" class="t t">AlternateStreamData</a> <span id="r118 rd" class="r118 r">stream</span> <b>in</b> <a href="#28276e8c322107d7" class="t t">AlternateDataStreamUtilities</a>.<span class="i">GetStreams</span>(<span class="r114 r">result</span>.<span class="i">FullName</span>))
                            {
                                <b>if</b> (!<span class="r116 r">p</span>.<a href="../engine/regex.cs.html#02e7d1c913f3c256" class="i method">IsMatch</a>(<span class="r118 r">stream</span>.<a href="#74a4aa230d954592" class="i property">Stream</a>))
                                {
                                    <b>continue</b>;
                                }
 
                                <b>string</b> <span id="r119 rd" class="r119 r">outputPath</span> = <span class="r114 r">result</span>.<span class="i">FullName</span> + <span class="s">&quot;:&quot;</span> + <span class="r118 r">stream</span>.<a href="#74a4aa230d954592" class="i property">Stream</a>;
                                <span class="c">// Alternate data streams can never be containers.</span>
                                <a href="ProviderBase.cs.html#ed0f1f879dd50c77" class="i method">WriteItemObject</a>(<span class="r118 r">stream</span>, <span class="r119 r">outputPath</span>, <span class="r120 r">isContainer</span>: <b>false</b>);
                                <span class="r117 r">foundStream</span> = <b>true</b>;
                            }
 
                            <b>if</b> ((!<a href="../engine/regex.cs.html#d450e739ff28e660" class="t t">WildcardPattern</a>.<a href="../engine/regex.cs.html#f9cf207fdd565080" class="i method">ContainsWildcardCharacters</a>(<span class="r115 r">desiredStream</span>)) &amp;&amp; (!<span class="r117 r">foundStream</span>))
                            {
                                <b>string</b> <span id="r121 rd" class="r121 r">errorMessage</span> = <a href="../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(
                                    <span class="i">FileSystemProviderStrings</span>.<span class="i">AlternateDataStreamNotFound</span>, <span class="r115 r">desiredStream</span>, <span class="r114 r">result</span>.<span class="i">FullName</span>);
                                <span class="i">Exception</span> <span id="r122 rd" class="r122 r">e</span> = <b>new</b> <span class="i">FileNotFoundException</span>(<span class="r121 r">errorMessage</span>, <span class="r114 r">result</span>.<span class="i">FullName</span>);
 
                                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <a href="../engine/ErrorPackage.cs.html#e9334565e5136f43" class="t constructor">ErrorRecord</a>(
                                    <span class="r122 r">e</span>,
                                    <span class="s">&quot;AlternateDataStreamNotFound&quot;</span>,
                                    <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#9a72a7d3051ac7c5" class="i field">ObjectNotFound</a>,
                                    <span class="r107 r">path</span>));
                            }
                        }
                    }
                    <b>else</b>
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
                    {
                        <span class="c">// Otherwise, return the item itself.</span>
                        <span class="i">WriteItemObject</span>(<span class="r114 r">result</span>, <span class="r114 r">result</span>.<span class="i">FullName</span>, <span class="r108 r">isContainer</span>);
                    }
                }
                <b>else</b>
                {
                    <b>string</b> <span id="r123 rd" class="r123 r">error</span> = <a href="../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">FileSystemProviderStrings</span>.<span class="i">ItemNotFound</span>, <span class="r107 r">path</span>);
                    <span class="i">Exception</span> <span id="r124 rd" class="r124 r">e</span> = <b>new</b> <span class="i">IOException</span>(<span class="r123 r">error</span>);
                    <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <a href="../engine/ErrorPackage.cs.html#e9334565e5136f43" class="t constructor">ErrorRecord</a>(
                        <span class="r124 r">e</span>,
                        <span class="s">&quot;ItemNotFound&quot;</span>,
                        <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#9a72a7d3051ac7c5" class="i field">ObjectNotFound</a>,
                        <span class="r107 r">path</span>));
                }
            }
            <b>catch</b> (<span class="i">IOException</span> <span id="r125 rd" class="r125 r">ioError</span>)
            {
                <span class="c">// IOException contains specific message about the error occurred and so no need for errordetails.</span>
                <a href="../engine/ErrorPackage.cs.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r126 rd" class="r126 r">er</span> = <b>new</b> <span class="t">ErrorRecord</span>(<span class="r125 r">ioError</span>, <span class="s">&quot;GetItemIOError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#cad1e0e3e13dc1f3" class="i field">ReadError</a>, <span class="r107 r">path</span>);
                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<span class="r126 r">er</span>);
            }
            <b>catch</b> (<span class="i">UnauthorizedAccessException</span> <span id="r127 rd" class="r127 r">accessException</span>)
            {
                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r127 r">accessException</span>, <span class="s">&quot;GetItemUnauthorizedAccessError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#26ba13af79d30a75" class="i field">PermissionDenied</a>, <span class="r107 r">path</span>));
            }
        }
 
        <b>private</b> <span class="i">FileSystemInfo</span> <a id="0ee3f4e33785948c" href="../R/0ee3f4e33785948c.html" target="n" data-glyph="76,1" class="i method">GetFileSystemItem</a>(<b>string</b> <span id="r128 rd" class="r128 r">path</span>, <b>ref bool</b> <span id="r129 rd" class="r129 r">isContainer</span>, <b>bool</b> <span id="r130 rd" class="r130 r">showHidden</span>)
        {
            <span class="r128 r">path</span> = <a href="#2679b47e3c6ebedc" class="i method">NormalizePath</a>(<span class="r128 r">path</span>);
            <span class="i">FileInfo</span> <span id="r131 rd" class="r131 r">result</span> = <b>new</b> <span class="i">FileInfo</span>(<span class="r128 r">path</span>);
 
            <span class="c">// FileInfo.Exists is always false for a directory path, so we check the attribute for existence.</span>
            <b>var</b> <span id="r132 rd" class="r132 r">attributes</span> = <span class="r131 r">result</span>.<span class="i">Attributes</span>;
            <b>if</b> ((<b>int</b>)<span class="r132 r">attributes</span> == -1) { <span class="c">/* Path doesn&#39;t exist. */</span> <b>return</b> <b>null</b>; }
 
            <b>bool</b> <span id="r133 rd" class="r133 r">hidden</span> = <span class="r132 r">attributes</span>.<span class="i">HasFlag</span>(<span class="i">FileAttributes</span>.<span class="i">Hidden</span>);
            <span class="r129 r">isContainer</span> = <span class="r132 r">attributes</span>.<span class="i">HasFlag</span>(<span class="i">FileAttributes</span>.<span class="i">Directory</span>);
 
            <a href="../engine/EnumExpressionEvaluator.cs.html#596ee50bb25acc45" class="t t">FlagsExpression</a>&lt;<span class="i">FileAttributes</span>&gt; <span id="r134 rd" class="r134 r">evaluator</span> = <b>null</b>;
            <a href="../engine/EnumExpressionEvaluator.cs.html#596ee50bb25acc45" class="t t">FlagsExpression</a>&lt;<span class="i">FileAttributes</span>&gt; <span id="r135 rd" class="r135 r">switchEvaluator</span> = <b>null</b>;
            <a href="#5d2564feefe2a3d0" class="t t">GetChildDynamicParameters</a> <span id="r136 rd" class="r136 r">fspDynamicParam</span> = <a href="ProviderBase.cs.html#57d60aa2d2bc908d" class="i property">DynamicParameters</a> <b>as</b> <a href="#5d2564feefe2a3d0" class="t t">GetChildDynamicParameters</a>;
            <b>if</b> (<span class="r136 r">fspDynamicParam</span> != <b>null</b>)
            {
                <span class="r134 r">evaluator</span> = <span class="r136 r">fspDynamicParam</span>.<a href="#9b94c5e245d1e7bf" class="i property">Attributes</a>;
                <span class="r135 r">switchEvaluator</span> = <a href="#117df236a3008681" class="i method">FormatAttributeSwitchParameters</a>();
            }
 
            <b>bool</b> <span id="r137 rd" class="r137 r">filterHidden</span> = <b>false</b>;           <span class="c">// &quot;Hidden&quot; is specified somewhere in the expression</span>
            <b>bool</b> <span id="r138 rd" class="r138 r">switchFilterHidden</span> = <b>false</b>;     <span class="c">// &quot;Hidden&quot; is specified somewhere in the parameters</span>
 
            <b>if</b> (<span class="r134 r">evaluator</span> != <b>null</b>)
            {
                <span class="r137 r">filterHidden</span> = <span class="r134 r">evaluator</span>.<span class="i">ExistsInExpression</span>(<span class="i">FileAttributes</span>.<span class="i">Hidden</span>);
            }
 
            <b>if</b> (<span class="r135 r">switchEvaluator</span> != <b>null</b>)
            {
                <span class="r138 r">switchFilterHidden</span> = <span class="r135 r">switchEvaluator</span>.<span class="i">ExistsInExpression</span>(<span class="i">FileAttributes</span>.<span class="i">Hidden</span>);
            }
 
            <span class="c">// if &quot;Hidden&quot; is specified in the attribute filter dynamic parameters</span>
            <span class="c">// also return the object</span>
            <b>if</b> (!<span class="r129 r">isContainer</span>)
            {
                <b>if</b> (!<span class="r133 r">hidden</span> || <a href="ProviderBase.cs.html#e3c4d51f13fbfcaa" class="i property">Force</a> || <span class="r130 r">showHidden</span> || <span class="r137 r">filterHidden</span> || <span class="r138 r">switchFilterHidden</span>)
                {
                    <a href="#3b3990865d6b9e3a" class="i field">s_tracer</a>.<span class="i">WriteLine</span>(<span class="s">&quot;Got file info: {0}&quot;</span>, <span class="r131 r">result</span>);
                    <b>return</b> <span class="r131 r">result</span>;
                }
            }
            <b>else</b>
            {
                <span class="c">// Check to see if the path is the root of a file system drive.</span>
                <span class="c">// Since all root paths are hidden we need to show the directory</span>
                <span class="c">// anyway</span>
                <b>bool</b> <span id="r139 rd" class="r139 r">isRootPath</span> =
                    <b>string</b>.<span class="i">Equals</span>(
                        <span class="i">Path</span>.<span class="i">GetPathRoot</span>(<span class="r128 r">path</span>),
                        <span class="r131 r">result</span>.<span class="i">FullName</span>,
                        <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>);
 
                <span class="c">// if &quot;Hidden&quot; is specified in the attribute filter dynamic parameters</span>
                <span class="c">// also return the object</span>
                <b>if</b> (<span class="r139 r">isRootPath</span> || !<span class="r133 r">hidden</span> || <a href="ProviderBase.cs.html#e3c4d51f13fbfcaa" class="i property">Force</a> || <span class="r130 r">showHidden</span> || <span class="r137 r">filterHidden</span> || <span class="r138 r">switchFilterHidden</span>)
                {
                    <a href="#3b3990865d6b9e3a" class="i field">s_tracer</a>.<span class="i">WriteLine</span>(<span class="s">&quot;Got directory info: {0}&quot;</span>, <span class="r131 r">result</span>);
                    <b>return</b> <b>new</b> <span class="i">DirectoryInfo</span>(<span class="r128 r">path</span>);
                }
            }
 
            <b>return</b> <b>null</b>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Invokes the item at the path using ShellExecute semantics.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r140 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The item to invoke.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">System</span>.<span class="i">ArgumentException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">     path is null or empty.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>protected override void</b> <a id="578e1264bac1e835" href="../R/578e1264bac1e835.html" target="n" data-glyph="75,1" class="i method">InvokeDefaultAction</a>(<b>string</b> <span id="r140 rd" class="r140 r">path</span>)
        {
            <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r140 r">path</span>))
            {
                <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../utils/MshTraceSource.cs.html#fed5f40dc0075d41" class="i method">NewArgumentException</a>(<b>nameof</b>(<span class="r140 r">path</span>));
            }
 
            <span class="r140 r">path</span> = <a href="#2679b47e3c6ebedc" class="i method">NormalizePath</a>(<span class="r140 r">path</span>);
 
            <b>string</b> <span id="r141 rd" class="r141 r">action</span> = <span class="i">FileSystemProviderStrings</span>.<span class="i">InvokeItemAction</span>;
 
            <b>string</b> <span id="r142 rd" class="r142 r">resource</span> = <a href="../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">FileSystemProviderStrings</span>.<span class="i">InvokeItemResourceFileTemplate</span>, <span class="r140 r">path</span>);
 
            <b>if</b> (<a href="ProviderBase.cs.html#4cb6a9cf0567d153" class="i method">ShouldProcess</a>(<span class="r142 r">resource</span>, <span class="r141 r">action</span>))
            {
                <b>var</b> <span id="r143 rd" class="r143 r">invokeProcess</span> = <b>new</b> <span class="i n">System</span>.<span class="i n">Diagnostics</span>.<span class="i">Process</span>();
                <span class="r143 r">invokeProcess</span>.<span class="i">StartInfo</span>.<span class="i">FileName</span> = <span class="r140 r">path</span>;
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">UNIX</span>
<span class="e">                bool useShellExecute = false;
                if (Directory.Exists(path))
                {
                    // Path points to a directory. We have to use xdg-open/open on Linux/macOS.
                    useShellExecute = true;
                }
                else
                {
                    try
                    {
                        // Try Process.Start first. This works for executables on Win/Unix platforms
                        invokeProcess.Start();
                    }
                    catch (Win32Exception ex) when (ex.NativeErrorCode == 13)
                    {
                        // Error code 13 -- Permission denied
                        // The file is possibly not an executable. We try xdg-open/open on Linux/macOS.
                        useShellExecute = true;
                    }
                }
 
                if (useShellExecute)
                {
                    invokeProcess.StartInfo.UseShellExecute = true;
                    invokeProcess.Start();
                }
</span><span class="k preprocess">#</span><span class="k preprocess">else</span>
                <span class="c">// Use ShellExecute when it&#39;s not a headless SKU</span>
                <span class="r143 r">invokeProcess</span>.<span class="i">StartInfo</span>.<span class="i">UseShellExecute</span> = <a href="../CoreCLR/CorePsPlatform.cs.html#693813241122eb45" class="t t">Platform</a>.<a href="../CoreCLR/CorePsPlatform.cs.html#527d8835d493a8d0" class="i property">IsWindowsDesktop</a>;
                <span class="r143 r">invokeProcess</span>.<span class="i">Start</span>();
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> ItemCmdletProvider members
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> ContainerCmdletProvider members
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> GetChildItems
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the child items of a given directory.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r144 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The full path of the directory to enumerate.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r145 r">recurse</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If true, recursively enumerates the child items as well.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r146 r">depth</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Limits the depth of recursion; uint.MaxValue performs full recursion.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Nothing.  FileInfo and DirectoryInfo objects that match the filter are written to the</span>
        <span class="c">///</span><span class="c"> context&#39;s pipeline.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">System</span>.<span class="i">ArgumentException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">     path is null or empty.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>protected override void</b> <a id="a3e567466712dfe9" href="../R/a3e567466712dfe9.html" target="n" data-glyph="75,1" class="i method">GetChildItems</a>(
            <b>string</b> <span id="r144 rd" class="r144 r">path</span>,
            <b>bool</b> <span id="r145 rd" class="r145 r">recurse</span>,
            <b>uint</b> <span id="r146 rd" class="r146 r">depth</span>)
        {
            <a href="#902916bc5610b586" class="i method">GetPathItems</a>(<span class="r144 r">path</span>, <span class="r145 r">recurse</span>, <span class="r146 r">depth</span>, <b>false</b>, <a href="../engine/ChildrenCmdletProviderInterfaces.cs.html#33becc108c70a3e1" class="t t">ReturnContainers</a>.<a href="../engine/ChildrenCmdletProviderInterfaces.cs.html#b4f5c0ad509c47b2" class="i field">ReturnMatchingContainers</a>);
        }
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> GetChildItems
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> GetChildNames
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the path names for all children of the specified</span>
        <span class="c">///</span><span class="c"> directory that match the given filter.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r147 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The full path of the directory to enumerate.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r148 r">returnContainers</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Determines if all containers should be returned or only those containers that match the</span>
        <span class="c">///</span><span class="c"> filter(s).</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Nothing.  Child names are written to the context&#39;s pipeline.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">System</span>.<span class="i">ArgumentException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">     path is null or empty.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>protected override void</b> <a id="acd2e3d0892f155d" href="../R/acd2e3d0892f155d.html" target="n" data-glyph="75,1" class="i method">GetChildNames</a>(
            <b>string</b> <span id="r147 rd" class="r147 r">path</span>,
            <a href="../engine/ChildrenCmdletProviderInterfaces.cs.html#33becc108c70a3e1" class="t t">ReturnContainers</a> <span id="r148 rd" class="r148 r">returnContainers</span>)
        {
            <span class="i">GetPathItems</span>(<span class="r147 r">path</span>, <b>false</b>, <b>uint</b>.<span class="i">MaxValue</span>, <b>true</b>, <span class="r148 r">returnContainers</span>);
        }
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> GetChildNames
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets a new provider-specific path and filter (if any) that corresponds to the given</span>
        <span class="c">///</span><span class="c"> path.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r149 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The path to the item. Unlike most other provider APIs, this path is likely to</span>
        <span class="c">///</span><span class="c"> contain PowerShell wildcards.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r150 r">filter</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The provider-specific filter currently applied.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r151 r">updatedPath</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The new path to the item.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r152 r">updatedFilter</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The new filter.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> True if the path or filter were altered. False otherwise.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Makes no attempt to filter if the user has already specified a filter, or</span>
        <span class="c">///</span><span class="c"> if the path contains directory separators. Those are not supported by the</span>
        <span class="c">///</span><span class="c"> FileSystem filter.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>protected override bool</b> <a id="3180036877233832" href="../R/3180036877233832.html" target="n" data-glyph="75,1" class="i method">ConvertPath</a>(
            <b>string</b> <span id="r149 rd" class="r149 r">path</span>,
            <b>string</b> <span id="r150 rd" class="r150 r">filter</span>,
            <b>ref string</b> <span id="r151 rd" class="r151 r">updatedPath</span>,
            <b>ref string</b> <span id="r152 rd" class="r152 r">updatedFilter</span>)
        {
            <span class="c">// Don&#39;t handle full paths, paths that the user is already trying to</span>
            <span class="c">// filter, or paths they are trying to escape.</span>
            <b>if</b> ((!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r150 r">filter</span>)) ||
                (<span class="r149 r">path</span>.<span class="i">Contains</span>(<a href="../engine/SessionStateStrings.cs.html#55ee11e42c7cf459" class="t t">StringLiterals</a>.<a href="../engine/SessionStateStrings.cs.html#88fdd102fa325178" class="i field">DefaultPathSeparator</a>, <span class="i">StringComparison</span>.<span class="i">Ordinal</span>)) ||
                (<span class="r149 r">path</span>.<span class="i">Contains</span>(<a href="../engine/SessionStateStrings.cs.html#55ee11e42c7cf459" class="t t">StringLiterals</a>.<a href="../engine/SessionStateStrings.cs.html#f2548f0f61690656" class="i field">AlternatePathSeparator</a>, <span class="i">StringComparison</span>.<span class="i">Ordinal</span>)) ||
                (<span class="r149 r">path</span>.<span class="i">Contains</span>(<a href="../engine/SessionStateStrings.cs.html#55ee11e42c7cf459" class="t t">StringLiterals</a>.<a href="../engine/SessionStateStrings.cs.html#2cc15195ee4a2318" class="i field">EscapeCharacter</a>)))
            {
                <b>return</b> <b>false</b>;
            }
 
            <span class="c">// We can never actually modify the PowerShell path, as the</span>
            <span class="c">// Win32 filtering support returns items that match the short</span>
            <span class="c">// filename OR long filename.</span>
            <span class="c">//</span>
            <span class="c">// This creates tons of seemingly incorrect matches, such as:</span>
            <span class="c">//</span>
            <span class="c">// *~*:   Matches any file with a long filename</span>
            <span class="c">// *n*:   Matches all files with a long filename, but have been</span>
            <span class="c">//        mapped to a [6][~n].[3] disambiguation bucket</span>
            <span class="c">// *.abc: Matches all files that have an extension that begins</span>
            <span class="c">//        with ABC, since their extension is truncated in the</span>
            <span class="c">//        short filename</span>
            <span class="c">// *.*:   Matches all files and directories, even if they don&#39;t</span>
            <span class="c">//        have a dot in their name</span>
 
            <span class="c">// Our algorithm here is pretty simple. The filesystem can handle</span>
            <span class="c">// * and ? in PowerShell wildcards, just not character ranges [a-z].</span>
            <span class="c">// We replace character ranges with the single-character wildcard, &#39;?&#39;.</span>
            <span class="r151 r">updatedPath</span> = <span class="r149 r">path</span>;
            <span class="r152 r">updatedFilter</span> = <span class="i n">System</span>.<span class="i">Text</span>.<span class="i">RegularExpressions</span>.<span class="i">Regex</span>.<span class="i">Replace</span>(<span class="r149 r">path</span>, <span class="s">&quot;\\[.*?\\]&quot;</span>, <span class="s">&quot;?&quot;</span>);
 
            <b>return</b> <b>true</b>;
        }
 
        <b>private void</b> <a id="902916bc5610b586" href="../R/902916bc5610b586.html" target="n" data-glyph="76,1" class="i method">GetPathItems</a>(
            <b>string</b> <span id="r153 rd" class="r153 r">path</span>,
            <b>bool</b> <span id="r154 rd" class="r154 r">recurse</span>,
            <b>uint</b> <span id="r155 rd" class="r155 r">depth</span>,
            <b>bool</b> <span id="r156 rd" class="r156 r">nameOnly</span>,
            <a href="../engine/ChildrenCmdletProviderInterfaces.cs.html#33becc108c70a3e1" class="t t">ReturnContainers</a> <span id="r157 rd" class="r157 r">returnContainers</span>)
        {
            <span class="c">// Verify parameters</span>
            <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r153 r">path</span>))
            {
                <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../utils/MshTraceSource.cs.html#fed5f40dc0075d41" class="i method">NewArgumentException</a>(<b>nameof</b>(<span class="r153 r">path</span>));
            }
 
            <span class="r153 r">path</span> = <a href="#2679b47e3c6ebedc" class="i method">NormalizePath</a>(<span class="r153 r">path</span>);
 
            <b>var</b> <span id="r158 rd" class="r158 r">fsinfo</span> = <a href="#03417d6757ea1d51" class="i method">GetFileSystemInfo</a>(<span class="r153 r">path</span>, <b>out bool</b> <span id="r159 rd" class="r159 r">isDirectory</span>);
 
            <b>if</b> (<span class="r158 r">fsinfo</span> != <b>null</b>)
            {
                <b>if</b> (<span class="r159 r">isDirectory</span>)
                {
                    <a href="#cee9878fea124fe4" class="t t">InodeTracker</a> <span id="r160 rd" class="r160 r">tracker</span> = <b>null</b>;
 
                    <b>if</b> (<span class="r154 r">recurse</span>)
                    {
                        <a href="#5d2564feefe2a3d0" class="t t">GetChildDynamicParameters</a> <span id="r161 rd" class="r161 r">fspDynamicParam</span> = <a href="ProviderBase.cs.html#57d60aa2d2bc908d" class="i property">DynamicParameters</a> <b>as</b> <a href="#5d2564feefe2a3d0" class="t t">GetChildDynamicParameters</a>;
                        <b>if</b> (<span class="r161 r">fspDynamicParam</span> != <b>null</b> &amp;&amp; <span class="r161 r">fspDynamicParam</span>.<a href="#589bd8d055ba636d" class="i property">FollowSymlink</a>)
                        {
                            <span class="r160 r">tracker</span> = <b>new</b> <span class="t">InodeTracker</span>(<span class="r158 r">fsinfo</span>.<span class="i">FullName</span>);
                        }
                    }
 
                    <span class="c">// Enumerate the directory</span>
                    <a href="#c43e2d2b04f55c4b" class="i method">Dir</a>((<span class="i">DirectoryInfo</span>)<span class="r158 r">fsinfo</span>, <span class="r154 r">recurse</span>, <span class="r155 r">depth</span>, <span class="r156 r">nameOnly</span>, <span class="r157 r">returnContainers</span>, <span class="r160 r">tracker</span>);
                }
                <b>else</b>
                {
                    <a href="../engine/EnumExpressionEvaluator.cs.html#596ee50bb25acc45" class="t t">FlagsExpression</a>&lt;<span class="i">FileAttributes</span>&gt; <span id="r162 rd" class="r162 r">evaluator</span> = <b>null</b>;
                    <a href="../engine/EnumExpressionEvaluator.cs.html#596ee50bb25acc45" class="t t">FlagsExpression</a>&lt;<span class="i">FileAttributes</span>&gt; <span id="r163 rd" class="r163 r">switchEvaluator</span> = <b>null</b>;
                    <a href="#5d2564feefe2a3d0" class="t t">GetChildDynamicParameters</a> <span id="r164 rd" class="r164 r">fspDynamicParam</span> = <a href="ProviderBase.cs.html#57d60aa2d2bc908d" class="i property">DynamicParameters</a> <b>as</b> <a href="#5d2564feefe2a3d0" class="t t">GetChildDynamicParameters</a>;
                    <b>if</b> (<span class="r164 r">fspDynamicParam</span> != <b>null</b>)
                    {
                        <span class="r162 r">evaluator</span> = <span class="r164 r">fspDynamicParam</span>.<a href="#9b94c5e245d1e7bf" class="i property">Attributes</a>;
                        <span class="r163 r">switchEvaluator</span> = <a href="#117df236a3008681" class="i method">FormatAttributeSwitchParameters</a>();
                    }
 
                    <b>bool</b> <span id="r165 rd" class="r165 r">attributeFilter</span> = <b>true</b>;
                    <b>bool</b> <span id="r166 rd" class="r166 r">switchAttributeFilter</span> = <b>true</b>;
                    <b>bool</b> <span id="r167 rd" class="r167 r">filterHidden</span> = <b>false</b>;           <span class="c">// &quot;Hidden&quot; is specified somewhere in the expression</span>
                    <b>bool</b> <span id="r168 rd" class="r168 r">switchFilterHidden</span> = <b>false</b>;     <span class="c">// &quot;Hidden&quot; is specified somewhere in the parameters</span>
 
                    <b>if</b> (<span class="r162 r">evaluator</span> != <b>null</b>)
                    {
                        <span class="r165 r">attributeFilter</span> = <span class="r162 r">evaluator</span>.<span class="i">Evaluate</span>(<span class="r158 r">fsinfo</span>.<span class="i">Attributes</span>);  <span class="c">// expressions</span>
                        <span class="r167 r">filterHidden</span> = <span class="r162 r">evaluator</span>.<span class="i">ExistsInExpression</span>(<span class="i">FileAttributes</span>.<span class="i">Hidden</span>);
                    }
 
                    <b>if</b> (<span class="r163 r">switchEvaluator</span> != <b>null</b>)
                    {
                        <span class="r166 r">switchAttributeFilter</span> = <span class="r163 r">switchEvaluator</span>.<span class="i">Evaluate</span>(<span class="r158 r">fsinfo</span>.<span class="i">Attributes</span>);  <span class="c">// switch parameters</span>
                        <span class="r168 r">switchFilterHidden</span> = <span class="r163 r">switchEvaluator</span>.<span class="i">ExistsInExpression</span>(<span class="i">FileAttributes</span>.<span class="i">Hidden</span>);
                    }
 
                    <b>bool</b> <span id="r169 rd" class="r169 r">hidden</span> = (<span class="r158 r">fsinfo</span>.<span class="i">Attributes</span> &amp; <span class="i">FileAttributes</span>.<span class="i">Hidden</span>) != 0;
 
                    <span class="c">// if &quot;Hidden&quot; is explicitly specified anywhere in the attribute filter, then override</span>
                    <span class="c">// default hidden attribute filter.</span>
                    <b>if</b> ((<span class="r165 r">attributeFilter</span> &amp;&amp; <span class="r166 r">switchAttributeFilter</span>)
                        &amp;&amp; (<span class="r167 r">filterHidden</span> || <span class="r168 r">switchFilterHidden</span> || <a href="ProviderBase.cs.html#e3c4d51f13fbfcaa" class="i property">Force</a> || !<span class="r169 r">hidden</span>))
                    {
                        <b>if</b> (<span class="r156 r">nameOnly</span>)
                        {
                            <span class="i">WriteItemObject</span>(
                                <span class="r158 r">fsinfo</span>.<span class="i">Name</span>,
                                <span class="r158 r">fsinfo</span>.<span class="i">FullName</span>,
                                <b>false</b>);
                        }
                        <b>else</b>
                        {
                            <span class="i">WriteItemObject</span>(<span class="r158 r">fsinfo</span>, <span class="r153 r">path</span>, <b>false</b>);
                        }
                    }
                }
            }
            <b>else</b>
            {
                <b>string</b> <span id="r170 rd" class="r170 r">error</span> = <a href="../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">FileSystemProviderStrings</span>.<span class="i">ItemDoesNotExist</span>, <span class="r153 r">path</span>);
                <span class="i">Exception</span> <span id="r171 rd" class="r171 r">e</span> = <b>new</b> <span class="i">IOException</span>(<span class="r170 r">error</span>);
                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <a href="../engine/ErrorPackage.cs.html#e9334565e5136f43" class="t constructor">ErrorRecord</a>(
                    <span class="r171 r">e</span>,
                    <span class="s">&quot;ItemDoesNotExist&quot;</span>,
                    <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#9a72a7d3051ac7c5" class="i field">ObjectNotFound</a>,
                    <span class="r153 r">path</span>));
                <b>return</b>;
            }
        }
 
        <b>private void</b> <a id="c43e2d2b04f55c4b" href="../R/c43e2d2b04f55c4b.html" target="n" data-glyph="76,1" class="i method">Dir</a>(
            <span class="i">DirectoryInfo</span> <span id="r172 rd" class="r172 r">directory</span>,
            <b>bool</b> <span id="r173 rd" class="r173 r">recurse</span>,
            <b>uint</b> <span id="r174 rd" class="r174 r">depth</span>,
            <b>bool</b> <span id="r175 rd" class="r175 r">nameOnly</span>,
            <a href="../engine/ChildrenCmdletProviderInterfaces.cs.html#33becc108c70a3e1" class="t t">ReturnContainers</a> <span id="r176 rd" class="r176 r">returnContainers</span>,
            <a href="#cee9878fea124fe4" class="t t">InodeTracker</a> <span id="r177 rd" class="r177 r">tracker</span>)   <span class="c">// tracker will be non-null only if the user invoked the -FollowSymLinks and -Recurse switch parameters.</span>
        {
            <span class="i">List</span>&lt;<span class="i">IEnumerable</span>&lt;<span class="i">FileSystemInfo</span>&gt;&gt; <span id="r178 rd" class="r178 r">target</span> = <b>new</b> <span class="i">List</span>&lt;<span class="i">IEnumerable</span>&lt;<span class="i">FileSystemInfo</span>&gt;&gt;();
 
            <b>try</b>
            {
                <b>if</b> (<a href="ProviderBase.cs.html#ef76826218eaf5e1" class="i property">Filter</a> != <b>null</b> &amp;&amp;
                    <a href="ProviderBase.cs.html#ef76826218eaf5e1" class="i property">Filter</a>.<span class="i">Length</span> &gt; 0)
                {
                    <b>if</b> (<span class="r176 r">returnContainers</span> == <a href="../engine/ChildrenCmdletProviderInterfaces.cs.html#33becc108c70a3e1" class="t t">ReturnContainers</a>.<a href="../engine/ChildrenCmdletProviderInterfaces.cs.html#1b66c2d2e8f051dd" class="i field">ReturnAllContainers</a>)
                    {
                        <span class="c">// Don&#39;t filter directories</span>
                        <span class="r178 r">target</span>.<span class="i">Add</span>(<span class="r172 r">directory</span>.<span class="i">EnumerateDirectories</span>());
                    }
                    <b>else</b>
                    {
                        <span class="c">// Filter the directories</span>
                        <span class="r178 r">target</span>.<span class="i">Add</span>(<span class="r172 r">directory</span>.<span class="i">EnumerateDirectories</span>(<a href="ProviderBase.cs.html#ef76826218eaf5e1" class="i property">Filter</a>, <a href="#c212b0b5c9beb587" class="i field">_enumerationOptions</a>));
                    }
 
                    <span class="c">// Making sure to obey the StopProcessing.</span>
                    <b>if</b> (<a href="ProviderBase.cs.html#7f198513b75d23b5" class="i property">Stopping</a>)
                    {
                        <b>return</b>;
                    }
 
                    <span class="c">// Use the specified filter when retrieving the</span>
                    <span class="c">// children</span>
                    <span class="r178 r">target</span>.<span class="i">Add</span>(<span class="r172 r">directory</span>.<span class="i">EnumerateFiles</span>(<a href="ProviderBase.cs.html#ef76826218eaf5e1" class="i property">Filter</a>, <a href="#c212b0b5c9beb587" class="i field">_enumerationOptions</a>));
                }
                <b>else</b>
                {
                    <span class="r178 r">target</span>.<span class="i">Add</span>(<span class="r172 r">directory</span>.<span class="i">EnumerateDirectories</span>());
 
                    <span class="c">// Making sure to obey the StopProcessing.</span>
                    <b>if</b> (<a href="ProviderBase.cs.html#7f198513b75d23b5" class="i property">Stopping</a>)
                    {
                        <b>return</b>;
                    }
 
                    <span class="c">// Don&#39;t use a filter to retrieve the children</span>
                    <span class="r178 r">target</span>.<span class="i">Add</span>(<span class="r172 r">directory</span>.<span class="i">EnumerateFiles</span>());
                }
 
                <a href="../engine/EnumExpressionEvaluator.cs.html#596ee50bb25acc45" class="t t">FlagsExpression</a>&lt;<span class="i">FileAttributes</span>&gt; <span id="r179 rd" class="r179 r">evaluator</span> = <b>null</b>;
                <a href="../engine/EnumExpressionEvaluator.cs.html#596ee50bb25acc45" class="t t">FlagsExpression</a>&lt;<span class="i">FileAttributes</span>&gt; <span id="r180 rd" class="r180 r">switchEvaluator</span> = <b>null</b>;
 
                <a href="#5d2564feefe2a3d0" class="t t">GetChildDynamicParameters</a> <span id="r181 rd" class="r181 r">fspDynamicParam</span> = <a href="ProviderBase.cs.html#57d60aa2d2bc908d" class="i property">DynamicParameters</a> <b>as</b> <a href="#5d2564feefe2a3d0" class="t t">GetChildDynamicParameters</a>;
                <b>if</b> (<span class="r181 r">fspDynamicParam</span> != <b>null</b>)
                {
                    <span class="r179 r">evaluator</span> = <span class="r181 r">fspDynamicParam</span>.<a href="#9b94c5e245d1e7bf" class="i property">Attributes</a>;
                    <span class="r180 r">switchEvaluator</span> = <a href="#117df236a3008681" class="i method">FormatAttributeSwitchParameters</a>();
                }
 
                <span class="c">// Write out the items</span>
                <b>foreach</b> (<span class="i">IEnumerable</span>&lt;<span class="i">FileSystemInfo</span>&gt; <span id="r182 rd" class="r182 r">childList</span> <b>in</b> <span class="r178 r">target</span>)
                {
                    <span class="c">// On some systems, this is already sorted.  For consistency, always sort again.</span>
                    <span class="i">IEnumerable</span>&lt;<span class="i">FileSystemInfo</span>&gt; <span id="r183 rd" class="r183 r">sortedChildList</span> = <span class="r182 r">childList</span>.<span class="i">OrderBy</span>(<b>static</b> <span id="r184 rd" class="r184 r">c</span> =&gt; <span class="r184 r">c</span>.<span class="i">Name</span>, <span class="i">StringComparer</span>.<span class="i">CurrentCultureIgnoreCase</span>);
 
                    <b>foreach</b> (<span class="i">FileSystemInfo</span> <span id="r185 rd" class="r185 r">filesystemInfo</span> <b>in</b> <span class="r183 r">sortedChildList</span>)
                    {
                        <span class="c">// Making sure to obey the StopProcessing.</span>
                        <b>if</b> (<a href="ProviderBase.cs.html#7f198513b75d23b5" class="i property">Stopping</a>)
                        {
                            <b>return</b>;
                        }
 
                        <b>try</b>
                        {
                            <b>bool</b> <span id="r186 rd" class="r186 r">attributeFilter</span> = <b>true</b>;
                            <b>bool</b> <span id="r187 rd" class="r187 r">switchAttributeFilter</span> = <b>true</b>;
                            <span class="c">// &#39;Hidden&#39; is specified somewhere in the expression</span>
                            <b>bool</b> <span id="r188 rd" class="r188 r">filterHidden</span> = <b>false</b>;
                            <span class="c">// &#39;Hidden&#39; is specified somewhere in the parameters</span>
                            <b>bool</b> <span id="r189 rd" class="r189 r">switchFilterHidden</span> = <b>false</b>;
 
                            <b>if</b> (<span class="r179 r">evaluator</span> != <b>null</b>)
                            {
                                <span class="r186 r">attributeFilter</span> = <span class="r179 r">evaluator</span>.<span class="i">Evaluate</span>(<span class="r185 r">filesystemInfo</span>.<span class="i">Attributes</span>);
                                <span class="r188 r">filterHidden</span> = <span class="r179 r">evaluator</span>.<span class="i">ExistsInExpression</span>(<span class="i">FileAttributes</span>.<span class="i">Hidden</span>);
                            }
 
                            <b>if</b> (<span class="r180 r">switchEvaluator</span> != <b>null</b>)
                            {
                                <span class="r187 r">switchAttributeFilter</span> = <span class="r180 r">switchEvaluator</span>.<span class="i">Evaluate</span>(<span class="r185 r">filesystemInfo</span>.<span class="i">Attributes</span>);
                                <span class="r189 r">switchFilterHidden</span> = <span class="r180 r">switchEvaluator</span>.<span class="i">ExistsInExpression</span>(<span class="i">FileAttributes</span>.<span class="i">Hidden</span>);
                            }
 
                            <b>bool</b> <span id="r190 rd" class="r190 r">hidden</span> = <b>false</b>;
                            <b>if</b> (!<a href="ProviderBase.cs.html#e3c4d51f13fbfcaa" class="i property">Force</a>)
                            {
                                <span class="r190 r">hidden</span> = (<span class="r185 r">filesystemInfo</span>.<span class="i">Attributes</span> &amp; <span class="i">FileAttributes</span>.<span class="i">Hidden</span>) != 0;
                            }
 
                            <span class="c">// If &#39;Hidden&#39; is explicitly specified anywhere in the attribute filter, then override</span>
                            <span class="c">// default hidden attribute filter.</span>
                            <span class="c">// If specification is to return all containers, then do not do attribute filter on</span>
                            <span class="c">// the containers.</span>
                            <b>bool</b> <span id="r191 rd" class="r191 r">attributeSatisfy</span> =
                                ((<span class="r186 r">attributeFilter</span> &amp;&amp; <span class="r187 r">switchAttributeFilter</span>) ||
                                    ((<span class="r176 r">returnContainers</span> == <a href="../engine/ChildrenCmdletProviderInterfaces.cs.html#33becc108c70a3e1" class="t t">ReturnContainers</a>.<a href="../engine/ChildrenCmdletProviderInterfaces.cs.html#1b66c2d2e8f051dd" class="i field">ReturnAllContainers</a>) &amp;&amp;
                                    ((<span class="r185 r">filesystemInfo</span>.<span class="i">Attributes</span> &amp; <span class="i">FileAttributes</span>.<span class="i">Directory</span>) != 0)));
 
                            <b>if</b> (<span class="r191 r">attributeSatisfy</span> &amp;&amp; (<span class="r188 r">filterHidden</span> || <span class="r189 r">switchFilterHidden</span> || <a href="ProviderBase.cs.html#e3c4d51f13fbfcaa" class="i property">Force</a> || !<span class="r190 r">hidden</span>))
                            {
                                <b>if</b> (<span class="r175 r">nameOnly</span>)
                                {
                                    <span class="i">WriteItemObject</span>(
                                        <span class="r185 r">filesystemInfo</span>.<span class="i">Name</span>,
                                        <span class="r185 r">filesystemInfo</span>.<span class="i">FullName</span>,
                                        <b>false</b>);
                                }
                                <b>else</b>
                                {
                                    <b>if</b> (<span class="r185 r">filesystemInfo</span> <b>is</b> <span class="i">FileInfo</span>)
                                    {
                                        <span class="i">WriteItemObject</span>(<span class="r185 r">filesystemInfo</span>, <span class="r185 r">filesystemInfo</span>.<span class="i">FullName</span>, <b>false</b>);
                                    }
                                    <b>else</b>
                                    {
                                        <span class="i">WriteItemObject</span>(<span class="r185 r">filesystemInfo</span>, <span class="r185 r">filesystemInfo</span>.<span class="i">FullName</span>, <b>true</b>);
                                    }
                                }
                            }
                        }
                        <b>catch</b> (<span class="i n">System</span>.<span class="i">IO</span>.<span class="i">FileNotFoundException</span> <span id="r192 rd" class="r192 r">ex</span>)
                        {
                            <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r192 r">ex</span>, <span class="s">&quot;DirIOError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#cad1e0e3e13dc1f3" class="i field">ReadError</a>, <span class="r172 r">directory</span>.<span class="i">FullName</span>));
                        }
                        <b>catch</b> (<span class="i">UnauthorizedAccessException</span> <span id="r193 rd" class="r193 r">ex</span>)
                        {
                            <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r193 r">ex</span>, <span class="s">&quot;DirUnauthorizedAccessError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#26ba13af79d30a75" class="i field">PermissionDenied</a>, <span class="r172 r">directory</span>.<span class="i">FullName</span>));
                        }
                    }
                }
 
                <b>bool</b> <span id="r194 rd" class="r194 r">isFilterHiddenSpecified</span> = <b>false</b>;           <span class="c">// &quot;Hidden&quot; is specified somewhere in the expression</span>
                <b>bool</b> <span id="r195 rd" class="r195 r">isSwitchFilterHiddenSpecified</span> = <b>false</b>;     <span class="c">// &quot;Hidden&quot; is specified somewhere in the parameters</span>
 
                <b>if</b> (<span class="r179 r">evaluator</span> != <b>null</b>)
                {
                    <span class="r194 r">isFilterHiddenSpecified</span> = <span class="r179 r">evaluator</span>.<span class="i">ExistsInExpression</span>(<span class="i">FileAttributes</span>.<span class="i">Hidden</span>);
                }
 
                <b>if</b> (<span class="r180 r">switchEvaluator</span> != <b>null</b>)
                {
                    <span class="r195 r">isSwitchFilterHiddenSpecified</span> = <span class="r180 r">switchEvaluator</span>.<span class="i">ExistsInExpression</span>(<span class="i">FileAttributes</span>.<span class="i">Hidden</span>);
                }
                <span class="c">// Recurse into the directories</span>
                <span class="c">// Grab all the directories to recurse</span>
                <span class="c">// into separately from the ones that will get written</span>
                <span class="c">// out.</span>
                <b>if</b> (<span class="r173 r">recurse</span>)
                {
                    <span class="c">// Limiter for recursion</span>
                    <b>if</b> (<span class="r174 r">depth</span> &gt; 0) <span class="c">// this includes special case &#39;depth == uint.MaxValue&#39; for unlimited recursion</span>
                    {
                        <b>foreach</b> (<span class="i">DirectoryInfo</span> <span id="r196 rd" class="r196 r">recursiveDirectory</span> <b>in</b> <span class="r172 r">directory</span>.<span class="i">EnumerateDirectories</span>())
                        {
                            <span class="c">// Making sure to obey the StopProcessing.</span>
                            <b>if</b> (<a href="ProviderBase.cs.html#7f198513b75d23b5" class="i property">Stopping</a>)
                            {
                                <b>return</b>;
                            }
 
                            <b>bool</b> <span id="r197 rd" class="r197 r">hidden</span> = <b>false</b>;
                            <b>bool</b> <span id="r198 rd" class="r198 r">checkReparsePoint</span> = <b>true</b>;
                            <b>if</b> (!<a href="ProviderBase.cs.html#e3c4d51f13fbfcaa" class="i property">Force</a>)
                            {
                                <span class="r197 r">hidden</span> = (<span class="r196 r">recursiveDirectory</span>.<span class="i">Attributes</span> &amp; <span class="i">FileAttributes</span>.<span class="i">Hidden</span>) != 0;
 
                                <span class="c">// We&#39;ve already taken the expense of initializing the Attributes property here,</span>
                                <span class="c">// so we can use that to avoid needing to call IsReparsePointLikeSymlink() later.</span>
                                <span class="r198 r">checkReparsePoint</span> = <span class="r196 r">recursiveDirectory</span>.<span class="i">Attributes</span>.<span class="i">HasFlag</span>(<span class="i">FileAttributes</span>.<span class="i">ReparsePoint</span>);
                            }
 
                            <span class="c">// if &quot;Hidden&quot; is explicitly specified anywhere in the attribute filter, then override</span>
                            <span class="c">// default hidden attribute filter.</span>
                            <b>if</b> (<a href="ProviderBase.cs.html#e3c4d51f13fbfcaa" class="i property">Force</a> || !<span class="r197 r">hidden</span> || <span class="r194 r">isFilterHiddenSpecified</span> || <span class="r195 r">isSwitchFilterHiddenSpecified</span>)
                            {
                                <span class="c">// We only want to recurse into symlinks if</span>
                                <span class="c">//  a) the user has asked to with the -FollowSymLinks switch parameter and</span>
                                <span class="c">//  b) the directory pointed to by the symlink has not already been visited,</span>
                                <span class="c">//     preventing symlink loops.</span>
                                <span class="c">//  c) it is not a reparse point with a target (not OneDrive or an AppX link).</span>
                                <b>if</b> (<span class="r177 r">tracker</span> == <b>null</b>)
                                {
                                    <b>if</b> (<span class="r198 r">checkReparsePoint</span> &amp;&amp; <a href="#916c1750999d4e10" class="t t">InternalSymbolicLinkLinkCodeMethods</a>.<span class="i">IsReparsePointLikeSymlink</span>(<span class="r196 r">recursiveDirectory</span>))
                                    {
                                        <b>continue</b>;
                                    }
                                }
                                <b>else</b> <b>if</b> (!<span class="r177 r">tracker</span>.<span class="i">TryVisitPath</span>(<span class="r196 r">recursiveDirectory</span>.<span class="i">FullName</span>))
                                {
                                    <a href="ProviderBase.cs.html#622732b947e27162" class="i method">WriteWarning</a>(<a href="../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">FileSystemProviderStrings</span>.<span class="i">AlreadyListedDirectory</span>,
                                                                   <span class="r196 r">recursiveDirectory</span>.<span class="i">FullName</span>));
                                    <b>continue</b>;
                                }
 
                                <span class="i">Dir</span>(<span class="r196 r">recursiveDirectory</span>, <span class="r173 r">recurse</span>, <span class="r174 r">depth</span> - 1, <span class="r175 r">nameOnly</span>, <span class="r176 r">returnContainers</span>, <span class="r177 r">tracker</span>);
                            }
                        }
                    }
                }
            }
            <b>catch</b> (<span class="i">ArgumentException</span> <span id="r199 rd" class="r199 r">argException</span>)
            {
                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r199 r">argException</span>, <span class="s">&quot;DirArgumentError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#846d2b572f2c4820" class="i field">InvalidArgument</a>, <span class="r172 r">directory</span>.<span class="i">FullName</span>));
            }
            <b>catch</b> (<span class="i">IOException</span> <span id="r200 rd" class="r200 r">e</span>)
            {
                <span class="c">// 2004/10/13-JonN removed ResourceActionFailedException wrapper</span>
                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r200 r">e</span>, <span class="s">&quot;DirIOError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#cad1e0e3e13dc1f3" class="i field">ReadError</a>, <span class="r172 r">directory</span>.<span class="i">FullName</span>));
            }
            <b>catch</b> (<span class="i">UnauthorizedAccessException</span> <span id="r201 rd" class="r201 r">uae</span>)
            {
                <span class="c">// 2004/10/13-JonN removed ResourceActionFailedException wrapper</span>
                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r201 r">uae</span>, <span class="s">&quot;DirUnauthorizedAccessError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#26ba13af79d30a75" class="i field">PermissionDenied</a>, <span class="r172 r">directory</span>.<span class="i">FullName</span>));
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Create an enum expression evaluator for user-specified attribute filtering</span>
        <span class="c">///</span><span class="c"> switch parameters.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If any attribute filtering switch parameters are set,</span>
        <span class="c">///</span><span class="c"> returns an evaluator that evaluates these parameters.</span>
        <span class="c">///</span><span class="c"> Otherwise,</span>
        <span class="c">///</span><span class="c"> returns NULL</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>private</b> <a href="../engine/EnumExpressionEvaluator.cs.html#596ee50bb25acc45" class="t t">FlagsExpression</a>&lt;<span class="i">FileAttributes</span>&gt; <a id="117df236a3008681" href="../R/117df236a3008681.html" target="n" data-glyph="76,1" class="i method">FormatAttributeSwitchParameters</a>()
        {
            <a href="../engine/EnumExpressionEvaluator.cs.html#596ee50bb25acc45" class="t t">FlagsExpression</a>&lt;<span class="i">FileAttributes</span>&gt; <span id="r202 rd" class="r202 r">switchParamEvaluator</span> = <b>null</b>;
            <span class="i">StringBuilder</span> <span id="r203 rd" class="r203 r">sb</span> = <b>new</b> <span class="i">StringBuilder</span>();
 
            <b>if</b> (((<a href="#5d2564feefe2a3d0" class="t t">GetChildDynamicParameters</a>)<a href="ProviderBase.cs.html#57d60aa2d2bc908d" class="i property">DynamicParameters</a>).<a href="#2ca1b1c968849c67" class="i property">Directory</a>)
            {
                <span class="r203 r">sb</span>.<span class="i">Append</span>(<span class="s">&quot;+Directory&quot;</span>);
            }
 
            <b>if</b> (((<a href="#5d2564feefe2a3d0" class="t t">GetChildDynamicParameters</a>)<a href="ProviderBase.cs.html#57d60aa2d2bc908d" class="i property">DynamicParameters</a>).<a href="#0e064e4e6a94c210" class="i property">File</a>)
            {
                <span class="r203 r">sb</span>.<span class="i">Append</span>(<span class="s">&quot;+!Directory&quot;</span>);
            }
 
            <b>if</b> (((<a href="#5d2564feefe2a3d0" class="t t">GetChildDynamicParameters</a>)<a href="ProviderBase.cs.html#57d60aa2d2bc908d" class="i property">DynamicParameters</a>).<a href="#eb2215f497d83bec" class="i property">System</a>)
            {
                <span class="r203 r">sb</span>.<span class="i">Append</span>(<span class="s">&quot;+System&quot;</span>);
            }
 
            <b>if</b> (((<a href="#5d2564feefe2a3d0" class="t t">GetChildDynamicParameters</a>)<a href="ProviderBase.cs.html#57d60aa2d2bc908d" class="i property">DynamicParameters</a>).<a href="#1fe8b85002b76adf" class="i property">ReadOnly</a>)
            {
                <span class="r203 r">sb</span>.<span class="i">Append</span>(<span class="s">&quot;+ReadOnly&quot;</span>);
            }
 
            <b>if</b> (((<a href="#5d2564feefe2a3d0" class="t t">GetChildDynamicParameters</a>)<a href="ProviderBase.cs.html#57d60aa2d2bc908d" class="i property">DynamicParameters</a>).<a href="#e392319a284f39a1" class="i property">Hidden</a>)
            {
                <span class="r203 r">sb</span>.<span class="i">Append</span>(<span class="s">&quot;+Hidden&quot;</span>);
            }
 
            <b>string</b> <span id="r204 rd" class="r204 r">switchParamString</span> = <span class="r203 r">sb</span>.<span class="i">ToString</span>();
 
            <b>if</b> (!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r204 r">switchParamString</span>))
            {
                <span class="c">// Remove unnecessary PLUS sign</span>
                <span class="r202 r">switchParamEvaluator</span> = <b>new</b> <span class="t">FlagsExpression</span>&lt;<span class="i">FileAttributes</span>&gt;(<span class="r204 r">switchParamString</span>.<span class="i">Substring</span>(1));
            }
 
            <b>return</b> <span class="r202 r">switchParamEvaluator</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Provides a mode property for FileSystemInfo.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r205 r">instance</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Instance of PSObject wrapping a FileSystemInfo.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">A string representation of the FileAttributes, with one letter per attribute.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        [<span class="i n">System</span>.<span class="i n">Diagnostics</span>.<span class="i">CodeAnalysis</span>.<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Reliability&quot;</span>, <span class="s">&quot;CA2001:AvoidCallingProblematicMethods&quot;</span>)]
        <b>public static string</b> <a id="10d3029c58e648db" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">Mode</a>(<a href="../engine/MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r205 rd" class="r205 r">instance</span>) =&gt; <a href="#6b69c6cb1b5f8c81" class="i method">Mode</a>(<span class="r205 r">instance</span>, <span class="r206 r">excludeHardLink</span>: <b>false</b>);
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Provides a ModeWithoutHardLink property for FileSystemInfo, without HardLinks for performance reasons.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r207 r">instance</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Instance of PSObject wrapping a FileSystemInfo.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">A string representation of the FileAttributes, with one letter per attribute.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        [<span class="i n">System</span>.<span class="i n">Diagnostics</span>.<span class="i">CodeAnalysis</span>.<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Reliability&quot;</span>, <span class="s">&quot;CA2001:AvoidCallingProblematicMethods&quot;</span>)]
        <b>public static string</b> <a id="971432acca56fde8" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">ModeWithoutHardLink</a>(<a href="../engine/MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r207 rd" class="r207 r">instance</span>) =&gt; <a href="#6b69c6cb1b5f8c81" class="i method">Mode</a>(<span class="r207 r">instance</span>, <span class="r206 r">excludeHardLink</span>: <b>true</b>);
 
        <b>private static string</b> <a id="6b69c6cb1b5f8c81" href="../R/6b69c6cb1b5f8c81.html" target="n" data-glyph="76,1" class="i method">Mode</a>(<a href="../engine/MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r208 rd" class="r208 r">instance</span>, <b>bool</b> <span id="r206 rd" class="r206 r">excludeHardLink</span>)
        {
            <b>string</b> <a id="448f6291b74e3347" href="../R/448f6291b74e3347.html" target="n" data-glyph="76,2" class="i method">ToModeString</a>(<span class="i">FileSystemInfo</span> <span id="r209 rd" class="r209 r">fileSystemInfo</span>)
            {
                <span class="i">FileAttributes</span> <span id="r210 rd" class="r210 r">fileAttributes</span> = <span class="r209 r">fileSystemInfo</span>.<span class="i">Attributes</span>;
 
                <b>bool</b> <span id="r211 rd" class="r211 r">isReparsePoint</span> = <a href="#916c1750999d4e10" class="t t">InternalSymbolicLinkLinkCodeMethods</a>.<a href="#7caa2744ba84db20" class="i method">IsReparsePoint</a>(<span class="r209 r">fileSystemInfo</span>);
                <b>bool</b> <span id="r212 rd" class="r212 r">isLink</span> = <span class="r211 r">isReparsePoint</span> || (!<span class="r206 r">excludeHardLink</span> &amp;&amp; <a href="#916c1750999d4e10" class="t t">InternalSymbolicLinkLinkCodeMethods</a>.<a href="#df7ccd99bcbb2071" class="i method">IsHardLink</a>(<span class="r209 r">fileSystemInfo</span>));
                <b>if</b> (!<span class="r212 r">isLink</span>)
                {
                    <span class="c">// special casing for the common cases - no allocations</span>
                    <b>switch</b> (<span class="r210 r">fileAttributes</span>)
                    {
                        <b>case</b> <span class="i">FileAttributes</span>.<span class="i">Archive</span>:
                            <b>return</b> <span class="s">&quot;-a---&quot;</span>;
                        <b>case</b> <span class="i">FileAttributes</span>.<span class="i">Directory</span>:
                            <b>return</b> <span class="s">&quot;d----&quot;</span>;
                        <b>case</b> <span class="i">FileAttributes</span>.<span class="i">Normal</span>:
                            <b>return</b> <span class="s">&quot;-----&quot;</span>;
                        <b>case</b> <span class="i">FileAttributes</span>.<span class="i">Directory</span> | <span class="i">FileAttributes</span>.<span class="i">ReadOnly</span>:
                            <b>return</b> <span class="s">&quot;d-r--&quot;</span>;
                        <b>case</b> <span class="i">FileAttributes</span>.<span class="i">Archive</span> | <span class="i">FileAttributes</span>.<span class="i">ReadOnly</span>:
                            <b>return</b> <span class="s">&quot;-ar--&quot;</span>;
                    }
                }
 
                <b>bool</b> <span id="r213 rd" class="r213 r">isDirectory</span> = <span class="r210 r">fileAttributes</span>.<span class="i">HasFlag</span>(<span class="i">FileAttributes</span>.<span class="i">Directory</span>);
                <span class="i">ReadOnlySpan</span>&lt;<b>char</b>&gt; <span id="r214 rd" class="r214 r">mode</span> = <b>stackalloc char</b>[]
                {
                    <span class="r212 r">isLink</span> ? <span class="s">&#39;l&#39;</span> : <span class="r213 r">isDirectory</span> ? <span class="s">&#39;d&#39;</span> : <span class="s">&#39;-&#39;</span>,
                    <span class="r210 r">fileAttributes</span>.<span class="i">HasFlag</span>(<span class="i">FileAttributes</span>.<span class="i">Archive</span>) ? <span class="s">&#39;a&#39;</span> : <span class="s">&#39;-&#39;</span>,
                    <span class="r210 r">fileAttributes</span>.<span class="i">HasFlag</span>(<span class="i">FileAttributes</span>.<span class="i">ReadOnly</span>) ? <span class="s">&#39;r&#39;</span> : <span class="s">&#39;-&#39;</span>,
                    <span class="r210 r">fileAttributes</span>.<span class="i">HasFlag</span>(<span class="i">FileAttributes</span>.<span class="i">Hidden</span>) ? <span class="s">&#39;h&#39;</span> : <span class="s">&#39;-&#39;</span>,
                    <span class="r210 r">fileAttributes</span>.<span class="i">HasFlag</span>(<span class="i">FileAttributes</span>.<span class="i">System</span>) ? <span class="s">&#39;s&#39;</span> : <span class="s">&#39;-&#39;</span>,
                };
                <b>return</b> <b>new</b> <b>string</b>(<span class="r214 r">mode</span>);
            }
 
            <b>return</b> <span class="r208 r">instance</span>?.<a href="../engine/MshObject.cs.html#d854d13536b70a12" class="i property">BaseObject</a> <b>is</b> <span class="i">FileSystemInfo</span> <span id="r215 rd" class="r215 r">fileInfo</span>
                ? <a href="#448f6291b74e3347" class="i method">ToModeString</a>(<span class="r215 r">fileInfo</span>)
                : <b>string</b>.<span class="i">Empty</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Provides a NameString property for FileSystemInfo.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r216 r">instance</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Instance of PSObject wrapping a FileSystemInfo.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">Name if a file or directory, Name -&gt; Target if symlink.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public static string</b> <a id="871703f609d3f62b" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">NameString</a>(<a href="../engine/MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r216 rd" class="r216 r">instance</span>)
        {
            <b>if</b> (<a href="../engine/ExperimentalFeature/ExperimentalFeature.cs.html#6626da1ebcb2b206" class="t t">ExperimentalFeature</a>.<a href="../engine/ExperimentalFeature/ExperimentalFeature.cs.html#e292001e34f610da" class="i method">IsEnabled</a>(<span class="s">&quot;PSAnsiRenderingFileInfo&quot;</span>))
            {
                <b>if</b> (<span class="r216 r">instance</span>?.<a href="../engine/MshObject.cs.html#d854d13536b70a12" class="i property">BaseObject</a> <b>is</b> <span class="i">FileSystemInfo</span> <span id="r217 rd" class="r217 r">fileInfo</span>)
                {
                    <b>if</b> (<a href="#916c1750999d4e10" class="t t">InternalSymbolicLinkLinkCodeMethods</a>.<a href="#327bd40bb20377da" class="i method">IsReparsePointLikeSymlink</a>(<span class="r217 r">fileInfo</span>))
                    {
                        <b>return</b> <span class="s">$&quot;</span>{<a href="../FormatAndOutput/common/PSStyle.cs.html#340d221c8aa09678" class="t t">PSStyle</a>.<a href="../FormatAndOutput/common/PSStyle.cs.html#f7875006d0bc55f1" class="i property">Instance</a>.<a href="../FormatAndOutput/common/PSStyle.cs.html#dbea67f30ca5b4c4" class="i property">FileInfo</a>.<a href="../FormatAndOutput/common/PSStyle.cs.html#8b0ececfd91a9c1e" class="i property">SymbolicLink</a>}{<span class="r217 r">fileInfo</span>.<span class="i">Name</span>}{<a href="../FormatAndOutput/common/PSStyle.cs.html#340d221c8aa09678" class="t t">PSStyle</a>.<a href="../FormatAndOutput/common/PSStyle.cs.html#f7875006d0bc55f1" class="i property">Instance</a>.<a href="../FormatAndOutput/common/PSStyle.cs.html#0b1059dd37953926" class="i property">Reset</a>}<span class="s"> -&gt; </span>{<a href="#916c1750999d4e10" class="t t">InternalSymbolicLinkLinkCodeMethods</a>.<a href="#5742b8c481f2b1a7" class="i method">GetTarget</a>(<span class="r216 r">instance</span>)}<span class="s">&quot;</span>;
                    }
                    <b>else</b> <b>if</b> (<span class="r217 r">fileInfo</span>.<span class="i">Attributes</span>.<span class="i">HasFlag</span>(<span class="i">FileAttributes</span>.<span class="i">Directory</span>))
                    {
                        <b>return</b> <span class="s">$&quot;</span>{<a href="../FormatAndOutput/common/PSStyle.cs.html#340d221c8aa09678" class="t t">PSStyle</a>.<a href="../FormatAndOutput/common/PSStyle.cs.html#f7875006d0bc55f1" class="i property">Instance</a>.<a href="../FormatAndOutput/common/PSStyle.cs.html#dbea67f30ca5b4c4" class="i property">FileInfo</a>.<a href="../FormatAndOutput/common/PSStyle.cs.html#d69c342f25559bfe" class="i property">Directory</a>}{<span class="r217 r">fileInfo</span>.<span class="i">Name</span>}{<a href="../FormatAndOutput/common/PSStyle.cs.html#340d221c8aa09678" class="t t">PSStyle</a>.<a href="../FormatAndOutput/common/PSStyle.cs.html#f7875006d0bc55f1" class="i property">Instance</a>.<a href="../FormatAndOutput/common/PSStyle.cs.html#0b1059dd37953926" class="i property">Reset</a>}<span class="s">&quot;</span>;
                    }
                    <b>else</b> <b>if</b> (<a href="../FormatAndOutput/common/PSStyle.cs.html#340d221c8aa09678" class="t t">PSStyle</a>.<a href="../FormatAndOutput/common/PSStyle.cs.html#f7875006d0bc55f1" class="i property">Instance</a>.<a href="../FormatAndOutput/common/PSStyle.cs.html#dbea67f30ca5b4c4" class="i property">FileInfo</a>.<a href="../FormatAndOutput/common/PSStyle.cs.html#14cdb0d0f3cde47d" class="i property">Extension</a>.<span class="i">ContainsKey</span>(<span class="r217 r">fileInfo</span>.<span class="i">Extension</span>))
                    {
                        <b>return</b> <span class="s">$&quot;</span>{<a href="../FormatAndOutput/common/PSStyle.cs.html#340d221c8aa09678" class="t t">PSStyle</a>.<a href="../FormatAndOutput/common/PSStyle.cs.html#f7875006d0bc55f1" class="i property">Instance</a>.<a href="../FormatAndOutput/common/PSStyle.cs.html#dbea67f30ca5b4c4" class="i property">FileInfo</a>.<a href="../FormatAndOutput/common/PSStyle.cs.html#14cdb0d0f3cde47d" class="i property">Extension</a>[<span class="r217 r">fileInfo</span>.<span class="i">Extension</span>]}{<span class="r217 r">fileInfo</span>.<span class="i">Name</span>}{<a href="../FormatAndOutput/common/PSStyle.cs.html#340d221c8aa09678" class="t t">PSStyle</a>.<a href="../FormatAndOutput/common/PSStyle.cs.html#f7875006d0bc55f1" class="i property">Instance</a>.<a href="../FormatAndOutput/common/PSStyle.cs.html#0b1059dd37953926" class="i property">Reset</a>}<span class="s">&quot;</span>;
                    }
                    <b>else</b> <b>if</b> ((<a href="../CoreCLR/CorePsPlatform.cs.html#693813241122eb45" class="t t">Platform</a>.<a href="../CoreCLR/CorePsPlatform.cs.html#a0395f876114b36d" class="i property">IsWindows</a> &amp;&amp; <a href="../engine/CommandDiscovery.cs.html#04905efdf0510fc2" class="t t">CommandDiscovery</a>.<a href="../engine/CommandDiscovery.cs.html#bfb5c06a04a1d33d" class="i property">PathExtensions</a>.<span class="i">Contains</span>(<span class="r217 r">fileInfo</span>.<span class="i">Extension</span>.<span class="i">ToLower</span>())) ||
                        (!<a href="../CoreCLR/CorePsPlatform.cs.html#693813241122eb45" class="t t">Platform</a>.<a href="../CoreCLR/CorePsPlatform.cs.html#a0395f876114b36d" class="i property">IsWindows</a> &amp;&amp; <a href="../CoreCLR/CorePsPlatform.cs.html#693813241122eb45" class="t t">Platform</a>.<span class="i">NonWindowsIsExecutable</span>(<span class="r217 r">fileInfo</span>.<span class="i">FullName</span>)))
                    {
                        <b>return</b> <span class="s">$&quot;</span>{<a href="../FormatAndOutput/common/PSStyle.cs.html#340d221c8aa09678" class="t t">PSStyle</a>.<a href="../FormatAndOutput/common/PSStyle.cs.html#f7875006d0bc55f1" class="i property">Instance</a>.<a href="../FormatAndOutput/common/PSStyle.cs.html#dbea67f30ca5b4c4" class="i property">FileInfo</a>.<a href="../FormatAndOutput/common/PSStyle.cs.html#22b6d850e0cc2c7d" class="i property">Executable</a>}{<span class="r217 r">fileInfo</span>.<span class="i">Name</span>}{<a href="../FormatAndOutput/common/PSStyle.cs.html#340d221c8aa09678" class="t t">PSStyle</a>.<a href="../FormatAndOutput/common/PSStyle.cs.html#f7875006d0bc55f1" class="i property">Instance</a>.<a href="../FormatAndOutput/common/PSStyle.cs.html#0b1059dd37953926" class="i property">Reset</a>}<span class="s">&quot;</span>;
                    }
                    <b>else</b>
                    {
                        <b>return</b> <span class="r217 r">fileInfo</span>.<span class="i">Name</span>;
                    }
                }
 
                <b>return</b> <b>string</b>.<span class="i">Empty</span>;
            }
            <b>else</b>
            {
                <b>return</b> <span class="r216 r">instance</span>?.<a href="../engine/MshObject.cs.html#d854d13536b70a12" class="i property">BaseObject</a> <b>is</b> <span class="i">FileSystemInfo</span> <span id="r218 rd" class="r218 r">fileInfo</span>
                    ? <a href="#916c1750999d4e10" class="t t">InternalSymbolicLinkLinkCodeMethods</a>.<a href="#327bd40bb20377da" class="i method">IsReparsePointLikeSymlink</a>(<span class="r218 r">fileInfo</span>)
                        ? <span class="s">$&quot;</span>{<span class="r218 r">fileInfo</span>.<span class="i">Name</span>}<span class="s"> -&gt; </span>{<a href="#916c1750999d4e10" class="t t">InternalSymbolicLinkLinkCodeMethods</a>.<a href="#5742b8c481f2b1a7" class="i method">GetTarget</a>(<span class="r216 r">instance</span>)}<span class="s">&quot;</span>
                        : <span class="r218 r">fileInfo</span>.<span class="i">Name</span>
                    : <b>string</b>.<span class="i">Empty</span>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Provides a LengthString property for FileSystemInfo.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r219 r">instance</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Instance of PSObject wrapping a FileSystemInfo.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">Length as a string.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public static string</b> <a id="e674dea96438ad54" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">LengthString</a>(<a href="../engine/MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r219 rd" class="r219 r">instance</span>)
        {
            <b>return</b> <span class="r219 r">instance</span>?.<a href="../engine/MshObject.cs.html#d854d13536b70a12" class="i property">BaseObject</a> <b>is</b> <span class="i">FileInfo</span> <span id="r220 rd" class="r220 r">fileInfo</span>
                ? <span class="r220 r">fileInfo</span>.<span class="i">Attributes</span>.<span class="i">HasFlag</span>(<span class="i">FileAttributes</span>.<span class="i">Offline</span>)
                    ? <span class="s">$&quot;</span><span class="s">(</span>{<span class="r220 r">fileInfo</span>.<span class="i">Length</span>}<span class="s">)</span><span class="s">&quot;</span>
                    : <span class="r220 r">fileInfo</span>.<span class="i">Length</span>.<span class="i">ToString</span>()
                : <b>string</b>.<span class="i">Empty</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Provides a LastWriteTimeString property for FileSystemInfo.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r221 r">instance</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Instance of PSObject wrapping a FileSystemInfo.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">LastWriteTime formatted as short date + short time.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public static string</b> <a id="81561d7ca01c1493" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">LastWriteTimeString</a>(<a href="../engine/MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r221 rd" class="r221 r">instance</span>)
        {
            <b>return</b> <span class="r221 r">instance</span>?.<a href="../engine/MshObject.cs.html#d854d13536b70a12" class="i property">BaseObject</a> <b>is</b> <span class="i">FileSystemInfo</span> <span id="r222 rd" class="r222 r">fileInfo</span>
                ? <b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">CurrentCulture</span>, <span class="s">&quot;{0,10:d} {0,8:t}&quot;</span>, <span class="r222 r">fileInfo</span>.<span class="i">LastWriteTime</span>)
                : <b>string</b>.<span class="i">Empty</span>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> RenameItem
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Renames a file or directory.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r223 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The current full path to the file or directory.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r224 r">newName</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The new full path to the file or directory.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Nothing.  The renamed DirectoryInfo or FileInfo object is</span>
        <span class="c">///</span><span class="c"> written to the context&#39;s pipeline.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">System</span>.<span class="i">ArgumentException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">     path is null or empty.</span>
        <span class="c">///</span><span class="c">     newName is null or empty</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>protected override void</b> <a id="ea6151c6f339665b" href="../R/ea6151c6f339665b.html" target="n" data-glyph="75,1" class="i method">RenameItem</a>(
            <b>string</b> <span id="r223 rd" class="r223 r">path</span>,
            <b>string</b> <span id="r224 rd" class="r224 r">newName</span>)
        {
            <span class="c">// Check the parameters</span>
            <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r223 r">path</span>))
            {
                <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../utils/MshTraceSource.cs.html#fed5f40dc0075d41" class="i method">NewArgumentException</a>(<b>nameof</b>(<span class="r223 r">path</span>));
            }
 
            <span class="r223 r">path</span> = <a href="#2679b47e3c6ebedc" class="i method">NormalizePath</a>(<span class="r223 r">path</span>);
 
            <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r224 r">newName</span>))
            {
                <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../utils/MshTraceSource.cs.html#fed5f40dc0075d41" class="i method">NewArgumentException</a>(<b>nameof</b>(<span class="r224 r">newName</span>));
            }
 
            <span class="c">// Clean up &quot;newname&quot; to fix some common usability problems:</span>
            <span class="c">// Rename .\foo.txt .\bar.txt</span>
            <span class="c">// Rename C:\temp\foo.txt C:\temp\bar.txt</span>
            <b>if</b> (<span class="r224 r">newName</span>.<span class="i">StartsWith</span>(<span class="s">&quot;.\\&quot;</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>) ||
                <span class="r224 r">newName</span>.<span class="i">StartsWith</span>(<span class="s">&quot;./&quot;</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
            {
                <span class="r224 r">newName</span> = <span class="r224 r">newName</span>.<span class="i">Remove</span>(0, 2);
            }
            <b>else</b> <b>if</b> (<b>string</b>.<span class="i">Equals</span>(<span class="i">Path</span>.<span class="i">GetDirectoryName</span>(<span class="r223 r">path</span>), <span class="i">Path</span>.<span class="i">GetDirectoryName</span>(<span class="r224 r">newName</span>), <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
            {
                <span class="r224 r">newName</span> = <span class="i">Path</span>.<span class="i">GetFileName</span>(<span class="r224 r">newName</span>);
            }
 
            <span class="c">// Check to see if the target specified is just filename. We dont allow rename to move the file to a different directory.</span>
            <span class="c">// If a path is specified for the newName then we flag that as an error.</span>
            <b>if</b> (!<b>string</b>.<span class="i">Equals</span>(<span class="i">Path</span>.<span class="i">GetFileName</span>(<span class="r224 r">newName</span>), <span class="r224 r">newName</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
            {
                <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<span class="i">NewArgumentException</span>(<b>nameof</b>(<span class="r224 r">newName</span>), <span class="i">FileSystemProviderStrings</span>.<span class="i">RenameError</span>);
            }
 
            <span class="c">// Verify that the target doesn&#39;t represent a device name</span>
            <b>if</b> (<a href="#f2f9701584921b3e" class="i method">PathIsReservedDeviceName</a>(<span class="r224 r">newName</span>, <span class="s">&quot;RenameError&quot;</span>))
            {
                <b>return</b>;
            }
 
            <b>try</b>
            {
                <b>bool</b> <span id="r225 rd" class="r225 r">isContainer</span> = <a href="#152bdf0e0e17cd95" class="i method">IsItemContainer</a>(<span class="r223 r">path</span>);
 
                <span class="i">FileSystemInfo</span> <span id="r226 rd" class="r226 r">result</span> = <b>null</b>;
 
                <b>if</b> (<span class="r225 r">isContainer</span>)
                {
                    <span class="c">// Get the DirectoryInfo</span>
                    <span class="i">DirectoryInfo</span> <span id="r227 rd" class="r227 r">dir</span> = <b>new</b> <span class="i">DirectoryInfo</span>(<span class="r223 r">path</span>);
 
                    <span class="c">// Generate the new path which the directory will</span>
                    <span class="c">// be renamed to.</span>
                    <b>string</b> <span id="r228 rd" class="r228 r">parentDirectory</span> = <span class="r227 r">dir</span>.<span class="i">Parent</span>.<span class="i">FullName</span>;
                    <b>string</b> <span id="r229 rd" class="r229 r">newPath</span> = <a href="NavigationProviderBase.cs.html#6133115f9f4a066d" class="i method">MakePath</a>(<span class="r228 r">parentDirectory</span>, <span class="r224 r">newName</span>);
 
                    <span class="c">// Confirm the rename with the user</span>
                    <b>string</b> <span id="r230 rd" class="r230 r">action</span> = <span class="i">FileSystemProviderStrings</span>.<span class="i">RenameItemActionDirectory</span>;
 
                    <b>string</b> <span id="r231 rd" class="r231 r">resource</span> = <a href="../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">FileSystemProviderStrings</span>.<span class="i">RenameItemResourceFileTemplate</span>, <span class="r227 r">dir</span>.<span class="i">FullName</span>, <span class="r229 r">newPath</span>);
 
                    <b>if</b> (<a href="ProviderBase.cs.html#4cb6a9cf0567d153" class="i method">ShouldProcess</a>(<span class="r231 r">resource</span>, <span class="r230 r">action</span>))
                    {
                        <span class="c">// Now move the file</span>
                        <span class="r227 r">dir</span>.<span class="i">MoveTo</span>(<span class="r229 r">newPath</span>);
 
                        <span class="r226 r">result</span> = <span class="r227 r">dir</span>;
                        <span class="i">WriteItemObject</span>(<span class="r226 r">result</span>, <span class="r226 r">result</span>.<span class="i">FullName</span>, <span class="r225 r">isContainer</span>);
                    }
                }
                <b>else</b>
                {
                    <span class="c">// Get the FileInfo</span>
                    <span class="i">FileInfo</span> <span id="r232 rd" class="r232 r">file</span> = <b>new</b> <span class="i">FileInfo</span>(<span class="r223 r">path</span>);
 
                    <span class="c">// Generate the new path which the file will be renamed to.</span>
                    <b>string</b> <span id="r233 rd" class="r233 r">parentDirectory</span> = <span class="r232 r">file</span>.<span class="i">DirectoryName</span>;
                    <b>string</b> <span id="r234 rd" class="r234 r">newPath</span> = <a href="NavigationProviderBase.cs.html#6133115f9f4a066d" class="i method">MakePath</a>(<span class="r233 r">parentDirectory</span>, <span class="r224 r">newName</span>);
 
                    <span class="c">// Confirm the rename with the user</span>
                    <b>string</b> <span id="r235 rd" class="r235 r">action</span> = <span class="i">FileSystemProviderStrings</span>.<span class="i">RenameItemActionFile</span>;
 
                    <b>string</b> <span id="r236 rd" class="r236 r">resource</span> = <a href="../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">FileSystemProviderStrings</span>.<span class="i">RenameItemResourceFileTemplate</span>, <span class="r232 r">file</span>.<span class="i">FullName</span>, <span class="r234 r">newPath</span>);
 
                    <b>if</b> (<a href="ProviderBase.cs.html#4cb6a9cf0567d153" class="i method">ShouldProcess</a>(<span class="r236 r">resource</span>, <span class="r235 r">action</span>))
                    {
                        <span class="c">// Now move the file</span>
                        <span class="r232 r">file</span>.<span class="i">MoveTo</span>(<span class="r234 r">newPath</span>);
 
                        <span class="r226 r">result</span> = <span class="r232 r">file</span>;
                        <span class="i">WriteItemObject</span>(<span class="r226 r">result</span>, <span class="r226 r">result</span>.<span class="i">FullName</span>, <span class="r225 r">isContainer</span>);
                    }
                }
            }
            <b>catch</b> (<span class="i">ArgumentException</span> <span id="r237 rd" class="r237 r">argException</span>)
            {
                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r237 r">argException</span>, <span class="s">&quot;RenameItemArgumentError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#846d2b572f2c4820" class="i field">InvalidArgument</a>, <span class="r223 r">path</span>));
            }
            <b>catch</b> (<span class="i">IOException</span> <span id="r238 rd" class="r238 r">ioException</span>)
            {
                <span class="c">// IOException contains specific message about the error occurred and so no need for errordetails.</span>
                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r238 r">ioException</span>, <span class="s">&quot;RenameItemIOError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#0c2f4b9c74e5b7c2" class="i field">WriteError</a>, <span class="r223 r">path</span>));
            }
            <b>catch</b> (<span class="i">UnauthorizedAccessException</span> <span id="r239 rd" class="r239 r">accessException</span>)
            {
                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r239 r">accessException</span>, <span class="s">&quot;RenameItemUnauthorizedAccessError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#26ba13af79d30a75" class="i field">PermissionDenied</a>, <span class="r223 r">path</span>));
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> RenameItem
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> NewItem
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Creates a file or directory with the given path.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r240 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The path of the file or directory to create.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r241 r">type</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Specify &quot;file&quot; to create a file.</span>
        <span class="c">///</span><span class="c"> Specify &quot;directory&quot; or &quot;container&quot; to create a directory.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r242 r">value</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r241 r">type</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> is &quot;file&quot; then this parameter becomes the content</span>
        <span class="c">///</span><span class="c"> of the file to be created.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Nothing.  The new DirectoryInfo or FileInfo object is</span>
        <span class="c">///</span><span class="c"> written to the context&#39;s pipeline.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">System</span>.<span class="i">ArgumentException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">     path is null or empty.</span>
        <span class="c">///</span><span class="c">     type is null or empty.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>protected override void</b> <a id="867e84830f3c4a72" href="../R/867e84830f3c4a72.html" target="n" data-glyph="75,1" class="i method">NewItem</a>(
            <b>string</b> <span id="r240 rd" class="r240 r">path</span>,
            <b>string</b> <span id="r241 rd" class="r241 r">type</span>,
            <b>object</b> <span id="r242 rd" class="r242 r">value</span>)
        {
            <a href="#84d6fc55e854c346" class="t t">ItemType</a> <span id="r243 rd" class="r243 r">itemType</span> = <a href="#84d6fc55e854c346" class="t t">ItemType</a>.<a href="#d4cdcced6c620eba" class="i field">Unknown</a>;
 
            <span class="c">// Verify parameters</span>
            <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r240 r">path</span>))
            {
                <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../utils/MshTraceSource.cs.html#fed5f40dc0075d41" class="i method">NewArgumentException</a>(<b>nameof</b>(<span class="r240 r">path</span>));
            }
 
            <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r241 r">type</span>))
            {
                <span class="r241 r">type</span> = <span class="s">&quot;file&quot;</span>;
            }
 
            <span class="r240 r">path</span> = <a href="#2679b47e3c6ebedc" class="i method">NormalizePath</a>(<span class="r240 r">path</span>);
 
            <b>if</b> (<a href="ProviderBase.cs.html#e3c4d51f13fbfcaa" class="i property">Force</a>)
            {
                <b>if</b> (!<a href="#c9f70ab2695bd382" class="i method">CreateIntermediateDirectories</a>(<span class="r240 r">path</span>))
                {
                    <b>return</b>;
                }
            }
 
            <span class="r243 r">itemType</span> = <a href="#b0cab249ff0dfd3c" class="i method">GetItemType</a>(<span class="r241 r">type</span>);
 
            <b>if</b> (<span class="r243 r">itemType</span> == <a href="#84d6fc55e854c346" class="t t">ItemType</a>.<a href="#a3f1033a66b0a2df" class="i field">Directory</a>)
            {
                <a href="#8ee1f3e6ca6489ce" class="i method">CreateDirectory</a>(<span class="r240 r">path</span>, <b>true</b>);
            }
            <b>else</b> <b>if</b> (<span class="r243 r">itemType</span> == <a href="#84d6fc55e854c346" class="t t">ItemType</a>.<a href="#6a4c1c41cadf0eb2" class="i field">File</a>)
            {
                <b>try</b>
                {
                    <span class="i">FileMode</span> <span id="r244 rd" class="r244 r">fileMode</span> = <span class="i">FileMode</span>.<span class="i">CreateNew</span>;
 
                    <b>if</b> (<a href="ProviderBase.cs.html#e3c4d51f13fbfcaa" class="i property">Force</a>)
                    {
                        <span class="c">// If force is specified, overwrite the existing</span>
                        <span class="c">// file</span>
                        <span class="r244 r">fileMode</span> = <span class="i">FileMode</span>.<span class="i">Create</span>;
                    }
 
                    <b>string</b> <span id="r245 rd" class="r245 r">action</span> = <span class="i">FileSystemProviderStrings</span>.<span class="i">NewItemActionFile</span>;
 
                    <b>string</b> <span id="r246 rd" class="r246 r">resource</span> = <a href="../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">FileSystemProviderStrings</span>.<span class="i">NewItemActionTemplate</span>, <span class="r240 r">path</span>);
 
                    <b>if</b> (<a href="ProviderBase.cs.html#4cb6a9cf0567d153" class="i method">ShouldProcess</a>(<span class="r246 r">resource</span>, <span class="r245 r">action</span>))
                    {
                        <span class="c">// Create the file with read/write access and</span>
                        <span class="c">// not allowing sharing.</span>
                        <b>using</b> (<span class="i">FileStream</span> <span id="r247 rd" class="r247 r">newFile</span> =
                            <b>new</b> <span class="i">FileStream</span>(
                                <span class="r240 r">path</span>,
                                <span class="r244 r">fileMode</span>,
                                <span class="i">FileAccess</span>.<span class="i">Write</span>,
                                <span class="i">FileShare</span>.<span class="i">None</span>))
                        {
                            <b>if</b> (<span class="r242 r">value</span> != <b>null</b>)
                            {
                                <span class="i">StreamWriter</span> <span id="r248 rd" class="r248 r">streamWriter</span> = <b>new</b> <span class="i">StreamWriter</span>(<span class="r247 r">newFile</span>);
                                <span class="r248 r">streamWriter</span>.<span class="i">Write</span>(<span class="r242 r">value</span>.<span class="i">ToString</span>());
                                <span class="r248 r">streamWriter</span>.<span class="i">Flush</span>();
                                <span class="r248 r">streamWriter</span>.<span class="i">Dispose</span>();
                            }
                        }
 
                        <span class="i">FileInfo</span> <span id="r249 rd" class="r249 r">fileInfo</span> = <b>new</b> <span class="i">FileInfo</span>(<span class="r240 r">path</span>);
                        <span class="i">WriteItemObject</span>(<span class="r249 r">fileInfo</span>, <span class="r240 r">path</span>, <b>false</b>);
                    }
                }
                <b>catch</b> (<span class="i">IOException</span> <span id="r250 rd" class="r250 r">exception</span>)
                {
                    <span class="c">// IOException contains specific message about the error occurred and so no need for errordetails.</span>
                    <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r250 r">exception</span>, <span class="s">&quot;NewItemIOError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#0c2f4b9c74e5b7c2" class="i field">WriteError</a>, <span class="r240 r">path</span>));
                }
                <b>catch</b> (<span class="i">UnauthorizedAccessException</span> <span id="r251 rd" class="r251 r">accessException</span>)
                {
                    <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r251 r">accessException</span>, <span class="s">&quot;NewItemUnauthorizedAccessError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#26ba13af79d30a75" class="i field">PermissionDenied</a>, <span class="r240 r">path</span>));
                }
            }
            <b>else</b> <b>if</b> (<span class="r243 r">itemType</span> == <a href="#84d6fc55e854c346" class="t t">ItemType</a>.<a href="#f91c351b26cbcdb2" class="i field">SymbolicLink</a> || <span class="r243 r">itemType</span> == <a href="#84d6fc55e854c346" class="t t">ItemType</a>.<a href="#9dd8b7556f75a580" class="i field">HardLink</a>)
            {
                <b>string</b> <span id="r252 rd" class="r252 r">action</span> = <b>null</b>;
                <b>if</b> (<span class="r243 r">itemType</span> == <a href="#84d6fc55e854c346" class="t t">ItemType</a>.<a href="#f91c351b26cbcdb2" class="i field">SymbolicLink</a>)
                {
                    <span class="r252 r">action</span> = <span class="i">FileSystemProviderStrings</span>.<span class="i">NewItemActionSymbolicLink</span>;
                }
                <b>else</b> <b>if</b> (<span class="r243 r">itemType</span> == <a href="#84d6fc55e854c346" class="t t">ItemType</a>.<a href="#9dd8b7556f75a580" class="i field">HardLink</a>)
                {
                    <span class="r252 r">action</span> = <span class="i">FileSystemProviderStrings</span>.<span class="i">NewItemActionHardLink</span>;
                }
 
                <b>string</b> <span id="r253 rd" class="r253 r">resource</span> = <a href="../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">FileSystemProviderStrings</span>.<span class="i">NewItemActionTemplate</span>, <span class="r240 r">path</span>);
 
                <b>if</b> (<a href="ProviderBase.cs.html#4cb6a9cf0567d153" class="i method">ShouldProcess</a>(<span class="r253 r">resource</span>, <span class="r252 r">action</span>))
                {
                    <b>bool</b> <span id="r254 rd" class="r254 r">isDirectory</span> = <b>false</b>;
                    <b>string</b> <span id="r255 rd" class="r255 r">strTargetPath</span> = <span class="r242 r">value</span>?.<span class="i">ToString</span>();
 
                    <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r255 r">strTargetPath</span>))
                    {
                        <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../utils/MshTraceSource.cs.html#fbe67220ad7522a0" class="i method">NewArgumentNullException</a>(<b>nameof</b>(<span class="r242 r">value</span>));
                    }
 
                    <b>bool</b> <span id="r256 rd" class="r256 r">exists</span> = <b>false</b>;
 
                    <span class="c">// It is legal to create symbolic links to non-existing targets on</span>
                    <span class="c">// both Windows and Linux. It is not legal to create hard links to</span>
                    <span class="c">// non-existing targets on either Windows or Linux.</span>
                    <b>try</b>
                    {
                        <b>if</b> (<span class="r243 r">itemType</span> == <a href="#84d6fc55e854c346" class="t t">ItemType</a>.<a href="#f91c351b26cbcdb2" class="i field">SymbolicLink</a>)
                        {
                            <span class="r256 r">exists</span> = <b>true</b>;
 
                            <b>var</b> <span id="r257 rd" class="r257 r">normalizedTargetPath</span> = <span class="r255 r">strTargetPath</span>;
                            <b>if</b> (<span class="r255 r">strTargetPath</span>.<span class="i">StartsWith</span>(<span class="s">&quot;.\\&quot;</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>) ||
                                <span class="r255 r">strTargetPath</span>.<span class="i">StartsWith</span>(<span class="s">&quot;./&quot;</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
                            {
                                <span class="r257 r">normalizedTargetPath</span> = <span class="i">Path</span>.<span class="i">Join</span>(<a href="ProviderBase.cs.html#209214b021cef1cf" class="i property">SessionState</a>.<a href="../engine/SessionStatePublic.cs.html#9be0303086619111" class="i property">Internal</a>.<a href="../engine/SessionStateLocationAPIs.cs.html#7f6b3bbb0c411e27" class="i property">CurrentLocation</a>.<a href="PathInfo.cs.html#16e3fcd7f95c1bfc" class="i property">ProviderPath</a>, <span class="r255 r">strTargetPath</span>.<span class="i">AsSpan</span>(2));
                            }
 
                            <a href="#03417d6757ea1d51" class="i method">GetFileSystemInfo</a>(<span class="r257 r">normalizedTargetPath</span>, <b>out</b> <span class="r254 r">isDirectory</span>);
 
                            <span class="r255 r">strTargetPath</span> = <span class="r255 r">strTargetPath</span>.<span class="i">Replace</span>(<a href="../engine/SessionStateStrings.cs.html#55ee11e42c7cf459" class="t t">StringLiterals</a>.<a href="../engine/SessionStateStrings.cs.html#f2548f0f61690656" class="i field">AlternatePathSeparator</a>, <a href="../engine/SessionStateStrings.cs.html#55ee11e42c7cf459" class="t t">StringLiterals</a>.<a href="../engine/SessionStateStrings.cs.html#88fdd102fa325178" class="i field">DefaultPathSeparator</a>);
                        }
                        <b>else</b>
                        {
                            <span class="r256 r">exists</span> = <a href="#03417d6757ea1d51" class="i method">GetFileSystemInfo</a>(<span class="r255 r">strTargetPath</span>, <b>out</b> <span class="r254 r">isDirectory</span>) != <b>null</b>;
                        }
                    }
                    <b>catch</b> (<span class="i">Exception</span> <span id="r258 rd" class="r258 r">e</span>)
                    {
                        <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <a href="../engine/ErrorPackage.cs.html#e9334565e5136f43" class="t constructor">ErrorRecord</a>(<span class="r258 r">e</span>, <span class="s">&quot;AccessException&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#26ba13af79d30a75" class="i field">PermissionDenied</a>, <span class="r255 r">strTargetPath</span>));
                        <b>return</b>;
                    }
 
                    <b>if</b> (!<span class="r256 r">exists</span>)
                    {
                        <b>string</b> <span id="r259 rd" class="r259 r">message</span> = <a href="../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">FileSystemProviderStrings</span>.<span class="i">ItemNotFound</span>, <span class="r255 r">strTargetPath</span>);
                        <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<b>new</b> <a href="../utils/SessionStateExceptions.cs.html#e0421fcbe680a07e" class="t constructor">ItemNotFoundException</a>(<span class="r259 r">message</span>), <span class="s">&quot;ItemNotFound&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#9a72a7d3051ac7c5" class="i field">ObjectNotFound</a>, <span class="r255 r">strTargetPath</span>));
                        <b>return</b>;
                    }
 
                    <b>if</b> (<span class="r243 r">itemType</span> == <a href="#84d6fc55e854c346" class="t t">ItemType</a>.<a href="#9dd8b7556f75a580" class="i field">HardLink</a>)
                    {
                        <span class="c">// Hard links can only be to files, not directories.</span>
                        <b>if</b> (<span class="r254 r">isDirectory</span>)
                        {
                            <b>string</b> <span id="r260 rd" class="r260 r">message</span> = <a href="../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">FileSystemProviderStrings</span>.<span class="i">ItemNotFile</span>, <span class="r255 r">strTargetPath</span>);
                            <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<b>new</b> <span class="i">InvalidOperationException</span>(<span class="r260 r">message</span>), <span class="s">&quot;ItemNotFile&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#b5cba3d51f976bb3" class="i field">InvalidOperation</a>, <span class="r255 r">strTargetPath</span>));
                            <b>return</b>;
                        }
                    }
 
                    <b>bool</b> <span id="r261 rd" class="r261 r">isSymLinkDirectory</span> = <b>false</b>;
                    <b>bool</b> <span id="r262 rd" class="r262 r">symLinkExists</span> = <b>false</b>;
 
                    <b>try</b>
                    {
                        <span class="r262 r">symLinkExists</span> = <a href="#03417d6757ea1d51" class="i method">GetFileSystemInfo</a>(<span class="r240 r">path</span>, <b>out</b> <span class="r261 r">isSymLinkDirectory</span>) != <b>null</b>;
                    }
                    <b>catch</b> (<span class="i">Exception</span> <span id="r263 rd" class="r263 r">e</span>)
                    {
                        <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <a href="../engine/ErrorPackage.cs.html#e9334565e5136f43" class="t constructor">ErrorRecord</a>(<span class="r263 r">e</span>, <span class="s">&quot;AccessException&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#26ba13af79d30a75" class="i field">PermissionDenied</a>, <span class="r240 r">path</span>));
                        <b>return</b>;
                    }
 
                    <b>if</b> (<a href="ProviderBase.cs.html#e3c4d51f13fbfcaa" class="i property">Force</a>)
                    {
                        <b>try</b>
                        {
                            <b>if</b> (!<span class="r261 r">isSymLinkDirectory</span> &amp;&amp; <span class="r262 r">symLinkExists</span>)
                            {
                                <span class="i">File</span>.<span class="i">Delete</span>(<span class="r240 r">path</span>);
                            }
                            <b>else</b> <b>if</b> (<span class="r261 r">isSymLinkDirectory</span> &amp;&amp; <span class="r262 r">symLinkExists</span>)
                            {
                                <span class="i">Directory</span>.<span class="i">Delete</span>(<span class="r240 r">path</span>);
                            }
                        }
                        <b>catch</b> (<span class="i">Exception</span> <span id="r264 rd" class="r264 r">exception</span>)
                        {
                            <b>if</b> ((<span class="r264 r">exception</span> <b>is</b> <span class="i">FileNotFoundException</span>) ||
                                (<span class="r264 r">exception</span> <b>is</b> <span class="i">DirectoryNotFoundException</span>) ||
                                (<span class="r264 r">exception</span> <b>is</b> <span class="i">UnauthorizedAccessException</span>) ||
                                (<span class="r264 r">exception</span> <b>is</b> <span class="i n">System</span>.<span class="i">Security</span>.<span class="i">SecurityException</span>) ||
                                (<span class="r264 r">exception</span> <b>is</b> <span class="i">ArgumentException</span>) ||
                                (<span class="r264 r">exception</span> <b>is</b> <span class="i">PathTooLongException</span>) ||
                                (<span class="r264 r">exception</span> <b>is</b> <span class="i">NotSupportedException</span>) ||
                                (<span class="r264 r">exception</span> <b>is</b> <span class="i">ArgumentNullException</span>) ||
                                (<span class="r264 r">exception</span> <b>is</b> <span class="i">IOException</span>))
                            {
                                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <a href="../engine/ErrorPackage.cs.html#e9334565e5136f43" class="t constructor">ErrorRecord</a>(<span class="r264 r">exception</span>, <span class="s">&quot;NewItemDeleteIOError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#0c2f4b9c74e5b7c2" class="i field">WriteError</a>, <span class="r240 r">path</span>));
                            }
                            <b>else</b>
                            {
                                <b>throw</b>;
                            }
                        }
                    }
                    <b>else</b>
                    {
                        <b>if</b> (<span class="r262 r">symLinkExists</span>)
                        {
                            <b>string</b> <span id="r265 rd" class="r265 r">message</span> = <a href="../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">FileSystemProviderStrings</span>.<span class="i">SymlinkItemExists</span>, <span class="r240 r">path</span>);
                            <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<b>new</b> <span class="i">IOException</span>(<span class="r265 r">message</span>), <span class="s">&quot;SymLinkExists&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#22cb3b8b80f740be" class="i field">ResourceExists</a>, <span class="r240 r">path</span>));
                            <b>return</b>;
                        }
                    }
 
                    <b>bool</b> <span id="r266 rd" class="r266 r">success</span> = <b>false</b>;
 
                    <b>if</b> (<span class="r243 r">itemType</span> == <a href="#84d6fc55e854c346" class="t t">ItemType</a>.<a href="#f91c351b26cbcdb2" class="i field">SymbolicLink</a>)
                    {
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">UNIX</span>
<span class="e">                        success = Platform.NonWindowsCreateSymbolicLink(path, strTargetPath);
</span><span class="k preprocess">#</span><span class="k preprocess">else</span>
                        <span class="r266 r">success</span> = <a href="#39fbd9f8a372a5ac" class="i method">WinCreateSymbolicLink</a>(<span class="r240 r">path</span>, <span class="r255 r">strTargetPath</span>, <span class="r254 r">isDirectory</span>);
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
                    }
                    <b>else</b> <b>if</b> (<span class="r243 r">itemType</span> == <a href="#84d6fc55e854c346" class="t t">ItemType</a>.<a href="#9dd8b7556f75a580" class="i field">HardLink</a>)
                    {
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">UNIX</span>
<span class="e">                        success = Platform.NonWindowsCreateHardLink(path, strTargetPath);
</span><span class="k preprocess">#</span><span class="k preprocess">else</span>
                        <span class="r266 r">success</span> = <a href="#ec59e67105e86fcf" class="i method">WinCreateHardLink</a>(<span class="r240 r">path</span>, <span class="r255 r">strTargetPath</span>);
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
                    }
 
                    <b>if</b> (!<span class="r266 r">success</span>)
                    {
                        <span class="c">// Porting note: The Win32Exception will report the correct error on Linux</span>
                        <b>int</b> <span id="r267 rd" class="r267 r">errorCode</span> = <span class="i">Marshal</span>.<span class="i">GetLastWin32Error</span>();
 
                        <span class="i">Win32Exception</span> <span id="r268 rd" class="r268 r">w32Exception</span> = <b>new</b> <span class="i">Win32Exception</span>((<b>int</b>)<span class="r267 r">errorCode</span>);
 
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">UNIX</span>
<span class="e">                        if (Platform.Unix.GetErrorCategory(errorCode) == ErrorCategory.PermissionDenied)
</span><span class="k preprocess">#</span><span class="k preprocess">else</span>
                        <b>if</b> (<span class="r267 r">errorCode</span> == 1314) <span class="c">// ERROR_PRIVILEGE_NOT_HELD</span>
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
                        {
                            <b>string</b> <span id="r269 rd" class="r269 r">message</span> = <span class="i">FileSystemProviderStrings</span>.<span class="i">ElevationRequired</span>;
                            <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<b>new</b> <span class="i">UnauthorizedAccessException</span>(<span class="r269 r">message</span>, <span class="r268 r">w32Exception</span>), <span class="s">&quot;NewItemSymbolicLinkElevationRequired&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#26ba13af79d30a75" class="i field">PermissionDenied</a>, <span class="r242 r">value</span>.<span class="i">ToString</span>()));
                            <b>return</b>;
                        }
 
                        <b>if</b> (<span class="r267 r">errorCode</span> == 1) <span class="c">// ERROR_INVALID_FUNCTION</span>
                        {
                            <b>string</b> <span id="r270 rd" class="r270 r">message</span> = <b>null</b>;
                            <b>if</b> (<span class="r243 r">itemType</span> == <a href="#84d6fc55e854c346" class="t t">ItemType</a>.<a href="#f91c351b26cbcdb2" class="i field">SymbolicLink</a>)
                            {
                                <span class="r270 r">message</span> = <span class="i">FileSystemProviderStrings</span>.<span class="i">SymbolicLinkNotSupported</span>;
                            }
                            <b>else</b>
                            {
                                <span class="r270 r">message</span> = <span class="i">FileSystemProviderStrings</span>.<span class="i">HardLinkNotSupported</span>;
                            }
 
                            <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<b>new</b> <span class="i">InvalidOperationException</span>(<span class="r270 r">message</span>, <span class="r268 r">w32Exception</span>), <span class="s">&quot;NewItemInvalidOperation&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#b5cba3d51f976bb3" class="i field">InvalidOperation</a>, <span class="r242 r">value</span>.<span class="i">ToString</span>()));
                            <b>return</b>;
                        }
 
                        <b>throw</b> <span class="r268 r">w32Exception</span>;
                    }
                    <b>else</b>
                    {
                        <b>if</b> (<span class="r254 r">isDirectory</span>)
                        {
                            <span class="i">DirectoryInfo</span> <span id="r271 rd" class="r271 r">dirInfo</span> = <b>new</b> <span class="i">DirectoryInfo</span>(<span class="r240 r">path</span>);
                            <span class="i">WriteItemObject</span>(<span class="r271 r">dirInfo</span>, <span class="r240 r">path</span>, <b>true</b>);
                        }
                        <b>else</b>
                        {
                            <span class="i">FileInfo</span> <span id="r272 rd" class="r272 r">fileInfo</span> = <b>new</b> <span class="i">FileInfo</span>(<span class="r240 r">path</span>);
                            <span class="i">WriteItemObject</span>(<span class="r272 r">fileInfo</span>, <span class="r240 r">path</span>, <b>false</b>);
                        }
                    }
                }
            }
            <b>else</b> <b>if</b> (<span class="r243 r">itemType</span> == <a href="#84d6fc55e854c346" class="t t">ItemType</a>.<a href="#843e6794d3de2d4c" class="i field">Junction</a>)
            {
                <b>string</b> <span id="r273 rd" class="r273 r">action</span> = <span class="i">FileSystemProviderStrings</span>.<span class="i">NewItemActionJunction</span>;
                <b>string</b> <span id="r274 rd" class="r274 r">resource</span> = <a href="../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">FileSystemProviderStrings</span>.<span class="i">NewItemActionTemplate</span>, <span class="r240 r">path</span>);
 
                <b>if</b> (<a href="ProviderBase.cs.html#4cb6a9cf0567d153" class="i method">ShouldProcess</a>(<span class="r274 r">resource</span>, <span class="r273 r">action</span>))
                {
                    <b>bool</b> <span id="r275 rd" class="r275 r">isDirectory</span> = <b>false</b>;
                    <b>string</b> <span id="r276 rd" class="r276 r">strTargetPath</span> = <span class="r242 r">value</span>?.<span class="i">ToString</span>();
 
                    <b>bool</b> <span id="r277 rd" class="r277 r">exists</span> = <b>false</b>;
 
                    <b>try</b>
                    {
                        <span class="r277 r">exists</span> = <a href="#03417d6757ea1d51" class="i method">GetFileSystemInfo</a>(<span class="r276 r">strTargetPath</span>, <b>out</b> <span class="r275 r">isDirectory</span>) != <b>null</b>;
                    }
                    <b>catch</b> (<span class="i">Exception</span> <span id="r278 rd" class="r278 r">e</span>)
                    {
                        <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <a href="../engine/ErrorPackage.cs.html#e9334565e5136f43" class="t constructor">ErrorRecord</a>(<span class="r278 r">e</span>, <span class="s">&quot;AccessException&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#26ba13af79d30a75" class="i field">PermissionDenied</a>, <span class="r276 r">strTargetPath</span>));
                        <b>return</b>;
                    }
 
                    <b>if</b> (!<span class="r277 r">exists</span>)
                    {
                        <b>string</b> <span id="r279 rd" class="r279 r">message</span> = <a href="../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">FileSystemProviderStrings</span>.<span class="i">ItemNotFound</span>, <span class="r276 r">strTargetPath</span>);
                        <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<b>new</b> <a href="../utils/SessionStateExceptions.cs.html#e0421fcbe680a07e" class="t constructor">ItemNotFoundException</a>(<span class="r279 r">message</span>), <span class="s">&quot;ItemNotFound&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#9a72a7d3051ac7c5" class="i field">ObjectNotFound</a>, <span class="r276 r">strTargetPath</span>));
                        <b>return</b>;
                    }
 
                    <span class="c">// Junctions can only be directories.</span>
                    <b>if</b> (!<span class="r275 r">isDirectory</span>)
                    {
                        <b>string</b> <span id="r280 rd" class="r280 r">message</span> = <a href="../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">FileSystemProviderStrings</span>.<span class="i">ItemNotDirectory</span>, <span class="r242 r">value</span>);
                        <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<b>new</b> <span class="i">InvalidOperationException</span>(<span class="r280 r">message</span>), <span class="s">&quot;ItemNotDirectory&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#b5cba3d51f976bb3" class="i field">InvalidOperation</a>, <span class="r242 r">value</span>));
                        <b>return</b>;
                    }
 
                    <b>bool</b> <span id="r281 rd" class="r281 r">isPathDirectory</span> = <b>false</b>;
                    <span class="i">FileSystemInfo</span> <span id="r282 rd" class="r282 r">pathDirInfo</span>;
 
                    <b>try</b>
                    {
                        <span class="r282 r">pathDirInfo</span> = <a href="#03417d6757ea1d51" class="i method">GetFileSystemInfo</a>(<span class="r240 r">path</span>, <b>out</b> <span class="r281 r">isPathDirectory</span>);
                    }
                    <b>catch</b> (<span class="i">Exception</span> <span id="r283 rd" class="r283 r">e</span>)
                    {
                        <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <a href="../engine/ErrorPackage.cs.html#e9334565e5136f43" class="t constructor">ErrorRecord</a>(<span class="r283 r">e</span>, <span class="s">&quot;AccessException&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#26ba13af79d30a75" class="i field">PermissionDenied</a>, <span class="r276 r">strTargetPath</span>));
                        <b>return</b>;
                    }
 
                    <b>bool</b> <span id="r284 rd" class="r284 r">pathExists</span> = <span class="r282 r">pathDirInfo</span> != <b>null</b>;
 
                    <b>if</b> (<span class="r284 r">pathExists</span>)
                    {
                        <span class="c">// Junctions can only be directories.</span>
                        <b>if</b> (!<span class="r281 r">isPathDirectory</span>)
                        {
                            <b>string</b> <span id="r285 rd" class="r285 r">message</span> = <a href="../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">FileSystemProviderStrings</span>.<span class="i">ItemNotDirectory</span>, <span class="r240 r">path</span>);
                            <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<b>new</b> <span class="i">InvalidOperationException</span>(<span class="r285 r">message</span>), <span class="s">&quot;ItemNotDirectory&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#b5cba3d51f976bb3" class="i field">InvalidOperation</a>, <span class="r240 r">path</span>));
                            <b>return</b>;
                        }
 
                        <span class="c">// Junctions cannot have files</span>
                        <b>if</b> (<a href="#311536e1beab722a" class="i method">DirectoryInfoHasChildItems</a>((<span class="i">DirectoryInfo</span>)<span class="r282 r">pathDirInfo</span>))
                        {
                            <b>string</b> <span id="r286 rd" class="r286 r">message</span> = <a href="../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">FileSystemProviderStrings</span>.<span class="i">DirectoryNotEmpty</span>, <span class="r240 r">path</span>);
                            <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<b>new</b> <span class="i">IOException</span>(<span class="r286 r">message</span>), <span class="s">&quot;DirectoryNotEmpty&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#0c2f4b9c74e5b7c2" class="i field">WriteError</a>, <span class="r240 r">path</span>));
                            <b>return</b>;
                        }
 
                        <b>if</b> (<a href="ProviderBase.cs.html#e3c4d51f13fbfcaa" class="i property">Force</a>)
                        {
                            <b>try</b>
                            {
                                <span class="r282 r">pathDirInfo</span>.<span class="i">Delete</span>();
                            }
                            <b>catch</b> (<span class="i">Exception</span> <span id="r287 rd" class="r287 r">exception</span>)
                            {
                                <b>if</b> ((<span class="r287 r">exception</span> <b>is</b> <span class="i">DirectoryNotFoundException</span>) ||
                                    (<span class="r287 r">exception</span> <b>is</b> <span class="i">UnauthorizedAccessException</span>) ||
                                    (<span class="r287 r">exception</span> <b>is</b> <span class="i n">System</span>.<span class="i">Security</span>.<span class="i">SecurityException</span>) ||
                                    (<span class="r287 r">exception</span> <b>is</b> <span class="i">IOException</span>))
                                {
                                    <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <a href="../engine/ErrorPackage.cs.html#e9334565e5136f43" class="t constructor">ErrorRecord</a>(<span class="r287 r">exception</span>, <span class="s">&quot;NewItemDeleteIOError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#0c2f4b9c74e5b7c2" class="i field">WriteError</a>, <span class="r240 r">path</span>));
                                }
                                <b>else</b>
                                {
                                    <b>throw</b>;
                                }
                            }
                        }
                    }
                    <b>else</b>
                    {
                        <a href="#8ee1f3e6ca6489ce" class="i method">CreateDirectory</a>(<span class="r240 r">path</span>, <b>false</b>);
                        <span class="r282 r">pathDirInfo</span> = <b>new</b> <span class="i">DirectoryInfo</span>(<span class="r240 r">path</span>);
                    }
 
                    <b>try</b>
                    {
                        <b>bool</b> <span id="r288 rd" class="r288 r">junctionCreated</span> = <a href="#2bce3b3e6efbeec4" class="i method">WinCreateJunction</a>(<span class="r240 r">path</span>, <span class="r276 r">strTargetPath</span>);
 
                        <b>if</b> (<span class="r288 r">junctionCreated</span>)
                        {
                            <span class="i">WriteItemObject</span>(<span class="r282 r">pathDirInfo</span>, <span class="r240 r">path</span>, <b>true</b>);
                        }
                        <b>else</b> <span class="c">// rollback the directory creation if we created it.</span>
                        {
                            <b>if</b> (!<span class="r284 r">pathExists</span>)
                            {
                                <span class="r282 r">pathDirInfo</span>.<span class="i">Delete</span>();
                            }
                        }
                    }
                    <b>catch</b> (<span class="i">Exception</span> <span id="r289 rd" class="r289 r">exception</span>)
                    {
                        <span class="c">// rollback the directory creation if it was created.</span>
                        <b>if</b> (!<span class="r284 r">pathExists</span>)
                        {
                            <span class="r282 r">pathDirInfo</span>.<span class="i">Delete</span>();
                        }
 
                        <b>if</b> ((<span class="r289 r">exception</span> <b>is</b> <span class="i">FileNotFoundException</span>) ||
                                (<span class="r289 r">exception</span> <b>is</b> <span class="i">DirectoryNotFoundException</span>) ||
                                (<span class="r289 r">exception</span> <b>is</b> <span class="i">UnauthorizedAccessException</span>) ||
                                (<span class="r289 r">exception</span> <b>is</b> <span class="i n">System</span>.<span class="i">Security</span>.<span class="i">SecurityException</span>) ||
                                (<span class="r289 r">exception</span> <b>is</b> <span class="i">ArgumentException</span>) ||
                                (<span class="r289 r">exception</span> <b>is</b> <span class="i">PathTooLongException</span>) ||
                                (<span class="r289 r">exception</span> <b>is</b> <span class="i">NotSupportedException</span>) ||
                                (<span class="r289 r">exception</span> <b>is</b> <span class="i">ArgumentNullException</span>) ||
                                (<span class="r289 r">exception</span> <b>is</b> <span class="i">Win32Exception</span>) ||
                                (<span class="r289 r">exception</span> <b>is</b> <span class="i">IOException</span>))
                        {
                            <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <a href="../engine/ErrorPackage.cs.html#e9334565e5136f43" class="t constructor">ErrorRecord</a>(<span class="r289 r">exception</span>, <span class="s">&quot;NewItemCreateIOError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#0c2f4b9c74e5b7c2" class="i field">WriteError</a>, <span class="r240 r">path</span>));
                        }
                        <b>else</b>
                        {
                            <b>throw</b>;
                        }
                    }
                }
            }
            <b>else</b>
            {
                <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<span class="i">NewArgumentException</span>(<b>nameof</b>(<span class="r241 r">type</span>), <span class="i">FileSystemProviderStrings</span>.<span class="i">UnknownType</span>);
            }
        }
 
        <b>private static bool</b> <a id="39fbd9f8a372a5ac" href="../R/39fbd9f8a372a5ac.html" target="n" data-glyph="76,1" class="i method">WinCreateSymbolicLink</a>(<b>string</b> <span id="r290 rd" class="r290 r">path</span>, <b>string</b> <span id="r291 rd" class="r291 r">strTargetPath</span>, <b>bool</b> <span id="r292 rd" class="r292 r">isDirectory</span>)
        {
            <span class="c">// The new AllowUnprivilegedCreate is only available on Win10 build 14972 or newer</span>
            <a href="#3bf6d62476ea2c93" class="k">var</a> <span id="r293 rd" class="r293 r">flags</span> = <span class="r292 r">isDirectory</span> ? <a href="#f0fcb2141ba63e82" class="t t">NativeMethods</a>.<a href="#3bf6d62476ea2c93" class="t t">SymbolicLinkFlags</a>.<a href="#3173d409ba2b9d00" class="i field">Directory</a> : <a href="#f0fcb2141ba63e82" class="t t">NativeMethods</a>.<a href="#3bf6d62476ea2c93" class="t t">SymbolicLinkFlags</a>.<a href="#580d7f222c06cf10" class="i field">File</a>;
 
            <span class="i">Version</span> <span id="r294 rd" class="r294 r">minBuildOfDeveloperMode</span> = <b>new</b> <span class="i">Version</span>(10, 0, 14972, 0);
            <b>if</b> (<span class="i">Environment</span>.<span class="i">OSVersion</span>.<span class="i">Version</span> &gt;= <span class="r294 r">minBuildOfDeveloperMode</span>)
            {
                <span class="r293 r">flags</span> |= <a href="#f0fcb2141ba63e82" class="t t">NativeMethods</a>.<a href="#3bf6d62476ea2c93" class="t t">SymbolicLinkFlags</a>.<a href="#5675dec56b7daae7" class="i field">AllowUnprivilegedCreate</a>;
            }
 
            <b>var</b> <span id="r295 rd" class="r295 r">created</span> = <a href="#f0fcb2141ba63e82" class="t t">NativeMethods</a>.<a href="#d7108f3789c23913" class="i method">CreateSymbolicLink</a>(<span class="r290 r">path</span>, <span class="r291 r">strTargetPath</span>, <span class="r293 r">flags</span>);
            <b>return</b> <span class="r295 r">created</span>;
        }
 
        <b>private static bool</b> <a id="ec59e67105e86fcf" href="../R/ec59e67105e86fcf.html" target="n" data-glyph="76,1" class="i method">WinCreateHardLink</a>(<b>string</b> <span id="r296 rd" class="r296 r">path</span>, <b>string</b> <span id="r297 rd" class="r297 r">strTargetPath</span>)
        {
            <b>bool</b> <span id="r298 rd" class="r298 r">success</span> = <a href="#f0fcb2141ba63e82" class="t t">NativeMethods</a>.<span class="i">CreateHardLink</span>(<span class="r296 r">path</span>, <span class="r297 r">strTargetPath</span>, <span class="i">IntPtr</span>.<span class="i">Zero</span>);
            <b>return</b> <span class="r298 r">success</span>;
        }
 
        <b>private static bool</b> <a id="2bce3b3e6efbeec4" href="../R/2bce3b3e6efbeec4.html" target="n" data-glyph="76,1" class="i method">WinCreateJunction</a>(<b>string</b> <span id="r299 rd" class="r299 r">path</span>, <b>string</b> <span id="r300 rd" class="r300 r">strTargetPath</span>)
        {
            <b>bool</b> <span id="r301 rd" class="r301 r">junctionCreated</span> = <a href="#916c1750999d4e10" class="t t">InternalSymbolicLinkLinkCodeMethods</a>.<a href="#a202e3dbfe2ea66e" class="i method">CreateJunction</a>(<span class="r299 r">path</span>, <span class="r300 r">strTargetPath</span>);
            <b>return</b> <span class="r301 r">junctionCreated</span>;
        }
 
        <b>private enum</b> <a id="84d6fc55e854c346" href="../R/84d6fc55e854c346.html" target="n" data-glyph="22,1" class="t t"><span id="b2c45e0ecdcc05a3">ItemType</span></a>
        {
            <a id="d4cdcced6c620eba" href="../R/d4cdcced6c620eba.html" target="n" data-glyph="24,2" class="i field">Unknown</a>,
            <a id="6a4c1c41cadf0eb2" href="../R/6a4c1c41cadf0eb2.html" target="n" data-glyph="24,2" class="i field">File</a>,
            <a id="a3f1033a66b0a2df" href="../R/a3f1033a66b0a2df.html" target="n" data-glyph="24,2" class="i field">Directory</a>,
            <a id="f91c351b26cbcdb2" href="../R/f91c351b26cbcdb2.html" target="n" data-glyph="24,2" class="i field">SymbolicLink</a>,
            <a id="843e6794d3de2d4c" href="../R/843e6794d3de2d4c.html" target="n" data-glyph="24,2" class="i field">Junction</a>,
            <a id="9dd8b7556f75a580" href="../R/9dd8b7556f75a580.html" target="n" data-glyph="24,2" class="i field">HardLink</a>
        }
 
        <b>private static</b> <a href="#84d6fc55e854c346" class="t t">ItemType</a> <a id="b0cab249ff0dfd3c" href="../R/b0cab249ff0dfd3c.html" target="n" data-glyph="76,1" class="i method">GetItemType</a>(<b>string</b> <span id="r302 rd" class="r302 r">input</span>)
        {
            <a href="#84d6fc55e854c346" class="t t">ItemType</a> <span id="r303 rd" class="r303 r">itemType</span> = <a href="#84d6fc55e854c346" class="t t">ItemType</a>.<a href="#d4cdcced6c620eba" class="i field">Unknown</a>;
 
            <a href="../engine/regex.cs.html#d450e739ff28e660" class="t t">WildcardPattern</a> <span id="r304 rd" class="r304 r">typeEvaluator</span> =
                <a href="../engine/regex.cs.html#d450e739ff28e660" class="t t">WildcardPattern</a>.<span class="i">Get</span>(<span class="r302 r">input</span> + <span class="s">&quot;*&quot;</span>,
                                     <a href="../engine/regex.cs.html#4e788ab2470b3632" class="t t">WildcardOptions</a>.<a href="../engine/regex.cs.html#2d0521a6986208d3" class="i field">IgnoreCase</a> |
                                     <a href="../engine/regex.cs.html#4e788ab2470b3632" class="t t">WildcardOptions</a>.<a href="../engine/regex.cs.html#e7978967739ff542" class="i field">Compiled</a>);
 
            <b>if</b> (<span class="r304 r">typeEvaluator</span>.<a href="../engine/regex.cs.html#02e7d1c913f3c256" class="i method">IsMatch</a>(<span class="s">&quot;directory&quot;</span>) ||
                <span class="r304 r">typeEvaluator</span>.<a href="../engine/regex.cs.html#02e7d1c913f3c256" class="i method">IsMatch</a>(<span class="s">&quot;container&quot;</span>))
            {
                <span class="r303 r">itemType</span> = <a href="#84d6fc55e854c346" class="t t">ItemType</a>.<a href="#a3f1033a66b0a2df" class="i field">Directory</a>;
            }
            <b>else</b> <b>if</b> (<span class="r304 r">typeEvaluator</span>.<a href="../engine/regex.cs.html#02e7d1c913f3c256" class="i method">IsMatch</a>(<span class="s">&quot;file&quot;</span>))
            {
                <span class="r303 r">itemType</span> = <a href="#84d6fc55e854c346" class="t t">ItemType</a>.<a href="#6a4c1c41cadf0eb2" class="i field">File</a>;
            }
            <b>else</b> <b>if</b> (<span class="r304 r">typeEvaluator</span>.<a href="../engine/regex.cs.html#02e7d1c913f3c256" class="i method">IsMatch</a>(<span class="s">&quot;symboliclink&quot;</span>))
            {
                <span class="r303 r">itemType</span> = <a href="#84d6fc55e854c346" class="t t">ItemType</a>.<a href="#f91c351b26cbcdb2" class="i field">SymbolicLink</a>;
            }
            <b>else</b> <b>if</b> (<span class="r304 r">typeEvaluator</span>.<a href="../engine/regex.cs.html#02e7d1c913f3c256" class="i method">IsMatch</a>(<span class="s">&quot;junction&quot;</span>))
            {
                <span class="r303 r">itemType</span> = <a href="#84d6fc55e854c346" class="t t">ItemType</a>.<a href="#843e6794d3de2d4c" class="i field">Junction</a>;
            }
            <b>else</b> <b>if</b> (<span class="r304 r">typeEvaluator</span>.<a href="../engine/regex.cs.html#02e7d1c913f3c256" class="i method">IsMatch</a>(<span class="s">&quot;hardlink&quot;</span>))
            {
                <span class="r303 r">itemType</span> = <a href="#84d6fc55e854c346" class="t t">ItemType</a>.<a href="#9dd8b7556f75a580" class="i field">HardLink</a>;
            }
 
            <b>return</b> <span class="r303 r">itemType</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Creates a directory at the specified path.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r305 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The path of the directory to create</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r306 r">streamOutput</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Determines if the directory should be streamed out after being created.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>private void</b> <a id="8ee1f3e6ca6489ce" href="../R/8ee1f3e6ca6489ce.html" target="n" data-glyph="76,1" class="i method">CreateDirectory</a>(<b>string</b> <span id="r305 rd" class="r305 r">path</span>, <b>bool</b> <span id="r306 rd" class="r306 r">streamOutput</span>)
        {
            <span class="i n">Dbg</span>.<a href="../utils/assert.cs.html#c04955255430d32f" class="t t">Diagnostics</a>.<span class="i">Assert</span>(
                !<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r305 r">path</span>),
                <span class="s">&quot;The caller should verify path&quot;</span>);
 
            <span class="c">// Get the parent path</span>
            <b>string</b> <span id="r307 rd" class="r307 r">parentPath</span> = <a href="#f3d047f7aa5be4e6" class="i method">GetParentPath</a>(<span class="r305 r">path</span>, <b>null</b>);
 
            <span class="c">// The directory name</span>
            <b>string</b> <span id="r308 rd" class="r308 r">childName</span> = <a href="#651f505b469fdf3b" class="i method">GetChildName</a>(<span class="r305 r">path</span>);
 
            <a href="../engine/ErrorPackage.cs.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r309 rd" class="r309 r">error</span> = <b>null</b>;
            <b>if</b> (!<a href="ProviderBase.cs.html#e3c4d51f13fbfcaa" class="i property">Force</a> &amp;&amp; <a href="#5131889761110ea9" class="i method">ItemExists</a>(<span class="r305 r">path</span>, <b>out</b> <span class="r309 r">error</span>))
            {
                <b>string</b> <span id="r310 rd" class="r310 r">errorMessage</span> = <a href="../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">FileSystemProviderStrings</span>.<span class="i">DirectoryExist</span>, <span class="r305 r">path</span>);
                <span class="i">Exception</span> <span id="r311 rd" class="r311 r">e</span> = <b>new</b> <span class="i">IOException</span>(<span class="r310 r">errorMessage</span>);
 
                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <a href="../engine/ErrorPackage.cs.html#e9334565e5136f43" class="t constructor">ErrorRecord</a>(
                    <span class="r311 r">e</span>,
                    <span class="s">&quot;DirectoryExist&quot;</span>,
                    <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#22cb3b8b80f740be" class="i field">ResourceExists</a>,
                    <span class="r305 r">path</span>));
 
                <b>return</b>;
            }
 
            <b>if</b> (<span class="r309 r">error</span> != <b>null</b>)
            {
                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<span class="r309 r">error</span>);
                <b>return</b>;
            }
 
            <b>try</b>
            {
                <b>string</b> <span id="r312 rd" class="r312 r">action</span> = <span class="i">FileSystemProviderStrings</span>.<span class="i">NewItemActionDirectory</span>;
 
                <b>string</b> <span id="r313 rd" class="r313 r">resource</span> = <a href="../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">FileSystemProviderStrings</span>.<span class="i">NewItemActionTemplate</span>, <span class="r305 r">path</span>);
 
                <b>if</b> (<a href="ProviderBase.cs.html#4cb6a9cf0567d153" class="i method">ShouldProcess</a>(<span class="r313 r">resource</span>, <span class="r312 r">action</span>))
                {
                    <b>var</b> <span id="r314 rd" class="r314 r">result</span> = <span class="i">Directory</span>.<span class="i">CreateDirectory</span>(<span class="i">Path</span>.<span class="i">Combine</span>(<span class="r307 r">parentPath</span>, <span class="r308 r">childName</span>));
 
                    <b>if</b> (<span class="r306 r">streamOutput</span>)
                    {
                        <span class="c">// Write the result to the pipeline</span>
                        <span class="i">WriteItemObject</span>(<span class="r314 r">result</span>, <span class="r305 r">path</span>, <b>true</b>);
                    }
                }
            }
            <b>catch</b> (<span class="i">ArgumentException</span> <span id="r315 rd" class="r315 r">argException</span>)
            {
                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r315 r">argException</span>, <span class="s">&quot;CreateDirectoryArgumentError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#846d2b572f2c4820" class="i field">InvalidArgument</a>, <span class="r305 r">path</span>));
            }
            <b>catch</b> (<span class="i">IOException</span> <span id="r316 rd" class="r316 r">ioException</span>)
            {
                <span class="c">// Ignore the error if force was specified</span>
                <b>if</b> (!<a href="ProviderBase.cs.html#e3c4d51f13fbfcaa" class="i property">Force</a>)
                {
                    <span class="c">// IOException contains specific message about the error occurred and so no need for errordetails.</span>
                    <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r316 r">ioException</span>, <span class="s">&quot;CreateDirectoryIOError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#0c2f4b9c74e5b7c2" class="i field">WriteError</a>, <span class="r305 r">path</span>));
                }
            }
            <b>catch</b> (<span class="i">UnauthorizedAccessException</span> <span id="r317 rd" class="r317 r">accessException</span>)
            {
                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r317 r">accessException</span>, <span class="s">&quot;CreateDirectoryUnauthorizedAccessError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#26ba13af79d30a75" class="i field">PermissionDenied</a>, <span class="r305 r">path</span>));
            }
        }
 
        <b>private bool</b> <a id="c9f70ab2695bd382" href="../R/c9f70ab2695bd382.html" target="n" data-glyph="76,1" class="i method">CreateIntermediateDirectories</a>(<b>string</b> <span id="r318 rd" class="r318 r">path</span>)
        {
            <b>bool</b> <span id="r319 rd" class="r319 r">result</span> = <b>false</b>;
 
            <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r318 r">path</span>))
            {
                <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../utils/MshTraceSource.cs.html#fed5f40dc0075d41" class="i method">NewArgumentException</a>(<b>nameof</b>(<span class="r318 r">path</span>));
            }
 
            <b>try</b>
            {
                <span class="c">// Push the paths of the missing directories onto a stack such that the highest missing</span>
                <span class="c">// parent in the tree is at the top of the stack.</span>
                <span class="i">Stack</span>&lt;<b>string</b>&gt; <span id="r320 rd" class="r320 r">missingDirectories</span> = <b>new</b> <span class="i">Stack</span>&lt;<b>string</b>&gt;();
 
                <b>string</b> <span id="r321 rd" class="r321 r">previousParent</span> = <span class="r318 r">path</span>;
 
                <b>do</b>
                {
                    <b>string</b> <span id="r322 rd" class="r322 r">root</span> = <b>string</b>.<span class="i">Empty</span>;
 
                    <b>if</b> (<a href="ProviderBase.cs.html#bf1d5d8dfd4808db" class="i property">PSDriveInfo</a> != <b>null</b>)
                    {
                        <span class="r322 r">root</span> = <a href="ProviderBase.cs.html#bf1d5d8dfd4808db" class="i property">PSDriveInfo</a>.<a href="../engine/DataStoreAdapter.cs.html#6c8f4db73167e8f9" class="i property">Root</a>;
                    }
 
                    <b>string</b> <span id="r323 rd" class="r323 r">parentPath</span> = <a href="#f3d047f7aa5be4e6" class="i method">GetParentPath</a>(<span class="r318 r">path</span>, <span class="r322 r">root</span>);
 
                    <b>if</b> (!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r323 r">parentPath</span>) &amp;&amp;
                        !<b>string</b>.<span class="i">Equals</span>(
                            <span class="r323 r">parentPath</span>,
                            <span class="r321 r">previousParent</span>,
                            <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
                    {
                        <b>if</b> (!<a href="#eaf4c5f09f546f86" class="i method">ItemExists</a>(<span class="r323 r">parentPath</span>))
                        {
                            <span class="r320 r">missingDirectories</span>.<span class="i">Push</span>(<span class="r323 r">parentPath</span>);
                        }
                        <b>else</b>
                        {
                            <b>break</b>;
                        }
                    }
                    <b>else</b>
                    {
                        <b>break</b>;
                    }
 
                    <span class="r321 r">previousParent</span> = <span class="r323 r">parentPath</span>;
                } <b>while</b> (!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r321 r">previousParent</span>));
 
                <span class="c">// Now create the missing directories</span>
                <b>foreach</b> (<b>string</b> <span id="r324 rd" class="r324 r">directoryPath</span> <b>in</b> <span class="r320 r">missingDirectories</span>)
                {
                    <a href="#8ee1f3e6ca6489ce" class="i method">CreateDirectory</a>(<span class="r324 r">directoryPath</span>, <b>false</b>);
                }
 
                <span class="r319 r">result</span> = <b>true</b>;
            }
            <b>catch</b> (<span class="i">ArgumentException</span> <span id="r325 rd" class="r325 r">argException</span>)
            {
                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r325 r">argException</span>, <span class="s">&quot;CreateIntermediateDirectoriesArgumentError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#846d2b572f2c4820" class="i field">InvalidArgument</a>, <span class="r318 r">path</span>));
            }
            <b>catch</b> (<span class="i">IOException</span> <span id="r326 rd" class="r326 r">ioException</span>)
            {
                <span class="c">// IOException contains specific message about the error occurred and so no need for errordetails.</span>
                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r326 r">ioException</span>, <span class="s">&quot;CreateIntermediateDirectoriesIOError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#0c2f4b9c74e5b7c2" class="i field">WriteError</a>, <span class="r318 r">path</span>));
            }
            <b>catch</b> (<span class="i">UnauthorizedAccessException</span> <span id="r327 rd" class="r327 r">accessException</span>)
            {
                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r327 r">accessException</span>, <span class="s">&quot;CreateIntermediateDirectoriesUnauthorizedAccessError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#26ba13af79d30a75" class="i field">PermissionDenied</a>, <span class="r318 r">path</span>));
            }
 
            <b>return</b> <span class="r319 r">result</span>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> NewItem
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> RemoveItem
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Removes the specified file or directory.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r328 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The full path to the file or directory to be removed.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r329 r">recurse</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Specifies if the operation should also remove child items.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">System</span>.<span class="i">ArgumentException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">     path is null or empty.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>protected override void</b> <a id="88c47f0161da7080" href="../R/88c47f0161da7080.html" target="n" data-glyph="75,1" class="i method">RemoveItem</a>(<b>string</b> <span id="r328 rd" class="r328 r">path</span>, <b>bool</b> <span id="r329 rd" class="r329 r">recurse</span>)
        {
            <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r328 r">path</span>))
            {
                <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../utils/MshTraceSource.cs.html#fed5f40dc0075d41" class="i method">NewArgumentException</a>(<b>nameof</b>(<span class="r328 r">path</span>));
            }
 
            <b>try</b>
            {
                <span class="r328 r">path</span> = <a href="#2679b47e3c6ebedc" class="i method">NormalizePath</a>(<span class="r328 r">path</span>);
 
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">UNIX</span>
                <b>bool</b> <span id="r330 rd" class="r330 r">removeStreams</span> = <b>false</b>;
                <a href="#bca4e55a4c7ee955" class="t t">FileSystemProviderRemoveItemDynamicParameters</a> <span id="r331 rd" class="r331 r">dynamicParameters</span> = <b>null</b>;
 
                <b>if</b> (<a href="ProviderBase.cs.html#57d60aa2d2bc908d" class="i property">DynamicParameters</a> != <b>null</b>)
                {
                    <span class="r331 r">dynamicParameters</span> = <a href="ProviderBase.cs.html#57d60aa2d2bc908d" class="i property">DynamicParameters</a> <b>as</b> <a href="#bca4e55a4c7ee955" class="t t">FileSystemProviderRemoveItemDynamicParameters</a>;
                    <b>if</b> (<span class="r331 r">dynamicParameters</span> != <b>null</b>)
                    {
                        <b>if</b> ((<span class="r331 r">dynamicParameters</span>.<a href="#a2b126b2711295e3" class="i property">Stream</a> != <b>null</b>) &amp;&amp; (<span class="r331 r">dynamicParameters</span>.<a href="#a2b126b2711295e3" class="i property">Stream</a>.<span class="i">Length</span> &gt; 0))
                        {
                            <span class="r330 r">removeStreams</span> = <b>true</b>;
                        }
                        <b>else</b>
                        {
                            <span class="c">// See if they&#39;ve used the inline stream syntax. They have more than one colon.</span>
                            <b>int</b> <span id="r332 rd" class="r332 r">firstColon</span> = <span class="r328 r">path</span>.<span class="i">IndexOf</span>(<span class="s">&#39;:&#39;</span>);
                            <b>int</b> <span id="r333 rd" class="r333 r">secondColon</span> = <span class="r328 r">path</span>.<span class="i">IndexOf</span>(<span class="s">&#39;:&#39;</span>, <span class="r332 r">firstColon</span> + 1);
                            <b>if</b> (<span class="r333 r">secondColon</span> &gt; 0)
                            {
                                <b>string</b> <span id="r334 rd" class="r334 r">streamName</span> = <span class="r328 r">path</span>.<span class="i">Substring</span>(<span class="r333 r">secondColon</span> + 1);
                                <span class="r328 r">path</span> = <span class="r328 r">path</span>.<span class="i">Remove</span>(<span class="r333 r">secondColon</span>);
 
                                <span class="r330 r">removeStreams</span> = <b>true</b>;
                                <span class="r331 r">dynamicParameters</span> = <b>new</b> <span class="t">FileSystemProviderRemoveItemDynamicParameters</span>();
                                <span class="r331 r">dynamicParameters</span>.<a href="#a2b126b2711295e3" class="i property">Stream</a> = <b>new</b> <b>string</b>[] { <span class="r334 r">streamName</span> };
                            }
                        }
                    }
                }
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
 
                <span class="i">FileSystemInfo</span> <span id="r335 rd" class="r335 r">fsinfo</span> = <a href="#03417d6757ea1d51" class="i method">GetFileSystemInfo</a>(<span class="r328 r">path</span>, <b>out bool</b> <span id="r336 rd" class="r336 r">iscontainer</span>);
                <b>if</b> (<span class="r335 r">fsinfo</span> == <b>null</b>)
                {
                    <b>string</b> <span id="r337 rd" class="r337 r">error</span> = <a href="../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">FileSystemProviderStrings</span>.<span class="i">ItemDoesNotExist</span>, <span class="r328 r">path</span>);
                    <span class="i">Exception</span> <span id="r338 rd" class="r338 r">e</span> = <b>new</b> <span class="i">IOException</span>(<span class="r337 r">error</span>);
                    <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <a href="../engine/ErrorPackage.cs.html#e9334565e5136f43" class="t constructor">ErrorRecord</a>(<span class="r338 r">e</span>, <span class="s">&quot;ItemDoesNotExist&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#9a72a7d3051ac7c5" class="i field">ObjectNotFound</a>, <span class="r328 r">path</span>));
                    <b>return</b>;
                }
 
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">UNIX</span>
<span class="e">                if (iscontainer)
                {
                    RemoveDirectoryInfoItem((DirectoryInfo)fsinfo, recurse, Force, true);
                }
                else
                {
                    RemoveFileInfoItem((FileInfo)fsinfo, Force);
                }
</span><span class="k preprocess">#</span><span class="k preprocess">else</span>
                <b>if</b> ((!<span class="r330 r">removeStreams</span>) &amp;&amp; <span class="r336 r">iscontainer</span>)
                {
                    <a href="#e017efc53a06cd45" class="i method">RemoveDirectoryInfoItem</a>((<span class="i">DirectoryInfo</span>)<span class="r335 r">fsinfo</span>, <span class="r329 r">recurse</span>, <a href="ProviderBase.cs.html#e3c4d51f13fbfcaa" class="i property">Force</a>, <b>true</b>);
                }
                <b>else</b>
                {
                    <span class="c">// If we want to remove the file streams, retrieve them and remove them.</span>
                    <b>if</b> (<span class="r330 r">removeStreams</span>)
                    {
                        <b>foreach</b> (<b>string</b> <span id="r339 rd" class="r339 r">desiredStream</span> <b>in</b> <span class="r331 r">dynamicParameters</span>.<a href="#a2b126b2711295e3" class="i property">Stream</a>)
                        {
                            <span class="c">// See that it matches the name specified</span>
                            <a href="../engine/regex.cs.html#d450e739ff28e660" class="t t">WildcardPattern</a> <span id="r340 rd" class="r340 r">p</span> = <a href="../engine/regex.cs.html#d450e739ff28e660" class="t t">WildcardPattern</a>.<a href="../engine/regex.cs.html#03cc3ceece086129" class="i method">Get</a>(<span class="r339 r">desiredStream</span>, <a href="../engine/regex.cs.html#4e788ab2470b3632" class="t t">WildcardOptions</a>.<a href="../engine/regex.cs.html#2d0521a6986208d3" class="i field">IgnoreCase</a> | <a href="../engine/regex.cs.html#4e788ab2470b3632" class="t t">WildcardOptions</a>.<a href="../engine/regex.cs.html#c83c96a47a1cc99d" class="i field">CultureInvariant</a>);
                            <b>bool</b> <span id="r341 rd" class="r341 r">foundStream</span> = <b>false</b>;
 
                            <b>foreach</b> (<a href="#bed6b027cd443111" class="t t">AlternateStreamData</a> <span id="r342 rd" class="r342 r">stream</span> <b>in</b> <a href="#28276e8c322107d7" class="t t">AlternateDataStreamUtilities</a>.<span class="i">GetStreams</span>(<span class="r335 r">fsinfo</span>.<span class="i">FullName</span>))
                            {
                                <b>if</b> (!<span class="r340 r">p</span>.<a href="../engine/regex.cs.html#02e7d1c913f3c256" class="i method">IsMatch</a>(<span class="r342 r">stream</span>.<a href="#74a4aa230d954592" class="i property">Stream</a>)) { <b>continue</b>; }
 
                                <span class="r341 r">foundStream</span> = <b>true</b>;
 
                                <b>string</b> <span id="r343 rd" class="r343 r">action</span> = <b>string</b>.<span class="i">Format</span>(
                                    <span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>,
                                    <span class="i">FileSystemProviderStrings</span>.<span class="i">StreamAction</span>,
                                    <span class="r342 r">stream</span>.<a href="#74a4aa230d954592" class="i property">Stream</a>, <span class="r335 r">fsinfo</span>.<span class="i">FullName</span>);
                                <b>if</b> (<a href="ProviderBase.cs.html#11c40eac9520b247" class="i method">ShouldProcess</a>(<span class="r343 r">action</span>))
                                {
                                    <a href="#28276e8c322107d7" class="t t">AlternateDataStreamUtilities</a>.<span class="i">DeleteFileStream</span>(<span class="r335 r">fsinfo</span>.<span class="i">FullName</span>, <span class="r342 r">stream</span>.<a href="#74a4aa230d954592" class="i property">Stream</a>);
                                }
                            }
 
                            <b>if</b> ((!<a href="../engine/regex.cs.html#d450e739ff28e660" class="t t">WildcardPattern</a>.<a href="../engine/regex.cs.html#f9cf207fdd565080" class="i method">ContainsWildcardCharacters</a>(<span class="r339 r">desiredStream</span>)) &amp;&amp; (!<span class="r341 r">foundStream</span>))
                            {
                                <b>string</b> <span id="r344 rd" class="r344 r">errorMessage</span> = <a href="../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(
                                    <span class="i">FileSystemProviderStrings</span>.<span class="i">AlternateDataStreamNotFound</span>, <span class="r339 r">desiredStream</span>, <span class="r335 r">fsinfo</span>.<span class="i">FullName</span>);
                                <span class="i">Exception</span> <span id="r345 rd" class="r345 r">e</span> = <b>new</b> <span class="i">FileNotFoundException</span>(<span class="r344 r">errorMessage</span>, <span class="r335 r">fsinfo</span>.<span class="i">FullName</span>);
 
                                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <a href="../engine/ErrorPackage.cs.html#e9334565e5136f43" class="t constructor">ErrorRecord</a>(
                                    <span class="r345 r">e</span>,
                                    <span class="s">&quot;AlternateDataStreamNotFound&quot;</span>,
                                    <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#9a72a7d3051ac7c5" class="i field">ObjectNotFound</a>,
                                    <span class="r328 r">path</span>));
                            }
                        }
                    }
                    <b>else</b>
                    {
                        <a href="#b27c2b5544cbba65" class="i method">RemoveFileInfoItem</a>((<span class="i">FileInfo</span>)<span class="r335 r">fsinfo</span>, <a href="ProviderBase.cs.html#e3c4d51f13fbfcaa" class="i property">Force</a>);
                    }
                }
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
            }
            <b>catch</b> (<span class="i">IOException</span> <span id="r346 rd" class="r346 r">exception</span>)
            {
                <span class="c">// IOException contains specific message about the error occurred and so no need for errordetails.</span>
                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r346 r">exception</span>, <span class="s">&quot;RemoveItemIOError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#0c2f4b9c74e5b7c2" class="i field">WriteError</a>, <span class="r328 r">path</span>));
            }
            <b>catch</b> (<span class="i">UnauthorizedAccessException</span> <span id="r347 rd" class="r347 r">accessException</span>)
            {
                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r347 r">accessException</span>, <span class="s">&quot;RemoveItemUnauthorizedAccessError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#26ba13af79d30a75" class="i field">PermissionDenied</a>, <span class="r328 r">path</span>));
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Retrieves the dynamic parameters required for the Remove-Item cmdlet.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r348 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The path of the file to process.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r349 r">recurse</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Whether to recurse into containers.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">An instance of the FileSystemProviderRemoveItemDynamicParameters class that represents the dynamic parameters.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>protected override object</b> <a id="cd9cc6b309d742cf" href="../R/cd9cc6b309d742cf.html" target="n" data-glyph="75,1" class="i method">RemoveItemDynamicParameters</a>(<b>string</b> <span id="r348 rd" class="r348 r">path</span>, <b>bool</b> <span id="r349 rd" class="r349 r">recurse</span>)
        {
            <b>if</b> (!<span class="r349 r">recurse</span>)
            {
                <b>return</b> <b>new</b> <span class="t">FileSystemProviderRemoveItemDynamicParameters</span>();
            }
            <b>else</b>
            {
                <b>return</b> <b>null</b>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Removes a directory from the file system.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r350 r">directory</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The DirectoryInfo object representing the directory to be removed.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r351 r">recurse</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If true, ShouldProcess will be called for each item in the subtree.</span>
        <span class="c">///</span><span class="c"> If false, ShouldProcess will only be called for the directory item.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r352 r">force</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If true, attempts to modify the file attributes in case of a failure so that</span>
        <span class="c">///</span><span class="c"> the file can be removed.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r353 r">rootOfRemoval</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> True if the DirectoryInfo being passed in is the root of the tree being removed.</span>
        <span class="c">///</span><span class="c"> ShouldProcess will be called if this is true or if recurse is true.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>private void</b> <a id="e017efc53a06cd45" href="../R/e017efc53a06cd45.html" target="n" data-glyph="76,1" class="i method">RemoveDirectoryInfoItem</a>(<span class="i">DirectoryInfo</span> <span id="r350 rd" class="r350 r">directory</span>, <b>bool</b> <span id="r351 rd" class="r351 r">recurse</span>, <b>bool</b> <span id="r352 rd" class="r352 r">force</span>, <b>bool</b> <span id="r353 rd" class="r353 r">rootOfRemoval</span>)
        {
            <span class="i n">Dbg</span>.<a href="../utils/assert.cs.html#c04955255430d32f" class="t t">Diagnostics</a>.<a href="../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r350 r">directory</span> != <b>null</b>, <span class="s">&quot;Caller should always check directory&quot;</span>);
 
            <b>bool</b> <span id="r354 rd" class="r354 r">continueRemoval</span> = <b>true</b>;
 
            <span class="c">// We only want to confirm the removal if this is the root of the</span>
            <span class="c">// tree being removed or the recurse flag is specified.</span>
            <b>if</b> (<span class="r353 r">rootOfRemoval</span> || <span class="r351 r">recurse</span>)
            {
                <span class="c">// Confirm the user wants to remove the directory</span>
                <b>string</b> <span id="r355 rd" class="r355 r">action</span> = <span class="i">FileSystemProviderStrings</span>.<span class="i">RemoveItemActionDirectory</span>;
                <span class="r354 r">continueRemoval</span> = <span class="i">ShouldProcess</span>(<span class="r350 r">directory</span>.<span class="i">FullName</span>, <span class="r355 r">action</span>);
            }
 
            <b>if</b> (<a href="#916c1750999d4e10" class="t t">InternalSymbolicLinkLinkCodeMethods</a>.<span class="i">IsReparsePointLikeSymlink</span>(<span class="r350 r">directory</span>))
            {
                <b>void</b> <a id="e012eab55174e61e" href="../R/../../0000000000.html" target="n" data-glyph="76,2" class="i method">WriteErrorHelper</a>(<span class="i">Exception</span> <span id="r356 rd" class="r356 r">exception</span>)
                {
                    <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r356 r">exception</span>, <span class="i">errorId</span>: <span class="s">&quot;DeleteSymbolicLinkFailed&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#0c2f4b9c74e5b7c2" class="i field">WriteError</a>, <span class="r350 r">directory</span>));
                }
 
                <b>try</b>
                {
                    <b>if</b> (<a href="../engine/Utils.cs.html#f365eaa75311eda0" class="t t">InternalTestHooks</a>.<a href="../engine/Utils.cs.html#9f1ecef5221b3e20" class="i field">OneDriveTestOn</a>)
                    {
                        <span class="i">WriteErrorHelper</span>(<b>new</b> <span class="i">IOException</span>());
                        <b>return</b>;
                    }
                    <b>else</b>
                    {
                        <span class="c">// Name surrogates should just be detached.</span>
                        <span class="r350 r">directory</span>.<span class="i">Delete</span>();
                    }
                }
                <b>catch</b> (<span class="i">Exception</span> <span id="r357 rd" class="r357 r">e</span>)
                {
                    <b>string</b> <span id="r358 rd" class="r358 r">error</span> = <a href="../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">FileSystemProviderStrings</span>.<span class="i">CannotRemoveItem</span>, <span class="r350 r">directory</span>.<span class="i">FullName</span>, <span class="r357 r">e</span>.<span class="i">Message</span>);
                    <b>var</b> <span id="r359 rd" class="r359 r">exception</span> = <b>new</b> <span class="i">IOException</span>(<span class="r358 r">error</span>, <span class="r357 r">e</span>);
                    <span class="i">WriteErrorHelper</span>(<span class="r359 r">exception</span>);
                }
 
                <b>return</b>;
            }
 
            <b>if</b> (<span class="r354 r">continueRemoval</span>)
            {
                <span class="c">// Loop through each of the contained directories and recurse into them for</span>
                <span class="c">// removal.</span>
                <b>foreach</b> (<span class="i">DirectoryInfo</span> <span id="r360 rd" class="r360 r">childDir</span> <b>in</b> <span class="r350 r">directory</span>.<span class="i">EnumerateDirectories</span>())
                {
                    <span class="c">// Making sure to obey the StopProcessing.</span>
                    <b>if</b> (<a href="ProviderBase.cs.html#7f198513b75d23b5" class="i property">Stopping</a>)
                    {
                        <b>return</b>;
                    }
 
                    <b>if</b> (<span class="r360 r">childDir</span> != <b>null</b>)
                    {
                        <a href="#e017efc53a06cd45" class="i method">RemoveDirectoryInfoItem</a>(<span class="r360 r">childDir</span>, <span class="r351 r">recurse</span>, <span class="r352 r">force</span>, <b>false</b>);
                    }
                }
 
                <span class="c">// Loop through each of the contained files and remove them.</span>
                <span class="i">IEnumerable</span>&lt;<span class="i">FileInfo</span>&gt; <span id="r361 rd" class="r361 r">files</span> = <b>null</b>;
 
                <b>if</b> (!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<a href="ProviderBase.cs.html#ef76826218eaf5e1" class="i property">Filter</a>))
                {
                    <span class="r361 r">files</span> = <span class="r350 r">directory</span>.<span class="i">EnumerateFiles</span>(<a href="ProviderBase.cs.html#ef76826218eaf5e1" class="i property">Filter</a>);
                }
                <b>else</b>
                {
                    <span class="r361 r">files</span> = <span class="r350 r">directory</span>.<span class="i">EnumerateFiles</span>();
                }
 
                <b>foreach</b> (<span class="i">FileInfo</span> <span id="r362 rd" class="r362 r">file</span> <b>in</b> <span class="r361 r">files</span>)
                {
                    <span class="c">// Making sure to obey the StopProcessing.</span>
                    <b>if</b> (<a href="ProviderBase.cs.html#7f198513b75d23b5" class="i property">Stopping</a>)
                    {
                        <b>return</b>;
                    }
 
                    <b>if</b> (<span class="r362 r">file</span> != <b>null</b>)
                    {
                        <b>if</b> (<span class="r351 r">recurse</span>)
                        {
                            <span class="c">// When recurse is specified we need to confirm each</span>
                            <span class="c">// item before removal.</span>
                            <a href="#b27c2b5544cbba65" class="i method">RemoveFileInfoItem</a>(<span class="r362 r">file</span>, <span class="r352 r">force</span>);
                        }
                        <b>else</b>
                        {
                            <span class="c">// When recurse is not specified just delete all the</span>
                            <span class="c">// subitems without confirming with the user.</span>
                            <span class="i">RemoveFileSystemItem</span>(<span class="r362 r">file</span>, <span class="r352 r">force</span>);
                        }
                    }
                }
 
                <span class="c">// Check to see if the item has children</span>
                <b>bool</b> <span id="r363 rd" class="r363 r">hasChildren</span> = <a href="#311536e1beab722a" class="i method">DirectoryInfoHasChildItems</a>(<span class="r350 r">directory</span>);
 
                <b>if</b> (<span class="r363 r">hasChildren</span> &amp;&amp; !<span class="r352 r">force</span>)
                {
                    <b>string</b> <span id="r364 rd" class="r364 r">error</span> = <a href="../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">FileSystemProviderStrings</span>.<span class="i">DirectoryNotEmpty</span>, <span class="r350 r">directory</span>.<span class="i">FullName</span>);
                    <span class="i">Exception</span> <span id="r365 rd" class="r365 r">e</span> = <b>new</b> <span class="i">IOException</span>(<span class="r364 r">error</span>);
                    <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r365 r">e</span>, <span class="s">&quot;DirectoryNotEmpty&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#0c2f4b9c74e5b7c2" class="i field">WriteError</a>, <span class="r350 r">directory</span>));
                }
                <b>else</b> <span class="c">// !hasChildren || force</span>
                {
                    <span class="c">// Finally, remove the directory</span>
                    <span class="i">RemoveFileSystemItem</span>(<span class="r350 r">directory</span>, <span class="r352 r">force</span>);
                }
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Removes a file from the file system.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r366 r">file</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The FileInfo object representing the file to be removed.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r367 r">force</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If true, attempts to modify the file attributes in case of a failure so that</span>
        <span class="c">///</span><span class="c"> the file can be removed.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>private void</b> <a id="b27c2b5544cbba65" href="../R/b27c2b5544cbba65.html" target="n" data-glyph="76,1" class="i method">RemoveFileInfoItem</a>(<span class="i">FileInfo</span> <span id="r366 rd" class="r366 r">file</span>, <b>bool</b> <span id="r367 rd" class="r367 r">force</span>)
        {
            <span class="i n">Dbg</span>.<a href="../utils/assert.cs.html#c04955255430d32f" class="t t">Diagnostics</a>.<a href="../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(
                <span class="r366 r">file</span> != <b>null</b>,
                <span class="s">&quot;Caller should always check file&quot;</span>);
 
            <b>string</b> <span id="r368 rd" class="r368 r">action</span> = <span class="i">FileSystemProviderStrings</span>.<span class="i">RemoveItemActionFile</span>;
 
            <b>if</b> (<span class="i">ShouldProcess</span>(<span class="r366 r">file</span>.<span class="i">FullName</span>, <span class="r368 r">action</span>))
            {
                <span class="i">RemoveFileSystemItem</span>(<span class="r366 r">file</span>, <span class="r367 r">force</span>);
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Removes the file system object from the file system.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r369 r">fileSystemInfo</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The FileSystemInfo object representing the file or directory to be removed.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r370 r">force</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If true, the readonly and hidden attributes will be masked off in the case of</span>
        <span class="c">///</span><span class="c"> an error, and the removal will be attempted again. If false, exceptions are</span>
        <span class="c">///</span><span class="c"> written to the error pipeline.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>private void</b> <a id="2fa8bd44384a2c31" href="../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">RemoveFileSystemItem</a>(<span class="i">FileSystemInfo</span> <span id="r369 rd" class="r369 r">fileSystemInfo</span>, <b>bool</b> <span id="r370 rd" class="r370 r">force</span>)
        {
            <span class="i n">Dbg</span>.<a href="../utils/assert.cs.html#c04955255430d32f" class="t t">Diagnostics</a>.<a href="../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(
                <span class="r369 r">fileSystemInfo</span> != <b>null</b>,
                <span class="s">&quot;Caller should always check fileSystemInfo&quot;</span>);
 
            <span class="c">// First check if we can delete this file when force is not specified.</span>
            <b>if</b> (!<a href="ProviderBase.cs.html#e3c4d51f13fbfcaa" class="i property">Force</a> &amp;&amp;
                (<span class="r369 r">fileSystemInfo</span>.<span class="i">Attributes</span> &amp; (<span class="i">FileAttributes</span>.<span class="i">Hidden</span> | <span class="i">FileAttributes</span>.<span class="i">System</span> | <span class="i">FileAttributes</span>.<span class="i">ReadOnly</span>)) != 0)
            {
                <b>string</b> <span id="r371 rd" class="r371 r">error</span> = <a href="../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">FileSystemProviderStrings</span>.<span class="i">PermissionError</span>);
                <span class="i">Exception</span> <span id="r372 rd" class="r372 r">e</span> = <b>new</b> <span class="i">IOException</span>(<span class="r371 r">error</span>);
 
                <a href="../engine/ErrorPackage.cs.html#d882fa1d2308673f" class="t t">ErrorDetails</a> <span id="r373 rd" class="r373 r">errorDetails</span> =
                    <b>new</b> <span class="t">ErrorDetails</span>(<a href="../P/64a92af39f1cd630.html#64a92af39f1cd630" class="k">this</a>, <span class="s">&quot;FileSystemProviderStrings&quot;</span>,
                        <span class="s">&quot;CannotRemoveItem&quot;</span>,
                        <span class="r369 r">fileSystemInfo</span>.<span class="i">FullName</span>,
                        <span class="r372 r">e</span>.<span class="i">Message</span>);
 
                <a href="../engine/ErrorPackage.cs.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r374 rd" class="r374 r">errorRecord</span> = <b>new</b> <span class="t">ErrorRecord</span>(<span class="r372 r">e</span>, <span class="s">&quot;RemoveFileSystemItemUnAuthorizedAccess&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#26ba13af79d30a75" class="i field">PermissionDenied</a>, <span class="r369 r">fileSystemInfo</span>);
                <span class="r374 r">errorRecord</span>.<a href="../engine/ErrorPackage.cs.html#4e9df045b6372ce0" class="i property">ErrorDetails</a> = <span class="r373 r">errorDetails</span>;
 
                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<span class="r374 r">errorRecord</span>);
                <b>return</b>;
            }
 
            <span class="c">// Store the old attributes in case we fail to delete</span>
            <span class="i">FileAttributes</span> <span id="r375 rd" class="r375 r">oldAttributes</span> = <span class="r369 r">fileSystemInfo</span>.<span class="i">Attributes</span>;
            <b>bool</b> <span id="r376 rd" class="r376 r">attributeRecoveryRequired</span> = <b>false</b>;
 
            <b>try</b>
            {
                <span class="c">// Try to delete the item.  Strip any problematic attributes</span>
                <span class="c">// if they&#39;ve specified force.</span>
                <b>if</b> (<span class="r370 r">force</span>)
                {
                    <span class="r369 r">fileSystemInfo</span>.<span class="i">Attributes</span> &amp;= ~(<span class="i">FileAttributes</span>.<span class="i">Hidden</span> | <span class="i">FileAttributes</span>.<span class="i">ReadOnly</span> | <span class="i">FileAttributes</span>.<span class="i">System</span>);
                    <span class="r376 r">attributeRecoveryRequired</span> = <b>true</b>;
                }
 
                <span class="r369 r">fileSystemInfo</span>.<span class="i">Delete</span>();
 
                <b>if</b> (<span class="r370 r">force</span>)
                {
                    <span class="r376 r">attributeRecoveryRequired</span> = <b>false</b>;
                }
            }
            <b>catch</b> (<span class="i">Exception</span> <span id="r377 rd" class="r377 r">fsException</span>)
            {
                <a href="../engine/ErrorPackage.cs.html#d882fa1d2308673f" class="t t">ErrorDetails</a> <span id="r378 rd" class="r378 r">errorDetails</span> =
                    <b>new</b> <span class="t">ErrorDetails</span>(<a href="../P/64a92af39f1cd630.html#64a92af39f1cd630" class="k">this</a>, <span class="s">&quot;FileSystemProviderStrings&quot;</span>,
                        <span class="s">&quot;CannotRemoveItem&quot;</span>,
                        <span class="r369 r">fileSystemInfo</span>.<span class="i">FullName</span>,
                        <span class="r377 r">fsException</span>.<span class="i">Message</span>);
 
                <b>if</b> ((<span class="r377 r">fsException</span> <b>is</b> <span class="i n">System</span>.<span class="i">Security</span>.<span class="i">SecurityException</span>) ||
                    (<span class="r377 r">fsException</span> <b>is</b> <span class="i">UnauthorizedAccessException</span>))
                {
                    <a href="../engine/ErrorPackage.cs.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r379 rd" class="r379 r">errorRecord</span> = <b>new</b> <span class="t">ErrorRecord</span>(<span class="r377 r">fsException</span>, <span class="s">&quot;RemoveFileSystemItemUnAuthorizedAccess&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#26ba13af79d30a75" class="i field">PermissionDenied</a>, <span class="r369 r">fileSystemInfo</span>);
                    <span class="r379 r">errorRecord</span>.<a href="../engine/ErrorPackage.cs.html#4e9df045b6372ce0" class="i property">ErrorDetails</a> = <span class="r378 r">errorDetails</span>;
 
                    <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<span class="r379 r">errorRecord</span>);
                }
                <b>else</b> <b>if</b> (<span class="r377 r">fsException</span> <b>is</b> <span class="i">ArgumentException</span>)
                {
                    <a href="../engine/ErrorPackage.cs.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r380 rd" class="r380 r">errorRecord</span> = <b>new</b> <span class="t">ErrorRecord</span>(<span class="r377 r">fsException</span>, <span class="s">&quot;RemoveFileSystemItemArgumentError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#846d2b572f2c4820" class="i field">InvalidArgument</a>, <span class="r369 r">fileSystemInfo</span>);
                    <span class="r380 r">errorRecord</span>.<a href="../engine/ErrorPackage.cs.html#4e9df045b6372ce0" class="i property">ErrorDetails</a> = <span class="r378 r">errorDetails</span>;
 
                    <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<span class="r380 r">errorRecord</span>);
                }
                <b>else</b> <b>if</b> ((<span class="r377 r">fsException</span> <b>is</b> <span class="i">IOException</span>) ||
                    (<span class="r377 r">fsException</span> <b>is</b> <span class="i">FileNotFoundException</span>) ||
                    (<span class="r377 r">fsException</span> <b>is</b> <span class="i">DirectoryNotFoundException</span>))
                {
                    <a href="../engine/ErrorPackage.cs.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r381 rd" class="r381 r">errorRecord</span> = <b>new</b> <span class="t">ErrorRecord</span>(<span class="r377 r">fsException</span>, <span class="s">&quot;RemoveFileSystemItemIOError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#0c2f4b9c74e5b7c2" class="i field">WriteError</a>, <span class="r369 r">fileSystemInfo</span>);
                    <span class="r381 r">errorRecord</span>.<a href="../engine/ErrorPackage.cs.html#4e9df045b6372ce0" class="i property">ErrorDetails</a> = <span class="r378 r">errorDetails</span>;
 
                    <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<span class="r381 r">errorRecord</span>);
                }
                <b>else</b>
                {
                    <b>throw</b>;
                }
            }
            <b>finally</b>
            {
                <b>if</b> (<span class="r376 r">attributeRecoveryRequired</span>)
                {
                    <b>try</b>
                    {
                        <b>if</b> (<span class="r369 r">fileSystemInfo</span>.<span class="i">Exists</span>)
                        {
                            <span class="r369 r">fileSystemInfo</span>.<span class="i">Attributes</span> = <span class="r375 r">oldAttributes</span>;
                        }
                    }
                    <b>catch</b> (<span class="i">Exception</span> <span id="r382 rd" class="r382 r">attributeException</span>)
                    {
                        <b>if</b> ((<span class="r382 r">attributeException</span> <b>is</b> <span class="i n">System</span>.<span class="i">IO</span>.<span class="i">DirectoryNotFoundException</span>) ||
                            (<span class="r382 r">attributeException</span> <b>is</b> <span class="i n">System</span>.<span class="i">Security</span>.<span class="i">SecurityException</span>) ||
                            (<span class="r382 r">attributeException</span> <b>is</b> <span class="i n">System</span>.<span class="i">ArgumentException</span>) ||
                            (<span class="r382 r">attributeException</span> <b>is</b> <span class="i n">System</span>.<span class="i">IO</span>.<span class="i">FileNotFoundException</span>) ||
                            (<span class="r382 r">attributeException</span> <b>is</b> <span class="i n">System</span>.<span class="i">IO</span>.<span class="i">IOException</span>))
                        {
                            <a href="../engine/ErrorPackage.cs.html#d882fa1d2308673f" class="t t">ErrorDetails</a> <span id="r383 rd" class="r383 r">attributeDetails</span> = <b>new</b> <span class="t">ErrorDetails</span>(
                                <a href="../P/64a92af39f1cd630.html#64a92af39f1cd630" class="k">this</a>, <span class="s">&quot;FileSystemProviderStrings&quot;</span>,
                                    <span class="s">&quot;CannotRestoreAttributes&quot;</span>,
                                    <span class="r369 r">fileSystemInfo</span>.<span class="i">FullName</span>,
                                    <span class="r382 r">attributeException</span>.<span class="i">Message</span>);
 
                            <a href="../engine/ErrorPackage.cs.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r384 rd" class="r384 r">errorRecord</span> = <b>new</b> <span class="t">ErrorRecord</span>(<span class="r382 r">attributeException</span>, <span class="s">&quot;RemoveFileSystemItemCannotRestoreAttributes&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#26ba13af79d30a75" class="i field">PermissionDenied</a>, <span class="r369 r">fileSystemInfo</span>);
                            <span class="r384 r">errorRecord</span>.<a href="../engine/ErrorPackage.cs.html#4e9df045b6372ce0" class="i property">ErrorDetails</a> = <span class="r383 r">attributeDetails</span>;
 
                            <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<span class="r384 r">errorRecord</span>);
                        }
                        <b>else</b>
                            <b>throw</b>;
                    }
                }
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> RemoveItem
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> ItemExists
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Determines if a file or directory exists at the specified path.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r385 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The path of the item to check.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> True if a file or directory exists at the specified path, false otherwise.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">System</span>.<span class="i">ArgumentException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">     path is null or empty.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>protected override bool</b> <a id="eaf4c5f09f546f86" href="../R/eaf4c5f09f546f86.html" target="n" data-glyph="75,1" class="i method">ItemExists</a>(<b>string</b> <span id="r385 rd" class="r385 r">path</span>)
        {
            <a href="../engine/ErrorPackage.cs.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r386 rd" class="r386 r">error</span> = <b>null</b>;
            <b>bool</b> <span id="r387 rd" class="r387 r">result</span> = <a href="#5131889761110ea9" class="i method">ItemExists</a>(<span class="r385 r">path</span>, <b>out</b> <span class="r386 r">error</span>);
 
            <b>if</b> (<span class="r386 r">error</span> != <b>null</b>)
            {
                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<span class="r386 r">error</span>);
            }
 
            <b>return</b> <span class="r387 r">result</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Implementation of ItemExists for the provider. This implementation</span>
        <span class="c">///</span><span class="c"> allows the caller to decide if it wants to WriteError or not based</span>
        <span class="c">///</span><span class="c"> on the returned ErrorRecord.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r388 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The path of the object to check</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r389 r">error</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> An error record is returned in this parameter if there was an error.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> True if an object exists at the specified path, false otherwise.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">System</span>.<span class="i">ArgumentException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">     path is null or empty.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>private bool</b> <a id="5131889761110ea9" href="../R/5131889761110ea9.html" target="n" data-glyph="76,1" class="i method">ItemExists</a>(<b>string</b> <span id="r388 rd" class="r388 r">path</span>, <b>out</b> <a href="../engine/ErrorPackage.cs.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r389 rd" class="r389 r">error</span>)
        {
            <span class="r389 r">error</span> = <b>null</b>;
 
            <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r388 r">path</span>))
            {
                <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../utils/MshTraceSource.cs.html#fed5f40dc0075d41" class="i method">NewArgumentException</a>(<b>nameof</b>(<span class="r388 r">path</span>));
            }
 
            <b>bool</b> <span id="r390 rd" class="r390 r">result</span> = <b>false</b>;
 
            <span class="r388 r">path</span> = <a href="#2679b47e3c6ebedc" class="i method">NormalizePath</a>(<span class="r388 r">path</span>);
 
            <b>try</b>
            {
                <b>var</b> <span id="r391 rd" class="r391 r">fsinfo</span> = <a href="#03417d6757ea1d51" class="i method">GetFileSystemInfo</a>(<span class="r388 r">path</span>, <b>out bool _</b>);
                <span class="r390 r">result</span> = <span class="r391 r">fsinfo</span> != <b>null</b>;
 
                <a href="#2102c33332bd089f" class="t t">FileSystemItemProviderDynamicParameters</a> <span id="r392 rd" class="r392 r">itemExistsDynamicParameters</span> =
                    <a href="ProviderBase.cs.html#57d60aa2d2bc908d" class="i property">DynamicParameters</a> <b>as</b> <a href="#2102c33332bd089f" class="t t">FileSystemItemProviderDynamicParameters</a>;
 
                <span class="c">// If the items see if we need to check the age of the file...</span>
                <b>if</b> (<span class="r390 r">result</span> &amp;&amp; <span class="r392 r">itemExistsDynamicParameters</span> != <b>null</b>)
                {
                    <span class="i">DateTime</span> <span id="r393 rd" class="r393 r">lastWriteTime</span> = <span class="r391 r">fsinfo</span>.<span class="i">LastWriteTime</span>;
 
                    <b>if</b> (<span class="r392 r">itemExistsDynamicParameters</span>.<a href="#125b2cac6c5b301c" class="i property">OlderThan</a>.<span class="i">HasValue</span>)
                    {
                        <span class="r390 r">result</span> = <span class="r393 r">lastWriteTime</span> &lt; <span class="r392 r">itemExistsDynamicParameters</span>.<a href="#125b2cac6c5b301c" class="i property">OlderThan</a>.<span class="i">Value</span>;
                    }
 
                    <b>if</b> (<span class="r392 r">itemExistsDynamicParameters</span>.<a href="#1170bc49b0de9637" class="i property">NewerThan</a>.<span class="i">HasValue</span>)
                    {
                        <span class="r390 r">result</span> = <span class="r393 r">lastWriteTime</span> &gt; <span class="r392 r">itemExistsDynamicParameters</span>.<a href="#1170bc49b0de9637" class="i property">NewerThan</a>.<span class="i">Value</span>;
                    }
                }
            }
            <b>catch</b> (<span class="i n">System</span>.<span class="i">Security</span>.<span class="i">SecurityException</span> <span id="r394 rd" class="r394 r">security</span>)
            {
                <span class="r389 r">error</span> = <b>new</b> <span class="t">ErrorRecord</span>(<span class="r394 r">security</span>, <span class="s">&quot;ItemExistsSecurityError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#26ba13af79d30a75" class="i field">PermissionDenied</a>, <span class="r388 r">path</span>);
            }
            <b>catch</b> (<span class="i">ArgumentException</span> <span id="r395 rd" class="r395 r">argument</span>)
            {
                <span class="r389 r">error</span> = <b>new</b> <span class="t">ErrorRecord</span>(<span class="r395 r">argument</span>, <span class="s">&quot;ItemExistsArgumentError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#846d2b572f2c4820" class="i field">InvalidArgument</a>, <span class="r388 r">path</span>);
            }
            <b>catch</b> (<span class="i">UnauthorizedAccessException</span> <span id="r396 rd" class="r396 r">unauthorized</span>)
            {
                <span class="r389 r">error</span> = <b>new</b> <span class="t">ErrorRecord</span>(<span class="r396 r">unauthorized</span>, <span class="s">&quot;ItemExistsUnauthorizedAccessError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#26ba13af79d30a75" class="i field">PermissionDenied</a>, <span class="r388 r">path</span>);
            }
            <b>catch</b> (<span class="i">PathTooLongException</span> <span id="r397 rd" class="r397 r">pathTooLong</span>)
            {
                <span class="r389 r">error</span> = <b>new</b> <span class="t">ErrorRecord</span>(<span class="r397 r">pathTooLong</span>, <span class="s">&quot;ItemExistsPathTooLongError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#846d2b572f2c4820" class="i field">InvalidArgument</a>, <span class="r388 r">path</span>);
            }
            <b>catch</b> (<span class="i">NotSupportedException</span> <span id="r398 rd" class="r398 r">notSupported</span>)
            {
                <span class="r389 r">error</span> = <b>new</b> <span class="t">ErrorRecord</span>(<span class="r398 r">notSupported</span>, <span class="s">&quot;ItemExistsNotSupportedError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#b5cba3d51f976bb3" class="i field">InvalidOperation</a>, <span class="r388 r">path</span>);
            }
 
            <b>return</b> <span class="r390 r">result</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Adds -OlderThan, -NewerThan dynamic properties.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r399 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If the path was specified on the command line, this is the path</span>
        <span class="c">///</span><span class="c"> to the item to get the dynamic parameters for.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Overrides of this method should return an object that has properties and fields decorated with</span>
        <span class="c">///</span><span class="c"> parsing attributes similar to a cmdlet class or a</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="../engine/PseudoParameters.cs.html#d55a14219c7e096c" class="t t">RuntimeDefinedParameterDictionary</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c">.</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> The default implementation returns null. (no additional parameters)</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>protected override object</b> <a id="5beb89bbe2a962e5" href="../R/5beb89bbe2a962e5.html" target="n" data-glyph="75,1" class="i method">ItemExistsDynamicParameters</a>(<b>string</b> <span id="r399 rd" class="r399 r">path</span>)
        {
            <b>using</b> (<a href="../CoreCLR/CorePsStub.cs.html#6d758ac5b09394e4" class="t t">PSTransactionManager</a>.<a href="../CoreCLR/CorePsStub.cs.html#d6d4cf3db02d03bb" class="i method">GetEngineProtectionScope</a>())
            {
                <b>return</b> <b>new</b> <span class="t">FileSystemItemProviderDynamicParameters</span>();
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> ItemExists
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> HasChildItems
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Determines if the given path is a directory, and has children.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r400 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The full path to the directory.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> True if the path refers to a directory that contains other</span>
        <span class="c">///</span><span class="c"> directories or files.  False otherwise.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">System</span>.<span class="i">ArgumentException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">     path is null or empty.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>protected override bool</b> <a id="17a5a3df666f7478" href="../R/17a5a3df666f7478.html" target="n" data-glyph="75,1" class="i method">HasChildItems</a>(<b>string</b> <span id="r400 rd" class="r400 r">path</span>)
        {
            <b>bool</b> <span id="r401 rd" class="r401 r">result</span> = <b>false</b>;
 
            <span class="c">// verify parameters</span>
            <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r400 r">path</span>))
            {
                <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../utils/MshTraceSource.cs.html#fed5f40dc0075d41" class="i method">NewArgumentException</a>(<b>nameof</b>(<span class="r400 r">path</span>));
            }
 
            <span class="r400 r">path</span> = <a href="#2679b47e3c6ebedc" class="i method">NormalizePath</a>(<span class="r400 r">path</span>);
 
            <span class="c">// First check to see if it is a directory</span>
            <b>try</b>
            {
                <span class="i">DirectoryInfo</span> <span id="r402 rd" class="r402 r">directory</span> = <b>new</b> <span class="i">DirectoryInfo</span>(<span class="r400 r">path</span>);
 
                <span class="c">// If the above didn&#39;t throw an exception, check to</span>
                <span class="c">// see if we should proceed and if it contains any children</span>
                <b>if</b> ((<span class="r402 r">directory</span>.<span class="i">Attributes</span> &amp; <span class="i">FileAttributes</span>.<span class="i">Directory</span>) != <span class="i">FileAttributes</span>.<span class="i">Directory</span>)
                    <b>return</b> <b>false</b>;
 
                <span class="r401 r">result</span> = <a href="#311536e1beab722a" class="i method">DirectoryInfoHasChildItems</a>(<span class="r402 r">directory</span>);
            }
            <b>catch</b> (<span class="i">ArgumentNullException</span>)
            {
                <span class="c">// Since we couldn&#39;t convert the path to a DirectoryInfo</span>
                <span class="c">// the path could not be a file system container with</span>
                <span class="c">// children</span>
                <span class="r401 r">result</span> = <b>false</b>;
            }
            <b>catch</b> (<span class="i">ArgumentException</span>)
            {
                <span class="c">// Since we couldn&#39;t convert the path to a DirectoryInfo</span>
                <span class="c">// the path could not be a file system container with</span>
                <span class="c">// children</span>
                <span class="r401 r">result</span> = <b>false</b>;
            }
            <b>catch</b> (<span class="i">UnauthorizedAccessException</span>)
            {
                <span class="c">// Since we couldn&#39;t convert the path to a DirectoryInfo</span>
                <span class="c">// the path could not be a file system container with</span>
                <span class="c">// children</span>
                <span class="r401 r">result</span> = <b>false</b>;
            }
            <b>catch</b> (<span class="i">IOException</span>)
            {
                <span class="c">// Since we couldn&#39;t convert the path to a DirectoryInfo</span>
                <span class="c">// the path could not be a file system container with</span>
                <span class="c">// children</span>
                <span class="r401 r">result</span> = <b>false</b>;
            }
            <b>catch</b> (<span class="i">NotSupportedException</span>)
            {
                <span class="c">// Happens when we try to access an alternate data stream</span>
                <span class="r401 r">result</span> = <b>false</b>;
            }
 
            <b>return</b> <span class="r401 r">result</span>;
        }
 
        <b>private static bool</b> <a id="311536e1beab722a" href="../R/311536e1beab722a.html" target="n" data-glyph="76,1" class="i method">DirectoryInfoHasChildItems</a>(<span class="i">DirectoryInfo</span> <span id="r403 rd" class="r403 r">directory</span>)
        {
            <span class="i n">Dbg</span>.<a href="../utils/assert.cs.html#c04955255430d32f" class="t t">Diagnostics</a>.<a href="../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(
                <span class="r403 r">directory</span> != <b>null</b>,
                <span class="s">&quot;The caller should verify directory.&quot;</span>);
 
            <b>bool</b> <span id="r404 rd" class="r404 r">result</span> = <b>false</b>;
 
            <span class="i">IEnumerable</span>&lt;<span class="i">FileSystemInfo</span>&gt; <span id="r405 rd" class="r405 r">children</span> = <span class="r403 r">directory</span>.<span class="i">EnumerateFileSystemInfos</span>();
 
            <b>if</b> (<span class="r405 r">children</span>.<span class="i">Any</span>())
            {
                <span class="r404 r">result</span> = <b>true</b>;
            }
 
            <b>return</b> <span class="r404 r">result</span>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> HasChildItems
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> CopyItem
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Copies an item at the specified path to the given destination.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r406 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The path of the item to copy.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r407 r">destinationPath</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The path of the destination.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r408 r">recurse</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Specifies if the operation should also copy child items.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">System</span>.<span class="i">ArgumentException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">     path is null or empty.</span>
        <span class="c">///</span><span class="c">     destination path is null or empty.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Nothing.  Copied items are written to the context&#39;s pipeline.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>protected override void</b> <a id="6c3da1d0532fe7f2" href="../R/6c3da1d0532fe7f2.html" target="n" data-glyph="75,1" class="i method">CopyItem</a>(
            <b>string</b> <span id="r406 rd" class="r406 r">path</span>,
            <b>string</b> <span id="r407 rd" class="r407 r">destinationPath</span>,
            <b>bool</b> <span id="r408 rd" class="r408 r">recurse</span>)
        {
            <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r406 r">path</span>))
            {
                <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../utils/MshTraceSource.cs.html#fed5f40dc0075d41" class="i method">NewArgumentException</a>(<b>nameof</b>(<span class="r406 r">path</span>));
            }
 
            <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r407 r">destinationPath</span>))
            {
                <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../utils/MshTraceSource.cs.html#fed5f40dc0075d41" class="i method">NewArgumentException</a>(<b>nameof</b>(<span class="r407 r">destinationPath</span>));
            }
 
            <span class="r406 r">path</span> = <a href="#2679b47e3c6ebedc" class="i method">NormalizePath</a>(<span class="r406 r">path</span>);
            <span class="r407 r">destinationPath</span> = <a href="#2679b47e3c6ebedc" class="i method">NormalizePath</a>(<span class="r407 r">destinationPath</span>);
 
            <a href="../engine/remoting/client/remoterunspaceinfo.cs.html#84e3d9c13d0f2efc" class="t t">PSSession</a> <span id="r409 rd" class="r409 r">fromSession</span> = <b>null</b>;
            <a href="../engine/remoting/client/remoterunspaceinfo.cs.html#84e3d9c13d0f2efc" class="t t">PSSession</a> <span id="r410 rd" class="r410 r">toSession</span> = <b>null</b>;
 
            <a href="#9b19cb6efee111b1" class="t t">CopyItemDynamicParameters</a> <span id="r411 rd" class="r411 r">copyDynamicParameter</span> = <a href="ProviderBase.cs.html#57d60aa2d2bc908d" class="i property">DynamicParameters</a> <b>as</b> <a href="#9b19cb6efee111b1" class="t t">CopyItemDynamicParameters</a>;
 
            <b>if</b> (<span class="r411 r">copyDynamicParameter</span> != <b>null</b>)
            {
                <b>if</b> (<span class="r411 r">copyDynamicParameter</span>.<a href="#90aa7c4771007659" class="i property">FromSession</a> != <b>null</b>)
                {
                    <span class="r409 r">fromSession</span> = <span class="r411 r">copyDynamicParameter</span>.<a href="#90aa7c4771007659" class="i property">FromSession</a>;
                }
                <b>else</b>
                {
                    <span class="r410 r">toSession</span> = <span class="r411 r">copyDynamicParameter</span>.<a href="#748b24596344cba4" class="i property">ToSession</a>;
                }
            }
 
            <a href="#27e7d5cf314c5db2" class="i field">_excludeMatcher</a> = <a href="../engine/SessionStateUtils.cs.html#a64f812795996898" class="t t">SessionStateUtilities</a>.<span class="i">CreateWildcardsFromStrings</span>(<a href="ProviderBase.cs.html#4cba0b24d8402c17" class="i property">Exclude</a>, <a href="../engine/regex.cs.html#4e788ab2470b3632" class="t t">WildcardOptions</a>.<a href="../engine/regex.cs.html#2d0521a6986208d3" class="i field">IgnoreCase</a>);
 
            <span class="c">// if the source and destination path are same (for a local copy) then flag it as error.</span>
            <b>if</b> ((<span class="r410 r">toSession</span> == <b>null</b>) &amp;&amp; (<span class="r409 r">fromSession</span> == <b>null</b>) &amp;&amp; <a href="#916c1750999d4e10" class="t t">InternalSymbolicLinkLinkCodeMethods</a>.<a href="#0b904825e5bba667" class="i method">IsSameFileSystemItem</a>(<span class="r406 r">path</span>, <span class="r407 r">destinationPath</span>))
            {
                <b>string</b> <span id="r412 rd" class="r412 r">error</span> = <a href="../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">FileSystemProviderStrings</span>.<span class="i">CopyError</span>, <span class="r406 r">path</span>);
                <span class="i">Exception</span> <span id="r413 rd" class="r413 r">e</span> = <b>new</b> <span class="i">IOException</span>(<span class="r412 r">error</span>);
                <span class="r413 r">e</span>.<span class="i">Data</span>[<a href="#941facd9edebd126" class="i field">SelfCopyDataKey</a>] = <span class="r407 r">destinationPath</span>;
                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <a href="../engine/ErrorPackage.cs.html#e9334565e5136f43" class="t constructor">ErrorRecord</a>(<span class="r413 r">e</span>, <span class="s">&quot;CopyError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#0c2f4b9c74e5b7c2" class="i field">WriteError</a>, <span class="r406 r">path</span>));
                <b>return</b>;
            }
            <span class="c">// Copy-Item from session</span>
            <b>if</b> (<span class="r409 r">fromSession</span> != <b>null</b>)
            {
                <a href="#fce90bf2162244c5" class="i method">CopyItemFromRemoteSession</a>(<span class="r406 r">path</span>, <span class="r407 r">destinationPath</span>, <span class="r408 r">recurse</span>, <a href="ProviderBase.cs.html#e3c4d51f13fbfcaa" class="i property">Force</a>, <span class="r409 r">fromSession</span>);
            }
            <b>else</b>
            {
                <span class="c">// Copy-Item to session</span>
                <b>if</b> (<span class="r410 r">toSession</span> != <b>null</b>)
                {
                    <b>using</b> (<span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="../engine/hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShell</a> <span id="r414 rd" class="r414 r">ps</span> = <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="../engine/hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShell</a>.<a href="../engine/hostifaces/PowerShell.cs.html#40345bc4625ff918" class="i method">Create</a>())
                    {
                        <span class="r414 r">ps</span>.<a href="../engine/hostifaces/PowerShell.cs.html#ccf57242c9d46642" class="i property">Runspace</a> = <span class="r410 r">toSession</span>.<a href="../engine/remoting/client/remoterunspaceinfo.cs.html#9c20236793fb308a" class="i property">Runspace</a>;
                        <a href="#015ca001ee38d8c5" class="i method">CopyItemLocalOrToSession</a>(<span class="r406 r">path</span>, <span class="r407 r">destinationPath</span>, <span class="r408 r">recurse</span>, <a href="ProviderBase.cs.html#e3c4d51f13fbfcaa" class="i property">Force</a>, <span class="r414 r">ps</span>);
                    }
                }
                <b>else</b> <span class="c">// Copy-Item local</span>
                {
                    <a href="#015ca001ee38d8c5" class="i method">CopyItemLocalOrToSession</a>(<span class="r406 r">path</span>, <span class="r407 r">destinationPath</span>, <span class="r408 r">recurse</span>, <a href="ProviderBase.cs.html#e3c4d51f13fbfcaa" class="i property">Force</a>, <b>null</b>);
                }
            }
 
            <a href="#27e7d5cf314c5db2" class="i field">_excludeMatcher</a>.<span class="i">Clear</span>();
            <a href="#27e7d5cf314c5db2" class="i field">_excludeMatcher</a> = <b>null</b>;
        }
 
        <b>private void</b> <a id="fce90bf2162244c5" href="../R/fce90bf2162244c5.html" target="n" data-glyph="76,1" class="i method">CopyItemFromRemoteSession</a>(<b>string</b> <span id="r415 rd" class="r415 r">path</span>, <b>string</b> <span id="r416 rd" class="r416 r">destinationPath</span>, <b>bool</b> <span id="r417 rd" class="r417 r">recurse</span>, <b>bool</b> <span id="r418 rd" class="r418 r">force</span>, <a href="../engine/remoting/client/remoterunspaceinfo.cs.html#84e3d9c13d0f2efc" class="t t">PSSession</a> <span id="r419 rd" class="r419 r">fromSession</span>)
        {
            <b>using</b> (<span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="../engine/hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShell</a> <span id="r420 rd" class="r420 r">ps</span> = <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="../engine/hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShell</a>.<a href="../engine/hostifaces/PowerShell.cs.html#40345bc4625ff918" class="i method">Create</a>())
            {
                <span class="r420 r">ps</span>.<a href="../engine/hostifaces/PowerShell.cs.html#ccf57242c9d46642" class="i property">Runspace</a> = <span class="r419 r">fromSession</span>.<a href="../engine/remoting/client/remoterunspaceinfo.cs.html#9c20236793fb308a" class="i property">Runspace</a>;
 
                <a href="#9f95e4ea04930b77" class="i method">InitializeFunctionPSCopyFileFromRemoteSession</a>(<span class="r420 r">ps</span>);
 
                <b>try</b>
                {
                    <span class="c">// get info on source</span>
                    <span class="r420 r">ps</span>.<a href="../engine/hostifaces/PowerShell.cs.html#9cc79c297f6cced9" class="i method">AddCommand</a>(<a href="#18b0063a4d2c0d48" class="t t">CopyFileRemoteUtils</a>.<a href="#7768bae509667d9d" class="i field">PSCopyFromSessionHelperName</a>);
                    <span class="r420 r">ps</span>.<a href="../engine/hostifaces/PowerShell.cs.html#40674f99a3618f4b" class="i method">AddParameter</a>(<span class="s">&quot;getPathItems&quot;</span>, <span class="r415 r">path</span>);
 
                    <span class="i">Hashtable</span> <span id="r421 rd" class="r421 r">op</span> = <a href="#0021e65731f91d4b" class="t t">SafeInvokeCommand</a>.<a href="#52932871655c3ffb" class="i method">Invoke</a>(<span class="r420 r">ps</span>, <a href="../P/64a92af39f1cd630.html#64a92af39f1cd630" class="k">this</a>, <b>null</b>);
                    <b>if</b> (<span class="r421 r">op</span> == <b>null</b>)
                    {
                        <span class="i">Exception</span> <span id="r422 rd" class="r422 r">e</span> = <b>new</b> <span class="i">IOException</span>(<b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>, <span class="i">FileSystemProviderStrings</span>.<span class="i">CopyItemRemotelyFailedToReadFile</span>, <span class="r415 r">path</span>));
                        <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <a href="../engine/ErrorPackage.cs.html#e9334565e5136f43" class="t constructor">ErrorRecord</a>(<span class="r422 r">e</span>, <span class="s">&quot;CopyItemRemotelyFailedToReadFile&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#0c2f4b9c74e5b7c2" class="i field">WriteError</a>, <span class="r415 r">path</span>));
                        <b>return</b>;
                    }
 
                    <b>bool</b> <span id="r423 rd" class="r423 r">exists</span> = (<b>bool</b>)(<span class="r421 r">op</span>[<span class="s">&quot;Exists&quot;</span>]);
                    <b>if</b> (!<span class="r423 r">exists</span>)
                    {
                        <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<span class="i">NewArgumentNullException</span>(<span class="i">SessionStateStrings</span>.<span class="i">PathNotFound</span>, <span class="r415 r">path</span>);
                    }
 
                    <b>if</b> (<span class="r421 r">op</span>[<span class="s">&quot;Items&quot;</span>] != <b>null</b>)
                    {
                        <a href="../engine/MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r424 rd" class="r424 r">obj</span> = (<a href="../engine/MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>)<span class="r421 r">op</span>[<span class="s">&quot;Items&quot;</span>];
                        <span class="i">ArrayList</span> <span id="r425 rd" class="r425 r">itemsList</span> = (<span class="i">ArrayList</span>)<span class="r424 r">obj</span>.<a href="../engine/MshObject.cs.html#d854d13536b70a12" class="i property">BaseObject</a>;
                        <b>foreach</b> (<a href="../engine/MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r426 rd" class="r426 r">item</span> <b>in</b> <span class="r425 r">itemsList</span>)
                        {
                            <span class="i">Hashtable</span> <span id="r427 rd" class="r427 r">ItemInfo</span> = (<span class="i">Hashtable</span>)<span class="r426 r">item</span>.<a href="../engine/MshObject.cs.html#d854d13536b70a12" class="i property">BaseObject</a>;
                            <b>string</b> <span id="r428 rd" class="r428 r">itemName</span> = (<b>string</b>)<span class="r427 r">ItemInfo</span>[<span class="s">&quot;Name&quot;</span>];
                            <b>string</b> <span id="r429 rd" class="r429 r">itemFullName</span> = (<b>string</b>)<span class="r427 r">ItemInfo</span>[<span class="s">&quot;FullName&quot;</span>];
                            <b>bool</b> <span id="r430 rd" class="r430 r">isContainer</span> = (<b>bool</b>)<span class="r427 r">ItemInfo</span>[<span class="s">&quot;IsDirectory&quot;</span>];
 
                            <b>if</b> (<span class="r430 r">isContainer</span>)
                            {
                                <b>if</b> (<span class="i">File</span>.<span class="i">Exists</span>(<span class="r416 r">destinationPath</span>))
                                {
                                    <span class="i">Exception</span> <span id="r431 rd" class="r431 r">e</span> = <b>new</b> <span class="i">IOException</span>(<b>string</b>.<span class="i">Format</span>(
                                        <span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>,
                                        <span class="i">FileSystemProviderStrings</span>.<span class="i">CopyItemRemotelyDestinationIsFile</span>,
                                        <span class="r415 r">path</span>,
                                        <span class="r416 r">destinationPath</span>));
                                    <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <a href="../engine/ErrorPackage.cs.html#e9334565e5136f43" class="t constructor">ErrorRecord</a>(<span class="r431 r">e</span>, <span class="s">&quot;CopyError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#0c2f4b9c74e5b7c2" class="i field">WriteError</a>, <span class="r416 r">destinationPath</span>));
                                    <b>return</b>;
                                }
 
                                <a href="#96503e1fb7ffd05a" class="i method">CopyDirectoryFromRemoteSession</a>(
                                    <span class="r428 r">itemName</span>,
                                    <span class="r429 r">itemFullName</span>,
                                    <span class="r416 r">destinationPath</span>,
                                    <span class="r418 r">force</span>,
                                    <span class="r417 r">recurse</span>,
                                    <span class="r420 r">ps</span>);
                            }
                            <b>else</b>
                            {
                                <b>bool</b> <span id="r432 rd" class="r432 r">excludeFile</span> = <a href="../engine/SessionStateUtils.cs.html#a64f812795996898" class="t t">SessionStateUtilities</a>.<span class="i">MatchesAnyWildcardPattern</span>(<span class="r428 r">itemName</span>, <a href="#27e7d5cf314c5db2" class="i field">_excludeMatcher</a>, <b>false</b>);
                                <b>if</b> (!<span class="r432 r">excludeFile</span>)
                                {
                                    <b>long</b> <span id="r433 rd" class="r433 r">itemSize</span> = (<b>long</b>)<span class="r427 r">ItemInfo</span>[<span class="s">&quot;FileSize&quot;</span>];
                                    <a href="#5eb063b6cb281a34" class="i method">CopyFileFromRemoteSession</a>(<span class="r428 r">itemName</span>, <span class="r429 r">itemFullName</span>, <span class="r416 r">destinationPath</span>, <span class="r418 r">force</span>, <span class="r420 r">ps</span>, <span class="r433 r">itemSize</span>);
                                }
                            }
                        }
                    }
                }
                <b>finally</b>
                {
                    <a href="#418b3e41ad2dd85e" class="i method">RemoveFunctionsPSCopyFileFromRemoteSession</a>(<span class="r420 r">ps</span>);
                }
            }
        }
 
        <b>private void</b> <a id="015ca001ee38d8c5" href="../R/015ca001ee38d8c5.html" target="n" data-glyph="76,1" class="i method">CopyItemLocalOrToSession</a>(<b>string</b> <span id="r434 rd" class="r434 r">path</span>, <b>string</b> <span id="r435 rd" class="r435 r">destinationPath</span>, <b>bool</b> <span id="r436 rd" class="r436 r">recurse</span>, <b>bool</b> <span id="r437 rd" class="r437 r">Force</span>, <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="../engine/hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShell</a> <span id="r438 rd" class="r438 r">ps</span>)
        {
            <b>bool</b> <span id="r439 rd" class="r439 r">isContainer</span> = <a href="#152bdf0e0e17cd95" class="i method">IsItemContainer</a>(<span class="r434 r">path</span>);
 
            <a href="#96099715ea4c00a3" class="i method">InitializeFunctionsPSCopyFileToRemoteSession</a>(<span class="r438 r">ps</span>);
 
            <b>try</b>
            {
                <b>if</b> (<span class="r439 r">isContainer</span>)
                {
                    <span class="c">// Get the directory info</span>
                    <span class="i">DirectoryInfo</span> <span id="r440 rd" class="r440 r">dir</span> = <b>new</b> <span class="i">DirectoryInfo</span>(<span class="r434 r">path</span>);
 
                    <span class="c">// Now copy the directory to the destination</span>
                    <a href="#4dcbf8c8e14462a1" class="i method">CopyDirectoryInfoItem</a>(<span class="r440 r">dir</span>, <span class="r435 r">destinationPath</span>, <span class="r436 r">recurse</span>, <span class="r437 r">Force</span>, <span class="r438 r">ps</span>);
                }
                <b>else</b> <span class="c">// !isContainer</span>
                {
                    <span class="c">// Get the file info</span>
                    <span class="i">FileInfo</span> <span id="r441 rd" class="r441 r">file</span> = <b>new</b> <span class="i">FileInfo</span>(<span class="r434 r">path</span>);
 
                    <a href="#50b3baf13086de85" class="i method">CopyFileInfoItem</a>(<span class="r441 r">file</span>, <span class="r435 r">destinationPath</span>, <span class="r437 r">Force</span>, <span class="r438 r">ps</span>);
                }
            }
            <b>finally</b>
            {
                <a href="#393993531ccd57fc" class="i method">RemoveFunctionPSCopyFileToRemoteSession</a>(<span class="r438 r">ps</span>);
            }
        }
 
        <b>private void</b> <a id="4dcbf8c8e14462a1" href="../R/4dcbf8c8e14462a1.html" target="n" data-glyph="76,1" class="i method">CopyDirectoryInfoItem</a>(
            <span class="i">DirectoryInfo</span> <span id="r442 rd" class="r442 r">directory</span>,
            <b>string</b> <span id="r443 rd" class="r443 r">destination</span>,
            <b>bool</b> <span id="r444 rd" class="r444 r">recurse</span>,
            <b>bool</b> <span id="r445 rd" class="r445 r">force</span>,
            <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="../engine/hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShell</a> <span id="r446 rd" class="r446 r">ps</span>)
        {
            <span class="i n">Dbg</span>.<a href="../utils/assert.cs.html#c04955255430d32f" class="t t">Diagnostics</a>.<a href="../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(
                <span class="r442 r">directory</span> != <b>null</b>,
                <span class="s">&quot;The caller should verify directory.&quot;</span>);
 
            <span class="c">// Generate the path based on whether the destination path exists and</span>
            <span class="c">// is a container.</span>
            <span class="c">// If the destination exists and is a container the directory we are copying</span>
            <span class="c">// will become a child of that directory.</span>
            <span class="c">// If the destination doesn&#39;t exist we will just try to copy to that new</span>
            <span class="c">// path.</span>
 
            <b>if</b> (<span class="r446 r">ps</span> == <b>null</b>)
            {
                <b>if</b> (<a href="#152bdf0e0e17cd95" class="i method">IsItemContainer</a>(<span class="r443 r">destination</span>))
                {
                    <span class="r443 r">destination</span> = <span class="i">MakePath</span>(<span class="r443 r">destination</span>, <span class="r442 r">directory</span>.<span class="i">Name</span>);
                }
            }
            <b>else</b>
            {
                <b>if</b> (<a href="#a504b7239c357e85" class="i method">RemoteDirectoryExist</a>(<span class="r446 r">ps</span>, <span class="r443 r">destination</span>))
                {
                    <span class="r443 r">destination</span> = <span class="i">Path</span>.<span class="i">Combine</span>(<span class="r443 r">destination</span>, <span class="r442 r">directory</span>.<span class="i">Name</span>);
                }
            }
 
            <a href="#3b3990865d6b9e3a" class="i field">s_tracer</a>.<a href="../utils/StructuredTraceSource.cs.html#25b8416175e53218" class="i method">WriteLine</a>(<span class="s">&quot;destination = {0}&quot;</span>, <span class="r443 r">destination</span>);
 
            <span class="c">// Confirm the copy with the user</span>
            <b>string</b> <span id="r447 rd" class="r447 r">action</span> = <span class="i">FileSystemProviderStrings</span>.<span class="i">CopyItemActionDirectory</span>;
 
            <b>string</b> <span id="r448 rd" class="r448 r">resource</span> = <a href="../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">FileSystemProviderStrings</span>.<span class="i">CopyItemResourceFileTemplate</span>, <span class="r442 r">directory</span>.<span class="i">FullName</span>, <span class="r443 r">destination</span>);
 
            <b>if</b> (<a href="ProviderBase.cs.html#4cb6a9cf0567d153" class="i method">ShouldProcess</a>(<span class="r448 r">resource</span>, <span class="r447 r">action</span>))
            {
                <span class="c">// Create the new directory</span>
                <span class="c">// CreateDirectory does the WriteItemObject for the new DirectoryInfo</span>
                <b>if</b> (<span class="r446 r">ps</span> == <b>null</b>)
                {
                    <a href="#8ee1f3e6ca6489ce" class="i method">CreateDirectory</a>(<span class="r443 r">destination</span>, <b>true</b>);
                }
                <b>else</b>
                {
                    <span class="c">// Verify that the destination is not a file on the remote end</span>
                    <b>if</b> (<a href="#93c6b9361ba96cc6" class="i method">RemoteDestinationPathIsFile</a>(<span class="r443 r">destination</span>, <span class="r446 r">ps</span>))
                    {
                        <span class="i">Exception</span> <span id="r449 rd" class="r449 r">e</span> = <b>new</b> <span class="i">IOException</span>(<b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>,
                                                                    <span class="i">FileSystemProviderStrings</span>.<span class="i">CopyItemRemoteDestinationIsFile</span>,
                                                                    <span class="r443 r">destination</span>));
                        <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <a href="../engine/ErrorPackage.cs.html#e9334565e5136f43" class="t constructor">ErrorRecord</a>(<span class="r449 r">e</span>, <span class="s">&quot;CopyError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#0c2f4b9c74e5b7c2" class="i field">WriteError</a>, <span class="r443 r">destination</span>));
                        <b>return</b>;
                    }
 
                    <span class="r443 r">destination</span> = <a href="#390bc802e88b9273" class="i method">CreateDirectoryOnRemoteSession</a>(<span class="r443 r">destination</span>, <span class="r445 r">force</span>, <span class="r446 r">ps</span>);
                    <b>if</b> (<span class="r443 r">destination</span> == <b>null</b>)
                    {
                        <b>return</b>;
                    }
                }
 
                <b>if</b> (<span class="r444 r">recurse</span>)
                {
                    <span class="c">// Now copy all the files to that directory</span>
                    <span class="i">IEnumerable</span>&lt;<span class="i">FileInfo</span>&gt; <span id="r450 rd" class="r450 r">files</span> = <b>null</b>;
 
                    <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<a href="ProviderBase.cs.html#ef76826218eaf5e1" class="i property">Filter</a>))
                    {
                        <span class="r450 r">files</span> = <span class="r442 r">directory</span>.<span class="i">EnumerateFiles</span>();
                    }
                    <b>else</b>
                    {
                        <span class="r450 r">files</span> = <span class="r442 r">directory</span>.<span class="i">EnumerateFiles</span>(<a href="ProviderBase.cs.html#ef76826218eaf5e1" class="i property">Filter</a>);
                    }
 
                    <b>foreach</b> (<span class="i">FileInfo</span> <span id="r451 rd" class="r451 r">file</span> <b>in</b> <span class="r450 r">files</span>)
                    {
                        <span class="c">// Making sure to obey the StopProcessing.</span>
                        <b>if</b> (<a href="ProviderBase.cs.html#7f198513b75d23b5" class="i property">Stopping</a>)
                        {
                            <b>return</b>;
                        }
 
                        <b>if</b> (<span class="r451 r">file</span> != <b>null</b>)
                        {
                            <b>try</b>
                            {
                                <span class="c">// CopyFileInfoItem does the WriteItemObject for the new FileInfo</span>
                                <a href="#50b3baf13086de85" class="i method">CopyFileInfoItem</a>(<span class="r451 r">file</span>, <span class="r443 r">destination</span>, <span class="r445 r">force</span>, <span class="r446 r">ps</span>);
                            }
                            <b>catch</b> (<span class="i">ArgumentException</span> <span id="r452 rd" class="r452 r">argException</span>)
                            {
                                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r452 r">argException</span>, <span class="s">&quot;CopyDirectoryInfoItemArgumentError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#846d2b572f2c4820" class="i field">InvalidArgument</a>, <span class="r451 r">file</span>));
                            }
                            <b>catch</b> (<span class="i">IOException</span> <span id="r453 rd" class="r453 r">ioException</span>)
                            {
                                <span class="c">// IOException contains specific message about the error occurred and so no need for errordetails.</span>
                                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r453 r">ioException</span>, <span class="s">&quot;CopyDirectoryInfoItemIOError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#0c2f4b9c74e5b7c2" class="i field">WriteError</a>, <span class="r451 r">file</span>));
                            }
                            <b>catch</b> (<span class="i">UnauthorizedAccessException</span> <span id="r454 rd" class="r454 r">accessException</span>)
                            {
                                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r454 r">accessException</span>, <span class="s">&quot;CopyDirectoryInfoItemUnauthorizedAccessError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#26ba13af79d30a75" class="i field">PermissionDenied</a>, <span class="r451 r">file</span>));
                            }
                        }
                    }
 
                    <span class="c">// Now copy all the directories to that directory</span>
                    <b>foreach</b> (<span class="i">DirectoryInfo</span> <span id="r455 rd" class="r455 r">childDir</span> <b>in</b> <span class="r442 r">directory</span>.<span class="i">EnumerateDirectories</span>())
                    {
                        <span class="c">// Making sure to obey the StopProcessing.</span>
                        <b>if</b> (<a href="ProviderBase.cs.html#7f198513b75d23b5" class="i property">Stopping</a>)
                        {
                            <b>return</b>;
                        }
 
                        <b>if</b> (<span class="r455 r">childDir</span> != <b>null</b>)
                        {
                            <b>try</b>
                            {
                                <a href="#4dcbf8c8e14462a1" class="i method">CopyDirectoryInfoItem</a>(<span class="r455 r">childDir</span>, <span class="r443 r">destination</span>, <span class="r444 r">recurse</span>, <span class="r445 r">force</span>, <span class="r446 r">ps</span>);
                            }
                            <b>catch</b> (<span class="i">ArgumentException</span> <span id="r456 rd" class="r456 r">argException</span>)
                            {
                                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r456 r">argException</span>, <span class="s">&quot;CopyDirectoryInfoItemArgumentError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#846d2b572f2c4820" class="i field">InvalidArgument</a>, <span class="r455 r">childDir</span>));
                            }
                            <b>catch</b> (<span class="i">IOException</span> <span id="r457 rd" class="r457 r">ioException</span>)
                            {
                                <span class="c">// IOException contains specific message about the error occurred and so no need for errordetails.</span>
                                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r457 r">ioException</span>, <span class="s">&quot;CopyDirectoryInfoItemIOError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#0c2f4b9c74e5b7c2" class="i field">WriteError</a>, <span class="r455 r">childDir</span>));
                            }
                            <b>catch</b> (<span class="i">UnauthorizedAccessException</span> <span id="r458 rd" class="r458 r">accessException</span>)
                            {
                                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r458 r">accessException</span>, <span class="s">&quot;CopyDirectoryInfoItemUnauthorizedAccessError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#26ba13af79d30a75" class="i field">PermissionDenied</a>, <span class="r455 r">childDir</span>));
                            }
                        }
                    }
                }
            }
        }
 
        <b>private void</b> <a id="50b3baf13086de85" href="../R/50b3baf13086de85.html" target="n" data-glyph="76,1" class="i method">CopyFileInfoItem</a>(<span class="i">FileInfo</span> <span id="r459 rd" class="r459 r">file</span>, <b>string</b> <span id="r460 rd" class="r460 r">destinationPath</span>, <b>bool</b> <span id="r461 rd" class="r461 r">force</span>, <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="../engine/hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShell</a> <span id="r462 rd" class="r462 r">ps</span>)
        {
            <span class="i n">Dbg</span>.<a href="../utils/assert.cs.html#c04955255430d32f" class="t t">Diagnostics</a>.<a href="../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(
                <span class="r459 r">file</span> != <b>null</b>,
                <span class="s">&quot;The caller should verify file.&quot;</span>);
 
            <span class="c">// If the destination is a container, add the file name</span>
            <span class="c">// to the destination path.</span>
            <b>if</b> (<span class="r462 r">ps</span> == <b>null</b>)
            {
                <b>if</b> (<a href="#152bdf0e0e17cd95" class="i method">IsItemContainer</a>(<span class="r460 r">destinationPath</span>))
                {
                    <span class="r460 r">destinationPath</span> = <span class="i">MakePath</span>(<span class="r460 r">destinationPath</span>, <span class="r459 r">file</span>.<span class="i">Name</span>);
                }
 
                <span class="c">// if the source and destination path are same then flag it as error.</span>
                <b>if</b> (<a href="#916c1750999d4e10" class="t t">InternalSymbolicLinkLinkCodeMethods</a>.<span class="i">IsSameFileSystemItem</span>(<span class="r460 r">destinationPath</span>, <span class="r459 r">file</span>.<span class="i">FullName</span>))
                {
                    <b>string</b> <span id="r463 rd" class="r463 r">error</span> = <a href="../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">FileSystemProviderStrings</span>.<span class="i">CopyError</span>, <span class="r460 r">destinationPath</span>);
                    <span class="i">Exception</span> <span id="r464 rd" class="r464 r">e</span> = <b>new</b> <span class="i">IOException</span>(<span class="r463 r">error</span>);
                    <span class="r464 r">e</span>.<span class="i">Data</span>[<a href="#941facd9edebd126" class="i field">SelfCopyDataKey</a>] = <span class="r459 r">file</span>.<span class="i">FullName</span>;
                    <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <a href="../engine/ErrorPackage.cs.html#e9334565e5136f43" class="t constructor">ErrorRecord</a>(<span class="r464 r">e</span>, <span class="s">&quot;CopyError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#0c2f4b9c74e5b7c2" class="i field">WriteError</a>, <span class="r460 r">destinationPath</span>));
                    <b>return</b>;
                }
                <span class="c">// Verify that the target doesn&#39;t represent a device name</span>
                <b>if</b> (<a href="#f2f9701584921b3e" class="i method">PathIsReservedDeviceName</a>(<span class="r460 r">destinationPath</span>, <span class="s">&quot;CopyError&quot;</span>))
                {
                    <b>return</b>;
                }
            }
 
            <span class="c">// Confirm the copy with the user</span>
            <b>string</b> <span id="r465 rd" class="r465 r">action</span> = <span class="i">FileSystemProviderStrings</span>.<span class="i">CopyItemActionFile</span>;
 
            <b>string</b> <span id="r466 rd" class="r466 r">resource</span> = <a href="../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">FileSystemProviderStrings</span>.<span class="i">CopyItemResourceFileTemplate</span>, <span class="r459 r">file</span>.<span class="i">FullName</span>, <span class="r460 r">destinationPath</span>);
 
            <b>bool</b> <span id="r467 rd" class="r467 r">excludeFile</span> = <a href="../engine/SessionStateUtils.cs.html#a64f812795996898" class="t t">SessionStateUtilities</a>.<span class="i">MatchesAnyWildcardPattern</span>(<span class="r459 r">file</span>.<span class="i">Name</span>, <a href="#27e7d5cf314c5db2" class="i field">_excludeMatcher</a>, <span class="i">defaultValue</span>: <b>false</b>);
 
            <b>if</b> (!<span class="r467 r">excludeFile</span>)
            {
                <b>if</b> (<a href="ProviderBase.cs.html#4cb6a9cf0567d153" class="i method">ShouldProcess</a>(<span class="r466 r">resource</span>, <span class="r465 r">action</span>))
                {
                    <b>try</b>
                    {
                        <b>if</b> (<span class="r462 r">ps</span> == <b>null</b>)
                        {
                            <span class="c">// Now copy the file</span>
                            <span class="c">// We assume that if we get called we want to make</span>
                            <span class="c">// the copy even if the destination already exists.</span>
                            <span class="r459 r">file</span>.<span class="i">CopyTo</span>(<span class="r460 r">destinationPath</span>, <b>true</b>);
 
                            <span class="i">FileInfo</span> <span id="r468 rd" class="r468 r">result</span> = <b>new</b> <span class="i">FileInfo</span>(<span class="r460 r">destinationPath</span>);
                            <span class="i">WriteItemObject</span>(<span class="r468 r">result</span>, <span class="r460 r">destinationPath</span>, <b>false</b>);
                        }
                        <b>else</b>
                        {
                            <a href="#2f20ab3135dfeee6" class="i method">PerformCopyFileToRemoteSession</a>(<span class="r459 r">file</span>, <span class="r460 r">destinationPath</span>, <span class="r462 r">ps</span>);
                        }
                    }
                    <b>catch</b> (<span class="i n">System</span>.<span class="i">UnauthorizedAccessException</span> <span id="r469 rd" class="r469 r">unAuthorizedAccessException</span>)
                    {
                        <b>if</b> (<span class="r461 r">force</span>)
                        {
                            <b>try</b>
                            {
                                <b>if</b> (<span class="r462 r">ps</span> == <b>null</b>)
                                {
                                    <span class="c">// If the destination exists and force is specified,</span>
                                    <span class="c">// mask of the readonly and hidden attributes and</span>
                                    <span class="c">// try again</span>
                                    <span class="i">FileInfo</span> <span id="r470 rd" class="r470 r">destinationItem</span> = <b>new</b> <span class="i">FileInfo</span>(<span class="r460 r">destinationPath</span>);
 
                                    <span class="r470 r">destinationItem</span>.<span class="i">Attributes</span> &amp;= ~(<span class="i">FileAttributes</span>.<span class="i">ReadOnly</span> | <span class="i">FileAttributes</span>.<span class="i">Hidden</span>);
                                }
                                <b>else</b>
                                {
                                    <a href="#2f20ab3135dfeee6" class="i method">PerformCopyFileToRemoteSession</a>(<span class="r459 r">file</span>, <span class="r460 r">destinationPath</span>, <span class="r462 r">ps</span>);
                                }
                            }
                            <b>catch</b> (<span class="i">Exception</span> <span id="r471 rd" class="r471 r">exception</span>)
                            {
                                <b>if</b> ((<span class="r471 r">exception</span> <b>is</b> <span class="i">FileNotFoundException</span>) ||
                                    (<span class="r471 r">exception</span> <b>is</b> <span class="i">DirectoryNotFoundException</span>) ||
                                    (<span class="r471 r">exception</span> <b>is</b> <span class="i n">System</span>.<span class="i">Security</span>.<span class="i">SecurityException</span>) ||
                                    (<span class="r471 r">exception</span> <b>is</b> <span class="i">ArgumentException</span>) ||
                                    (<span class="r471 r">exception</span> <b>is</b> <span class="i">IOException</span>))
                                {
                                    <span class="c">// Write out the original error since we failed to force the copy</span>
                                    <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r469 r">unAuthorizedAccessException</span>, <span class="s">&quot;CopyFileInfoItemUnauthorizedAccessError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#26ba13af79d30a75" class="i field">PermissionDenied</a>, <span class="r459 r">file</span>));
                                }
                                <b>else</b>
                                {
                                    <b>throw</b>;
                                }
                            }
 
                            <span class="r459 r">file</span>.<span class="i">CopyTo</span>(<span class="r460 r">destinationPath</span>, <b>true</b>);
 
                            <span class="i">FileInfo</span> <span id="r472 rd" class="r472 r">result</span> = <b>new</b> <span class="i">FileInfo</span>(<span class="r460 r">destinationPath</span>);
                            <span class="i">WriteItemObject</span>(<span class="r472 r">result</span>, <span class="r460 r">destinationPath</span>, <b>false</b>);
                        }
                        <b>else</b>
                        {
                            <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r469 r">unAuthorizedAccessException</span>, <span class="s">&quot;CopyFileInfoItemUnauthorizedAccessError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#26ba13af79d30a75" class="i field">PermissionDenied</a>, <span class="r459 r">file</span>));
                        }
                    }
                    <b>catch</b> (<span class="i">IOException</span> <span id="r473 rd" class="r473 r">ioException</span>)
                    {
                        <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r473 r">ioException</span>, <span class="s">&quot;CopyFileInfoItemIOError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#0c2f4b9c74e5b7c2" class="i field">WriteError</a>, <span class="r459 r">file</span>));
                    }
                }
            }
        }
 
        <b>private void</b> <a id="96503e1fb7ffd05a" href="../R/96503e1fb7ffd05a.html" target="n" data-glyph="76,1" class="i method">CopyDirectoryFromRemoteSession</a>(
            <b>string</b> <span id="r474 rd" class="r474 r">sourceDirectoryName</span>,
            <b>string</b> <span id="r475 rd" class="r475 r">sourceDirectoryFullName</span>,
            <b>string</b> <span id="r476 rd" class="r476 r">destination</span>,
            <b>bool</b> <span id="r477 rd" class="r477 r">force</span>,
            <b>bool</b> <span id="r478 rd" class="r478 r">recurse</span>,
            <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="../engine/hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShell</a> <span id="r479 rd" class="r479 r">ps</span>)
        {
            <span class="i n">Dbg</span>.<a href="../utils/assert.cs.html#c04955255430d32f" class="t t">Diagnostics</a>.<a href="../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>((<span class="r474 r">sourceDirectoryName</span> != <b>null</b> &amp;&amp; <span class="r475 r">sourceDirectoryFullName</span> != <b>null</b>), <span class="s">&quot;The caller should verify directory.&quot;</span>);
 
            <b>if</b> (<a href="#152bdf0e0e17cd95" class="i method">IsItemContainer</a>(<span class="r476 r">destination</span>))
            {
                <span class="r476 r">destination</span> = <a href="NavigationProviderBase.cs.html#6133115f9f4a066d" class="i method">MakePath</a>(<span class="r476 r">destination</span>, <span class="r474 r">sourceDirectoryName</span>);
            }
 
            <a href="#3b3990865d6b9e3a" class="i field">s_tracer</a>.<a href="../utils/StructuredTraceSource.cs.html#25b8416175e53218" class="i method">WriteLine</a>(<span class="s">&quot;destination = {0}&quot;</span>, <span class="r476 r">destination</span>);
 
            <span class="c">// Confirm the copy with the user</span>
            <b>string</b> <span id="r480 rd" class="r480 r">action</span> = <span class="i">FileSystemProviderStrings</span>.<span class="i">CopyItemActionDirectory</span>;
            <b>string</b> <span id="r481 rd" class="r481 r">resource</span> = <a href="../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">FileSystemProviderStrings</span>.<span class="i">CopyItemResourceFileTemplate</span>, <span class="r475 r">sourceDirectoryFullName</span>, <span class="r476 r">destination</span>);
 
            <b>if</b> (<a href="ProviderBase.cs.html#4cb6a9cf0567d153" class="i method">ShouldProcess</a>(<span class="r481 r">resource</span>, <span class="r480 r">action</span>))
            {
                <span class="c">// Create destinationPath directory. This will fail if the directory already exists</span>
                <span class="c">// and Force is not selected.</span>
                <a href="#8ee1f3e6ca6489ce" class="i method">CreateDirectory</a>(<span class="r476 r">destination</span>, <b>false</b>);
 
                <span class="c">// If failed to create directory</span>
                <b>if</b> (!<span class="i">Directory</span>.<span class="i">Exists</span>(<span class="r476 r">destination</span>))
                {
                    <b>return</b>;
                }
 
                <b>if</b> (<span class="r478 r">recurse</span>)
                {
                    <span class="c">// Get all the files for that directory from the remote session</span>
                    <span class="r479 r">ps</span>.<a href="../engine/hostifaces/PowerShell.cs.html#9cc79c297f6cced9" class="i method">AddCommand</a>(<a href="#18b0063a4d2c0d48" class="t t">CopyFileRemoteUtils</a>.<a href="#7768bae509667d9d" class="i field">PSCopyFromSessionHelperName</a>);
                    <span class="r479 r">ps</span>.<a href="../engine/hostifaces/PowerShell.cs.html#40674f99a3618f4b" class="i method">AddParameter</a>(<span class="s">&quot;getPathDir&quot;</span>, <span class="r475 r">sourceDirectoryFullName</span>);
 
                    <span class="i">Hashtable</span> <span id="r482 rd" class="r482 r">op</span> = <a href="#0021e65731f91d4b" class="t t">SafeInvokeCommand</a>.<a href="#52932871655c3ffb" class="i method">Invoke</a>(<span class="r479 r">ps</span>, <a href="../P/64a92af39f1cd630.html#64a92af39f1cd630" class="k">this</a>, <b>null</b>);
                    <b>if</b> (<span class="r482 r">op</span> == <b>null</b>)
                    {
                        <span class="i">Exception</span> <span id="r483 rd" class="r483 r">e</span> = <b>new</b> <span class="i">IOException</span>(<b>string</b>.<span class="i">Format</span>(
                                                      <span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>,
                                                      <span class="i">FileSystemProviderStrings</span>.<span class="i">CopyItemRemotelyFailedToGetDirectoryChildItems</span>,
                                                      <span class="r475 r">sourceDirectoryFullName</span>));
                        <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <a href="../engine/ErrorPackage.cs.html#e9334565e5136f43" class="t constructor">ErrorRecord</a>(<span class="r483 r">e</span>, <span class="s">&quot;CopyError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#0c2f4b9c74e5b7c2" class="i field">WriteError</a>, <span class="r475 r">sourceDirectoryFullName</span>));
                        <b>return</b>;
                    }
 
                    <b>if</b> (<span class="r482 r">op</span>[<span class="s">&quot;Files&quot;</span>] != <b>null</b>)
                    {
                        <a href="../engine/MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r484 rd" class="r484 r">obj</span> = (<a href="../engine/MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>)<span class="r482 r">op</span>[<span class="s">&quot;Files&quot;</span>];
                        <span class="i">ArrayList</span> <span id="r485 rd" class="r485 r">filesList</span> = (<span class="i">ArrayList</span>)<span class="r484 r">obj</span>.<a href="../engine/MshObject.cs.html#d854d13536b70a12" class="i property">BaseObject</a>;
 
                        <b>foreach</b> (<a href="../engine/MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r486 rd" class="r486 r">fileObject</span> <b>in</b> <span class="r485 r">filesList</span>)
                        {
                            <span class="i">Hashtable</span> <span id="r487 rd" class="r487 r">file</span> = (<span class="i">Hashtable</span>)<span class="r486 r">fileObject</span>.<a href="../engine/MshObject.cs.html#d854d13536b70a12" class="i property">BaseObject</a>;
                            <b>string</b> <span id="r488 rd" class="r488 r">fileName</span> = (<b>string</b>)<span class="r487 r">file</span>[<span class="s">&quot;FileName&quot;</span>];
                            <b>string</b> <span id="r489 rd" class="r489 r">filePath</span> = (<b>string</b>)<span class="r487 r">file</span>[<span class="s">&quot;FilePath&quot;</span>];
                            <b>long</b> <span id="r490 rd" class="r490 r">fileSize</span> = (<b>long</b>)<span class="r487 r">file</span>[<span class="s">&quot;FileSize&quot;</span>];
 
                            <span class="c">// Making sure to obey the StopProcessing.</span>
                            <b>if</b> (<a href="ProviderBase.cs.html#7f198513b75d23b5" class="i property">Stopping</a>)
                            {
                                <b>return</b>;
                            }
 
                            <b>bool</b> <span id="r491 rd" class="r491 r">excludeFile</span> = <a href="../engine/SessionStateUtils.cs.html#a64f812795996898" class="t t">SessionStateUtilities</a>.<span class="i">MatchesAnyWildcardPattern</span>(<span class="r488 r">fileName</span>, <a href="#27e7d5cf314c5db2" class="i field">_excludeMatcher</a>, <span class="i">defaultValue</span>: <b>false</b>);
 
                            <b>if</b> (!<span class="r491 r">excludeFile</span>)
                            {
                                <span class="c">// If an exception is thrown in the remote session, it is surface to the user via PowerShell Write-Error.</span>
                                <a href="#5eb063b6cb281a34" class="i method">CopyFileFromRemoteSession</a>(<span class="r488 r">fileName</span>,
                                                          <span class="r489 r">filePath</span>,
                                                          <span class="r476 r">destination</span>,
                                                          <span class="r477 r">force</span>,
                                                          <span class="r479 r">ps</span>,
                                                          <span class="r490 r">fileSize</span>);
                            }
                        }
                    }
 
                    <b>if</b> (<span class="r482 r">op</span>[<span class="s">&quot;Directories&quot;</span>] != <b>null</b>)
                    {
                        <a href="../engine/MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r492 rd" class="r492 r">obj</span> = (<a href="../engine/MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>)<span class="r482 r">op</span>[<span class="s">&quot;Directories&quot;</span>];
                        <span class="i">ArrayList</span> <span id="r493 rd" class="r493 r">directories</span> = (<span class="i">ArrayList</span>)<span class="r492 r">obj</span>.<a href="../engine/MshObject.cs.html#d854d13536b70a12" class="i property">BaseObject</a>;
 
                        <b>foreach</b> (<a href="../engine/MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r494 rd" class="r494 r">dirObject</span> <b>in</b> <span class="r493 r">directories</span>)
                        {
                            <span class="i">Hashtable</span> <span id="r495 rd" class="r495 r">dir</span> = (<span class="i">Hashtable</span>)<span class="r494 r">dirObject</span>.<a href="../engine/MshObject.cs.html#d854d13536b70a12" class="i property">BaseObject</a>;
                            <b>string</b> <span id="r496 rd" class="r496 r">dirName</span> = (<b>string</b>)<span class="r495 r">dir</span>[<span class="s">&quot;Name&quot;</span>];
                            <b>string</b> <span id="r497 rd" class="r497 r">dirFullName</span> = (<b>string</b>)<span class="r495 r">dir</span>[<span class="s">&quot;FullName&quot;</span>];
 
                            <span class="c">// Making sure to obey the StopProcessing.</span>
                            <b>if</b> (<a href="ProviderBase.cs.html#7f198513b75d23b5" class="i property">Stopping</a>)
                            {
                                <b>return</b>;
                            }
 
                            <span class="c">// If an exception is thrown in the remote session, it is surface to the user via PowerShell Write-Error.</span>
                            <a href="#96503e1fb7ffd05a" class="i method">CopyDirectoryFromRemoteSession</a>(<span class="r496 r">dirName</span>,
                                                           <span class="r497 r">dirFullName</span>,
                                                           <span class="r476 r">destination</span>,
                                                           <span class="r477 r">force</span>,
                                                           <span class="r478 r">recurse</span>,
                                                           <span class="r479 r">ps</span>);
                        }
                    }
                }
            }
        }
 
        <b>private</b> <span class="i">ArrayList</span> <a id="e58bbbd81df8db02" href="../R/e58bbbd81df8db02.html" target="n" data-glyph="76,1" class="i method">GetRemoteSourceAlternateStreams</a>(<span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="../engine/hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShell</a> <span id="r498 rd" class="r498 r">ps</span>, <b>string</b> <span id="r499 rd" class="r499 r">path</span>)
        {
            <span class="i">ArrayList</span> <span id="r500 rd" class="r500 r">streams</span> = <b>null</b>;
            <b>bool</b> <span id="r501 rd" class="r501 r">supportsAlternateStreams</span> = <b>false</b>;
 
            <span class="r498 r">ps</span>.<a href="../engine/hostifaces/PowerShell.cs.html#9cc79c297f6cced9" class="i method">AddCommand</a>(<a href="#18b0063a4d2c0d48" class="t t">CopyFileRemoteUtils</a>.<a href="#7768bae509667d9d" class="i field">PSCopyFromSessionHelperName</a>);
            <span class="r498 r">ps</span>.<a href="../engine/hostifaces/PowerShell.cs.html#40674f99a3618f4b" class="i method">AddParameter</a>(<span class="s">&quot;supportAltStreamPath&quot;</span>, <span class="r499 r">path</span>);
 
            <span class="i">Hashtable</span> <span id="r502 rd" class="r502 r">op</span> = <a href="#0021e65731f91d4b" class="t t">SafeInvokeCommand</a>.<a href="#52932871655c3ffb" class="i method">Invoke</a>(<span class="r498 r">ps</span>, <a href="../P/64a92af39f1cd630.html#64a92af39f1cd630" class="k">this</a>, <b>null</b>);
            <b>if</b> (<span class="r502 r">op</span> != <b>null</b> &amp;&amp; <span class="r502 r">op</span>[<span class="s">&quot;SourceSupportsAlternateStreams&quot;</span>] != <b>null</b>)
            {
                <span class="r501 r">supportsAlternateStreams</span> = (<b>bool</b>)<span class="r502 r">op</span>[<span class="s">&quot;SourceSupportsAlternateStreams&quot;</span>];
            }
 
            <b>if</b> (<span class="r501 r">supportsAlternateStreams</span>)
            {
                <a href="../engine/MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r503 rd" class="r503 r">obj</span> = (<a href="../engine/MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>)<span class="r502 r">op</span>[<span class="s">&quot;Streams&quot;</span>];
                <span class="r500 r">streams</span> = (<span class="i">ArrayList</span>)<span class="r503 r">obj</span>.<a href="../engine/MshObject.cs.html#d854d13536b70a12" class="i property">BaseObject</a>;
            }
 
            <b>return</b> <span class="r500 r">streams</span>;
        }
 
        <b>private void</b> <a id="9f95e4ea04930b77" href="../R/9f95e4ea04930b77.html" target="n" data-glyph="76,1" class="i method">InitializeFunctionPSCopyFileFromRemoteSession</a>(<span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="../engine/hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShell</a> <span id="r504 rd" class="r504 r">ps</span>)
        {
            <b>if</b> ((<span class="r504 r">ps</span> == <b>null</b>) || !<a href="#0852ca5d36bc9fd8" class="i method">ValidRemoteSessionForScripting</a>(<span class="r504 r">ps</span>.<a href="../engine/hostifaces/PowerShell.cs.html#ccf57242c9d46642" class="i property">Runspace</a>))
            {
                <b>return</b>;
            }
 
            <span class="r504 r">ps</span>.<a href="../engine/hostifaces/PowerShell.cs.html#c97f8d15a2f93e31" class="i method">AddScript</a>(<a href="#18b0063a4d2c0d48" class="t t">CopyFileRemoteUtils</a>.<a href="#de976ac700812acc" class="i field">AllCopyFromRemoteScripts</a>);
            <a href="#0021e65731f91d4b" class="t t">SafeInvokeCommand</a>.<a href="#33792f673831f08f" class="i method">Invoke</a>(<span class="r504 r">ps</span>, <a href="../P/64a92af39f1cd630.html#64a92af39f1cd630" class="k">this</a>, <b>null</b>, <b>false</b>);
        }
 
        <b>private void</b> <a id="418b3e41ad2dd85e" href="../R/418b3e41ad2dd85e.html" target="n" data-glyph="76,1" class="i method">RemoveFunctionsPSCopyFileFromRemoteSession</a>(<span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="../engine/hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShell</a> <span id="r505 rd" class="r505 r">ps</span>)
        {
            <b>if</b> ((<span class="r505 r">ps</span> == <b>null</b>) || !<a href="#0852ca5d36bc9fd8" class="i method">ValidRemoteSessionForScripting</a>(<span class="r505 r">ps</span>.<a href="../engine/hostifaces/PowerShell.cs.html#ccf57242c9d46642" class="i property">Runspace</a>))
            {
                <b>return</b>;
            }
 
            <b>const string</b> <span id="r506 rd" class="r506 r">remoteScript</span> = <span class="s">@&quot;
                Microsoft.PowerShell.Management\Remove-Item function:PSCopyFromSessionHelper -ea SilentlyContinue -Force
                Microsoft.PowerShell.Management\Remove-Item function:PSCopyRemoteUtils -ea SilentlyContinue -Force
            &quot;</span>;
            <span class="r505 r">ps</span>.<a href="../engine/hostifaces/PowerShell.cs.html#c97f8d15a2f93e31" class="i method">AddScript</a>(<span class="r506 r">remoteScript</span>);
            <a href="#0021e65731f91d4b" class="t t">SafeInvokeCommand</a>.<a href="#33792f673831f08f" class="i method">Invoke</a>(<span class="r505 r">ps</span>, <a href="../P/64a92af39f1cd630.html#64a92af39f1cd630" class="k">this</a>, <b>null</b>, <b>false</b>);
        }
 
        <b>private static bool</b> <a id="0852ca5d36bc9fd8" href="../R/0852ca5d36bc9fd8.html" target="n" data-glyph="76,1" class="i method">ValidRemoteSessionForScripting</a>(<a href="../engine/hostifaces/Connection.cs.html#7e5b8eab1aa16fd7" class="t t">Runspace</a> <span id="r507 rd" class="r507 r">runspace</span>)
        {
            <b>if</b> (<span class="r507 r">runspace</span> <b>is not</b> <a href="../engine/remoting/client/remoterunspace.cs.html#e2c1bde75e106663" class="t t">RemoteRunspace</a>)
            {
                <b>return</b> <b>false</b>;
            }
 
            <a href="../engine/SessionStatePublic.cs.html#450052824aba2e3f" class="t t">PSLanguageMode</a> <span id="r508 rd" class="r508 r">languageMode</span> = <span class="r507 r">runspace</span>.<a href="../engine/hostifaces/Connection.cs.html#c43f0c90447752e8" class="i property">SessionStateProxy</a>.<a href="../engine/hostifaces/Connection.cs.html#ccb77bd743e72d6c" class="i property">LanguageMode</a>;
            <b>if</b> (<span class="r508 r">languageMode</span> == <a href="../engine/SessionStatePublic.cs.html#450052824aba2e3f" class="t t">PSLanguageMode</a>.<a href="../engine/SessionStatePublic.cs.html#9f1205fe78117fc2" class="i field">ConstrainedLanguage</a> || <span class="r508 r">languageMode</span> == <a href="../engine/SessionStatePublic.cs.html#450052824aba2e3f" class="t t">PSLanguageMode</a>.<a href="../engine/SessionStatePublic.cs.html#a659f53717c16b4b" class="i field">NoLanguage</a>)
            {
                <span class="c">// SessionStateInternal.ValidateRemotePathAndGetRoot checked for expected helper functions on the</span>
                <span class="c">// restricted session and will have returned an error if they are missing.  So at this point we</span>
                <span class="c">// assume the session is set up with the needed helper functions.</span>
                <b>return</b> <b>false</b>;
            }
 
            <b>return</b> <b>true</b>;
        }
 
        <b>private</b> <span class="i">Hashtable</span> <a id="5c1691d6cb442470" href="../R/5c1691d6cb442470.html" target="n" data-glyph="76,1" class="i method">GetRemoteFileMetadata</a>(<b>string</b> <span id="r509 rd" class="r509 r">filePath</span>, <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="../engine/hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShell</a> <span id="r510 rd" class="r510 r">ps</span>)
        {
            <span class="r510 r">ps</span>.<a href="../engine/hostifaces/PowerShell.cs.html#9cc79c297f6cced9" class="i method">AddCommand</a>(<a href="#18b0063a4d2c0d48" class="t t">CopyFileRemoteUtils</a>.<a href="#7768bae509667d9d" class="i field">PSCopyFromSessionHelperName</a>);
            <span class="r510 r">ps</span>.<a href="../engine/hostifaces/PowerShell.cs.html#40674f99a3618f4b" class="i method">AddParameter</a>(<span class="s">&quot;getMetaFilePath&quot;</span>, <span class="r509 r">filePath</span>);
            <span class="i">Hashtable</span> <span id="r511 rd" class="r511 r">metadata</span> = <a href="#0021e65731f91d4b" class="t t">SafeInvokeCommand</a>.<a href="#52932871655c3ffb" class="i method">Invoke</a>(<span class="r510 r">ps</span>, <a href="../P/64a92af39f1cd630.html#64a92af39f1cd630" class="k">this</a>, <b>null</b>);
            <b>return</b> <span class="r511 r">metadata</span>;
        }
 
        <b>private void</b> <a id="0c52ed323790f434" href="../R/0c52ed323790f434.html" target="n" data-glyph="76,1" class="i method">SetFileMetadata</a>(<b>string</b> <span id="r512 rd" class="r512 r">sourceFileFullName</span>, <span class="i">FileInfo</span> <span id="r513 rd" class="r513 r">destinationFile</span>, <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="../engine/hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShell</a> <span id="r514 rd" class="r514 r">ps</span>)
        {
            <span class="i">Hashtable</span> <span id="r515 rd" class="r515 r">metadata</span> = <a href="#5c1691d6cb442470" class="i method">GetRemoteFileMetadata</a>(<span class="r512 r">sourceFileFullName</span>, <span class="r514 r">ps</span>);
 
            <b>if</b> (<span class="r515 r">metadata</span> != <b>null</b>)
            {
                <span class="c">// LastWriteTime</span>
                <b>if</b> (<span class="r515 r">metadata</span>[<span class="s">&quot;LastWriteTimeUtc&quot;</span>] != <b>null</b>)
                {
                    <span class="r513 r">destinationFile</span>.<span class="i">LastWriteTimeUtc</span> = (<span class="i">DateTime</span>)<span class="r515 r">metadata</span>[<span class="s">&quot;LastWriteTimeUtc&quot;</span>];
                }
 
                <b>if</b> (<span class="r515 r">metadata</span>[<span class="s">&quot;LastWriteTime&quot;</span>] != <b>null</b>)
                {
                    <span class="r513 r">destinationFile</span>.<span class="i">LastWriteTime</span> = (<span class="i">DateTime</span>)<span class="r515 r">metadata</span>[<span class="s">&quot;LastWriteTime&quot;</span>];
                }
 
                <span class="c">// Attributes</span>
                <b>if</b> (<span class="r515 r">metadata</span>[<span class="s">&quot;Attributes&quot;</span>] != <b>null</b>)
                {
                    <a href="../engine/MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r516 rd" class="r516 r">obj</span> = (<a href="../engine/MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>)<span class="r515 r">metadata</span>[<span class="s">&quot;Attributes&quot;</span>];
                    <b>foreach</b> (<b>string</b> <span id="r517 rd" class="r517 r">value</span> <b>in</b> (<span class="i">ArrayList</span>)<span class="r516 r">obj</span>.<a href="../engine/MshObject.cs.html#d854d13536b70a12" class="i property">BaseObject</a>)
                    {
                        <b>if</b> (<b>string</b>.<span class="i">Equals</span>(<span class="r517 r">value</span>, <span class="s">&quot;ReadOnly&quot;</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
                        {
                            <span class="r513 r">destinationFile</span>.<span class="i">Attributes</span> |= <span class="i">FileAttributes</span>.<span class="i">ReadOnly</span>;
                        }
                        <b>else</b> <b>if</b> (<b>string</b>.<span class="i">Equals</span>(<span class="r517 r">value</span>, <span class="s">&quot;Hidden&quot;</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
                        {
                            <span class="r513 r">destinationFile</span>.<span class="i">Attributes</span> |= <span class="i">FileAttributes</span>.<span class="i">Hidden</span>;
                        }
                        <b>else</b> <b>if</b> (<b>string</b>.<span class="i">Equals</span>(<span class="r517 r">value</span>, <span class="s">&quot;Archive&quot;</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
                        {
                            <span class="r513 r">destinationFile</span>.<span class="i">Attributes</span> |= <span class="i">FileAttributes</span>.<span class="i">Archive</span>;
                        }
                        <b>else</b> <b>if</b> (<b>string</b>.<span class="i">Equals</span>(<span class="r517 r">value</span>, <span class="s">&quot;System&quot;</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
                        {
                            <span class="r513 r">destinationFile</span>.<span class="i">Attributes</span> |= <span class="i">FileAttributes</span>.<span class="i">System</span>;
                        }
                    }
                }
            }
        }
 
        <b>private void</b> <a id="5eb063b6cb281a34" href="../R/5eb063b6cb281a34.html" target="n" data-glyph="76,1" class="i method">CopyFileFromRemoteSession</a>(
            <b>string</b> <span id="r518 rd" class="r518 r">sourceFileName</span>,
            <b>string</b> <span id="r519 rd" class="r519 r">sourceFileFullName</span>,
            <b>string</b> <span id="r520 rd" class="r520 r">destinationPath</span>,
            <b>bool</b> <span id="r521 rd" class="r521 r">force</span>,
            <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="../engine/hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShell</a> <span id="r522 rd" class="r522 r">ps</span>,
            <b>long</b> <span id="r523 rd" class="r523 r">fileSize</span> = 0)
        {
            <span class="i n">Dbg</span>.<a href="../utils/assert.cs.html#c04955255430d32f" class="t t">Diagnostics</a>.<a href="../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r519 r">sourceFileFullName</span> != <b>null</b>, <span class="s">&quot;The caller should verify file.&quot;</span>);
 
            <span class="c">// If the destination is a container, add the file name</span>
            <span class="c">// to the destination path.</span>
            <b>if</b> (<a href="#152bdf0e0e17cd95" class="i method">IsItemContainer</a>(<span class="r520 r">destinationPath</span>))
            {
                <span class="r520 r">destinationPath</span> = <a href="NavigationProviderBase.cs.html#6133115f9f4a066d" class="i method">MakePath</a>(<span class="r520 r">destinationPath</span>, <span class="r518 r">sourceFileName</span>);
            }
 
            <span class="c">// Verify that the target doesn&#39;t represent a device name</span>
            <b>if</b> (<a href="#f2f9701584921b3e" class="i method">PathIsReservedDeviceName</a>(<span class="r520 r">destinationPath</span>, <span class="s">&quot;CopyError&quot;</span>))
            {
                <b>return</b>;
            }
 
            <span class="i">FileInfo</span> <span id="r524 rd" class="r524 r">destinationFile</span> = <b>new</b> <span class="i">FileInfo</span>(<span class="r520 r">destinationPath</span>);
 
            <b>string</b> <span id="r525 rd" class="r525 r">action</span> = <span class="i">FileSystemProviderStrings</span>.<span class="i">CopyItemActionFile</span>;
            <b>string</b> <span id="r526 rd" class="r526 r">resource</span> = <a href="../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">FileSystemProviderStrings</span>.<span class="i">CopyItemResourceFileTemplate</span>, <span class="r519 r">sourceFileFullName</span>, <span class="r520 r">destinationPath</span>);
 
            <b>if</b> (<a href="ProviderBase.cs.html#4cb6a9cf0567d153" class="i method">ShouldProcess</a>(<span class="r526 r">resource</span>, <span class="r525 r">action</span>))
            {
                <b>bool</b> <span id="r527 rd" class="r527 r">result</span> = <a href="#3f1f1ea86b0f24a5" class="i method">PerformCopyFileFromRemoteSession</a>(<span class="r519 r">sourceFileFullName</span>, <span class="r524 r">destinationFile</span>, <span class="r520 r">destinationPath</span>, <span class="r521 r">force</span>, <span class="r522 r">ps</span>, <span class="r523 r">fileSize</span>, <b>false</b>, <b>null</b>);
 
                <span class="c">// Copying the file from the remote session completed successfully</span>
                <b>if</b> (<span class="r527 r">result</span>)
                {
                    <span class="c">// Check if the remote source file has any alternate data streams</span>
                    <span class="i">ArrayList</span> <span id="r528 rd" class="r528 r">remoteFileStreams</span> = <a href="#e58bbbd81df8db02" class="i method">GetRemoteSourceAlternateStreams</a>(<span class="r522 r">ps</span>, <span class="r519 r">sourceFileFullName</span>);
                    <b>if</b> ((<span class="r528 r">remoteFileStreams</span> != <b>null</b>) &amp;&amp; (<span class="r528 r">remoteFileStreams</span>.<span class="i">Count</span> &gt; 0))
                    {
                        <b>foreach</b> (<b>string</b> <span id="r529 rd" class="r529 r">streamName</span> <b>in</b> <span class="r528 r">remoteFileStreams</span>)
                        {
                            <span class="r527 r">result</span> = <a href="#3f1f1ea86b0f24a5" class="i method">PerformCopyFileFromRemoteSession</a>(<span class="r519 r">sourceFileFullName</span>, <span class="r524 r">destinationFile</span>, <span class="r520 r">destinationPath</span>, <span class="r521 r">force</span>, <span class="r522 r">ps</span>, <span class="r523 r">fileSize</span>, <b>true</b>, <span class="r529 r">streamName</span>);
                            <b>if</b> (!<span class="r527 r">result</span>)
                            {
                                <b>break</b>;
                            }
                        }
                    }
                }
 
                <span class="c">// The file was copied successfully. Now, set the file metadata</span>
                <b>if</b> (<span class="r527 r">result</span>)
                {
                    <a href="#0c52ed323790f434" class="i method">SetFileMetadata</a>(<span class="r519 r">sourceFileFullName</span>, <span class="r524 r">destinationFile</span>, <span class="r522 r">ps</span>);
                }
            }
        }
 
        <b>private bool</b> <a id="3f1f1ea86b0f24a5" href="../R/3f1f1ea86b0f24a5.html" target="n" data-glyph="76,1" class="i method">PerformCopyFileFromRemoteSession</a>(<b>string</b> <span id="r530 rd" class="r530 r">sourceFileFullName</span>, <span class="i">FileInfo</span> <span id="r531 rd" class="r531 r">destinationFile</span>, <b>string</b> <span id="r532 rd" class="r532 r">destinationPath</span>, <b>bool</b> <span id="r533 rd" class="r533 r">force</span>, <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="../engine/hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShell</a> <span id="r534 rd" class="r534 r">ps</span>,
                                                      <b>long</b> <span id="r535 rd" class="r535 r">fileSize</span>, <b>bool</b> <span id="r536 rd" class="r536 r">isAlternateDataStream</span>, <b>string</b> <span id="r537 rd" class="r537 r">streamName</span>)
        {
            <b>bool</b> <span id="r538 rd" class="r538 r">success</span> = <b>false</b>;
            <b>string</b> <span id="r539 rd" class="r539 r">activity</span> = <b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>,
                                            <span class="i">FileSystemProviderStrings</span>.<span class="i">CopyItemRemotelyProgressActivity</span>,
                                            <span class="r530 r">sourceFileFullName</span>,
                                            <span class="r531 r">destinationFile</span>.<span class="i">FullName</span>);
            <b>string</b> <span id="r540 rd" class="r540 r">statusDescription</span> = <b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>,
                                                        <span class="i">FileSystemProviderStrings</span>.<span class="i">CopyItemRemotelyStatusDescription</span>,
                                                        <span class="r534 r">ps</span>.<a href="../engine/hostifaces/PowerShell.cs.html#ccf57242c9d46642" class="i property">Runspace</a>.<a href="../engine/hostifaces/Connection.cs.html#7ff4c79fcb624bf1" class="i property">ConnectionInfo</a>.<a href="../engine/remoting/common/RunspaceConnectionInfo.cs.html#64143b41c05cd7ea" class="i property">ComputerName</a>,
                                                        <span class="s">&quot;localhost&quot;</span>);
 
            <a href="../engine/ProgressRecord.cs.html#d79b27687c6ed8c8" class="t t">ProgressRecord</a> <span id="r541 rd" class="r541 r">progress</span> = <b>new</b> <a href="../engine/ProgressRecord.cs.html#fc5a01f49984a3f9" class="t constructor">ProgressRecord</a>(0, <span class="r539 r">activity</span>, <span class="r540 r">statusDescription</span>);
            <span class="r541 r">progress</span>.<a href="../engine/ProgressRecord.cs.html#7c559492a0012510" class="i property">PercentComplete</a> = 0;
            <span class="r541 r">progress</span>.<a href="../engine/ProgressRecord.cs.html#b83bd20609cddaf5" class="i property">RecordType</a> = <a href="../engine/ProgressRecord.cs.html#1f168993cf0b800f" class="t t">ProgressRecordType</a>.<a href="../engine/ProgressRecord.cs.html#b02a1a2b864a452c" class="i field">Processing</a>;
            <a href="ProviderBase.cs.html#94e173c0fd7ac926" class="i method">WriteProgress</a>(<span class="r541 r">progress</span>);
            <span class="i">FileStream</span> <span id="r542 rd" class="r542 r">wStream</span> = <b>null</b>;
            <b>bool</b> <span id="r543 rd" class="r543 r">errorWhileCopyRemoteFile</span> = <b>false</b>;
 
            <b>try</b>
            {
                <span class="c">// The main data stream</span>
                <b>if</b> (!<span class="r536 r">isAlternateDataStream</span>)
                {
                    <span class="c">// If force is specified, and the file already exist at the destination, mask of the readonly, hidden, and system attributes</span>
                    <b>if</b> (<span class="r533 r">force</span> &amp;&amp; <span class="i">File</span>.<span class="i">Exists</span>(<span class="r531 r">destinationFile</span>.<span class="i">FullName</span>))
                    {
                        <span class="r531 r">destinationFile</span>.<span class="i">Attributes</span> &amp;= ~(<span class="i">FileAttributes</span>.<span class="i">ReadOnly</span> | <span class="i">FileAttributes</span>.<span class="i">Hidden</span> | <span class="i">FileAttributes</span>.<span class="i">System</span>);
                    }
 
                    <span class="r542 r">wStream</span> = <b>new</b> <span class="i">FileStream</span>(<span class="r531 r">destinationFile</span>.<span class="i">FullName</span>, <span class="i">FileMode</span>.<span class="i">Create</span>);
                }
 
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">UNIX</span>
                <span class="c">// an alternate stream</span>
                <b>else</b>
                {
                    <span class="r542 r">wStream</span> = <a href="#28276e8c322107d7" class="t t">AlternateDataStreamUtilities</a>.<span class="i">CreateFileStream</span>(<span class="r531 r">destinationFile</span>.<span class="i">FullName</span>, <span class="r537 r">streamName</span>, <span class="i">FileMode</span>.<span class="i">Append</span>, <span class="i">FileAccess</span>.<span class="i">Write</span>, <span class="i">FileShare</span>.<span class="i">ReadWrite</span>);
                }
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
                <b>const long</b> <span id="r544 rd" class="r544 r">fragmentSize</span> = <a href="#be0b26e88f63b3fb" class="i field">FILETRANSFERSIZE</a>;
                <b>long</b> <span id="r545 rd" class="r545 r">copiedSoFar</span> = 0;
                <b>long</b> <span id="r546 rd" class="r546 r">currentIndex</span> = 0;
 
                <b>while</b> (<b>true</b>)
                {
                    <span class="r534 r">ps</span>.<a href="../engine/hostifaces/PowerShell.cs.html#9cc79c297f6cced9" class="i method">AddCommand</a>(<a href="#18b0063a4d2c0d48" class="t t">CopyFileRemoteUtils</a>.<a href="#7768bae509667d9d" class="i field">PSCopyFromSessionHelperName</a>);
                    <span class="r534 r">ps</span>.<a href="../engine/hostifaces/PowerShell.cs.html#40674f99a3618f4b" class="i method">AddParameter</a>(<span class="s">&quot;copyFromFilePath&quot;</span>, <span class="r530 r">sourceFileFullName</span>);
                    <span class="r534 r">ps</span>.<a href="../engine/hostifaces/PowerShell.cs.html#40674f99a3618f4b" class="i method">AddParameter</a>(<span class="s">&quot;copyFromStart&quot;</span>, <span class="r546 r">currentIndex</span>);
                    <span class="r534 r">ps</span>.<a href="../engine/hostifaces/PowerShell.cs.html#40674f99a3618f4b" class="i method">AddParameter</a>(<span class="s">&quot;copyFromNumBytes&quot;</span>, <span class="r544 r">fragmentSize</span>);
                    <b>if</b> (<span class="r533 r">force</span>)
                    {
                        <span class="r534 r">ps</span>.<a href="../engine/hostifaces/PowerShell.cs.html#40674f99a3618f4b" class="i method">AddParameter</a>(<b>nameof</b>(<span class="r533 r">force</span>), <b>true</b>);
                    }
 
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">UNIX</span>
                    <b>if</b> (<span class="r536 r">isAlternateDataStream</span>)
                    {
                        <span class="r534 r">ps</span>.<a href="../engine/hostifaces/PowerShell.cs.html#40674f99a3618f4b" class="i method">AddParameter</a>(<span class="s">&quot;isAlternateStream&quot;</span>, <b>true</b>);
                        <span class="r534 r">ps</span>.<a href="../engine/hostifaces/PowerShell.cs.html#40674f99a3618f4b" class="i method">AddParameter</a>(<b>nameof</b>(<span class="r537 r">streamName</span>), <span class="r537 r">streamName</span>);
                    }
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
 
                    <span class="i">Hashtable</span> <span id="r547 rd" class="r547 r">op</span> = <a href="#0021e65731f91d4b" class="t t">SafeInvokeCommand</a>.<a href="#52932871655c3ffb" class="i method">Invoke</a>(<span class="r534 r">ps</span>, <a href="../P/64a92af39f1cd630.html#64a92af39f1cd630" class="k">this</a>, <b>null</b>);
 
                    <span class="c">// Check if there was an exception when reading the remote file.</span>
                    <b>if</b> (<span class="r547 r">op</span> == <b>null</b>)
                    {
                        <span class="r543 r">errorWhileCopyRemoteFile</span> = <b>true</b>;
                        <span class="i">Exception</span> <span id="r548 rd" class="r548 r">e</span> = <b>new</b> <span class="i">IOException</span>(<b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>,
                                                                    <span class="i">FileSystemProviderStrings</span>.<span class="i">CopyItemRemotelyFailedToReadFile</span>,
                                                                    <span class="r530 r">sourceFileFullName</span>));
                        <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <a href="../engine/ErrorPackage.cs.html#e9334565e5136f43" class="t constructor">ErrorRecord</a>(<span class="r548 r">e</span>, <span class="s">&quot;FailedToCopyFileFromRemoteSession&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#0c2f4b9c74e5b7c2" class="i field">WriteError</a>, <span class="r530 r">sourceFileFullName</span>));
                        <b>break</b>;
                    }
 
                    <b>if</b> (<span class="r547 r">op</span>[<span class="s">&quot;ExceptionThrown&quot;</span>] != <b>null</b>)
                    {
                        <b>bool</b> <span id="r549 rd" class="r549 r">failedToReadFile</span> = (<b>bool</b>)(<span class="r547 r">op</span>[<span class="s">&quot;ExceptionThrown&quot;</span>]);
                        <b>if</b> (<span class="r549 r">failedToReadFile</span>)
                        {
                            <span class="c">// The error is written to the error array via SafeInvokeCommand</span>
                            <span class="r543 r">errorWhileCopyRemoteFile</span> = <b>true</b>;
                            <b>break</b>;
                        }
                    }
 
                    <span class="c">// To accommodate empty files</span>
                    <b>string</b> <span id="r550 rd" class="r550 r">content</span> = <b>string</b>.<span class="i">Empty</span>;
                    <b>if</b> (<span class="r547 r">op</span>[<span class="s">&quot;b64Fragment&quot;</span>] != <b>null</b>)
                    {
                        <span class="r550 r">content</span> = (<b>string</b>)<span class="r547 r">op</span>[<span class="s">&quot;b64Fragment&quot;</span>];
                    }
 
                    <b>bool</b> <span id="r551 rd" class="r551 r">more</span> = (<b>bool</b>)<span class="r547 r">op</span>[<span class="s">&quot;moreAvailable&quot;</span>];
                    <span class="r546 r">currentIndex</span> += <span class="r544 r">fragmentSize</span>;
                    <b>byte</b>[] <span id="r552 rd" class="r552 r">bytes</span> = <span class="i n">System</span>.<span class="i">Convert</span>.<span class="i">FromBase64String</span>(<span class="r550 r">content</span>);
                    <span class="r542 r">wStream</span>.<span class="i">Write</span>(<span class="r552 r">bytes</span>, 0, <span class="r552 r">bytes</span>.<span class="i">Length</span>);
                    <span class="r545 r">copiedSoFar</span> += <span class="r552 r">bytes</span>.<span class="i">Length</span>;
 
                    <b>if</b> (<span class="r542 r">wStream</span>.<span class="i">Length</span> &gt; 0)
                    {
                        <b>int</b> <span id="r553 rd" class="r553 r">percentage</span> = (<b>int</b>)(<span class="r545 r">copiedSoFar</span> * 100 / <span class="r542 r">wStream</span>.<span class="i">Length</span>);
                        <span class="r541 r">progress</span>.<a href="../engine/ProgressRecord.cs.html#7c559492a0012510" class="i property">PercentComplete</a> = <span class="r553 r">percentage</span>;
                        <a href="ProviderBase.cs.html#94e173c0fd7ac926" class="i method">WriteProgress</a>(<span class="r541 r">progress</span>);
                    }
 
                    <b>if</b> (!<span class="r551 r">more</span>)
                    {
                        <span class="r538 r">success</span> = <b>true</b>;
                        <b>break</b>;
                    }
                }
 
                <span class="r541 r">progress</span>.<a href="../engine/ProgressRecord.cs.html#7c559492a0012510" class="i property">PercentComplete</a> = 100;
                <span class="r541 r">progress</span>.<a href="../engine/ProgressRecord.cs.html#b83bd20609cddaf5" class="i property">RecordType</a> = <a href="../engine/ProgressRecord.cs.html#1f168993cf0b800f" class="t t">ProgressRecordType</a>.<a href="../engine/ProgressRecord.cs.html#be29e101fe03f5d0" class="i field">Completed</a>;
                <a href="ProviderBase.cs.html#94e173c0fd7ac926" class="i method">WriteProgress</a>(<span class="r541 r">progress</span>);
            }
            <b>catch</b> (<span class="i">IOException</span> <span id="r554 rd" class="r554 r">ioException</span>)
            {
                <span class="c">// IOException takes care of FileNotFoundException, DirectoryNotFoundException, and PathTooLongException</span>
                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r554 r">ioException</span>, <span class="s">&quot;CopyItemRemotelyIOError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#0c2f4b9c74e5b7c2" class="i field">WriteError</a>, <span class="r530 r">sourceFileFullName</span>));
            }
            <b>catch</b> (<span class="i">ArgumentException</span> <span id="r555 rd" class="r555 r">argException</span>)
            {
                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r555 r">argException</span>, <span class="s">&quot;CopyItemRemotelyArgumentError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#0c2f4b9c74e5b7c2" class="i field">WriteError</a>, <span class="r530 r">sourceFileFullName</span>));
            }
            <b>catch</b> (<span class="i">NotSupportedException</span> <span id="r556 rd" class="r556 r">notSupportedException</span>)
            {
                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r556 r">notSupportedException</span>, <span class="s">&quot;CopyFileInfoRemotelyPathRefersToANonFileDevice&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#846d2b572f2c4820" class="i field">InvalidArgument</a>, <span class="r530 r">sourceFileFullName</span>));
            }
            <b>catch</b> (<span class="i">SecurityException</span> <span id="r557 rd" class="r557 r">securityException</span>)
            {
                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r557 r">securityException</span>, <span class="s">&quot;CopyFileInfoRemotelyUnauthorizedAccessError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#26ba13af79d30a75" class="i field">PermissionDenied</a>, <span class="r530 r">sourceFileFullName</span>));
            }
            <b>catch</b> (<span class="i">UnauthorizedAccessException</span> <span id="r558 rd" class="r558 r">unauthorizedAccessException</span>)
            {
                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r558 r">unauthorizedAccessException</span>, <span class="s">&quot;CopyFileInfoItemRemotelyUnauthorizedAccessError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#26ba13af79d30a75" class="i field">PermissionDenied</a>, <span class="r530 r">sourceFileFullName</span>));
            }
            <b>finally</b>
            {
                <b>if</b> (<span class="r542 r">wStream</span> != <b>null</b>)
                {
                    <span class="r542 r">wStream</span>.<span class="i">Dispose</span>();
                }
 
                <span class="c">// If copying the file from the remote session failed, then remove it.</span>
                <b>if</b> (<span class="r543 r">errorWhileCopyRemoteFile</span> &amp;&amp; <span class="i">File</span>.<span class="i">Exists</span>(<span class="r531 r">destinationFile</span>.<span class="i">FullName</span>))
                {
                    <b>if</b> (!(<span class="r531 r">destinationFile</span>.<span class="i">Attributes</span>.<span class="i">HasFlag</span>(<span class="i">FileAttributes</span>.<span class="i">ReadOnly</span>) ||
                            <span class="r531 r">destinationFile</span>.<span class="i">Attributes</span>.<span class="i">HasFlag</span>(<span class="i">FileAttributes</span>.<span class="i">Hidden</span>) ||
                            <span class="r531 r">destinationFile</span>.<span class="i">Attributes</span>.<span class="i">HasFlag</span>(<span class="i">FileAttributes</span>.<span class="i">System</span>)))
                    {
                        <span class="i">RemoveFileSystemItem</span>(<span class="r531 r">destinationFile</span>, <b>true</b>);
                    }
                }
            }
 
            <b>return</b> <span class="r538 r">success</span>;
        }
 
        <b>private void</b> <a id="96099715ea4c00a3" href="../R/96099715ea4c00a3.html" target="n" data-glyph="76,1" class="i method">InitializeFunctionsPSCopyFileToRemoteSession</a>(<span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="../engine/hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShell</a> <span id="r559 rd" class="r559 r">ps</span>)
        {
            <b>if</b> ((<span class="r559 r">ps</span> == <b>null</b>) || !<a href="#0852ca5d36bc9fd8" class="i method">ValidRemoteSessionForScripting</a>(<span class="r559 r">ps</span>.<a href="../engine/hostifaces/PowerShell.cs.html#ccf57242c9d46642" class="i property">Runspace</a>)) { <b>return</b>; }
 
            <span class="r559 r">ps</span>.<a href="../engine/hostifaces/PowerShell.cs.html#c97f8d15a2f93e31" class="i method">AddScript</a>(<a href="#18b0063a4d2c0d48" class="t t">CopyFileRemoteUtils</a>.<a href="#d5ab88936d4b338b" class="i field">AllCopyToRemoteScripts</a>);
            <a href="#0021e65731f91d4b" class="t t">SafeInvokeCommand</a>.<a href="#33792f673831f08f" class="i method">Invoke</a>(<span class="r559 r">ps</span>, <a href="../P/64a92af39f1cd630.html#64a92af39f1cd630" class="k">this</a>, <b>null</b>, <b>false</b>);
        }
 
        <b>private void</b> <a id="393993531ccd57fc" href="../R/393993531ccd57fc.html" target="n" data-glyph="76,1" class="i method">RemoveFunctionPSCopyFileToRemoteSession</a>(<span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="../engine/hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShell</a> <span id="r560 rd" class="r560 r">ps</span>)
        {
            <b>if</b> ((<span class="r560 r">ps</span> == <b>null</b>) || !<a href="#0852ca5d36bc9fd8" class="i method">ValidRemoteSessionForScripting</a>(<span class="r560 r">ps</span>.<a href="../engine/hostifaces/PowerShell.cs.html#ccf57242c9d46642" class="i property">Runspace</a>)) { <b>return</b>; }
 
            <b>const string</b> <span id="r561 rd" class="r561 r">remoteScript</span> = <span class="s">@&quot;
                Microsoft.PowerShell.Management\Remove-Item function:PSCopyToSessionHelper -ea SilentlyContinue -Force
                Microsoft.PowerShell.Management\Remove-Item function:PSCopyRemoteUtils -ea SilentlyContinue -Force
            &quot;</span>;
            <span class="r560 r">ps</span>.<a href="../engine/hostifaces/PowerShell.cs.html#c97f8d15a2f93e31" class="i method">AddScript</a>(<span class="r561 r">remoteScript</span>);
            <a href="#0021e65731f91d4b" class="t t">SafeInvokeCommand</a>.<a href="#33792f673831f08f" class="i method">Invoke</a>(<span class="r560 r">ps</span>, <a href="../P/64a92af39f1cd630.html#64a92af39f1cd630" class="k">this</a>, <b>null</b>, <b>false</b>);
        }
 
        <span class="c">// If the target supports alternate data streams the following must be true:</span>
        <span class="c">// 1) The remote session must be PowerShell V3 or higher to support Streams</span>
        <span class="c">// 2) The target drive must be NTFS</span>
        <b>private bool</b> <a id="207e563ff6ab7c7a" href="../R/207e563ff6ab7c7a.html" target="n" data-glyph="76,1" class="i method">RemoteTargetSupportsAlternateStreams</a>(<span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="../engine/hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShell</a> <span id="r562 rd" class="r562 r">ps</span>, <b>string</b> <span id="r563 rd" class="r563 r">path</span>)
        {
            <b>bool</b> <span id="r564 rd" class="r564 r">supportsAlternateStreams</span> = <b>false</b>;
 
            <span class="r562 r">ps</span>.<a href="../engine/hostifaces/PowerShell.cs.html#9cc79c297f6cced9" class="i method">AddCommand</a>(<a href="#18b0063a4d2c0d48" class="t t">CopyFileRemoteUtils</a>.<a href="#3bb0f47e99c017c4" class="i field">PSCopyToSessionHelperName</a>);
            <span class="r562 r">ps</span>.<a href="../engine/hostifaces/PowerShell.cs.html#40674f99a3618f4b" class="i method">AddParameter</a>(<span class="s">&quot;supportAltStreamPath&quot;</span>, <span class="r563 r">path</span>);
 
            <span class="i">Hashtable</span> <span id="r565 rd" class="r565 r">op</span> = <a href="#0021e65731f91d4b" class="t t">SafeInvokeCommand</a>.<a href="#52932871655c3ffb" class="i method">Invoke</a>(<span class="r562 r">ps</span>, <a href="../P/64a92af39f1cd630.html#64a92af39f1cd630" class="k">this</a>, <b>null</b>);
            <b>if</b> (<span class="r565 r">op</span> != <b>null</b> &amp;&amp; <span class="r565 r">op</span>[<span class="s">&quot;TargetSupportsAlternateStreams&quot;</span>] != <b>null</b>)
            {
                <span class="r564 r">supportsAlternateStreams</span> = (<b>bool</b>)<span class="r565 r">op</span>[<span class="s">&quot;TargetSupportsAlternateStreams&quot;</span>];
            }
 
            <b>return</b> <span class="r564 r">supportsAlternateStreams</span>;
        }
 
        <span class="c">// Validate that the given remotePath exists, and do the following:</span>
        <span class="c">// 1) If the remotePath is a FileInfo, then just return the remotePath.</span>
        <span class="c">// 2) If the remotePath is a DirectoryInfo, then return the remotePath + the given filename.</span>
        <span class="c">// 3) If the remote path does not exist, but its parent does, and it is a DirectoryInfo, then return the remotePath.</span>
        <span class="c">// 4) If the remotePath or its parent do not exist, return null.</span>
        <b>private string</b> <a id="24cdb1b2391ec926" href="../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">MakeRemotePath</a>(<span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="../engine/hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShell</a> <span id="r566 rd" class="r566 r">ps</span>, <b>string</b> <span id="r567 rd" class="r567 r">remotePath</span>, <b>string</b> <span id="r568 rd" class="r568 r">filename</span>)
        {
            <b>bool</b> <span id="r569 rd" class="r569 r">isFileInfo</span> = <b>false</b>;
            <b>bool</b> <span id="r570 rd" class="r570 r">isDirectoryInfo</span> = <b>false</b>;
            <b>bool</b> <span id="r571 rd" class="r571 r">parentIsDirectoryInfo</span> = <b>false</b>;
            <b>string</b> <span id="r572 rd" class="r572 r">path</span> = <b>null</b>;
 
            <span class="r566 r">ps</span>.<a href="../engine/hostifaces/PowerShell.cs.html#9cc79c297f6cced9" class="i method">AddCommand</a>(<a href="#18b0063a4d2c0d48" class="t t">CopyFileRemoteUtils</a>.<a href="#3bb0f47e99c017c4" class="i field">PSCopyToSessionHelperName</a>);
            <span class="r566 r">ps</span>.<a href="../engine/hostifaces/PowerShell.cs.html#40674f99a3618f4b" class="i method">AddParameter</a>(<b>nameof</b>(<span class="r567 r">remotePath</span>), <span class="r567 r">remotePath</span>);
            <span class="i">Hashtable</span> <span id="r573 rd" class="r573 r">op</span> = <a href="#0021e65731f91d4b" class="t t">SafeInvokeCommand</a>.<a href="#52932871655c3ffb" class="i method">Invoke</a>(<span class="r566 r">ps</span>, <a href="../P/64a92af39f1cd630.html#64a92af39f1cd630" class="k">this</a>, <b>null</b>);
 
            <b>if</b> (<span class="r573 r">op</span> != <b>null</b>)
            {
                <b>if</b> (<span class="r573 r">op</span>[<span class="s">&quot;IsDirectoryInfo&quot;</span>] != <b>null</b>)
                {
                    <span class="r570 r">isDirectoryInfo</span> = (<b>bool</b>)<span class="r573 r">op</span>[<span class="s">&quot;IsDirectoryInfo&quot;</span>];
                }
 
                <b>if</b> (<span class="r573 r">op</span>[<span class="s">&quot;IsFileInfo&quot;</span>] != <b>null</b>)
                {
                    <span class="r569 r">isFileInfo</span> = (<b>bool</b>)<span class="r573 r">op</span>[<span class="s">&quot;IsFileInfo&quot;</span>];
                }
 
                <b>if</b> (<span class="r573 r">op</span>[<span class="s">&quot;ParentIsDirectoryInfo&quot;</span>] != <b>null</b>)
                {
                    <span class="r571 r">parentIsDirectoryInfo</span> = (<b>bool</b>)<span class="r573 r">op</span>[<span class="s">&quot;ParentIsDirectoryInfo&quot;</span>];
                }
            }
 
            <b>if</b> (<span class="r569 r">isFileInfo</span>)
            {
                <span class="c">// The destination is a file, so we are going to overwrite it.</span>
                <span class="r572 r">path</span> = <span class="r567 r">remotePath</span>;
            }
            <b>else</b> <b>if</b> (<span class="r570 r">isDirectoryInfo</span>)
            {
                <span class="c">// The destination is a directory, so append the file name to the path.</span>
                <span class="r572 r">path</span> = <span class="i">Path</span>.<span class="i">Combine</span>(<span class="r567 r">remotePath</span>, <span class="r568 r">filename</span>);
            }
            <b>else</b> <b>if</b> (<span class="r571 r">parentIsDirectoryInfo</span>)
            {
                <span class="c">// At this point we know that the remotePath is neither a file or a directory on the remote target.</span>
                <span class="c">// However, if the parent of the remotePath exists, then we are doing a copy-item operation in which</span>
                <span class="c">// the destination file name is already being passed, e.g.,</span>
                <span class="c">// copy-item -path c:\localDir\foo.txt -destination d:\remoteDir\bar.txt -toSession $s</span>
                <span class="c">// Note that d:\remoteDir is a directory that exists on the remote target machine.</span>
                <span class="r572 r">path</span> = <span class="r567 r">remotePath</span>;
            }
 
            <b>return</b> <span class="r572 r">path</span>;
        }
 
        <b>private bool</b> <a id="a504b7239c357e85" href="../R/a504b7239c357e85.html" target="n" data-glyph="76,1" class="i method">RemoteDirectoryExist</a>(<span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="../engine/hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShell</a> <span id="r574 rd" class="r574 r">ps</span>, <b>string</b> <span id="r575 rd" class="r575 r">path</span>)
        {
            <b>bool</b> <span id="r576 rd" class="r576 r">pathExists</span> = <b>false</b>;
 
            <span class="r574 r">ps</span>.<a href="../engine/hostifaces/PowerShell.cs.html#9cc79c297f6cced9" class="i method">AddCommand</a>(<a href="#18b0063a4d2c0d48" class="t t">CopyFileRemoteUtils</a>.<a href="#147015726857e7cc" class="i field">PSCopyRemoteUtilsName</a>);
            <span class="r574 r">ps</span>.<a href="../engine/hostifaces/PowerShell.cs.html#40674f99a3618f4b" class="i method">AddParameter</a>(<span class="s">&quot;dirPathExists&quot;</span>, <span class="r575 r">path</span>);
            <span class="i">Hashtable</span> <span id="r577 rd" class="r577 r">op</span> = <a href="#0021e65731f91d4b" class="t t">SafeInvokeCommand</a>.<a href="#52932871655c3ffb" class="i method">Invoke</a>(<span class="r574 r">ps</span>, <a href="../P/64a92af39f1cd630.html#64a92af39f1cd630" class="k">this</a>, <b>null</b>);
 
            <b>if</b> (<span class="r577 r">op</span> != <b>null</b>)
            {
                <b>if</b> (<span class="r577 r">op</span>[<span class="s">&quot;Exists&quot;</span>] != <b>null</b>)
                    <span class="r576 r">pathExists</span> = (<b>bool</b>)<span class="r577 r">op</span>[<span class="s">&quot;Exists&quot;</span>];
            }
 
            <b>return</b> <span class="r576 r">pathExists</span>;
        }
 
        <b>private bool</b> <a id="208e659c91e1f7e3" href="../R/208e659c91e1f7e3.html" target="n" data-glyph="76,1" class="i method">CopyFileStreamToRemoteSession</a>(<span class="i">FileInfo</span> <span id="r578 rd" class="r578 r">file</span>, <b>string</b> <span id="r579 rd" class="r579 r">destinationPath</span>, <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="../engine/hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShell</a> <span id="r580 rd" class="r580 r">ps</span>, <b>bool</b> <span id="r581 rd" class="r581 r">isAlternateStream</span>, <b>string</b> <span id="r582 rd" class="r582 r">streamName</span>)
        {
            <b>string</b> <span id="r583 rd" class="r583 r">activity</span> = <b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>,
                                            <span class="i">FileSystemProviderStrings</span>.<span class="i">CopyItemRemotelyProgressActivity</span>,
                                            <span class="r578 r">file</span>.<span class="i">FullName</span>,
                                            <span class="r579 r">destinationPath</span>);
            <b>string</b> <span id="r584 rd" class="r584 r">statusDescription</span> = <b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>,
                                                     <span class="i">FileSystemProviderStrings</span>.<span class="i">CopyItemRemotelyStatusDescription</span>,
                                                     <span class="s">&quot;localhost&quot;</span>,
                                                     <span class="r580 r">ps</span>.<a href="../engine/hostifaces/PowerShell.cs.html#ccf57242c9d46642" class="i property">Runspace</a>.<a href="../engine/hostifaces/Connection.cs.html#7ff4c79fcb624bf1" class="i property">ConnectionInfo</a>.<a href="../engine/remoting/common/RunspaceConnectionInfo.cs.html#64143b41c05cd7ea" class="i property">ComputerName</a>);
 
            <a href="../engine/ProgressRecord.cs.html#d79b27687c6ed8c8" class="t t">ProgressRecord</a> <span id="r585 rd" class="r585 r">progress</span> = <b>new</b> <a href="../engine/ProgressRecord.cs.html#fc5a01f49984a3f9" class="t constructor">ProgressRecord</a>(0, <span class="r583 r">activity</span>, <span class="r584 r">statusDescription</span>);
            <span class="r585 r">progress</span>.<a href="../engine/ProgressRecord.cs.html#7c559492a0012510" class="i property">PercentComplete</a> = 0;
            <span class="r585 r">progress</span>.<a href="../engine/ProgressRecord.cs.html#b83bd20609cddaf5" class="i property">RecordType</a> = <a href="../engine/ProgressRecord.cs.html#1f168993cf0b800f" class="t t">ProgressRecordType</a>.<a href="../engine/ProgressRecord.cs.html#b02a1a2b864a452c" class="i field">Processing</a>;
            <a href="ProviderBase.cs.html#94e173c0fd7ac926" class="i method">WriteProgress</a>(<span class="r585 r">progress</span>);
 
            <span class="c">// 4MB gives the best results without spiking the resources on the remote connection.</span>
            <b>const int</b> <span id="r586 rd" class="r586 r">fragmentSize</span> = <a href="#be0b26e88f63b3fb" class="i field">FILETRANSFERSIZE</a>;
            <b>byte</b>[] <span id="r587 rd" class="r587 r">fragment</span> = <b>null</b>;
            <b>int</b> <span id="r588 rd" class="r588 r">iteration</span> = 0;
            <b>bool</b> <span id="r589 rd" class="r589 r">success</span> = <b>false</b>;
 
            <span class="i">FileStream</span> <span id="r590 rd" class="r590 r">fStream</span> = <b>null</b>;
            <b>try</b>
            {
                <span class="c">// Main data stream</span>
                <b>if</b> (!<span class="r581 r">isAlternateStream</span>)
                {
                    <span class="r590 r">fStream</span> = <span class="i">File</span>.<span class="i">OpenRead</span>(<span class="r578 r">file</span>.<span class="i">FullName</span>);
                }
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">UNIX</span>
                <b>else</b>
                {
                    <span class="r590 r">fStream</span> = <a href="#28276e8c322107d7" class="t t">AlternateDataStreamUtilities</a>.<span class="i">CreateFileStream</span>(<span class="r578 r">file</span>.<span class="i">FullName</span>, <span class="r582 r">streamName</span>, <span class="i">FileMode</span>.<span class="i">Open</span>, <span class="i">FileAccess</span>.<span class="i">Read</span>, <span class="i">FileShare</span>.<span class="i">ReadWrite</span>);
                }
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
                <b>long</b> <span id="r591 rd" class="r591 r">remainingFileSize</span> = <span class="r590 r">fStream</span> != <b>null</b> ? <span class="r590 r">fStream</span>.<span class="i">Length</span> : 0;
                <b>do</b>
                {
                    <b>if</b> (<a href="ProviderBase.cs.html#7f198513b75d23b5" class="i property">Stopping</a>)
                    {
                        <b>return</b> <b>false</b>;
                    }
 
                    <span class="r588 r">iteration</span>++;
                    <b>int</b> <span id="r592 rd" class="r592 r">toRead</span> = <span class="r586 r">fragmentSize</span>;
                    <b>if</b> (<span class="r592 r">toRead</span> &gt; <span class="r591 r">remainingFileSize</span>)
                    {
                        <span class="r592 r">toRead</span> = (<b>int</b>)<span class="r591 r">remainingFileSize</span>;
                    }
 
                    <b>if</b> (<span class="r587 r">fragment</span> == <b>null</b>)
                    {
                        <span class="r587 r">fragment</span> = <b>new</b> <b>byte</b>[<span class="r592 r">toRead</span>];
                    }
                    <b>else</b> <b>if</b> (<span class="r592 r">toRead</span> &lt; <span class="r586 r">fragmentSize</span>)
                    {
                        <span class="r587 r">fragment</span> = <b>new</b> <b>byte</b>[<span class="r592 r">toRead</span>];
                    }
 
                    <b>int</b> <span id="r593 rd" class="r593 r">readSoFar</span> = 0;
                    <b>while</b> (<span class="r593 r">readSoFar</span> &lt; <span class="r592 r">toRead</span>)
                    {
                        <span class="r593 r">readSoFar</span> += <span class="r590 r">fStream</span>.<span class="i">Read</span>(<span class="r587 r">fragment</span>, 0, <span class="r592 r">toRead</span>);
                    }
 
                    <span class="r591 r">remainingFileSize</span> -= <span class="r593 r">readSoFar</span>;
 
                    <b>string</b> <span id="r594 rd" class="r594 r">b64Fragment</span> = <span class="i n">System</span>.<span class="i">Convert</span>.<span class="i">ToBase64String</span>(<span class="r587 r">fragment</span>);
 
                    <span class="c">// Main data stream</span>
                    <b>if</b> (!<span class="r581 r">isAlternateStream</span>)
                    {
                        <span class="r580 r">ps</span>.<a href="../engine/hostifaces/PowerShell.cs.html#9cc79c297f6cced9" class="i method">AddCommand</a>(<a href="#18b0063a4d2c0d48" class="t t">CopyFileRemoteUtils</a>.<a href="#3bb0f47e99c017c4" class="i field">PSCopyToSessionHelperName</a>);
                        <span class="r580 r">ps</span>.<a href="../engine/hostifaces/PowerShell.cs.html#40674f99a3618f4b" class="i method">AddParameter</a>(<span class="s">&quot;copyToFilePath&quot;</span>, <span class="r579 r">destinationPath</span>);
                        <span class="r580 r">ps</span>.<a href="../engine/hostifaces/PowerShell.cs.html#40674f99a3618f4b" class="i method">AddParameter</a>(<span class="s">&quot;createFile&quot;</span>, (<span class="r588 r">iteration</span> == 1));
 
                        <b>if</b> ((<span class="r588 r">iteration</span> == 1) &amp;&amp; (<span class="r594 r">b64Fragment</span>.<span class="i">Length</span> == 0))
                        {
                            <span class="c">// This fixes the case in which the user tries to copy an empty file between sessions.</span>
                            <span class="c">// Scenario 1: The user creates an empty file using the Out-File cmdlet.</span>
                            <span class="c">//             In this case the file length is 6.</span>
                            <span class="c">//             &quot;&quot; | out-file test.txt</span>
                            <span class="c">// Scenario 2: The user generates an empty file using the New-Item cmdlet.</span>
                            <span class="c">//             In this case the file length is 0.</span>
                            <span class="c">//             New-Item -Path test.txt -Type File</span>
                            <span class="c">// Because of this, when we create the file on the remote session, we need to check</span>
                            <span class="c">// the length of b64Fragment to figure out if we are creating an empty file.</span>
                            <span class="r580 r">ps</span>.<a href="../engine/hostifaces/PowerShell.cs.html#40674f99a3618f4b" class="i method">AddParameter</a>(<span class="s">&quot;emptyFile&quot;</span>, <b>true</b>);
                        }
                        <b>else</b>
                        {
                            <span class="r580 r">ps</span>.<a href="../engine/hostifaces/PowerShell.cs.html#40674f99a3618f4b" class="i method">AddParameter</a>(<span class="s">&quot;b64Fragment&quot;</span>, <span class="r594 r">b64Fragment</span>);
                        }
                    }
                    <b>else</b>
                    {
                        <span class="r580 r">ps</span>.<a href="../engine/hostifaces/PowerShell.cs.html#9cc79c297f6cced9" class="i method">AddCommand</a>(<a href="#18b0063a4d2c0d48" class="t t">CopyFileRemoteUtils</a>.<a href="#3bb0f47e99c017c4" class="i field">PSCopyToSessionHelperName</a>);
                        <span class="r580 r">ps</span>.<a href="../engine/hostifaces/PowerShell.cs.html#40674f99a3618f4b" class="i method">AddParameter</a>(<span class="s">&quot;copyToFilePath&quot;</span>, <span class="r579 r">destinationPath</span>);
                        <span class="r580 r">ps</span>.<a href="../engine/hostifaces/PowerShell.cs.html#40674f99a3618f4b" class="i method">AddParameter</a>(<span class="s">&quot;b64Fragment&quot;</span>, <span class="r594 r">b64Fragment</span>);
                        <span class="r580 r">ps</span>.<a href="../engine/hostifaces/PowerShell.cs.html#40674f99a3618f4b" class="i method">AddParameter</a>(<b>nameof</b>(<span class="r582 r">streamName</span>), <span class="r582 r">streamName</span>);
                    }
 
                    <span class="i">Hashtable</span> <span id="r595 rd" class="r595 r">op</span> = <a href="#0021e65731f91d4b" class="t t">SafeInvokeCommand</a>.<a href="#52932871655c3ffb" class="i method">Invoke</a>(<span class="r580 r">ps</span>, <a href="../P/64a92af39f1cd630.html#64a92af39f1cd630" class="k">this</a>, <b>null</b>);
                    <b>if</b> (<span class="r595 r">op</span> == <b>null</b> || <span class="r595 r">op</span>[<span class="s">&quot;BytesWritten&quot;</span>] == <b>null</b>)
                    {
                        <span class="c">// write error to stream</span>
                        <span class="i">Exception</span> <span id="r596 rd" class="r596 r">e</span> = <b>new</b> <span class="i">IOException</span>(<b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>, <span class="i">FileSystemProviderStrings</span>.<span class="i">CopyItemRemotelyFailed</span>, <span class="r578 r">file</span>));
                        <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r596 r">e</span>, <span class="s">&quot;CopyError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#0c2f4b9c74e5b7c2" class="i field">WriteError</a>, <span class="r578 r">file</span>.<span class="i">FullName</span>));
                        <b>return</b> <b>false</b>;
                    }
 
                    <b>if</b> ((<b>int</b>)(<span class="r595 r">op</span>[<span class="s">&quot;BytesWritten&quot;</span>]) != <span class="r592 r">toRead</span>)
                    {
                        <span class="i">Exception</span> <span id="r597 rd" class="r597 r">e</span> = <b>new</b> <span class="i">IOException</span>(<b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>, <span class="i">FileSystemProviderStrings</span>.<span class="i">CopyItemRemotelyFailed</span>, <span class="r578 r">file</span>));
                        <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r597 r">e</span>, <span class="s">&quot;CopyError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#0c2f4b9c74e5b7c2" class="i field">WriteError</a>, <span class="r578 r">file</span>.<span class="i">FullName</span>));
                        <b>return</b> <b>false</b>;
                    }
 
                    <b>if</b> (<span class="r590 r">fStream</span>.<span class="i">Length</span> &gt; 0)
                    {
                        <b>int</b> <span id="r598 rd" class="r598 r">percentage</span> = (<b>int</b>)((<span class="r590 r">fStream</span>.<span class="i">Length</span> - <span class="r591 r">remainingFileSize</span>) * 100 / <span class="r590 r">fStream</span>.<span class="i">Length</span>);
                        <span class="r585 r">progress</span>.<a href="../engine/ProgressRecord.cs.html#7c559492a0012510" class="i property">PercentComplete</a> = <span class="r598 r">percentage</span>;
                        <a href="ProviderBase.cs.html#94e173c0fd7ac926" class="i method">WriteProgress</a>(<span class="r585 r">progress</span>);
                    }
                } <b>while</b> (<span class="r591 r">remainingFileSize</span> &gt; 0);
                <span class="r585 r">progress</span>.<a href="../engine/ProgressRecord.cs.html#7c559492a0012510" class="i property">PercentComplete</a> = 100;
                <span class="r585 r">progress</span>.<a href="../engine/ProgressRecord.cs.html#b83bd20609cddaf5" class="i property">RecordType</a> = <a href="../engine/ProgressRecord.cs.html#1f168993cf0b800f" class="t t">ProgressRecordType</a>.<a href="../engine/ProgressRecord.cs.html#be29e101fe03f5d0" class="i field">Completed</a>;
                <a href="ProviderBase.cs.html#94e173c0fd7ac926" class="i method">WriteProgress</a>(<span class="r585 r">progress</span>);
                <span class="r589 r">success</span> = <b>true</b>;
            }
            <b>catch</b> (<span class="i">IOException</span> <span id="r599 rd" class="r599 r">ioException</span>)
            {
                <span class="c">// IOException takes care of FileNotFoundException, DirectoryNotFoundException, and PathTooLongException</span>
                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r599 r">ioException</span>, <span class="s">&quot;CopyItemRemotelyIOError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#0c2f4b9c74e5b7c2" class="i field">WriteError</a>, <span class="r578 r">file</span>.<span class="i">FullName</span>));
            }
            <b>catch</b> (<span class="i">ArgumentException</span> <span id="r600 rd" class="r600 r">argException</span>)
            {
                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r600 r">argException</span>, <span class="s">&quot;CopyItemRemotelyArgumentError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#0c2f4b9c74e5b7c2" class="i field">WriteError</a>, <span class="r578 r">file</span>.<span class="i">FullName</span>));
            }
            <b>catch</b> (<span class="i">NotSupportedException</span> <span id="r601 rd" class="r601 r">notSupportedException</span>)
            {
                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r601 r">notSupportedException</span>, <span class="s">&quot;CopyFileInfoRemotelyPathRefersToANonFileDevice&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#846d2b572f2c4820" class="i field">InvalidArgument</a>, <span class="r578 r">file</span>.<span class="i">FullName</span>));
            }
            <b>catch</b> (<span class="i">SecurityException</span> <span id="r602 rd" class="r602 r">securityException</span>)
            {
                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r602 r">securityException</span>, <span class="s">&quot;CopyFileInfoRemotelyUnauthorizedAccessError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#26ba13af79d30a75" class="i field">PermissionDenied</a>, <span class="r578 r">file</span>.<span class="i">FullName</span>));
            }
            <b>finally</b>
            {
                <b>if</b> (<span class="r590 r">fStream</span> != <b>null</b>)
                {
                    <span class="r590 r">fStream</span>.<span class="i">Dispose</span>();
                }
            }
 
            <b>return</b> <span class="r589 r">success</span>;
        }
 
        <span class="c">// Returns a hash table with metadata about this file info.</span>
        <span class="c">//</span>
        <b>private static</b> <span class="i">Hashtable</span> <a id="a549c58526a2a923" href="../R/a549c58526a2a923.html" target="n" data-glyph="76,1" class="i method">GetFileMetadata</a>(<span class="i">FileInfo</span> <span id="r603 rd" class="r603 r">file</span>)
        {
            <span class="i">Hashtable</span> <span id="r604 rd" class="r604 r">metadata</span> = <b>new</b> <span class="i">Hashtable</span>();
 
            <span class="c">// LastWriteTime</span>
            <span class="r604 r">metadata</span>.<span class="i">Add</span>(<span class="s">&quot;LastWriteTime&quot;</span>, <span class="r603 r">file</span>.<span class="i">LastWriteTime</span>);
            <span class="r604 r">metadata</span>.<span class="i">Add</span>(<span class="s">&quot;LastWriteTimeUtc&quot;</span>, <span class="r603 r">file</span>.<span class="i">LastWriteTimeUtc</span>);
 
            <span class="c">// File attributes</span>
            <span class="r604 r">metadata</span>.<span class="i">Add</span>(<span class="s">&quot;Attributes&quot;</span>, <span class="r603 r">file</span>.<span class="i">Attributes</span>);
 
            <b>return</b> <span class="r604 r">metadata</span>;
        }
 
        <b>private void</b> <a id="1bfab5249f6d04b4" href="../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">SetRemoteFileMetadata</a>(<span class="i">FileInfo</span> <span id="r605 rd" class="r605 r">file</span>, <b>string</b> <span id="r606 rd" class="r606 r">remoteFilePath</span>, <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="../engine/hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShell</a> <span id="r607 rd" class="r607 r">ps</span>)
        {
            <span class="i">Hashtable</span> <span id="r608 rd" class="r608 r">metadata</span> = <a href="#a549c58526a2a923" class="i method">GetFileMetadata</a>(<span class="r605 r">file</span>);
            <b>if</b> (<span class="r608 r">metadata</span> != <b>null</b>)
            {
                <span class="r607 r">ps</span>.<a href="../engine/hostifaces/PowerShell.cs.html#9cc79c297f6cced9" class="i method">AddCommand</a>(<a href="#18b0063a4d2c0d48" class="t t">CopyFileRemoteUtils</a>.<a href="#3bb0f47e99c017c4" class="i field">PSCopyToSessionHelperName</a>);
                <span class="r607 r">ps</span>.<a href="../engine/hostifaces/PowerShell.cs.html#40674f99a3618f4b" class="i method">AddParameter</a>(<span class="s">&quot;metaDataFilePath&quot;</span>, <span class="r606 r">remoteFilePath</span>);
                <span class="r607 r">ps</span>.<span class="i">AddParameter</span>(<span class="s">&quot;metaDataToSet&quot;</span>, <span class="r608 r">metadata</span>);
                <a href="#0021e65731f91d4b" class="t t">SafeInvokeCommand</a>.<a href="#33792f673831f08f" class="i method">Invoke</a>(<span class="r607 r">ps</span>, <a href="../P/64a92af39f1cd630.html#64a92af39f1cd630" class="k">this</a>, <b>null</b>, <b>false</b>);
            }
        }
 
        <b>private bool</b> <a id="2f20ab3135dfeee6" href="../R/2f20ab3135dfeee6.html" target="n" data-glyph="76,1" class="i method">PerformCopyFileToRemoteSession</a>(<span class="i">FileInfo</span> <span id="r609 rd" class="r609 r">file</span>, <b>string</b> <span id="r610 rd" class="r610 r">destinationPath</span>, <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="../engine/hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShell</a> <span id="r611 rd" class="r611 r">ps</span>)
        {
            <span class="c">// Make the remote path</span>
            <b>var</b> <span id="r612 rd" class="r612 r">remoteFilePath</span> = <span class="i">MakeRemotePath</span>(<span class="r611 r">ps</span>, <span class="r610 r">destinationPath</span>, <span class="r609 r">file</span>.<span class="i">Name</span>);
 
            <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r612 r">remoteFilePath</span>))
            {
                <span class="i">Exception</span> <span id="r613 rd" class="r613 r">e</span> = <b>new</b> <span class="i">ArgumentException</span>(<b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>, <span class="i">SessionStateStrings</span>.<span class="i">PathNotFound</span>, <span class="r610 r">destinationPath</span>));
                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <a href="../engine/ErrorPackage.cs.html#e9334565e5136f43" class="t constructor">ErrorRecord</a>(<span class="r613 r">e</span>, <span class="s">&quot;RemotePathNotFound&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#0c2f4b9c74e5b7c2" class="i field">WriteError</a>, <span class="r610 r">destinationPath</span>));
                <b>return</b> <b>false</b>;
            }
 
            <b>bool</b> <span id="r614 rd" class="r614 r">result</span> = <a href="#208e659c91e1f7e3" class="i method">CopyFileStreamToRemoteSession</a>(<span class="r609 r">file</span>, <span class="r612 r">remoteFilePath</span>, <span class="r611 r">ps</span>, <b>false</b>, <b>null</b>);
 
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">UNIX</span>
            <b>bool</b> <span id="r615 rd" class="r615 r">targetSupportsAlternateStreams</span> = <a href="#207e563ff6ab7c7a" class="i method">RemoteTargetSupportsAlternateStreams</a>(<span class="r611 r">ps</span>, <span class="r612 r">remoteFilePath</span>);
 
            <span class="c">// Once the file is copied successfully, check if the file has any alternate data streams</span>
            <b>if</b> (<span class="r614 r">result</span> &amp;&amp; <span class="r615 r">targetSupportsAlternateStreams</span>)
            {
                <b>foreach</b> (<a href="#bed6b027cd443111" class="t t">AlternateStreamData</a> <span id="r616 rd" class="r616 r">stream</span> <b>in</b> <a href="#28276e8c322107d7" class="t t">AlternateDataStreamUtilities</a>.<span class="i">GetStreams</span>(<span class="r609 r">file</span>.<span class="i">FullName</span>))
                {
                    <b>if</b> (!(<b>string</b>.<span class="i">Equals</span>(<span class="s">&quot;:$DATA&quot;</span>, <span class="r616 r">stream</span>.<a href="#74a4aa230d954592" class="i property">Stream</a>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>)))
                    {
                        <span class="r614 r">result</span> = <a href="#208e659c91e1f7e3" class="i method">CopyFileStreamToRemoteSession</a>(<span class="r609 r">file</span>, <span class="r612 r">remoteFilePath</span>, <span class="r611 r">ps</span>, <b>true</b>, <span class="r616 r">stream</span>.<a href="#74a4aa230d954592" class="i property">Stream</a>);
                        <b>if</b> (!<span class="r614 r">result</span>)
                        {
                            <b>break</b>;
                        }
                    }
                }
            }
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
            <b>if</b> (<span class="r614 r">result</span>)
            {
                <span class="i">SetRemoteFileMetadata</span>(<span class="r609 r">file</span>, <span class="i">Path</span>.<span class="i">Combine</span>(<span class="r610 r">destinationPath</span>, <span class="r609 r">file</span>.<span class="i">Name</span>), <span class="r611 r">ps</span>);
            }
 
            <b>return</b> <span class="r614 r">result</span>;
        }
 
        <b>private bool</b> <a id="93c6b9361ba96cc6" href="../R/93c6b9361ba96cc6.html" target="n" data-glyph="76,1" class="i method">RemoteDestinationPathIsFile</a>(<b>string</b> <span id="r617 rd" class="r617 r">destination</span>, <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="../engine/hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShell</a> <span id="r618 rd" class="r618 r">ps</span>)
        {
            <span class="r618 r">ps</span>.<a href="../engine/hostifaces/PowerShell.cs.html#9cc79c297f6cced9" class="i method">AddCommand</a>(<a href="#18b0063a4d2c0d48" class="t t">CopyFileRemoteUtils</a>.<a href="#3bb0f47e99c017c4" class="i field">PSCopyToSessionHelperName</a>);
            <span class="r618 r">ps</span>.<a href="../engine/hostifaces/PowerShell.cs.html#40674f99a3618f4b" class="i method">AddParameter</a>(<span class="s">&quot;isFilePath&quot;</span>, <span class="r617 r">destination</span>);
 
            <span class="i">Hashtable</span> <span id="r619 rd" class="r619 r">op</span> = <a href="#0021e65731f91d4b" class="t t">SafeInvokeCommand</a>.<a href="#52932871655c3ffb" class="i method">Invoke</a>(<span class="r618 r">ps</span>, <a href="../P/64a92af39f1cd630.html#64a92af39f1cd630" class="k">this</a>, <b>null</b>);
 
            <b>if</b> (<span class="r619 r">op</span> == <b>null</b> || <span class="r619 r">op</span>[<span class="s">&quot;IsFileInfo&quot;</span>] == <b>null</b>)
            {
                <span class="i">Exception</span> <span id="r620 rd" class="r620 r">e</span> = <b>new</b> <span class="i">IOException</span>(<b>string</b>.<span class="i">Format</span>(
                                                    <span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>,
                                                    <span class="i">FileSystemProviderStrings</span>.<span class="i">CopyItemRemotelyFailedToValidateIfDestinationIsFile</span>,
                                                    <span class="r617 r">destination</span>));
                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <a href="../engine/ErrorPackage.cs.html#e9334565e5136f43" class="t constructor">ErrorRecord</a>(<span class="r620 r">e</span>, <span class="s">&quot;CopyError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#0c2f4b9c74e5b7c2" class="i field">WriteError</a>, <span class="r617 r">destination</span>));
                <b>return</b> <b>false</b>;
            }
 
            <b>return</b> (<b>bool</b>)(<span class="r619 r">op</span>[<span class="s">&quot;IsFileInfo&quot;</span>]);
        }
 
        <b>private string</b> <a id="390bc802e88b9273" href="../R/390bc802e88b9273.html" target="n" data-glyph="76,1" class="i method">CreateDirectoryOnRemoteSession</a>(<b>string</b> <span id="r621 rd" class="r621 r">destination</span>, <b>bool</b> <span id="r622 rd" class="r622 r">force</span>, <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="../engine/hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShell</a> <span id="r623 rd" class="r623 r">ps</span>)
        {
            <span class="r623 r">ps</span>.<a href="../engine/hostifaces/PowerShell.cs.html#9cc79c297f6cced9" class="i method">AddCommand</a>(<a href="#18b0063a4d2c0d48" class="t t">CopyFileRemoteUtils</a>.<a href="#3bb0f47e99c017c4" class="i field">PSCopyToSessionHelperName</a>);
            <span class="r623 r">ps</span>.<a href="../engine/hostifaces/PowerShell.cs.html#40674f99a3618f4b" class="i method">AddParameter</a>(<span class="s">&quot;createDirectoryPath&quot;</span>, <span class="r621 r">destination</span>);
            <b>if</b> (<span class="r622 r">force</span>)
            {
                <span class="r623 r">ps</span>.<a href="../engine/hostifaces/PowerShell.cs.html#40674f99a3618f4b" class="i method">AddParameter</a>(<b>nameof</b>(<span class="r622 r">force</span>), <b>true</b>);
            }
 
            <span class="i">Hashtable</span> <span id="r624 rd" class="r624 r">op</span> = <a href="#0021e65731f91d4b" class="t t">SafeInvokeCommand</a>.<a href="#52932871655c3ffb" class="i method">Invoke</a>(<span class="r623 r">ps</span>, <a href="../P/64a92af39f1cd630.html#64a92af39f1cd630" class="k">this</a>, <b>null</b>);
 
            <span class="c">// If op == null,  SafeInvokeCommand.Invoke throwns an error.</span>
            <b>if</b> (<span class="r624 r">op</span>[<span class="s">&quot;ExceptionThrown&quot;</span>] != <b>null</b>)
            {
                <span class="c">// If an error is thrown on the remote session, it is written via SafeInvokeCommand.Invoke.</span>
                <b>if</b> ((<b>bool</b>)<span class="r624 r">op</span>[<span class="s">&quot;ExceptionThrown&quot;</span>])
                    <b>return</b> <b>null</b>;
            }
 
            <b>if</b> (<span class="r622 r">force</span> &amp;&amp; (<span class="r624 r">op</span>[<span class="s">&quot;DirectoryPath&quot;</span>] == <b>null</b>))
            {
                <span class="i">Exception</span> <span id="r625 rd" class="r625 r">e</span> = <b>new</b> <span class="i">IOException</span>(<b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>,
                                                            <span class="i">FileSystemProviderStrings</span>.<span class="i">CopyItemRemotelyFailedToCreateDirectory</span>,
                                                            <span class="r621 r">destination</span>));
                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <a href="../engine/ErrorPackage.cs.html#e9334565e5136f43" class="t constructor">ErrorRecord</a>(<span class="r625 r">e</span>, <span class="s">&quot;FailedToCreateDirectory&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#0c2f4b9c74e5b7c2" class="i field">WriteError</a>, <span class="r621 r">destination</span>));
                <b>return</b> <b>null</b>;
            }
 
            <b>string</b> <span id="r626 rd" class="r626 r">path</span> = (<b>string</b>)(<span class="r624 r">op</span>[<span class="s">&quot;DirectoryPath&quot;</span>]);
 
            <b>if</b> ((!<span class="r622 r">force</span>) &amp;&amp; (<b>bool</b>)<span class="r624 r">op</span>[<span class="s">&quot;PathExists&quot;</span>])
            {
                <span class="i">Exception</span> <span id="r627 rd" class="r627 r">e</span> = <b>new</b> <span class="i">IOException</span>(<a href="../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">FileSystemProviderStrings</span>.<span class="i">DirectoryExist</span>, <span class="r626 r">path</span>));
                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <a href="../engine/ErrorPackage.cs.html#e9334565e5136f43" class="t constructor">ErrorRecord</a>(<span class="r627 r">e</span>, <span class="s">&quot;DirectoryExist&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#22cb3b8b80f740be" class="i field">ResourceExists</a>, <span class="r626 r">path</span>));
                <b>return</b> <b>null</b>;
            }
 
            <b>return</b> <span class="r626 r">path</span>;
        }
 
        <span class="c">// Returns true if the destination path represents a device name, and write an error to the user.</span>
        <b>private bool</b> <a id="f2f9701584921b3e" href="../R/f2f9701584921b3e.html" target="n" data-glyph="76,1" class="i method">PathIsReservedDeviceName</a>(<b>string</b> <span id="r628 rd" class="r628 r">destinationPath</span>, <b>string</b> <span id="r629 rd" class="r629 r">errorId</span>)
        {
            <b>bool</b> <span id="r630 rd" class="r630 r">pathIsReservedDeviceName</span> = <b>false</b>;
            <b>if</b> (<a href="../engine/Utils.cs.html#9185d6ecbaebbec0" class="t t">Utils</a>.<a href="../engine/Utils.cs.html#562333e0cb916c25" class="i method">IsReservedDeviceName</a>(<span class="r628 r">destinationPath</span>))
            {
                <span class="r630 r">pathIsReservedDeviceName</span> = <b>true</b>;
                <b>string</b> <span id="r631 rd" class="r631 r">error</span> = <a href="../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">FileSystemProviderStrings</span>.<span class="i">TargetCannotContainDeviceName</span>, <span class="r628 r">destinationPath</span>);
                <span class="i">Exception</span> <span id="r632 rd" class="r632 r">e</span> = <b>new</b> <span class="i">IOException</span>(<span class="r631 r">error</span>);
                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <a href="../engine/ErrorPackage.cs.html#e9334565e5136f43" class="t constructor">ErrorRecord</a>(<span class="r632 r">e</span>, <span class="r629 r">errorId</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#0c2f4b9c74e5b7c2" class="i field">WriteError</a>, <span class="r628 r">destinationPath</span>));
            }
 
            <b>return</b> <span class="r630 r">pathIsReservedDeviceName</span>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> CopyItem
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> ContainerCmdletProvider members
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> NavigationCmdletProvider members
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the parent of the given path.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r633 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The path of which to get the parent.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r634 r">root</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The root of the drive.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The parent of the given path.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>protected override string</b> <a id="f3d047f7aa5be4e6" href="../R/f3d047f7aa5be4e6.html" target="n" data-glyph="75,1" class="i method">GetParentPath</a>(<b>string</b> <span id="r633 rd" class="r633 r">path</span>, <b>string</b> <span id="r634 rd" class="r634 r">root</span>)
        {
            <b>string</b> <span id="r635 rd" class="r635 r">parentPath</span> = <a href="NavigationProviderBase.cs.html#7d31476313596b0b" class="k">base</a>.<a href="NavigationProviderBase.cs.html#ae5182f675ef4491" class="i method">GetParentPath</a>(<span class="r633 r">path</span>, <span class="r634 r">root</span>);
            <b>if</b> (!<a href="../engine/Utils.cs.html#9185d6ecbaebbec0" class="t t">Utils</a>.<a href="../engine/Utils.cs.html#035be1ae91f35c16" class="i method">PathIsUnc</a>(<span class="r633 r">path</span>))
            {
                <span class="r635 r">parentPath</span> = <a href="#23abd537fda56143" class="i method">EnsureDriveIsRooted</a>(<span class="r635 r">parentPath</span>);
            }
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">UNIX</span>
            <b>else</b> <b>if</b> (<span class="r635 r">parentPath</span>.<span class="i">Equals</span>(<a href="../engine/SessionStateStrings.cs.html#55ee11e42c7cf459" class="t t">StringLiterals</a>.<a href="../engine/SessionStateStrings.cs.html#b7c0e8f5832a0fb6" class="i field">DefaultPathSeparatorString</a>, <span class="i">StringComparison</span>.<span class="i">Ordinal</span>))
            {
                <span class="c">// make sure we return two backslashes so it still results in a UNC path</span>
                <span class="r635 r">parentPath</span> = <span class="s">&quot;\\\\&quot;</span>;
            }
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
            <b>return</b> <span class="r635 r">parentPath</span>;
        }
 
        <span class="c">// Note: we don&#39;t use IO.Path.IsPathRooted as this deals with &quot;invalid&quot; i.e. unnormalized paths</span>
        <b>private static bool</b> <a id="ab87c5ca4d4c6949" href="../R/ab87c5ca4d4c6949.html" target="n" data-glyph="76,1" class="i method">IsAbsolutePath</a>(<b>string</b> <span id="r636 rd" class="r636 r">path</span>)
        {
            <b>bool</b> <span id="r637 rd" class="r637 r">result</span> = <b>false</b>;
 
            <span class="c">// check if we&#39;re on a single root filesystem and it&#39;s an absolute path</span>
            <b>if</b> (<a href="LocationGlobber.cs.html#6387d90abe0ca584" class="t t">LocationGlobber</a>.<a href="LocationGlobber.cs.html#8c254b695f60d50c" class="i method">IsSingleFileSystemAbsolutePath</a>(<span class="r636 r">path</span>))
            {
                <b>return</b> <b>true</b>;
            }
 
            <span class="c">// Find the drive separator</span>
            <b>int</b> <span id="r638 rd" class="r638 r">index</span> = <span class="r636 r">path</span>.<span class="i">IndexOf</span>(<span class="s">&#39;:&#39;</span>);
 
            <b>if</b> (<span class="r638 r">index</span> != -1)
            {
                <span class="r637 r">result</span> = <b>true</b>;
            }
 
            <b>return</b> <span class="r637 r">result</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Determines if the specified path is a root of a UNC share</span>
        <span class="c">///</span><span class="c"> by counting the path separators &quot;\&quot; following &quot;\\&quot;. If only</span>
        <span class="c">///</span><span class="c"> one path separator is found we know the path is in the form</span>
        <span class="c">///</span><span class="c"> &quot;\\server\share&quot; and is a valid UNC root.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r639 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The path to check to see if its a UNC root.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> True if the path is a UNC root, or false otherwise.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>private static bool</b> <a id="6dd7fbec94bfc5f2" href="../R/6dd7fbec94bfc5f2.html" target="n" data-glyph="76,1" class="i method">IsUNCRoot</a>(<b>string</b> <span id="r639 rd" class="r639 r">path</span>)
        {
            <b>bool</b> <span id="r640 rd" class="r640 r">result</span> = <b>false</b>;
 
            <b>if</b> (!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r639 r">path</span>))
            {
                <b>if</b> (<a href="../engine/Utils.cs.html#9185d6ecbaebbec0" class="t t">Utils</a>.<a href="../engine/Utils.cs.html#035be1ae91f35c16" class="i method">PathIsUnc</a>(<span class="r639 r">path</span>))
                {
                    <b>int</b> <span id="r641 rd" class="r641 r">lastIndex</span> = <span class="r639 r">path</span>.<span class="i">Length</span> - 1;
 
                    <b>if</b> (<span class="r639 r">path</span>[<span class="r639 r">path</span>.<span class="i">Length</span> - 1] == <span class="s">&#39;\\&#39;</span>)
                    {
                        <span class="r641 r">lastIndex</span>--;
                    }
 
                    <b>int</b> <span id="r642 rd" class="r642 r">separatorsFound</span> = 0;
                    <b>do</b>
                    {
                        <span class="r641 r">lastIndex</span> = <span class="r639 r">path</span>.<span class="i">LastIndexOf</span>(<span class="s">&#39;\\&#39;</span>, <span class="r641 r">lastIndex</span>);
                        <b>if</b> (<span class="r641 r">lastIndex</span> == -1)
                        {
                            <b>break</b>;
                        }
 
                        --<span class="r641 r">lastIndex</span>;
                        <b>if</b> (<span class="r641 r">lastIndex</span> &lt; 3)
                        {
                            <b>break</b>;
                        }
 
                        ++<span class="r642 r">separatorsFound</span>;
                    } <b>while</b> (<span class="r641 r">lastIndex</span> &gt; 3);
 
                    <b>if</b> (<span class="r642 r">separatorsFound</span> == 1)
                    {
                        <span class="r640 r">result</span> = <b>true</b>;
                    }
                }
            }
 
            <b>return</b> <span class="r640 r">result</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Determines if the specified path is either a drive root or a UNC root.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r643 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The path</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> True if the path is either a drive root or a UNC root, or false otherwise.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>private static bool</b> <a id="36ec86a915618f36" href="../R/36ec86a915618f36.html" target="n" data-glyph="76,1" class="i method">IsPathRoot</a>(<b>string</b> <span id="r643 rd" class="r643 r">path</span>)
        {
            <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r643 r">path</span>))
            {
                <b>return</b> <b>false</b>;
            }
 
            <b>bool</b> <span id="r644 rd" class="r644 r">isDriveRoot</span> = <b>string</b>.<span class="i">Equals</span>(<span class="r643 r">path</span>, <span class="i">Path</span>.<span class="i">GetPathRoot</span>(<span class="r643 r">path</span>), <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>);
            <b>bool</b> <span id="r645 rd" class="r645 r">isUNCRoot</span> = <a href="#6dd7fbec94bfc5f2" class="i method">IsUNCRoot</a>(<span class="r643 r">path</span>);
            <b>bool</b> <span id="r646 rd" class="r646 r">result</span> = <span class="r644 r">isDriveRoot</span> || <span class="r645 r">isUNCRoot</span>;
            <a href="#3b3990865d6b9e3a" class="i field">s_tracer</a>.<a href="../utils/StructuredTraceSource.cs.html#ea4adc43a7440f6a" class="i method">WriteLine</a>(<span class="s">&quot;result = {0}; isDriveRoot = {1}; isUNCRoot = {2}&quot;</span>, <span class="r646 r">result</span>, <span class="r644 r">isDriveRoot</span>, <span class="r645 r">isUNCRoot</span>);
            <b>return</b> <span class="r646 r">result</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Normalizes the path that was passed in and returns it as a normalized</span>
        <span class="c">///</span><span class="c"> path relative to the given basePath.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r647 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> A fully qualifiedpath to an item. The item must exist,</span>
        <span class="c">///</span><span class="c"> or the provider writes out an error.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r648 r">basePath</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The path that the normalized path should be relative to.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> A normalized path, relative to the given basePath.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">System</span>.<span class="i">ArgumentException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">     path is null or empty.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>protected override string</b> <a id="2fa782c88dc1ec18" href="../R/2fa782c88dc1ec18.html" target="n" data-glyph="75,1" class="i method">NormalizeRelativePath</a>(
            <b>string</b> <span id="r647 rd" class="r647 r">path</span>,
            <b>string</b> <span id="r648 rd" class="r648 r">basePath</span>)
        {
            <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r647 r">path</span>) || !<a href="#5c5e8a134ef48ff4" class="i method">IsValidPath</a>(<span class="r647 r">path</span>))
            {
                <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../utils/MshTraceSource.cs.html#fed5f40dc0075d41" class="i method">NewArgumentException</a>(<b>nameof</b>(<span class="r647 r">path</span>));
            }
 
            <b>if</b> (<span class="r648 r">basePath</span> == <b>null</b>)
            {
                <span class="r648 r">basePath</span> = <b>string</b>.<span class="i">Empty</span>;
            }
 
            <a href="#3b3990865d6b9e3a" class="i field">s_tracer</a>.<a href="../utils/StructuredTraceSource.cs.html#25b8416175e53218" class="i method">WriteLine</a>(<span class="s">&quot;basePath = {0}&quot;</span>, <span class="r648 r">basePath</span>);
 
            <b>string</b> <span id="r649 rd" class="r649 r">result</span> = <span class="r647 r">path</span>;
 
            <b>do</b> <span class="c">// false loop</span>
            {
                <span class="r647 r">path</span> = <a href="#2679b47e3c6ebedc" class="i method">NormalizePath</a>(<span class="r647 r">path</span>);
                <span class="r647 r">path</span> = <a href="#23abd537fda56143" class="i method">EnsureDriveIsRooted</a>(<span class="r647 r">path</span>);
 
                <span class="c">// If it&#39;s not fully normalized, normalize it.</span>
                <span class="r647 r">path</span> = <a href="#812e8e6bf49b47ce" class="i method">NormalizeRelativePathHelper</a>(<span class="r647 r">path</span>, <span class="r648 r">basePath</span>);
 
                <span class="r648 r">basePath</span> = <a href="#2679b47e3c6ebedc" class="i method">NormalizePath</a>(<span class="r648 r">basePath</span>);
                <span class="r648 r">basePath</span> = <a href="#23abd537fda56143" class="i method">EnsureDriveIsRooted</a>(<span class="r648 r">basePath</span>);
 
                <span class="r649 r">result</span> = <span class="r647 r">path</span>;
                <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r649 r">result</span>))
                {
                    <b>break</b>;
                }
 
                <b>try</b>
                {
                    <b>string</b> <span id="r650 rd" class="r650 r">originalPathComparison</span> = <span class="r647 r">path</span>;
                    <b>if</b> (!<span class="r650 r">originalPathComparison</span>.<span class="i">EndsWith</span>(<a href="../engine/SessionStateStrings.cs.html#55ee11e42c7cf459" class="t t">StringLiterals</a>.<a href="../engine/SessionStateStrings.cs.html#88fdd102fa325178" class="i field">DefaultPathSeparator</a>))
                    {
                        <span class="r650 r">originalPathComparison</span> += <a href="../engine/SessionStateStrings.cs.html#55ee11e42c7cf459" class="t t">StringLiterals</a>.<a href="../engine/SessionStateStrings.cs.html#88fdd102fa325178" class="i field">DefaultPathSeparator</a>;
                    }
 
                    <b>string</b> <span id="r651 rd" class="r651 r">basePathComparison</span> = <span class="r648 r">basePath</span>;
                    <b>if</b> (!<span class="r651 r">basePathComparison</span>.<span class="i">EndsWith</span>(<a href="../engine/SessionStateStrings.cs.html#55ee11e42c7cf459" class="t t">StringLiterals</a>.<a href="../engine/SessionStateStrings.cs.html#88fdd102fa325178" class="i field">DefaultPathSeparator</a>))
                    {
                        <span class="r651 r">basePathComparison</span> += <a href="../engine/SessionStateStrings.cs.html#55ee11e42c7cf459" class="t t">StringLiterals</a>.<a href="../engine/SessionStateStrings.cs.html#88fdd102fa325178" class="i field">DefaultPathSeparator</a>;
                    }
 
                    <b>if</b> (<span class="r650 r">originalPathComparison</span>.<span class="i">StartsWith</span>(<span class="r651 r">basePathComparison</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
                    {
                        <b>if</b> (!<a href="../engine/Utils.cs.html#9185d6ecbaebbec0" class="t t">Utils</a>.<a href="../engine/Utils.cs.html#035be1ae91f35c16" class="i method">PathIsUnc</a>(<span class="r649 r">result</span>))
                        {
                            <span class="c">// Add the base path back on so that it can be used for</span>
                            <span class="c">// processing</span>
                            <b>if</b> (!<span class="r649 r">result</span>.<span class="i">StartsWith</span>(<span class="r648 r">basePath</span>, <span class="i">StringComparison</span>.<span class="i">Ordinal</span>))
                            {
                                <span class="r649 r">result</span> = <a href="NavigationProviderBase.cs.html#6133115f9f4a066d" class="i method">MakePath</a>(<span class="r648 r">basePath</span>, <span class="r649 r">result</span>);
                            }
                        }
 
                        <b>if</b> (<a href="#36ec86a915618f36" class="i method">IsPathRoot</a>(<span class="r649 r">result</span>))
                        {
                            <span class="r649 r">result</span> = <a href="#23abd537fda56143" class="i method">EnsureDriveIsRooted</a>(<span class="r649 r">result</span>);
                        }
                        <b>else</b>
                        {
                            <span class="c">// Now ensure that we have the proper casing by</span>
                            <span class="c">// getting the names of the files and directories that match</span>
                            <b>string</b> <span id="r652 rd" class="r652 r">directoryPath</span> = <span class="i">GetParentPath</span>(<span class="r649 r">result</span>, <b>string</b>.<span class="i">Empty</span>);
 
                            <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r652 r">directoryPath</span>))
                            {
                                <b>return</b> <b>string</b>.<span class="i">Empty</span>;
                            }
 
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">UNIX</span>
<span class="e">                            // We don&#39;t use the Directory.EnumerateFiles() for Unix because the path
                            // may contain additional globbing patterns such as &#39;[ab]&#39;
                            // which Directory.EnumerateFiles() processes, giving undesireable
                            // results in this context.
                            if (!File.Exists(result) &amp;&amp; !Directory.Exists(result))
                            {
                                string error = StringUtil.Format(FileSystemProviderStrings.ItemDoesNotExist, path);
                                Exception e = new IOException(error);
                                WriteError(new ErrorRecord(
                                    e,
                                    &quot;ItemDoesNotExist&quot;,
                                    ErrorCategory.ObjectNotFound,
                                    path));
                                break;
                            }
</span><span class="k preprocess">#</span><span class="k preprocess">else</span>
                            <b>string</b> <span id="r653 rd" class="r653 r">leafName</span> = <a href="#651f505b469fdf3b" class="i method">GetChildName</a>(<span class="r649 r">result</span>);
 
                            <span class="c">// Use the Directory class to get the real path (this will</span>
                            <span class="c">// ensure the proper casing</span>
                            <span class="i">IEnumerable</span>&lt;<b>string</b>&gt; <span id="r654 rd" class="r654 r">files</span> = <span class="i">Directory</span>.<span class="i">EnumerateFiles</span>(<span class="r652 r">directoryPath</span>, <span class="r653 r">leafName</span>);
 
                            <b>if</b> (<span class="r654 r">files</span> == <b>null</b> || !<span class="r654 r">files</span>.<span class="i">Any</span>())
                            {
                                <span class="r654 r">files</span> = <span class="i">Directory</span>.<span class="i">EnumerateDirectories</span>(<span class="r652 r">directoryPath</span>, <span class="r653 r">leafName</span>);
                            }
 
                            <b>if</b> (<span class="r654 r">files</span> == <b>null</b> || !<span class="r654 r">files</span>.<span class="i">Any</span>())
                            {
                                <b>string</b> <span id="r655 rd" class="r655 r">error</span> = <a href="../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">FileSystemProviderStrings</span>.<span class="i">ItemDoesNotExist</span>, <span class="r647 r">path</span>);
                                <span class="i">Exception</span> <span id="r656 rd" class="r656 r">e</span> = <b>new</b> <span class="i">IOException</span>(<span class="r655 r">error</span>);
                                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <a href="../engine/ErrorPackage.cs.html#e9334565e5136f43" class="t constructor">ErrorRecord</a>(
                                    <span class="r656 r">e</span>,
                                    <span class="s">&quot;ItemDoesNotExist&quot;</span>,
                                    <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#9a72a7d3051ac7c5" class="i field">ObjectNotFound</a>,
                                    <span class="r647 r">path</span>));
                                <b>break</b>;
                            }
 
                            <span class="r649 r">result</span> = <span class="r654 r">files</span>.<span class="i">First</span>();
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
 
                            <b>if</b> (<span class="r649 r">result</span>.<span class="i">StartsWith</span>(<span class="r648 r">basePath</span>, <span class="i">StringComparison</span>.<span class="i">Ordinal</span>))
                            {
                                <span class="r649 r">result</span> = <span class="r649 r">result</span>.<span class="i">Substring</span>(<span class="r648 r">basePath</span>.<span class="i">Length</span>);
                            }
                            <b>else</b>
                            {
                                <b>string</b> <span id="r657 rd" class="r657 r">error</span> = <a href="../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">FileSystemProviderStrings</span>.<span class="i">PathOutSideBasePath</span>, <span class="r647 r">path</span>);
                                <span class="i">Exception</span> <span id="r658 rd" class="r658 r">e</span> =
                                    <b>new</b> <span class="i">ArgumentException</span>(<span class="r657 r">error</span>);
                                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <a href="../engine/ErrorPackage.cs.html#e9334565e5136f43" class="t constructor">ErrorRecord</a>(
                                    <span class="r658 r">e</span>,
                                    <span class="s">&quot;PathOutSideBasePath&quot;</span>,
                                    <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#846d2b572f2c4820" class="i field">InvalidArgument</a>,
                                    <b>null</b>));
                                <b>break</b>;
                            }
                        }
                    }
                }
                <b>catch</b> (<span class="i">ArgumentException</span> <span id="r659 rd" class="r659 r">argumentException</span>)
                {
                    <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r659 r">argumentException</span>, <span class="s">&quot;NormalizeRelativePathArgumentError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#846d2b572f2c4820" class="i field">InvalidArgument</a>, <span class="r647 r">path</span>));
                    <b>break</b>;
                }
                <b>catch</b> (<span class="i">DirectoryNotFoundException</span> <span id="r660 rd" class="r660 r">directoryNotFound</span>)
                {
                    <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r660 r">directoryNotFound</span>, <span class="s">&quot;NormalizeRelativePathDirectoryNotFoundError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#9a72a7d3051ac7c5" class="i field">ObjectNotFound</a>, <span class="r647 r">path</span>));
                    <b>break</b>;
                }
                <b>catch</b> (<span class="i">IOException</span> <span id="r661 rd" class="r661 r">ioError</span>)
                {
                    <span class="c">// IOException contains specific message about the error occurred and so no need for errordetails.</span>
                    <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r661 r">ioError</span>, <span class="s">&quot;NormalizeRelativePathIOError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#cad1e0e3e13dc1f3" class="i field">ReadError</a>, <span class="r647 r">path</span>));
                    <b>break</b>;
                }
                <b>catch</b> (<span class="i">UnauthorizedAccessException</span> <span id="r662 rd" class="r662 r">accessException</span>)
                {
                    <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r662 r">accessException</span>, <span class="s">&quot;NormalizeRelativePathUnauthorizedAccessError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#26ba13af79d30a75" class="i field">PermissionDenied</a>, <span class="r647 r">path</span>));
                    <b>break</b>;
                }
            } <b>while</b> (<b>false</b>);
 
            <b>return</b> <span class="r649 r">result</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Normalizes the path that was passed in and returns the normalized path</span>
        <span class="c">///</span><span class="c"> as a relative path to the basePath that was passed.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r663 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> A fully qualified provider specific path to an item. The item should exist</span>
        <span class="c">///</span><span class="c"> or the provider should write out an error.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r664 r">basePath</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The path that the return value should be relative to.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> A normalized path that is relative to the basePath that was passed. The</span>
        <span class="c">///</span><span class="c"> provider should parse the path parameter, normalize the path, and then</span>
        <span class="c">///</span><span class="c"> return the normalized path relative to the basePath.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This method does not have to be purely syntactical parsing of the path. It</span>
        <span class="c">///</span><span class="c"> is encouraged that the provider actually use the path to lookup in its store</span>
        <span class="c">///</span><span class="c"> and create a relative path that matches the casing, and standardized path syntax.</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> Note, the base class implementation uses GetParentPath, GetChildName, and MakePath</span>
        <span class="c">///</span><span class="c"> to normalize the path and then make it relative to basePath. All string comparisons</span>
        <span class="c">///</span><span class="c"> are done using StringComparison.InvariantCultureIgnoreCase.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>private string</b> <a id="812e8e6bf49b47ce" href="../R/812e8e6bf49b47ce.html" target="n" data-glyph="76,1" class="i method">NormalizeRelativePathHelper</a>(<b>string</b> <span id="r663 rd" class="r663 r">path</span>, <b>string</b> <span id="r664 rd" class="r664 r">basePath</span>)
        {
            <b>if</b> (<span class="r663 r">path</span> == <b>null</b>)
            {
                <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../utils/MshTraceSource.cs.html#fbe67220ad7522a0" class="i method">NewArgumentNullException</a>(<b>nameof</b>(<span class="r663 r">path</span>));
            }
 
            <b>if</b> (<span class="r663 r">path</span>.<span class="i">Length</span> == 0)
            {
                <b>return</b> <b>string</b>.<span class="i">Empty</span>;
            }
 
            <b>if</b> (<span class="r664 r">basePath</span> == <b>null</b>)
            {
                <span class="r664 r">basePath</span> = <b>string</b>.<span class="i">Empty</span>;
            }
 
            <a href="#3b3990865d6b9e3a" class="i field">s_tracer</a>.<a href="../utils/StructuredTraceSource.cs.html#25b8416175e53218" class="i method">WriteLine</a>(<span class="s">&quot;basePath = {0}&quot;</span>, <span class="r664 r">basePath</span>);
 
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">UNIX</span>
            <span class="c">// Remove alternate data stream references</span>
            <span class="c">// See if they&#39;ve used the inline stream syntax. They have more than one colon.</span>
            <b>string</b> <span id="r665 rd" class="r665 r">alternateDataStream</span> = <b>string</b>.<span class="i">Empty</span>;
            <b>int</b> <span id="r666 rd" class="r666 r">firstColon</span> = <span class="r663 r">path</span>.<span class="i">IndexOf</span>(<span class="s">&#39;:&#39;</span>);
            <b>int</b> <span id="r667 rd" class="r667 r">secondColon</span> = <span class="r663 r">path</span>.<span class="i">IndexOf</span>(<span class="s">&#39;:&#39;</span>, <span class="r666 r">firstColon</span> + 1);
            <b>if</b> (<span class="r667 r">secondColon</span> &gt; 0)
            {
                <b>string</b> <span id="r668 rd" class="r668 r">newPath</span> = <span class="r663 r">path</span>.<span class="i">Substring</span>(0, <span class="r667 r">secondColon</span>);
                <span class="r665 r">alternateDataStream</span> = <span class="r663 r">path</span>.<span class="i">Replace</span>(<span class="r668 r">newPath</span>, <b>string</b>.<span class="i">Empty</span>);
                <span class="r663 r">path</span> = <span class="r668 r">newPath</span>;
            }
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
 
            <b>string</b> <span id="r669 rd" class="r669 r">result</span> = <span class="r663 r">path</span>;
 
            <b>do</b> <span class="c">// false loop</span>
            {
                <span class="c">// Convert to the correct path separators and trim trailing separators</span>
                <span class="r663 r">path</span> = <span class="r663 r">path</span>.<span class="i">Replace</span>(<a href="../engine/SessionStateStrings.cs.html#55ee11e42c7cf459" class="t t">StringLiterals</a>.<a href="../engine/SessionStateStrings.cs.html#f2548f0f61690656" class="i field">AlternatePathSeparator</a>, <a href="../engine/SessionStateStrings.cs.html#55ee11e42c7cf459" class="t t">StringLiterals</a>.<a href="../engine/SessionStateStrings.cs.html#88fdd102fa325178" class="i field">DefaultPathSeparator</a>);
                <b>string</b> <span id="r670 rd" class="r670 r">originalPath</span> = <span class="r663 r">path</span>;
 
                <span class="r663 r">path</span> = <span class="r663 r">path</span>.<span class="i">TrimEnd</span>(<a href="../engine/SessionStateStrings.cs.html#55ee11e42c7cf459" class="t t">StringLiterals</a>.<a href="../engine/SessionStateStrings.cs.html#88fdd102fa325178" class="i field">DefaultPathSeparator</a>);
                <span class="r664 r">basePath</span> = <span class="r664 r">basePath</span>.<span class="i">Replace</span>(<a href="../engine/SessionStateStrings.cs.html#55ee11e42c7cf459" class="t t">StringLiterals</a>.<a href="../engine/SessionStateStrings.cs.html#f2548f0f61690656" class="i field">AlternatePathSeparator</a>, <a href="../engine/SessionStateStrings.cs.html#55ee11e42c7cf459" class="t t">StringLiterals</a>.<a href="../engine/SessionStateStrings.cs.html#88fdd102fa325178" class="i field">DefaultPathSeparator</a>);
                <span class="r664 r">basePath</span> = <span class="r664 r">basePath</span>.<span class="i">TrimEnd</span>(<a href="../engine/SessionStateStrings.cs.html#55ee11e42c7cf459" class="t t">StringLiterals</a>.<a href="../engine/SessionStateStrings.cs.html#88fdd102fa325178" class="i field">DefaultPathSeparator</a>);
 
                <span class="r663 r">path</span> = <a href="#79dc11a4f1e2e8f6" class="i method">RemoveRelativeTokens</a>(<span class="r663 r">path</span>);
 
                <span class="c">// See if the base and the path are already the same. We resolve this to</span>
                <span class="c">// ..\Leaf, since resolving &quot;.&quot; to &quot;.&quot; doesn&#39;t offer much information.</span>
                <b>if</b> (<b>string</b>.<span class="i">Equals</span>(<span class="r663 r">path</span>, <span class="r664 r">basePath</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>) &amp;&amp;
                    (!<span class="r670 r">originalPath</span>.<span class="i">EndsWith</span>(<a href="../engine/SessionStateStrings.cs.html#55ee11e42c7cf459" class="t t">StringLiterals</a>.<a href="../engine/SessionStateStrings.cs.html#88fdd102fa325178" class="i field">DefaultPathSeparator</a>)))
                {
                    <b>string</b> <span id="r671 rd" class="r671 r">childName</span> = <a href="#651f505b469fdf3b" class="i method">GetChildName</a>(<span class="r663 r">path</span>);
                    <span class="r669 r">result</span> = <a href="NavigationProviderBase.cs.html#6133115f9f4a066d" class="i method">MakePath</a>(<span class="s">&quot;..&quot;</span>, <span class="r671 r">childName</span>);
                    <b>break</b>;
                }
 
                <span class="i">Stack</span>&lt;<b>string</b>&gt; <span id="r672 rd" class="r672 r">tokenizedPathStack</span> = <b>null</b>;
 
                <span class="c">// If the base path isn&#39;t really a base, then we resolve to a parent</span>
                <span class="c">// path (such as ../../foo)</span>
                <span class="c">// For example: base = c:/temp/bar/baz</span>
                <span class="c">//              path = c:/temp/foo</span>
                <b>if</b> ((
                    !(<span class="r663 r">path</span> + <a href="../engine/SessionStateStrings.cs.html#55ee11e42c7cf459" class="t t">StringLiterals</a>.<a href="../engine/SessionStateStrings.cs.html#88fdd102fa325178" class="i field">DefaultPathSeparator</a>).<span class="i">StartsWith</span>(
                    <span class="r664 r">basePath</span> + <a href="../engine/SessionStateStrings.cs.html#55ee11e42c7cf459" class="t t">StringLiterals</a>.<a href="../engine/SessionStateStrings.cs.html#88fdd102fa325178" class="i field">DefaultPathSeparator</a>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>)) &amp;&amp;
                    (!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r664 r">basePath</span>))
                    )
                {
                    <span class="r669 r">result</span> = <b>string</b>.<span class="i">Empty</span>;
                    <b>string</b> <span id="r673 rd" class="r673 r">commonBase</span> = <a href="#9e77ce29b3a6054c" class="i method">GetCommonBase</a>(<span class="r663 r">path</span>, <span class="r664 r">basePath</span>);
 
                    <span class="i">Stack</span>&lt;<b>string</b>&gt; <span id="r674 rd" class="r674 r">parentNavigationStack</span> = <a href="#bca21c400d018754" class="i method">TokenizePathToStack</a>(<span class="r664 r">basePath</span>, <span class="r673 r">commonBase</span>);
                    <b>int</b> <span id="r675 rd" class="r675 r">parentPopCount</span> = <span class="r674 r">parentNavigationStack</span>.<span class="i">Count</span>;
 
                    <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r673 r">commonBase</span>))
                    {
                        <span class="r675 r">parentPopCount</span>--;
                    }
 
                    <b>for</b> (<b>int</b> <span id="r676 rd" class="r676 r">leafCounter</span> = 0; <span class="r676 r">leafCounter</span> &lt; <span class="r675 r">parentPopCount</span>; <span class="r676 r">leafCounter</span>++)
                    {
                        <span class="r669 r">result</span> = <a href="NavigationProviderBase.cs.html#6133115f9f4a066d" class="i method">MakePath</a>(<span class="s">&quot;..&quot;</span>, <span class="r669 r">result</span>);
                    }
 
                    <span class="c">// This is true if we get passed a base path like:</span>
                    <span class="c">//    c:\directory1\directory2</span>
                    <span class="c">// and an actual path of</span>
                    <span class="c">//    c:\directory1</span>
                    <span class="c">// Which happens when the user is in c:\directory1\directory2</span>
                    <span class="c">// and wants to resolve something like:</span>
                    <span class="c">// ..\..\dir*</span>
                    <span class="c">// In that case (as above,) we keep the ..\..\directory1</span>
                    <span class="c">// instead of &quot;..&quot; as would usually be returned</span>
                    <b>if</b> (!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r673 r">commonBase</span>))
                    {
                        <b>if</b> (<b>string</b>.<span class="i">Equals</span>(<span class="r663 r">path</span>, <span class="r673 r">commonBase</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>) &amp;&amp;
                            (!<span class="r663 r">path</span>.<span class="i">EndsWith</span>(<a href="../engine/SessionStateStrings.cs.html#55ee11e42c7cf459" class="t t">StringLiterals</a>.<a href="../engine/SessionStateStrings.cs.html#88fdd102fa325178" class="i field">DefaultPathSeparator</a>)))
                        {
                            <b>string</b> <span id="r677 rd" class="r677 r">childName</span> = <a href="#651f505b469fdf3b" class="i method">GetChildName</a>(<span class="r663 r">path</span>);
                            <span class="r669 r">result</span> = <a href="NavigationProviderBase.cs.html#6133115f9f4a066d" class="i method">MakePath</a>(<span class="s">&quot;..&quot;</span>, <span class="r669 r">result</span>);
                            <span class="r669 r">result</span> = <a href="NavigationProviderBase.cs.html#6133115f9f4a066d" class="i method">MakePath</a>(<span class="r669 r">result</span>, <span class="r677 r">childName</span>);
                        }
                        <b>else</b>
                        {
                            <b>string</b>[] <span id="r678 rd" class="r678 r">childNavigationItems</span> = <a href="#bca21c400d018754" class="i method">TokenizePathToStack</a>(<span class="r663 r">path</span>, <span class="r673 r">commonBase</span>).<span class="i">ToArray</span>();
 
                            <b>for</b> (<b>int</b> <span id="r679 rd" class="r679 r">leafCounter</span> = 0; <span class="r679 r">leafCounter</span> &lt; <span class="r678 r">childNavigationItems</span>.<span class="i">Length</span>; <span class="r679 r">leafCounter</span>++)
                            {
                                <span class="r669 r">result</span> = <a href="NavigationProviderBase.cs.html#6133115f9f4a066d" class="i method">MakePath</a>(<span class="r669 r">result</span>, <span class="r678 r">childNavigationItems</span>[<span class="r679 r">leafCounter</span>]);
                            }
                        }
                    }
                }
                <span class="c">// Otherwise, we resolve to a child path (such as foo/bar)</span>
                <b>else</b>
                {
                    <span class="c">// If the path is a root, then the result will either be empty or the root depending</span>
                    <span class="c">// on the value of basePath.</span>
                    <b>if</b> (<a href="#36ec86a915618f36" class="i method">IsPathRoot</a>(<span class="r663 r">path</span>))
                    {
                        <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r664 r">basePath</span>))
                        {
                            <span class="r669 r">result</span> = <span class="r663 r">path</span>;
                            <b>break</b>;
                        }
                        <b>else</b>
                        {
                            <span class="r669 r">result</span> = <b>string</b>.<span class="i">Empty</span>;
                            <b>break</b>;
                        }
                    }
 
                    <span class="r672 r">tokenizedPathStack</span> = <a href="#bca21c400d018754" class="i method">TokenizePathToStack</a>(<span class="r663 r">path</span>, <span class="r664 r">basePath</span>);
 
                    <span class="c">// Now we have to normalize the path</span>
                    <span class="c">// by processing each token on the stack</span>
                    <span class="i">Stack</span>&lt;<b>string</b>&gt; <span id="r680 rd" class="r680 r">normalizedPathStack</span>;
 
                    <b>try</b>
                    {
                        <span class="r680 r">normalizedPathStack</span> = <a href="#2062d887d7fd8863" class="i method">NormalizeThePath</a>(<span class="r664 r">basePath</span>, <span class="r672 r">tokenizedPathStack</span>);
                    }
                    <b>catch</b> (<span class="i">ArgumentException</span> <span id="r681 rd" class="r681 r">argumentException</span>)
                    {
                        <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r681 r">argumentException</span>, <span class="s">&quot;NormalizeRelativePathHelperArgumentError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#846d2b572f2c4820" class="i field">InvalidArgument</a>, <b>null</b>));
                        <span class="r669 r">result</span> = <b>null</b>;
                        <b>break</b>;
                    }
 
                    <span class="c">// Now that the path has been normalized, create the relative path</span>
                    <span class="r669 r">result</span> = <a href="#b32d92c3bff351cb" class="i method">CreateNormalizedRelativePathFromStack</a>(<span class="r680 r">normalizedPathStack</span>);
                }
            } <b>while</b> (<b>false</b>);
 
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">UNIX</span>
            <b>if</b> (!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r665 r">alternateDataStream</span>))
            {
                <span class="r669 r">result</span> += <span class="r665 r">alternateDataStream</span>;
            }
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
 
            <b>return</b> <span class="r669 r">result</span>;
        }
 
        <b>private string</b> <a id="79dc11a4f1e2e8f6" href="../R/79dc11a4f1e2e8f6.html" target="n" data-glyph="76,1" class="i method">RemoveRelativeTokens</a>(<b>string</b> <span id="r682 rd" class="r682 r">path</span>)
        {
            <b>string</b> <span id="r683 rd" class="r683 r">testPath</span> = <span class="r682 r">path</span>.<span class="i">Replace</span>(<span class="s">&#39;/&#39;</span>, <span class="s">&#39;\\&#39;</span>);
            <b>if</b> (
                !<span class="r683 r">testPath</span>.<span class="i">Contains</span>(<span class="s">&#39;\\&#39;</span>) ||
                <span class="r683 r">testPath</span>.<span class="i">StartsWith</span>(<span class="s">&quot;.\\&quot;</span>, <span class="i">StringComparison</span>.<span class="i">Ordinal</span>) ||
                <span class="r683 r">testPath</span>.<span class="i">StartsWith</span>(<span class="s">&quot;..\\&quot;</span>, <span class="i">StringComparison</span>.<span class="i">Ordinal</span>) ||
                <span class="r683 r">testPath</span>.<span class="i">EndsWith</span>(<span class="s">&quot;\\.&quot;</span>, <span class="i">StringComparison</span>.<span class="i">Ordinal</span>) ||
                <span class="r683 r">testPath</span>.<span class="i">EndsWith</span>(<span class="s">&quot;\\..&quot;</span>, <span class="i">StringComparison</span>.<span class="i">Ordinal</span>) ||
                <span class="r683 r">testPath</span>.<span class="i">Contains</span>(<span class="s">&quot;\\.\\&quot;</span>, <span class="i">StringComparison</span>.<span class="i">Ordinal</span>) ||
                <span class="r683 r">testPath</span>.<span class="i">Contains</span>(<span class="s">&quot;\\..\\&quot;</span>, <span class="i">StringComparison</span>.<span class="i">Ordinal</span>))
            {
                <b>try</b>
                {
                    <span class="i">Stack</span>&lt;<b>string</b>&gt; <span id="r684 rd" class="r684 r">tokenizedPathStack</span> = <span class="i">TokenizePathToStack</span>(<span class="r682 r">path</span>, <b>string</b>.<span class="i">Empty</span>);
                    <span class="i">Stack</span>&lt;<b>string</b>&gt; <span id="r685 rd" class="r685 r">normalizedPath</span> = <span class="i">NormalizeThePath</span>(<b>string</b>.<span class="i">Empty</span>, <span class="r684 r">tokenizedPathStack</span>);
                    <b>return</b> <a href="#b32d92c3bff351cb" class="i method">CreateNormalizedRelativePathFromStack</a>(<span class="r685 r">normalizedPath</span>);
                }
                <b>catch</b> (<span class="i">UnauthorizedAccessException</span>)
                {
                    <span class="c">// Catch any errors here, as we may be in an AppContainer</span>
                }
            }
 
            <b>return</b> <span class="r682 r">path</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Get the common base path of two paths.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r686 r">path1</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">One path.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r687 r">path2</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Another path.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>private string</b> <a id="9e77ce29b3a6054c" href="../R/9e77ce29b3a6054c.html" target="n" data-glyph="76,1" class="i method">GetCommonBase</a>(<b>string</b> <span id="r686 rd" class="r686 r">path1</span>, <b>string</b> <span id="r687 rd" class="r687 r">path2</span>)
        {
            <span class="c">// Always see if the shorter path is a substring of the</span>
            <span class="c">// longer path. If it is not, take the child off of the longer</span>
            <span class="c">// path and compare again.</span>
            <b>while</b> (!<b>string</b>.<span class="i">Equals</span>(<span class="r686 r">path1</span>, <span class="r687 r">path2</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
            {
                <b>if</b> (<span class="r687 r">path2</span>.<span class="i">Length</span> &gt; <span class="r686 r">path1</span>.<span class="i">Length</span>)
                {
                    <span class="r687 r">path2</span> = <a href="#f3d047f7aa5be4e6" class="i method">GetParentPath</a>(<span class="r687 r">path2</span>, <b>null</b>);
                }
                <b>else</b>
                {
                    <span class="r686 r">path1</span> = <a href="#f3d047f7aa5be4e6" class="i method">GetParentPath</a>(<span class="r686 r">path1</span>, <b>null</b>);
                }
            }
 
            <b>return</b> <span class="r686 r">path1</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Tokenizes the specified path onto a stack.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r688 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The path to tokenize.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r689 r">basePath</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The base part of the path that should not be tokenized.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> A stack containing the tokenized path with leaf elements on the bottom</span>
        <span class="c">///</span><span class="c"> of the stack and the most ancestral parent at the top.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>private</b> <span class="i">Stack</span>&lt;<b>string</b>&gt; <a id="bca21c400d018754" href="../R/bca21c400d018754.html" target="n" data-glyph="76,1" class="i method">TokenizePathToStack</a>(<b>string</b> <span id="r688 rd" class="r688 r">path</span>, <b>string</b> <span id="r689 rd" class="r689 r">basePath</span>)
        {
            <span class="i">Stack</span>&lt;<b>string</b>&gt; <span id="r690 rd" class="r690 r">tokenizedPathStack</span> = <b>new</b> <span class="i">Stack</span>&lt;<b>string</b>&gt;();
 
            <b>string</b> <span id="r691 rd" class="r691 r">tempPath</span> = <span class="r688 r">path</span>;
            <b>string</b> <span id="r692 rd" class="r692 r">previousParent</span> = <span class="r688 r">path</span>;
 
            <b>while</b> (<span class="r691 r">tempPath</span>.<span class="i">Length</span> &gt; <span class="r689 r">basePath</span>.<span class="i">Length</span>)
            {
                <span class="c">// Get the child name and push it onto the stack</span>
                <span class="c">// if its valid</span>
                <b>string</b> <span id="r693 rd" class="r693 r">childName</span> = <a href="#651f505b469fdf3b" class="i method">GetChildName</a>(<span class="r691 r">tempPath</span>);
                <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r693 r">childName</span>))
                {
                    <span class="c">// Push the parent on and then stop</span>
                    <a href="#3b3990865d6b9e3a" class="i field">s_tracer</a>.<a href="../utils/StructuredTraceSource.cs.html#25b8416175e53218" class="i method">WriteLine</a>(<span class="s">&quot;tokenizedPathStack.Push({0})&quot;</span>, <span class="r691 r">tempPath</span>);
                    <span class="r690 r">tokenizedPathStack</span>.<span class="i">Push</span>(<span class="r691 r">tempPath</span>);
                    <b>break</b>;
                }
 
                <a href="#3b3990865d6b9e3a" class="i field">s_tracer</a>.<a href="../utils/StructuredTraceSource.cs.html#25b8416175e53218" class="i method">WriteLine</a>(<span class="s">&quot;tokenizedPathStack.Push({0})&quot;</span>, <span class="r693 r">childName</span>);
                <span class="r690 r">tokenizedPathStack</span>.<span class="i">Push</span>(<span class="r693 r">childName</span>);
 
                <span class="c">// Get the parent path and verify if we have to continue</span>
                <span class="c">// tokenizing</span>
                <span class="c">// We are done if the remaining path is:</span>
                <span class="c">// - the same as the previous path</span>
                <span class="c">// - a UNC path that is the root of a UNC share</span>
                <span class="c">// - not a UNC path and the string length is less than or</span>
                <span class="c">//   equal to 3. &quot;C:\&quot;</span>
                <span class="r691 r">tempPath</span> = <a href="#f3d047f7aa5be4e6" class="i method">GetParentPath</a>(<span class="r691 r">tempPath</span>, <span class="r689 r">basePath</span>);
                <b>if</b> (<span class="r691 r">tempPath</span>.<span class="i">Length</span> &gt;= <span class="r692 r">previousParent</span>.<span class="i">Length</span> ||
                    <a href="#36ec86a915618f36" class="i method">IsPathRoot</a>(<span class="r691 r">tempPath</span>))
                {
                    <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r689 r">basePath</span>))
                    {
                        <a href="#3b3990865d6b9e3a" class="i field">s_tracer</a>.<a href="../utils/StructuredTraceSource.cs.html#25b8416175e53218" class="i method">WriteLine</a>(<span class="s">&quot;tokenizedPathStack.Push({0})&quot;</span>, <span class="r691 r">tempPath</span>);
                        <span class="r690 r">tokenizedPathStack</span>.<span class="i">Push</span>(<span class="r691 r">tempPath</span>);
                    }
 
                    <b>break</b>;
                }
 
                <span class="r692 r">previousParent</span> = <span class="r691 r">tempPath</span>;
            }
 
            <b>return</b> <span class="r690 r">tokenizedPathStack</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Given the tokenized path, the relative path elements are removed.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r694 r">basepath</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">   String containing basepath for which we are trying to find the relative path.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r695 r">tokenizedPathStack</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> A stack containing path elements where the leaf most element is at</span>
        <span class="c">///</span><span class="c"> the bottom of the stack and the most ancestral parent is on the top.</span>
        <span class="c">///</span><span class="c"> Generally this stack comes from TokenizePathToStack().</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> A stack in reverse order with the path elements normalized and all relative</span>
        <span class="c">///</span><span class="c"> path tokens removed.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>private</b> <span class="i">Stack</span>&lt;<b>string</b>&gt; <a id="2062d887d7fd8863" href="../R/2062d887d7fd8863.html" target="n" data-glyph="76,1" class="i method">NormalizeThePath</a>(<b>string</b> <span id="r694 rd" class="r694 r">basepath</span>, <span class="i">Stack</span>&lt;<b>string</b>&gt; <span id="r695 rd" class="r695 r">tokenizedPathStack</span>)
        {
            <span class="i">Stack</span>&lt;<b>string</b>&gt; <span id="r696 rd" class="r696 r">normalizedPathStack</span> = <b>new</b> <span class="i">Stack</span>&lt;<b>string</b>&gt;();
            <b>string</b> <span id="r697 rd" class="r697 r">currentPath</span> = <span class="r694 r">basepath</span>;
 
            <b>while</b> (<span class="r695 r">tokenizedPathStack</span>.<span class="i">Count</span> &gt; 0)
            {
                <b>string</b> <span id="r698 rd" class="r698 r">childName</span> = <span class="r695 r">tokenizedPathStack</span>.<span class="i">Pop</span>();
 
                <a href="#3b3990865d6b9e3a" class="i field">s_tracer</a>.<a href="../utils/StructuredTraceSource.cs.html#25b8416175e53218" class="i method">WriteLine</a>(<span class="s">&quot;childName = {0}&quot;</span>, <span class="r698 r">childName</span>);
 
                <span class="c">// Ignore the current directory token</span>
                <b>if</b> (<span class="r698 r">childName</span>.<span class="i">Equals</span>(<span class="s">&quot;.&quot;</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
                {
                    <span class="c">// Just ignore it and move on.</span>
                    <b>continue</b>;
                }
                <b>else</b> <b>if</b> (<span class="r698 r">childName</span>.<span class="i">Equals</span>(<span class="s">&quot;..&quot;</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
                {
                    <b>if</b> (<span class="r696 r">normalizedPathStack</span>.<span class="i">Count</span> &gt; 0)
                    {
                        <span class="c">// Pop the result and continue processing</span>
                        <b>string</b> <span id="r699 rd" class="r699 r">poppedName</span> = <span class="r696 r">normalizedPathStack</span>.<span class="i">Pop</span>();
                        <span class="c">// update our currentpath to reflect the change.</span>
                        <b>if</b> (<span class="r697 r">currentPath</span>.<span class="i">Length</span> &gt; <span class="r699 r">poppedName</span>.<span class="i">Length</span>)
                        {
                            <span class="r697 r">currentPath</span> = <span class="r697 r">currentPath</span>.<span class="i">Substring</span>(0, <span class="r697 r">currentPath</span>.<span class="i">Length</span> - <span class="r699 r">poppedName</span>.<span class="i">Length</span> - 1);
                        }
                        <b>else</b>
                        {
                            <span class="r697 r">currentPath</span> = <b>string</b>.<span class="i">Empty</span>;
                        }
 
                        <a href="#3b3990865d6b9e3a" class="i field">s_tracer</a>.<a href="../utils/StructuredTraceSource.cs.html#25b8416175e53218" class="i method">WriteLine</a>(<span class="s">&quot;normalizedPathStack.Pop() : {0}&quot;</span>, <span class="r699 r">poppedName</span>);
                        <b>continue</b>;
                    }
                    <b>else</b>
                    {
                        <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<span class="i">NewArgumentException</span>(<span class="s">&quot;path&quot;</span>, <span class="i">FileSystemProviderStrings</span>.<span class="i">PathOutSideBasePath</span>);
                    }
                }
                <b>else</b>
                {
                    <span class="r697 r">currentPath</span> = <a href="NavigationProviderBase.cs.html#6133115f9f4a066d" class="i method">MakePath</a>(<span class="r697 r">currentPath</span>, <span class="r698 r">childName</span>);
 
                    <b>var</b> <span id="r700 rd" class="r700 r">fsinfo</span> = <a href="#03417d6757ea1d51" class="i method">GetFileSystemInfo</a>(<span class="r697 r">currentPath</span>, <b>out bool _</b>);
 
                    <span class="c">// Clean up the child name to proper casing and short-path</span>
                    <span class="c">// expansion if required. Also verify that .NET hasn&#39;t over-normalized</span>
                    <span class="c">// the path</span>
                    <b>if</b> (<span class="r700 r">fsinfo</span> != <b>null</b>)
                    {
                        <span class="c">// This might happen if you&#39;ve passed a child name of two or more dots,</span>
                        <span class="c">// which the .NET APIs treat as the parent directory</span>
                        <b>if</b> (<span class="r700 r">fsinfo</span>.<span class="i">FullName</span>.<span class="i">Length</span> &lt; <span class="r697 r">currentPath</span>.<span class="i">Length</span>)
                        {
                            <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<span class="i">NewArgumentException</span>(<span class="s">&quot;path&quot;</span>, <span class="i">FileSystemProviderStrings</span>.<span class="i">ItemDoesNotExist</span>, <span class="r697 r">currentPath</span>);
                        }
 
                        <span class="c">// Expand the short file name</span>
                        <b>if</b> (<span class="r700 r">fsinfo</span>.<span class="i">Name</span>.<span class="i">Length</span> &gt;= <span class="r698 r">childName</span>.<span class="i">Length</span>)
                        {
                            <span class="r698 r">childName</span> = <span class="r700 r">fsinfo</span>.<span class="i">Name</span>;
                        }
                    }
                    <b>else</b>
                    {
                        <span class="c">// We couldn&#39;t find the item</span>
                        <b>if</b> (<span class="r695 r">tokenizedPathStack</span>.<span class="i">Count</span> == 0)
                        {
                            <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<span class="i">NewArgumentException</span>(<span class="s">&quot;path&quot;</span>, <span class="i">FileSystemProviderStrings</span>.<span class="i">ItemDoesNotExist</span>, <span class="r697 r">currentPath</span>);
                        }
                    }
                }
 
                <a href="#3b3990865d6b9e3a" class="i field">s_tracer</a>.<a href="../utils/StructuredTraceSource.cs.html#25b8416175e53218" class="i method">WriteLine</a>(<span class="s">&quot;normalizedPathStack.Push({0})&quot;</span>, <span class="r698 r">childName</span>);
                <span class="r696 r">normalizedPathStack</span>.<span class="i">Push</span>(<span class="r698 r">childName</span>);
            }
 
            <b>return</b> <span class="r696 r">normalizedPathStack</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Pops each leaf element of the stack and uses MakePath to generate the relative path.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r701 r">normalizedPathStack</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The stack containing the leaf elements of the path.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> A path that is made up of the leaf elements on the given stack.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The elements on the stack start from the leaf element followed by its parent</span>
        <span class="c">///</span><span class="c"> followed by its parent, etc. Each following element on the stack is the parent</span>
        <span class="c">///</span><span class="c"> of the one before it.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>private string</b> <a id="b32d92c3bff351cb" href="../R/b32d92c3bff351cb.html" target="n" data-glyph="76,1" class="i method">CreateNormalizedRelativePathFromStack</a>(<span class="i">Stack</span>&lt;<b>string</b>&gt; <span id="r701 rd" class="r701 r">normalizedPathStack</span>)
        {
            <b>string</b> <span id="r702 rd" class="r702 r">leafElement</span> = <b>string</b>.<span class="i">Empty</span>;
 
            <b>while</b> (<span class="r701 r">normalizedPathStack</span>.<span class="i">Count</span> &gt; 0)
            {
                <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r702 r">leafElement</span>))
                {
                    <span class="r702 r">leafElement</span> = <span class="r701 r">normalizedPathStack</span>.<span class="i">Pop</span>();
                }
                <b>else</b>
                {
                    <b>string</b> <span id="r703 rd" class="r703 r">parentElement</span> = <span class="r701 r">normalizedPathStack</span>.<span class="i">Pop</span>();
                    <span class="r702 r">leafElement</span> = <a href="NavigationProviderBase.cs.html#6133115f9f4a066d" class="i method">MakePath</a>(<span class="r703 r">parentElement</span>, <span class="r702 r">leafElement</span>);
                }
            }
 
            <b>return</b> <span class="r702 r">leafElement</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the name of the leaf element of the specified path.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r704 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The fully qualified path to the item.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The leaf element of the specified path.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">System</span>.<span class="i">ArgumentException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">     path is null or empty.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>protected override string</b> <a id="651f505b469fdf3b" href="../R/651f505b469fdf3b.html" target="n" data-glyph="75,1" class="i method">GetChildName</a>(<b>string</b> <span id="r704 rd" class="r704 r">path</span>)
        {
            <span class="c">// Verify the parameters</span>
 
            <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r704 r">path</span>))
            {
                <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../utils/MshTraceSource.cs.html#fed5f40dc0075d41" class="i method">NewArgumentException</a>(<b>nameof</b>(<span class="r704 r">path</span>));
            }
 
            <span class="c">// Normalize the path</span>
            <span class="r704 r">path</span> = <span class="r704 r">path</span>.<span class="i">Replace</span>(<a href="../engine/SessionStateStrings.cs.html#55ee11e42c7cf459" class="t t">StringLiterals</a>.<a href="../engine/SessionStateStrings.cs.html#f2548f0f61690656" class="i field">AlternatePathSeparator</a>, <a href="../engine/SessionStateStrings.cs.html#55ee11e42c7cf459" class="t t">StringLiterals</a>.<a href="../engine/SessionStateStrings.cs.html#88fdd102fa325178" class="i field">DefaultPathSeparator</a>);
 
            <span class="c">// Trim trailing back slashes</span>
            <span class="r704 r">path</span> = <span class="r704 r">path</span>.<span class="i">TrimEnd</span>(<a href="../engine/SessionStateStrings.cs.html#55ee11e42c7cf459" class="t t">StringLiterals</a>.<a href="../engine/SessionStateStrings.cs.html#88fdd102fa325178" class="i field">DefaultPathSeparator</a>);
 
            <b>string</b> <span id="r705 rd" class="r705 r">result</span> = <b>null</b>;
 
            <b>int</b> <span id="r706 rd" class="r706 r">separatorIndex</span> = <span class="r704 r">path</span>.<span class="i">LastIndexOf</span>(<a href="../engine/SessionStateStrings.cs.html#55ee11e42c7cf459" class="t t">StringLiterals</a>.<a href="../engine/SessionStateStrings.cs.html#88fdd102fa325178" class="i field">DefaultPathSeparator</a>);
 
            <b>if</b> (<span class="r706 r">separatorIndex</span> == -1)
            {
                <span class="c">// Since there was no path separator return an empty string</span>
                <span class="r705 r">result</span> = <a href="#23abd537fda56143" class="i method">EnsureDriveIsRooted</a>(<span class="r704 r">path</span>);
            }
            <b>else</b>
            {
                <span class="r705 r">result</span> = <span class="r704 r">path</span>.<span class="i">Substring</span>(<span class="r706 r">separatorIndex</span> + 1);
            }
 
            <b>return</b> <span class="r705 r">result</span>;
        }
 
        <b>private static string</b> <a id="23abd537fda56143" href="../R/23abd537fda56143.html" target="n" data-glyph="76,1" class="i method">EnsureDriveIsRooted</a>(<b>string</b> <span id="r707 rd" class="r707 r">path</span>)
        {
            <b>string</b> <span id="r708 rd" class="r708 r">result</span> = <span class="r707 r">path</span>;
 
            <span class="c">// Find the drive separator</span>
            <b>int</b> <span id="r709 rd" class="r709 r">index</span> = <span class="r707 r">path</span>.<span class="i">IndexOf</span>(<span class="s">&#39;:&#39;</span>);
 
            <b>if</b> (<span class="r709 r">index</span> != -1)
            {
                <span class="c">// if the drive separator is the end of the path, add</span>
                <span class="c">// the root path separator back</span>
                <b>if</b> (<span class="r709 r">index</span> + 1 == <span class="r707 r">path</span>.<span class="i">Length</span>)
                {
                    <span class="r708 r">result</span> = <span class="r707 r">path</span> + <a href="../engine/SessionStateStrings.cs.html#55ee11e42c7cf459" class="t t">StringLiterals</a>.<a href="../engine/SessionStateStrings.cs.html#88fdd102fa325178" class="i field">DefaultPathSeparator</a>;
                }
            }
 
            <b>return</b> <span class="r708 r">result</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Determines if the item at the specified path is a directory.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r710 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The path to the file or directory to check.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> True if the item at the specified path is a directory.</span>
        <span class="c">///</span><span class="c"> False otherwise.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">System</span>.<span class="i">ArgumentException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">     path is null or empty.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>protected override bool</b> <a id="152bdf0e0e17cd95" href="../R/152bdf0e0e17cd95.html" target="n" data-glyph="75,1" class="i method">IsItemContainer</a>(<b>string</b> <span id="r710 rd" class="r710 r">path</span>)
        {
            <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r710 r">path</span>))
            {
                <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../utils/MshTraceSource.cs.html#fed5f40dc0075d41" class="i method">NewArgumentException</a>(<b>nameof</b>(<span class="r710 r">path</span>));
            }
 
            <span class="r710 r">path</span> = <a href="#2679b47e3c6ebedc" class="i method">NormalizePath</a>(<span class="r710 r">path</span>);
 
            <b>return</b> <span class="i">Directory</span>.<span class="i">Exists</span>(<span class="r710 r">path</span>);
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> MoveItem
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Moves an item at the specified path to the given destination.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r711 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The path of the item to move.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r712 r">destination</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The path of the destination.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Nothing.  Moved items are written to the context&#39;s pipeline.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">System</span>.<span class="i">ArgumentException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">     path is null or empty.</span>
        <span class="c">///</span><span class="c">     destination is null or empty.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>protected override void</b> <a id="51b8ee7c1e8ecc65" href="../R/51b8ee7c1e8ecc65.html" target="n" data-glyph="75,1" class="i method">MoveItem</a>(
            <b>string</b> <span id="r711 rd" class="r711 r">path</span>,
            <b>string</b> <span id="r712 rd" class="r712 r">destination</span>)
        {
            <span class="c">// Check the parameters</span>
 
            <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r711 r">path</span>))
            {
                <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../utils/MshTraceSource.cs.html#fed5f40dc0075d41" class="i method">NewArgumentException</a>(<b>nameof</b>(<span class="r711 r">path</span>));
            }
 
            <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r712 r">destination</span>))
            {
                <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../utils/MshTraceSource.cs.html#fed5f40dc0075d41" class="i method">NewArgumentException</a>(<b>nameof</b>(<span class="r712 r">destination</span>));
            }
 
            <span class="r711 r">path</span> = <a href="#2679b47e3c6ebedc" class="i method">NormalizePath</a>(<span class="r711 r">path</span>);
            <span class="r712 r">destination</span> = <a href="#2679b47e3c6ebedc" class="i method">NormalizePath</a>(<span class="r712 r">destination</span>);
 
            <span class="c">// Verify that the target doesn&#39;t represent a device name</span>
            <b>if</b> (<a href="#f2f9701584921b3e" class="i method">PathIsReservedDeviceName</a>(<span class="r712 r">destination</span>, <span class="s">&quot;MoveError&quot;</span>))
            {
                <b>return</b>;
            }
 
            <b>try</b>
            {
                <b>bool</b> <span id="r713 rd" class="r713 r">isContainer</span> = <a href="#152bdf0e0e17cd95" class="i method">IsItemContainer</a>(<span class="r711 r">path</span>);
                <a href="#3b3990865d6b9e3a" class="i field">s_tracer</a>.<a href="../utils/StructuredTraceSource.cs.html#49bf988885074437" class="i method">WriteLine</a>(<span class="s">&quot;Moving {0} to {1}&quot;</span>, <span class="r711 r">path</span>, <span class="r712 r">destination</span>);
 
                <b>if</b> (<span class="r713 r">isContainer</span>)
                {
                    <span class="c">// Get the DirectoryInfo</span>
                    <span class="i">DirectoryInfo</span> <span id="r714 rd" class="r714 r">dir</span> = <b>new</b> <span class="i">DirectoryInfo</span>(<span class="r711 r">path</span>);
 
                    <b>if</b> (<a href="#eaf4c5f09f546f86" class="i method">ItemExists</a>(<span class="r712 r">destination</span>) &amp;&amp;
                        <a href="#152bdf0e0e17cd95" class="i method">IsItemContainer</a>(<span class="r712 r">destination</span>))
                    {
                        <span class="r712 r">destination</span> = <span class="i">MakePath</span>(<span class="r712 r">destination</span>, <span class="r714 r">dir</span>.<span class="i">Name</span>);
                    }
 
                    <span class="c">// Get the confirmation text</span>
                    <b>string</b> <span id="r715 rd" class="r715 r">action</span> = <span class="i">FileSystemProviderStrings</span>.<span class="i">MoveItemActionDirectory</span>;
 
                    <b>string</b> <span id="r716 rd" class="r716 r">resource</span> = <a href="../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">FileSystemProviderStrings</span>.<span class="i">MoveItemResourceFileTemplate</span>, <span class="r714 r">dir</span>.<span class="i">FullName</span>, <span class="r712 r">destination</span>);
 
                    <span class="c">// Confirm the move with the user</span>
                    <b>if</b> (<a href="ProviderBase.cs.html#4cb6a9cf0567d153" class="i method">ShouldProcess</a>(<span class="r716 r">resource</span>, <span class="r715 r">action</span>))
                    {
                        <span class="c">// Now move the directory</span>
                        <a href="#fcd90938ee740652" class="i method">MoveDirectoryInfoItem</a>(<span class="r714 r">dir</span>, <span class="r712 r">destination</span>, <a href="ProviderBase.cs.html#e3c4d51f13fbfcaa" class="i property">Force</a>);
                    }
                }
                <b>else</b>
                {
                    <span class="c">// Get the FileInfo</span>
                    <span class="i">FileInfo</span> <span id="r717 rd" class="r717 r">file</span> = <b>new</b> <span class="i">FileInfo</span>(<span class="r711 r">path</span>);
 
                    <span class="i n">Dbg</span>.<a href="../utils/assert.cs.html#c04955255430d32f" class="t t">Diagnostics</a>.<span class="i">Assert</span>(
                        <span class="r717 r">file</span> != <b>null</b>,
                        <span class="s">&quot;FileInfo should be throwing an exception but it&#39;s &quot;</span> +
                        <span class="s">&quot;returning null instead&quot;</span>);
 
                    <b>if</b> (<a href="#152bdf0e0e17cd95" class="i method">IsItemContainer</a>(<span class="r712 r">destination</span>))
                    {
                        <span class="c">// Construct the new file path from the destination</span>
                        <span class="c">// directory and the file name</span>
                        <span class="r712 r">destination</span> = <span class="i">MakePath</span>(<span class="r712 r">destination</span>, <span class="r717 r">file</span>.<span class="i">Name</span>);
                    }
 
                    <span class="c">// Get the confirmation text</span>
                    <b>string</b> <span id="r718 rd" class="r718 r">action</span> = <span class="i">FileSystemProviderStrings</span>.<span class="i">MoveItemActionFile</span>;
 
                    <b>string</b> <span id="r719 rd" class="r719 r">resource</span> = <a href="../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">FileSystemProviderStrings</span>.<span class="i">MoveItemResourceFileTemplate</span>, <span class="r717 r">file</span>.<span class="i">FullName</span>, <span class="r712 r">destination</span>);
 
                    <span class="c">// Confirm the move with the user</span>
                    <b>if</b> (<a href="ProviderBase.cs.html#4cb6a9cf0567d153" class="i method">ShouldProcess</a>(<span class="r719 r">resource</span>, <span class="r718 r">action</span>))
                    {
                        <a href="#989dbb1b97e5fd68" class="i method">MoveFileInfoItem</a>(<span class="r717 r">file</span>, <span class="r712 r">destination</span>, <a href="ProviderBase.cs.html#e3c4d51f13fbfcaa" class="i property">Force</a>, <b>true</b>);
                    }
                }
            }
            <b>catch</b> (<span class="i">ArgumentException</span> <span id="r720 rd" class="r720 r">argException</span>)
            {
                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r720 r">argException</span>, <span class="s">&quot;MoveItemArgumentError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#846d2b572f2c4820" class="i field">InvalidArgument</a>, <span class="r711 r">path</span>));
            }
            <b>catch</b> (<span class="i">IOException</span> <span id="r721 rd" class="r721 r">ioException</span>)
            {
                <span class="c">// IOException contains specific message about the error occurred and so no need for errordetails.</span>
                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r721 r">ioException</span>, <span class="s">&quot;MoveItemIOError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#0c2f4b9c74e5b7c2" class="i field">WriteError</a>, <span class="r711 r">path</span>));
            }
            <b>catch</b> (<span class="i">UnauthorizedAccessException</span> <span id="r722 rd" class="r722 r">accessException</span>)
            {
                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r722 r">accessException</span>, <span class="s">&quot;MoveItemUnauthorizedAccessError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#26ba13af79d30a75" class="i field">PermissionDenied</a>, <span class="r711 r">path</span>));
            }
        }
 
        <b>private void</b> <a id="989dbb1b97e5fd68" href="../R/989dbb1b97e5fd68.html" target="n" data-glyph="76,1" class="i method">MoveFileInfoItem</a>(
            <span class="i">FileInfo</span> <span id="r723 rd" class="r723 r">file</span>,
            <b>string</b> <span id="r724 rd" class="r724 r">destination</span>,
            <b>bool</b> <span id="r725 rd" class="r725 r">force</span>,
            <b>bool</b> <span id="r726 rd" class="r726 r">output</span>)
        {
            <span class="i n">Dbg</span>.<a href="../utils/assert.cs.html#c04955255430d32f" class="t t">Diagnostics</a>.<a href="../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(
                <span class="r723 r">file</span> != <b>null</b>,
                <span class="s">&quot;The caller should verify file.&quot;</span>);
 
            <span class="i n">Dbg</span>.<a href="../utils/assert.cs.html#c04955255430d32f" class="t t">Diagnostics</a>.<span class="i">Assert</span>(
                !<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r724 r">destination</span>),
                <span class="s">&quot;THe caller should verify destination.&quot;</span>);
 
            <b>try</b>
            {
                <span class="c">// Move the file</span>
                <span class="r723 r">file</span>.<span class="i">MoveTo</span>(<span class="r724 r">destination</span>);
 
                <b>if</b> (<span class="r726 r">output</span>)
                {
                    <span class="i">WriteItemObject</span>(
                        <span class="r723 r">file</span>,
                        <span class="r723 r">file</span>.<span class="i">FullName</span>,
                        <b>false</b>);
                }
            }
            <b>catch</b> (<span class="i n">System</span>.<span class="i">UnauthorizedAccessException</span> <span id="r727 rd" class="r727 r">unauthorizedAccess</span>)
            {
                <span class="c">// This error is thrown when the readonly bit is set.</span>
                <b>if</b> (<span class="r725 r">force</span>)
                {
                    <b>try</b>
                    {
                        <span class="c">// mask off the readonly and hidden bits and try again</span>
                        <span class="r723 r">file</span>.<span class="i">Attributes</span> &amp;= ~(<span class="i">FileAttributes</span>.<span class="i">ReadOnly</span> | <span class="i">FileAttributes</span>.<span class="i">Hidden</span>);
 
                        <span class="r723 r">file</span>.<span class="i">MoveTo</span>(<span class="r724 r">destination</span>);
 
                        <b>if</b> (<span class="r726 r">output</span>)
                        {
                            <span class="i">WriteItemObject</span>(<span class="r723 r">file</span>, <span class="r723 r">file</span>.<span class="i">FullName</span>, <b>false</b>);
                        }
                    }
                    <b>catch</b> (<span class="i">Exception</span> <span id="r728 rd" class="r728 r">e</span>)
                    {
                        <b>if</b> ((<span class="r728 r">e</span> <b>is</b> <span class="i">IOException</span>) ||
                            (<span class="r728 r">e</span> <b>is</b> <span class="i">ArgumentNullException</span>) ||
                            (<span class="r728 r">e</span> <b>is</b> <span class="i">ArgumentException</span>) ||
                            (<span class="r728 r">e</span> <b>is</b> <span class="i n">System</span>.<span class="i">Security</span>.<span class="i">SecurityException</span>) ||
                            (<span class="r728 r">e</span> <b>is</b> <span class="i">UnauthorizedAccessException</span>) ||
                            (<span class="r728 r">e</span> <b>is</b> <span class="i">FileNotFoundException</span>) ||
                            (<span class="r728 r">e</span> <b>is</b> <span class="i">DirectoryNotFoundException</span>) ||
                            (<span class="r728 r">e</span> <b>is</b> <span class="i">PathTooLongException</span>) ||
                            (<span class="r728 r">e</span> <b>is</b> <span class="i">NotSupportedException</span>))
                        {
                            <span class="c">// If any exception occurs return the original error</span>
                            <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r727 r">unauthorizedAccess</span>, <span class="s">&quot;MoveFileInfoItemUnauthorizedAccessError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#26ba13af79d30a75" class="i field">PermissionDenied</a>, <span class="r723 r">file</span>));
                        }
                        <b>else</b>
                            <b>throw</b>;
                    }
                }
                <b>else</b>
                {
                    <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r727 r">unauthorizedAccess</span>, <span class="s">&quot;MoveFileInfoItemUnauthorizedAccessError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#26ba13af79d30a75" class="i field">PermissionDenied</a>, <span class="r723 r">file</span>));
                }
            }
            <b>catch</b> (<span class="i">ArgumentException</span> <span id="r729 rd" class="r729 r">argException</span>)
            {
                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r729 r">argException</span>, <span class="s">&quot;MoveFileInfoItemArgumentError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#846d2b572f2c4820" class="i field">InvalidArgument</a>, <span class="r723 r">file</span>));
            }
            <b>catch</b> (<span class="i">IOException</span> <span id="r730 rd" class="r730 r">ioException</span>)
            {
                <span class="c">// check if destination file exists. if force is specified then we should delete the destination before moving</span>
                <b>if</b> (<span class="r725 r">force</span> &amp;&amp; <span class="i">File</span>.<span class="i">Exists</span>(<span class="r724 r">destination</span>))
                {
                    <span class="i">FileInfo</span> <span id="r731 rd" class="r731 r">destfile</span> = <b>new</b> <span class="i">FileInfo</span>(<span class="r724 r">destination</span>);
                    <b>if</b> (<span class="r731 r">destfile</span> != <b>null</b>)
                    {
                        <b>try</b>
                        {
                            <span class="c">// Make sure the file is not read only</span>
                            <span class="r731 r">destfile</span>.<span class="i">Attributes</span> &amp;= ~(<span class="i">FileAttributes</span>.<span class="i">ReadOnly</span> | <span class="i">FileAttributes</span>.<span class="i">Hidden</span>);
                            <span class="r731 r">destfile</span>.<span class="i">Delete</span>();
                            <span class="r723 r">file</span>.<span class="i">MoveTo</span>(<span class="r724 r">destination</span>);
 
                            <b>if</b> (<span class="r726 r">output</span>)
                            {
                                <span class="i">WriteItemObject</span>(<span class="r723 r">file</span>, <span class="r723 r">file</span>.<span class="i">FullName</span>, <b>false</b>);
                            }
                        }
                        <b>catch</b> (<span class="i">Exception</span> <span id="r732 rd" class="r732 r">exception</span>)
                        {
                            <b>if</b> ((<span class="r732 r">exception</span> <b>is</b> <span class="i">FileNotFoundException</span>) ||
                                (<span class="r732 r">exception</span> <b>is</b> <span class="i">DirectoryNotFoundException</span>) ||
                                (<span class="r732 r">exception</span> <b>is</b> <span class="i">UnauthorizedAccessException</span>) ||
                                (<span class="r732 r">exception</span> <b>is</b> <span class="i n">System</span>.<span class="i">Security</span>.<span class="i">SecurityException</span>) ||
                                (<span class="r732 r">exception</span> <b>is</b> <span class="i">ArgumentException</span>) ||
                                (<span class="r732 r">exception</span> <b>is</b> <span class="i">PathTooLongException</span>) ||
                                (<span class="r732 r">exception</span> <b>is</b> <span class="i">NotSupportedException</span>) ||
                                (<span class="r732 r">exception</span> <b>is</b> <span class="i">ArgumentNullException</span>) ||
                                (<span class="r732 r">exception</span> <b>is</b> <span class="i">IOException</span>))
                            {
                                <span class="c">// IOException contains specific message about the error occurred and so no need for errordetails.</span>
                                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r730 r">ioException</span>, <span class="s">&quot;MoveFileInfoItemIOError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#0c2f4b9c74e5b7c2" class="i field">WriteError</a>, <span class="r731 r">destfile</span>));
                            }
                            <b>else</b>
                                <b>throw</b>;
                        }
                    }
                    <b>else</b>
                    {
                        <span class="c">// IOException contains specific message about the error occurred and so no need for errordetails.</span>
                        <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r730 r">ioException</span>, <span class="s">&quot;MoveFileInfoItemIOError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#0c2f4b9c74e5b7c2" class="i field">WriteError</a>, <span class="r723 r">file</span>));
                    }
                }
                <b>else</b>
                {
                    <span class="c">// IOException contains specific message about the error occurred and so no need for errordetails.</span>
                    <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r730 r">ioException</span>, <span class="s">&quot;MoveFileInfoItemIOError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#0c2f4b9c74e5b7c2" class="i field">WriteError</a>, <span class="r723 r">file</span>));
                }
            }
        }
 
        <b>private void</b> <a id="fcd90938ee740652" href="../R/fcd90938ee740652.html" target="n" data-glyph="76,1" class="i method">MoveDirectoryInfoItem</a>(
            <span class="i">DirectoryInfo</span> <span id="r733 rd" class="r733 r">directory</span>,
            <b>string</b> <span id="r734 rd" class="r734 r">destination</span>,
            <b>bool</b> <span id="r735 rd" class="r735 r">force</span>)
        {
            <span class="i n">Dbg</span>.<a href="../utils/assert.cs.html#c04955255430d32f" class="t t">Diagnostics</a>.<a href="../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(
                <span class="r733 r">directory</span> != <b>null</b>,
                <span class="s">&quot;The caller should verify directory.&quot;</span>);
 
            <span class="i n">Dbg</span>.<a href="../utils/assert.cs.html#c04955255430d32f" class="t t">Diagnostics</a>.<span class="i">Assert</span>(
                !<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r734 r">destination</span>),
                <span class="s">&quot;The caller should verify destination.&quot;</span>);
 
            <b>try</b>
            {
                <a href="#cf0d7aa85c107967" class="i method">MoveDirectoryInfoUnchecked</a>(<span class="r733 r">directory</span>, <span class="r734 r">destination</span>, <span class="r735 r">force</span>);
 
                <span class="i">WriteItemObject</span>(
                    <span class="r733 r">directory</span>,
                    <span class="r733 r">directory</span>.<span class="i">FullName</span>,
                    <b>true</b>);
            }
            <b>catch</b> (<span class="i n">System</span>.<span class="i">UnauthorizedAccessException</span> <span id="r736 rd" class="r736 r">unauthorizedAccess</span>)
            {
                <span class="c">// This error is thrown when the readonly bit is set.</span>
                <b>if</b> (<span class="r735 r">force</span>)
                {
                    <b>try</b>
                    {
                        <span class="c">// mask off the readonly and hidden bits and try again</span>
                        <span class="r733 r">directory</span>.<span class="i">Attributes</span> &amp;= ~(<span class="i">FileAttributes</span>.<span class="i">ReadOnly</span> | <span class="i">FileAttributes</span>.<span class="i">Hidden</span>);
 
                        <a href="#cf0d7aa85c107967" class="i method">MoveDirectoryInfoUnchecked</a>(<span class="r733 r">directory</span>, <span class="r734 r">destination</span>, <span class="r735 r">force</span>);
 
                        <span class="i">WriteItemObject</span>(<span class="r733 r">directory</span>, <span class="r733 r">directory</span>.<span class="i">FullName</span>, <b>true</b>);
                    }
                    <b>catch</b> (<span class="i">IOException</span>)
                    {
                        <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r736 r">unauthorizedAccess</span>, <span class="s">&quot;MoveDirectoryItemUnauthorizedAccessError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#26ba13af79d30a75" class="i field">PermissionDenied</a>, <span class="r733 r">directory</span>));
                    }
                    <b>catch</b> (<span class="i">Exception</span> <span id="r737 rd" class="r737 r">exception</span>)
                    {
                        <b>if</b> ((<span class="r737 r">exception</span> <b>is</b> <span class="i">FileNotFoundException</span>) ||
                            (<span class="r737 r">exception</span> <b>is</b> <span class="i">ArgumentNullException</span>) ||
                            (<span class="r737 r">exception</span> <b>is</b> <span class="i">DirectoryNotFoundException</span>) ||
                            (<span class="r737 r">exception</span> <b>is</b> <span class="i n">System</span>.<span class="i">Security</span>.<span class="i">SecurityException</span>) ||
                            (<span class="r737 r">exception</span> <b>is</b> <span class="i">ArgumentException</span>))
                        {
                            <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r736 r">unauthorizedAccess</span>, <span class="s">&quot;MoveDirectoryItemUnauthorizedAccessError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#26ba13af79d30a75" class="i field">PermissionDenied</a>, <span class="r733 r">directory</span>));
                        }
                        <b>else</b>
                            <b>throw</b>;
                    }
                }
                <b>else</b>
                {
                    <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r736 r">unauthorizedAccess</span>, <span class="s">&quot;MoveDirectoryItemUnauthorizedAccessError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#26ba13af79d30a75" class="i field">PermissionDenied</a>, <span class="r733 r">directory</span>));
                }
            }
            <b>catch</b> (<span class="i">ArgumentException</span> <span id="r738 rd" class="r738 r">argException</span>)
            {
                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r738 r">argException</span>, <span class="s">&quot;MoveDirectoryItemArgumentError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#846d2b572f2c4820" class="i field">InvalidArgument</a>, <span class="r733 r">directory</span>));
            }
            <b>catch</b> (<span class="i">IOException</span> <span id="r739 rd" class="r739 r">ioException</span>)
            {
                <span class="c">// IOException contains specific message about the error occurred and so no need for errordetails.</span>
                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r739 r">ioException</span>, <span class="s">&quot;MoveDirectoryItemIOError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#0c2f4b9c74e5b7c2" class="i field">WriteError</a>, <span class="r733 r">directory</span>));
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Implements the file move operation for directories without handling any error scenarios.</span>
        <span class="c">///</span><span class="c"> In particular, this attempts to rename or copy+delete the file,</span>
        <span class="c">///</span><span class="c"> but passes any exceptional behavior through to the caller.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r740 r">directory</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The directory to move.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r741 r">destinationPath</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The destination path to move the directory to.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r742 r">force</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">If true, force move the directory, overwriting anything at the destination.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>private void</b> <a id="cf0d7aa85c107967" href="../R/cf0d7aa85c107967.html" target="n" data-glyph="76,1" class="i method">MoveDirectoryInfoUnchecked</a>(<span class="i">DirectoryInfo</span> <span id="r740 rd" class="r740 r">directory</span>, <b>string</b> <span id="r741 rd" class="r741 r">destinationPath</span>, <b>bool</b> <span id="r742 rd" class="r742 r">force</span>)
        {
            <b>try</b>
            {
                <b>if</b> (<a href="../engine/Utils.cs.html#f365eaa75311eda0" class="t t">InternalTestHooks</a>.<a href="../engine/Utils.cs.html#7ab5bd80fb0edd04" class="i field">ThrowExdevErrorOnMoveDirectory</a>)
                {
                    <b>throw</b> <b>new</b> <span class="i">IOException</span>(<span class="s">&quot;Invalid cross-device link&quot;</span>);
                }
 
                <span class="r740 r">directory</span>.<span class="i">MoveTo</span>(<span class="r741 r">destinationPath</span>);
            }
            <b>catch</b> (<span class="i">IOException</span>)
            {
                <span class="c">// Rather than try to ascertain whether we can rename a directory ahead of time,</span>
                <span class="c">// it&#39;s both faster and more correct to try to rename it and fall back to copy/deleting it</span>
                <span class="c">// See also: https://github.com/coreutils/coreutils/blob/439741053256618eb651e6d43919df29625b8714/src/mv.c#L212-L216</span>
                <a href="#9443124e7e66de1f" class="i method">CopyAndDelete</a>(<span class="r740 r">directory</span>, <span class="r741 r">destinationPath</span>, <span class="r742 r">force</span>);
            }
        }
 
        <b>private void</b> <a id="9443124e7e66de1f" href="../R/9443124e7e66de1f.html" target="n" data-glyph="76,1" class="i method">CopyAndDelete</a>(<span class="i">DirectoryInfo</span> <span id="r743 rd" class="r743 r">directory</span>, <b>string</b> <span id="r744 rd" class="r744 r">destination</span>, <b>bool</b> <span id="r745 rd" class="r745 r">force</span>)
        {
            <b>if</b> (!<a href="#eaf4c5f09f546f86" class="i method">ItemExists</a>(<span class="r744 r">destination</span>))
            {
                <a href="#8ee1f3e6ca6489ce" class="i method">CreateDirectory</a>(<span class="r744 r">destination</span>, <b>false</b>);
            }
            <b>else</b> <b>if</b> (<a href="#eaf4c5f09f546f86" class="i method">ItemExists</a>(<span class="r744 r">destination</span>) &amp;&amp; !<a href="#152bdf0e0e17cd95" class="i method">IsItemContainer</a>(<span class="r744 r">destination</span>))
            {
                <b>string</b> <span id="r746 rd" class="r746 r">errorMessage</span> = <a href="../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">FileSystemProviderStrings</span>.<span class="i">DirectoryExist</span>, <span class="r744 r">destination</span>);
                <span class="i">Exception</span> <span id="r747 rd" class="r747 r">e</span> = <b>new</b> <span class="i">IOException</span>(<span class="r746 r">errorMessage</span>);
 
                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <a href="../engine/ErrorPackage.cs.html#e9334565e5136f43" class="t constructor">ErrorRecord</a>(
                    <span class="r747 r">e</span>,
                    <span class="s">&quot;DirectoryExist&quot;</span>,
                    <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#22cb3b8b80f740be" class="i field">ResourceExists</a>,
                    <span class="r744 r">destination</span>));
                <b>return</b>;
            }
 
            <b>foreach</b> (<span class="i">FileInfo</span> <span id="r748 rd" class="r748 r">file</span> <b>in</b> <span class="r743 r">directory</span>.<span class="i">EnumerateFiles</span>())
            {
                <span class="i">MoveFileInfoItem</span>(<span class="r748 r">file</span>, <span class="i">Path</span>.<span class="i">Combine</span>(<span class="r744 r">destination</span>, <span class="r748 r">file</span>.<span class="i">Name</span>), <span class="r745 r">force</span>, <b>false</b>);
            }
 
            <b>foreach</b> (<span class="i">DirectoryInfo</span> <span id="r749 rd" class="r749 r">dir</span> <b>in</b> <span class="r743 r">directory</span>.<span class="i">EnumerateDirectories</span>())
            {
                <span class="i">CopyAndDelete</span>(<span class="r749 r">dir</span>, <span class="i">Path</span>.<span class="i">Combine</span>(<span class="r744 r">destination</span>, <span class="r749 r">dir</span>.<span class="i">Name</span>), <span class="r745 r">force</span>);
            }
 
            <b>if</b> (!<span class="r743 r">directory</span>.<span class="i">EnumerateDirectories</span>().<span class="i">Any</span>() &amp;&amp; !<span class="r743 r">directory</span>.<span class="i">EnumerateFiles</span>().<span class="i">Any</span>())
            {
                <span class="i">RemoveItem</span>(<span class="r743 r">directory</span>.<span class="i">FullName</span>, <b>false</b>);
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> MoveItem
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> NavigationCmdletProvider members
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> IPropertyCmdletProvider
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets a property for the given item.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r750 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The fully qualified path to the item.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r751 r">providerSpecificPickList</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The list of properties to get.  Examples include &quot;Attributes&quot;, &quot;LastAccessTime,&quot;</span>
        <span class="c">///</span><span class="c"> and other properties defined by</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">System</span>.<span class="i">IO</span>.<span class="i">DirectoryInfo</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> and</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">System</span>.<span class="i">IO</span>.<span class="i">FileInfo</span><span class="c">&quot;</span><span class="c">/&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>public void</b> <a id="08096bf331edfe1b" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">GetProperty</a>(<b>string</b> <span id="r750 rd" class="r750 r">path</span>, <span class="i">Collection</span>&lt;<b>string</b>&gt; <span id="r751 rd" class="r751 r">providerSpecificPickList</span>)
        {
            <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r750 r">path</span>))
            {
                <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../utils/MshTraceSource.cs.html#fed5f40dc0075d41" class="i method">NewArgumentException</a>(<b>nameof</b>(<span class="r750 r">path</span>));
            }
 
            <span class="r750 r">path</span> = <a href="#2679b47e3c6ebedc" class="i method">NormalizePath</a>(<span class="r750 r">path</span>);
 
            <a href="../engine/MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r752 rd" class="r752 r">result</span> = <b>null</b>;
 
            <b>try</b>
            {
                <b>var</b> <span id="r753 rd" class="r753 r">fileSystemObject</span> = <a href="#03417d6757ea1d51" class="i method">GetFileSystemInfo</a>(<span class="r750 r">path</span>, <b>out bool</b> <span id="r754 rd" class="r754 r">isDirectory</span>);
 
                <b>if</b> (<span class="r753 r">fileSystemObject</span> == <b>null</b>)
                {
                    <b>string</b> <span id="r755 rd" class="r755 r">error</span> = <a href="../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">FileSystemProviderStrings</span>.<span class="i">ItemDoesNotExist</span>, <span class="r750 r">path</span>);
                    <span class="i">Exception</span> <span id="r756 rd" class="r756 r">e</span> = <b>new</b> <span class="i">IOException</span>(<span class="r755 r">error</span>);
                    <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <a href="../engine/ErrorPackage.cs.html#e9334565e5136f43" class="t constructor">ErrorRecord</a>(
                        <span class="r756 r">e</span>,
                        <span class="s">&quot;ItemDoesNotExist&quot;</span>,
                        <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#9a72a7d3051ac7c5" class="i field">ObjectNotFound</a>,
                        <span class="r750 r">path</span>));
                }
                <b>else</b>
                {
                    <span class="c">// Finally get the properties</span>
                    <b>if</b> (<span class="r751 r">providerSpecificPickList</span> == <b>null</b> || <span class="r751 r">providerSpecificPickList</span>.<span class="i">Count</span> == 0)
                    {
                        <span class="r752 r">result</span> = <a href="../engine/MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>.<span class="i">AsPSObject</span>(<span class="r753 r">fileSystemObject</span>);
                    }
                    <b>else</b>
                    {
                        <b>foreach</b> (<b>string</b> <span id="r757 rd" class="r757 r">property</span> <b>in</b> <span class="r751 r">providerSpecificPickList</span>)
                        {
                            <b>if</b> (<span class="r757 r">property</span> != <b>null</b> &amp;&amp; <span class="r757 r">property</span>.<span class="i">Length</span> &gt; 0)
                            {
                                <b>try</b>
                                {
                                    <a href="../engine/MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r758 rd" class="r758 r">mshObject</span> = <a href="../engine/MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>.<span class="i">AsPSObject</span>(<span class="r753 r">fileSystemObject</span>);
                                    <a href="../engine/MshMemberInfo.cs.html#fbee845d6706f8da" class="t t">PSMemberInfo</a> <span id="r759 rd" class="r759 r">member</span> = <span class="r758 r">mshObject</span>.<a href="../engine/MshObject.cs.html#59e9cd1ad57ccd34" class="i property">Properties</a><a href="../engine/MshMemberInfo.cs.html#f603b32aa49d3ffa">[</a><span class="r757 r">property</span>];
                                    <b>object</b> <span id="r760 rd" class="r760 r">value</span>;
                                    <b>if</b> (<span class="r759 r">member</span> != <b>null</b>)
                                    {
                                        <span class="r760 r">value</span> = <span class="r759 r">member</span>.<a href="../engine/MshMemberInfo.cs.html#cd3a9989baedf3dd" class="i property">Value</a>;
                                        <b>if</b> (<span class="r752 r">result</span> == <b>null</b>)
                                        {
                                            <span class="r752 r">result</span> = <b>new</b> <a href="../engine/MshObject.cs.html#cbbe437e20e8b8b8" class="t constructor">PSObject</a>();
                                        }
 
                                        <span class="r752 r">result</span>.<a href="../engine/MshObject.cs.html#59e9cd1ad57ccd34" class="i property">Properties</a>.<a href="../engine/MshMemberInfo.cs.html#a9e3a2dc56d98237" class="i method">Add</a>(<b>new</b> <a href="../engine/MshMemberInfo.cs.html#f4e5bccf8ccb9f2a" class="t constructor">PSNoteProperty</a>(<span class="r757 r">property</span>, <span class="r760 r">value</span>));
                                    }
                                    <b>else</b>
                                    {
                                        <b>string</b> <span id="r761 rd" class="r761 r">error</span> =
                                            <a href="../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(
                                                <span class="i">FileSystemProviderStrings</span>.<span class="i">PropertyNotFound</span>,
                                                <span class="r757 r">property</span>);
                                        <span class="i">Exception</span> <span id="r762 rd" class="r762 r">e</span> = <b>new</b> <span class="i">IOException</span>(<span class="r761 r">error</span>);
                                        <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <a href="../engine/ErrorPackage.cs.html#e9334565e5136f43" class="t constructor">ErrorRecord</a>(<span class="r762 r">e</span>, <span class="s">&quot;GetValueError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#cad1e0e3e13dc1f3" class="i field">ReadError</a>, <span class="r757 r">property</span>));
                                    }
                                }
                                <b>catch</b> (<a href="../engine/ExtendedTypeSystemException.cs.html#396f7c7b826437d7" class="t t">GetValueException</a> <span id="r763 rd" class="r763 r">exception</span>)
                                {
                                    <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r763 r">exception</span>, <span class="s">&quot;GetValueError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#cad1e0e3e13dc1f3" class="i field">ReadError</a>, <span class="r757 r">property</span>));
                                }
                            }
                        }
                    }
                }
            }
            <b>catch</b> (<span class="i">ArgumentException</span> <span id="r764 rd" class="r764 r">argException</span>)
            {
                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r764 r">argException</span>, <span class="s">&quot;GetPropertyArgumentError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#846d2b572f2c4820" class="i field">InvalidArgument</a>, <span class="r750 r">path</span>));
            }
            <b>catch</b> (<span class="i">IOException</span> <span id="r765 rd" class="r765 r">ioException</span>)
            {
                <span class="c">// IOException contains specific message about the error occurred and so no need for errordetails.</span>
                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r765 r">ioException</span>, <span class="s">&quot;GetPropertyIOError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#cad1e0e3e13dc1f3" class="i field">ReadError</a>, <span class="r750 r">path</span>));
            }
            <b>catch</b> (<span class="i">UnauthorizedAccessException</span> <span id="r766 rd" class="r766 r">accessException</span>)
            {
                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r766 r">accessException</span>, <span class="s">&quot;GetPropertyUnauthorizedAccessError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#26ba13af79d30a75" class="i field">PermissionDenied</a>, <span class="r750 r">path</span>));
            }
 
            <b>if</b> (<span class="r752 r">result</span> != <b>null</b>)
            {
                <a href="ProviderBase.cs.html#23d43fdf180baa8e" class="i method">WritePropertyObject</a>(<span class="r752 r">result</span>, <span class="r750 r">path</span>);
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the dynamic property parameters required by the get-itemproperty cmdlet.</span>
        <span class="c">///</span><span class="c"> This feature is not required by the File System provider.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r767 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If the path was specified on the command line, this is the path</span>
        <span class="c">///</span><span class="c"> to the item for which to get the dynamic parameters.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r768 r">providerSpecificPickList</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> A list of properties that should be retrieved. If this parameter is null</span>
        <span class="c">///</span><span class="c"> or empty, all properties should be retrieved.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Null.  This feature is not required by the File System provider.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public object</b> <a id="e03613faacc75c43" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">GetPropertyDynamicParameters</a>(
            <b>string</b> <span id="r767 rd" class="r767 r">path</span>,
            <span class="i">Collection</span>&lt;<b>string</b>&gt; <span id="r768 rd" class="r768 r">providerSpecificPickList</span>)
        {
            <b>return</b> <b>null</b>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Sets the specified properties on the item at the given path.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r769 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The path of the item on which to set the properties.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r770 r">propertyToSet</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> A PSObject which contains a collection of the names and values</span>
        <span class="c">///</span><span class="c"> of the properties to be set.  The File System provider supports setting</span>
        <span class="c">///</span><span class="c"> only the &quot;Attributes&quot; property.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">System</span>.<span class="i">ArgumentException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">     path is null or empty.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">System</span>.<span class="i">ArgumentNullException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">     propertyToSet is null.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>public void</b> <a id="2e19b0b32ff29f1e" href="../R/2e19b0b32ff29f1e.html" target="n" data-glyph="72,1" class="i method">SetProperty</a>(<b>string</b> <span id="r769 rd" class="r769 r">path</span>, <a href="../engine/MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r770 rd" class="r770 r">propertyToSet</span>)
        {
            <span class="c">// verify parameters</span>
 
            <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r769 r">path</span>))
            {
                <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../utils/MshTraceSource.cs.html#fed5f40dc0075d41" class="i method">NewArgumentException</a>(<b>nameof</b>(<span class="r769 r">path</span>));
            }
 
            <b>if</b> (<span class="r770 r">propertyToSet</span> == <b>null</b>)
            {
                <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../utils/MshTraceSource.cs.html#fbe67220ad7522a0" class="i method">NewArgumentNullException</a>(<b>nameof</b>(<span class="r770 r">propertyToSet</span>));
            }
 
            <span class="r769 r">path</span> = <a href="#2679b47e3c6ebedc" class="i method">NormalizePath</a>(<span class="r769 r">path</span>);
 
            <a href="../engine/MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r771 rd" class="r771 r">results</span> = <b>new</b> <a href="../engine/MshObject.cs.html#cbbe437e20e8b8b8" class="t constructor">PSObject</a>();
 
            <b>var</b> <span id="r772 rd" class="r772 r">fsinfo</span> = <a href="#03417d6757ea1d51" class="i method">GetFileSystemInfo</a>(<span class="r769 r">path</span>, <b>out bool</b> <span id="r773 rd" class="r773 r">isDirectory</span>);
 
            <span class="c">// Create a PSObject with either a DirectoryInfo or FileInfo object at its core.</span>
            <b>if</b> (<span class="r772 r">fsinfo</span> != <b>null</b>)
            {
                <a href="../engine/MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r774 rd" class="r774 r">fileSystemInfoShell</span> = <a href="../engine/MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>.<span class="i">AsPSObject</span>(<span class="r772 r">fsinfo</span>);
 
                <b>bool</b> <span id="r775 rd" class="r775 r">propertySet</span> = <b>false</b>;
 
                <b>foreach</b> (<a href="../engine/MshMemberInfo.cs.html#fbee845d6706f8da" class="t t">PSMemberInfo</a> <span id="r776 rd" class="r776 r">property</span> <b>in</b> <span class="r770 r">propertyToSet</span>.<a href="../engine/MshObject.cs.html#59e9cd1ad57ccd34" class="i property">Properties</a>)
                {
                    <b>object</b> <span id="r777 rd" class="r777 r">propertyValue</span> = <span class="r776 r">property</span>.<a href="../engine/MshMemberInfo.cs.html#cd3a9989baedf3dd" class="i property">Value</a>;
 
                    <span class="c">// Get the confirmation text</span>
                    <b>string</b> <span id="r778 rd" class="r778 r">action</span> = <b>null</b>;
 
                    <b>if</b> (<span class="r773 r">isDirectory</span>)
                    {
                        <span class="r778 r">action</span> = <span class="i">FileSystemProviderStrings</span>.<span class="i">SetPropertyActionDirectory</span>;
                    }
                    <b>else</b>
                    {
                        <span class="r778 r">action</span> = <span class="i">FileSystemProviderStrings</span>.<span class="i">SetPropertyActionFile</span>;
                    }
 
                    <b>string</b> <span id="r779 rd" class="r779 r">resourceTemplate</span> = <span class="i">FileSystemProviderStrings</span>.<span class="i">SetPropertyResourceTemplate</span>;
 
                    <b>string</b> <span id="r780 rd" class="r780 r">propertyValueString</span>;
 
                    <b>try</b>
                    {
                        <span class="c">// Use a PSObject to get the string representation of the property value</span>
                        <a href="../engine/MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r781 rd" class="r781 r">propertyValuePSObject</span> = <a href="../engine/MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>.<a href="../engine/MshObject.cs.html#e81a321a846beda7" class="i method">AsPSObject</a>(<span class="r777 r">propertyValue</span>);
                        <span class="r780 r">propertyValueString</span> = <span class="r781 r">propertyValuePSObject</span>.<a href="../engine/MshObject.cs.html#298666357e641f03" class="i method">ToString</a>();
                    }
                    <b>catch</b> (<span class="i">Exception</span> <span id="r782 rd" class="r782 r">e</span>)
                    {
                        <span class="i n">Dbg</span>.<a href="../utils/assert.cs.html#c04955255430d32f" class="t t">Diagnostics</a>.<span class="i">Assert</span>(
                            <b>false</b>,
                            <span class="s">&quot;FileSystemProvider.SetProperty exception &quot;</span> + <span class="r782 r">e</span>.<span class="i">Message</span>);
                        <b>throw</b>;
                    }
 
                    <b>string</b> <span id="r783 rd" class="r783 r">resource</span> =
                        <b>string</b>.<span class="i">Format</span>(
                            <a href="ProviderBase.cs.html#be8557754a3bdef0" class="i property">Host</a>.<a href="../engine/hostifaces/MshHost.cs.html#d531244924cf2614" class="i property">CurrentCulture</a>,
                            <span class="r779 r">resourceTemplate</span>,
                            <span class="r769 r">path</span>,
                            <span class="r776 r">property</span>.<a href="../engine/MshMemberInfo.cs.html#02d8236d3d236301" class="i property">Name</a>,
                            <span class="r780 r">propertyValueString</span>);
 
                    <span class="c">// Confirm the set with the user</span>
                    <b>if</b> (<a href="ProviderBase.cs.html#4cb6a9cf0567d153" class="i method">ShouldProcess</a>(<span class="r783 r">resource</span>, <span class="r778 r">action</span>))
                    {
                        <a href="../engine/MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r784 rd" class="r784 r">mshObject</span> = <a href="../engine/MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>.<a href="../engine/MshObject.cs.html#e81a321a846beda7" class="i method">AsPSObject</a>(<span class="r774 r">fileSystemInfoShell</span>);
                        <a href="../engine/MshMemberInfo.cs.html#fbee845d6706f8da" class="t t">PSMemberInfo</a> <span id="r785 rd" class="r785 r">member</span> = <span class="r784 r">mshObject</span>.<a href="../engine/MshObject.cs.html#59e9cd1ad57ccd34" class="i property">Properties</a><a href="../engine/MshMemberInfo.cs.html#f603b32aa49d3ffa">[</a><span class="r776 r">property</span>.<a href="../engine/MshMemberInfo.cs.html#02d8236d3d236301" class="i property">Name</a>];
 
                        <b>if</b> (<span class="r785 r">member</span> != <b>null</b>)
                        {
                            <b>if</b> (<b>string</b>.<span class="i">Equals</span>(<span class="r776 r">property</span>.<a href="../engine/MshMemberInfo.cs.html#02d8236d3d236301" class="i property">Name</a>, <span class="s">&quot;attributes&quot;</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
                            {
                                <span class="i">FileAttributes</span> <span id="r786 rd" class="r786 r">attributes</span>;
 
                                <b>if</b> (<span class="r777 r">propertyValue</span> <b>is</b> <span class="i">FileAttributes</span>)
                                    <span class="r786 r">attributes</span> = (<span class="i">FileAttributes</span>)<span class="r777 r">propertyValue</span>;
                                <b>else</b>
                                    <span class="r786 r">attributes</span> = (<span class="i">FileAttributes</span>)<span class="i">Enum</span>.<span class="i">Parse</span>(<b>typeof</b>(<span class="i">FileAttributes</span>), <span class="r780 r">propertyValueString</span>, <b>true</b>);
 
                                <b>if</b> ((<span class="r786 r">attributes</span> &amp; ~(<span class="i">FileAttributes</span>.<span class="i">Archive</span> | <span class="i">FileAttributes</span>.<span class="i">Hidden</span> |
                                                        <span class="i">FileAttributes</span>.<span class="i">Normal</span> | <span class="i">FileAttributes</span>.<span class="i">ReadOnly</span> | <span class="i">FileAttributes</span>.<span class="i">System</span>)) != 0)
                                {
                                    <b>string</b> <span id="r787 rd" class="r787 r">error</span> =
                                        <a href="../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(
                                            <span class="i">FileSystemProviderStrings</span>.<span class="i">AttributesNotSupported</span>,
                                            <span class="r776 r">property</span>);
                                    <span class="i">Exception</span> <span id="r788 rd" class="r788 r">e</span> = <b>new</b> <span class="i">IOException</span>(<span class="r787 r">error</span>);
                                    <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <a href="../engine/ErrorPackage.cs.html#e9334565e5136f43" class="t constructor">ErrorRecord</a>(<span class="r788 r">e</span>, <span class="s">&quot;SetPropertyError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#cad1e0e3e13dc1f3" class="i field">ReadError</a>, <span class="r776 r">property</span>));
                                    <b>continue</b>;
                                }
                            }
 
                            <span class="r785 r">member</span>.<a href="../engine/MshMemberInfo.cs.html#cd3a9989baedf3dd" class="i property">Value</a> = <span class="r777 r">propertyValue</span>;
                            <span class="r771 r">results</span>.<a href="../engine/MshObject.cs.html#59e9cd1ad57ccd34" class="i property">Properties</a>.<a href="../engine/MshMemberInfo.cs.html#a9e3a2dc56d98237" class="i method">Add</a>(<b>new</b> <a href="../engine/MshMemberInfo.cs.html#f4e5bccf8ccb9f2a" class="t constructor">PSNoteProperty</a>(<span class="r776 r">property</span>.<a href="../engine/MshMemberInfo.cs.html#02d8236d3d236301" class="i property">Name</a>, <span class="r777 r">propertyValue</span>));
                            <span class="r775 r">propertySet</span> = <b>true</b>;
                        }
                        <b>else</b>
                        {
                            <b>string</b> <span id="r789 rd" class="r789 r">error</span> =
                                <a href="../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(
                                    <span class="i">FileSystemProviderStrings</span>.<span class="i">PropertyNotFound</span>,
                                    <span class="r776 r">property</span>);
                            <span class="i">Exception</span> <span id="r790 rd" class="r790 r">e</span> = <b>new</b> <span class="i">IOException</span>(<span class="r789 r">error</span>);
                            <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <a href="../engine/ErrorPackage.cs.html#e9334565e5136f43" class="t constructor">ErrorRecord</a>(<span class="r790 r">e</span>, <span class="s">&quot;SetPropertyError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#cad1e0e3e13dc1f3" class="i field">ReadError</a>, <span class="r776 r">property</span>));
                        }
                    }
                }
 
                <b>if</b> (<span class="r775 r">propertySet</span>)
                {
                    <a href="ProviderBase.cs.html#23d43fdf180baa8e" class="i method">WritePropertyObject</a>(<span class="r771 r">results</span>, <span class="r769 r">path</span>);
                }
            }
            <b>else</b>
            {
                <b>string</b> <span id="r791 rd" class="r791 r">error</span> = <a href="../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">FileSystemProviderStrings</span>.<span class="i">ItemDoesNotExist</span>, <span class="r769 r">path</span>);
                <span class="i">Exception</span> <span id="r792 rd" class="r792 r">e</span> = <b>new</b> <span class="i">IOException</span>(<span class="r791 r">error</span>);
                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <a href="../engine/ErrorPackage.cs.html#e9334565e5136f43" class="t constructor">ErrorRecord</a>(
                    <span class="r792 r">e</span>,
                    <span class="s">&quot;ItemDoesNotExist&quot;</span>,
                    <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#9a72a7d3051ac7c5" class="i field">ObjectNotFound</a>,
                    <span class="r769 r">path</span>));
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the dynamic property parameters required by the set-itemproperty cmdlet.</span>
        <span class="c">///</span><span class="c"> This feature is not required by the File System provider.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r793 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If the path was specified on the command line, this is the path</span>
        <span class="c">///</span><span class="c"> to the item for which to set the dynamic parameters.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r794 r">propertyValue</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> A PSObject which contains a collection of the name, type, value</span>
        <span class="c">///</span><span class="c"> of the properties to be set.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Null.  This feature is not required by the File System provider.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public object</b> <a id="d325a908c03f45a0" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">SetPropertyDynamicParameters</a>(
            <b>string</b> <span id="r793 rd" class="r793 r">path</span>,
            <a href="../engine/MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r794 rd" class="r794 r">propertyValue</span>)
        {
            <b>return</b> <b>null</b>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Clears the specified properties on the item at the given path.</span>
        <span class="c">///</span><span class="c"> The File System provider supports only the &quot;Attributes&quot; property.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r795 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The path of the item on which to clear the properties.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r796 r">propertiesToClear</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> A collection of the names of the properties to clear.  The File System</span>
        <span class="c">///</span><span class="c"> provider supports clearing only the &quot;Attributes&quot; property.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">System</span>.<span class="i">ArgumentException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">     Path is null or empty.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">System</span>.<span class="i">ArgumentNullException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">     propertiesToClear is null or count is zero.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>public void</b> <a id="192f29bd10407fc6" href="../R/192f29bd10407fc6.html" target="n" data-glyph="72,1" class="i method">ClearProperty</a>(
            <b>string</b> <span id="r795 rd" class="r795 r">path</span>,
            <span class="i">Collection</span>&lt;<b>string</b>&gt; <span id="r796 rd" class="r796 r">propertiesToClear</span>)
        {
            <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r795 r">path</span>))
            {
                <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../utils/MshTraceSource.cs.html#fed5f40dc0075d41" class="i method">NewArgumentException</a>(<b>nameof</b>(<span class="r795 r">path</span>));
            }
 
            <span class="r795 r">path</span> = <a href="#2679b47e3c6ebedc" class="i method">NormalizePath</a>(<span class="r795 r">path</span>);
 
            <b>if</b> (<span class="r796 r">propertiesToClear</span> == <b>null</b> ||
                <span class="r796 r">propertiesToClear</span>.<span class="i">Count</span> == 0)
            {
                <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../utils/MshTraceSource.cs.html#fbe67220ad7522a0" class="i method">NewArgumentNullException</a>(<b>nameof</b>(<span class="r796 r">propertiesToClear</span>));
            }
 
            <span class="c">// Only the attributes property can be cleared</span>
            <b>if</b> (<span class="r796 r">propertiesToClear</span>.<span class="i">Count</span> &gt; 1 ||
                <a href="ProviderBase.cs.html#be8557754a3bdef0" class="i property">Host</a>.<a href="../engine/hostifaces/MshHost.cs.html#d531244924cf2614" class="i property">CurrentCulture</a>.<span class="i">CompareInfo</span>.<span class="i">Compare</span>(<span class="s">&quot;Attributes&quot;</span>, <span class="r796 r">propertiesToClear</span>[0], <span class="i">CompareOptions</span>.<span class="i">IgnoreCase</span>) != 0)
            {
                <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<span class="i">NewArgumentException</span>(<b>nameof</b>(<span class="r796 r">propertiesToClear</span>), <span class="i">FileSystemProviderStrings</span>.<span class="i">CannotClearProperty</span>);
            }
 
            <b>try</b>
            {
                <span class="c">// Now the only entry in the array should be the Attributes, so clear them</span>
                <span class="i">FileSystemInfo</span> <span id="r797 rd" class="r797 r">fileSystemInfo</span> = <b>null</b>;
 
                <span class="c">// Get the confirmation text</span>
                <b>string</b> <span id="r798 rd" class="r798 r">action</span> = <b>null</b>;
 
                <b>bool</b> <span id="r799 rd" class="r799 r">isContainer</span> = <a href="#152bdf0e0e17cd95" class="i method">IsItemContainer</a>(<span class="r795 r">path</span>);
                <b>if</b> (<span class="r799 r">isContainer</span>)
                {
                    <span class="r798 r">action</span> = <span class="i">FileSystemProviderStrings</span>.<span class="i">ClearPropertyActionDirectory</span>;
 
                    <span class="r797 r">fileSystemInfo</span> = <b>new</b> <span class="i">DirectoryInfo</span>(<span class="r795 r">path</span>);
                }
                <b>else</b>
                {
                    <span class="r798 r">action</span> = <span class="i">FileSystemProviderStrings</span>.<span class="i">ClearPropertyActionFile</span>;
 
                    <span class="r797 r">fileSystemInfo</span> = <b>new</b> <span class="i">FileInfo</span>(<span class="r795 r">path</span>);
                }
 
                <b>string</b> <span id="r800 rd" class="r800 r">resourceTemplate</span> = <span class="i">FileSystemProviderStrings</span>.<span class="i">ClearPropertyResourceTemplate</span>;
 
                <b>string</b> <span id="r801 rd" class="r801 r">resource</span> =
                    <b>string</b>.<span class="i">Format</span>(
                        <a href="ProviderBase.cs.html#be8557754a3bdef0" class="i property">Host</a>.<a href="../engine/hostifaces/MshHost.cs.html#d531244924cf2614" class="i property">CurrentCulture</a>,
                        <span class="r800 r">resourceTemplate</span>,
                        <span class="r797 r">fileSystemInfo</span>.<span class="i">FullName</span>,
                        <span class="r796 r">propertiesToClear</span>[0]);
 
                <span class="c">// Confirm the set with the user</span>
                <b>if</b> (<a href="ProviderBase.cs.html#4cb6a9cf0567d153" class="i method">ShouldProcess</a>(<span class="r801 r">resource</span>, <span class="r798 r">action</span>))
                {
                    <span class="r797 r">fileSystemInfo</span>.<span class="i">Attributes</span> = <span class="i">FileAttributes</span>.<span class="i">Normal</span>;
                    <a href="../engine/MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r802 rd" class="r802 r">result</span> = <b>new</b> <a href="../engine/MshObject.cs.html#cbbe437e20e8b8b8" class="t constructor">PSObject</a>();
                    <span class="r802 r">result</span>.<a href="../engine/MshObject.cs.html#59e9cd1ad57ccd34" class="i property">Properties</a>.<a href="../engine/MshMemberInfo.cs.html#a9e3a2dc56d98237" class="i method">Add</a>(<b>new</b> <span class="t">PSNoteProperty</span>(<span class="r796 r">propertiesToClear</span>[0], <span class="r797 r">fileSystemInfo</span>.<span class="i">Attributes</span>));
 
                    <span class="c">// Now write out the attribute that was cleared.</span>
                    <a href="ProviderBase.cs.html#23d43fdf180baa8e" class="i method">WritePropertyObject</a>(<span class="r802 r">result</span>, <span class="r795 r">path</span>);
                }
            }
            <b>catch</b> (<span class="i">UnauthorizedAccessException</span> <span id="r803 rd" class="r803 r">unauthorizedAccessException</span>)
            {
                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r803 r">unauthorizedAccessException</span>, <span class="s">&quot;ClearPropertyUnauthorizedAccessError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#26ba13af79d30a75" class="i field">PermissionDenied</a>, <span class="r795 r">path</span>));
            }
            <b>catch</b> (<span class="i">ArgumentException</span> <span id="r804 rd" class="r804 r">argException</span>)
            {
                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r804 r">argException</span>, <span class="s">&quot;ClearPropertyArgumentError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#846d2b572f2c4820" class="i field">InvalidArgument</a>, <span class="r795 r">path</span>));
            }
            <b>catch</b> (<span class="i">IOException</span> <span id="r805 rd" class="r805 r">ioException</span>)
            {
                <span class="c">// IOException contains specific message about the error occurred and so no need for errordetails.</span>
                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r805 r">ioException</span>, <span class="s">&quot;ClearPropertyIOError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#0c2f4b9c74e5b7c2" class="i field">WriteError</a>, <span class="r795 r">path</span>));
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the dynamic property parameters required by the clear-itemproperty cmdlet.</span>
        <span class="c">///</span><span class="c"> This feature is not required by the File System provider.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r806 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If the path was specified on the command line, this is the path</span>
        <span class="c">///</span><span class="c"> to the item for which to set the dynamic parameters.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r807 r">propertiesToClear</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> A collection of the names of the properties to clear.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Null.  This feature is not required by the File System provider.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public object</b> <a id="e2737d3ac3f77644" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">ClearPropertyDynamicParameters</a>(
            <b>string</b> <span id="r806 rd" class="r806 r">path</span>,
            <span class="i">Collection</span>&lt;<b>string</b>&gt; <span id="r807 rd" class="r807 r">propertiesToClear</span>)
        {
            <b>return</b> <b>null</b>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> IPropertyCmdletProvider
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> IContentCmdletProvider
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Creates an instance of the FileSystemContentStream class, opens</span>
        <span class="c">///</span><span class="c"> the specified file for reading, and returns the IContentReader interface</span>
        <span class="c">///</span><span class="c"> to it.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r808 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The path of the file to be opened for reading.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> An IContentReader for the specified file.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">System</span>.<span class="i">ArgumentException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">     path is null or empty.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>public</b> <a href="IContentReader.cs.html#3b9d8a4d37108123" class="t t">IContentReader</a> <a id="0e68bbe912982ae6" href="../R/0e68bbe912982ae6.html" target="n" data-glyph="72,1" class="i method">GetContentReader</a>(<b>string</b> <span id="r808 rd" class="r808 r">path</span>)
        {
            <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r808 r">path</span>))
            {
                <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../utils/MshTraceSource.cs.html#fed5f40dc0075d41" class="i method">NewArgumentException</a>(<b>nameof</b>(<span class="r808 r">path</span>));
            }
 
            <span class="r808 r">path</span> = <a href="#2679b47e3c6ebedc" class="i method">NormalizePath</a>(<span class="r808 r">path</span>);
 
            <span class="c">// Defaults for the file read operation</span>
            <b>string</b> <span id="r809 rd" class="r809 r">delimiter</span> = <span class="s">&quot;\n&quot;</span>;
            <span class="i">Encoding</span> <span id="r810 rd" class="r810 r">encoding</span> = <a href="../utils/ClrFacade.cs.html#a9a016478ec73a42" class="t t">ClrFacade</a>.<a href="../utils/ClrFacade.cs.html#0c8a7fc2b80117dd" class="i method">GetDefaultEncoding</a>();
            <b>bool</b> <span id="r811 rd" class="r811 r">waitForChanges</span> = <b>false</b>;
 
            <b>bool</b> <span id="r812 rd" class="r812 r">streamTypeSpecified</span> = <b>false</b>;
            <b>bool</b> <span id="r813 rd" class="r813 r">usingByteEncoding</span> = <b>false</b>;
            <b>bool</b> <span id="r814 rd" class="r814 r">delimiterSpecified</span> = <b>false</b>;
            <b>bool</b> <span id="r815 rd" class="r815 r">isRawStream</span> = <b>false</b>;
            <b>string</b> <span id="r816 rd" class="r816 r">streamName</span> = <b>null</b>;
 
            <span class="c">// Get the dynamic parameters.</span>
            <span class="c">// They override the defaults specified above.</span>
            <b>if</b> (<a href="ProviderBase.cs.html#57d60aa2d2bc908d" class="i property">DynamicParameters</a> != <b>null</b>)
            {
                <a href="#3ea3397c69a1676c" class="t t">FileSystemContentReaderDynamicParameters</a> <span id="r817 rd" class="r817 r">dynParams</span> =
                    <a href="ProviderBase.cs.html#57d60aa2d2bc908d" class="i property">DynamicParameters</a> <b>as</b> <a href="#3ea3397c69a1676c" class="t t">FileSystemContentReaderDynamicParameters</a>;
 
                <b>if</b> (<span class="r817 r">dynParams</span> != <b>null</b>)
                {
                    <span class="c">// -raw is not allowed when -first,-last or -wait is specified</span>
                    <span class="c">// this call will validate that and throws.</span>
                    <a href="#7a1a9c6bbb4c3943" class="i method">ValidateParameters</a>(<span class="r817 r">dynParams</span>.<a href="#0ef6f2594f7cc514" class="i property">Raw</a>);
 
                    <span class="r815 r">isRawStream</span> = <span class="r817 r">dynParams</span>.<a href="#0ef6f2594f7cc514" class="i property">Raw</a>;
 
                    <span class="c">// Get the delimiter</span>
                    <span class="r814 r">delimiterSpecified</span> = <span class="r817 r">dynParams</span>.<a href="#316665f197d56597" class="i property">DelimiterSpecified</a>;
                    <b>if</b> (<span class="r814 r">delimiterSpecified</span>)
                        <span class="r809 r">delimiter</span> = <span class="r817 r">dynParams</span>.<a href="#1037f85f9f999306" class="i property">Delimiter</a>;
 
                    <span class="c">// Get the stream type</span>
                    <span class="r813 r">usingByteEncoding</span> = <span class="r817 r">dynParams</span>.<a href="#703200654acef170" class="i property">AsByteStream</a>;
                    <span class="r812 r">streamTypeSpecified</span> = <span class="r817 r">dynParams</span>.<a href="#535b30ec05070165" class="i property">WasStreamTypeSpecified</a>;
 
                    <b>if</b> (<span class="r813 r">usingByteEncoding</span> &amp;&amp; <span class="r812 r">streamTypeSpecified</span>)
                    {
                        <span class="i">WriteWarning</span>(<span class="i">FileSystemProviderStrings</span>.<span class="i">EncodingNotUsed</span>);
                    }
 
                    <b>if</b> (<span class="r812 r">streamTypeSpecified</span>)
                    {
                        <span class="r810 r">encoding</span> = <span class="r817 r">dynParams</span>.<a href="#436b3401e978d4f2" class="i property">Encoding</a>;
                    }
 
                    <span class="c">// Get the wait value</span>
                    <span class="r811 r">waitForChanges</span> = <span class="r817 r">dynParams</span>.<a href="#dcd641c76872efa4" class="i property">Wait</a>;
 
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">UNIX</span>
                    <span class="c">// Get the stream name</span>
                    <span class="r816 r">streamName</span> = <span class="r817 r">dynParams</span>.<a href="#f1c0191eb7e77399" class="i property">Stream</a>;
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
                }
            }
 
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">UNIX</span>
            <span class="c">// See if they&#39;ve used the inline stream syntax. They have more than one colon.</span>
            <b>int</b> <span id="r818 rd" class="r818 r">firstColon</span> = <span class="r808 r">path</span>.<span class="i">IndexOf</span>(<span class="s">&#39;:&#39;</span>);
            <b>int</b> <span id="r819 rd" class="r819 r">secondColon</span> = <span class="r808 r">path</span>.<span class="i">IndexOf</span>(<span class="s">&#39;:&#39;</span>, <span class="r818 r">firstColon</span> + 1);
            <b>if</b> (<span class="r819 r">secondColon</span> &gt; 0)
            {
                <span class="r816 r">streamName</span> = <span class="r808 r">path</span>.<span class="i">Substring</span>(<span class="r819 r">secondColon</span> + 1);
                <span class="r808 r">path</span> = <span class="r808 r">path</span>.<span class="i">Remove</span>(<span class="r819 r">secondColon</span>);
            }
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
 
            <a href="FileSystemContentStream.cs.html#adf1718ab0894286" class="t t">FileSystemContentReaderWriter</a> <span id="r820 rd" class="r820 r">stream</span> = <b>null</b>;
 
            <b>try</b>
            {
                <span class="c">// Get-Content will write a non-terminating error if the target is a directory.</span>
                <span class="c">// On Windows, the streamName must be null or empty for it to write the error. Otherwise, the</span>
                <span class="c">// alternate data stream is not a directory, even if it&#39;s set on a directory.</span>
                <b>if</b> (<span class="i">Directory</span>.<span class="i">Exists</span>(<span class="r808 r">path</span>)
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">UNIX</span>
                    &amp;&amp; <b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r816 r">streamName</span>)
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
                    )
                {
                    <b>string</b> <span id="r821 rd" class="r821 r">errMsg</span> = <a href="../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">SessionStateStrings</span>.<span class="i">GetContainerContentException</span>, <span class="r808 r">path</span>);
                    <a href="../engine/ErrorPackage.cs.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r822 rd" class="r822 r">error</span> = <b>new</b> <span class="t">ErrorRecord</span>(<b>new</b> <span class="i">InvalidOperationException</span>(<span class="r821 r">errMsg</span>), <span class="s">&quot;GetContainerContentException&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#b5cba3d51f976bb3" class="i field">InvalidOperation</a>, <b>null</b>);
                    <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<span class="r822 r">error</span>);
                    <b>return</b> <span class="r820 r">stream</span>;
                }
 
                <span class="c">// Users can&#39;t both read as bytes, and specify a delimiter</span>
                <b>if</b> (<span class="r814 r">delimiterSpecified</span>)
                {
                    <b>if</b> (<span class="r813 r">usingByteEncoding</span>)
                    {
                        <span class="i">Exception</span> <span id="r823 rd" class="r823 r">e</span> =
                            <b>new</b> <span class="i">ArgumentException</span>(<span class="i">FileSystemProviderStrings</span>.<span class="i">DelimiterError</span>, <span class="s">&quot;delimiter&quot;</span>);
                        <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <a href="../engine/ErrorPackage.cs.html#e9334565e5136f43" class="t constructor">ErrorRecord</a>(
                            <span class="r823 r">e</span>,
                            <span class="s">&quot;GetContentReaderArgumentError&quot;</span>,
                            <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#846d2b572f2c4820" class="i field">InvalidArgument</a>,
                            <span class="r808 r">path</span>));
                    }
                    <b>else</b>
                    {
                        <span class="c">// Initialize the file reader</span>
                        <span class="r820 r">stream</span> = <b>new</b> <span class="t">FileSystemContentReaderWriter</span>(<span class="r808 r">path</span>, <span class="r816 r">streamName</span>, <span class="i">FileMode</span>.<span class="i">Open</span>, <span class="i">FileAccess</span>.<span class="i">Read</span>, <span class="i">FileShare</span>.<span class="i">ReadWrite</span>, <span class="r809 r">delimiter</span>, <span class="r810 r">encoding</span>, <span class="r811 r">waitForChanges</span>, <a href="../P/64a92af39f1cd630.html#64a92af39f1cd630" class="k">this</a>, <span class="r815 r">isRawStream</span>);
                    }
                }
                <b>else</b>
                {
                    <span class="r820 r">stream</span> = <b>new</b> <span class="t">FileSystemContentReaderWriter</span>(<span class="r808 r">path</span>, <span class="r816 r">streamName</span>, <span class="i">FileMode</span>.<span class="i">Open</span>, <span class="i">FileAccess</span>.<span class="i">Read</span>, <span class="i">FileShare</span>.<span class="i">ReadWrite</span>, <span class="r810 r">encoding</span>, <span class="r813 r">usingByteEncoding</span>, <span class="r811 r">waitForChanges</span>, <a href="../P/64a92af39f1cd630.html#64a92af39f1cd630" class="k">this</a>, <span class="r815 r">isRawStream</span>);
                }
            }
            <b>catch</b> (<span class="i">PathTooLongException</span> <span id="r824 rd" class="r824 r">pathTooLong</span>)
            {
                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r824 r">pathTooLong</span>, <span class="s">&quot;GetContentReaderPathTooLongError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#846d2b572f2c4820" class="i field">InvalidArgument</a>, <span class="r808 r">path</span>));
            }
            <b>catch</b> (<span class="i">FileNotFoundException</span> <span id="r825 rd" class="r825 r">fileNotFound</span>)
            {
                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r825 r">fileNotFound</span>, <span class="s">&quot;GetContentReaderFileNotFoundError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#9a72a7d3051ac7c5" class="i field">ObjectNotFound</a>, <span class="r808 r">path</span>));
            }
            <b>catch</b> (<span class="i">DirectoryNotFoundException</span> <span id="r826 rd" class="r826 r">directoryNotFound</span>)
            {
                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r826 r">directoryNotFound</span>, <span class="s">&quot;GetContentReaderDirectoryNotFoundError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#9a72a7d3051ac7c5" class="i field">ObjectNotFound</a>, <span class="r808 r">path</span>));
            }
            <b>catch</b> (<span class="i">ArgumentException</span> <span id="r827 rd" class="r827 r">argException</span>)
            {
                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r827 r">argException</span>, <span class="s">&quot;GetContentReaderArgumentError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#846d2b572f2c4820" class="i field">InvalidArgument</a>, <span class="r808 r">path</span>));
            }
            <b>catch</b> (<span class="i">IOException</span> <span id="r828 rd" class="r828 r">ioException</span>)
            {
                <span class="c">// IOException contains specific message about the error occurred and so no need for errordetails.</span>
                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r828 r">ioException</span>, <span class="s">&quot;GetContentReaderIOError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#cad1e0e3e13dc1f3" class="i field">ReadError</a>, <span class="r808 r">path</span>));
            }
            <b>catch</b> (<span class="i n">System</span>.<span class="i">Security</span>.<span class="i">SecurityException</span> <span id="r829 rd" class="r829 r">securityException</span>)
            {
                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r829 r">securityException</span>, <span class="s">&quot;GetContentReaderSecurityError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#26ba13af79d30a75" class="i field">PermissionDenied</a>, <span class="r808 r">path</span>));
            }
            <b>catch</b> (<span class="i">UnauthorizedAccessException</span> <span id="r830 rd" class="r830 r">unauthorizedAccess</span>)
            {
                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r830 r">unauthorizedAccess</span>, <span class="s">&quot;GetContentReaderUnauthorizedAccessError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#26ba13af79d30a75" class="i field">PermissionDenied</a>, <span class="r808 r">path</span>));
            }
 
            <b>return</b> <span class="r820 r">stream</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the dynamic property parameters required by the get-content cmdlet.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r831 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If the path was specified on the command line, this is the path</span>
        <span class="c">///</span><span class="c"> to the item for which to get the dynamic parameters.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> An object that has properties and fields decorated with</span>
        <span class="c">///</span><span class="c"> parsing attributes similar to a cmdlet class.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public object</b> <a id="cc3afd26cc6b522c" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">GetContentReaderDynamicParameters</a>(<b>string</b> <span id="r831 rd" class="r831 r">path</span>)
        {
            <b>return</b> <b>new</b> <a href="#32d3814fc3c952c5" class="t constructor">FileSystemContentReaderDynamicParameters</a>(<a href="../P/64a92af39f1cd630.html#64a92af39f1cd630" class="k">this</a>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Creates an instance of the FileSystemContentStream class, opens</span>
        <span class="c">///</span><span class="c"> the specified file for writing, and returns the IContentReader interface</span>
        <span class="c">///</span><span class="c"> to it.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r832 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The path of the file to be opened for writing.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> An IContentWriter for the specified file.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">System</span>.<span class="i">ArgumentException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">     path is null or empty.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>public</b> <a href="IContentWriter.cs.html#1c68919f6402f8b9" class="t t">IContentWriter</a> <a id="d9d082c986877ed6" href="../R/d9d082c986877ed6.html" target="n" data-glyph="72,1" class="i method">GetContentWriter</a>(<b>string</b> <span id="r832 rd" class="r832 r">path</span>)
        {
            <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r832 r">path</span>))
            {
                <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../utils/MshTraceSource.cs.html#fed5f40dc0075d41" class="i method">NewArgumentException</a>(<b>nameof</b>(<span class="r832 r">path</span>));
            }
 
            <span class="r832 r">path</span> = <a href="#2679b47e3c6ebedc" class="i method">NormalizePath</a>(<span class="r832 r">path</span>);
 
            <span class="c">// If this is true, then the content will be read as bytes</span>
            <b>bool</b> <span id="r833 rd" class="r833 r">usingByteEncoding</span> = <b>false</b>;
            <b>bool</b> <span id="r834 rd" class="r834 r">streamTypeSpecified</span> = <b>false</b>;
            <span class="i">Encoding</span> <span id="r835 rd" class="r835 r">encoding</span> = <a href="../utils/ClrFacade.cs.html#a9a016478ec73a42" class="t t">ClrFacade</a>.<a href="../utils/ClrFacade.cs.html#0c8a7fc2b80117dd" class="i method">GetDefaultEncoding</a>();
            <b>const</b> <span class="i">FileMode</span> <span id="r836 rd" class="r836 r">filemode</span> = <span class="i">FileMode</span>.<span class="i">OpenOrCreate</span>;
            <b>string</b> <span id="r837 rd" class="r837 r">streamName</span> = <b>null</b>;
            <b>bool</b> <span id="r838 rd" class="r838 r">suppressNewline</span> = <b>false</b>;
 
            <span class="c">// Get the dynamic parameters</span>
            <b>if</b> (<a href="ProviderBase.cs.html#57d60aa2d2bc908d" class="i property">DynamicParameters</a> != <b>null</b>)
            {
                <a href="#a9b3825da1cbf7be" class="t t">FileSystemContentWriterDynamicParameters</a> <span id="r839 rd" class="r839 r">dynParams</span> =
                    <a href="ProviderBase.cs.html#57d60aa2d2bc908d" class="i property">DynamicParameters</a> <b>as</b> <a href="#a9b3825da1cbf7be" class="t t">FileSystemContentWriterDynamicParameters</a>;
 
                <b>if</b> (<span class="r839 r">dynParams</span> != <b>null</b>)
                {
                    <span class="r833 r">usingByteEncoding</span> = <span class="r839 r">dynParams</span>.<a href="#703200654acef170" class="i property">AsByteStream</a>;
                    <span class="r834 r">streamTypeSpecified</span> = <span class="r839 r">dynParams</span>.<a href="#535b30ec05070165" class="i property">WasStreamTypeSpecified</a>;
 
                    <b>if</b> (<span class="r833 r">usingByteEncoding</span> &amp;&amp; <span class="r834 r">streamTypeSpecified</span>)
                    {
                        <span class="i">WriteWarning</span>(<span class="i">FileSystemProviderStrings</span>.<span class="i">EncodingNotUsed</span>);
                    }
 
                    <b>if</b> (<span class="r834 r">streamTypeSpecified</span>)
                    {
                        <span class="r835 r">encoding</span> = <span class="r839 r">dynParams</span>.<a href="#436b3401e978d4f2" class="i property">Encoding</a>;
                    }
 
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">UNIX</span>
                    <span class="r837 r">streamName</span> = <span class="r839 r">dynParams</span>.<a href="#f1c0191eb7e77399" class="i property">Stream</a>;
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
                    <span class="r838 r">suppressNewline</span> = <span class="r839 r">dynParams</span>.<a href="#95c68977c1cbc95b" class="i property">NoNewline</a>.<a href="../engine/MshCmdlet.cs.html#e9c777a85700d3da" class="i property">IsPresent</a>;
                }
            }
 
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">UNIX</span>
            <span class="c">// See if they&#39;ve used the inline stream syntax. They have more than one colon.</span>
            <b>int</b> <span id="r840 rd" class="r840 r">firstColon</span> = <span class="r832 r">path</span>.<span class="i">IndexOf</span>(<span class="s">&#39;:&#39;</span>);
            <b>int</b> <span id="r841 rd" class="r841 r">secondColon</span> = <span class="r832 r">path</span>.<span class="i">IndexOf</span>(<span class="s">&#39;:&#39;</span>, <span class="r840 r">firstColon</span> + 1);
            <b>if</b> (<span class="r841 r">secondColon</span> &gt; 0)
            {
                <span class="r837 r">streamName</span> = <span class="r832 r">path</span>.<span class="i">Substring</span>(<span class="r841 r">secondColon</span> + 1);
                <span class="r832 r">path</span> = <span class="r832 r">path</span>.<span class="i">Remove</span>(<span class="r841 r">secondColon</span>);
            }
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
 
            <a href="FileSystemContentStream.cs.html#adf1718ab0894286" class="t t">FileSystemContentReaderWriter</a> <span id="r842 rd" class="r842 r">stream</span> = <b>null</b>;
 
            <b>try</b>
            {
                <span class="c">// Add-Content and Set-Content will write a non-terminating error if the target is a directory.</span>
                <span class="c">// On Windows, the streamName must be null or empty for it to write the error. Otherwise, the</span>
                <span class="c">// alternate data stream is not a directory, even if it&#39;s set on a directory.</span>
                <b>if</b> (<span class="i">Directory</span>.<span class="i">Exists</span>(<span class="r832 r">path</span>)
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">UNIX</span>
                    &amp;&amp; <b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r837 r">streamName</span>)
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
                    )
                {
                    <b>string</b> <span id="r843 rd" class="r843 r">errMsg</span> = <a href="../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">SessionStateStrings</span>.<span class="i">WriteContainerContentException</span>, <span class="r832 r">path</span>);
                    <a href="../engine/ErrorPackage.cs.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r844 rd" class="r844 r">error</span> = <b>new</b> <span class="t">ErrorRecord</span>(<b>new</b> <span class="i">InvalidOperationException</span>(<span class="r843 r">errMsg</span>), <span class="s">&quot;WriteContainerContentException&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#b5cba3d51f976bb3" class="i field">InvalidOperation</a>, <b>null</b>);
                    <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<span class="r844 r">error</span>);
                    <b>return</b> <span class="r842 r">stream</span>;
                }
 
                <span class="r842 r">stream</span> = <b>new</b> <span class="t">FileSystemContentReaderWriter</span>(<span class="r832 r">path</span>, <span class="r837 r">streamName</span>, <span class="r836 r">filemode</span>, <span class="i">FileAccess</span>.<span class="i">Write</span>, <span class="i">FileShare</span>.<span class="i">ReadWrite</span>, <span class="r835 r">encoding</span>, <span class="r833 r">usingByteEncoding</span>, <b>false</b>, <a href="../P/64a92af39f1cd630.html#64a92af39f1cd630" class="k">this</a>, <b>false</b>, <span class="r838 r">suppressNewline</span>);
            }
            <b>catch</b> (<span class="i">PathTooLongException</span> <span id="r845 rd" class="r845 r">pathTooLong</span>)
            {
                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r845 r">pathTooLong</span>, <span class="s">&quot;GetContentWriterPathTooLongError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#846d2b572f2c4820" class="i field">InvalidArgument</a>, <span class="r832 r">path</span>));
            }
            <b>catch</b> (<span class="i">FileNotFoundException</span> <span id="r846 rd" class="r846 r">fileNotFound</span>)
            {
                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r846 r">fileNotFound</span>, <span class="s">&quot;GetContentWriterFileNotFoundError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#9a72a7d3051ac7c5" class="i field">ObjectNotFound</a>, <span class="r832 r">path</span>));
            }
            <b>catch</b> (<span class="i">DirectoryNotFoundException</span> <span id="r847 rd" class="r847 r">directoryNotFound</span>)
            {
                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r847 r">directoryNotFound</span>, <span class="s">&quot;GetContentWriterDirectoryNotFoundError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#9a72a7d3051ac7c5" class="i field">ObjectNotFound</a>, <span class="r832 r">path</span>));
            }
            <b>catch</b> (<span class="i">ArgumentException</span> <span id="r848 rd" class="r848 r">argException</span>)
            {
                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r848 r">argException</span>, <span class="s">&quot;GetContentWriterArgumentError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#846d2b572f2c4820" class="i field">InvalidArgument</a>, <span class="r832 r">path</span>));
            }
            <b>catch</b> (<span class="i">IOException</span> <span id="r849 rd" class="r849 r">ioException</span>)
            {
                <span class="c">// IOException contains specific message about the error occurred and so no need for errordetails.</span>
                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r849 r">ioException</span>, <span class="s">&quot;GetContentWriterIOError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#0c2f4b9c74e5b7c2" class="i field">WriteError</a>, <span class="r832 r">path</span>));
            }
            <b>catch</b> (<span class="i n">System</span>.<span class="i">Security</span>.<span class="i">SecurityException</span> <span id="r850 rd" class="r850 r">securityException</span>)
            {
                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r850 r">securityException</span>, <span class="s">&quot;GetContentWriterSecurityError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#26ba13af79d30a75" class="i field">PermissionDenied</a>, <span class="r832 r">path</span>));
            }
            <b>catch</b> (<span class="i">UnauthorizedAccessException</span> <span id="r851 rd" class="r851 r">unauthorizedAccess</span>)
            {
                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r851 r">unauthorizedAccess</span>, <span class="s">&quot;GetContentWriterUnauthorizedAccessError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#26ba13af79d30a75" class="i field">PermissionDenied</a>, <span class="r832 r">path</span>));
            }
 
            <b>return</b> <span class="r842 r">stream</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the dynamic property parameters required by the set-content and</span>
        <span class="c">///</span><span class="c"> add-content cmdlets.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r852 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If the path was specified on the command line, this is the path</span>
        <span class="c">///</span><span class="c"> to the item for which to get the dynamic parameters.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> An object that has properties and fields decorated with</span>
        <span class="c">///</span><span class="c"> parsing attributes similar to a cmdlet class.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public object</b> <a id="da6f5b624c238685" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">GetContentWriterDynamicParameters</a>(<b>string</b> <span id="r852 rd" class="r852 r">path</span>)
        {
            <b>return</b> <b>new</b> <a href="#c2491fe7e93bf39e" class="t constructor">FileSystemContentWriterDynamicParameters</a>(<a href="../P/64a92af39f1cd630.html#64a92af39f1cd630" class="k">this</a>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Clears the content of the specified file.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r853 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The path to the file of which to clear the contents.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">System</span>.<span class="i">ArgumentException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">     path is null or empty.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>public void</b> <a id="f76fe1b9dab291c6" href="../R/f76fe1b9dab291c6.html" target="n" data-glyph="72,1" class="i method">ClearContent</a>(<b>string</b> <span id="r853 rd" class="r853 r">path</span>)
        {
            <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r853 r">path</span>))
            {
                <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../utils/MshTraceSource.cs.html#fed5f40dc0075d41" class="i method">NewArgumentException</a>(<b>nameof</b>(<span class="r853 r">path</span>));
            }
 
            <span class="r853 r">path</span> = <a href="#2679b47e3c6ebedc" class="i method">NormalizePath</a>(<span class="r853 r">path</span>);
 
            <b>try</b>
            {
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">UNIX</span>
                <b>bool</b> <span id="r854 rd" class="r854 r">clearStream</span> = <b>false</b>;
                <b>string</b> <span id="r855 rd" class="r855 r">streamName</span> = <b>null</b>;
                <a href="#1175b7b5a5b0a2f5" class="t t">FileSystemClearContentDynamicParameters</a> <span id="r856 rd" class="r856 r">dynamicParameters</span> = <b>null</b>;
                <a href="#a9b3825da1cbf7be" class="t t">FileSystemContentWriterDynamicParameters</a> <span id="r857 rd" class="r857 r">writerDynamicParameters</span> = <b>null</b>;
 
                <span class="c">// We get called during:</span>
                <span class="c">//     - Clear-Content</span>
                <span class="c">//     - Set-Content, in the phase that clears the path first.</span>
                <b>if</b> (<a href="ProviderBase.cs.html#57d60aa2d2bc908d" class="i property">DynamicParameters</a> != <b>null</b>)
                {
                    <span class="r856 r">dynamicParameters</span> = <a href="ProviderBase.cs.html#57d60aa2d2bc908d" class="i property">DynamicParameters</a> <b>as</b> <a href="#1175b7b5a5b0a2f5" class="t t">FileSystemClearContentDynamicParameters</a>;
                    <span class="r857 r">writerDynamicParameters</span> = <a href="ProviderBase.cs.html#57d60aa2d2bc908d" class="i property">DynamicParameters</a> <b>as</b> <a href="#a9b3825da1cbf7be" class="t t">FileSystemContentWriterDynamicParameters</a>;
 
                    <b>if</b> (<span class="r856 r">dynamicParameters</span> != <b>null</b>)
                    {
                        <b>if</b> ((<span class="r856 r">dynamicParameters</span>.<a href="#4294eb06e9b51d21" class="i property">Stream</a> != <b>null</b>) &amp;&amp; (<span class="r856 r">dynamicParameters</span>.<a href="#4294eb06e9b51d21" class="i property">Stream</a>.<span class="i">Length</span> &gt; 0))
                            <span class="r854 r">clearStream</span> = <b>true</b>;
                        <span class="r855 r">streamName</span> = <span class="r856 r">dynamicParameters</span>.<a href="#4294eb06e9b51d21" class="i property">Stream</a>;
                    }
                    <b>else</b> <b>if</b> (<span class="r857 r">writerDynamicParameters</span> != <b>null</b>)
                    {
                        <b>if</b> ((<span class="r857 r">writerDynamicParameters</span>.<a href="#f1c0191eb7e77399" class="i property">Stream</a> != <b>null</b>) &amp;&amp; (<span class="r857 r">writerDynamicParameters</span>.<a href="#f1c0191eb7e77399" class="i property">Stream</a>.<span class="i">Length</span> &gt; 0))
                            <span class="r854 r">clearStream</span> = <b>true</b>;
                        <span class="r855 r">streamName</span> = <span class="r857 r">writerDynamicParameters</span>.<a href="#f1c0191eb7e77399" class="i property">Stream</a>;
                    }
 
                    <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r855 r">streamName</span>))
                    {
                        <span class="c">// See if they&#39;ve used the inline stream syntax. They have more than one colon.</span>
                        <b>int</b> <span id="r858 rd" class="r858 r">firstColon</span> = <span class="r853 r">path</span>.<span class="i">IndexOf</span>(<span class="s">&#39;:&#39;</span>);
                        <b>int</b> <span id="r859 rd" class="r859 r">secondColon</span> = <span class="r853 r">path</span>.<span class="i">IndexOf</span>(<span class="s">&#39;:&#39;</span>, <span class="r858 r">firstColon</span> + 1);
                        <b>if</b> (<span class="r859 r">secondColon</span> &gt; 0)
                        {
                            <span class="r855 r">streamName</span> = <span class="r853 r">path</span>.<span class="i">Substring</span>(<span class="r859 r">secondColon</span> + 1);
                            <span class="r853 r">path</span> = <span class="r853 r">path</span>.<span class="i">Remove</span>(<span class="r859 r">secondColon</span>);
 
                            <span class="r854 r">clearStream</span> = <b>true</b>;
                        }
                    }
                }
 
                <span class="c">// If they&#39;re just working on the DATA stream, don&#39;t use the Alternate Data Stream</span>
                <span class="c">// utils to clear the stream - otherwise, the Win32 API will trash the other streams.</span>
                <b>if</b> (<b>string</b>.<span class="i">Equals</span>(<span class="s">&quot;:$DATA&quot;</span>, <span class="r855 r">streamName</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
                {
                    <span class="r854 r">clearStream</span> = <b>false</b>;
                }
 
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
                <span class="c">// On Windows, determine if our argument is a directory only after we determine if</span>
                <span class="c">// we&#39;re being asked to work with an alternate data stream, because directories can have</span>
                <span class="c">// alternate data streams on them that are not child items. These alternate data streams</span>
                <span class="c">// must be treated as data streams, even if they&#39;re attached to directories. However,</span>
                <span class="c">// if asked to work with a directory without a data stream specified, write a non-terminating</span>
                <span class="c">// error instead of clearing all child items of the directory. (On non-Windows, alternate</span>
                <span class="c">// data streams don&#39;t exist, so in that environment always write the error when addressing</span>
                <span class="c">// a directory.)</span>
                <b>if</b> (<span class="i">Directory</span>.<span class="i">Exists</span>(<span class="r853 r">path</span>)
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">UNIX</span>
                    &amp;&amp; !<span class="r854 r">clearStream</span>
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
                    )
                {
                    <b>string</b> <span id="r860 rd" class="r860 r">errorMsg</span> = <a href="../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">SessionStateStrings</span>.<span class="i">ClearDirectoryContent</span>, <span class="r853 r">path</span>);
                    <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<b>new</b> <span class="i">NotSupportedException</span>(<span class="r860 r">errorMsg</span>), <span class="s">&quot;ClearDirectoryContent&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#b5cba3d51f976bb3" class="i field">InvalidOperation</a>, <span class="r853 r">path</span>));
                    <b>return</b>;
                }
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">UNIX</span>
                <b>if</b> (<span class="r854 r">clearStream</span>)
                {
                    <span class="i">FileStream</span> <span id="r861 rd" class="r861 r">fileStream</span> = <b>null</b>;
 
                    <b>string</b> <span id="r862 rd" class="r862 r">streamAction</span> = <b>string</b>.<span class="i">Format</span>(
                        <span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>,
                        <span class="i">FileSystemProviderStrings</span>.<span class="i">StreamAction</span>,
                        <span class="r855 r">streamName</span>, <span class="r853 r">path</span>);
                    <b>if</b> (<a href="ProviderBase.cs.html#11c40eac9520b247" class="i method">ShouldProcess</a>(<span class="r862 r">streamAction</span>))
                    {
                        <span class="c">// If we&#39;ve been called as part of Clear-Content, validate that the stream exists.</span>
                        <span class="c">// This is because the core API doesn&#39;t support truncate mode.</span>
                        <b>if</b> (<span class="r856 r">dynamicParameters</span> != <b>null</b>)
                        {
                            <span class="r861 r">fileStream</span> = <a href="#28276e8c322107d7" class="t t">AlternateDataStreamUtilities</a>.<span class="i">CreateFileStream</span>(<span class="r853 r">path</span>, <span class="r855 r">streamName</span>, <span class="i">FileMode</span>.<span class="i">Open</span>, <span class="i">FileAccess</span>.<span class="i">Write</span>, <span class="i">FileShare</span>.<span class="i">Write</span>);
                            <span class="r861 r">fileStream</span>.<span class="i">Dispose</span>();
                        }
 
                        <span class="r861 r">fileStream</span> = <a href="#28276e8c322107d7" class="t t">AlternateDataStreamUtilities</a>.<span class="i">CreateFileStream</span>(
                            <span class="r853 r">path</span>, <span class="r855 r">streamName</span>, <span class="i">FileMode</span>.<span class="i">Create</span>, <span class="i">FileAccess</span>.<span class="i">Write</span>, <span class="i">FileShare</span>.<span class="i">Write</span>);
                        <span class="r861 r">fileStream</span>.<span class="i">Dispose</span>();
                    }
                }
                <b>else</b>
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
                {
                    <b>string</b> <span id="r863 rd" class="r863 r">action</span> = <span class="i">FileSystemProviderStrings</span>.<span class="i">ClearContentActionFile</span>;
                    <b>string</b> <span id="r864 rd" class="r864 r">resource</span> = <a href="../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">FileSystemProviderStrings</span>.<span class="i">ClearContentesourceTemplate</span>, <span class="r853 r">path</span>);
 
                    <b>if</b> (!<a href="ProviderBase.cs.html#4cb6a9cf0567d153" class="i method">ShouldProcess</a>(<span class="r864 r">resource</span>, <span class="r863 r">action</span>))
                        <b>return</b>;
 
                    <span class="i">FileStream</span> <span id="r865 rd" class="r865 r">fileStream</span> = <b>new</b> <span class="i">FileStream</span>(<span class="r853 r">path</span>, <span class="i">FileMode</span>.<span class="i">Truncate</span>, <span class="i">FileAccess</span>.<span class="i">Write</span>, <span class="i">FileShare</span>.<span class="i">Write</span>);
                    <span class="r865 r">fileStream</span>.<span class="i">Dispose</span>();
                }
 
                <span class="c">// For filesystem once content is cleared</span>
                <span class="i">WriteItemObject</span>(<b>string</b>.<span class="i">Empty</span>, <span class="r853 r">path</span>, <b>false</b>);
            }
            <b>catch</b> (<span class="i">ArgumentException</span> <span id="r866 rd" class="r866 r">argException</span>)
            {
                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r866 r">argException</span>, <span class="s">&quot;ClearContentArgumentError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#846d2b572f2c4820" class="i field">InvalidArgument</a>, <span class="r853 r">path</span>));
            }
            <b>catch</b> (<span class="i">IOException</span> <span id="r867 rd" class="r867 r">ioException</span>)
            {
                <span class="c">// IOException contains specific message about the error occurred and so no need for errordetails.</span>
                <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r867 r">ioException</span>, <span class="s">&quot;ClearContentIOError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#0c2f4b9c74e5b7c2" class="i field">WriteError</a>, <span class="r853 r">path</span>));
            }
            <b>catch</b> (<span class="i">UnauthorizedAccessException</span> <span id="r868 rd" class="r868 r">accessException</span>)
            {
                <b>if</b> (<a href="ProviderBase.cs.html#e3c4d51f13fbfcaa" class="i property">Force</a>)
                {
                    <span class="c">//// Store the old attributes so that we can recover them</span>
                    <span class="i">FileAttributes</span> <span id="r869 rd" class="r869 r">oldAttributes</span> = <span class="i">File</span>.<span class="i">GetAttributes</span>(<span class="r853 r">path</span>);
 
                    <b>try</b>
                    {
                        <span class="c">// Since a security exception was thrown, try to mask off</span>
                        <span class="c">// the hidden and readonly bits and then retry.</span>
                        <span class="i">File</span>.<span class="i">SetAttributes</span>(<span class="r853 r">path</span>, (<span class="i">File</span>.<span class="i">GetAttributes</span>(<span class="r853 r">path</span>) &amp; ~(<span class="i">FileAttributes</span>.<span class="i">Hidden</span> | <span class="i">FileAttributes</span>.<span class="i">ReadOnly</span>)));
                        <span class="i">FileStream</span> <span id="r870 rd" class="r870 r">fileStream</span> = <b>new</b> <span class="i">FileStream</span>(<span class="r853 r">path</span>, <span class="i">FileMode</span>.<span class="i">Truncate</span>, <span class="i">FileAccess</span>.<span class="i">Write</span>, <span class="i">FileShare</span>.<span class="i">Write</span>);
                        <span class="r870 r">fileStream</span>.<span class="i">Dispose</span>();
 
                        <span class="c">// For filesystem once content is cleared</span>
                        <span class="i">WriteItemObject</span>(<b>string</b>.<span class="i">Empty</span>, <span class="r853 r">path</span>, <b>false</b>);
                    }
                    <b>catch</b> (<span class="i">UnauthorizedAccessException</span> <span id="r871 rd" class="r871 r">failure</span>)
                    {
                        <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r871 r">failure</span>, <span class="s">&quot;RemoveFileSystemItemUnAuthorizedAccess&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#26ba13af79d30a75" class="i field">PermissionDenied</a>, <span class="r853 r">path</span>));
                    }
                    <b>finally</b>
                    {
                        <span class="c">//// Reset the attributes</span>
                        <span class="i">File</span>.<span class="i">SetAttributes</span>(<span class="r853 r">path</span>, <span class="r869 r">oldAttributes</span>);
                    }
                }
                <b>else</b>
                {
                    <a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r868 r">accessException</span>, <span class="s">&quot;ClearContentUnauthorizedAccessError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#26ba13af79d30a75" class="i field">PermissionDenied</a>, <span class="r853 r">path</span>));
                }
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the dynamic property parameters required by the clear-content cmdlet.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r872 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If the path was specified on the command line, this is the path</span>
        <span class="c">///</span><span class="c"> to the item for which to get the dynamic parameters.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> A FileSystemClearContentDynamicParameters that provides access to the -Stream dynamic parameter.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public object</b> <a id="cb76ebf60a6470ac" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">ClearContentDynamicParameters</a>(<b>string</b> <span id="r872 rd" class="r872 r">path</span>)
        {
            <b>return</b> <b>new</b> <span class="t">FileSystemClearContentDynamicParameters</span>();
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> IContentCmdletProvider
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> -raw is not allowed when -first,-last or -wait is specified</span>
        <span class="c">///</span><span class="c"> this call will validate that and throws.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private void</b> <a id="7a1a9c6bbb4c3943" href="../R/7a1a9c6bbb4c3943.html" target="n" data-glyph="76,1" class="i method">ValidateParameters</a>(<b>bool</b> <span id="r873 rd" class="r873 r">isRawSpecified</span>)
        {
            <b>if</b> (<span class="r873 r">isRawSpecified</span>)
            {
                <b>if</b> (<a href="../P/64a92af39f1cd630.html#64a92af39f1cd630" class="k">this</a>.<a href="ProviderBase.cs.html#70e6bb9df8f94746" class="i property">Context</a>.<a href="CoreCommandContext.cs.html#564b4e39ec1a78d8" class="i property">MyInvocation</a>.<a href="../engine/InvocationInfo.cs.html#1927782a0117ff76" class="i property">BoundParameters</a>.<span class="i">ContainsKey</span>(<span class="s">&quot;TotalCount&quot;</span>))
                {
                    <b>string</b> <span id="r874 rd" class="r874 r">message</span> = <a href="../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">FileSystemProviderStrings</span>.<span class="i">NoFirstLastWaitForRaw</span>, <span class="s">&quot;Raw&quot;</span>, <span class="s">&quot;TotalCount&quot;</span>);
                    <b>throw</b> <b>new</b> <a href="../utils/MshInvalidOperationException.cs.html#de5b942a57457045" class="t constructor">PSInvalidOperationException</a>(<span class="r874 r">message</span>);
                }
 
                <b>if</b> (<a href="../P/64a92af39f1cd630.html#64a92af39f1cd630" class="k">this</a>.<a href="ProviderBase.cs.html#70e6bb9df8f94746" class="i property">Context</a>.<a href="CoreCommandContext.cs.html#564b4e39ec1a78d8" class="i property">MyInvocation</a>.<a href="../engine/InvocationInfo.cs.html#1927782a0117ff76" class="i property">BoundParameters</a>.<span class="i">ContainsKey</span>(<span class="s">&quot;Tail&quot;</span>))
                {
                    <b>string</b> <span id="r875 rd" class="r875 r">message</span> = <a href="../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">FileSystemProviderStrings</span>.<span class="i">NoFirstLastWaitForRaw</span>, <span class="s">&quot;Raw&quot;</span>, <span class="s">&quot;Tail&quot;</span>);
                    <b>throw</b> <b>new</b> <a href="../utils/MshInvalidOperationException.cs.html#de5b942a57457045" class="t constructor">PSInvalidOperationException</a>(<span class="r875 r">message</span>);
                }
 
                <b>if</b> (<a href="../P/64a92af39f1cd630.html#64a92af39f1cd630" class="k">this</a>.<a href="ProviderBase.cs.html#70e6bb9df8f94746" class="i property">Context</a>.<a href="CoreCommandContext.cs.html#564b4e39ec1a78d8" class="i property">MyInvocation</a>.<a href="../engine/InvocationInfo.cs.html#1927782a0117ff76" class="i property">BoundParameters</a>.<span class="i">ContainsKey</span>(<span class="s">&quot;Wait&quot;</span>))
                {
                    <b>string</b> <span id="r876 rd" class="r876 r">message</span> = <a href="../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">FileSystemProviderStrings</span>.<span class="i">NoFirstLastWaitForRaw</span>, <span class="s">&quot;Raw&quot;</span>, <span class="s">&quot;Wait&quot;</span>);
                    <b>throw</b> <b>new</b> <a href="../utils/MshInvalidOperationException.cs.html#de5b942a57457045" class="t constructor">PSInvalidOperationException</a>(<span class="r876 r">message</span>);
                }
 
                <b>if</b> (<a href="../P/64a92af39f1cd630.html#64a92af39f1cd630" class="k">this</a>.<a href="ProviderBase.cs.html#70e6bb9df8f94746" class="i property">Context</a>.<a href="CoreCommandContext.cs.html#564b4e39ec1a78d8" class="i property">MyInvocation</a>.<a href="../engine/InvocationInfo.cs.html#1927782a0117ff76" class="i property">BoundParameters</a>.<span class="i">ContainsKey</span>(<span class="s">&quot;Delimiter&quot;</span>))
                {
                    <b>string</b> <span id="r877 rd" class="r877 r">message</span> = <a href="../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">FileSystemProviderStrings</span>.<span class="i">NoFirstLastWaitForRaw</span>, <span class="s">&quot;Raw&quot;</span>, <span class="s">&quot;Delimiter&quot;</span>);
                    <b>throw</b> <b>new</b> <a href="../utils/MshInvalidOperationException.cs.html#de5b942a57457045" class="t constructor">PSInvalidOperationException</a>(<span class="r877 r">message</span>);
                }
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The API &#39;PathIsNetworkPath&#39; is not available in CoreSystem.</span>
        <span class="c">///</span><span class="c"> This implementation is based on the &#39;PathIsNetworkPath&#39; API.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r878 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal static bool</b> <a id="fabdfaa176fe57d0" href="../R/fabdfaa176fe57d0.html" target="n" data-glyph="74,1" class="i method">PathIsNetworkPath</a>(<b>string</b> <span id="r878 rd" class="r878 r">path</span>)
        {
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">UNIX</span>
<span class="e">            return false;
</span><span class="k preprocess">#</span><span class="k preprocess">else</span>
            <b>return</b> <a href="#a39ac78cde829df4" class="i method">WinPathIsNetworkPath</a>(<span class="r878 r">path</span>);
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
        }
 
        <b>internal static bool</b> <a id="a39ac78cde829df4" href="../R/a39ac78cde829df4.html" target="n" data-glyph="74,1" class="i method">WinPathIsNetworkPath</a>(<b>string</b> <span id="r879 rd" class="r879 r">path</span>)
        {
            <b>return</b> <a href="#f0fcb2141ba63e82" class="t t">NativeMethods</a>.<a href="#b003a03823227e92" class="i method">PathIsNetworkPath</a>(<span class="r879 r">path</span>); <span class="c">// call the native method</span>
        }
 
        <b>private static class</b> <a id="f0fcb2141ba63e82" href="../R/f0fcb2141ba63e82.html" target="n" data-glyph="4,1" class="t t">NativeMethods</a>
        {
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> WNetAddConnection2 API makes a connection to a network resource</span>
            <span class="c">///</span><span class="c"> and can redirect a local device to the network resource.</span>
            <span class="c">///</span><span class="c"> This API simulates the &quot;new Use&quot; functionality used to connect to</span>
            <span class="c">///</span><span class="c"> network resource.</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r880 r">netResource</span><span class="c">&quot;</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> The netResource structure contains information</span>
            <span class="c">///</span><span class="c"> about a network resource.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r881 r">password</span><span class="c">&quot;</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> The password used to get connected to network resource.</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r882 r">username</span><span class="c">&quot;</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> The username used to get connected to network resource.</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r883 r">flags</span><span class="c">&quot;</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> The flags parameter is used to indicate if the created network</span>
            <span class="c">///</span><span class="c"> resource has to be persisted or not.</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">If connection is established to the network resource</span>
            <span class="c">///</span><span class="c"> then success is returned or else the error code describing the</span>
            <span class="c">///</span><span class="c"> type of failure that occurred while establishing</span>
            <span class="c">///</span><span class="c"> the connection is returned.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
            [<span class="i">DllImport</span>(<span class="s">&quot;mpr.dll&quot;</span>, <span class="i">CharSet</span> = <span class="i">CharSet</span>.<span class="i">Unicode</span>)]
            <b>internal static extern int</b> <a id="8fc3ce8fb6eb99ce" href="../R/8fc3ce8fb6eb99ce.html" target="n" data-glyph="74,2" class="i method">WNetAddConnection2</a>(<b>ref</b> <a href="#62db5386db62a54d" class="t t">NetResource</a> <span id="r880 rd" class="r880 r">netResource</span>, <b>byte</b>[] <span id="r881 rd" class="r881 r">password</span>, <b>string</b> <span id="r882 rd" class="r882 r">username</span>, <b>int</b> <span id="r883 rd" class="r883 r">flags</span>);
 
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> WNetCancelConnection2 function cancels an existing network connection.</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r884 r">driveName</span><span class="c">&quot;</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> PSDrive Name.</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r885 r">flags</span><span class="c">&quot;</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> Connection Type.</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r886 r">force</span><span class="c">&quot;</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> Specifies whether the disconnection should occur if there are open files or jobs</span>
            <span class="c">///</span><span class="c"> on the connection. If this parameter is FALSE, the function fails</span>
            <span class="c">///</span><span class="c"> if there are open files or jobs.</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">If connection is removed then success is returned or</span>
            <span class="c">///</span><span class="c"> else the error code describing the type of failure that occurred while</span>
            <span class="c">///</span><span class="c"> trying to remove the connection is returned.</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
            [<span class="i">DllImport</span>(<span class="s">&quot;mpr.dll&quot;</span>, <span class="i">CharSet</span> = <span class="i">CharSet</span>.<span class="i">Unicode</span>)]
            <b>internal static extern int</b> <a id="c0450c8f0d10f87e" href="../R/c0450c8f0d10f87e.html" target="n" data-glyph="74,2" class="i method">WNetCancelConnection2</a>(<b>string</b> <span id="r884 rd" class="r884 r">driveName</span>, <b>int</b> <span id="r885 rd" class="r885 r">flags</span>, <b>bool</b> <span id="r886 rd" class="r886 r">force</span>);
 
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> WNetGetConnection function retrieves the name of the network resource associated with a local device.</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r887 r">localName</span><span class="c">&quot;</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> Local name of the PSDrive.</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r888 r">remoteName</span><span class="c">&quot;</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> The remote name to which the PSDrive is getting mapped to.</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r889 r">remoteNameLength</span><span class="c">&quot;</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> length of the remote name of the created PSDrive.</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
            [<span class="i">DllImport</span>(<span class="s">&quot;mpr.dll&quot;</span>, <span class="i">CharSet</span> = <span class="i">CharSet</span>.<span class="i">Unicode</span>)]
            <b>internal static extern int</b> <a id="5615424d0bdd9184" href="../R/5615424d0bdd9184.html" target="n" data-glyph="74,2" class="i method">WNetGetConnection</a>(<b>string</b> <span id="r887 rd" class="r887 r">localName</span>, <span class="i">StringBuilder</span> <span id="r888 rd" class="r888 r">remoteName</span>, <b>ref int</b> <span id="r889 rd" class="r889 r">remoteNameLength</span>);
 
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">CORECLR</span> <span class="c">// TODO:CORECLR Win32 function &#39;PathIsNetworkPath&#39; is in an extension API set which is currently not on CSS.</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> Searches a path for a drive letter within the range of &#39;A&#39; to &#39;Z&#39; and returns the corresponding drive number.</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r890 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> Path of the file being executed</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">Returns 0 through 25 (corresponding to &#39;A&#39; through &#39;Z&#39;) if the path has a drive letter, or -1 otherwise.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
            [<span class="i">DllImport</span>(<span class="s">&quot;api-ms-win-core-shlwapi-legacy-l1-1-0.dll&quot;</span>, <span class="i">CharSet</span> = <span class="i">CharSet</span>.<span class="i">Unicode</span>)]
            <b>internal static extern int</b> <a id="e2393f72c38e1e54" href="../R/e2393f72c38e1e54.html" target="n" data-glyph="74,2" class="i method">PathGetDriveNumber</a>(<b>string</b> <span id="r890 rd" class="r890 r">path</span>);
 
            <b>private static bool</b> <a id="2b8516b9f25a4a01" href="../R/2b8516b9f25a4a01.html" target="n" data-glyph="46,2" class="i field">_WNetApiAvailable</a> = <b>true</b>;
 
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> The API &#39;PathIsNetworkPath&#39; is not available in CoreSystem.</span>
            <span class="c">///</span><span class="c"> This implementation is based on the &#39;PathIsNetworkPath&#39; API.</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r891 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
            <b>internal static bool</b> <a id="b003a03823227e92" href="../R/b003a03823227e92.html" target="n" data-glyph="74,2" class="i method">PathIsNetworkPath</a>(<b>string</b> <span id="r891 rd" class="r891 r">path</span>)
            {
                <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r891 r">path</span>))
                {
                    <b>return</b> <b>false</b>;
                }
 
                <b>if</b> (<a href="../engine/Utils.cs.html#9185d6ecbaebbec0" class="t t">Utils</a>.<a href="../engine/Utils.cs.html#035be1ae91f35c16" class="i method">PathIsUnc</a>(<span class="r891 r">path</span>))
                {
                    <b>return</b> <b>true</b>;
                }
 
                <b>if</b> (!<a href="#2b8516b9f25a4a01" class="i field">_WNetApiAvailable</a>)
                {
                    <b>return</b> <b>false</b>;
                }
 
                <span class="c">// 0 - 25 corresponding to &#39;A&#39; - &#39;Z&#39;</span>
                <b>int</b> <span id="r892 rd" class="r892 r">driveId</span> = <a href="#e2393f72c38e1e54" class="i method">PathGetDriveNumber</a>(<span class="r891 r">path</span>);
                <b>if</b> (<span class="r892 r">driveId</span> &gt;= 0 &amp;&amp; <span class="r892 r">driveId</span> &lt; 26)
                {
                    <b>string</b> <span id="r893 rd" class="r893 r">driveName</span> = (<b>char</b>)(<span class="s">&#39;A&#39;</span> + <span class="r892 r">driveId</span>) + <span class="s">&quot;:&quot;</span>;
 
                    <b>int</b> <span id="r894 rd" class="r894 r">bufferSize</span> = 260; <span class="c">// MAX_PATH from EhStorIoctl.h</span>
                    <span class="i">StringBuilder</span> <span id="r895 rd" class="r895 r">uncBuffer</span> = <b>new</b> <span class="i">StringBuilder</span>(<span class="r894 r">bufferSize</span>);
                    <b>int</b> <span id="r896 rd" class="r896 r">errorCode</span> = -1;
                    <b>try</b>
                    {
                        <span class="r896 r">errorCode</span> = <a href="#5615424d0bdd9184" class="i method">WNetGetConnection</a>(<span class="r893 r">driveName</span>, <span class="r895 r">uncBuffer</span>, <b>ref</b> <span class="r894 r">bufferSize</span>);
                    }
                    <b>catch</b> (<span class="i n">System</span>.<span class="i">DllNotFoundException</span>)
                    {
                        <a href="#2b8516b9f25a4a01" class="i field">_WNetApiAvailable</a> = <b>false</b>;
                        <b>return</b> <b>false</b>;
                    }
 
                    <span class="c">// From the &#39;IsNetDrive&#39; API.</span>
                    <span class="c">// 0: success; 1201: connection closed; 31: device error</span>
                    <b>if</b> (<span class="r896 r">errorCode</span> == 0 || <span class="r896 r">errorCode</span> == 1201 || <span class="r896 r">errorCode</span> == 31)
                    {
                        <b>return</b> <b>true</b>;
                    }
                }
 
                <b>return</b> <b>false</b>;
            }
<span class="k preprocess">#</span><span class="k preprocess">else</span>
<span class="e">            /// &lt;summary&gt;
            /// Facilitates to validate if the supplied path exists locally or on the network share.
            /// &lt;/summary&gt;
            /// &lt;param name=&quot;path&quot;&gt;
            /// Path of the file being executed.
            /// &lt;/param&gt;
            /// &lt;returns&gt;True if the path is a network path or else returns false.&lt;/returns&gt;
            [DllImport(&quot;shlwapi.dll&quot;, CharSet = CharSet.Unicode)]
            [return: MarshalAs(UnmanagedType.Bool)]
            internal static extern bool PathIsNetworkPath(string path);
</span><span class="k preprocess">#</span><span class="k preprocess">endif</span>
 
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> The function can obtain the current mapping for a particular MS-DOS device name.</span>
            <span class="c">///</span>
            <span class="c">///</span><span class="c"> If lpDeviceName is non-NULL, the function retrieves information about the particular MS-DOS device specified by lpDeviceName.</span>
            <span class="c">///</span><span class="c"> The first null-terminated string stored into the buffer is the current mapping for the device.</span>
            <span class="c">///</span><span class="c"> The other null-terminated strings represent undeleted prior mappings for the device.</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r897 r">lpDeviceName</span><span class="c">&quot;</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> The particular MS-DOS device name.</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r898 r">lpTargetPath</span><span class="c">&quot;</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> The buffer to receive the result of the query.</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r899 r">ucchMax</span><span class="c">&quot;</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> The maximum number of characters that can be stored into the buffer</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
            [<span class="i">DllImport</span>(<a href="../utils/PInvokeDllNames.cs.html#6c73838805dd2f2a" class="t t">PinvokeDllNames</a>.<a href="../utils/PInvokeDllNames.cs.html#5f5dbab83be9c9ef" class="i field">QueryDosDeviceDllName</a>, <span class="i">CharSet</span> = <span class="i">CharSet</span>.<span class="i">Unicode</span>, <span class="i">SetLastError</span> = <b>true</b>)]
            <b>internal static extern int</b> <a id="83e0d4edeb60f583" href="../R/83e0d4edeb60f583.html" target="n" data-glyph="74,2" class="i method">QueryDosDevice</a>(<b>string</b> <span id="r897 rd" class="r897 r">lpDeviceName</span>, <span class="i">StringBuilder</span> <span id="r898 rd" class="r898 r">lpTargetPath</span>, <b>int</b> <span id="r899 rd" class="r899 r">ucchMax</span>);
 
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> Creates a symbolic link using the native API.</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r900 r">name</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Path of the symbolic link.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r901 r">destination</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Path of the target of the symbolic link.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r902 r">symbolicLinkFlags</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Flag values from SymbolicLinkFlags enum.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">1 on successful creation.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
            [<span class="i">DllImport</span>(<a href="../utils/PInvokeDllNames.cs.html#6c73838805dd2f2a" class="t t">PinvokeDllNames</a>.<a href="../utils/PInvokeDllNames.cs.html#6e34cb1c53cbf3b0" class="i field">CreateSymbolicLinkDllName</a>, <span class="i">CharSet</span> = <span class="i">CharSet</span>.<span class="i">Unicode</span>, <span class="i">SetLastError</span> = <b>true</b>)]
            [<b>return</b>: <span class="i">MarshalAs</span>(<span class="i">UnmanagedType</span>.<span class="i">I1</span>)]
            <b>internal static extern bool</b> <a id="d7108f3789c23913" href="../R/d7108f3789c23913.html" target="n" data-glyph="74,2" class="i method">CreateSymbolicLink</a>(<b>string</b> <span id="r900 rd" class="r900 r">name</span>, <b>string</b> <span id="r901 rd" class="r901 r">destination</span>, <a href="#3bf6d62476ea2c93" class="t t">SymbolicLinkFlags</a> <span id="r902 rd" class="r902 r">symbolicLinkFlags</span>);
 
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> Flags used when creating a symbolic link.</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
            [<span class="i">Flags</span>]
            <b>internal enum</b> <a id="3bf6d62476ea2c93" href="../R/3bf6d62476ea2c93.html" target="n" data-glyph="20,2" class="t t"><span id="3fd92e72600d2722">SymbolicLinkFlags</span></a>
            {
                <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
                <span class="c">///</span><span class="c"> Symbolic link is a file.</span>
                <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
                <a id="580d7f222c06cf10" href="../R/580d7f222c06cf10.html" target="n" data-glyph="24,3" class="i field">File</a> = 0,
 
                <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
                <span class="c">///</span><span class="c"> Symbolic link is a directory.</span>
                <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
                <a id="3173d409ba2b9d00" href="../R/3173d409ba2b9d00.html" target="n" data-glyph="24,3" class="i field">Directory</a> = 1,
 
                <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
                <span class="c">///</span><span class="c"> Allow creation of symbolic link without elevation.  Requires Developer mode.</span>
                <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
                <a id="5675dec56b7daae7" href="../R/5675dec56b7daae7.html" target="n" data-glyph="24,3" class="i field">AllowUnprivilegedCreate</a> = 2,
            }
 
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> Creates a hard link using the native API.</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r903 r">name</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Name of the hard link.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r904 r">existingFileName</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Path to the target of the hard link.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r905 r">SecurityAttributes</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
            [<span class="i">DllImport</span>(<a href="../utils/PInvokeDllNames.cs.html#6c73838805dd2f2a" class="t t">PinvokeDllNames</a>.<a href="../utils/PInvokeDllNames.cs.html#7346399096c3e857" class="i field">CreateHardLinkDllName</a>, <span class="i">CharSet</span> = <span class="i">CharSet</span>.<span class="i">Unicode</span>, <span class="i">SetLastError</span> = <b>true</b>)]
            [<b>return</b>: <span class="i">MarshalAs</span>(<span class="i">UnmanagedType</span>.<span class="i">Bool</span>)]
            <b>internal static extern bool</b> <a id="c7184567af443031" href="../R/../../0000000000.html" target="n" data-glyph="74,2" class="i method">CreateHardLink</a>(<b>string</b> <span id="r903 rd" class="r903 r">name</span>, <b>string</b> <span id="r904 rd" class="r904 r">existingFileName</span>, <span class="i">IntPtr</span> <span id="r905 rd" class="r905 r">SecurityAttributes</span>);
 
            <span class="c">// OneDrive placeholder support</span>
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">UNIX</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> Returns the placeholder compatibility mode for the current process.</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">The process&#39;s placeholder compatibily mode (PHCM_xxx), or a negative value on error (PCHM_ERROR_xxx).</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
            [<span class="i">DllImport</span>(<span class="s">&quot;ntdll.dll&quot;</span>)]
            <b>internal static extern sbyte</b> <a id="e16ba683bb0b7670" href="../R/e16ba683bb0b7670.html" target="n" data-glyph="74,2" class="i method">RtlQueryProcessPlaceholderCompatibilityMode</a>();
 
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> Sets the placeholder compatibility mode for the current process.</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r906 r">pcm</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The placeholder compatibility mode to set.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">The process&#39;s previous placeholder compatibily mode (PHCM_xxx), or a negative value on error (PCHM_ERROR_xxx).</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
            [<span class="i">DllImport</span>(<span class="s">&quot;ntdll.dll&quot;</span>)]
            <b>internal static extern sbyte</b> <a id="ffa63bc15ea68838" href="../R/ffa63bc15ea68838.html" target="n" data-glyph="74,2" class="i method">RtlSetProcessPlaceholderCompatibilityMode</a>(<b>sbyte</b> <span id="r906 rd" class="r906 r">pcm</span>);
 
            <b>internal const sbyte</b> <a id="281bfe11dd6b9374" href="../R/../../0000000000.html" target="n" data-glyph="8,2" class="i field">PHCM_APPLICATION_DEFAULT</a> = 0;
            <b>internal const sbyte</b> <a id="1b92af2559c918a6" href="../R/1b92af2559c918a6.html" target="n" data-glyph="8,2" class="i field">PHCM_DISGUISE_PLACEHOLDER</a> = 1;
            <b>internal const sbyte</b> <a id="09adb9e8d12f3700" href="../R/09adb9e8d12f3700.html" target="n" data-glyph="8,2" class="i field">PHCM_EXPOSE_PLACEHOLDERS</a> = 2;
            <b>internal const sbyte</b> <a id="6912349bdcadb2bf" href="../R/../../0000000000.html" target="n" data-glyph="8,2" class="i field">PHCM_MAX</a> = 2;
            <b>internal const sbyte</b> <a id="0b3c2f935dc804e7" href="../R/../../0000000000.html" target="n" data-glyph="8,2" class="i field">PHCM_ERROR_INVALID_PARAMETER</a> = -1;
            <b>internal const sbyte</b> <a id="94bc4ddb2351a2f0" href="../R/../../0000000000.html" target="n" data-glyph="8,2" class="i field">PHCM_ERROR_NO_TEB</a> = -2;
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Managed equivalent of NETRESOURCE structure of WNet API.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">StructLayout</span>(<span class="i">LayoutKind</span>.<span class="i">Sequential</span>)]
        <b>private struct</b> <a id="62db5386db62a54d" href="../R/62db5386db62a54d.html" target="n" data-glyph="112,1" class="t t"><span id="7761a9db95598b12">NetResource</span></a>
        {
            <b>public int</b> <a id="89dcbed515b54429" href="../R/89dcbed515b54429.html" target="n" data-glyph="42,2" class="i field">Scope</a>;
            <b>public int</b> <a id="5ed2ae11151a493e" href="../R/5ed2ae11151a493e.html" target="n" data-glyph="42,2" class="i field">Type</a>;
            <b>public int</b> <a id="a49581a14cbc6e28" href="../R/a49581a14cbc6e28.html" target="n" data-glyph="42,2" class="i field">DisplayType</a>;
            <b>public int</b> <a id="f7793deae66f702c" href="../R/f7793deae66f702c.html" target="n" data-glyph="42,2" class="i field">Usage</a>;
 
            [<span class="i">MarshalAs</span>(<span class="i">UnmanagedType</span>.<span class="i">LPWStr</span>)]
            <b>public string</b> <a id="b883cb13898c562f" href="../R/b883cb13898c562f.html" target="n" data-glyph="42,2" class="i field">LocalName</a>;
 
            [<span class="i">MarshalAs</span>(<span class="i">UnmanagedType</span>.<span class="i">LPWStr</span>)]
            <b>public string</b> <a id="8a812494402cf999" href="../R/8a812494402cf999.html" target="n" data-glyph="42,2" class="i field">RemoteName</a>;
 
            [<span class="i">MarshalAs</span>(<span class="i">UnmanagedType</span>.<span class="i">LPWStr</span>)]
            <b>public string</b> <a id="8fd485e3a5a59659" href="../R/8fd485e3a5a59659.html" target="n" data-glyph="42,2" class="i field">Comment</a>;
 
            [<span class="i">MarshalAs</span>(<span class="i">UnmanagedType</span>.<span class="i">LPWStr</span>)]
            <b>public string</b> <a id="c6dcab103b697cc6" href="../R/c6dcab103b697cc6.html" target="n" data-glyph="42,2" class="i field">Provider</a>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> InodeTracker
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Tracks visited files/directories by caching their device IDs and inodes.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private sealed class</b> <a id="cee9878fea124fe4" href="../R/cee9878fea124fe4.html" target="n" data-glyph="4,1" class="t t">InodeTracker</a>
        {
            <b>private readonly</b> <span class="i">HashSet</span>&lt;(<span class="i">UInt64</span>, <span class="i">UInt64</span>)&gt; <a id="fc12c6d0391da9ad" href="../R/fc12c6d0391da9ad.html" target="n" data-glyph="46,2" class="i field">_visitations</a>;
 
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> Construct a new InodeTracker with an initial path.</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
            <b>internal</b> <a id="5338dd92a56f6b72" href="../R/../../0000000000.html" target="n" data-glyph="74,2" class="t constructor">InodeTracker</a>(<b>string</b> <span id="r907 rd" class="r907 r">path</span>)
            {
                <a href="#fc12c6d0391da9ad" class="i field">_visitations</a> = <b>new</b> <span class="i">HashSet</span>&lt;(<span class="i">UInt64</span>, <span class="i">UInt64</span>)&gt;();
 
                <b>if</b> (<a href="#916c1750999d4e10" class="t t">InternalSymbolicLinkLinkCodeMethods</a>.<span class="i">GetInodeData</span>(<span class="r907 r">path</span>, <b>out</b> (<span class="i">UInt64</span>, <span class="i">UInt64</span>) <span id="r908 rd" class="r908 r">inodeData</span>))
                {
                    <a href="#fc12c6d0391da9ad" class="i field">_visitations</a>.<span class="i">Add</span>(<span class="r908 r">inodeData</span>);
                }
            }
 
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> Attempt to mark a path as having been visited.</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r909 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> Path to the file system item to be visited.</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> True if the path had not been previously visited and was</span>
            <span class="c">///</span><span class="c"> successfully marked as visited, false otherwise.</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
            <b>internal bool</b> <a id="31d4fd4b4fa4a4df" href="../R/../../0000000000.html" target="n" data-glyph="74,2" class="i method">TryVisitPath</a>(<b>string</b> <span id="r909 rd" class="r909 r">path</span>)
            {
                <b>bool</b> <span id="r910 rd" class="r910 r">returnValue</span> = <b>false</b>;
 
                <b>if</b> (<a href="#916c1750999d4e10" class="t t">InternalSymbolicLinkLinkCodeMethods</a>.<span class="i">GetInodeData</span>(<span class="r909 r">path</span>, <b>out</b> (<span class="i">UInt64</span>, <span class="i">UInt64</span>) <span id="r911 rd" class="r911 r">inodeData</span>))
                {
                    <span class="r910 r">returnValue</span> = <a href="#fc12c6d0391da9ad" class="i field">_visitations</a>.<span class="i">Add</span>(<span class="r911 r">inodeData</span>);
                }
 
                <b>return</b> <span class="r910 r">returnValue</span>;
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
    }
 
    <b>internal static class</b> <a id="0021e65731f91d4b" href="../R/0021e65731f91d4b.html" target="n" data-glyph="2,0" class="t t">SafeInvokeCommand</a>
    {
        <b>public static</b> <span class="i">Hashtable</span> <a id="52932871655c3ffb" href="../R/52932871655c3ffb.html" target="n" data-glyph="72,1" class="i method">Invoke</a>(<span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="../engine/hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShell</a> <span id="r912 rd" class="r912 r">ps</span>, <a href="../P/64a92af39f1cd630.html#64a92af39f1cd630" class="t t">FileSystemProvider</a> <span id="r913 rd" class="r913 r">fileSystemContext</span>, <a href="CoreCommandContext.cs.html#1e83d35d5286e174" class="t t">CmdletProviderContext</a> <span id="r914 rd" class="r914 r">cmdletContext</span>)
        {
            <b>return</b> <a href="#33792f673831f08f" class="i method">Invoke</a>(<span class="r912 r">ps</span>, <span class="r913 r">fileSystemContext</span>, <span class="r914 r">cmdletContext</span>, <b>true</b>);
        }
 
        <b>public static</b> <span class="i">Hashtable</span> <a id="33792f673831f08f" href="../R/33792f673831f08f.html" target="n" data-glyph="72,1" class="i method">Invoke</a>(<span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="../engine/hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShell</a> <span id="r915 rd" class="r915 r">ps</span>, <a href="../P/64a92af39f1cd630.html#64a92af39f1cd630" class="t t">FileSystemProvider</a> <span id="r916 rd" class="r916 r">fileSystemContext</span>, <a href="CoreCommandContext.cs.html#1e83d35d5286e174" class="t t">CmdletProviderContext</a> <span id="r917 rd" class="r917 r">cmdletContext</span>, <b>bool</b> <span id="r918 rd" class="r918 r">shouldHaveOutput</span>)
        {
            <b>bool</b> <span id="r919 rd" class="r919 r">useFileSystemProviderContext</span> = (<span class="r917 r">cmdletContext</span> == <b>null</b>);
 
            <b>if</b> (<span class="r919 r">useFileSystemProviderContext</span>)
            {
                <span class="i n">Dbg</span>.<a href="../utils/assert.cs.html#c04955255430d32f" class="t t">Diagnostics</a>.<a href="../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r916 r">fileSystemContext</span> != <b>null</b>, <span class="s">&quot;The caller should verify FileSystemProvider context.&quot;</span>);
            }
 
            <span class="i">Collection</span>&lt;<span class="i">Hashtable</span>&gt; <span id="r920 rd" class="r920 r">output</span>;
            <b>try</b>
            {
                <span class="r920 r">output</span> = <span class="r915 r">ps</span>.<a href="../engine/hostifaces/PowerShell.cs.html#11053e110c66cae7" class="i method">Invoke</a>&lt;<span class="i">Hashtable</span>&gt;();
            }
            <b>catch</b> (<span class="i">Exception</span> <span id="r921 rd" class="r921 r">e</span>)
            {
                <b>if</b> (<span class="r919 r">useFileSystemProviderContext</span>)
                {
                    <span class="r916 r">fileSystemContext</span>.<a href="ProviderBase.cs.html#83bb4484e6f0cc5d" class="i method">WriteError</a>(<b>new</b> <a href="../engine/ErrorPackage.cs.html#e9334565e5136f43" class="t constructor">ErrorRecord</a>(<span class="r921 r">e</span>, <span class="s">&quot;CopyFileRemoteExecutionError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#b5cba3d51f976bb3" class="i field">InvalidOperation</a>, <span class="r915 r">ps</span>));
                    <span class="r915 r">ps</span>.<a href="../engine/hostifaces/PowerShell.cs.html#7bde27452e045465" class="i property">Commands</a>.<a href="../engine/hostifaces/PSCommand.cs.html#15970659c9fe6157" class="i method">Clear</a>();
                }
                <b>else</b>
                {
                    <span class="r917 r">cmdletContext</span>.<a href="CoreCommandContext.cs.html#97661a296df11e6d" class="i method">WriteError</a>(<b>new</b> <a href="../engine/ErrorPackage.cs.html#e9334565e5136f43" class="t constructor">ErrorRecord</a>(<span class="r921 r">e</span>, <span class="s">&quot;CopyFileRemoteExecutionError&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#b5cba3d51f976bb3" class="i field">InvalidOperation</a>, <span class="r915 r">ps</span>));
                    <span class="r915 r">ps</span>.<a href="../engine/hostifaces/PowerShell.cs.html#7bde27452e045465" class="i property">Commands</a>.<a href="../engine/hostifaces/PSCommand.cs.html#15970659c9fe6157" class="i method">Clear</a>();
                }
 
                <b>return</b> <b>null</b>;
            }
 
            <b>if</b> (<span class="r915 r">ps</span>.<a href="../engine/hostifaces/PowerShell.cs.html#55e1a13ecd52fcd0" class="i property">HadErrors</a>)
            {
                <b>foreach</b> (<b>var</b> <span id="r922 rd" class="r922 r">error</span> <b>in</b> <span class="r915 r">ps</span>.<a href="../engine/hostifaces/PowerShell.cs.html#622ebeade9b6ada7" class="i property">Streams</a>.<a href="../engine/hostifaces/PowerShell.cs.html#ae04a604c26c6f7d" class="i property">Error</a>)
                {
                    <b>if</b> (<span class="r919 r">useFileSystemProviderContext</span>)
                    {
                        <span class="r916 r">fileSystemContext</span>.<span class="i">WriteError</span>(<span class="r922 r">error</span>);
                    }
                    <b>else</b>
                    {
                        <span class="r917 r">cmdletContext</span>.<span class="i">WriteError</span>(<span class="r922 r">error</span>);
                    }
                }
            }
 
            <span class="r915 r">ps</span>.<a href="../engine/hostifaces/PowerShell.cs.html#7bde27452e045465" class="i property">Commands</a>.<a href="../engine/hostifaces/PSCommand.cs.html#15970659c9fe6157" class="i method">Clear</a>();
 
            <b>if</b> (<span class="r918 r">shouldHaveOutput</span>)
            {
                <b>if</b> (<span class="r920 r">output</span>.<span class="i">Count</span> != 1 || <span class="r920 r">output</span>[0].<span class="i">GetType</span>() != <b>typeof</b>(<span class="i">Hashtable</span>))
                {
                    <span class="c">// unexpected output</span>
                    <span class="i n">Dbg</span>.<a href="../utils/assert.cs.html#c04955255430d32f" class="t t">Diagnostics</a>.<a href="../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r920 r">output</span>[0] != <b>null</b>, <span class="s">&quot;Expected an output from the remote call.&quot;</span>);
                    <b>return</b> <b>null</b>;
                }
 
                <b>return</b> (<span class="i">Hashtable</span>)<span class="r920 r">output</span>[0];
            }
 
            <b>return</b> <b>null</b>;
        }
    }
 
    <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
    <span class="k preprocess">#</span><span class="k preprocess">region</span> Dynamic Parameters
 
    <b>internal sealed class</b> <a id="9b19cb6efee111b1" href="../R/9b19cb6efee111b1.html" target="n" data-glyph="2,0" class="t t"><span id="e82a4247371fc21f">CopyItemDynamicParameters</span></a>
    {
        [<span class="i">Parameter</span>]
        [<span class="i">ValidateNotNullOrEmpty</span>]
        <b>public</b> <a href="../engine/remoting/client/remoterunspaceinfo.cs.html#84e3d9c13d0f2efc" class="t t">PSSession</a> <a id="90aa7c4771007659" href="../R/90aa7c4771007659.html" target="n" data-glyph="102,1" class="i property">FromSession</a> { <b>get</b>; <b>set</b>; }
 
        [<span class="i">Parameter</span>]
        [<span class="i">ValidateNotNullOrEmpty</span>]
        <b>public</b> <a href="../engine/remoting/client/remoterunspaceinfo.cs.html#84e3d9c13d0f2efc" class="t t">PSSession</a> <a id="748b24596344cba4" href="../R/748b24596344cba4.html" target="n" data-glyph="102,1" class="i property">ToSession</a> { <b>get</b>; <b>set</b>; }
    }
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Defines the container cmdlet dynamic providers.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>internal sealed class</b> <a id="5d2564feefe2a3d0" href="../R/5d2564feefe2a3d0.html" target="n" data-glyph="2,0" class="t t"><span id="f8848869efcaba5b">GetChildDynamicParameters</span></a>
    {
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets or sets the attribute filtering enum evaluator.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>]
        <b>public</b> <a href="../engine/EnumExpressionEvaluator.cs.html#596ee50bb25acc45" class="t t">FlagsExpression</a>&lt;<span class="i">FileAttributes</span>&gt; <a id="9b94c5e245d1e7bf" href="../R/9b94c5e245d1e7bf.html" target="n" data-glyph="102,1" class="i property">Attributes</a> { <b>get</b>; <b>set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets or sets the flag to follow symbolic links when recursing.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>]
        <b>public</b> <a href="../engine/MshCmdlet.cs.html#8260026027378f6c" class="t t">SwitchParameter</a> <a id="589bd8d055ba636d" href="../R/589bd8d055ba636d.html" target="n" data-glyph="102,1" class="i property">FollowSymlink</a> { <b>get</b>; <b>set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets or sets the filter directory flag.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>]
        [<span class="i">Alias</span>(<span class="s">&quot;ad&quot;</span>)]
        <b>public</b> <a href="../engine/MshCmdlet.cs.html#8260026027378f6c" class="t t">SwitchParameter</a> <a id="2ca1b1c968849c67" href="../R/2ca1b1c968849c67.html" target="n" data-glyph="102,1" class="i property">Directory</a>
        {
            <b>get</b> { <b>return</b> <a href="#2c2a3f3132aaf1d3" class="i field">_attributeDirectory</a>; }
 
            <b>set</b> { <a href="#2c2a3f3132aaf1d3" class="i field">_attributeDirectory</a> = <b>value</b>; }
        }
 
        <b>private bool</b> <a id="2c2a3f3132aaf1d3" href="../R/2c2a3f3132aaf1d3.html" target="n" data-glyph="46,1" class="i field">_attributeDirectory</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets or sets the filter file flag.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>]
        [<span class="i">Alias</span>(<span class="s">&quot;af&quot;</span>)]
        <b>public</b> <a href="../engine/MshCmdlet.cs.html#8260026027378f6c" class="t t">SwitchParameter</a> <a id="0e064e4e6a94c210" href="../R/0e064e4e6a94c210.html" target="n" data-glyph="102,1" class="i property">File</a>
        {
            <b>get</b> { <b>return</b> <a href="#adf47fb698ce026f" class="i field">_attributeFile</a>; }
 
            <b>set</b> { <a href="#adf47fb698ce026f" class="i field">_attributeFile</a> = <b>value</b>; }
        }
 
        <b>private bool</b> <a id="adf47fb698ce026f" href="../R/adf47fb698ce026f.html" target="n" data-glyph="46,1" class="i field">_attributeFile</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets or sets the filter hidden flag.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>]
        [<span class="i">Alias</span>(<span class="s">&quot;ah&quot;</span>, <span class="s">&quot;h&quot;</span>)]
        <b>public</b> <a href="../engine/MshCmdlet.cs.html#8260026027378f6c" class="t t">SwitchParameter</a> <a id="e392319a284f39a1" href="../R/e392319a284f39a1.html" target="n" data-glyph="102,1" class="i property">Hidden</a>
        {
            <b>get</b> { <b>return</b> <a href="#221f30a81fed9dfb" class="i field">_attributeHidden</a>; }
 
            <b>set</b> { <a href="#221f30a81fed9dfb" class="i field">_attributeHidden</a> = <b>value</b>; }
        }
 
        <b>private bool</b> <a id="221f30a81fed9dfb" href="../R/221f30a81fed9dfb.html" target="n" data-glyph="46,1" class="i field">_attributeHidden</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets or sets the filter readonly flag.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>]
        [<span class="i">Alias</span>(<span class="s">&quot;ar&quot;</span>)]
        <b>public</b> <a href="../engine/MshCmdlet.cs.html#8260026027378f6c" class="t t">SwitchParameter</a> <a id="1fe8b85002b76adf" href="../R/1fe8b85002b76adf.html" target="n" data-glyph="102,1" class="i property">ReadOnly</a>
        {
            <b>get</b> { <b>return</b> <a href="#f784e1742e496c7e" class="i field">_attributeReadOnly</a>; }
 
            <b>set</b> { <a href="#f784e1742e496c7e" class="i field">_attributeReadOnly</a> = <b>value</b>; }
        }
 
        <b>private bool</b> <a id="f784e1742e496c7e" href="../R/f784e1742e496c7e.html" target="n" data-glyph="46,1" class="i field">_attributeReadOnly</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets or sets the filter system flag.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>]
        [<span class="i">Alias</span>(<span class="s">&quot;as&quot;</span>)]
        <b>public</b> <a href="../engine/MshCmdlet.cs.html#8260026027378f6c" class="t t">SwitchParameter</a> <a id="eb2215f497d83bec" href="../R/eb2215f497d83bec.html" target="n" data-glyph="102,1" class="i property">System</a>
        {
            <b>get</b> { <b>return</b> <a href="#f0baa8d0f4ed7ee9" class="i field">_attributeSystem</a>; }
 
            <b>set</b> { <a href="#f0baa8d0f4ed7ee9" class="i field">_attributeSystem</a> = <b>value</b>; }
        }
 
        <b>private bool</b> <a id="f0baa8d0f4ed7ee9" href="../R/f0baa8d0f4ed7ee9.html" target="n" data-glyph="46,1" class="i field">_attributeSystem</a>;
    }
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Defines the dynamic parameters used by both the content reader and writer.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>public class</b> <a id="4eda9c7f960399e0" href="../R/4eda9c7f960399e0.html" target="n" data-glyph="0,0" class="t t">FileSystemContentDynamicParametersBase</a>
    {
        <b>internal</b> <a id="94faa29c2c35f03a" href="../R/94faa29c2c35f03a.html" target="n" data-glyph="74,1" class="t constructor">FileSystemContentDynamicParametersBase</a>(<a href="../P/64a92af39f1cd630.html#64a92af39f1cd630" class="t t">FileSystemProvider</a> <span id="r923 rd" class="r923 r">provider</span>)
        {
            <a href="#f0d0fbdabe19464b" class="i field">_provider</a> = <span class="r923 r">provider</span>;
        }
 
        <b>private readonly</b> <a href="../P/64a92af39f1cd630.html#64a92af39f1cd630" class="t t">FileSystemProvider</a> <a id="f0d0fbdabe19464b" href="../R/f0d0fbdabe19464b.html" target="n" data-glyph="46,1" class="i field">_provider</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets or sets the encoding method used when</span>
        <span class="c">///</span><span class="c"> reading data from the file.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>]
        [<span class="i">ArgumentToEncodingTransformationAttribute</span>()]
        [<span class="i">ArgumentEncodingCompletionsAttribute</span>]
        [<span class="i">ValidateNotNullOrEmpty</span>]
        <b>public</b> <span class="i">Encoding</span> <a id="436b3401e978d4f2" href="../R/436b3401e978d4f2.html" target="n" data-glyph="102,1" class="i property">Encoding</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#22b185bed1158932" class="i field">_encoding</a>;
            }
 
            <b>set</b>
            {
                <span class="c">// Check for UTF-7 by checking for code page 65000</span>
                <span class="c">// See: https://docs.microsoft.com/en-us/dotnet/core/compatibility/corefx#utf-7-code-paths-are-obsolete</span>
                <b>if</b> (<b>value</b> != <b>null</b> &amp;&amp; <b>value</b>.<span class="i">CodePage</span> == 65000)
                {
                    <a href="#f0d0fbdabe19464b" class="i field">_provider</a>.<span class="i">WriteWarning</span>(<span class="i">PathUtilsStrings</span>.<span class="i">Utf7EncodingObsolete</span>);
                }
                <a href="#22b185bed1158932" class="i field">_encoding</a> = <b>value</b>;
                <span class="c">// If an encoding was explicitly set, be sure to capture that.</span>
                <a href="#535b30ec05070165" class="i property">WasStreamTypeSpecified</a> = <b>true</b>;
            }
        }
 
        <b>private</b> <span class="i">Encoding</span> <a id="22b185bed1158932" href="../R/22b185bed1158932.html" target="n" data-glyph="46,1" class="i field">_encoding</a> = <a href="../utils/ClrFacade.cs.html#a9a016478ec73a42" class="t t">ClrFacade</a>.<a href="../utils/ClrFacade.cs.html#0c8a7fc2b80117dd" class="i method">GetDefaultEncoding</a>();
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Return file contents as a byte stream or create file from a series of bytes.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>]
        <b>public</b> <a href="../engine/MshCmdlet.cs.html#8260026027378f6c" class="t t">SwitchParameter</a> <a id="703200654acef170" href="../R/703200654acef170.html" target="n" data-glyph="102,1" class="i property">AsByteStream</a> { <b>get</b>; <b>set</b>; }
 
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">UNIX</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> A parameter to return a stream of an item.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>]
        <b>public string</b> <a id="f1c0191eb7e77399" href="../R/f1c0191eb7e77399.html" target="n" data-glyph="102,1" class="i property">Stream</a> { <b>get</b>; <b>set</b>; }
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the status of the StreamType parameter.  Returns true</span>
        <span class="c">///</span><span class="c"> if the stream was opened with a user-specified encoding, false otherwise.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public bool</b> <a id="535b30ec05070165" href="../R/535b30ec05070165.html" target="n" data-glyph="102,1" class="i property">WasStreamTypeSpecified</a> { <b>get</b>; <b>private set</b>; }
    }
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Defines the dynamic parameters used by the Clear-Content cmdlet.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>public class</b> <a id="1175b7b5a5b0a2f5" href="../R/1175b7b5a5b0a2f5.html" target="n" data-glyph="0,0" class="t t"><span id="4fdef0631bacb00a">FileSystemClearContentDynamicParameters</span></a>
    {
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">UNIX</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> A parameter to return a stream of an item.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>]
        <b>public string</b> <a id="4294eb06e9b51d21" href="../R/4294eb06e9b51d21.html" target="n" data-glyph="102,1" class="i property">Stream</a> { <b>get</b>; <b>set</b>; }
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
    }
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Defines the dynamic parameters used by the set-content and</span>
    <span class="c">///</span><span class="c"> add-content cmdlets.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>public class</b> <a id="a9b3825da1cbf7be" href="../R/a9b3825da1cbf7be.html" target="n" data-glyph="0,0" class="t t">FileSystemContentWriterDynamicParameters</a> : <a href="#4eda9c7f960399e0" class="t t">FileSystemContentDynamicParametersBase</a>
    {
        <b>internal</b> <a id="c2491fe7e93bf39e" href="../R/c2491fe7e93bf39e.html" target="n" data-glyph="74,1" class="t constructor">FileSystemContentWriterDynamicParameters</a>(<a href="../P/64a92af39f1cd630.html#64a92af39f1cd630" class="t t">FileSystemProvider</a> <span id="r924 rd" class="r924 r">provider</span>) : <a href="#94faa29c2c35f03a" class="k">base</a>(<span class="r924 r">provider</span>) { }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> False to add a newline to the end of the output string, true if not.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>]
        <b>public</b> <a href="../engine/MshCmdlet.cs.html#8260026027378f6c" class="t t">SwitchParameter</a> <a id="95c68977c1cbc95b" href="../R/95c68977c1cbc95b.html" target="n" data-glyph="102,1" class="i property">NoNewline</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#90817d14e8b66b83" class="i field">_suppressNewline</a>;
            }
 
            <b>set</b>
            {
                <a href="#90817d14e8b66b83" class="i field">_suppressNewline</a> = <b>value</b>;
            }
        }
 
        <b>private bool</b> <a id="90817d14e8b66b83" href="../R/90817d14e8b66b83.html" target="n" data-glyph="46,1" class="i field">_suppressNewline</a> = <b>false</b>;
    }
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Defines the dynamic parameters used by the get-content cmdlet.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>public class</b> <a id="3ea3397c69a1676c" href="../R/3ea3397c69a1676c.html" target="n" data-glyph="0,0" class="t t">FileSystemContentReaderDynamicParameters</a> : <a href="#4eda9c7f960399e0" class="t t">FileSystemContentDynamicParametersBase</a>
    {
        <b>internal</b> <a id="32d3814fc3c952c5" href="../R/32d3814fc3c952c5.html" target="n" data-glyph="74,1" class="t constructor">FileSystemContentReaderDynamicParameters</a>(<a href="../P/64a92af39f1cd630.html#64a92af39f1cd630" class="t t">FileSystemProvider</a> <span id="r925 rd" class="r925 r">provider</span>) : <a href="#94faa29c2c35f03a" class="k">base</a>(<span class="r925 r">provider</span>) { }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets or sets the delimiter to use when reading the file.  Custom delimiters</span>
        <span class="c">///</span><span class="c"> may not be used when the file is opened with a &quot;Byte&quot; encoding.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>]
        <b>public string</b> <a id="1037f85f9f999306" href="../R/1037f85f9f999306.html" target="n" data-glyph="102,1" class="i property">Delimiter</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#c356dbd9dbd6f6bc" class="i field">_delimiter</a>;
            }
 
            <b>set</b>
            {
                <a href="#316665f197d56597" class="i property">DelimiterSpecified</a> = <b>true</b>;
                <a href="#c356dbd9dbd6f6bc" class="i field">_delimiter</a> = <b>value</b>;
            }
        }
 
        <b>private string</b> <a id="c356dbd9dbd6f6bc" href="../R/c356dbd9dbd6f6bc.html" target="n" data-glyph="46,1" class="i field">_delimiter</a> = <span class="s">&quot;\n&quot;</span>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets or sets the Wait flag.  The wait flag determines if we want</span>
        <span class="c">///</span><span class="c"> the read-content call to poll (and wait) for changes to the file,</span>
        <span class="c">///</span><span class="c"> rather than exit after the content has been read.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>]
        <b>public</b> <a href="../engine/MshCmdlet.cs.html#8260026027378f6c" class="t t">SwitchParameter</a> <a id="dcd641c76872efa4" href="../R/dcd641c76872efa4.html" target="n" data-glyph="102,1" class="i property">Wait</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#638cff7d3738485a" class="i field">_wait</a>;
            }
 
            <b>set</b>
            {
                <a href="#638cff7d3738485a" class="i field">_wait</a> = <b>value</b>;
            }
        }
 
        <b>private bool</b> <a id="638cff7d3738485a" href="../R/638cff7d3738485a.html" target="n" data-glyph="46,1" class="i field">_wait</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> When the Raw switch is present, we don&#39;t do any breaks on newlines,</span>
        <span class="c">///</span><span class="c"> and only emit one object to the pipeline: all of the content.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>]
        <b>public</b> <a href="../engine/MshCmdlet.cs.html#8260026027378f6c" class="t t">SwitchParameter</a> <a id="0ef6f2594f7cc514" href="../R/0ef6f2594f7cc514.html" target="n" data-glyph="102,1" class="i property">Raw</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#eba2006d7fc4ce04" class="i field">_isRaw</a>;
            }
 
            <b>set</b>
            {
                <a href="#eba2006d7fc4ce04" class="i field">_isRaw</a> = <b>value</b>;
            }
        }
 
        <b>private bool</b> <a id="eba2006d7fc4ce04" href="../R/eba2006d7fc4ce04.html" target="n" data-glyph="46,1" class="i field">_isRaw</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the status of the delimiter parameter.  Returns true</span>
        <span class="c">///</span><span class="c"> if the delimiter was explicitly specified by the user, false otherwise.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public bool</b> <a id="316665f197d56597" href="../R/316665f197d56597.html" target="n" data-glyph="102,1" class="i property">DelimiterSpecified</a>
        {
            <b>get</b>; <b>private set</b>;
            <span class="c">// get</span>
        }
    }
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Provides the dynamic parameters for test-path on the file system.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>public class</b> <a id="2102c33332bd089f" href="../R/2102c33332bd089f.html" target="n" data-glyph="0,0" class="t t"><span id="4de3e10cd2811d49">FileSystemItemProviderDynamicParameters</span></a>
    {
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> A parameter to test if a file is older than a certain time or date.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>]
        <b>public</b> <span class="i">DateTime</span>? <a id="125b2cac6c5b301c" href="../R/125b2cac6c5b301c.html" target="n" data-glyph="102,1" class="i property">OlderThan</a> { <b>get</b>; <b>set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> A parameter to test if a file is newer than a certain time or date.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>]
        <b>public</b> <span class="i">DateTime</span>? <a id="1170bc49b0de9637" href="../R/1170bc49b0de9637.html" target="n" data-glyph="102,1" class="i property">NewerThan</a> { <b>get</b>; <b>set</b>; }
    }
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Provides the dynamic parameters for Get-Item on the file system.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>public class</b> <a id="187ca243c9c08a1e" href="../R/187ca243c9c08a1e.html" target="n" data-glyph="0,0" class="t t"><span id="2518d1a387860d7e">FileSystemProviderGetItemDynamicParameters</span></a>
    {
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">UNIX</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> A parameter to return the streams of an item.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>]
        [<span class="i">ValidateNotNullOrEmpty</span>()]
        [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Performance&quot;</span>, <span class="s">&quot;CA1819:PropertiesShouldNotReturnArrays&quot;</span>)]
        <b>public string</b>[] <a id="6fc3e642a4cf1972" href="../R/6fc3e642a4cf1972.html" target="n" data-glyph="102,1" class="i property">Stream</a> { <b>get</b>; <b>set</b>; }
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
    }
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Provides the dynamic parameters for Remove-Item on the file system.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>public class</b> <a id="bca4e55a4c7ee955" href="../R/bca4e55a4c7ee955.html" target="n" data-glyph="0,0" class="t t"><span id="3a30006318423ce7">FileSystemProviderRemoveItemDynamicParameters</span></a>
    {
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">UNIX</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> A parameter to return the streams of an item.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>]
        [<span class="i">ValidateNotNullOrEmpty</span>()]
        [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Performance&quot;</span>, <span class="s">&quot;CA1819:PropertiesShouldNotReturnArrays&quot;</span>)]
        <b>public string</b>[] <a id="a2b126b2711295e3" href="../R/a2b126b2711295e3.html" target="n" data-glyph="102,1" class="i property">Stream</a> { <b>get</b>; <b>set</b>; }
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
    }
 
    <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
    <span class="k preprocess">#</span><span class="k preprocess">region</span> Symbolic Link
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Class to find the symbolic link target.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>public static class</b> <a id="916c1750999d4e10" href="../R/916c1750999d4e10.html" target="n" data-glyph="0,0" class="t t">InternalSymbolicLinkLinkCodeMethods</a>
    {
        <span class="c">// This size comes from measuring the size of the header of REPARSE_GUID_DATA_BUFFER</span>
        <b>private const int</b> <a id="b4980ef5a739e6d6" href="../R/b4980ef5a739e6d6.html" target="n" data-glyph="10,1" class="i field">REPARSE_GUID_DATA_BUFFER_HEADER_SIZE</a> = 24;
 
        <span class="c">// Maximum reparse buffer info size. The max user defined reparse</span>
        <span class="c">// data is 16KB, plus there&#39;s a header.</span>
        <b>private const int</b> <a id="7be664e13a624101" href="../R/7be664e13a624101.html" target="n" data-glyph="10,1" class="i field">MAX_REPARSE_SIZE</a> = (16 * 1024) + <a href="#b4980ef5a739e6d6" class="i field">REPARSE_GUID_DATA_BUFFER_HEADER_SIZE</a>;
 
        <b>private const int</b> <a id="45f6e94a76b87943" href="../R/45f6e94a76b87943.html" target="n" data-glyph="10,1" class="i field">FSCTL_GET_REPARSE_POINT</a> = 0x000900A8;
 
        <b>private const int</b> <a id="6af08d0c23ec4678" href="../R/6af08d0c23ec4678.html" target="n" data-glyph="10,1" class="i field">FSCTL_SET_REPARSE_POINT</a> = 0x000900A4;
 
        <b>private const int</b> <a id="475f41326c76d934" href="../R/../../0000000000.html" target="n" data-glyph="10,1" class="i field">FSCTL_DELETE_REPARSE_POINT</a> = 0x000900AC;
 
        <b>private const uint</b> <a id="f000c4d7ed5bf8d2" href="../R/f000c4d7ed5bf8d2.html" target="n" data-glyph="10,1" class="i field">IO_REPARSE_TAG_SYMLINK</a> = 0xA000000C;
 
        <b>private const uint</b> <a id="3e0a3d8753e9e8a0" href="../R/3e0a3d8753e9e8a0.html" target="n" data-glyph="10,1" class="i field">IO_REPARSE_TAG_MOUNT_POINT</a> = 0xA0000003;
 
        <b>private const uint</b> <a id="ec2322baaabead1b" href="../R/ec2322baaabead1b.html" target="n" data-glyph="10,1" class="i field">IO_REPARSE_TAG_APPEXECLINK</a> = 0x8000001B;
 
        <b>private const string</b> <a id="bbc6c24126da66a1" href="../R/bbc6c24126da66a1.html" target="n" data-glyph="10,1" class="i field">NonInterpretedPathPrefix</a> = <span class="s">@&quot;\??\&quot;</span>;
 
        <b>private const int</b> <a id="45fec8c54ccbe795" href="../R/45fec8c54ccbe795.html" target="n" data-glyph="10,1" class="i field">MAX_PATH</a> = 260;
 
        [<span class="i">Flags</span>]
        <span class="c">// dwDesiredAccess of CreateFile</span>
        <b>internal enum</b> <a id="89b13872d5153f14" href="../R/89b13872d5153f14.html" target="n" data-glyph="20,1" class="t t"><span id="c8b74fb2d8e9b98a">FileDesiredAccess</span></a> : <b>uint</b>
        {
            <a id="8713cd0cfd4b66b1" href="../R/8713cd0cfd4b66b1.html" target="n" data-glyph="24,2" class="i field">GenericZero</a> = 0,
            <a id="2f53772d6a486eab" href="../R/2f53772d6a486eab.html" target="n" data-glyph="24,2" class="i field">GenericRead</a> = 0x80000000,
            <a id="fac9c5f1cabe105a" href="../R/fac9c5f1cabe105a.html" target="n" data-glyph="24,2" class="i field">GenericWrite</a> = 0x40000000,
            <a id="fe25d3506c4e5863" href="../R/../../0000000000.html" target="n" data-glyph="24,2" class="i field">GenericExecute</a> = 0x20000000,
            <a id="5ae91007bf8ac26a" href="../R/../../0000000000.html" target="n" data-glyph="24,2" class="i field">GenericAll</a> = 0x10000000,
        }
 
        [<span class="i">Flags</span>]
        <span class="c">// dwShareMode of CreateFile</span>
        <b>internal enum</b> <a id="44bf171c7413eedd" href="../R/44bf171c7413eedd.html" target="n" data-glyph="20,1" class="t t"><span id="967c5882566ab388">FileShareMode</span></a> : <b>uint</b>
        {
            <a id="5e9765f6f734c124" href="../R/../../0000000000.html" target="n" data-glyph="24,2" class="i field">None</a> = 0x00000000,
            <a id="af51eedea87c63a3" href="../R/af51eedea87c63a3.html" target="n" data-glyph="24,2" class="i field">Read</a> = 0x00000001,
            <a id="1b446288dce9353b" href="../R/1b446288dce9353b.html" target="n" data-glyph="24,2" class="i field">Write</a> = 0x00000002,
            <a id="3d9ec8b4f285d58e" href="../R/3d9ec8b4f285d58e.html" target="n" data-glyph="24,2" class="i field">Delete</a> = 0x00000004,
        }
 
        <span class="c">// dwCreationDisposition of CreateFile</span>
        <b>internal enum</b> <a id="be8a03c7378c4369" href="../R/be8a03c7378c4369.html" target="n" data-glyph="20,1" class="t t"><span id="4653fc364e84f42d">FileCreationDisposition</span></a> : <b>uint</b>
        {
            <a id="002fbdab2330cd5c" href="../R/../../0000000000.html" target="n" data-glyph="24,2" class="i field">New</a> = 1,
            <a id="48beb307a91623d1" href="../R/../../0000000000.html" target="n" data-glyph="24,2" class="i field">CreateAlways</a> = 2,
            <a id="c19469d8f8675cd8" href="../R/c19469d8f8675cd8.html" target="n" data-glyph="24,2" class="i field">OpenExisting</a> = 3,
            <a id="51e524b975ed6980" href="../R/../../0000000000.html" target="n" data-glyph="24,2" class="i field">OpenAlways</a> = 4,
            <a id="c3c9f71345a7a77a" href="../R/../../0000000000.html" target="n" data-glyph="24,2" class="i field">TruncateExisting</a> = 5,
        }
 
        [<span class="i">Flags</span>]
        <span class="c">// dwFlagsAndAttributes</span>
        <b>internal enum</b> <a id="26cffa651e77fb97" href="../R/26cffa651e77fb97.html" target="n" data-glyph="20,1" class="t t"><span id="aa7ecb416af0a0bd">FileAttributes</span></a> : <b>uint</b>
        {
            <a id="2609d7897cb05cef" href="../R/../../0000000000.html" target="n" data-glyph="24,2" class="i field">Readonly</a> = 0x00000001,
            <a id="9e78a68906f457c9" href="../R/../../0000000000.html" target="n" data-glyph="24,2" class="i field">Hidden</a> = 0x00000002,
            <a id="dc501d5e5d4c50ad" href="../R/../../0000000000.html" target="n" data-glyph="24,2" class="i field">System</a> = 0x00000004,
            <a id="22435c38bd94783b" href="../R/../../0000000000.html" target="n" data-glyph="24,2" class="i field">Archive</a> = 0x00000020,
            <a id="6e2ba52dbbcbe0c3" href="../R/../../0000000000.html" target="n" data-glyph="24,2" class="i field">Encrypted</a> = 0x00004000,
            <a id="e48ac1ca047785f6" href="../R/../../0000000000.html" target="n" data-glyph="24,2" class="i field">Write_Through</a> = 0x80000000,
            <a id="87ca82aa4e19e3b0" href="../R/../../0000000000.html" target="n" data-glyph="24,2" class="i field">Overlapped</a> = 0x40000000,
            <a id="0aba4cc740259a87" href="../R/../../0000000000.html" target="n" data-glyph="24,2" class="i field">NoBuffering</a> = 0x20000000,
            <a id="4a73be1b6b9323b4" href="../R/../../0000000000.html" target="n" data-glyph="24,2" class="i field">RandomAccess</a> = 0x10000000,
            <a id="3c1a10cb3bab2208" href="../R/../../0000000000.html" target="n" data-glyph="24,2" class="i field">SequentialScan</a> = 0x08000000,
            <a id="3655b774db1a8abd" href="../R/../../0000000000.html" target="n" data-glyph="24,2" class="i field">DeleteOnClose</a> = 0x04000000,
            <a id="c62d515ae553ed70" href="../R/c62d515ae553ed70.html" target="n" data-glyph="24,2" class="i field">BackupSemantics</a> = 0x02000000,
            <a id="705ee907a725ed7a" href="../R/705ee907a725ed7a.html" target="n" data-glyph="24,2" class="i field">PosixSemantics</a> = 0x01000000,
            <a id="06bfbdbd75104a4b" href="../R/06bfbdbd75104a4b.html" target="n" data-glyph="24,2" class="i field">OpenReparsePoint</a> = 0x00200000,
            <a id="eae3c92e57c56497" href="../R/../../0000000000.html" target="n" data-glyph="24,2" class="i field">OpenNoRecall</a> = 0x00100000,
            <a id="d2af866e0d21e391" href="../R/../../0000000000.html" target="n" data-glyph="24,2" class="i field">SessionAware</a> = 0x00800000,
            <a id="da94215671855ed6" href="../R/da94215671855ed6.html" target="n" data-glyph="24,2" class="i field">Normal</a> = 0x00000080
        }
 
        [<span class="i">StructLayout</span>(<span class="i">LayoutKind</span>.<span class="i">Sequential</span>)]
        <b>private struct</b> <a id="4fc9c4ca68f7ee61" href="../R/4fc9c4ca68f7ee61.html" target="n" data-glyph="112,1" class="t t"><span id="15fe00c38591903a">REPARSE_DATA_BUFFER_SYMBOLICLINK</span></a>
        {
            <b>public uint</b> <a id="5948f24777d3d516" href="../R/5948f24777d3d516.html" target="n" data-glyph="42,2" class="i field">ReparseTag</a>;
            <b>public ushort</b> <a id="ec1013a73a8d7799" href="../R/../../0000000000.html" target="n" data-glyph="42,2" class="i field">ReparseDataLength</a>;
            <b>public ushort</b> <a id="e33a7be107ff88ed" href="../R/../../0000000000.html" target="n" data-glyph="42,2" class="i field">Reserved</a>;
            <b>public ushort</b> <a id="c754101786b40907" href="../R/c754101786b40907.html" target="n" data-glyph="42,2" class="i field">SubstituteNameOffset</a>;
            <b>public ushort</b> <a id="95723778d8638ce8" href="../R/95723778d8638ce8.html" target="n" data-glyph="42,2" class="i field">SubstituteNameLength</a>;
            <b>public ushort</b> <a id="415697d4d67375c1" href="../R/../../0000000000.html" target="n" data-glyph="42,2" class="i field">PrintNameOffset</a>;
            <b>public ushort</b> <a id="c1b64ad2efda069a" href="../R/../../0000000000.html" target="n" data-glyph="42,2" class="i field">PrintNameLength</a>;
            <b>public uint</b> <a id="07d6e142578cb95c" href="../R/../../0000000000.html" target="n" data-glyph="42,2" class="i field">Flags</a>;
 
            [<span class="i">MarshalAs</span>(<span class="i">UnmanagedType</span>.<span class="i">ByValArray</span>, <span class="i">SizeConst</span> = 0x3FF0)]
            <b>public byte</b>[] <a id="3f3a979dd58d03a4" href="../R/3f3a979dd58d03a4.html" target="n" data-glyph="42,2" class="i field">PathBuffer</a>;
        }
 
        [<span class="i">StructLayout</span>(<span class="i">LayoutKind</span>.<span class="i">Sequential</span>)]
        <b>private struct</b> <a id="e8a7818edd23c8ee" href="../R/e8a7818edd23c8ee.html" target="n" data-glyph="112,1" class="t t"><span id="c0e328735ce23b3c">REPARSE_DATA_BUFFER_MOUNTPOINT</span></a>
        {
            <b>public uint</b> <a id="5e0f98ab3f4bd165" href="../R/5e0f98ab3f4bd165.html" target="n" data-glyph="42,2" class="i field">ReparseTag</a>;
            <b>public ushort</b> <a id="469697cb907460a3" href="../R/469697cb907460a3.html" target="n" data-glyph="42,2" class="i field">ReparseDataLength</a>;
            <b>public ushort</b> <a id="6d321816042e5a58" href="../R/../../0000000000.html" target="n" data-glyph="42,2" class="i field">Reserved</a>;
            <b>public ushort</b> <a id="0a6541710d18900c" href="../R/0a6541710d18900c.html" target="n" data-glyph="42,2" class="i field">SubstituteNameOffset</a>;
            <b>public ushort</b> <a id="0ef48f8370c134db" href="../R/0ef48f8370c134db.html" target="n" data-glyph="42,2" class="i field">SubstituteNameLength</a>;
            <b>public ushort</b> <a id="8f5fea2c4517cefd" href="../R/8f5fea2c4517cefd.html" target="n" data-glyph="42,2" class="i field">PrintNameOffset</a>;
            <b>public ushort</b> <a id="7ab3134da74f47fc" href="../R/7ab3134da74f47fc.html" target="n" data-glyph="42,2" class="i field">PrintNameLength</a>;
 
            [<span class="i">MarshalAs</span>(<span class="i">UnmanagedType</span>.<span class="i">ByValArray</span>, <span class="i">SizeConst</span> = 0x3FF0)]
            <b>public byte</b>[] <a id="9961d0fbffc0ed89" href="../R/9961d0fbffc0ed89.html" target="n" data-glyph="42,2" class="i field">PathBuffer</a>;
        }
 
        [<span class="i">StructLayout</span>(<span class="i">LayoutKind</span>.<span class="i">Sequential</span>)]
        <b>private struct</b> <a id="3d96493d81a7370e" href="../R/3d96493d81a7370e.html" target="n" data-glyph="112,1" class="t t"><span id="56f5f9abdb378848">REPARSE_DATA_BUFFER_APPEXECLINK</span></a>
        {
            <b>public uint</b> <a id="6bf1a38eef77c366" href="../R/../../0000000000.html" target="n" data-glyph="42,2" class="i field">ReparseTag</a>;
            <b>public ushort</b> <a id="46d26e6f179646da" href="../R/../../0000000000.html" target="n" data-glyph="42,2" class="i field">ReparseDataLength</a>;
            <b>public ushort</b> <a id="9fab95c68f4c2f8c" href="../R/../../0000000000.html" target="n" data-glyph="42,2" class="i field">Reserved</a>;
            <b>public uint</b> <a id="a90563d83fbeda28" href="../R/a90563d83fbeda28.html" target="n" data-glyph="42,2" class="i field">StringCount</a>;
 
            [<span class="i">MarshalAs</span>(<span class="i">UnmanagedType</span>.<span class="i">ByValArray</span>, <span class="i">SizeConst</span> = 0x3FF0)]
            <b>public byte</b>[] <a id="acf7860100e1545b" href="../R/acf7860100e1545b.html" target="n" data-glyph="42,2" class="i field">StringList</a>;
        }
 
        [<span class="i">StructLayout</span>(<span class="i">LayoutKind</span>.<span class="i">Sequential</span>)]
        <b>private struct</b> <a id="d8d3f6957abdc9b5" href="../R/d8d3f6957abdc9b5.html" target="n" data-glyph="112,1" class="t t"><span id="38f8333d0767eca9">BY_HANDLE_FILE_INFORMATION</span></a>
        {
            <b>public uint</b> <a id="be869be101cdb338" href="../R/../../0000000000.html" target="n" data-glyph="42,2" class="i field">FileAttributes</a>;
            <b>public</b> <span class="i n">System</span>.<span class="i">Runtime</span>.<span class="i">InteropServices</span>.<span class="i">ComTypes</span>.<span class="i">FILETIME</span> <a id="202d65287e0c3314" href="../R/../../0000000000.html" target="n" data-glyph="42,2" class="i field">CreationTime</a>;
            <b>public</b> <span class="i n">System</span>.<span class="i">Runtime</span>.<span class="i">InteropServices</span>.<span class="i">ComTypes</span>.<span class="i">FILETIME</span> <a id="2688d01638c4423e" href="../R/../../0000000000.html" target="n" data-glyph="42,2" class="i field">LastAccessTime</a>;
            <b>public</b> <span class="i n">System</span>.<span class="i">Runtime</span>.<span class="i">InteropServices</span>.<span class="i">ComTypes</span>.<span class="i">FILETIME</span> <a id="4fdccb588e105b08" href="../R/../../0000000000.html" target="n" data-glyph="42,2" class="i field">LastWriteTime</a>;
            <b>public uint</b> <a id="1f6abf5d4c872fc7" href="../R/1f6abf5d4c872fc7.html" target="n" data-glyph="42,2" class="i field">VolumeSerialNumber</a>;
            <b>public uint</b> <a id="18032e58b40d0098" href="../R/../../0000000000.html" target="n" data-glyph="42,2" class="i field">FileSizeHigh</a>;
            <b>public uint</b> <a id="f8c70ae3a49e0a26" href="../R/../../0000000000.html" target="n" data-glyph="42,2" class="i field">FileSizeLow</a>;
            <b>public uint</b> <a id="d526a9cc5dd05ad6" href="../R/d526a9cc5dd05ad6.html" target="n" data-glyph="42,2" class="i field">NumberOfLinks</a>;
            <b>public uint</b> <a id="747e0d89ab0ee2dc" href="../R/747e0d89ab0ee2dc.html" target="n" data-glyph="42,2" class="i field">FileIndexHigh</a>;
            <b>public uint</b> <a id="3a6f0d2a2e5c1a82" href="../R/3a6f0d2a2e5c1a82.html" target="n" data-glyph="42,2" class="i field">FileIndexLow</a>;
        }
 
        [<span class="i">StructLayout</span>(<span class="i">LayoutKind</span>.<span class="i">Sequential</span>)]
        <b>private struct</b> <a id="97a981e0b6205c91" href="../R/97a981e0b6205c91.html" target="n" data-glyph="112,1" class="t t"><span id="f8d1518f34ba9005">GUID</span></a>
        {
            <b>public uint</b> <a id="373faad556e3deba" href="../R/../../0000000000.html" target="n" data-glyph="42,2" class="i field">Data1</a>;
            <b>public ushort</b> <a id="049ebf891f18733d" href="../R/../../0000000000.html" target="n" data-glyph="42,2" class="i field">Data2</a>;
            <b>public ushort</b> <a id="dddd5a9f59c4af5b" href="../R/../../0000000000.html" target="n" data-glyph="42,2" class="i field">Data3</a>;
 
            [<span class="i">MarshalAs</span>(<span class="i">UnmanagedType</span>.<span class="i">ByValArray</span>, <span class="i">SizeConst</span> = 8)]
            <b>public char</b>[] <a id="50b0ac138916d6ac" href="../R/../../0000000000.html" target="n" data-glyph="42,2" class="i field">Data4</a>;
        }
 
        [<span class="i">StructLayout</span>(<span class="i">LayoutKind</span>.<span class="i">Sequential</span>)]
        <b>private struct</b> <a id="6cf9934f37595202" href="../R/../../0000000000.html" target="n" data-glyph="112,1" class="t t"><span id="9d44d88d7615e0cd">REPARSE_GUID_DATA_BUFFER</span></a>
        {
            <b>public uint</b> <a id="1f594cc4f06177ca" href="../R/../../0000000000.html" target="n" data-glyph="42,2" class="i field">ReparseTag</a>;
            <b>public ushort</b> <a id="563d310bb03539e3" href="../R/../../0000000000.html" target="n" data-glyph="42,2" class="i field">ReparseDataLength</a>;
            <b>public ushort</b> <a id="8789b5de7ca4d8a0" href="../R/../../0000000000.html" target="n" data-glyph="42,2" class="i field">Reserved</a>;
            <b>public</b> <a href="#97a981e0b6205c91" class="t t">GUID</a> <a id="c332e13182d0d2de" href="../R/../../0000000000.html" target="n" data-glyph="42,2" class="i field">ReparseGuid</a>;
 
            [<span class="i">MarshalAs</span>(<span class="i">UnmanagedType</span>.<span class="i">ByValArray</span>, <span class="i">SizeConst</span> = <a href="#7be664e13a624101" class="i field">MAX_REPARSE_SIZE</a>)]
            <b>public char</b>[] <a id="b341d57cb21ead70" href="../R/../../0000000000.html" target="n" data-glyph="42,2" class="i field">DataBuffer</a>;
        }
 
        [<span class="i">DllImport</span>(<a href="../utils/PInvokeDllNames.cs.html#6c73838805dd2f2a" class="t t">PinvokeDllNames</a>.<a href="../utils/PInvokeDllNames.cs.html#fe55e65c59eeb8a7" class="i field">DeviceIoControlDllName</a>, <span class="i">CharSet</span> = <span class="i">CharSet</span>.<span class="i">Unicode</span>, <span class="i">ExactSpelling</span> = <b>true</b>, <span class="i">SetLastError</span> = <b>true</b>)]
        <b>private static extern bool</b> <a id="6160b1e15e4075df" href="../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">DeviceIoControl</a>(<span class="i">IntPtr</span> <span id="r926 rd" class="r926 r">hDevice</span>, <b>uint</b> <span id="r927 rd" class="r927 r">dwIoControlCode</span>,
            <span class="i">IntPtr</span> <span id="r928 rd" class="r928 r">InBuffer</span>, <b>int</b> <span id="r929 rd" class="r929 r">nInBufferSize</span>,
            <span class="i">IntPtr</span> <span id="r930 rd" class="r930 r">OutBuffer</span>, <b>int</b> <span id="r931 rd" class="r931 r">nOutBufferSize</span>,
            <b>out int</b> <span id="r932 rd" class="r932 r">pBytesReturned</span>, <span class="i">IntPtr</span> <span id="r933 rd" class="r933 r">lpOverlapped</span>);
 
        [<span class="i">DllImport</span>(<a href="../utils/PInvokeDllNames.cs.html#6c73838805dd2f2a" class="t t">PinvokeDllNames</a>.<a href="../utils/PInvokeDllNames.cs.html#1da9a5e87b8ea12a" class="i field">GetFileInformationByHandleDllName</a>, <span class="i">SetLastError</span> = <b>true</b>, <span class="i">CharSet</span> = <span class="i">CharSet</span>.<span class="i">Unicode</span>)]
        [<b>return</b>: <span class="i">MarshalAs</span>(<span class="i">UnmanagedType</span>.<span class="i">Bool</span>)]
        <b>private static extern bool</b> <a id="bc1cb20545432745" href="../R/bc1cb20545432745.html" target="n" data-glyph="76,1" class="i method">GetFileInformationByHandle</a>(
                <span class="i">IntPtr</span> <span id="r934 rd" class="r934 r">hFile</span>,
                <b>out</b> <a href="#d8d3f6957abdc9b5" class="t t">BY_HANDLE_FILE_INFORMATION</a> <span id="r935 rd" class="r935 r">lpFileInformation</span>);
 
        [<span class="i">DllImport</span>(<a href="../utils/PInvokeDllNames.cs.html#6c73838805dd2f2a" class="t t">PinvokeDllNames</a>.<a href="../utils/PInvokeDllNames.cs.html#c72846465597e9c7" class="i field">CreateFileDllName</a>, <span class="i">SetLastError</span> = <b>true</b>, <span class="i">CharSet</span> = <span class="i">CharSet</span>.<span class="i">Unicode</span>)]
        <b>internal static extern</b> <span class="i">IntPtr</span> <a id="2b4e779cfd5c6b29" href="../R/../../0000000000.html" target="n" data-glyph="74,1" class="i method">CreateFile</a>(
            <b>string</b> <span id="r936 rd" class="r936 r">lpFileName</span>,
            <a href="#89b13872d5153f14" class="t t">FileDesiredAccess</a> <span id="r937 rd" class="r937 r">dwDesiredAccess</span>,
            <a href="#44bf171c7413eedd" class="t t">FileShareMode</a> <span id="r938 rd" class="r938 r">dwShareMode</span>,
            <span class="i">IntPtr</span> <span id="r939 rd" class="r939 r">lpSecurityAttributes</span>,
            <a href="#be8a03c7378c4369" class="t t">FileCreationDisposition</a> <span id="r940 rd" class="r940 r">dwCreationDisposition</span>,
            <a href="#26cffa651e77fb97" class="t t">FileAttributes</a> <span id="r941 rd" class="r941 r">dwFlagsAndAttributes</span>,
            <span class="i">IntPtr</span> <span id="r942 rd" class="r942 r">hTemplateFile</span>);
 
        <b>internal sealed class</b> <a id="df14ad068c277762" href="../R/df14ad068c277762.html" target="n" data-glyph="2,1" class="t t">SafeFindHandle</a> : <span class="i">SafeHandleZeroOrMinusOneIsInvalid</span>
        {
            <b>private</b> <a id="5339e02ba1b37e87" href="../R/../../0000000000.html" target="n" data-glyph="76,2" class="t constructor">SafeFindHandle</a>() : <b>base</b>(<b>true</b>) { }
 
            <b>protected override bool</b> <a id="3adf26b3dbdd7b18" href="../R/../../0000000000.html" target="n" data-glyph="75,2" class="i method">ReleaseHandle</a>()
            {
                <b>return</b> <span class="i">FindClose</span>(<a href="#df14ad068c277762" class="k">this</a>.<span class="i">handle</span>);
            }
 
            [<span class="i">DllImport</span>(<a href="../utils/PInvokeDllNames.cs.html#6c73838805dd2f2a" class="t t">PinvokeDllNames</a>.<a href="../utils/PInvokeDllNames.cs.html#d0d2e1a53b9555d0" class="i field">FindCloseDllName</a>)]
            [<b>return</b>: <span class="i">MarshalAs</span>(<span class="i">UnmanagedType</span>.<span class="i">Bool</span>)]
            <b>private static extern bool</b> <a id="2fe3ded6a9138017" href="../R/../../0000000000.html" target="n" data-glyph="76,2" class="i method">FindClose</a>(<span class="i">IntPtr</span> <span id="r943 rd" class="r943 r">handle</span>);
        }
 
        [<span class="i">DllImport</span>(<a href="../utils/PInvokeDllNames.cs.html#6c73838805dd2f2a" class="t t">PinvokeDllNames</a>.<a href="../utils/PInvokeDllNames.cs.html#413e105cc9067277" class="i field">FindFirstFileDllName</a>, <span class="i">EntryPoint</span> = <span class="s">&quot;FindFirstFileExW&quot;</span>, <span class="i">SetLastError</span> = <b>true</b>, <span class="i">CharSet</span> = <span class="i">CharSet</span>.<span class="i">Unicode</span>)]
        <b>private static extern</b> <a href="#df14ad068c277762" class="t t">SafeFindHandle</a> <a id="045d381c5182006f" href="../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">FindFirstFileEx</a>(<b>string</b> <span id="r944 rd" class="r944 r">lpFileName</span>, <a href="#7518966c5ba3ed2e" class="t t">FINDEX_INFO_LEVELS</a> <span id="r945 rd" class="r945 r">fInfoLevelId</span>, <b>ref</b> <a href="#ea8c20ddbc369bae" class="t t">WIN32_FIND_DATA</a> <span id="r946 rd" class="r946 r">lpFindFileData</span>, <a href="#248cde4051ceceea" class="t t">FINDEX_SEARCH_OPS</a> <span id="r947 rd" class="r947 r">fSearchOp</span>, <span class="i">IntPtr</span> <span id="r948 rd" class="r948 r">lpSearchFilter</span>, <b>int</b> <span id="r949 rd" class="r949 r">dwAdditionalFlags</span>);
 
        <b>internal enum</b> <a id="7518966c5ba3ed2e" href="../R/7518966c5ba3ed2e.html" target="n" data-glyph="20,1" class="t t"><span id="abd35e16ce1e1619">FINDEX_INFO_LEVELS</span></a> : <b>uint</b>
        {
            <a id="d696e46ea6d92754" href="../R/../../0000000000.html" target="n" data-glyph="24,2" class="i field">FindExInfoStandard</a> = 0x0u,
            <a id="7677837ecf6c3406" href="../R/7677837ecf6c3406.html" target="n" data-glyph="24,2" class="i field">FindExInfoBasic</a> = 0x1u,
            <a id="22094baca7b6e568" href="../R/../../0000000000.html" target="n" data-glyph="24,2" class="i field">FindExInfoMaxInfoLevel</a> = 0x2u,
        }
 
        <b>internal enum</b> <a id="248cde4051ceceea" href="../R/248cde4051ceceea.html" target="n" data-glyph="20,1" class="t t"><span id="ecdd396d143b95f3">FINDEX_SEARCH_OPS</span></a> : <b>uint</b>
        {
            <a id="1adc66e1c8f44253" href="../R/1adc66e1c8f44253.html" target="n" data-glyph="24,2" class="i field">FindExSearchNameMatch</a> = 0x0u,
            <a id="a5a335e9ca89787b" href="../R/../../0000000000.html" target="n" data-glyph="24,2" class="i field">FindExSearchLimitToDirectories</a> = 0x1u,
            <a id="21728a117c46ff3a" href="../R/../../0000000000.html" target="n" data-glyph="24,2" class="i field">FindExSearchLimitToDevices</a> = 0x2u,
            <a id="b61e392db4d7b8d7" href="../R/../../0000000000.html" target="n" data-glyph="24,2" class="i field">FindExSearchMaxSearchOp</a> = 0x3u,
        }
 
        [<span class="i">StructLayout</span>(<span class="i">LayoutKind</span>.<span class="i">Sequential</span>, <span class="i">CharSet</span> = <span class="i">CharSet</span>.<span class="i">Unicode</span>)]
        <b>internal unsafe struct</b> <a id="ea8c20ddbc369bae" href="../R/ea8c20ddbc369bae.html" target="n" data-glyph="110,1" class="t t"><span id="9ba63a832fb99f09">WIN32_FIND_DATA</span></a>
        {
            <b>internal uint</b> <a id="25be9bef8f5543b0" href="../R/25be9bef8f5543b0.html" target="n" data-glyph="44,2" class="i field">dwFileAttributes</a>;
            <b>internal</b> <span class="i n">System</span>.<span class="i">Runtime</span>.<span class="i">InteropServices</span>.<span class="i">ComTypes</span>.<span class="i">FILETIME</span> <a id="651dadad57f31786" href="../R/../../0000000000.html" target="n" data-glyph="44,2" class="i field">ftCreationTime</a>;
            <b>internal</b> <span class="i n">System</span>.<span class="i">Runtime</span>.<span class="i">InteropServices</span>.<span class="i">ComTypes</span>.<span class="i">FILETIME</span> <a id="2b98d7a390c7ca44" href="../R/../../0000000000.html" target="n" data-glyph="44,2" class="i field">ftLastAccessTime</a>;
            <b>internal</b> <span class="i n">System</span>.<span class="i">Runtime</span>.<span class="i">InteropServices</span>.<span class="i">ComTypes</span>.<span class="i">FILETIME</span> <a id="48d44a9561e15f99" href="../R/../../0000000000.html" target="n" data-glyph="44,2" class="i field">ftLastWriteTime</a>;
            <b>internal uint</b> <a id="33ac550a3e099fed" href="../R/../../0000000000.html" target="n" data-glyph="44,2" class="i field">nFileSizeHigh</a>;
            <b>internal uint</b> <a id="535498e117313f4b" href="../R/../../0000000000.html" target="n" data-glyph="44,2" class="i field">nFileSizeLow</a>;
            <b>internal uint</b> <a id="41e27d6e384a6c23" href="../R/41e27d6e384a6c23.html" target="n" data-glyph="44,2" class="i field">dwReserved0</a>;
            <b>internal uint</b> <a id="6f613af74105fe9d" href="../R/../../0000000000.html" target="n" data-glyph="44,2" class="i field">dwReserved1</a>;
            <b>internal fixed char</b> <a id="fb13724f403ff2d9" href="../R/../../0000000000.html" target="n" data-glyph="44,2" class="i field">cFileName</a>[<span class="i">MAX_PATH</span>];
            <b>internal fixed char</b> <a id="e96d9f97b1d05b36" href="../R/../../0000000000.html" target="n" data-glyph="44,2" class="i field">cAlternateFileName</a>[14];
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the target of the specified reparse point.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r950 r">instance</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The object of FileInfo or DirectoryInfo type.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">The target of the reparse point.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public static string</b> <a id="5742b8c481f2b1a7" href="../R/5742b8c481f2b1a7.html" target="n" data-glyph="72,1" class="i method">GetTarget</a>(<a href="../engine/MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r950 rd" class="r950 r">instance</span>)
        {
            <b>if</b> (<span class="r950 r">instance</span>.<a href="../engine/MshObject.cs.html#d854d13536b70a12" class="i property">BaseObject</a> <b>is</b> <span class="i">FileSystemInfo</span> <span id="r951 rd" class="r951 r">fileSysInfo</span>)
            {
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">UNIX</span>
                <b>return</b> <span class="i">WinInternalGetTarget</span>(<span class="r951 r">fileSysInfo</span>.<span class="i">FullName</span>);
<span class="k preprocess">#</span><span class="k preprocess">else</span>
<span class="e">               return UnixInternalGetTarget(fileSysInfo.FullName);
</span><span class="k preprocess">#</span><span class="k preprocess">endif</span>
            }
 
            <b>return</b> <b>null</b>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the link type of the specified reparse point.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r952 r">instance</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The object of FileInfo or DirectoryInfo type.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">The link type of the reparse point. SymbolicLink for symbolic links.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public static string</b> <a id="e1dad7ed67148708" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">GetLinkType</a>(<a href="../engine/MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r952 rd" class="r952 r">instance</span>)
        {
            <span class="i">FileSystemInfo</span> <span id="r953 rd" class="r953 r">fileSysInfo</span> = <span class="r952 r">instance</span>.<a href="../engine/MshObject.cs.html#d854d13536b70a12" class="i property">BaseObject</a> <b>as</b> <span class="i">FileSystemInfo</span>;
 
            <b>if</b> (<span class="r953 r">fileSysInfo</span> != <b>null</b>)
            {
                <b>return</b> <a href="#c0d4e12bd9bed080" class="i method">InternalGetLinkType</a>(<span class="r953 r">fileSysInfo</span>);
            }
 
            <b>return</b> <b>null</b>;
        }
 
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">UNIX</span>
<span class="e">        private static string UnixInternalGetTarget(string filePath)
        {
            string link = Platform.NonWindowsInternalGetTarget(filePath);
 
            if (string.IsNullOrEmpty(link))
            {
                throw new Win32Exception(Marshal.GetLastWin32Error());
            }
 
            return link;
        }
</span><span class="k preprocess">#</span><span class="k preprocess">endif</span>
 
        <b>private static string</b> <a id="c0d4e12bd9bed080" href="../R/c0d4e12bd9bed080.html" target="n" data-glyph="76,1" class="i method">InternalGetLinkType</a>(<span class="i">FileSystemInfo</span> <span id="r954 rd" class="r954 r">fileInfo</span>)
        {
            <b>if</b> (<a href="../CoreCLR/CorePsPlatform.cs.html#693813241122eb45" class="t t">Platform</a>.<a href="../CoreCLR/CorePsPlatform.cs.html#a0395f876114b36d" class="i property">IsWindows</a>)
            {
                <b>return</b> <span class="i">WinInternalGetLinkType</span>(<span class="r954 r">fileInfo</span>.<span class="i">FullName</span>);
            }
            <b>else</b>
            {
                <b>return</b> <a href="../CoreCLR/CorePsPlatform.cs.html#693813241122eb45" class="t t">Platform</a>.<a href="../CoreCLR/CorePsPlatform.cs.html#73977320dec19f12" class="i method">NonWindowsInternalGetLinkType</a>(<span class="r954 r">fileInfo</span>);
            }
        }
 
        [<span class="i n">System</span>.<span class="i n">Diagnostics</span>.<span class="i">CodeAnalysis</span>.<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Reliability&quot;</span>, <span class="s">&quot;CA2001:AvoidCallingProblematicMethods&quot;</span>)]
        <b>private static string</b> <a id="ac749d6cd2b77fce" href="../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">WinInternalGetLinkType</a>(<b>string</b> <span id="r955 rd" class="r955 r">filePath</span>)
        {
            <b>if</b> (!<a href="../CoreCLR/CorePsPlatform.cs.html#693813241122eb45" class="t t">Platform</a>.<a href="../CoreCLR/CorePsPlatform.cs.html#a0395f876114b36d" class="i property">IsWindows</a>)
            {
                <b>throw</b> <b>new</b> <span class="i">PlatformNotSupportedException</span>();
            }
 
            <span class="c">// We set accessMode parameter to zero because documentation says:</span>
            <span class="c">// If this parameter is zero, the application can query certain metadata</span>
            <span class="c">// such as file, directory, or device attributes without accessing</span>
            <span class="c">// that file or device, even if GENERIC_READ access would have been denied.</span>
            <b>using</b> (<span class="i">SafeFileHandle</span> <span id="r956 rd" class="r956 r">handle</span> = <a href="#cd874b6072a99b60" class="i method">OpenReparsePoint</a>(<span class="r955 r">filePath</span>, <a href="#89b13872d5153f14" class="t t">FileDesiredAccess</a>.<a href="#8713cd0cfd4b66b1" class="i field">GenericZero</a>))
            {
                <b>int</b> <span id="r957 rd" class="r957 r">outBufferSize</span> = <span class="i">Marshal</span>.<span class="i">SizeOf</span>&lt;<a href="#4fc9c4ca68f7ee61" class="t t">REPARSE_DATA_BUFFER_SYMBOLICLINK</a>&gt;();
 
                <span class="i">IntPtr</span> <span id="r958 rd" class="r958 r">outBuffer</span> = <span class="i">Marshal</span>.<span class="i">AllocHGlobal</span>(<span class="r957 r">outBufferSize</span>);
                <b>bool</b> <span id="r959 rd" class="r959 r">success</span> = <b>false</b>;
 
                <b>try</b>
                {
                    <b>int</b> <span id="r960 rd" class="r960 r">bytesReturned</span>;
                    <b>string</b> <span id="r961 rd" class="r961 r">linkType</span> = <b>null</b>;
 
                    <span class="c">// OACR warning 62001 about using DeviceIOControl has been disabled.</span>
                    <span class="c">// According to MSDN guidance DangerousAddRef() and DangerousRelease() have been used.</span>
                    <span class="r956 r">handle</span>.<span class="i">DangerousAddRef</span>(<b>ref</b> <span class="r959 r">success</span>);
 
                    <span class="c">// Get Buffer size</span>
                    <span class="i">IntPtr</span> <span id="r962 rd" class="r962 r">dangerousHandle</span> = <span class="r956 r">handle</span>.<span class="i">DangerousGetHandle</span>();
 
                    <b>bool</b> <span id="r963 rd" class="r963 r">result</span> = <span class="i">DeviceIoControl</span>(
                        <span class="r962 r">dangerousHandle</span>,
                        <a href="#45f6e94a76b87943" class="i field">FSCTL_GET_REPARSE_POINT</a>,
                        <span class="i">InBuffer</span>: <span class="i">IntPtr</span>.<span class="i">Zero</span>,
                        <span class="i">nInBufferSize</span>: 0,
                        <span class="r958 r">outBuffer</span>,
                        <span class="r957 r">outBufferSize</span>,
                        <b>out</b> <span class="r960 r">bytesReturned</span>,
                        <span class="i">lpOverlapped</span>: <span class="i">IntPtr</span>.<span class="i">Zero</span>);
 
                    <b>if</b> (!<span class="r963 r">result</span>)
                    {
                        <span class="c">// It&#39;s not a reparse point or the file system doesn&#39;t support reparse points.</span>
                        <b>return</b> <a href="#c633fe3da866cd0b" class="i method">IsHardLink</a>(<b>ref</b> <span class="r962 r">dangerousHandle</span>) ? <span class="s">&quot;HardLink&quot;</span> : <b>null</b>;
                    }
 
                    <a href="#4fc9c4ca68f7ee61" class="t t">REPARSE_DATA_BUFFER_SYMBOLICLINK</a> <span id="r964 rd" class="r964 r">reparseDataBuffer</span> = <span class="i">Marshal</span>.<span class="i">PtrToStructure</span>&lt;<a href="#4fc9c4ca68f7ee61" class="t t">REPARSE_DATA_BUFFER_SYMBOLICLINK</a>&gt;(<span class="r958 r">outBuffer</span>);
 
                    <b>switch</b> (<span class="r964 r">reparseDataBuffer</span>.<a href="#5948f24777d3d516" class="i field">ReparseTag</a>)
                    {
                        <b>case</b> <a href="#f000c4d7ed5bf8d2" class="i field">IO_REPARSE_TAG_SYMLINK</a>:
                            <span class="r961 r">linkType</span> = <span class="s">&quot;SymbolicLink&quot;</span>;
                            <b>break</b>;
 
                        <b>case</b> <a href="#3e0a3d8753e9e8a0" class="i field">IO_REPARSE_TAG_MOUNT_POINT</a>:
                            <span class="r961 r">linkType</span> = <span class="s">&quot;Junction&quot;</span>;
                            <b>break</b>;
 
                        <b>case</b> <a href="#ec2322baaabead1b" class="i field">IO_REPARSE_TAG_APPEXECLINK</a>:
                            <span class="r961 r">linkType</span> = <span class="s">&quot;AppExeCLink&quot;</span>;
                            <b>break</b>;
 
                        <b>default</b>:
                            <span class="r961 r">linkType</span> = <b>null</b>;
                            <b>break</b>;
                    }
 
                    <b>return</b> <span class="r961 r">linkType</span>;
                }
                <b>finally</b>
                {
                    <b>if</b> (<span class="r959 r">success</span>)
                    {
                        <span class="r956 r">handle</span>.<span class="i">DangerousRelease</span>();
                    }
 
                    <span class="i">Marshal</span>.<span class="i">FreeHGlobal</span>(<span class="r958 r">outBuffer</span>);
                }
            }
        }
 
        <b>internal static bool</b> <a id="df7ccd99bcbb2071" href="../R/df7ccd99bcbb2071.html" target="n" data-glyph="74,1" class="i method">IsHardLink</a>(<span class="i">FileSystemInfo</span> <span id="r965 rd" class="r965 r">fileInfo</span>)
        {
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">UNIX</span>
<span class="e">            return Platform.NonWindowsIsHardLink(fileInfo);
</span><span class="k preprocess">#</span><span class="k preprocess">else</span>
            <b>return</b> <a href="#2d030626fc1bf381" class="i method">WinIsHardLink</a>(<span class="r965 r">fileInfo</span>);
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
        }
 
        <b>internal static bool</b> <a id="7caa2744ba84db20" href="../R/7caa2744ba84db20.html" target="n" data-glyph="74,1" class="i method">IsReparsePoint</a>(<span class="i">FileSystemInfo</span> <span id="r966 rd" class="r966 r">fileInfo</span>)
        {
            <b>return</b> <span class="r966 r">fileInfo</span>.<span class="i">Attributes</span>.<span class="i">HasFlag</span>(<span class="i n">System</span>.<span class="i">IO</span>.<span class="i">FileAttributes</span>.<span class="i">ReparsePoint</span>);
        }
 
        <b>internal static bool</b> <a id="327bd40bb20377da" href="../R/327bd40bb20377da.html" target="n" data-glyph="74,1" class="i method">IsReparsePointLikeSymlink</a>(<span class="i">FileSystemInfo</span> <span id="r967 rd" class="r967 r">fileInfo</span>)
        {
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">UNIX</span>
<span class="e">            // Reparse point on Unix is a symlink.
            return IsReparsePoint(fileInfo);
</span><span class="k preprocess">#</span><span class="k preprocess">else</span>
            <b>if</b> (<a href="../engine/Utils.cs.html#f365eaa75311eda0" class="t t">InternalTestHooks</a>.<a href="../engine/Utils.cs.html#9f1ecef5221b3e20" class="i field">OneDriveTestOn</a> &amp;&amp; <span class="r967 r">fileInfo</span>.<span class="i">Name</span> == <a href="../engine/Utils.cs.html#f365eaa75311eda0" class="t t">InternalTestHooks</a>.<a href="../engine/Utils.cs.html#693288444174cf3b" class="i field">OneDriveTestSymlinkName</a>)
            {
                <b>return</b> !<a href="../engine/Utils.cs.html#f365eaa75311eda0" class="t t">InternalTestHooks</a>.<a href="../engine/Utils.cs.html#ef7c978c6f943e37" class="i field">OneDriveTestRecurseOn</a>;
            }
 
            <a href="#ea8c20ddbc369bae" class="t t">WIN32_FIND_DATA</a> <span id="r968 rd" class="r968 r">data</span> = <b>default</b>;
            <b>string</b> <span id="r969 rd" class="r969 r">fullPath</span> = <span class="i">Path</span>.<span class="i">TrimEndingDirectorySeparator</span>(<span class="r967 r">fileInfo</span>.<span class="i">FullName</span>);
            <b>if</b> (<span class="r969 r">fullPath</span>.<span class="i">Length</span> &gt; <a href="#45fec8c54ccbe795" class="i field">MAX_PATH</a>)
            {
                <span class="r969 r">fullPath</span> = <a href="../utils/PathUtils.cs.html#fdaf75f786a21eb9" class="t t">PathUtils</a>.<a href="../utils/PathUtils.cs.html#caa7014d709999ce" class="i method">EnsureExtendedPrefix</a>(<span class="r969 r">fullPath</span>);
            }
 
            <b>using</b> (<a href="#df14ad068c277762" class="t t">SafeFindHandle</a> <span id="r970 rd" class="r970 r">handle</span> = <span class="i">FindFirstFileEx</span>(<span class="r969 r">fullPath</span>, <a href="#7518966c5ba3ed2e" class="t t">FINDEX_INFO_LEVELS</a>.<a href="#7677837ecf6c3406" class="i field">FindExInfoBasic</a>, <b>ref</b> <span class="r968 r">data</span>, <a href="#248cde4051ceceea" class="t t">FINDEX_SEARCH_OPS</a>.<a href="#1adc66e1c8f44253" class="i field">FindExSearchNameMatch</a>, <span class="i">IntPtr</span>.<span class="i">Zero</span>, 0))
            {
                <b>if</b> (<span class="r970 r">handle</span>.<span class="i">IsInvalid</span>)
                {
                    <span class="c">// Our handle could be invalidated by something else touching the filesystem,</span>
                    <span class="c">// so ensure we deal with that possibility here</span>
                    <b>int</b> <span id="r971 rd" class="r971 r">lastError</span> = <span class="i">Marshal</span>.<span class="i">GetLastWin32Error</span>();
                    <b>throw</b> <b>new</b> <span class="i">Win32Exception</span>(<span class="r971 r">lastError</span>);
                }
 
                <span class="c">// We already have the file attribute information from our Win32 call,</span>
                <span class="c">// so no need to take the expense of the FileInfo.FileAttributes call</span>
                <b>const int</b> <span id="r972 rd" class="r972 r">FILE_ATTRIBUTE_REPARSE_POINT</span> = 0x0400;
                <b>if</b> ((<span class="r968 r">data</span>.<a href="#25be9bef8f5543b0" class="i field">dwFileAttributes</a> &amp; <span class="r972 r">FILE_ATTRIBUTE_REPARSE_POINT</span>) == 0)
                {
                    <span class="c">// Not a reparse point.</span>
                    <b>return</b> <b>false</b>;
                }
 
                <span class="c">// The name surrogate bit 0x20000000 is defined in https://docs.microsoft.com/windows/win32/fileio/reparse-point-tags</span>
                <span class="c">// Name surrogates (0x20000000) are reparse points that point to other named entities local to the filesystem</span>
                <span class="c">// (like symlinks and mount points).</span>
                <span class="c">// In the case of OneDrive, they are not name surrogates and would be safe to recurse into.</span>
                <b>if</b> ((<span class="r968 r">data</span>.<a href="#41e27d6e384a6c23" class="i field">dwReserved0</a> &amp; 0x20000000) == 0 &amp;&amp; (<span class="r968 r">data</span>.<a href="#41e27d6e384a6c23" class="i field">dwReserved0</a> != <a href="#ec2322baaabead1b" class="i field">IO_REPARSE_TAG_APPEXECLINK</a>))
                {
                    <b>return</b> <b>false</b>;
                }
            }
 
            <b>return</b> <b>true</b>;
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
        }
 
        <b>internal static bool</b> <a id="2d030626fc1bf381" href="../R/2d030626fc1bf381.html" target="n" data-glyph="74,1" class="i method">WinIsHardLink</a>(<span class="i">FileSystemInfo</span> <span id="r973 rd" class="r973 r">fileInfo</span>)
        {
            <b>bool</b> <span id="r974 rd" class="r974 r">isHardLink</span> = <b>false</b>;
 
            <span class="c">// only check for hard link if the item is not directory</span>
            <b>if</b> ((<span class="r973 r">fileInfo</span>.<span class="i">Attributes</span> &amp; <span class="i n">System</span>.<span class="i">IO</span>.<span class="i">FileAttributes</span>.<span class="i">Directory</span>) != <span class="i n">System</span>.<span class="i">IO</span>.<span class="i">FileAttributes</span>.<span class="i">Directory</span>)
            {
                <span class="i">IntPtr</span> <span id="r975 rd" class="r975 r">nativeHandle</span> = <a href="#916c1750999d4e10" class="t t">InternalSymbolicLinkLinkCodeMethods</a>.<span class="i">CreateFile</span>(
                    <span class="r973 r">fileInfo</span>.<span class="i">FullName</span>,
                    <a href="#916c1750999d4e10" class="t t">InternalSymbolicLinkLinkCodeMethods</a>.<a href="#89b13872d5153f14" class="t t">FileDesiredAccess</a>.<a href="#2f53772d6a486eab" class="i field">GenericRead</a>,
                    <a href="#916c1750999d4e10" class="t t">InternalSymbolicLinkLinkCodeMethods</a>.<a href="#44bf171c7413eedd" class="t t">FileShareMode</a>.<a href="#af51eedea87c63a3" class="i field">Read</a>,
                    <span class="i">IntPtr</span>.<span class="i">Zero</span>,
                    <a href="#916c1750999d4e10" class="t t">InternalSymbolicLinkLinkCodeMethods</a>.<a href="#be8a03c7378c4369" class="t t">FileCreationDisposition</a>.<a href="#c19469d8f8675cd8" class="i field">OpenExisting</a>,
                    <a href="#916c1750999d4e10" class="t t">InternalSymbolicLinkLinkCodeMethods</a>.<a href="#26cffa651e77fb97" class="t t">FileAttributes</a>.<a href="#da94215671855ed6" class="i field">Normal</a>,
                    <span class="i">IntPtr</span>.<span class="i">Zero</span>);
 
                <b>using</b> (<span class="i">SafeFileHandle</span> <span id="r976 rd" class="r976 r">handle</span> = <b>new</b> <span class="i">SafeFileHandle</span>(<span class="r975 r">nativeHandle</span>, <b>true</b>))
                {
                    <b>bool</b> <span id="r977 rd" class="r977 r">success</span> = <b>false</b>;
 
                    <b>try</b>
                    {
                        <span class="r976 r">handle</span>.<span class="i">DangerousAddRef</span>(<b>ref</b> <span class="r977 r">success</span>);
                        <span class="i">IntPtr</span> <span id="r978 rd" class="r978 r">dangerousHandle</span> = <span class="r976 r">handle</span>.<span class="i">DangerousGetHandle</span>();
                        <span class="r974 r">isHardLink</span> = <a href="#916c1750999d4e10" class="t t">InternalSymbolicLinkLinkCodeMethods</a>.<a href="#c633fe3da866cd0b" class="i method">IsHardLink</a>(<b>ref</b> <span class="r978 r">dangerousHandle</span>);
                    }
                    <b>finally</b>
                    {
                        <b>if</b> (<span class="r977 r">success</span>)
                            <span class="r976 r">handle</span>.<span class="i">DangerousRelease</span>();
                    }
                }
            }
 
            <b>return</b> <span class="r974 r">isHardLink</span>;
        }
 
        <b>internal static bool</b> <a id="0b904825e5bba667" href="../R/0b904825e5bba667.html" target="n" data-glyph="74,1" class="i method">IsSameFileSystemItem</a>(<b>string</b> <span id="r979 rd" class="r979 r">pathOne</span>, <b>string</b> <span id="r980 rd" class="r980 r">pathTwo</span>)
        {
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">UNIX</span>
<span class="e">            return Platform.NonWindowsIsSameFileSystemItem(pathOne, pathTwo);
</span><span class="k preprocess">#</span><span class="k preprocess">else</span>
            <b>return</b> <a href="#4f04fe9ae59b9809" class="i method">WinIsSameFileSystemItem</a>(<span class="r979 r">pathOne</span>, <span class="r980 r">pathTwo</span>);
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
        }
 
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">UNIX</span>
        <b>private static bool</b> <a id="4f04fe9ae59b9809" href="../R/4f04fe9ae59b9809.html" target="n" data-glyph="76,1" class="i method">WinIsSameFileSystemItem</a>(<b>string</b> <span id="r981 rd" class="r981 r">pathOne</span>, <b>string</b> <span id="r982 rd" class="r982 r">pathTwo</span>)
        {
            <b>const</b> <span class="i">FileAccess</span> <span id="r983 rd" class="r983 r">access</span> = <span class="i">FileAccess</span>.<span class="i">Read</span>;
            <b>const</b> <span class="i">FileShare</span> <span id="r984 rd" class="r984 r">share</span> = <span class="i">FileShare</span>.<span class="i">Read</span>;
            <b>const</b> <span class="i">FileMode</span> <span id="r985 rd" class="r985 r">creation</span> = <span class="i">FileMode</span>.<span class="i">Open</span>;
            <b>const</b> <a href="#26cffa651e77fb97" class="t t">FileAttributes</a> <span id="r986 rd" class="r986 r">attributes</span> = <a href="#26cffa651e77fb97" class="t t">FileAttributes</a>.<a href="#c62d515ae553ed70" class="i field">BackupSemantics</a> | <a href="#26cffa651e77fb97" class="t t">FileAttributes</a>.<a href="#705ee907a725ed7a" class="i field">PosixSemantics</a>;
 
            <b>using</b> (<b>var</b> <span id="r987 rd" class="r987 r">sfOne</span> = <a href="#28276e8c322107d7" class="t t">AlternateDataStreamUtilities</a>.<a href="#8683c4e037a7b912" class="t t">NativeMethods</a>.<span class="i">CreateFile</span>(<span class="r981 r">pathOne</span>, <span class="r983 r">access</span>, <span class="r984 r">share</span>, <span class="i">IntPtr</span>.<span class="i">Zero</span>, <span class="r985 r">creation</span>, (<b>int</b>)<span class="r986 r">attributes</span>, <span class="i">IntPtr</span>.<span class="i">Zero</span>))
            <b>using</b> (<b>var</b> <span id="r988 rd" class="r988 r">sfTwo</span> = <a href="#28276e8c322107d7" class="t t">AlternateDataStreamUtilities</a>.<a href="#8683c4e037a7b912" class="t t">NativeMethods</a>.<span class="i">CreateFile</span>(<span class="r982 r">pathTwo</span>, <span class="r983 r">access</span>, <span class="r984 r">share</span>, <span class="i">IntPtr</span>.<span class="i">Zero</span>, <span class="r985 r">creation</span>, (<b>int</b>)<span class="r986 r">attributes</span>, <span class="i">IntPtr</span>.<span class="i">Zero</span>))
            {
                <b>if</b> (!<span class="r987 r">sfOne</span>.<span class="i">IsInvalid</span> &amp;&amp; !<span class="r988 r">sfTwo</span>.<span class="i">IsInvalid</span>)
                {
                    <a href="#d8d3f6957abdc9b5" class="t t">BY_HANDLE_FILE_INFORMATION</a> <span id="r989 rd" class="r989 r">infoOne</span>;
                    <a href="#d8d3f6957abdc9b5" class="t t">BY_HANDLE_FILE_INFORMATION</a> <span id="r990 rd" class="r990 r">infoTwo</span>;
                    <b>if</b> (<span class="i">GetFileInformationByHandle</span>(<span class="r987 r">sfOne</span>.<span class="i">DangerousGetHandle</span>(), <b>out</b> <span class="r989 r">infoOne</span>)
                        &amp;&amp; <span class="i">GetFileInformationByHandle</span>(<span class="r988 r">sfTwo</span>.<span class="i">DangerousGetHandle</span>(), <b>out</b> <span class="r990 r">infoTwo</span>))
                    {
                        <b>return</b> <span class="r989 r">infoOne</span>.<a href="#1f6abf5d4c872fc7" class="i field">VolumeSerialNumber</a> == <span class="r990 r">infoTwo</span>.<a href="#1f6abf5d4c872fc7" class="i field">VolumeSerialNumber</a>
                               &amp;&amp; <span class="r989 r">infoOne</span>.<a href="#747e0d89ab0ee2dc" class="i field">FileIndexHigh</a> == <span class="r990 r">infoTwo</span>.<a href="#747e0d89ab0ee2dc" class="i field">FileIndexHigh</a>
                               &amp;&amp; <span class="r989 r">infoOne</span>.<a href="#3a6f0d2a2e5c1a82" class="i field">FileIndexLow</a> == <span class="r990 r">infoTwo</span>.<a href="#3a6f0d2a2e5c1a82" class="i field">FileIndexLow</a>;
                    }
                }
            }
 
            <b>return</b> <b>false</b>;
        }
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
 
        <b>internal static bool</b> <a id="b7f8a59fbede92ee" href="../R/../../0000000000.html" target="n" data-glyph="74,1" class="i method">GetInodeData</a>(<b>string</b> <span id="r991 rd" class="r991 r">path</span>, <b>out</b> <span class="i n">System</span>.<span class="i">ValueTuple</span>&lt;<span class="i">UInt64</span>, <span class="i">UInt64</span>&gt; <span id="r992 rd" class="r992 r">inodeData</span>)
        {
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">UNIX</span>
<span class="e">            bool rv = Platform.NonWindowsGetInodeData(path, out inodeData);
</span><span class="k preprocess">#</span><span class="k preprocess">else</span>
            <b>bool</b> <span id="r993 rd" class="r993 r">rv</span> = <a href="#826655ea6da9c499" class="i method">WinGetInodeData</a>(<span class="r991 r">path</span>, <b>out</b> <span class="r992 r">inodeData</span>);
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
            <b>return</b> <span class="r993 r">rv</span>;
        }
 
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">UNIX</span>
        <b>private static bool</b> <a id="826655ea6da9c499" href="../R/826655ea6da9c499.html" target="n" data-glyph="76,1" class="i method">WinGetInodeData</a>(<b>string</b> <span id="r994 rd" class="r994 r">path</span>, <b>out</b> <span class="i n">System</span>.<span class="i">ValueTuple</span>&lt;<span class="i">UInt64</span>, <span class="i">UInt64</span>&gt; <span id="r995 rd" class="r995 r">inodeData</span>)
        {
            <b>const</b> <span class="i">FileAccess</span> <span id="r996 rd" class="r996 r">access</span> = <span class="i">FileAccess</span>.<span class="i">Read</span>;
            <b>const</b> <span class="i">FileShare</span> <span id="r997 rd" class="r997 r">share</span> = <span class="i">FileShare</span>.<span class="i">Read</span>;
            <b>const</b> <span class="i">FileMode</span> <span id="r998 rd" class="r998 r">creation</span> = <span class="i">FileMode</span>.<span class="i">Open</span>;
            <b>const</b> <a href="#26cffa651e77fb97" class="t t">FileAttributes</a> <span id="r999 rd" class="r999 r">attributes</span> = <a href="#26cffa651e77fb97" class="t t">FileAttributes</a>.<a href="#c62d515ae553ed70" class="i field">BackupSemantics</a> | <a href="#26cffa651e77fb97" class="t t">FileAttributes</a>.<a href="#705ee907a725ed7a" class="i field">PosixSemantics</a>;
 
            <b>using</b> (<b>var</b> <span id="r1000 rd" class="r1000 r">sf</span> = <a href="#28276e8c322107d7" class="t t">AlternateDataStreamUtilities</a>.<a href="#8683c4e037a7b912" class="t t">NativeMethods</a>.<span class="i">CreateFile</span>(<span class="r994 r">path</span>, <span class="r996 r">access</span>, <span class="r997 r">share</span>, <span class="i">IntPtr</span>.<span class="i">Zero</span>, <span class="r998 r">creation</span>, (<b>int</b>)<span class="r999 r">attributes</span>, <span class="i">IntPtr</span>.<span class="i">Zero</span>))
            {
                <b>if</b> (!<span class="r1000 r">sf</span>.<span class="i">IsInvalid</span>)
                {
                    <a href="#d8d3f6957abdc9b5" class="t t">BY_HANDLE_FILE_INFORMATION</a> <span id="r1001 rd" class="r1001 r">info</span>;
 
                    <b>if</b> (<span class="i">GetFileInformationByHandle</span>(<span class="r1000 r">sf</span>.<span class="i">DangerousGetHandle</span>(), <b>out</b> <span class="r1001 r">info</span>))
                    {
                        <span class="i">UInt64</span> <span id="r1002 rd" class="r1002 r">tmp</span> = <span class="r1001 r">info</span>.<a href="#747e0d89ab0ee2dc" class="i field">FileIndexHigh</a>;
                        <span class="r1002 r">tmp</span> = (<span class="r1002 r">tmp</span> &lt;&lt; 32) | <span class="r1001 r">info</span>.<a href="#3a6f0d2a2e5c1a82" class="i field">FileIndexLow</a>;
 
                        <span class="r995 r">inodeData</span> = (<span class="r1001 r">info</span>.<a href="#1f6abf5d4c872fc7" class="i field">VolumeSerialNumber</a>, <span class="r1002 r">tmp</span>);
 
                        <b>return</b> <b>true</b>;
                    }
                }
            }
 
            <span class="r995 r">inodeData</span> = (0, 0);
 
            <b>return</b> <b>false</b>;
        }
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
 
        <b>internal static bool</b> <a id="c633fe3da866cd0b" href="../R/c633fe3da866cd0b.html" target="n" data-glyph="74,1" class="i method">IsHardLink</a>(<b>ref</b> <span class="i">IntPtr</span> <span id="r1003 rd" class="r1003 r">handle</span>)
        {
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">UNIX</span>
<span class="e">            return Platform.NonWindowsIsHardLink(ref handle);
</span><span class="k preprocess">#</span><span class="k preprocess">else</span>
            <b>return</b> <a href="#47608b75d25c4def" class="i method">WinIsHardLink</a>(<b>ref</b> <span class="r1003 r">handle</span>);
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
        }
 
        [<span class="i n">System</span>.<span class="i n">Diagnostics</span>.<span class="i">CodeAnalysis</span>.<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Reliability&quot;</span>, <span class="s">&quot;CA2001:AvoidCallingProblematicMethods&quot;</span>)]
        <b>internal static bool</b> <a id="47608b75d25c4def" href="../R/47608b75d25c4def.html" target="n" data-glyph="74,1" class="i method">WinIsHardLink</a>(<b>ref</b> <span class="i">IntPtr</span> <span id="r1004 rd" class="r1004 r">handle</span>)
        {
            <a href="#d8d3f6957abdc9b5" class="t t">BY_HANDLE_FILE_INFORMATION</a> <span id="r1005 rd" class="r1005 r">handleInfo</span>;
            <b>bool</b> <span id="r1006 rd" class="r1006 r">succeeded</span> = <a href="#916c1750999d4e10" class="t t">InternalSymbolicLinkLinkCodeMethods</a>.<a href="#bc1cb20545432745" class="i method">GetFileInformationByHandle</a>(<span class="r1004 r">handle</span>, <b>out</b> <span class="r1005 r">handleInfo</span>);
            <b>return</b> <span class="r1006 r">succeeded</span> &amp;&amp; (<span class="r1005 r">handleInfo</span>.<a href="#d526a9cc5dd05ad6" class="i field">NumberOfLinks</a> &gt; 1);
        }
 
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">UNIX</span>
        <b>internal static string</b> <a id="8660b3c94688ae73" href="../R/8660b3c94688ae73.html" target="n" data-glyph="74,1" class="i method">WinInternalGetTarget</a>(<b>string</b> <span id="r1007 rd" class="r1007 r">path</span>)
        {
            <span class="c">// We set accessMode parameter to zero because documentation says:</span>
            <span class="c">// If this parameter is zero, the application can query certain metadata</span>
            <span class="c">// such as file, directory, or device attributes without accessing</span>
            <span class="c">// that file or device, even if GENERIC_READ access would have been denied.</span>
            <b>using</b> (<span class="i">SafeFileHandle</span> <span id="r1008 rd" class="r1008 r">handle</span> = <a href="#cd874b6072a99b60" class="i method">OpenReparsePoint</a>(<span class="r1007 r">path</span>, <a href="#89b13872d5153f14" class="t t">FileDesiredAccess</a>.<a href="#8713cd0cfd4b66b1" class="i field">GenericZero</a>))
            {
                <b>return</b> <a href="#1ea111f3f34ccd39" class="i method">WinInternalGetTarget</a>(<span class="r1008 r">handle</span>);
            }
        }
 
        [<span class="i n">System</span>.<span class="i n">Diagnostics</span>.<span class="i">CodeAnalysis</span>.<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Reliability&quot;</span>, <span class="s">&quot;CA2001:AvoidCallingProblematicMethods&quot;</span>)]
        <b>private static string</b> <a id="1ea111f3f34ccd39" href="../R/1ea111f3f34ccd39.html" target="n" data-glyph="76,1" class="i method">WinInternalGetTarget</a>(<span class="i">SafeFileHandle</span> <span id="r1009 rd" class="r1009 r">handle</span>)
        {
            <b>int</b> <span id="r1010 rd" class="r1010 r">outBufferSize</span> = <span class="i">Marshal</span>.<span class="i">SizeOf</span>&lt;<a href="#4fc9c4ca68f7ee61" class="t t">REPARSE_DATA_BUFFER_SYMBOLICLINK</a>&gt;();
 
            <span class="i">IntPtr</span> <span id="r1011 rd" class="r1011 r">outBuffer</span> = <span class="i">Marshal</span>.<span class="i">AllocHGlobal</span>(<span class="r1010 r">outBufferSize</span>);
            <b>bool</b> <span id="r1012 rd" class="r1012 r">success</span> = <b>false</b>;
 
            <b>try</b>
            {
                <b>int</b> <span id="r1013 rd" class="r1013 r">bytesReturned</span>;
 
                <span class="c">// OACR warning 62001 about using DeviceIOControl has been disabled.</span>
                <span class="c">// According to MSDN guidance DangerousAddRef() and DangerousRelease() have been used.</span>
                <span class="r1009 r">handle</span>.<span class="i">DangerousAddRef</span>(<b>ref</b> <span class="r1012 r">success</span>);
 
                <b>bool</b> <span id="r1014 rd" class="r1014 r">result</span> = <span class="i">DeviceIoControl</span>(
                    <span class="r1009 r">handle</span>.<span class="i">DangerousGetHandle</span>(),
                    <a href="#45f6e94a76b87943" class="i field">FSCTL_GET_REPARSE_POINT</a>,
                    <span class="i">InBuffer</span>: <span class="i">IntPtr</span>.<span class="i">Zero</span>,
                    <span class="i">nInBufferSize</span>: 0,
                    <span class="r1011 r">outBuffer</span>,
                    <span class="r1010 r">outBufferSize</span>,
                    <b>out</b> <span class="r1013 r">bytesReturned</span>,
                    <span class="i">lpOverlapped</span>: <span class="i">IntPtr</span>.<span class="i">Zero</span>);
 
                <b>if</b> (!<span class="r1014 r">result</span>)
                {
                    <span class="c">// It&#39;s not a reparse point or the file system doesn&#39;t support reparse points.</span>
                    <b>return</b> <b>null</b>;
                }
 
                <b>string</b> <span id="r1015 rd" class="r1015 r">targetDir</span> = <b>null</b>;
 
                <a href="#4fc9c4ca68f7ee61" class="t t">REPARSE_DATA_BUFFER_SYMBOLICLINK</a> <span id="r1016 rd" class="r1016 r">reparseDataBuffer</span> = <span class="i">Marshal</span>.<span class="i">PtrToStructure</span>&lt;<a href="#4fc9c4ca68f7ee61" class="t t">REPARSE_DATA_BUFFER_SYMBOLICLINK</a>&gt;(<span class="r1011 r">outBuffer</span>);
 
                <b>switch</b> (<span class="r1016 r">reparseDataBuffer</span>.<a href="#5948f24777d3d516" class="i field">ReparseTag</a>)
                {
                    <b>case</b> <a href="#f000c4d7ed5bf8d2" class="i field">IO_REPARSE_TAG_SYMLINK</a>:
                        <span class="r1015 r">targetDir</span> = <span class="i">Encoding</span>.<span class="i">Unicode</span>.<span class="i">GetString</span>(<span class="r1016 r">reparseDataBuffer</span>.<a href="#3f3a979dd58d03a4" class="i field">PathBuffer</a>, <span class="r1016 r">reparseDataBuffer</span>.<a href="#c754101786b40907" class="i field">SubstituteNameOffset</a>, <span class="r1016 r">reparseDataBuffer</span>.<a href="#95723778d8638ce8" class="i field">SubstituteNameLength</a>);
                        <b>break</b>;
 
                    <b>case</b> <a href="#3e0a3d8753e9e8a0" class="i field">IO_REPARSE_TAG_MOUNT_POINT</a>:
                        <a href="#e8a7818edd23c8ee" class="t t">REPARSE_DATA_BUFFER_MOUNTPOINT</a> <span id="r1017 rd" class="r1017 r">reparseMountPointDataBuffer</span> = <span class="i">Marshal</span>.<span class="i">PtrToStructure</span>&lt;<a href="#e8a7818edd23c8ee" class="t t">REPARSE_DATA_BUFFER_MOUNTPOINT</a>&gt;(<span class="r1011 r">outBuffer</span>);
                        <span class="r1015 r">targetDir</span> = <span class="i">Encoding</span>.<span class="i">Unicode</span>.<span class="i">GetString</span>(<span class="r1017 r">reparseMountPointDataBuffer</span>.<a href="#9961d0fbffc0ed89" class="i field">PathBuffer</a>, <span class="r1017 r">reparseMountPointDataBuffer</span>.<a href="#0a6541710d18900c" class="i field">SubstituteNameOffset</a>, <span class="r1017 r">reparseMountPointDataBuffer</span>.<a href="#0ef48f8370c134db" class="i field">SubstituteNameLength</a>);
                        <b>break</b>;
 
                    <b>case</b> <a href="#ec2322baaabead1b" class="i field">IO_REPARSE_TAG_APPEXECLINK</a>:
                        <a href="#3d96493d81a7370e" class="t t">REPARSE_DATA_BUFFER_APPEXECLINK</a> <span id="r1018 rd" class="r1018 r">reparseAppExeDataBuffer</span> = <span class="i">Marshal</span>.<span class="i">PtrToStructure</span>&lt;<a href="#3d96493d81a7370e" class="t t">REPARSE_DATA_BUFFER_APPEXECLINK</a>&gt;(<span class="r1011 r">outBuffer</span>);
                        <span class="c">// The target file is at index 2</span>
                        <b>if</b> (<span class="r1018 r">reparseAppExeDataBuffer</span>.<a href="#a90563d83fbeda28" class="i field">StringCount</a> &gt;= 3)
                        {
                            <b>string</b> <span id="r1019 rd" class="r1019 r">temp</span> = <span class="i">Encoding</span>.<span class="i">Unicode</span>.<span class="i">GetString</span>(<span class="r1018 r">reparseAppExeDataBuffer</span>.<a href="#acf7860100e1545b" class="i field">StringList</a>);
                            <span class="r1015 r">targetDir</span> = <span class="r1019 r">temp</span>.<span class="i">Split</span>(<span class="s">&#39;\0&#39;</span>)[2];
                        }
                        <b>break</b>;
 
                    <b>default</b>:
                        <b>return</b> <b>null</b>;
                }
 
                <b>if</b> (<span class="r1015 r">targetDir</span> != <b>null</b> &amp;&amp; <span class="r1015 r">targetDir</span>.<span class="i">StartsWith</span>(<a href="#bbc6c24126da66a1" class="i field">NonInterpretedPathPrefix</a>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
                {
                    <span class="r1015 r">targetDir</span> = <span class="r1015 r">targetDir</span>.<span class="i">Substring</span>(<a href="#bbc6c24126da66a1" class="i field">NonInterpretedPathPrefix</a>.<span class="i">Length</span>);
                }
 
                <b>return</b> <span class="r1015 r">targetDir</span>;
            }
            <b>finally</b>
            {
                <b>if</b> (<span class="r1012 r">success</span>)
                {
                    <span class="r1009 r">handle</span>.<span class="i">DangerousRelease</span>();
                }
 
                <span class="i">Marshal</span>.<span class="i">FreeHGlobal</span>(<span class="r1011 r">outBuffer</span>);
            }
        }
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
 
        <b>internal static bool</b> <a id="a202e3dbfe2ea66e" href="../R/a202e3dbfe2ea66e.html" target="n" data-glyph="74,1" class="i method">CreateJunction</a>(<b>string</b> <span id="r1020 rd" class="r1020 r">path</span>, <b>string</b> <span id="r1021 rd" class="r1021 r">target</span>)
        {
            <span class="c">// this is a purely Windows specific feature, no feature flag</span>
            <span class="c">// used for that reason</span>
            <b>if</b> (<a href="../CoreCLR/CorePsPlatform.cs.html#693813241122eb45" class="t t">Platform</a>.<a href="../CoreCLR/CorePsPlatform.cs.html#a0395f876114b36d" class="i property">IsWindows</a>)
            {
                <b>return</b> <a href="#61b4771581877ef4" class="i method">WinCreateJunction</a>(<span class="r1020 r">path</span>, <span class="r1021 r">target</span>);
            }
            <b>else</b>
            {
                <b>return</b> <b>false</b>;
            }
        }
 
        [<span class="i n">System</span>.<span class="i n">Diagnostics</span>.<span class="i">CodeAnalysis</span>.<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Reliability&quot;</span>, <span class="s">&quot;CA2001:AvoidCallingProblematicMethods&quot;</span>)]
        <b>private static bool</b> <a id="61b4771581877ef4" href="../R/61b4771581877ef4.html" target="n" data-glyph="76,1" class="i method">WinCreateJunction</a>(<b>string</b> <span id="r1022 rd" class="r1022 r">path</span>, <b>string</b> <span id="r1023 rd" class="r1023 r">target</span>)
        {
            <b>if</b> (!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r1022 r">path</span>))
            {
                <b>if</b> (!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r1023 r">target</span>))
                {
                    <b>using</b> (<span class="i">SafeHandle</span> <span id="r1024 rd" class="r1024 r">handle</span> = <a href="#cd874b6072a99b60" class="i method">OpenReparsePoint</a>(<span class="r1022 r">path</span>, <a href="#89b13872d5153f14" class="t t">FileDesiredAccess</a>.<a href="#fac9c5f1cabe105a" class="i field">GenericWrite</a>))
                    {
                        <b>byte</b>[] <span id="r1025 rd" class="r1025 r">mountPointBytes</span> = <span class="i">Encoding</span>.<span class="i">Unicode</span>.<span class="i">GetBytes</span>(<a href="#bbc6c24126da66a1" class="i field">NonInterpretedPathPrefix</a> + <span class="i">Path</span>.<span class="i">GetFullPath</span>(<span class="r1023 r">target</span>));
 
                        <a href="#e8a7818edd23c8ee" class="t t">REPARSE_DATA_BUFFER_MOUNTPOINT</a> <span id="r1026 rd" class="r1026 r">mountPoint</span> = <b>new</b> <span class="t">REPARSE_DATA_BUFFER_MOUNTPOINT</span>();
                        <span class="r1026 r">mountPoint</span>.<a href="#5e0f98ab3f4bd165" class="i field">ReparseTag</a> = <a href="#3e0a3d8753e9e8a0" class="i field">IO_REPARSE_TAG_MOUNT_POINT</a>;
                        <span class="r1026 r">mountPoint</span>.<a href="#469697cb907460a3" class="i field">ReparseDataLength</a> = (<b>ushort</b>)(<span class="r1025 r">mountPointBytes</span>.<span class="i">Length</span> + 12); <span class="c">// Added space for the header and null endo</span>
                        <span class="r1026 r">mountPoint</span>.<a href="#0a6541710d18900c" class="i field">SubstituteNameOffset</a> = 0;
                        <span class="r1026 r">mountPoint</span>.<a href="#0ef48f8370c134db" class="i field">SubstituteNameLength</a> = (<b>ushort</b>)<span class="r1025 r">mountPointBytes</span>.<span class="i">Length</span>;
                        <span class="r1026 r">mountPoint</span>.<a href="#8f5fea2c4517cefd" class="i field">PrintNameOffset</a> = (<b>ushort</b>)(<span class="r1025 r">mountPointBytes</span>.<span class="i">Length</span> + 2); <span class="c">// 2 as unicode null take 2 bytes.</span>
                        <span class="r1026 r">mountPoint</span>.<a href="#7ab3134da74f47fc" class="i field">PrintNameLength</a> = 0;
                        <span class="r1026 r">mountPoint</span>.<a href="#9961d0fbffc0ed89" class="i field">PathBuffer</a> = <b>new</b> <b>byte</b>[0x3FF0]; <span class="c">// Buffer for max size.</span>
                        <span class="i">Array</span>.<span class="i">Copy</span>(<span class="r1025 r">mountPointBytes</span>, <span class="r1026 r">mountPoint</span>.<a href="#9961d0fbffc0ed89" class="i field">PathBuffer</a>, <span class="r1025 r">mountPointBytes</span>.<span class="i">Length</span>);
 
                        <b>int</b> <span id="r1027 rd" class="r1027 r">nativeBufferSize</span> = <span class="i">Marshal</span>.<span class="i">SizeOf</span>(<span class="r1026 r">mountPoint</span>);
                        <span class="i">IntPtr</span> <span id="r1028 rd" class="r1028 r">nativeBuffer</span> = <span class="i">Marshal</span>.<span class="i">AllocHGlobal</span>(<span class="r1027 r">nativeBufferSize</span>);
                        <b>bool</b> <span id="r1029 rd" class="r1029 r">success</span> = <b>false</b>;
 
                        <b>try</b>
                        {
                            <span class="i">Marshal</span>.<span class="i">StructureToPtr</span>(<span class="r1026 r">mountPoint</span>, <span class="r1028 r">nativeBuffer</span>, <b>false</b>);
 
                            <b>int</b> <span id="r1030 rd" class="r1030 r">bytesReturned</span> = 0;
 
                            <span class="c">// OACR warning 62001 about using DeviceIOControl has been disabled.</span>
                            <span class="c">// According to MSDN guidance DangerousAddRef() and DangerousRelease() have been used.</span>
                            <span class="r1024 r">handle</span>.<span class="i">DangerousAddRef</span>(<b>ref</b> <span class="r1029 r">success</span>);
 
                            <b>bool</b> <span id="r1031 rd" class="r1031 r">result</span> = <span class="i">DeviceIoControl</span>(<span class="r1024 r">handle</span>.<span class="i">DangerousGetHandle</span>(), <a href="#6af08d0c23ec4678" class="i field">FSCTL_SET_REPARSE_POINT</a>, <span class="r1028 r">nativeBuffer</span>, <span class="r1025 r">mountPointBytes</span>.<span class="i">Length</span> + 20, <span class="i">IntPtr</span>.<span class="i">Zero</span>, 0, <b>out</b> <span class="r1030 r">bytesReturned</span>, <span class="i">IntPtr</span>.<span class="i">Zero</span>);
 
                            <b>if</b> (!<span class="r1031 r">result</span>)
                            {
                                <b>throw</b> <b>new</b> <span class="i">Win32Exception</span>(<span class="i">Marshal</span>.<span class="i">GetLastWin32Error</span>());
                            }
 
                            <b>return</b> <span class="r1031 r">result</span>;
                        }
                        <b>finally</b>
                        {
                            <span class="i">Marshal</span>.<span class="i">FreeHGlobal</span>(<span class="r1028 r">nativeBuffer</span>);
 
                            <b>if</b> (<span class="r1029 r">success</span>)
                            {
                                <span class="r1024 r">handle</span>.<span class="i">DangerousRelease</span>();
                            }
                        }
                    }
                }
                <b>else</b>
                {
                    <b>throw</b> <b>new</b> <span class="i">ArgumentNullException</span>(<b>nameof</b>(<span class="r1023 r">target</span>));
                }
            }
            <b>else</b>
            {
                <b>throw</b> <b>new</b> <span class="i">ArgumentNullException</span>(<b>nameof</b>(<span class="r1022 r">path</span>));
            }
        }
 
        <b>private static</b> <span class="i">SafeFileHandle</span> <a id="cd874b6072a99b60" href="../R/cd874b6072a99b60.html" target="n" data-glyph="76,1" class="i method">OpenReparsePoint</a>(<b>string</b> <span id="r1032 rd" class="r1032 r">reparsePoint</span>, <a href="#89b13872d5153f14" class="t t">FileDesiredAccess</a> <span id="r1033 rd" class="r1033 r">accessMode</span>)
        {
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">UNIX</span>
<span class="e">            throw new PlatformNotSupportedException();
</span><span class="k preprocess">#</span><span class="k preprocess">else</span>
            <b>return</b> <a href="#6bf843ccb61b0a12" class="i method">WinOpenReparsePoint</a>(<span class="r1032 r">reparsePoint</span>, <span class="r1033 r">accessMode</span>);
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
        }
 
        <b>private static</b> <span class="i">SafeFileHandle</span> <a id="6bf843ccb61b0a12" href="../R/6bf843ccb61b0a12.html" target="n" data-glyph="76,1" class="i method">WinOpenReparsePoint</a>(<b>string</b> <span id="r1034 rd" class="r1034 r">reparsePoint</span>, <a href="#89b13872d5153f14" class="t t">FileDesiredAccess</a> <span id="r1035 rd" class="r1035 r">accessMode</span>)
        {
            <span class="i">IntPtr</span> <span id="r1036 rd" class="r1036 r">nativeHandle</span> = <span class="i">CreateFile</span>(<span class="r1034 r">reparsePoint</span>, <span class="r1035 r">accessMode</span>,
                <a href="#44bf171c7413eedd" class="t t">FileShareMode</a>.<a href="#af51eedea87c63a3" class="i field">Read</a> | <a href="#44bf171c7413eedd" class="t t">FileShareMode</a>.<a href="#1b446288dce9353b" class="i field">Write</a> | <a href="#44bf171c7413eedd" class="t t">FileShareMode</a>.<a href="#3d9ec8b4f285d58e" class="i field">Delete</a>,
                <span class="i">IntPtr</span>.<span class="i">Zero</span>, <a href="#be8a03c7378c4369" class="t t">FileCreationDisposition</a>.<a href="#c19469d8f8675cd8" class="i field">OpenExisting</a>,
                <a href="#26cffa651e77fb97" class="t t">FileAttributes</a>.<a href="#c62d515ae553ed70" class="i field">BackupSemantics</a> | <a href="#26cffa651e77fb97" class="t t">FileAttributes</a>.<a href="#06bfbdbd75104a4b" class="i field">OpenReparsePoint</a>,
                <span class="i">IntPtr</span>.<span class="i">Zero</span>);
 
            <b>int</b> <span id="r1037 rd" class="r1037 r">lastError</span> = <span class="i">Marshal</span>.<span class="i">GetLastWin32Error</span>();
 
            <b>if</b> (<span class="r1037 r">lastError</span> != 0)
                <b>throw</b> <b>new</b> <span class="i">Win32Exception</span>(<span class="r1037 r">lastError</span>);
 
            <span class="i">SafeFileHandle</span> <span id="r1038 rd" class="r1038 r">reparsePointHandle</span> = <b>new</b> <span class="i">SafeFileHandle</span>(<span class="r1036 r">nativeHandle</span>, <b>true</b>);
 
            <b>return</b> <span class="r1038 r">reparsePointHandle</span>;
        }
    }
 
    <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
}
 
<b>namespace</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Internal</span>
{
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">UNIX</span>
    <span class="k preprocess">#</span><span class="k preprocess">region</span> AlternateDataStreamUtilities
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Represents alternate stream data retrieved from a file.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>public class</b> <a id="bed6b027cd443111" href="../R/bed6b027cd443111.html" target="n" data-glyph="0,0" class="t t"><span id="df0e6a62bdd971fd">AlternateStreamData</span></a>
    {
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The name of the file that holds this stream.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public string</b> <a id="cb0e97fee3583beb" href="../R/cb0e97fee3583beb.html" target="n" data-glyph="102,1" class="i property">FileName</a> { <b>get</b>; <b>set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The name of this stream.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public string</b> <a id="74a4aa230d954592" href="../R/74a4aa230d954592.html" target="n" data-glyph="102,1" class="i property">Stream</a> { <b>get</b>; <b>set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The length of this stream.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public long</b> <a id="215a5507abb32b64" href="../R/215a5507abb32b64.html" target="n" data-glyph="102,1" class="i property">Length</a> { <b>get</b>; <b>set</b>; }
    }
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Provides access to alternate data streams on a file.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    [<span class="i n">System</span>.<span class="i n">Diagnostics</span>.<span class="i">CodeAnalysis</span>.<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.MSInternal&quot;</span>, <span class="s">&quot;CA903:InternalNamespaceShouldNotContainPublicTypes&quot;</span>,
        <span class="i">Justification</span> = <span class="s">&quot;Needed by both the FileSystem provider and Unblock-File cmdlet.&quot;</span>)]
    <b>public static class</b> <a id="28276e8c322107d7" href="../R/28276e8c322107d7.html" target="n" data-glyph="0,0" class="t t">AlternateDataStreamUtilities</a>
    {
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> List all of the streams on a file.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r1039 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The fully-qualified path to the file.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">The list of streams (and their size) in the file.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal static</b> <span class="i">List</span>&lt;<a href="#bed6b027cd443111" class="t t">AlternateStreamData</a>&gt; <a id="adddf7aa6cd82f10" href="../R/../../0000000000.html" target="n" data-glyph="74,1" class="i method">GetStreams</a>(<b>string</b> <span id="r1039 rd" class="r1039 r">path</span>)
        {
            <b>if</b> (<span class="r1039 r">path</span> == <b>null</b>) <b>throw</b> <b>new</b> <span class="i">ArgumentNullException</span>(<b>nameof</b>(<span class="r1039 r">path</span>));
 
            <span class="i">List</span>&lt;<a href="#bed6b027cd443111" class="t t">AlternateStreamData</a>&gt; <span id="r1040 rd" class="r1040 r">alternateStreams</span> = <b>new</b> <span class="i">List</span>&lt;<a href="#bed6b027cd443111" class="t t">AlternateStreamData</a>&gt;();
 
            <a href="#f13eeee5415629de" class="t t">AlternateStreamNativeData</a> <span id="r1041 rd" class="r1041 r">findStreamData</span> = <b>new</b> <span class="t">AlternateStreamNativeData</span>();
 
            <a href="#17ab00f39925dee1" class="t t">SafeFindHandle</a> <span id="r1042 rd" class="r1042 r">handle</span> = <a href="#8683c4e037a7b912" class="t t">NativeMethods</a>.<a href="#7000562b365b0f12" class="i method">FindFirstStreamW</a>(
                <span class="r1039 r">path</span>, <a href="#8683c4e037a7b912" class="t t">NativeMethods</a>.<a href="#37d2427eefecd850" class="t t">StreamInfoLevels</a>.<a href="#1befbcaf789c021f" class="i field">FindStreamInfoStandard</a>,
                <span class="r1041 r">findStreamData</span>, 0);
 
            <b>if</b> (<span class="r1042 r">handle</span>.<span class="i">IsInvalid</span>)
            {
                <b>int</b> <span id="r1043 rd" class="r1043 r">error</span> = <span class="i">Marshal</span>.<span class="i">GetLastWin32Error</span>();
 
                <span class="c">// Directories don&#39;t normally have alternate streams, so this is not an exceptional state.</span>
                <span class="c">// If a directory has no alternate data streams, FindFirstStreamW returns ERROR_HANDLE_EOF.</span>
                <b>if</b> (<span class="r1043 r">error</span> == <a href="#8683c4e037a7b912" class="t t">NativeMethods</a>.<a href="#0b44b131b5b1a8e4" class="i field">ERROR_HANDLE_EOF</a>)
                {
                    <b>return</b> <span class="r1040 r">alternateStreams</span>;
                }
 
                <span class="c">// An unexpected error was returned, that we don&#39;t know how to interpret. The most helpful</span>
                <span class="c">// thing we can do at this point is simply throw the raw Win32 exception.</span>
                <b>throw</b> <b>new</b> <span class="i">Win32Exception</span>(<span class="r1043 r">error</span>);
            }
 
            <b>try</b>
            {
                <b>do</b>
                {
                    <span class="c">// Remove the leading &#39;:&#39;</span>
                    <span class="r1041 r">findStreamData</span>.<a href="#b843615af3532172" class="i field">Name</a> = <span class="r1041 r">findStreamData</span>.<a href="#b843615af3532172" class="i field">Name</a>.<span class="i">Substring</span>(1);
 
                    <span class="c">// And trailing :$DATA (as long as it&#39;s not the default data stream)</span>
                    <b>const string</b> <span id="r1044 rd" class="r1044 r">dataStream</span> = <span class="s">&quot;:$DATA&quot;</span>;
                    <b>if</b> (!<b>string</b>.<span class="i">Equals</span>(<span class="r1041 r">findStreamData</span>.<a href="#b843615af3532172" class="i field">Name</a>, <span class="r1044 r">dataStream</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
                    {
                        <span class="r1041 r">findStreamData</span>.<a href="#b843615af3532172" class="i field">Name</a> = <span class="r1041 r">findStreamData</span>.<a href="#b843615af3532172" class="i field">Name</a>.<span class="i">Replace</span>(<span class="r1044 r">dataStream</span>, <b>string</b>.<span class="i">Empty</span>);
                    }
 
                    <a href="#bed6b027cd443111" class="t t">AlternateStreamData</a> <span id="r1045 rd" class="r1045 r">data</span> = <b>new</b> <span class="t">AlternateStreamData</span>();
                    <span class="r1045 r">data</span>.<a href="#74a4aa230d954592" class="i property">Stream</a> = <span class="r1041 r">findStreamData</span>.<a href="#b843615af3532172" class="i field">Name</a>;
                    <span class="r1045 r">data</span>.<a href="#215a5507abb32b64" class="i property">Length</a> = <span class="r1041 r">findStreamData</span>.<a href="#d146511fd25185ec" class="i field">Length</a>;
                    <span class="r1045 r">data</span>.<a href="#cb0e97fee3583beb" class="i property">FileName</a> = <span class="r1039 r">path</span>.<span class="i">Replace</span>(<span class="r1045 r">data</span>.<a href="#74a4aa230d954592" class="i property">Stream</a>, <b>string</b>.<span class="i">Empty</span>);
                    <span class="r1045 r">data</span>.<a href="#cb0e97fee3583beb" class="i property">FileName</a> = <span class="r1045 r">data</span>.<a href="#cb0e97fee3583beb" class="i property">FileName</a>.<span class="i">Trim</span>(<a href="../engine/Utils.cs.html#9185d6ecbaebbec0" class="t t">Utils</a>.<a href="../engine/Utils.cs.html#6fd6d3492cb91f87" class="t t">Separators</a>.<a href="../engine/Utils.cs.html#464cd2b65728c452" class="i field">Colon</a>);
 
                    <span class="r1040 r">alternateStreams</span>.<span class="i">Add</span>(<span class="r1045 r">data</span>);
                    <span class="r1041 r">findStreamData</span> = <b>new</b> <span class="t">AlternateStreamNativeData</span>();
                }
                <b>while</b> (<a href="#8683c4e037a7b912" class="t t">NativeMethods</a>.<a href="#7504a53296804801" class="i method">FindNextStreamW</a>(<span class="r1042 r">handle</span>, <span class="r1041 r">findStreamData</span>));
 
                <b>int</b> <span id="r1046 rd" class="r1046 r">lastError</span> = <span class="i">Marshal</span>.<span class="i">GetLastWin32Error</span>();
                <b>if</b> (<span class="r1046 r">lastError</span> != <a href="#8683c4e037a7b912" class="t t">NativeMethods</a>.<a href="#0b44b131b5b1a8e4" class="i field">ERROR_HANDLE_EOF</a>)
                    <b>throw</b> <b>new</b> <span class="i">Win32Exception</span>(<span class="r1046 r">lastError</span>);
            }
            <b>finally</b> { <span class="r1042 r">handle</span>.<span class="i">Dispose</span>(); }
 
            <b>return</b> <span class="r1040 r">alternateStreams</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Creates a file stream on a file.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r1047 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The fully-qualified path to the file.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r1048 r">streamName</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The name of the alternate data stream to open.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r1049 r">mode</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The FileMode of the file.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r1050 r">access</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The FileAccess of the file.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r1051 r">share</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The FileShare of the file.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">A FileStream that can be used to interact with the file.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal static</b> <span class="i">FileStream</span> <a id="a2e973b96e499bce" href="../R/a2e973b96e499bce.html" target="n" data-glyph="74,1" class="i method">CreateFileStream</a>(<b>string</b> <span id="r1047 rd" class="r1047 r">path</span>, <b>string</b> <span id="r1048 rd" class="r1048 r">streamName</span>, <span class="i">FileMode</span> <span id="r1049 rd" class="r1049 r">mode</span>, <span class="i">FileAccess</span> <span id="r1050 rd" class="r1050 r">access</span>, <span class="i">FileShare</span> <span id="r1051 rd" class="r1051 r">share</span>)
        {
            <b>if</b> (!<a href="#534de1965a1fbc43" class="i method">TryCreateFileStream</a>(<span class="r1047 r">path</span>, <span class="r1048 r">streamName</span>, <span class="r1049 r">mode</span>, <span class="r1050 r">access</span>, <span class="r1051 r">share</span>, <b>out</b> <b>var</b> <span id="r1052 rd" class="r1052 r">stream</span>))
            {
                <b>string</b> <span id="r1053 rd" class="r1053 r">errorMessage</span> = <a href="../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(
                    <span class="i">FileSystemProviderStrings</span>.<span class="i">AlternateDataStreamNotFound</span>, <span class="r1048 r">streamName</span>, <span class="r1047 r">path</span>);
                <b>throw</b> <b>new</b> <span class="i">FileNotFoundException</span>(<span class="r1053 r">errorMessage</span>, <span class="s">$&quot;</span>{<span class="r1047 r">path</span>}<span class="s">:</span>{<span class="r1048 r">streamName</span>}<span class="s">&quot;</span>);
            }
 
            <b>return</b> <span class="r1052 r">stream</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Tries to create a file stream on a file.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r1054 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The fully-qualified path to the file.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r1055 r">streamName</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The name of the alternate data stream to open.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r1056 r">mode</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The FileMode of the file.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r1057 r">access</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The FileAccess of the file.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r1058 r">share</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The FileShare of the file.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r1059 r">stream</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">A FileStream that can be used to interact with the file.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">True if the stream was successfully created, otherwise false.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal static bool</b> <a id="534de1965a1fbc43" href="../R/534de1965a1fbc43.html" target="n" data-glyph="74,1" class="i method">TryCreateFileStream</a>(<b>string</b> <span id="r1054 rd" class="r1054 r">path</span>, <b>string</b> <span id="r1055 rd" class="r1055 r">streamName</span>, <span class="i">FileMode</span> <span id="r1056 rd" class="r1056 r">mode</span>, <span class="i">FileAccess</span> <span id="r1057 rd" class="r1057 r">access</span>, <span class="i">FileShare</span> <span id="r1058 rd" class="r1058 r">share</span>, <b>out</b> <span class="i">FileStream</span> <span id="r1059 rd" class="r1059 r">stream</span>)
        {
            <b>if</b> (<span class="r1054 r">path</span> == <b>null</b>)
            {
                <b>throw</b> <b>new</b> <span class="i">ArgumentNullException</span>(<b>nameof</b>(<span class="r1054 r">path</span>));
            }
 
            <b>if</b> (<span class="r1055 r">streamName</span> == <b>null</b>)
            {
                <b>throw</b> <b>new</b> <span class="i">ArgumentNullException</span>(<b>nameof</b>(<span class="r1055 r">streamName</span>));
            }
 
            <b>if</b> (<span class="r1056 r">mode</span> == <span class="i">FileMode</span>.<span class="i">Append</span>)
            {
                <span class="r1056 r">mode</span> = <span class="i">FileMode</span>.<span class="i">OpenOrCreate</span>;
            }
 
            <b>var</b> <span id="r1060 rd" class="r1060 r">resultPath</span> = <span class="s">$&quot;</span>{<span class="r1054 r">path</span>}<span class="s">:</span>{<span class="r1055 r">streamName</span>}<span class="s">&quot;</span>;
            <span class="i">SafeFileHandle</span> <span id="r1061 rd" class="r1061 r">handle</span> = <a href="#8683c4e037a7b912" class="t t">NativeMethods</a>.<span class="i">CreateFile</span>(<span class="r1060 r">resultPath</span>, <span class="r1057 r">access</span>, <span class="r1058 r">share</span>, <span class="i">IntPtr</span>.<span class="i">Zero</span>, <span class="r1056 r">mode</span>, 0, <span class="i">IntPtr</span>.<span class="i">Zero</span>);
 
            <b>if</b> (<span class="r1061 r">handle</span>.<span class="i">IsInvalid</span>)
            {
                <span class="r1059 r">stream</span> = <b>null</b>;
                <b>return</b> <b>false</b>;
            }
 
            <span class="r1059 r">stream</span> = <b>new</b> <span class="i">FileStream</span>(<span class="r1061 r">handle</span>, <span class="r1057 r">access</span>);
            <b>return</b> <b>true</b>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Removes an alternate data stream.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r1062 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The path to the file.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r1063 r">streamName</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The name of the alternate data stream to delete.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal static void</b> <a id="5c42dacceaf182a5" href="../R/../../0000000000.html" target="n" data-glyph="74,1" class="i method">DeleteFileStream</a>(<b>string</b> <span id="r1062 rd" class="r1062 r">path</span>, <b>string</b> <span id="r1063 rd" class="r1063 r">streamName</span>)
        {
            <b>if</b> (<span class="r1062 r">path</span> == <b>null</b>) <b>throw</b> <b>new</b> <span class="i">ArgumentNullException</span>(<b>nameof</b>(<span class="r1062 r">path</span>));
            <b>if</b> (<span class="r1063 r">streamName</span> == <b>null</b>) <b>throw</b> <b>new</b> <span class="i">ArgumentNullException</span>(<b>nameof</b>(<span class="r1063 r">streamName</span>));
 
            <b>string</b> <span id="r1064 rd" class="r1064 r">adjustedStreamName</span> = <span class="r1063 r">streamName</span>.<span class="i">Trim</span>();
            <b>if</b> (<span class="r1064 r">adjustedStreamName</span>.<span class="i">IndexOf</span>(<span class="s">&#39;:&#39;</span>) != 0)
            {
                <span class="r1064 r">adjustedStreamName</span> = <span class="s">&quot;:&quot;</span> + <span class="r1064 r">adjustedStreamName</span>;
            }
 
            <b>string</b> <span id="r1065 rd" class="r1065 r">resultPath</span> = <span class="r1062 r">path</span> + <span class="r1064 r">adjustedStreamName</span>;
 
            <span class="i">File</span>.<span class="i">Delete</span>(<span class="r1065 r">resultPath</span>);
        }
 
        <b>internal static void</b> <a id="a1675011820bb41f" href="../R/../../0000000000.html" target="n" data-glyph="74,1" class="i method">SetZoneOfOrigin</a>(<b>string</b> <span id="r1066 rd" class="r1066 r">path</span>, <span class="i">SecurityZone</span> <span id="r1067 rd" class="r1067 r">securityZone</span>)
        {
            <b>using</b> (<span class="i">FileStream</span> <span id="r1068 rd" class="r1068 r">fileStream</span> = <span class="i">CreateFileStream</span>(<span class="r1066 r">path</span>, <span class="s">&quot;Zone.Identifier&quot;</span>, <span class="i">FileMode</span>.<span class="i">Create</span>, <span class="i">FileAccess</span>.<span class="i">Write</span>, <span class="i">FileShare</span>.<span class="i">None</span>))
            <b>using</b> (<span class="i">TextWriter</span> <span id="r1069 rd" class="r1069 r">textWriter</span> = <b>new</b> <span class="i">StreamWriter</span>(<span class="r1068 r">fileStream</span>, <span class="i">Encoding</span>.<span class="i">Unicode</span>))
            {
                <span class="r1069 r">textWriter</span>.<span class="i">WriteLine</span>(<span class="s">&quot;[ZoneTransfer]&quot;</span>);
                <span class="r1069 r">textWriter</span>.<span class="i">WriteLine</span>(<span class="s">&quot;ZoneId={0}&quot;</span>, (<b>int</b>)<span class="r1067 r">securityZone</span>);
            }
 
            <span class="c">// an alternative is to use IAttachmentExecute interface as described here:</span>
            <span class="c">// http://joco.name/2010/12/22/windows-antivirus-api-in-net-and-a-com-interop-crash-course/</span>
            <span class="c">// the code above seems cleaner and more robust than the IAttachmentExecute approach</span>
        }
 
        <b>internal static class</b> <a id="8683c4e037a7b912" href="../R/8683c4e037a7b912.html" target="n" data-glyph="2,1" class="t t">NativeMethods</a>
        {
            <b>internal const int</b> <a id="0b44b131b5b1a8e4" href="../R/0b44b131b5b1a8e4.html" target="n" data-glyph="8,2" class="i field">ERROR_HANDLE_EOF</a> = 38;
            <b>internal const int</b> <a id="c30f367b1b255292" href="../R/../../0000000000.html" target="n" data-glyph="8,2" class="i field">ERROR_INVALID_PARAMETER</a> = 87;
 
            <b>internal enum</b> <a id="37d2427eefecd850" href="../R/37d2427eefecd850.html" target="n" data-glyph="20,2" class="t t"><span id="b35c6f15d784738a">StreamInfoLevels</span></a> { <a id="1befbcaf789c021f" href="../R/1befbcaf789c021f.html" target="n" data-glyph="24,3" class="i field">FindStreamInfoStandard</a> = 0 }
 
            [<span class="i">DllImport</span>(<a href="../utils/PInvokeDllNames.cs.html#6c73838805dd2f2a" class="t t">PinvokeDllNames</a>.<a href="../utils/PInvokeDllNames.cs.html#c72846465597e9c7" class="i field">CreateFileDllName</a>, <span class="i">CharSet</span> = <span class="i">CharSet</span>.<span class="i">Unicode</span>, <span class="i">SetLastError</span> = <b>true</b>)]
            <b>internal static extern</b> <span class="i">SafeFileHandle</span> <a id="cba16464b8cf8188" href="../R/../../0000000000.html" target="n" data-glyph="74,2" class="i method">CreateFile</a>(<b>string</b> <span id="r1070 rd" class="r1070 r">lpFileName</span>,
                <span class="i">FileAccess</span> <span id="r1071 rd" class="r1071 r">dwDesiredAccess</span>, <span class="i">FileShare</span> <span id="r1072 rd" class="r1072 r">dwShareMode</span>,
                <span class="i">IntPtr</span> <span id="r1073 rd" class="r1073 r">lpSecurityAttributes</span>, <span class="i">FileMode</span> <span id="r1074 rd" class="r1074 r">dwCreationDisposition</span>,
                <b>int</b> <span id="r1075 rd" class="r1075 r">dwFlagsAndAttributes</span>, <span class="i">IntPtr</span> <span id="r1076 rd" class="r1076 r">hTemplateFile</span>);
 
            [<span class="i">DllImport</span>(<span class="s">&quot;kernel32.dll&quot;</span>, <span class="i">ExactSpelling</span> = <b>true</b>, <span class="i">CharSet</span> = <span class="i">CharSet</span>.<span class="i">Unicode</span>, <span class="i">SetLastError</span> = <b>true</b>)]
            [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Globalization&quot;</span>, <span class="s">&quot;CA2101:SpecifyMarshalingForPInvokeStringArguments&quot;</span>, <span class="i">MessageId</span> = <span class="s">&quot;AlternateStreamNativeData.Name&quot;</span>)]
            <b>internal static extern</b> <a href="#17ab00f39925dee1" class="t t">SafeFindHandle</a> <a id="7000562b365b0f12" href="../R/7000562b365b0f12.html" target="n" data-glyph="74,2" class="i method">FindFirstStreamW</a>(
                <b>string</b> <span id="r1077 rd" class="r1077 r">lpFileName</span>, <a href="#37d2427eefecd850" class="t t">StreamInfoLevels</a> <span id="r1078 rd" class="r1078 r">InfoLevel</span>,
                [<span class="i">In</span>, <span class="i">Out</span>, <span class="i">MarshalAs</span>(<span class="i">UnmanagedType</span>.<span class="i">LPStruct</span>)]
                <a href="#f13eeee5415629de" class="t t">AlternateStreamNativeData</a> <span id="r1079 rd" class="r1079 r">lpFindStreamData</span>, <b>uint</b> <span id="r1080 rd" class="r1080 r">dwFlags</span>);
 
            [<span class="i">DllImport</span>(<span class="s">&quot;kernel32.dll&quot;</span>, <span class="i">ExactSpelling</span> = <b>true</b>, <span class="i">CharSet</span> = <span class="i">CharSet</span>.<span class="i">Unicode</span>, <span class="i">SetLastError</span> = <b>true</b>)]
            [<b>return</b>: <span class="i">MarshalAs</span>(<span class="i">UnmanagedType</span>.<span class="i">Bool</span>)]
            [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Globalization&quot;</span>, <span class="s">&quot;CA2101:SpecifyMarshalingForPInvokeStringArguments&quot;</span>, <span class="i">MessageId</span> = <span class="s">&quot;AlternateStreamNativeData.Name&quot;</span>)]
            <b>internal static extern bool</b> <a id="7504a53296804801" href="../R/7504a53296804801.html" target="n" data-glyph="74,2" class="i method">FindNextStreamW</a>(
                <a href="#17ab00f39925dee1" class="t t">SafeFindHandle</a> <span id="r1081 rd" class="r1081 r">hndFindFile</span>,
                [<span class="i">In</span>, <span class="i">Out</span>, <span class="i">MarshalAs</span>(<span class="i">UnmanagedType</span>.<span class="i">LPStruct</span>)]
                <a href="#f13eeee5415629de" class="t t">AlternateStreamNativeData</a> <span id="r1082 rd" class="r1082 r">lpFindStreamData</span>);
        }
 
        <b>internal sealed class</b> <a id="17ab00f39925dee1" href="../R/17ab00f39925dee1.html" target="n" data-glyph="2,1" class="t t">SafeFindHandle</a> : <span class="i">SafeHandleZeroOrMinusOneIsInvalid</span>
        {
            <b>private</b> <a id="3cf0ca8c35082b8a" href="../R/../../0000000000.html" target="n" data-glyph="76,2" class="t constructor">SafeFindHandle</a>() : <b>base</b>(<b>true</b>) { }
 
            <b>protected override bool</b> <a id="bcd411bf91bf7a47" href="../R/../../0000000000.html" target="n" data-glyph="75,2" class="i method">ReleaseHandle</a>()
            {
                <b>return</b> <span class="i">FindClose</span>(<a href="#17ab00f39925dee1" class="k">this</a>.<span class="i">handle</span>);
            }
 
            [<span class="i">DllImport</span>(<a href="../utils/PInvokeDllNames.cs.html#6c73838805dd2f2a" class="t t">PinvokeDllNames</a>.<a href="../utils/PInvokeDllNames.cs.html#d0d2e1a53b9555d0" class="i field">FindCloseDllName</a>)]
            [<b>return</b>: <span class="i">MarshalAs</span>(<span class="i">UnmanagedType</span>.<span class="i">Bool</span>)]
            <b>private static extern bool</b> <a id="33d0dc6594355c1a" href="../R/../../0000000000.html" target="n" data-glyph="76,2" class="i method">FindClose</a>(<span class="i">IntPtr</span> <span id="r1083 rd" class="r1083 r">handle</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Represents alternate stream data retrieved from a file.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">StructLayout</span>(<span class="i">LayoutKind</span>.<span class="i">Sequential</span>, <span class="i">CharSet</span> = <span class="i">CharSet</span>.<span class="i">Unicode</span>)]
        <b>internal class</b> <a id="f13eeee5415629de" href="../R/f13eeee5415629de.html" target="n" data-glyph="2,1" class="t t"><span id="21e9de661041f3ae">AlternateStreamNativeData</span></a>
        {
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> The length of this stream.</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
            <b>public long</b> <a id="d146511fd25185ec" href="../R/d146511fd25185ec.html" target="n" data-glyph="42,2" class="i field">Length</a>;
 
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> The name of this stream.</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
            [<span class="i">MarshalAs</span>(<span class="i">UnmanagedType</span>.<span class="i">ByValTStr</span>, <span class="i">SizeConst</span> = 296)]
            <b>public string</b> <a id="b843615af3532172" href="../R/b843615af3532172.html" target="n" data-glyph="42,2" class="i field">Name</a>;
        }
    }
 
    <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
 
    <span class="k preprocess">#</span><span class="k preprocess">region</span> CopyFileFromRemoteUtils
 
    <b>internal static class</b> <a id="18b0063a4d2c0d48" href="../R/18b0063a4d2c0d48.html" target="n" data-glyph="2,0" class="t t">CopyFileRemoteUtils</a>
    {
        <b>private const string</b> <a id="17901e631197a52f" href="../R/17901e631197a52f.html" target="n" data-glyph="10,1" class="i field">functionToken</a> = <span class="s">&quot;function &quot;</span>;
        <b>private const string</b> <a id="23b629ca925fbcc1" href="../R/23b629ca925fbcc1.html" target="n" data-glyph="10,1" class="i field">nameToken</a> = <span class="s">&quot;Name&quot;</span>;
        <b>private const string</b> <a id="68845a09b9c590b4" href="../R/68845a09b9c590b4.html" target="n" data-glyph="10,1" class="i field">definitionToken</a> = <span class="s">&quot;Definition&quot;</span>;
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> PSCopyToSessionHelper
 
        <b>internal const string</b> <a id="3bb0f47e99c017c4" href="../R/3bb0f47e99c017c4.html" target="n" data-glyph="8,1" class="i field">PSCopyToSessionHelperName</a> = <span class="s">@&quot;PSCopyToSessionHelper&quot;</span>;
 
        <b>private static readonly string</b> <a id="51686e306b0747b6" href="../R/51686e306b0747b6.html" target="n" data-glyph="46,1" class="i field">s_driveMaxSizeErrorFormatString</a> = <span class="i">FileSystemProviderStrings</span>.<span class="i">DriveMaxSizeError</span>;
        <b>private static readonly string</b> <a id="2d4abdfe9653b29f" href="../R/2d4abdfe9653b29f.html" target="n" data-glyph="46,1" class="i field">s_PSCopyToSessionHelperDefinition</a> = <a href="../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<a href="../utils/StringUtil.cs.html#2212180d4582cc59" class="i method">Format</a>(<a href="#8c5fdaa529a41aa0" class="i field">PSCopyToSessionHelperDefinitionFormat</a>, <span class="s">@&quot;[ValidateNotNullOrEmpty()]&quot;</span>, <a href="#51686e306b0747b6" class="i field">s_driveMaxSizeErrorFormatString</a>);
        <b>private static readonly string</b> <a id="9850f9d3f14029b2" href="../R/9850f9d3f14029b2.html" target="n" data-glyph="46,1" class="i field">s_PSCopyToSessionHelperDefinitionRestricted</a> = <a href="../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<a href="../utils/StringUtil.cs.html#2212180d4582cc59" class="i method">Format</a>(<a href="#8c5fdaa529a41aa0" class="i field">PSCopyToSessionHelperDefinitionFormat</a>, <span class="s">@&quot;[ValidateUserDrive()]&quot;</span>, <a href="#51686e306b0747b6" class="i field">s_driveMaxSizeErrorFormatString</a>);
 
        <b>private const string</b> <a id="8c5fdaa529a41aa0" href="../R/8c5fdaa529a41aa0.html" target="n" data-glyph="10,1" class="i field">PSCopyToSessionHelperDefinitionFormat</a> = <span class="s">@&quot;
        param (
            [Parameter(ParameterSetName=&quot;&quot;PSCopyFileToRemoteSession&quot;&quot;)]
            [Parameter(ParameterSetName=&quot;&quot;PSCopyAlternateStreamToRemoteSession&quot;&quot;)]
            {0}
 
            [string] $copyToFilePath,
 
            [Parameter(ParameterSetName=&quot;&quot;PSCopyFileToRemoteSession&quot;&quot;, Mandatory=$false)]
            [Parameter(ParameterSetName=&quot;&quot;PSCopyAlternateStreamToRemoteSession&quot;&quot;)]
            [ValidateNotNullOrEmpty()]
            [string] $b64Fragment,
 
            [Parameter(ParameterSetName=&quot;&quot;PSCopyFileToRemoteSession&quot;&quot;)]
            [switch] $createFile = $false,
 
            [Parameter(ParameterSetName=&quot;&quot;PSCopyFileToRemoteSession&quot;&quot;)]
            [switch] $emptyFile = $false,
 
            [Parameter(ParameterSetName=&quot;&quot;PSCopyAlternateStreamToRemoteSession&quot;&quot;, Mandatory=$true)]
            [ValidateNotNullOrEmpty()]
            [string] $streamName,
 
            [Parameter(ParameterSetName=&quot;&quot;PSTargetSupportsAlternateStreams&quot;&quot;, Mandatory=$true)]
            {0}
 
            [string] $supportAltStreamPath,
 
            [Parameter(ParameterSetName=&quot;&quot;PSSetFileMetadata&quot;&quot;, Mandatory=$true)]
            {0}
 
            [string] $metaDataFilePath,
 
            [Parameter(ParameterSetName=&quot;&quot;PSSetFileMetadata&quot;&quot;, Mandatory=$true)]
            [ValidateNotNull()]
            [hashtable] $metaDataToSet,
 
            [Parameter(ParameterSetName=&quot;&quot;PSRemoteDestinationPathIsFile&quot;&quot;, Mandatory=$true)]
            {0}
 
            [string] $isFilePath,
 
            [Parameter(ParameterSetName=&quot;&quot;PSGetRemotePathInfo&quot;&quot;, Mandatory=$true)]
            {0}
 
            [string] $remotePath,
 
            [Parameter(ParameterSetName=&quot;&quot;PSCreateDirectoryOnRemoteSession&quot;&quot;, Mandatory=$true)]
            {0}
 
            [string] $createDirectoryPath,
 
            [Parameter(ParameterSetName=&quot;&quot;PSCreateDirectoryOnRemoteSession&quot;&quot;)]
            [switch] $force
        )
 
        # Checks if path drive specifies max size and if max size is exceeded
        #
        function CheckPSDriveSize
        {{
            param (
                [System.Management.Automation.PathInfo] $resolvedPath,
                [int] $fragmentLength
            )
 
            if (($null -ne $resolvedPath.Drive) -and ($null -ne $resolvedPath.Drive.MaximumSize))
            {{
                $maxUserSize = $resolvedPath.Drive.MaximumSize
                $dirSize = 0
                Microsoft.PowerShell.Management\Get-ChildItem -LiteralPath ($resolvedPath.Drive.Name + &quot;&quot;:&quot;&quot;) -Recurse | ForEach-Object {{
                    Microsoft.PowerShell.Management\Get-Item -LiteralPath $_.FullName -Stream * | ForEach-Object {{ $dirSize += $_.Length }}
                }}
 
                if (($dirSize + $fragmentLength) -gt $maxUserSize)
                {{
                    $msg = &quot;&quot;{1}&quot;&quot; -f $maxUserSize
                    throw $msg
                }}
            }}
        }}
 
        # Return a hashtable with the following members:
        #    BytesWritten - the number of bytes written to a file
        #
        function PSCopyFileToRemoteSession
        {{
            param(
                [string] $copyToFilePath,
                [string] $b64Fragment,
                [switch] $createFile = $false,
                [switch] $emptyFile = $false
            )
 
            $op = @{{
                BytesWritten = $null
            }}
 
            $wstream = $null
 
            try
            {{
                $filePathExists = Microsoft.PowerShell.Management\Test-Path -Path $copyToFilePath
 
                if ($createFile -or (! $filePathExists))
                {{
                    # If the file already exists, try to delete it.
                    if ($filePathExists)
                    {{
                        Microsoft.PowerShell.Management\Remove-Item -Path $copyToFilePath -Force -ea SilentlyContinue
                    }}
 
                    # Create the new file.
                    $fileInfo = Microsoft.PowerShell.Management\New-Item -Path $copyToFilePath -Type File -Force
 
                    if ($emptyFile)
                    {{
                        # Handle the empty file scenario.
                        $op[&#39;BytesWritten&#39;] = 0
                        return $op
                    }}
                }}
 
                # Resolve path in case it is a PSDrive
                $resolvedPath = Microsoft.PowerShell.Management\Resolve-Path -literal $copyToFilePath
 
                # Decode
                $fragment = [System.Convert]::FromBase64String($b64Fragment)
 
                # Check if drive specifies max size and if max size is exceeded
                CheckPSDriveSize $resolvedPath $fragment.Length
 
                # Write fragment
                $wstream = Microsoft.PowerShell.Utility\New-Object -TypeName IO.FileStream -ArgumentList ($resolvedPath.ProviderPath), ([System.IO.FileMode]::Append)
                $wstream.Write($fragment, 0, $fragment.Length)
 
                $op[&#39;BytesWritten&#39;] = $fragment.Length
            }}
            catch
            {{
                if ($_.Exception.InnerException)
                {{
                    Microsoft.PowerShell.Utility\Write-Error -Exception $_.Exception.InnerException
                }}
                else
                {{
                    Microsoft.PowerShell.Utility\Write-Error -Exception $_.Exception
                }}
            }}
            finally
            {{
                if ($null -ne $wstream)
                {{
                    $wstream.Dispose()
                }}
            }}
 
            return $op
        }}
 
        # Returns a hashtable with the following members:
        #    BytesWritten - number of bytes written to an alternate file stream
        #
        function PSCopyFileAlternateStreamToRemoteSession
        {{
            param (
                [string] $copyToFilePath,
                [string] $b64Fragment,
                [string] $streamName
            )
 
            $op = @{{
                BytesWritten = $null
            }}
 
            try
            {{
                # Resolve path in case it is a PSDrive
                $resolvedPath = Microsoft.PowerShell.Management\Resolve-Path -literal $copyToFilePath
 
                # Decode
                $fragment = [System.Convert]::FromBase64String($b64Fragment)
 
                # Check if drive specifies max size and if max size is exceeded
                CheckPSDriveSize $resolvedPath $fragment.Length
 
                # Write the stream
                Microsoft.PowerShell.Management\Add-Content -Path ($resolvedPath.ProviderPath) -Value $fragment -Encoding Byte -Stream $streamName -ErrorAction Stop
                $op[&#39;BytesWritten&#39;] = $fragment.Length
            }}
            catch
            {{
                Microsoft.PowerShell.Utility\Write-Error -Exception $_.Exception
            }}
 
            return $op
        }}
 
        # Returns a hashtable with the following member:
        #    TargetSupportsAlternateStreams - boolean to keep track of whether the target supports Alternate data streams.
        #
        function PSTargetSupportsAlternateStreams
        {{
            param (
                [string] $supportAltStreamPath
            )
 
            $result = @{{
                TargetSupportsAlternateStreams = $false
            }}
 
            # Resolve path in case it is a PSDrive
            $resolvedPath = Microsoft.PowerShell.Management\Resolve-Path -literal $supportAltStreamPath
 
            $targetDrive = [IO.Path]::GetPathRoot($resolvedPath.ProviderPath)
            if (-not $targetDrive)
            {{
                return $result
            }}
 
            # Check if the target drive is NTFS
            $driveFormat = &#39;NTFS&#39;
            foreach ($drive in [System.IO.DriveInfo]::GetDrives())
            {{
                if (($drive.Name -eq $targetDrive) -and ($drive.DriveFormat -eq $driveFormat))
                {{
                    # Now, check if the target supports Add-Command -Stream. This functionality was introduced in version 3.0.
                    $addContentCmdlet = Microsoft.PowerShell.Core\Get-Command Microsoft.PowerShell.Management\Add-Content -ErrorAction SilentlyContinue
                    if ($addContentCmdlet.Parameters.Keys -contains &#39;Stream&#39;)
                    {{
                        $result[&#39;TargetSupportsAlternateStreams&#39;] = $true
                        break
                    }}
                }}
            }}
 
            return $result
        }}
 
        # Sets the metadata for the given file.
        #
        function PSSetFileMetadata
        {{
            param (
                [string] $metaDataFilePath,
                [hashtable] $metaDataToSet
            )
 
            $item = Microsoft.PowerShell.Management\get-item $metaDataFilePath -ea SilentlyContinue -Force
 
            if ($item)
            {{
                # LastWriteTime
                if ($metaDataToSet[&#39;LastWriteTimeUtc&#39;])
                {{
                    $item.LastWriteTimeUtc = $metaDataToSet[&#39;LastWriteTimeUtc&#39;]
                }}
 
                if ($metaDataToSet[&#39;LastWriteTime&#39;])
                {{
                    $item.LastWriteTime = $metaDataToSet[&#39;LastWriteTime&#39;]
                }}
 
                # Attributes
                if ($metaDataToSet[&#39;Attributes&#39;])
                {{
                    $item.Attributes = $metaDataToSet[&#39;Attributes&#39;]
                }}
            }}
        }}
 
        # Returns a hashtable with the following member:
        #    IsFileInfo - boolean to keep track of whether the given path is a remote file.
        #    IsDirectoryInfo - boolean to keep track of whether the given path is a remote directory.
        #    ParentIsDirectoryInfo - boolean to keep track of whether the given parent path is a remote directory.
        #
        function PSGetRemotePathInfo
        {{
            param (
                [string] $remotePath
            )
 
            try
            {{
 
                try
                {{
                    $parentPath = Microsoft.PowerShell.Management\Split-Path $remotePath
                }}
                # catch everything and ignore the error.
                catch {{}}
 
                $result = @{{
                    IsFileInfo = (Microsoft.PowerShell.Management\Test-Path $remotePath -PathType Leaf)
                    IsDirectoryInfo = (Microsoft.PowerShell.Management\Test-Path $remotePath -PathType Container)
                }}
 
                if ($parentPath)
                {{
                    $result[&#39;ParentIsDirectoryInfo&#39;] = (Microsoft.PowerShell.Management\Test-Path $parentPath -PathType Container)
                }}
 
            }}
            catch
            {{
                if ($_.Exception.InnerException)
                {{
                    Microsoft.PowerShell.Utility\Write-Error -Exception $_.Exception.InnerException
                }}
                else
                {{
                    Microsoft.PowerShell.Utility\Write-Error -Exception $_.Exception
                }}
            }}
 
            return $result
        }}
 
        # Returns a hashtable with the following information:
        #  - IsFileInfotrue bool to keep track if the given destination is a FileInfo type.
        function PSRemoteDestinationPathIsFile
        {{
            param (
                [string] $isFilePath
            )
 
            $op = @{{
                IsFileInfo = $null
            }}
 
            try
            {{
                $op[&#39;IsFileInfo&#39;] = (Microsoft.PowerShell.Management\Test-Path $isFilePath -PathType Leaf)
            }}
            catch
            {{
                if ($_.Exception.InnerException)
                {{
                    Microsoft.PowerShell.Utility\Write-Error -Exception $_.Exception.InnerException
                }}
                else
                {{
                    Microsoft.PowerShell.Utility\Write-Error -Exception $_.Exception
                }}
            }}
 
            return $op
        }}
 
        # Return a hash table in the following format:
        #      DirectoryPath is the directory to be created.
        #      PathExists is a bool to to keep track of whether the directory already exist.
        #
        # 1) If DirectoryPath already exists:
        #     a) If -Force is specified, force create the directory. Set DirectoryPath to the created directory path.
        #     b) If not -Force is specified, then set PathExists to $true.
        # 2) If DirectoryPath does not exist, create it. Set DirectoryPath to the created directory path.
        function PSCreateDirectoryOnRemoteSession
        {{
            param (
                [string] $createDirectoryPath,
                [switch] $force = $false
            )
 
            $op = @{{
                DirectoryPath = $null
                PathExists = $false
            }}
 
            try
            {{
                if (Microsoft.PowerShell.Management\Test-Path $createDirectoryPath)
                {{
                    # -Force is specified, then force create the directory.
                    if ($force)
                    {{
                        Microsoft.PowerShell.Management\New-Item $createDirectoryPath -ItemType Directory -Force | Out-Null
                        $op[&#39;DirectoryPath&#39;] = $createDirectoryPath
                    }}
                    else
                    {{
                        $op[&#39;PathExists&#39;] = $true
                    }}
                }}
                else
                {{
                    Microsoft.PowerShell.Management\New-Item $createDirectoryPath -ItemType Directory | Out-Null
                    $op[&#39;DirectoryPath&#39;] = $createDirectoryPath
                }}
            }}
            catch
            {{
                if ($_.Exception.InnerException)
                {{
                    Microsoft.PowerShell.Utility\Write-Error -Exception $_.Exception.InnerException
                }}
                else
                {{
                    Microsoft.PowerShell.Utility\Write-Error -Exception $_.Exception
                }}
            }}
 
            return $op
        }}
 
        #
        # Call helper function based on bound parameter set
        #
        $params = $PSCmdlet.MyInvocation.BoundParameters
        switch ($PSCmdlet.ParameterSetName)
        {{
            &quot;&quot;PSCopyFileToRemoteSession&quot;&quot;
            {{
                return PSCopyFileToRemoteSession @params
            }}
 
            &quot;&quot;PSCopyAlternateStreamToRemoteSession&quot;&quot;
            {{
                return PSCopyFileAlternateStreamToRemoteSession @params
            }}
 
            &quot;&quot;PSTargetSupportsAlternateStreams&quot;&quot;
            {{
                return PSTargetSupportsAlternateStreams @params
            }}
 
            &quot;&quot;PSSetFileMetadata&quot;&quot;
            {{
                return PSSetFileMetadata @params
            }}
 
            &quot;&quot;PSRemoteDestinationPathIsFile&quot;&quot;
            {{
                return PSRemoteDestinationPathIsFile @params
            }}
 
            &quot;&quot;PSGetRemotePathInfo&quot;&quot;
            {{
                return PSGetRemotePathInfo @params
            }}
 
            &quot;&quot;PSCreateDirectoryOnRemoteSession&quot;&quot;
            {{
                return PSCreateDirectoryOnRemoteSession @params
            }}
        }}
        &quot;</span>;
 
        <b>private static readonly string</b> <a id="256c060188254ba7" href="../R/256c060188254ba7.html" target="n" data-glyph="46,1" class="i field">s_PSCopyToSessionHelper</a> = <a href="#17901e631197a52f" class="i field">functionToken</a> + <a href="#3bb0f47e99c017c4" class="i field">PSCopyToSessionHelperName</a> + <span class="s">@&quot;
        {
        &quot;</span> + <a href="#2d4abdfe9653b29f" class="i field">s_PSCopyToSessionHelperDefinition</a> + <span class="s">@&quot;
        }
        &quot;</span>;
 
        <b>private static readonly</b> <span class="i">Hashtable</span> <a id="fd9cb235b5be2209" href="../R/fd9cb235b5be2209.html" target="n" data-glyph="46,1" class="i field">s_PSCopyToSessionHelperFunction</a> = <b>new</b> <span class="i">Hashtable</span>() {
            {<a href="#23b629ca925fbcc1" class="i field">nameToken</a>, <a href="#3bb0f47e99c017c4" class="i field">PSCopyToSessionHelperName</a>},
            {<a href="#68845a09b9c590b4" class="i field">definitionToken</a>, <a href="#9850f9d3f14029b2" class="i field">s_PSCopyToSessionHelperDefinitionRestricted</a>}
        };
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> PSCopyFromSessionHelper
 
        <b>internal const string</b> <a id="7768bae509667d9d" href="../R/7768bae509667d9d.html" target="n" data-glyph="8,1" class="i field">PSCopyFromSessionHelperName</a> = <span class="s">@&quot;PSCopyFromSessionHelper&quot;</span>;
 
        <b>private static readonly string</b> <a id="78bc1c8bb5f2cb5e" href="../R/78bc1c8bb5f2cb5e.html" target="n" data-glyph="46,1" class="i field">s_PSCopyFromSessionHelperDefinition</a> = <a href="../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<a href="../utils/StringUtil.cs.html#6dd43165d0b5d92f" class="i method">Format</a>(<a href="#56e9833a60547d7c" class="i field">PSCopyFromSessionHelperDefinitionFormat</a>, <span class="s">@&quot;[ValidateNotNullOrEmpty()]&quot;</span>);
        <b>private static readonly string</b> <a id="e40be48f2d2b3ca9" href="../R/e40be48f2d2b3ca9.html" target="n" data-glyph="46,1" class="i field">s_PSCopyFromSessionHelperDefinitionRestricted</a> = <a href="../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<a href="../utils/StringUtil.cs.html#6dd43165d0b5d92f" class="i method">Format</a>(<a href="#56e9833a60547d7c" class="i field">PSCopyFromSessionHelperDefinitionFormat</a>, <span class="s">@&quot;[ValidateUserDrive()]&quot;</span>);
 
        <b>private const string</b> <a id="56e9833a60547d7c" href="../R/56e9833a60547d7c.html" target="n" data-glyph="10,1" class="i field">PSCopyFromSessionHelperDefinitionFormat</a> = <span class="s">@&quot;
        param (
            [Parameter(ParameterSetName=&quot;&quot;PSCopyFileFromRemoteSession&quot;&quot;, Mandatory=$true)]
            {0}
 
            [string] $copyFromFilePath,
 
            [Parameter(ParameterSetName=&quot;&quot;PSCopyFileFromRemoteSession&quot;&quot;, Mandatory=$true)]
            [ValidateRange(0, [long]::MaxValue)]
            [long] $copyFromStart,
 
            [Parameter(ParameterSetName=&quot;&quot;PSCopyFileFromRemoteSession&quot;&quot;, Mandatory=$true)]
            [ValidateRange(0, [long]::MaxValue)]
            [long] $copyFromNumBytes,
 
            [Parameter(ParameterSetName=&quot;&quot;PSCopyFileFromRemoteSession&quot;&quot;)]
            [switch] $force,
 
            [Parameter(ParameterSetName=&quot;&quot;PSCopyFileFromRemoteSession&quot;&quot;)]
            [switch] $isAlternateStream,
 
            [Parameter(ParameterSetName=&quot;&quot;PSCopyFileFromRemoteSession&quot;&quot;)]
            [ValidateNotNullOrEmpty()]
            [string] $streamName,
 
            [Parameter(ParameterSetName=&quot;&quot;PSSourceSupportsAlternateStreams&quot;&quot;, Mandatory=$true)]
            {0}
 
            [string] $supportAltStreamPath,
 
            [Parameter(ParameterSetName=&quot;&quot;PSGetFileMetadata&quot;&quot;, Mandatory=$true)]
            {0}
 
            [string] $getMetaFilePath,
 
            [Parameter(ParameterSetName=&quot;&quot;PSGetPathItems&quot;&quot;, Mandatory=$true)]
            {0}
 
            [string] $getPathItems,
 
            [Parameter(ParameterSetName=&quot;&quot;PSGetPathDirAndFiles&quot;&quot;, Mandatory=$true)]
            {0}
 
            [string] $getPathDir
        )
 
        # A hash table with the following members is returned:
        #   - moreAvailable bool to keep track of whether there is more data available
        #   - b64Fragment to track of the number of bytes.
        #   - ExceptionThrown bool to keep track if an exception was thrown
        function PSCopyFileFromRemoteSession
        {{
            param(
                [string] $copyFromFilePath,
                [long] $copyFromStart,
                [long] $copyFromNumbytes,
                [switch] $force = $false,
                [switch] $isAlternateStream = $false,
                [string] $streamName
            )
 
            $finalResult = @{{
                b64Fragment = $null
                moreAvailable = $null
                ExceptionThrown = $false
            }}
 
            function PerformCopyFileFromRemoteSession
            {{
                param(
                    [string] $filePath,
                    [long] $start,
                    [long] $numBytes,
                    [switch] $isAlternateStream,
                    [string] $streamName
                )
 
                $op = @{{
                    b64Fragment = $null
                    moreAvailable = $false
                }}
 
                # Ensure bytes read is less than Max allowed
                $maxBytes = 10 * 1024 * 1024
                $numBytes = [Math]::Min($numBytes, $maxBytes)
 
                $rstream = $null
                try
                {{
                    if ($isAlternateStream)
                    {{
                        $content = Microsoft.PowerShell.Management\Get-Content $filePath -stream $streamName -Encoding Byte -Raw
                        $rstream = [System.IO.MemoryStream]::new($content)
                    }}
                    else
                    {{
                        $rstream = [System.IO.File]::OpenRead($filePath)
                    }}
 
                    # Create a new array to hold the file content
                    if ($start -lt $rstream.Length)
                    {{
                        $o = $rstream.Seek($start, 0)
                        $toRead = [Math]::Min($numBytes, $rstream.Length - $start)
                        $fragment = Microsoft.PowerShell.Utility\New-Object byte[] $toRead
                        $readsoFar = 0
                        while ($readsoFar -lt $toRead)
                        {{
                            $read = $rstream.Read($fragment, $readSoFar, $toRead - $readsoFar)
                            $readsoFar += $read
                        }}
 
                        $op[&#39;b64Fragment&#39;] = [System.Convert]::ToBase64String($fragment)
                        if (($start + $readsoFar) -lt $rstream.Length)
                        {{
                            $op[&#39;moreAvailable&#39;] = $true
                        }}
                    }}
 
                    $op
                }}
                finally
                {{
                    if ($null -ne $rstream)
                    {{
                        $rstream.Dispose()
                    }}
                }}
            }}
 
            function WriteException
            {{
                param ($ex)
 
                if ($ex.Exception.InnerException)
                {{
                    Microsoft.PowerShell.Utility\Write-Error -Exception $ex.Exception.InnerException
                }}
                else
                {{
                    Microsoft.PowerShell.Utility\Write-Error -Exception $ex.Exception
                }}
 
                $finalResult.ExceptionThrown = $true
            }}
 
            # Resolve path in case it is a PSDrive
            $resolvedFilePath = (Microsoft.PowerShell.Management\Resolve-Path -literal $copyFromFilePath).ProviderPath
 
            $unAuthorizedAccessException = $null
            $result = $null
 
            $isReadOnly = $false
            $isHidden = $false
            try
            {{
                $result = PerformCopyFileFromRemoteSession -filePath $resolvedFilePath -start $copyFromStart -numBytes $copyFromNumBytes -isAlternateStream:$isAlternateStream -streamName $streamName
                $finalResult.b64Fragment =  $result.b64Fragment
                $finalResult.moreAvailable =  $result.moreAvailable
            }}
            catch [System.UnauthorizedAccessException]
            {{
                $unAuthorizedAccessException = $_
                if ($force)
                {{
                    $exception = $null
                    try
                    {{
                        # Disable the readonly and hidden attributes and try again
                        $item = Microsoft.PowerShell.Management\Get-Item $resolvedFilePath
 
                        if ($item.Attributes.HasFlag([System.IO.FileAttributes]::Hidden))
                        {{
                            $isHidden = $true
                            $item.Attributes = $item.Attributes -band (-bnot ([System.IO.FileAttributes]::Hidden))
                        }}
 
                        if ($item.Attributes.HasFlag([System.IO.FileAttributes]::ReadOnly))
                        {{
                            $isReadOnly = $true
                            $item.Attributes = $item.Attributes -band (-bnot ([System.IO.FileAttributes]::ReadOnly))
                        }}
 
                        $result = PerformCopyFileFromRemoteSession -filePath $resolvedFilePath -start $copyFromStart -numBytes $copyFromNumBytes -isAlternateStream:$isAlternateStream
                        $finalResult.b64Fragment =  $result.b64Fragment
                        $finalResult.moreAvailable =  $result.moreAvailable
                    }}
                    catch
                    {{
                        $e = $_
                        if (($e.Exception.InnerException -is [System.IO.FileNotFoundException]) -or
                            ($e.Exception.InnerException -is [System.IO.DirectoryNotFoundException]) -or
                            ($e.Exception.InnerException -is [System.Security.SecurityException] ) -or
                            ($e.Exception.InnerException -is [System.ArgumentException]) -or
                            ($e.Exception.InnerException -is [System.IO.IOException]))
                        {{
                            # Write out the original error since we failed to force the copy
                            WriteException $unAuthorizedAccessException
                        }}
                        else
                        {{
                            WriteException $e
                        }}
 
                        $finalResult.ExceptionThrown = $true
                    }}
                }}
                else
                {{
                    $finalResult.ExceptionThrown = $true
                    WriteException $unAuthorizedAccessException
                }}
            }}
            catch
            {{
                WriteException $_
            }}
            finally
            {{
                if ($isReadOnly)
                {{
                    $item.Attributes = $item.Attributes -bor [System.IO.FileAttributes]::ReadOnly
                }}
 
                if ($isHidden)
                {{
                    $item.Attributes = $item.Attributes -bor [System.IO.FileAttributes]::Hidden
                }}
            }}
 
            return $finalResult
        }}
 
        # Returns a hashtable with the following members:
        #    SourceSupportsAlternateStreams - boolean to keep track of whether the source supports Alternate data streams.
        #    Streams - the list of alternate streams
        #
        function PSSourceSupportsAlternateStreams
        {{
            param ([string]$supportAltStreamPath)
 
            $result = @{{
                SourceSupportsAlternateStreams = $false
                Streams = @()
            }}
 
            # Check if the source supports &#39;Get-Content -Stream&#39;. This functionality was introduced in version 3.0.
            $getContentCmdlet = Microsoft.PowerShell.Core\Get-Command Microsoft.PowerShell.Management\Get-Content -ErrorAction SilentlyContinue
            if ($getContentCmdlet.Parameters.Keys -notcontains &#39;Stream&#39;)
            {{
                return $result
            }}
 
            $result[&#39;SourceSupportsAlternateStreams&#39;] = $true
 
            # Check if the file has any alternate data streams.
            $item = Microsoft.PowerShell.Management\Get-Item -Path $supportAltStreamPath -Stream * -ea SilentlyContinue
            if (-not $item)
            {{
                return $result
            }}
 
            foreach ($streamName in $item.Stream)
            {{
                if ($streamName -ne &#39;:$DATA&#39;)
                {{
                    $result[&#39;Streams&#39;] += $streamName
                }}
            }}
 
            return $result
        }}
 
        # Returns a hash table with metadata info about the file for the given path.
        #
        function PSGetFileMetadata
        {{
            param ($getMetaFilePath)
 
            if (-not (Microsoft.PowerShell.Management\Test-Path $getMetaFilePath))
            {{
                return
            }}
 
            $item = Microsoft.PowerShell.Management\Get-Item $getMetaFilePath -Force -ea SilentlyContinue
            if ($item)
            {{
                $metadata = @{{}}
 
                # Attributes
                $attributes = @($item.Attributes.ToString().Split(&#39;,&#39;).Trim())
                if ($attributes.Count -gt 0)
                {{
                    $metadata.Add(&#39;Attributes&#39;, $attributes)
                }}
 
                # LastWriteTime
                $metadata.Add(&#39;LastWriteTime&#39;, $item.LastWriteTime)
                $metadata.Add(&#39;LastWriteTimeUtc&#39;, $item.LastWriteTimeUtc)
 
                return $metadata
            }}
        }}
 
        # Converts file system path to PSDrive path
        #    Returns converted path or original path if not conversion is needed.
        function ConvertToPSDrivePath
        {{
            param (
                [System.Management.Automation.PSDriveInfo] $driveInfo,
                [string] $pathToConvert
            )
 
            if (!($driveInfo) -or !($driveInfo.Name) -or !($driveInfo.Root))
            {{
                return $pathToConvert
            }}
 
            if (! ($driveInfo.Root.StartsWith($driveInfo.Name)))
            {{
                return $pathToConvert.ToUpper().Replace($driveInfo.Root.ToUpper(), (($driveInfo.Name) + &quot;&quot;:&quot;&quot;))
            }}
 
            return $pathToConvert
        }}
 
        ## A hashtable is returned in the following format:
        ##  Exists - Boolean to keep track if the given path exists.
        ##  Items  - The items that Get-Item -Path $path resolves to.
        function PSGetPathItems
        {{
            param (
                [string] $getPathItems
            )
 
            $op = @{{
                Exists = $null
                Items = $null
            }}
 
            try
            {{
                if (-not (Microsoft.PowerShell.Management\Test-Path $getPathItems))
                {{
                    $op[&#39;Exists&#39;] = $false
                    return $op
                }}
 
                $items = @(Microsoft.PowerShell.Management\Get-Item -Path $getPathItems | Microsoft.PowerShell.Core\ForEach-Object {{
                    @{{
                        FullName = ConvertToPSDrivePath $_.PSDrive $_.FullName;
                        Name = $_.Name;
                        FileSize = $_.Length; IsDirectory = $_ -is [System.IO.DirectoryInfo]
                     }}
                }})
                $op[&#39;Exists&#39;] = $true
                $op[&#39;Items&#39;] = $items
 
                return $op
            }}
            catch
            {{
                if ($_.Exception.InnerException)
                {{
                    Microsoft.PowerShell.Utility\Write-Error -Exception $_.Exception.InnerException
                }}
                else
                {{
                    Microsoft.PowerShell.Utility\Write-Error -Exception $_.Exception
                }}
            }}
 
            return $op
        }}
 
        # Return a hashtable with the following members:
        # Files - Array with file fullnames, and their sizes
        # Directories - Array of child directory fullnames
        function PSGetPathDirAndFiles
        {{
            param (
                [string] $getPathDir
            )
 
            $result = @()
 
            $op = @{{
                Files = $null
                Directories = $null
            }}
 
            try
            {{
                $item = Microsoft.PowerShell.Management\Get-Item $getPathDir
 
                if ($item -isnot [System.IO.DirectoryInfo])
                {{
                    return $op
                }}
 
                $files = @(Microsoft.PowerShell.Management\Get-ChildItem -Path $getPathDir -File | Microsoft.PowerShell.Core\ForEach-Object {{
                    @{{ FileName = $_.Name;
                        FilePath = (ConvertToPSDrivePath $_.PSDrive $_.FullName);
                        FileSize = $_.Length
                     }}
                }})
 
                $directories = @(Microsoft.PowerShell.Management\Get-ChildItem -Path $getPathDir -Directory | Microsoft.PowerShell.Core\ForEach-Object {{
                    @{{ Name = $_.Name;
                        FullName = (ConvertToPSDrivePath $_.PSDrive $_.FullName)
                     }}
                }})
 
                if ($files.count -gt 0)
                {{
                    $op[&#39;Files&#39;] = $files
                }}
 
                if ($directories.count -gt 0)
                {{
                    $op[&#39;Directories&#39;] = $directories
                }}
            }}
            catch
            {{
                if ($_.Exception.InnerException)
                {{
                    Microsoft.PowerShell.Utility\Write-Error -Exception $_.Exception.InnerException
                }}
                else
                {{
                    Microsoft.PowerShell.Utility\Write-Error -Exception $_.Exception
                }}
            }}
 
            return $op
        }}
 
        #
        # Call helper function based on bound parameter set
        #
        $params = $PSCmdlet.MyInvocation.BoundParameters
        switch ($PSCmdlet.ParameterSetName)
        {{
            &quot;&quot;PSCopyFileFromRemoteSession&quot;&quot;
            {{
                return PSCopyFileFromRemoteSession @params
            }}
 
            &quot;&quot;PSSourceSupportsAlternateStreams&quot;&quot;
            {{
                PSSourceSupportsAlternateStreams @params
            }}
 
            &quot;&quot;PSGetFileMetadata&quot;&quot;
            {{
                PSGetFileMetadata @params
            }}
 
            &quot;&quot;PSGetPathItems&quot;&quot;
            {{
                PSGetPathItems @params
            }}
 
            &quot;&quot;PSGetPathDirAndFiles&quot;&quot;
            {{
                PSGetPathDirAndFiles @params
            }}
        }}
        &quot;</span>;
 
        <b>internal static readonly string</b> <a id="ac25ae240a5a6639" href="../R/ac25ae240a5a6639.html" target="n" data-glyph="44,1" class="i field">PSCopyFromSessionHelper</a> = <a href="#17901e631197a52f" class="i field">functionToken</a> + <a href="#7768bae509667d9d" class="i field">PSCopyFromSessionHelperName</a> + <span class="s">@&quot;
        {
        &quot;</span> + <a href="#78bc1c8bb5f2cb5e" class="i field">s_PSCopyFromSessionHelperDefinition</a> + <span class="s">@&quot;
        }
        &quot;</span>;
 
        <b>private static readonly</b> <span class="i">Hashtable</span> <a id="01da04023217ec9b" href="../R/01da04023217ec9b.html" target="n" data-glyph="46,1" class="i field">s_PSCopyFromSessionHelperFunction</a> = <b>new</b> <span class="i">Hashtable</span>() {
            {<a href="#23b629ca925fbcc1" class="i field">nameToken</a>, <a href="#7768bae509667d9d" class="i field">PSCopyFromSessionHelperName</a>},
            {<a href="#68845a09b9c590b4" class="i field">definitionToken</a>, <a href="#e40be48f2d2b3ca9" class="i field">s_PSCopyFromSessionHelperDefinitionRestricted</a>}
        };
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> PSCopyRemoteUtils
 
        <b>internal const string</b> <a id="147015726857e7cc" href="../R/147015726857e7cc.html" target="n" data-glyph="8,1" class="i field">PSCopyRemoteUtilsName</a> = <span class="s">@&quot;PSCopyRemoteUtils&quot;</span>;
 
        <b>internal static readonly string</b> <a id="3c628db85affc4eb" href="../R/3c628db85affc4eb.html" target="n" data-glyph="44,1" class="i field">PSCopyRemoteUtilsDefinition</a> = <a href="../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<a href="../utils/StringUtil.cs.html#2212180d4582cc59" class="i method">Format</a>(<a href="#6314ea97c6017bd8" class="i field">PSCopyRemoteUtilsDefinitionFormat</a>, <span class="s">@&quot;[ValidateNotNullOrEmpty()]&quot;</span>, <a href="#8ac90cd8ec1e7112" class="i field">PSValidatePathFunction</a>);
        <b>private static readonly string</b> <a id="dd4811a8a96b30ee" href="../R/dd4811a8a96b30ee.html" target="n" data-glyph="46,1" class="i field">s_PSCopyRemoteUtilsDefinitionRestricted</a> = <a href="../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<a href="../utils/StringUtil.cs.html#2212180d4582cc59" class="i method">Format</a>(<a href="#6314ea97c6017bd8" class="i field">PSCopyRemoteUtilsDefinitionFormat</a>, <span class="s">@&quot;[ValidateUserDrive()]&quot;</span>, <a href="#8ac90cd8ec1e7112" class="i field">PSValidatePathFunction</a>);
 
        <b>private const string</b> <a id="6314ea97c6017bd8" href="../R/6314ea97c6017bd8.html" target="n" data-glyph="10,1" class="i field">PSCopyRemoteUtilsDefinitionFormat</a> = <span class="s">@&quot;
        param (
            [Parameter(ParameterSetName=&quot;&quot;PSRemoteDirectoryExist&quot;&quot;, Mandatory=$true)]
            {0}
 
            [string] $dirPathExists,
 
            [Parameter(ParameterSetName=&quot;&quot;PSValidatePath&quot;&quot;, Mandatory=$true)]
            {0}
 
            [string] $pathToValidate,
 
            [Parameter(ParameterSetName=&quot;&quot;PSValidatePath&quot;&quot;)]
            [switch] $sourceIsRemote
        )
 
        # Returns a hashtable with the following member:
        #    Exists - boolean to keep track of whether the given path exists for a remote directory.
        #
        function PSRemoteDirectoryExist
        {{
            param (
                [string] $dirPathExists
            )
 
            $result = @{{ Exists = (Microsoft.PowerShell.Management\Test-Path $dirPathExists -PathType Container) }}
 
            return $result
        }}
 
        {1}
 
        #
        # Call helper function based on bound parameter set
        #
        $params = $PSCmdlet.MyInvocation.BoundParameters
        switch ($PSCmdlet.ParameterSetName)
        {{
            &quot;&quot;PSRemoteDirectoryExist&quot;&quot;
            {{
                return PSRemoteDirectoryExist @params
            }}
 
            &quot;&quot;PSValidatePath&quot;&quot;
            {{
                return PSValidatePath @params
            }}
        }}
        &quot;</span>;
 
        <b>private const string</b> <a id="8ac90cd8ec1e7112" href="../R/8ac90cd8ec1e7112.html" target="n" data-glyph="10,1" class="i field">PSValidatePathFunction</a> = <a href="#17901e631197a52f" class="i field">functionToken</a> + <span class="s">&quot;PSValidatePath&quot;</span> + <span class="s">@&quot;
        {
        &quot;</span> + <a href="#31e2ee754572d1bb" class="i field">PSValidatePathDefinition</a> + <span class="s">@&quot;
        }
        &quot;</span>;
 
        <b>internal const string</b> <a id="31e2ee754572d1bb" href="../R/31e2ee754572d1bb.html" target="n" data-glyph="8,1" class="i field">PSValidatePathDefinition</a> = <span class="s">@&quot;
        # Return hashtable in the following format:
        #   Exists - boolean to keep track if the given path exists
        #   Root - the root for the given path. If wildcards are used, it returns the first drive root.
        #   IsAbsolute - boolean to keep track of whether the given path is absolute
        param (
            [string] $pathToValidate,
            [switch] $sourceIsRemote
        )
 
        function SafeGetDriveRoot
        {
            param (
                [System.Management.Automation.PSDriveInfo] $driveInfo
            )
 
            if (! ($driveInfo.Root.StartsWith($driveInfo.Name)))
            {
                return (($driveInfo.Name) + &quot;&quot;:&quot;&quot;)
            }
            else
            {
                $driveInfo.Root
            }
        }
 
        $result = @{
            Exists = $null
            Root = $null
            IsAbsolute = $null
        }
 
        # Validate if the path is absolute
        $result[&#39;IsAbsolute&#39;] = (Microsoft.PowerShell.Management\Split-Path $pathToValidate -IsAbsolute)
        if (-not $result[&#39;IsAbsolute&#39;])
        {
            return $result
        }
 
        # Check if the given path exists.
        $result[&#39;Exists&#39;] = (Microsoft.PowerShell.Management\Test-Path $pathToValidate)
 
        # If $pathToValidate is a remote source, and it does not exist, return.
        if ($sourceIsRemote -and (-not $result[&#39;Exists&#39;]))
        {
            return $result
        }
 
        # If the path does not exist, check if we can find its root.
        if (-not (Microsoft.PowerShell.Management\Test-Path $pathToValidate))
        {
            $possibleRoot = $null
 
            try
            {
                $possibleRoot = [System.IO.Path]::GetPathRoot($pathToValidate)
            }
            # Catch everything and ignore the error.
            catch {}
 
            if (-not $possibleRoot)
            {
                return $result
            }
 
            # Now use this path to find its root.
            $pathToValidate = $possibleRoot
        }
 
        # Get the root path using Get-Item
        $item = Microsoft.PowerShell.Management\Get-Item $pathToValidate -ea SilentlyContinue
        if (($null -ne $item) -and ($item[0].PSProvider.Name -eq &#39;FileSystem&#39;))
        {
            $result[&#39;Root&#39;] = SafeGetDriveRoot $item[0].PSDrive
            return $result
        }
 
        # If this fails, try to get them via Get-PSDrive
        $fileSystemDrives = @(Microsoft.PowerShell.Management\Get-PSDrive -PSProvider FileSystem -ea SilentlyContinue)
 
        # If this fails, try to get them via Get-PSProvider
        if ($fileSystemDrives.Count -eq 0)
        {
            $fileSystemDrives = @((Microsoft.PowerShell.Management\Get-PSProvider -PSProvider FileSystem -ea SilentlyContinue).Drives)
        }
 
        foreach ($drive in  $fileSystemDrives)
        {
            if ($pathToValidate.StartsWith($drive.Root))
            {
                $result[&#39;Root&#39;] = SafeGetDriveRoot $drive
                break
            }
        }
 
        return $result
        &quot;</span>;
 
        <b>internal static readonly string</b> <a id="f6a82cd9650e0f6f" href="../R/f6a82cd9650e0f6f.html" target="n" data-glyph="44,1" class="i field">PSCopyRemoteUtils</a> = <a href="#17901e631197a52f" class="i field">functionToken</a> + <a href="#147015726857e7cc" class="i field">PSCopyRemoteUtilsName</a> + <span class="s">@&quot;
        {
        &quot;</span> + <a href="#3c628db85affc4eb" class="i field">PSCopyRemoteUtilsDefinition</a> + <span class="s">@&quot;
        }
        &quot;</span>;
 
        <b>internal static readonly</b> <span class="i">Hashtable</span> <a id="11f31bf76ec607b7" href="../R/11f31bf76ec607b7.html" target="n" data-glyph="44,1" class="i field">PSCopyRemoteUtilsFunction</a> = <b>new</b> <span class="i">Hashtable</span>() {
            {<a href="#23b629ca925fbcc1" class="i field">nameToken</a>, <a href="#147015726857e7cc" class="i field">PSCopyRemoteUtilsName</a>},
            {<a href="#68845a09b9c590b4" class="i field">definitionToken</a>, <a href="#dd4811a8a96b30ee" class="i field">s_PSCopyRemoteUtilsDefinitionRestricted</a>}
        };
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <b>internal static readonly string</b> <a id="d5ab88936d4b338b" href="../R/d5ab88936d4b338b.html" target="n" data-glyph="44,1" class="i field">AllCopyToRemoteScripts</a> = <a href="#256c060188254ba7" class="i field">s_PSCopyToSessionHelper</a> + <a href="#f6a82cd9650e0f6f" class="i field">PSCopyRemoteUtils</a>;
 
        <b>internal static</b> <span class="i">IEnumerable</span>&lt;<span class="i">Hashtable</span>&gt; <a id="cfeb8b157f1ad891" href="../R/cfeb8b157f1ad891.html" target="n" data-glyph="74,1" class="i method">GetAllCopyToRemoteScriptFunctions</a>()
        {
            <b>yield</b> <b>return</b> <a href="#fd9cb235b5be2209" class="i field">s_PSCopyToSessionHelperFunction</a>;
            <b>yield</b> <b>return</b> <a href="#11f31bf76ec607b7" class="i field">PSCopyRemoteUtilsFunction</a>;
        }
 
        <b>internal static readonly string</b> <a id="de976ac700812acc" href="../R/de976ac700812acc.html" target="n" data-glyph="44,1" class="i field">AllCopyFromRemoteScripts</a> = <a href="#ac25ae240a5a6639" class="i field">PSCopyFromSessionHelper</a> + <a href="#f6a82cd9650e0f6f" class="i field">PSCopyRemoteUtils</a>;
 
        <b>internal static</b> <span class="i">IEnumerable</span>&lt;<span class="i">Hashtable</span>&gt; <a id="7bb137e0dc664552" href="../R/7bb137e0dc664552.html" target="n" data-glyph="74,1" class="i method">GetAllCopyFromRemoteScriptFunctions</a>()
        {
            <b>yield</b> <b>return</b> <a href="#01da04023217ec9b" class="i field">s_PSCopyFromSessionHelperFunction</a>;
            <b>yield</b> <b>return</b> <a href="#11f31bf76ec607b7" class="i field">PSCopyRemoteUtilsFunction</a>;
        }
    }
 
    <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
}
</pre></td></tr></table></div></body></html>
