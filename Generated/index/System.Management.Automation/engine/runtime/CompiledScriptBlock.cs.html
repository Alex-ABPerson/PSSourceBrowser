<!DOCTYPE html>
<html><head><title>CompiledScriptBlock.cs</title><link rel="stylesheet" href="../../../styles.css"><script src="../../../scripts.js"></script></head>
<body class="cB" onload="i(2532);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#System.Management.Automation/engine/runtime/CompiledScriptBlock.cs" target="_top">engine\runtime\CompiledScriptBlock.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#System.Management.Automation" target="_top">src\System.Management.Automation\System.Management.Automation.csproj</a> (System.Management.Automation)</td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation.</span>
<span class="c">// Licensed under the MIT License.</span>
 
<b>using</b> <span class="i n">System</span>.<span class="i">Collections</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Collections</span>.<span class="i">Concurrent</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Collections</span>.<span class="i">Generic</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Diagnostics</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Linq</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Configuration</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Internal</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Language</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Runspaces</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Tracing</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Reflection</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Runtime</span>.<span class="i">CompilerServices</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Runtime</span>.<span class="i">Serialization</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Security</span>.<span class="i">Cryptography</span>.<span class="i">X509Certificates</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Text</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Threading</span>.<span class="i">Tasks</span>;
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">LEGACYTELEMETRY</span>
<span class="e">using Microsoft.PowerShell.Telemetry.Internal;
</span><span class="k preprocess">#</span><span class="k preprocess">endif</span>
 
<b>namespace</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>
{
    <b>internal enum</b> <a id="85d3cce0f94dc5cc" href="../../R/85d3cce0f94dc5cc.html" target="n" data-glyph="20,0" class="t t"><span id="d6cafb2cdfcf5502">CompileInterpretChoice</span></a>
    {
        <a id="c5f98f2c635b066b" href="../../R/c5f98f2c635b066b.html" target="n" data-glyph="24,1" class="i field">NeverCompile</a>,
        <a id="b2e9faa10199a7ac" href="../../R/b2e9faa10199a7ac.html" target="n" data-glyph="24,1" class="i field">AlwaysCompile</a>,
        <a id="947d7b82b1184fc9" href="../../R/947d7b82b1184fc9.html" target="n" data-glyph="24,1" class="i field">CompileOnDemand</a>
    }
 
    <b>internal enum</b> <a id="34af49554c079f15" href="../../R/34af49554c079f15.html" target="n" data-glyph="20,0" class="t t"><span id="dcc7821bbdd5ef2a">ScriptBlockClauseToInvoke</span></a>
    {
        <a id="85ca98782a255c39" href="../../R/85ca98782a255c39.html" target="n" data-glyph="24,1" class="i field">Begin</a>,
        <a id="94c9d79f22dcf339" href="../../R/94c9d79f22dcf339.html" target="n" data-glyph="24,1" class="i field">Process</a>,
        <a id="0b20b164588bea50" href="../../R/0b20b164588bea50.html" target="n" data-glyph="24,1" class="i field">End</a>,
        <a id="60e19cf946da098d" href="../../R/60e19cf946da098d.html" target="n" data-glyph="24,1" class="i field">ProcessBlockOnly</a>,
    }
 
    <b>internal class</b> <a id="a80c8ca7922183a5" href="../../R/a80c8ca7922183a5.html" target="n" data-glyph="2,0" class="t t">CompiledScriptBlockData</a>
    {
        <b>internal</b> <a id="50828b29768964ff" href="../../R/50828b29768964ff.html" target="n" data-glyph="74,1" class="t constructor">CompiledScriptBlockData</a>(<a href="../parser/ast.cs.html#063cc8bbea9e10f2" class="t t">IParameterMetadataProvider</a> <span id="r0 rd" class="r0 r">ast</span>, <b>bool</b> <span id="r1 rd" class="r1 r">isFilter</span>)
        {
            <a href="#2f74422462362f75" class="i field">_ast</a> = <span class="r0 r">ast</span>;
            <a href="#a80c8ca7922183a5" class="k">this</a>.<a href="#20d44dfc1b215b74" class="i property">IsFilter</a> = <span class="r1 r">isFilter</span>;
            <a href="#a80c8ca7922183a5" class="k">this</a>.<a href="#039ec6feee61aa62" class="i property">Id</a> = <span class="i">Guid</span>.<span class="i">NewGuid</span>();
        }
 
        <b>internal</b> <a id="1ccf5a6ae2cd2e05" href="../../R/1ccf5a6ae2cd2e05.html" target="n" data-glyph="74,1" class="t constructor">CompiledScriptBlockData</a>(<b>string</b> <span id="r2 rd" class="r2 r">scriptText</span>, <b>bool</b> <span id="r3 rd" class="r3 r">isProductCode</span>)
        {
            <a href="#91f2344d0624bd7a" class="i field">_isProductCode</a> = <span class="r3 r">isProductCode</span>;
            <a href="#90e5e70d98063639" class="i field">_scriptText</a> = <span class="r2 r">scriptText</span>;
            <a href="#a80c8ca7922183a5" class="k">this</a>.<a href="#039ec6feee61aa62" class="i property">Id</a> = <span class="i">Guid</span>.<span class="i">NewGuid</span>();
        }
 
        <b>internal bool</b> <a id="0f166b9df4330182" href="../../R/0f166b9df4330182.html" target="n" data-glyph="74,1" class="i method">Compile</a>(<b>bool</b> <span id="r4 rd" class="r4 r">optimized</span>)
        {
            <b>if</b> (<a href="#af3ceb2ebcb3c5b6" class="i field">_attributes</a> == <b>null</b>)
            {
                <a href="#97f6ee498001c639" class="i method">InitializeMetadata</a>();
            }
 
            <span class="c">// We need the name to index map to check if any allscope variables are assigned.  If they</span>
            <span class="c">// are, we can&#39;t run the optimized version, so we&#39;ll compile once more unoptimized and run that.</span>
            <b>if</b> (<span class="r4 r">optimized</span> &amp;&amp; <a href="#e200f548c2cb062b" class="i property">NameToIndexMap</a> == <b>null</b>)
            {
                <a href="#61e3c65f7e5db0d1" class="i method">CompileOptimized</a>();
            }
 
            <span class="r4 r">optimized</span> = <span class="r4 r">optimized</span> &amp;&amp; !<a href="../parser/VariableAnalysis.cs.html#3d310869db3a3b73" class="t t">VariableAnalysis</a>.<a href="../parser/VariableAnalysis.cs.html#b8e10947746fe400" class="i method">AnyVariablesCouldBeAllScope</a>(<a href="#e200f548c2cb062b" class="i property">NameToIndexMap</a>);
 
            <b>if</b> (!<span class="r4 r">optimized</span> &amp;&amp; !<a href="#3aba55d3b827b1d2" class="i field">_compiledUnoptimized</a>)
            {
                <a href="#28ec52364adb910e" class="i method">CompileUnoptimized</a>();
            }
            <b>else</b> <b>if</b> (<span class="r4 r">optimized</span> &amp;&amp; !<a href="#de2749937259499c" class="i field">_compiledOptimized</a>)
            {
                <a href="#61e3c65f7e5db0d1" class="i method">CompileOptimized</a>();
            }
 
            <b>return</b> <span class="r4 r">optimized</span>;
        }
 
        <b>private void</b> <a id="97f6ee498001c639" href="../../R/97f6ee498001c639.html" target="n" data-glyph="76,1" class="i method">InitializeMetadata</a>()
        {
            <b>lock</b> (<a href="#a80c8ca7922183a5" class="k">this</a>)
            {
                <b>if</b> (<a href="#af3ceb2ebcb3c5b6" class="i field">_attributes</a> != <b>null</b>)
                {
                    <span class="c">// Another thread must have initialized the metadata.</span>
                    <b>return</b>;
                }
 
                <span class="i">Attribute</span>[] <span id="r5 rd" class="r5 r">attributes</span>;
                <a href="../Attributes.cs.html#67a775c242618ea6" class="t t">CmdletBindingAttribute</a> <span id="r6 rd" class="r6 r">cmdletBindingAttribute</span> = <b>null</b>;
                <b>if</b> (!<a href="#4fc4e37b6267d386" class="i property">Ast</a>.<a href="../parser/ast.cs.html#dea65be215e5a292" class="i method">HasAnyScriptBlockAttributes</a>())
                {
                    <span class="r5 r">attributes</span> = <span class="i">Array</span>.<span class="i">Empty</span>&lt;<span class="i">Attribute</span>&gt;();
                }
                <b>else</b>
                {
                    <span class="r5 r">attributes</span> = <a href="#4fc4e37b6267d386" class="i property">Ast</a>.<a href="../parser/ast.cs.html#5268a33bec21621c" class="i method">GetScriptBlockAttributes</a>().<span class="i">ToArray</span>();
                    <b>foreach</b> (<b>var</b> <span id="r7 rd" class="r7 r">attribute</span> <b>in</b> <span class="r5 r">attributes</span>)
                    {
                        <b>if</b> (<span class="r7 r">attribute</span> <b>is</b> <a href="../Attributes.cs.html#67a775c242618ea6" class="t t">CmdletBindingAttribute</a> <span id="r8 rd" class="r8 r">c</span>)
                        {
                            <span class="r6 r">cmdletBindingAttribute</span> ??= <span class="r8 r">c</span>;
                        }
                        <b>else</b> <b>if</b> (<span class="r7 r">attribute</span> <b>is</b> <span class="i">DebuggerHiddenAttribute</span>)
                        {
                            <a href="#0deff729c13c207d" class="i property">DebuggerHidden</a> = <b>true</b>;
                        }
                        <b>else</b> <b>if</b> (<span class="r7 r">attribute</span> <b>is</b> <span class="i">DebuggerStepThroughAttribute</span> || <span class="r7 r">attribute</span> <b>is</b> <span class="i">DebuggerNonUserCodeAttribute</span>)
                        {
                            <a href="#aebb4a2acbb378c0" class="i property">DebuggerStepThrough</a> = <b>true</b>;
                        }
                    }
 
                    <a href="#49af89551321f9ac" class="i field">_usesCmdletBinding</a> = <span class="r6 r">cmdletBindingAttribute</span> != <b>null</b>;
                }
 
                <b>bool</b> <span id="r9 rd" class="r9 r">automaticPosition</span> = <span class="r6 r">cmdletBindingAttribute</span> == <b>null</b> || <span class="r6 r">cmdletBindingAttribute</span>.<a href="../Attributes.cs.html#923927e48096d1bb" class="i property">PositionalBinding</a>;
                <a href="../PseudoParameters.cs.html#d55a14219c7e096c" class="k">var</a> <span id="r10 rd" class="r10 r">runtimeDefinedParameterDictionary</span> =
                    <a href="#4fc4e37b6267d386" class="i property">Ast</a>.<a href="../parser/ast.cs.html#c8000536ef7797f3" class="i method">GetParameterMetadata</a>(<span class="r9 r">automaticPosition</span>, <b>ref</b> <a href="#49af89551321f9ac" class="i field">_usesCmdletBinding</a>);
 
                <span class="c">// Initialize these fields last - if there were any exceptions, we don&#39;t want the partial results cached.</span>
                <a href="#af3ceb2ebcb3c5b6" class="i field">_attributes</a> = <span class="r5 r">attributes</span>;
                <a href="#1e9dfa82db5f670e" class="i field">_runtimeDefinedParameterDictionary</a> = <span class="r10 r">runtimeDefinedParameterDictionary</span>;
            }
        }
 
        <b>private void</b> <a id="28ec52364adb910e" href="../../R/28ec52364adb910e.html" target="n" data-glyph="76,1" class="i method">CompileUnoptimized</a>()
        {
            <b>lock</b> (<a href="#a80c8ca7922183a5" class="k">this</a>)
            {
                <b>if</b> (<a href="#3aba55d3b827b1d2" class="i field">_compiledUnoptimized</a>)
                {
                    <span class="c">// Another thread must have compiled while we were waiting on the lock.</span>
                    <b>return</b>;
                }
 
                <a href="#efc8d347fba7e61a" class="i method">ReallyCompile</a>(<b>false</b>);
                <a href="#3aba55d3b827b1d2" class="i field">_compiledUnoptimized</a> = <b>true</b>;
            }
        }
 
        <b>private void</b> <a id="61e3c65f7e5db0d1" href="../../R/61e3c65f7e5db0d1.html" target="n" data-glyph="76,1" class="i method">CompileOptimized</a>()
        {
            <b>lock</b> (<a href="#a80c8ca7922183a5" class="k">this</a>)
            {
                <b>if</b> (<a href="#de2749937259499c" class="i field">_compiledOptimized</a>)
                {
                    <span class="c">// Another thread must have compiled while we were waiting on the lock.</span>
                    <b>return</b>;
                }
 
                <a href="#efc8d347fba7e61a" class="i method">ReallyCompile</a>(<b>true</b>);
                <a href="#de2749937259499c" class="i field">_compiledOptimized</a> = <b>true</b>;
            }
        }
 
        <b>private void</b> <a id="efc8d347fba7e61a" href="../../R/efc8d347fba7e61a.html" target="n" data-glyph="76,1" class="i method">ReallyCompile</a>(<b>bool</b> <span id="r11 rd" class="r11 r">optimize</span>)
        {
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">LEGACYTELEMETRY</span>
<span class="e">            var sw = new Stopwatch();
            sw.Start();
</span><span class="k preprocess">#</span><span class="k preprocess">endif</span>
            <b>bool</b> <span id="r12 rd" class="r12 r">etwEnabled</span> = <a href="../parser/Parser.cs.html#ef505205d8f64188" class="t t">ParserEventSource</a>.<a href="../parser/Parser.cs.html#10130af1551d9144" class="i field">Log</a>.<span class="i">IsEnabled</span>();
            <b>if</b> (<span class="r12 r">etwEnabled</span>)
            {
                <a href="../parser/Position.cs.html#bbc751d075344454" class="k">var</a> <span id="r13 rd" class="r13 r">extent</span> = <a href="#2f74422462362f75" class="i field">_ast</a>.<a href="../parser/ast.cs.html#b25d4ae40ae3a393" class="i property">Body</a>.<a href="../parser/ast.cs.html#d9d5cd324ee61136" class="i property">Extent</a>;
                <b>var</b> <span id="r14 rd" class="r14 r">text</span> = <span class="r13 r">extent</span>.<a href="../parser/Position.cs.html#43ce932d9225bc9c" class="i property">Text</a>;
                <a href="../parser/Parser.cs.html#ef505205d8f64188" class="t t">ParserEventSource</a>.<a href="../parser/Parser.cs.html#10130af1551d9144" class="i field">Log</a>.<span class="i">CompileStart</span>(
                    <span class="i">FileName</span>: <a href="../parser/Parser.cs.html#ef505205d8f64188" class="t t">ParserEventSource</a>.<span class="i">GetFileOrScript</span>(<span class="r13 r">extent</span>.<a href="../parser/Position.cs.html#e933edecd2b0cc1d" class="i property">File</a>, <span class="r14 r">text</span>),
                    <span class="r14 r">text</span>.<span class="i">Length</span>,
                    <span class="r11 r">optimize</span>);
            }
 
            <a href="#1b83e0ee9cebde20" class="i method">PerformSecurityChecks</a>();
 
            <a href="../parser/Compiler.cs.html#8bdfc042f41c96c5" class="t t">Compiler</a> <span id="r15 rd" class="r15 r">compiler</span> = <b>new</b> <a href="../parser/Compiler.cs.html#b6cc6d8d9723112a" class="t constructor">Compiler</a>();
            <span class="r15 r">compiler</span>.<a href="../parser/Compiler.cs.html#ab988fb229ec4a74" class="i method">Compile</a>(<a href="#a80c8ca7922183a5" class="k">this</a>, <span class="r11 r">optimize</span>);
 
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">LEGACYTELEMETRY</span>
<span class="e">            if (!IsProductCode)
            {
                TelemetryAPI.ReportScriptTelemetry((Ast)_ast, !optimize, sw.ElapsedMilliseconds);
            }
</span><span class="k preprocess">#</span><span class="k preprocess">endif</span>
            <b>if</b> (<span class="r12 r">etwEnabled</span>) <a href="../parser/Parser.cs.html#ef505205d8f64188" class="t t">ParserEventSource</a>.<a href="../parser/Parser.cs.html#10130af1551d9144" class="i field">Log</a>.<a href="../parser/Parser.cs.html#b2b562f5afc6f3cf" class="i method">CompileStop</a>();
        }
 
        <b>private void</b> <a id="1b83e0ee9cebde20" href="../../R/1b83e0ee9cebde20.html" target="n" data-glyph="76,1" class="i method">PerformSecurityChecks</a>()
        {
            <b>if</b> (!(<a href="#4fc4e37b6267d386" class="i property">Ast</a> <b>is</b> <a href="../parser/ast.cs.html#6f963589327835a4" class="t t">ScriptBlockAst</a> <span id="r16 rd" class="r16 r">scriptBlockAst</span>))
            {
                <span class="c">// Checks are only needed at the top level.</span>
                <b>return</b>;
            }
 
            <a href="../parser/Position.cs.html#bbc751d075344454" class="k">var</a> <span id="r17 rd" class="r17 r">scriptExtent</span> = <span class="r16 r">scriptBlockAst</span>.<a href="../parser/ast.cs.html#d9d5cd324ee61136" class="i property">Extent</a>;
            <b>var</b> <span id="r18 rd" class="r18 r">scriptFile</span> = <span class="r17 r">scriptExtent</span>.<a href="../parser/Position.cs.html#e933edecd2b0cc1d" class="i property">File</a>;
 
            <b>if</b> (<span class="r18 r">scriptFile</span> != <b>null</b>
                &amp;&amp; <span class="r18 r">scriptFile</span>.<span class="i">EndsWith</span>(<a href="../SessionStateStrings.cs.html#55ee11e42c7cf459" class="t t">StringLiterals</a>.<a href="../SessionStateStrings.cs.html#35afed2e7cb8ba9d" class="i field">PowerShellDataFileExtension</a>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>)
                &amp;&amp; <a href="#bb1d4b5dadc2f1ce" class="i method">IsScriptBlockInFactASafeHashtable</a>())
            {
                <span class="c">// Skip the scan for .psd1 files if their content is in fact a safe HashtableAst.</span>
                <b>return</b>;
            }
 
            <span class="c">// Call the AMSI API to determine if the script block has malicious content</span>
            <a href="../../security/SecuritySupport.cs.html#d74158b7878b36c0" class="k">var</a> <span id="r19 rd" class="r19 r">amsiResult</span> = <a href="../../security/SecuritySupport.cs.html#da6cbabe35a18e75" class="t t">AmsiUtils</a>.<span class="i">ScanContent</span>(<span class="r17 r">scriptExtent</span>.<a href="../parser/Position.cs.html#43ce932d9225bc9c" class="i property">Text</a>, <span class="r18 r">scriptFile</span>);
 
            <b>if</b> (<span class="r19 r">amsiResult</span> == <a href="../../security/SecuritySupport.cs.html#da6cbabe35a18e75" class="t t">AmsiUtils</a>.<a href="../../security/SecuritySupport.cs.html#31aff5f95eefff88" class="t t">AmsiNativeMethods</a>.<a href="../../security/SecuritySupport.cs.html#d74158b7878b36c0" class="t t">AMSI_RESULT</a>.<a href="../../security/SecuritySupport.cs.html#1f564dba81089b8c" class="i field">AMSI_RESULT_DETECTED</a>)
            {
                <a href="../parser/Parser.cs.html#3b2ee49e322daa35" class="k">var</a> <span id="r20 rd" class="r20 r">parseError</span> = <b>new</b> <span class="t">ParseError</span>(
                    <span class="r17 r">scriptExtent</span>,
                    <span class="s">&quot;ScriptContainedMaliciousContent&quot;</span>,
                    <span class="i">ParserStrings</span>.<span class="i">ScriptContainedMaliciousContent</span>);
                <b>throw</b> <b>new</b> <a href="../../utils/ParserException.cs.html#62f3ee5b65dd2bdb" class="t constructor">ParseException</a>(<b>new</b>[] { <span class="r20 r">parseError</span> });
            }
            <b>else</b> <b>if</b> (<span class="r19 r">amsiResult</span> &gt;= <a href="../../security/SecuritySupport.cs.html#da6cbabe35a18e75" class="t t">AmsiUtils</a>.<a href="../../security/SecuritySupport.cs.html#31aff5f95eefff88" class="t t">AmsiNativeMethods</a>.<a href="../../security/SecuritySupport.cs.html#d74158b7878b36c0" class="t t">AMSI_RESULT</a>.<a href="../../security/SecuritySupport.cs.html#8f189e05dc8dc3d3" class="i field">AMSI_RESULT_BLOCKED_BY_ADMIN_BEGIN</a>
                &amp;&amp; <span class="r19 r">amsiResult</span> &lt;= <a href="../../security/SecuritySupport.cs.html#da6cbabe35a18e75" class="t t">AmsiUtils</a>.<a href="../../security/SecuritySupport.cs.html#31aff5f95eefff88" class="t t">AmsiNativeMethods</a>.<a href="../../security/SecuritySupport.cs.html#d74158b7878b36c0" class="t t">AMSI_RESULT</a>.<a href="../../security/SecuritySupport.cs.html#7395ffb6f1c47aea" class="i field">AMSI_RESULT_BLOCKED_BY_ADMIN_END</a>)
            {
                <span class="c">// Certain policies set by an administrator blocked this content on this machine</span>
                <a href="../parser/Parser.cs.html#3b2ee49e322daa35" class="k">var</a> <span id="r21 rd" class="r21 r">parseError</span> = <b>new</b> <a href="../parser/Parser.cs.html#eb0f2f05b24bdb0e" class="t constructor">ParseError</a>(
                    <span class="r17 r">scriptExtent</span>,
                    <span class="s">&quot;ScriptHasAdminBlockedContent&quot;</span>,
                    <a href="../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">ParserStrings</span>.<span class="i">ScriptHasAdminBlockedContent</span>, <span class="r19 r">amsiResult</span>));
                <b>throw</b> <b>new</b> <a href="../../utils/ParserException.cs.html#62f3ee5b65dd2bdb" class="t constructor">ParseException</a>(<b>new</b>[] { <span class="r21 r">parseError</span> });
            }
 
            <b>if</b> (<a href="../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="t t">ScriptBlock</a>.<a href="#d5d67f7728bfe547" class="i method">CheckSuspiciousContent</a>(<span class="r16 r">scriptBlockAst</span>) != <b>null</b>)
            {
                <a href="#0b48ef81314cd409" class="i property">HasSuspiciousContent</a> = <b>true</b>;
            }
 
            <span class="c">// A local function to check if the ScriptBlockAst is in fact a safe HashtableAst.</span>
            <b>bool</b> <a id="bb1d4b5dadc2f1ce" href="../../R/bb1d4b5dadc2f1ce.html" target="n" data-glyph="76,2" class="i method">IsScriptBlockInFactASafeHashtable</a>()
            {
                <span class="c">// NOTE: The code below depends on the current member structure of &#39;ScriptBlockAst&#39;</span>
                <span class="c">// to determine if the ScriptBlockAst is in fact just a HashtableAst. If AST types</span>
                <span class="c">// are enhanced, such as new members added to &#39;ScriptBlockAst&#39;, the code here needs</span>
                <span class="c">// to be reviewed and changed accordingly.</span>
 
                <b>if</b> (<span class="r16 r">scriptBlockAst</span>.<a href="../parser/ast.cs.html#08794a618a2d04ac" class="i property">BeginBlock</a> != <b>null</b>
                    || <span class="r16 r">scriptBlockAst</span>.<a href="../parser/ast.cs.html#8940fb8f9b3e6444" class="i property">ProcessBlock</a> != <b>null</b>
                    || <span class="r16 r">scriptBlockAst</span>.<a href="../parser/ast.cs.html#3fd8788db62344d2" class="i property">ParamBlock</a> != <b>null</b>
                    || <span class="r16 r">scriptBlockAst</span>.<a href="../parser/ast.cs.html#4549d1761658a004" class="i property">DynamicParamBlock</a> != <b>null</b>
                    || <span class="r16 r">scriptBlockAst</span>.<a href="../parser/ast.cs.html#db84554dcf2e5444" class="i property">ScriptRequirements</a> != <b>null</b>
                    || <span class="r16 r">scriptBlockAst</span>.<a href="../parser/ast.cs.html#c707ba0b01460c10" class="i property">UsingStatements</a>.<span class="i">Count</span> &gt; 0
                    || <span class="r16 r">scriptBlockAst</span>.<a href="../parser/ast.cs.html#a46b9537e8b363d2" class="i property">Attributes</a>.<span class="i">Count</span> &gt; 0)
                {
                    <b>return</b> <b>false</b>;
                }
 
                <a href="../parser/ast.cs.html#61c97c02c53bf32d" class="t t">NamedBlockAst</a> <span id="r22 rd" class="r22 r">endBlock</span> = <span class="r16 r">scriptBlockAst</span>.<a href="../parser/ast.cs.html#958e631868900aba" class="i property">EndBlock</a>;
                <b>if</b> (!<span class="r22 r">endBlock</span>.<a href="../parser/ast.cs.html#4b76ccd3ee5695b7" class="i property">Unnamed</a> || <span class="r22 r">endBlock</span>.<a href="../parser/ast.cs.html#2b645ddd993169db" class="i property">Traps</a> != <b>null</b> || <span class="r22 r">endBlock</span>.<a href="../parser/ast.cs.html#496f71fcd5c4e6a1" class="i property">Statements</a>.<span class="i">Count</span> != 1)
                {
                    <b>return</b> <b>false</b>;
                }
 
                <b>if</b> (!(<span class="r22 r">endBlock</span>.<a href="../parser/ast.cs.html#496f71fcd5c4e6a1" class="i property">Statements</a>[0] <b>is</b> <a href="../parser/ast.cs.html#785915ec8547ce9f" class="t t">PipelineAst</a> <span id="r23 rd" class="r23 r">pipelineAst</span>))
                {
                    <b>return</b> <b>false</b>;
                }
 
                <b>if</b> (!(<span class="r23 r">pipelineAst</span>.<a href="../parser/ast.cs.html#df65de159259e5e0" class="i method">GetPureExpression</a>() <b>is</b> <a href="../parser/ast.cs.html#fd6e450f68cfd52b" class="t t">HashtableAst</a> <span id="r24 rd" class="r24 r">hashtableAst</span>))
                {
                    <b>return</b> <b>false</b>;
                }
 
                <span class="c">// After the above steps, we know the ScriptBlockAst is in fact just a HashtableAst,</span>
                <span class="c">// now we need to check if the HashtableAst is safe.</span>
                <b>return</b> <a href="../parser/SafeValues.cs.html#eb4d92e68685204f" class="t t">IsSafeValueVisitor</a>.<a href="../parser/SafeValues.cs.html#d86c2fd26927c264" class="i field">Default</a>.<a href="../parser/SafeValues.cs.html#ce8bc3b491f831c6" class="i method">IsAstSafe</a>(<span class="r24 r">hashtableAst</span>);
            }
        }
 
        <span class="c">// We delay parsing scripts loaded on startup, so we save the text.</span>
        <b>private string</b> <a id="90e5e70d98063639" href="../../R/90e5e70d98063639.html" target="n" data-glyph="46,1" class="i field">_scriptText</a>;
 
        <b>internal</b> <a href="../parser/ast.cs.html#063cc8bbea9e10f2" class="t t">IParameterMetadataProvider</a> <a id="4fc4e37b6267d386" href="../../R/4fc4e37b6267d386.html" target="n" data-glyph="104,1" class="i property">Ast</a> { <b>get</b> =&gt; <a href="#2f74422462362f75" class="i field">_ast</a> ?? <a href="#21a511645cbb3540" class="i method">DelayParseScriptText</a>(); }
 
        <b>private</b> <a href="../parser/ast.cs.html#063cc8bbea9e10f2" class="t t">IParameterMetadataProvider</a> <a id="2f74422462362f75" href="../../R/2f74422462362f75.html" target="n" data-glyph="46,1" class="i field">_ast</a>;
 
        <b>private</b> <a href="../parser/ast.cs.html#063cc8bbea9e10f2" class="t t">IParameterMetadataProvider</a> <a id="21a511645cbb3540" href="../../R/21a511645cbb3540.html" target="n" data-glyph="76,1" class="i method">DelayParseScriptText</a>()
        {
            <b>lock</b> (<a href="#a80c8ca7922183a5" class="k">this</a>)
            {
                <b>if</b> (<a href="#2f74422462362f75" class="i field">_ast</a> != <b>null</b>)
                {
                    <b>return</b> <a href="#2f74422462362f75" class="i field">_ast</a>;
                }
 
                <a href="../parser/Parser.cs.html#3b2ee49e322daa35" class="t t">ParseError</a>[] <span id="r25 rd" class="r25 r">errors</span>;
                <a href="#2f74422462362f75" class="i field">_ast</a> = (<b>new</b> <a href="../parser/Parser.cs.html#aee2c3138d83ea53" class="t constructor">Parser</a>()).<a href="../parser/Parser.cs.html#3b3edfaa9020f895" class="i method">Parse</a>(<b>null</b>, <a href="#90e5e70d98063639" class="i field">_scriptText</a>, <b>null</b>, <b>out</b> <span class="r25 r">errors</span>, <a href="../parser/Parser.cs.html#5c0497999a31aece" class="t t">ParseMode</a>.<a href="../parser/Parser.cs.html#33fb9c7ca2039a3e" class="i field">Default</a>);
                <b>if</b> (<span class="r25 r">errors</span>.<span class="i">Length</span> != 0)
                {
                    <b>throw</b> <b>new</b> <a href="../../utils/ParserException.cs.html#62f3ee5b65dd2bdb" class="t constructor">ParseException</a>(<span class="r25 r">errors</span>);
                }
 
                <a href="#90e5e70d98063639" class="i field">_scriptText</a> = <b>null</b>;
                <b>return</b> <a href="#2f74422462362f75" class="i field">_ast</a>;
            }
        }
 
        <b>internal</b> <span class="i">Type</span> <a id="e19b7f75e9ba3109" href="../../R/e19b7f75e9ba3109.html" target="n" data-glyph="104,1" class="i property">LocalsMutableTupleType</a> { <b>get</b>; <b>set</b>; }
 
        <b>internal</b> <span class="i">Type</span> <a id="365d21fb5ac6f9e6" href="../../R/365d21fb5ac6f9e6.html" target="n" data-glyph="104,1" class="i property">UnoptimizedLocalsMutableTupleType</a> { <b>get</b>; <b>set</b>; }
 
        <b>internal</b> <span class="i">Func</span>&lt;<a href="MutableTuple.cs.html#d4c692d6a8bac31d" class="t t">MutableTuple</a>&gt; <a id="96022acf251075a0" href="../../R/96022acf251075a0.html" target="n" data-glyph="104,1" class="i property">LocalsMutableTupleCreator</a> { <b>get</b>; <b>set</b>; }
 
        <b>internal</b> <span class="i">Func</span>&lt;<a href="MutableTuple.cs.html#d4c692d6a8bac31d" class="t t">MutableTuple</a>&gt; <a id="60d93a32e14ee515" href="../../R/60d93a32e14ee515.html" target="n" data-glyph="104,1" class="i property">UnoptimizedLocalsMutableTupleCreator</a> { <b>get</b>; <b>set</b>; }
 
        <b>internal</b> <span class="i">Dictionary</span>&lt;<b>string</b>, <b>int</b>&gt; <a id="e200f548c2cb062b" href="../../R/e200f548c2cb062b.html" target="n" data-glyph="104,1" class="i property">NameToIndexMap</a> { <b>get</b>; <b>set</b>; }
 
        <b>internal</b> <span class="i">Action</span>&lt;<a href="../parser/Compiler.cs.html#aa4ec5dd36f7e2eb" class="t t">FunctionContext</a>&gt; <a id="c18d520d763b6c11" href="../../R/c18d520d763b6c11.html" target="n" data-glyph="104,1" class="i property">DynamicParamBlock</a> { <b>get</b>; <b>set</b>; }
 
        <b>internal</b> <span class="i">Action</span>&lt;<a href="../parser/Compiler.cs.html#aa4ec5dd36f7e2eb" class="t t">FunctionContext</a>&gt; <a id="ef7c60a2857843dc" href="../../R/ef7c60a2857843dc.html" target="n" data-glyph="104,1" class="i property">UnoptimizedDynamicParamBlock</a> { <b>get</b>; <b>set</b>; }
 
        <b>internal</b> <span class="i">Action</span>&lt;<a href="../parser/Compiler.cs.html#aa4ec5dd36f7e2eb" class="t t">FunctionContext</a>&gt; <a id="9913dea66272cc70" href="../../R/9913dea66272cc70.html" target="n" data-glyph="104,1" class="i property">BeginBlock</a> { <b>get</b>; <b>set</b>; }
 
        <b>internal</b> <span class="i">Action</span>&lt;<a href="../parser/Compiler.cs.html#aa4ec5dd36f7e2eb" class="t t">FunctionContext</a>&gt; <a id="22c1e1d6bb481504" href="../../R/22c1e1d6bb481504.html" target="n" data-glyph="104,1" class="i property">UnoptimizedBeginBlock</a> { <b>get</b>; <b>set</b>; }
 
        <b>internal</b> <span class="i">Action</span>&lt;<a href="../parser/Compiler.cs.html#aa4ec5dd36f7e2eb" class="t t">FunctionContext</a>&gt; <a id="81b0289e5e379546" href="../../R/81b0289e5e379546.html" target="n" data-glyph="104,1" class="i property">ProcessBlock</a> { <b>get</b>; <b>set</b>; }
 
        <b>internal</b> <span class="i">Action</span>&lt;<a href="../parser/Compiler.cs.html#aa4ec5dd36f7e2eb" class="t t">FunctionContext</a>&gt; <a id="efa61db3d10b1e5f" href="../../R/efa61db3d10b1e5f.html" target="n" data-glyph="104,1" class="i property">UnoptimizedProcessBlock</a> { <b>get</b>; <b>set</b>; }
 
        <b>internal</b> <span class="i">Action</span>&lt;<a href="../parser/Compiler.cs.html#aa4ec5dd36f7e2eb" class="t t">FunctionContext</a>&gt; <a id="6210fa92a7dbeebe" href="../../R/6210fa92a7dbeebe.html" target="n" data-glyph="104,1" class="i property">EndBlock</a> { <b>get</b>; <b>set</b>; }
 
        <b>internal</b> <span class="i">Action</span>&lt;<a href="../parser/Compiler.cs.html#aa4ec5dd36f7e2eb" class="t t">FunctionContext</a>&gt; <a id="3255522102eddb54" href="../../R/3255522102eddb54.html" target="n" data-glyph="104,1" class="i property">UnoptimizedEndBlock</a> { <b>get</b>; <b>set</b>; }
 
        <b>internal</b> <a href="../parser/Position.cs.html#bbc751d075344454" class="t t">IScriptExtent</a>[] <a id="f7bd45487f76d285" href="../../R/f7bd45487f76d285.html" target="n" data-glyph="104,1" class="i property">SequencePoints</a> { <b>get</b>; <b>set</b>; }
 
        <b>private</b> <a href="../PseudoParameters.cs.html#d55a14219c7e096c" class="t t">RuntimeDefinedParameterDictionary</a> <a id="1e9dfa82db5f670e" href="../../R/1e9dfa82db5f670e.html" target="n" data-glyph="46,1" class="i field">_runtimeDefinedParameterDictionary</a>;
        <b>private</b> <span class="i">Attribute</span>[] <a id="af3ceb2ebcb3c5b6" href="../../R/af3ceb2ebcb3c5b6.html" target="n" data-glyph="46,1" class="i field">_attributes</a>;
        <b>private bool</b> <a id="49af89551321f9ac" href="../../R/49af89551321f9ac.html" target="n" data-glyph="46,1" class="i field">_usesCmdletBinding</a>;
        <b>private bool</b> <a id="de2749937259499c" href="../../R/de2749937259499c.html" target="n" data-glyph="46,1" class="i field">_compiledOptimized</a>;
        <b>private bool</b> <a id="3aba55d3b827b1d2" href="../../R/3aba55d3b827b1d2.html" target="n" data-glyph="46,1" class="i field">_compiledUnoptimized</a>;
        <b>private bool</b> <a id="77af28dadbe5069a" href="../../R/77af28dadbe5069a.html" target="n" data-glyph="46,1" class="i field">_hasSuspiciousContent</a>;
        <b>private bool</b>? <a id="91f2344d0624bd7a" href="../../R/91f2344d0624bd7a.html" target="n" data-glyph="46,1" class="i field">_isProductCode</a>;
 
        <b>internal bool</b> <a id="0deff729c13c207d" href="../../R/0deff729c13c207d.html" target="n" data-glyph="104,1" class="i property">DebuggerHidden</a> { <b>get</b>; <b>set</b>; }
 
        <b>internal bool</b> <a id="aebb4a2acbb378c0" href="../../R/aebb4a2acbb378c0.html" target="n" data-glyph="104,1" class="i property">DebuggerStepThrough</a> { <b>get</b>; <b>set</b>; }
 
        <b>internal</b> <span class="i">Guid</span> <a id="039ec6feee61aa62" href="../../R/039ec6feee61aa62.html" target="n" data-glyph="104,1" class="i property">Id</a> { <b>get</b>; <b>private set</b>; }
 
        <b>internal bool</b> <a id="158ef5e0ad41505a" href="../../R/158ef5e0ad41505a.html" target="n" data-glyph="104,1" class="i property">HasLogged</a> { <b>get</b>; <b>set</b>; }
 
        <b>internal bool</b> <a id="984b8769a8333424" href="../../R/984b8769a8333424.html" target="n" data-glyph="104,1" class="i property">SkipLogging</a> { <b>get</b>; <b>set</b>; }
 
        <b>internal bool</b> <a id="20d44dfc1b215b74" href="../../R/20d44dfc1b215b74.html" target="n" data-glyph="104,1" class="i property">IsFilter</a> { <b>get</b>; }
 
        <b>internal bool</b> <a id="38a9df40a1ccf48a" href="../../R/38a9df40a1ccf48a.html" target="n" data-glyph="104,1" class="i property">IsProductCode</a>
        {
            <b>get</b>
            {
                <b>if</b> (<a href="#91f2344d0624bd7a" class="i field">_isProductCode</a> == <b>null</b>)
                {
                    <a href="#91f2344d0624bd7a" class="i field">_isProductCode</a> = <a href="../../security/SecuritySupport.cs.html#5c234bd2337db61c" class="t t">SecuritySupport</a>.<span class="i">IsProductBinary</span>(((<a href="../parser/ast.cs.html#d47621d83efd14de" class="t t">Ast</a>)<a href="#2f74422462362f75" class="i field">_ast</a>).<a href="../parser/ast.cs.html#d9d5cd324ee61136" class="i property">Extent</a>.<a href="../parser/Position.cs.html#e933edecd2b0cc1d" class="i property">File</a>);
                }
 
                <b>return</b> <a href="#91f2344d0624bd7a" class="i field">_isProductCode</a>.<span class="i">Value</span>;
            }
        }
 
        <b>internal bool</b> <a id="e0447ec54dcc5e85" href="../../R/e0447ec54dcc5e85.html" target="n" data-glyph="74,1" class="i method">GetIsConfiguration</a>()
        {
            <span class="c">// Use _ast instead of Ast</span>
            <span class="c">//  If we access Ast, we may parse a &quot;delay parsed&quot; script block unnecessarily</span>
            <span class="c">//  if _ast is null - it can&#39;t be a configuration as there is no way to create a configuration that way</span>
            <a href="../parser/ast.cs.html#6f963589327835a4" class="k">var</a> <span id="r26 rd" class="r26 r">scriptBlockAst</span> = <a href="#2f74422462362f75" class="i field">_ast</a> <b>as</b> <a href="../parser/ast.cs.html#6f963589327835a4" class="t t">ScriptBlockAst</a>;
            <b>return</b> <span class="r26 r">scriptBlockAst</span> != <b>null</b> &amp;&amp; <span class="r26 r">scriptBlockAst</span>.<a href="../parser/ast.cs.html#3b3b1d45fd29329c" class="i property">IsConfiguration</a>;
        }
 
        <b>internal bool</b> <a id="0b48ef81314cd409" href="../../R/0b48ef81314cd409.html" target="n" data-glyph="104,1" class="i property">HasSuspiciousContent</a>
        {
            <b>get</b>
            {
                <a href="../../utils/assert.cs.html#c04955255430d32f" class="t t">Diagnostics</a>.<a href="../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(
                    <a href="#de2749937259499c" class="i field">_compiledOptimized</a> || <a href="#3aba55d3b827b1d2" class="i field">_compiledUnoptimized</a>,
                    <span class="s">&quot;HasSuspiciousContent is not set correctly before being compiled&quot;</span>);
                <b>return</b> <a href="#77af28dadbe5069a" class="i field">_hasSuspiciousContent</a>;
            }
 
            <b>set</b> =&gt; <a href="#77af28dadbe5069a" class="i field">_hasSuspiciousContent</a> = <b>value</b>;
        }
 
        <b>private</b> <a href="../MergedCommandParameterMetadata.cs.html#2ce55afbd6d4dfde" class="t t">MergedCommandParameterMetadata</a> <a id="ea6427312eaf28a8" href="../../R/ea6427312eaf28a8.html" target="n" data-glyph="46,1" class="i field">_parameterMetadata</a>;
 
        <b>internal</b> <span class="i">List</span>&lt;<span class="i">Attribute</span>&gt; <a id="5f788763f11d9553" href="../../R/5f788763f11d9553.html" target="n" data-glyph="74,1" class="i method">GetAttributes</a>()
        {
            <b>if</b> (<a href="#af3ceb2ebcb3c5b6" class="i field">_attributes</a> == <b>null</b>)
            {
                <a href="#97f6ee498001c639" class="i method">InitializeMetadata</a>();
            }
 
            <a href="../../utils/assert.cs.html#c04955255430d32f" class="t t">Diagnostics</a>.<a href="../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(
                <a href="#af3ceb2ebcb3c5b6" class="i field">_attributes</a> != <b>null</b>,
                <span class="s">&quot;after initialization, attributes is never null, must be an empty list if no attributes.&quot;</span>);
            <b>return</b> <a href="#af3ceb2ebcb3c5b6" class="i field">_attributes</a>.<span class="i">ToList</span>();
        }
 
        <b>internal bool</b> <a id="a6b53fb28ca80b16" href="../../R/a6b53fb28ca80b16.html" target="n" data-glyph="104,1" class="i property">UsesCmdletBinding</a>
        {
            <b>get</b>
            {
                <b>if</b> (<a href="#af3ceb2ebcb3c5b6" class="i field">_attributes</a> != <b>null</b>)
                {
                    <b>return</b> <a href="#49af89551321f9ac" class="i field">_usesCmdletBinding</a>;
                }
 
                <b>return</b> <a href="#4fc4e37b6267d386" class="i property">Ast</a>.<a href="../parser/ast.cs.html#960da0e2b7046796" class="i method">UsesCmdletBinding</a>();
            }
        }
 
        <b>internal</b> <a href="../PseudoParameters.cs.html#d55a14219c7e096c" class="t t">RuntimeDefinedParameterDictionary</a> <a id="9fcfbb034bb3c718" href="../../R/9fcfbb034bb3c718.html" target="n" data-glyph="104,1" class="i property">RuntimeDefinedParameters</a>
        {
            <b>get</b>
            {
                <b>if</b> (<a href="#1e9dfa82db5f670e" class="i field">_runtimeDefinedParameterDictionary</a> == <b>null</b>)
                {
                    <a href="#97f6ee498001c639" class="i method">InitializeMetadata</a>();
                }
 
                <b>return</b> <a href="#1e9dfa82db5f670e" class="i field">_runtimeDefinedParameterDictionary</a>;
            }
        }
 
        <b>internal</b> <a href="../Attributes.cs.html#67a775c242618ea6" class="t t">CmdletBindingAttribute</a> <a id="44ccf527ce27d70d" href="../../R/44ccf527ce27d70d.html" target="n" data-glyph="104,1" class="i property">CmdletBindingAttribute</a>
        {
            <b>get</b>
            {
                <b>if</b> (<a href="#1e9dfa82db5f670e" class="i field">_runtimeDefinedParameterDictionary</a> == <b>null</b>)
                {
                    <a href="#97f6ee498001c639" class="i method">InitializeMetadata</a>();
                }
 
                <b>return</b> <a href="#49af89551321f9ac" class="i field">_usesCmdletBinding</a>
                    ? (<a href="../Attributes.cs.html#67a775c242618ea6" class="t t">CmdletBindingAttribute</a>)<span class="i">Array</span>.<span class="i">Find</span>(<a href="#af3ceb2ebcb3c5b6" class="i field">_attributes</a>, <b>static</b> <span id="r27 rd" class="r27 r">attr</span> =&gt; <span class="r27 r">attr</span> <b>is</b> <a href="../Attributes.cs.html#67a775c242618ea6" class="t t">CmdletBindingAttribute</a>)
                    : <b>null</b>;
            }
        }
 
        <b>internal</b> <span class="i">ObsoleteAttribute</span> <a id="10bfd3605123b87f" href="../../R/10bfd3605123b87f.html" target="n" data-glyph="104,1" class="i property">ObsoleteAttribute</a>
        {
            <b>get</b>
            {
                <b>if</b> (<a href="#1e9dfa82db5f670e" class="i field">_runtimeDefinedParameterDictionary</a> == <b>null</b>)
                {
                    <a href="#97f6ee498001c639" class="i method">InitializeMetadata</a>();
                }
 
                <b>return</b> (<span class="i">ObsoleteAttribute</span>)<span class="i">Array</span>.<span class="i">Find</span>(<a href="#af3ceb2ebcb3c5b6" class="i field">_attributes</a>, <b>static</b> <span id="r28 rd" class="r28 r">attr</span> =&gt; <span class="r28 r">attr</span> <b>is</b> <a href="#10bfd3605123b87f" class="i property">ObsoleteAttribute</a>);
            }
        }
 
        <b>internal</b> <a href="../ExperimentalFeature/ExperimentalFeature.cs.html#a9ee2c313b8e7ce8" class="t t">ExperimentalAttribute</a> <a id="d024d5cad669d640" href="../../R/d024d5cad669d640.html" target="n" data-glyph="104,1" class="i property">ExperimentalAttribute</a>
        {
            <b>get</b>
            {
                <b>if</b> (<a href="#dc97d2a50ed1006c" class="i field">_expAttribute</a> == <a href="../ExperimentalFeature/ExperimentalFeature.cs.html#a9ee2c313b8e7ce8" class="t t">ExperimentalAttribute</a>.<a href="../ExperimentalFeature/ExperimentalFeature.cs.html#a384a07796008b35" class="i field">None</a>)
                {
                    <b>lock</b> (<a href="#a80c8ca7922183a5" class="k">this</a>)
                    {
                        <b>if</b> (<a href="#dc97d2a50ed1006c" class="i field">_expAttribute</a> == <a href="../ExperimentalFeature/ExperimentalFeature.cs.html#a9ee2c313b8e7ce8" class="t t">ExperimentalAttribute</a>.<a href="../ExperimentalFeature/ExperimentalFeature.cs.html#a384a07796008b35" class="i field">None</a>)
                        {
                            <a href="#dc97d2a50ed1006c" class="i field">_expAttribute</a> = <a href="#4fc4e37b6267d386" class="i property">Ast</a>.<a href="../parser/ast.cs.html#8aeaf9e21660f350" class="i method">GetExperimentalAttributes</a>().<span class="i">FirstOrDefault</span>();
                        }
                    }
                }
 
                <b>return</b> <a href="#dc97d2a50ed1006c" class="i field">_expAttribute</a>;
            }
        }
 
        <b>private</b> <a href="../ExperimentalFeature/ExperimentalFeature.cs.html#a9ee2c313b8e7ce8" class="t t">ExperimentalAttribute</a> <a id="dc97d2a50ed1006c" href="../../R/dc97d2a50ed1006c.html" target="n" data-glyph="46,1" class="i field">_expAttribute</a> = <a href="../ExperimentalFeature/ExperimentalFeature.cs.html#a9ee2c313b8e7ce8" class="t t">ExperimentalAttribute</a>.<a href="../ExperimentalFeature/ExperimentalFeature.cs.html#a384a07796008b35" class="i field">None</a>;
 
        <b>public</b> <a href="../MergedCommandParameterMetadata.cs.html#2ce55afbd6d4dfde" class="t t">MergedCommandParameterMetadata</a> <a id="cba0c16805c0aee1" href="../../R/cba0c16805c0aee1.html" target="n" data-glyph="72,1" class="i method">GetParameterMetadata</a>(<a href="../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="t t">ScriptBlock</a> <span id="r29 rd" class="r29 r">scriptBlock</span>)
        {
            <b>if</b> (<a href="#ea6427312eaf28a8" class="i field">_parameterMetadata</a> == <b>null</b>)
            {
                <b>lock</b> (<a href="#a80c8ca7922183a5" class="k">this</a>)
                {
                    <b>if</b> (<a href="#ea6427312eaf28a8" class="i field">_parameterMetadata</a> == <b>null</b>)
                    {
                        <a href="../CommandMetadata.cs.html#543f906b9137ce10" class="t t">CommandMetadata</a> <span id="r30 rd" class="r30 r">metadata</span> = <b>new</b> <span class="t">CommandMetadata</span>(
                            <span class="r29 r">scriptBlock</span>,
                            <b>string</b>.<span class="i">Empty</span>,
                            <a href="../hostifaces/LocalPipeline.cs.html#4ecb13103c10f113" class="t t">LocalPipeline</a>.<a href="../hostifaces/LocalPipeline.cs.html#d3eaa3d3391ed484" class="i method">GetExecutionContextFromTLS</a>());
                        <a href="#ea6427312eaf28a8" class="i field">_parameterMetadata</a> = <span class="r30 r">metadata</span>.<a href="../CommandMetadata.cs.html#2949218a02f2a560" class="i property">StaticCommandParameterMetadata</a>;
                    }
                }
            }
 
            <b>return</b> <a href="#ea6427312eaf28a8" class="i field">_parameterMetadata</a>;
        }
 
        <b>public override string</b> <a id="d01244957535ade1" href="../../R/d01244957535ade1.html" target="n" data-glyph="72,1" class="i method">ToString</a>()
        {
            <b>if</b> (<a href="#90e5e70d98063639" class="i field">_scriptText</a> != <b>null</b>)
            {
                <b>return</b> <a href="#90e5e70d98063639" class="i field">_scriptText</a>;
            }
 
            <b>if</b> (<a href="#2f74422462362f75" class="i field">_ast</a> <b>is</b> <a href="../parser/ast.cs.html#6f963589327835a4" class="t t">ScriptBlockAst</a> <span id="r31 rd" class="r31 r">sbAst</span>)
            {
                <b>return</b> <span class="r31 r">sbAst</span>.<a href="../parser/ast.cs.html#8753abaf002f9597" class="i method">ToStringForSerialization</a>();
            }
 
            <a href="../parser/ast.cs.html#542e4087fd3a0dac" class="k">var</a> <span id="r32 rd" class="r32 r">generatedMemberFunctionAst</span> = <a href="#2f74422462362f75" class="i field">_ast</a> <b>as</b> <a href="../parser/ast.cs.html#542e4087fd3a0dac" class="t t">CompilerGeneratedMemberFunctionAst</a>;
            <b>if</b> (<span class="r32 r">generatedMemberFunctionAst</span> != <b>null</b>)
            {
                <b>return</b> <span class="r32 r">generatedMemberFunctionAst</span>.<a href="../parser/ast.cs.html#d9d5cd324ee61136" class="i property">Extent</a>.<a href="../parser/Position.cs.html#43ce932d9225bc9c" class="i property">Text</a>;
            }
 
            <a href="../parser/ast.cs.html#dd61b2a7b388405b" class="k">var</a> <span id="r33 rd" class="r33 r">funcDefn</span> = (<a href="../parser/ast.cs.html#dd61b2a7b388405b" class="t t">FunctionDefinitionAst</a>)<a href="#2f74422462362f75" class="i field">_ast</a>;
            <b>if</b> (<span class="r33 r">funcDefn</span>.<a href="../parser/ast.cs.html#653a0e4bf79364c2" class="i property">Parameters</a> == <b>null</b>)
            {
                <b>return</b> <span class="r33 r">funcDefn</span>.<a href="../parser/ast.cs.html#201bce3cfc040274" class="i property">Body</a>.<a href="../parser/ast.cs.html#8753abaf002f9597" class="i method">ToStringForSerialization</a>();
            }
 
            <b>var</b> <span id="r34 rd" class="r34 r">sb</span> = <b>new</b> <span class="i">StringBuilder</span>();
            <span class="r34 r">sb</span>.<span class="i">Append</span>(<span class="r33 r">funcDefn</span>.<a href="../parser/ast.cs.html#98eceea7e3f7c2a6" class="i method">GetParamTextFromParameterList</a>());
            <span class="r34 r">sb</span>.<span class="i">Append</span>(<span class="r33 r">funcDefn</span>.<a href="../parser/ast.cs.html#201bce3cfc040274" class="i property">Body</a>.<a href="../parser/ast.cs.html#8753abaf002f9597" class="i method">ToStringForSerialization</a>());
            <b>return</b> <span class="r34 r">sb</span>.<span class="i">ToString</span>();
        }
    }
 
    [<span class="i">Serializable</span>]
    <b>public</b> <a href="../../P/eea83b421baeaca4.html" target="s" class="k">partial</a> <b>class</b> <a id="eea83b421baeaca4" href="../../R/eea83b421baeaca4.html" target="n" data-glyph="0,0" class="t t">ScriptBlock</a> : <span class="i">ISerializable</span>
    {
        <b>private readonly</b> <a href="#a80c8ca7922183a5" class="t t">CompiledScriptBlockData</a> <a id="93a1a6c2d4f99ed6" href="../../R/93a1a6c2d4f99ed6.html" target="n" data-glyph="46,1" class="i field">_scriptBlockData</a>;
 
        <b>internal</b> <a id="7c5e468d9c460238" href="../../R/7c5e468d9c460238.html" target="n" data-glyph="74,1" class="t constructor">ScriptBlock</a>(<a href="../parser/ast.cs.html#063cc8bbea9e10f2" class="t t">IParameterMetadataProvider</a> <span id="r35 rd" class="r35 r">ast</span>, <b>bool</b> <span id="r36 rd" class="r36 r">isFilter</span>)
            : <a href="#cf87a3188da993bd" class="k">this</a>(<b>new</b> <a href="#50828b29768964ff" class="t constructor">CompiledScriptBlockData</a>(<span class="r35 r">ast</span>, <span class="r36 r">isFilter</span>))
        {
        }
 
        <b>private</b> <a id="cf87a3188da993bd" href="../../R/cf87a3188da993bd.html" target="n" data-glyph="76,1" class="t constructor">ScriptBlock</a>(<a href="#a80c8ca7922183a5" class="t t">CompiledScriptBlockData</a> <span id="r37 rd" class="r37 r">scriptBlockData</span>)
        {
            <a href="#93a1a6c2d4f99ed6" class="i field">_scriptBlockData</a> = <span class="r37 r">scriptBlockData</span>;
 
            <span class="c">// LanguageMode is a nullable PSLanguageMode enumeration because script blocks</span>
            <span class="c">// need to inherit the language mode from the context in which they are executing.</span>
            <span class="c">// We can&#39;t assume FullLanguage by default when there is no context, as there are</span>
            <span class="c">// script blocks (such as the script blocks used in Workflow activities) that are</span>
            <span class="c">// created by the host without a &quot;current language mode&quot; to inherit. They ultimately</span>
            <span class="c">// get their language mode set when they are finally invoked in a constrained</span>
            <span class="c">// language runspace.</span>
            <span class="c">// Script blocks that should always be run under FullLanguage mode (i.e.: set in</span>
            <span class="c">// InitialSessionState, etc.) should explicitly set the LanguageMode to FullLanguage</span>
            <span class="c">// when they are created.</span>
            <a href="../ExecutionContext.cs.html#130bda5418e8559c" class="t t">ExecutionContext</a> <span id="r38 rd" class="r38 r">context</span> = <a href="../hostifaces/LocalPipeline.cs.html#4ecb13103c10f113" class="t t">LocalPipeline</a>.<a href="../hostifaces/LocalPipeline.cs.html#d3eaa3d3391ed484" class="i method">GetExecutionContextFromTLS</a>();
            <b>if</b> (<span class="r38 r">context</span> != <b>null</b>)
            {
                <a href="../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="k">this</a>.<a href="../lang/scriptblock.cs.html#5e76a9fb0d1a7f12" class="i property">LanguageMode</a> = <span class="r38 r">context</span>.<a href="../ExecutionContext.cs.html#ebe55e376f6c32fa" class="i property">LanguageMode</a>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Protected constructor to support ISerializable.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>protected</b> <a id="bf36d05513805d34" href="../../R/../../0000000000.html" target="n" data-glyph="75,1" class="t constructor">ScriptBlock</a>(<span class="i">SerializationInfo</span> <span id="r39 rd" class="r39 r">info</span>, <span class="i">StreamingContext</span> <span id="r40 rd" class="r40 r">context</span>)
        {
        }
 
        <b>private static readonly</b> <span class="i">ConcurrentDictionary</span>&lt;<span class="i">Tuple</span>&lt;<b>string</b>, <b>string</b>&gt;, <a href="../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="t t">ScriptBlock</a>&gt; <a id="476efe9f8385183a" href="../../R/476efe9f8385183a.html" target="n" data-glyph="46,1" class="i field">s_cachedScripts</a> =
            <b>new</b> <span class="i">ConcurrentDictionary</span>&lt;<span class="i">Tuple</span>&lt;<b>string</b>, <b>string</b>&gt;, <a href="../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="t t">ScriptBlock</a>&gt;();
 
        <b>internal static</b> <a href="../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="t t">ScriptBlock</a> <a id="17ea1496446c8d9a" href="../../R/17ea1496446c8d9a.html" target="n" data-glyph="74,1" class="i method">TryGetCachedScriptBlock</a>(<b>string</b> <span id="r41 rd" class="r41 r">fileName</span>, <b>string</b> <span id="r42 rd" class="r42 r">fileContents</span>)
        {
            <b>if</b> (<a href="../Utils.cs.html#f365eaa75311eda0" class="t t">InternalTestHooks</a>.<a href="../Utils.cs.html#a188e382998526ae" class="i field">IgnoreScriptBlockCache</a>)
            {
                <b>return</b> <b>null</b>;
            }
 
            <a href="../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="t t">ScriptBlock</a> <span id="r43 rd" class="r43 r">scriptBlock</span>;
            <b>var</b> <span id="r44 rd" class="r44 r">key</span> = <span class="i">Tuple</span>.<span class="i">Create</span>(<span class="r41 r">fileName</span>, <span class="r42 r">fileContents</span>);
            <b>if</b> (<a href="#476efe9f8385183a" class="i field">s_cachedScripts</a>.<span class="i">TryGetValue</span>(<span class="r44 r">key</span>, <b>out</b> <span class="r43 r">scriptBlock</span>))
            {
                <a href="../../utils/assert.cs.html#c04955255430d32f" class="t t">Diagnostics</a>.<a href="../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(
                    <span class="r43 r">scriptBlock</span>.<a href="../lang/scriptblock.cs.html#d25a345294fd74f0" class="i property">SessionStateInternal</a> == <b>null</b>,
                    <span class="s">&quot;A cached scriptblock should not have it&#39;s session state bound, that causes a memory leak.&quot;</span>);
                <b>return</b> <span class="r43 r">scriptBlock</span>.<a href="#13c9ab07535d8eb6" class="i method">Clone</a>();
            }
 
            <b>return</b> <b>null</b>;
        }
 
        <b>private static bool</b> <a id="be11b32681947dcd" href="../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">IsDynamicKeyword</a>(<a href="../parser/ast.cs.html#d47621d83efd14de" class="t t">Ast</a> <span id="r45 rd" class="r45 r">ast</span>)
            =&gt; <span class="r45 r">ast</span> <b>is</b> <a href="../parser/ast.cs.html#a310aaa1e0374ddd" class="t t">CommandAst</a> <span id="r46 rd" class="r46 r">cmdAst</span> &amp;&amp; <span class="r46 r">cmdAst</span>.<a href="../parser/ast.cs.html#38c09f0576bc413e" class="i property">DefiningKeyword</a> != <b>null</b>;
 
        <b>private static bool</b> <a id="89209f8206f7af2a" href="../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">IsUsingTypes</a>(<a href="../parser/ast.cs.html#d47621d83efd14de" class="t t">Ast</a> <span id="r47 rd" class="r47 r">ast</span>)
            =&gt; <span class="r47 r">ast</span> <b>is</b> <a href="../parser/ast.cs.html#a269e1753cbc4c90" class="t t">UsingStatementAst</a> <span id="r48 rd" class="r48 r">cmdAst</span> &amp;&amp; <span class="r48 r">cmdAst</span>.<a href="../parser/ast.cs.html#6eade438e49592dc" class="i method">IsUsingModuleOrAssembly</a>();
 
        <b>internal static void</b> <a id="625bd5ac188d701f" href="../../R/625bd5ac188d701f.html" target="n" data-glyph="74,1" class="i method">CacheScriptBlock</a>(<a href="../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="t t">ScriptBlock</a> <span id="r49 rd" class="r49 r">scriptBlock</span>, <b>string</b> <span id="r50 rd" class="r50 r">fileName</span>, <b>string</b> <span id="r51 rd" class="r51 r">fileContents</span>)
        {
            <b>if</b> (<a href="../Utils.cs.html#f365eaa75311eda0" class="t t">InternalTestHooks</a>.<a href="../Utils.cs.html#a188e382998526ae" class="i field">IgnoreScriptBlockCache</a>)
            {
                <b>return</b>;
            }
 
            <span class="c">// Don&#39;t cache scriptblocks that have</span>
            <span class="c">// a) dynamic keywords</span>
            <span class="c">// b) &#39;using module&#39; or &#39;using assembly&#39;</span>
            <span class="c">// The definition of the dynamic keyword could change, consequently changing how the source text should be parsed.</span>
            <span class="c">// Exported types definitions from &#39;using module&#39; could change, we need to do all parse-time checks again.</span>
            <span class="c">// TODO(sevoroby): we can optimize it to ignore &#39;using&#39; if there are no actual type usage in locally defined types.</span>
 
            <span class="c">// using is always a top-level statements in scriptBlock, we don&#39;t need to search in child blocks.</span>
            <b>if</b> (<span class="r49 r">scriptBlock</span>.<a href="#e028cdfe16daf552" class="i property">Ast</a>.<span class="i">Find</span>(<b>static</b> <span id="r52 rd" class="r52 r">ast</span> =&gt; <span class="i">IsUsingTypes</span>(<span class="r52 r">ast</span>), <b>false</b>) != <b>null</b>
                || <span class="r49 r">scriptBlock</span>.<a href="#e028cdfe16daf552" class="i property">Ast</a>.<span class="i">Find</span>(<b>static</b> <span id="r53 rd" class="r53 r">ast</span> =&gt; <span class="i">IsDynamicKeyword</span>(<span class="r53 r">ast</span>), <b>true</b>) != <b>null</b>)
            {
                <b>return</b>;
            }
 
            <b>if</b> (<a href="#476efe9f8385183a" class="i field">s_cachedScripts</a>.<span class="i">Count</span> &gt; 1024)
            {
                <a href="#476efe9f8385183a" class="i field">s_cachedScripts</a>.<span class="i">Clear</span>();
            }
 
            <b>var</b> <span id="r54 rd" class="r54 r">key</span> = <span class="i">Tuple</span>.<span class="i">Create</span>(<span class="r50 r">fileName</span>, <span class="r51 r">fileContents</span>);
            <a href="#476efe9f8385183a" class="i field">s_cachedScripts</a>.<span class="i">TryAdd</span>(<span class="r54 r">key</span>, <span class="r49 r">scriptBlock</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Clears the cached scriptblocks.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal static void</b> <a id="b39ce8dfc972e20e" href="../../R/../../0000000000.html" target="n" data-glyph="74,1" class="i method">ClearScriptBlockCache</a>()
        {
            <a href="#476efe9f8385183a" class="i field">s_cachedScripts</a>.<span class="i">Clear</span>();
        }
 
        <b>internal static readonly</b> <a href="../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="t t">ScriptBlock</a> <a id="dc12e2c318ee7aef" href="../../R/dc12e2c318ee7aef.html" target="n" data-glyph="44,1" class="i field">EmptyScriptBlock</a> =
            <a href="../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="t t">ScriptBlock</a>.<span class="i">CreateDelayParsedScriptBlock</span>(<b>string</b>.<span class="i">Empty</span>, <span class="i">isProductCode</span>: <b>true</b>);
 
        <b>internal static</b> <a href="../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="t t">ScriptBlock</a> <a id="7dc3df5a13c2e779" href="../../R/7dc3df5a13c2e779.html" target="n" data-glyph="74,1" class="i method">Create</a>(<a href="../parser/Parser.cs.html#bbf5e856fb3215c5" class="t t">Parser</a> <span id="r55 rd" class="r55 r">parser</span>, <b>string</b> <span id="r56 rd" class="r56 r">fileName</span>, <b>string</b> <span id="r57 rd" class="r57 r">fileContents</span>)
        {
            <a href="../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="k">var</a> <span id="r58 rd" class="r58 r">scriptBlock</span> = <a href="#17ea1496446c8d9a" class="i method">TryGetCachedScriptBlock</a>(<span class="r56 r">fileName</span>, <span class="r57 r">fileContents</span>);
            <b>if</b> (<span class="r58 r">scriptBlock</span> != <b>null</b>)
            {
                <b>return</b> <span class="r58 r">scriptBlock</span>;
            }
 
            <a href="../parser/ast.cs.html#6f963589327835a4" class="k">var</a> <span id="r59 rd" class="r59 r">ast</span> = <span class="r55 r">parser</span>.<a href="../parser/Parser.cs.html#3b3edfaa9020f895" class="i method">Parse</a>(<span class="r56 r">fileName</span>, <span class="r57 r">fileContents</span>, <b>null</b>, <b>out</b> <a href="../parser/Parser.cs.html#3b2ee49e322daa35" class="t t">ParseError</a>[] <span id="r60 rd" class="r60 r">errors</span>, <a href="../parser/Parser.cs.html#5c0497999a31aece" class="t t">ParseMode</a>.<a href="../parser/Parser.cs.html#33fb9c7ca2039a3e" class="i field">Default</a>);
            <b>if</b> (<span class="r60 r">errors</span>.<span class="i">Length</span> != 0)
            {
                <b>throw</b> <b>new</b> <a href="../../utils/ParserException.cs.html#62f3ee5b65dd2bdb" class="t constructor">ParseException</a>(<span class="r60 r">errors</span>);
            }
 
            <a href="../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="k">var</a> <span id="r61 rd" class="r61 r">result</span> = <b>new</b> <a href="#7c5e468d9c460238" class="t constructor">ScriptBlock</a>(<span class="r59 r">ast</span>, <span class="r36 r">isFilter</span>: <b>false</b>);
            <a href="#625bd5ac188d701f" class="i method">CacheScriptBlock</a>(<span class="r61 r">result</span>, <span class="r56 r">fileName</span>, <span class="r57 r">fileContents</span>);
 
            <span class="c">// The value returned will potentially be bound to a session state.  We don&#39;t want</span>
            <span class="c">// the cached script block to end up being bound to any session state, so clone</span>
            <span class="c">// the return value to ensure the cached value has no session state.</span>
            <b>return</b> <span class="r61 r">result</span>.<a href="#13c9ab07535d8eb6" class="i method">Clone</a>();
        }
 
        <b>internal</b> <a href="../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="t t">ScriptBlock</a> <a id="13c9ab07535d8eb6" href="../../R/13c9ab07535d8eb6.html" target="n" data-glyph="74,1" class="i method">Clone</a>() =&gt; <b>new</b> <a href="#cf87a3188da993bd" class="t constructor">ScriptBlock</a>(<a href="#93a1a6c2d4f99ed6" class="i field">_scriptBlockData</a>);
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Returns the text of the script block.  The return value might not match the original text exactly.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public override string</b> <a id="89c5da438a36dbb2" href="../../R/89c5da438a36dbb2.html" target="n" data-glyph="72,1" class="i method">ToString</a>() =&gt; <a href="#93a1a6c2d4f99ed6" class="i field">_scriptBlockData</a>.<a href="#d01244957535ade1" class="i method">ToString</a>();
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Returns the text of the script block with the handling of $using expressions.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal string</b> <a id="79dc129fc5b444af" href="../../R/../../0000000000.html" target="n" data-glyph="74,1" class="i method">ToStringWithDollarUsingHandling</a>(
            <span class="i">Tuple</span>&lt;<span class="i">List</span>&lt;<a href="../parser/ast.cs.html#248562b22b336dec" class="t t">VariableExpressionAst</a>&gt;, <b>string</b>&gt; <span id="r62 rd" class="r62 r">usingVariablesTuple</span>)
        {
            <a href="../parser/ast.cs.html#dd61b2a7b388405b" class="t t">FunctionDefinitionAst</a> <span id="r63 rd" class="r63 r">funcDefn</span> = <b>null</b>;
            <a href="../parser/ast.cs.html#6f963589327835a4" class="k">var</a> <span id="r64 rd" class="r64 r">sbAst</span> = <a href="#e028cdfe16daf552" class="i property">Ast</a> <b>as</b> <a href="../parser/ast.cs.html#6f963589327835a4" class="t t">ScriptBlockAst</a>;
            <b>if</b> (<span class="r64 r">sbAst</span> == <b>null</b>)
            {
                <span class="r63 r">funcDefn</span> = (<a href="../parser/ast.cs.html#dd61b2a7b388405b" class="t t">FunctionDefinitionAst</a>)<a href="#e028cdfe16daf552" class="i property">Ast</a>;
                <span class="r64 r">sbAst</span> = <span class="r63 r">funcDefn</span>.<a href="../parser/ast.cs.html#201bce3cfc040274" class="i property">Body</a>;
            }
 
            <b>string</b> <span id="r65 rd" class="r65 r">sbText</span> = <span class="r64 r">sbAst</span>.<a href="../parser/ast.cs.html#8a9e338706865ac2" class="i method">ToStringForSerialization</a>(<span class="r62 r">usingVariablesTuple</span>, <span class="r64 r">sbAst</span>.<a href="../parser/ast.cs.html#d9d5cd324ee61136" class="i property">Extent</a>.<a href="../parser/Position.cs.html#14e0029eb01de3bb" class="i property">StartOffset</a>, <span class="r64 r">sbAst</span>.<a href="../parser/ast.cs.html#d9d5cd324ee61136" class="i property">Extent</a>.<a href="../parser/Position.cs.html#ca890c6b6bd34ec4" class="i property">EndOffset</a>);
            <b>if</b> (<span class="r64 r">sbAst</span>.<a href="../parser/ast.cs.html#3fd8788db62344d2" class="i property">ParamBlock</a> != <b>null</b>)
            {
                <b>return</b> <span class="r65 r">sbText</span>;
            }
 
            <b>string</b> <span id="r66 rd" class="r66 r">paramText</span>;
            <b>string</b> <span id="r67 rd" class="r67 r">additionalNewParams</span> = <span class="r62 r">usingVariablesTuple</span>.<span class="i">Item2</span>;
            <b>if</b> (<span class="r63 r">funcDefn</span> == <b>null</b> || <span class="r63 r">funcDefn</span>.<a href="../parser/ast.cs.html#653a0e4bf79364c2" class="i property">Parameters</a> == <b>null</b>)
            {
                <span class="r66 r">paramText</span> = <span class="s">&quot;param(&quot;</span> + <span class="r67 r">additionalNewParams</span> + <span class="s">&quot;)&quot;</span> + <span class="i">Environment</span>.<span class="i">NewLine</span>;
            }
            <b>else</b>
            {
                <span class="r66 r">paramText</span> = <span class="r63 r">funcDefn</span>.<a href="../parser/ast.cs.html#98eceea7e3f7c2a6" class="i method">GetParamTextFromParameterList</a>(<span class="r62 r">usingVariablesTuple</span>);
            }
 
            <span class="r65 r">sbText</span> = <span class="r66 r">paramText</span> + <span class="r65 r">sbText</span>;
            <b>return</b> <span class="r65 r">sbText</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Support for </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">ISerializable</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c">.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public virtual void</b> <a id="2b3c8446024b6c84" href="../../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">GetObjectData</a>(<span class="i">SerializationInfo</span> <span id="r68 rd" class="r68 r">info</span>, <span class="i">StreamingContext</span> <span id="r69 rd" class="r69 r">context</span>)
        {
            <b>if</b> (<span class="r68 r">info</span> == <b>null</b>)
            {
                <b>throw</b> <a href="../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../../utils/MshTraceSource.cs.html#fbe67220ad7522a0" class="i method">NewArgumentNullException</a>(<b>nameof</b>(<span class="r68 r">info</span>));
            }
 
            <b>string</b> <span id="r70 rd" class="r70 r">serializedContent</span> = <a href="../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="k">this</a>.<a href="#89c5da438a36dbb2" class="i method">ToString</a>();
            <span class="r68 r">info</span>.<span class="i">AddValue</span>(<span class="s">&quot;ScriptText&quot;</span>, <span class="r70 r">serializedContent</span>);
            <span class="r68 r">info</span>.<span class="i">SetType</span>(<b>typeof</b>(<a href="#79a312bbf298b06b" class="t t">ScriptBlockSerializationHelper</a>));
        }
 
        <b>internal</b> <a href="../hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShell</a> <a id="4904fe35fcc2ecfc" href="../../R/4904fe35fcc2ecfc.html" target="n" data-glyph="74,1" class="i method">GetPowerShellImpl</a>(
            <a href="../ExecutionContext.cs.html#130bda5418e8559c" class="t t">ExecutionContext</a> <span id="r71 rd" class="r71 r">context</span>,
            <span class="i">Dictionary</span>&lt;<b>string</b>, <b>object</b>&gt; <span id="r72 rd" class="r72 r">variables</span>,
            <b>bool</b> <span id="r73 rd" class="r73 r">isTrustedInput</span>,
            <b>bool</b> <span id="r74 rd" class="r74 r">filterNonUsingVariables</span>,
            <b>bool</b>? <span id="r75 rd" class="r75 r">createLocalScope</span>,
            <b>params object</b>[] <span id="r76 rd" class="r76 r">args</span>)
        {
            <b>return</b> <a href="#02087845babe4650" class="i property">AstInternal</a>.<a href="../parser/ast.cs.html#43e8e80a08c89ef8" class="i method">GetPowerShell</a>(
                <span class="r71 r">context</span>,
                <span class="r72 r">variables</span>,
                <span class="r73 r">isTrustedInput</span>,
                <span class="r74 r">filterNonUsingVariables</span>,
                <span class="r75 r">createLocalScope</span>,
                <span class="r76 r">args</span>);
        }
 
        <b>internal</b> <a href="../lang/scriptblock.cs.html#5e20a8a88cfbe6cb" class="t t">SteppablePipeline</a> <a id="7755d861f33d4515" href="../../R/7755d861f33d4515.html" target="n" data-glyph="74,1" class="i method">GetSteppablePipelineImpl</a>(<a href="../SecurityManagerBase.cs.html#a1d5a2ba5cd1b3aa" class="t t">CommandOrigin</a> <span id="r77 rd" class="r77 r">commandOrigin</span>, <b>object</b>[] <span id="r78 rd" class="r78 r">args</span>)
        {
            <a href="../parser/ast.cs.html#785915ec8547ce9f" class="k">var</a> <span id="r79 rd" class="r79 r">pipelineAst</span> = <span class="i">GetSimplePipeline</span>(
                <span id="r80 rd" class="r80 r">resourceString</span> =&gt; <b>throw</b> <a href="../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<span class="i">NewInvalidOperationException</span>(<span class="r80 r">resourceString</span>));
            <a href="../../utils/assert.cs.html#c04955255430d32f" class="t t">Diagnostics</a>.<a href="../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r79 r">pipelineAst</span> != <b>null</b>, <span class="s">&quot;This should be checked by GetSimplePipeline&quot;</span>);
 
            <b>if</b> (<span class="r79 r">pipelineAst</span>.<a href="../parser/ast.cs.html#edccd333bf2ee4d5" class="i property">PipelineElements</a>[0] <b>is not</b> <a href="../parser/ast.cs.html#a310aaa1e0374ddd" class="t t">CommandAst</a>)
            {
                <b>throw</b> <a href="../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<span class="i">NewInvalidOperationException</span>(<span class="i">AutomationExceptions</span>.<span class="i">CantConvertEmptyPipeline</span>);
            }
 
            <b>return</b> <a href="Operations/MiscOps.cs.html#533f892ba25eaa2f" class="t t">PipelineOps</a>.<a href="Operations/MiscOps.cs.html#83ec5f802f317eaa" class="i method">GetSteppablePipeline</a>(<span class="r79 r">pipelineAst</span>, <span class="r77 r">commandOrigin</span>, <a href="../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="k">this</a>, <span class="r78 r">args</span>);
        }
 
        <b>private</b> <a href="../parser/ast.cs.html#785915ec8547ce9f" class="t t">PipelineAst</a> <a id="3da7ebc08ccdbede" href="../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">GetSimplePipeline</a>(<span class="i">Func</span>&lt;<b>string</b>, <a href="../parser/ast.cs.html#785915ec8547ce9f" class="t t">PipelineAst</a>&gt; <span id="r81 rd" class="r81 r">errorHandler</span>)
        {
            <span class="r81 r">errorHandler</span> ??= (<b>static</b> <span id="r82 rd" class="r82 r">_</span> =&gt; <b>null</b>);
 
            <b>if</b> (<a href="#680dd2bf19ec8364" class="i property">HasBeginBlock</a> || <a href="#5ee5abba7294e48d" class="i property">HasProcessBlock</a>)
            {
                <b>return</b> <span class="r81 r">errorHandler</span>(<span class="i">AutomationExceptions</span>.<span class="i">CanConvertOneClauseOnly</span>);
            }
 
            <a href="../parser/ast.cs.html#063cc8bbea9e10f2" class="k">var</a> <span id="r83 rd" class="r83 r">ast</span> = <a href="#02087845babe4650" class="i property">AstInternal</a>;
            <b>var</b> <span id="r84 rd" class="r84 r">statements</span> = <span class="r83 r">ast</span>.<a href="../parser/ast.cs.html#b25d4ae40ae3a393" class="i property">Body</a>.<a href="../parser/ast.cs.html#958e631868900aba" class="i property">EndBlock</a>.<a href="../parser/ast.cs.html#496f71fcd5c4e6a1" class="i property">Statements</a>;
            <b>if</b> (<span class="r84 r">statements</span>.<span class="i">Count</span> == 0)
            {
                <b>return</b> <span class="r81 r">errorHandler</span>(<span class="i">AutomationExceptions</span>.<span class="i">CantConvertEmptyPipeline</span>);
            }
 
            <b>if</b> (<span class="r84 r">statements</span>.<span class="i">Count</span> &gt; 1)
            {
                <b>return</b> <span class="r81 r">errorHandler</span>(<span class="i">AutomationExceptions</span>.<span class="i">CanOnlyConvertOnePipeline</span>);
            }
 
            <b>if</b> (<span class="r83 r">ast</span>.<a href="../parser/ast.cs.html#b25d4ae40ae3a393" class="i property">Body</a>.<a href="../parser/ast.cs.html#958e631868900aba" class="i property">EndBlock</a>.<a href="../parser/ast.cs.html#2b645ddd993169db" class="i property">Traps</a> != <b>null</b> &amp;&amp; <span class="r83 r">ast</span>.<a href="../parser/ast.cs.html#b25d4ae40ae3a393" class="i property">Body</a>.<a href="../parser/ast.cs.html#958e631868900aba" class="i property">EndBlock</a>.<a href="../parser/ast.cs.html#2b645ddd993169db" class="i property">Traps</a>.<span class="i">Count</span> &gt; 0)
            {
                <b>return</b> <span class="r81 r">errorHandler</span>(<span class="i">AutomationExceptions</span>.<span class="i">CantConvertScriptBlockWithTrap</span>);
            }
 
            <b>if</b> (!(<span class="r84 r">statements</span>[0] <b>is</b> <a href="../parser/ast.cs.html#785915ec8547ce9f" class="t t">PipelineAst</a> <span id="r85 rd" class="r85 r">pipeAst</span>))
            {
                <b>return</b> <span class="r81 r">errorHandler</span>(<span class="i">AutomationExceptions</span>.<span class="i">CanOnlyConvertOnePipeline</span>);
            }
 
            <span class="c">// The old code checked for empty pipeline.</span>
            <span class="c">// That can&#39;t happen in the new parser (validated in the constructors),</span>
            <span class="c">// so the resource CantConvertEmptyPipeline is probably unused.</span>
 
            <b>return</b> <span class="r85 r">pipeAst</span>;
        }
 
        <b>internal</b> <span class="i">List</span>&lt;<span class="i">Attribute</span>&gt; <a id="4d049ecd74717744" href="../../R/4d049ecd74717744.html" target="n" data-glyph="74,1" class="i method">GetAttributes</a>() =&gt; <a href="#93a1a6c2d4f99ed6" class="i field">_scriptBlockData</a>.<a href="#5f788763f11d9553" class="i method">GetAttributes</a>();
 
        <b>internal string</b> <a id="0d05bf065e4a0270" href="../../R/0d05bf065e4a0270.html" target="n" data-glyph="74,1" class="i method">GetFileName</a>() =&gt; <a href="#02087845babe4650" class="i property">AstInternal</a>.<a href="../parser/ast.cs.html#b25d4ae40ae3a393" class="i property">Body</a>.<a href="../parser/ast.cs.html#d9d5cd324ee61136" class="i property">Extent</a>.<a href="../parser/Position.cs.html#e933edecd2b0cc1d" class="i property">File</a>;
 
        <span class="c">// GetAttributes() is asserted never return null</span>
        <b>internal bool</b> <a id="e23a7d51c5f3a7e6" href="../../R/e23a7d51c5f3a7e6.html" target="n" data-glyph="74,1" class="i method">IsMetaConfiguration</a>() =&gt; <a href="#4d049ecd74717744" class="i method">GetAttributes</a>().<span class="i">OfType</span>&lt;<a href="../Attributes.cs.html#94fe11f1e2480ea1" class="t t">DscLocalConfigurationManagerAttribute</a>&gt;().<span class="i">Any</span>();
 
        <b>internal</b> <a href="../lang/interface/PSToken.cs.html#3bec645a477d668a" class="t t">PSToken</a> <a id="b85cdcd56f3f4eb2" href="../../R/b85cdcd56f3f4eb2.html" target="n" data-glyph="74,1" class="i method">GetStartPosition</a>() =&gt; <b>new</b> <a href="../lang/interface/PSToken.cs.html#de937415f3fb7c6e" class="t constructor">PSToken</a>(<a href="#e028cdfe16daf552" class="i property">Ast</a>.<a href="../parser/ast.cs.html#d9d5cd324ee61136" class="i property">Extent</a>);
 
        <b>internal</b> <a href="../MergedCommandParameterMetadata.cs.html#2ce55afbd6d4dfde" class="t t">MergedCommandParameterMetadata</a> <a id="56719d9b47343722" href="../../R/56719d9b47343722.html" target="n" data-glyph="104,1" class="i property">ParameterMetadata</a>
        {
            <b>get</b> =&gt; <a href="#93a1a6c2d4f99ed6" class="i field">_scriptBlockData</a>.<a href="#cba0c16805c0aee1" class="i method">GetParameterMetadata</a>(<a href="../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="k">this</a>);
        }
 
        <b>internal bool</b> <a id="42e46e4ff0244eb3" href="../../R/42e46e4ff0244eb3.html" target="n" data-glyph="104,1" class="i property">UsesCmdletBinding</a> { <b>get</b> =&gt; <a href="#93a1a6c2d4f99ed6" class="i field">_scriptBlockData</a>.<a href="#a6b53fb28ca80b16" class="i property">UsesCmdletBinding</a>; }
 
        <b>internal bool</b> <a id="1e6d0becba712301" href="../../R/1e6d0becba712301.html" target="n" data-glyph="104,1" class="i property">HasDynamicParameters</a> { <b>get</b> =&gt; <a href="#02087845babe4650" class="i property">AstInternal</a>.<a href="../parser/ast.cs.html#b25d4ae40ae3a393" class="i property">Body</a>.<a href="../parser/ast.cs.html#4549d1761658a004" class="i property">DynamicParamBlock</a> != <b>null</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> DebuggerHidden.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public bool</b> <a id="6bbac4f67f789407" href="../../R/6bbac4f67f789407.html" target="n" data-glyph="102,1" class="i property">DebuggerHidden</a>
        {
            <b>get</b> =&gt; <a href="#93a1a6c2d4f99ed6" class="i field">_scriptBlockData</a>.<a href="#0deff729c13c207d" class="i property">DebuggerHidden</a>;
            <b>set</b> =&gt; <a href="#93a1a6c2d4f99ed6" class="i field">_scriptBlockData</a>.<a href="#0deff729c13c207d" class="i property">DebuggerHidden</a> = <b>value</b>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The unique ID of this script block.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public</b> <span class="i">Guid</span> <a id="84b30017d1a078db" href="../../R/84b30017d1a078db.html" target="n" data-glyph="102,1" class="i property">Id</a> { <b>get</b> =&gt; <a href="#93a1a6c2d4f99ed6" class="i field">_scriptBlockData</a>.<a href="#039ec6feee61aa62" class="i property">Id</a>; }
 
        <b>internal bool</b> <a id="28f1dfc28a9bfb01" href="../../R/28f1dfc28a9bfb01.html" target="n" data-glyph="104,1" class="i property">DebuggerStepThrough</a>
        {
            <b>get</b> { <b>return</b> <a href="#93a1a6c2d4f99ed6" class="i field">_scriptBlockData</a>.<a href="#aebb4a2acbb378c0" class="i property">DebuggerStepThrough</a>; }
 
            <b>set</b> { <a href="#93a1a6c2d4f99ed6" class="i field">_scriptBlockData</a>.<a href="#aebb4a2acbb378c0" class="i property">DebuggerStepThrough</a> = <b>value</b>; }
        }
 
        <b>internal</b> <a href="../PseudoParameters.cs.html#d55a14219c7e096c" class="t t">RuntimeDefinedParameterDictionary</a> <a id="61f3934e64edc598" href="../../R/61f3934e64edc598.html" target="n" data-glyph="104,1" class="i property">RuntimeDefinedParameters</a>
        {
            <b>get</b> =&gt; <a href="#93a1a6c2d4f99ed6" class="i field">_scriptBlockData</a>.<a href="#9fcfbb034bb3c718" class="i property">RuntimeDefinedParameters</a>;
        }
 
        <b>internal bool</b> <a id="a2fb56b3538e8ff4" href="../../R/a2fb56b3538e8ff4.html" target="n" data-glyph="104,1" class="i property">HasLogged</a>
        {
            <b>get</b> =&gt; <a href="#93a1a6c2d4f99ed6" class="i field">_scriptBlockData</a>.<a href="#158ef5e0ad41505a" class="i property">HasLogged</a>;
            <b>set</b> =&gt; <a href="#93a1a6c2d4f99ed6" class="i field">_scriptBlockData</a>.<a href="#158ef5e0ad41505a" class="i property">HasLogged</a> = <b>value</b>;
        }
 
        <b>internal bool</b> <a id="f04bfb1d05890259" href="../../R/f04bfb1d05890259.html" target="n" data-glyph="104,1" class="i property">SkipLogging</a>
        {
            <b>get</b> { <b>return</b> <a href="#93a1a6c2d4f99ed6" class="i field">_scriptBlockData</a>.<a href="#984b8769a8333424" class="i property">SkipLogging</a>; }
 
            <b>set</b> { <a href="#93a1a6c2d4f99ed6" class="i field">_scriptBlockData</a>.<a href="#984b8769a8333424" class="i property">SkipLogging</a> = <b>value</b>; }
        }
 
        <b>internal</b> <span class="i">Assembly</span> <a id="37830aab9aece092" href="../../R/37830aab9aece092.html" target="n" data-glyph="104,1" class="i property">AssemblyDefiningPSTypes</a> { <b>get</b>; <b>set</b>; }
 
        <b>internal</b> <a href="../../help/HelpInfo.cs.html#d64eccc845958c22" class="t t">HelpInfo</a> <a id="e66fc4ae4110c000" href="../../R/e66fc4ae4110c000.html" target="n" data-glyph="74,1" class="i method">GetHelpInfo</a>(
            <a href="../ExecutionContext.cs.html#130bda5418e8559c" class="t t">ExecutionContext</a> <span id="r86 rd" class="r86 r">context</span>,
            <a href="../CommandInfo.cs.html#71babe57a99ca852" class="t t">CommandInfo</a> <span id="r87 rd" class="r87 r">commandInfo</span>,
            <b>bool</b> <span id="r88 rd" class="r88 r">dontSearchOnRemoteComputer</span>,
            <span class="i">Dictionary</span>&lt;<a href="../parser/ast.cs.html#d47621d83efd14de" class="t t">Ast</a>, <a href="../parser/token.cs.html#ec5d9ac6a36d920c" class="t t">Token</a>[]&gt; <span id="r89 rd" class="r89 r">scriptBlockTokenCache</span>,
            <b>out string</b> <span id="r90 rd" class="r90 r">helpFile</span>,
            <b>out string</b> <span id="r91 rd" class="r91 r">helpUriFromDotLink</span>)
        {
            <span class="r91 r">helpUriFromDotLink</span> = <b>null</b>;
 
            <b>var</b> <span id="r92 rd" class="r92 r">commentTokens</span> = <a href="../../help/HelpCommentsParser.cs.html#9f10a00eb0f83566" class="t t">HelpCommentsParser</a>.<a href="../../help/HelpCommentsParser.cs.html#20a6987da91cc728" class="i method">GetHelpCommentTokens</a>(<a href="#02087845babe4650" class="i property">AstInternal</a>, <span class="r89 r">scriptBlockTokenCache</span>);
            <b>if</b> (<span class="r92 r">commentTokens</span> != <b>null</b>)
            {
                <b>return</b> <a href="../../help/HelpCommentsParser.cs.html#9f10a00eb0f83566" class="t t">HelpCommentsParser</a>.<span class="i">CreateFromComments</span>(
                    <span class="r86 r">context</span>,
                    <span class="r87 r">commandInfo</span>,
                    <span class="r92 r">commentTokens</span>.<span class="i">Item1</span>,
                    <span class="r92 r">commentTokens</span>.<span class="i">Item2</span>,
                    <span class="r88 r">dontSearchOnRemoteComputer</span>,
                    <b>out</b> <span class="r90 r">helpFile</span>,
                    <b>out</b> <span class="r91 r">helpUriFromDotLink</span>);
            }
 
            <span class="r90 r">helpFile</span> = <b>null</b>;
            <b>return</b> <b>null</b>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Check the script block to see if it uses any language constructs not allowed in restricted language mode.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r93 r">allowedCommands</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The commands that are allowed.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r94 r">allowedVariables</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The variables allowed in this scriptblock. If this is null, then the default variable set</span>
        <span class="c">///</span><span class="c"> will be allowed. If it is an empty list, no variables will be allowed. If it is &quot;*&quot; then</span>
        <span class="c">///</span><span class="c"> any variable will be allowed.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r95 r">allowEnvironmentVariables</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The environment variables that are allowed.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>public void</b> <a id="ebeb50ec60013521" href="../../R/ebeb50ec60013521.html" target="n" data-glyph="72,1" class="i method">CheckRestrictedLanguage</a>(
            <span class="i">IEnumerable</span>&lt;<b>string</b>&gt; <span id="r93 rd" class="r93 r">allowedCommands</span>,
            <span class="i">IEnumerable</span>&lt;<b>string</b>&gt; <span id="r94 rd" class="r94 r">allowedVariables</span>,
            <b>bool</b> <span id="r95 rd" class="r95 r">allowEnvironmentVariables</span>)
        {
            <a href="../parser/Parser.cs.html#bbf5e856fb3215c5" class="t t">Parser</a> <span id="r96 rd" class="r96 r">parser</span> = <b>new</b> <a href="../parser/Parser.cs.html#aee2c3138d83ea53" class="t constructor">Parser</a>();
 
            <a href="../parser/ast.cs.html#063cc8bbea9e10f2" class="k">var</a> <span id="r97 rd" class="r97 r">ast</span> = <a href="#02087845babe4650" class="i property">AstInternal</a>;
            <b>if</b> (<a href="#680dd2bf19ec8364" class="i property">HasBeginBlock</a> || <a href="#5ee5abba7294e48d" class="i property">HasProcessBlock</a> || <span class="r97 r">ast</span>.<a href="../parser/ast.cs.html#b25d4ae40ae3a393" class="i property">Body</a>.<a href="../parser/ast.cs.html#3fd8788db62344d2" class="i property">ParamBlock</a> != <b>null</b>)
            {
                <a href="../parser/ast.cs.html#d47621d83efd14de" class="t t">Ast</a> <span id="r98 rd" class="r98 r">errorAst</span> = <span class="r97 r">ast</span>.<a href="../parser/ast.cs.html#b25d4ae40ae3a393" class="i property">Body</a>.<a href="../parser/ast.cs.html#08794a618a2d04ac" class="i property">BeginBlock</a> ?? (<a href="../parser/ast.cs.html#d47621d83efd14de" class="t t">Ast</a>)<span class="r97 r">ast</span>.<a href="../parser/ast.cs.html#b25d4ae40ae3a393" class="i property">Body</a>.<a href="../parser/ast.cs.html#8940fb8f9b3e6444" class="i property">ProcessBlock</a> ?? <span class="r97 r">ast</span>.<a href="../parser/ast.cs.html#b25d4ae40ae3a393" class="i property">Body</a>.<a href="../parser/ast.cs.html#3fd8788db62344d2" class="i property">ParamBlock</a>;
                <span class="r96 r">parser</span>.<span class="i">ReportError</span>(
                    <span class="r98 r">errorAst</span>.<a href="../parser/ast.cs.html#d9d5cd324ee61136" class="i property">Extent</a>,
                    <b>nameof</b>(<span class="i">ParserStrings</span>.<span class="i">InvalidScriptBlockInDataSection</span>),
                    <span class="i">ParserStrings</span>.<span class="i">InvalidScriptBlockInDataSection</span>);
            }
 
            <b>if</b> (<a href="#e0cf74ca3d5f266a" class="i property">HasEndBlock</a>)
            {
                <a href="../parser/SemanticChecks.cs.html#7c9c4e1c1c4e828d" class="k">var</a> <span id="r99 rd" class="r99 r">rlc</span> = <b>new</b> <a href="../parser/SemanticChecks.cs.html#83c5d1ad64eb6f9a" class="t constructor">RestrictedLanguageChecker</a>(
                    <span class="r96 r">parser</span>,
                    <span class="r93 r">allowedCommands</span>,
                    <span class="r94 r">allowedVariables</span>,
                    <span class="r95 r">allowEnvironmentVariables</span>);
 
                <a href="../parser/ast.cs.html#268644c84b225866" class="t t">StatementBlockAst</a>.<a href="../parser/ast.cs.html#e97d641fd893bf3f" class="i method">InternalVisit</a>(
                    <span class="r99 r">rlc</span>,
                    <span class="r97 r">ast</span>.<a href="../parser/ast.cs.html#b25d4ae40ae3a393" class="i property">Body</a>.<a href="../parser/ast.cs.html#958e631868900aba" class="i property">EndBlock</a>.<a href="../parser/ast.cs.html#2b645ddd993169db" class="i property">Traps</a>,
                    <span class="r97 r">ast</span>.<a href="../parser/ast.cs.html#b25d4ae40ae3a393" class="i property">Body</a>.<a href="../parser/ast.cs.html#958e631868900aba" class="i property">EndBlock</a>.<a href="../parser/ast.cs.html#496f71fcd5c4e6a1" class="i property">Statements</a>,
                    <a href="../parser/PreOrderVisitor.cs.html#1a6b8cf9a4c6249a" class="t t">AstVisitAction</a>.<a href="../parser/PreOrderVisitor.cs.html#eaa9a8bac592128a" class="i field">Continue</a>);
            }
 
            <b>if</b> (<span class="r96 r">parser</span>.<a href="../parser/Parser.cs.html#e8f5d233c7c0eda2" class="i property">ErrorList</a>.<span class="i">Count</span> &gt; 0)
            {
                <b>throw</b> <b>new</b> <span class="t">ParseException</span>(<span class="r96 r">parser</span>.<a href="../parser/Parser.cs.html#e8f5d233c7c0eda2" class="i property">ErrorList</a>.<span class="i">ToArray</span>());
            }
        }
 
        <b>internal string</b> <a id="4a1a7db17b43318d" href="../../R/4a1a7db17b43318d.html" target="n" data-glyph="74,1" class="i method">GetWithInputHandlingForInvokeCommand</a>() =&gt; <a href="#02087845babe4650" class="i property">AstInternal</a>.<a href="../parser/ast.cs.html#9eb35ed25013c0ba" class="i method">GetWithInputHandlingForInvokeCommand</a>();
 
        <b>internal string</b> <a id="b865ffde18eedc2d" href="../../R/../../0000000000.html" target="n" data-glyph="74,1" class="i method">GetWithInputHandlingForInvokeCommandWithUsingExpression</a>(
            <span class="i">Tuple</span>&lt;<span class="i">List</span>&lt;<a href="../parser/ast.cs.html#248562b22b336dec" class="t t">VariableExpressionAst</a>&gt;, <b>string</b>&gt; <span id="r100 rd" class="r100 r">usingVariablesTuple</span>)
        {
            <span class="i">Tuple</span>&lt;<b>string</b>, <b>string</b>&gt; <span id="r101 rd" class="r101 r">result</span> =
                <a href="#02087845babe4650" class="i property">AstInternal</a>.<a href="../parser/ast.cs.html#65bd5fb5ed6ed146" class="i method">GetWithInputHandlingForInvokeCommandWithUsingExpression</a>(<span class="r100 r">usingVariablesTuple</span>);
 
            <span class="c">// result.Item1 is ParamText; result.Item2 is ScriptBlockText</span>
            <b>return</b> <span class="r101 r">result</span>.<span class="i">Item1</span> == <b>null</b> ? <span class="r101 r">result</span>.<span class="i">Item2</span> : <span class="r101 r">result</span>.<span class="i">Item1</span> + <span class="r101 r">result</span>.<span class="i">Item2</span>;
        }
 
        <b>internal bool</b> <a id="92d6ae4085fe0c47" href="../../R/92d6ae4085fe0c47.html" target="n" data-glyph="74,1" class="i method">IsUsingDollarInput</a>() =&gt; <a href="../parser/AstVisitor.cs.html#5298c9a8d6287f90" class="t t">AstSearcher</a>.<a href="../parser/AstVisitor.cs.html#e53f8659ae77015d" class="i method">IsUsingDollarInput</a>(<a href="../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="k">this</a>.<a href="#e028cdfe16daf552" class="i property">Ast</a>);
 
        <b>internal void</b> <a id="3dc0ff0ae9ff4d22" href="../../R/3dc0ff0ae9ff4d22.html" target="n" data-glyph="74,1" class="i method">InvokeWithPipeImpl</a>(
            <b>bool</b> <span id="r102 rd" class="r102 r">createLocalScope</span>,
            <span class="i">Dictionary</span>&lt;<b>string</b>, <a href="../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="t t">ScriptBlock</a>&gt; <span id="r103 rd" class="r103 r">functionsToDefine</span>,
            <span class="i">List</span>&lt;<a href="../ShellVariable.cs.html#5bd16fef1f858b3d" class="t t">PSVariable</a>&gt; <span id="r104 rd" class="r104 r">variablesToDefine</span>,
            <a href="../lang/scriptblock.cs.html#10c045824f712272" class="t t">ErrorHandlingBehavior</a> <span id="r105 rd" class="r105 r">errorHandlingBehavior</span>,
            <b>object</b> <span id="r106 rd" class="r106 r">dollarUnder</span>,
            <b>object</b> <span id="r107 rd" class="r107 r">input</span>,
            <b>object</b> <span id="r108 rd" class="r108 r">scriptThis</span>,
            <a href="../Pipe.cs.html#59f1a03e60a5aa51" class="t t">Pipe</a> <span id="r109 rd" class="r109 r">outputPipe</span>,
            <a href="../InvocationInfo.cs.html#407d6c7d1ecbc8cc" class="t t">InvocationInfo</a> <span id="r110 rd" class="r110 r">invocationInfo</span>,
            <b>params object</b>[] <span id="r111 rd" class="r111 r">args</span>)
        {
            <a href="#278ab6100f6c91e7" class="i method">InvokeWithPipeImpl</a>(
                <a href="#34af49554c079f15" class="t t">ScriptBlockClauseToInvoke</a>.<a href="#60e19cf946da098d" class="i field">ProcessBlockOnly</a>,
                <span class="r102 r">createLocalScope</span>,
                <span class="r103 r">functionsToDefine</span>,
                <span class="r104 r">variablesToDefine</span>,
                <span class="r105 r">errorHandlingBehavior</span>,
                <span class="r106 r">dollarUnder</span>,
                <span class="r107 r">input</span>,
                <span class="r108 r">scriptThis</span>,
                <span class="r109 r">outputPipe</span>,
                <span class="r110 r">invocationInfo</span>,
                <span class="r111 r">args</span>);
        }
 
        <b>internal void</b> <a id="278ab6100f6c91e7" href="../../R/278ab6100f6c91e7.html" target="n" data-glyph="74,1" class="i method">InvokeWithPipeImpl</a>(
            <a href="#34af49554c079f15" class="t t">ScriptBlockClauseToInvoke</a> <span id="r112 rd" class="r112 r">clauseToInvoke</span>,
            <b>bool</b> <span id="r113 rd" class="r113 r">createLocalScope</span>,
            <span class="i">Dictionary</span>&lt;<b>string</b>, <a href="../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="t t">ScriptBlock</a>&gt; <span id="r114 rd" class="r114 r">functionsToDefine</span>,
            <span class="i">List</span>&lt;<a href="../ShellVariable.cs.html#5bd16fef1f858b3d" class="t t">PSVariable</a>&gt; <span id="r115 rd" class="r115 r">variablesToDefine</span>,
            <a href="../lang/scriptblock.cs.html#10c045824f712272" class="t t">ErrorHandlingBehavior</a> <span id="r116 rd" class="r116 r">errorHandlingBehavior</span>,
            <b>object</b> <span id="r117 rd" class="r117 r">dollarUnder</span>,
            <b>object</b> <span id="r118 rd" class="r118 r">input</span>,
            <b>object</b> <span id="r119 rd" class="r119 r">scriptThis</span>,
            <a href="../Pipe.cs.html#59f1a03e60a5aa51" class="t t">Pipe</a> <span id="r120 rd" class="r120 r">outputPipe</span>,
            <a href="../InvocationInfo.cs.html#407d6c7d1ecbc8cc" class="t t">InvocationInfo</a> <span id="r121 rd" class="r121 r">invocationInfo</span>,
            <b>params object</b>[] <span id="r122 rd" class="r122 r">args</span>)
        {
            <b>if</b> ((<span class="r112 r">clauseToInvoke</span> == <a href="#34af49554c079f15" class="t t">ScriptBlockClauseToInvoke</a>.<a href="#85ca98782a255c39" class="i field">Begin</a> &amp;&amp; !<a href="#680dd2bf19ec8364" class="i property">HasBeginBlock</a>)
                || (<span class="r112 r">clauseToInvoke</span> == <a href="#34af49554c079f15" class="t t">ScriptBlockClauseToInvoke</a>.<a href="#94c9d79f22dcf339" class="i field">Process</a> &amp;&amp; !<a href="#5ee5abba7294e48d" class="i property">HasProcessBlock</a>)
                || (<span class="r112 r">clauseToInvoke</span> == <a href="#34af49554c079f15" class="t t">ScriptBlockClauseToInvoke</a>.<a href="#0b20b164588bea50" class="i field">End</a> &amp;&amp; !<a href="#e0cf74ca3d5f266a" class="i property">HasEndBlock</a>))
            {
                <b>return</b>;
            }
 
            <a href="../ExecutionContext.cs.html#130bda5418e8559c" class="t t">ExecutionContext</a> <span id="r123 rd" class="r123 r">context</span> = <a href="../lang/scriptblock.cs.html#2203aa15482df0bc" class="i method">GetContextFromTLS</a>();
            <a href="../../utils/assert.cs.html#c04955255430d32f" class="t t">Diagnostics</a>.<a href="../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(
                <a href="../lang/scriptblock.cs.html#d25a345294fd74f0" class="i property">SessionStateInternal</a> == <b>null</b> || <a href="../lang/scriptblock.cs.html#d25a345294fd74f0" class="i property">SessionStateInternal</a>.<a href="../SessionState.cs.html#3ddff2db6bc01805" class="i property">ExecutionContext</a> == <span class="r123 r">context</span>,
                <span class="s">&quot;The scriptblock is being invoked in a runspace different than the one where it was created&quot;</span>);
 
            <b>if</b> (<span class="r123 r">context</span>.<a href="../ExecutionContext.cs.html#bc7d7c4d79ef05e4" class="i property">CurrentPipelineStopping</a>)
            {
                <b>throw</b> <b>new</b> <a href="../../utils/ExecutionExceptions.cs.html#105b0214d3aab114" class="t constructor">PipelineStoppedException</a>();
            }
 
            <span class="c">// Validate at the arguments are consistent. The only public API that gets you here never sets createLocalScope to false...</span>
            <a href="../../utils/assert.cs.html#c04955255430d32f" class="t t">Diagnostics</a>.<a href="../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(
                <span class="r113 r">createLocalScope</span> || <span class="r114 r">functionsToDefine</span> == <b>null</b>,
                <span class="s">&quot;When calling ScriptBlock.InvokeWithContext(), if &#39;functionsToDefine&#39; != null then &#39;createLocalScope&#39; must be true&quot;</span>);
            <a href="../../utils/assert.cs.html#c04955255430d32f" class="t t">Diagnostics</a>.<a href="../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(
                <span class="r113 r">createLocalScope</span> || <span class="r115 r">variablesToDefine</span> == <b>null</b>,
                <span class="s">&quot;When calling ScriptBlock.InvokeWithContext(), if &#39;variablesToDefine&#39; != null then &#39;createLocalScope&#39; must be true&quot;</span>);
 
            <b>if</b> (<span class="r122 r">args</span> == <b>null</b>)
            {
                <span class="r122 r">args</span> = <span class="i">Array</span>.<span class="i">Empty</span>&lt;<b>object</b>&gt;();
            }
 
            <b>bool</b> <span id="r124 rd" class="r124 r">runOptimized</span> = <span class="r123 r">context</span>.<a href="../ExecutionContext.cs.html#00e6fdde4b76eb15" class="i field">_debuggingMode</a> &lt;= 0 &amp;&amp; <span class="r113 r">createLocalScope</span>;
            <b>var</b> <span id="r125 rd" class="r125 r">codeToInvoke</span> = <a href="#58ca76fe16d8dda9" class="i method">GetCodeToInvoke</a>(<b>ref</b> <span class="r124 r">runOptimized</span>, <span class="r112 r">clauseToInvoke</span>);
            <b>if</b> (<span class="r125 r">codeToInvoke</span> == <b>null</b>)
            {
                <b>return</b>;
            }
 
            <b>if</b> (<span class="r120 r">outputPipe</span> == <b>null</b>)
            {
                <span class="c">// If we don&#39;t have a pipe to write to, we need to discard all results.</span>
                <span class="r120 r">outputPipe</span> = <b>new</b> <a href="../Pipe.cs.html#c1592456b1ff42b5" class="t constructor">Pipe</a> { <a href="../Pipe.cs.html#8ef98c4ec55d7204" class="i property">NullPipe</a> = <b>true</b> };
            }
 
            <a href="MutableTuple.cs.html#d4c692d6a8bac31d" class="k">var</a> <span id="r126 rd" class="r126 r">locals</span> = <a href="#74eb29587e65199f" class="i method">MakeLocalsTuple</a>(<span class="r124 r">runOptimized</span>);
 
            <b>if</b> (<span class="r117 r">dollarUnder</span> != <a href="../AutomationNull.cs.html#681fbea4c40e4af1" class="t t">AutomationNull</a>.<a href="../AutomationNull.cs.html#1cf7e193da582896" class="i property">Value</a>)
            {
                <span class="r126 r">locals</span>.<a href="MutableTuple.cs.html#b596dd33aa0e3dbc" class="i method">SetAutomaticVariable</a>(<a href="../SpecialVariables.cs.html#1c6f2efd91287b59" class="t t">AutomaticVariable</a>.<a href="../SpecialVariables.cs.html#3599fdc9d261201f" class="i field">Underbar</a>, <span class="r117 r">dollarUnder</span>, <span class="r123 r">context</span>);
            }
 
            <b>if</b> (<span class="r118 r">input</span> != <a href="../AutomationNull.cs.html#681fbea4c40e4af1" class="t t">AutomationNull</a>.<a href="../AutomationNull.cs.html#1cf7e193da582896" class="i property">Value</a>)
            {
                <span class="r126 r">locals</span>.<a href="MutableTuple.cs.html#b596dd33aa0e3dbc" class="i method">SetAutomaticVariable</a>(<a href="../SpecialVariables.cs.html#1c6f2efd91287b59" class="t t">AutomaticVariable</a>.<a href="../SpecialVariables.cs.html#52526bd30f8a492b" class="i field">Input</a>, <span class="r118 r">input</span>, <span class="r123 r">context</span>);
            }
 
            <b>if</b> (<span class="r119 r">scriptThis</span> != <a href="../AutomationNull.cs.html#681fbea4c40e4af1" class="t t">AutomationNull</a>.<a href="../AutomationNull.cs.html#1cf7e193da582896" class="i property">Value</a>)
            {
                <span class="r126 r">locals</span>.<a href="MutableTuple.cs.html#b596dd33aa0e3dbc" class="i method">SetAutomaticVariable</a>(<a href="../SpecialVariables.cs.html#1c6f2efd91287b59" class="t t">AutomaticVariable</a>.<a href="../SpecialVariables.cs.html#314e6b638d8d7ddc" class="i field">This</a>, <span class="r119 r">scriptThis</span>, <span class="r123 r">context</span>);
            }
 
            <a href="../lang/scriptblock.cs.html#a3474072505c30d2" class="i method">SetPSScriptRootAndPSCommandPath</a>(<span class="r126 r">locals</span>, <span class="r123 r">context</span>);
 
            <a href="../Pipe.cs.html#59f1a03e60a5aa51" class="k">var</a> <span id="r127 rd" class="r127 r">oldShellFunctionErrorOutputPipe</span> = <span class="r123 r">context</span>.<a href="../ExecutionContext.cs.html#d0ed5d60dd57b004" class="i property">ShellFunctionErrorOutputPipe</a>;
            <a href="../../utils/IObjectWriter.cs.html#37301df630b2ae9a" class="k">var</a> <span id="r128 rd" class="r128 r">oldExternalErrorOutput</span> = <span class="r123 r">context</span>.<a href="../ExecutionContext.cs.html#b62a014273263f69" class="i property">ExternalErrorOutput</a>;
            <a href="../SecurityManagerBase.cs.html#a1d5a2ba5cd1b3aa" class="k">var</a> <span id="r129 rd" class="r129 r">oldScopeOrigin</span> = <span class="r123 r">context</span>.<a href="../ExecutionContext.cs.html#07982205e4a6a726" class="i property">EngineSessionState</a>.<a href="../SessionStateScopeAPIs.cs.html#224987ad36a90f88" class="i property">CurrentScope</a>.<a href="../SessionStateScope.cs.html#84d072e625b581f5" class="i property">ScopeOrigin</a>;
            <a href="../../P/2dc1bd90a8299178.html#2dc1bd90a8299178" class="k">var</a> <span id="r130 rd" class="r130 r">oldSessionState</span> = <span class="r123 r">context</span>.<a href="../ExecutionContext.cs.html#07982205e4a6a726" class="i property">EngineSessionState</a>;
 
            <span class="c">// If the script block has a different language mode than the current,</span>
            <span class="c">// change the language mode.</span>
            <a href="../SessionStatePublic.cs.html#450052824aba2e3f" class="t t">PSLanguageMode</a>? <span id="r131 rd" class="r131 r">oldLanguageMode</span> = <b>null</b>;
            <a href="../SessionStatePublic.cs.html#450052824aba2e3f" class="t t">PSLanguageMode</a>? <span id="r132 rd" class="r132 r">newLanguageMode</span> = <b>null</b>;
            <b>if</b> (<a href="../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="k">this</a>.<a href="../lang/scriptblock.cs.html#5e76a9fb0d1a7f12" class="i property">LanguageMode</a>.<span class="i">HasValue</span>
                &amp;&amp; <a href="../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="k">this</a>.<a href="../lang/scriptblock.cs.html#5e76a9fb0d1a7f12" class="i property">LanguageMode</a> != <span class="r123 r">context</span>.<a href="../ExecutionContext.cs.html#ebe55e376f6c32fa" class="i property">LanguageMode</a>)
            {
                <span class="c">// Don&#39;t allow context: ConstrainedLanguage -&gt; FullLanguage transition if</span>
                <span class="c">// this is dot sourcing into the current scope, unless it is within a trusted module scope.</span>
                <b>if</b> (<a href="../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="k">this</a>.<a href="../lang/scriptblock.cs.html#5e76a9fb0d1a7f12" class="i property">LanguageMode</a> != <a href="../SessionStatePublic.cs.html#450052824aba2e3f" class="t t">PSLanguageMode</a>.<a href="../SessionStatePublic.cs.html#eec721eb8c02f156" class="i field">FullLanguage</a>
                    || <span class="r113 r">createLocalScope</span>
                    || <span class="r123 r">context</span>.<a href="../ExecutionContext.cs.html#07982205e4a6a726" class="i property">EngineSessionState</a>.<a href="../SessionState.cs.html#1900efdc2f293d5a" class="i property">Module</a>?.<a href="../Modules/PSModuleInfo.cs.html#8c5e251e6d3f0c67" class="i property">LanguageMode</a> == <a href="../SessionStatePublic.cs.html#450052824aba2e3f" class="t t">PSLanguageMode</a>.<a href="../SessionStatePublic.cs.html#eec721eb8c02f156" class="i field">FullLanguage</a>)
                {
                    <span class="r131 r">oldLanguageMode</span> = <span class="r123 r">context</span>.<a href="../ExecutionContext.cs.html#ebe55e376f6c32fa" class="i property">LanguageMode</a>;
                    <span class="r132 r">newLanguageMode</span> = <a href="../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="k">this</a>.<a href="../lang/scriptblock.cs.html#5e76a9fb0d1a7f12" class="i property">LanguageMode</a>;
                }
            }
 
            <span class="i">Dictionary</span>&lt;<b>string</b>, <a href="../ShellVariable.cs.html#5bd16fef1f858b3d" class="t t">PSVariable</a>&gt; <span id="r133 rd" class="r133 r">backupWhenDotting</span> = <b>null</b>;
            <b>try</b>
            {
                <a href="../InvocationInfo.cs.html#407d6c7d1ecbc8cc" class="k">var</a> <span id="r134 rd" class="r134 r">myInvocationInfo</span> = <span class="r121 r">invocationInfo</span>;
                <b>if</b> (<span class="r134 r">myInvocationInfo</span> == <b>null</b>)
                {
                    <b>var</b> <span id="r135 rd" class="r135 r">callerFrame</span> = <span class="r123 r">context</span>.<a href="../ExecutionContext.cs.html#3e56b2d709de0d80" class="i property">Debugger</a>.<a href="../debugger/debugger.cs.html#6e5b14dde8877cdc" class="i method">GetCallStack</a>().<span class="i">LastOrDefault</span>();
                    <b>var</b> <span id="r136 rd" class="r136 r">extent</span> = (<span class="r135 r">callerFrame</span> != <b>null</b>)
                        ? <span class="r135 r">callerFrame</span>.<span class="i">FunctionContext</span>.<span class="i">CurrentPosition</span>
                        : <a href="#e028cdfe16daf552" class="i property">Ast</a>.<a href="../parser/ast.cs.html#d9d5cd324ee61136" class="i property">Extent</a>;
                    <span class="r134 r">myInvocationInfo</span> = <b>new</b> <span class="t">InvocationInfo</span>(<b>null</b>, <span class="r136 r">extent</span>, <span class="r123 r">context</span>);
                }
 
                <span class="r126 r">locals</span>.<a href="MutableTuple.cs.html#b596dd33aa0e3dbc" class="i method">SetAutomaticVariable</a>(<a href="../SpecialVariables.cs.html#1c6f2efd91287b59" class="t t">AutomaticVariable</a>.<a href="../SpecialVariables.cs.html#80b3b66ce97fc2c9" class="i field">MyInvocation</a>, <span class="r134 r">myInvocationInfo</span>, <span class="r123 r">context</span>);
 
                <b>if</b> (<a href="../lang/scriptblock.cs.html#d25a345294fd74f0" class="i property">SessionStateInternal</a> != <b>null</b>)
                {
                    <span class="r123 r">context</span>.<a href="../ExecutionContext.cs.html#07982205e4a6a726" class="i property">EngineSessionState</a> = <a href="../lang/scriptblock.cs.html#d25a345294fd74f0" class="i property">SessionStateInternal</a>;
                }
 
                <span class="c">// If we don&#39;t want errors written, hide the error pipe.</span>
                <b>switch</b> (<span class="r116 r">errorHandlingBehavior</span>)
                {
                    <b>case</b> <a href="../lang/scriptblock.cs.html#10c045824f712272" class="t t">ErrorHandlingBehavior</a>.<a href="../lang/scriptblock.cs.html#5e78734ffe1c6ed3" class="i field">WriteToCurrentErrorPipe</a>:
                        <span class="c">// no need to do anything</span>
                        <b>break</b>;
                    <b>case</b> <a href="../lang/scriptblock.cs.html#10c045824f712272" class="t t">ErrorHandlingBehavior</a>.<a href="../lang/scriptblock.cs.html#df0061919fb37a15" class="i field">WriteToExternalErrorPipe</a>:
                        <span class="r123 r">context</span>.<a href="../ExecutionContext.cs.html#d0ed5d60dd57b004" class="i property">ShellFunctionErrorOutputPipe</a> = <b>null</b>;
                        <b>break</b>;
                    <b>case</b> <a href="../lang/scriptblock.cs.html#10c045824f712272" class="t t">ErrorHandlingBehavior</a>.<a href="../lang/scriptblock.cs.html#8df8eb772a66da9e" class="i field">SwallowErrors</a>:
                        <span class="r123 r">context</span>.<a href="../ExecutionContext.cs.html#d0ed5d60dd57b004" class="i property">ShellFunctionErrorOutputPipe</a> = <b>null</b>;
                        <span class="r123 r">context</span>.<a href="../ExecutionContext.cs.html#b62a014273263f69" class="i property">ExternalErrorOutput</a> = <b>new</b> <span class="t">DiscardingPipelineWriter</span>();
                        <b>break</b>;
                }
 
                <b>if</b> (<span class="r113 r">createLocalScope</span>)
                {
                    <a href="../SessionStateScope.cs.html#460261155e0163cb" class="k">var</a> <span id="r137 rd" class="r137 r">newScope</span> = <span class="r123 r">context</span>.<a href="../ExecutionContext.cs.html#07982205e4a6a726" class="i property">EngineSessionState</a>.<a href="../SessionStateScopeAPIs.cs.html#27e7de485699a643" class="i method">NewScope</a>(<b>false</b>);
                    <span class="r123 r">context</span>.<a href="../ExecutionContext.cs.html#07982205e4a6a726" class="i property">EngineSessionState</a>.<a href="../SessionStateScopeAPIs.cs.html#224987ad36a90f88" class="i property">CurrentScope</a> = <span class="r137 r">newScope</span>;
                    <span class="r137 r">newScope</span>.<a href="../SessionStateScope.cs.html#d10101bbc5961e39" class="i property">LocalsTuple</a> = <span class="r126 r">locals</span>;
                    <span class="c">// Inject passed in functions into the scope</span>
                    <b>if</b> (<span class="r114 r">functionsToDefine</span> != <b>null</b>)
                    {
                        <b>foreach</b> (<b>var</b> <span id="r138 rd" class="r138 r">def</span> <b>in</b> <span class="r114 r">functionsToDefine</span>)
                        {
                            <b>if</b> (<b>string</b>.<span class="i">IsNullOrWhiteSpace</span>(<span class="r138 r">def</span>.<span class="i">Key</span>))
                            {
                                <a href="../../utils/MshInvalidOperationException.cs.html#259a38c8b594783c" class="t t">PSInvalidOperationException</a> <span id="r139 rd" class="r139 r">e</span> = <a href="../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<span class="i">NewInvalidOperationException</span>(
                                    <span class="i">ParserStrings</span>.<span class="i">EmptyFunctionNameInFunctionDefinitionDictionary</span>);
 
                                <span class="r139 r">e</span>.<a href="../../utils/MshInvalidOperationException.cs.html#06b019caca30c7ed" class="i method">SetErrorId</a>(<span class="s">&quot;EmptyFunctionNameInFunctionDefinitionDictionary&quot;</span>);
                                <b>throw</b> <span class="r139 r">e</span>;
                            }
 
                            <b>if</b> (<span class="r138 r">def</span>.<span class="i">Value</span> == <b>null</b>)
                            {
                                <a href="../../utils/MshInvalidOperationException.cs.html#259a38c8b594783c" class="t t">PSInvalidOperationException</a> <span id="r140 rd" class="r140 r">e</span> = <a href="../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<span class="i">NewInvalidOperationException</span>(
                                    <span class="i">ParserStrings</span>.<span class="i">NullFunctionBodyInFunctionDefinitionDictionary</span>, <span class="r138 r">def</span>.<span class="i">Key</span>);
 
                                <span class="r140 r">e</span>.<a href="../../utils/MshInvalidOperationException.cs.html#06b019caca30c7ed" class="i method">SetErrorId</a>(<span class="s">&quot;NullFunctionBodyInFunctionDefinitionDictionary&quot;</span>);
                                <b>throw</b> <span class="r140 r">e</span>;
                            }
 
                            <span class="r137 r">newScope</span>.<a href="../SessionStateScope.cs.html#0cb72e1b3b779c82" class="i property">FunctionTable</a>.<span class="i">Add</span>(<span class="r138 r">def</span>.<span class="i">Key</span>, <b>new</b> <span class="t">FunctionInfo</span>(<span class="r138 r">def</span>.<span class="i">Key</span>, <span class="r138 r">def</span>.<span class="i">Value</span>, <span class="r123 r">context</span>));
                        }
                    }
                    <span class="c">// Inject passed in variables into the scope</span>
                    <b>if</b> (<span class="r115 r">variablesToDefine</span> != <b>null</b>)
                    {
                        <b>int</b> <span id="r141 rd" class="r141 r">index</span> = 0;
                        <b>foreach</b> (<b>var</b> <span id="r142 rd" class="r142 r">psvar</span> <b>in</b> <span class="r115 r">variablesToDefine</span>)
                        {
                            <span class="c">// Check for null entries.</span>
                            <b>if</b> (<span class="r142 r">psvar</span> == <b>null</b>)
                            {
                                <a href="../../utils/MshInvalidOperationException.cs.html#259a38c8b594783c" class="t t">PSInvalidOperationException</a> <span id="r143 rd" class="r143 r">e</span> = <a href="../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<span class="i">NewInvalidOperationException</span>(
                                    <span class="i">ParserStrings</span>.<span class="i">NullEntryInVariablesDefinitionList</span>, <span class="r141 r">index</span>);
 
                                <span class="r143 r">e</span>.<a href="../../utils/MshInvalidOperationException.cs.html#06b019caca30c7ed" class="i method">SetErrorId</a>(<span class="s">&quot;NullEntryInVariablesDefinitionList&quot;</span>);
                                <b>throw</b> <span class="r143 r">e</span>;
                            }
 
                            <b>string</b> <span id="r144 rd" class="r144 r">name</span> = <span class="r142 r">psvar</span>.<span class="i">Name</span>;
                            <a href="../../utils/assert.cs.html#c04955255430d32f" class="t t">Diagnostics</a>.<span class="i">Assert</span>(
                                !(<b>string</b>.<span class="i">Equals</span>(<span class="r144 r">name</span>, <span class="s">&quot;this&quot;</span>) || <b>string</b>.<span class="i">Equals</span>(<span class="r144 r">name</span>, <span class="s">&quot;_&quot;</span>) || <b>string</b>.<span class="i">Equals</span>(<span class="r144 r">name</span>, <span class="s">&quot;input&quot;</span>)),
                                <span class="s">&quot;The list of variables to set in the scriptblock&#39;s scope cannot contain &#39;this&#39;, &#39;_&#39; or &#39;input&#39;. These variables should be removed before passing the collection to this routine.&quot;</span>);
                            <span class="r141 r">index</span>++;
                            <span class="r137 r">newScope</span>.<a href="../SessionStateScope.cs.html#f3f7c22a2d29d233" class="i property">Variables</a>.<span class="i">Add</span>(<span class="r144 r">name</span>, <span class="r142 r">psvar</span>);
                        }
                    }
                }
                <b>else</b>
                {
                    <b>if</b> (<span class="r123 r">context</span>.<a href="../ExecutionContext.cs.html#07982205e4a6a726" class="i property">EngineSessionState</a>.<a href="../SessionStateScopeAPIs.cs.html#224987ad36a90f88" class="i property">CurrentScope</a>.<a href="../SessionStateScope.cs.html#d10101bbc5961e39" class="i property">LocalsTuple</a> == <b>null</b>)
                    {
                        <span class="c">// If the locals tuple is null, that means either:</span>
                        <span class="c">//     * we&#39;re invoking a script block for a module</span>
                        <span class="c">//     * something unexpected</span>
                        <span class="r123 r">context</span>.<a href="../ExecutionContext.cs.html#07982205e4a6a726" class="i property">EngineSessionState</a>.<a href="../SessionStateScopeAPIs.cs.html#224987ad36a90f88" class="i property">CurrentScope</a>.<a href="../SessionStateScope.cs.html#d10101bbc5961e39" class="i property">LocalsTuple</a> = <span class="r126 r">locals</span>;
                    }
                    <b>else</b>
                    {
                        <span class="r123 r">context</span>.<a href="../ExecutionContext.cs.html#07982205e4a6a726" class="i property">EngineSessionState</a>.<a href="../SessionStateScopeAPIs.cs.html#224987ad36a90f88" class="i property">CurrentScope</a>.<a href="../SessionStateScope.cs.html#240090c569665c17" class="i property">DottedScopes</a>.<span class="i">Push</span>(<span class="r126 r">locals</span>);
                        <span class="r133 r">backupWhenDotting</span> = <b>new</b> <span class="i">Dictionary</span>&lt;<b>string</b>, <a href="../ShellVariable.cs.html#5bd16fef1f858b3d" class="t t">PSVariable</a>&gt;();
                    }
                }
 
                <span class="c">// Set the language mode</span>
                <b>if</b> (<span class="r132 r">newLanguageMode</span>.<span class="i">HasValue</span>)
                {
                    <span class="r123 r">context</span>.<a href="../ExecutionContext.cs.html#ebe55e376f6c32fa" class="i property">LanguageMode</a> = <span class="r132 r">newLanguageMode</span>.<span class="i">Value</span>;
                }
 
                <span class="r122 r">args</span> = <span class="i">BindArgumentsForScriptblockInvoke</span>(
                    (<a href="../PseudoParameters.cs.html#68fb670c5eb25328" class="t t">RuntimeDefinedParameter</a>[])<a href="#61f3934e64edc598" class="i property">RuntimeDefinedParameters</a>.<a href="../PseudoParameters.cs.html#188173533cedce98" class="i property">Data</a>,
                    <span class="r122 r">args</span>,
                    <span class="r123 r">context</span>,
                    !<span class="r113 r">createLocalScope</span>,
                    <span class="r133 r">backupWhenDotting</span>,
                    <span class="r126 r">locals</span>);
                <span class="r126 r">locals</span>.<a href="MutableTuple.cs.html#b596dd33aa0e3dbc" class="i method">SetAutomaticVariable</a>(<a href="../SpecialVariables.cs.html#1c6f2efd91287b59" class="t t">AutomaticVariable</a>.<a href="../SpecialVariables.cs.html#57fd29949d2d5d62" class="i field">Args</a>, <span class="r122 r">args</span>, <span class="r123 r">context</span>);
 
                <span class="r123 r">context</span>.<a href="../ExecutionContext.cs.html#07982205e4a6a726" class="i property">EngineSessionState</a>.<a href="../SessionStateScopeAPIs.cs.html#224987ad36a90f88" class="i property">CurrentScope</a>.<a href="../SessionStateScope.cs.html#84d072e625b581f5" class="i property">ScopeOrigin</a> = <a href="../SecurityManagerBase.cs.html#a1d5a2ba5cd1b3aa" class="t t">CommandOrigin</a>.<a href="../SecurityManagerBase.cs.html#946d8e7ca02acec6" class="i field">Internal</a>;
 
                <a href="../parser/Compiler.cs.html#aa4ec5dd36f7e2eb" class="k">var</a> <span id="r145 rd" class="r145 r">functionContext</span> = <b>new</b> <span class="t">FunctionContext</span>
                {
                    <a href="../parser/Compiler.cs.html#86d08ccdd0602a1b" class="i field">_executionContext</a> = <span class="r123 r">context</span>,
                    <a href="../parser/Compiler.cs.html#6c44d518392049f0" class="i field">_outputPipe</a> = <span class="r120 r">outputPipe</span>,
                    <a href="../parser/Compiler.cs.html#23a9d5ac6a3b086b" class="i field">_localsTuple</a> = <span class="r126 r">locals</span>,
                    <a href="../parser/Compiler.cs.html#4980a1f93a561cb3" class="i field">_scriptBlock</a> = <a href="../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="k">this</a>,
                    <a href="../parser/Compiler.cs.html#95a73081cffaa015" class="i field">_file</a> = <a href="../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="k">this</a>.<a href="../lang/scriptblock.cs.html#20772981d01b9078" class="i property">File</a>,
                    <a href="../parser/Compiler.cs.html#f9539890beb6e765" class="i field">_debuggerHidden</a> = <a href="../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="k">this</a>.<a href="#6bbac4f67f789407" class="i property">DebuggerHidden</a>,
                    <a href="../parser/Compiler.cs.html#f82ab745f95a8791" class="i field">_debuggerStepThrough</a> = <a href="../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="k">this</a>.<a href="#28f1dfc28a9bfb01" class="i property">DebuggerStepThrough</a>,
                    <a href="../parser/Compiler.cs.html#354889e302c1693c" class="i field">_sequencePoints</a> = <a href="#fa7a45aa6cb804cf" class="i property">SequencePoints</a>,
                };
 
                <a href="../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="t t">ScriptBlock</a>.<a href="#5b263ac9d28348b4" class="i method">LogScriptBlockStart</a>(<a href="../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="k">this</a>, <span class="r123 r">context</span>.<a href="../ExecutionContext.cs.html#98ee84b98c4d109b" class="i property">CurrentRunspace</a>.<a href="../hostifaces/Connection.cs.html#af7b715fe8b1bee2" class="i property">InstanceId</a>);
 
                <b>try</b>
                {
                    <span class="r125 r">codeToInvoke</span>(<span class="r145 r">functionContext</span>);
                }
                <b>finally</b>
                {
                    <a href="../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="t t">ScriptBlock</a>.<a href="#0412bd44086911de" class="i method">LogScriptBlockEnd</a>(<a href="../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="k">this</a>, <span class="r123 r">context</span>.<a href="../ExecutionContext.cs.html#98ee84b98c4d109b" class="i property">CurrentRunspace</a>.<a href="../hostifaces/Connection.cs.html#af7b715fe8b1bee2" class="i property">InstanceId</a>);
                }
            }
            <b>catch</b> (<span class="i">TargetInvocationException</span> <span id="r146 rd" class="r146 r">tie</span>)
            {
                <span class="c">// DynamicInvoke always wraps, so unwrap here.</span>
                <b>throw</b> <span class="r146 r">tie</span>.<span class="i">InnerException</span>;
            }
            <b>finally</b>
            {
                <span class="c">// Restore the language mode</span>
                <b>if</b> (<span class="r131 r">oldLanguageMode</span>.<span class="i">HasValue</span>)
                {
                    <span class="r123 r">context</span>.<a href="../ExecutionContext.cs.html#ebe55e376f6c32fa" class="i property">LanguageMode</a> = <span class="r131 r">oldLanguageMode</span>.<span class="i">Value</span>;
                }
 
                <span class="c">// Now restore the output pipe...</span>
                <span class="r123 r">context</span>.<a href="../ExecutionContext.cs.html#d0ed5d60dd57b004" class="i property">ShellFunctionErrorOutputPipe</a> = <span class="r127 r">oldShellFunctionErrorOutputPipe</span>;
                <span class="r123 r">context</span>.<a href="../ExecutionContext.cs.html#b62a014273263f69" class="i property">ExternalErrorOutput</a> = <span class="r128 r">oldExternalErrorOutput</span>;
 
                <span class="c">// Restore the interactive command state...</span>
                <span class="r123 r">context</span>.<a href="../ExecutionContext.cs.html#07982205e4a6a726" class="i property">EngineSessionState</a>.<a href="../SessionStateScopeAPIs.cs.html#224987ad36a90f88" class="i property">CurrentScope</a>.<a href="../SessionStateScope.cs.html#84d072e625b581f5" class="i property">ScopeOrigin</a> = <span class="r129 r">oldScopeOrigin</span>;
 
                <b>if</b> (<span class="r113 r">createLocalScope</span>)
                {
                    <span class="r123 r">context</span>.<a href="../ExecutionContext.cs.html#07982205e4a6a726" class="i property">EngineSessionState</a>.<a href="../SessionStateScopeAPIs.cs.html#729d02bb53189219" class="i method">RemoveScope</a>(<span class="r123 r">context</span>.<a href="../ExecutionContext.cs.html#07982205e4a6a726" class="i property">EngineSessionState</a>.<a href="../SessionStateScopeAPIs.cs.html#224987ad36a90f88" class="i property">CurrentScope</a>);
                }
                <b>else</b> <b>if</b> (<span class="r133 r">backupWhenDotting</span> != <b>null</b>)
                {
                    <span class="r123 r">context</span>.<a href="../ExecutionContext.cs.html#07982205e4a6a726" class="i property">EngineSessionState</a>.<a href="../SessionStateScopeAPIs.cs.html#224987ad36a90f88" class="i property">CurrentScope</a>.<a href="../SessionStateScope.cs.html#240090c569665c17" class="i property">DottedScopes</a>.<span class="i">Pop</span>();
 
                    <a href="../../utils/assert.cs.html#c04955255430d32f" class="t t">Diagnostics</a>.<a href="../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r133 r">backupWhenDotting</span> != <b>null</b>, <span class="s">&quot;when dotting, this dictionary isn&#39;t null&quot;</span>);
                    <b>foreach</b> (<b>var</b> <span id="r147 rd" class="r147 r">pair</span> <b>in</b> <span class="r133 r">backupWhenDotting</span>)
                    {
                        <b>if</b> (<span class="r147 r">pair</span>.<span class="i">Value</span> != <b>null</b>)
                        {
                            <span class="r123 r">context</span>.<a href="../ExecutionContext.cs.html#07982205e4a6a726" class="i property">EngineSessionState</a>.<span class="i">SetVariable</span>(<span class="r147 r">pair</span>.<span class="i">Value</span>, <b>false</b>, <a href="../SecurityManagerBase.cs.html#a1d5a2ba5cd1b3aa" class="t t">CommandOrigin</a>.<a href="../SecurityManagerBase.cs.html#946d8e7ca02acec6" class="i field">Internal</a>);
                        }
                        <b>else</b>
                        {
                            <span class="r123 r">context</span>.<a href="../ExecutionContext.cs.html#07982205e4a6a726" class="i property">EngineSessionState</a>.<span class="i">RemoveVariable</span>(<span class="r147 r">pair</span>.<span class="i">Key</span>);
                        }
                    }
                }
 
                <span class="c">// Restore session state...</span>
                <span class="r123 r">context</span>.<a href="../ExecutionContext.cs.html#07982205e4a6a726" class="i property">EngineSessionState</a> = <span class="r130 r">oldSessionState</span>;
            }
        }
 
        <b>internal</b> <a href="MutableTuple.cs.html#d4c692d6a8bac31d" class="t t">MutableTuple</a> <a id="74eb29587e65199f" href="../../R/74eb29587e65199f.html" target="n" data-glyph="74,1" class="i method">MakeLocalsTuple</a>(<b>bool</b> <span id="r148 rd" class="r148 r">createLocalScope</span>)
        {
            <a href="MutableTuple.cs.html#d4c692d6a8bac31d" class="t t">MutableTuple</a> <span id="r149 rd" class="r149 r">locals</span>;
            <b>if</b> (<span class="r148 r">createLocalScope</span>)
            {
                <span class="r149 r">locals</span> = <a href="MutableTuple.cs.html#d4c692d6a8bac31d" class="t t">MutableTuple</a>.<a href="MutableTuple.cs.html#32166b6659de79e2" class="i method">MakeTuple</a>(
                    <a href="#93a1a6c2d4f99ed6" class="i field">_scriptBlockData</a>.<a href="#e19b7f75e9ba3109" class="i property">LocalsMutableTupleType</a>,
                    <a href="#93a1a6c2d4f99ed6" class="i field">_scriptBlockData</a>.<a href="#e200f548c2cb062b" class="i property">NameToIndexMap</a>,
                    <a href="#93a1a6c2d4f99ed6" class="i field">_scriptBlockData</a>.<a href="#96022acf251075a0" class="i property">LocalsMutableTupleCreator</a>);
            }
            <b>else</b>
            {
                <span class="r149 r">locals</span> = <a href="MutableTuple.cs.html#d4c692d6a8bac31d" class="t t">MutableTuple</a>.<a href="MutableTuple.cs.html#32166b6659de79e2" class="i method">MakeTuple</a>(
                    <a href="#93a1a6c2d4f99ed6" class="i field">_scriptBlockData</a>.<a href="#365d21fb5ac6f9e6" class="i property">UnoptimizedLocalsMutableTupleType</a>,
                    <a href="#42e46e4ff0244eb3" class="i property">UsesCmdletBinding</a>
                        ? <a href="../parser/Compiler.cs.html#8bdfc042f41c96c5" class="t t">Compiler</a>.<a href="../parser/Compiler.cs.html#53f2953cbecb6154" class="i field">DottedScriptCmdletLocalsNameIndexMap</a>
                        : <a href="../parser/Compiler.cs.html#8bdfc042f41c96c5" class="t t">Compiler</a>.<a href="../parser/Compiler.cs.html#8a3b323becd5e9eb" class="i field">DottedLocalsNameIndexMap</a>,
                    <a href="#93a1a6c2d4f99ed6" class="i field">_scriptBlockData</a>.<a href="#60d93a32e14ee515" class="i property">UnoptimizedLocalsMutableTupleCreator</a>);
            }
 
            <b>return</b> <span class="r149 r">locals</span>;
        }
 
        <b>internal static object</b>[] <a id="15a4814e5820949d" href="../../R/15a4814e5820949d.html" target="n" data-glyph="74,1" class="i method">BindArgumentsForScriptblockInvoke</a>(
            <a href="../PseudoParameters.cs.html#68fb670c5eb25328" class="t t">RuntimeDefinedParameter</a>[] <span id="r150 rd" class="r150 r">parameters</span>,
            <b>object</b>[] <span id="r151 rd" class="r151 r">args</span>,
            <a href="../ExecutionContext.cs.html#130bda5418e8559c" class="t t">ExecutionContext</a> <span id="r152 rd" class="r152 r">context</span>,
            <b>bool</b> <span id="r153 rd" class="r153 r">dotting</span>,
            <span class="i">Dictionary</span>&lt;<b>string</b>, <a href="../ShellVariable.cs.html#5bd16fef1f858b3d" class="t t">PSVariable</a>&gt; <span id="r154 rd" class="r154 r">backupWhenDotting</span>,
            <a href="MutableTuple.cs.html#d4c692d6a8bac31d" class="t t">MutableTuple</a> <span id="r155 rd" class="r155 r">locals</span>)
        {
            <a href="../ParameterBinderBase.cs.html#efc1e794ccda0552" class="k">var</a> <span id="r156 rd" class="r156 r">boundParameters</span> = <b>new</b> <span class="t">CommandLineParameters</span>();
 
            <b>if</b> (<span class="r150 r">parameters</span>.<span class="i">Length</span> == 0)
            {
                <b>return</b> <span class="r151 r">args</span>;
            }
 
            <b>for</b> (<b>int</b> <span id="r157 rd" class="r157 r">i</span> = 0; <span class="r157 r">i</span> &lt; <span class="r150 r">parameters</span>.<span class="i">Length</span>; <span class="r157 r">i</span>++)
            {
                <a href="../PseudoParameters.cs.html#68fb670c5eb25328" class="k">var</a> <span id="r158 rd" class="r158 r">parameter</span> = <span class="r150 r">parameters</span>[<span class="r157 r">i</span>];
                <b>object</b> <span id="r159 rd" class="r159 r">valueToBind</span>;
                <b>bool</b> <span id="r160 rd" class="r160 r">wasDefaulted</span> = <b>false</b>;
                <b>if</b> (<span class="r157 r">i</span> &gt;= <span class="r151 r">args</span>.<span class="i">Length</span>)
                {
                    <span class="r159 r">valueToBind</span> = <span class="r158 r">parameter</span>.<a href="../PseudoParameters.cs.html#de6715664001bb38" class="i property">Value</a>;
                    <b>if</b> (<span class="r159 r">valueToBind</span> <b>is</b> <a href="../parser/Compiler.cs.html#8bdfc042f41c96c5" class="t t">Compiler</a>.<a href="../parser/Compiler.cs.html#1bc376c4f871461b" class="t t">DefaultValueExpressionWrapper</a>)
                    {
                        <span class="c">// We pass in a null SessionStateInternal because the current scope is already set correctly.</span>
                        <span class="r159 r">valueToBind</span> = ((<a href="../parser/Compiler.cs.html#8bdfc042f41c96c5" class="t t">Compiler</a>.<a href="../parser/Compiler.cs.html#1bc376c4f871461b" class="t t">DefaultValueExpressionWrapper</a>)<span class="r159 r">valueToBind</span>).<a href="../parser/Compiler.cs.html#d71913e518ec5671" class="i method">GetValue</a>(<span class="r152 r">context</span>, <b>null</b>);
                    }
 
                    <span class="r160 r">wasDefaulted</span> = <b>true</b>;
                }
                <b>else</b>
                {
                    <span class="r159 r">valueToBind</span> = <span class="r151 r">args</span>[<span class="r157 r">i</span>];
                }
 
                <b>bool</b> <span id="r161 rd" class="r161 r">valueSet</span> = <b>false</b>;
                <b>if</b> (<span class="r153 r">dotting</span> &amp;&amp; <span class="r154 r">backupWhenDotting</span> != <b>null</b>)
                {
                    <span class="r154 r">backupWhenDotting</span>[<span class="r158 r">parameter</span>.<a href="../PseudoParameters.cs.html#72b879c4e1ec8c2b" class="i property">Name</a>] =
                        <span class="r152 r">context</span>.<a href="../ExecutionContext.cs.html#07982205e4a6a726" class="i property">EngineSessionState</a>.<a href="../SessionStateVariableAPIs.cs.html#ea8f4d42f09f18a8" class="i method">GetVariableAtScope</a>(<span class="r158 r">parameter</span>.<a href="../PseudoParameters.cs.html#72b879c4e1ec8c2b" class="i property">Name</a>, <span class="s">&quot;local&quot;</span>);
                }
                <b>else</b>
                {
                    <span class="r161 r">valueSet</span> = <span class="r155 r">locals</span>.<a href="MutableTuple.cs.html#1d0ae1bfb437b1f3" class="i method">TrySetParameter</a>(<span class="r158 r">parameter</span>.<a href="../PseudoParameters.cs.html#72b879c4e1ec8c2b" class="i property">Name</a>, <span class="r159 r">valueToBind</span>);
                }
 
                <b>if</b> (!<span class="r161 r">valueSet</span>)
                {
                    <a href="../ShellVariable.cs.html#5bd16fef1f858b3d" class="k">var</a> <span id="r162 rd" class="r162 r">variable</span> = <b>new</b> <a href="../ShellVariable.cs.html#3ac543e1434ca630" class="t constructor">PSVariable</a>(
                        <span class="r158 r">parameter</span>.<a href="../PseudoParameters.cs.html#72b879c4e1ec8c2b" class="i property">Name</a>,
                        <span class="r159 r">valueToBind</span>,
                        <a href="../ShellVariable.cs.html#8d6fb934c02e4185" class="t t">ScopedItemOptions</a>.<a href="../ShellVariable.cs.html#76fffaf5453ae116" class="i field">None</a>,
                        <span class="r158 r">parameter</span>.<a href="../PseudoParameters.cs.html#e64718f6a082a9d8" class="i property">Attributes</a>);
                    <span class="r152 r">context</span>.<a href="../ExecutionContext.cs.html#07982205e4a6a726" class="i property">EngineSessionState</a>.<a href="../SessionStateVariableAPIs.cs.html#8dc502ca6f48c743" class="i method">SetVariable</a>(<span class="r162 r">variable</span>, <b>false</b>, <a href="../SecurityManagerBase.cs.html#a1d5a2ba5cd1b3aa" class="t t">CommandOrigin</a>.<a href="../SecurityManagerBase.cs.html#946d8e7ca02acec6" class="i field">Internal</a>);
                }
 
                <b>if</b> (!<span class="r160 r">wasDefaulted</span>)
                {
                    <span class="r156 r">boundParameters</span>.<a href="../ParameterBinderBase.cs.html#fb9729d19c4f40b0" class="i method">Add</a>(<span class="r158 r">parameter</span>.<a href="../PseudoParameters.cs.html#72b879c4e1ec8c2b" class="i property">Name</a>, <span class="r159 r">valueToBind</span>);
                    <span class="r156 r">boundParameters</span>.<a href="../ParameterBinderBase.cs.html#300462d4aee417ae" class="i method">MarkAsBoundPositionally</a>(<span class="r158 r">parameter</span>.<a href="../PseudoParameters.cs.html#72b879c4e1ec8c2b" class="i property">Name</a>);
                }
            }
 
            <span class="r155 r">locals</span>.<a href="MutableTuple.cs.html#b596dd33aa0e3dbc" class="i method">SetAutomaticVariable</a>(
                <a href="../SpecialVariables.cs.html#1c6f2efd91287b59" class="t t">AutomaticVariable</a>.<a href="../SpecialVariables.cs.html#93a934b8cba4991e" class="i field">PSBoundParameters</a>,
                <span class="r156 r">boundParameters</span>.<a href="../ParameterBinderBase.cs.html#a424a7a35309dc44" class="i method">GetValueToBindToPSBoundParameters</a>(),
                <span class="r152 r">context</span>);
 
            <b>var</b> <span id="r163 rd" class="r163 r">leftOverArgs</span> = <span class="r151 r">args</span>.<span class="i">Length</span> - <span class="r150 r">parameters</span>.<span class="i">Length</span>;
            <b>if</b> (<span class="r163 r">leftOverArgs</span> &lt;= 0)
            {
                <b>return</b> <span class="i">Array</span>.<span class="i">Empty</span>&lt;<b>object</b>&gt;();
            }
 
            <b>object</b>[] <span id="r164 rd" class="r164 r">result</span> = <b>new</b> <b>object</b>[<span class="r163 r">leftOverArgs</span>];
            <span class="i">Array</span>.<span class="i">Copy</span>(<span class="r151 r">args</span>, <span class="r150 r">parameters</span>.<span class="i">Length</span>, <span class="r164 r">result</span>, 0, <span class="r164 r">result</span>.<span class="i">Length</span>);
            <b>return</b> <span class="r164 r">result</span>;
        }
 
        <b>internal static void</b> <a id="f5ebe856ed4e7b6e" href="../../R/../../0000000000.html" target="n" data-glyph="74,1" class="i method">SetAutomaticVariable</a>(<a href="../SpecialVariables.cs.html#1c6f2efd91287b59" class="t t">AutomaticVariable</a> <span id="r165 rd" class="r165 r">variable</span>, <b>object</b> <span id="r166 rd" class="r166 r">value</span>, <a href="MutableTuple.cs.html#d4c692d6a8bac31d" class="t t">MutableTuple</a> <span id="r167 rd" class="r167 r">locals</span>)
            =&gt; <span class="r167 r">locals</span>.<a href="MutableTuple.cs.html#e29ef8d980593d33" class="i method">SetValue</a>((<b>int</b>)<span class="r165 r">variable</span>, <span class="r166 r">value</span>);
 
        <b>private</b> <span class="i">Action</span>&lt;<a href="../parser/Compiler.cs.html#aa4ec5dd36f7e2eb" class="t t">FunctionContext</a>&gt; <a id="58ca76fe16d8dda9" href="../../R/58ca76fe16d8dda9.html" target="n" data-glyph="76,1" class="i method">GetCodeToInvoke</a>(<b>ref bool</b> <span id="r168 rd" class="r168 r">optimized</span>, <a href="#34af49554c079f15" class="t t">ScriptBlockClauseToInvoke</a> <span id="r169 rd" class="r169 r">clauseToInvoke</span>)
        {
            <b>if</b> (<span class="r169 r">clauseToInvoke</span> == <a href="#34af49554c079f15" class="t t">ScriptBlockClauseToInvoke</a>.<a href="#60e19cf946da098d" class="i field">ProcessBlockOnly</a>
                &amp;&amp; (<a href="#680dd2bf19ec8364" class="i property">HasBeginBlock</a> || (<a href="#e0cf74ca3d5f266a" class="i property">HasEndBlock</a> &amp;&amp; <a href="#5ee5abba7294e48d" class="i property">HasProcessBlock</a>)))
            {
                <b>throw</b> <a href="../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<span class="i">NewInvalidOperationException</span>(<span class="i">AutomationExceptions</span>.<span class="i">ScriptBlockInvokeOnOneClauseOnly</span>);
            }
 
            <span class="r168 r">optimized</span> = <a href="#93a1a6c2d4f99ed6" class="i field">_scriptBlockData</a>.<a href="#0f166b9df4330182" class="i method">Compile</a>(<span class="r168 r">optimized</span>);
 
            <b>if</b> (<span class="r168 r">optimized</span>)
            {
                <b>switch</b> (<span class="r169 r">clauseToInvoke</span>)
                {
                    <b>case</b> <a href="#34af49554c079f15" class="t t">ScriptBlockClauseToInvoke</a>.<a href="#85ca98782a255c39" class="i field">Begin</a>:
                        <b>return</b> <a href="#93a1a6c2d4f99ed6" class="i field">_scriptBlockData</a>.<a href="#9913dea66272cc70" class="i property">BeginBlock</a>;
                    <b>case</b> <a href="#34af49554c079f15" class="t t">ScriptBlockClauseToInvoke</a>.<a href="#94c9d79f22dcf339" class="i field">Process</a>:
                        <b>return</b> <a href="#93a1a6c2d4f99ed6" class="i field">_scriptBlockData</a>.<a href="#81b0289e5e379546" class="i property">ProcessBlock</a>;
                    <b>case</b> <a href="#34af49554c079f15" class="t t">ScriptBlockClauseToInvoke</a>.<a href="#0b20b164588bea50" class="i field">End</a>:
                        <b>return</b> <a href="#93a1a6c2d4f99ed6" class="i field">_scriptBlockData</a>.<a href="#6210fa92a7dbeebe" class="i property">EndBlock</a>;
                    <b>default</b>:
                        <b>return</b> <a href="#5ee5abba7294e48d" class="i property">HasProcessBlock</a> ? <a href="#93a1a6c2d4f99ed6" class="i field">_scriptBlockData</a>.<a href="#81b0289e5e379546" class="i property">ProcessBlock</a> : <a href="#93a1a6c2d4f99ed6" class="i field">_scriptBlockData</a>.<a href="#6210fa92a7dbeebe" class="i property">EndBlock</a>;
                }
            }
 
            <b>switch</b> (<span class="r169 r">clauseToInvoke</span>)
            {
                <b>case</b> <a href="#34af49554c079f15" class="t t">ScriptBlockClauseToInvoke</a>.<a href="#85ca98782a255c39" class="i field">Begin</a>:
                    <b>return</b> <a href="#93a1a6c2d4f99ed6" class="i field">_scriptBlockData</a>.<a href="#22c1e1d6bb481504" class="i property">UnoptimizedBeginBlock</a>;
                <b>case</b> <a href="#34af49554c079f15" class="t t">ScriptBlockClauseToInvoke</a>.<a href="#94c9d79f22dcf339" class="i field">Process</a>:
                    <b>return</b> <a href="#93a1a6c2d4f99ed6" class="i field">_scriptBlockData</a>.<a href="#efa61db3d10b1e5f" class="i property">UnoptimizedProcessBlock</a>;
                <b>case</b> <a href="#34af49554c079f15" class="t t">ScriptBlockClauseToInvoke</a>.<a href="#0b20b164588bea50" class="i field">End</a>:
                    <b>return</b> <a href="#93a1a6c2d4f99ed6" class="i field">_scriptBlockData</a>.<a href="#3255522102eddb54" class="i property">UnoptimizedEndBlock</a>;
                <b>default</b>:
                    <b>return</b> <a href="#5ee5abba7294e48d" class="i property">HasProcessBlock</a> ? <a href="#93a1a6c2d4f99ed6" class="i field">_scriptBlockData</a>.<a href="#efa61db3d10b1e5f" class="i property">UnoptimizedProcessBlock</a> : <a href="#93a1a6c2d4f99ed6" class="i field">_scriptBlockData</a>.<a href="#3255522102eddb54" class="i property">UnoptimizedEndBlock</a>;
            }
        }
 
        <b>internal</b> <a href="../Attributes.cs.html#67a775c242618ea6" class="t t">CmdletBindingAttribute</a> <a id="f357391ff92f5336" href="../../R/f357391ff92f5336.html" target="n" data-glyph="104,1" class="i property">CmdletBindingAttribute</a> { <b>get</b> =&gt; <a href="#93a1a6c2d4f99ed6" class="i field">_scriptBlockData</a>.<a href="#44ccf527ce27d70d" class="i property">CmdletBindingAttribute</a>; }
 
        <b>internal</b> <span class="i">ObsoleteAttribute</span> <a id="2acf0b78bcba9559" href="../../R/2acf0b78bcba9559.html" target="n" data-glyph="104,1" class="i property">ObsoleteAttribute</a> { <b>get</b> =&gt; <a href="#93a1a6c2d4f99ed6" class="i field">_scriptBlockData</a>.<a href="#10bfd3605123b87f" class="i property">ObsoleteAttribute</a>; }
 
        <b>internal</b> <a href="../ExperimentalFeature/ExperimentalFeature.cs.html#a9ee2c313b8e7ce8" class="t t">ExperimentalAttribute</a> <a id="91492ca459ac2cd6" href="../../R/91492ca459ac2cd6.html" target="n" data-glyph="104,1" class="i property">ExperimentalAttribute</a> { <b>get</b> =&gt; <a href="#93a1a6c2d4f99ed6" class="i field">_scriptBlockData</a>.<a href="#d024d5cad669d640" class="i property">ExperimentalAttribute</a>; }
 
        <b>internal bool</b> <a id="fed28a51bb21935d" href="../../R/fed28a51bb21935d.html" target="n" data-glyph="74,1" class="i method">Compile</a>(<b>bool</b> <span id="r170 rd" class="r170 r">optimized</span>) =&gt; <a href="#93a1a6c2d4f99ed6" class="i field">_scriptBlockData</a>.<a href="#0f166b9df4330182" class="i method">Compile</a>(<span class="r170 r">optimized</span>);
 
        <b>internal static void</b> <a id="ef7b1ca995273fa6" href="../../R/ef7b1ca995273fa6.html" target="n" data-glyph="74,1" class="i method">LogScriptBlockCreation</a>(<a href="../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="t t">ScriptBlock</a> <span id="r171 rd" class="r171 r">scriptBlock</span>, <b>bool</b> <span id="r172 rd" class="r172 r">force</span>)
        {
            <b>if</b> (<span class="r171 r">scriptBlock</span>.<a href="#a2fb56b3538e8ff4" class="i property">HasLogged</a> &amp;&amp; !<a href="../Utils.cs.html#f365eaa75311eda0" class="t t">InternalTestHooks</a>.<a href="../Utils.cs.html#60588f95c91db986" class="i field">ForceScriptBlockLogging</a>)
            {
                <span class="c">// Fast exit if the script block is already logged and we are not force re-logging in tests.</span>
                <b>return</b>;
            }
 
            <a href="../PSConfiguration.cs.html#77a0f8dab4448573" class="t t">ScriptBlockLogging</a> <span id="r173 rd" class="r173 r">logSetting</span> = <a href="#7474f4dd95b98f76" class="i method">GetScriptBlockLoggingSetting</a>();
            <b>if</b> (<span class="r172 r">force</span> || <span class="r173 r">logSetting</span>?.<a href="../PSConfiguration.cs.html#86de5873845e657b" class="i property">EnableScriptBlockLogging</a> == <b>true</b>)
            {
                <span class="c">// If script block logging is explicitly disabled, or it&#39;s from a trusted</span>
                <span class="c">// file or internal, skip logging.</span>
                <b>if</b> (<span class="r173 r">logSetting</span>?.<a href="../PSConfiguration.cs.html#86de5873845e657b" class="i property">EnableScriptBlockLogging</a> == <b>false</b>
                    || <span class="r171 r">scriptBlock</span>.<a href="#755d14464cc0fe20" class="i property">ScriptBlockData</a>.<a href="#38a9df40a1ccf48a" class="i property">IsProductCode</a>)
                {
                    <span class="r171 r">scriptBlock</span>.<a href="#f04bfb1d05890259" class="i property">SkipLogging</a> = <b>true</b>;
                    <b>return</b>;
                }
 
                <b>string</b> <span id="r174 rd" class="r174 r">scriptBlockText</span> = <span class="r171 r">scriptBlock</span>.<a href="#e028cdfe16daf552" class="i property">Ast</a>.<a href="../parser/ast.cs.html#d9d5cd324ee61136" class="i property">Extent</a>.<a href="../parser/Position.cs.html#43ce932d9225bc9c" class="i property">Text</a>;
                <b>bool</b> <span id="r175 rd" class="r175 r">written</span> = <b>false</b>;
 
                <span class="c">// Maximum size of ETW events is 64kb. Split a message if it is larger than 20k (Unicode) characters.</span>
                <b>if</b> (<span class="r174 r">scriptBlockText</span>.<span class="i">Length</span> &lt; 20000)
                {
                    <span class="r175 r">written</span> = <a href="#d73e9b6b51497d55" class="i method">WriteScriptBlockToLog</a>(<span class="r171 r">scriptBlock</span>, 0, 1, <span class="r171 r">scriptBlock</span>.<a href="#e028cdfe16daf552" class="i property">Ast</a>.<a href="../parser/ast.cs.html#d9d5cd324ee61136" class="i property">Extent</a>.<a href="../parser/Position.cs.html#43ce932d9225bc9c" class="i property">Text</a>);
                }
                <b>else</b>
                {
                    <span class="c">// But split the segments into random sizes (10k + between 0 and 10kb extra)</span>
                    <span class="c">// so that attackers can&#39;t creatively force their scripts to span well-known</span>
                    <span class="c">// segments (making simple rules less reliable).</span>
                    <b>int</b> <span id="r176 rd" class="r176 r">segmentSize</span> = 10000 + (<b>new</b> <span class="i">Random</span>()).<span class="i">Next</span>(10000);
                    <b>int</b> <span id="r177 rd" class="r177 r">segments</span> = (<b>int</b>)<span class="i">Math</span>.<span class="i">Floor</span>((<b>double</b>)(<span class="r174 r">scriptBlockText</span>.<span class="i">Length</span> / <span class="r176 r">segmentSize</span>)) + 1;
                    <b>int</b> <span id="r178 rd" class="r178 r">currentLocation</span> = 0;
                    <b>int</b> <span id="r179 rd" class="r179 r">currentSegmentSize</span> = 0;
 
                    <b>for</b> (<b>int</b> <span id="r180 rd" class="r180 r">segment</span> = 0; <span class="r180 r">segment</span> &lt; <span class="r177 r">segments</span>; <span class="r180 r">segment</span>++)
                    {
                        <span class="r178 r">currentLocation</span> = <span class="r180 r">segment</span> * <span class="r176 r">segmentSize</span>;
                        <span class="r179 r">currentSegmentSize</span> = <span class="i">Math</span>.<span class="i">Min</span>(<span class="r176 r">segmentSize</span>, <span class="r174 r">scriptBlockText</span>.<span class="i">Length</span> - <span class="r178 r">currentLocation</span>);
 
                        <b>string</b> <span id="r181 rd" class="r181 r">textToLog</span> = <span class="r174 r">scriptBlockText</span>.<span class="i">Substring</span>(<span class="r178 r">currentLocation</span>, <span class="r179 r">currentSegmentSize</span>);
                        <span class="r175 r">written</span> = <a href="#d73e9b6b51497d55" class="i method">WriteScriptBlockToLog</a>(<span class="r171 r">scriptBlock</span>, <span class="r180 r">segment</span>, <span class="r177 r">segments</span>, <span class="r181 r">textToLog</span>);
                    }
                }
 
                <b>if</b> (<span class="r175 r">written</span>)
                {
                    <span class="r171 r">scriptBlock</span>.<a href="#a2fb56b3538e8ff4" class="i property">HasLogged</a> = <b>true</b>;
                }
            }
            <b>else</b>
            {
                <span class="r171 r">scriptBlock</span>.<a href="#f04bfb1d05890259" class="i property">SkipLogging</a> = <b>true</b>;
            }
        }
 
        <b>private static bool</b> <a id="d73e9b6b51497d55" href="../../R/d73e9b6b51497d55.html" target="n" data-glyph="76,1" class="i method">WriteScriptBlockToLog</a>(<a href="../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="t t">ScriptBlock</a> <span id="r182 rd" class="r182 r">scriptBlock</span>, <b>int</b> <span id="r183 rd" class="r183 r">segment</span>, <b>int</b> <span id="r184 rd" class="r184 r">segments</span>, <b>string</b> <span id="r185 rd" class="r185 r">textToLog</span>)
        {
            <span class="c">// See if we need to encrypt the event log message. This info is all cached by Utils.GetPolicySetting(),</span>
            <span class="c">// so we&#39;re not hitting the configuration file for every script block we compile.</span>
            <a href="../PSConfiguration.cs.html#b80e130b16229ecc" class="t t">ProtectedEventLogging</a> <span id="r186 rd" class="r186 r">logSetting</span> =
                <a href="../Utils.cs.html#9185d6ecbaebbec0" class="t t">Utils</a>.<a href="../Utils.cs.html#fb031837cf810b13" class="i method">GetPolicySetting</a>&lt;<a href="../PSConfiguration.cs.html#b80e130b16229ecc" class="t t">ProtectedEventLogging</a>&gt;(<a href="../Utils.cs.html#9185d6ecbaebbec0" class="t t">Utils</a>.<a href="../Utils.cs.html#56b94f3ef7006dfe" class="i field">SystemWideOnlyConfig</a>);
            <b>bool</b> <span id="r187 rd" class="r187 r">wasEncoded</span> = <b>false</b>;
            <b>if</b> (<span class="r186 r">logSetting</span> != <b>null</b>)
            {
                <b>lock</b> (<a href="#a9f30388f1800a1c" class="i field">s_syncObject</a>)
                {
                    <span class="c">// Populates the encryptionRecipients list from the Group Policy, if possible. If not possible,</span>
                    <span class="c">// does all appropriate logging and encryptionRecipients is &#39;null&#39;. &#39;CouldLog&#39; being false</span>
                    <span class="c">// implies the engine wasn&#39;t ready for logging yet.</span>
                    <b>bool</b> <span id="r188 rd" class="r188 r">couldLog</span> = <a href="#24fe41eb99c09f29" class="i method">GetAndValidateEncryptionRecipients</a>(<span class="r182 r">scriptBlock</span>, <span class="r186 r">logSetting</span>);
                    <b>if</b> (!<span class="r188 r">couldLog</span>)
                    {
                        <b>return</b> <b>false</b>;
                    }
 
                    <span class="c">// If we have recipients to encrypt to, then do so.</span>
                    <span class="c">// Otherwise, we&#39;ll just log the plain text version.</span>
                    <b>if</b> (<a href="#fd7e76499659d16d" class="i field">s_encryptionRecipients</a> != <b>null</b>)
                    {
                        <span class="c">// Encrypt the raw text from the scriptblock.</span>
                        <span class="c">// The user may have to deal with any control characters in the data.</span>
                        <a href="../ExecutionContext.cs.html#130bda5418e8559c" class="t t">ExecutionContext</a> <span id="r189 rd" class="r189 r">executionContext</span> = <a href="../hostifaces/LocalPipeline.cs.html#4ecb13103c10f113" class="t t">LocalPipeline</a>.<a href="../hostifaces/LocalPipeline.cs.html#d3eaa3d3391ed484" class="i method">GetExecutionContextFromTLS</a>();
                        <a href="../ErrorPackage.cs.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r190 rd" class="r190 r">error</span> = <b>null</b>;
                        <b>byte</b>[] <span id="r191 rd" class="r191 r">contentBytes</span> = <span class="i n">System</span>.<span class="i">Text</span>.<span class="i">Encoding</span>.<span class="i">UTF8</span>.<span class="i">GetBytes</span>(<span class="r185 r">textToLog</span>);
                        <b>string</b> <span id="r192 rd" class="r192 r">encodedContent</span> = <a href="../../security/SecuritySupport.cs.html#de6319bf8345395a" class="t t">CmsUtils</a>.<a href="../../security/SecuritySupport.cs.html#5194b16780add5d4" class="i method">Encrypt</a>(
                            <span class="r191 r">contentBytes</span>,
                            <a href="#fd7e76499659d16d" class="i field">s_encryptionRecipients</a>,
                            <span class="r189 r">executionContext</span>.<a href="../ExecutionContext.cs.html#4502619a6e4808ee" class="i property">SessionState</a>,
                            <b>out</b> <span class="r190 r">error</span>);
 
                        <span class="c">// Can&#39;t cache the reporting of encryption errors, as they are likely content-based.</span>
                        <b>if</b> (<span class="r190 r">error</span> != <b>null</b>)
                        {
                            <span class="c">// If we got an error encrypting the content, log an error and continue</span>
                            <span class="c">// logging the (unencrypted) message anyways. Logging trumps protected logging -</span>
                            <span class="c">// being able to detect that an attacker has compromised a box outweighs the danger of the</span>
                            <span class="c">// attacker seeing potentially sensitive data. Because if they aren&#39;t detected, then</span>
                            <span class="c">// they can just wait on the compromised box and see the sensitive data eventually anyways.</span>
 
                            <b>string</b> <span id="r193 rd" class="r193 r">errorMessage</span> = <a href="../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(
                                <span class="i">SecuritySupportStrings</span>.<span class="i">CouldNotEncryptContent</span>,
                                <span class="r185 r">textToLog</span>,
                                <span class="r190 r">error</span>.<a href="../ErrorPackage.cs.html#cab659be098926dd" class="i method">ToString</a>());
                            <a href="../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogOperationalError</span>(
                                <span class="i">id</span>: <a href="../remoting/common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../remoting/common/PSETWTracer.cs.html#537824865d62e570" class="i field">ScriptBlock_Compile_Detail</a>,
                                <span class="i">opcode</span>: <a href="../remoting/common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../remoting/common/PSETWTracer.cs.html#5c13bbf5691971de" class="i field">Create</a>,
                                <span class="i">task</span>: <a href="../remoting/common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../remoting/common/PSETWTracer.cs.html#970efdc5fe5714ba" class="i field">ExecuteCommand</a>,
                                <span class="i">keyword</span>: <a href="../remoting/common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../remoting/common/PSETWTracer.cs.html#05d709c2010b41d5" class="i field">UseAlwaysOperational</a>,
                                0,
                                0,
                                <span class="r193 r">errorMessage</span>,
                                <span class="r182 r">scriptBlock</span>.<a href="#84b30017d1a078db" class="i property">Id</a>.<span class="i">ToString</span>(),
                                <span class="r182 r">scriptBlock</span>.<a href="../lang/scriptblock.cs.html#20772981d01b9078" class="i property">File</a> ?? <b>string</b>.<span class="i">Empty</span>);
                        }
                        <b>else</b>
                        {
                            <span class="r185 r">textToLog</span> = <span class="r192 r">encodedContent</span>;
                            <span class="r187 r">wasEncoded</span> = <b>true</b>;
                        }
                    }
                }
            }
 
            <b>if</b> (!<span class="r187 r">wasEncoded</span>)
            {
                <span class="r185 r">textToLog</span> = <a href="#9c7bca808a9dff00" class="i method">FormatLogString</a>(<span class="r185 r">textToLog</span>);
            }
 
            <b>if</b> (<span class="r182 r">scriptBlock</span>.<a href="#93a1a6c2d4f99ed6" class="i field">_scriptBlockData</a>.<a href="#0b48ef81314cd409" class="i property">HasSuspiciousContent</a>)
            {
                <a href="../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogOperationalWarning</span>(
                    <span class="i">id</span>: <a href="../remoting/common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../remoting/common/PSETWTracer.cs.html#537824865d62e570" class="i field">ScriptBlock_Compile_Detail</a>,
                    <span class="i">opcode</span>: <a href="../remoting/common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../remoting/common/PSETWTracer.cs.html#5c13bbf5691971de" class="i field">Create</a>,
                    <span class="i">task</span>: <a href="../remoting/common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../remoting/common/PSETWTracer.cs.html#970efdc5fe5714ba" class="i field">ExecuteCommand</a>,
                    <span class="i">keyword</span>: <a href="../remoting/common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../remoting/common/PSETWTracer.cs.html#05d709c2010b41d5" class="i field">UseAlwaysOperational</a>,
                    <span class="r183 r">segment</span> + 1,
                    <span class="r184 r">segments</span>,
                    <span class="r185 r">textToLog</span>,
                    <span class="r182 r">scriptBlock</span>.<a href="#84b30017d1a078db" class="i property">Id</a>.<span class="i">ToString</span>(),
                    <span class="r182 r">scriptBlock</span>.<a href="../lang/scriptblock.cs.html#20772981d01b9078" class="i property">File</a> ?? <b>string</b>.<span class="i">Empty</span>);
            }
            <b>else</b>
            {
                <a href="../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogOperationalVerbose</span>(
                    <span class="i">id</span>: <a href="../remoting/common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../remoting/common/PSETWTracer.cs.html#537824865d62e570" class="i field">ScriptBlock_Compile_Detail</a>,
                    <span class="i">opcode</span>: <a href="../remoting/common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../remoting/common/PSETWTracer.cs.html#5c13bbf5691971de" class="i field">Create</a>,
                    <span class="i">task</span>: <a href="../remoting/common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../remoting/common/PSETWTracer.cs.html#970efdc5fe5714ba" class="i field">ExecuteCommand</a>,
                    <span class="i">keyword</span>: <a href="../remoting/common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../remoting/common/PSETWTracer.cs.html#05d709c2010b41d5" class="i field">UseAlwaysOperational</a>,
                    <span class="r183 r">segment</span> + 1,
                    <span class="r184 r">segments</span>,
                    <span class="r185 r">textToLog</span>,
                    <span class="r182 r">scriptBlock</span>.<a href="#84b30017d1a078db" class="i property">Id</a>.<span class="i">ToString</span>(),
                    <span class="r182 r">scriptBlock</span>.<a href="../lang/scriptblock.cs.html#20772981d01b9078" class="i property">File</a> ?? <b>string</b>.<span class="i">Empty</span>);
            }
 
            <b>return</b> <b>true</b>;
        }
 
        <b>private static string</b> <a id="9c7bca808a9dff00" href="../../R/9c7bca808a9dff00.html" target="n" data-glyph="76,1" class="i method">FormatLogString</a>(<b>string</b> <span id="r194 rd" class="r194 r">textToLog</span>)
        {
            <b>const char</b> <span id="r195 rd" class="r195 r">NullControlChar</span> = <span class="s">&#39;\u0000&#39;</span>;
 
            <span class="c">// The null symbol - `␀`</span>
            <b>const char</b> <span id="r196 rd" class="r196 r">NullSymbolChar</span> = <span class="s">&#39;\u2400&#39;</span>;
 
            <span class="c">// No logging mechanism(s) cannot handle null and rendering may not be able to handle</span>
            <span class="c">// null as we have the string defined as a null terminated string in the manifest.</span>
            <span class="c">// So, replace null characters with the Unicode `SYMBOL FOR NULL`</span>
            <span class="c">// We don&#39;t just remove the characters to preserve the fact that a null character was there.</span>
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">UNIX</span>
<span class="e">            const char LinefeedControlChar = &#39;\u000A&#39;;
            const char CarriageReturnControlChar = &#39;\u000D&#39;;
 
            // We chose the return symbol because we believe it is more associated with these concepts
            // than the carriage return (␍), line feed (␊), or new line (␤) symbols.
            // The return symbol - `⏎`
            const char ReturnSymbolChar = &#39;\u23CE&#39;;
 
            if (Platform.IsLinux)
            {
                // Because the creation of the string builder is expensive
                // We only do this on Linux where we are doing multiple replace operations
                StringBuilder logBuilder = new StringBuilder(textToLog);
 
                logBuilder.Replace(NullControlChar, NullSymbolChar);
 
                // Syslog (only used on Linux) encodes CR and NL to their octal values.
                // We will replace them with a unicode  &#39;RETURN SYMBOL&#39; (U+23CE) charater for easier viewing
                logBuilder.Replace(LinefeedControlChar, ReturnSymbolChar);
                logBuilder.Replace(CarriageReturnControlChar, ReturnSymbolChar);
 
                return logBuilder.ToString();
            }
            else
            {
                return textToLog.Replace(NullControlChar, NullSymbolChar);
            }
</span><span class="k preprocess">#</span><span class="k preprocess">else</span>
            <b>return</b> <span class="r194 r">textToLog</span>.<span class="i">Replace</span>(<span class="r195 r">NullControlChar</span>, <span class="r196 r">NullSymbolChar</span>);
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
        }
 
        <b>private static bool</b> <a id="24fe41eb99c09f29" href="../../R/24fe41eb99c09f29.html" target="n" data-glyph="76,1" class="i method">GetAndValidateEncryptionRecipients</a>(
            <a href="../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="t t">ScriptBlock</a> <span id="r197 rd" class="r197 r">scriptBlock</span>,
            <a href="../PSConfiguration.cs.html#b80e130b16229ecc" class="t t">ProtectedEventLogging</a> <span id="r198 rd" class="r198 r">logSetting</span>)
        {
            <span class="c">// See if protected event logging is enabled</span>
            <b>if</b> (<span class="r198 r">logSetting</span>.<a href="../PSConfiguration.cs.html#faef4e99db8e36a1" class="i property">EnableProtectedEventLogging</a> == <b>true</b>)
            {
                <span class="c">// Get the encryption certificate</span>
                <b>if</b> (<span class="r198 r">logSetting</span>.<a href="../PSConfiguration.cs.html#5611c7a6791c44f9" class="i property">EncryptionCertificate</a> != <b>null</b>)
                {
                    <a href="../ErrorPackage.cs.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r199 rd" class="r199 r">error</span> = <b>null</b>;
                    <a href="../ExecutionContext.cs.html#130bda5418e8559c" class="t t">ExecutionContext</a> <span id="r200 rd" class="r200 r">executionContext</span> = <a href="../hostifaces/LocalPipeline.cs.html#4ecb13103c10f113" class="t t">LocalPipeline</a>.<a href="../hostifaces/LocalPipeline.cs.html#d3eaa3d3391ed484" class="i method">GetExecutionContextFromTLS</a>();
                    <a href="../SessionStatePublic.cs.html#0a202aa6b2d52930" class="t t">SessionState</a> <span id="r201 rd" class="r201 r">sessionState</span> = <b>null</b>;
 
                    <span class="c">// Use the session state from the current pipeline, if it exists.</span>
                    <b>if</b> (<span class="r200 r">executionContext</span> != <b>null</b>)
                    {
                        <span class="r201 r">sessionState</span> = <span class="r200 r">executionContext</span>.<a href="../ExecutionContext.cs.html#4502619a6e4808ee" class="i property">SessionState</a>;
                    }
 
                    <span class="c">// If the engine hasn&#39;t started up yet, then we&#39;re just compiling script</span>
                    <span class="c">// blocks. We&#39;ll have to log them when they are used and we have an engine</span>
                    <span class="c">// to work with.</span>
                    <b>if</b> (<span class="r201 r">sessionState</span> == <b>null</b>)
                    {
                        <b>return</b> <b>false</b>;
                    }
 
                    <b>string</b> <span id="r202 rd" class="r202 r">fullCertificateContent</span> = <b>string</b>.<span class="i">Join</span>(<span class="i">Environment</span>.<span class="i">NewLine</span>, <span class="r198 r">logSetting</span>.<a href="../PSConfiguration.cs.html#5611c7a6791c44f9" class="i property">EncryptionCertificate</a>);
 
                    <span class="c">// If the certificate has changed, drop all of our cached information</span>
                    <a href="#13e57f651cd4d2ab" class="i method">ResetCertificateCacheIfNeeded</a>(<span class="r202 r">fullCertificateContent</span>);
 
                    <span class="c">// If we have valid recipients, no need for further analysis.</span>
                    <b>if</b> (<a href="#fd7e76499659d16d" class="i field">s_encryptionRecipients</a> != <b>null</b>)
                    {
                        <b>return</b> <b>true</b>;
                    }
 
                    <span class="c">// If we&#39;ve already verified all of the properties of the cert we care about (even if it</span>
                    <span class="c">// didn&#39;t result in a valid cert), return now.</span>
                    <b>if</b> (<a href="#87ee29c95f6d53b7" class="i field">s_hasProcessedCertificate</a>)
                    {
                        <b>return</b> <b>true</b>;
                    }
 
                    <span class="c">// Resolve the certificate to a recipient</span>
                    <a href="../../security/SecuritySupport.cs.html#5c5b6fe96cf7c3f2" class="t t">CmsMessageRecipient</a> <span id="r203 rd" class="r203 r">recipient</span> = <b>new</b> <a href="../../security/SecuritySupport.cs.html#b3763cd21ae51368" class="t constructor">CmsMessageRecipient</a>(<span class="r202 r">fullCertificateContent</span>);
                    <span class="r203 r">recipient</span>.<a href="../../security/SecuritySupport.cs.html#cf095157bcdcff2d" class="i method">Resolve</a>(<span class="r201 r">sessionState</span>, <a href="../../security/SecuritySupport.cs.html#1ce40ae4097eedd5" class="t t">ResolutionPurpose</a>.<a href="../../security/SecuritySupport.cs.html#7fe822f4f96a4ab8" class="i field">Encryption</a>, <b>out</b> <span class="r199 r">error</span>);
                    <a href="#87ee29c95f6d53b7" class="i field">s_hasProcessedCertificate</a> = <b>true</b>;
 
                    <span class="c">// If there&#39;s an error that we haven&#39;t already reported, report it in the event log.</span>
                    <span class="c">// We only do this once, as the error will always be the same for a given certificate.</span>
                    <b>if</b> (<span class="r199 r">error</span> != <b>null</b>)
                    {
                        <span class="c">// If we got an error resolving the encryption certificate, log a warning and continue</span>
                        <span class="c">// logging the (unencrypted) message anyways. Logging trumps protected logging -</span>
                        <span class="c">// being able to detect that an attacker has compromised a box outweighs the danger of the</span>
                        <span class="c">// attacker seeing potentially sensitive data. Because if they aren&#39;t detected, then</span>
                        <span class="c">// they can just wait on the compromised box and see the sensitive data eventually anyways.</span>
                        <b>string</b> <span id="r204 rd" class="r204 r">errorMessage</span> = <a href="../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(
                            <span class="i">SecuritySupportStrings</span>.<span class="i">CouldNotUseCertificate</span>,
                            <span class="r199 r">error</span>.<a href="../ErrorPackage.cs.html#cab659be098926dd" class="i method">ToString</a>());
                        <a href="../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogOperationalError</span>(
                            <span class="i">id</span>: <a href="../remoting/common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../remoting/common/PSETWTracer.cs.html#537824865d62e570" class="i field">ScriptBlock_Compile_Detail</a>,
                            <span class="i">opcode</span>: <a href="../remoting/common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../remoting/common/PSETWTracer.cs.html#5c13bbf5691971de" class="i field">Create</a>,
                            <span class="i">task</span>: <a href="../remoting/common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../remoting/common/PSETWTracer.cs.html#970efdc5fe5714ba" class="i field">ExecuteCommand</a>,
                            <span class="i">keyword</span>: <a href="../remoting/common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../remoting/common/PSETWTracer.cs.html#05d709c2010b41d5" class="i field">UseAlwaysOperational</a>,
                            0,
                            0,
                            <span class="r204 r">errorMessage</span>,
                            <span class="r197 r">scriptBlock</span>.<a href="#84b30017d1a078db" class="i property">Id</a>.<span class="i">ToString</span>(),
                            <span class="r197 r">scriptBlock</span>.<a href="../lang/scriptblock.cs.html#20772981d01b9078" class="i property">File</a> ?? <b>string</b>.<span class="i">Empty</span>);
 
                        <b>return</b> <b>true</b>;
                    }
 
                    <span class="c">// Now, save the certificate. We&#39;ll be comfortable using this one from now on.</span>
                    <a href="#fd7e76499659d16d" class="i field">s_encryptionRecipients</a> = <b>new</b> <a href="../../security/SecuritySupport.cs.html#5c5b6fe96cf7c3f2" class="t t">CmsMessageRecipient</a>[] { <span class="r203 r">recipient</span> };
 
                    <span class="c">// Check if the certificate has a private key, and report a warning if so.</span>
                    <span class="c">// We only do this once, as the error will always be the same for a given certificate.</span>
                    <b>foreach</b> (<span class="i">X509Certificate2</span> <span id="r205 rd" class="r205 r">validationCertificate</span> <b>in</b> <span class="r203 r">recipient</span>.<a href="../../security/SecuritySupport.cs.html#eedb5991913b91ce" class="i property">Certificates</a>)
                    {
                        <b>if</b> (<span class="r205 r">validationCertificate</span>.<span class="i">HasPrivateKey</span>)
                        {
                            <span class="c">// Only log the first line of what we pulled from the configuration. If this is a path, this will have enough information.</span>
                            <span class="c">// If this is the actual certificate, only include the first line of the certificate content so that we&#39;re not permanently keeping the private</span>
                            <span class="c">// key in the log.</span>
                            <b>string</b> <span id="r206 rd" class="r206 r">certificateForLog</span> = <span class="r202 r">fullCertificateContent</span>;
                            <b>if</b> (<span class="r198 r">logSetting</span>.<a href="../PSConfiguration.cs.html#5611c7a6791c44f9" class="i property">EncryptionCertificate</a>.<span class="i">Length</span> &gt; 1)
                            {
                                <span class="r206 r">certificateForLog</span> = <span class="r198 r">logSetting</span>.<a href="../PSConfiguration.cs.html#5611c7a6791c44f9" class="i property">EncryptionCertificate</a>[1];
                            }
 
                            <b>string</b> <span id="r207 rd" class="r207 r">errorMessage</span> = <a href="../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(
                                <span class="i">SecuritySupportStrings</span>.<span class="i">CertificateContainsPrivateKey</span>,
                                <span class="r206 r">certificateForLog</span>);
                            <a href="../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogOperationalError</span>(
                                <span class="i">id</span>: <a href="../remoting/common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../remoting/common/PSETWTracer.cs.html#537824865d62e570" class="i field">ScriptBlock_Compile_Detail</a>,
                                <span class="i">opcode</span>: <a href="../remoting/common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../remoting/common/PSETWTracer.cs.html#5c13bbf5691971de" class="i field">Create</a>,
                                <span class="i">task</span>: <a href="../remoting/common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../remoting/common/PSETWTracer.cs.html#970efdc5fe5714ba" class="i field">ExecuteCommand</a>,
                                <span class="i">keyword</span>: <a href="../remoting/common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../remoting/common/PSETWTracer.cs.html#05d709c2010b41d5" class="i field">UseAlwaysOperational</a>,
                                0,
                                0,
                                <span class="r207 r">errorMessage</span>,
                                <span class="r197 r">scriptBlock</span>.<a href="#84b30017d1a078db" class="i property">Id</a>.<span class="i">ToString</span>(),
                                <span class="r197 r">scriptBlock</span>.<a href="../lang/scriptblock.cs.html#20772981d01b9078" class="i property">File</a> ?? <b>string</b>.<span class="i">Empty</span>);
                        }
                    }
                }
            }
 
            <b>return</b> <b>true</b>;
        }
 
        <b>private static readonly object</b> <a id="a9f30388f1800a1c" href="../../R/a9f30388f1800a1c.html" target="n" data-glyph="46,1" class="i field">s_syncObject</a> = <b>new</b> <b>object</b>();
        <b>private static string</b> <a id="4b3679c8875c1970" href="../../R/4b3679c8875c1970.html" target="n" data-glyph="46,1" class="i field">s_lastSeenCertificate</a> = <b>string</b>.<span class="i">Empty</span>;
        <b>private static bool</b> <a id="87ee29c95f6d53b7" href="../../R/87ee29c95f6d53b7.html" target="n" data-glyph="46,1" class="i field">s_hasProcessedCertificate</a> = <b>false</b>;
        <b>private static</b> <a href="../../security/SecuritySupport.cs.html#5c5b6fe96cf7c3f2" class="t t">CmsMessageRecipient</a>[] <a id="fd7e76499659d16d" href="../../R/fd7e76499659d16d.html" target="n" data-glyph="46,1" class="i field">s_encryptionRecipients</a> = <b>null</b>;
 
        <b>private static readonly</b> <span class="i">Lazy</span>&lt;<a href="../PSConfiguration.cs.html#77a0f8dab4448573" class="t t">ScriptBlockLogging</a>&gt; <a id="b11bd10c1ba0c603" href="../../R/b11bd10c1ba0c603.html" target="n" data-glyph="46,1" class="i field">s_sbLoggingSettingCache</a> = <b>new</b> <span class="i">Lazy</span>&lt;<a href="../PSConfiguration.cs.html#77a0f8dab4448573" class="t t">ScriptBlockLogging</a>&gt;(
            <b>static</b> () =&gt; <a href="../Utils.cs.html#9185d6ecbaebbec0" class="t t">Utils</a>.<a href="../Utils.cs.html#fb031837cf810b13" class="i method">GetPolicySetting</a>&lt;<a href="../PSConfiguration.cs.html#77a0f8dab4448573" class="t t">ScriptBlockLogging</a>&gt;(<a href="../Utils.cs.html#9185d6ecbaebbec0" class="t t">Utils</a>.<a href="../Utils.cs.html#7a2ef29ad39fd97e" class="i field">SystemWideThenCurrentUserConfig</a>),
            <span class="i">isThreadSafe</span>: <b>true</b>);
 
        <span class="c">// Reset any static caches if the certificate has changed</span>
        <b>private static void</b> <a id="13e57f651cd4d2ab" href="../../R/13e57f651cd4d2ab.html" target="n" data-glyph="76,1" class="i method">ResetCertificateCacheIfNeeded</a>(<b>string</b> <span id="r208 rd" class="r208 r">certificate</span>)
        {
            <b>if</b> (!<b>string</b>.<span class="i">Equals</span>(<a href="#4b3679c8875c1970" class="i field">s_lastSeenCertificate</a>, <span class="r208 r">certificate</span>, <span class="i">StringComparison</span>.<span class="i">Ordinal</span>))
            {
                <a href="#87ee29c95f6d53b7" class="i field">s_hasProcessedCertificate</a> = <b>false</b>;
                <a href="#4b3679c8875c1970" class="i field">s_lastSeenCertificate</a> = <span class="r208 r">certificate</span>;
                <a href="#fd7e76499659d16d" class="i field">s_encryptionRecipients</a> = <b>null</b>;
            }
        }
 
        <b>private static</b> <a href="../PSConfiguration.cs.html#77a0f8dab4448573" class="t t">ScriptBlockLogging</a> <a id="7474f4dd95b98f76" href="../../R/7474f4dd95b98f76.html" target="n" data-glyph="76,1" class="i method">GetScriptBlockLoggingSetting</a>()
        {
            <b>if</b> (<a href="../Utils.cs.html#f365eaa75311eda0" class="t t">InternalTestHooks</a>.<a href="../Utils.cs.html#de82c6590fd7de27" class="i field">BypassGroupPolicyCaching</a>)
            {
                <b>return</b> <a href="../Utils.cs.html#9185d6ecbaebbec0" class="t t">Utils</a>.<a href="../Utils.cs.html#fb031837cf810b13" class="i method">GetPolicySetting</a>&lt;<a href="../PSConfiguration.cs.html#77a0f8dab4448573" class="t t">ScriptBlockLogging</a>&gt;(<a href="../Utils.cs.html#9185d6ecbaebbec0" class="t t">Utils</a>.<a href="../Utils.cs.html#7a2ef29ad39fd97e" class="i field">SystemWideThenCurrentUserConfig</a>);
            }
 
            <b>return</b> <a href="#b11bd10c1ba0c603" class="i field">s_sbLoggingSettingCache</a>.<span class="i">Value</span>;
        }
 
        <span class="c">// Quick check for script blocks that may have suspicious content. If this</span>
        <span class="c">// is true, we log them to the event log despite event log settings.</span>
        <b>internal static string</b> <a id="d5d67f7728bfe547" href="../../R/d5d67f7728bfe547.html" target="n" data-glyph="74,1" class="i method">CheckSuspiciousContent</a>(<a href="../parser/ast.cs.html#d47621d83efd14de" class="t t">Ast</a> <span id="r209 rd" class="r209 r">scriptBlockAst</span>)
        {
            <b>var</b> <span id="r210 rd" class="r210 r">foundSignature</span> = <a href="#ed915683efd508fc" class="t t">SuspiciousContentChecker</a>.<a href="#535971e3a3b83500" class="i method">Match</a>(<span class="r209 r">scriptBlockAst</span>.<a href="../parser/ast.cs.html#d9d5cd324ee61136" class="i property">Extent</a>.<a href="../parser/Position.cs.html#43ce932d9225bc9c" class="i property">Text</a>);
            <b>if</b> (<span class="r210 r">foundSignature</span> != <b>null</b>)
            {
                <b>return</b> <span class="r210 r">foundSignature</span>;
            }
 
            <b>if</b> (<span class="r209 r">scriptBlockAst</span>.<a href="../parser/ast.cs.html#6c2f95c8b079b507" class="i property">HasSuspiciousContent</a>)
            {
                <a href="../parser/ast.cs.html#d47621d83efd14de" class="t t">Ast</a> <span id="r211 rd" class="r211 r">foundAst</span> = <span class="r209 r">scriptBlockAst</span>.<span class="i">Find</span>(
                    <span id="r212 rd" class="r212 r">ast</span> =&gt;
                    {
                        <span class="c">// Try to find the lowest AST that was not considered suspicious, but its parent was.</span>
                        <b>return</b> (!<span class="r212 r">ast</span>.<span class="i">HasSuspiciousContent</span>) &amp;&amp; <span class="r212 r">ast</span>.<span class="i">Parent</span>.<span class="i">HasSuspiciousContent</span>;
                    }, <b>true</b>);
 
                <b>if</b> (<span class="r211 r">foundAst</span> != <b>null</b>)
                {
                    <b>return</b> <span class="r211 r">foundAst</span>.<a href="../parser/ast.cs.html#faf9ad7a55f1cc57" class="i property">Parent</a>.<a href="../parser/ast.cs.html#d9d5cd324ee61136" class="i property">Extent</a>.<a href="../parser/Position.cs.html#43ce932d9225bc9c" class="i property">Text</a>;
                }
                <b>else</b>
                {
                    <b>return</b> <span class="r209 r">scriptBlockAst</span>.<a href="../parser/ast.cs.html#d9d5cd324ee61136" class="i property">Extent</a>.<a href="../parser/Position.cs.html#43ce932d9225bc9c" class="i property">Text</a>;
                }
            }
 
            <b>return</b> <b>null</b>;
        }
 
        <b>private static class</b> <a id="ed915683efd508fc" href="../../R/ed915683efd508fc.html" target="n" data-glyph="4,1" class="t t">SuspiciousContentChecker</a>
        {
            <span class="c">// Based on a (bad) random number generator, but good enough</span>
            <span class="c">// for our simple needs.</span>
            <b>private const uint</b> <a id="838ad4b88b00eb6e" href="../../R/838ad4b88b00eb6e.html" target="n" data-glyph="10,2" class="i field">LCG</a> = 31;
 
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> Check if a hash code matches a small set of pre-computed hashes</span>
            <span class="c">///</span><span class="c"> for suspicious strings in a PowerShell script.</span>
            <span class="c">///</span>
            <span class="c">///</span><span class="c"> If you need to add a new string, use the commented out</span>
            <span class="c">///</span><span class="c"> method HashNewPattern (commented out because it&#39;s dead</span>
            <span class="c">///</span><span class="c"> code - needed only to generate this switch statement below.)</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">The string matching the hash, or null.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
            <b>private static string</b> <a id="81fee013c1f8aedf" href="../../R/81fee013c1f8aedf.html" target="n" data-glyph="76,2" class="i method">LookupHash</a>(<b>uint</b> <span id="r213 rd" class="r213 r">h</span>)
            {
                <b>switch</b> (<span class="r213 r">h</span>)
                {
                    <span class="c">// Calling Add-Type</span>
                    <b>case</b> 3012981990: <b>return</b> <span class="s">&quot;Add-Type&quot;</span>;
                    <b>case</b> 3359423881: <b>return</b> <span class="s">&quot;DllImport&quot;</span>;
 
                    <span class="c">// Doing dynamic assembly building / method indirection</span>
                    <b>case</b> 2713126922: <b>return</b> <span class="s">&quot;DefineDynamicAssembly&quot;</span>;
                    <b>case</b> 2407049616: <b>return</b> <span class="s">&quot;DefineDynamicModule&quot;</span>;
                    <b>case</b> 3276870517: <b>return</b> <span class="s">&quot;DefineType&quot;</span>;
                    <b>case</b> 419507039: <b>return</b> <span class="s">&quot;DefineConstructor&quot;</span>;
                    <b>case</b> 1370182198: <b>return</b> <span class="s">&quot;CreateType&quot;</span>;
                    <b>case</b> 1973546644: <b>return</b> <span class="s">&quot;DefineLiteral&quot;</span>;
                    <b>case</b> 3276413244: <b>return</b> <span class="s">&quot;DefineEnum&quot;</span>;
                    <b>case</b> 2785322015: <b>return</b> <span class="s">&quot;DefineField&quot;</span>;
                    <b>case</b> 837002512: <b>return</b> <span class="s">&quot;ILGenerator&quot;</span>;
                    <b>case</b> 3117011: <b>return</b> <span class="s">&quot;Emit&quot;</span>;
                    <b>case</b> 883134515: <b>return</b> <span class="s">&quot;UnverifiableCodeAttribute&quot;</span>;
                    <b>case</b> 2920989166: <b>return</b> <span class="s">&quot;DefinePInvokeMethod&quot;</span>;
                    <b>case</b> 1996222179: <b>return</b> <span class="s">&quot;GetTypes&quot;</span>;
                    <b>case</b> 3935635674: <b>return</b> <span class="s">&quot;GetAssemblies&quot;</span>;
                    <b>case</b> 955534258: <b>return</b> <span class="s">&quot;Methods&quot;</span>;
                    <b>case</b> 3368914227: <b>return</b> <span class="s">&quot;Properties&quot;</span>;
 
                    <span class="c">// Suspicious methods / properties on &quot;Type&quot;</span>
                    <b>case</b> 398423780: <b>return</b> <span class="s">&quot;GetConstructor&quot;</span>;
                    <b>case</b> 3761202703: <b>return</b> <span class="s">&quot;GetConstructors&quot;</span>;
                    <b>case</b> 1998297230: <b>return</b> <span class="s">&quot;GetDefaultMembers&quot;</span>;
                    <b>case</b> 1982269700: <b>return</b> <span class="s">&quot;GetEvent&quot;</span>;
                    <b>case</b> 1320818671: <b>return</b> <span class="s">&quot;GetEvents&quot;</span>;
                    <b>case</b> 1982805860: <b>return</b> <span class="s">&quot;GetField&quot;</span>;
                    <b>case</b> 1337439631: <b>return</b> <span class="s">&quot;GetFields&quot;</span>;
                    <b>case</b> 2784018083: <b>return</b> <span class="s">&quot;GetInterface&quot;</span>;
                    <b>case</b> 2864332761: <b>return</b> <span class="s">&quot;GetInterfaceMap&quot;</span>;
                    <b>case</b> 405214768: <b>return</b> <span class="s">&quot;GetInterfaces&quot;</span>;
                    <b>case</b> 1534378352: <b>return</b> <span class="s">&quot;GetMember&quot;</span>;
                    <b>case</b> 321088771: <b>return</b> <span class="s">&quot;GetMembers&quot;</span>;
                    <b>case</b> 1534592951: <b>return</b> <span class="s">&quot;GetMethod&quot;</span>;
                    <b>case</b> 327741340: <b>return</b> <span class="s">&quot;GetMethods&quot;</span>;
                    <b>case</b> 1116240007: <b>return</b> <span class="s">&quot;GetNestedType&quot;</span>;
                    <b>case</b> 243701964: <b>return</b> <span class="s">&quot;GetNestedTypes&quot;</span>;
                    <b>case</b> 1077700873: <b>return</b> <span class="s">&quot;GetProperties&quot;</span>;
                    <b>case</b> 1020114731: <b>return</b> <span class="s">&quot;GetProperty&quot;</span>;
                    <b>case</b> 257791250: <b>return</b> <span class="s">&quot;InvokeMember&quot;</span>;
                    <b>case</b> 3217683173: <b>return</b> <span class="s">&quot;MakeArrayType&quot;</span>;
                    <b>case</b> 821968872: <b>return</b> <span class="s">&quot;MakeByRefType&quot;</span>;
                    <b>case</b> 3538448099: <b>return</b> <span class="s">&quot;MakeGenericType&quot;</span>;
                    <b>case</b> 3207725129: <b>return</b> <span class="s">&quot;MakePointerType&quot;</span>;
                    <b>case</b> 1617553224: <b>return</b> <span class="s">&quot;DeclaringMethod&quot;</span>;
                    <b>case</b> 3152745313: <b>return</b> <span class="s">&quot;DeclaringType&quot;</span>;
                    <b>case</b> 4144122198: <b>return</b> <span class="s">&quot;ReflectedType&quot;</span>;
                    <b>case</b> 3455789538: <b>return</b> <span class="s">&quot;TypeHandle&quot;</span>;
                    <b>case</b> 624373608: <b>return</b> <span class="s">&quot;TypeInitializer&quot;</span>;
                    <b>case</b> 637454598: <b>return</b> <span class="s">&quot;UnderlyingSystemType&quot;</span>;
 
                    <span class="c">// Doing things with System.Runtime.InteropServices</span>
                    <b>case</b> 1855303451: <b>return</b> <span class="s">&quot;InteropServices&quot;</span>;
                    <b>case</b> 839491486: <b>return</b> <span class="s">&quot;Marshal&quot;</span>;
                    <b>case</b> 1928879414: <b>return</b> <span class="s">&quot;AllocHGlobal&quot;</span>;
                    <b>case</b> 3180922282: <b>return</b> <span class="s">&quot;PtrToStructure&quot;</span>;
                    <b>case</b> 1718292736: <b>return</b> <span class="s">&quot;StructureToPtr&quot;</span>;
                    <b>case</b> 3390778911: <b>return</b> <span class="s">&quot;FreeHGlobal&quot;</span>;
                    <b>case</b> 3111215263: <b>return</b> <span class="s">&quot;IntPtr&quot;</span>;
 
                    <span class="c">// General Obfuscation</span>
                    <b>case</b> 1606191041: <b>return</b> <span class="s">&quot;MemoryStream&quot;</span>;
                    <b>case</b> 2147536747: <b>return</b> <span class="s">&quot;DeflateStream&quot;</span>;
                    <b>case</b> 1820815050: <b>return</b> <span class="s">&quot;FromBase64String&quot;</span>;
                    <b>case</b> 3656724093: <b>return</b> <span class="s">&quot;EncodedCommand&quot;</span>;
                    <b>case</b> 2920836328: <b>return</b> <span class="s">&quot;Bypass&quot;</span>;
                    <b>case</b> 3473847323: <b>return</b> <span class="s">&quot;ToBase64String&quot;</span>;
                    <b>case</b> 4192166699: <b>return</b> <span class="s">&quot;ExpandString&quot;</span>;
                    <b>case</b> 2462813217: <b>return</b> <span class="s">&quot;GetPowerShell&quot;</span>;
 
                    <span class="c">// Suspicious Win32 API calls</span>
                    <b>case</b> 2123968741: <b>return</b> <span class="s">&quot;OpenProcess&quot;</span>;
                    <b>case</b> 3630248714: <b>return</b> <span class="s">&quot;VirtualAlloc&quot;</span>;
                    <b>case</b> 3303847927: <b>return</b> <span class="s">&quot;VirtualFree&quot;</span>;
                    <b>case</b> 512407217: <b>return</b> <span class="s">&quot;WriteProcessMemory&quot;</span>;
                    <b>case</b> 2357873553: <b>return</b> <span class="s">&quot;CreateUserThread&quot;</span>;
                    <b>case</b> 756544032: <b>return</b> <span class="s">&quot;CloseHandle&quot;</span>;
                    <b>case</b> 3400025495: <b>return</b> <span class="s">&quot;GetDelegateForFunctionPointer&quot;</span>;
                    <b>case</b> 314128220: <b>return</b> <span class="s">&quot;kernel32&quot;</span>;
                    <b>case</b> 2469462534: <b>return</b> <span class="s">&quot;CreateThread&quot;</span>;
                    <b>case</b> 3217199031: <b>return</b> <span class="s">&quot;memcpy&quot;</span>;
                    <b>case</b> 2283745557: <b>return</b> <span class="s">&quot;LoadLibrary&quot;</span>;
                    <b>case</b> 3317813738: <b>return</b> <span class="s">&quot;GetModuleHandle&quot;</span>;
                    <b>case</b> 2491894472: <b>return</b> <span class="s">&quot;GetProcAddress&quot;</span>;
                    <b>case</b> 1757922660: <b>return</b> <span class="s">&quot;VirtualProtect&quot;</span>;
                    <b>case</b> 2693938383: <b>return</b> <span class="s">&quot;FreeLibrary&quot;</span>;
                    <b>case</b> 2873914970: <b>return</b> <span class="s">&quot;ReadProcessMemory&quot;</span>;
                    <b>case</b> 2717270220: <b>return</b> <span class="s">&quot;CreateRemoteThread&quot;</span>;
                    <b>case</b> 2867203884: <b>return</b> <span class="s">&quot;AdjustTokenPrivileges&quot;</span>;
                    <b>case</b> 2889068903: <b>return</b> <span class="s">&quot;WriteByte&quot;</span>;
                    <b>case</b> 3667925519: <b>return</b> <span class="s">&quot;WriteInt32&quot;</span>;
                    <b>case</b> 2742077861: <b>return</b> <span class="s">&quot;OpenThreadToken&quot;</span>;
                    <b>case</b> 2826980154: <b>return</b> <span class="s">&quot;PtrToString&quot;</span>;
                    <b>case</b> 3735047487: <b>return</b> <span class="s">&quot;ZeroFreeGlobalAllocUnicode&quot;</span>;
                    <b>case</b> 788615220: <b>return</b> <span class="s">&quot;OpenProcessToken&quot;</span>;
                    <b>case</b> 1264589033: <b>return</b> <span class="s">&quot;GetTokenInformation&quot;</span>;
                    <b>case</b> 2165372045: <b>return</b> <span class="s">&quot;SetThreadToken&quot;</span>;
                    <b>case</b> 197357349: <b>return</b> <span class="s">&quot;ImpersonateLoggedOnUser&quot;</span>;
                    <b>case</b> 1259149099: <b>return</b> <span class="s">&quot;RevertToSelf&quot;</span>;
                    <b>case</b> 2446460563: <b>return</b> <span class="s">&quot;GetLogonSessionData&quot;</span>;
                    <b>case</b> 2534763616: <b>return</b> <span class="s">&quot;CreateProcessWithToken&quot;</span>;
                    <b>case</b> 3512478977: <b>return</b> <span class="s">&quot;DuplicateTokenEx&quot;</span>;
                    <b>case</b> 3126049082: <b>return</b> <span class="s">&quot;OpenWindowStation&quot;</span>;
                    <b>case</b> 3990594194: <b>return</b> <span class="s">&quot;OpenDesktop&quot;</span>;
                    <b>case</b> 3195806696: <b>return</b> <span class="s">&quot;MiniDumpWriteDump&quot;</span>;
                    <b>case</b> 3990234693: <b>return</b> <span class="s">&quot;AddSecurityPackage&quot;</span>;
                    <b>case</b> 611728017: <b>return</b> <span class="s">&quot;EnumerateSecurityPackages&quot;</span>;
                    <b>case</b> 4283779521: <b>return</b> <span class="s">&quot;GetProcessHandle&quot;</span>;
                    <b>case</b> 845600244: <b>return</b> <span class="s">&quot;DangerousGetHandle&quot;</span>;
 
                    <span class="c">// Crypto - ransomware, etc.</span>
                    <b>case</b> 2691669189: <b>return</b> <span class="s">&quot;CryptoServiceProvider&quot;</span>;
                    <b>case</b> 1413809388: <b>return</b> <span class="s">&quot;Cryptography&quot;</span>;
                    <b>case</b> 4113841312: <b>return</b> <span class="s">&quot;RijndaelManaged&quot;</span>;
                    <b>case</b> 1650652922: <b>return</b> <span class="s">&quot;SHA1Managed&quot;</span>;
                    <b>case</b> 1759701889: <b>return</b> <span class="s">&quot;CryptoStream&quot;</span>;
                    <b>case</b> 2439640460: <b>return</b> <span class="s">&quot;CreateEncryptor&quot;</span>;
                    <b>case</b> 1446703796: <b>return</b> <span class="s">&quot;CreateDecryptor&quot;</span>;
                    <b>case</b> 1638240579: <b>return</b> <span class="s">&quot;TransformFinalBlock&quot;</span>;
                    <b>case</b> 1464730593: <b>return</b> <span class="s">&quot;DeviceIoControl&quot;</span>;
                    <b>case</b> 3966822309: <b>return</b> <span class="s">&quot;SetInformationProcess&quot;</span>;
                    <b>case</b> 851965993: <b>return</b> <span class="s">&quot;PasswordDeriveBytes&quot;</span>;
 
                    <span class="c">// Keylogging</span>
                    <b>case</b> 793353336: <b>return</b> <span class="s">&quot;GetAsyncKeyState&quot;</span>;
                    <b>case</b> 293877108: <b>return</b> <span class="s">&quot;GetKeyboardState&quot;</span>;
                    <b>case</b> 2448894537: <b>return</b> <span class="s">&quot;GetForegroundWindow&quot;</span>;
 
                    <span class="c">// Using internal types</span>
                    <b>case</b> 4059335458: <b>return</b> <span class="s">&quot;BindingFlags&quot;</span>;
                    <b>case</b> 1085624182: <b>return</b> <span class="s">&quot;NonPublic&quot;</span>;
 
                    <span class="c">// Changing logging settings</span>
                    <b>case</b> 904148605: <b>return</b> <span class="s">&quot;ScriptBlockLogging&quot;</span>;
                    <b>case</b> 4150524432: <b>return</b> <span class="s">&quot;LogPipelineExecutionDetails&quot;</span>;
                    <b>case</b> 3704712755: <b>return</b> <span class="s">&quot;ProtectedEventLogging&quot;</span>;
 
                    <b>default</b>: <b>return</b> <b>null</b>;
                }
            }
 
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> Check the list of running hashes for any matches, but</span>
            <span class="c">///</span><span class="c"> only up to the limit of </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r214 r">upTo</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c">.</span>
            <span class="c">///</span>
            <span class="c">///</span><span class="c"> If a hash matches, we ignore the possibility of a</span>
            <span class="c">///</span><span class="c"> collision. If the hash is acceptable, collisions will</span>
            <span class="c">///</span><span class="c"> be infrequent and we&#39;ll just log an occasionaly script</span>
            <span class="c">///</span><span class="c"> that isn&#39;t really suspicious.</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">The string matching the hash, or null.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
            <b>private static string</b> <a id="77b0c31e4b7dd2d0" href="../../R/77b0c31e4b7dd2d0.html" target="n" data-glyph="76,2" class="i method">CheckForMatches</a>(<b>uint</b>[] <span id="r215 rd" class="r215 r">runningHash</span>, <b>int</b> <span id="r214 rd" class="r214 r">upTo</span>)
            {
                <b>var</b> <span id="r216 rd" class="r216 r">upToMax</span> = <span class="r215 r">runningHash</span>.<span class="i">Length</span>;
                <b>if</b> (<span class="r214 r">upTo</span> == 0 || <span class="r214 r">upTo</span> &gt; <span class="r216 r">upToMax</span>)
                {
                    <span class="r214 r">upTo</span> = <span class="r216 r">upToMax</span>;
                }
 
                <b>for</b> (<b>var</b> <span id="r217 rd" class="r217 r">i</span> = 0; <span class="r217 r">i</span> &lt; <span class="r214 r">upTo</span>; <span class="r217 r">i</span>++)
                {
                    <b>var</b> <span id="r218 rd" class="r218 r">result</span> = <a href="#81fee013c1f8aedf" class="i method">LookupHash</a>(<span class="r215 r">runningHash</span>[<span class="r217 r">i</span>]);
                    <b>if</b> (<span class="r218 r">result</span> != <b>null</b>)
                    {
                        <b>return</b> <span class="r218 r">result</span>;
                    }
                }
 
                <b>return</b> <b>null</b>;
            }
 
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> Scan a string for suspicious content.</span>
            <span class="c">///</span>
            <span class="c">///</span><span class="c"> This is based on the Rubin-Karp algorithm, but heavily</span>
            <span class="c">///</span><span class="c"> modified to support searching for multiple patterns at</span>
            <span class="c">///</span><span class="c"> the same time.</span>
            <span class="c">///</span>
            <span class="c">///</span><span class="c"> The key difference from Rubin-Karp is that we don&#39;t undo</span>
            <span class="c">///</span><span class="c"> the hash of the first character as we shift along in the</span>
            <span class="c">///</span><span class="c"> input.</span>
            <span class="c">///</span>
            <span class="c">///</span><span class="c"> Instead, we can rely on knowing we need the hashes for</span>
            <span class="c">///</span><span class="c"> shorter strings anyway, so we reuse their values in</span>
            <span class="c">///</span><span class="c"> computing the hash for the longer patterns. This lets us</span>
            <span class="c">///</span><span class="c"> use a much simpler hash as well - we can avoid the use of</span>
            <span class="c">///</span><span class="c"> mod.</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">The string matching the hash, or null.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
            <b>public static string</b> <a id="535971e3a3b83500" href="../../R/535971e3a3b83500.html" target="n" data-glyph="72,2" class="i method">Match</a>(<b>string</b> <span id="r219 rd" class="r219 r">text</span>)
            {
                <span class="c">// The longest pattern is 29 characters.</span>
                <span class="c">// The values in the array are the computed hashes of length</span>
                <span class="c">// index-1 (so runningHash[0] holds the hash for length 1).</span>
                <b>var</b> <span id="r220 rd" class="r220 r">runningHash</span> = <b>new</b> <b>uint</b>[29];
 
                <b>int</b> <span id="r221 rd" class="r221 r">longestPossiblePattern</span> = 0;
                <b>for</b> (<b>int</b> <span id="r222 rd" class="r222 r">i</span> = 0; <span class="r222 r">i</span> &lt; <span class="r219 r">text</span>.<span class="i">Length</span>; <span class="r222 r">i</span>++)
                {
                    <b>uint</b> <span id="r223 rd" class="r223 r">h</span> = <span class="r219 r">text</span>[<span class="r222 r">i</span>];
                    <b>if</b> (<span class="r223 r">h</span> &gt;= <span class="s">&#39;A&#39;</span> &amp;&amp; <span class="r223 r">h</span> &lt;= <span class="s">&#39;Z&#39;</span>)
                    {
                        <span class="r223 r">h</span> |= 0x20; <span class="c">// ToLower</span>
                    }
                    <b>else</b> <b>if</b> (!((<span class="r223 r">h</span> &gt;= <span class="s">&#39;a&#39;</span> &amp;&amp; <span class="r223 r">h</span> &lt;= <span class="s">&#39;z&#39;</span>) || <span class="r223 r">h</span> == <span class="s">&#39;-&#39;</span>))
                    {
                        <span class="c">// If the character isn&#39;t in any of our patterns,</span>
                        <span class="c">// don&#39;t bother hashing and reset the running length.</span>
                        <span class="r221 r">longestPossiblePattern</span> = 0;
                        <b>continue</b>;
                    }
 
                    <b>for</b> (<b>int</b> <span id="r224 rd" class="r224 r">j</span> = <span class="i">Math</span>.<span class="i">Min</span>(<span class="r222 r">i</span>, <span class="r220 r">runningHash</span>.<span class="i">Length</span>) - 1; <span class="r224 r">j</span> &gt; 0; <span class="r224 r">j</span>--)
                    {
                        <span class="c">// Say our input is: `Emit` (our shortest pattern, len 4).</span>
                        <span class="c">// Towards the end just before matching, we will:</span>
                        <span class="c">//</span>
                        <span class="c">// iter n: compute hash on `Emi` (len 3)</span>
                        <span class="c">// iter n+1: compute hash on `Emit` (len 4) using hash from previous iteration (j-1)</span>
                        <span class="c">// iter n+1: compute hash on `mit` (len 3)</span>
                        <span class="c">//    This overwrites the previous iteration, hence we go from longest to shortest.</span>
                        <span class="c">//</span>
                        <span class="c">// LCG comes from a trivial (bad) random number generator,</span>
                        <span class="c">// but it&#39;s sufficient for us - the hashes for our patterns</span>
                        <span class="c">// are unique, and processing of 2200 files found no false matches.</span>
                        <span class="r220 r">runningHash</span>[<span class="r224 r">j</span>] = <a href="#838ad4b88b00eb6e" class="i field">LCG</a> * <span class="r220 r">runningHash</span>[<span class="r224 r">j</span> - 1] + <span class="r223 r">h</span>;
                    }
 
                    <span class="r220 r">runningHash</span>[0] = <span class="r223 r">h</span>;
 
                    <b>if</b> (++<span class="r221 r">longestPossiblePattern</span> &gt;= 4)
                    {
                        <b>var</b> <span id="r225 rd" class="r225 r">result</span> = <a href="#77b0c31e4b7dd2d0" class="i method">CheckForMatches</a>(<span class="r220 r">runningHash</span>, <span class="r221 r">longestPossiblePattern</span>);
                        <b>if</b> (<span class="r225 r">result</span> != <b>null</b>) <b>return</b> <span class="r225 r">result</span>;
                    }
                }
 
                <b>return</b> <a href="#77b0c31e4b7dd2d0" class="i method">CheckForMatches</a>(<span class="r220 r">runningHash</span>, 0);
            }
 
<span class="k preprocess">#</span><span class="k preprocess">if</span> <b>false</b>
<span class="e">            // This code can be used when adding a new pattern.
            internal static uint HashNewPattern(string pattern)
            {
                char ToLower(char c)
                {
                    if (c &gt;= &#39;A&#39; &amp;&amp; c &lt;= &#39;Z&#39;)
                    {
                        c = (char) (c | 0x20);
                    }
 
                    return c;
                }
 
                if (pattern.Length &gt; 29) {
                    throw new Exception(
                        &quot;Update runningHash in match for new longest string.\n&quot; +
                        &quot;Also a longer maximum length could greatly affect the performance of this algorithm, so only increase with care.&quot;);
                }
 
                uint h = 0;
                foreach (var c in pattern)
                {
                    h = LCG * h + ToLower(c);
                }
 
                return h;
            }
</span><span class="k preprocess">#</span><span class="k preprocess">endif</span>
        }
 
        <b>internal static void</b> <a id="5b263ac9d28348b4" href="../../R/5b263ac9d28348b4.html" target="n" data-glyph="74,1" class="i method">LogScriptBlockStart</a>(<a href="../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="t t">ScriptBlock</a> <span id="r226 rd" class="r226 r">scriptBlock</span>, <span class="i">Guid</span> <span id="r227 rd" class="r227 r">runspaceId</span>)
        {
            <span class="c">// Fast exit if the script block can skip logging.</span>
            <b>if</b> (!<span class="r226 r">scriptBlock</span>.<a href="#f04bfb1d05890259" class="i property">SkipLogging</a>)
            {
                <span class="c">// When invoking, log the creation of the script block if it has suspicious content</span>
                <b>bool</b> <span id="r228 rd" class="r228 r">forceLogCreation</span> = <span class="r226 r">scriptBlock</span>.<a href="#93a1a6c2d4f99ed6" class="i field">_scriptBlockData</a>.<a href="#0b48ef81314cd409" class="i property">HasSuspiciousContent</a>;
 
                <span class="c">// We delay logging the creation until the &#39;Start&#39; so that we can be sure we&#39;ve</span>
                <span class="c">// properly analyzed the script block&#39;s security.</span>
                <a href="#ef7b1ca995273fa6" class="i method">LogScriptBlockCreation</a>(<span class="r226 r">scriptBlock</span>, <span class="r228 r">forceLogCreation</span>);
            }
 
            <b>if</b> (<a href="#7474f4dd95b98f76" class="i method">GetScriptBlockLoggingSetting</a>()?.<a href="../PSConfiguration.cs.html#9d95dbdd96e5f65b" class="i property">EnableScriptBlockInvocationLogging</a> == <b>true</b>)
            {
                <a href="../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogOperationalVerbose</span>(
                    <span class="i">id</span>: <a href="../remoting/common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../remoting/common/PSETWTracer.cs.html#b8855e59d1a75832" class="i field">ScriptBlock_Invoke_Start_Detail</a>,
                    <span class="i">opcode</span>: <a href="../remoting/common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../remoting/common/PSETWTracer.cs.html#5c13bbf5691971de" class="i field">Create</a>,
                    <span class="i">task</span>: <a href="../remoting/common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../remoting/common/PSETWTracer.cs.html#cae1efe535f9aafa" class="i field">CommandStart</a>,
                    <span class="i">keyword</span>: <a href="../remoting/common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../remoting/common/PSETWTracer.cs.html#05d709c2010b41d5" class="i field">UseAlwaysOperational</a>,
                    <span class="r226 r">scriptBlock</span>.<a href="#84b30017d1a078db" class="i property">Id</a>.<span class="i">ToString</span>(),
                    <span class="r227 r">runspaceId</span>.<span class="i">ToString</span>());
            }
        }
 
        <b>internal static void</b> <a id="0412bd44086911de" href="../../R/0412bd44086911de.html" target="n" data-glyph="74,1" class="i method">LogScriptBlockEnd</a>(<a href="../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="t t">ScriptBlock</a> <span id="r229 rd" class="r229 r">scriptBlock</span>, <span class="i">Guid</span> <span id="r230 rd" class="r230 r">runspaceId</span>)
        {
            <b>if</b> (<a href="#7474f4dd95b98f76" class="i method">GetScriptBlockLoggingSetting</a>()?.<a href="../PSConfiguration.cs.html#9d95dbdd96e5f65b" class="i property">EnableScriptBlockInvocationLogging</a> == <b>true</b>)
            {
                <a href="../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogOperationalVerbose</span>(
                    <span class="i">id</span>: <a href="../remoting/common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../remoting/common/PSETWTracer.cs.html#d57295b2e2d18ccc" class="i field">ScriptBlock_Invoke_Complete_Detail</a>,
                    <span class="i">opcode</span>: <a href="../remoting/common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../remoting/common/PSETWTracer.cs.html#5c13bbf5691971de" class="i field">Create</a>,
                    <span class="i">task</span>: <a href="../remoting/common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../remoting/common/PSETWTracer.cs.html#19af28c42d5b21dc" class="i field">CommandStop</a>,
                    <span class="i">keyword</span>: <a href="../remoting/common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../remoting/common/PSETWTracer.cs.html#05d709c2010b41d5" class="i field">UseAlwaysOperational</a>,
                    <span class="r229 r">scriptBlock</span>.<a href="#84b30017d1a078db" class="i property">Id</a>.<span class="i">ToString</span>(),
                    <span class="r230 r">runspaceId</span>.<span class="i">ToString</span>());
            }
        }
 
        <b>internal</b> <a href="#a80c8ca7922183a5" class="t t">CompiledScriptBlockData</a> <a id="755d14464cc0fe20" href="../../R/755d14464cc0fe20.html" target="n" data-glyph="104,1" class="i property">ScriptBlockData</a> { <b>get</b> =&gt; <a href="#93a1a6c2d4f99ed6" class="i field">_scriptBlockData</a>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Returns the AST corresponding to the script block.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public</b> <a href="../parser/ast.cs.html#d47621d83efd14de" class="t t">Ast</a> <a id="e028cdfe16daf552" href="../../R/e028cdfe16daf552.html" target="n" data-glyph="102,1" class="i property">Ast</a> { <b>get</b> =&gt; (<a href="../parser/ast.cs.html#d47621d83efd14de" class="t t">Ast</a>)<a href="#93a1a6c2d4f99ed6" class="i field">_scriptBlockData</a>.<a href="#4fc4e37b6267d386" class="i property">Ast</a>; }
 
        <b>internal</b> <a href="../parser/ast.cs.html#063cc8bbea9e10f2" class="t t">IParameterMetadataProvider</a> <a id="02087845babe4650" href="../../R/02087845babe4650.html" target="n" data-glyph="104,1" class="i property">AstInternal</a> { <b>get</b> =&gt; <a href="#93a1a6c2d4f99ed6" class="i field">_scriptBlockData</a>.<a href="#4fc4e37b6267d386" class="i property">Ast</a>; }
 
        <b>internal</b> <a href="../parser/Position.cs.html#bbc751d075344454" class="t t">IScriptExtent</a>[] <a id="fa7a45aa6cb804cf" href="../../R/fa7a45aa6cb804cf.html" target="n" data-glyph="104,1" class="i property">SequencePoints</a> { <b>get</b> =&gt; <a href="#93a1a6c2d4f99ed6" class="i field">_scriptBlockData</a>.<a href="#f7bd45487f76d285" class="i property">SequencePoints</a>; }
 
        <b>internal</b> <span class="i">Action</span>&lt;<a href="../parser/Compiler.cs.html#aa4ec5dd36f7e2eb" class="t t">FunctionContext</a>&gt; <a id="392285d852716b6e" href="../../R/392285d852716b6e.html" target="n" data-glyph="104,1" class="i property">DynamicParamBlock</a> { <b>get</b> =&gt; <a href="#93a1a6c2d4f99ed6" class="i field">_scriptBlockData</a>.<a href="#c18d520d763b6c11" class="i property">DynamicParamBlock</a>; }
 
        <b>internal</b> <span class="i">Action</span>&lt;<a href="../parser/Compiler.cs.html#aa4ec5dd36f7e2eb" class="t t">FunctionContext</a>&gt; <a id="14cb97c0057ead9e" href="../../R/14cb97c0057ead9e.html" target="n" data-glyph="104,1" class="i property">UnoptimizedDynamicParamBlock</a> { <b>get</b> =&gt; <a href="#93a1a6c2d4f99ed6" class="i field">_scriptBlockData</a>.<a href="#ef7c60a2857843dc" class="i property">UnoptimizedDynamicParamBlock</a>; }
 
        <b>internal</b> <span class="i">Action</span>&lt;<a href="../parser/Compiler.cs.html#aa4ec5dd36f7e2eb" class="t t">FunctionContext</a>&gt; <a id="4466269805a5863e" href="../../R/4466269805a5863e.html" target="n" data-glyph="104,1" class="i property">BeginBlock</a> { <b>get</b> =&gt; <a href="#93a1a6c2d4f99ed6" class="i field">_scriptBlockData</a>.<a href="#9913dea66272cc70" class="i property">BeginBlock</a>; }
 
        <b>internal</b> <span class="i">Action</span>&lt;<a href="../parser/Compiler.cs.html#aa4ec5dd36f7e2eb" class="t t">FunctionContext</a>&gt; <a id="6052408bb7624a4e" href="../../R/6052408bb7624a4e.html" target="n" data-glyph="104,1" class="i property">UnoptimizedBeginBlock</a> { <b>get</b> =&gt; <a href="#93a1a6c2d4f99ed6" class="i field">_scriptBlockData</a>.<a href="#22c1e1d6bb481504" class="i property">UnoptimizedBeginBlock</a>; }
 
        <b>internal</b> <span class="i">Action</span>&lt;<a href="../parser/Compiler.cs.html#aa4ec5dd36f7e2eb" class="t t">FunctionContext</a>&gt; <a id="46b25735aefff06f" href="../../R/46b25735aefff06f.html" target="n" data-glyph="104,1" class="i property">ProcessBlock</a> { <b>get</b> =&gt; <a href="#93a1a6c2d4f99ed6" class="i field">_scriptBlockData</a>.<a href="#81b0289e5e379546" class="i property">ProcessBlock</a>; }
 
        <b>internal</b> <span class="i">Action</span>&lt;<a href="../parser/Compiler.cs.html#aa4ec5dd36f7e2eb" class="t t">FunctionContext</a>&gt; <a id="83941ff41ae9d393" href="../../R/83941ff41ae9d393.html" target="n" data-glyph="104,1" class="i property">UnoptimizedProcessBlock</a> { <b>get</b> =&gt; <a href="#93a1a6c2d4f99ed6" class="i field">_scriptBlockData</a>.<a href="#efa61db3d10b1e5f" class="i property">UnoptimizedProcessBlock</a>; }
 
        <b>internal</b> <span class="i">Action</span>&lt;<a href="../parser/Compiler.cs.html#aa4ec5dd36f7e2eb" class="t t">FunctionContext</a>&gt; <a id="b6696f8aab4cc825" href="../../R/b6696f8aab4cc825.html" target="n" data-glyph="104,1" class="i property">EndBlock</a> { <b>get</b> =&gt; <a href="#93a1a6c2d4f99ed6" class="i field">_scriptBlockData</a>.<a href="#6210fa92a7dbeebe" class="i property">EndBlock</a>; }
 
        <b>internal</b> <span class="i">Action</span>&lt;<a href="../parser/Compiler.cs.html#aa4ec5dd36f7e2eb" class="t t">FunctionContext</a>&gt; <a id="0c428bcdac23053a" href="../../R/0c428bcdac23053a.html" target="n" data-glyph="104,1" class="i property">UnoptimizedEndBlock</a> { <b>get</b> =&gt; <a href="#93a1a6c2d4f99ed6" class="i field">_scriptBlockData</a>.<a href="#3255522102eddb54" class="i property">UnoptimizedEndBlock</a>; }
 
        <b>internal bool</b> <a id="680dd2bf19ec8364" href="../../R/680dd2bf19ec8364.html" target="n" data-glyph="104,1" class="i property">HasBeginBlock</a> { <b>get</b> =&gt; <a href="#02087845babe4650" class="i property">AstInternal</a>.<a href="../parser/ast.cs.html#b25d4ae40ae3a393" class="i property">Body</a>.<a href="../parser/ast.cs.html#08794a618a2d04ac" class="i property">BeginBlock</a> != <b>null</b>; }
 
        <b>internal bool</b> <a id="5ee5abba7294e48d" href="../../R/5ee5abba7294e48d.html" target="n" data-glyph="104,1" class="i property">HasProcessBlock</a> { <b>get</b> =&gt; <a href="#02087845babe4650" class="i property">AstInternal</a>.<a href="../parser/ast.cs.html#b25d4ae40ae3a393" class="i property">Body</a>.<a href="../parser/ast.cs.html#8940fb8f9b3e6444" class="i property">ProcessBlock</a> != <b>null</b>; }
 
        <b>internal bool</b> <a id="e0cf74ca3d5f266a" href="../../R/e0cf74ca3d5f266a.html" target="n" data-glyph="104,1" class="i property">HasEndBlock</a> { <b>get</b> =&gt; <a href="#02087845babe4650" class="i property">AstInternal</a>.<a href="../parser/ast.cs.html#b25d4ae40ae3a393" class="i property">Body</a>.<a href="../parser/ast.cs.html#958e631868900aba" class="i property">EndBlock</a> != <b>null</b>; }
    }
 
    [<span class="i">Serializable</span>]
    <b>internal class</b> <a id="79a312bbf298b06b" href="../../R/79a312bbf298b06b.html" target="n" data-glyph="2,0" class="t t">ScriptBlockSerializationHelper</a> : <span class="i">ISerializable</span>, <span class="i">IObjectReference</span>
    {
        <b>private readonly string</b> <a id="bfdd7375687cc52d" href="../../R/bfdd7375687cc52d.html" target="n" data-glyph="46,1" class="i field">_scriptText</a>;
 
        <b>private</b> <a id="5ee3cadf6ccfd20d" href="../../R/../../0000000000.html" target="n" data-glyph="76,1" class="t constructor">ScriptBlockSerializationHelper</a>(<span class="i">SerializationInfo</span> <span id="r231 rd" class="r231 r">info</span>, <span class="i">StreamingContext</span> <span id="r232 rd" class="r232 r">context</span>)
        {
            <b>if</b> (<span class="r231 r">info</span> == <b>null</b>)
            {
                <b>throw</b> <b>new</b> <span class="i">ArgumentNullException</span>(<b>nameof</b>(<span class="r231 r">info</span>));
            }
 
            <a href="#bfdd7375687cc52d" class="i field">_scriptText</a> = <span class="r231 r">info</span>.<span class="i">GetValue</span>(<span class="s">&quot;ScriptText&quot;</span>, <b>typeof</b>(<b>string</b>)) <b>as string</b>;
            <b>if</b> (<a href="#bfdd7375687cc52d" class="i field">_scriptText</a> == <b>null</b>)
            {
                <b>throw</b> <a href="../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../../utils/MshTraceSource.cs.html#fbe67220ad7522a0" class="i method">NewArgumentNullException</a>(<b>nameof</b>(<span class="r231 r">info</span>));
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Returns a script block that corresponds to the version deserialized.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r233 r">context</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The streaming context for this instance.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">A script block that corresponds to the version deserialized.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public object</b> <a id="df7959682f70194f" href="../../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">GetRealObject</a>(<span class="i">StreamingContext</span> <span id="r233 rd" class="r233 r">context</span>) =&gt; <a href="../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="t t">ScriptBlock</a>.<a href="../lang/scriptblock.cs.html#adfac0fa7bf5725f" class="i method">Create</a>(<a href="#bfdd7375687cc52d" class="i field">_scriptText</a>);
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Implements the ISerializable contract for serializing a scriptblock.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r234 r">info</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Serialization information for this instance.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r235 r">context</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The streaming context for this instance.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>public virtual void</b> <a id="95545fe090e5d51c" href="../../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">GetObjectData</a>(<span class="i">SerializationInfo</span> <span id="r234 rd" class="r234 r">info</span>, <span class="i">StreamingContext</span> <span id="r235 rd" class="r235 r">context</span>)
            =&gt; <b>throw</b> <b>new</b> <span class="i">NotSupportedException</span>();
    }
 
    <b>internal sealed class</b> <a id="20151031a0be3c24" href="../../R/20151031a0be3c24.html" target="n" data-glyph="2,0" class="t t">PSScriptCmdlet</a> : <a href="../../P/30543a6971fed1fc.html#30543a6971fed1fc" class="t t">PSCmdlet</a>, <a href="../MshCmdlet.cs.html#c401984c7c9aeb48" class="t t">IDynamicParameters</a>, <span class="i">IDisposable</span>
    {
        <b>private readonly</b> <span class="i">ArrayList</span> <a id="7633ed3f604753f3" href="../../R/7633ed3f604753f3.html" target="n" data-glyph="46,1" class="i field">_input</a> = <b>new</b> <span class="i">ArrayList</span>();
        <b>private readonly</b> <a href="../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="t t">ScriptBlock</a> <a id="38a16315e09e6dac" href="../../R/38a16315e09e6dac.html" target="n" data-glyph="46,1" class="i field">_scriptBlock</a>;
        <b>private readonly bool</b> <a id="cdf8568cb736993b" href="../../R/cdf8568cb736993b.html" target="n" data-glyph="46,1" class="i field">_fromScriptFile</a>;
        <b>private readonly bool</b> <a id="e5892ff505265931" href="../../R/e5892ff505265931.html" target="n" data-glyph="46,1" class="i field">_useLocalScope</a>;
        <b>private readonly bool</b> <a id="4fb348c75e1e71ab" href="../../R/4fb348c75e1e71ab.html" target="n" data-glyph="46,1" class="i field">_runOptimized</a>;
        <b>private readonly bool</b> <a id="59e19debab345a7b" href="../../R/59e19debab345a7b.html" target="n" data-glyph="46,1" class="i field">_rethrowExitException</a>;
        <b>private</b> <a href="../MshCommandRuntime.cs.html#f9ebe6a3b284ab55" class="t t">MshCommandRuntime</a> <a id="68dec21f3eafb4a8" href="../../R/68dec21f3eafb4a8.html" target="n" data-glyph="46,1" class="i field">_commandRuntime</a>;
        <b>private readonly</b> <a href="MutableTuple.cs.html#d4c692d6a8bac31d" class="t t">MutableTuple</a> <a id="a9a5e07b3f71abe5" href="../../R/a9a5e07b3f71abe5.html" target="n" data-glyph="46,1" class="i field">_localsTuple</a>;
        <b>private bool</b> <a id="069f9d3d7d0ece5d" href="../../R/069f9d3d7d0ece5d.html" target="n" data-glyph="46,1" class="i field">_exitWasCalled</a>;
        <b>private readonly</b> <a href="../parser/Compiler.cs.html#aa4ec5dd36f7e2eb" class="t t">FunctionContext</a> <a id="c71c6db8ad1c332e" href="../../R/c71c6db8ad1c332e.html" target="n" data-glyph="46,1" class="i field">_functionContext</a>;
 
        <b>public</b> <a id="bd083c0ce4190995" href="../../R/bd083c0ce4190995.html" target="n" data-glyph="72,1" class="t constructor">PSScriptCmdlet</a>(<a href="../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="t t">ScriptBlock</a> <span id="r236 rd" class="r236 r">scriptBlock</span>, <b>bool</b> <span id="r237 rd" class="r237 r">useNewScope</span>, <b>bool</b> <span id="r238 rd" class="r238 r">fromScriptFile</span>, <a href="../ExecutionContext.cs.html#130bda5418e8559c" class="t t">ExecutionContext</a> <span id="r239 rd" class="r239 r">context</span>)
        {
            <a href="#38a16315e09e6dac" class="i field">_scriptBlock</a> = <span class="r236 r">scriptBlock</span>;
            <a href="#e5892ff505265931" class="i field">_useLocalScope</a> = <span class="r237 r">useNewScope</span>;
            <a href="#cdf8568cb736993b" class="i field">_fromScriptFile</a> = <span class="r238 r">fromScriptFile</span>;
            <a href="#4fb348c75e1e71ab" class="i field">_runOptimized</a> = <a href="#38a16315e09e6dac" class="i field">_scriptBlock</a>.<a href="#fed28a51bb21935d" class="i method">Compile</a>(<span class="r170 r">optimized</span>: <span class="r239 r">context</span>.<a href="../ExecutionContext.cs.html#00e6fdde4b76eb15" class="i field">_debuggingMode</a> &lt;= 0 &amp;&amp; <span class="r237 r">useNewScope</span>);
            <a href="#a9a5e07b3f71abe5" class="i field">_localsTuple</a> = <a href="#38a16315e09e6dac" class="i field">_scriptBlock</a>.<a href="#74eb29587e65199f" class="i method">MakeLocalsTuple</a>(<a href="#4fb348c75e1e71ab" class="i field">_runOptimized</a>);
            <a href="#a9a5e07b3f71abe5" class="i field">_localsTuple</a>.<a href="MutableTuple.cs.html#b596dd33aa0e3dbc" class="i method">SetAutomaticVariable</a>(<a href="../SpecialVariables.cs.html#1c6f2efd91287b59" class="t t">AutomaticVariable</a>.<a href="../SpecialVariables.cs.html#37f55176262aac78" class="i field">PSCmdlet</a>, <a href="#20151031a0be3c24" class="k">this</a>, <span class="r239 r">context</span>);
            <a href="#38a16315e09e6dac" class="i field">_scriptBlock</a>.<a href="../lang/scriptblock.cs.html#a3474072505c30d2" class="i method">SetPSScriptRootAndPSCommandPath</a>(<a href="#a9a5e07b3f71abe5" class="i field">_localsTuple</a>, <span class="r239 r">context</span>);
            <a href="#c71c6db8ad1c332e" class="i field">_functionContext</a> = <b>new</b> <span class="t">FunctionContext</span>
            {
                <a href="../parser/Compiler.cs.html#23a9d5ac6a3b086b" class="i field">_localsTuple</a> = <a href="#a9a5e07b3f71abe5" class="i field">_localsTuple</a>,
                <a href="../parser/Compiler.cs.html#4980a1f93a561cb3" class="i field">_scriptBlock</a> = <a href="#38a16315e09e6dac" class="i field">_scriptBlock</a>,
                <a href="../parser/Compiler.cs.html#95a73081cffaa015" class="i field">_file</a> = <a href="#38a16315e09e6dac" class="i field">_scriptBlock</a>.<a href="../lang/scriptblock.cs.html#20772981d01b9078" class="i property">File</a>,
                <a href="../parser/Compiler.cs.html#354889e302c1693c" class="i field">_sequencePoints</a> = <a href="#38a16315e09e6dac" class="i field">_scriptBlock</a>.<a href="#fa7a45aa6cb804cf" class="i property">SequencePoints</a>,
                <a href="../parser/Compiler.cs.html#f9539890beb6e765" class="i field">_debuggerHidden</a> = <a href="#38a16315e09e6dac" class="i field">_scriptBlock</a>.<a href="#6bbac4f67f789407" class="i property">DebuggerHidden</a>,
                <a href="../parser/Compiler.cs.html#f82ab745f95a8791" class="i field">_debuggerStepThrough</a> = <a href="#38a16315e09e6dac" class="i field">_scriptBlock</a>.<a href="#28f1dfc28a9bfb01" class="i property">DebuggerStepThrough</a>,
                <a href="../parser/Compiler.cs.html#86d08ccdd0602a1b" class="i field">_executionContext</a> = <span class="r239 r">context</span>,
            };
            <a href="#59e19debab345a7b" class="i field">_rethrowExitException</a> = <span class="r239 r">context</span>.<a href="../ExecutionContext.cs.html#da0268d4cb08ef32" class="i property">ScriptCommandProcessorShouldRethrowExit</a>;
            <span class="r239 r">context</span>.<a href="../ExecutionContext.cs.html#da0268d4cb08ef32" class="i property">ScriptCommandProcessorShouldRethrowExit</a> = <b>false</b>;
        }
 
        <b>protected override void</b> <a id="6b6acf3a64101864" href="../../R/6b6acf3a64101864.html" target="n" data-glyph="75,1" class="i method">BeginProcessing</a>()
        {
            <span class="c">// commandRuntime and the execution context are set here and in GetDynamicParameters.  GetDynamicParameters isn&#39;t</span>
            <span class="c">// called unless the scriptblock has a dynamicparam block, so we must set these values in both places.  It&#39;d</span>
            <span class="c">// be cleaner to set in the constructor, but neither the commandRuntime nor the context are set when being constructed.</span>
            <a href="#68dec21f3eafb4a8" class="i field">_commandRuntime</a> = (<a href="../MshCommandRuntime.cs.html#f9ebe6a3b284ab55" class="t t">MshCommandRuntime</a>)<a href="../CommandBase.cs.html#71eb09c6dd471a86" class="i field">commandRuntime</a>;
 
            <span class="c">// We don&#39;t set the output pipe until after GetDynamicParameters because dynamic parameters aren&#39;t written to the</span>
            <span class="c">// command processors pipe, but once we enter begin, we will write to the default pipe.</span>
            <a href="#c71c6db8ad1c332e" class="i field">_functionContext</a>.<a href="../parser/Compiler.cs.html#6c44d518392049f0" class="i field">_outputPipe</a> = <a href="#68dec21f3eafb4a8" class="i field">_commandRuntime</a>.<a href="../MshCommandRuntime.cs.html#b24610eb88ee27e9" class="i property">OutputPipe</a>;
 
            <a href="#2fa542e5974eebfe" class="i method">SetPreferenceVariables</a>();
 
            <b>if</b> (<a href="#38a16315e09e6dac" class="i field">_scriptBlock</a>.<a href="#680dd2bf19ec8364" class="i property">HasBeginBlock</a>)
            {
                <span class="i">RunClause</span>(
                    <span class="i">clause</span>: <a href="#4fb348c75e1e71ab" class="i field">_runOptimized</a> ? <a href="#38a16315e09e6dac" class="i field">_scriptBlock</a>.<a href="#4466269805a5863e" class="i property">BeginBlock</a> : <a href="#38a16315e09e6dac" class="i field">_scriptBlock</a>.<a href="#6052408bb7624a4e" class="i property">UnoptimizedBeginBlock</a>,
                    <span class="i">dollarUnderbar</span>: <a href="../AutomationNull.cs.html#681fbea4c40e4af1" class="t t">AutomationNull</a>.<a href="../AutomationNull.cs.html#1cf7e193da582896" class="i property">Value</a>,
                    <span class="i">inputToProcess</span>: <a href="#7633ed3f604753f3" class="i field">_input</a>);
            }
        }
 
        <b>internal override void</b> <a id="910a4e2f09b7345b" href="../../R/910a4e2f09b7345b.html" target="n" data-glyph="74,1" class="i method">DoProcessRecord</a>()
        {
            <b>if</b> (<a href="#069f9d3d7d0ece5d" class="i field">_exitWasCalled</a>)
            {
                <b>return</b>;
            }
 
            <b>object</b> <span id="r240 rd" class="r240 r">dollarUnder</span>;
            <b>if</b> (<a href="../CommandBase.cs.html#394e3b79ee75331b" class="i property">CurrentPipelineObject</a> == <a href="../AutomationNull.cs.html#681fbea4c40e4af1" class="t t">AutomationNull</a>.<a href="../AutomationNull.cs.html#1cf7e193da582896" class="i property">Value</a>)
            {
                <span class="r240 r">dollarUnder</span> = <b>null</b>;
            }
            <b>else</b>
            {
                <span class="r240 r">dollarUnder</span> = <a href="../CommandBase.cs.html#394e3b79ee75331b" class="i property">CurrentPipelineObject</a>;
                <a href="#7633ed3f604753f3" class="i field">_input</a>.<span class="i">Add</span>(<span class="r240 r">dollarUnder</span>);
            }
 
            <b>if</b> (<a href="#38a16315e09e6dac" class="i field">_scriptBlock</a>.<a href="#5ee5abba7294e48d" class="i property">HasProcessBlock</a>)
            {
                <span class="i">RunClause</span>(
                    <span class="i">clause</span>: <a href="#4fb348c75e1e71ab" class="i field">_runOptimized</a> ? <a href="#38a16315e09e6dac" class="i field">_scriptBlock</a>.<a href="#46b25735aefff06f" class="i property">ProcessBlock</a> : <a href="#38a16315e09e6dac" class="i field">_scriptBlock</a>.<a href="#83941ff41ae9d393" class="i property">UnoptimizedProcessBlock</a>,
                    <span class="i">dollarUnderbar</span>: <span class="r240 r">dollarUnder</span>,
                    <span class="i">inputToProcess</span>: <a href="#7633ed3f604753f3" class="i field">_input</a>);
                <a href="#7633ed3f604753f3" class="i field">_input</a>.<span class="i">Clear</span>();
            }
        }
 
        <b>internal override void</b> <a id="929984d343ad441d" href="../../R/929984d343ad441d.html" target="n" data-glyph="74,1" class="i method">DoEndProcessing</a>()
        {
            <b>if</b> (<a href="#069f9d3d7d0ece5d" class="i field">_exitWasCalled</a>)
            {
                <b>return</b>;
            }
 
            <b>if</b> (<a href="#38a16315e09e6dac" class="i field">_scriptBlock</a>.<a href="#e0cf74ca3d5f266a" class="i property">HasEndBlock</a>)
            {
                <span class="i">RunClause</span>(
                    <span class="i">clause</span>: <a href="#4fb348c75e1e71ab" class="i field">_runOptimized</a> ? <a href="#38a16315e09e6dac" class="i field">_scriptBlock</a>.<a href="#b6696f8aab4cc825" class="i property">EndBlock</a> : <a href="#38a16315e09e6dac" class="i field">_scriptBlock</a>.<a href="#0c428bcdac23053a" class="i property">UnoptimizedEndBlock</a>,
                    <span class="i">dollarUnderbar</span>: <a href="../AutomationNull.cs.html#681fbea4c40e4af1" class="t t">AutomationNull</a>.<a href="../AutomationNull.cs.html#1cf7e193da582896" class="i property">Value</a>,
                    <span class="i">inputToProcess</span>: <a href="#7633ed3f604753f3" class="i field">_input</a>.<span class="i">ToArray</span>());
            }
        }
 
        <b>private void</b> <a id="0cbb010c0cfe8e3c" href="../../R/0cbb010c0cfe8e3c.html" target="n" data-glyph="76,1" class="i method">EnterScope</a>()
        {
            <a href="#68dec21f3eafb4a8" class="i field">_commandRuntime</a>.<a href="../MshCommandRuntime.cs.html#4ddec4b42d084335" class="i method">SetVariableListsInPipe</a>();
        }
 
        <b>private void</b> <a id="28307c8db23c527a" href="../../R/28307c8db23c527a.html" target="n" data-glyph="76,1" class="i method">ExitScope</a>()
        {
            <a href="#68dec21f3eafb4a8" class="i field">_commandRuntime</a>.<a href="../MshCommandRuntime.cs.html#d4d5bbd4ef2bc541" class="i method">RemoveVariableListsInPipe</a>();
        }
 
        <b>private void</b> <a id="4a7acc69073bb734" href="../../R/4a7acc69073bb734.html" target="n" data-glyph="76,1" class="i method">RunClause</a>(<span class="i">Action</span>&lt;<a href="../parser/Compiler.cs.html#aa4ec5dd36f7e2eb" class="t t">FunctionContext</a>&gt; <span id="r241 rd" class="r241 r">clause</span>, <b>object</b> <span id="r242 rd" class="r242 r">dollarUnderbar</span>, <b>object</b> <span id="r243 rd" class="r243 r">inputToProcess</span>)
        {
            <a href="../Pipe.cs.html#59f1a03e60a5aa51" class="t t">Pipe</a> <span id="r244 rd" class="r244 r">oldErrorOutputPipe</span> = <a href="#20151031a0be3c24" class="k">this</a>.<a href="../CommandBase.cs.html#a41a765d70fc9c9d" class="i property">Context</a>.<a href="../ExecutionContext.cs.html#d0ed5d60dd57b004" class="i property">ShellFunctionErrorOutputPipe</a>;
 
            <span class="c">// If the script block has a different language mode than the current,</span>
            <span class="c">// change the language mode.</span>
            <a href="../SessionStatePublic.cs.html#450052824aba2e3f" class="t t">PSLanguageMode</a>? <span id="r245 rd" class="r245 r">oldLanguageMode</span> = <b>null</b>;
            <a href="../SessionStatePublic.cs.html#450052824aba2e3f" class="t t">PSLanguageMode</a>? <span id="r246 rd" class="r246 r">newLanguageMode</span> = <b>null</b>;
            <b>if</b> (<a href="#38a16315e09e6dac" class="i field">_scriptBlock</a>.<a href="../lang/scriptblock.cs.html#5e76a9fb0d1a7f12" class="i property">LanguageMode</a>.<span class="i">HasValue</span>
                &amp;&amp; <a href="#38a16315e09e6dac" class="i field">_scriptBlock</a>.<a href="../lang/scriptblock.cs.html#5e76a9fb0d1a7f12" class="i property">LanguageMode</a> != <a href="../CommandBase.cs.html#a41a765d70fc9c9d" class="i property">Context</a>.<a href="../ExecutionContext.cs.html#ebe55e376f6c32fa" class="i property">LanguageMode</a>)
            {
                <span class="r245 r">oldLanguageMode</span> = <a href="../CommandBase.cs.html#a41a765d70fc9c9d" class="i property">Context</a>.<a href="../ExecutionContext.cs.html#ebe55e376f6c32fa" class="i property">LanguageMode</a>;
                <span class="r246 r">newLanguageMode</span> = <a href="#38a16315e09e6dac" class="i field">_scriptBlock</a>.<a href="../lang/scriptblock.cs.html#5e76a9fb0d1a7f12" class="i property">LanguageMode</a>;
            }
 
            <b>try</b>
            {
                <b>try</b>
                {
                    <a href="#0cbb010c0cfe8e3c" class="i method">EnterScope</a>();
 
                    <b>if</b> (<a href="#68dec21f3eafb4a8" class="i field">_commandRuntime</a>.<a href="../MshCommandRuntime.cs.html#ed59e3b00feab7b1" class="i property">ErrorMergeTo</a> == <a href="../MshCommandRuntime.cs.html#f9ebe6a3b284ab55" class="t t">MshCommandRuntime</a>.<a href="../MshCommandRuntime.cs.html#8b0e9f05387e62ca" class="t t">MergeDataStream</a>.<a href="../MshCommandRuntime.cs.html#8ab59ea31f703b82" class="i field">Output</a>)
                    {
                        <a href="../CommandBase.cs.html#a41a765d70fc9c9d" class="i property">Context</a>.<a href="../ExecutionContext.cs.html#ae9b57da47a77bc5" class="i method">RedirectErrorPipe</a>(<a href="#68dec21f3eafb4a8" class="i field">_commandRuntime</a>.<a href="../MshCommandRuntime.cs.html#b24610eb88ee27e9" class="i property">OutputPipe</a>);
                    }
                    <b>else</b> <b>if</b> (<a href="#68dec21f3eafb4a8" class="i field">_commandRuntime</a>.<a href="../MshCommandRuntime.cs.html#8cfabd8908a77f92" class="i property">ErrorOutputPipe</a>.<a href="../Pipe.cs.html#f890f797fcc0ee94" class="i property">IsRedirected</a>)
                    {
                        <a href="../CommandBase.cs.html#a41a765d70fc9c9d" class="i property">Context</a>.<a href="../ExecutionContext.cs.html#ae9b57da47a77bc5" class="i method">RedirectErrorPipe</a>(<a href="#68dec21f3eafb4a8" class="i field">_commandRuntime</a>.<a href="../MshCommandRuntime.cs.html#8cfabd8908a77f92" class="i property">ErrorOutputPipe</a>);
                    }
 
                    <b>if</b> (<span class="r242 r">dollarUnderbar</span> != <a href="../AutomationNull.cs.html#681fbea4c40e4af1" class="t t">AutomationNull</a>.<a href="../AutomationNull.cs.html#1cf7e193da582896" class="i property">Value</a>)
                    {
                        <a href="#a9a5e07b3f71abe5" class="i field">_localsTuple</a>.<a href="MutableTuple.cs.html#b596dd33aa0e3dbc" class="i method">SetAutomaticVariable</a>(<a href="../SpecialVariables.cs.html#1c6f2efd91287b59" class="t t">AutomaticVariable</a>.<a href="../SpecialVariables.cs.html#3599fdc9d261201f" class="i field">Underbar</a>, <span class="r242 r">dollarUnderbar</span>, <a href="../CommandBase.cs.html#a41a765d70fc9c9d" class="i property">Context</a>);
                    }
 
                    <b>if</b> (<span class="r243 r">inputToProcess</span> != <a href="../AutomationNull.cs.html#681fbea4c40e4af1" class="t t">AutomationNull</a>.<a href="../AutomationNull.cs.html#1cf7e193da582896" class="i property">Value</a>)
                    {
                        <a href="#a9a5e07b3f71abe5" class="i field">_localsTuple</a>.<a href="MutableTuple.cs.html#b596dd33aa0e3dbc" class="i method">SetAutomaticVariable</a>(<a href="../SpecialVariables.cs.html#1c6f2efd91287b59" class="t t">AutomaticVariable</a>.<a href="../SpecialVariables.cs.html#52526bd30f8a492b" class="i field">Input</a>, <span class="r243 r">inputToProcess</span>, <a href="../CommandBase.cs.html#a41a765d70fc9c9d" class="i property">Context</a>);
                    }
 
                    <span class="c">// Set the language mode</span>
                    <b>if</b> (<span class="r246 r">newLanguageMode</span>.<span class="i">HasValue</span>)
                    {
                        <a href="../CommandBase.cs.html#a41a765d70fc9c9d" class="i property">Context</a>.<a href="../ExecutionContext.cs.html#ebe55e376f6c32fa" class="i property">LanguageMode</a> = <span class="r246 r">newLanguageMode</span>.<span class="i">Value</span>;
                    }
 
                    <span class="r241 r">clause</span>(<a href="#c71c6db8ad1c332e" class="i field">_functionContext</a>);
                }
                <b>catch</b> (<span class="i">TargetInvocationException</span> <span id="r247 rd" class="r247 r">tie</span>)
                {
                    <span class="c">// DynamicInvoke wraps exceptions, unwrap them here.</span>
                    <b>throw</b> <span class="r247 r">tie</span>.<span class="i">InnerException</span>;
                }
                <b>finally</b>
                {
                    <a href="#20151031a0be3c24" class="k">this</a>.<a href="../CommandBase.cs.html#a41a765d70fc9c9d" class="i property">Context</a>.<a href="../ExecutionContext.cs.html#3b12142fb72b35b3" class="i method">RestoreErrorPipe</a>(<span class="r244 r">oldErrorOutputPipe</span>);
 
                    <span class="c">// Set the language mode</span>
                    <b>if</b> (<span class="r245 r">oldLanguageMode</span>.<span class="i">HasValue</span>)
                    {
                        <a href="../CommandBase.cs.html#a41a765d70fc9c9d" class="i property">Context</a>.<a href="../ExecutionContext.cs.html#ebe55e376f6c32fa" class="i property">LanguageMode</a> = <span class="r245 r">oldLanguageMode</span>.<span class="i">Value</span>;
                    }
 
                    <a href="#28307c8db23c527a" class="i method">ExitScope</a>();
                }
            }
            <b>catch</b> (<a href="../lang/parserutils.cs.html#79de2587ceb4dc25" class="t t">ExitException</a> <span id="r248 rd" class="r248 r">ee</span>)
            {
                <b>if</b> (!<a href="#cdf8568cb736993b" class="i field">_fromScriptFile</a> || <a href="#59e19debab345a7b" class="i field">_rethrowExitException</a>)
                {
                    <b>throw</b>;
                }
 
                <a href="#069f9d3d7d0ece5d" class="i field">_exitWasCalled</a> = <b>true</b>;
 
                <b>int</b> <span id="r249 rd" class="r249 r">exitCode</span> = (<b>int</b>)<span class="r248 r">ee</span>.<a href="../lang/parserutils.cs.html#d1b0e4525b48e0c9" class="i property">Argument</a>;
                <a href="#20151031a0be3c24" class="k">this</a>.<a href="../CommandBase.cs.html#a41a765d70fc9c9d" class="i property">Context</a>.<a href="../ExecutionContext.cs.html#fa7f7322f772be22" class="i method">SetVariable</a>(<a href="../SpecialVariables.cs.html#07948374b47849e8" class="t t">SpecialVariables</a>.<a href="../SpecialVariables.cs.html#fe9ae54e56fef582" class="i field">LastExitCodeVarPath</a>, <span class="r249 r">exitCode</span>);
 
                <b>if</b> (<span class="r249 r">exitCode</span> != 0)
                {
                    <a href="#68dec21f3eafb4a8" class="i field">_commandRuntime</a>.<a href="../MshCommandRuntime.cs.html#895cb9f77d1d9539" class="i property">PipelineProcessor</a>.<a href="../pipeline.cs.html#813a2622f5f1116c" class="i property">ExecutionFailed</a> = <b>true</b>;
                }
            }
        }
 
        <b>public object</b> <a id="0a1873755921a3fc" href="../../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">GetDynamicParameters</a>()
        {
            <a href="#68dec21f3eafb4a8" class="i field">_commandRuntime</a> = (<a href="../MshCommandRuntime.cs.html#f9ebe6a3b284ab55" class="t t">MshCommandRuntime</a>)<a href="../CommandBase.cs.html#71eb09c6dd471a86" class="i field">commandRuntime</a>;
 
            <b>if</b> (<a href="#38a16315e09e6dac" class="i field">_scriptBlock</a>.<a href="#1e6d0becba712301" class="i property">HasDynamicParameters</a>)
            {
                <b>var</b> <span id="r250 rd" class="r250 r">resultList</span> = <b>new</b> <span class="i">List</span>&lt;<b>object</b>&gt;();
                <a href="../../utils/assert.cs.html#c04955255430d32f" class="t t">Diagnostics</a>.<a href="../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<a href="#c71c6db8ad1c332e" class="i field">_functionContext</a>.<a href="../parser/Compiler.cs.html#6c44d518392049f0" class="i field">_outputPipe</a> == <b>null</b>, <span class="s">&quot;Output pipe should not be set yet.&quot;</span>);
                <a href="#c71c6db8ad1c332e" class="i field">_functionContext</a>.<a href="../parser/Compiler.cs.html#6c44d518392049f0" class="i field">_outputPipe</a> = <b>new</b> <a href="../Pipe.cs.html#99288ee09b9642bb" class="t constructor">Pipe</a>(<span class="r250 r">resultList</span>);
                <a href="#4a7acc69073bb734" class="i method">RunClause</a>(
                    <span class="r241 r">clause</span>: <a href="#4fb348c75e1e71ab" class="i field">_runOptimized</a> ? <a href="#38a16315e09e6dac" class="i field">_scriptBlock</a>.<a href="#392285d852716b6e" class="i property">DynamicParamBlock</a> : <a href="#38a16315e09e6dac" class="i field">_scriptBlock</a>.<a href="#14cb97c0057ead9e" class="i property">UnoptimizedDynamicParamBlock</a>,
                    <span class="r242 r">dollarUnderbar</span>: <a href="../AutomationNull.cs.html#681fbea4c40e4af1" class="t t">AutomationNull</a>.<a href="../AutomationNull.cs.html#1cf7e193da582896" class="i property">Value</a>,
                    <span class="r243 r">inputToProcess</span>: <a href="../AutomationNull.cs.html#681fbea4c40e4af1" class="t t">AutomationNull</a>.<a href="../AutomationNull.cs.html#1cf7e193da582896" class="i property">Value</a>);
                <b>if</b> (<span class="r250 r">resultList</span>.<span class="i">Count</span> &gt; 1)
                {
                    <b>throw</b> <a href="../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<span class="i">NewInvalidOperationException</span>(
                        <span class="i">AutomationExceptions</span>.<span class="i">DynamicParametersWrongType</span>,
                        <a href="../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>.<span class="i">ToStringParser</span>(<a href="#20151031a0be3c24" class="k">this</a>.<a href="../CommandBase.cs.html#a41a765d70fc9c9d" class="i property">Context</a>, <span class="r250 r">resultList</span>));
                }
 
                <b>return</b> <span class="r250 r">resultList</span>.<span class="i">Count</span> == 0 ? <b>null</b> : <a href="../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>.<span class="i">Base</span>(<span class="r250 r">resultList</span>[0]);
            }
 
            <b>return</b> <b>null</b>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If the script cmdlet will run in a new local scope, this method is used to set the locals to the newly created scope.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="af9ddb8354e829ba" href="../../R/af9ddb8354e829ba.html" target="n" data-glyph="74,1" class="i method">SetLocalsTupleForNewScope</a>(<a href="../SessionStateScope.cs.html#460261155e0163cb" class="t t">SessionStateScope</a> <span id="r251 rd" class="r251 r">scope</span>)
        {
            <a href="../../utils/assert.cs.html#c04955255430d32f" class="t t">Diagnostics</a>.<a href="../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r251 r">scope</span>.<a href="../SessionStateScope.cs.html#d10101bbc5961e39" class="i property">LocalsTuple</a> == <b>null</b>, <span class="s">&quot;a newly created scope shouldn&#39;t have it&#39;s tuple set.&quot;</span>);
            <span class="r251 r">scope</span>.<a href="../SessionStateScope.cs.html#d10101bbc5961e39" class="i property">LocalsTuple</a> = <a href="#a9a5e07b3f71abe5" class="i field">_localsTuple</a>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If the script cmdlet is dotted, this method is used to push the locals to the &#39;DottedScopes&#39; of the current scope.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="7982039716d37469" href="../../R/7982039716d37469.html" target="n" data-glyph="74,1" class="i method">PushDottedScope</a>(<a href="../SessionStateScope.cs.html#460261155e0163cb" class="t t">SessionStateScope</a> <span id="r252 rd" class="r252 r">scope</span>) =&gt; <span class="r252 r">scope</span>.<a href="../SessionStateScope.cs.html#240090c569665c17" class="i property">DottedScopes</a>.<span class="i">Push</span>(<a href="#a9a5e07b3f71abe5" class="i field">_localsTuple</a>);
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If the script cmdlet is dotted, this method is used to pop the locals from the &#39;DottedScopes&#39; of the current scope.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="af0f5bc8bc0963a9" href="../../R/af0f5bc8bc0963a9.html" target="n" data-glyph="74,1" class="i method">PopDottedScope</a>(<a href="../SessionStateScope.cs.html#460261155e0163cb" class="t t">SessionStateScope</a> <span id="r253 rd" class="r253 r">scope</span>) =&gt; <span class="r253 r">scope</span>.<a href="../SessionStateScope.cs.html#240090c569665c17" class="i property">DottedScopes</a>.<span class="i">Pop</span>();
 
        <b>internal void</b> <a id="2d00234eb70e2d45" href="../../R/2d00234eb70e2d45.html" target="n" data-glyph="74,1" class="i method">PrepareForBinding</a>(<a href="../ParameterBinderBase.cs.html#efc1e794ccda0552" class="t t">CommandLineParameters</a> <span id="r254 rd" class="r254 r">commandLineParameters</span>)
        {
            <a href="#a9a5e07b3f71abe5" class="i field">_localsTuple</a>.<a href="MutableTuple.cs.html#b596dd33aa0e3dbc" class="i method">SetAutomaticVariable</a>(
                <a href="../SpecialVariables.cs.html#1c6f2efd91287b59" class="t t">AutomaticVariable</a>.<a href="../SpecialVariables.cs.html#93a934b8cba4991e" class="i field">PSBoundParameters</a>,
                <span class="r255 r">value</span>: <span class="r254 r">commandLineParameters</span>.<a href="../ParameterBinderBase.cs.html#a424a7a35309dc44" class="i method">GetValueToBindToPSBoundParameters</a>(),
                <a href="#20151031a0be3c24" class="k">this</a>.<a href="../CommandBase.cs.html#a41a765d70fc9c9d" class="i property">Context</a>);
            <a href="#a9a5e07b3f71abe5" class="i field">_localsTuple</a>.<a href="MutableTuple.cs.html#b596dd33aa0e3dbc" class="i method">SetAutomaticVariable</a>(<a href="../SpecialVariables.cs.html#1c6f2efd91287b59" class="t t">AutomaticVariable</a>.<a href="../SpecialVariables.cs.html#80b3b66ce97fc2c9" class="i field">MyInvocation</a>, <span class="r255 r">value</span>: <a href="../MshCmdlet.cs.html#92387ec2f33e4d8f" class="i property">MyInvocation</a>, <a href="#20151031a0be3c24" class="k">this</a>.<a href="../CommandBase.cs.html#a41a765d70fc9c9d" class="i property">Context</a>);
        }
 
        <b>private void</b> <a id="2fa542e5974eebfe" href="../../R/2fa542e5974eebfe.html" target="n" data-glyph="76,1" class="i method">SetPreferenceVariables</a>()
        {
            <b>if</b> (<a href="#68dec21f3eafb4a8" class="i field">_commandRuntime</a>.<a href="../MshCommandRuntime.cs.html#282d7ae011f39952" class="i property">IsDebugFlagSet</a>)
            {
                <a href="#a9a5e07b3f71abe5" class="i field">_localsTuple</a>.<span class="i">SetPreferenceVariable</span>(
                    <a href="../SpecialVariables.cs.html#6d6769bb9fbd45f2" class="t t">PreferenceVariable</a>.<a href="../SpecialVariables.cs.html#130c99476baaae6e" class="i field">Debug</a>,
                    <a href="#68dec21f3eafb4a8" class="i field">_commandRuntime</a>.<a href="../MshCommandRuntime.cs.html#9af4a240e58b55ef" class="i property">Debug</a> ? <a href="../CommandBase.cs.html#18f88a0529e26331" class="t t">ActionPreference</a>.<a href="../CommandBase.cs.html#0d6a3114b77f011d" class="i field">Continue</a> : <a href="../CommandBase.cs.html#18f88a0529e26331" class="t t">ActionPreference</a>.<a href="../CommandBase.cs.html#e5c6f06e809b81d8" class="i field">SilentlyContinue</a>);
            }
 
            <b>if</b> (<a href="#68dec21f3eafb4a8" class="i field">_commandRuntime</a>.<a href="../MshCommandRuntime.cs.html#1e78c373b00f9e54" class="i property">IsVerboseFlagSet</a>)
            {
                <a href="#a9a5e07b3f71abe5" class="i field">_localsTuple</a>.<span class="i">SetPreferenceVariable</span>(
                    <a href="../SpecialVariables.cs.html#6d6769bb9fbd45f2" class="t t">PreferenceVariable</a>.<a href="../SpecialVariables.cs.html#b99e61827efa1c3f" class="i field">Verbose</a>,
                    <a href="#68dec21f3eafb4a8" class="i field">_commandRuntime</a>.<a href="../MshCommandRuntime.cs.html#e4eb8be94a708a06" class="i property">Verbose</a> ? <a href="../CommandBase.cs.html#18f88a0529e26331" class="t t">ActionPreference</a>.<a href="../CommandBase.cs.html#0d6a3114b77f011d" class="i field">Continue</a> : <a href="../CommandBase.cs.html#18f88a0529e26331" class="t t">ActionPreference</a>.<a href="../CommandBase.cs.html#e5c6f06e809b81d8" class="i field">SilentlyContinue</a>);
            }
 
            <b>if</b> (<a href="#68dec21f3eafb4a8" class="i field">_commandRuntime</a>.<a href="../MshCommandRuntime.cs.html#4e39bf0444feb43b" class="i property">IsErrorActionSet</a>)
            {
                <a href="#a9a5e07b3f71abe5" class="i field">_localsTuple</a>.<span class="i">SetPreferenceVariable</span>(<a href="../SpecialVariables.cs.html#6d6769bb9fbd45f2" class="t t">PreferenceVariable</a>.<a href="../SpecialVariables.cs.html#163c289f3e89a2d7" class="i field">Error</a>, <a href="#68dec21f3eafb4a8" class="i field">_commandRuntime</a>.<a href="../MshCommandRuntime.cs.html#0135181adbe24516" class="i property">ErrorAction</a>);
            }
 
            <b>if</b> (<a href="#68dec21f3eafb4a8" class="i field">_commandRuntime</a>.<a href="../MshCommandRuntime.cs.html#341d7d562b4842c8" class="i property">IsWarningActionSet</a>)
            {
                <a href="#a9a5e07b3f71abe5" class="i field">_localsTuple</a>.<span class="i">SetPreferenceVariable</span>(<a href="../SpecialVariables.cs.html#6d6769bb9fbd45f2" class="t t">PreferenceVariable</a>.<a href="../SpecialVariables.cs.html#7e88cd85a313588d" class="i field">Warning</a>, <a href="#68dec21f3eafb4a8" class="i field">_commandRuntime</a>.<a href="../MshCommandRuntime.cs.html#b12b6c5f70c4f2b1" class="i property">WarningPreference</a>);
            }
 
            <b>if</b> (<a href="#68dec21f3eafb4a8" class="i field">_commandRuntime</a>.<a href="../MshCommandRuntime.cs.html#c4e3634c2911287d" class="i property">IsInformationActionSet</a>)
            {
                <a href="#a9a5e07b3f71abe5" class="i field">_localsTuple</a>.<span class="i">SetPreferenceVariable</span>(<a href="../SpecialVariables.cs.html#6d6769bb9fbd45f2" class="t t">PreferenceVariable</a>.<a href="../SpecialVariables.cs.html#9fe1a10098470346" class="i field">Information</a>, <a href="#68dec21f3eafb4a8" class="i field">_commandRuntime</a>.<a href="../MshCommandRuntime.cs.html#8157d9c42d054f98" class="i property">InformationPreference</a>);
            }
 
            <b>if</b> (<a href="#68dec21f3eafb4a8" class="i field">_commandRuntime</a>.<a href="../MshCommandRuntime.cs.html#69835be1216947c1" class="i property">IsWhatIfFlagSet</a>)
            {
                <a href="#a9a5e07b3f71abe5" class="i field">_localsTuple</a>.<span class="i">SetPreferenceVariable</span>(<a href="../SpecialVariables.cs.html#6d6769bb9fbd45f2" class="t t">PreferenceVariable</a>.<a href="../SpecialVariables.cs.html#147a9792f93a8de4" class="i field">WhatIf</a>, <a href="#68dec21f3eafb4a8" class="i field">_commandRuntime</a>.<a href="../MshCommandRuntime.cs.html#bbd763fc28e57d9a" class="i property">WhatIf</a>);
            }
 
            <b>if</b> (<a href="#68dec21f3eafb4a8" class="i field">_commandRuntime</a>.<a href="../MshCommandRuntime.cs.html#e98e9c7743290b43" class="i property">IsConfirmFlagSet</a>)
            {
                <a href="#a9a5e07b3f71abe5" class="i field">_localsTuple</a>.<span class="i">SetPreferenceVariable</span>(
                    <a href="../SpecialVariables.cs.html#6d6769bb9fbd45f2" class="t t">PreferenceVariable</a>.<a href="../SpecialVariables.cs.html#cb61dc2e7ac4e724" class="i field">Confirm</a>,
                    <a href="#68dec21f3eafb4a8" class="i field">_commandRuntime</a>.<a href="../MshCommandRuntime.cs.html#80b115f7d2831129" class="i property">Confirm</a> ? <a href="../CommandBase.cs.html#ba94675b57c6d6e9" class="t t">ConfirmImpact</a>.<a href="../CommandBase.cs.html#9bb946a0731a8a9e" class="i field">Low</a> : <a href="../CommandBase.cs.html#ba94675b57c6d6e9" class="t t">ConfirmImpact</a>.<a href="../CommandBase.cs.html#5b2b0bf78675f285" class="i field">None</a>);
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> StopProcessing functionality for script cmdlets
 
        <b>internal event</b> <span class="i">EventHandler</span> <a id="81ae81369d4c49a5" href="../../R/81ae81369d4c49a5.html" target="n" data-glyph="32,1" class="i">StoppingEvent</a>;
 
        <b>protected override void</b> <a id="0702c8458dd51c04" href="../../R/0702c8458dd51c04.html" target="n" data-glyph="75,1" class="i method">StopProcessing</a>()
        {
            <a href="#20151031a0be3c24" class="k">this</a>.<a href="#81ae81369d4c49a5" class="i">StoppingEvent</a>.<span class="i">SafeInvoke</span>(<a href="#20151031a0be3c24" class="k">this</a>, <span class="i">EventArgs</span>.<span class="i">Empty</span>);
            <a href="../../P/30543a6971fed1fc.html#30543a6971fed1fc" class="k">base</a>.<a href="../cmdlet.cs.html#ed29eac69e2abf69" class="i method">StopProcessing</a>();
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> IDispose
 
        <b>private bool</b> <a id="0dbbb90dba94a0b0" href="../../R/0dbbb90dba94a0b0.html" target="n" data-glyph="46,1" class="i field">_disposed</a>;
 
        <b>internal event</b> <span class="i">EventHandler</span> <a id="9d180a7243d4cc62" href="../../R/9d180a7243d4cc62.html" target="n" data-glyph="32,1" class="i">DisposingEvent</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> IDisposable implementation</span>
        <span class="c">///</span><span class="c"> When the command is complete, release the associated scope</span>
        <span class="c">///</span><span class="c"> and other members.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public void</b> <a id="39f2cef5afda4d95" href="../../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">Dispose</a>()
        {
            <b>if</b> (<a href="#0dbbb90dba94a0b0" class="i field">_disposed</a>)
            {
                <b>return</b>;
            }
 
            <a href="#20151031a0be3c24" class="k">this</a>.<a href="#9d180a7243d4cc62" class="i">DisposingEvent</a>.<span class="i">SafeInvoke</span>(<a href="#20151031a0be3c24" class="k">this</a>, <span class="i">EventArgs</span>.<span class="i">Empty</span>);
            <a href="../CommandBase.cs.html#71eb09c6dd471a86" class="i field">commandRuntime</a> = <b>null</b>;
            <a href="../CommandBase.cs.html#3346a8d14bcaa14c" class="i field">currentObjectInPipeline</a> = <b>null</b>;
            <a href="#7633ed3f604753f3" class="i field">_input</a>.<span class="i">Clear</span>();
            <span class="c">// _scriptBlock = null;</span>
            <span class="c">// _localsTuple = null;</span>
            <span class="c">// _functionContext = null;</span>
 
            <a href="../../P/30543a6971fed1fc.html#30543a6971fed1fc" class="k">base</a>.<a href="../CommandBase.cs.html#71e0ac0f2936b71c" class="i method">InternalDispose</a>(<b>true</b>);
            <a href="#0dbbb90dba94a0b0" class="i field">_disposed</a> = <b>true</b>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> IDispose
    }
}
</pre></td></tr></table></div></body></html>
