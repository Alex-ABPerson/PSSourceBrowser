<!DOCTYPE html>
<html><head><title>CommandCompletion.cs</title><link rel="stylesheet" href="../../../styles.css"><script src="../../../scripts.js"></script></head>
<body class="cB" onload="i(1326);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#System.Management.Automation/engine/CommandCompletion/CommandCompletion.cs" target="_top">engine\CommandCompletion\CommandCompletion.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#System.Management.Automation" target="_top">src\System.Management.Automation\System.Management.Automation.csproj</a> (System.Management.Automation)</td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation.</span>
<span class="c">// Licensed under the MIT License.</span>
 
<b>using</b> <span class="i n">System</span>.<span class="i">Collections</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Collections</span>.<span class="i">Generic</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Collections</span>.<span class="i">ObjectModel</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Diagnostics</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Diagnostics</span>.<span class="i">CodeAnalysis</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Globalization</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Language</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Runspaces</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Text</span>.<span class="i">RegularExpressions</span>;
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">LEGACYTELEMETRY</span>
<span class="e">using Microsoft.PowerShell.Telemetry.Internal;
</span><span class="k preprocess">#</span><span class="k preprocess">endif</span>
 
<b>namespace</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>
{
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Provides a set of possible completions for given input.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>public class</b> <a id="a9d35cade4030f50" href="../../R/a9d35cade4030f50.html" target="n" data-glyph="0,0" class="t t">CommandCompletion</a>
    {
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Construct the result CompleteInput or TabExpansion2.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public</b> <a id="5326ccdefb90b656" href="../../R/5326ccdefb90b656.html" target="n" data-glyph="72,1" class="t constructor">CommandCompletion</a>(<span class="i">Collection</span>&lt;<a href="CompletionResult.cs.html#a4c553f80d9e648c" class="t t">CompletionResult</a>&gt; <span id="r0 rd" class="r0 r">matches</span>, <b>int</b> <span id="r1 rd" class="r1 r">currentMatchIndex</span>, <b>int</b> <span id="r2 rd" class="r2 r">replacementIndex</span>, <b>int</b> <span id="r3 rd" class="r3 r">replacementLength</span>)
        {
            <a href="#a9d35cade4030f50" class="k">this</a>.<a href="#fd7d52da3aade7dd" class="i property">CompletionMatches</a> = <span class="r0 r">matches</span>;
            <a href="#a9d35cade4030f50" class="k">this</a>.<a href="#7e09838758131c09" class="i property">CurrentMatchIndex</a> = <span class="r1 r">currentMatchIndex</span>;
            <a href="#a9d35cade4030f50" class="k">this</a>.<a href="#f76230ac471e920e" class="i property">ReplacementIndex</a> = <span class="r2 r">replacementIndex</span>;
            <a href="#a9d35cade4030f50" class="k">this</a>.<a href="#dbba368a0f352ed6" class="i property">ReplacementLength</a> = <span class="r3 r">replacementLength</span>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Fields and Properties
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Current index in </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="#fd7d52da3aade7dd" class="i property">CompletionMatches</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c">.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public int</b> <a id="7e09838758131c09" href="../../R/7e09838758131c09.html" target="n" data-glyph="102,1" class="i property">CurrentMatchIndex</a> { <b>get</b>; <b>set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Returns the starting replacement index from the original input.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public int</b> <a id="f76230ac471e920e" href="../../R/f76230ac471e920e.html" target="n" data-glyph="102,1" class="i property">ReplacementIndex</a> { <b>get</b>; <b>set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Returns the length of the text to replace from the original input.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public int</b> <a id="dbba368a0f352ed6" href="../../R/dbba368a0f352ed6.html" target="n" data-glyph="102,1" class="i property">ReplacementLength</a> { <b>get</b>; <b>set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets all the completion results.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Usage&quot;</span>, <span class="s">&quot;CA2227:CollectionPropertiesShouldBeReadOnly&quot;</span>)]
        <b>public</b> <span class="i">Collection</span>&lt;<a href="CompletionResult.cs.html#a4c553f80d9e648c" class="t t">CompletionResult</a>&gt; <a id="fd7d52da3aade7dd" href="../../R/fd7d52da3aade7dd.html" target="n" data-glyph="102,1" class="i property">CompletionMatches</a> { <b>get</b>; <b>set</b>; }
 
        <b>internal static readonly</b> <span class="i">IList</span>&lt;<a href="CompletionResult.cs.html#a4c553f80d9e648c" class="t t">CompletionResult</a>&gt; <a id="13ad720861798479" href="../../R/13ad720861798479.html" target="n" data-glyph="44,1" class="i field">EmptyCompletionResult</a> = <span class="i">Array</span>.<span class="i">Empty</span>&lt;<a href="CompletionResult.cs.html#a4c553f80d9e648c" class="t t">CompletionResult</a>&gt;();
 
        <b>private static readonly</b> <a href="#a9d35cade4030f50" class="t t">CommandCompletion</a> <a id="afb38c659d6775e0" href="../../R/afb38c659d6775e0.html" target="n" data-glyph="46,1" class="i field">s_emptyCommandCompletion</a> = <b>new</b> <span class="t">CommandCompletion</span>(
            <b>new</b> <span class="i">Collection</span>&lt;<a href="CompletionResult.cs.html#a4c553f80d9e648c" class="t t">CompletionResult</a>&gt;(<a href="#13ad720861798479" class="i field">EmptyCompletionResult</a>), -1, -1, -1);
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Fields and Properties
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> public methods
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r4 r">input</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r5 r">cursorIndex</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public static</b> <span class="i">Tuple</span>&lt;<a href="../parser/ast.cs.html#d47621d83efd14de" class="t t">Ast</a>, <a href="../parser/token.cs.html#ec5d9ac6a36d920c" class="t t">Token</a>[], <a href="../parser/Position.cs.html#fb2ad3feb9004d98" class="t t">IScriptPosition</a>&gt; <a id="0cf2e80464e3e96d" href="../../R/0cf2e80464e3e96d.html" target="n" data-glyph="72,1" class="i method">MapStringInputToParsedInput</a>(<b>string</b> <span id="r4 rd" class="r4 r">input</span>, <b>int</b> <span id="r5 rd" class="r5 r">cursorIndex</span>)
        {
            <b>if</b> (<span class="r5 r">cursorIndex</span> &gt; <span class="r4 r">input</span>.<span class="i">Length</span>)
            {
                <b>throw</b> <a href="../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../../utils/MshTraceSource.cs.html#fed5f40dc0075d41" class="i method">NewArgumentException</a>(<b>nameof</b>(<span class="r5 r">cursorIndex</span>));
            }
 
            <a href="../parser/token.cs.html#ec5d9ac6a36d920c" class="t t">Token</a>[] <span id="r6 rd" class="r6 r">tokens</span>;
            <a href="../parser/Parser.cs.html#3b2ee49e322daa35" class="t t">ParseError</a>[] <span id="r7 rd" class="r7 r">errors</span>;
            <a href="../parser/ast.cs.html#6f963589327835a4" class="k">var</a> <span id="r8 rd" class="r8 r">ast</span> = <a href="../parser/Parser.cs.html#bbf5e856fb3215c5" class="t t">Parser</a>.<a href="../parser/Parser.cs.html#8c264bb718ff180a" class="i method">ParseInput</a>(<span class="r4 r">input</span>, <b>out</b> <span class="r6 r">tokens</span>, <b>out</b> <span class="r7 r">errors</span>);
 
            <a href="../parser/Position.cs.html#fb2ad3feb9004d98" class="t t">IScriptPosition</a> <span id="r9 rd" class="r9 r">cursorPosition</span> =
                ((<a href="../parser/Position.cs.html#ded1553e3f2b51f3" class="t t">InternalScriptPosition</a>)<span class="r8 r">ast</span>.<a href="../parser/ast.cs.html#d9d5cd324ee61136" class="i property">Extent</a>.<a href="../parser/Position.cs.html#88220ab61fd15a4b" class="i property">StartScriptPosition</a>).<a href="../parser/Position.cs.html#5e4a9fe01b81c852" class="i method">CloneWithNewOffset</a>(<span class="r5 r">cursorIndex</span>);
            <b>return</b> <span class="i">Tuple</span>.<span class="i">Create</span>&lt;<a href="../parser/ast.cs.html#d47621d83efd14de" class="t t">Ast</a>, <a href="../parser/token.cs.html#ec5d9ac6a36d920c" class="t t">Token</a>[], <a href="../parser/Position.cs.html#fb2ad3feb9004d98" class="t t">IScriptPosition</a>&gt;(<span class="r8 r">ast</span>, <span class="r6 r">tokens</span>, <span class="r9 r">cursorPosition</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r10 r">input</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The input to complete.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r11 r">cursorIndex</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The index of the cursor in the input.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r12 r">options</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Optional options to configure how completion is performed.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public static</b> <a href="#a9d35cade4030f50" class="t t">CommandCompletion</a> <a id="d1c41e283bfc01a1" href="../../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">CompleteInput</a>(<b>string</b> <span id="r10 rd" class="r10 r">input</span>, <b>int</b> <span id="r11 rd" class="r11 r">cursorIndex</span>, <span class="i">Hashtable</span> <span id="r12 rd" class="r12 r">options</span>)
        {
            <b>if</b> (<span class="r10 r">input</span> == <b>null</b>)
            {
                <b>return</b> <a href="#afb38c659d6775e0" class="i field">s_emptyCommandCompletion</a>;
            }
 
            <b>var</b> <span id="r13 rd" class="r13 r">parsedInput</span> = <a href="#0cf2e80464e3e96d" class="i method">MapStringInputToParsedInput</a>(<span class="r10 r">input</span>, <span class="r11 r">cursorIndex</span>);
            <b>return</b> <span class="i">CompleteInputImpl</span>(<span class="r13 r">parsedInput</span>.<span class="i">Item1</span>, <span class="r13 r">parsedInput</span>.<span class="i">Item2</span>, <span class="r13 r">parsedInput</span>.<span class="i">Item3</span>, <span class="r12 r">options</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r14 r">ast</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Ast for pre-parsed input.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r15 r">tokens</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Tokens for pre-parsed input.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r16 r">positionOfCursor</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r17 r">options</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Optional options to configure how completion is performed.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public static</b> <a href="#a9d35cade4030f50" class="t t">CommandCompletion</a> <a id="65cd8f0b4e18bf69" href="../../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">CompleteInput</a>(<a href="../parser/ast.cs.html#d47621d83efd14de" class="t t">Ast</a> <span id="r14 rd" class="r14 r">ast</span>, <a href="../parser/token.cs.html#ec5d9ac6a36d920c" class="t t">Token</a>[] <span id="r15 rd" class="r15 r">tokens</span>, <a href="../parser/Position.cs.html#fb2ad3feb9004d98" class="t t">IScriptPosition</a> <span id="r16 rd" class="r16 r">positionOfCursor</span>, <span class="i">Hashtable</span> <span id="r17 rd" class="r17 r">options</span>)
        {
            <b>if</b> (<span class="r14 r">ast</span> == <b>null</b>)
            {
                <b>throw</b> <a href="../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../../utils/MshTraceSource.cs.html#fbe67220ad7522a0" class="i method">NewArgumentNullException</a>(<b>nameof</b>(<span class="r14 r">ast</span>));
            }
 
            <b>if</b> (<span class="r15 r">tokens</span> == <b>null</b>)
            {
                <b>throw</b> <a href="../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../../utils/MshTraceSource.cs.html#fbe67220ad7522a0" class="i method">NewArgumentNullException</a>(<b>nameof</b>(<span class="r15 r">tokens</span>));
            }
 
            <b>if</b> (<span class="r16 r">positionOfCursor</span> == <b>null</b>)
            {
                <b>throw</b> <a href="../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../../utils/MshTraceSource.cs.html#fbe67220ad7522a0" class="i method">NewArgumentNullException</a>(<b>nameof</b>(<span class="r16 r">positionOfCursor</span>));
            }
 
            <b>return</b> <a href="#547539b5333d34b3" class="i method">CompleteInputImpl</a>(<span class="r14 r">ast</span>, <span class="r15 r">tokens</span>, <span class="r16 r">positionOfCursor</span>, <span class="r17 r">options</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Invokes the script function TabExpansion2.</span>
        <span class="c">///</span><span class="c"> For legacy support, TabExpansion2 will indirectly call TabExpansion if it exists.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r18 r">input</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The input script to complete.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r19 r">cursorIndex</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The offset in </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r18 r">input</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> where completion is requested.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r20 r">options</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Optional parameter that specifies configurable options for completion.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r21 r">powershell</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The powershell to use to invoke the script function TabExpansion2.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">A collection of completions with the replacement start and length.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Naming&quot;</span>, <span class="s">&quot;CA1704:IdentifiersShouldBeSpelledCorrectly&quot;</span>, <span class="i">MessageId</span> = <span class="s">&quot;powershell&quot;</span>)]
        <b>public static</b> <a href="#a9d35cade4030f50" class="t t">CommandCompletion</a> <a id="5d314c6ade212b21" href="../../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">CompleteInput</a>(<b>string</b> <span id="r18 rd" class="r18 r">input</span>, <b>int</b> <span id="r19 rd" class="r19 r">cursorIndex</span>, <span class="i">Hashtable</span> <span id="r20 rd" class="r20 r">options</span>, <a href="../hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShell</a> <span id="r21 rd" class="r21 r">powershell</span>)
        {
            <b>if</b> (<span class="r18 r">input</span> == <b>null</b>)
            {
                <b>return</b> <a href="#afb38c659d6775e0" class="i field">s_emptyCommandCompletion</a>;
            }
 
            <b>if</b> (<span class="r19 r">cursorIndex</span> &gt; <span class="r18 r">input</span>.<span class="i">Length</span>)
            {
                <b>throw</b> <a href="../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../../utils/MshTraceSource.cs.html#fed5f40dc0075d41" class="i method">NewArgumentException</a>(<b>nameof</b>(<span class="r19 r">cursorIndex</span>));
            }
 
            <b>if</b> (<span class="r21 r">powershell</span> == <b>null</b>)
            {
                <b>throw</b> <a href="../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../../utils/MshTraceSource.cs.html#fbe67220ad7522a0" class="i method">NewArgumentNullException</a>(<b>nameof</b>(<span class="r21 r">powershell</span>));
            }
 
            <span class="c">// If we are in a debugger stop, let the debugger do the command completion.</span>
            <a href="../debugger/debugger.cs.html#9e8f0b396592e65c" class="k">var</a> <span id="r22 rd" class="r22 r">debugger</span> = <span class="r21 r">powershell</span>.<a href="../hostifaces/PowerShell.cs.html#ccf57242c9d46642" class="i property">Runspace</a>?.<a href="../hostifaces/Connection.cs.html#d6610640d00b19f5" class="i property">Debugger</a>;
            <b>if</b> ((<span class="r22 r">debugger</span> != <b>null</b>) &amp;&amp; <span class="r22 r">debugger</span>.<a href="../debugger/debugger.cs.html#564232f4b51d11aa" class="i property">InBreakpoint</a>)
            {
                <b>return</b> <a href="#51cc74b3fd5f7e9e" class="i method">CompleteInputInDebugger</a>(<span class="r18 r">input</span>, <span class="r19 r">cursorIndex</span>, <span class="r20 r">options</span>, <span class="r22 r">debugger</span>);
            }
 
            <a href="../remoting/client/remoterunspace.cs.html#e2c1bde75e106663" class="k">var</a> <span id="r23 rd" class="r23 r">remoteRunspace</span> = <span class="r21 r">powershell</span>.<a href="../hostifaces/PowerShell.cs.html#ccf57242c9d46642" class="i property">Runspace</a> <b>as</b> <a href="../remoting/client/remoterunspace.cs.html#e2c1bde75e106663" class="t t">RemoteRunspace</a>;
            <b>if</b> (<span class="r23 r">remoteRunspace</span> != <b>null</b>)
            {
                <span class="c">// If the runspace is not available to run commands then exit here because nested commands are not</span>
                <span class="c">// supported on remote runspaces.</span>
                <b>if</b> (<span class="r21 r">powershell</span>.<a href="../hostifaces/PowerShell.cs.html#32c156c0cba25702" class="i property">IsNested</a> || (<span class="r23 r">remoteRunspace</span>.<a href="../remoting/client/remoterunspace.cs.html#c9a8dc56926b5fdf" class="i property">RunspaceAvailability</a> != <a href="../hostifaces/Connection.cs.html#bd6944cab8dcc583" class="t t">RunspaceAvailability</a>.<a href="../hostifaces/Connection.cs.html#64bc5c5290cfb16d" class="i field">Available</a>))
                {
                    <b>return</b> <a href="#afb38c659d6775e0" class="i field">s_emptyCommandCompletion</a>;
                }
 
                <span class="c">// If it&#39;s in the nested prompt, the powershell instance is created by &quot;PowerShell.Create(RunspaceMode.CurrentRunspace);&quot;.</span>
                <span class="c">// In this case, the powershell._runspace is null but if we try to access the property &quot;Runspace&quot;, it will create a new</span>
                <span class="c">// local runspace - the default local runspace will be abandoned. So we check the powershell.IsChild first to make sure</span>
                <span class="c">// not to access the property &quot;Runspace&quot; in this case - powershell.isChild will be set to true only in this case.</span>
                <b>if</b> (!<span class="r21 r">powershell</span>.<a href="../hostifaces/PowerShell.cs.html#d1ffd6dcd401bcb5" class="i property">IsChild</a>)
                {
                    <a href="#4c57696277b28908" class="i method">CheckScriptCallOnRemoteRunspace</a>(<span class="r23 r">remoteRunspace</span>);
                    <b>if</b> (<span class="r23 r">remoteRunspace</span>.<a href="../remoting/client/remoterunspace.cs.html#558ae0c453ba9c2e" class="i method">GetCapabilities</a>().<span class="i">Equals</span>(<span class="i n">Runspaces</span>.<a href="../hostifaces/Connection.cs.html#381534d5ae10528e" class="t t">RunspaceCapability</a>.<a href="../hostifaces/Connection.cs.html#9ed1c376ca1193e2" class="i field">Default</a>))
                    {
                        <span class="c">// Capability:</span>
                        <span class="c">//      NamedPipeTransport (0x2)            -&gt; If remoteMachine is Threshold or later</span>
                        <span class="c">//      SupportsDisconnect (0x1)            -&gt; If remoteMachine is Win8 or later</span>
                        <span class="c">//      Default (0x0)                       -&gt; If remoteMachine is Win7</span>
                        <span class="c">// Remoting to a Win7 machine. Use the legacy tab completion function from V1/V2</span>
                        <b>int</b> <span id="r24 rd" class="r24 r">replacementIndex</span>;
                        <b>int</b> <span id="r25 rd" class="r25 r">replacementLength</span>;
 
                        <span class="r21 r">powershell</span>.<a href="../hostifaces/PowerShell.cs.html#7bde27452e045465" class="i property">Commands</a>.<a href="../hostifaces/PSCommand.cs.html#15970659c9fe6157" class="i method">Clear</a>();
                        <b>var</b> <span id="r26 rd" class="r26 r">results</span> = <a href="#d985eafcd4190adc" class="i method">InvokeLegacyTabExpansion</a>(<span class="r21 r">powershell</span>, <span class="r18 r">input</span>, <span class="r19 r">cursorIndex</span>, <b>true</b>, <b>out</b> <span class="r24 r">replacementIndex</span>, <b>out</b> <span class="r25 r">replacementLength</span>);
                        <b>return</b> <b>new</b> <span class="t">CommandCompletion</span>(
                            <b>new</b> <span class="i">Collection</span>&lt;<a href="CompletionResult.cs.html#a4c553f80d9e648c" class="t t">CompletionResult</a>&gt;(<span class="r26 r">results</span> ?? <a href="#13ad720861798479" class="i field">EmptyCompletionResult</a>),
                            -1, <span class="r24 r">replacementIndex</span>, <span class="r25 r">replacementLength</span>);
                    }
                }
            }
 
            <b>return</b> <a href="#387970af3aa3ce7e" class="i method">CallScriptWithStringParameterSet</a>(<span class="r18 r">input</span>, <span class="r19 r">cursorIndex</span>, <span class="r20 r">options</span>, <span class="r21 r">powershell</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Invokes the script function TabExpansion2.</span>
        <span class="c">///</span><span class="c"> For legacy support, TabExpansion2 will indirectly call TabExpansion if it exists.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r27 r">ast</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The ast for pre-parsed input.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r28 r">tokens</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r29 r">cursorPosition</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r30 r">options</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Optional options to configure how completion is performed.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r31 r">powershell</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The powershell to use to invoke the script function TabExpansion2.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Naming&quot;</span>, <span class="s">&quot;CA1704:IdentifiersShouldBeSpelledCorrectly&quot;</span>, <span class="i">MessageId</span> = <span class="s">&quot;powershell&quot;</span>)]
        <b>public static</b> <a href="#a9d35cade4030f50" class="t t">CommandCompletion</a> <a id="8788f60adfdabee0" href="../../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">CompleteInput</a>(<a href="../parser/ast.cs.html#d47621d83efd14de" class="t t">Ast</a> <span id="r27 rd" class="r27 r">ast</span>, <a href="../parser/token.cs.html#ec5d9ac6a36d920c" class="t t">Token</a>[] <span id="r28 rd" class="r28 r">tokens</span>, <a href="../parser/Position.cs.html#fb2ad3feb9004d98" class="t t">IScriptPosition</a> <span id="r29 rd" class="r29 r">cursorPosition</span>, <span class="i">Hashtable</span> <span id="r30 rd" class="r30 r">options</span>, <a href="../hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShell</a> <span id="r31 rd" class="r31 r">powershell</span>)
        {
            <b>if</b> (<span class="r27 r">ast</span> == <b>null</b>)
            {
                <b>throw</b> <a href="../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../../utils/MshTraceSource.cs.html#fbe67220ad7522a0" class="i method">NewArgumentNullException</a>(<b>nameof</b>(<span class="r27 r">ast</span>));
            }
 
            <b>if</b> (<span class="r28 r">tokens</span> == <b>null</b>)
            {
                <b>throw</b> <a href="../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../../utils/MshTraceSource.cs.html#fbe67220ad7522a0" class="i method">NewArgumentNullException</a>(<b>nameof</b>(<span class="r28 r">tokens</span>));
            }
 
            <b>if</b> (<span class="r29 r">cursorPosition</span> == <b>null</b>)
            {
                <b>throw</b> <a href="../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../../utils/MshTraceSource.cs.html#fbe67220ad7522a0" class="i method">NewArgumentNullException</a>(<b>nameof</b>(<span class="r29 r">cursorPosition</span>));
            }
 
            <b>if</b> (<span class="r31 r">powershell</span> == <b>null</b>)
            {
                <b>throw</b> <a href="../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../../utils/MshTraceSource.cs.html#fbe67220ad7522a0" class="i method">NewArgumentNullException</a>(<b>nameof</b>(<span class="r31 r">powershell</span>));
            }
 
            <span class="c">// If we are in a debugger stop, let the debugger do the command completion.</span>
            <a href="../debugger/debugger.cs.html#9e8f0b396592e65c" class="k">var</a> <span id="r32 rd" class="r32 r">debugger</span> = <span class="r31 r">powershell</span>.<a href="../hostifaces/PowerShell.cs.html#ccf57242c9d46642" class="i property">Runspace</a>?.<a href="../hostifaces/Connection.cs.html#d6610640d00b19f5" class="i property">Debugger</a>;
            <b>if</b> ((<span class="r32 r">debugger</span> != <b>null</b>) &amp;&amp; <span class="r32 r">debugger</span>.<a href="../debugger/debugger.cs.html#564232f4b51d11aa" class="i property">InBreakpoint</a>)
            {
                <b>return</b> <a href="#a9ecaab104224c19" class="i method">CompleteInputInDebugger</a>(<span class="r27 r">ast</span>, <span class="r28 r">tokens</span>, <span class="r29 r">cursorPosition</span>, <span class="r30 r">options</span>, <span class="r32 r">debugger</span>);
            }
 
            <a href="../remoting/client/remoterunspace.cs.html#e2c1bde75e106663" class="k">var</a> <span id="r33 rd" class="r33 r">remoteRunspace</span> = <span class="r31 r">powershell</span>.<a href="../hostifaces/PowerShell.cs.html#ccf57242c9d46642" class="i property">Runspace</a> <b>as</b> <a href="../remoting/client/remoterunspace.cs.html#e2c1bde75e106663" class="t t">RemoteRunspace</a>;
            <b>if</b> (<span class="r33 r">remoteRunspace</span> != <b>null</b>)
            {
                <span class="c">// If the runspace is not available to run commands then exit here because nested commands are not</span>
                <span class="c">// supported on remote runspaces.</span>
                <b>if</b> (<span class="r31 r">powershell</span>.<a href="../hostifaces/PowerShell.cs.html#32c156c0cba25702" class="i property">IsNested</a> || (<span class="r33 r">remoteRunspace</span>.<a href="../remoting/client/remoterunspace.cs.html#c9a8dc56926b5fdf" class="i property">RunspaceAvailability</a> != <a href="../hostifaces/Connection.cs.html#bd6944cab8dcc583" class="t t">RunspaceAvailability</a>.<a href="../hostifaces/Connection.cs.html#64bc5c5290cfb16d" class="i field">Available</a>))
                {
                    <b>return</b> <a href="#afb38c659d6775e0" class="i field">s_emptyCommandCompletion</a>;
                }
 
                <b>if</b> (!<span class="r31 r">powershell</span>.<a href="../hostifaces/PowerShell.cs.html#d1ffd6dcd401bcb5" class="i property">IsChild</a>)
                {
                    <a href="#4c57696277b28908" class="i method">CheckScriptCallOnRemoteRunspace</a>(<span class="r33 r">remoteRunspace</span>);
                    <b>if</b> (<span class="r33 r">remoteRunspace</span>.<a href="../remoting/client/remoterunspace.cs.html#558ae0c453ba9c2e" class="i method">GetCapabilities</a>().<span class="i">Equals</span>(<span class="i n">Runspaces</span>.<a href="../hostifaces/Connection.cs.html#381534d5ae10528e" class="t t">RunspaceCapability</a>.<a href="../hostifaces/Connection.cs.html#9ed1c376ca1193e2" class="i field">Default</a>))
                    {
                        <span class="c">// Capability:</span>
                        <span class="c">//      SupportsDisconnect (0x1)            -&gt; If remoteMachine is Win8 or later</span>
                        <span class="c">//      Default (0x0)                       -&gt; If remoteMachine is Win7</span>
                        <span class="c">// Remoting to a Win7 machine. Use the legacy tab completion function from V1/V2</span>
                        <b>int</b> <span id="r34 rd" class="r34 r">replacementIndex</span>;
                        <b>int</b> <span id="r35 rd" class="r35 r">replacementLength</span>;
 
                        <span class="c">// When call the win7 TabExpansion script, the input should be the single current line</span>
                        <span class="r31 r">powershell</span>.<a href="../hostifaces/PowerShell.cs.html#7bde27452e045465" class="i property">Commands</a>.<a href="../hostifaces/PSCommand.cs.html#15970659c9fe6157" class="i method">Clear</a>();
                        <b>var</b> <span id="r36 rd" class="r36 r">inputAndCursor</span> = <a href="#91a7723171a8f53f" class="i method">GetInputAndCursorFromAst</a>(<span class="r29 r">cursorPosition</span>);
                        <b>var</b> <span id="r37 rd" class="r37 r">results</span> = <span class="i">InvokeLegacyTabExpansion</span>(<span class="r31 r">powershell</span>, <span class="r36 r">inputAndCursor</span>.<span class="i">Item1</span>, <span class="r36 r">inputAndCursor</span>.<span class="i">Item2</span>, <b>true</b>, <b>out</b> <span class="r34 r">replacementIndex</span>, <b>out</b> <span class="r35 r">replacementLength</span>);
                        <b>return</b> <b>new</b> <span class="t">CommandCompletion</span>(
                            <b>new</b> <span class="i">Collection</span>&lt;<a href="CompletionResult.cs.html#a4c553f80d9e648c" class="t t">CompletionResult</a>&gt;(<span class="r37 r">results</span> ?? <a href="#13ad720861798479" class="i field">EmptyCompletionResult</a>),
                            -1, <span class="r34 r">replacementIndex</span> + <span class="r36 r">inputAndCursor</span>.<span class="i">Item3</span>, <span class="r35 r">replacementLength</span>);
                    }
                    <b>else</b>
                    {
                        <span class="c">// Call script on a remote win8 machine</span>
                        <span class="c">// when call the win8 TabExpansion2 script, the input should be the whole script text</span>
                        <b>string</b> <span id="r38 rd" class="r38 r">input</span> = <span class="r27 r">ast</span>.<a href="../parser/ast.cs.html#d9d5cd324ee61136" class="i property">Extent</a>.<a href="../parser/Position.cs.html#43ce932d9225bc9c" class="i property">Text</a>;
                        <b>int</b> <span id="r39 rd" class="r39 r">cursorIndex</span> = ((<a href="../parser/Position.cs.html#ded1553e3f2b51f3" class="t t">InternalScriptPosition</a>)<span class="r29 r">cursorPosition</span>).<a href="../parser/Position.cs.html#ae983dad2327d7fd" class="i property">Offset</a>;
                        <b>return</b> <a href="#387970af3aa3ce7e" class="i method">CallScriptWithStringParameterSet</a>(<span class="r38 r">input</span>, <span class="r39 r">cursorIndex</span>, <span class="r30 r">options</span>, <span class="r31 r">powershell</span>);
                    }
                }
            }
 
            <b>return</b> <a href="#8da22023b6221491" class="i method">CallScriptWithAstParameterSet</a>(<span class="r27 r">ast</span>, <span class="r28 r">tokens</span>, <span class="r29 r">cursorPosition</span>, <span class="r30 r">options</span>, <span class="r31 r">powershell</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Get the next result, moving forward or backward.  Supports wraparound, so if there are any results at all,</span>
        <span class="c">///</span><span class="c"> this method will never fail and never return null.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r40 r">forward</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">True if we should move forward through the list, false if backwards.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">The next completion result, or null if no results.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public</b> <a href="CompletionResult.cs.html#a4c553f80d9e648c" class="t t">CompletionResult</a> <a id="7f62198ecd5504d4" href="../../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">GetNextResult</a>(<b>bool</b> <span id="r40 rd" class="r40 r">forward</span>)
        {
            <a href="CompletionResult.cs.html#a4c553f80d9e648c" class="t t">CompletionResult</a> <span id="r41 rd" class="r41 r">result</span> = <b>null</b>;
            <b>var</b> <span id="r42 rd" class="r42 r">count</span> = <a href="#fd7d52da3aade7dd" class="i property">CompletionMatches</a>.<span class="i">Count</span>;
            <b>if</b> (<span class="r42 r">count</span> &gt; 0)
            {
                <a href="#7e09838758131c09" class="i property">CurrentMatchIndex</a> += <span class="r40 r">forward</span> ? 1 : -1;
                <b>if</b> (<a href="#7e09838758131c09" class="i property">CurrentMatchIndex</a> &gt;= <span class="r42 r">count</span>)
                {
                    <a href="#7e09838758131c09" class="i property">CurrentMatchIndex</a> = 0;
                }
                <b>else</b> <b>if</b> (<a href="#7e09838758131c09" class="i property">CurrentMatchIndex</a> &lt; 0)
                {
                    <a href="#7e09838758131c09" class="i property">CurrentMatchIndex</a> = <span class="r42 r">count</span> - 1;
                }
 
                <span class="r41 r">result</span> = <a href="#fd7d52da3aade7dd" class="i property">CompletionMatches</a>[<a href="#7e09838758131c09" class="i property">CurrentMatchIndex</a>];
            }
 
            <b>return</b> <span class="r41 r">result</span>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> public methods
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Internal methods
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Command completion while in debug break mode.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r43 r">input</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The input script to complete.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r44 r">cursorIndex</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The offset in </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r43 r">input</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> where completion is requested.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r45 r">options</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Optional parameter that specifies configurable options for completion.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r46 r">debugger</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Current debugger.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">A collection of completions with the replacement start and length.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal static</b> <a href="#a9d35cade4030f50" class="t t">CommandCompletion</a> <a id="51cc74b3fd5f7e9e" href="../../R/51cc74b3fd5f7e9e.html" target="n" data-glyph="74,1" class="i method">CompleteInputInDebugger</a>(<b>string</b> <span id="r43 rd" class="r43 r">input</span>, <b>int</b> <span id="r44 rd" class="r44 r">cursorIndex</span>, <span class="i">Hashtable</span> <span id="r45 rd" class="r45 r">options</span>, <a href="../debugger/debugger.cs.html#9e8f0b396592e65c" class="t t">Debugger</a> <span id="r46 rd" class="r46 r">debugger</span>)
        {
            <b>if</b> (<span class="r43 r">input</span> == <b>null</b>)
            {
                <b>return</b> <a href="#afb38c659d6775e0" class="i field">s_emptyCommandCompletion</a>;
            }
 
            <b>if</b> (<span class="r44 r">cursorIndex</span> &gt; <span class="r43 r">input</span>.<span class="i">Length</span>)
            {
                <b>throw</b> <a href="../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../../utils/MshTraceSource.cs.html#fed5f40dc0075d41" class="i method">NewArgumentException</a>(<b>nameof</b>(<span class="r44 r">cursorIndex</span>));
            }
 
            <b>if</b> (<span class="r46 r">debugger</span> == <b>null</b>)
            {
                <b>throw</b> <a href="../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../../utils/MshTraceSource.cs.html#fbe67220ad7522a0" class="i method">NewArgumentNullException</a>(<b>nameof</b>(<span class="r46 r">debugger</span>));
            }
 
            <a href="../hostifaces/Command.cs.html#b55b68a3bf75e612" class="t t">Command</a> <span id="r47 rd" class="r47 r">cmd</span> = <b>new</b> <a href="../hostifaces/Command.cs.html#6c075592cf04e686" class="t constructor">Command</a>(<span class="s">&quot;TabExpansion2&quot;</span>);
            <span class="r47 r">cmd</span>.<a href="../hostifaces/Command.cs.html#ba1074ca05aadff5" class="i property">Parameters</a>.<a href="../hostifaces/Parameter.cs.html#435d9001e2932613" class="i method">Add</a>(<span class="s">&quot;InputScript&quot;</span>, <span class="r43 r">input</span>);
            <span class="r47 r">cmd</span>.<a href="../hostifaces/Command.cs.html#ba1074ca05aadff5" class="i property">Parameters</a>.<a href="../hostifaces/Parameter.cs.html#435d9001e2932613" class="i method">Add</a>(<span class="s">&quot;CursorColumn&quot;</span>, <span class="r44 r">cursorIndex</span>);
            <span class="r47 r">cmd</span>.<a href="../hostifaces/Command.cs.html#ba1074ca05aadff5" class="i property">Parameters</a>.<span class="i">Add</span>(<span class="s">&quot;Options&quot;</span>, <span class="r45 r">options</span>);
 
            <b>return</b> <a href="#f1a77ee14b2560cc" class="i method">ProcessCompleteInputCommand</a>(<span class="r47 r">cmd</span>, <span class="r46 r">debugger</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Command completion while in debug break mode.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r48 r">ast</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The ast for pre-parsed input.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r49 r">tokens</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r50 r">cursorPosition</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r51 r">options</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Optional options to configure how completion is performed.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r52 r">debugger</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Current debugger.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">Command completion.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal static</b> <a href="#a9d35cade4030f50" class="t t">CommandCompletion</a> <a id="a9ecaab104224c19" href="../../R/a9ecaab104224c19.html" target="n" data-glyph="74,1" class="i method">CompleteInputInDebugger</a>(<a href="../parser/ast.cs.html#d47621d83efd14de" class="t t">Ast</a> <span id="r48 rd" class="r48 r">ast</span>, <a href="../parser/token.cs.html#ec5d9ac6a36d920c" class="t t">Token</a>[] <span id="r49 rd" class="r49 r">tokens</span>, <a href="../parser/Position.cs.html#fb2ad3feb9004d98" class="t t">IScriptPosition</a> <span id="r50 rd" class="r50 r">cursorPosition</span>, <span class="i">Hashtable</span> <span id="r51 rd" class="r51 r">options</span>, <a href="../debugger/debugger.cs.html#9e8f0b396592e65c" class="t t">Debugger</a> <span id="r52 rd" class="r52 r">debugger</span>)
        {
            <b>if</b> (<span class="r48 r">ast</span> == <b>null</b>)
            {
                <b>throw</b> <a href="../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../../utils/MshTraceSource.cs.html#fbe67220ad7522a0" class="i method">NewArgumentNullException</a>(<b>nameof</b>(<span class="r48 r">ast</span>));
            }
 
            <b>if</b> (<span class="r49 r">tokens</span> == <b>null</b>)
            {
                <b>throw</b> <a href="../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../../utils/MshTraceSource.cs.html#fbe67220ad7522a0" class="i method">NewArgumentNullException</a>(<b>nameof</b>(<span class="r49 r">tokens</span>));
            }
 
            <b>if</b> (<span class="r50 r">cursorPosition</span> == <b>null</b>)
            {
                <b>throw</b> <a href="../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../../utils/MshTraceSource.cs.html#fbe67220ad7522a0" class="i method">NewArgumentNullException</a>(<b>nameof</b>(<span class="r50 r">cursorPosition</span>));
            }
 
            <b>if</b> (<span class="r52 r">debugger</span> == <b>null</b>)
            {
                <b>throw</b> <a href="../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../../utils/MshTraceSource.cs.html#fbe67220ad7522a0" class="i method">NewArgumentNullException</a>(<b>nameof</b>(<span class="r52 r">debugger</span>));
            }
 
            <span class="c">// For remote debugging just pass string input.</span>
            <b>if</b> ((<span class="r52 r">debugger</span> <b>is</b> <a href="../remoting/client/remoterunspace.cs.html#89199d5c3f22d94e" class="t t">RemoteDebugger</a>) || <span class="r52 r">debugger</span>.<a href="../debugger/debugger.cs.html#970bc0159abf3265" class="i property">IsPushed</a>)
            {
                <b>string</b> <span id="r53 rd" class="r53 r">input</span> = <span class="r48 r">ast</span>.<a href="../parser/ast.cs.html#d9d5cd324ee61136" class="i property">Extent</a>.<a href="../parser/Position.cs.html#43ce932d9225bc9c" class="i property">Text</a>;
                <b>int</b> <span id="r54 rd" class="r54 r">cursorIndex</span> = ((<a href="../parser/Position.cs.html#ded1553e3f2b51f3" class="t t">InternalScriptPosition</a>)<span class="r50 r">cursorPosition</span>).<a href="../parser/Position.cs.html#ae983dad2327d7fd" class="i property">Offset</a>;
 
                <b>return</b> <a href="#51cc74b3fd5f7e9e" class="i method">CompleteInputInDebugger</a>(<span class="r53 r">input</span>, <span class="r54 r">cursorIndex</span>, <span class="r51 r">options</span>, <span class="r52 r">debugger</span>);
            }
 
            <a href="../hostifaces/Command.cs.html#b55b68a3bf75e612" class="t t">Command</a> <span id="r55 rd" class="r55 r">cmd</span> = <b>new</b> <a href="../hostifaces/Command.cs.html#6c075592cf04e686" class="t constructor">Command</a>(<span class="s">&quot;TabExpansion2&quot;</span>);
            <span class="r55 r">cmd</span>.<a href="../hostifaces/Command.cs.html#ba1074ca05aadff5" class="i property">Parameters</a>.<a href="../hostifaces/Parameter.cs.html#435d9001e2932613" class="i method">Add</a>(<span class="s">&quot;Ast&quot;</span>, <span class="r48 r">ast</span>);
            <span class="r55 r">cmd</span>.<a href="../hostifaces/Command.cs.html#ba1074ca05aadff5" class="i property">Parameters</a>.<a href="../hostifaces/Parameter.cs.html#435d9001e2932613" class="i method">Add</a>(<span class="s">&quot;Tokens&quot;</span>, <span class="r49 r">tokens</span>);
            <span class="r55 r">cmd</span>.<a href="../hostifaces/Command.cs.html#ba1074ca05aadff5" class="i property">Parameters</a>.<a href="../hostifaces/Parameter.cs.html#435d9001e2932613" class="i method">Add</a>(<span class="s">&quot;PositionOfCursor&quot;</span>, <span class="r50 r">cursorPosition</span>);
            <span class="r55 r">cmd</span>.<a href="../hostifaces/Command.cs.html#ba1074ca05aadff5" class="i property">Parameters</a>.<span class="i">Add</span>(<span class="s">&quot;Options&quot;</span>, <span class="r51 r">options</span>);
 
            <b>return</b> <a href="#f1a77ee14b2560cc" class="i method">ProcessCompleteInputCommand</a>(<span class="r55 r">cmd</span>, <span class="r52 r">debugger</span>);
        }
 
        <b>private static</b> <a href="#a9d35cade4030f50" class="t t">CommandCompletion</a> <a id="f1a77ee14b2560cc" href="../../R/f1a77ee14b2560cc.html" target="n" data-glyph="76,1" class="i method">ProcessCompleteInputCommand</a>(
            <a href="../hostifaces/Command.cs.html#b55b68a3bf75e612" class="t t">Command</a> <span id="r56 rd" class="r56 r">cmd</span>,
            <a href="../debugger/debugger.cs.html#9e8f0b396592e65c" class="t t">Debugger</a> <span id="r57 rd" class="r57 r">debugger</span>)
        {
            <a href="../hostifaces/PSCommand.cs.html#b9f024f73904cf55" class="t t">PSCommand</a> <span id="r58 rd" class="r58 r">command</span> = <b>new</b> <a href="../hostifaces/PSCommand.cs.html#630b26942ccab3f2" class="t constructor">PSCommand</a>(<span class="r56 r">cmd</span>);
            <a href="../hostifaces/PSDataCollection.cs.html#52e2b209c10ec0a4" class="t t">PSDataCollection</a>&lt;<a href="../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt; <span id="r59 rd" class="r59 r">output</span> = <b>new</b> <a href="../hostifaces/PSDataCollection.cs.html#ee85ce3306fe4e5b" class="t constructor">PSDataCollection</a>&lt;<a href="../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt;();
 
            <span class="r57 r">debugger</span>.<a href="../debugger/debugger.cs.html#f752da7b39207812" class="i method">ProcessCommand</a>(<span class="r58 r">command</span>, <span class="r59 r">output</span>);
 
            <b>if</b> (<span class="r59 r">output</span>.<a href="../hostifaces/PSDataCollection.cs.html#e7cb43bbebbb4aca" class="i property">Count</a> == 1)
            {
                <a href="#a9d35cade4030f50" class="k">var</a> <span id="r60 rd" class="r60 r">commandCompletion</span> = <span class="r59 r">output</span>[0].<a href="../MshObject.cs.html#d854d13536b70a12" class="i property">BaseObject</a> <b>as</b> <a href="#a9d35cade4030f50" class="t t">CommandCompletion</a>;
                <b>if</b> (<span class="r60 r">commandCompletion</span> != <b>null</b>)
                {
                    <b>return</b> <span class="r60 r">commandCompletion</span>;
                }
            }
 
            <b>return</b> <a href="#afb38c659d6775e0" class="i field">s_emptyCommandCompletion</a>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> private methods
 
        <b>private static void</b> <a id="4c57696277b28908" href="../../R/4c57696277b28908.html" target="n" data-glyph="76,1" class="i method">CheckScriptCallOnRemoteRunspace</a>(<a href="../remoting/client/remoterunspace.cs.html#e2c1bde75e106663" class="t t">RemoteRunspace</a> <span id="r61 rd" class="r61 r">remoteRunspace</span>)
        {
            <a href="../remoting/client/RemoteRunspacePoolInternal.cs.html#1aba79be5da56f57" class="k">var</a> <span id="r62 rd" class="r62 r">remoteRunspaceInternal</span> = <span class="r61 r">remoteRunspace</span>.<a href="../remoting/client/remoterunspace.cs.html#52e4a4fcfd3da6a7" class="i property">RunspacePool</a>.<a href="../hostifaces/RunspacePool.cs.html#ae1c1c4ae8a5c648" class="i property">RemoteRunspacePoolInternal</a>;
            <b>if</b> (<span class="r62 r">remoteRunspaceInternal</span> != <b>null</b>)
            {
                <a href="../remoting/fanin/BaseTransportManager.cs.html#19883ec4df424177" class="k">var</a> <span id="r63 rd" class="r63 r">transportManager</span> = <span class="r62 r">remoteRunspaceInternal</span>.<a href="../remoting/client/RemoteRunspacePoolInternal.cs.html#6629c704c27c6e09" class="i property">DataStructureHandler</a>.<a href="../remoting/client/RemotingProtocol2.cs.html#38c23f3a35d84598" class="i property">TransportManager</a>;
                <b>if</b> (<span class="r63 r">transportManager</span> != <b>null</b> &amp;&amp; <span class="r63 r">transportManager</span>.<a href="../remoting/fanin/BaseTransportManager.cs.html#0ded339d7f7c59f8" class="i property">TypeTable</a> == <b>null</b>)
                {
                    <span class="c">// The remote runspace was created without a TypeTable instance.</span>
                    <span class="c">// The tab completion results cannot be deserialized if the TypeTable is not available</span>
                    <b>throw</b> <a href="../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<span class="i">NewInvalidOperationException</span>(<span class="i">TabCompletionStrings</span>.<span class="i">CannotDeserializeTabCompletionResult</span>);
                }
            }
        }
 
        <b>private static</b> <a href="#a9d35cade4030f50" class="t t">CommandCompletion</a> <a id="387970af3aa3ce7e" href="../../R/387970af3aa3ce7e.html" target="n" data-glyph="76,1" class="i method">CallScriptWithStringParameterSet</a>(<b>string</b> <span id="r64 rd" class="r64 r">input</span>, <b>int</b> <span id="r65 rd" class="r65 r">cursorIndex</span>, <span class="i">Hashtable</span> <span id="r66 rd" class="r66 r">options</span>, <a href="../hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShell</a> <span id="r67 rd" class="r67 r">powershell</span>)
        {
            <b>try</b>
            {
                <span class="r67 r">powershell</span>.<a href="../hostifaces/PowerShell.cs.html#7bde27452e045465" class="i property">Commands</a>.<a href="../hostifaces/PSCommand.cs.html#15970659c9fe6157" class="i method">Clear</a>();
                <span class="r67 r">powershell</span>.<a href="../hostifaces/PowerShell.cs.html#9cc79c297f6cced9" class="i method">AddCommand</a>(<span class="s">&quot;TabExpansion2&quot;</span>)
                    .<a href="../hostifaces/PowerShell.cs.html#b2931353596991a4" class="i method">AddArgument</a>(<span class="r64 r">input</span>)
                    .<a href="../hostifaces/PowerShell.cs.html#b2931353596991a4" class="i method">AddArgument</a>(<span class="r65 r">cursorIndex</span>)
                    .<span class="i">AddArgument</span>(<span class="r66 r">options</span>);
                <b>var</b> <span id="r68 rd" class="r68 r">results</span> = <span class="r67 r">powershell</span>.<a href="../hostifaces/PowerShell.cs.html#184e23c46120523e" class="i method">Invoke</a>();
                <b>if</b> (<span class="r68 r">results</span> == <b>null</b>)
                {
                    <b>return</b> <a href="#afb38c659d6775e0" class="i field">s_emptyCommandCompletion</a>;
                }
 
                <b>if</b> (<span class="r68 r">results</span>.<span class="i">Count</span> == 1)
                {
                    <b>var</b> <span id="r69 rd" class="r69 r">result</span> = <a href="../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>.<span class="i">Base</span>(<span class="r68 r">results</span>[0]);
                    <a href="#a9d35cade4030f50" class="k">var</a> <span id="r70 rd" class="r70 r">commandCompletion</span> = <span class="r69 r">result</span> <b>as</b> <a href="#a9d35cade4030f50" class="t t">CommandCompletion</a>;
                    <b>if</b> (<span class="r70 r">commandCompletion</span> != <b>null</b>)
                    {
                        <b>return</b> <span class="r70 r">commandCompletion</span>;
                    }
                }
            }
            <b>catch</b> (<span class="i">Exception</span>)
            {
            }
            <b>finally</b>
            {
                <span class="r67 r">powershell</span>.<a href="../hostifaces/PowerShell.cs.html#7bde27452e045465" class="i property">Commands</a>.<a href="../hostifaces/PSCommand.cs.html#15970659c9fe6157" class="i method">Clear</a>();
            }
 
            <b>return</b> <a href="#afb38c659d6775e0" class="i field">s_emptyCommandCompletion</a>;
        }
 
        <b>private static</b> <a href="#a9d35cade4030f50" class="t t">CommandCompletion</a> <a id="8da22023b6221491" href="../../R/8da22023b6221491.html" target="n" data-glyph="76,1" class="i method">CallScriptWithAstParameterSet</a>(<a href="../parser/ast.cs.html#d47621d83efd14de" class="t t">Ast</a> <span id="r71 rd" class="r71 r">ast</span>, <a href="../parser/token.cs.html#ec5d9ac6a36d920c" class="t t">Token</a>[] <span id="r72 rd" class="r72 r">tokens</span>, <a href="../parser/Position.cs.html#fb2ad3feb9004d98" class="t t">IScriptPosition</a> <span id="r73 rd" class="r73 r">cursorPosition</span>, <span class="i">Hashtable</span> <span id="r74 rd" class="r74 r">options</span>, <a href="../hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShell</a> <span id="r75 rd" class="r75 r">powershell</span>)
        {
            <b>try</b>
            {
                <span class="r75 r">powershell</span>.<a href="../hostifaces/PowerShell.cs.html#7bde27452e045465" class="i property">Commands</a>.<a href="../hostifaces/PSCommand.cs.html#15970659c9fe6157" class="i method">Clear</a>();
                <span class="r75 r">powershell</span>.<a href="../hostifaces/PowerShell.cs.html#9cc79c297f6cced9" class="i method">AddCommand</a>(<span class="s">&quot;TabExpansion2&quot;</span>)
                    .<a href="../hostifaces/PowerShell.cs.html#b2931353596991a4" class="i method">AddArgument</a>(<span class="r71 r">ast</span>)
                    .<a href="../hostifaces/PowerShell.cs.html#b2931353596991a4" class="i method">AddArgument</a>(<span class="r72 r">tokens</span>)
                    .<a href="../hostifaces/PowerShell.cs.html#b2931353596991a4" class="i method">AddArgument</a>(<span class="r73 r">cursorPosition</span>)
                    .<span class="i">AddArgument</span>(<span class="r74 r">options</span>);
                <b>var</b> <span id="r76 rd" class="r76 r">results</span> = <span class="r75 r">powershell</span>.<a href="../hostifaces/PowerShell.cs.html#184e23c46120523e" class="i method">Invoke</a>();
                <b>if</b> (<span class="r76 r">results</span> == <b>null</b>)
                {
                    <b>return</b> <a href="#afb38c659d6775e0" class="i field">s_emptyCommandCompletion</a>;
                }
 
                <b>if</b> (<span class="r76 r">results</span>.<span class="i">Count</span> == 1)
                {
                    <b>var</b> <span id="r77 rd" class="r77 r">result</span> = <a href="../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>.<span class="i">Base</span>(<span class="r76 r">results</span>[0]);
                    <a href="#a9d35cade4030f50" class="k">var</a> <span id="r78 rd" class="r78 r">commandCompletion</span> = <span class="r77 r">result</span> <b>as</b> <a href="#a9d35cade4030f50" class="t t">CommandCompletion</a>;
                    <b>if</b> (<span class="r78 r">commandCompletion</span> != <b>null</b>)
                    {
                        <b>return</b> <span class="r78 r">commandCompletion</span>;
                    }
                }
            }
            <b>catch</b> (<span class="i">Exception</span>)
            {
            }
            <b>finally</b>
            {
                <span class="r75 r">powershell</span>.<a href="../hostifaces/PowerShell.cs.html#7bde27452e045465" class="i property">Commands</a>.<a href="../hostifaces/PSCommand.cs.html#15970659c9fe6157" class="i method">Clear</a>();
            }
 
            <b>return</b> <a href="#afb38c659d6775e0" class="i field">s_emptyCommandCompletion</a>;
        }
 
        <span class="c">// This is the start of the real implementation of autocomplete/intellisense/tab completion</span>
        <b>private static</b> <a href="#a9d35cade4030f50" class="t t">CommandCompletion</a> <a id="547539b5333d34b3" href="../../R/547539b5333d34b3.html" target="n" data-glyph="76,1" class="i method">CompleteInputImpl</a>(<a href="../parser/ast.cs.html#d47621d83efd14de" class="t t">Ast</a> <span id="r79 rd" class="r79 r">ast</span>, <a href="../parser/token.cs.html#ec5d9ac6a36d920c" class="t t">Token</a>[] <span id="r80 rd" class="r80 r">tokens</span>, <a href="../parser/Position.cs.html#fb2ad3feb9004d98" class="t t">IScriptPosition</a> <span id="r81 rd" class="r81 r">positionOfCursor</span>, <span class="i">Hashtable</span> <span id="r82 rd" class="r82 r">options</span>)
        {
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">LEGACYTELEMETRY</span>
<span class="e">            // We could start collecting telemetry at a later date.
            // We will leave the #if to remind us that we did this once.
            var sw = new Stopwatch();
            sw.Start();
</span><span class="k preprocess">#</span><span class="k preprocess">endif</span>
            <b>using</b> (<a href="../hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="k">var</a> <span id="r83 rd" class="r83 r">powershell</span> = <a href="../hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShell</a>.<a href="../hostifaces/PowerShell.cs.html#1c6a51d3c837bb4d" class="i method">Create</a>(<a href="../hostifaces/PowerShell.cs.html#c3c0f0e5e0b337ff" class="t t">RunspaceMode</a>.<a href="../hostifaces/PowerShell.cs.html#75d224de5df87e75" class="i field">CurrentRunspace</a>))
            {
                <a href="../ExecutionContext.cs.html#130bda5418e8559c" class="k">var</a> <span id="r84 rd" class="r84 r">context</span> = <a href="../hostifaces/LocalPipeline.cs.html#4ecb13103c10f113" class="t t">LocalPipeline</a>.<a href="../hostifaces/LocalPipeline.cs.html#d3eaa3d3391ed484" class="i method">GetExecutionContextFromTLS</a>();
 
                <span class="c">// First, check if a V1/V2 implementation of TabExpansion exists.  If so, the user had overridden</span>
                <span class="c">// the built-in version, so we should continue to use theirs.</span>
                <b>int</b> <span id="r85 rd" class="r85 r">replacementIndex</span> = -1;
                <b>int</b> <span id="r86 rd" class="r86 r">replacementLength</span> = -1;
                <span class="i">List</span>&lt;<a href="CompletionResult.cs.html#a4c553f80d9e648c" class="t t">CompletionResult</a>&gt; <span id="r87 rd" class="r87 r">results</span> = <b>null</b>;
 
                <b>if</b> (<a href="#fd88e667fe8f5889" class="i method">NeedToInvokeLegacyTabExpansion</a>(<span class="r83 r">powershell</span>))
                {
                    <b>var</b> <span id="r88 rd" class="r88 r">inputAndCursor</span> = <a href="#91a7723171a8f53f" class="i method">GetInputAndCursorFromAst</a>(<span class="r81 r">positionOfCursor</span>);
                    <span class="r87 r">results</span> = <span class="i">InvokeLegacyTabExpansion</span>(<span class="r83 r">powershell</span>, <span class="r88 r">inputAndCursor</span>.<span class="i">Item1</span>, <span class="r88 r">inputAndCursor</span>.<span class="i">Item2</span>, <b>false</b>, <b>out</b> <span class="r85 r">replacementIndex</span>, <b>out</b> <span class="r86 r">replacementLength</span>);
                    <span class="r85 r">replacementIndex</span> += <span class="r88 r">inputAndCursor</span>.<span class="i">Item3</span>;
                }
 
                <b>if</b> (<span class="r87 r">results</span> == <b>null</b> || <span class="r87 r">results</span>.<span class="i">Count</span> == 0)
                {
                    <span class="c">/* BROKEN code commented out, fix sometime
                    // If we were invoked from TabExpansion2, we want to &quot;remove&quot; TabExpansion2 and anything it calls
                    // from our results.  We do this by faking out the session so that TabExpansion2 isn&#39;t anywhere to be found.
                    MutableTuple tupleForFrameToSkipPast = null;
                    foreach (var stackEntry in context.Debugger.GetCallStack())
                    {
                        dynamic stackEntryAsPSObj = PSObject.AsPSObject(stackEntry);
                        if (stackEntryAsPSObj.Command.Equals(&quot;TabExpansion2&quot;, StringComparison.OrdinalIgnoreCase))
                        {
                            tupleForFrameToSkipPast = stackEntry.FunctionContext._localsTuple;
                            break;
                        }
                    }
 
                    SessionStateScope scopeToRestore = null;
                    if (tupleForFrameToSkipPast != null)
                    {
                        // Find this tuple in the scope stack.
                        scopeToRestore = context.EngineSessionState.CurrentScope;
                        var scope = context.EngineSessionState.CurrentScope;
                        while (scope != null &amp;&amp; scope.LocalsTuple != tupleForFrameToSkipPast)
                        {
                            scope = scope.Parent;
                        }
 
                        if (scope != null)
                        {
                            context.EngineSessionState.CurrentScope = scope.Parent;
                        }
                    }
 
                    try
                    {
                    */</span>
                    <a href="CompletionAnalysis.cs.html#978ec9faf3baf106" class="k">var</a> <span id="r89 rd" class="r89 r">completionAnalysis</span> = <b>new</b> <a href="CompletionAnalysis.cs.html#b6ce3ec3700571b3" class="t constructor">CompletionAnalysis</a>(<span class="r79 r">ast</span>, <span class="r80 r">tokens</span>, <span class="r81 r">positionOfCursor</span>, <span class="r82 r">options</span>);
                    <span class="r87 r">results</span> = <span class="r89 r">completionAnalysis</span>.<a href="CompletionAnalysis.cs.html#5cf3c5e39f65b543" class="i method">GetResults</a>(<span class="r83 r">powershell</span>, <b>out</b> <span class="r85 r">replacementIndex</span>, <b>out</b> <span class="r86 r">replacementLength</span>);
                    <span class="c">/*
                    }
                    finally
                    {
                        if (scopeToRestore != null)
                        {
                            context.EngineSessionState.CurrentScope = scopeToRestore;
                        }
                    }
                    */</span>
                }
 
                <b>var</b> <span id="r90 rd" class="r90 r">completionResults</span> = <span class="r87 r">results</span> ?? <a href="#13ad720861798479" class="i field">EmptyCompletionResult</a>;
 
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">LEGACYTELEMETRY</span>
<span class="e">                    // no telemetry here. We don&#39;t capture tab completion performance.
                    sw.Stop();
                    TelemetryAPI.ReportTabCompletionTelemetry(sw.ElapsedMilliseconds, completionResults.Count,
                        completionResults.Count &gt; 0 ? completionResults[0].ResultType : CompletionResultType.Text);
</span><span class="k preprocess">#</span><span class="k preprocess">endif</span>
                <b>return</b> <b>new</b> <span class="t">CommandCompletion</span>(
                    <b>new</b> <span class="i">Collection</span>&lt;<a href="CompletionResult.cs.html#a4c553f80d9e648c" class="t t">CompletionResult</a>&gt;(<span class="r90 r">completionResults</span>),
                    -1,
                    <span class="r85 r">replacementIndex</span>,
                    <span class="r86 r">replacementLength</span>);
            }
        }
 
        <b>private static</b> <span class="i">Tuple</span>&lt;<b>string</b>, <b>int</b>, <b>int</b>&gt; <a id="91a7723171a8f53f" href="../../R/91a7723171a8f53f.html" target="n" data-glyph="76,1" class="i method">GetInputAndCursorFromAst</a>(<a href="../parser/Position.cs.html#fb2ad3feb9004d98" class="t t">IScriptPosition</a> <span id="r91 rd" class="r91 r">cursorPosition</span>)
        {
            <b>var</b> <span id="r92 rd" class="r92 r">line</span> = <span class="r91 r">cursorPosition</span>.<a href="../parser/Position.cs.html#5498933e478f6930" class="i property">Line</a>;
            <b>var</b> <span id="r93 rd" class="r93 r">cursor</span> = <span class="r91 r">cursorPosition</span>.<a href="../parser/Position.cs.html#adb21ecf0073d187" class="i property">ColumnNumber</a> - 1;
            <b>var</b> <span id="r94 rd" class="r94 r">adjustment</span> = <span class="r91 r">cursorPosition</span>.<a href="../parser/Position.cs.html#cd3280d5f1045b06" class="i property">Offset</a> - <span class="r93 r">cursor</span>;
            <b>return</b> <span class="i">Tuple</span>.<span class="i">Create</span>(<span class="r92 r">line</span>.<span class="i">Substring</span>(0, <span class="r93 r">cursor</span>), <span class="r93 r">cursor</span>, <span class="r94 r">adjustment</span>);
        }
 
        <b>private static bool</b> <a id="fd88e667fe8f5889" href="../../R/fd88e667fe8f5889.html" target="n" data-glyph="76,1" class="i method">NeedToInvokeLegacyTabExpansion</a>(<a href="../hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShell</a> <span id="r95 rd" class="r95 r">powershell</span>)
        {
            <a href="../ExecutionContext.cs.html#130bda5418e8559c" class="k">var</a> <span id="r96 rd" class="r96 r">executionContext</span> = <span class="r95 r">powershell</span>.<a href="../hostifaces/PowerShell.cs.html#ff0cc19559303c1e" class="i method">GetContextFromTLS</a>();
 
            <span class="c">// We don&#39;t want command discovery to search unloaded modules for TabExpansion.</span>
            <a href="../FunctionInfo.cs.html#e37ab42bb144c43b" class="k">var</a> <span id="r97 rd" class="r97 r">functionInfo</span> = <span class="r96 r">executionContext</span>.<a href="../ExecutionContext.cs.html#07982205e4a6a726" class="i property">EngineSessionState</a>.<a href="../SessionStateFunctionAPIs.cs.html#09dc9c88802b581d" class="i method">GetFunction</a>(<span class="s">&quot;TabExpansion&quot;</span>);
            <b>if</b> (<span class="r97 r">functionInfo</span> != <b>null</b>)
                <b>return</b> <b>true</b>;
 
            <a href="../AliasInfo.cs.html#cf27095b0a2fb6ea" class="k">var</a> <span id="r98 rd" class="r98 r">aliasInfo</span> = <span class="r96 r">executionContext</span>.<a href="../ExecutionContext.cs.html#07982205e4a6a726" class="i property">EngineSessionState</a>.<a href="../SessionStateAliasAPIs.cs.html#b2fe92ea38746079" class="i method">GetAlias</a>(<span class="s">&quot;TabExpansion&quot;</span>);
            <b>if</b> (<span class="r98 r">aliasInfo</span> != <b>null</b>)
                <b>return</b> <b>true</b>;
 
            <b>return</b> <b>false</b>;
        }
 
        <b>private static</b> <span class="i">List</span>&lt;<a href="CompletionResult.cs.html#a4c553f80d9e648c" class="t t">CompletionResult</a>&gt; <a id="d985eafcd4190adc" href="../../R/d985eafcd4190adc.html" target="n" data-glyph="76,1" class="i method">InvokeLegacyTabExpansion</a>(<a href="../hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShell</a> <span id="r99 rd" class="r99 r">powershell</span>, <b>string</b> <span id="r100 rd" class="r100 r">input</span>, <b>int</b> <span id="r101 rd" class="r101 r">cursorIndex</span>, <b>bool</b> <span id="r102 rd" class="r102 r">remoteToWin7</span>, <b>out int</b> <span id="r103 rd" class="r103 r">replacementIndex</span>, <b>out int</b> <span id="r104 rd" class="r104 r">replacementLength</span>)
        {
            <span class="i">List</span>&lt;<a href="CompletionResult.cs.html#a4c553f80d9e648c" class="t t">CompletionResult</a>&gt; <span id="r105 rd" class="r105 r">results</span> = <b>null</b>;
 
            <b>var</b> <span id="r106 rd" class="r106 r">legacyInput</span> = (<span class="r101 r">cursorIndex</span> != <span class="r100 r">input</span>.<span class="i">Length</span>) ? <span class="r100 r">input</span>.<span class="i">Substring</span>(0, <span class="r101 r">cursorIndex</span>) : <span class="r100 r">input</span>;
            <b>char</b> <span id="r107 rd" class="r107 r">quote</span>;
            <b>var</b> <span id="r108 rd" class="r108 r">lastword</span> = <a href="#c7a495428c48ad16" class="t t">LastWordFinder</a>.<span class="i">FindLastWord</span>(<span class="r106 r">legacyInput</span>, <b>out</b> <span class="r103 r">replacementIndex</span>, <b>out</b> <span class="r107 r">quote</span>);
            <span class="r104 r">replacementLength</span> = <span class="r106 r">legacyInput</span>.<span class="i">Length</span> - <span class="r103 r">replacementIndex</span>;
            <a href="../../utils/PowerShellExecutionHelper.cs.html#4790f0f05d781b55" class="k">var</a> <span id="r109 rd" class="r109 r">helper</span> = <b>new</b> <a href="../../utils/PowerShellExecutionHelper.cs.html#b251f5b816b2dd25" class="t constructor">PowerShellExecutionHelper</a>(<span class="r99 r">powershell</span>);
 
            <span class="r99 r">powershell</span>.<a href="../hostifaces/PowerShell.cs.html#9cc79c297f6cced9" class="i method">AddCommand</a>(<span class="s">&quot;TabExpansion&quot;</span>).<span class="i">AddArgument</span>(<span class="r106 r">legacyInput</span>).<a href="../hostifaces/PowerShell.cs.html#b2931353596991a4" class="i method">AddArgument</a>(<span class="r108 r">lastword</span>);
 
            <span class="i">Exception</span> <span id="r110 rd" class="r110 r">exceptionThrown</span>;
            <b>var</b> <span id="r111 rd" class="r111 r">oldResults</span> = <span class="r109 r">helper</span>.<a href="../../utils/PowerShellExecutionHelper.cs.html#ca353a51989cf3bd" class="i method">ExecuteCurrentPowerShell</a>(<b>out</b> <span class="r110 r">exceptionThrown</span>);
            <b>if</b> (<span class="r111 r">oldResults</span> != <b>null</b>)
            {
                <span class="r105 r">results</span> = <b>new</b> <span class="i">List</span>&lt;<a href="CompletionResult.cs.html#a4c553f80d9e648c" class="t t">CompletionResult</a>&gt;();
                <b>foreach</b> (<b>var</b> <span id="r112 rd" class="r112 r">oldResult</span> <b>in</b> <span class="r111 r">oldResults</span>)
                {
                    <a href="CompletionResult.cs.html#a4c553f80d9e648c" class="k">var</a> <span id="r113 rd" class="r113 r">completionResult</span> = <a href="../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>.<span class="i">Base</span>(<span class="r112 r">oldResult</span>) <b>as</b> <a href="CompletionResult.cs.html#a4c553f80d9e648c" class="t t">CompletionResult</a>;
                    <b>if</b> (<span class="r113 r">completionResult</span> == <b>null</b>)
                    {
                        <b>var</b> <span id="r114 rd" class="r114 r">oldResultStr</span> = <span class="r112 r">oldResult</span>.<span class="i">ToString</span>();
 
                        <span class="c">// Add back the quotes we removed if the result isn&#39;t quoted</span>
                        <b>if</b> (<span class="r107 r">quote</span> != <span class="s">&#39;\0&#39;</span>)
                        {
                            <b>if</b> (<span class="r114 r">oldResultStr</span>.<span class="i">Length</span> &gt; 2 &amp;&amp; <span class="r114 r">oldResultStr</span>[0] != <span class="r107 r">quote</span>)
                            {
                                <span class="r114 r">oldResultStr</span> = <span class="r107 r">quote</span> + <span class="r114 r">oldResultStr</span> + <span class="r107 r">quote</span>;
                            }
                        }
 
                        <span class="r113 r">completionResult</span> = <b>new</b> <span class="t">CompletionResult</span>(<span class="r114 r">oldResultStr</span>);
                    }
 
                    <span class="r105 r">results</span>.<span class="i">Add</span>(<span class="r113 r">completionResult</span>);
                }
            }
 
            <b>if</b> (<span class="r102 r">remoteToWin7</span> &amp;&amp; (<span class="r105 r">results</span> == <b>null</b> || <span class="r105 r">results</span>.<span class="i">Count</span> == 0))
            {
                <b>string</b> <span id="r115 rd" class="r115 r">quoteStr</span> = <span class="r107 r">quote</span> == <span class="s">&#39;\0&#39;</span> ? <b>string</b>.<span class="i">Empty</span> : <span class="r107 r">quote</span>.<span class="i">ToString</span>();
                <span class="r105 r">results</span> = <a href="#ee743b112ae74c88" class="t t">PSv2CompletionCompleter</a>.<a href="#93de54f60c1c3127" class="i method">PSv2GenerateMatchSetOfFiles</a>(<span class="r109 r">helper</span>, <span class="r108 r">lastword</span>, <span class="r103 r">replacementIndex</span> == 0, <span class="r115 r">quoteStr</span>);
                <b>var</b> <span id="r116 rd" class="r116 r">cmdletResults</span> = <a href="#ee743b112ae74c88" class="t t">PSv2CompletionCompleter</a>.<a href="#929669eb4ebe73cd" class="i method">PSv2GenerateMatchSetOfCmdlets</a>(<span class="r109 r">helper</span>, <span class="r108 r">lastword</span>, <span class="r115 r">quoteStr</span>, <span class="r103 r">replacementIndex</span> == 0);
 
                <b>if</b> (<span class="r116 r">cmdletResults</span> != <b>null</b> &amp;&amp; <span class="r116 r">cmdletResults</span>.<span class="i">Count</span> &gt; 0)
                {
                    <span class="r105 r">results</span>.<span class="i">AddRange</span>(<span class="r116 r">cmdletResults</span>);
                }
            }
 
            <b>return</b> <span class="r105 r">results</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> PSv2CompletionCompleter implements the algorithm we use to complete cmdlet/file names in PowerShell v2. This class</span>
        <span class="c">///</span><span class="c"> exists for legacy purpose only. It is used only in a remote interactive session from Win8 to Win7. V3 and forward</span>
        <span class="c">///</span><span class="c"> uses completely different completers.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The implementation of file name completion is completely different on V2 and V3 for remote scenarios. On PSv3, the</span>
        <span class="c">///</span><span class="c"> CompletionResults are generated always on the target machine, and</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>private static class</b> <a id="ee743b112ae74c88" href="../../R/ee743b112ae74c88.html" target="n" data-glyph="4,1" class="t t">PSv2CompletionCompleter</a>
        {
            <b>private static readonly</b> <span class="i">Regex</span> <a id="b3da234ca4c010c4" href="../../R/b3da234ca4c010c4.html" target="n" data-glyph="46,2" class="i field">s_cmdletTabRegex</a> = <b>new</b> <span class="i">Regex</span>(<span class="s">@&quot;^[\w\*\?]+-[\w\*\?]*&quot;</span>);
            <b>private static readonly char</b>[] <a id="c99e7a91dd9212d8" href="../../R/c99e7a91dd9212d8.html" target="n" data-glyph="46,2" class="i field">s_charsRequiringQuotedString</a> = <span class="s">&quot;`&amp;@&#39;#{}()$,;|&lt;&gt; \t&quot;</span>.<span class="i">ToCharArray</span>();
 
            <span class="k preprocess">#</span><span class="k preprocess">region</span> &quot;Handle Command&quot;
 
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> Used when remoting from a win8 machine to a win7 machine.</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r117 r">lastWord</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r118 r">isSnapinSpecified</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
            <b>private static bool</b> <a id="fbbaef0b69874230" href="../../R/fbbaef0b69874230.html" target="n" data-glyph="76,2" class="i method">PSv2IsCommandLikeCmdlet</a>(<b>string</b> <span id="r117 rd" class="r117 r">lastWord</span>, <b>out bool</b> <span id="r118 rd" class="r118 r">isSnapinSpecified</span>)
            {
                <span class="r118 r">isSnapinSpecified</span> = <b>false</b>;
 
                <b>string</b>[] <span id="r119 rd" class="r119 r">cmdletParts</span> = <span class="r117 r">lastWord</span>.<span class="i">Split</span>(<a href="../Utils.cs.html#9185d6ecbaebbec0" class="t t">Utils</a>.<a href="../Utils.cs.html#6fd6d3492cb91f87" class="t t">Separators</a>.<a href="../Utils.cs.html#247bb446a0dd1494" class="i field">Backslash</a>);
                <b>if</b> (<span class="r119 r">cmdletParts</span>.<span class="i">Length</span> == 1)
                {
                    <b>return</b> <a href="#b3da234ca4c010c4" class="i field">s_cmdletTabRegex</a>.<span class="i">IsMatch</span>(<span class="r117 r">lastWord</span>);
                }
 
                <b>if</b> (<span class="r119 r">cmdletParts</span>.<span class="i">Length</span> == 2)
                {
                    <span class="r118 r">isSnapinSpecified</span> = <a href="../../singleshell/config/MshSnapinInfo.cs.html#571fb5b01a41502f" class="t t">PSSnapInInfo</a>.<a href="../../singleshell/config/MshSnapinInfo.cs.html#153f92aef8175cd9" class="i method">IsPSSnapinIdValid</a>(<span class="r119 r">cmdletParts</span>[0]);
                    <b>if</b> (<span class="r118 r">isSnapinSpecified</span>)
                    {
                        <b>return</b> <a href="#b3da234ca4c010c4" class="i field">s_cmdletTabRegex</a>.<span class="i">IsMatch</span>(<span class="r119 r">cmdletParts</span>[1]);
                    }
                }
 
                <b>return</b> <b>false</b>;
            }
 
            <b>private readonly struct</b> <a id="e60abb138f2fab7d" href="../../R/e60abb138f2fab7d.html" target="n" data-glyph="112,2" class="t t"><span id="523aec430da0f833">CommandAndName</span></a>
            {
                <b>internal readonly</b> <a href="../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <a id="58902a9a1104ced1" href="../../R/58902a9a1104ced1.html" target="n" data-glyph="44,3" class="i field">Command</a>;
                <b>internal readonly</b> <a href="../MshSnapinQualifiedName.cs.html#93cb5bb27e91d97d" class="t t">PSSnapinQualifiedName</a> <a id="bbf25cd4c2b190f4" href="../../R/bbf25cd4c2b190f4.html" target="n" data-glyph="44,3" class="i field">CommandName</a>;
 
                <b>internal</b> <a id="6860ae8401d8c571" href="../../R/6860ae8401d8c571.html" target="n" data-glyph="74,3" class="t constructor">CommandAndName</a>(<a href="../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r120 rd" class="r120 r">command</span>, <a href="../MshSnapinQualifiedName.cs.html#93cb5bb27e91d97d" class="t t">PSSnapinQualifiedName</a> <span id="r121 rd" class="r121 r">commandName</span>)
                {
                    <a href="#e60abb138f2fab7d" class="k">this</a>.<a href="#58902a9a1104ced1" class="i field">Command</a> = <span class="r120 r">command</span>;
                    <a href="#e60abb138f2fab7d" class="k">this</a>.<a href="#bbf25cd4c2b190f4" class="i field">CommandName</a> = <span class="r121 r">commandName</span>;
                }
            }
 
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> Used when remoting from a win8 machine to a win7 machine. Complete command names.</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r122 r">helper</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r123 r">lastWord</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r124 r">quote</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r125 r">completingAtStartOfLine</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
            <b>internal static</b> <span class="i">List</span>&lt;<a href="CompletionResult.cs.html#a4c553f80d9e648c" class="t t">CompletionResult</a>&gt; <a id="929669eb4ebe73cd" href="../../R/929669eb4ebe73cd.html" target="n" data-glyph="74,2" class="i method">PSv2GenerateMatchSetOfCmdlets</a>(<a href="../../utils/PowerShellExecutionHelper.cs.html#4790f0f05d781b55" class="t t">PowerShellExecutionHelper</a> <span id="r122 rd" class="r122 r">helper</span>, <b>string</b> <span id="r123 rd" class="r123 r">lastWord</span>, <b>string</b> <span id="r124 rd" class="r124 r">quote</span>, <b>bool</b> <span id="r125 rd" class="r125 r">completingAtStartOfLine</span>)
            {
                <b>var</b> <span id="r126 rd" class="r126 r">results</span> = <b>new</b> <span class="i">List</span>&lt;<a href="CompletionResult.cs.html#a4c553f80d9e648c" class="t t">CompletionResult</a>&gt;();
                <b>bool</b> <span id="r127 rd" class="r127 r">isSnapinSpecified</span>;
 
                <b>if</b> (!<a href="#fbbaef0b69874230" class="i method">PSv2IsCommandLikeCmdlet</a>(<span class="r123 r">lastWord</span>, <b>out</b> <span class="r127 r">isSnapinSpecified</span>))
                    <b>return</b> <span class="r126 r">results</span>;
 
                <span class="r122 r">helper</span>.<a href="../../utils/PowerShellExecutionHelper.cs.html#ddb7ad1950c8ea20" class="i property">CurrentPowerShell</a>
                    .<a href="../hostifaces/PowerShell.cs.html#9cc79c297f6cced9" class="i method">AddCommand</a>(<span class="s">&quot;Get-Command&quot;</span>)
                    .<span class="i">AddParameter</span>(<span class="s">&quot;Name&quot;</span>, <span class="r123 r">lastWord</span> + <span class="s">&quot;*&quot;</span>)
                    .<a href="../hostifaces/PowerShell.cs.html#9cc79c297f6cced9" class="i method">AddCommand</a>(<span class="s">&quot;Sort-Object&quot;</span>)
                    .<a href="../hostifaces/PowerShell.cs.html#40674f99a3618f4b" class="i method">AddParameter</a>(<span class="s">&quot;Property&quot;</span>, <span class="s">&quot;Name&quot;</span>);
 
                <span class="i">Exception</span> <span id="r128 rd" class="r128 r">exceptionThrown</span>;
                <span class="i">Collection</span>&lt;<a href="../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt; <span id="r129 rd" class="r129 r">commands</span> = <span class="r122 r">helper</span>.<a href="../../utils/PowerShellExecutionHelper.cs.html#ca353a51989cf3bd" class="i method">ExecuteCurrentPowerShell</a>(<b>out</b> <span class="r128 r">exceptionThrown</span>);
 
                <b>if</b> (<span class="r129 r">commands</span> != <b>null</b> &amp;&amp; <span class="r129 r">commands</span>.<span class="i">Count</span> &gt; 0)
                {
                    <span class="c">// convert the PSObjects into strings</span>
                    <a href="#e60abb138f2fab7d" class="t t">CommandAndName</a>[] <span id="r130 rd" class="r130 r">cmdlets</span> = <b>new</b> <a href="#e60abb138f2fab7d" class="t t">CommandAndName</a>[<span class="r129 r">commands</span>.<span class="i">Count</span>];
                    <span class="c">// if the command causes cmdlets from multiple mshsnapin is returned,</span>
                    <span class="c">// append the mshsnapin name to disambiguate the cmdlets.</span>
                    <b>for</b> (<b>int</b> <span id="r131 rd" class="r131 r">i</span> = 0; <span class="r131 r">i</span> &lt; <span class="r129 r">commands</span>.<span class="i">Count</span>; ++<span class="r131 r">i</span>)
                    {
                        <a href="../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r132 rd" class="r132 r">command</span> = <span class="r129 r">commands</span>[<span class="r131 r">i</span>];
                        <b>string</b> <span id="r133 rd" class="r133 r">cmdletFullName</span> = <a href="../CmdletInfo.cs.html#9492ffc9968f644d" class="t t">CmdletInfo</a>.<a href="../CmdletInfo.cs.html#e35729759ecbb150" class="i method">GetFullName</a>(<span class="r132 r">command</span>);
                        <span class="r130 r">cmdlets</span>[<span class="r131 r">i</span>] = <b>new</b> <a href="#6860ae8401d8c571" class="t constructor">CommandAndName</a>(<span class="r132 r">command</span>, <a href="../MshSnapinQualifiedName.cs.html#93cb5bb27e91d97d" class="t t">PSSnapinQualifiedName</a>.<span class="i">GetInstance</span>(<span class="r133 r">cmdletFullName</span>));
                    }
 
                    <b>if</b> (<span class="r127 r">isSnapinSpecified</span>)
                    {
                        <b>foreach</b> (<a href="#e60abb138f2fab7d" class="t t">CommandAndName</a> <span id="r134 rd" class="r134 r">cmdlet</span> <b>in</b> <span class="r130 r">cmdlets</span>)
                        {
                            <a href="#71519e437e861ebc" class="i method">AddCommandResult</a>(<span class="r134 r">cmdlet</span>, <b>true</b>, <span class="r125 r">completingAtStartOfLine</span>, <span class="r124 r">quote</span>, <span class="r126 r">results</span>);
                        }
                    }
                    <b>else</b>
                    {
                        <a href="#70454d03a7e668bb" class="i method">PrependSnapInNameForSameCmdletNames</a>(<span class="r130 r">cmdlets</span>, <span class="r125 r">completingAtStartOfLine</span>, <span class="r124 r">quote</span>, <span class="r126 r">results</span>);
                    }
                }
 
                <b>return</b> <span class="r126 r">results</span>;
            }
 
            <b>private static void</b> <a id="71519e437e861ebc" href="../../R/71519e437e861ebc.html" target="n" data-glyph="76,2" class="i method">AddCommandResult</a>(<a href="#e60abb138f2fab7d" class="t t">CommandAndName</a> <span id="r135 rd" class="r135 r">commandAndName</span>, <b>bool</b> <span id="r136 rd" class="r136 r">useFullName</span>, <b>bool</b> <span id="r137 rd" class="r137 r">completingAtStartOfLine</span>, <b>string</b> <span id="r138 rd" class="r138 r">quote</span>, <span class="i">List</span>&lt;<a href="CompletionResult.cs.html#a4c553f80d9e648c" class="t t">CompletionResult</a>&gt; <span id="r139 rd" class="r139 r">results</span>)
            {
                <a href="../../utils/assert.cs.html#c04955255430d32f" class="t t">Diagnostics</a>.<a href="../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r139 r">results</span> != <b>null</b>, <span class="s">&quot;Caller needs to make sure the result list is not null&quot;</span>);
 
                <b>string</b> <span id="r140 rd" class="r140 r">name</span> = <span class="r136 r">useFullName</span> ? <span class="r135 r">commandAndName</span>.<a href="#bbf25cd4c2b190f4" class="i field">CommandName</a>.<a href="../MshSnapinQualifiedName.cs.html#8c76a251a7f1c2dd" class="i property">FullName</a> : <span class="r135 r">commandAndName</span>.<a href="#bbf25cd4c2b190f4" class="i field">CommandName</a>.<a href="../MshSnapinQualifiedName.cs.html#cb4b6868a9751795" class="i property">ShortName</a>;
                <b>string</b> <span id="r141 rd" class="r141 r">quotedFileName</span> = <a href="#62b12cdfd031782d" class="i method">AddQuoteIfNecessary</a>(<span class="r140 r">name</span>, <span class="r138 r">quote</span>, <span class="r137 r">completingAtStartOfLine</span>);
 
                <b>var</b> <span id="r142 rd" class="r142 r">commandType</span> = <a href="#2d675dd8311bf72f" class="i method">SafeGetProperty</a>&lt;<a href="../CommandInfo.cs.html#3699fe79fa6969b5" class="t t">CommandTypes</a>?&gt;(<span class="r135 r">commandAndName</span>.<a href="#58902a9a1104ced1" class="i field">Command</a>, <span class="s">&quot;CommandType&quot;</span>);
                <b>if</b> (<span class="r142 r">commandType</span> == <b>null</b>)
                {
                    <b>return</b>;
                }
 
                <b>string</b> <span id="r143 rd" class="r143 r">toolTip</span>;
                <b>string</b> <span id="r144 rd" class="r144 r">displayName</span> = <a href="#2d675dd8311bf72f" class="i method">SafeGetProperty</a>&lt;<b>string</b>&gt;(<span class="r135 r">commandAndName</span>.<a href="#58902a9a1104ced1" class="i field">Command</a>, <span class="s">&quot;Name&quot;</span>);
 
                <b>if</b> (<span class="r142 r">commandType</span>.<span class="i">Value</span> == <a href="../CommandInfo.cs.html#3699fe79fa6969b5" class="t t">CommandTypes</a>.<a href="../CommandInfo.cs.html#e95f2e5deaaf9b93" class="i field">Cmdlet</a> || <span class="r142 r">commandType</span>.<span class="i">Value</span> == <a href="../CommandInfo.cs.html#3699fe79fa6969b5" class="t t">CommandTypes</a>.<a href="../CommandInfo.cs.html#f4fc4c6de9082bc5" class="i field">Application</a>)
                {
                    <span class="r143 r">toolTip</span> = <a href="#2d675dd8311bf72f" class="i method">SafeGetProperty</a>&lt;<b>string</b>&gt;(<span class="r135 r">commandAndName</span>.<a href="#58902a9a1104ced1" class="i field">Command</a>, <span class="s">&quot;Definition&quot;</span>);
                }
                <b>else</b>
                {
                    <span class="r143 r">toolTip</span> = <span class="r144 r">displayName</span>;
                }
 
                <span class="r139 r">results</span>.<span class="i">Add</span>(<b>new</b> <a href="CompletionResult.cs.html#ca2afdd6b4929db6" class="t constructor">CompletionResult</a>(<span class="r141 r">quotedFileName</span>, <span class="r144 r">displayName</span>, <a href="CompletionResult.cs.html#3cfd90a9cdb70973" class="t t">CompletionResultType</a>.<a href="CompletionResult.cs.html#8f5d60fd073bb8d9" class="i field">Command</a>, <span class="r143 r">toolTip</span>));
            }
 
            <b>private static void</b> <a id="70454d03a7e668bb" href="../../R/70454d03a7e668bb.html" target="n" data-glyph="76,2" class="i method">PrependSnapInNameForSameCmdletNames</a>(<a href="#e60abb138f2fab7d" class="t t">CommandAndName</a>[] <span id="r145 rd" class="r145 r">cmdlets</span>, <b>bool</b> <span id="r146 rd" class="r146 r">completingAtStartOfLine</span>, <b>string</b> <span id="r147 rd" class="r147 r">quote</span>, <span class="i">List</span>&lt;<a href="CompletionResult.cs.html#a4c553f80d9e648c" class="t t">CompletionResult</a>&gt; <span id="r148 rd" class="r148 r">results</span>)
            {
                <a href="../../utils/assert.cs.html#c04955255430d32f" class="t t">Diagnostics</a>.<a href="../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r145 r">cmdlets</span> != <b>null</b> &amp;&amp; <span class="r145 r">cmdlets</span>.<span class="i">Length</span> &gt; 0,
                    <span class="s">&quot;HasMultiplePSSnapIns must be called with a non-empty collection of PSObject&quot;</span>);
 
                <b>int</b> <span id="r149 rd" class="r149 r">i</span> = 0;
                <b>bool</b> <span id="r150 rd" class="r150 r">previousMatched</span> = <b>false</b>;
                <b>while</b> (<b>true</b>)
                {
                    <a href="#e60abb138f2fab7d" class="t t">CommandAndName</a> <span id="r151 rd" class="r151 r">commandAndName</span> = <span class="r145 r">cmdlets</span>[<span class="r149 r">i</span>];
 
                    <b>int</b> <span id="r152 rd" class="r152 r">lookAhead</span> = <span class="r149 r">i</span> + 1;
                    <b>if</b> (<span class="r152 r">lookAhead</span> &gt;= <span class="r145 r">cmdlets</span>.<span class="i">Length</span>)
                    {
                        <a href="#71519e437e861ebc" class="i method">AddCommandResult</a>(<span class="r151 r">commandAndName</span>, <span class="r150 r">previousMatched</span>, <span class="r146 r">completingAtStartOfLine</span>, <span class="r147 r">quote</span>, <span class="r148 r">results</span>);
                        <b>break</b>;
                    }
 
                    <a href="#e60abb138f2fab7d" class="t t">CommandAndName</a> <span id="r153 rd" class="r153 r">nextCommandAndName</span> = <span class="r145 r">cmdlets</span>[<span class="r152 r">lookAhead</span>];
 
                    <b>if</b> (<b>string</b>.<span class="i">Equals</span>(
                            <span class="r151 r">commandAndName</span>.<a href="#bbf25cd4c2b190f4" class="i field">CommandName</a>.<a href="../MshSnapinQualifiedName.cs.html#cb4b6868a9751795" class="i property">ShortName</a>,
                            <span class="r153 r">nextCommandAndName</span>.<a href="#bbf25cd4c2b190f4" class="i field">CommandName</a>.<a href="../MshSnapinQualifiedName.cs.html#cb4b6868a9751795" class="i property">ShortName</a>,
                            <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
                    {
                        <a href="#71519e437e861ebc" class="i method">AddCommandResult</a>(<span class="r151 r">commandAndName</span>, <b>true</b>, <span class="r146 r">completingAtStartOfLine</span>, <span class="r147 r">quote</span>, <span class="r148 r">results</span>);
                        <span class="r150 r">previousMatched</span> = <b>true</b>;
                    }
                    <b>else</b>
                    {
                        <a href="#71519e437e861ebc" class="i method">AddCommandResult</a>(<span class="r151 r">commandAndName</span>, <span class="r150 r">previousMatched</span>, <span class="r146 r">completingAtStartOfLine</span>, <span class="r147 r">quote</span>, <span class="r148 r">results</span>);
                        <span class="r150 r">previousMatched</span> = <b>false</b>;
                    }
 
                    <span class="r149 r">i</span>++;
                }
            }
 
            <span class="k preprocess">#</span><span class="k preprocess">endregion</span> &quot;Handle Command&quot;
 
            <span class="k preprocess">#</span><span class="k preprocess">region</span> &quot;Handle File Names&quot;
 
            <b>internal static</b> <span class="i">List</span>&lt;<a href="CompletionResult.cs.html#a4c553f80d9e648c" class="t t">CompletionResult</a>&gt; <a id="93de54f60c1c3127" href="../../R/93de54f60c1c3127.html" target="n" data-glyph="74,2" class="i method">PSv2GenerateMatchSetOfFiles</a>(<a href="../../utils/PowerShellExecutionHelper.cs.html#4790f0f05d781b55" class="t t">PowerShellExecutionHelper</a> <span id="r154 rd" class="r154 r">helper</span>, <b>string</b> <span id="r155 rd" class="r155 r">lastWord</span>, <b>bool</b> <span id="r156 rd" class="r156 r">completingAtStartOfLine</span>, <b>string</b> <span id="r157 rd" class="r157 r">quote</span>)
            {
                <b>var</b> <span id="r158 rd" class="r158 r">results</span> = <b>new</b> <span class="i">List</span>&lt;<a href="CompletionResult.cs.html#a4c553f80d9e648c" class="t t">CompletionResult</a>&gt;();
 
                <span class="c">// lastWord is treated as an PSPath. The match set includes those items that match that</span>
                <span class="c">// path, namely, the union of:</span>
                <span class="c">//  (S1) the sorted set of items matching the last word</span>
                <span class="c">//  (S2) the sorted set of items matching the last word + *</span>
                <span class="c">// If the last word contains no wildcard characters, then S1 is the empty set.  S1 is always</span>
                <span class="c">// a subset of S2, but we want to present S1 first, then (S2 - S1) next.  The idea is that</span>
                <span class="c">// if the user typed some wildcard characters, they&#39;d prefer to see those matches before</span>
                <span class="c">// all of the rest.</span>
 
                <span class="c">// Determine if we need to quote the paths we parse</span>
 
                <span class="r155 r">lastWord</span> ??= <b>string</b>.<span class="i">Empty</span>;
                <b>bool</b> <span id="r159 rd" class="r159 r">isLastWordEmpty</span> = <b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r155 r">lastWord</span>);
                <b>bool</b> <span id="r160 rd" class="r160 r">lastCharIsStar</span> = !<span class="r159 r">isLastWordEmpty</span> &amp;&amp; <span class="r155 r">lastWord</span>.<span class="i">EndsWith</span>(<span class="s">&#39;*&#39;</span>);
                <b>bool</b> <span id="r161 rd" class="r161 r">containsGlobChars</span> = <a href="../regex.cs.html#d450e739ff28e660" class="t t">WildcardPattern</a>.<a href="../regex.cs.html#f9cf207fdd565080" class="i method">ContainsWildcardCharacters</a>(<span class="r155 r">lastWord</span>);
 
                <b>string</b> <span id="r162 rd" class="r162 r">wildWord</span> = <span class="r155 r">lastWord</span> + <span class="s">&quot;*&quot;</span>;
                <b>bool</b> <span id="r163 rd" class="r163 r">shouldFullyQualifyPaths</span> = <a href="#ea2b835b21baf1d3" class="i method">PSv2ShouldFullyQualifyPathsPath</a>(<span class="r154 r">helper</span>, <span class="r155 r">lastWord</span>);
 
                <span class="c">// NTRAID#Windows Out Of Band Releases-927933-2006/03/13-JeffJon</span>
                <span class="c">// Need to detect when the path is a provider-direct path and make sure</span>
                <span class="c">// to remove the provider-qualifier when the resolved path is returned.</span>
                <b>bool</b> <span id="r164 rd" class="r164 r">isProviderDirectPath</span> = <span class="r155 r">lastWord</span>.<span class="i">StartsWith</span>(<span class="s">@&quot;\\&quot;</span>, <span class="i">StringComparison</span>.<span class="i">Ordinal</span>) ||
                                            <span class="r155 r">lastWord</span>.<span class="i">StartsWith</span>(<span class="s">&quot;//&quot;</span>, <span class="i">StringComparison</span>.<span class="i">Ordinal</span>);
 
                <span class="i">List</span>&lt;<a href="#0a3bf6d425b692a0" class="t t">PathItemAndConvertedPath</a>&gt; <span id="r165 rd" class="r165 r">s1</span> = <b>null</b>;
                <span class="i">List</span>&lt;<a href="#0a3bf6d425b692a0" class="t t">PathItemAndConvertedPath</a>&gt; <span id="r166 rd" class="r166 r">s2</span> = <b>null</b>;
 
                <b>if</b> (<span class="r161 r">containsGlobChars</span> &amp;&amp; !<span class="r159 r">isLastWordEmpty</span>)
                {
                    <span class="r165 r">s1</span> = <a href="#c8ab99c6d4106254" class="i method">PSv2FindMatches</a>(
                            <span class="r154 r">helper</span>,
                            <span class="r155 r">lastWord</span>,
                            <span class="r163 r">shouldFullyQualifyPaths</span>);
                }
 
                <b>if</b> (!<span class="r160 r">lastCharIsStar</span>)
                {
                    <span class="r166 r">s2</span> = <a href="#c8ab99c6d4106254" class="i method">PSv2FindMatches</a>(
                            <span class="r154 r">helper</span>,
                            <span class="r162 r">wildWord</span>,
                            <span class="r163 r">shouldFullyQualifyPaths</span>);
                }
 
                <span class="i">IEnumerable</span>&lt;<a href="#0a3bf6d425b692a0" class="t t">PathItemAndConvertedPath</a>&gt; <span id="r167 rd" class="r167 r">combinedMatches</span> = <a href="#f115508301e32c9a" class="i method">CombineMatchSets</a>(<span class="r165 r">s1</span>, <span class="r166 r">s2</span>);
 
                <b>if</b> (<span class="r167 r">combinedMatches</span> != <b>null</b>)
                {
                    <b>foreach</b> (<b>var</b> <span id="r168 rd" class="r168 r">combinedMatch</span> <b>in</b> <span class="r167 r">combinedMatches</span>)
                    {
                        <b>string</b> <span id="r169 rd" class="r169 r">combinedMatchPath</span> = <a href="../regex.cs.html#d450e739ff28e660" class="t t">WildcardPattern</a>.<span class="i">Escape</span>(<span class="r168 r">combinedMatch</span>.<span class="i">Path</span>);
                        <b>string</b> <span id="r170 rd" class="r170 r">combinedMatchConvertedPath</span> = <a href="../regex.cs.html#d450e739ff28e660" class="t t">WildcardPattern</a>.<span class="i">Escape</span>(<span class="r168 r">combinedMatch</span>.<span class="i">ConvertedPath</span>);
                        <b>string</b> <span id="r171 rd" class="r171 r">completionText</span> = <span class="r164 r">isProviderDirectPath</span> ? <span class="r170 r">combinedMatchConvertedPath</span> : <span class="r169 r">combinedMatchPath</span>;
 
                        <span class="r171 r">completionText</span> = <a href="#62b12cdfd031782d" class="i method">AddQuoteIfNecessary</a>(<span class="r171 r">completionText</span>, <span class="r157 r">quote</span>, <span class="r156 r">completingAtStartOfLine</span>);
 
                        <b>bool</b>? <span id="r172 rd" class="r172 r">isContainer</span> = <span class="i">SafeGetProperty</span>&lt;<b>bool</b>?&gt;(<span class="r168 r">combinedMatch</span>.<span class="i">Item</span>, <span class="s">&quot;PSIsContainer&quot;</span>);
                        <b>string</b> <span id="r173 rd" class="r173 r">childName</span> = <span class="i">SafeGetProperty</span>&lt;<b>string</b>&gt;(<span class="r168 r">combinedMatch</span>.<span class="i">Item</span>, <span class="s">&quot;PSChildName&quot;</span>);
                        <b>string</b> <span id="r174 rd" class="r174 r">toolTip</span> = <a href="../../utils/PowerShellExecutionHelper.cs.html#4790f0f05d781b55" class="t t">PowerShellExecutionHelper</a>.<span class="i">SafeToString</span>(<span class="r168 r">combinedMatch</span>.<span class="i">ConvertedPath</span>);
 
                        <b>if</b> (<span class="r172 r">isContainer</span> != <b>null</b> &amp;&amp; <span class="r173 r">childName</span> != <b>null</b> &amp;&amp; <span class="r174 r">toolTip</span> != <b>null</b>)
                        {
                            <a href="CompletionResult.cs.html#3cfd90a9cdb70973" class="t t">CompletionResultType</a> <span id="r175 rd" class="r175 r">resultType</span> = <span class="r172 r">isContainer</span>.<span class="i">Value</span>
                                                                  ? <a href="CompletionResult.cs.html#3cfd90a9cdb70973" class="t t">CompletionResultType</a>.<a href="CompletionResult.cs.html#f4f151a5480e81af" class="i field">ProviderContainer</a>
                                                                  : <a href="CompletionResult.cs.html#3cfd90a9cdb70973" class="t t">CompletionResultType</a>.<a href="CompletionResult.cs.html#14b0f548feb1e82f" class="i field">ProviderItem</a>;
                            <span class="r158 r">results</span>.<span class="i">Add</span>(<b>new</b> <a href="CompletionResult.cs.html#ca2afdd6b4929db6" class="t constructor">CompletionResult</a>(<span class="r171 r">completionText</span>, <span class="r173 r">childName</span>, <span class="r175 r">resultType</span>, <span class="r174 r">toolTip</span>));
                        }
                    }
                }
 
                <b>return</b> <span class="r158 r">results</span>;
            }
 
            <b>private static string</b> <a id="62b12cdfd031782d" href="../../R/62b12cdfd031782d.html" target="n" data-glyph="76,2" class="i method">AddQuoteIfNecessary</a>(<b>string</b> <span id="r176 rd" class="r176 r">completionText</span>, <b>string</b> <span id="r177 rd" class="r177 r">quote</span>, <b>bool</b> <span id="r178 rd" class="r178 r">completingAtStartOfLine</span>)
            {
                <b>if</b> (<span class="r176 r">completionText</span>.<span class="i">IndexOfAny</span>(<a href="#c99e7a91dd9212d8" class="i field">s_charsRequiringQuotedString</a>) != -1)
                {
                    <b>bool</b> <span id="r179 rd" class="r179 r">needAmpersand</span> = <span class="r177 r">quote</span>.<span class="i">Length</span> == 0 &amp;&amp; <span class="r178 r">completingAtStartOfLine</span>;
                    <b>string</b> <span id="r180 rd" class="r180 r">quoteInUse</span> = <span class="r177 r">quote</span>.<span class="i">Length</span> == 0 ? <span class="s">&quot;&#39;&quot;</span> : <span class="r177 r">quote</span>;
                    <span class="r176 r">completionText</span> = <span class="r180 r">quoteInUse</span> == <span class="s">&quot;&#39;&quot;</span> ? <span class="r176 r">completionText</span>.<span class="i">Replace</span>(<span class="s">&quot;&#39;&quot;</span>, <span class="s">&quot;&#39;&#39;&quot;</span>) : <span class="r176 r">completionText</span>;
                    <span class="r176 r">completionText</span> = <span class="r180 r">quoteInUse</span> + <span class="r176 r">completionText</span> + <span class="r180 r">quoteInUse</span>;
                    <span class="r176 r">completionText</span> = <span class="r179 r">needAmpersand</span> ? <span class="s">&quot;&amp; &quot;</span> + <span class="r176 r">completionText</span> : <span class="r176 r">completionText</span>;
                }
                <b>else</b>
                {
                    <span class="r176 r">completionText</span> = <span class="r177 r">quote</span> + <span class="r176 r">completionText</span> + <span class="r177 r">quote</span>;
                }
 
                <b>return</b> <span class="r176 r">completionText</span>;
            }
 
            <b>private static</b> <span class="i">IEnumerable</span>&lt;<a href="#0a3bf6d425b692a0" class="t t">PathItemAndConvertedPath</a>&gt; <a id="f115508301e32c9a" href="../../R/f115508301e32c9a.html" target="n" data-glyph="76,2" class="i method">CombineMatchSets</a>(<span class="i">List</span>&lt;<a href="#0a3bf6d425b692a0" class="t t">PathItemAndConvertedPath</a>&gt; <span id="r181 rd" class="r181 r">s1</span>, <span class="i">List</span>&lt;<a href="#0a3bf6d425b692a0" class="t t">PathItemAndConvertedPath</a>&gt; <span id="r182 rd" class="r182 r">s2</span>)
            {
                <b>if</b> (<span class="r181 r">s1</span> == <b>null</b> || <span class="r181 r">s1</span>.<span class="i">Count</span> &lt; 1)
                {
                    <span class="c">// only s2 contains results; which may be null or empty</span>
                    <b>return</b> <span class="r182 r">s2</span>;
                }
 
                <b>if</b> (<span class="r182 r">s2</span> == <b>null</b> || <span class="r182 r">s2</span>.<span class="i">Count</span> &lt; 1)
                {
                    <span class="c">// only s1 contains results</span>
                    <b>return</b> <span class="r181 r">s1</span>;
                }
 
                <span class="c">// s1 and s2 contain results</span>
                <a href="../../utils/assert.cs.html#c04955255430d32f" class="t t">Diagnostics</a>.<a href="../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r181 r">s1</span> != <b>null</b> &amp;&amp; <span class="r181 r">s1</span>.<span class="i">Count</span> &gt; 0, <span class="s">&quot;s1 should have results&quot;</span>);
                <a href="../../utils/assert.cs.html#c04955255430d32f" class="t t">Diagnostics</a>.<a href="../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r182 r">s2</span> != <b>null</b> &amp;&amp; <span class="r182 r">s2</span>.<span class="i">Count</span> &gt; 0, <span class="s">&quot;if s1 has results, s2 must also&quot;</span>);
                <a href="../../utils/assert.cs.html#c04955255430d32f" class="t t">Diagnostics</a>.<a href="../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r181 r">s1</span>.<span class="i">Count</span> &lt;= <span class="r182 r">s2</span>.<span class="i">Count</span>, <span class="s">&quot;s2 should always be larger than s1&quot;</span>);
 
                <b>var</b> <span id="r183 rd" class="r183 r">result</span> = <b>new</b> <span class="i">List</span>&lt;<a href="#0a3bf6d425b692a0" class="t t">PathItemAndConvertedPath</a>&gt;();
 
                <span class="c">// we need to remove from s2 those items in s1.  Since the results from FindMatches will be sorted,</span>
                <span class="c">// just copy out the unique elements from s2 and s1.  We know that every element of S1 will be in S2,</span>
                <span class="c">// so the result set will be S1 + (S2 - S1), which is the same size as S2.</span>
                <span class="r183 r">result</span>.<span class="i">AddRange</span>(<span class="r181 r">s1</span>);
                <b>for</b> (<b>int</b> <span id="r184 rd" class="r184 r">i</span> = 0, <span id="r185 rd" class="r185 r">j</span> = 0; <span class="r184 r">i</span> &lt; <span class="r182 r">s2</span>.<span class="i">Count</span>; ++<span class="r184 r">i</span>)
                {
                    <b>if</b> (<span class="r185 r">j</span> &lt; <span class="r181 r">s1</span>.<span class="i">Count</span> &amp;&amp; <b>string</b>.<span class="i">Equals</span>(<span class="r182 r">s2</span>[<span class="r184 r">i</span>].<span class="i">Path</span>, <span class="r181 r">s1</span>[<span class="r185 r">j</span>].<span class="i">Path</span>, <span class="i">StringComparison</span>.<span class="i">CurrentCultureIgnoreCase</span>))
                    {
                        ++<span class="r185 r">j</span>;
                        <b>continue</b>;
                    }
 
                    <span class="r183 r">result</span>.<span class="i">Add</span>(<span class="r182 r">s2</span>[<span class="r184 r">i</span>]);
                }
 
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">DEBUG</span>
                <a href="../../utils/assert.cs.html#c04955255430d32f" class="t t">Diagnostics</a>.<a href="../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r183 r">result</span>.<span class="i">Count</span> == <span class="r182 r">s2</span>.<span class="i">Count</span>, <span class="s">&quot;result should be the same size as s2, see the size comment above&quot;</span>);
                <b>for</b> (<b>int</b> <span id="r186 rd" class="r186 r">i</span> = 0; <span class="r186 r">i</span> &lt; <span class="r181 r">s1</span>.<span class="i">Count</span>; ++<span class="r186 r">i</span>)
                {
                    <b>string</b> <span id="r187 rd" class="r187 r">path</span> = <span class="r183 r">result</span>[<span class="r186 r">i</span>].<span class="i">Path</span>;
                    <b>int</b> <span id="r188 rd" class="r188 r">j</span> = <span class="r183 r">result</span>.<span class="i">FindLastIndex</span>(<span id="r189 rd" class="r189 r">item</span> =&gt; <span class="r189 r">item</span>.<span class="i">Path</span> == <span class="r187 r">path</span>);
                    <a href="../../utils/assert.cs.html#c04955255430d32f" class="t t">Diagnostics</a>.<a href="../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r188 r">j</span> == <span class="r186 r">i</span>, <span class="s">&quot;elements of s1 should only come at the start of the results&quot;</span>);
                }
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
                <b>return</b> <span class="r183 r">result</span>;
            }
 
            <b>private static</b> <span class="r190 r t">T</span> <a id="2d675dd8311bf72f" href="../../R/2d675dd8311bf72f.html" target="n" data-glyph="76,2" class="i method">SafeGetProperty</a>&lt;<span id="r190 rd t" class="r190 r t">T</span>&gt;(<a href="../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r191 rd" class="r191 r">psObject</span>, <b>string</b> <span id="r192 rd" class="r192 r">propertyName</span>)
            {
                <b>if</b> (<span class="r191 r">psObject</span> == <b>null</b>)
                {
                    <b>return</b> <b>default</b>(<span class="r190 r t">T</span>);
                }
 
                <a href="../MshMemberInfo.cs.html#13ab3796654e613c" class="t t">PSPropertyInfo</a> <span id="r193 rd" class="r193 r">property</span> = <span class="r191 r">psObject</span>.<a href="../MshObject.cs.html#59e9cd1ad57ccd34" class="i property">Properties</a><a href="../MshMemberInfo.cs.html#f603b32aa49d3ffa">[</a><span class="r192 r">propertyName</span>];
                <b>if</b> (<span class="r193 r">property</span> == <b>null</b>)
                {
                    <b>return</b> <b>default</b>(<span class="r190 r t">T</span>);
                }
 
                <b>object</b> <span id="r194 rd" class="r194 r">propertyValue</span> = <span class="r193 r">property</span>.<a href="../MshMemberInfo.cs.html#cd3a9989baedf3dd" class="i property">Value</a>;
                <b>if</b> (<span class="r194 r">propertyValue</span> == <b>null</b>)
                {
                    <b>return</b> <b>default</b>(<span class="r190 r t">T</span>);
                }
 
                <span class="r190 r t">T</span> <span id="r195 rd" class="r195 r">returnValue</span>;
                <b>if</b> (<a href="../LanguagePrimitives.cs.html#6dac09d64da9900c" class="t t">LanguagePrimitives</a>.<a href="../LanguagePrimitives.cs.html#0ba3f8cd03b35aee" class="i method">TryConvertTo</a>(<span class="r194 r">propertyValue</span>, <b>out</b> <span class="r195 r">returnValue</span>))
                {
                    <b>return</b> <span class="r195 r">returnValue</span>;
                }
 
                <b>return</b> <b>default</b>(<span class="r190 r t">T</span>);
            }
 
            <b>private static bool</b> <a id="ea2b835b21baf1d3" href="../../R/ea2b835b21baf1d3.html" target="n" data-glyph="76,2" class="i method">PSv2ShouldFullyQualifyPathsPath</a>(<a href="../../utils/PowerShellExecutionHelper.cs.html#4790f0f05d781b55" class="t t">PowerShellExecutionHelper</a> <span id="r196 rd" class="r196 r">helper</span>, <b>string</b> <span id="r197 rd" class="r197 r">lastWord</span>)
            {
                <span class="c">// These are special cases, as they represent cases where the user expects to</span>
                <span class="c">// see the full path.</span>
                <b>if</b> (<span class="r197 r">lastWord</span>.<span class="i">StartsWith</span>(<span class="s">&#39;~&#39;</span>) ||
                    <span class="r197 r">lastWord</span>.<span class="i">StartsWith</span>(<span class="s">&#39;\\&#39;</span>) ||
                    <span class="r197 r">lastWord</span>.<span class="i">StartsWith</span>(<span class="s">&#39;/&#39;</span>))
                {
                    <b>return</b> <b>true</b>;
                }
 
                <span class="r196 r">helper</span>.<a href="../../utils/PowerShellExecutionHelper.cs.html#ddb7ad1950c8ea20" class="i property">CurrentPowerShell</a>
                    .<a href="../hostifaces/PowerShell.cs.html#9cc79c297f6cced9" class="i method">AddCommand</a>(<span class="s">&quot;Split-Path&quot;</span>)
                    .<a href="../hostifaces/PowerShell.cs.html#40674f99a3618f4b" class="i method">AddParameter</a>(<span class="s">&quot;Path&quot;</span>, <span class="r197 r">lastWord</span>)
                    .<a href="../hostifaces/PowerShell.cs.html#40674f99a3618f4b" class="i method">AddParameter</a>(<span class="s">&quot;IsAbsolute&quot;</span>, <b>true</b>);
 
                <b>bool</b> <span id="r198 rd" class="r198 r">isAbsolute</span> = <span class="r196 r">helper</span>.<a href="../../utils/PowerShellExecutionHelper.cs.html#f53cb46b802e54be" class="i method">ExecuteCommandAndGetResultAsBool</a>();
                <b>return</b> <span class="r198 r">isAbsolute</span>;
            }
 
            <b>private readonly struct</b> <a id="0a3bf6d425b692a0" href="../../R/0a3bf6d425b692a0.html" target="n" data-glyph="112,2" class="t t"><span id="a0e26db2f9ece870">PathItemAndConvertedPath</span></a>
            {
                <b>internal readonly string</b> <a id="5c2a9647bcf16a98" href="../../R/5c2a9647bcf16a98.html" target="n" data-glyph="44,3" class="i field">Path</a>;
                <b>internal readonly</b> <a href="../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <a id="fb8a7c4f449fca9b" href="../../R/fb8a7c4f449fca9b.html" target="n" data-glyph="44,3" class="i field">Item</a>;
                <b>internal readonly string</b> <a id="9191e9af1e47991d" href="../../R/9191e9af1e47991d.html" target="n" data-glyph="44,3" class="i field">ConvertedPath</a>;
 
                <b>internal</b> <a id="9db3f535c3d255e4" href="../../R/9db3f535c3d255e4.html" target="n" data-glyph="74,3" class="t constructor">PathItemAndConvertedPath</a>(<b>string</b> <span id="r199 rd" class="r199 r">path</span>, <a href="../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r200 rd" class="r200 r">item</span>, <b>string</b> <span id="r201 rd" class="r201 r">convertedPath</span>)
                {
                    <a href="#0a3bf6d425b692a0" class="k">this</a>.<a href="#5c2a9647bcf16a98" class="i field">Path</a> = <span class="r199 r">path</span>;
                    <a href="#0a3bf6d425b692a0" class="k">this</a>.<a href="#fb8a7c4f449fca9b" class="i field">Item</a> = <span class="r200 r">item</span>;
                    <a href="#0a3bf6d425b692a0" class="k">this</a>.<a href="#9191e9af1e47991d" class="i field">ConvertedPath</a> = <span class="r201 r">convertedPath</span>;
                }
            }
 
            <b>private static</b> <span class="i">List</span>&lt;<a href="#0a3bf6d425b692a0" class="t t">PathItemAndConvertedPath</a>&gt; <a id="c8ab99c6d4106254" href="../../R/c8ab99c6d4106254.html" target="n" data-glyph="76,2" class="i method">PSv2FindMatches</a>(<a href="../../utils/PowerShellExecutionHelper.cs.html#4790f0f05d781b55" class="t t">PowerShellExecutionHelper</a> <span id="r202 rd" class="r202 r">helper</span>, <b>string</b> <span id="r203 rd" class="r203 r">path</span>, <b>bool</b> <span id="r204 rd" class="r204 r">shouldFullyQualifyPaths</span>)
            {
                <a href="../../utils/assert.cs.html#c04955255430d32f" class="t t">Diagnostics</a>.<span class="i">Assert</span>(!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r203 r">path</span>), <span class="s">&quot;path should have a value&quot;</span>);
                <b>var</b> <span id="r205 rd" class="r205 r">result</span> = <b>new</b> <span class="i">List</span>&lt;<a href="#0a3bf6d425b692a0" class="t t">PathItemAndConvertedPath</a>&gt;();
 
                <span class="i">Exception</span> <span id="r206 rd" class="r206 r">exceptionThrown</span>;
                <a href="../hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShell</a> <span id="r207 rd" class="r207 r">powershell</span> = <span class="r202 r">helper</span>.<a href="../../utils/PowerShellExecutionHelper.cs.html#ddb7ad1950c8ea20" class="i property">CurrentPowerShell</a>;
 
                <span class="c">// It&#39;s OK to use script, since tab completion is useless when the remote Win7 machine is in nolanguage mode</span>
                <b>if</b> (!<span class="r204 r">shouldFullyQualifyPaths</span>)
                {
                    <span class="r207 r">powershell</span>.<span class="i">AddScript</span>(<b>string</b>.<span class="i">Format</span>(
                        <span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>,
                        <span class="s">&quot;&amp; {{ trap {{ continue }} ; resolve-path {0} -Relative -WarningAction SilentlyContinue | ForEach-Object {{,($_,(get-item $_ -WarningAction SilentlyContinue),(convert-path $_ -WarningAction SilentlyContinue))}} }}&quot;</span>,
                        <span class="r203 r">path</span>));
                }
                <b>else</b>
                {
                    <span class="r207 r">powershell</span>.<span class="i">AddScript</span>(<b>string</b>.<span class="i">Format</span>(
                        <span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>,
                        <span class="s">&quot;&amp; {{ trap {{ continue }} ; resolve-path {0} -WarningAction SilentlyContinue | ForEach-Object {{,($_,(get-item $_ -WarningAction SilentlyContinue),(convert-path $_ -WarningAction SilentlyContinue))}} }}&quot;</span>,
                        <span class="r203 r">path</span>));
                }
 
                <span class="i">Collection</span>&lt;<a href="../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt; <span id="r208 rd" class="r208 r">paths</span> = <span class="r202 r">helper</span>.<a href="../../utils/PowerShellExecutionHelper.cs.html#ca353a51989cf3bd" class="i method">ExecuteCurrentPowerShell</a>(<b>out</b> <span class="r206 r">exceptionThrown</span>);
                <b>if</b> (<span class="r208 r">paths</span> == <b>null</b> || <span class="r208 r">paths</span>.<span class="i">Count</span> == 0)
                {
                    <b>return</b> <b>null</b>;
                }
 
                <b>foreach</b> (<a href="../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r209 rd" class="r209 r">t</span> <b>in</b> <span class="r208 r">paths</span>)
                {
                    <b>var</b> <span id="r210 rd" class="r210 r">pathsArray</span> = <span class="r209 r">t</span>.<a href="../MshObject.cs.html#d854d13536b70a12" class="i property">BaseObject</a> <b>as</b> <span class="i">IList</span>;
                    <b>if</b> (<span class="r210 r">pathsArray</span> != <b>null</b> &amp;&amp; <span class="r210 r">pathsArray</span>.<span class="i">Count</span> == 3)
                    {
                        <b>object</b> <span id="r211 rd" class="r211 r">objectPath</span> = <span class="r210 r">pathsArray</span>[0];
                        <a href="../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r212 rd" class="r212 r">item</span> = <span class="r210 r">pathsArray</span>[1] <b>as</b> <a href="../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>;
                        <b>object</b> <span id="r213 rd" class="r213 r">convertedPath</span> = <span class="r210 r">pathsArray</span>[1];
 
                        <b>if</b> (<span class="r211 r">objectPath</span> == <b>null</b> || <span class="r212 r">item</span> == <b>null</b> || <span class="r213 r">convertedPath</span> == <b>null</b>)
                        {
                            <b>continue</b>;
                        }
 
                        <span class="r205 r">result</span>.<span class="i">Add</span>(<b>new</b> <a href="#9db3f535c3d255e4" class="t constructor">PathItemAndConvertedPath</a>(
                                            <a href="../../utils/PowerShellExecutionHelper.cs.html#4790f0f05d781b55" class="t t">PowerShellExecutionHelper</a>.<a href="../../utils/PowerShellExecutionHelper.cs.html#35fd3d0195d41d5d" class="i method">SafeToString</a>(<span class="r211 r">objectPath</span>),
                                            <span class="r212 r">item</span>,
                                            <a href="../../utils/PowerShellExecutionHelper.cs.html#4790f0f05d781b55" class="t t">PowerShellExecutionHelper</a>.<a href="../../utils/PowerShellExecutionHelper.cs.html#35fd3d0195d41d5d" class="i method">SafeToString</a>(<span class="r213 r">convertedPath</span>)));
                    }
                }
 
                <b>if</b> (<span class="r205 r">result</span>.<span class="i">Count</span> == 0)
                {
                    <b>return</b> <b>null</b>;
                }
 
                <span class="r205 r">result</span>.<span class="i">Sort</span>((<a href="#0a3bf6d425b692a0" class="t t">PathItemAndConvertedPath</a> <span id="r214 rd" class="r214 r">x</span>, <a href="#0a3bf6d425b692a0" class="t t">PathItemAndConvertedPath</a> <span id="r215 rd" class="r215 r">y</span>) =&gt;
                {
                    <a href="../../utils/assert.cs.html#c04955255430d32f" class="t t">Diagnostics</a>.<a href="../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r214 r">x</span>.<a href="#5c2a9647bcf16a98" class="i field">Path</a> != <b>null</b> &amp;&amp; <span class="r215 r">y</span>.<a href="#5c2a9647bcf16a98" class="i field">Path</a> != <b>null</b>, <span class="s">&quot;SafeToString always returns a non-null string&quot;</span>);
                    <b>return</b> <b>string</b>.<span class="i">Compare</span>(<span class="r214 r">x</span>.<a href="#5c2a9647bcf16a98" class="i field">Path</a>, <span class="r215 r">y</span>.<a href="#5c2a9647bcf16a98" class="i field">Path</a>, <span class="i">StringComparison</span>.<span class="i">CurrentCultureIgnoreCase</span>);
                });
 
                <b>return</b> <span class="r205 r">result</span>;
            }
 
            <span class="k preprocess">#</span><span class="k preprocess">endregion</span> &quot;Handle File Names&quot;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> LastWordFinder implements the algorithm we use to search for the last word in a line of input taken from the console.</span>
        <span class="c">///</span><span class="c"> This class exists for legacy purposes only - V3 and forward uses a slightly different interface.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private sealed class</b> <a id="c7a495428c48ad16" href="../../R/c7a495428c48ad16.html" target="n" data-glyph="4,1" class="t t">LastWordFinder</a>
        {
            <b>internal static string</b> <a id="3d6795c3bea2de0f" href="../../R/../../0000000000.html" target="n" data-glyph="74,2" class="i method">FindLastWord</a>(<b>string</b> <span id="r216 rd" class="r216 r">sentence</span>, <b>out int</b> <span id="r217 rd" class="r217 r">replacementIndexOut</span>, <b>out char</b> <span id="r218 rd" class="r218 r">closingQuote</span>)
            {
                <b>return</b> (<b>new</b> <a href="#20a113e2a349d108" class="t constructor">LastWordFinder</a>(<span class="r216 r">sentence</span>)).<a href="#0445d2acaa0f3500" class="i method">FindLastWord</a>(<b>out</b> <span class="r217 r">replacementIndexOut</span>, <b>out</b> <span class="r218 r">closingQuote</span>);
            }
 
            <b>private</b> <a id="20a113e2a349d108" href="../../R/20a113e2a349d108.html" target="n" data-glyph="76,2" class="t constructor">LastWordFinder</a>(<b>string</b> <span id="r219 rd" class="r219 r">sentence</span>)
            {
                <a href="#1a9164be70c4a5ae" class="i field">_replacementIndex</a> = 0;
                <a href="../../utils/assert.cs.html#c04955255430d32f" class="t t">Diagnostics</a>.<a href="../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r219 r">sentence</span> != <b>null</b>, <span class="s">&quot;need to provide an instance&quot;</span>);
                <a href="#91f08bc48edba3e3" class="i field">_sentence</a> = <span class="r219 r">sentence</span>;
            }
 
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> Locates the last &quot;word&quot; in a string of text.  A word is a conguous sequence of characters that are not</span>
            <span class="c">///</span><span class="c"> whitespace, or a contiguous set grouped by single or double quotes.  Can be called by at most 1 thread at a time</span>
            <span class="c">///</span><span class="c"> per LastWordFinder instance.</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r220 r">replacementIndexOut</span><span class="c">&quot;</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> Receives the character index (from the front of the string) of the starting point of the located word, or 0 if</span>
            <span class="c">///</span><span class="c"> the word starts at the beginning of the sentence.</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r221 r">closingQuote</span><span class="c">&quot;</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> Receives the quote character that would be needed to end the sentence with a balanced pair of quotes.  For</span>
            <span class="c">///</span><span class="c"> instance, if sentence is &quot;foo then &quot; is returned, if sentence if &quot;foo&quot; then nothing is returned, if sentence is</span>
            <span class="c">///</span><span class="c"> &#39;foo then &#39; is returned, if sentence is &#39;foo&#39; then nothing is returned.</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">The last word located, or the empty string if no word could be found.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
            <b>private string</b> <a id="0445d2acaa0f3500" href="../../R/0445d2acaa0f3500.html" target="n" data-glyph="76,2" class="i method">FindLastWord</a>(<b>out int</b> <span id="r220 rd" class="r220 r">replacementIndexOut</span>, <b>out char</b> <span id="r221 rd" class="r221 r">closingQuote</span>)
            {
                <b>bool</b> <span id="r222 rd" class="r222 r">inSingleQuote</span> = <b>false</b>;
                <b>bool</b> <span id="r223 rd" class="r223 r">inDoubleQuote</span> = <b>false</b>;
 
                <a href="#5693dddbfe2821f0" class="i property">ReplacementIndex</a> = 0;
 
                <b>for</b> (<a href="#877d79025b6c7993" class="i field">_sentenceIndex</a> = 0; <a href="#877d79025b6c7993" class="i field">_sentenceIndex</a> &lt; <a href="#91f08bc48edba3e3" class="i field">_sentence</a>.<span class="i">Length</span>; ++<a href="#877d79025b6c7993" class="i field">_sentenceIndex</a>)
                {
                    <a href="../../utils/assert.cs.html#c04955255430d32f" class="t t">Diagnostics</a>.<span class="i">Assert</span>(!(<span class="r222 r">inSingleQuote</span> &amp;&amp; <span class="r223 r">inDoubleQuote</span>),
                        <span class="s">&quot;Can&#39;t be in both single and double quotes&quot;</span>);
 
                    <b>char</b> <span id="r224 rd" class="r224 r">c</span> = <a href="#91f08bc48edba3e3" class="i field">_sentence</a>[<a href="#877d79025b6c7993" class="i field">_sentenceIndex</a>];
 
                    <span class="c">// there are 3 possibilities:</span>
                    <span class="c">// 1) a new sequence is starting,</span>
                    <span class="c">// 2) a sequence is ending, or</span>
                    <span class="c">// 3) a sequence is due to end on the next matching quote, end-of-sentence, or whitespace</span>
 
                    <b>if</b> (<span class="r224 r">c</span> == <span class="s">&#39;\&#39;&#39;</span>)
                    {
                        <a href="#1992c45b87f56d96" class="i method">HandleQuote</a>(<b>ref</b> <span class="r222 r">inSingleQuote</span>, <b>ref</b> <span class="r223 r">inDoubleQuote</span>, <span class="r224 r">c</span>);
                    }
                    <b>else</b> <b>if</b> (<span class="r224 r">c</span> == <span class="s">&#39;&quot;&#39;</span>)
                    {
                        <a href="#1992c45b87f56d96" class="i method">HandleQuote</a>(<b>ref</b> <span class="r223 r">inDoubleQuote</span>, <b>ref</b> <span class="r222 r">inSingleQuote</span>, <span class="r224 r">c</span>);
                    }
                    <b>else</b> <b>if</b> (<span class="r224 r">c</span> == <span class="s">&#39;`&#39;</span>)
                    {
                        <a href="#57d5680857be7b1a" class="i method">Consume</a>(<span class="r224 r">c</span>);
                        <b>if</b> (++<a href="#877d79025b6c7993" class="i field">_sentenceIndex</a> &lt; <a href="#91f08bc48edba3e3" class="i field">_sentence</a>.<span class="i">Length</span>)
                        {
                            <span class="i">Consume</span>(<a href="#91f08bc48edba3e3" class="i field">_sentence</a>[<a href="#877d79025b6c7993" class="i field">_sentenceIndex</a>]);
                        }
                    }
                    <b>else</b> <b>if</b> (<a href="#9550e312784801ca" class="i method">IsWhitespace</a>(<span class="r224 r">c</span>))
                    {
                        <b>if</b> (<a href="#fa092bc893837df5" class="i field">_sequenceDueToEnd</a>)
                        {
                            <span class="c">// we skipped a quote earlier, now end that sequence</span>
 
                            <a href="#fa092bc893837df5" class="i field">_sequenceDueToEnd</a> = <b>false</b>;
                            <b>if</b> (<span class="r222 r">inSingleQuote</span>)
                            {
                                <span class="r222 r">inSingleQuote</span> = <b>false</b>;
                            }
 
                            <b>if</b> (<span class="r223 r">inDoubleQuote</span>)
                            {
                                <span class="r223 r">inDoubleQuote</span> = <b>false</b>;
                            }
 
                            <a href="#5693dddbfe2821f0" class="i property">ReplacementIndex</a> = <a href="#877d79025b6c7993" class="i field">_sentenceIndex</a> + 1;
                        }
                        <b>else</b> <b>if</b> (<span class="r222 r">inSingleQuote</span> || <span class="r223 r">inDoubleQuote</span>)
                        {
                            <span class="c">// a sequence is started and we&#39;re in quotes</span>
 
                            <a href="#57d5680857be7b1a" class="i method">Consume</a>(<span class="r224 r">c</span>);
                        }
                        <b>else</b>
                        {
                            <span class="c">// no sequence is started, so ignore c</span>
 
                            <a href="#5693dddbfe2821f0" class="i property">ReplacementIndex</a> = <a href="#877d79025b6c7993" class="i field">_sentenceIndex</a> + 1;
                        }
                    }
                    <b>else</b>
                    {
                        <span class="c">// a sequence is started and we&#39;re in it</span>
 
                        <a href="#57d5680857be7b1a" class="i method">Consume</a>(<span class="r224 r">c</span>);
                    }
                }
 
                <b>string</b> <span id="r225 rd" class="r225 r">result</span> = <b>new</b> <b>string</b>(<a href="#a0a577ab3f7b2071" class="i field">_wordBuffer</a>, 0, <a href="#2e80ef1ee0dd8c9b" class="i field">_wordBufferIndex</a>);
 
                <span class="r221 r">closingQuote</span> = <span class="r222 r">inSingleQuote</span> ? <span class="s">&#39;\&#39;&#39;</span> : <span class="r223 r">inDoubleQuote</span> ? <span class="s">&#39;&quot;&#39;</span> : <span class="s">&#39;\0&#39;</span>;
                <span class="r220 r">replacementIndexOut</span> = <a href="#5693dddbfe2821f0" class="i property">ReplacementIndex</a>;
                <b>return</b> <span class="r225 r">result</span>;
            }
 
            <b>private void</b> <a id="1992c45b87f56d96" href="../../R/1992c45b87f56d96.html" target="n" data-glyph="76,2" class="i method">HandleQuote</a>(<b>ref bool</b> <span id="r226 rd" class="r226 r">inQuote</span>, <b>ref bool</b> <span id="r227 rd" class="r227 r">inOppositeQuote</span>, <b>char</b> <span id="r228 rd" class="r228 r">c</span>)
            {
                <b>if</b> (<span class="r227 r">inOppositeQuote</span>)
                {
                    <span class="c">// a sequence is started, and we&#39;re in it.</span>
                    <a href="#57d5680857be7b1a" class="i method">Consume</a>(<span class="r228 r">c</span>);
                    <b>return</b>;
                }
 
                <b>if</b> (<span class="r226 r">inQuote</span>)
                {
                    <b>if</b> (<a href="#fa092bc893837df5" class="i field">_sequenceDueToEnd</a>)
                    {
                        <span class="c">// I&#39;ve ended a sequence and am starting another; don&#39;t consume c, update replacementIndex</span>
                        <a href="#5693dddbfe2821f0" class="i property">ReplacementIndex</a> = <a href="#877d79025b6c7993" class="i field">_sentenceIndex</a> + 1;
                    }
 
                    <a href="#fa092bc893837df5" class="i field">_sequenceDueToEnd</a> = !<a href="#fa092bc893837df5" class="i field">_sequenceDueToEnd</a>;
                }
                <b>else</b>
                {
                    <span class="c">// I&#39;m starting a sequence; don&#39;t consume c, update replacementIndex</span>
                    <span class="r226 r">inQuote</span> = <b>true</b>;
                    <a href="#5693dddbfe2821f0" class="i property">ReplacementIndex</a> = <a href="#877d79025b6c7993" class="i field">_sentenceIndex</a>;
                }
            }
 
            <b>private void</b> <a id="57d5680857be7b1a" href="../../R/57d5680857be7b1a.html" target="n" data-glyph="76,2" class="i method">Consume</a>(<b>char</b> <span id="r229 rd" class="r229 r">c</span>)
            {
                <a href="../../utils/assert.cs.html#c04955255430d32f" class="t t">Diagnostics</a>.<a href="../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<a href="#a0a577ab3f7b2071" class="i field">_wordBuffer</a> != <b>null</b>, <span class="s">&quot;wordBuffer is not initialized&quot;</span>);
                <a href="../../utils/assert.cs.html#c04955255430d32f" class="t t">Diagnostics</a>.<a href="../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<a href="#2e80ef1ee0dd8c9b" class="i field">_wordBufferIndex</a> &lt; <a href="#a0a577ab3f7b2071" class="i field">_wordBuffer</a>.<span class="i">Length</span>, <span class="s">&quot;wordBufferIndex is out of range&quot;</span>);
 
                <a href="#a0a577ab3f7b2071" class="i field">_wordBuffer</a>[<a href="#2e80ef1ee0dd8c9b" class="i field">_wordBufferIndex</a>++] = <span class="r229 r">c</span>;
            }
 
            <b>private int</b> <a id="5693dddbfe2821f0" href="../../R/5693dddbfe2821f0.html" target="n" data-glyph="106,2" class="i property">ReplacementIndex</a>
            {
                <b>get</b>
                {
                    <b>return</b> <a href="#1a9164be70c4a5ae" class="i field">_replacementIndex</a>;
                }
 
                <b>set</b>
                {
                    <a href="../../utils/assert.cs.html#c04955255430d32f" class="t t">Diagnostics</a>.<a href="../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<b>value</b> &gt;= 0 &amp;&amp; <b>value</b> &lt; <a href="#91f08bc48edba3e3" class="i field">_sentence</a>.<span class="i">Length</span> + 1, <span class="s">&quot;value out of range&quot;</span>);
 
                    <span class="c">// when we set the replacement index, that means we&#39;re also resetting our word buffer. we know wordBuffer</span>
                    <span class="c">// will never be longer than sentence.</span>
 
                    <a href="#a0a577ab3f7b2071" class="i field">_wordBuffer</a> = <b>new</b> <b>char</b>[<a href="#91f08bc48edba3e3" class="i field">_sentence</a>.<span class="i">Length</span>];
                    <a href="#2e80ef1ee0dd8c9b" class="i field">_wordBufferIndex</a> = 0;
                    <a href="#1a9164be70c4a5ae" class="i field">_replacementIndex</a> = <b>value</b>;
                }
            }
 
            <b>private static bool</b> <a id="9550e312784801ca" href="../../R/9550e312784801ca.html" target="n" data-glyph="76,2" class="i method">IsWhitespace</a>(<b>char</b> <span id="r230 rd" class="r230 r">c</span>)
            {
                <b>return</b> (<span class="r230 r">c</span> == <span class="s">&#39; &#39;</span>) || (<span class="r230 r">c</span> == <span class="s">&#39;\x0009&#39;</span>);
            }
 
            <b>private readonly string</b> <a id="91f08bc48edba3e3" href="../../R/91f08bc48edba3e3.html" target="n" data-glyph="46,2" class="i field">_sentence</a>;
            <b>private char</b>[] <a id="a0a577ab3f7b2071" href="../../R/a0a577ab3f7b2071.html" target="n" data-glyph="46,2" class="i field">_wordBuffer</a>;
            <b>private int</b> <a id="2e80ef1ee0dd8c9b" href="../../R/2e80ef1ee0dd8c9b.html" target="n" data-glyph="46,2" class="i field">_wordBufferIndex</a>;
            <b>private int</b> <a id="1a9164be70c4a5ae" href="../../R/1a9164be70c4a5ae.html" target="n" data-glyph="46,2" class="i field">_replacementIndex</a>;
            <b>private int</b> <a id="877d79025b6c7993" href="../../R/877d79025b6c7993.html" target="n" data-glyph="46,2" class="i field">_sentenceIndex</a>;
            <b>private bool</b> <a id="fa092bc893837df5" href="../../R/fa092bc893837df5.html" target="n" data-glyph="46,2" class="i field">_sequenceDueToEnd</a>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> private methods
    }
}
</pre></td></tr></table></div></body></html>
