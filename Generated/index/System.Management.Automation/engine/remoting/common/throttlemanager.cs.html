<!DOCTYPE html>
<html><head><title>throttlemanager.cs</title><link rel="stylesheet" href="../../../../styles.css"><script src="../../../../scripts.js"></script></head>
<body class="cB" onload="i(770);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#System.Management.Automation/engine/remoting/common/throttlemanager.cs" target="_top">engine\remoting\common\throttlemanager.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#System.Management.Automation" target="_top">src\System.Management.Automation\System.Management.Automation.csproj</a> (System.Management.Automation)</td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation.</span>
<span class="c">// Licensed under the MIT License.</span>
 
<b>using</b> <span class="i n">System</span>.<span class="i">Collections</span>.<span class="i">Generic</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Threading</span>;
 
<b>using</b> <span class="t">Dbg</span> = <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Diagnostics</a>;
 
<b>namespace</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Remoting</span>
{
    <span class="k preprocess">#</span><span class="k preprocess">region</span> OperationState
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Defines the different states of the operation.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>internal enum</b> <a id="6cf95059c5d2ad6e" href="../../../R/6cf95059c5d2ad6e.html" target="n" data-glyph="20,0" class="t t"><span id="abce84eed9c38e0d">OperationState</span></a>
    {
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Start operation completed successfully.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <a id="bad569808247de6a" href="../../../R/bad569808247de6a.html" target="n" data-glyph="24,1" class="i field">StartComplete</a> = 0,
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Stop operation completed successfully.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <a id="c2e1a69d3e84f187" href="../../../R/c2e1a69d3e84f187.html" target="n" data-glyph="24,1" class="i field">StopComplete</a> = 1,
    }
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Class describing event args which a helper class</span>
    <span class="c">///</span><span class="c"> implementing IThrottleOperation need to throw.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>internal sealed class</b> <a id="ef7de7ace48bc7ae" href="../../../R/ef7de7ace48bc7ae.html" target="n" data-glyph="2,0" class="t t"><span id="8925d010611b7276">OperationStateEventArgs</span></a> : <span class="i">EventArgs</span>
    {
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Operation state.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal</b> <a href="#6cf95059c5d2ad6e" class="t t">OperationState</a> <a id="8648129d937c33ce" href="../../../R/8648129d937c33ce.html" target="n" data-glyph="104,1" class="i property">OperationState</a> { <b>get</b>; <b>set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The original event which actually resulted in this</span>
        <span class="c">///</span><span class="c"> event being raised.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal</b> <span class="i">EventArgs</span> <a id="c68f18b126779ae0" href="../../../R/c68f18b126779ae0.html" target="n" data-glyph="104,1" class="i property">BaseEvent</a> { <b>get</b>; <b>set</b>; }
    }
 
    <span class="k preprocess">#</span><span class="k preprocess">endregion</span> OperationState
 
    <span class="k preprocess">#</span><span class="k preprocess">region</span> IThrottleOperation
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Interface which needs to be implemented by a class which wants to</span>
    <span class="c">///</span><span class="c"> submit operations to the throttle manager.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span><span class="c">Any synchronization that needs to be performed between</span>
    <span class="c">///</span><span class="c"> StartOperation and StopOperation in the class that implements this</span>
    <span class="c">///</span><span class="c"> interface should take care of handling the same. For instance,</span>
    <span class="c">///</span><span class="c"> say New-Runspace class internally uses a class A which implements</span>
    <span class="c">///</span><span class="c"> the IThrottleOperation interface. StartOperation of this</span>
    <span class="c">///</span><span class="c"> class opens a runspace asynchronously on a remote machine. Stop</span>
    <span class="c">///</span><span class="c"> operation is supposed to cancel the opening of this runspace. Any</span>
    <span class="c">///</span><span class="c"> synchronization/cleanup issues should be handled by class A.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
    <b>internal abstract class</b> <a id="1164666ea3964901" href="../../../R/1164666ea3964901.html" target="n" data-glyph="2,0" class="t t"><span id="8799121d8e9013fd">IThrottleOperation</span></a>
    {
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This method should handle the actual operation which need to be</span>
        <span class="c">///</span><span class="c"> controlled and performed. Examples of this can be Opening remote</span>
        <span class="c">///</span><span class="c"> runspace, invoking expression in a remote runspace, etc. Once</span>
        <span class="c">///</span><span class="c"> an event is successfully received as a result of this function,</span>
        <span class="c">///</span><span class="c"> the handler has to ensure that it raises an OperationComplete</span>
        <span class="c">///</span><span class="c"> event with StartComplete or StopComplete for the throttle manager</span>
        <span class="c">///</span><span class="c"> to handle.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal abstract void</b> <a id="eb111ab2d4fcd6e3" href="../../../R/eb111ab2d4fcd6e3.html" target="n" data-glyph="74,1" class="i method">StartOperation</a>();
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This method should handle the situation when a stop signal is sent</span>
        <span class="c">///</span><span class="c"> for this operation. For instance, when trying to open a set of</span>
        <span class="c">///</span><span class="c"> remote runspaces, the user might hit ctrl-C. In which case, the</span>
        <span class="c">///</span><span class="c"> pending runspaces to be opened will actually be signalled through</span>
        <span class="c">///</span><span class="c"> this method to stop operation and return back. This method also</span>
        <span class="c">///</span><span class="c"> needs to be asynchronous. Once an event is successfully received</span>
        <span class="c">///</span><span class="c"> as a result of this function, the handler has to ensure that it</span>
        <span class="c">///</span><span class="c"> raises an OperationComplete event with StopComplete for the</span>
        <span class="c">///</span><span class="c"> throttle manager to handle. It is important that this function</span>
        <span class="c">///</span><span class="c"> does not raise a StartComplete which will then result in the</span>
        <span class="c">///</span><span class="c"> ThrottleComplete event not being raised by the throttle manager.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal abstract void</b> <a id="acbd248999d6331f" href="../../../R/acbd248999d6331f.html" target="n" data-glyph="74,1" class="i method">StopOperation</a>();
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Event which will be triggered when the operation is complete. It is</span>
        <span class="c">///</span><span class="c"> assumed that all the operations performed by StartOperation and</span>
        <span class="c">///</span><span class="c"> StopOperation are asynchronous. The submitter of operations may</span>
        <span class="c">///</span><span class="c"> subscribe to this event to know when it&#39;s complete (or it can handle</span>
        <span class="c">///</span><span class="c"> the synchronization with its scheduler) and the throttle</span>
        <span class="c">///</span><span class="c"> manager will subscribe to this event to know that it&#39;s complete</span>
        <span class="c">///</span><span class="c"> and to start the operation on the next item.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal abstract event</b> <span class="i">EventHandler</span>&lt;<a href="#ef7de7ace48bc7ae" class="t t">OperationStateEventArgs</a>&gt; <a id="d2b8440ede8b9b06" href="../../../R/d2b8440ede8b9b06.html" target="n" data-glyph="32,1" class="i">OperationComplete</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This Property indicates whether an operation has been stopped.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> In the initial implementation of ThrottleManager stopping</span>
        <span class="c">///</span><span class="c"> individual operations was not supported. When the support</span>
        <span class="c">///</span><span class="c"> for stopping individual operations was added, there was</span>
        <span class="c">///</span><span class="c"> the following problem - if an operation is not there in</span>
        <span class="c">///</span><span class="c"> the pending queue and in the startOperationQueue as well,</span>
        <span class="c">///</span><span class="c"> then the following two scenarios are possible</span>
        <span class="c">///</span><span class="c">      (a) Operation was started and start completed</span>
        <span class="c">///</span><span class="c">      (b) Operation was started and stopped and both completed</span>
        <span class="c">///</span><span class="c"> This property has been added in order to disambiguate between</span>
        <span class="c">///</span><span class="c"> these two cases. When this property is set, StopOperation</span>
        <span class="c">///</span><span class="c"> need not be called on the operation (this can be when the</span>
        <span class="c">///</span><span class="c"> operation has stop completed or stop has been called and is</span>
        <span class="c">///</span><span class="c"> pending)</span>
        <span class="c">///</span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>internal bool</b> <a id="59066f8320b56465" href="../../../R/59066f8320b56465.html" target="n" data-glyph="104,1" class="i property">IgnoreStop</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#2010406755255643" class="i field">_ignoreStop</a>;
            }
 
            <b>set</b>
            {
                <a href="#2010406755255643" class="i field">_ignoreStop</a> = <b>true</b>;
            }
        }
 
        <b>private bool</b> <a id="2010406755255643" href="../../../R/2010406755255643.html" target="n" data-glyph="46,1" class="i field">_ignoreStop</a> = <b>false</b>;
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Runspace Debug
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> When true enables runspace debugging for operations involving runspaces.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal bool</b> <a id="df9433bee909401f" href="../../../R/df9433bee909401f.html" target="n" data-glyph="104,1" class="i property">RunspaceDebuggingEnabled</a>
        {
            <b>get</b>;
            <b>set</b>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> When true configures runspace debugging to stop at first opportunity.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal bool</b> <a id="f1d539c43b7c28a2" href="../../../R/f1d539c43b7c28a2.html" target="n" data-glyph="104,1" class="i property">RunspaceDebugStepInEnabled</a>
        {
            <b>get</b>;
            <b>set</b>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Event raised when operation runspace enters a debugger stopped state.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal event</b> <span class="i">EventHandler</span>&lt;<a href="../../debugger/debugger.cs.html#0b214bf7844547d9" class="t t">StartRunspaceDebugProcessingEventArgs</a>&gt; <a id="fc79266b79f42512" href="../../../R/fc79266b79f42512.html" target="n" data-glyph="32,1" class="i">RunspaceDebugStop</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> RaiseRunspaceDebugStopEvent.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r0 r">runspace</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Runspace.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="014cb7d8604d4b95" href="../../../R/014cb7d8604d4b95.html" target="n" data-glyph="74,1" class="i method">RaiseRunspaceDebugStopEvent</a>(<span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Runspaces</span>.<a href="../../hostifaces/Connection.cs.html#7e5b8eab1aa16fd7" class="t t">Runspace</a> <span id="r0 rd" class="r0 r">runspace</span>)
        {
            <a href="#fc79266b79f42512" class="i">RunspaceDebugStop</a>.<span class="i">SafeInvoke</span>(<a href="#1164666ea3964901" class="k">this</a>, <b>new</b> <a href="../../debugger/debugger.cs.html#e075a36149989e34" class="t constructor">StartRunspaceDebugProcessingEventArgs</a>(<span class="r0 r">runspace</span>));
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
    }
 
    <span class="k preprocess">#</span><span class="k preprocess">endregion</span> IThrottleOperation
 
    <span class="k preprocess">#</span><span class="k preprocess">region</span> ThrottleManager
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Class which handles the throttling operations. This class is singleton and therefore</span>
    <span class="c">///</span><span class="c"> when used either across cmdlets or at the infrastructure level it will ensure that</span>
    <span class="c">///</span><span class="c"> there aren&#39;t more operations by way of accumulation than what is intended by design.</span>
    <span class="c">///</span>
    <span class="c">///</span><span class="c"> This class contains a queue of items, each of which has the</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Remoting</span>.<a href="#1164666ea3964901" class="t t">IThrottleOperation</a><span class="c">&quot;</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> IThrottleOperation</span><span class="c">&lt;/</span><span class="c">see</span><span class="c">&gt;</span><span class="c"> interface implemented. To begin with</span>
    <span class="c">///</span><span class="c"> THROTTLE_LIMIT number of items will be taken from the queue and the operations on</span>
    <span class="c">///</span><span class="c"> them will be executed. Subsequently, as and when operations complete, new items from</span>
    <span class="c">///</span><span class="c"> the queue will be taken and their operations executed.</span>
    <span class="c">///</span>
    <span class="c">///</span><span class="c"> Whenever a consumer submits or adds operations, the methods will start as much</span>
    <span class="c">///</span><span class="c"> operations from the queue as permitted based on the throttle limit. Also the event</span>
    <span class="c">///</span><span class="c"> handler will start an operation once a previous event is completed.</span>
    <span class="c">///</span>
    <span class="c">///</span><span class="c"> The queue used is a generic queue of type IThrottleOperations, as it will offer better</span>
    <span class="c">///</span><span class="c"> performance.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span><span class="c">Throttle limit is currently set to 50. This value may be modified later based</span>
    <span class="c">///</span><span class="c"> on a figure that we may arrive at out of experience.</span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
    <b>internal class</b> <a id="4aa32d51dd591ac8" href="../../../R/4aa32d51dd591ac8.html" target="n" data-glyph="2,0" class="t t">ThrottleManager</a> : <span class="i">IDisposable</span>
    {
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Public (internal) Properties
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Allows the consumer to override the default throttle limit.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal int</b> <a id="c88c6759bac73d6d" href="../../../R/c88c6759bac73d6d.html" target="n" data-glyph="104,1" class="i property">ThrottleLimit</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#4118851f175afb38" class="i field">_throttleLimit</a>;
            }
 
            <b>set</b>
            {
                <b>if</b> (<b>value</b> &gt; 0 &amp;&amp; <b>value</b> &lt;= <a href="#113db4b705049e02" class="i field">s_THROTTLE_LIMIT_MAX</a>)
                {
                    <a href="#4118851f175afb38" class="i field">_throttleLimit</a> = <b>value</b>;
                }
            }
        }
 
        <b>private int</b> <a id="4118851f175afb38" href="../../../R/4118851f175afb38.html" target="n" data-glyph="46,1" class="i field">_throttleLimit</a> = <a href="#25b22eb7db666cb5" class="i field">s_DEFAULT_THROTTLE_LIMIT</a>;
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Public (internal) Properties
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Public (internal) Methods
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Submit a list of operations that need to be throttled.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r1 r">operations</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">List of operations to be throttled.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span><span class="c">Once the operations are added to the queue, the method will</span>
        <span class="c">///</span><span class="c"> start operations from the queue</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="ee8f2ac038103ebc" href="../../../R/ee8f2ac038103ebc.html" target="n" data-glyph="74,1" class="i method">SubmitOperations</a>(<span class="i">List</span>&lt;<a href="#1164666ea3964901" class="t t">IThrottleOperation</a>&gt; <span id="r1 rd" class="r1 r">operations</span>)
        {
            <b>lock</b> (<a href="#a97d6a93c41954a0" class="i field">_syncObject</a>)
            {
                <span class="c">// operations can be submitted only until submitComplete</span>
                <span class="c">// is not set to true (happens when EndSubmitOperations is called)</span>
                <b>if</b> (!<a href="#0e44709b08d9bf48" class="i field">_submitComplete</a>)
                {
                    <span class="c">// add items to the queue</span>
                    <b>foreach</b> (<a href="#1164666ea3964901" class="t t">IThrottleOperation</a> <span id="r2 rd" class="r2 r">operation</span> <b>in</b> <span class="r1 r">operations</span>)
                    {
                        <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r2 r">operation</span> != <b>null</b>,
                            <span class="s">&quot;Operation submitComplete to throttle manager cannot be null&quot;</span>);
                        <a href="#19bb0fb23d91a633" class="i field">_operationsQueue</a>.<span class="i">Add</span>(<span class="r2 r">operation</span>);
                    }
                }
                <b>else</b>
                {
                    <b>throw</b> <b>new</b> <span class="i">InvalidOperationException</span>();
                }
            }
 
            <span class="c">// schedule operations here if possible</span>
            <a href="#8b55c6704c3010d3" class="i method">StartOperationsFromQueue</a>();
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Add a single operation to the queue.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r3 r">operation</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Operation to be added.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="ad36926f4e2b6584" href="../../../R/ad36926f4e2b6584.html" target="n" data-glyph="74,1" class="i method">AddOperation</a>(<a href="#1164666ea3964901" class="t t">IThrottleOperation</a> <span id="r3 rd" class="r3 r">operation</span>)
        {
            <span class="c">// add item to the queue</span>
            <b>lock</b> (<a href="#a97d6a93c41954a0" class="i field">_syncObject</a>)
            {
                <span class="c">// operations can be submitted only until submitComplete</span>
                <span class="c">// is not set to true (happens when EndSubmitOperations is called)</span>
                <b>if</b> (!<a href="#0e44709b08d9bf48" class="i field">_submitComplete</a>)
                {
                    <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r3 r">operation</span> != <b>null</b>,
                        <span class="s">&quot;Operation submitComplete to throttle manager cannot be null&quot;</span>);
 
                    <a href="#19bb0fb23d91a633" class="i field">_operationsQueue</a>.<span class="i">Add</span>(<span class="r3 r">operation</span>);
                }
                <b>else</b>
                {
                    <b>throw</b> <b>new</b> <span class="i">InvalidOperationException</span>();
                }
            }
 
            <span class="c">// start operations from queue if possible</span>
            <a href="#8b55c6704c3010d3" class="i method">StartOperationsFromQueue</a>();
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Stop throttling operations.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span><span class="c">Calling this method will also affect other cmdlets which</span>
        <span class="c">///</span><span class="c"> could have potentially submitComplete operations for processing</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">Number of objects cleared from queue without being</span>
        <span class="c">///</span><span class="c"> stopped.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="255a5e90af99543c" href="../../../R/255a5e90af99543c.html" target="n" data-glyph="74,1" class="i method">StopAllOperations</a>()
        {
            <span class="c">// if stopping is already in progress, make it a no op</span>
            <b>bool</b> <span id="r4 rd" class="r4 r">needToReturn</span> = <b>false</b>;
 
            <b>lock</b> (<a href="#a97d6a93c41954a0" class="i field">_syncObject</a>)
            {
                <b>if</b> (!<a href="#38d97b038202f8ed" class="i field">_stopping</a>)
                {
                    <a href="#38d97b038202f8ed" class="i field">_stopping</a> = <b>true</b>;
                }
                <b>else</b>
                {
                    <span class="r4 r">needToReturn</span> = <b>true</b>;
                }
            }
 
            <b>if</b> (<span class="r4 r">needToReturn</span>)
            {
                <a href="#912d64bd052c6cae" class="i method">RaiseThrottleManagerEvents</a>();
                <b>return</b>;
            }
 
            <a href="#1164666ea3964901" class="t t">IThrottleOperation</a>[] <span id="r5 rd" class="r5 r">startOperationsInProcessArray</span>;
 
            <b>lock</b> (<a href="#a97d6a93c41954a0" class="i field">_syncObject</a>)
            {
                <span class="c">// no more submissions possible once stopped</span>
                <a href="#0e44709b08d9bf48" class="i field">_submitComplete</a> = <b>true</b>;
 
                <span class="c">// Clear all pending operations in queue so that they are not</span>
                <span class="c">// scheduled when a stop operation completes</span>
                <a href="#19bb0fb23d91a633" class="i field">_operationsQueue</a>.<span class="i">Clear</span>();
 
                <span class="c">// Make a copy of the in process queue so as to stop all</span>
                <span class="c">// operations in progress</span>
                <span class="r5 r">startOperationsInProcessArray</span> =
                        <b>new</b> <a href="#1164666ea3964901" class="t t">IThrottleOperation</a>[<a href="#70823a49c541eb49" class="i field">_startOperationQueue</a>.<span class="i">Count</span>];
                <a href="#70823a49c541eb49" class="i field">_startOperationQueue</a>.<span class="i">CopyTo</span>(<span class="r5 r">startOperationsInProcessArray</span>);
 
                <span class="c">// stop all operations in process (using the copy)</span>
                <b>foreach</b> (<a href="#1164666ea3964901" class="t t">IThrottleOperation</a> <span id="r6 rd" class="r6 r">operation</span> <b>in</b> <span class="r5 r">startOperationsInProcessArray</span>)
                {
                    <span class="c">// When iterating through the array of operations in process</span>
                    <span class="c">// it is quite possible that a runspace gets to the open state</span>
                    <span class="c">// before stop is actually called on it. In that case, the</span>
                    <span class="c">// OperationCompleteHandler will remove it from the</span>
                    <span class="c">// operationsInProcess queue. Now when the runspace is closed</span>
                    <span class="c">// the same handler will try removing it again and so there will</span>
                    <span class="c">// be an exception. Hence adding it a second time before stop</span>
                    <span class="c">// will ensure that the operation is available in the queue for</span>
                    <span class="c">// removal. In case the stop succeeds before start succeeds then</span>
                    <span class="c">// both will get removed (it goes without saying that there cannot</span>
                    <span class="c">// be a situation where start succeeds after stop succeeded)</span>
                    <a href="#3001c584206eaec0" class="i field">_stopOperationQueue</a>.<span class="i">Add</span>(<span class="r6 r">operation</span>);
 
                    <span class="r6 r">operation</span>.<a href="#59066f8320b56465" class="i property">IgnoreStop</a> = <b>true</b>;
                }
            }
 
            <b>foreach</b> (<a href="#1164666ea3964901" class="t t">IThrottleOperation</a> <span id="r7 rd" class="r7 r">operation</span> <b>in</b> <span class="r5 r">startOperationsInProcessArray</span>)
            {
                <span class="r7 r">operation</span>.<a href="#acbd248999d6331f" class="i method">StopOperation</a>();
            }
 
            <span class="c">// Raise event as it can be that at this point, all operations are</span>
            <span class="c">// complete</span>
            <a href="#912d64bd052c6cae" class="i method">RaiseThrottleManagerEvents</a>();
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Stop the specified operation.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r8 r">operation</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Operation which needs to be stopped.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="9fdde813aaf8678c" href="../../../R/9fdde813aaf8678c.html" target="n" data-glyph="74,1" class="i method">StopOperation</a>(<a href="#1164666ea3964901" class="t t">IThrottleOperation</a> <span id="r8 rd" class="r8 r">operation</span>)
        {
            <span class="c">// StopOperation is being called a second time</span>
            <span class="c">// or the stop operation has already completed</span>
            <span class="c">// - in either case just return</span>
            <b>if</b> (<span class="r8 r">operation</span>.<a href="#59066f8320b56465" class="i property">IgnoreStop</a>)
            {
                <b>return</b>;
            }
 
            <span class="c">// If the operation has not yet been started, then</span>
            <span class="c">// remove it from the pending queue</span>
            <b>if</b> (<a href="#19bb0fb23d91a633" class="i field">_operationsQueue</a>.<span class="i">IndexOf</span>(<span class="r8 r">operation</span>) != -1)
            {
                <b>lock</b> (<a href="#a97d6a93c41954a0" class="i field">_syncObject</a>)
                {
                    <b>if</b> (<a href="#19bb0fb23d91a633" class="i field">_operationsQueue</a>.<span class="i">IndexOf</span>(<span class="r8 r">operation</span>) != -1)
                    {
                        <a href="#19bb0fb23d91a633" class="i field">_operationsQueue</a>.<span class="i">Remove</span>(<span class="r8 r">operation</span>);
                        <a href="#912d64bd052c6cae" class="i method">RaiseThrottleManagerEvents</a>();
                        <b>return</b>;
                    }
                }
            }
 
            <span class="c">// The operation has already started, then add it</span>
            <span class="c">// to the inprocess queue and call stop. Refer to</span>
            <span class="c">// comment in StopAllOperations() as to why this is</span>
            <span class="c">// being added a second time</span>
            <b>lock</b> (<a href="#a97d6a93c41954a0" class="i field">_syncObject</a>)
            {
                <a href="#3001c584206eaec0" class="i field">_stopOperationQueue</a>.<span class="i">Add</span>(<span class="r8 r">operation</span>);
 
                <span class="r8 r">operation</span>.<a href="#59066f8320b56465" class="i property">IgnoreStop</a> = <b>true</b>;
            }
 
            <span class="c">// stop the operation outside of the lock</span>
            <span class="r8 r">operation</span>.<a href="#acbd248999d6331f" class="i method">StopOperation</a>();
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Signals that no more operations can be submitComplete</span>
        <span class="c">///</span><span class="c"> for throttling.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="75a1eec170a5d6bc" href="../../../R/75a1eec170a5d6bc.html" target="n" data-glyph="74,1" class="i method">EndSubmitOperations</a>()
        {
            <b>lock</b> (<a href="#a97d6a93c41954a0" class="i field">_syncObject</a>)
            {
                <a href="#0e44709b08d9bf48" class="i field">_submitComplete</a> = <b>true</b>;
            }
 
            <a href="#912d64bd052c6cae" class="i method">RaiseThrottleManagerEvents</a>();
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Public (internal) Methods
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Public (internal) Events
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Event raised when throttling all operations is complete.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal event</b> <span class="i">EventHandler</span>&lt;<span class="i">EventArgs</span>&gt; <a id="dd885eab312c9a19" href="../../../R/dd885eab312c9a19.html" target="n" data-glyph="32,1" class="i">ThrottleComplete</a>;
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Public (internal) Events
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Constructors
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Public constructor.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public</b> <a id="21c77408b36939a4" href="../../../R/21c77408b36939a4.html" target="n" data-glyph="72,1" class="t constructor">ThrottleManager</a>()
        {
            <a href="#19bb0fb23d91a633" class="i field">_operationsQueue</a> = <b>new</b> <span class="i">List</span>&lt;<a href="#1164666ea3964901" class="t t">IThrottleOperation</a>&gt;();
            <a href="#70823a49c541eb49" class="i field">_startOperationQueue</a> = <b>new</b> <span class="i">List</span>&lt;<a href="#1164666ea3964901" class="t t">IThrottleOperation</a>&gt;();
            <a href="#3001c584206eaec0" class="i field">_stopOperationQueue</a> = <b>new</b> <span class="i">List</span>&lt;<a href="#1164666ea3964901" class="t t">IThrottleOperation</a>&gt;();
            <a href="#a97d6a93c41954a0" class="i field">_syncObject</a> = <b>new</b> <b>object</b>();
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Constructors
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Private Methods
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Handler which handles state change for the object which implements</span>
        <span class="c">///</span><span class="c"> the </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Remoting</span>.<a href="#1164666ea3964901" class="t t">IThrottleOperation</a><span class="c">&quot;</span><span class="c">/&gt;</span>
        <span class="c">///</span><span class="c"> interface.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r9 r">source</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Sender of the event.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r10 r">stateEventArgs</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Event information object which describes the event</span>
        <span class="c">///</span><span class="c"> which triggered this method</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>private void</b> <a id="6c43f033ebb28b4b" href="../../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">OperationCompleteHandler</a>(<b>object</b> <span id="r9 rd" class="r9 r">source</span>, <a href="#ef7de7ace48bc7ae" class="t t">OperationStateEventArgs</a> <span id="r10 rd" class="r10 r">stateEventArgs</span>)
        {
            <span class="c">// An item has completed operation. If it&#39;s a start operation which completed</span>
            <span class="c">// remove the instance from the startOperationqueue. If it&#39;s a stop operation</span>
            <span class="c">// which completed, then remove the instance from both queues</span>
            <b>lock</b> (<a href="#a97d6a93c41954a0" class="i field">_syncObject</a>)
            {
                <a href="#1164666ea3964901" class="t t">IThrottleOperation</a> <span id="r11 rd" class="r11 r">operation</span> = <span class="r9 r">source</span> <b>as</b> <a href="#1164666ea3964901" class="t t">IThrottleOperation</a>;
 
                <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r11 r">operation</span> != <b>null</b>, <span class="s">&quot;Source of event should not be null&quot;</span>);
 
                <b>int</b> <span id="r12 rd" class="r12 r">index</span> = -1;
 
                <b>if</b> (<span class="r10 r">stateEventArgs</span>.<a href="#8648129d937c33ce" class="i property">OperationState</a> == <a href="#6cf95059c5d2ad6e" class="t t">OperationState</a>.<a href="#bad569808247de6a" class="i field">StartComplete</a>)
                {
                    <span class="c">// A stop operation can be initiated before a start operation completes.</span>
                    <span class="c">// A stop operation handler cleans up an outstanding start operation.</span>
                    <span class="c">// So it is possible that a start operation complete callback will find the</span>
                    <span class="c">// operation removed from the queue by an earlier stop operation complete.</span>
                    <span class="r12 r">index</span> = <a href="#70823a49c541eb49" class="i field">_startOperationQueue</a>.<span class="i">IndexOf</span>(<span class="r11 r">operation</span>);
                    <b>if</b> (<span class="r12 r">index</span> != -1)
                    {
                        <a href="#70823a49c541eb49" class="i field">_startOperationQueue</a>.<span class="i">RemoveAt</span>(<span class="r12 r">index</span>);
                    }
                }
                <b>else</b>
                {
                    <span class="c">// for a stop operation, the same operation object would have been</span>
                    <span class="c">// added to the stopOperationQueue as well. So we need to</span>
                    <span class="c">// remove both the instances.</span>
                    <span class="r12 r">index</span> = <a href="#70823a49c541eb49" class="i field">_startOperationQueue</a>.<span class="i">IndexOf</span>(<span class="r11 r">operation</span>);
                    <b>if</b> (<span class="r12 r">index</span> != -1)
                    {
                        <a href="#70823a49c541eb49" class="i field">_startOperationQueue</a>.<span class="i">RemoveAt</span>(<span class="r12 r">index</span>);
                    }
 
                    <span class="r12 r">index</span> = <a href="#3001c584206eaec0" class="i field">_stopOperationQueue</a>.<span class="i">IndexOf</span>(<span class="r11 r">operation</span>);
                    <b>if</b> (<span class="r12 r">index</span> != -1)
                    {
                        <a href="#3001c584206eaec0" class="i field">_stopOperationQueue</a>.<span class="i">RemoveAt</span>(<span class="r12 r">index</span>);
                    }
 
                    <span class="c">// if an operation signals a stopcomplete, it can mean</span>
                    <span class="c">// that the operation has completed. In this case, we</span>
                    <span class="c">// need to set the isStopped to true</span>
                    <span class="r11 r">operation</span>.<a href="#59066f8320b56465" class="i property">IgnoreStop</a> = <b>true</b>;
                }
            }
 
            <span class="c">// It&#39;s possible that all operations are completed at this point</span>
            <span class="c">// and submit is complete. So raise event</span>
            <a href="#912d64bd052c6cae" class="i method">RaiseThrottleManagerEvents</a>();
 
            <span class="c">// Do necessary things for starting operation for the next item in the queue</span>
            <a href="#d757eec2fd1d876a" class="i method">StartOneOperationFromQueue</a>();
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Method used to start the operation on one item in the queue.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private void</b> <a id="d757eec2fd1d876a" href="../../../R/d757eec2fd1d876a.html" target="n" data-glyph="76,1" class="i method">StartOneOperationFromQueue</a>()
        {
            <a href="#1164666ea3964901" class="t t">IThrottleOperation</a> <span id="r13 rd" class="r13 r">operation</span> = <b>null</b>;
 
            <b>lock</b> (<a href="#a97d6a93c41954a0" class="i field">_syncObject</a>)
            {
                <b>if</b> (<a href="#19bb0fb23d91a633" class="i field">_operationsQueue</a>.<span class="i">Count</span> &gt; 0)
                {
                    <span class="r13 r">operation</span> = <a href="#19bb0fb23d91a633" class="i field">_operationsQueue</a>[0];
                    <a href="#19bb0fb23d91a633" class="i field">_operationsQueue</a>.<span class="i">RemoveAt</span>(0);
                    <span class="r13 r">operation</span>.<a href="#d2b8440ede8b9b06" class="i">OperationComplete</a> += <span class="i">OperationCompleteHandler</span>;
                    <a href="#70823a49c541eb49" class="i field">_startOperationQueue</a>.<span class="i">Add</span>(<span class="r13 r">operation</span>);
                }
            }
 
            <b>if</b> (<span class="r13 r">operation</span> != <b>null</b>)
            {
                <span class="r13 r">operation</span>.<a href="#eb111ab2d4fcd6e3" class="i method">StartOperation</a>();
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Start operations to the limit possible from the queue.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private void</b> <a id="8b55c6704c3010d3" href="../../../R/8b55c6704c3010d3.html" target="n" data-glyph="76,1" class="i method">StartOperationsFromQueue</a>()
        {
            <b>int</b> <span id="r14 rd" class="r14 r">operationsInProcessCount</span> = 0;
            <b>int</b> <span id="r15 rd" class="r15 r">operationsQueueCount</span> = 0;
 
            <b>lock</b> (<a href="#a97d6a93c41954a0" class="i field">_syncObject</a>)
            {
                <span class="r14 r">operationsInProcessCount</span> = <a href="#70823a49c541eb49" class="i field">_startOperationQueue</a>.<span class="i">Count</span>;
                <span class="r15 r">operationsQueueCount</span> = <a href="#19bb0fb23d91a633" class="i field">_operationsQueue</a>.<span class="i">Count</span>;
            }
 
            <b>int</b> <span id="r16 rd" class="r16 r">remainingCap</span> = <a href="#4118851f175afb38" class="i field">_throttleLimit</a> - <span class="r14 r">operationsInProcessCount</span>;
 
            <b>if</b> (<span class="r16 r">remainingCap</span> &gt; 0)
            {
                <b>int</b> <span id="r17 rd" class="r17 r">numOperations</span> = (<span class="r16 r">remainingCap</span> &gt; <span class="r15 r">operationsQueueCount</span>) ? <span class="r15 r">operationsQueueCount</span> : <span class="r16 r">remainingCap</span>;
 
                <b>for</b> (<b>int</b> <span id="r18 rd" class="r18 r">i</span> = 0; <span class="r18 r">i</span> &lt; <span class="r17 r">numOperations</span>; <span class="r18 r">i</span>++)
                {
                    <a href="#d757eec2fd1d876a" class="i method">StartOneOperationFromQueue</a>();
                }
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Raise the throttle manager events once the conditions are met.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private void</b> <a id="912d64bd052c6cae" href="../../../R/912d64bd052c6cae.html" target="n" data-glyph="76,1" class="i method">RaiseThrottleManagerEvents</a>()
        {
            <b>bool</b> <span id="r19 rd" class="r19 r">readyToRaise</span> = <b>false</b>;
 
            <b>lock</b> (<a href="#a97d6a93c41954a0" class="i field">_syncObject</a>)
            {
                <span class="c">// if submit is complete, there are no operations in progress and</span>
                <span class="c">// the pending queue is empty, then raise events</span>
                <b>if</b> (<a href="#0e44709b08d9bf48" class="i field">_submitComplete</a> &amp;&amp;
                    <a href="#70823a49c541eb49" class="i field">_startOperationQueue</a>.<span class="i">Count</span> == 0 &amp;&amp;
                    <a href="#3001c584206eaec0" class="i field">_stopOperationQueue</a>.<span class="i">Count</span> == 0 &amp;&amp;
                    <a href="#19bb0fb23d91a633" class="i field">_operationsQueue</a>.<span class="i">Count</span> == 0)
                {
                    <span class="r19 r">readyToRaise</span> = <b>true</b>;
                }
            }
 
            <b>if</b> (<span class="r19 r">readyToRaise</span>)
            {
                <a href="#dd885eab312c9a19" class="i">ThrottleComplete</a>.<span class="i">SafeInvoke</span>(<a href="#4aa32d51dd591ac8" class="k">this</a>, <span class="i">EventArgs</span>.<span class="i">Empty</span>);
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Private Methods
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Private Members
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Default throttle limit - the maximum number of operations</span>
        <span class="c">///</span><span class="c"> to be processed at a time.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private static readonly int</b> <a id="25b22eb7db666cb5" href="../../../R/25b22eb7db666cb5.html" target="n" data-glyph="46,1" class="i field">s_DEFAULT_THROTTLE_LIMIT</a> = 32;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Maximum value that the throttle limit can be set to.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private static readonly int</b> <a id="113db4b705049e02" href="../../../R/113db4b705049e02.html" target="n" data-glyph="46,1" class="i field">s_THROTTLE_LIMIT_MAX</a> = <b>int</b>.<span class="i">MaxValue</span>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> All pending operations.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private readonly</b> <span class="i">List</span>&lt;<a href="#1164666ea3964901" class="t t">IThrottleOperation</a>&gt; <a id="19bb0fb23d91a633" href="../../../R/19bb0fb23d91a633.html" target="n" data-glyph="46,1" class="i field">_operationsQueue</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> List of items on which a StartOperation has</span>
        <span class="c">///</span><span class="c"> been called.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private readonly</b> <span class="i">List</span>&lt;<a href="#1164666ea3964901" class="t t">IThrottleOperation</a>&gt; <a id="70823a49c541eb49" href="../../../R/70823a49c541eb49.html" target="n" data-glyph="46,1" class="i field">_startOperationQueue</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> List of items on which a StopOperation has</span>
        <span class="c">///</span><span class="c"> been called.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private readonly</b> <span class="i">List</span>&lt;<a href="#1164666ea3964901" class="t t">IThrottleOperation</a>&gt; <a id="3001c584206eaec0" href="../../../R/3001c584206eaec0.html" target="n" data-glyph="46,1" class="i field">_stopOperationQueue</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Object used to synchronize access to the queues.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private readonly object</b> <a id="a97d6a93c41954a0" href="../../../R/a97d6a93c41954a0.html" target="n" data-glyph="46,1" class="i field">_syncObject</a>;
 
        <b>private bool</b> <a id="0e44709b08d9bf48" href="../../../R/0e44709b08d9bf48.html" target="n" data-glyph="46,1" class="i field">_submitComplete</a> = <b>false</b>;                    <span class="c">// to check if operations have been submitComplete</span>
        <b>private bool</b> <a id="38d97b038202f8ed" href="../../../R/38d97b038202f8ed.html" target="n" data-glyph="46,1" class="i field">_stopping</a> = <b>false</b>;                      <span class="c">// if stop is in process</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Private Members
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> IDisposable Overrides
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Dispose method of IDisposable. Any cmdlet that uses</span>
        <span class="c">///</span><span class="c"> the throttle manager needs to call this method from its</span>
        <span class="c">///</span><span class="c"> Dispose method.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public void</b> <a id="dd620168185a530e" href="../../../R/dd620168185a530e.html" target="n" data-glyph="72,1" class="i method">Dispose</a>()
        {
            <a href="#aeb2bcb3e470c27d" class="i method">Dispose</a>(<b>true</b>);
 
            <span class="i">GC</span>.<span class="i">SuppressFinalize</span>(<a href="#4aa32d51dd591ac8" class="k">this</a>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Internal dispose method which does the actual dispose</span>
        <span class="c">///</span><span class="c"> operations and finalize suppressions.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r20 r">disposing</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">If method is called from</span>
        <span class="c">///</span><span class="c"> disposing of destructor</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>private void</b> <a id="aeb2bcb3e470c27d" href="../../../R/aeb2bcb3e470c27d.html" target="n" data-glyph="76,1" class="i method">Dispose</a>(<b>bool</b> <span id="r20 rd" class="r20 r">disposing</span>)
        {
            <b>if</b> (<span class="r20 r">disposing</span>)
            {
                <a href="#255a5e90af99543c" class="i method">StopAllOperations</a>();
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> IDisposable Overrides
    }
 
    <span class="k preprocess">#</span><span class="k preprocess">endregion</span> ThrottleManager
 
    <span class="k preprocess">#</span><span class="k preprocess">region</span> Helper Class for Testing
 
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">CORECLR</span> <span class="c">// Skip The Helper Class for Testing (Thread.Abort() Not In CoreCLR)</span>
<span class="e">    internal class Operation : IThrottleOperation
    {
        private ThreadStart workerThreadDelegate;
        private Thread workerThreadStart;
        private Thread workerThreadStop;
 
        public bool Done { get; set; }
 
        public int SleepTime { get; set; } = 100;
 
        private void WorkerThreadMethodStart()
        {
            Thread.Sleep(SleepTime);
            Done = true;
            OperationStateEventArgs operationStateEventArgs =
                    new OperationStateEventArgs();
            operationStateEventArgs.OperationState = OperationState.StartComplete;
            OperationComplete.SafeInvoke(this, operationStateEventArgs);
        }
 
        private void WorkerThreadMethodStop()
        {
            workerThreadStart.Abort();
 
            OperationStateEventArgs operationStateEventArgs =
                    new OperationStateEventArgs();
            operationStateEventArgs.OperationState = OperationState.StopComplete;
            OperationComplete.SafeInvoke(this, operationStateEventArgs);
        }
 
        internal Operation()
        {
            Done = false;
            workerThreadDelegate = new ThreadStart(WorkerThreadMethodStart);
            workerThreadStart = new Thread(workerThreadDelegate);
            workerThreadDelegate = new ThreadStart(WorkerThreadMethodStop);
            workerThreadStop = new Thread(workerThreadDelegate);
        }
 
        internal override void StartOperation()
        {
            workerThreadStart.Start();
        }
 
        internal override void StopOperation()
        {
            workerThreadStop.Start();
        }
 
        internal override event EventHandler&lt;OperationStateEventArgs&gt; OperationComplete;
 
        internal event EventHandler&lt;EventArgs&gt; InternalEvent = null;
 
        internal event EventHandler&lt;EventArgs&gt; EventHandler
        {
            add
            {
                bool firstEntry = (InternalEvent == null);
 
                InternalEvent += value;
 
                if (firstEntry)
                {
                    OperationComplete += new EventHandler&lt;OperationStateEventArgs&gt;(Operation_OperationComplete);
                }
            }
 
            remove
            {
                InternalEvent -= value;
            }
        }
 
        private void Operation_OperationComplete(object sender, OperationStateEventArgs e)
        {
            InternalEvent.SafeInvoke(sender, e);
        }
 
        internal static void SubmitOperations(List&lt;object&gt; operations, ThrottleManager throttleManager)
        {
            List&lt;IThrottleOperation&gt; newOperations = new List&lt;IThrottleOperation&gt;();
            foreach (object operation in operations)
            {
                newOperations.Add((IThrottleOperation)operation);
            }
 
            throttleManager.SubmitOperations(newOperations);
        }
 
        internal static void AddOperation(object operation, ThrottleManager throttleManager)
        {
            throttleManager.AddOperation((IThrottleOperation)operation);
        }
    }
</span><span class="k preprocess">#</span><span class="k preprocess">endif</span>
 
    <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Helper Class for Testing
}
</pre></td></tr></table></div></body></html>
