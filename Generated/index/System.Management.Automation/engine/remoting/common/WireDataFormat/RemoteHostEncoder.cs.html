<!DOCTYPE html>
<html><head><title>RemoteHostEncoder.cs</title><link rel="stylesheet" href="../../../../../styles.css"><script src="../../../../../scripts.js"></script></head>
<body class="cB" onload="i(783);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#System.Management.Automation/engine/remoting/common/WireDataFormat/RemoteHostEncoder.cs" target="_top">engine\remoting\common\WireDataFormat\RemoteHostEncoder.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#System.Management.Automation" target="_top">src\System.Management.Automation\System.Management.Automation.csproj</a> (System.Management.Automation)</td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation.</span>
<span class="c">// Licensed under the MIT License.</span>
 
<b>using</b> <span class="i n">System</span>.<span class="i">Collections</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Collections</span>.<span class="i">Generic</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Collections</span>.<span class="i">ObjectModel</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Globalization</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Host</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Reflection</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Runtime</span>.<span class="i">Serialization</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Security</span>;
 
<b>using</b> <span class="t">Dbg</span> = <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="../../../../utils/assert.cs.html#c04955255430d32f" class="t t">Diagnostics</a>;
 
<b>namespace</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Remoting</span>
{
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Encodes and decodes data types and exceptions for transmission across</span>
    <span class="c">///</span><span class="c"> the wire. Used for transmitting remote host method call parameters, return</span>
    <span class="c">///</span><span class="c"> values, and exceptions. The convention is that EncodeObject converts the</span>
    <span class="c">///</span><span class="c"> objects into a type that can be serialized and deserialized without losing</span>
    <span class="c">///</span><span class="c"> fidelity. For example, EncodeObject converts Version objects to string,</span>
    <span class="c">///</span><span class="c"> and converts more complex classes into property bags on PSObjects. This</span>
    <span class="c">///</span><span class="c"> guarantees that transmitting on the wire will not change the encoded</span>
    <span class="c">///</span><span class="c"> object&#39;s type.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>internal static class</b> <a id="f99e89fafaac33f0" href="../../../../R/f99e89fafaac33f0.html" target="n" data-glyph="2,0" class="t t">RemoteHostEncoder</a>
    {
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Is known type.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private static bool</b> <a id="98acd24e2426f144" href="../../../../R/98acd24e2426f144.html" target="n" data-glyph="76,1" class="i method">IsKnownType</a>(<span class="i">Type</span> <span id="r0 rd" class="r0 r">type</span>)
        {
            <a href="../../../serialization.cs.html#8c15ca7ae5349db9" class="t t">TypeSerializationInfo</a> <span id="r1 rd" class="r1 r">info</span> = <a href="../../../serialization.cs.html#295889332d482ff3" class="t t">KnownTypes</a>.<a href="../../../serialization.cs.html#8e99646679237ea1" class="i method">GetTypeSerializationInfo</a>(<span class="r0 r">type</span>);
            <b>return</b> (<span class="r1 r">info</span> != <b>null</b>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Is encoding allowed for class or struct.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private static bool</b> <a id="3b21b80badedcd5e" href="../../../../R/3b21b80badedcd5e.html" target="n" data-glyph="76,1" class="i method">IsEncodingAllowedForClassOrStruct</a>(<span class="i">Type</span> <span id="r2 rd" class="r2 r">type</span>)
        {
            <span class="c">// To enable encoding and decoding for a class or struct, add it here.</span>
            <b>return</b>
                <span class="c">// Struct types.</span>
                <span class="r2 r">type</span> == <b>typeof</b>(<a href="../../../hostifaces/MshHostRawUserInterface.cs.html#789e42f61d8e8616" class="t t">KeyInfo</a>) ||
                <span class="r2 r">type</span> == <b>typeof</b>(<a href="../../../hostifaces/MshHostRawUserInterface.cs.html#c6f6da6e12de292e" class="t t">Coordinates</a>) ||
                <span class="r2 r">type</span> == <b>typeof</b>(<a href="../../../hostifaces/MshHostRawUserInterface.cs.html#4d1d20b1c8ac2812" class="t t">Size</a>) ||
                <span class="r2 r">type</span> == <b>typeof</b>(<a href="../../../hostifaces/MshHostRawUserInterface.cs.html#9e00d99644eab7e7" class="t t">BufferCell</a>) ||
                <span class="r2 r">type</span> == <b>typeof</b>(<a href="../../../hostifaces/MshHostRawUserInterface.cs.html#bf950e0fd28033b0" class="t t">Rectangle</a>) ||
 
                <span class="c">// Class types.</span>
                <span class="r2 r">type</span> == <b>typeof</b>(<a href="../../../ProgressRecord.cs.html#d79b27687c6ed8c8" class="t t">ProgressRecord</a>) ||
                <span class="r2 r">type</span> == <b>typeof</b>(<a href="../../../hostifaces/FieldDescription.cs.html#604dc47cb14e8ae1" class="t t">FieldDescription</a>) ||
                <span class="r2 r">type</span> == <b>typeof</b>(<a href="../../../hostifaces/ChoiceDescription.cs.html#1f38c9f99af41345" class="t t">ChoiceDescription</a>) ||
                <span class="r2 r">type</span> == <b>typeof</b>(<a href="RemoteSessionCapability.cs.html#4fc7c4b336de518c" class="t t">HostInfo</a>) ||
                <span class="r2 r">type</span> == <b>typeof</b>(<a href="RemoteSessionCapability.cs.html#80e5be2c8462bf2a" class="t t">HostDefaultData</a>) ||
                <span class="r2 r">type</span> == <b>typeof</b>(<a href="RemoteSessionCapability.cs.html#410d0e97ea446fd9" class="t t">RemoteSessionCapability</a>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Encode class or struct.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private static</b> <a href="../../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <a id="dbab01c23932653f" href="../../../../R/dbab01c23932653f.html" target="n" data-glyph="76,1" class="i method">EncodeClassOrStruct</a>(<b>object</b> <span id="r3 rd" class="r3 r">obj</span>)
        {
            <a href="../../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r4 rd" class="r4 r">psObject</span> = <a href="EncodeAndDecode.cs.html#88b19073d823ce05" class="t t">RemotingEncoder</a>.<a href="EncodeAndDecode.cs.html#22d9fb1506026254" class="i method">CreateEmptyPSObject</a>();
            <span class="i">FieldInfo</span>[] <span id="r5 rd" class="r5 r">fieldInfos</span> = <span class="r3 r">obj</span>.<span class="i">GetType</span>().<span class="i">GetFields</span>(<span class="i">BindingFlags</span>.<span class="i">Instance</span> | <span class="i">BindingFlags</span>.<span class="i">Public</span> | <span class="i">BindingFlags</span>.<span class="i">NonPublic</span>);
 
            <span class="c">// Add all the non-null field values to the ps object.</span>
            <b>foreach</b> (<span class="i">FieldInfo</span> <span id="r6 rd" class="r6 r">fieldInfo</span> <b>in</b> <span class="r5 r">fieldInfos</span>)
            {
                <b>object</b> <span id="r7 rd" class="r7 r">fieldValue</span> = <span class="r6 r">fieldInfo</span>.<span class="i">GetValue</span>(<span class="r3 r">obj</span>);
                <b>if</b> (<span class="r7 r">fieldValue</span> == <b>null</b>)
                {
                    <b>continue</b>;
                }
 
                <b>object</b> <span id="r8 rd" class="r8 r">encodedFieldValue</span> = <a href="#7c8e1a4e8e4ec484" class="i method">EncodeObject</a>(<span class="r7 r">fieldValue</span>);
                <span class="r4 r">psObject</span>.<a href="../../../MshObject.cs.html#59e9cd1ad57ccd34" class="i property">Properties</a>.<a href="../../../MshMemberInfo.cs.html#a9e3a2dc56d98237" class="i method">Add</a>(<b>new</b> <span class="t">PSNoteProperty</span>(<span class="r6 r">fieldInfo</span>.<span class="i">Name</span>, <span class="r8 r">encodedFieldValue</span>));
            }
 
            <b>return</b> <span class="r4 r">psObject</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Decode class or struct.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private static object</b> <a id="c8db802104329836" href="../../../../R/c8db802104329836.html" target="n" data-glyph="76,1" class="i method">DecodeClassOrStruct</a>(<a href="../../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r9 rd" class="r9 r">psObject</span>, <span class="i">Type</span> <span id="r10 rd" class="r10 r">type</span>)
        {
            <b>object</b> <span id="r11 rd" class="r11 r">obj</span> = <span class="i">FormatterServices</span>.<span class="i">GetUninitializedObject</span>(<span class="r10 r">type</span>);
 
            <span class="c">// Field values cannot be null - because for null fields we simply don&#39;t transport them.</span>
            <b>foreach</b> (<a href="../../../MshMemberInfo.cs.html#13ab3796654e613c" class="t t">PSPropertyInfo</a> <span id="r12 rd" class="r12 r">propertyInfo</span> <b>in</b> <span class="r9 r">psObject</span>.<a href="../../../MshObject.cs.html#59e9cd1ad57ccd34" class="i property">Properties</a>)
            {
                <span class="i">FieldInfo</span> <span id="r13 rd" class="r13 r">fieldInfo</span> = <span class="r10 r">type</span>.<span class="i">GetField</span>(<span class="r12 r">propertyInfo</span>.<a href="../../../MshMemberInfo.cs.html#02d8236d3d236301" class="i property">Name</a>, <span class="i">BindingFlags</span>.<span class="i">Instance</span> | <span class="i">BindingFlags</span>.<span class="i">Public</span> | <span class="i">BindingFlags</span>.<span class="i">NonPublic</span>);
                <b>if</b> (<span class="r12 r">propertyInfo</span>.<a href="../../../MshMemberInfo.cs.html#cd3a9989baedf3dd" class="i property">Value</a> == <b>null</b>) { <b>throw</b> <a href="RemoteHost.cs.html#b4240fded240f14a" class="t t">RemoteHostExceptions</a>.<a href="RemoteHost.cs.html#3107e507a0ff5c2d" class="i method">NewDecodingFailedException</a>(); }
 
                <b>object</b> <span id="r14 rd" class="r14 r">fieldValue</span> = <span class="i">DecodeObject</span>(<span class="r12 r">propertyInfo</span>.<a href="../../../MshMemberInfo.cs.html#cd3a9989baedf3dd" class="i property">Value</a>, <span class="r13 r">fieldInfo</span>.<span class="i">FieldType</span>);
                <b>if</b> (<span class="r14 r">fieldValue</span> == <b>null</b>) { <b>throw</b> <a href="RemoteHost.cs.html#b4240fded240f14a" class="t t">RemoteHostExceptions</a>.<a href="RemoteHost.cs.html#3107e507a0ff5c2d" class="i method">NewDecodingFailedException</a>(); }
 
                <span class="r13 r">fieldInfo</span>.<span class="i">SetValue</span>(<span class="r11 r">obj</span>, <span class="r14 r">fieldValue</span>);
            }
 
            <b>return</b> <span class="r11 r">obj</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Is collection.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private static bool</b> <a id="1bd37b7ab4bd4b43" href="../../../../R/1bd37b7ab4bd4b43.html" target="n" data-glyph="76,1" class="i method">IsCollection</a>(<span class="i">Type</span> <span id="r15 rd" class="r15 r">type</span>)
        {
            <b>return</b> <span class="r15 r">type</span>.<span class="i">IsGenericType</span> &amp;&amp; <span class="r15 r">type</span>.<span class="i">GetGenericTypeDefinition</span>().<span class="i">Equals</span>(<b>typeof</b>(<span class="i">Collection</span>&lt;&gt;));
        }
 
        <b>private static bool</b> <a id="ffa538a572090151" href="../../../../R/ffa538a572090151.html" target="n" data-glyph="76,1" class="i method">IsGenericIEnumerableOfInt</a>(<span class="i">Type</span> <span id="r16 rd" class="r16 r">type</span>)
        {
            <b>return</b> <span class="r16 r">type</span>.<span class="i">Equals</span>(<b>typeof</b>(<span class="i">IEnumerable</span>&lt;<b>int</b>&gt;));
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Encode collection.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private static</b> <a href="../../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <a id="72e627b876edf7f5" href="../../../../R/72e627b876edf7f5.html" target="n" data-glyph="76,1" class="i method">EncodeCollection</a>(<span class="i">IList</span> <span id="r17 rd" class="r17 r">collection</span>)
        {
            <span class="i">ArrayList</span> <span id="r18 rd" class="r18 r">arrayList</span> = <b>new</b> <span class="i">ArrayList</span>();
            <b>foreach</b> (<b>object</b> <span id="r19 rd" class="r19 r">obj</span> <b>in</b> <span class="r17 r">collection</span>)
            {
                <span class="r18 r">arrayList</span>.<span class="i">Add</span>(<a href="#7c8e1a4e8e4ec484" class="i method">EncodeObject</a>(<span class="r19 r">obj</span>));
            }
 
            <b>return</b> <b>new</b> <span class="t">PSObject</span>(<span class="r18 r">arrayList</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Decode collection.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private static</b> <span class="i">IList</span> <a id="c3322f488cf67b1d" href="../../../../R/c3322f488cf67b1d.html" target="n" data-glyph="76,1" class="i method">DecodeCollection</a>(<a href="../../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r20 rd" class="r20 r">psObject</span>, <span class="i">Type</span> <span id="r21 rd" class="r21 r">collectionType</span>)
        {
            <span class="c">// Get the element type.</span>
            <span class="i">Type</span>[] <span id="r22 rd" class="r22 r">elementTypes</span> = <span class="r21 r">collectionType</span>.<span class="i">GetGenericArguments</span>();
            <a href="../../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r22 r">elementTypes</span>.<span class="i">Length</span> == 1, <span class="s">&quot;Expected elementTypes.Length == 1&quot;</span>);
            <span class="i">Type</span> <span id="r23 rd" class="r23 r">elementType</span> = <span class="r22 r">elementTypes</span>[0];
 
            <span class="c">// Rehydrate the collection from the array list.</span>
            <span class="i">ArrayList</span> <span id="r24 rd" class="r24 r">arrayList</span> = <a href="#82b6052c02a48f0e" class="i method">SafelyGetBaseObject</a>&lt;<span class="i">ArrayList</span>&gt;(<span class="r20 r">psObject</span>);
            <span class="i">IList</span> <span id="r25 rd" class="r25 r">collection</span> = (<span class="i">IList</span>)<span class="i">Activator</span>.<span class="i">CreateInstance</span>(<span class="r21 r">collectionType</span>);
            <b>foreach</b> (<b>object</b> <span id="r26 rd" class="r26 r">element</span> <b>in</b> <span class="r24 r">arrayList</span>)
            {
                <span class="r25 r">collection</span>.<span class="i">Add</span>(<a href="#509f16b4d334125b" class="i method">DecodeObject</a>(<span class="r26 r">element</span>, <span class="r23 r">elementType</span>));
            }
 
            <b>return</b> <span class="r25 r">collection</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Is dictionary.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private static bool</b> <a id="e09cf1d01c304d13" href="../../../../R/e09cf1d01c304d13.html" target="n" data-glyph="76,1" class="i method">IsDictionary</a>(<span class="i">Type</span> <span id="r27 rd" class="r27 r">type</span>)
        {
            <b>return</b> <span class="r27 r">type</span>.<span class="i">IsGenericType</span> &amp;&amp; <span class="r27 r">type</span>.<span class="i">GetGenericTypeDefinition</span>().<span class="i">Equals</span>(<b>typeof</b>(<span class="i">Dictionary</span>&lt;,&gt;));
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Encode dictionary.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private static</b> <a href="../../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <a id="a15973eaacd58c80" href="../../../../R/a15973eaacd58c80.html" target="n" data-glyph="76,1" class="i method">EncodeDictionary</a>(<span class="i">IDictionary</span> <span id="r28 rd" class="r28 r">dictionary</span>)
        {
            <span class="c">// If element type is object then encode as object-dictionary.</span>
            <b>if</b> (<span class="i">IsObjectDictionaryType</span>(<span class="r28 r">dictionary</span>.<span class="i">GetType</span>()))
            {
                <b>return</b> <a href="#407d796dbe4364c0" class="i method">EncodeObjectDictionary</a>(<span class="r28 r">dictionary</span>);
            }
 
            <span class="i">Hashtable</span> <span id="r29 rd" class="r29 r">hashtable</span> = <b>new</b> <span class="i">Hashtable</span>();
            <b>foreach</b> (<b>object</b> <span id="r30 rd" class="r30 r">key</span> <b>in</b> <span class="r28 r">dictionary</span>.<span class="i">Keys</span>)
            {
                <span class="r29 r">hashtable</span>.<span class="i">Add</span>(<a href="#7c8e1a4e8e4ec484" class="i method">EncodeObject</a>(<span class="r30 r">key</span>), <span class="i">EncodeObject</span>(<span class="r28 r">dictionary</span>[<span class="r30 r">key</span>]));
            }
 
            <b>return</b> <b>new</b> <span class="t">PSObject</span>(<span class="r29 r">hashtable</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Decode dictionary.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private static</b> <span class="i">IDictionary</span> <a id="1d815430dd6b1370" href="../../../../R/1d815430dd6b1370.html" target="n" data-glyph="76,1" class="i method">DecodeDictionary</a>(<a href="../../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r31 rd" class="r31 r">psObject</span>, <span class="i">Type</span> <span id="r32 rd" class="r32 r">dictionaryType</span>)
        {
            <span class="c">// If element type is object then decode as object-dictionary.</span>
            <b>if</b> (<a href="#2ed6fc1ec9007366" class="i method">IsObjectDictionaryType</a>(<span class="r32 r">dictionaryType</span>))
            {
                <b>return</b> <a href="#60e1734f3161b4b3" class="i method">DecodeObjectDictionary</a>(<span class="r31 r">psObject</span>, <span class="r32 r">dictionaryType</span>);
            }
 
            <span class="c">// Get the element type.</span>
            <span class="i">Type</span>[] <span id="r33 rd" class="r33 r">elementTypes</span> = <span class="r32 r">dictionaryType</span>.<span class="i">GetGenericArguments</span>();
            <a href="../../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r33 r">elementTypes</span>.<span class="i">Length</span> == 2, <span class="s">&quot;Expected elementTypes.Length == 2&quot;</span>);
            <span class="i">Type</span> <span id="r34 rd" class="r34 r">keyType</span> = <span class="r33 r">elementTypes</span>[0];
            <span class="i">Type</span> <span id="r35 rd" class="r35 r">valueType</span> = <span class="r33 r">elementTypes</span>[1];
 
            <span class="c">// Rehydrate the dictionary from the hashtable.</span>
            <span class="i">Hashtable</span> <span id="r36 rd" class="r36 r">hashtable</span> = <a href="#82b6052c02a48f0e" class="i method">SafelyGetBaseObject</a>&lt;<span class="i">Hashtable</span>&gt;(<span class="r31 r">psObject</span>);
            <span class="i">IDictionary</span> <span id="r37 rd" class="r37 r">dictionary</span> = (<span class="i">IDictionary</span>)<span class="i">Activator</span>.<span class="i">CreateInstance</span>(<span class="r32 r">dictionaryType</span>);
            <b>foreach</b> (<b>object</b> <span id="r38 rd" class="r38 r">key</span> <b>in</b> <span class="r36 r">hashtable</span>.<span class="i">Keys</span>)
            {
                <span class="r37 r">dictionary</span>.<span class="i">Add</span>(
                    <a href="#509f16b4d334125b" class="i method">DecodeObject</a>(<span class="r38 r">key</span>, <span class="r34 r">keyType</span>),
                    <span class="i">DecodeObject</span>(<span class="r36 r">hashtable</span>[<span class="r38 r">key</span>], <span class="r35 r">valueType</span>));
            }
 
            <b>return</b> <span class="r37 r">dictionary</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Encode ps object.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private static</b> <a href="../../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <a id="17e49fc502cf0947" href="../../../../R/17e49fc502cf0947.html" target="n" data-glyph="76,1" class="i method">EncodePSObject</a>(<a href="../../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r39 rd" class="r39 r">psObject</span>)
        {
            <span class="c">// We are not encoding the contents of the PSObject since these can be</span>
            <span class="c">// arbitrarily complex. Only objects that can be serialized and deserialized</span>
            <span class="c">// correctly should be wrapped in PSObjects. This logic should also just do</span>
            <span class="c">// the right thing with PSObject subclasses. Note: This method might seem</span>
            <span class="c">// trivial but it must exist in order to maintain the symmetry with</span>
            <span class="c">// DecodePSObject. There is no perf penalty because: (a) the compiler should</span>
            <span class="c">// inline it, and (b) perf optimization should be based on profiling;</span>
            <span class="c">// premature optimization is the root of all evil.</span>
 
            <b>return</b> <span class="r39 r">psObject</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Decode ps object.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private static</b> <a href="../../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <a id="aa247c60e09df3a3" href="../../../../R/aa247c60e09df3a3.html" target="n" data-glyph="76,1" class="i method">DecodePSObject</a>(<b>object</b> <span id="r40 rd" class="r40 r">obj</span>)
        {
            <b>if</b> (<span class="r40 r">obj</span> <b>is</b> <a href="../../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>)
            {
                <b>return</b> (<a href="../../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>)<span class="r40 r">obj</span>;
            }
            <b>else</b>
            {
                <span class="c">// If this is not a PSObject, wrap it in one. This case needs to be handled</span>
                <span class="c">// because the serializer converts Dictionary&lt;string,PSObject&gt; to a Hashtable</span>
                <span class="c">// mapping strings to strings, when the PSObject is a simple wrapper around</span>
                <span class="c">// string.</span>
                <b>return</b> <b>new</b> <a href="../../../MshObject.cs.html#3ee1d75e736c4afc" class="t constructor">PSObject</a>(<span class="r40 r">obj</span>);
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Encode exception.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private static</b> <a href="../../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <a id="020454b1c35dccb0" href="../../../../R/020454b1c35dccb0.html" target="n" data-glyph="76,1" class="i method">EncodeException</a>(<span class="i">Exception</span> <span id="r41 rd" class="r41 r">exception</span>)
        {
            <span class="c">// We are encoding exceptions as ErrorRecord objects because exceptions written</span>
            <span class="c">// to the wire are lost during serialization. By sending across ErrorRecord objects</span>
            <span class="c">// we are able to preserve the exception as well as the stack trace.</span>
 
            <a href="../../../ErrorPackage.cs.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r42 rd" class="r42 r">errorRecord</span> = <b>null</b>;
            <a href="../../../ErrorPackage.cs.html#2d342e12f9600886" class="t t">IContainsErrorRecord</a> <span id="r43 rd" class="r43 r">containsErrorRecord</span> = <span class="r41 r">exception</span> <b>as</b> <a href="../../../ErrorPackage.cs.html#2d342e12f9600886" class="t t">IContainsErrorRecord</a>;
            <b>if</b> (<span class="r43 r">containsErrorRecord</span> == <b>null</b>)
            {
                <span class="c">// If this is a .NET exception then wrap in an ErrorRecord.</span>
                <span class="r42 r">errorRecord</span> = <b>new</b> <a href="../../../ErrorPackage.cs.html#e9334565e5136f43" class="t constructor">ErrorRecord</a>(<span class="r41 r">exception</span>, <span class="s">&quot;RemoteHostExecutionException&quot;</span>, <a href="../../../ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../../../ErrorPackage.cs.html#707bbec7a1bb5ead" class="i field">NotSpecified</a>, <b>null</b>);
            }
            <b>else</b>
            {
                <span class="c">// Exception inside the error record is ParentContainsErrorRecordException which</span>
                <span class="c">// doesn&#39;t have stack trace. Replace it with top level exception.</span>
                <span class="r42 r">errorRecord</span> = <span class="r43 r">containsErrorRecord</span>.<a href="../../../ErrorPackage.cs.html#cef340f272a30c6b" class="i property">ErrorRecord</a>;
                <span class="r42 r">errorRecord</span> = <b>new</b> <a href="../../../ErrorPackage.cs.html#9d778b0f7802757e" class="t constructor">ErrorRecord</a>(<span class="r42 r">errorRecord</span>, <span class="r41 r">exception</span>);
            }
 
            <a href="../../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r44 rd" class="r44 r">errorRecordPSObject</span> = <a href="EncodeAndDecode.cs.html#88b19073d823ce05" class="t t">RemotingEncoder</a>.<a href="EncodeAndDecode.cs.html#22d9fb1506026254" class="i method">CreateEmptyPSObject</a>();
            <span class="r42 r">errorRecord</span>.<a href="../../../ErrorPackage.cs.html#d16aa6eb75ff130e" class="i method">ToPSObjectForRemoting</a>(<span class="r44 r">errorRecordPSObject</span>);
            <b>return</b> <span class="r44 r">errorRecordPSObject</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Decode exception.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private static</b> <span class="i">Exception</span> <a id="3f6353df88c39941" href="../../../../R/3f6353df88c39941.html" target="n" data-glyph="76,1" class="i method">DecodeException</a>(<a href="../../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r45 rd" class="r45 r">psObject</span>)
        {
            <a href="../../../ErrorPackage.cs.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r46 rd" class="r46 r">errorRecord</span> = <a href="../../../ErrorPackage.cs.html#fe2b46733a081db9" class="t t">ErrorRecord</a>.<a href="../../../ErrorPackage.cs.html#1232603351a94344" class="i method">FromPSObjectForRemoting</a>(<span class="r45 r">psObject</span>);
            <b>if</b> (<span class="r46 r">errorRecord</span> == <b>null</b>)
            {
                <b>throw</b> <a href="RemoteHost.cs.html#b4240fded240f14a" class="t t">RemoteHostExceptions</a>.<a href="RemoteHost.cs.html#f02b445df2cc1822" class="i method">NewDecodingErrorForErrorRecordException</a>();
            }
            <b>else</b>
                <b>return</b> <span class="r46 r">errorRecord</span>.<a href="../../../ErrorPackage.cs.html#2c2498db91e737eb" class="i property">Exception</a>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Upcast field description subclass and drop attributes.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private static</b> <a href="../../../hostifaces/FieldDescription.cs.html#604dc47cb14e8ae1" class="t t">FieldDescription</a> <a id="1f8caabccecce214" href="../../../../R/1f8caabccecce214.html" target="n" data-glyph="76,1" class="i method">UpcastFieldDescriptionSubclassAndDropAttributes</a>(<a href="../../../hostifaces/FieldDescription.cs.html#604dc47cb14e8ae1" class="t t">FieldDescription</a> <span id="r47 rd" class="r47 r">fieldDescription1</span>)
        {
            <span class="c">// Upcasts derived types back to FieldDescription type and throws away attributes.</span>
 
            <span class="c">// Create a new field description object.</span>
            <a href="../../../hostifaces/FieldDescription.cs.html#604dc47cb14e8ae1" class="t t">FieldDescription</a> <span id="r48 rd" class="r48 r">fieldDescription2</span> = <b>new</b> <a href="../../../hostifaces/FieldDescription.cs.html#fa5ee5ec028527f8" class="t constructor">FieldDescription</a>(<span class="r47 r">fieldDescription1</span>.<a href="../../../hostifaces/FieldDescription.cs.html#05535b8392ec4274" class="i property">Name</a>);
 
            <span class="c">// Copy the fields not initialized during construction.</span>
            <span class="r48 r">fieldDescription2</span>.<a href="../../../hostifaces/FieldDescription.cs.html#4bb9c572923973c6" class="i property">Label</a> = <span class="r47 r">fieldDescription1</span>.<a href="../../../hostifaces/FieldDescription.cs.html#4bb9c572923973c6" class="i property">Label</a>;
            <span class="r48 r">fieldDescription2</span>.<a href="../../../hostifaces/FieldDescription.cs.html#3fbb648ef49de9ef" class="i property">HelpMessage</a> = <span class="r47 r">fieldDescription1</span>.<a href="../../../hostifaces/FieldDescription.cs.html#3fbb648ef49de9ef" class="i property">HelpMessage</a>;
            <span class="r48 r">fieldDescription2</span>.<a href="../../../hostifaces/FieldDescription.cs.html#964eb5c82527d436" class="i property">IsMandatory</a> = <span class="r47 r">fieldDescription1</span>.<a href="../../../hostifaces/FieldDescription.cs.html#964eb5c82527d436" class="i property">IsMandatory</a>;
            <span class="r48 r">fieldDescription2</span>.<a href="../../../hostifaces/FieldDescription.cs.html#c9b9bf35499b8ede" class="i property">DefaultValue</a> = <span class="r47 r">fieldDescription1</span>.<a href="../../../hostifaces/FieldDescription.cs.html#c9b9bf35499b8ede" class="i property">DefaultValue</a>;
 
            <span class="c">// Set the type related fields.</span>
            <span class="r48 r">fieldDescription2</span>.<a href="../../../hostifaces/FieldDescription.cs.html#748d11f5ca71fcfc" class="i method">SetParameterTypeName</a>(<span class="r47 r">fieldDescription1</span>.<a href="../../../hostifaces/FieldDescription.cs.html#46048f0bdd8e7551" class="i property">ParameterTypeName</a>);
            <span class="r48 r">fieldDescription2</span>.<a href="../../../hostifaces/FieldDescription.cs.html#b6fe515fcc98cb29" class="i method">SetParameterTypeFullName</a>(<span class="r47 r">fieldDescription1</span>.<a href="../../../hostifaces/FieldDescription.cs.html#4ad2da2d0ed2d9f7" class="i property">ParameterTypeFullName</a>);
            <span class="r48 r">fieldDescription2</span>.<a href="../../../hostifaces/FieldDescription.cs.html#8d80b3aef5d2552d" class="i method">SetParameterAssemblyFullName</a>(<span class="r47 r">fieldDescription1</span>.<a href="../../../hostifaces/FieldDescription.cs.html#459fd71367f5fc99" class="i property">ParameterAssemblyFullName</a>);
 
            <b>return</b> <span class="r48 r">fieldDescription2</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Encode object.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal static object</b> <a id="7c8e1a4e8e4ec484" href="../../../../R/7c8e1a4e8e4ec484.html" target="n" data-glyph="74,1" class="i method">EncodeObject</a>(<b>object</b> <span id="r49 rd" class="r49 r">obj</span>)
        {
            <b>if</b> (<span class="r49 r">obj</span> == <b>null</b>)
            {
                <b>return</b> <b>null</b>;
            }
 
            <span class="i">Type</span> <span id="r50 rd" class="r50 r">type</span> = <span class="r49 r">obj</span>.<span class="i">GetType</span>();
            <b>if</b> (<span class="r49 r">obj</span> <b>is</b> <a href="../../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>)
            {
                <span class="c">// The &quot;is&quot; keyword takes care of PSObject and subclasses.</span>
                <b>return</b> <a href="#17e49fc502cf0947" class="i method">EncodePSObject</a>((<a href="../../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>)<span class="r49 r">obj</span>);
            }
            <b>else</b> <b>if</b> (<span class="r49 r">obj</span> <b>is</b> <a href="../../../ProgressRecord.cs.html#d79b27687c6ed8c8" class="t t">ProgressRecord</a>)
            {
                <b>return</b> ((<a href="../../../ProgressRecord.cs.html#d79b27687c6ed8c8" class="t t">ProgressRecord</a>)<span class="r49 r">obj</span>).<a href="../../../ProgressRecord.cs.html#b278995941ed5af9" class="i method">ToPSObjectForRemoting</a>();
            }
            <b>else</b> <b>if</b> (<a href="#98acd24e2426f144" class="i method">IsKnownType</a>(<span class="r50 r">type</span>))
            {
                <b>return</b> <span class="r49 r">obj</span>;
            }
            <b>else</b> <b>if</b> (<span class="r50 r">type</span>.<span class="i">IsEnum</span>)
            {
                <b>return</b> (<b>int</b>)<span class="r49 r">obj</span>;
            }
            <b>else</b> <b>if</b> (<span class="r49 r">obj</span> <b>is</b> <span class="i">CultureInfo</span>)
            {
                <span class="c">// The &quot;is&quot; keyword takes care of CultureInfo and subclasses.</span>
                <b>return</b> <span class="r49 r">obj</span>.<span class="i">ToString</span>();
            }
            <b>else</b> <b>if</b> (<span class="r49 r">obj</span> <b>is</b> <span class="i">Exception</span>)
            {
                <b>return</b> <a href="#020454b1c35dccb0" class="i method">EncodeException</a>((<span class="i">Exception</span>)<span class="r49 r">obj</span>);
            }
            <b>else</b> <b>if</b> (<span class="r50 r">type</span> == <b>typeof</b>(<b>object</b>[]))
            {
                <b>return</b> <a href="#21e3d03d87ecc00c" class="i method">EncodeObjectArray</a>((<b>object</b>[])<span class="r49 r">obj</span>);
            }
            <b>else</b> <b>if</b> (<span class="r50 r">type</span>.<span class="i">IsArray</span>)
            {
                <b>return</b> <a href="#9499536c1dee633e" class="i method">EncodeArray</a>((<span class="i">Array</span>)<span class="r49 r">obj</span>);
            }
            <b>else</b> <b>if</b> (<span class="r49 r">obj</span> <b>is</b> <span class="i">IList</span> &amp;&amp; <a href="#1bd37b7ab4bd4b43" class="i method">IsCollection</a>(<span class="r50 r">type</span>))
            {
                <b>return</b> <a href="#72e627b876edf7f5" class="i method">EncodeCollection</a>((<span class="i">IList</span>)<span class="r49 r">obj</span>);
            }
            <b>else</b> <b>if</b> (<span class="r49 r">obj</span> <b>is</b> <span class="i">IDictionary</span> &amp;&amp; <a href="#e09cf1d01c304d13" class="i method">IsDictionary</a>(<span class="r50 r">type</span>))
            {
                <b>return</b> <a href="#a15973eaacd58c80" class="i method">EncodeDictionary</a>((<span class="i">IDictionary</span>)<span class="r49 r">obj</span>);
            }
            <b>else</b> <b>if</b> (<span class="r50 r">type</span>.<span class="i">IsSubclassOf</span>(<b>typeof</b>(<a href="../../../hostifaces/FieldDescription.cs.html#604dc47cb14e8ae1" class="t t">FieldDescription</a>)) || <span class="r50 r">type</span> == <b>typeof</b>(<a href="../../../hostifaces/FieldDescription.cs.html#604dc47cb14e8ae1" class="t t">FieldDescription</a>))
            {
                <span class="c">// The upcasting removes the Attributes, so we want to do this both when it</span>
                <span class="c">// is a subclass and when it is a FieldDescription object.</span>
                <b>return</b> <a href="#dbab01c23932653f" class="i method">EncodeClassOrStruct</a>(<a href="#1f8caabccecce214" class="i method">UpcastFieldDescriptionSubclassAndDropAttributes</a>((<a href="../../../hostifaces/FieldDescription.cs.html#604dc47cb14e8ae1" class="t t">FieldDescription</a>)<span class="r49 r">obj</span>));
            }
            <b>else</b> <b>if</b> (<a href="#3b21b80badedcd5e" class="i method">IsEncodingAllowedForClassOrStruct</a>(<span class="r50 r">type</span>))
            {
                <b>return</b> <a href="#dbab01c23932653f" class="i method">EncodeClassOrStruct</a>(<span class="r49 r">obj</span>);
            }
            <b>else</b> <b>if</b> (<span class="r49 r">obj</span> <b>is</b> <a href="RemoteHost.cs.html#8bf334b011b63f92" class="t t">RemoteHostCall</a>)
            {
                <b>return</b> ((<a href="RemoteHost.cs.html#8bf334b011b63f92" class="t t">RemoteHostCall</a>)<span class="r49 r">obj</span>).<a href="RemoteHost.cs.html#855168f47ac0d666" class="i method">Encode</a>();
            }
            <b>else</b> <b>if</b> (<span class="r49 r">obj</span> <b>is</b> <a href="RemoteHost.cs.html#2088d050a88e3ac6" class="t t">RemoteHostResponse</a>)
            {
                <b>return</b> ((<a href="RemoteHost.cs.html#2088d050a88e3ac6" class="t t">RemoteHostResponse</a>)<span class="r49 r">obj</span>).<a href="RemoteHost.cs.html#657b141251f02e27" class="i method">Encode</a>();
            }
            <b>else</b> <b>if</b> (<span class="r49 r">obj</span> <b>is</b> <span class="i">SecureString</span>)
            {
                <b>return</b> <span class="r49 r">obj</span>;
            }
            <b>else</b> <b>if</b> (<span class="r49 r">obj</span> <b>is</b> <a href="../../../Credential.cs.html#6245dc122e2f1916" class="t t">PSCredential</a>)
            {
                <b>return</b> <span class="r49 r">obj</span>;
            }
            <b>else</b> <b>if</b> (<a href="#ffa538a572090151" class="i method">IsGenericIEnumerableOfInt</a>(<span class="r50 r">type</span>))
            {
                <b>return</b> <a href="#72e627b876edf7f5" class="i method">EncodeCollection</a>((<span class="i">IList</span>)<span class="r49 r">obj</span>);
            }
            <b>else</b>
            {
                <b>throw</b> <a href="RemoteHost.cs.html#b4240fded240f14a" class="t t">RemoteHostExceptions</a>.<a href="RemoteHost.cs.html#1a58ac29a432c1f9" class="i method">NewRemoteHostDataEncodingNotSupportedException</a>(<span class="r50 r">type</span>);
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Decode object.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal static object</b> <a id="509f16b4d334125b" href="../../../../R/509f16b4d334125b.html" target="n" data-glyph="74,1" class="i method">DecodeObject</a>(<b>object</b> <span id="r51 rd" class="r51 r">obj</span>, <span class="i">Type</span> <span id="r52 rd" class="r52 r">type</span>)
        {
            <b>if</b> (<span class="r51 r">obj</span> == <b>null</b>)
            {
                <b>return</b> <b>null</b>;
            }
 
            <a href="../../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r52 r">type</span> != <b>null</b>, <span class="s">&quot;Expected type != null&quot;</span>);
            <b>if</b> (<span class="r52 r">type</span> == <b>typeof</b>(<a href="../../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>))
            {
                <b>return</b> <a href="#aa247c60e09df3a3" class="i method">DecodePSObject</a>(<span class="r51 r">obj</span>);
            }
            <b>else</b> <b>if</b> (<span class="r52 r">type</span> == <b>typeof</b>(<a href="../../../ProgressRecord.cs.html#d79b27687c6ed8c8" class="t t">ProgressRecord</a>))
            {
                <b>return</b> <a href="../../../ProgressRecord.cs.html#d79b27687c6ed8c8" class="t t">ProgressRecord</a>.<a href="../../../ProgressRecord.cs.html#b59ff0d76f410fc2" class="i method">FromPSObjectForRemoting</a>(<a href="../../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>.<a href="../../../MshObject.cs.html#e81a321a846beda7" class="i method">AsPSObject</a>(<span class="r51 r">obj</span>));
            }
            <b>else</b> <b>if</b> (<a href="#98acd24e2426f144" class="i method">IsKnownType</a>(<span class="r52 r">type</span>))
            {
                <b>return</b> <span class="r51 r">obj</span>;
            }
            <b>else</b> <b>if</b> (<span class="r51 r">obj</span> <b>is</b> <span class="i">SecureString</span>)
            {
                <b>return</b> <span class="r51 r">obj</span>;
            }
            <b>else</b> <b>if</b> (<span class="r51 r">obj</span> <b>is</b> <a href="../../../Credential.cs.html#6245dc122e2f1916" class="t t">PSCredential</a>)
            {
                <b>return</b> <span class="r51 r">obj</span>;
            }
            <b>else</b> <b>if</b> (<span class="r51 r">obj</span> <b>is</b> <a href="../../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> &amp;&amp; <span class="r52 r">type</span> == <b>typeof</b>(<a href="../../../Credential.cs.html#6245dc122e2f1916" class="t t">PSCredential</a>))
            {
                <span class="c">// BUGBUG: The following piece of code is a workaround</span>
                <span class="c">// because custom serialization is busted. If rehydration</span>
                <span class="c">// works correctly then PSCredential should be available</span>
                <a href="../../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r53 rd" class="r53 r">objAsPSObject</span> = (<a href="../../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>)<span class="r51 r">obj</span>;
                <a href="../../../Credential.cs.html#6245dc122e2f1916" class="t t">PSCredential</a> <span id="r54 rd" class="r54 r">cred</span> = <b>null</b>;
                <b>try</b>
                {
                    <span class="r54 r">cred</span> = <b>new</b> <a href="../../../Credential.cs.html#cddcf55c2817657f" class="t constructor">PSCredential</a>((<b>string</b>)<span class="r53 r">objAsPSObject</span>.<a href="../../../MshObject.cs.html#59e9cd1ad57ccd34" class="i property">Properties</a><a href="../../../MshMemberInfo.cs.html#f603b32aa49d3ffa">[</a><span class="s">&quot;UserName&quot;</span>].<a href="../../../MshMemberInfo.cs.html#cd3a9989baedf3dd" class="i property">Value</a>,
                                            (<span class="i">SecureString</span>)<span class="r53 r">objAsPSObject</span>.<a href="../../../MshObject.cs.html#59e9cd1ad57ccd34" class="i property">Properties</a><a href="../../../MshMemberInfo.cs.html#f603b32aa49d3ffa">[</a><span class="s">&quot;Password&quot;</span>].<a href="../../../MshMemberInfo.cs.html#cd3a9989baedf3dd" class="i property">Value</a>);
                }
                <b>catch</b> (<a href="../../../ExtendedTypeSystemException.cs.html#396f7c7b826437d7" class="t t">GetValueException</a>)
                {
                    <span class="r54 r">cred</span> = <b>null</b>;
                }
 
                <b>return</b> <span class="r54 r">cred</span>;
            }
            <b>else</b> <b>if</b> (<span class="r51 r">obj</span> <b>is int</b> &amp;&amp; <span class="r52 r">type</span>.<span class="i">IsEnum</span>)
            {
                <b>return</b> <span class="i">Enum</span>.<span class="i">ToObject</span>(<span class="r52 r">type</span>, (<b>int</b>)<span class="r51 r">obj</span>);
            }
            <b>else</b> <b>if</b> (<span class="r51 r">obj</span> <b>is string</b> &amp;&amp; <span class="r52 r">type</span> == <b>typeof</b>(<span class="i">CultureInfo</span>))
            {
                <b>return</b> <b>new</b> <span class="i">CultureInfo</span>((<b>string</b>)<span class="r51 r">obj</span>);
            }
            <b>else</b> <b>if</b> (<span class="r51 r">obj</span> <b>is</b> <a href="../../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> &amp;&amp; <span class="r52 r">type</span> == <b>typeof</b>(<span class="i">Exception</span>))
            {
                <b>return</b> <a href="#3f6353df88c39941" class="i method">DecodeException</a>((<a href="../../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>)<span class="r51 r">obj</span>);
            }
            <b>else</b> <b>if</b> (<span class="r51 r">obj</span> <b>is</b> <a href="../../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> &amp;&amp; <span class="r52 r">type</span> == <b>typeof</b>(<b>object</b>[]))
            {
                <b>return</b> <a href="#d57b38f2be2965d3" class="i method">DecodeObjectArray</a>((<a href="../../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>)<span class="r51 r">obj</span>);
            }
            <b>else</b> <b>if</b> (<span class="r51 r">obj</span> <b>is</b> <a href="../../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> &amp;&amp; <span class="r52 r">type</span>.<span class="i">IsArray</span>)
            {
                <b>return</b> <a href="#1e2deac22f677787" class="i method">DecodeArray</a>((<a href="../../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>)<span class="r51 r">obj</span>, <span class="r52 r">type</span>);
            }
            <b>else</b> <b>if</b> (<span class="r51 r">obj</span> <b>is</b> <a href="../../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> &amp;&amp; <a href="#1bd37b7ab4bd4b43" class="i method">IsCollection</a>(<span class="r52 r">type</span>))
            {
                <b>return</b> <a href="#c3322f488cf67b1d" class="i method">DecodeCollection</a>((<a href="../../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>)<span class="r51 r">obj</span>, <span class="r52 r">type</span>);
            }
            <b>else</b> <b>if</b> (<span class="r51 r">obj</span> <b>is</b> <a href="../../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> &amp;&amp; <a href="#e09cf1d01c304d13" class="i method">IsDictionary</a>(<span class="r52 r">type</span>))
            {
                <b>return</b> <a href="#1d815430dd6b1370" class="i method">DecodeDictionary</a>((<a href="../../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>)<span class="r51 r">obj</span>, <span class="r52 r">type</span>);
            }
            <b>else</b> <b>if</b> (<span class="r51 r">obj</span> <b>is</b> <a href="../../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> &amp;&amp; <a href="#3b21b80badedcd5e" class="i method">IsEncodingAllowedForClassOrStruct</a>(<span class="r52 r">type</span>))
            {
                <b>return</b> <a href="#c8db802104329836" class="i method">DecodeClassOrStruct</a>((<a href="../../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>)<span class="r51 r">obj</span>, <span class="r52 r">type</span>);
            }
            <b>else</b> <b>if</b> (<span class="r51 r">obj</span> <b>is</b> <a href="../../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> &amp;&amp; <a href="#ffa538a572090151" class="i method">IsGenericIEnumerableOfInt</a>(<span class="r52 r">type</span>))
            {
                <span class="c">// we cannot create an instance of interface type like IEnumerable</span>
                <span class="c">// Since a Collection implements IEnumerable, falling back to use</span>
                <span class="c">// that.</span>
                <b>return</b> <span class="i">DecodeCollection</span>((<a href="../../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>)<span class="r51 r">obj</span>, <b>typeof</b>(<span class="i">Collection</span>&lt;<b>int</b>&gt;));
            }
            <b>else</b> <b>if</b> (<span class="r51 r">obj</span> <b>is</b> <a href="../../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> &amp;&amp; <span class="r52 r">type</span> == <b>typeof</b>(<a href="RemoteHost.cs.html#8bf334b011b63f92" class="t t">RemoteHostCall</a>))
            {
                <b>return</b> <a href="RemoteHost.cs.html#8bf334b011b63f92" class="t t">RemoteHostCall</a>.<a href="RemoteHost.cs.html#c603556c125f7c63" class="i method">Decode</a>((<a href="../../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>)<span class="r51 r">obj</span>);
            }
            <b>else</b> <b>if</b> (<span class="r51 r">obj</span> <b>is</b> <a href="../../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> &amp;&amp; <span class="r52 r">type</span> == <b>typeof</b>(<a href="RemoteHost.cs.html#2088d050a88e3ac6" class="t t">RemoteHostResponse</a>))
            {
                <b>return</b> <a href="RemoteHost.cs.html#2088d050a88e3ac6" class="t t">RemoteHostResponse</a>.<a href="RemoteHost.cs.html#bb70fcce88a4188e" class="i method">Decode</a>((<a href="../../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>)<span class="r51 r">obj</span>);
            }
            <b>else</b>
            {
                <b>throw</b> <a href="RemoteHost.cs.html#b4240fded240f14a" class="t t">RemoteHostExceptions</a>.<a href="RemoteHost.cs.html#a33ff02c30f768e0" class="i method">NewRemoteHostDataDecodingNotSupportedException</a>(<span class="r52 r">type</span>);
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Encode and add as property.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal static void</b> <a id="23428b9baeef2fd8" href="../../../../R/23428b9baeef2fd8.html" target="n" data-glyph="74,1" class="i method">EncodeAndAddAsProperty</a>(<a href="../../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r55 rd" class="r55 r">psObject</span>, <b>string</b> <span id="r56 rd" class="r56 r">propertyName</span>, <b>object</b> <span id="r57 rd" class="r57 r">propertyValue</span>)
        {
            <a href="../../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r55 r">psObject</span> != <b>null</b>, <span class="s">&quot;Expected psObject != null&quot;</span>);
            <a href="../../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r56 r">propertyName</span> != <b>null</b>, <span class="s">&quot;Expected propertyName != null&quot;</span>);
            <b>if</b> (<span class="r57 r">propertyValue</span> == <b>null</b>)
            {
                <b>return</b>;
            }
 
            <span class="r55 r">psObject</span>.<a href="../../../MshObject.cs.html#59e9cd1ad57ccd34" class="i property">Properties</a>.<a href="../../../MshMemberInfo.cs.html#a9e3a2dc56d98237" class="i method">Add</a>(<b>new</b> <a href="../../../MshMemberInfo.cs.html#f4e5bccf8ccb9f2a" class="t constructor">PSNoteProperty</a>(<span class="r56 r">propertyName</span>, <a href="#7c8e1a4e8e4ec484" class="i method">EncodeObject</a>(<span class="r57 r">propertyValue</span>)));
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Decode property value.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal static object</b> <a id="8969fd24be9fc354" href="../../../../R/8969fd24be9fc354.html" target="n" data-glyph="74,1" class="i method">DecodePropertyValue</a>(<a href="../../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r58 rd" class="r58 r">psObject</span>, <b>string</b> <span id="r59 rd" class="r59 r">propertyName</span>, <span class="i">Type</span> <span id="r60 rd" class="r60 r">propertyValueType</span>)
        {
            <a href="../../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r58 r">psObject</span> != <b>null</b>, <span class="s">&quot;Expected psObject != null&quot;</span>);
            <a href="../../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r59 r">propertyName</span> != <b>null</b>, <span class="s">&quot;Expected propertyName != null&quot;</span>);
            <a href="../../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r60 r">propertyValueType</span> != <b>null</b>, <span class="s">&quot;Expected propertyValueType != null&quot;</span>);
            <a href="../../../MshMemberInfo.cs.html#4dd963b2f49e6c5a" class="t t">ReadOnlyPSMemberInfoCollection</a>&lt;<a href="../../../MshMemberInfo.cs.html#13ab3796654e613c" class="t t">PSPropertyInfo</a>&gt; <span id="r61 rd" class="r61 r">matches</span> = <span class="r58 r">psObject</span>.<a href="../../../MshObject.cs.html#59e9cd1ad57ccd34" class="i property">Properties</a>.<a href="../../../MshMemberInfo.cs.html#f1c7fd033259dd43" class="i method">Match</a>(<span class="r59 r">propertyName</span>);
            <b>if</b> (<span class="r61 r">matches</span>.<a href="../../../MshMemberInfo.cs.html#4fcb958a2e493168" class="i property">Count</a> == 0)
            {
                <b>return</b> <b>null</b>;
            }
 
            <a href="../../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r61 r">matches</span>.<a href="../../../MshMemberInfo.cs.html#4fcb958a2e493168" class="i property">Count</a> == 1, <span class="s">&quot;Expected matches.Count == 1&quot;</span>);
            <b>return</b> <a href="#509f16b4d334125b" class="i method">DecodeObject</a>(<span class="r61 r">matches</span>[0].<a href="../../../MshMemberInfo.cs.html#cd3a9989baedf3dd" class="i property">Value</a>, <span class="r60 r">propertyValueType</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Encode object array.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private static</b> <a href="../../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <a id="21e3d03d87ecc00c" href="../../../../R/21e3d03d87ecc00c.html" target="n" data-glyph="76,1" class="i method">EncodeObjectArray</a>(<b>object</b>[] <span id="r62 rd" class="r62 r">objects</span>)
        {
            <span class="i">ArrayList</span> <span id="r63 rd" class="r63 r">arrayList</span> = <b>new</b> <span class="i">ArrayList</span>();
            <b>foreach</b> (<b>object</b> <span id="r64 rd" class="r64 r">obj</span> <b>in</b> <span class="r62 r">objects</span>)
            {
                <span class="r63 r">arrayList</span>.<span class="i">Add</span>(<a href="#8bda456577d00ea9" class="i method">EncodeObjectWithType</a>(<span class="r64 r">obj</span>));
            }
 
            <b>return</b> <b>new</b> <span class="t">PSObject</span>(<span class="r63 r">arrayList</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Decode object array.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private static object</b>[] <a id="d57b38f2be2965d3" href="../../../../R/d57b38f2be2965d3.html" target="n" data-glyph="76,1" class="i method">DecodeObjectArray</a>(<a href="../../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r65 rd" class="r65 r">psObject</span>)
        {
            <span class="c">// Rehydrate the array from the array list.</span>
            <span class="i">ArrayList</span> <span id="r66 rd" class="r66 r">arrayList</span> = <a href="#82b6052c02a48f0e" class="i method">SafelyGetBaseObject</a>&lt;<span class="i">ArrayList</span>&gt;(<span class="r65 r">psObject</span>);
            <b>object</b>[] <span id="r67 rd" class="r67 r">objects</span> = <b>new</b> <b>object</b>[<span class="r66 r">arrayList</span>.<span class="i">Count</span>];
            <b>for</b> (<b>int</b> <span id="r68 rd" class="r68 r">i</span> = 0; <span class="r68 r">i</span> &lt; <span class="r66 r">arrayList</span>.<span class="i">Count</span>; ++<span class="r68 r">i</span>)
            {
                <span class="r67 r">objects</span>[<span class="r68 r">i</span>] = <span class="i">DecodeObjectWithType</span>(<span class="r66 r">arrayList</span>[<span class="r68 r">i</span>]);
            }
 
            <b>return</b> <span class="r67 r">objects</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Encode object with type.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private static</b> <a href="../../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <a id="8bda456577d00ea9" href="../../../../R/8bda456577d00ea9.html" target="n" data-glyph="76,1" class="i method">EncodeObjectWithType</a>(<b>object</b> <span id="r69 rd" class="r69 r">obj</span>)
        {
            <b>if</b> (<span class="r69 r">obj</span> == <b>null</b>)
            {
                <b>return</b> <b>null</b>;
            }
 
            <a href="../../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r70 rd" class="r70 r">psObject</span> = <a href="EncodeAndDecode.cs.html#88b19073d823ce05" class="t t">RemotingEncoder</a>.<a href="EncodeAndDecode.cs.html#22d9fb1506026254" class="i method">CreateEmptyPSObject</a>();
            <span class="r70 r">psObject</span>.<a href="../../../MshObject.cs.html#59e9cd1ad57ccd34" class="i property">Properties</a>.<a href="../../../MshMemberInfo.cs.html#a9e3a2dc56d98237" class="i method">Add</a>(<b>new</b> <span class="t">PSNoteProperty</span>(<a href="EncodeAndDecode.cs.html#7c9c1b0b95848ffd" class="t t">RemoteDataNameStrings</a>.<a href="EncodeAndDecode.cs.html#861d4a33cee79bef" class="i field">ObjectType</a>, <span class="r69 r">obj</span>.<span class="i">GetType</span>().<span class="i">ToString</span>()));
            <span class="r70 r">psObject</span>.<a href="../../../MshObject.cs.html#59e9cd1ad57ccd34" class="i property">Properties</a>.<a href="../../../MshMemberInfo.cs.html#a9e3a2dc56d98237" class="i method">Add</a>(<b>new</b> <a href="../../../MshMemberInfo.cs.html#f4e5bccf8ccb9f2a" class="t constructor">PSNoteProperty</a>(<a href="EncodeAndDecode.cs.html#7c9c1b0b95848ffd" class="t t">RemoteDataNameStrings</a>.<a href="EncodeAndDecode.cs.html#6fd9ede619784d4d" class="i field">ObjectValue</a>, <a href="#7c8e1a4e8e4ec484" class="i method">EncodeObject</a>(<span class="r69 r">obj</span>)));
            <b>return</b> <span class="r70 r">psObject</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Decode object with type.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private static object</b> <a id="eb89671cf1f5500e" href="../../../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">DecodeObjectWithType</a>(<b>object</b> <span id="r71 rd" class="r71 r">obj</span>)
        {
            <b>if</b> (<span class="r71 r">obj</span> == <b>null</b>)
            {
                <b>return</b> <b>null</b>;
            }
 
            <a href="../../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r72 rd" class="r72 r">psObject</span> = <a href="#0ab7e22f29d9c2ec" class="i method">SafelyCastObject</a>&lt;<a href="../../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt;(<span class="r71 r">obj</span>);
            <b>string</b> <span id="r73 rd" class="r73 r">typeName</span> = <a href="#8952c14fbf745828" class="i method">SafelyGetPropertyValue</a>&lt;<b>string</b>&gt;(<span class="r72 r">psObject</span>, <a href="EncodeAndDecode.cs.html#7c9c1b0b95848ffd" class="t t">RemoteDataNameStrings</a>.<a href="EncodeAndDecode.cs.html#861d4a33cee79bef" class="i field">ObjectType</a>);
            <span class="i">Type</span> <span id="r74 rd" class="r74 r">type</span> = <a href="../../../LanguagePrimitives.cs.html#6dac09d64da9900c" class="t t">LanguagePrimitives</a>.<a href="../../../LanguagePrimitives.cs.html#8b9327b10b12742d" class="i method">ConvertTo</a>&lt;<span class="i">Type</span>&gt;(<span class="r73 r">typeName</span>);
            <b>object</b> <span id="r75 rd" class="r75 r">val</span> = <a href="#8952c14fbf745828" class="i method">SafelyGetPropertyValue</a>&lt;<b>object</b>&gt;(<span class="r72 r">psObject</span>, <a href="EncodeAndDecode.cs.html#7c9c1b0b95848ffd" class="t t">RemoteDataNameStrings</a>.<a href="EncodeAndDecode.cs.html#6fd9ede619784d4d" class="i field">ObjectValue</a>);
            <b>return</b> <a href="#509f16b4d334125b" class="i method">DecodeObject</a>(<span class="r75 r">val</span>, <span class="r74 r">type</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Array is zero based.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i n">System</span>.<span class="i n">Diagnostics</span>.<span class="i">CodeAnalysis</span>.<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Performance&quot;</span>, <span class="s">&quot;CA1811:AvoidUncalledPrivateCode&quot;</span>)]
        <b>private static bool</b> <a id="5e1f40070da3ec2b" href="../../../../R/5e1f40070da3ec2b.html" target="n" data-glyph="76,1" class="i method">ArrayIsZeroBased</a>(<span class="i">Array</span> <span id="r76 rd" class="r76 r">array</span>)
        {
            <b>int</b> <span id="r77 rd" class="r77 r">rank</span> = <span class="r76 r">array</span>.<span class="i">Rank</span>;
            <b>for</b> (<b>int</b> <span id="r78 rd" class="r78 r">i</span> = 0; <span class="r78 r">i</span> &lt; <span class="r77 r">rank</span>; ++<span class="r78 r">i</span>)
            {
                <b>if</b> (<span class="r76 r">array</span>.<span class="i">GetLowerBound</span>(<span class="r78 r">i</span>) != 0)
                {
                    <b>return</b> <b>false</b>;
                }
            }
 
            <b>return</b> <b>true</b>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Encode array.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private static</b> <a href="../../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <a id="9499536c1dee633e" href="../../../../R/9499536c1dee633e.html" target="n" data-glyph="76,1" class="i method">EncodeArray</a>(<span class="i">Array</span> <span id="r79 rd" class="r79 r">array</span>)
        {
            <a href="../../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r79 r">array</span> != <b>null</b>, <span class="s">&quot;Expected array != null&quot;</span>);
            <a href="../../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<a href="#5e1f40070da3ec2b" class="i method">ArrayIsZeroBased</a>(<span class="r79 r">array</span>), <span class="s">&quot;Expected ArrayIsZeroBased(array)&quot;</span>);
            <span class="i">Type</span> <span id="r80 rd" class="r80 r">arrayType</span> = <span class="r79 r">array</span>.<span class="i">GetType</span>();
            <span class="i">Type</span> <span id="r81 rd" class="r81 r">elementType</span> = <span class="r80 r">arrayType</span>.<span class="i">GetElementType</span>();
            <b>int</b> <span id="r82 rd" class="r82 r">rank</span> = <span class="r79 r">array</span>.<span class="i">Rank</span>;
            <b>int</b>[] <span id="r83 rd" class="r83 r">lengths</span> = <b>new</b> <b>int</b>[<span class="r82 r">rank</span>];
            <b>for</b> (<b>int</b> <span id="r84 rd" class="r84 r">i</span> = 0; <span class="r84 r">i</span> &lt; <span class="r82 r">rank</span>; ++<span class="r84 r">i</span>)
            {
                <span class="r83 r">lengths</span>[<span class="r84 r">i</span>] = <span class="r79 r">array</span>.<span class="i">GetUpperBound</span>(<span class="r84 r">i</span>) + 1;
            }
 
            <a href="../Indexer.cs.html#98a918a8d83717e9" class="t t">Indexer</a> <span id="r85 rd" class="r85 r">indexer</span> = <b>new</b> <a href="../Indexer.cs.html#497e24d06161348b" class="t constructor">Indexer</a>(<span class="r83 r">lengths</span>);
            <span class="i">ArrayList</span> <span id="r86 rd" class="r86 r">elements</span> = <b>new</b> <span class="i">ArrayList</span>();
            <b>foreach</b> (<b>int</b>[] <span id="r87 rd" class="r87 r">index</span> <b>in</b> <span class="r85 r">indexer</span>)
            {
                <b>object</b> <span id="r88 rd" class="r88 r">elementValue</span> = <span class="r79 r">array</span>.<span class="i">GetValue</span>(<span class="r87 r">index</span>);
                <span class="r86 r">elements</span>.<span class="i">Add</span>(<a href="#7c8e1a4e8e4ec484" class="i method">EncodeObject</a>(<span class="r88 r">elementValue</span>));
            }
 
            <a href="../../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r89 rd" class="r89 r">psObject</span> = <a href="EncodeAndDecode.cs.html#88b19073d823ce05" class="t t">RemotingEncoder</a>.<a href="EncodeAndDecode.cs.html#22d9fb1506026254" class="i method">CreateEmptyPSObject</a>();
            <span class="r89 r">psObject</span>.<a href="../../../MshObject.cs.html#59e9cd1ad57ccd34" class="i property">Properties</a>.<a href="../../../MshMemberInfo.cs.html#a9e3a2dc56d98237" class="i method">Add</a>(<b>new</b> <span class="t">PSNoteProperty</span>(<a href="EncodeAndDecode.cs.html#7c9c1b0b95848ffd" class="t t">RemoteDataNameStrings</a>.<a href="EncodeAndDecode.cs.html#e2f0cad9f64af07e" class="i field">MethodArrayElements</a>, <span class="r86 r">elements</span>));
            <span class="r89 r">psObject</span>.<a href="../../../MshObject.cs.html#59e9cd1ad57ccd34" class="i property">Properties</a>.<a href="../../../MshMemberInfo.cs.html#a9e3a2dc56d98237" class="i method">Add</a>(<b>new</b> <a href="../../../MshMemberInfo.cs.html#f4e5bccf8ccb9f2a" class="t constructor">PSNoteProperty</a>(<a href="EncodeAndDecode.cs.html#7c9c1b0b95848ffd" class="t t">RemoteDataNameStrings</a>.<a href="EncodeAndDecode.cs.html#ec419064a02a01f3" class="i field">MethodArrayLengths</a>, <span class="r83 r">lengths</span>));
            <b>return</b> <span class="r89 r">psObject</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Decode array.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private static</b> <span class="i">Array</span> <a id="1e2deac22f677787" href="../../../../R/1e2deac22f677787.html" target="n" data-glyph="76,1" class="i method">DecodeArray</a>(<a href="../../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r90 rd" class="r90 r">psObject</span>, <span class="i">Type</span> <span id="r91 rd" class="r91 r">type</span>)
        {
            <span class="c">// Extract the type.</span>
            <a href="../../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<span class="i">Assert</span>(<span class="r91 r">type</span>.<span class="i">IsArray</span>, <span class="s">&quot;Expected type.IsArray&quot;</span>);
            <span class="i">Type</span> <span id="r92 rd" class="r92 r">elementType</span> = <span class="r91 r">type</span>.<span class="i">GetElementType</span>();
 
            <span class="c">// Extract elements from psObject.</span>
            <a href="../../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r93 rd" class="r93 r">psObjectContainingElements</span> = <a href="#8952c14fbf745828" class="i method">SafelyGetPropertyValue</a>&lt;<a href="../../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt;(<span class="r90 r">psObject</span>, <a href="EncodeAndDecode.cs.html#7c9c1b0b95848ffd" class="t t">RemoteDataNameStrings</a>.<a href="EncodeAndDecode.cs.html#e2f0cad9f64af07e" class="i field">MethodArrayElements</a>);
            <span class="i">ArrayList</span> <span id="r94 rd" class="r94 r">elements</span> = <a href="#82b6052c02a48f0e" class="i method">SafelyGetBaseObject</a>&lt;<span class="i">ArrayList</span>&gt;(<span class="r93 r">psObjectContainingElements</span>);
 
            <span class="c">// Extract lengths from psObject.</span>
            <a href="../../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r95 rd" class="r95 r">psObjectContainingLengths</span> = <a href="#8952c14fbf745828" class="i method">SafelyGetPropertyValue</a>&lt;<a href="../../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt;(<span class="r90 r">psObject</span>, <a href="EncodeAndDecode.cs.html#7c9c1b0b95848ffd" class="t t">RemoteDataNameStrings</a>.<a href="EncodeAndDecode.cs.html#ec419064a02a01f3" class="i field">MethodArrayLengths</a>);
            <span class="i">ArrayList</span> <span id="r96 rd" class="r96 r">lengthsArrayList</span> = <a href="#82b6052c02a48f0e" class="i method">SafelyGetBaseObject</a>&lt;<span class="i">ArrayList</span>&gt;(<span class="r95 r">psObjectContainingLengths</span>);
            <b>int</b>[] <span id="r97 rd" class="r97 r">lengths</span> = (<b>int</b>[])<span class="r96 r">lengthsArrayList</span>.<span class="i">ToArray</span>(<b>typeof</b>(<b>int</b>));
 
            <span class="c">// Reconstitute the array.</span>
            <a href="../Indexer.cs.html#98a918a8d83717e9" class="t t">Indexer</a> <span id="r98 rd" class="r98 r">indexer</span> = <b>new</b> <a href="../Indexer.cs.html#497e24d06161348b" class="t constructor">Indexer</a>(<span class="r97 r">lengths</span>);
            <span class="i">Array</span> <span id="r99 rd" class="r99 r">array</span> = <span class="i">Array</span>.<span class="i">CreateInstance</span>(<span class="r92 r">elementType</span>, <span class="r97 r">lengths</span>);
            <b>int</b> <span id="r100 rd" class="r100 r">elementIndex</span> = 0;
            <b>foreach</b> (<b>int</b>[] <span id="r101 rd" class="r101 r">index</span> <b>in</b> <span class="r98 r">indexer</span>)
            {
                <b>object</b> <span id="r102 rd" class="r102 r">elementValue</span> = <span class="i">DecodeObject</span>(<span class="r94 r">elements</span>[<span class="r100 r">elementIndex</span>++], <span class="r92 r">elementType</span>);
                <span class="r99 r">array</span>.<span class="i">SetValue</span>(<span class="r102 r">elementValue</span>, <span class="r101 r">index</span>);
            }
 
            <b>return</b> <span class="r99 r">array</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Is object dictionary type.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private static bool</b> <a id="2ed6fc1ec9007366" href="../../../../R/2ed6fc1ec9007366.html" target="n" data-glyph="76,1" class="i method">IsObjectDictionaryType</a>(<span class="i">Type</span> <span id="r103 rd" class="r103 r">dictionaryType</span>)
        {
            <span class="c">// True if the value-type of the dictionary is object; false otherwise.</span>
            <b>if</b> (!<a href="#e09cf1d01c304d13" class="i method">IsDictionary</a>(<span class="r103 r">dictionaryType</span>)) { <b>return</b> <b>false</b>; }
 
            <span class="i">Type</span>[] <span id="r104 rd" class="r104 r">elementTypes</span> = <span class="r103 r">dictionaryType</span>.<span class="i">GetGenericArguments</span>();
            <b>if</b> (<span class="r104 r">elementTypes</span>.<span class="i">Length</span> != 2) { <b>return</b> <b>false</b>; }
 
            <span class="i">Type</span> <span id="r105 rd" class="r105 r">valueType</span> = <span class="r104 r">elementTypes</span>[1];
            <b>return</b> <span class="r105 r">valueType</span> == <b>typeof</b>(<b>object</b>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Encode object dictionary.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private static</b> <a href="../../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <a id="407d796dbe4364c0" href="../../../../R/407d796dbe4364c0.html" target="n" data-glyph="76,1" class="i method">EncodeObjectDictionary</a>(<span class="i">IDictionary</span> <span id="r106 rd" class="r106 r">dictionary</span>)
        {
            <a href="../../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="i">IsObjectDictionaryType</span>(<span class="r106 r">dictionary</span>.<span class="i">GetType</span>()), <span class="s">&quot;Expected IsObjectDictionaryType(dictionary.GetType())&quot;</span>);
 
            <span class="c">// Encode the dictionary as a hashtable.</span>
            <span class="i">Hashtable</span> <span id="r107 rd" class="r107 r">hashtable</span> = <b>new</b> <span class="i">Hashtable</span>();
            <b>foreach</b> (<b>object</b> <span id="r108 rd" class="r108 r">key</span> <b>in</b> <span class="r106 r">dictionary</span>.<span class="i">Keys</span>)
            {
                <span class="r107 r">hashtable</span>.<span class="i">Add</span>(<a href="#7c8e1a4e8e4ec484" class="i method">EncodeObject</a>(<span class="r108 r">key</span>), <span class="i">EncodeObjectWithType</span>(<span class="r106 r">dictionary</span>[<span class="r108 r">key</span>]));
            }
 
            <b>return</b> <b>new</b> <span class="t">PSObject</span>(<span class="r107 r">hashtable</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Decode object dictionary.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private static</b> <span class="i">IDictionary</span> <a id="60e1734f3161b4b3" href="../../../../R/60e1734f3161b4b3.html" target="n" data-glyph="76,1" class="i method">DecodeObjectDictionary</a>(<a href="../../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r109 rd" class="r109 r">psObject</span>, <span class="i">Type</span> <span id="r110 rd" class="r110 r">dictionaryType</span>)
        {
            <a href="../../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<a href="#2ed6fc1ec9007366" class="i method">IsObjectDictionaryType</a>(<span class="r110 r">dictionaryType</span>), <span class="s">&quot;Expected IsObjectDictionaryType(dictionaryType)&quot;</span>);
 
            <span class="c">// Get the element type.</span>
            <span class="i">Type</span>[] <span id="r111 rd" class="r111 r">elementTypes</span> = <span class="r110 r">dictionaryType</span>.<span class="i">GetGenericArguments</span>();
            <a href="../../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r111 r">elementTypes</span>.<span class="i">Length</span> == 2, <span class="s">&quot;Expected elementTypes.Length == 2&quot;</span>);
            <span class="i">Type</span> <span id="r112 rd" class="r112 r">keyType</span> = <span class="r111 r">elementTypes</span>[0];
            <span class="i">Type</span> <span id="r113 rd" class="r113 r">valueType</span> = <span class="r111 r">elementTypes</span>[1];
            <a href="../../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r113 r">valueType</span> == <b>typeof</b>(<b>object</b>), <span class="s">&quot;Expected valueType == typeof(object)&quot;</span>);
 
            <span class="c">// Rehydrate the dictionary from the hashtable.</span>
            <span class="i">Hashtable</span> <span id="r114 rd" class="r114 r">hashtable</span> = <a href="#82b6052c02a48f0e" class="i method">SafelyGetBaseObject</a>&lt;<span class="i">Hashtable</span>&gt;(<span class="r109 r">psObject</span>);
            <span class="i">IDictionary</span> <span id="r115 rd" class="r115 r">dictionary</span> = (<span class="i">IDictionary</span>)<span class="i">Activator</span>.<span class="i">CreateInstance</span>(<span class="r110 r">dictionaryType</span>);
            <b>foreach</b> (<b>object</b> <span id="r116 rd" class="r116 r">key</span> <b>in</b> <span class="r114 r">hashtable</span>.<span class="i">Keys</span>)
            {
                <span class="r115 r">dictionary</span>.<span class="i">Add</span>(
                    <a href="#509f16b4d334125b" class="i method">DecodeObject</a>(<span class="r116 r">key</span>, <span class="r112 r">keyType</span>),
                    <span class="i">DecodeObjectWithType</span>(<span class="r114 r">hashtable</span>[<span class="r116 r">key</span>]));
            }
 
            <b>return</b> <span class="r115 r">dictionary</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Safely get base object.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private static</b> <span class="r117 r t">T</span> <a id="82b6052c02a48f0e" href="../../../../R/82b6052c02a48f0e.html" target="n" data-glyph="76,1" class="i method">SafelyGetBaseObject</a>&lt;<span id="r117 rd t" class="r117 r t">T</span>&gt;(<a href="../../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r118 rd" class="r118 r">psObject</span>)
        {
            <b>if</b> (<span class="r118 r">psObject</span> == <b>null</b> || <span class="r118 r">psObject</span>.<a href="../../../MshObject.cs.html#d854d13536b70a12" class="i property">BaseObject</a> == <b>null</b> || <span class="r118 r">psObject</span>.<a href="../../../MshObject.cs.html#d854d13536b70a12" class="i property">BaseObject</a> <b>is not</b> <span class="r117 r t">T</span>)
            {
                <b>throw</b> <a href="RemoteHost.cs.html#b4240fded240f14a" class="t t">RemoteHostExceptions</a>.<a href="RemoteHost.cs.html#3107e507a0ff5c2d" class="i method">NewDecodingFailedException</a>();
            }
 
            <b>return</b> (<span class="r117 r t">T</span>)<span class="r118 r">psObject</span>.<a href="../../../MshObject.cs.html#d854d13536b70a12" class="i property">BaseObject</a>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Safely cast object.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private static</b> <span class="r119 r t">T</span> <a id="0ab7e22f29d9c2ec" href="../../../../R/0ab7e22f29d9c2ec.html" target="n" data-glyph="76,1" class="i method">SafelyCastObject</a>&lt;<span id="r119 rd t" class="r119 r t">T</span>&gt;(<b>object</b> <span id="r120 rd" class="r120 r">obj</span>)
        {
            <b>if</b> (<span class="r120 r">obj</span> <b>is</b> <span class="r119 r t">T</span>)
            {
                <b>return</b> (<span class="r119 r t">T</span>)<span class="r120 r">obj</span>;
            }
 
            <b>throw</b> <a href="RemoteHost.cs.html#b4240fded240f14a" class="t t">RemoteHostExceptions</a>.<a href="RemoteHost.cs.html#3107e507a0ff5c2d" class="i method">NewDecodingFailedException</a>();
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Safely get property value.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private static</b> <span class="r121 r t">T</span> <a id="8952c14fbf745828" href="../../../../R/8952c14fbf745828.html" target="n" data-glyph="76,1" class="i method">SafelyGetPropertyValue</a>&lt;<span id="r121 rd t" class="r121 r t">T</span>&gt;(<a href="../../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r122 rd" class="r122 r">psObject</span>, <b>string</b> <span id="r123 rd" class="r123 r">key</span>)
        {
            <a href="../../../MshMemberInfo.cs.html#13ab3796654e613c" class="t t">PSPropertyInfo</a> <span id="r124 rd" class="r124 r">propertyInfo</span> = <span class="r122 r">psObject</span>.<a href="../../../MshObject.cs.html#59e9cd1ad57ccd34" class="i property">Properties</a><a href="../../../MshMemberInfo.cs.html#f603b32aa49d3ffa">[</a><span class="r123 r">key</span>];
            <b>if</b> (<span class="r124 r">propertyInfo</span> == <b>null</b> || <span class="r124 r">propertyInfo</span>.<a href="../../../MshMemberInfo.cs.html#cd3a9989baedf3dd" class="i property">Value</a> == <b>null</b> || <span class="r124 r">propertyInfo</span>.<a href="../../../MshMemberInfo.cs.html#cd3a9989baedf3dd" class="i property">Value</a> <b>is not</b> <span class="r121 r t">T</span>)
            {
                <b>throw</b> <a href="RemoteHost.cs.html#b4240fded240f14a" class="t t">RemoteHostExceptions</a>.<a href="RemoteHost.cs.html#3107e507a0ff5c2d" class="i method">NewDecodingFailedException</a>();
            }
 
            <b>return</b> (<span class="r121 r t">T</span>)<span class="r124 r">propertyInfo</span>.<a href="../../../MshMemberInfo.cs.html#cd3a9989baedf3dd" class="i property">Value</a>;
        }
    }
}
</pre></td></tr></table></div></body></html>
