<!DOCTYPE html>
<html><head><title>RemoteRunspacePoolInternal.cs</title><link rel="stylesheet" href="../../../../styles.css"><script src="../../../../scripts.js"></script></head>
<body class="cB" onload="i(2180);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#System.Management.Automation/engine/remoting/client/RemoteRunspacePoolInternal.cs" target="_top">engine\remoting\client\RemoteRunspacePoolInternal.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#System.Management.Automation" target="_top">src\System.Management.Automation\System.Management.Automation.csproj</a> (System.Management.Automation)</td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation.</span>
<span class="c">// Licensed under the MIT License.</span>
 
<b>using</b> <span class="i n">System</span>.<span class="i">Collections</span>.<span class="i">Generic</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Collections</span>.<span class="i">ObjectModel</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Globalization</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Host</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Internal</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Remoting</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Remoting</span>.<span class="i n">Client</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Tracing</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Threading</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">PowerShell</span>.<span class="i n">Telemetry</span>;
 
<b>using</b> <span class="t">Dbg</span> = <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Diagnostics</a>;
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">LEGACYTELEMETRY</span>
<span class="e">using Microsoft.PowerShell.Telemetry.Internal;
</span><span class="k preprocess">#</span><span class="k preprocess">endif</span>
 
<b>namespace</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Runspaces</span>.<span class="i n">Internal</span>
{
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Class which supports pooling remote powerShell runspaces</span>
    <span class="c">///</span><span class="c"> on the client.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>internal class</b> <a id="1aba79be5da56f57" href="../../../R/1aba79be5da56f57.html" target="n" data-glyph="2,0" class="t t">RemoteRunspacePoolInternal</a> : <a href="../../hostifaces/RunspacePoolInternal.cs.html#f2c8813b33dfca3f" class="t t">RunspacePoolInternal</a>, <span class="i">IDisposable</span>
    {
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Constructor
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Constructor which creates a RunspacePool using the</span>
        <span class="c">///</span><span class="c"> supplied </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r0 r">connectionInfo</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c">, </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r1 r">minRunspaces</span><span class="c">&quot;</span><span class="c">/&gt;</span>
        <span class="c">///</span><span class="c"> and </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r2 r">maxRunspaces</span><span class="c">&quot;</span><span class="c">/&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r2 r">maxRunspaces</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The maximum number of Runspaces that can exist in this pool.</span>
        <span class="c">///</span><span class="c"> Should be greater than or equal to 1.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r1 r">minRunspaces</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The minimum number of Runspaces that can exist in this pool.</span>
        <span class="c">///</span><span class="c"> Should be greater than or equal to 1.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r3 r">typeTable</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The TypeTable to use while deserializing/serializing remote objects.</span>
        <span class="c">///</span><span class="c"> TypeTable has the following information used by serializer:</span>
        <span class="c">///</span><span class="c">   1. SerializationMethod</span>
        <span class="c">///</span><span class="c">   2. SerializationDepth</span>
        <span class="c">///</span><span class="c">   3. SpecificSerializationProperties</span>
        <span class="c">///</span><span class="c"> TypeTable has the following information used by deserializer:</span>
        <span class="c">///</span><span class="c">   1. TargetTypeForDeserialization</span>
        <span class="c">///</span><span class="c">   2. TypeConverter</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r4 r">host</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Host associated with this runspacepool.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r5 r">applicationArguments</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Application arguments the server can see in </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Remoting</span>.<a href="../fanin/PSPrincipal.cs.html#eeedcf9113508cb9" class="t t">PSSenderInfo</a>.<a href="../fanin/PSPrincipal.cs.html#fbb9c1201251c818" class="i property">ApplicationArguments</a><span class="c">&quot;</span><span class="c">/&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r0 r">connectionInfo</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The RunspaceConnectionInfo object</span>
        <span class="c">///</span><span class="c"> which identifies this runspace pools connection to the server</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r6 r">name</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Session name.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">ArgumentException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Maximum runspaces is less than 1.</span>
        <span class="c">///</span><span class="c"> Minimum runspaces is less than 1.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">ArgumentException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> ConnectionInfo specified is null</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>internal</b> <a id="05ca216b99b11fec" href="../../../R/05ca216b99b11fec.html" target="n" data-glyph="74,1" class="t constructor">RemoteRunspacePoolInternal</a>(<b>int</b> <span id="r1 rd" class="r1 r">minRunspaces</span>,
            <b>int</b> <span id="r2 rd" class="r2 r">maxRunspaces</span>, <a href="../../../P/a09d9b2cb7b1f0db.html#a09d9b2cb7b1f0db" class="t t">TypeTable</a> <span id="r3 rd" class="r3 r">typeTable</span>, <a href="../../hostifaces/MshHost.cs.html#7b79cd90e035740e" class="t t">PSHost</a> <span id="r4 rd" class="r4 r">host</span>, <a href="../../serialization.cs.html#04756020c00714fe" class="t t">PSPrimitiveDictionary</a> <span id="r5 rd" class="r5 r">applicationArguments</span>, <a href="../common/RunspaceConnectionInfo.cs.html#e07ed56a8a1da829" class="t t">RunspaceConnectionInfo</a> <span id="r0 rd" class="r0 r">connectionInfo</span>, <b>string</b> <span id="r6 rd" class="r6 r">name</span> = <b>null</b>)
            : <a href="../../hostifaces/RunspacePoolInternal.cs.html#d5847b3987568f15" class="k">base</a>(<span class="r1 r">minRunspaces</span>, <span class="r2 r">maxRunspaces</span>)
        {
            <b>if</b> (<span class="r0 r">connectionInfo</span> == <b>null</b>)
            {
                <b>throw</b> <a href="../../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../../../utils/MshTraceSource.cs.html#fbe67220ad7522a0" class="i method">NewArgumentNullException</a>(<span class="s">&quot;WSManConnectionInfo&quot;</span>);
            }
 
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogOperationalVerbose</span>(<a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#ef90be6dda297a97" class="i field">RunspacePoolConstructor</a>,
                    <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#ae0914f768747b55" class="i field">Constructor</a>, <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#752e56066810e4f0" class="i field">CreateRunspace</a>,
                    <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#05d709c2010b41d5" class="i field">UseAlwaysOperational</a>,
                    <a href="../../hostifaces/RunspacePoolInternal.cs.html#0d2daf8b32a561fc" class="i field">instanceId</a>.<span class="i">ToString</span>(),
                    <a href="../../hostifaces/RunspacePoolInternal.cs.html#f6fb1db5180e27f3" class="i field">minPoolSz</a>.<span class="i">ToString</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>),
                    <a href="../../hostifaces/RunspacePoolInternal.cs.html#eb45e1e66196a2b6" class="i field">maxPoolSz</a>.<span class="i">ToString</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>));
 
            <a href="#cf41f6952f7641e0" class="i field">_connectionInfo</a> = <span class="r0 r">connectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#54d6b570b04d9a9d" class="i method">InternalCopy</a>();
 
            <a href="#1aba79be5da56f57" class="k">this</a>.<a href="../../hostifaces/RunspacePoolInternal.cs.html#ceb434f916bd07a3" class="i field">host</a> = <span class="r4 r">host</span>;
            <a href="#8e2e1d8a212d75a0" class="i property">ApplicationArguments</a> = <span class="r5 r">applicationArguments</span>;
            <a href="#e9793c4f5c63d814" class="i property">AvailableForConnection</a> = <b>false</b>;
            <a href="#5fff47ad0a516624" class="i property">DispatchTable</a> = <b>new</b> <span class="t">DispatchTable</span>&lt;<b>object</b>&gt;();
            <a href="#f17432095680626f" class="i field">_runningPowerShells</a> = <b>new</b> <span class="i n">System</span>.<span class="i">Collections</span>.<span class="i">Concurrent</span>.<span class="i">ConcurrentStack</span>&lt;<a href="../../hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShell</a>&gt;();
 
            <b>if</b> (!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r6 r">name</span>))
            {
                <a href="#1aba79be5da56f57" class="k">this</a>.<a href="#1a2dda11a58f900f" class="i property">Name</a> = <span class="r6 r">name</span>;
            }
 
            <a href="#3b54de2bb02d0be6" class="i method">CreateDSHandler</a>(<span class="r3 r">typeTable</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Create a runspacepool object in the disconnected state.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r7 r">instanceId</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Identifies remote session to connect.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r8 r">name</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Friendly name for runspace pool.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r9 r">isDisconnected</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Indicates whether the runspacepool is disconnected.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r10 r">connectCommands</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Array of commands associated with this runspace pool.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r11 r">connectionInfo</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Connection information for remote server.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r12 r">host</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">PSHost object.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r13 r">typeTable</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">TypeTable for object serialization/deserialization.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal</b> <a id="1237b2843c79998f" href="../../../R/1237b2843c79998f.html" target="n" data-glyph="74,1" class="t constructor">RemoteRunspacePoolInternal</a>(<span class="i">Guid</span> <span id="r7 rd" class="r7 r">instanceId</span>, <b>string</b> <span id="r8 rd" class="r8 r">name</span>, <b>bool</b> <span id="r9 rd" class="r9 r">isDisconnected</span>,
            <a href="#b586ca980bfda5bc" class="t t">ConnectCommandInfo</a>[] <span id="r10 rd" class="r10 r">connectCommands</span>, <a href="../common/RunspaceConnectionInfo.cs.html#e07ed56a8a1da829" class="t t">RunspaceConnectionInfo</a> <span id="r11 rd" class="r11 r">connectionInfo</span>, <a href="../../hostifaces/MshHost.cs.html#7b79cd90e035740e" class="t t">PSHost</a> <span id="r12 rd" class="r12 r">host</span>, <a href="../../../P/a09d9b2cb7b1f0db.html#a09d9b2cb7b1f0db" class="t t">TypeTable</a> <span id="r13 rd" class="r13 r">typeTable</span>)
            : <a href="../../hostifaces/RunspacePoolInternal.cs.html#d5847b3987568f15" class="k">base</a>(1, 1)
        {
            <b>if</b> (<span class="r7 r">instanceId</span> == <span class="i">Guid</span>.<span class="i">Empty</span>)
            {
                <b>throw</b> <a href="../../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../../../utils/MshTraceSource.cs.html#fed5f40dc0075d41" class="i method">NewArgumentException</a>(<b>nameof</b>(<span class="r7 r">instanceId</span>));
            }
 
            <b>if</b> (<span class="r10 r">connectCommands</span> == <b>null</b>)
            {
                <b>throw</b> <a href="../../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../../../utils/MshTraceSource.cs.html#fbe67220ad7522a0" class="i method">NewArgumentNullException</a>(<span class="s">&quot;ConnectCommandInfo[]&quot;</span>);
            }
 
            <b>if</b> (<span class="r11 r">connectionInfo</span> == <b>null</b>)
            {
                <b>throw</b> <a href="../../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../../../utils/MshTraceSource.cs.html#fbe67220ad7522a0" class="i method">NewArgumentNullException</a>(<span class="s">&quot;WSManConnectionInfo&quot;</span>);
            }
 
            <b>if</b> (<span class="r11 r">connectionInfo</span> <b>is</b> <a href="../common/RunspaceConnectionInfo.cs.html#2d9d176ef419be5a" class="t t">WSManConnectionInfo</a>)
            {
                <a href="#cf41f6952f7641e0" class="i field">_connectionInfo</a> = <span class="r11 r">connectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#54d6b570b04d9a9d" class="i method">InternalCopy</a>();
            }
            <b>else</b>
            {
                <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<b>false</b>, <span class="s">&quot;ConnectionInfo must be WSManConnectionInfo&quot;</span>);
            }
 
            <span class="c">// Create the runspace pool object to have the same instanceId as the remote session.</span>
            <a href="#1aba79be5da56f57" class="k">this</a>.<a href="../../hostifaces/RunspacePoolInternal.cs.html#0d2daf8b32a561fc" class="i field">instanceId</a> = <span class="r7 r">instanceId</span>;
 
            <span class="c">// This indicates that this is a disconnected remote runspace pool and min/max values</span>
            <span class="c">// are currently unknown. These values will be updated once the object is connected.</span>
            <a href="#1aba79be5da56f57" class="k">this</a>.<a href="../../hostifaces/RunspacePoolInternal.cs.html#f6fb1db5180e27f3" class="i field">minPoolSz</a> = -1;
            <a href="#1aba79be5da56f57" class="k">this</a>.<a href="../../hostifaces/RunspacePoolInternal.cs.html#eb45e1e66196a2b6" class="i field">maxPoolSz</a> = -1;
 
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogOperationalVerbose</span>(<a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#ef90be6dda297a97" class="i field">RunspacePoolConstructor</a>,
                    <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#ae0914f768747b55" class="i field">Constructor</a>, <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#752e56066810e4f0" class="i field">CreateRunspace</a>,
                    <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#05d709c2010b41d5" class="i field">UseAlwaysOperational</a>,
                    <span class="r7 r">instanceId</span>.<span class="i">ToString</span>(),
                    <a href="../../hostifaces/RunspacePoolInternal.cs.html#f6fb1db5180e27f3" class="i field">minPoolSz</a>.<span class="i">ToString</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>),
                    <a href="../../hostifaces/RunspacePoolInternal.cs.html#eb45e1e66196a2b6" class="i field">maxPoolSz</a>.<span class="i">ToString</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>));
 
            <a href="#70f4b2d341860095" class="i property">ConnectCommands</a> = <span class="r10 r">connectCommands</span>;
            <a href="#1aba79be5da56f57" class="k">this</a>.<a href="#1a2dda11a58f900f" class="i property">Name</a> = <span class="r8 r">name</span>;
            <a href="#1aba79be5da56f57" class="k">this</a>.<a href="../../hostifaces/RunspacePoolInternal.cs.html#ceb434f916bd07a3" class="i field">host</a> = <span class="r12 r">host</span>;
            <a href="#5fff47ad0a516624" class="i property">DispatchTable</a> = <b>new</b> <span class="t">DispatchTable</span>&lt;<b>object</b>&gt;();
            <a href="#f17432095680626f" class="i field">_runningPowerShells</a> = <b>new</b> <span class="i n">System</span>.<span class="i">Collections</span>.<span class="i">Concurrent</span>.<span class="i">ConcurrentStack</span>&lt;<a href="../../hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShell</a>&gt;();
 
            <span class="c">// Create this object in the disconnected state.</span>
            <a href="#bb418a07ac8ba418" class="i method">SetRunspacePoolState</a>(<b>new</b> <a href="../common/RunspacePoolStateInfo.cs.html#c7dae263df1aded0" class="t constructor">RunspacePoolStateInfo</a>(<a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#fb0d368190577383" class="i field">Disconnected</a>, <b>null</b>));
 
            <a href="#3b54de2bb02d0be6" class="i method">CreateDSHandler</a>(<span class="r13 r">typeTable</span>);
 
            <a href="#e9793c4f5c63d814" class="i property">AvailableForConnection</a> = <span class="r9 r">isDisconnected</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Helper method to create the dispatchTable and dataStructureHandler objects.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private void</b> <a id="3b54de2bb02d0be6" href="../../../R/3b54de2bb02d0be6.html" target="n" data-glyph="76,1" class="i method">CreateDSHandler</a>(<a href="../../../P/a09d9b2cb7b1f0db.html#a09d9b2cb7b1f0db" class="t t">TypeTable</a> <span id="r14 rd" class="r14 r">typeTable</span>)
        {
            <a href="#6629c704c27c6e09" class="i property">DataStructureHandler</a> = <b>new</b> <a href="RemotingProtocol2.cs.html#361d769aef2a93b5" class="t constructor">ClientRunspacePoolDataStructureHandler</a>(<a href="#1aba79be5da56f57" class="k">this</a>, <span class="r14 r">typeTable</span>);
 
            <span class="c">// register for events from the data structure handler</span>
            <a href="#6629c704c27c6e09" class="i property">DataStructureHandler</a>.<a href="RemotingProtocol2.cs.html#04f3f3687cb34938" class="i">RemoteHostCallReceived</a> += <span class="i">HandleRemoteHostCalls</span>;
            <a href="#6629c704c27c6e09" class="i property">DataStructureHandler</a>.<a href="RemotingProtocol2.cs.html#fa0a7b8972a210b1" class="i">StateInfoReceived</a> += <span class="i">HandleStateInfoReceived</span>;
            <a href="#6629c704c27c6e09" class="i property">DataStructureHandler</a>.<a href="RemotingProtocol2.cs.html#bf58d5a4ed614edf" class="i">RSPoolInitInfoReceived</a> += <span class="i">HandleInitInfoReceived</span>;
            <a href="#6629c704c27c6e09" class="i property">DataStructureHandler</a>.<a href="RemotingProtocol2.cs.html#fb769c5336c2662c" class="i">ApplicationPrivateDataReceived</a> += <span class="i">HandleApplicationPrivateDataReceived</span>;
            <a href="#6629c704c27c6e09" class="i property">DataStructureHandler</a>.<a href="RemotingProtocol2.cs.html#dffa826144552f7a" class="i">SessionClosing</a> += <span class="i">HandleSessionClosing</span>;
            <a href="#6629c704c27c6e09" class="i property">DataStructureHandler</a>.<a href="RemotingProtocol2.cs.html#23d0434265cec36a" class="i">SessionClosed</a> += <span class="i">HandleSessionClosed</span>;
            <a href="#6629c704c27c6e09" class="i property">DataStructureHandler</a>.<a href="RemotingProtocol2.cs.html#51a9e31e7d8d7778" class="i">SetMaxMinRunspacesResponseReceived</a> += <span class="i">HandleResponseReceived</span>;
            <a href="#6629c704c27c6e09" class="i property">DataStructureHandler</a>.<a href="RemotingProtocol2.cs.html#a349be0ddd33b0cd" class="i">URIRedirectionReported</a> += <span class="i">HandleURIDirectionReported</span>;
            <a href="#6629c704c27c6e09" class="i property">DataStructureHandler</a>.<a href="RemotingProtocol2.cs.html#06dff54382619c9e" class="i">PSEventArgsReceived</a> += <span class="i">HandlePSEventArgsReceived</span>;
            <a href="#6629c704c27c6e09" class="i property">DataStructureHandler</a>.<a href="RemotingProtocol2.cs.html#397e074e3b0ebf78" class="i">SessionDisconnected</a> += <span class="i">HandleSessionDisconnected</span>;
            <a href="#6629c704c27c6e09" class="i property">DataStructureHandler</a>.<a href="RemotingProtocol2.cs.html#91398fc57675dda3" class="i">SessionReconnected</a> += <span class="i">HandleSessionReconnected</span>;
            <a href="#6629c704c27c6e09" class="i property">DataStructureHandler</a>.<a href="RemotingProtocol2.cs.html#2cbf947810fb0658" class="i">SessionRCDisconnecting</a> += <span class="i">HandleSessionRCDisconnecting</span>;
            <a href="#6629c704c27c6e09" class="i property">DataStructureHandler</a>.<a href="RemotingProtocol2.cs.html#c0f2f1dcd50aeb85" class="i">SessionCreateCompleted</a> += <span class="i">HandleSessionCreateCompleted</span>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Constructors
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Properties
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The connection associated with this runspace pool.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public override</b> <a href="../common/RunspaceConnectionInfo.cs.html#e07ed56a8a1da829" class="t t">RunspaceConnectionInfo</a> <a id="adb799cd03979b7a" href="../../../R/adb799cd03979b7a.html" target="n" data-glyph="102,1" class="i property">ConnectionInfo</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#cf41f6952f7641e0" class="i field">_connectionInfo</a>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The ClientRunspacePoolDataStructureHandler associated with this</span>
        <span class="c">///</span><span class="c"> runspace pool.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal</b> <a href="RemotingProtocol2.cs.html#7269f3ebd9b81159" class="t t">ClientRunspacePoolDataStructureHandler</a> <a id="6629c704c27c6e09" href="../../../R/6629c704c27c6e09.html" target="n" data-glyph="104,1" class="i property">DataStructureHandler</a> { <b>get</b>; <b>private set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> List of CommandConnectInfo objects for each remote running command</span>
        <span class="c">///</span><span class="c"> associated with this remote runspace pool.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal</b> <a href="#b586ca980bfda5bc" class="t t">ConnectCommandInfo</a>[] <a id="70f4b2d341860095" href="../../../R/70f4b2d341860095.html" target="n" data-glyph="104,1" class="i property">ConnectCommands</a> { <b>get</b>; <b>set</b>; } = <b>null</b>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets and sets the name string for this runspace pool object.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal string</b> <a id="1a2dda11a58f900f" href="../../../R/1a2dda11a58f900f.html" target="n" data-glyph="104,1" class="i property">Name</a>
        {
            <b>get</b> { <b>return</b> <a href="#abd906b35b0db638" class="i field">_friendlyName</a>; }
 
            <b>set</b> { <a href="#abd906b35b0db638" class="i field">_friendlyName</a> = <b>value</b> ?? <b>string</b>.<span class="i">Empty</span>; }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Indicates whether this runspace pools viable/available for connection.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal bool</b> <a id="e9793c4f5c63d814" href="../../../R/e9793c4f5c63d814.html" target="n" data-glyph="104,1" class="i property">AvailableForConnection</a> { <b>get</b>; <b>private set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Returns robust connection maximum retry time in milliseconds.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal int</b> <a id="53c4363b38e872a7" href="../../../R/53c4363b38e872a7.html" target="n" data-glyph="104,1" class="i property">MaxRetryConnectionTime</a>
        {
            <b>get</b>
            {
                <b>return</b> (<a href="#6629c704c27c6e09" class="i property">DataStructureHandler</a> != <b>null</b>) ? <a href="#6629c704c27c6e09" class="i property">DataStructureHandler</a>.<a href="RemotingProtocol2.cs.html#871adff805ee69f0" class="i property">MaxRetryConnectionTime</a> : 0;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Returns runspace pool availability.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public override</b> <a href="../../hostifaces/RunspacePool.cs.html#a2574df6d6211c0d" class="t t">RunspacePoolAvailability</a> <a id="4a7edfdd07f6a5c9" href="../../../R/4a7edfdd07f6a5c9.html" target="n" data-glyph="102,1" class="i property">RunspacePoolAvailability</a>
        {
            <b>get</b>
            {
                <a href="../../hostifaces/RunspacePool.cs.html#a2574df6d6211c0d" class="t t">RunspacePoolAvailability</a> <span id="r15 rd" class="r15 r">availability</span>;
                <b>if</b> (<a href="../../hostifaces/RunspacePoolInternal.cs.html#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a> == <a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#fb0d368190577383" class="i field">Disconnected</a>)
                {
                    <span class="c">// Set availability for disconnected runspace pool in the</span>
                    <span class="c">// same way it is set for runspaces.</span>
                    <span class="r15 r">availability</span> = (<a href="#e9793c4f5c63d814" class="i property">AvailableForConnection</a>) ?
                            <a href="../../hostifaces/RunspacePool.cs.html#a2574df6d6211c0d" class="t t">RunspacePoolAvailability</a>.<a href="../../hostifaces/RunspacePool.cs.html#080faa50d5a98f5b" class="i field">None</a> :     <span class="c">// Disconnected runspacepool available for connection.</span>
                            <a href="../../hostifaces/RunspacePool.cs.html#a2574df6d6211c0d" class="t t">RunspacePoolAvailability</a>.<a href="../../hostifaces/RunspacePool.cs.html#aea7d508a7416a71" class="i field">Busy</a>;      <span class="c">// Disconnected runspacepool unavailable for connection.</span>
                }
                <b>else</b>
                {
                    <span class="r15 r">availability</span> = <a href="../../hostifaces/RunspacePoolInternal.cs.html#f2c8813b33dfca3f" class="k">base</a>.<a href="../../hostifaces/RunspacePoolInternal.cs.html#acd5e3a5040e8caa" class="i property">RunspacePoolAvailability</a>;
                }
 
                <b>return</b> <span class="r15 r">availability</span>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Property to indicate that the debugger associated to this</span>
        <span class="c">///</span><span class="c"> remote runspace is in debug stop mode.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal bool</b> <a id="f8874da4a5c43ab5" href="../../../R/f8874da4a5c43ab5.html" target="n" data-glyph="104,1" class="i property">IsRemoteDebugStop</a>
        {
            <b>get</b>;
            <b>set</b>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> internal Methods
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Resets the runspace state on a runspace pool with a single</span>
        <span class="c">///</span><span class="c"> runspace.</span>
        <span class="c">///</span><span class="c"> This is currently supported *only* for remote runspaces.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">True if successful.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal override bool</b> <a id="e39ebaaa11f3f4de" href="../../../R/e39ebaaa11f3f4de.html" target="n" data-glyph="74,1" class="i method">ResetRunspaceState</a>()
        {
            <span class="c">// Version check.  Reset Runspace is supported only on PSRP protocol</span>
            <span class="c">// version 2.3 or greater.</span>
            <span class="i">Version</span> <span id="r16 rd" class="r16 r">remoteProtocolVersionDeclaredByServer</span> = <a href="#d44f4f1c4f3907db" class="i property">PSRemotingProtocolVersion</a>;
            <b>if</b> ((<span class="r16 r">remoteProtocolVersionDeclaredByServer</span> == <b>null</b>) ||
                (<span class="r16 r">remoteProtocolVersionDeclaredByServer</span> &lt; <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#d19a1042a44001e8" class="t t">RemotingConstants</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#a52fd4a38c196083" class="i field">ProtocolVersionWin10RTM</a>))
            {
                <b>throw</b> <a href="../../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<span class="i">NewInvalidOperationException</span>(<span class="i">RunspacePoolStrings</span>.<span class="i">ResetRunspaceStateNotSupportedOnServer</span>);
            }
 
            <b>long</b> <span id="r17 rd" class="r17 r">callId</span> = 0;
 
            <b>lock</b> (<a href="../../hostifaces/RunspacePoolInternal.cs.html#21db200b449932ac" class="i field">syncObject</a>)
            {
                <span class="r17 r">callId</span> = <a href="#5fff47ad0a516624" class="i property">DispatchTable</a>.<a href="../common/DispatchTable.cs.html#c9cd9f4e38362ba2" class="i method">CreateNewCallId</a>();
                <a href="#6629c704c27c6e09" class="i property">DataStructureHandler</a>.<a href="RemotingProtocol2.cs.html#c094016d47c8ba81" class="i method">SendResetRunspaceStateToServer</a>(<span class="r17 r">callId</span>);
            }
 
            <span class="c">// This call blocks until the response is received.</span>
            <b>object</b> <span id="r18 rd" class="r18 r">response</span> = <a href="#5fff47ad0a516624" class="i property">DispatchTable</a>.<a href="../common/DispatchTable.cs.html#46a1aac52dbe3aeb" class="i method">GetResponse</a>(<span class="r17 r">callId</span>, <b>false</b>);
            <b>return</b> (<b>bool</b>)<span class="r18 r">response</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Sets the maximum number of Runspaces that can be active concurrently</span>
        <span class="c">///</span><span class="c"> in the pool. All requests above that number remain queued until</span>
        <span class="c">///</span><span class="c"> runspaces become available.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r19 r">maxRunspaces</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The maximum number of runspaces in the pool.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> true if the change is successful; otherwise, false.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> You cannot set the number of runspaces to a number smaller than</span>
        <span class="c">///</span><span class="c"> the minimum runspaces.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>internal override bool</b> <a id="727b84250aea3ef8" href="../../../R/727b84250aea3ef8.html" target="n" data-glyph="74,1" class="i method">SetMaxRunspaces</a>(<b>int</b> <span id="r19 rd" class="r19 r">maxRunspaces</span>)
        {
            <b>bool</b> <span id="r20 rd" class="r20 r">isSizeIncreased</span> = <b>false</b>;
            <b>long</b> <span id="r21 rd" class="r21 r">callId</span> = 0;
 
            <b>lock</b> (<a href="../../hostifaces/RunspacePoolInternal.cs.html#21db200b449932ac" class="i field">syncObject</a>)
            {
                <b>if</b> (<span class="r19 r">maxRunspaces</span> &lt; <a href="../../hostifaces/RunspacePoolInternal.cs.html#f6fb1db5180e27f3" class="i field">minPoolSz</a> || <span class="r19 r">maxRunspaces</span> == <a href="../../hostifaces/RunspacePoolInternal.cs.html#eb45e1e66196a2b6" class="i field">maxPoolSz</a> || <a href="../../hostifaces/RunspacePoolInternal.cs.html#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a> == <a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#494904731e18b593" class="i field">Closed</a>
                    || <a href="../../hostifaces/RunspacePoolInternal.cs.html#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a> == <a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#2b6027539b9d1816" class="i field">Closing</a> || <a href="../../hostifaces/RunspacePoolInternal.cs.html#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a> == <a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#48a121178c7c288f" class="i field">Broken</a>)
                {
                    <b>return</b> <b>false</b>;
                }
 
                <span class="c">// if the runspace pool is not opened as yet, or is in Disconnected state.</span>
                <span class="c">// just change the value locally. No need to</span>
                <span class="c">// send a message</span>
                <b>if</b> (<a href="../../hostifaces/RunspacePoolInternal.cs.html#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a> == <a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#66c805b7b59385a4" class="i field">BeforeOpen</a> ||
                    <a href="../../hostifaces/RunspacePoolInternal.cs.html#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a> == <a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#fb0d368190577383" class="i field">Disconnected</a>)
                {
                    <a href="../../hostifaces/RunspacePoolInternal.cs.html#eb45e1e66196a2b6" class="i field">maxPoolSz</a> = <span class="r19 r">maxRunspaces</span>;
                    <b>return</b> <b>true</b>;
                }
 
                <span class="c">// sending the message should be done withing the lock</span>
                <span class="c">// to ensure that multiple calls to SetMaxRunspaces</span>
                <span class="c">// will be executed on the server in the order in which</span>
                <span class="c">// they were called in the client</span>
                <span class="r21 r">callId</span> = <a href="#5fff47ad0a516624" class="i property">DispatchTable</a>.<a href="../common/DispatchTable.cs.html#c9cd9f4e38362ba2" class="i method">CreateNewCallId</a>();
 
                <a href="#6629c704c27c6e09" class="i property">DataStructureHandler</a>.<a href="RemotingProtocol2.cs.html#e8b3b9c5905097a8" class="i method">SendSetMaxRunspacesToServer</a>(<span class="r19 r">maxRunspaces</span>, <span class="r21 r">callId</span>);
            }
 
            <span class="c">// this call blocks until the response is received</span>
            <b>object</b> <span id="r22 rd" class="r22 r">response</span> = <a href="#5fff47ad0a516624" class="i property">DispatchTable</a>.<a href="../common/DispatchTable.cs.html#46a1aac52dbe3aeb" class="i method">GetResponse</a>(<span class="r21 r">callId</span>, <b>false</b>);
 
            <span class="r20 r">isSizeIncreased</span> = (<b>bool</b>)<span class="r22 r">response</span>;
 
            <b>if</b> (<span class="r20 r">isSizeIncreased</span>)
            {
                <b>lock</b> (<a href="../../hostifaces/RunspacePoolInternal.cs.html#21db200b449932ac" class="i field">syncObject</a>)
                {
                    <a href="../../hostifaces/RunspacePoolInternal.cs.html#eb45e1e66196a2b6" class="i field">maxPoolSz</a> = <span class="r19 r">maxRunspaces</span>;
                }
            }
 
            <b>return</b> <span class="r20 r">isSizeIncreased</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Sets the minimum number of Runspaces that the pool maintains</span>
        <span class="c">///</span><span class="c"> in anticipation of new requests.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r23 r">minRunspaces</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The minimum number of runspaces in the pool.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> true if the change is successful; otherwise, false.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> You cannot set the number of idle runspaces to a number smaller than</span>
        <span class="c">///</span><span class="c"> 1 or greater than maximum number of active runspaces.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>internal override bool</b> <a id="e689d36cea00ed6f" href="../../../R/e689d36cea00ed6f.html" target="n" data-glyph="74,1" class="i method">SetMinRunspaces</a>(<b>int</b> <span id="r23 rd" class="r23 r">minRunspaces</span>)
        {
            <b>bool</b> <span id="r24 rd" class="r24 r">isSizeDecreased</span> = <b>false</b>;
            <b>long</b> <span id="r25 rd" class="r25 r">callId</span> = 0;
 
            <b>lock</b> (<a href="../../hostifaces/RunspacePoolInternal.cs.html#21db200b449932ac" class="i field">syncObject</a>)
            {
                <b>if</b> ((<span class="r23 r">minRunspaces</span> &lt; 1) || (<span class="r23 r">minRunspaces</span> &gt; <a href="../../hostifaces/RunspacePoolInternal.cs.html#eb45e1e66196a2b6" class="i field">maxPoolSz</a>) || (<span class="r23 r">minRunspaces</span> == <a href="../../hostifaces/RunspacePoolInternal.cs.html#f6fb1db5180e27f3" class="i field">minPoolSz</a>)
                    || <a href="../../hostifaces/RunspacePoolInternal.cs.html#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a> == <a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#494904731e18b593" class="i field">Closed</a> || <a href="../../hostifaces/RunspacePoolInternal.cs.html#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a> == <a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#2b6027539b9d1816" class="i field">Closing</a> ||
                    <a href="../../hostifaces/RunspacePoolInternal.cs.html#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a> == <a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#48a121178c7c288f" class="i field">Broken</a>)
                {
                    <b>return</b> <b>false</b>;
                }
 
                <span class="c">// if the runspace pool is not opened as yet, or is in Disconnected state.</span>
                <span class="c">// just change the value locally. No need to</span>
                <span class="c">// send a message</span>
                <b>if</b> (<a href="../../hostifaces/RunspacePoolInternal.cs.html#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a> == <a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#66c805b7b59385a4" class="i field">BeforeOpen</a> ||
                    <a href="../../hostifaces/RunspacePoolInternal.cs.html#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a> == <a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#fb0d368190577383" class="i field">Disconnected</a>)
                {
                    <a href="../../hostifaces/RunspacePoolInternal.cs.html#f6fb1db5180e27f3" class="i field">minPoolSz</a> = <span class="r23 r">minRunspaces</span>;
                    <b>return</b> <b>true</b>;
                }
 
                <span class="c">// sending the message should be done withing the lock</span>
                <span class="c">// to ensure that multiple calls to SetMinRunspaces</span>
                <span class="c">// will be executed on the server in the order in which</span>
                <span class="c">// they were called in the client</span>
                <span class="r25 r">callId</span> = <a href="#5fff47ad0a516624" class="i property">DispatchTable</a>.<a href="../common/DispatchTable.cs.html#c9cd9f4e38362ba2" class="i method">CreateNewCallId</a>();
 
                <a href="#6629c704c27c6e09" class="i property">DataStructureHandler</a>.<a href="RemotingProtocol2.cs.html#c9d35a601e824eae" class="i method">SendSetMinRunspacesToServer</a>(<span class="r23 r">minRunspaces</span>, <span class="r25 r">callId</span>);
            }
 
            <span class="c">// this call blocks until the response is received</span>
            <b>object</b> <span id="r26 rd" class="r26 r">response</span> = <a href="#5fff47ad0a516624" class="i property">DispatchTable</a>.<a href="../common/DispatchTable.cs.html#46a1aac52dbe3aeb" class="i method">GetResponse</a>(<span class="r25 r">callId</span>, <b>false</b>);
 
            <span class="r24 r">isSizeDecreased</span> = (<b>bool</b>)<span class="r26 r">response</span>;
 
            <b>if</b> (<span class="r24 r">isSizeDecreased</span>)
            {
                <b>lock</b> (<a href="../../hostifaces/RunspacePoolInternal.cs.html#21db200b449932ac" class="i field">syncObject</a>)
                {
                    <a href="../../hostifaces/RunspacePoolInternal.cs.html#f6fb1db5180e27f3" class="i field">minPoolSz</a> = <span class="r23 r">minRunspaces</span>;
                }
            }
 
            <b>return</b> <span class="r24 r">isSizeDecreased</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Retrieves the number of runspaces available at the time of calling</span>
        <span class="c">///</span><span class="c"> this method from the remote server.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">The number of runspaces available in the pool.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal override int</b> <a id="a0f67fd9e0fd7632" href="../../../R/a0f67fd9e0fd7632.html" target="n" data-glyph="74,1" class="i method">GetAvailableRunspaces</a>()
        {
            <b>int</b> <span id="r27 rd" class="r27 r">availableRunspaces</span> = 0;
            <b>long</b> <span id="r28 rd" class="r28 r">callId</span> = 0;
 
            <b>lock</b> (<a href="../../hostifaces/RunspacePoolInternal.cs.html#21db200b449932ac" class="i field">syncObject</a>)
            {
                <span class="c">// if the runspace pool is opened we need to</span>
                <span class="c">// get the value from the server, else</span>
                <span class="c">// return maxrunspaces</span>
                <b>if</b> (<a href="../../hostifaces/RunspacePoolInternal.cs.html#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a> == <a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#13cbf83371c004e0" class="i field">Opened</a>)
                {
                    <span class="c">// sending the message should be done withing the lock</span>
                    <span class="c">// to ensure that multiple calls to GetAvailableRunspaces</span>
                    <span class="c">// will be executed on the server in the order in which</span>
                    <span class="c">// they were called in the client</span>
                    <span class="r28 r">callId</span> = <a href="#5fff47ad0a516624" class="i property">DispatchTable</a>.<a href="../common/DispatchTable.cs.html#c9cd9f4e38362ba2" class="i method">CreateNewCallId</a>();
                }
                <b>else</b> <b>if</b> (<a href="../../hostifaces/RunspacePoolInternal.cs.html#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a> != <a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#66c805b7b59385a4" class="i field">BeforeOpen</a> &amp;&amp; <a href="../../hostifaces/RunspacePoolInternal.cs.html#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a> != <a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#3403f57e932b5ec3" class="i field">Opening</a>)
                {
                    <b>throw</b> <b>new</b> <span class="i">InvalidOperationException</span>(<span class="i">HostInterfaceExceptionsStrings</span>.<span class="i">RunspacePoolNotOpened</span>);
                }
                <b>else</b>
                {
                    <b>return</b> <a href="../../hostifaces/RunspacePoolInternal.cs.html#eb45e1e66196a2b6" class="i field">maxPoolSz</a>;
                }
 
                <a href="#6629c704c27c6e09" class="i property">DataStructureHandler</a>.<a href="RemotingProtocol2.cs.html#86b426e98414de12" class="i method">SendGetAvailableRunspacesToServer</a>(<span class="r28 r">callId</span>);
            }
 
            <span class="c">// this call blocks until the response is received</span>
            <b>object</b> <span id="r29 rd" class="r29 r">response</span> = <a href="#5fff47ad0a516624" class="i property">DispatchTable</a>.<a href="../common/DispatchTable.cs.html#46a1aac52dbe3aeb" class="i method">GetResponse</a>(<span class="r28 r">callId</span>, 0);
            <span class="r27 r">availableRunspaces</span> = (<b>int</b>)<span class="r29 r">response</span>;
 
            <b>return</b> <span class="r27 r">availableRunspaces</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The server sent application private data.  Store the data so that user</span>
        <span class="c">///</span><span class="c"> can get it later.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r30 r">eventArgs</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Argument describing this event.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r31 r">sender</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Sender of this event.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="3fc52c31385bb802" href="../../../R/../../0000000000.html" target="n" data-glyph="74,1" class="i method">HandleApplicationPrivateDataReceived</a>(<b>object</b> <span id="r31 rd" class="r31 r">sender</span>,
            <a href="../common/misc.cs.html#16d1e16a7ed9f8cc" class="t t">RemoteDataEventArgs</a>&lt;<a href="../../serialization.cs.html#04756020c00714fe" class="t t">PSPrimitiveDictionary</a>&gt; <span id="r30 rd" class="r30 r">eventArgs</span>)
        {
            <a href="#1aba79be5da56f57" class="k">this</a>.<a href="#921f404597e3e924" class="i method">SetApplicationPrivateData</a>(<span class="r30 r">eventArgs</span>.<a href="../common/misc.cs.html#0896dbbd394ce2e6" class="i property">Data</a>);
        }
 
        <b>internal void</b> <a id="90fdda4ebef6dde7" href="../../../R/../../0000000000.html" target="n" data-glyph="74,1" class="i method">HandleInitInfoReceived</a>(<b>object</b> <span id="r32 rd" class="r32 r">sender</span>,
                        <a href="../common/misc.cs.html#16d1e16a7ed9f8cc" class="t t">RemoteDataEventArgs</a>&lt;<a href="../common/RunspaceInitInfo.cs.html#3c3057f316390745" class="t t">RunspacePoolInitInfo</a>&gt; <span id="r33 rd" class="r33 r">eventArgs</span>)
        {
            <a href="../common/RunspacePoolStateInfo.cs.html#8b9143609d7a0363" class="t t">RunspacePoolStateInfo</a> <span id="r34 rd" class="r34 r">info</span> = <b>new</b> <a href="../common/RunspacePoolStateInfo.cs.html#c7dae263df1aded0" class="t constructor">RunspacePoolStateInfo</a>(<a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#13cbf83371c004e0" class="i field">Opened</a>, <b>null</b>);
 
            <b>bool</b> <span id="r35 rd" class="r35 r">raiseEvents</span> = <b>false</b>;
 
            <b>lock</b> (<a href="../../hostifaces/RunspacePoolInternal.cs.html#21db200b449932ac" class="i field">syncObject</a>)
            {
                <a href="../../hostifaces/RunspacePoolInternal.cs.html#f6fb1db5180e27f3" class="i field">minPoolSz</a> = <span class="r33 r">eventArgs</span>.<a href="../common/misc.cs.html#0896dbbd394ce2e6" class="i property">Data</a>.<a href="../common/RunspaceInitInfo.cs.html#f6458ad472c7c3b3" class="i property">MinRunspaces</a>;
                <a href="../../hostifaces/RunspacePoolInternal.cs.html#eb45e1e66196a2b6" class="i field">maxPoolSz</a> = <span class="r33 r">eventArgs</span>.<a href="../common/misc.cs.html#0896dbbd394ce2e6" class="i property">Data</a>.<a href="../common/RunspaceInitInfo.cs.html#ff4ed0c8169c770c" class="i property">MaxRunspaces</a>;
                <b>if</b> (<a href="../../hostifaces/RunspacePoolInternal.cs.html#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a> == <a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#332d1241bf520aa3" class="i field">Connecting</a>)
                {
                    <a href="#1ab56db66633b097" class="i method">ResetDisconnectedOnExpiresOn</a>();
 
                    <span class="r35 r">raiseEvents</span> = <b>true</b>;
                    <a href="#bb418a07ac8ba418" class="i method">SetRunspacePoolState</a>(<span class="r34 r">info</span>);
                }
            }
 
            <b>if</b> (<span class="r35 r">raiseEvents</span>)
            {
                <span class="c">// Private application data is sent after (post) connect.  We need</span>
                <span class="c">// to wait for application data before raising the state change</span>
                <span class="c">// Connecting -&gt; Opened event.</span>
                <span class="i">ThreadPool</span>.<span class="i">QueueUserWorkItem</span>(<span class="i">WaitAndRaiseConnectEventsProc</span>, <span class="r34 r">info</span>);
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The state of the server RunspacePool has changed. Handle</span>
        <span class="c">///</span><span class="c"> the same and reflect local states accordingly.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r36 r">eventArgs</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Argument describing this event.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r37 r">sender</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Sender of this event.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="5e4fa39dbcdd7bf9" href="../../../R/../../0000000000.html" target="n" data-glyph="74,1" class="i method">HandleStateInfoReceived</a>(<b>object</b> <span id="r37 rd" class="r37 r">sender</span>,
            <a href="../common/misc.cs.html#16d1e16a7ed9f8cc" class="t t">RemoteDataEventArgs</a>&lt;<a href="../common/RunspacePoolStateInfo.cs.html#8b9143609d7a0363" class="t t">RunspacePoolStateInfo</a>&gt; <span id="r36 rd" class="r36 r">eventArgs</span>)
        {
            <a href="../common/RunspacePoolStateInfo.cs.html#8b9143609d7a0363" class="t t">RunspacePoolStateInfo</a> <span id="r38 rd" class="r38 r">newStateInfo</span> = <span class="r36 r">eventArgs</span>.<a href="../common/misc.cs.html#0896dbbd394ce2e6" class="i property">Data</a>;
            <b>bool</b> <span id="r39 rd" class="r39 r">raiseEvents</span> = <b>false</b>;
 
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r38 r">newStateInfo</span> != <b>null</b>, <span class="s">&quot;state information should not be null&quot;</span>);
 
            <b>if</b> (<span class="r38 r">newStateInfo</span>.<a href="../common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a> == <a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#13cbf83371c004e0" class="i field">Opened</a>)
            {
                <b>lock</b> (<a href="../../hostifaces/RunspacePoolInternal.cs.html#21db200b449932ac" class="i field">syncObject</a>)
                {
                    <b>if</b> (<a href="../../hostifaces/RunspacePoolInternal.cs.html#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a> == <a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#3403f57e932b5ec3" class="i field">Opening</a>)
                    {
                        <a href="#bb418a07ac8ba418" class="i method">SetRunspacePoolState</a>(<span class="r38 r">newStateInfo</span>);
                        <span class="r39 r">raiseEvents</span> = <b>true</b>;
                    }
                }
 
                <b>if</b> (<span class="r39 r">raiseEvents</span>)
                {
                    <span class="c">// this needs to be done outside the lock to avoid a</span>
                    <span class="c">// deadlock scenario</span>
                    <a href="../../hostifaces/RunspacePoolInternal.cs.html#c96a416ffa6d47a6" class="i method">RaiseStateChangeEvent</a>(<a href="../../hostifaces/RunspacePoolInternal.cs.html#37ed160e0fbfb67a" class="i field">stateInfo</a>);
                    <a href="#4b2a5e72cdf8d101" class="i method">SetOpenAsCompleted</a>();
                }
            }
            <b>else</b> <b>if</b> (<span class="r38 r">newStateInfo</span>.<a href="../common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a> == <a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#494904731e18b593" class="i field">Closed</a> || <span class="r38 r">newStateInfo</span>.<a href="../common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a> == <a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#48a121178c7c288f" class="i field">Broken</a>)
            {
                <b>bool</b> <span id="r40 rd" class="r40 r">doClose</span> = <b>false</b>;
 
                <b>lock</b> (<a href="../../hostifaces/RunspacePoolInternal.cs.html#21db200b449932ac" class="i field">syncObject</a>)
                {
                    <b>if</b> (<a href="../../hostifaces/RunspacePoolInternal.cs.html#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a> == <a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#494904731e18b593" class="i field">Closed</a> || <a href="../../hostifaces/RunspacePoolInternal.cs.html#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a> == <a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#48a121178c7c288f" class="i field">Broken</a>)
                    {
                        <span class="c">// there is nothing to do here</span>
                        <b>return</b>;
                    }
 
                    <b>if</b> (<a href="../../hostifaces/RunspacePoolInternal.cs.html#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a> == <a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#3403f57e932b5ec3" class="i field">Opening</a>
                     || <a href="../../hostifaces/RunspacePoolInternal.cs.html#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a> == <a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#13cbf83371c004e0" class="i field">Opened</a>
                     || <a href="../../hostifaces/RunspacePoolInternal.cs.html#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a> == <a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#2b6027539b9d1816" class="i field">Closing</a>)
                    {
                        <span class="r40 r">doClose</span> = <b>true</b>;
                        <a href="#bb418a07ac8ba418" class="i method">SetRunspacePoolState</a>(<span class="r38 r">newStateInfo</span>);
                    }
                }
 
                <b>if</b> (<span class="r40 r">doClose</span>)
                {
                    <span class="c">// if closeAsyncResult is null, BeginClose is not called. That means</span>
                    <span class="c">// we are getting close event from server, in this case release the</span>
                    <span class="c">// local resources</span>
                    <b>if</b> (<a href="#deb9ddedc45cfcd0" class="i field">_closeAsyncResult</a> == <b>null</b>)
                    {
                        <span class="c">// Close the local resources.</span>
                        <a href="#6629c704c27c6e09" class="i property">DataStructureHandler</a>.<a href="RemotingProtocol2.cs.html#b00e0e445baebc5b" class="i method">CloseRunspacePoolAsync</a>();
                    }
 
                    <span class="c">// Delay notifying upper layers of finished state change event</span>
                    <span class="c">// until after transport close ack is received (HandleSessionClosed handler).</span>
                }
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> A host call has been proxied from the server which needs to</span>
        <span class="c">///</span><span class="c"> be executed.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r41 r">sender</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Sender of this event.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r42 r">eventArgs</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Arguments describing this event.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="b6b7bb6dd31c2248" href="../../../R/../../0000000000.html" target="n" data-glyph="74,1" class="i method">HandleRemoteHostCalls</a>(<b>object</b> <span id="r41 rd" class="r41 r">sender</span>,
            <a href="../common/misc.cs.html#16d1e16a7ed9f8cc" class="t t">RemoteDataEventArgs</a>&lt;<a href="../common/WireDataFormat/RemoteHost.cs.html#8bf334b011b63f92" class="t t">RemoteHostCall</a>&gt; <span id="r42 rd" class="r42 r">eventArgs</span>)
        {
            <b>if</b> (<a href="#272c7966a4f4bd80" class="i">HostCallReceived</a> != <b>null</b>)
            {
                <a href="#272c7966a4f4bd80" class="i">HostCallReceived</a>.<span class="i">SafeInvoke</span>(<span class="r41 r">sender</span>, <span class="r42 r">eventArgs</span>);
            }
            <b>else</b>
            {
                <a href="../common/WireDataFormat/RemoteHost.cs.html#8bf334b011b63f92" class="t t">RemoteHostCall</a> <span id="r43 rd" class="r43 r">hostCall</span> = <span class="r42 r">eventArgs</span>.<a href="../common/misc.cs.html#0896dbbd394ce2e6" class="i property">Data</a>;
 
                <b>if</b> (<span class="r43 r">hostCall</span>.<a href="../common/WireDataFormat/RemoteHost.cs.html#37efb27cec7c978c" class="i property">IsVoidMethod</a>)
                {
                    <span class="r43 r">hostCall</span>.<a href="../common/WireDataFormat/RemoteHost.cs.html#400d83762dea851d" class="i method">ExecuteVoidMethod</a>(<a href="../../hostifaces/RunspacePoolInternal.cs.html#ceb434f916bd07a3" class="i field">host</a>);
                }
                <b>else</b>
                {
                    <a href="../common/WireDataFormat/RemoteHost.cs.html#2088d050a88e3ac6" class="t t">RemoteHostResponse</a> <span id="r44 rd" class="r44 r">remoteHostResponse</span> = <span class="r43 r">hostCall</span>.<a href="../common/WireDataFormat/RemoteHost.cs.html#803d117187c9d69c" class="i method">ExecuteNonVoidMethod</a>(<a href="../../hostifaces/RunspacePoolInternal.cs.html#ceb434f916bd07a3" class="i field">host</a>);
                    <a href="#6629c704c27c6e09" class="i property">DataStructureHandler</a>.<a href="RemotingProtocol2.cs.html#3a23ef12d93e8d6b" class="i method">SendHostResponseToServer</a>(<span class="r44 r">remoteHostResponse</span>);
                }
            }
        }
 
        <b>internal</b> <a href="../../hostifaces/MshHost.cs.html#7b79cd90e035740e" class="t t">PSHost</a> <a id="836d29f1e729f0db" href="../../../R/836d29f1e729f0db.html" target="n" data-glyph="104,1" class="i property">Host</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="../../hostifaces/RunspacePoolInternal.cs.html#ceb434f916bd07a3" class="i field">host</a>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Application arguments to use when opening a remote session.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal</b> <a href="../../serialization.cs.html#04756020c00714fe" class="t t">PSPrimitiveDictionary</a> <a id="8e2e1d8a212d75a0" href="../../../R/8e2e1d8a212d75a0.html" target="n" data-glyph="104,1" class="i property">ApplicationArguments</a> { <b>get</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Private data to be used by applications built on top of PowerShell.</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> Remote runspace pool gets its application private data from the server (when creating the remote runspace pool)</span>
        <span class="c">///</span><span class="c"> - calling this method on a remote runspace will block until the data is received from the server.</span>
        <span class="c">///</span><span class="c"> - unless the runspace is disconnected and data hasn&#39;t been received in which case it returns null immediately.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal override</b> <a href="../../serialization.cs.html#04756020c00714fe" class="t t">PSPrimitiveDictionary</a> <a id="e5457ac2fe69c393" href="../../../R/e5457ac2fe69c393.html" target="n" data-glyph="74,1" class="i method">GetApplicationPrivateData</a>()
        {
            <b>if</b> (<a href="#1aba79be5da56f57" class="k">this</a>.<a href="../../hostifaces/RunspacePoolInternal.cs.html#f220504d3677222f" class="i property">RunspacePoolStateInfo</a>.<a href="../common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a> == <a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#fb0d368190577383" class="i field">Disconnected</a> &amp;&amp;
                !<a href="#4e668911d0a09c43" class="i field">_applicationPrivateDataReceived</a>.<span class="i">WaitOne</span>(0))
            {
                <span class="c">// Runspace pool was disconnected before application data was returned.  Application</span>
                <span class="c">// data cannot be returned with the runspace pool disconnected so return null.</span>
                <b>return</b> <b>null</b>;
            }
 
            <b>return</b> <a href="#f3fb14c2e731d9e2" class="i field">_applicationPrivateData</a>;
        }
 
        <b>internal void</b> <a id="921f404597e3e924" href="../../../R/921f404597e3e924.html" target="n" data-glyph="74,1" class="i method">SetApplicationPrivateData</a>(<a href="../../serialization.cs.html#04756020c00714fe" class="t t">PSPrimitiveDictionary</a> <span id="r45 rd" class="r45 r">applicationPrivateData</span>)
        {
            <b>lock</b> (<a href="#1aba79be5da56f57" class="k">this</a>.<a href="../../hostifaces/RunspacePoolInternal.cs.html#21db200b449932ac" class="i field">syncObject</a>)
            {
                <b>if</b> (<a href="#4e668911d0a09c43" class="i field">_applicationPrivateDataReceived</a>.<span class="i">WaitOne</span>(0))
                {
                    <b>return</b>; <span class="c">// ignore server&#39;s attempt to set application private data if it has already been set</span>
                }
 
                <a href="#f3fb14c2e731d9e2" class="i field">_applicationPrivateData</a> = <span class="r45 r">applicationPrivateData</span>;
                <a href="#4e668911d0a09c43" class="i field">_applicationPrivateDataReceived</a>.<span class="i">Set</span>();
 
                <b>foreach</b> (<a href="../../hostifaces/Connection.cs.html#7e5b8eab1aa16fd7" class="t t">Runspace</a> <span id="r46 rd" class="r46 r">runspace</span> <b>in</b> <a href="#1aba79be5da56f57" class="k">this</a>.<a href="../../hostifaces/RunspacePoolInternal.cs.html#43b18ffe73b89022" class="i field">runspaceList</a>)
                {
                    <span class="r46 r">runspace</span>.<a href="../../hostifaces/Connection.cs.html#29711178c3474b0a" class="i method">SetApplicationPrivateData</a>(<span class="r45 r">applicationPrivateData</span>);
                }
            }
        }
 
        <b>internal override void</b> <a id="df5b3dda5d14eb10" href="../../../R/df5b3dda5d14eb10.html" target="n" data-glyph="74,1" class="i method">PropagateApplicationPrivateData</a>(<a href="../../hostifaces/Connection.cs.html#7e5b8eab1aa16fd7" class="t t">Runspace</a> <span id="r47 rd" class="r47 r">runspace</span>)
        {
            <b>if</b> (<a href="#4e668911d0a09c43" class="i field">_applicationPrivateDataReceived</a>.<span class="i">WaitOne</span>(0))
            {
                <span class="r47 r">runspace</span>.<a href="../../hostifaces/Connection.cs.html#29711178c3474b0a" class="i method">SetApplicationPrivateData</a>(<a href="#1aba79be5da56f57" class="k">this</a>.<a href="#e5457ac2fe69c393" class="i method">GetApplicationPrivateData</a>());
            }
        }
 
        <b>private</b> <a href="../../serialization.cs.html#04756020c00714fe" class="t t">PSPrimitiveDictionary</a> <a id="f3fb14c2e731d9e2" href="../../../R/f3fb14c2e731d9e2.html" target="n" data-glyph="46,1" class="i field">_applicationPrivateData</a>;
        <b>private readonly</b> <span class="i">ManualResetEvent</span> <a id="4e668911d0a09c43" href="../../../R/4e668911d0a09c43.html" target="n" data-glyph="46,1" class="i field">_applicationPrivateDataReceived</a> = <b>new</b> <span class="i">ManualResetEvent</span>(<b>false</b>);
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This event is raised, when a host call is for a remote runspace</span>
        <span class="c">///</span><span class="c"> which this runspace pool wraps.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal event</b> <span class="i">EventHandler</span>&lt;<a href="../common/misc.cs.html#16d1e16a7ed9f8cc" class="t t">RemoteDataEventArgs</a>&lt;<a href="../common/WireDataFormat/RemoteHost.cs.html#8bf334b011b63f92" class="t t">RemoteHostCall</a>&gt;&gt; <a id="272c7966a4f4bd80" href="../../../R/272c7966a4f4bd80.html" target="n" data-glyph="32,1" class="i">HostCallReceived</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> EventHandler used to report connection URI redirections to the application.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal event</b> <span class="i">EventHandler</span>&lt;<a href="../common/misc.cs.html#16d1e16a7ed9f8cc" class="t t">RemoteDataEventArgs</a>&lt;<span class="i">Uri</span>&gt;&gt; <a id="4d85229304b06ad8" href="../../../R/4d85229304b06ad8.html" target="n" data-glyph="32,1" class="i">URIRedirectionReported</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Notifies the successful creation of the runspace session.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal event</b> <span class="i">EventHandler</span>&lt;<a href="../fanin/BaseTransportManager.cs.html#7d43cc7a3ac54680" class="t t">CreateCompleteEventArgs</a>&gt; <a id="4cbabe5737b8c8dc" href="../../../R/4cbabe5737b8c8dc.html" target="n" data-glyph="32,1" class="i">SessionCreateCompleted</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r48 r">shell</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="adc083491fd2d086" href="../../../R/adc083491fd2d086.html" target="n" data-glyph="74,1" class="i method">CreatePowerShellOnServerAndInvoke</a>(<a href="ClientRemotePowerShell.cs.html#b4d2ac017883b31c" class="t t">ClientRemotePowerShell</a> <span id="r48 rd" class="r48 r">shell</span>)
        {
            <a href="#6629c704c27c6e09" class="i property">DataStructureHandler</a>.<a href="RemotingProtocol2.cs.html#945cfb8a49d583cf" class="i method">CreatePowerShellOnServerAndInvoke</a>(<span class="r48 r">shell</span>);
 
            <span class="c">// send any input that may be available</span>
            <b>if</b> (!<span class="r48 r">shell</span>.<a href="ClientRemotePowerShell.cs.html#c3bd35b8d6fe0404" class="i property">NoInput</a>)
            {
                <span class="r48 r">shell</span>.<a href="ClientRemotePowerShell.cs.html#3663f71166889a90" class="i method">SendInput</a>();
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Add a ClientPowerShellDataStructureHandler to ClientRunspaceDataStructureHandler list.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r49 r">psShellInstanceId</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">PowerShell Instance Id.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r50 r">psDSHandler</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">ClientPowerShellDataStructureHandler for PowerShell.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="8aa83b594b0d44c9" href="../../../R/8aa83b594b0d44c9.html" target="n" data-glyph="74,1" class="i method">AddRemotePowerShellDSHandler</a>(<span class="i">Guid</span> <span id="r49 rd" class="r49 r">psShellInstanceId</span>, <a href="RemotingProtocol2.cs.html#ef96db27814e82f4" class="t t">ClientPowerShellDataStructureHandler</a> <span id="r50 rd" class="r50 r">psDSHandler</span>)
        {
            <a href="#6629c704c27c6e09" class="i property">DataStructureHandler</a>.<a href="RemotingProtocol2.cs.html#a4102d885e8b1ec7" class="i method">AddRemotePowerShellDSHandler</a>(<span class="r49 r">psShellInstanceId</span>, <span class="r50 r">psDSHandler</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Returns true if Runspace supports disconnect.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal bool</b> <a id="008af9ea26573908" href="../../../R/008af9ea26573908.html" target="n" data-glyph="104,1" class="i property">CanDisconnect</a>
        {
            <b>get</b>
            {
                <span class="i">Version</span> <span id="r51 rd" class="r51 r">remoteProtocolVersionDeclaredByServer</span> = <a href="#d44f4f1c4f3907db" class="i property">PSRemotingProtocolVersion</a>;
                <b>if</b> (<span class="r51 r">remoteProtocolVersionDeclaredByServer</span> != <b>null</b> &amp;&amp; <a href="#6629c704c27c6e09" class="i property">DataStructureHandler</a> != <b>null</b>)
                {
                    <span class="c">// Disconnect/Connect support is currently only provided by the WSMan transport</span>
                    <span class="c">// that is running PSRP protocol version 2.2 and greater.</span>
                    <b>return</b> (<span class="r51 r">remoteProtocolVersionDeclaredByServer</span> &gt;= <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#d19a1042a44001e8" class="t t">RemotingConstants</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#fd42c50dee2d8244" class="i field">ProtocolVersionWin8RTM</a> &amp;&amp;
                            <a href="#6629c704c27c6e09" class="i property">DataStructureHandler</a>.<a href="RemotingProtocol2.cs.html#5462b7ca1ee4d850" class="i property">EndpointSupportsDisconnect</a>);
                }
 
                <b>return</b> <b>false</b>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Returns the WinRM protocol version object for this runspace</span>
        <span class="c">///</span><span class="c"> pool connection.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal</b> <span class="i">Version</span> <a id="d44f4f1c4f3907db" href="../../../R/d44f4f1c4f3907db.html" target="n" data-glyph="104,1" class="i property">PSRemotingProtocolVersion</a>
        {
            <b>get</b>
            {
                <span class="i">Version</span> <span id="r52 rd" class="r52 r">winRMProtocolVersion</span> = <b>null</b>;
 
                <a href="../../serialization.cs.html#04756020c00714fe" class="t t">PSPrimitiveDictionary</a> <span id="r53 rd" class="r53 r">psPrimitiveDictionary</span> = <a href="#e5457ac2fe69c393" class="i method">GetApplicationPrivateData</a>();
                <b>if</b> (<span class="r53 r">psPrimitiveDictionary</span> != <b>null</b>)
                {
                    <a href="../../serialization.cs.html#04756020c00714fe" class="t t">PSPrimitiveDictionary</a>.<span class="i">TryPathGet</span>(
                        <span class="r53 r">psPrimitiveDictionary</span>,
                        <b>out</b> <span class="r52 r">winRMProtocolVersion</span>,
                        <a href="../../PSVersionInfo.cs.html#be287f9ea52b8d2f" class="t t">PSVersionInfo</a>.<a href="../../PSVersionInfo.cs.html#6f3eb6d7f2bfc1d8" class="i field">PSVersionTableName</a>,
                        <a href="../../PSVersionInfo.cs.html#be287f9ea52b8d2f" class="t t">PSVersionInfo</a>.<a href="../../PSVersionInfo.cs.html#a1769a49a5895018" class="i field">PSRemotingProtocolVersionName</a>);
                }
 
                <b>return</b> <span class="r52 r">winRMProtocolVersion</span>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Push a running PowerShell onto the stack.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r54 r">ps</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">PowerShell.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="b0e63b9b498e54b3" href="../../../R/b0e63b9b498e54b3.html" target="n" data-glyph="74,1" class="i method">PushRunningPowerShell</a>(<a href="../../hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShell</a> <span id="r54 rd" class="r54 r">ps</span>)
        {
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r54 r">ps</span> != <b>null</b>, <span class="s">&quot;Caller should not pass in null reference.&quot;</span>);
            <a href="#f17432095680626f" class="i field">_runningPowerShells</a>.<span class="i">Push</span>(<span class="r54 r">ps</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Pop the currently running PowerShell from stack.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">PowerShell.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal</b> <a href="../../hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShell</a> <a id="856f65c96543a194" href="../../../R/856f65c96543a194.html" target="n" data-glyph="74,1" class="i method">PopRunningPowerShell</a>()
        {
            <a href="../../hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShell</a> <span id="r55 rd" class="r55 r">powershell</span>;
            <b>if</b> (<a href="#f17432095680626f" class="i field">_runningPowerShells</a>.<span class="i">TryPop</span>(<b>out</b> <span class="r55 r">powershell</span>))
            {
                <b>return</b> <span class="r55 r">powershell</span>;
            }
 
            <b>return</b> <b>null</b>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Return the current running PowerShell.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">PowerShell.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal</b> <a href="../../hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShell</a> <a id="e739e4061d7c7d14" href="../../../R/e739e4061d7c7d14.html" target="n" data-glyph="74,1" class="i method">GetCurrentRunningPowerShell</a>()
        {
            <a href="../../hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShell</a> <span id="r56 rd" class="r56 r">powershell</span>;
            <b>if</b> (<a href="#f17432095680626f" class="i field">_runningPowerShells</a>.<span class="i">TryPeek</span>(<b>out</b> <span class="r56 r">powershell</span>))
            {
                <b>return</b> <span class="r56 r">powershell</span>;
            }
 
            <b>return</b> <b>null</b>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Internal Methods
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Protected Methods
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Opens the runspacepool synchronously / asynchronously.</span>
        <span class="c">///</span><span class="c"> Runspace pool must be opened before it can be used.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r57 r">isAsync</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> true to open asynchronously</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r58 r">callback</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> A AsyncCallback to call once the BeginOpen completes.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r59 r">asyncState</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> A user supplied state to call the </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r58 r">callback</span><span class="c">&quot;</span><span class="c">/&gt;</span>
        <span class="c">///</span><span class="c"> with.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> asyncResult object to monitor status of the async</span>
        <span class="c">///</span><span class="c"> open operation. This is returned only if </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r57 r">isAsync</span><span class="c">&quot;</span><span class="c">/&gt;</span>
        <span class="c">///</span><span class="c"> is true.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="../../hostifaces/RunspacePool.cs.html#741ffc1755303d69" class="t t">InvalidRunspacePoolStateException</a><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Cannot open RunspacePool because RunspacePool is not in</span>
        <span class="c">///</span><span class="c"> the BeforeOpen state.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">OutOfMemoryException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> There is not enough memory available to start this asynchronously.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>protected override</b> <span class="i">IAsyncResult</span> <a id="337ecfd42d4b304d" href="../../../R/337ecfd42d4b304d.html" target="n" data-glyph="75,1" class="i method">CoreOpen</a>(<b>bool</b> <span id="r57 rd" class="r57 r">isAsync</span>, <span class="i">AsyncCallback</span> <span id="r58 rd" class="r58 r">callback</span>,
            <b>object</b> <span id="r59 rd" class="r59 r">asyncState</span>)
        {
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<a href="../../../utils/tracing/PSEtwLog.cs.html#eb082c36055bc9a6" class="i method">SetActivityIdForCurrentThread</a>(<a href="#1aba79be5da56f57" class="k">this</a>.<a href="../../hostifaces/RunspacePoolInternal.cs.html#76aedcc22e17e7e5" class="i property">InstanceId</a>);
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<a href="../../../utils/tracing/PSEtwLog.cs.html#2cec541baaeaddc7" class="i method">LogOperationalVerbose</a>(<a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#47e1eabe709b6a0c" class="i field">RunspacePoolOpen</a>, <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#399fd86ea109ec79" class="i field">Open</a>,
                            <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#752e56066810e4f0" class="i field">CreateRunspace</a>, <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#05d709c2010b41d5" class="i field">UseAlwaysOperational</a>);
 
            <span class="c">// Telemetry here - remote session</span>
            <a href="../../../utils/Telemetry.cs.html#9832071d08aec551" class="t t">ApplicationInsightsTelemetry</a>.<span class="i">SendTelemetryMetric</span>(<a href="../../../utils/Telemetry.cs.html#3951f46d9ee8c91d" class="t t">TelemetryType</a>.<a href="../../../utils/Telemetry.cs.html#1cf75b47c1af2ffa" class="i field">RemoteSessionOpen</a>, <span class="r57 r">isAsync</span>.<span class="i">ToString</span>());
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">LEGACYTELEMETRY</span>
<span class="e">            TelemetryAPI.ReportRemoteSessionCreated(_connectionInfo);
</span><span class="k preprocess">#</span><span class="k preprocess">endif</span>
 
            <b>lock</b> (<a href="../../hostifaces/RunspacePoolInternal.cs.html#21db200b449932ac" class="i field">syncObject</a>)
            {
                <a href="../../hostifaces/RunspacePoolInternal.cs.html#38a7e17d18f5dbc9" class="i method">AssertIfStateIsBeforeOpen</a>();
 
                <a href="../../hostifaces/RunspacePoolInternal.cs.html#37ed160e0fbfb67a" class="i field">stateInfo</a> = <b>new</b> <a href="../common/RunspacePoolStateInfo.cs.html#c7dae263df1aded0" class="t constructor">RunspacePoolStateInfo</a>(<a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#3403f57e932b5ec3" class="i field">Opening</a>, <b>null</b>);
            }
 
            <span class="c">// BUGBUG: the following comment needs to be validated</span>
            <span class="c">// only one thread will reach here, so no need</span>
            <span class="c">// to lock</span>
            <a href="../../hostifaces/RunspacePoolInternal.cs.html#c96a416ffa6d47a6" class="i method">RaiseStateChangeEvent</a>(<a href="../../hostifaces/RunspacePoolInternal.cs.html#37ed160e0fbfb67a" class="i field">stateInfo</a>);
 
            <a href="../../hostifaces/RunspacePool.cs.html#bdf2646eeb96a548" class="t t">RunspacePoolAsyncResult</a> <span id="r60 rd" class="r60 r">asyncResult</span> = <b>new</b> <a href="../../hostifaces/RunspacePool.cs.html#5858f7ec065f0d15" class="t constructor">RunspacePoolAsyncResult</a>(
                    <a href="../../hostifaces/RunspacePoolInternal.cs.html#0d2daf8b32a561fc" class="i field">instanceId</a>, <span class="r58 r">callback</span>, <span class="r59 r">asyncState</span>, <b>true</b>);
 
            <a href="#309638fa94386800" class="i field">_openAsyncResult</a> = <span class="r60 r">asyncResult</span>;
 
            <span class="c">// send a message using the data structure handler to open the RunspacePool</span>
            <span class="c">// on the remote server</span>
            <a href="#6629c704c27c6e09" class="i property">DataStructureHandler</a>.<a href="RemotingProtocol2.cs.html#f02881912a691d25" class="i method">CreateRunspacePoolAndOpenAsync</a>();
 
            <b>return</b> <span class="r60 r">asyncResult</span>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Protected Methods
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Public Methods
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Synchronous open.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public override void</b> <a id="0f2a2740786e9342" href="../../../R/0f2a2740786e9342.html" target="n" data-glyph="72,1" class="i method">Open</a>()
        {
            <span class="i">IAsyncResult</span> <span id="r61 rd" class="r61 r">asyncResult</span> = <a href="../../hostifaces/RunspacePoolInternal.cs.html#9d8fd4a2bd24a85c" class="i method">BeginOpen</a>(<b>null</b>, <b>null</b>);
 
            <a href="../../hostifaces/RunspacePoolInternal.cs.html#526c7cda137675a2" class="i method">EndOpen</a>(<span class="r61 r">asyncResult</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Closes the RunspacePool and cleans all the internal</span>
        <span class="c">///</span><span class="c"> resources. This will close all the runspaces in the</span>
        <span class="c">///</span><span class="c"> runspacepool and release all the async operations</span>
        <span class="c">///</span><span class="c"> waiting for a runspace. If the pool is already closed</span>
        <span class="c">///</span><span class="c"> or broken or closing this will just return.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="../../hostifaces/RunspacePool.cs.html#741ffc1755303d69" class="t t">InvalidRunspacePoolStateException</a><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Cannot close the RunspacePool because RunspacePool is</span>
        <span class="c">///</span><span class="c"> in Closing state.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>public override void</b> <a id="7e5e1c76f4dec545" href="../../../R/7e5e1c76f4dec545.html" target="n" data-glyph="72,1" class="i method">Close</a>()
        {
            <span class="c">// close and wait</span>
            <span class="i">IAsyncResult</span> <span id="r62 rd" class="r62 r">asyncResult</span> = <a href="#1277abc60ee8c387" class="i method">BeginClose</a>(<b>null</b>, <b>null</b>);
            <a href="../../hostifaces/RunspacePoolInternal.cs.html#d46d5ac54fd693af" class="i method">EndClose</a>(<span class="r62 r">asyncResult</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Closes the RunspacePool asynchronously. To get the exceptions</span>
        <span class="c">///</span><span class="c"> that might have occurred, call EndOpen.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r63 r">callback</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> An AsyncCallback to call once the BeginClose completes</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r64 r">asyncState</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> A user supplied state to call the </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r63 r">callback</span><span class="c">&quot;</span><span class="c">/&gt;</span>
        <span class="c">///</span><span class="c"> with</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> An AsyncResult object to monitor the state of the async</span>
        <span class="c">///</span><span class="c"> operation</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public override</b> <span class="i">IAsyncResult</span> <a id="1277abc60ee8c387" href="../../../R/1277abc60ee8c387.html" target="n" data-glyph="72,1" class="i method">BeginClose</a>(<span class="i">AsyncCallback</span> <span id="r63 rd" class="r63 r">callback</span>, <b>object</b> <span id="r64 rd" class="r64 r">asyncState</span>)
        {
            <b>bool</b> <span id="r65 rd" class="r65 r">raiseEvents</span> = <b>false</b>;
            <b>bool</b> <span id="r66 rd" class="r66 r">skipClosing</span> = <b>false</b>;
            <a href="../common/RunspacePoolStateInfo.cs.html#8b9143609d7a0363" class="t t">RunspacePoolStateInfo</a> <span id="r67 rd" class="r67 r">copyState</span> = <b>new</b> <a href="../common/RunspacePoolStateInfo.cs.html#c7dae263df1aded0" class="t constructor">RunspacePoolStateInfo</a>(<a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#66c805b7b59385a4" class="i field">BeforeOpen</a>, <b>null</b>);
            <a href="../../hostifaces/RunspacePool.cs.html#bdf2646eeb96a548" class="t t">RunspacePoolAsyncResult</a> <span id="r68 rd" class="r68 r">asyncResult</span> = <b>null</b>;
 
            <b>lock</b> (<a href="../../hostifaces/RunspacePoolInternal.cs.html#21db200b449932ac" class="i field">syncObject</a>)
            {
                <b>if</b> ((<a href="../../hostifaces/RunspacePoolInternal.cs.html#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a> == <a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#494904731e18b593" class="i field">Closed</a>) ||
                    (<a href="../../hostifaces/RunspacePoolInternal.cs.html#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a> == <a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#48a121178c7c288f" class="i field">Broken</a>))
                {
                    <span class="r66 r">skipClosing</span> = <b>true</b>;
                    <span class="r68 r">asyncResult</span> = <b>new</b> <a href="../../hostifaces/RunspacePool.cs.html#5858f7ec065f0d15" class="t constructor">RunspacePoolAsyncResult</a>(<a href="../../hostifaces/RunspacePoolInternal.cs.html#0d2daf8b32a561fc" class="i field">instanceId</a>, <span class="r63 r">callback</span>, <span class="r64 r">asyncState</span>, <b>false</b>);
                }
                <b>else</b> <b>if</b> (<a href="../../hostifaces/RunspacePoolInternal.cs.html#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a> == <a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#66c805b7b59385a4" class="i field">BeforeOpen</a>)
                {
                    <span class="r67 r">copyState</span> = <a href="../../hostifaces/RunspacePoolInternal.cs.html#37ed160e0fbfb67a" class="i field">stateInfo</a> = <b>new</b> <a href="../common/RunspacePoolStateInfo.cs.html#c7dae263df1aded0" class="t constructor">RunspacePoolStateInfo</a>(<a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#494904731e18b593" class="i field">Closed</a>, <b>null</b>);
                    <span class="r65 r">raiseEvents</span> = <b>true</b>;
                    <span class="r66 r">skipClosing</span> = <b>true</b>;
                    <a href="#deb9ddedc45cfcd0" class="i field">_closeAsyncResult</a> = <b>null</b>;
                    <span class="r68 r">asyncResult</span> = <b>new</b> <a href="../../hostifaces/RunspacePool.cs.html#5858f7ec065f0d15" class="t constructor">RunspacePoolAsyncResult</a>(<a href="../../hostifaces/RunspacePoolInternal.cs.html#0d2daf8b32a561fc" class="i field">instanceId</a>, <span class="r63 r">callback</span>, <span class="r64 r">asyncState</span>, <b>false</b>);
                }
                <b>else</b> <b>if</b> (<a href="../../hostifaces/RunspacePoolInternal.cs.html#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a> == <a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#13cbf83371c004e0" class="i field">Opened</a> ||
                         <a href="../../hostifaces/RunspacePoolInternal.cs.html#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a> == <a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#3403f57e932b5ec3" class="i field">Opening</a>)
                {
                    <span class="r67 r">copyState</span> = <a href="../../hostifaces/RunspacePoolInternal.cs.html#37ed160e0fbfb67a" class="i field">stateInfo</a> = <b>new</b> <a href="../common/RunspacePoolStateInfo.cs.html#c7dae263df1aded0" class="t constructor">RunspacePoolStateInfo</a>(<a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#2b6027539b9d1816" class="i field">Closing</a>, <b>null</b>);
                    <a href="#deb9ddedc45cfcd0" class="i field">_closeAsyncResult</a> = <b>new</b> <a href="../../hostifaces/RunspacePool.cs.html#5858f7ec065f0d15" class="t constructor">RunspacePoolAsyncResult</a>(<a href="../../hostifaces/RunspacePoolInternal.cs.html#0d2daf8b32a561fc" class="i field">instanceId</a>, <span class="r63 r">callback</span>, <span class="r64 r">asyncState</span>, <b>false</b>);
                    <span class="r68 r">asyncResult</span> = <a href="#deb9ddedc45cfcd0" class="i field">_closeAsyncResult</a>;
                    <span class="r65 r">raiseEvents</span> = <b>true</b>;
                }
                <b>else</b> <b>if</b> (<a href="../../hostifaces/RunspacePoolInternal.cs.html#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a> == <a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#fb0d368190577383" class="i field">Disconnected</a> ||
                         <a href="../../hostifaces/RunspacePoolInternal.cs.html#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a> == <a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#91690c7b66b3081a" class="i field">Disconnecting</a> ||
                         <a href="../../hostifaces/RunspacePoolInternal.cs.html#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a> == <a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#332d1241bf520aa3" class="i field">Connecting</a>)
                {
                    <span class="c">// Continue with closing so the PSRP layer is aware that the client side session is</span>
                    <span class="c">// being closed.  This will result in a broken session on the client.</span>
                    <a href="#deb9ddedc45cfcd0" class="i field">_closeAsyncResult</a> = <b>new</b> <a href="../../hostifaces/RunspacePool.cs.html#5858f7ec065f0d15" class="t constructor">RunspacePoolAsyncResult</a>(<a href="../../hostifaces/RunspacePoolInternal.cs.html#0d2daf8b32a561fc" class="i field">instanceId</a>, <span class="r63 r">callback</span>, <span class="r64 r">asyncState</span>, <b>false</b>);
                    <span class="r68 r">asyncResult</span> = <a href="#deb9ddedc45cfcd0" class="i field">_closeAsyncResult</a>;
                }
                <b>else</b> <b>if</b> (<a href="../../hostifaces/RunspacePoolInternal.cs.html#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a> == <a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#2b6027539b9d1816" class="i field">Closing</a>)
                {
                    <b>return</b> <a href="#deb9ddedc45cfcd0" class="i field">_closeAsyncResult</a>;
                }
            }
 
            <span class="c">// raise the events outside the lock</span>
            <b>if</b> (<span class="r65 r">raiseEvents</span>)
            {
                <a href="../../hostifaces/RunspacePoolInternal.cs.html#c96a416ffa6d47a6" class="i method">RaiseStateChangeEvent</a>(<span class="r67 r">copyState</span>);
            }
 
            <b>if</b> (!<span class="r66 r">skipClosing</span>)
            {
                <span class="c">// SetRunspacePoolState(new RunspacePoolStateInfo(RunspacePoolState.Closing, null), true);</span>
 
                <span class="c">// send a message using the data structure handler to close the RunspacePool</span>
                <span class="c">// on the remote server</span>
                <a href="#6629c704c27c6e09" class="i property">DataStructureHandler</a>.<a href="RemotingProtocol2.cs.html#b00e0e445baebc5b" class="i method">CloseRunspacePoolAsync</a>();
            }
            <b>else</b>
            {
                <span class="c">// signal the wait handle</span>
                <span class="r68 r">asyncResult</span>.<a href="../../hostifaces/AsyncResult.cs.html#2d78c0fa1b51bb6e" class="i method">SetAsCompleted</a>(<b>null</b>);
            }
 
            <b>return</b> <span class="r68 r">asyncResult</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Synchronous disconnect.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public override void</b> <a id="dcd1d39a7bad8352" href="../../../R/dcd1d39a7bad8352.html" target="n" data-glyph="72,1" class="i method">Disconnect</a>()
        {
            <span class="i">IAsyncResult</span> <span id="r69 rd" class="r69 r">asyncResult</span> = <a href="#947e43b07383697b" class="i method">BeginDisconnect</a>(<b>null</b>, <b>null</b>);
 
            <a href="#b5d53ec4dbf75763" class="i method">EndDisconnect</a>(<span class="r69 r">asyncResult</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Asynchronous disconnect.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r70 r">callback</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">AsyncCallback object.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r71 r">state</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">State object.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">IAsyncResult.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public override</b> <span class="i">IAsyncResult</span> <a id="947e43b07383697b" href="../../../R/947e43b07383697b.html" target="n" data-glyph="72,1" class="i method">BeginDisconnect</a>(<span class="i">AsyncCallback</span> <span id="r70 rd" class="r70 r">callback</span>, <b>object</b> <span id="r71 rd" class="r71 r">state</span>)
        {
            <b>if</b> (!<a href="#008af9ea26573908" class="i property">CanDisconnect</a>)
            {
                <b>throw</b> <a href="../../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<span class="i">NewInvalidOperationException</span>(<span class="i">RunspacePoolStrings</span>.<span class="i">DisconnectNotSupportedOnServer</span>);
            }
 
            <a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a> <span id="r72 rd" class="r72 r">currentState</span>;
            <b>bool</b> <span id="r73 rd" class="r73 r">raiseEvents</span> = <b>false</b>;
            <b>lock</b> (<a href="../../hostifaces/RunspacePoolInternal.cs.html#21db200b449932ac" class="i field">syncObject</a>)
            {
                <span class="r72 r">currentState</span> = <a href="../../hostifaces/RunspacePoolInternal.cs.html#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a>;
                <b>if</b> (<span class="r72 r">currentState</span> == <a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#13cbf83371c004e0" class="i field">Opened</a>)
                {
                    <a href="../common/RunspacePoolStateInfo.cs.html#8b9143609d7a0363" class="t t">RunspacePoolStateInfo</a> <span id="r74 rd" class="r74 r">newStateInfo</span> = <b>new</b> <a href="../common/RunspacePoolStateInfo.cs.html#c7dae263df1aded0" class="t constructor">RunspacePoolStateInfo</a>(<a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#91690c7b66b3081a" class="i field">Disconnecting</a>, <b>null</b>);
 
                    <a href="#bb418a07ac8ba418" class="i method">SetRunspacePoolState</a>(<span class="r74 r">newStateInfo</span>);
                    <span class="r73 r">raiseEvents</span> = <b>true</b>;
                }
            }
 
            <span class="c">// Raise events outside of lock.</span>
            <b>if</b> (<span class="r73 r">raiseEvents</span>)
            {
                <a href="../../hostifaces/RunspacePoolInternal.cs.html#c96a416ffa6d47a6" class="i method">RaiseStateChangeEvent</a>(<a href="#1aba79be5da56f57" class="k">this</a>.<a href="../../hostifaces/RunspacePoolInternal.cs.html#37ed160e0fbfb67a" class="i field">stateInfo</a>);
            }
 
            <b>if</b> (<span class="r72 r">currentState</span> == <a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#13cbf83371c004e0" class="i field">Opened</a>)
            {
                <a href="../../hostifaces/RunspacePool.cs.html#bdf2646eeb96a548" class="t t">RunspacePoolAsyncResult</a> <span id="r75 rd" class="r75 r">asyncResult</span> = <b>new</b> <a href="../../hostifaces/RunspacePool.cs.html#5858f7ec065f0d15" class="t constructor">RunspacePoolAsyncResult</a>(
                    <a href="../../hostifaces/RunspacePoolInternal.cs.html#0d2daf8b32a561fc" class="i field">instanceId</a>, <span class="r70 r">callback</span>, <span class="r71 r">state</span>, <b>false</b>);
 
                <a href="#2c7911cd99440a88" class="i field">_disconnectAsyncResult</a> = <span class="r75 r">asyncResult</span>;
                <a href="#6629c704c27c6e09" class="i property">DataStructureHandler</a>.<a href="RemotingProtocol2.cs.html#72044423843601ca" class="i method">DisconnectPoolAsync</a>();
 
                <span class="c">// Return local reference to async object since the class member can</span>
                <span class="c">// be asynchronously nulled if the session closes suddenly.</span>
                <b>return</b> <span class="r75 r">asyncResult</span>;
            }
            <b>else</b>
            {
                <b>string</b> <span id="r76 rd" class="r76 r">message</span> = <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">RunspacePoolStrings</span>.<span class="i">InvalidRunspacePoolState</span>, <a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#13cbf83371c004e0" class="i field">Opened</a>, <a href="../../hostifaces/RunspacePoolInternal.cs.html#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a>);
                <a href="../../hostifaces/RunspacePool.cs.html#741ffc1755303d69" class="t t">InvalidRunspacePoolStateException</a> <span id="r77 rd" class="r77 r">invalidStateException</span> = <b>new</b> <a href="../../hostifaces/RunspacePool.cs.html#53060b2dd310e4fc" class="t constructor">InvalidRunspacePoolStateException</a>(<span class="r76 r">message</span>,
                        <a href="../../hostifaces/RunspacePoolInternal.cs.html#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a>, <a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#13cbf83371c004e0" class="i field">Opened</a>);
 
                <b>throw</b> <span class="r77 r">invalidStateException</span>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Waits for BeginDisconnect operation to complete.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r78 r">asyncResult</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">IAsyncResult object.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>public override void</b> <a id="b5d53ec4dbf75763" href="../../../R/b5d53ec4dbf75763.html" target="n" data-glyph="72,1" class="i method">EndDisconnect</a>(<span class="i">IAsyncResult</span> <span id="r78 rd" class="r78 r">asyncResult</span>)
        {
            <b>if</b> (<span class="r78 r">asyncResult</span> == <b>null</b>)
            {
                <b>throw</b> <a href="../../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../../../utils/MshTraceSource.cs.html#fbe67220ad7522a0" class="i method">NewArgumentNullException</a>(<b>nameof</b>(<span class="r78 r">asyncResult</span>));
            }
 
            <a href="../../hostifaces/RunspacePool.cs.html#bdf2646eeb96a548" class="t t">RunspacePoolAsyncResult</a> <span id="r79 rd" class="r79 r">rsAsyncResult</span> = <span class="r78 r">asyncResult</span> <b>as</b> <a href="../../hostifaces/RunspacePool.cs.html#bdf2646eeb96a548" class="t t">RunspacePoolAsyncResult</a>;
 
            <b>if</b> ((<span class="r79 r">rsAsyncResult</span> == <b>null</b>) ||
                (<span class="r79 r">rsAsyncResult</span>.<a href="../../hostifaces/AsyncResult.cs.html#c8afb8644f9407ba" class="i property">OwnerId</a> != <a href="../../hostifaces/RunspacePoolInternal.cs.html#0d2daf8b32a561fc" class="i field">instanceId</a>) ||
                (<span class="r79 r">rsAsyncResult</span>.<a href="../../hostifaces/RunspacePool.cs.html#52edc5f43955f90a" class="i property">IsAssociatedWithAsyncOpen</a>))
            {
                <b>throw</b> <a href="../../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<span class="i">NewArgumentException</span>(<b>nameof</b>(<span class="r78 r">asyncResult</span>),
                                                         <span class="i">RunspacePoolStrings</span>.<span class="i">AsyncResultNotOwned</span>,
                                                         <span class="s">&quot;IAsyncResult&quot;</span>,
                                                         <span class="s">&quot;BeginOpen&quot;</span>);
            }
 
            <span class="r79 r">rsAsyncResult</span>.<a href="../../hostifaces/AsyncResult.cs.html#75f5584cab706e68" class="i method">EndInvoke</a>();
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Synchronous connect.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public override void</b> <a id="a8ae5a36ba4939ef" href="../../../R/a8ae5a36ba4939ef.html" target="n" data-glyph="72,1" class="i method">Connect</a>()
        {
            <span class="i">IAsyncResult</span> <span id="r80 rd" class="r80 r">asyncResult</span> = <a href="#608026c609065c97" class="i method">BeginConnect</a>(<b>null</b>, <b>null</b>);
 
            <a href="#63974317e66015fe" class="i method">EndConnect</a>(<span class="r80 r">asyncResult</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Asynchronous connect.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r81 r">callback</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">ASyncCallback object.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r82 r">state</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">State Object.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">IAsyncResult.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public override</b> <span class="i">IAsyncResult</span> <a id="608026c609065c97" href="../../../R/608026c609065c97.html" target="n" data-glyph="72,1" class="i method">BeginConnect</a>(<span class="i">AsyncCallback</span> <span id="r81 rd" class="r81 r">callback</span>, <b>object</b> <span id="r82 rd" class="r82 r">state</span>)
        {
            <b>if</b> (!<a href="#e9793c4f5c63d814" class="i property">AvailableForConnection</a>)
            {
                <b>throw</b> <a href="../../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<span class="i">NewInvalidOperationException</span>(<span class="i">RunspacePoolStrings</span>.<span class="i">CannotConnect</span>);
            }
 
            <a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a> <span id="r83 rd" class="r83 r">currentState</span>;
            <b>bool</b> <span id="r84 rd" class="r84 r">raiseEvents</span> = <b>false</b>;
            <b>lock</b> (<a href="../../hostifaces/RunspacePoolInternal.cs.html#21db200b449932ac" class="i field">syncObject</a>)
            {
                <span class="r83 r">currentState</span> = <a href="../../hostifaces/RunspacePoolInternal.cs.html#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a>;
                <b>if</b> (<span class="r83 r">currentState</span> == <a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#fb0d368190577383" class="i field">Disconnected</a>)
                {
                    <a href="../common/RunspacePoolStateInfo.cs.html#8b9143609d7a0363" class="t t">RunspacePoolStateInfo</a> <span id="r85 rd" class="r85 r">newStateInfo</span> = <b>new</b> <a href="../common/RunspacePoolStateInfo.cs.html#c7dae263df1aded0" class="t constructor">RunspacePoolStateInfo</a>(<a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#332d1241bf520aa3" class="i field">Connecting</a>, <b>null</b>);
 
                    <a href="#bb418a07ac8ba418" class="i method">SetRunspacePoolState</a>(<span class="r85 r">newStateInfo</span>);
                    <span class="r84 r">raiseEvents</span> = <b>true</b>;
                }
            }
 
            <span class="c">// Raise events outside of lock.</span>
            <b>if</b> (<span class="r84 r">raiseEvents</span>)
            {
                <a href="../../hostifaces/RunspacePoolInternal.cs.html#c96a416ffa6d47a6" class="i method">RaiseStateChangeEvent</a>(<a href="#1aba79be5da56f57" class="k">this</a>.<a href="../../hostifaces/RunspacePoolInternal.cs.html#37ed160e0fbfb67a" class="i field">stateInfo</a>);
            }
 
            <span class="r84 r">raiseEvents</span> = <b>false</b>;
 
            <b>if</b> (<span class="r83 r">currentState</span> == <a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#fb0d368190577383" class="i field">Disconnected</a>)
            {
                <span class="c">// Assign to local variable to ensure we always pass a non-null value.</span>
                <span class="c">// The async class members can be nulled out if the session closes suddenly.</span>
                <a href="../../hostifaces/RunspacePool.cs.html#bdf2646eeb96a548" class="t t">RunspacePoolAsyncResult</a> <span id="r86 rd" class="r86 r">ret</span> = <b>new</b> <a href="../../hostifaces/RunspacePool.cs.html#5858f7ec065f0d15" class="t constructor">RunspacePoolAsyncResult</a>(
                    <a href="../../hostifaces/RunspacePoolInternal.cs.html#0d2daf8b32a561fc" class="i field">instanceId</a>, <span class="r81 r">callback</span>, <span class="r82 r">state</span>, <b>false</b>);
 
                <b>if</b> (<a href="#03452ff544a5ea09" class="i field">_canReconnect</a>)
                {
                    <span class="c">// This indicates a reconnect scenario where this object instance was previously</span>
                    <span class="c">// disconnected.</span>
                    <a href="#a24d1859482f126a" class="i field">_reconnectAsyncResult</a> = <span class="r86 r">ret</span>;
                    <a href="#6629c704c27c6e09" class="i property">DataStructureHandler</a>.<a href="RemotingProtocol2.cs.html#1777e1865ec532fe" class="i method">ReconnectPoolAsync</a>();
                }
                <b>else</b>
                {
                    <span class="c">// This indicates a reconstruction scenario where this object was created</span>
                    <span class="c">// in the disconnect state and is being connected for the first time.</span>
                    <a href="#309638fa94386800" class="i field">_openAsyncResult</a> = <span class="r86 r">ret</span>;
                    <a href="#6629c704c27c6e09" class="i property">DataStructureHandler</a>.<a href="RemotingProtocol2.cs.html#a61cd929044577ba" class="i method">ConnectPoolAsync</a>();
                }
 
                <b>if</b> (<span class="r84 r">raiseEvents</span>)
                {
                    <a href="../../hostifaces/RunspacePoolInternal.cs.html#c96a416ffa6d47a6" class="i method">RaiseStateChangeEvent</a>(<a href="#1aba79be5da56f57" class="k">this</a>.<a href="../../hostifaces/RunspacePoolInternal.cs.html#37ed160e0fbfb67a" class="i field">stateInfo</a>);
                }
 
                <b>return</b> <span class="r86 r">ret</span>;
            }
            <b>else</b>
            {
                <b>string</b> <span id="r87 rd" class="r87 r">message</span> = <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">RunspacePoolStrings</span>.<span class="i">InvalidRunspacePoolState</span>, <a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#fb0d368190577383" class="i field">Disconnected</a>, <a href="../../hostifaces/RunspacePoolInternal.cs.html#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a>);
                <a href="../../hostifaces/RunspacePool.cs.html#741ffc1755303d69" class="t t">InvalidRunspacePoolStateException</a> <span id="r88 rd" class="r88 r">invalidStateException</span> = <b>new</b> <a href="../../hostifaces/RunspacePool.cs.html#53060b2dd310e4fc" class="t constructor">InvalidRunspacePoolStateException</a>(<span class="r87 r">message</span>,
                        <a href="../../hostifaces/RunspacePoolInternal.cs.html#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a>, <a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#fb0d368190577383" class="i field">Disconnected</a>);
 
                <b>throw</b> <span class="r88 r">invalidStateException</span>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Waits for BeginConnect to complete.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r89 r">asyncResult</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">IAsyncResult object.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>public override void</b> <a id="63974317e66015fe" href="../../../R/63974317e66015fe.html" target="n" data-glyph="72,1" class="i method">EndConnect</a>(<span class="i">IAsyncResult</span> <span id="r89 rd" class="r89 r">asyncResult</span>)
        {
            <b>if</b> (<span class="r89 r">asyncResult</span> == <b>null</b>)
            {
                <b>throw</b> <a href="../../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../../../utils/MshTraceSource.cs.html#fbe67220ad7522a0" class="i method">NewArgumentNullException</a>(<b>nameof</b>(<span class="r89 r">asyncResult</span>));
            }
 
            <a href="../../hostifaces/RunspacePool.cs.html#bdf2646eeb96a548" class="t t">RunspacePoolAsyncResult</a> <span id="r90 rd" class="r90 r">rsAsyncResult</span> = <span class="r89 r">asyncResult</span> <b>as</b> <a href="../../hostifaces/RunspacePool.cs.html#bdf2646eeb96a548" class="t t">RunspacePoolAsyncResult</a>;
 
            <b>if</b> ((<span class="r90 r">rsAsyncResult</span> == <b>null</b>) ||
                (<span class="r90 r">rsAsyncResult</span>.<a href="../../hostifaces/AsyncResult.cs.html#c8afb8644f9407ba" class="i property">OwnerId</a> != <a href="../../hostifaces/RunspacePoolInternal.cs.html#0d2daf8b32a561fc" class="i field">instanceId</a>) ||
                (<span class="r90 r">rsAsyncResult</span>.<a href="../../hostifaces/RunspacePool.cs.html#52edc5f43955f90a" class="i property">IsAssociatedWithAsyncOpen</a>))
            {
                <b>throw</b> <a href="../../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<span class="i">NewArgumentException</span>(<b>nameof</b>(<span class="r89 r">asyncResult</span>),
                                                         <span class="i">RunspacePoolStrings</span>.<span class="i">AsyncResultNotOwned</span>,
                                                         <span class="s">&quot;IAsyncResult&quot;</span>,
                                                         <span class="s">&quot;BeginOpen&quot;</span>);
            }
 
            <span class="r90 r">rsAsyncResult</span>.<a href="../../hostifaces/AsyncResult.cs.html#75f5584cab706e68" class="i method">EndInvoke</a>();
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Creates an array of PowerShell objects that are in the Disconnected state for</span>
        <span class="c">///</span><span class="c"> all currently disconnected running commands associated with this runspace pool.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">Array of PowerShell objects.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public override</b> <span class="i">Collection</span>&lt;<a href="../../hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShell</a>&gt; <a id="2bc851967bb3c6b5" href="../../../R/2bc851967bb3c6b5.html" target="n" data-glyph="72,1" class="i method">CreateDisconnectedPowerShells</a>(<a href="../../hostifaces/RunspacePool.cs.html#c1948c2f22e6b527" class="t t">RunspacePool</a> <span id="r91 rd" class="r91 r">runspacePool</span>)
        {
            <span class="i">Collection</span>&lt;<a href="../../hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShell</a>&gt; <span id="r92 rd" class="r92 r">psCollection</span> = <b>new</b> <span class="i">Collection</span>&lt;<a href="../../hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShell</a>&gt;();
 
            <b>if</b> (<a href="#70f4b2d341860095" class="i property">ConnectCommands</a> == <b>null</b>)
            {
                <span class="c">// Throw error indicating that this runspacepool is not configured for</span>
                <span class="c">// reconstructing commands.</span>
                <b>string</b> <span id="r93 rd" class="r93 r">msg</span> = <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">RunspacePoolStrings</span>.<span class="i">CannotReconstructCommands</span>, <a href="#1aba79be5da56f57" class="k">this</a>.<a href="#1a2dda11a58f900f" class="i property">Name</a>);
                <b>throw</b> <b>new</b> <a href="../../hostifaces/RunspacePool.cs.html#96ff8beac53fead8" class="t constructor">InvalidRunspacePoolStateException</a>(<span class="r93 r">msg</span>);
            }
 
            <span class="c">// Get list of all disconnected commands associated with this runspace pool.</span>
            <b>foreach</b> (<a href="#b586ca980bfda5bc" class="t t">ConnectCommandInfo</a> <span id="r94 rd" class="r94 r">connectCmdInfo</span> <b>in</b> <a href="#70f4b2d341860095" class="i property">ConnectCommands</a>)
            {
                <span class="r92 r">psCollection</span>.<span class="i">Add</span>(<b>new</b> <a href="../../hostifaces/PowerShell.cs.html#9d89b3548a1395c2" class="t constructor">PowerShell</a>(<span class="r94 r">connectCmdInfo</span>, <span class="r91 r">runspacePool</span>));
            }
 
            <b>return</b> <span class="r92 r">psCollection</span>;
        }
 
        <span class="c">///</span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Returns RunspacePool capabilities.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">RunspacePoolCapability.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public override</b> <a href="../../hostifaces/RunspacePool.cs.html#ffda42f1dc806629" class="t t">RunspacePoolCapability</a> <a id="8cb20a8fb628c3b7" href="../../../R/8cb20a8fb628c3b7.html" target="n" data-glyph="72,1" class="i method">GetCapabilities</a>()
        {
            <a href="../../hostifaces/RunspacePool.cs.html#ffda42f1dc806629" class="t t">RunspacePoolCapability</a> <span id="r95 rd" class="r95 r">returnCaps</span> = <a href="../../hostifaces/RunspacePool.cs.html#ffda42f1dc806629" class="t t">RunspacePoolCapability</a>.<a href="../../hostifaces/RunspacePool.cs.html#09eb0969c270accf" class="i field">Default</a>;
 
            <b>if</b> (<a href="#008af9ea26573908" class="i property">CanDisconnect</a>)
            {
                <span class="r95 r">returnCaps</span> |= <a href="../../hostifaces/RunspacePool.cs.html#ffda42f1dc806629" class="t t">RunspacePoolCapability</a>.<a href="../../hostifaces/RunspacePool.cs.html#aaf68cbd22defb0d" class="i field">SupportsDisconnect</a>;
            }
 
            <b>return</b> <span class="r95 r">returnCaps</span>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Public Methods
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Static methods
 
        <b>internal static</b> <a href="../../hostifaces/RunspacePool.cs.html#c1948c2f22e6b527" class="t t">RunspacePool</a>[] <a id="9f0c620f91f8243e" href="../../../R/9f0c620f91f8243e.html" target="n" data-glyph="74,1" class="i method">GetRemoteRunspacePools</a>(<a href="../common/RunspaceConnectionInfo.cs.html#e07ed56a8a1da829" class="t t">RunspaceConnectionInfo</a> <span id="r96 rd" class="r96 r">connectionInfo</span>, <a href="../../hostifaces/MshHost.cs.html#7b79cd90e035740e" class="t t">PSHost</a> <span id="r97 rd" class="r97 r">host</span>, <a href="../../../P/a09d9b2cb7b1f0db.html#a09d9b2cb7b1f0db" class="t t">TypeTable</a> <span id="r98 rd" class="r98 r">typeTable</span>)
        {
            <b>if</b> (!(<span class="r96 r">connectionInfo</span> <b>is</b> <a href="../common/RunspaceConnectionInfo.cs.html#2d9d176ef419be5a" class="t t">WSManConnectionInfo</a> <span id="r99 rd" class="r99 r">wsmanConnectionInfoParam</span>))
            {
                <span class="c">// Disconnect-Connect currently only supported by WSMan.</span>
                <b>throw</b> <b>new</b> <span class="i">NotSupportedException</span>();
            }
 
            <span class="i">List</span>&lt;<a href="../../hostifaces/RunspacePool.cs.html#c1948c2f22e6b527" class="t t">RunspacePool</a>&gt; <span id="r100 rd" class="r100 r">discRunspacePools</span> = <b>new</b> <span class="i">List</span>&lt;<a href="../../hostifaces/RunspacePool.cs.html#c1948c2f22e6b527" class="t t">RunspacePool</a>&gt;();
 
            <span class="c">// Enumerate all runspacepools</span>
            <span class="i">Collection</span>&lt;<a href="../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt; <span id="r101 rd" class="r101 r">runspaceItems</span> = <a href="#75c22c3f22c67301" class="t t">RemoteRunspacePoolEnumeration</a>.<a href="#8b3fccc4885ae1ec" class="i method">GetRemotePools</a>(<span class="r99 r">wsmanConnectionInfoParam</span>);
            <b>foreach</b> (<a href="../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r102 rd" class="r102 r">rsObject</span> <b>in</b> <span class="r101 r">runspaceItems</span>)
            {
                <span class="c">// Create a new WSMan connection info object for each returned runspace pool.</span>
                <a href="../common/RunspaceConnectionInfo.cs.html#2d9d176ef419be5a" class="t t">WSManConnectionInfo</a> <span id="r103 rd" class="r103 r">wsmanConnectionInfo</span> = <span class="r99 r">wsmanConnectionInfoParam</span>.<a href="../common/RunspaceConnectionInfo.cs.html#34f8c1aa90e3af78" class="i method">Copy</a>();
 
                <a href="../../MshMemberInfo.cs.html#13ab3796654e613c" class="t t">PSPropertyInfo</a> <span id="r104 rd" class="r104 r">pspShellId</span> = <span class="r102 r">rsObject</span>.<a href="../../MshObject.cs.html#59e9cd1ad57ccd34" class="i property">Properties</a><a href="../../MshMemberInfo.cs.html#f603b32aa49d3ffa">[</a><span class="s">&quot;ShellId&quot;</span>];
                <a href="../../MshMemberInfo.cs.html#13ab3796654e613c" class="t t">PSPropertyInfo</a> <span id="r105 rd" class="r105 r">pspState</span> = <span class="r102 r">rsObject</span>.<a href="../../MshObject.cs.html#59e9cd1ad57ccd34" class="i property">Properties</a><a href="../../MshMemberInfo.cs.html#f603b32aa49d3ffa">[</a><span class="s">&quot;State&quot;</span>];
                <a href="../../MshMemberInfo.cs.html#13ab3796654e613c" class="t t">PSPropertyInfo</a> <span id="r106 rd" class="r106 r">pspName</span> = <span class="r102 r">rsObject</span>.<a href="../../MshObject.cs.html#59e9cd1ad57ccd34" class="i property">Properties</a><a href="../../MshMemberInfo.cs.html#f603b32aa49d3ffa">[</a><span class="s">&quot;Name&quot;</span>];
                <a href="../../MshMemberInfo.cs.html#13ab3796654e613c" class="t t">PSPropertyInfo</a> <span id="r107 rd" class="r107 r">pspResourceUri</span> = <span class="r102 r">rsObject</span>.<a href="../../MshObject.cs.html#59e9cd1ad57ccd34" class="i property">Properties</a><a href="../../MshMemberInfo.cs.html#f603b32aa49d3ffa">[</a><span class="s">&quot;ResourceUri&quot;</span>];
 
                <b>if</b> (<span class="r104 r">pspShellId</span> == <b>null</b> || <span class="r105 r">pspState</span> == <b>null</b> || <span class="r106 r">pspName</span> == <b>null</b> || <span class="r107 r">pspResourceUri</span> == <b>null</b>)
                {
                    <b>continue</b>;
                }
 
                <b>string</b> <span id="r108 rd" class="r108 r">strName</span> = <span class="r106 r">pspName</span>.<a href="../../MshMemberInfo.cs.html#cd3a9989baedf3dd" class="i property">Value</a>.<span class="i">ToString</span>();
                <b>string</b> <span id="r109 rd" class="r109 r">strShellUri</span> = <span class="r107 r">pspResourceUri</span>.<a href="../../MshMemberInfo.cs.html#cd3a9989baedf3dd" class="i property">Value</a>.<span class="i">ToString</span>();
                <b>bool</b> <span id="r110 rd" class="r110 r">isDisconnected</span> = <span class="r105 r">pspState</span>.<a href="../../MshMemberInfo.cs.html#cd3a9989baedf3dd" class="i property">Value</a>.<span class="i">ToString</span>().<span class="i">Equals</span>(<span class="s">&quot;Disconnected&quot;</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>);
                <span class="i">Guid</span> <span id="r111 rd" class="r111 r">shellId</span> = <span class="i">Guid</span>.<span class="i">Parse</span>(<span class="r104 r">pspShellId</span>.<a href="../../MshMemberInfo.cs.html#cd3a9989baedf3dd" class="i property">Value</a>.<span class="i">ToString</span>());
 
                <span class="c">// Filter returned items for PowerShell sessions.</span>
                <b>if</b> (!<span class="r109 r">strShellUri</span>.<span class="i">StartsWith</span>(<a href="../fanin/WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="../fanin/WSManNativeAPI.cs.html#f383edcf61712f90" class="i field">ResourceURIPrefix</a>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
                {
                    <b>continue</b>;
                }
 
                <span class="c">// Update wsmanconnection information with server settings.</span>
                <a href="#52f3ac08a3601fa4" class="i method">UpdateWSManConnectionInfo</a>(<span class="r103 r">wsmanConnectionInfo</span>, <span class="r102 r">rsObject</span>);
                <span class="c">// Ensure that EnableNetworkAccess property is always enabled for reconstructed runspaces.</span>
                <span class="r103 r">wsmanConnectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#bccff2b013731c62" class="i property">EnableNetworkAccess</a> = <b>true</b>;
 
                <span class="c">// Compute runspace DisconnectedOn and ExpiresOn fields.</span>
                <b>if</b> (<span class="r110 r">isDisconnected</span>)
                {
                    <span class="i">DateTime</span>? <span id="r112 rd" class="r112 r">disconnectedOn</span>;
                    <span class="i">DateTime</span>? <span id="r113 rd" class="r113 r">expiresOn</span>;
                    <a href="#818feac8b1ace8b0" class="i method">ComputeDisconnectedOnExpiresOn</a>(<span class="r102 r">rsObject</span>, <b>out</b> <span class="r112 r">disconnectedOn</span>, <b>out</b> <span class="r113 r">expiresOn</span>);
                    <span class="r103 r">wsmanConnectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#f332a5875710beac" class="i property">DisconnectedOn</a> = <span class="r112 r">disconnectedOn</span>;
                    <span class="r103 r">wsmanConnectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#98dcfd36463927fb" class="i property">ExpiresOn</a> = <span class="r113 r">expiresOn</span>;
                }
 
                <span class="i">List</span>&lt;<a href="#b586ca980bfda5bc" class="t t">ConnectCommandInfo</a>&gt; <span id="r114 rd" class="r114 r">connectCmdInfos</span> = <b>new</b> <span class="i">List</span>&lt;<a href="#b586ca980bfda5bc" class="t t">ConnectCommandInfo</a>&gt;();
 
                <span class="c">// Enumerate all commands on runspace pool.</span>
                <span class="i">Collection</span>&lt;<a href="../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt; <span id="r115 rd" class="r115 r">commandItems</span>;
                <b>try</b>
                {
                    <span class="r115 r">commandItems</span> = <a href="#75c22c3f22c67301" class="t t">RemoteRunspacePoolEnumeration</a>.<a href="#f29f5a0d04de1449" class="i method">GetRemoteCommands</a>(<span class="r111 r">shellId</span>, <span class="r103 r">wsmanConnectionInfo</span>);
                }
                <b>catch</b> (<a href="../../../utils/ExecutionExceptions.cs.html#7b242746a433b370" class="t t">CmdletInvocationException</a> <span id="r116 rd" class="r116 r">e</span>)
                {
                    <b>if</b> (<span class="r116 r">e</span>.<span class="i">InnerException</span> != <b>null</b> &amp;&amp; <span class="r116 r">e</span>.<span class="i">InnerException</span> <b>is</b> <span class="i">InvalidOperationException</span>)
                    {
                        <span class="c">// If we cannot successfully retrieve command information then this runspace</span>
                        <span class="c">// object we are building is invalid and must be skipped.</span>
                        <b>continue</b>;
                    }
 
                    <b>throw</b>;
                }
 
                <b>foreach</b> (<a href="../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r117 rd" class="r117 r">cmdObject</span> <b>in</b> <span class="r115 r">commandItems</span>)
                {
                    <a href="../../MshMemberInfo.cs.html#13ab3796654e613c" class="t t">PSPropertyInfo</a> <span id="r118 rd" class="r118 r">pspCommandId</span> = <span class="r117 r">cmdObject</span>.<a href="../../MshObject.cs.html#59e9cd1ad57ccd34" class="i property">Properties</a><a href="../../MshMemberInfo.cs.html#f603b32aa49d3ffa">[</a><span class="s">&quot;CommandId&quot;</span>];
                    <a href="../../MshMemberInfo.cs.html#13ab3796654e613c" class="t t">PSPropertyInfo</a> <span id="r119 rd" class="r119 r">pspCommandLine</span> = <span class="r117 r">cmdObject</span>.<a href="../../MshObject.cs.html#59e9cd1ad57ccd34" class="i property">Properties</a><a href="../../MshMemberInfo.cs.html#f603b32aa49d3ffa">[</a><span class="s">&quot;CommandLine&quot;</span>];
 
                    <b>if</b> (<span class="r118 r">pspCommandId</span> == <b>null</b>)
                    {
                        <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<b>false</b>, <span class="s">&quot;Should not get an empty command Id from a remote runspace pool.&quot;</span>);
                        <b>continue</b>;
                    }
 
                    <b>string</b> <span id="r120 rd" class="r120 r">cmdLine</span> = (<span class="r119 r">pspCommandLine</span> != <b>null</b>) ? <span class="r119 r">pspCommandLine</span>.<a href="../../MshMemberInfo.cs.html#cd3a9989baedf3dd" class="i property">Value</a>.<span class="i">ToString</span>() : <b>string</b>.<span class="i">Empty</span>;
                    <span class="i">Guid</span> <span id="r121 rd" class="r121 r">cmdId</span> = <span class="i">Guid</span>.<span class="i">Parse</span>(<span class="r118 r">pspCommandId</span>.<a href="../../MshMemberInfo.cs.html#cd3a9989baedf3dd" class="i property">Value</a>.<span class="i">ToString</span>());
 
                    <span class="r114 r">connectCmdInfos</span>.<span class="i">Add</span>(<b>new</b> <a href="#7661a91d2cae56e7" class="t constructor">ConnectCommandInfo</a>(<span class="r121 r">cmdId</span>, <span class="r120 r">cmdLine</span>));
                }
 
                <span class="c">// At this point we don&#39;t know if the runspace pool we want to connect to has just one runspace</span>
                <span class="c">// (a RemoteRunspace/PSSession) or multiple runspaces in its pool.  We do have an array of</span>
                <span class="c">// running command information which will indicate a runspace pool if the count is gt one.</span>
                <a href="../../hostifaces/RunspacePool.cs.html#c1948c2f22e6b527" class="t t">RunspacePool</a> <span id="r122 rd" class="r122 r">runspacePool</span> = <b>new</b> <span class="t">RunspacePool</span>(<span class="r110 r">isDisconnected</span>, <span class="r111 r">shellId</span>, <span class="r108 r">strName</span>,
                    <span class="r114 r">connectCmdInfos</span>.<span class="i">ToArray</span>(), <span class="r103 r">wsmanConnectionInfo</span>, <span class="r97 r">host</span>, <span class="r98 r">typeTable</span>);
                <span class="r100 r">discRunspacePools</span>.<span class="i">Add</span>(<span class="r122 r">runspacePool</span>);
            }
 
            <b>return</b> <span class="r100 r">discRunspacePools</span>.<span class="i">ToArray</span>();
        }
 
        <b>internal static</b> <a href="../../hostifaces/RunspacePool.cs.html#c1948c2f22e6b527" class="t t">RunspacePool</a> <a id="ed21571a445e674d" href="../../../R/ed21571a445e674d.html" target="n" data-glyph="74,1" class="i method">GetRemoteRunspacePool</a>(<a href="../common/RunspaceConnectionInfo.cs.html#e07ed56a8a1da829" class="t t">RunspaceConnectionInfo</a> <span id="r123 rd" class="r123 r">connectionInfo</span>, <span class="i">Guid</span> <span id="r124 rd" class="r124 r">sessionId</span>, <span class="i">Guid</span>? <span id="r125 rd" class="r125 r">commandId</span>, <a href="../../hostifaces/MshHost.cs.html#7b79cd90e035740e" class="t t">PSHost</a> <span id="r126 rd" class="r126 r">host</span>, <a href="../../../P/a09d9b2cb7b1f0db.html#a09d9b2cb7b1f0db" class="t t">TypeTable</a> <span id="r127 rd" class="r127 r">typeTable</span>)
        {
            <span class="i">List</span>&lt;<a href="#b586ca980bfda5bc" class="t t">ConnectCommandInfo</a>&gt; <span id="r128 rd" class="r128 r">connectCmdInfos</span> = <b>new</b> <span class="i">List</span>&lt;<a href="#b586ca980bfda5bc" class="t t">ConnectCommandInfo</a>&gt;();
            <b>if</b> (<span class="r125 r">commandId</span> != <b>null</b>)
            {
                <span class="r128 r">connectCmdInfos</span>.<span class="i">Add</span>(<b>new</b> <span class="t">ConnectCommandInfo</span>(<span class="r125 r">commandId</span>.<span class="i">Value</span>, <b>string</b>.<span class="i">Empty</span>));
            }
 
            <b>return</b> <b>new</b> <span class="t">RunspacePool</span>(<b>true</b>, <span class="r124 r">sessionId</span>, <b>string</b>.<span class="i">Empty</span>, <span class="r128 r">connectCmdInfos</span>.<span class="i">ToArray</span>(), <span class="r123 r">connectionInfo</span>, <span class="r126 r">host</span>, <span class="r127 r">typeTable</span>);
        }
 
        <b>private static void</b> <a id="52f3ac08a3601fa4" href="../../../R/52f3ac08a3601fa4.html" target="n" data-glyph="76,1" class="i method">UpdateWSManConnectionInfo</a>(
            <a href="../common/RunspaceConnectionInfo.cs.html#2d9d176ef419be5a" class="t t">WSManConnectionInfo</a> <span id="r129 rd" class="r129 r">wsmanConnectionInfo</span>,
            <a href="../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r130 rd" class="r130 r">rsInfoObject</span>)
        {
            <a href="../../MshMemberInfo.cs.html#13ab3796654e613c" class="t t">PSPropertyInfo</a> <span id="r131 rd" class="r131 r">pspIdleTimeOut</span> = <span class="r130 r">rsInfoObject</span>.<a href="../../MshObject.cs.html#59e9cd1ad57ccd34" class="i property">Properties</a><a href="../../MshMemberInfo.cs.html#f603b32aa49d3ffa">[</a><span class="s">&quot;IdleTimeOut&quot;</span>];
            <a href="../../MshMemberInfo.cs.html#13ab3796654e613c" class="t t">PSPropertyInfo</a> <span id="r132 rd" class="r132 r">pspBufferMode</span> = <span class="r130 r">rsInfoObject</span>.<a href="../../MshObject.cs.html#59e9cd1ad57ccd34" class="i property">Properties</a><a href="../../MshMemberInfo.cs.html#f603b32aa49d3ffa">[</a><span class="s">&quot;BufferMode&quot;</span>];
            <a href="../../MshMemberInfo.cs.html#13ab3796654e613c" class="t t">PSPropertyInfo</a> <span id="r133 rd" class="r133 r">pspResourceUri</span> = <span class="r130 r">rsInfoObject</span>.<a href="../../MshObject.cs.html#59e9cd1ad57ccd34" class="i property">Properties</a><a href="../../MshMemberInfo.cs.html#f603b32aa49d3ffa">[</a><span class="s">&quot;ResourceUri&quot;</span>];
            <a href="../../MshMemberInfo.cs.html#13ab3796654e613c" class="t t">PSPropertyInfo</a> <span id="r134 rd" class="r134 r">pspLocale</span> = <span class="r130 r">rsInfoObject</span>.<a href="../../MshObject.cs.html#59e9cd1ad57ccd34" class="i property">Properties</a><a href="../../MshMemberInfo.cs.html#f603b32aa49d3ffa">[</a><span class="s">&quot;Locale&quot;</span>];
            <a href="../../MshMemberInfo.cs.html#13ab3796654e613c" class="t t">PSPropertyInfo</a> <span id="r135 rd" class="r135 r">pspDataLocale</span> = <span class="r130 r">rsInfoObject</span>.<a href="../../MshObject.cs.html#59e9cd1ad57ccd34" class="i property">Properties</a><a href="../../MshMemberInfo.cs.html#f603b32aa49d3ffa">[</a><span class="s">&quot;DataLocale&quot;</span>];
            <a href="../../MshMemberInfo.cs.html#13ab3796654e613c" class="t t">PSPropertyInfo</a> <span id="r136 rd" class="r136 r">pspCompressionMode</span> = <span class="r130 r">rsInfoObject</span>.<a href="../../MshObject.cs.html#59e9cd1ad57ccd34" class="i property">Properties</a><a href="../../MshMemberInfo.cs.html#f603b32aa49d3ffa">[</a><span class="s">&quot;CompressionMode&quot;</span>];
            <a href="../../MshMemberInfo.cs.html#13ab3796654e613c" class="t t">PSPropertyInfo</a> <span id="r137 rd" class="r137 r">pspEncoding</span> = <span class="r130 r">rsInfoObject</span>.<a href="../../MshObject.cs.html#59e9cd1ad57ccd34" class="i property">Properties</a><a href="../../MshMemberInfo.cs.html#f603b32aa49d3ffa">[</a><span class="s">&quot;Encoding&quot;</span>];
            <a href="../../MshMemberInfo.cs.html#13ab3796654e613c" class="t t">PSPropertyInfo</a> <span id="r138 rd" class="r138 r">pspProfile</span> = <span class="r130 r">rsInfoObject</span>.<a href="../../MshObject.cs.html#59e9cd1ad57ccd34" class="i property">Properties</a><a href="../../MshMemberInfo.cs.html#f603b32aa49d3ffa">[</a><span class="s">&quot;ProfileLoaded&quot;</span>];
            <a href="../../MshMemberInfo.cs.html#13ab3796654e613c" class="t t">PSPropertyInfo</a> <span id="r139 rd" class="r139 r">pspMaxIdleTimeout</span> = <span class="r130 r">rsInfoObject</span>.<a href="../../MshObject.cs.html#59e9cd1ad57ccd34" class="i property">Properties</a><a href="../../MshMemberInfo.cs.html#f603b32aa49d3ffa">[</a><span class="s">&quot;MaxIdleTimeout&quot;</span>];
 
            <b>if</b> (<span class="r131 r">pspIdleTimeOut</span> != <b>null</b>)
            {
                <b>int</b> <span id="r140 rd" class="r140 r">idleTimeout</span>;
                <b>if</b> (<a href="#d6ac36eae6416aee" class="i method">GetTimeIntValue</a>(<span class="r131 r">pspIdleTimeOut</span>.<a href="../../MshMemberInfo.cs.html#cd3a9989baedf3dd" class="i property">Value</a> <b>as string</b>, <b>out</b> <span class="r140 r">idleTimeout</span>))
                {
                    <span class="r129 r">wsmanConnectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#0c117c8cb5b1de8b" class="i property">IdleTimeout</a> = <span class="r140 r">idleTimeout</span>;
                }
            }
 
            <b>if</b> (<span class="r132 r">pspBufferMode</span> != <b>null</b>)
            {
                <b>string</b> <span id="r141 rd" class="r141 r">bufferingMode</span> = <span class="r132 r">pspBufferMode</span>.<a href="../../MshMemberInfo.cs.html#cd3a9989baedf3dd" class="i property">Value</a> <b>as string</b>;
                <b>if</b> (<span class="r141 r">bufferingMode</span> != <b>null</b>)
                {
                    <a href="../common/RunspaceConnectionInfo.cs.html#9cb40ac520a09a1d" class="t t">OutputBufferingMode</a> <span id="r142 rd" class="r142 r">outputBufferingMode</span>;
                    <b>if</b> (<span class="i">Enum</span>.<span class="i">TryParse</span>&lt;<a href="../common/RunspaceConnectionInfo.cs.html#9cb40ac520a09a1d" class="t t">OutputBufferingMode</a>&gt;(<span class="r141 r">bufferingMode</span>, <b>out</b> <span class="r142 r">outputBufferingMode</span>))
                    {
                        <span class="c">// Update connection info.</span>
                        <span class="r129 r">wsmanConnectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#10ef35a810ea13c2" class="i property">OutputBufferingMode</a> = <span class="r142 r">outputBufferingMode</span>;
                    }
                }
            }
 
            <b>if</b> (<span class="r133 r">pspResourceUri</span> != <b>null</b>)
            {
                <b>string</b> <span id="r143 rd" class="r143 r">strShellUri</span> = <span class="r133 r">pspResourceUri</span>.<a href="../../MshMemberInfo.cs.html#cd3a9989baedf3dd" class="i property">Value</a> <b>as string</b>;
                <b>if</b> (<span class="r143 r">strShellUri</span> != <b>null</b>)
                {
                    <span class="r129 r">wsmanConnectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#a0ee4c890acec948" class="i property">ShellUri</a> = <span class="r143 r">strShellUri</span>;
                }
            }
 
            <b>if</b> (<span class="r134 r">pspLocale</span> != <b>null</b>)
            {
                <b>string</b> <span id="r144 rd" class="r144 r">localString</span> = <span class="r134 r">pspLocale</span>.<a href="../../MshMemberInfo.cs.html#cd3a9989baedf3dd" class="i property">Value</a> <b>as string</b>;
                <b>if</b> (<span class="r144 r">localString</span> != <b>null</b>)
                {
                    <b>try</b>
                    {
                        <span class="r129 r">wsmanConnectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#27251d0ea7ef6aba" class="i property">UICulture</a> = <b>new</b> <span class="i">CultureInfo</span>(<span class="r144 r">localString</span>);
                    }
                    <b>catch</b> (<span class="i">ArgumentException</span>)
                    { }
                }
            }
 
            <b>if</b> (<span class="r135 r">pspDataLocale</span> != <b>null</b>)
            {
                <b>string</b> <span id="r145 rd" class="r145 r">dataLocalString</span> = <span class="r135 r">pspDataLocale</span>.<a href="../../MshMemberInfo.cs.html#cd3a9989baedf3dd" class="i property">Value</a> <b>as string</b>;
                <b>if</b> (<span class="r145 r">dataLocalString</span> != <b>null</b>)
                {
                    <b>try</b>
                    {
                        <span class="r129 r">wsmanConnectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#237e4765cd52489b" class="i property">Culture</a> = <b>new</b> <span class="i">CultureInfo</span>(<span class="r145 r">dataLocalString</span>);
                    }
                    <b>catch</b> (<span class="i">ArgumentException</span>)
                    { }
                }
            }
 
            <b>if</b> (<span class="r136 r">pspCompressionMode</span> != <b>null</b>)
            {
                <b>string</b> <span id="r146 rd" class="r146 r">compressionModeString</span> = <span class="r136 r">pspCompressionMode</span>.<a href="../../MshMemberInfo.cs.html#cd3a9989baedf3dd" class="i property">Value</a> <b>as string</b>;
                <b>if</b> (<span class="r146 r">compressionModeString</span> != <b>null</b>)
                {
                    <span class="r129 r">wsmanConnectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#1ec52b9b453e24eb" class="i property">UseCompression</a> = !<span class="r146 r">compressionModeString</span>.<span class="i">Equals</span>(<span class="s">&quot;NoCompression&quot;</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>);
                }
            }
 
            <b>if</b> (<span class="r137 r">pspEncoding</span> != <b>null</b>)
            {
                <b>string</b> <span id="r147 rd" class="r147 r">encodingString</span> = <span class="r137 r">pspEncoding</span>.<a href="../../MshMemberInfo.cs.html#cd3a9989baedf3dd" class="i property">Value</a> <b>as string</b>;
                <b>if</b> (<span class="r147 r">encodingString</span> != <b>null</b>)
                {
                    <span class="r129 r">wsmanConnectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#9b6f0e89a27da3f2" class="i property">UseUTF16</a> = <span class="r147 r">encodingString</span>.<span class="i">Equals</span>(<span class="s">&quot;UTF16&quot;</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>);
                }
            }
 
            <b>if</b> (<span class="r138 r">pspProfile</span> != <b>null</b>)
            {
                <b>string</b> <span id="r148 rd" class="r148 r">machineProfileLoadedString</span> = <span class="r138 r">pspProfile</span>.<a href="../../MshMemberInfo.cs.html#cd3a9989baedf3dd" class="i property">Value</a> <b>as string</b>;
                <b>if</b> (<span class="r148 r">machineProfileLoadedString</span> != <b>null</b>)
                {
                    <span class="r129 r">wsmanConnectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#c6c54cb9078f2a4c" class="i property">NoMachineProfile</a> = !<span class="r148 r">machineProfileLoadedString</span>.<span class="i">Equals</span>(<span class="s">&quot;Yes&quot;</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>);
                }
            }
 
            <b>if</b> (<span class="r139 r">pspMaxIdleTimeout</span> != <b>null</b>)
            {
                <b>int</b> <span id="r149 rd" class="r149 r">maxIdleTimeout</span>;
                <b>if</b> (<a href="#d6ac36eae6416aee" class="i method">GetTimeIntValue</a>(<span class="r139 r">pspMaxIdleTimeout</span>.<a href="../../MshMemberInfo.cs.html#cd3a9989baedf3dd" class="i property">Value</a> <b>as string</b>, <b>out</b> <span class="r149 r">maxIdleTimeout</span>))
                {
                    <span class="r129 r">wsmanConnectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#8f5fff031b021f8b" class="i property">MaxIdleTimeout</a> = <span class="r149 r">maxIdleTimeout</span>;
                }
            }
        }
 
        <b>private static void</b> <a id="818feac8b1ace8b0" href="../../../R/818feac8b1ace8b0.html" target="n" data-glyph="76,1" class="i method">ComputeDisconnectedOnExpiresOn</a>(
            <a href="../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r150 rd" class="r150 r">rsInfoObject</span>,
            <b>out</b> <span class="i">DateTime</span>? <span id="r151 rd" class="r151 r">disconnectedOn</span>,
            <b>out</b> <span class="i">DateTime</span>? <span id="r152 rd" class="r152 r">expiresOn</span>)
        {
            <a href="../../MshMemberInfo.cs.html#13ab3796654e613c" class="t t">PSPropertyInfo</a> <span id="r153 rd" class="r153 r">pspIdleTimeOut</span> = <span class="r150 r">rsInfoObject</span>.<a href="../../MshObject.cs.html#59e9cd1ad57ccd34" class="i property">Properties</a><a href="../../MshMemberInfo.cs.html#f603b32aa49d3ffa">[</a><span class="s">&quot;IdleTimeOut&quot;</span>];
            <a href="../../MshMemberInfo.cs.html#13ab3796654e613c" class="t t">PSPropertyInfo</a> <span id="r154 rd" class="r154 r">pspShellInactivity</span> = <span class="r150 r">rsInfoObject</span>.<a href="../../MshObject.cs.html#59e9cd1ad57ccd34" class="i property">Properties</a><a href="../../MshMemberInfo.cs.html#f603b32aa49d3ffa">[</a><span class="s">&quot;ShellInactivity&quot;</span>];
 
            <b>if</b> (<span class="r153 r">pspIdleTimeOut</span> != <b>null</b> &amp;&amp; <span class="r154 r">pspShellInactivity</span> != <b>null</b>)
            {
                <b>string</b> <span id="r155 rd" class="r155 r">shellInactivityString</span> = <span class="r154 r">pspShellInactivity</span>.<a href="../../MshMemberInfo.cs.html#cd3a9989baedf3dd" class="i property">Value</a> <b>as string</b>;
                <b>int</b> <span id="r156 rd" class="r156 r">idleTimeout</span>;
                <b>if</b> ((<span class="r155 r">shellInactivityString</span> != <b>null</b>) &amp;&amp;
                    <a href="#d6ac36eae6416aee" class="i method">GetTimeIntValue</a>(<span class="r153 r">pspIdleTimeOut</span>.<a href="../../MshMemberInfo.cs.html#cd3a9989baedf3dd" class="i property">Value</a> <b>as string</b>, <b>out</b> <span class="r156 r">idleTimeout</span>))
                {
                    <b>try</b>
                    {
                        <span class="i">TimeSpan</span> <span id="r157 rd" class="r157 r">shellInactivityTime</span> = <span class="i">Xml</span>.<span class="i">XmlConvert</span>.<span class="i">ToTimeSpan</span>(<span class="r155 r">shellInactivityString</span>);
                        <span class="i">TimeSpan</span> <span id="r158 rd" class="r158 r">idleTimeoutTime</span> = <span class="i">TimeSpan</span>.<span class="i">FromSeconds</span>(<span class="r156 r">idleTimeout</span> / 1000);
 
                        <b>if</b> (<span class="r158 r">idleTimeoutTime</span> &gt; <span class="r157 r">shellInactivityTime</span>)
                        {
                            <span class="i">DateTime</span> <span id="r159 rd" class="r159 r">now</span> = <span class="i">DateTime</span>.<span class="i">Now</span>;
                            <span class="r151 r">disconnectedOn</span> = <span class="r159 r">now</span>.<span class="i">Subtract</span>(<span class="r157 r">shellInactivityTime</span>);
                            <span class="r152 r">expiresOn</span> = <span class="r151 r">disconnectedOn</span>.<span class="i">Value</span>.<span class="i">Add</span>(<span class="r158 r">idleTimeoutTime</span>);
 
                            <b>return</b>;
                        }
                    }
                    <b>catch</b> (<span class="i">FormatException</span>)
                    { }
                    <b>catch</b> (<span class="i">ArgumentOutOfRangeException</span>)
                    { }
                    <b>catch</b> (<span class="i">OverflowException</span>)
                    { }
                }
            }
 
            <span class="r151 r">disconnectedOn</span> = <b>null</b>;
            <span class="r152 r">expiresOn</span> = <b>null</b>;
        }
 
        <b>private static bool</b> <a id="d6ac36eae6416aee" href="../../../R/d6ac36eae6416aee.html" target="n" data-glyph="76,1" class="i method">GetTimeIntValue</a>(<b>string</b> <span id="r160 rd" class="r160 r">timeString</span>, <b>out int</b> <span id="r161 rd" class="r161 r">value</span>)
        {
            <b>if</b> (<span class="r160 r">timeString</span> != <b>null</b>)
            {
                <b>string</b> <span id="r162 rd" class="r162 r">timeoutString</span> = <span class="r160 r">timeString</span>.<span class="i">Replace</span>(<span class="s">&quot;PT&quot;</span>, <b>string</b>.<span class="i">Empty</span>).<span class="i">Replace</span>(<span class="s">&quot;S&quot;</span>, <b>string</b>.<span class="i">Empty</span>);
                <b>try</b>
                {
                    <span class="c">// Convert time from seconds to milliseconds.</span>
                    <b>int</b> <span id="r163 rd" class="r163 r">idleTimeout</span> = (<b>int</b>)(<span class="i">Convert</span>.<span class="i">ToDouble</span>(<span class="r162 r">timeoutString</span>, <span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>) * 1000);
                    <b>if</b> (<span class="r163 r">idleTimeout</span> &gt; 0)
                    {
                        <span class="r161 r">value</span> = <span class="r163 r">idleTimeout</span>;
                        <b>return</b> <b>true</b>;
                    }
                }
                <b>catch</b> (<span class="i">FormatException</span>)
                { }
                <b>catch</b> (<span class="i">OverflowException</span>)
                { }
            }
 
            <span class="r161 r">value</span> = 0;
            <b>return</b> <b>false</b>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Private Methods
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Set the new runspace pool state based on the state of the</span>
        <span class="c">///</span><span class="c"> server RunspacePool.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r164 r">newStateInfo</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">state information object</span>
        <span class="c">///</span><span class="c"> describing the state change at the server RunspacePool</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>private void</b> <a id="bb418a07ac8ba418" href="../../../R/bb418a07ac8ba418.html" target="n" data-glyph="76,1" class="i method">SetRunspacePoolState</a>(<a href="../common/RunspacePoolStateInfo.cs.html#8b9143609d7a0363" class="t t">RunspacePoolStateInfo</a> <span id="r164 rd" class="r164 r">newStateInfo</span>)
        {
            <a href="#18b0ef61a8921f01" class="i method">SetRunspacePoolState</a>(<span class="r164 r">newStateInfo</span>, <b>false</b>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Set the new runspace pool state based on the state of the</span>
        <span class="c">///</span><span class="c"> server RunspacePool and raise events if required.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r165 r">newStateInfo</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">state information object</span>
        <span class="c">///</span><span class="c"> describing the state change at the server RunspacePool</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r166 r">raiseEvents</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Raise state changed events if true.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>private void</b> <a id="18b0ef61a8921f01" href="../../../R/18b0ef61a8921f01.html" target="n" data-glyph="76,1" class="i method">SetRunspacePoolState</a>(<a href="../common/RunspacePoolStateInfo.cs.html#8b9143609d7a0363" class="t t">RunspacePoolStateInfo</a> <span id="r165 rd" class="r165 r">newStateInfo</span>, <b>bool</b> <span id="r166 rd" class="r166 r">raiseEvents</span>)
        {
            <a href="../../hostifaces/RunspacePoolInternal.cs.html#37ed160e0fbfb67a" class="i field">stateInfo</a> = <span class="r165 r">newStateInfo</span>;
 
            <span class="c">// Update the availableForConnection variable based on state change.</span>
            <a href="#e9793c4f5c63d814" class="i property">AvailableForConnection</a> = (<a href="../../hostifaces/RunspacePoolInternal.cs.html#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a> == <a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#fb0d368190577383" class="i field">Disconnected</a> ||
                                           <a href="../../hostifaces/RunspacePoolInternal.cs.html#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a> == <a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#13cbf83371c004e0" class="i field">Opened</a>);
 
            <b>if</b> (<span class="r166 r">raiseEvents</span>)
            {
                <a href="../../hostifaces/RunspacePoolInternal.cs.html#c96a416ffa6d47a6" class="i method">RaiseStateChangeEvent</a>(<span class="r165 r">newStateInfo</span>);
            }
        }
 
        <b>private void</b> <a id="2f7cb6fd376f089a" href="../../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">HandleSessionDisconnected</a>(<b>object</b> <span id="r167 rd" class="r167 r">sender</span>, <a href="../common/misc.cs.html#16d1e16a7ed9f8cc" class="t t">RemoteDataEventArgs</a>&lt;<span class="i">Exception</span>&gt; <span id="r168 rd" class="r168 r">eventArgs</span>)
        {
            <b>bool</b> <span id="r169 rd" class="r169 r">stateChange</span> = <b>false</b>;
            <b>lock</b> (<a href="#1aba79be5da56f57" class="k">this</a>.<a href="../../hostifaces/RunspacePoolInternal.cs.html#21db200b449932ac" class="i field">syncObject</a>)
            {
                <b>if</b> (<a href="../../hostifaces/RunspacePoolInternal.cs.html#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a> == <a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#91690c7b66b3081a" class="i field">Disconnecting</a>)
                {
                    <a href="#ef718d076f407385" class="i method">UpdateDisconnectedExpiresOn</a>();
 
                    <a href="#bb418a07ac8ba418" class="i method">SetRunspacePoolState</a>(<b>new</b> <a href="../common/RunspacePoolStateInfo.cs.html#c7dae263df1aded0" class="t constructor">RunspacePoolStateInfo</a>(<a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#fb0d368190577383" class="i field">Disconnected</a>, <span class="r168 r">eventArgs</span>.<a href="../common/misc.cs.html#0896dbbd394ce2e6" class="i property">Data</a>));
                    <span class="r169 r">stateChange</span> = <b>true</b>;
                }
 
                <span class="c">// Set boolean indicating this object has previous connection state and so</span>
                <span class="c">// can be reconnected as opposed to the alternative where the connection</span>
                <span class="c">// state has to be reconstructed then connected.</span>
                <a href="#03452ff544a5ea09" class="i field">_canReconnect</a> = <b>true</b>;
            }
 
            <span class="c">// Do state change work outside of lock.</span>
            <b>if</b> (<span class="r169 r">stateChange</span>)
            {
                <a href="../../hostifaces/RunspacePoolInternal.cs.html#c96a416ffa6d47a6" class="i method">RaiseStateChangeEvent</a>(<a href="#1aba79be5da56f57" class="k">this</a>.<a href="../../hostifaces/RunspacePoolInternal.cs.html#37ed160e0fbfb67a" class="i field">stateInfo</a>);
                <a href="#7ef13764fb23cf2e" class="i method">SetDisconnectAsCompleted</a>();
            }
        }
 
        <b>private void</b> <a id="7ef13764fb23cf2e" href="../../../R/7ef13764fb23cf2e.html" target="n" data-glyph="76,1" class="i method">SetDisconnectAsCompleted</a>()
        {
            <b>if</b> (<a href="#2c7911cd99440a88" class="i field">_disconnectAsyncResult</a> != <b>null</b> &amp;&amp; !<a href="#2c7911cd99440a88" class="i field">_disconnectAsyncResult</a>.<a href="../../hostifaces/AsyncResult.cs.html#8d04b010297eb52a" class="i property">IsCompleted</a>)
            {
                <a href="#2c7911cd99440a88" class="i field">_disconnectAsyncResult</a>.<a href="../../hostifaces/AsyncResult.cs.html#2d78c0fa1b51bb6e" class="i method">SetAsCompleted</a>(<a href="../../hostifaces/RunspacePoolInternal.cs.html#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../common/RunspacePoolStateInfo.cs.html#dcad0aee1f0be83d" class="i property">Reason</a>);
                <a href="#2c7911cd99440a88" class="i field">_disconnectAsyncResult</a> = <b>null</b>;
            }
        }
 
        <b>private void</b> <a id="a260bff802fc7340" href="../../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">HandleSessionReconnected</a>(<b>object</b> <span id="r170 rd" class="r170 r">sender</span>, <a href="../common/misc.cs.html#16d1e16a7ed9f8cc" class="t t">RemoteDataEventArgs</a>&lt;<span class="i">Exception</span>&gt; <span id="r171 rd" class="r171 r">eventArgs</span>)
        {
            <b>bool</b> <span id="r172 rd" class="r172 r">stateChange</span> = <b>false</b>;
            <b>lock</b> (<a href="#1aba79be5da56f57" class="k">this</a>.<a href="../../hostifaces/RunspacePoolInternal.cs.html#21db200b449932ac" class="i field">syncObject</a>)
            {
                <b>if</b> (<a href="../../hostifaces/RunspacePoolInternal.cs.html#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a> == <a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#332d1241bf520aa3" class="i field">Connecting</a>)
                {
                    <a href="#1ab56db66633b097" class="i method">ResetDisconnectedOnExpiresOn</a>();
 
                    <a href="#bb418a07ac8ba418" class="i method">SetRunspacePoolState</a>(<b>new</b> <a href="../common/RunspacePoolStateInfo.cs.html#c7dae263df1aded0" class="t constructor">RunspacePoolStateInfo</a>(<a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#13cbf83371c004e0" class="i field">Opened</a>, <b>null</b>));
                    <span class="r172 r">stateChange</span> = <b>true</b>;
                }
            }
 
            <span class="c">// Do state change work outside of lock.</span>
            <b>if</b> (<span class="r172 r">stateChange</span>)
            {
                <a href="../../hostifaces/RunspacePoolInternal.cs.html#c96a416ffa6d47a6" class="i method">RaiseStateChangeEvent</a>(<a href="#1aba79be5da56f57" class="k">this</a>.<a href="../../hostifaces/RunspacePoolInternal.cs.html#37ed160e0fbfb67a" class="i field">stateInfo</a>);
                <a href="#7ca17bb3e99ec1d8" class="i method">SetReconnectAsCompleted</a>();
            }
        }
 
        <b>private void</b> <a id="7ca17bb3e99ec1d8" href="../../../R/7ca17bb3e99ec1d8.html" target="n" data-glyph="76,1" class="i method">SetReconnectAsCompleted</a>()
        {
            <b>if</b> (<a href="#a24d1859482f126a" class="i field">_reconnectAsyncResult</a> != <b>null</b> &amp;&amp; !<a href="#a24d1859482f126a" class="i field">_reconnectAsyncResult</a>.<a href="../../hostifaces/AsyncResult.cs.html#8d04b010297eb52a" class="i property">IsCompleted</a>)
            {
                <a href="#a24d1859482f126a" class="i field">_reconnectAsyncResult</a>.<a href="../../hostifaces/AsyncResult.cs.html#2d78c0fa1b51bb6e" class="i method">SetAsCompleted</a>(<a href="../../hostifaces/RunspacePoolInternal.cs.html#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../common/RunspacePoolStateInfo.cs.html#dcad0aee1f0be83d" class="i property">Reason</a>);
                <a href="#a24d1859482f126a" class="i field">_reconnectAsyncResult</a> = <b>null</b>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The session is closing set the state and reason accordingly.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r173 r">sender</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Sender of this event, unused.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r174 r">eventArgs</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Arguments describing this event.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>private void</b> <a id="357f2d14e7c31d49" href="../../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">HandleSessionClosing</a>(<b>object</b> <span id="r173 rd" class="r173 r">sender</span>, <a href="../common/misc.cs.html#16d1e16a7ed9f8cc" class="t t">RemoteDataEventArgs</a>&lt;<span class="i">Exception</span>&gt; <span id="r174 rd" class="r174 r">eventArgs</span>)
        {
            <span class="c">// just capture the reason for closing here..handle the session closed event</span>
            <span class="c">// to change state appropriately.</span>
            <a href="#fc38c3edf7f4aacf" class="i field">_closingReason</a> = <span class="r174 r">eventArgs</span>.<a href="../common/misc.cs.html#0896dbbd394ce2e6" class="i property">Data</a>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The session closed, set the state and reason accordingly.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r175 r">sender</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Sender of this event, unused.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r176 r">eventArgs</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Arguments describing this event.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>private void</b> <a id="97fae1a4c8b27829" href="../../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">HandleSessionClosed</a>(<b>object</b> <span id="r175 rd" class="r175 r">sender</span>, <a href="../common/misc.cs.html#16d1e16a7ed9f8cc" class="t t">RemoteDataEventArgs</a>&lt;<span class="i">Exception</span>&gt; <span id="r176 rd" class="r176 r">eventArgs</span>)
        {
            <b>if</b> (<span class="r176 r">eventArgs</span>.<a href="../common/misc.cs.html#0896dbbd394ce2e6" class="i property">Data</a> != <b>null</b>)
            {
                <a href="#fc38c3edf7f4aacf" class="i field">_closingReason</a> = <span class="r176 r">eventArgs</span>.<a href="../common/misc.cs.html#0896dbbd394ce2e6" class="i property">Data</a>;
            }
 
            <span class="c">// Set state under lock.</span>
            <a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a> <span id="r177 rd" class="r177 r">prevState</span>;
            <a href="../common/RunspacePoolStateInfo.cs.html#8b9143609d7a0363" class="t t">RunspacePoolStateInfo</a> <span id="r178 rd" class="r178 r">finishedStateInfo</span>;
            <b>lock</b> (<a href="../../hostifaces/RunspacePoolInternal.cs.html#21db200b449932ac" class="i field">syncObject</a>)
            {
                <span class="r177 r">prevState</span> = <a href="../../hostifaces/RunspacePoolInternal.cs.html#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a>;
 
                <b>switch</b> (<span class="r177 r">prevState</span>)
                {
                    <b>case</b> <a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#3403f57e932b5ec3" class="i field">Opening</a>:
                    <b>case</b> <a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#13cbf83371c004e0" class="i field">Opened</a>:
                    <b>case</b> <a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#91690c7b66b3081a" class="i field">Disconnecting</a>:
                    <b>case</b> <a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#fb0d368190577383" class="i field">Disconnected</a>:
                    <b>case</b> <a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#332d1241bf520aa3" class="i field">Connecting</a>:
                        <span class="c">// Since RunspacePool is not in closing state, this close is</span>
                        <span class="c">// happening because of data structure handler error. Set the state to broken.</span>
                        <a href="#bb418a07ac8ba418" class="i method">SetRunspacePoolState</a>(<b>new</b> <a href="../common/RunspacePoolStateInfo.cs.html#c7dae263df1aded0" class="t constructor">RunspacePoolStateInfo</a>(<a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#48a121178c7c288f" class="i field">Broken</a>, <a href="#fc38c3edf7f4aacf" class="i field">_closingReason</a>));
                        <b>break</b>;
 
                    <b>case</b> <a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#2b6027539b9d1816" class="i field">Closing</a>:
                        <a href="#bb418a07ac8ba418" class="i method">SetRunspacePoolState</a>(<b>new</b> <a href="../common/RunspacePoolStateInfo.cs.html#c7dae263df1aded0" class="t constructor">RunspacePoolStateInfo</a>(<a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#494904731e18b593" class="i field">Closed</a>, <a href="#fc38c3edf7f4aacf" class="i field">_closingReason</a>));
                        <b>break</b>;
                }
 
                <span class="r178 r">finishedStateInfo</span> = <b>new</b> <a href="../common/RunspacePoolStateInfo.cs.html#c7dae263df1aded0" class="t constructor">RunspacePoolStateInfo</a>(<a href="../../hostifaces/RunspacePoolInternal.cs.html#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a>, <a href="../../hostifaces/RunspacePoolInternal.cs.html#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../common/RunspacePoolStateInfo.cs.html#dcad0aee1f0be83d" class="i property">Reason</a>);
            }
 
            <span class="c">// Raise notification event outside of lock.</span>
            <b>try</b>
            {
                <a href="../../hostifaces/RunspacePoolInternal.cs.html#c96a416ffa6d47a6" class="i method">RaiseStateChangeEvent</a>(<span class="r178 r">finishedStateInfo</span>);
            }
            <b>catch</b> (<span class="i">Exception</span>)
            {
                <span class="c">// Don&#39;t throw exception on notification thread.</span>
            }
 
            <span class="c">// Check if we have either an existing disconnect or connect async object</span>
            <span class="c">// and if so make sure they are set to completed since this is a</span>
            <span class="c">// final state for the runspace pool.</span>
            <a href="#7ef13764fb23cf2e" class="i method">SetDisconnectAsCompleted</a>();
            <a href="#7ca17bb3e99ec1d8" class="i method">SetReconnectAsCompleted</a>();
 
            <span class="c">// Ensure an existing Close async object is completed.</span>
            <a href="#27998b65f078a692" class="i method">SetCloseAsCompleted</a>();
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Set the async result for open as completed.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private void</b> <a id="4b2a5e72cdf8d101" href="../../../R/4b2a5e72cdf8d101.html" target="n" data-glyph="76,1" class="i method">SetOpenAsCompleted</a>()
        {
            <a href="../../hostifaces/RunspacePool.cs.html#bdf2646eeb96a548" class="t t">RunspacePoolAsyncResult</a> <span id="r179 rd" class="r179 r">tempOpenAsyncResult</span> = <a href="#309638fa94386800" class="i field">_openAsyncResult</a>;
            <a href="#309638fa94386800" class="i field">_openAsyncResult</a> = <b>null</b>;
            <b>if</b> (<span class="r179 r">tempOpenAsyncResult</span> != <b>null</b> &amp;&amp; !<span class="r179 r">tempOpenAsyncResult</span>.<a href="../../hostifaces/AsyncResult.cs.html#8d04b010297eb52a" class="i property">IsCompleted</a>)
            {
                <span class="r179 r">tempOpenAsyncResult</span>.<a href="../../hostifaces/AsyncResult.cs.html#2d78c0fa1b51bb6e" class="i method">SetAsCompleted</a>(<a href="../../hostifaces/RunspacePoolInternal.cs.html#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../common/RunspacePoolStateInfo.cs.html#dcad0aee1f0be83d" class="i property">Reason</a>);
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Set the async result for close as completed.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private void</b> <a id="27998b65f078a692" href="../../../R/27998b65f078a692.html" target="n" data-glyph="76,1" class="i method">SetCloseAsCompleted</a>()
        {
            <span class="c">// abort all pending calls.</span>
            <a href="#5fff47ad0a516624" class="i property">DispatchTable</a>.<a href="../common/DispatchTable.cs.html#907f0fdd7c6e0cd9" class="i method">AbortAllCalls</a>();
 
            <b>if</b> (<a href="#deb9ddedc45cfcd0" class="i field">_closeAsyncResult</a> != <b>null</b>)
            {
                <a href="#deb9ddedc45cfcd0" class="i field">_closeAsyncResult</a>.<a href="../../hostifaces/AsyncResult.cs.html#2d78c0fa1b51bb6e" class="i method">SetAsCompleted</a>(<a href="../../hostifaces/RunspacePoolInternal.cs.html#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../common/RunspacePoolStateInfo.cs.html#dcad0aee1f0be83d" class="i property">Reason</a>);
                <a href="#deb9ddedc45cfcd0" class="i field">_closeAsyncResult</a> = <b>null</b>;
            }
 
            <span class="c">// Ensure that openAsyncResult is completed and that</span>
            <span class="c">// any error is thrown on the calling thread.</span>
            <span class="c">// The session can be closed at any time, including</span>
            <span class="c">// during Open processing.</span>
            <a href="#4b2a5e72cdf8d101" class="i method">SetOpenAsCompleted</a>();
 
            <span class="c">// Ensure private application data wait is released.</span>
            <b>try</b>
            {
                <a href="#4e668911d0a09c43" class="i field">_applicationPrivateDataReceived</a>.<span class="i">Set</span>();
            }
            <b>catch</b> (<span class="i">ObjectDisposedException</span>) { }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> When a response to a SetMaxRunspaces or SetMinRunspaces is received,</span>
        <span class="c">///</span><span class="c"> from the server, this method sets the response and thereby unblocks</span>
        <span class="c">///</span><span class="c"> corresponding call.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r180 r">sender</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Sender of this message, unused.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r181 r">eventArgs</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Contains response and call id.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>private void</b> <a id="338b357638ae8b93" href="../../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">HandleResponseReceived</a>(<b>object</b> <span id="r180 rd" class="r180 r">sender</span>, <a href="../common/misc.cs.html#16d1e16a7ed9f8cc" class="t t">RemoteDataEventArgs</a>&lt;<a href="../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt; <span id="r181 rd" class="r181 r">eventArgs</span>)
        {
            <a href="../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r182 rd" class="r182 r">data</span> = <span class="r181 r">eventArgs</span>.<a href="../common/misc.cs.html#0896dbbd394ce2e6" class="i property">Data</a>;
            <b>object</b> <span id="r183 rd" class="r183 r">response</span> = <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#6f71f8c4cc2ac041" class="t t">RemotingDecoder</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#d3fee447c77dfb3b" class="i method">GetPropertyValue</a>&lt;<b>object</b>&gt;(<span class="r182 r">data</span>, <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#7c9c1b0b95848ffd" class="t t">RemoteDataNameStrings</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#1f17833c752fc385" class="i field">RunspacePoolOperationResponse</a>);
            <b>long</b> <span id="r184 rd" class="r184 r">callId</span> = <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#6f71f8c4cc2ac041" class="t t">RemotingDecoder</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#d3fee447c77dfb3b" class="i method">GetPropertyValue</a>&lt;<b>long</b>&gt;(<span class="r182 r">data</span>, <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#7c9c1b0b95848ffd" class="t t">RemoteDataNameStrings</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#9b48d21fcadf90c0" class="i field">CallId</a>);
            <a href="#5fff47ad0a516624" class="i property">DispatchTable</a>.<a href="../common/DispatchTable.cs.html#5acbc795fb790e18" class="i method">SetResponse</a>(<span class="r184 r">callId</span>, <span class="r183 r">response</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> When the client remote session reports a URI redirection, this method will report the</span>
        <span class="c">///</span><span class="c"> message to the user as a Warning using Host method calls.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r185 r">sender</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r186 r">eventArgs</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>private void</b> <a id="bfc375fb456f17ae" href="../../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">HandleURIDirectionReported</a>(<b>object</b> <span id="r185 rd" class="r185 r">sender</span>, <a href="../common/misc.cs.html#16d1e16a7ed9f8cc" class="t t">RemoteDataEventArgs</a>&lt;<span class="i">Uri</span>&gt; <span id="r186 rd" class="r186 r">eventArgs</span>)
        {
            <a href="../common/RunspaceConnectionInfo.cs.html#2d9d176ef419be5a" class="t t">WSManConnectionInfo</a> <span id="r187 rd" class="r187 r">wsmanConnectionInfo</span> = <a href="#cf41f6952f7641e0" class="i field">_connectionInfo</a> <b>as</b> <a href="../common/RunspaceConnectionInfo.cs.html#2d9d176ef419be5a" class="t t">WSManConnectionInfo</a>;
            <b>if</b> (<span class="r187 r">wsmanConnectionInfo</span> != <b>null</b>)
            {
                <span class="r187 r">wsmanConnectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#eb73ffdb9b586505" class="i property">ConnectionUri</a> = <span class="r186 r">eventArgs</span>.<a href="../common/misc.cs.html#0896dbbd394ce2e6" class="i property">Data</a>;
                <a href="#4d85229304b06ad8" class="i">URIRedirectionReported</a>.<span class="i">SafeInvoke</span>(<a href="#1aba79be5da56f57" class="k">this</a>, <span class="r186 r">eventArgs</span>);
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> When the server sends a PSEventArgs this method will add it to the local event queue.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private void</b> <a id="0baf95d59c6ef2e1" href="../../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">HandlePSEventArgsReceived</a>(<b>object</b> <span id="r188 rd" class="r188 r">sender</span>, <a href="../common/misc.cs.html#16d1e16a7ed9f8cc" class="t t">RemoteDataEventArgs</a>&lt;<a href="../../EventManager.cs.html#7210411b2f4a8407" class="t t">PSEventArgs</a>&gt; <span id="r189 rd" class="r189 r">e</span>)
        {
            <a href="../../hostifaces/RunspacePoolInternal.cs.html#b11455355be4eec7" class="i method">OnForwardEvent</a>(<span class="r189 r">e</span>.<a href="../common/misc.cs.html#0896dbbd394ce2e6" class="i property">Data</a>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> A session disconnect has been initiated by the WinRM robust connection layer.  Set</span>
        <span class="c">///</span><span class="c"> internal state to Disconnecting.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r190 r">sender</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r191 r">e</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>private void</b> <a id="d227ebefc46a7b2a" href="../../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">HandleSessionRCDisconnecting</a>(<b>object</b> <span id="r190 rd" class="r190 r">sender</span>, <a href="../common/misc.cs.html#16d1e16a7ed9f8cc" class="t t">RemoteDataEventArgs</a>&lt;<span class="i">Exception</span>&gt; <span id="r191 rd" class="r191 r">e</span>)
        {
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<a href="#1aba79be5da56f57" class="k">this</a>.<a href="../../hostifaces/RunspacePoolInternal.cs.html#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a> == <a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#13cbf83371c004e0" class="i field">Opened</a>,
                <span class="s">&quot;RC disconnect should only occur for runspace pools in the Opened state.&quot;</span>);
 
            <b>lock</b> (<a href="#1aba79be5da56f57" class="k">this</a>.<a href="../../hostifaces/RunspacePoolInternal.cs.html#21db200b449932ac" class="i field">syncObject</a>)
            {
                <a href="#bb418a07ac8ba418" class="i method">SetRunspacePoolState</a>(<b>new</b> <a href="../common/RunspacePoolStateInfo.cs.html#c7dae263df1aded0" class="t constructor">RunspacePoolStateInfo</a>(<a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#91690c7b66b3081a" class="i field">Disconnecting</a>, <span class="r191 r">e</span>.<a href="../common/misc.cs.html#0896dbbd394ce2e6" class="i property">Data</a>));
            }
 
            <a href="../../hostifaces/RunspacePoolInternal.cs.html#c96a416ffa6d47a6" class="i method">RaiseStateChangeEvent</a>(<a href="#1aba79be5da56f57" class="k">this</a>.<a href="../../hostifaces/RunspacePoolInternal.cs.html#37ed160e0fbfb67a" class="i field">stateInfo</a>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The session has been successfully created.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r192 r">sender</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r193 r">eventArgs</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>private void</b> <a id="b37798926a05abef" href="../../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">HandleSessionCreateCompleted</a>(<b>object</b> <span id="r192 rd" class="r192 r">sender</span>, <a href="../fanin/BaseTransportManager.cs.html#7d43cc7a3ac54680" class="t t">CreateCompleteEventArgs</a> <span id="r193 rd" class="r193 r">eventArgs</span>)
        {
            <span class="c">// Update connectionInfo with updated information from the transport.</span>
            <b>if</b> (<span class="r193 r">eventArgs</span> != <b>null</b>)
            {
                <a href="#cf41f6952f7641e0" class="i field">_connectionInfo</a>.<a href="../common/RunspaceConnectionInfo.cs.html#0c117c8cb5b1de8b" class="i property">IdleTimeout</a> = <span class="r193 r">eventArgs</span>.<a href="../fanin/BaseTransportManager.cs.html#42bc94ec2a83fd45" class="i property">ConnectionInfo</a>.<a href="../common/RunspaceConnectionInfo.cs.html#0c117c8cb5b1de8b" class="i property">IdleTimeout</a>;
                <a href="#cf41f6952f7641e0" class="i field">_connectionInfo</a>.<a href="../common/RunspaceConnectionInfo.cs.html#8f5fff031b021f8b" class="i property">MaxIdleTimeout</a> = <span class="r193 r">eventArgs</span>.<a href="../fanin/BaseTransportManager.cs.html#42bc94ec2a83fd45" class="i property">ConnectionInfo</a>.<a href="../common/RunspaceConnectionInfo.cs.html#8f5fff031b021f8b" class="i property">MaxIdleTimeout</a>;
                <a href="../common/RunspaceConnectionInfo.cs.html#2d9d176ef419be5a" class="t t">WSManConnectionInfo</a> <span id="r194 rd" class="r194 r">wsmanConnectionInfo</span> = <a href="#cf41f6952f7641e0" class="i field">_connectionInfo</a> <b>as</b> <a href="../common/RunspaceConnectionInfo.cs.html#2d9d176ef419be5a" class="t t">WSManConnectionInfo</a>;
                <b>if</b> (<span class="r194 r">wsmanConnectionInfo</span> != <b>null</b>)
                {
                    <span class="r194 r">wsmanConnectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#10ef35a810ea13c2" class="i property">OutputBufferingMode</a> =
                        ((<a href="../common/RunspaceConnectionInfo.cs.html#2d9d176ef419be5a" class="t t">WSManConnectionInfo</a>)<span class="r193 r">eventArgs</span>.<a href="../fanin/BaseTransportManager.cs.html#42bc94ec2a83fd45" class="i property">ConnectionInfo</a>).<a href="../common/RunspaceConnectionInfo.cs.html#10ef35a810ea13c2" class="i property">OutputBufferingMode</a>;
                }
            }
 
            <span class="c">// Forward event.</span>
            <a href="#4cbabe5737b8c8dc" class="i">SessionCreateCompleted</a>.<span class="i">SafeInvoke</span>&lt;<a href="../fanin/BaseTransportManager.cs.html#7d43cc7a3ac54680" class="t t">CreateCompleteEventArgs</a>&gt;(<a href="#1aba79be5da56f57" class="k">this</a>, <span class="r193 r">eventArgs</span>);
        }
 
        <b>private void</b> <a id="1ab56db66633b097" href="../../../R/1ab56db66633b097.html" target="n" data-glyph="76,1" class="i method">ResetDisconnectedOnExpiresOn</a>()
        {
            <span class="c">// Reset DisconnectedOn/ExpiresOn</span>
            <a href="../common/RunspaceConnectionInfo.cs.html#2d9d176ef419be5a" class="t t">WSManConnectionInfo</a> <span id="r195 rd" class="r195 r">wsManConnectionInfo</span> = <a href="#cf41f6952f7641e0" class="i field">_connectionInfo</a> <b>as</b> <a href="../common/RunspaceConnectionInfo.cs.html#2d9d176ef419be5a" class="t t">WSManConnectionInfo</a>;
            <b>if</b> (<span class="r195 r">wsManConnectionInfo</span> != <b>null</b>)
            {
                <span class="r195 r">wsManConnectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#bd03a6571a38d3e3" class="i method">NullDisconnectedExpiresOn</a>();
            }
        }
 
        <b>private void</b> <a id="ef718d076f407385" href="../../../R/ef718d076f407385.html" target="n" data-glyph="76,1" class="i method">UpdateDisconnectedExpiresOn</a>()
        {
            <span class="c">// Set DisconnectedOn/ExpiresOn for disconnected session.</span>
            <a href="../common/RunspaceConnectionInfo.cs.html#2d9d176ef419be5a" class="t t">WSManConnectionInfo</a> <span id="r196 rd" class="r196 r">wsManConnectionInfo</span> = <a href="#cf41f6952f7641e0" class="i field">_connectionInfo</a> <b>as</b> <a href="../common/RunspaceConnectionInfo.cs.html#2d9d176ef419be5a" class="t t">WSManConnectionInfo</a>;
            <b>if</b> (<span class="r196 r">wsManConnectionInfo</span> != <b>null</b>)
            {
                <span class="r196 r">wsManConnectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#231c10e07e4ebcfb" class="i method">SetDisconnectedExpiresOnToNow</a>();
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Waits for application private data from server before raising</span>
        <span class="c">///</span><span class="c"> event:  Connecting-&gt;Opened state changed event.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r197 r">state</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>private void</b> <a id="23d9cdf57d71c5ad" href="../../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">WaitAndRaiseConnectEventsProc</a>(<b>object</b> <span id="r197 rd" class="r197 r">state</span>)
        {
            <a href="../common/RunspacePoolStateInfo.cs.html#8b9143609d7a0363" class="t t">RunspacePoolStateInfo</a> <span id="r198 rd" class="r198 r">info</span> = <span class="r197 r">state</span> <b>as</b> <a href="../common/RunspacePoolStateInfo.cs.html#8b9143609d7a0363" class="t t">RunspacePoolStateInfo</a>;
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r198 r">info</span> != <b>null</b>, <span class="s">&quot;State -&gt; Event arguments cannot be null.&quot;</span>);
 
            <span class="c">// Wait for private application data to arrive from server.</span>
            <b>try</b>
            {
                <a href="#4e668911d0a09c43" class="i field">_applicationPrivateDataReceived</a>.<span class="i">WaitOne</span>();
            }
            <b>catch</b> (<span class="i">ObjectDisposedException</span>) { }
 
            <span class="c">// Raise state changed event.</span>
            <b>try</b>
            {
                <a href="../../hostifaces/RunspacePoolInternal.cs.html#c96a416ffa6d47a6" class="i method">RaiseStateChangeEvent</a>(<span class="r198 r">info</span>);
            }
            <b>catch</b> (<span class="i">Exception</span>)
            {
            }
 
            <span class="c">// Set Opened async object.</span>
            <a href="#4b2a5e72cdf8d101" class="i method">SetOpenAsCompleted</a>();
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Private Methods
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Private Members
 
        <b>private readonly</b> <a href="../common/RunspaceConnectionInfo.cs.html#e07ed56a8a1da829" class="t t">RunspaceConnectionInfo</a> <a id="cf41f6952f7641e0" href="../../../R/cf41f6952f7641e0.html" target="n" data-glyph="46,1" class="i field">_connectionInfo</a>;     <span class="c">// connection info with which this</span>
        <span class="c">// runspace is created</span>
        <span class="c">// data structure handler handling</span>
        <b>private</b> <a href="../../hostifaces/RunspacePool.cs.html#bdf2646eeb96a548" class="t t">RunspacePoolAsyncResult</a> <a id="309638fa94386800" href="../../../R/309638fa94386800.html" target="n" data-glyph="46,1" class="i field">_openAsyncResult</a>; <span class="c">// async result object generated on</span>
        <span class="c">// CoreOpen</span>
        <b>private</b> <a href="../../hostifaces/RunspacePool.cs.html#bdf2646eeb96a548" class="t t">RunspacePoolAsyncResult</a> <a id="deb9ddedc45cfcd0" href="../../../R/deb9ddedc45cfcd0.html" target="n" data-glyph="46,1" class="i field">_closeAsyncResult</a>; <span class="c">// async result object generated by</span>
        <span class="c">// BeginClose</span>
        <b>private</b> <span class="i">Exception</span> <a id="fc38c3edf7f4aacf" href="../../../R/fc38c3edf7f4aacf.html" target="n" data-glyph="46,1" class="i field">_closingReason</a>;                       <span class="c">// reason for a Closing state transition</span>
        <b>private</b> <a href="../../hostifaces/RunspacePool.cs.html#bdf2646eeb96a548" class="t t">RunspacePoolAsyncResult</a> <a id="2c7911cd99440a88" href="../../../R/2c7911cd99440a88.html" target="n" data-glyph="46,1" class="i field">_disconnectAsyncResult</a>; <span class="c">// async result object generated on CoreDisconnect</span>
        <b>private</b> <a href="../../hostifaces/RunspacePool.cs.html#bdf2646eeb96a548" class="t t">RunspacePoolAsyncResult</a> <a id="a24d1859482f126a" href="../../../R/a24d1859482f126a.html" target="n" data-glyph="46,1" class="i field">_reconnectAsyncResult</a>;  <span class="c">// async result object generated on CoreReconnect</span>
        <b>private bool</b> <a id="070c2c51c89d22f4" href="../../../R/070c2c51c89d22f4.html" target="n" data-glyph="46,1" class="i field">_isDisposed</a>;
 
        <b>private</b> <a href="../common/DispatchTable.cs.html#1c1bcd7eb0507d88" class="t t">DispatchTable</a>&lt;<b>object</b>&gt; <a id="5fff47ad0a516624" href="../../../R/5fff47ad0a516624.html" target="n" data-glyph="106,1" class="i property">DispatchTable</a> { <b>get</b>; }
 
        <b>private bool</b> <a id="03452ff544a5ea09" href="../../../R/03452ff544a5ea09.html" target="n" data-glyph="46,1" class="i field">_canReconnect</a>;
        <b>private string</b> <a id="abd906b35b0db638" href="../../../R/abd906b35b0db638.html" target="n" data-glyph="46,1" class="i field">_friendlyName</a> = <b>string</b>.<span class="i">Empty</span>;
 
        <b>private readonly</b> <span class="i n">System</span>.<span class="i">Collections</span>.<span class="i">Concurrent</span>.<span class="i">ConcurrentStack</span>&lt;<a href="../../hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShell</a>&gt; <a id="f17432095680626f" href="../../../R/f17432095680626f.html" target="n" data-glyph="46,1" class="i field">_runningPowerShells</a>;
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Private Members
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> IDisposable
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Public method for Dispose.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public void</b> <a id="bf15c5e4fe1f1c39" href="../../../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">Dispose</a>()
        {
            <a href="#bb2d48e513559a0a" class="i method">Dispose</a>(<b>true</b>);
 
            <span class="i">GC</span>.<span class="i">SuppressFinalize</span>(<a href="#1aba79be5da56f57" class="k">this</a>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Release all resources.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r199 r">disposing</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">If true, release all managed resources.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>public override void</b> <a id="bb2d48e513559a0a" href="../../../R/bb2d48e513559a0a.html" target="n" data-glyph="72,1" class="i method">Dispose</a>(<b>bool</b> <span id="r199 rd" class="r199 r">disposing</span>)
        {
            <span class="c">// dispose the base class before disposing dataStructure handler.</span>
            <a href="../../hostifaces/RunspacePoolInternal.cs.html#f2c8813b33dfca3f" class="k">base</a>.<a href="../../hostifaces/RunspacePoolInternal.cs.html#4adfd23f5bdd0610" class="i method">Dispose</a>(<span class="r199 r">disposing</span>);
            <b>if</b> (!<a href="#070c2c51c89d22f4" class="i field">_isDisposed</a>)
            {
                <a href="#070c2c51c89d22f4" class="i field">_isDisposed</a> = <b>true</b>;
                <a href="#6629c704c27c6e09" class="i property">DataStructureHandler</a>.<a href="RemotingProtocol2.cs.html#057f0ddfa0705e07" class="i method">Dispose</a>(<span class="r199 r">disposing</span>);
                <a href="#4e668911d0a09c43" class="i field">_applicationPrivateDataReceived</a>.<span class="i">Dispose</span>();
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> IDisposable
    }
 
    <span class="k preprocess">#</span><span class="k preprocess">region</span> ConnectCommandInfo class
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Class defining a remote command to connect to.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>internal class</b> <a id="b586ca980bfda5bc" href="../../../R/b586ca980bfda5bc.html" target="n" data-glyph="2,0" class="t t">ConnectCommandInfo</a>
    {
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Remote command instance Id.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public</b> <span class="i">Guid</span> <a id="1060192c0e7cff3a" href="../../../R/1060192c0e7cff3a.html" target="n" data-glyph="102,1" class="i property">CommandId</a> { <b>get</b>; } = <span class="i">Guid</span>.<span class="i">Empty</span>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Remote command string.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public string</b> <a id="059b4cc2a74508e2" href="../../../R/059b4cc2a74508e2.html" target="n" data-glyph="102,1" class="i property">Command</a> { <b>get</b>; } = <b>string</b>.<span class="i">Empty</span>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Constructs a remote command object.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r200 r">cmdId</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Command instance Id.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r201 r">cmdStr</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Command string.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>public</b> <a id="7661a91d2cae56e7" href="../../../R/7661a91d2cae56e7.html" target="n" data-glyph="72,1" class="t constructor">ConnectCommandInfo</a>(<span class="i">Guid</span> <span id="r200 rd" class="r200 r">cmdId</span>, <b>string</b> <span id="r201 rd" class="r201 r">cmdStr</span>)
        {
            <a href="#1060192c0e7cff3a" class="i property">CommandId</a> = <span class="r200 r">cmdId</span>;
            <a href="#059b4cc2a74508e2" class="i property">Command</a> = <span class="r201 r">cmdStr</span>;
        }
    }
 
    <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
    <span class="k preprocess">#</span><span class="k preprocess">region</span> RemoteRunspacePoolEnumeration class
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Enumerates remote runspacepools (Shells) and running commands</span>
    <span class="c">///</span><span class="c"> using Get-WSManInstance cmdlet.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>internal static class</b> <a id="75c22c3f22c67301" href="../../../R/75c22c3f22c67301.html" target="n" data-glyph="2,0" class="t t">RemoteRunspacePoolEnumeration</a>
    {
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets an array of XmlElement objects representing all</span>
        <span class="c">///</span><span class="c"> disconnected runspace pools on the indicated server.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r202 r">wsmanConnectionInfo</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Specifies the remote server to connect to.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span><span class="c">]</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">Collection of XmlElement objects.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal static</b> <span class="i">Collection</span>&lt;<a href="../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt; <a id="8b3fccc4885ae1ec" href="../../../R/8b3fccc4885ae1ec.html" target="n" data-glyph="74,1" class="i method">GetRemotePools</a>(<a href="../common/RunspaceConnectionInfo.cs.html#2d9d176ef419be5a" class="t t">WSManConnectionInfo</a> <span id="r202 rd" class="r202 r">wsmanConnectionInfo</span>)
        {
            <span class="i">Collection</span>&lt;<a href="../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt; <span id="r203 rd" class="r203 r">result</span>;
            <b>using</b> (<a href="../../hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShell</a> <span id="r204 rd" class="r204 r">powerShell</span> = <a href="../../hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShell</a>.<a href="../../hostifaces/PowerShell.cs.html#40345bc4625ff918" class="i method">Create</a>())
            {
                <span class="c">// Enumerate remote runspaces using the Get-WSManInstance cmdlet.</span>
                <span class="r204 r">powerShell</span>.<a href="../../hostifaces/PowerShell.cs.html#9cc79c297f6cced9" class="i method">AddCommand</a>(<span class="s">&quot;Get-WSManInstance&quot;</span>);
 
                <span class="c">// Add parameters to enumerate Shells (runspace pools).</span>
                <span class="r204 r">powerShell</span>.<a href="../../hostifaces/PowerShell.cs.html#40674f99a3618f4b" class="i method">AddParameter</a>(<span class="s">&quot;ResourceURI&quot;</span>, <span class="s">&quot;Shell&quot;</span>);
                <span class="r204 r">powerShell</span>.<a href="../../hostifaces/PowerShell.cs.html#40674f99a3618f4b" class="i method">AddParameter</a>(<span class="s">&quot;Enumerate&quot;</span>, <b>true</b>);
 
                <span class="c">// Add parameters for server connection.</span>
                <span class="r204 r">powerShell</span>.<a href="../../hostifaces/PowerShell.cs.html#40674f99a3618f4b" class="i method">AddParameter</a>(<span class="s">&quot;ComputerName&quot;</span>, <span class="r202 r">wsmanConnectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#74b71e9668d24a47" class="i property">ComputerName</a>);
                <span class="r204 r">powerShell</span>.<a href="../../hostifaces/PowerShell.cs.html#40674f99a3618f4b" class="i method">AddParameter</a>(<span class="s">&quot;Authentication&quot;</span>, <a href="#31e827722abe3997" class="i method">ConvertPSAuthToWSManAuth</a>(<span class="r202 r">wsmanConnectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#e1a2e5b5a5d08c41" class="i property">AuthenticationMechanism</a>));
                <b>if</b> (<span class="r202 r">wsmanConnectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#5a783a782d2a0c8e" class="i property">Credential</a> != <b>null</b>)
                {
                    <span class="r204 r">powerShell</span>.<a href="../../hostifaces/PowerShell.cs.html#40674f99a3618f4b" class="i method">AddParameter</a>(<span class="s">&quot;Credential&quot;</span>, <span class="r202 r">wsmanConnectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#5a783a782d2a0c8e" class="i property">Credential</a>);
                }
 
                <b>if</b> (<span class="r202 r">wsmanConnectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#4589105955753e41" class="i property">CertificateThumbprint</a> != <b>null</b>)
                {
                    <span class="r204 r">powerShell</span>.<a href="../../hostifaces/PowerShell.cs.html#40674f99a3618f4b" class="i method">AddParameter</a>(<span class="s">&quot;CertificateThumbprint&quot;</span>, <span class="r202 r">wsmanConnectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#4589105955753e41" class="i property">CertificateThumbprint</a>);
                }
 
                <b>if</b> (<span class="r202 r">wsmanConnectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#bf1ee40cfa31bba1" class="i property">PortSetting</a> != -1)
                {
                    <span class="r204 r">powerShell</span>.<a href="../../hostifaces/PowerShell.cs.html#40674f99a3618f4b" class="i method">AddParameter</a>(<span class="s">&quot;Port&quot;</span>, <span class="r202 r">wsmanConnectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#1aeb2cc802b3a879" class="i property">Port</a>);
                }
 
                <b>if</b> (<a href="#6de9aae89711c6dc" class="i method">CheckForSSL</a>(<span class="r202 r">wsmanConnectionInfo</span>))
                {
                    <span class="r204 r">powerShell</span>.<a href="../../hostifaces/PowerShell.cs.html#40674f99a3618f4b" class="i method">AddParameter</a>(<span class="s">&quot;UseSSL&quot;</span>, <b>true</b>);
                }
 
                <b>if</b> (!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r202 r">wsmanConnectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#0757157b257825db" class="i property">AppName</a>))
                {
                    <span class="c">// Remove prepended path character.</span>
                    <b>string</b> <span id="r205 rd" class="r205 r">appName</span> = <span class="r202 r">wsmanConnectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#0757157b257825db" class="i property">AppName</a>.<span class="i">TrimStart</span>(<span class="s">&#39;/&#39;</span>);
                    <span class="r204 r">powerShell</span>.<a href="../../hostifaces/PowerShell.cs.html#40674f99a3618f4b" class="i method">AddParameter</a>(<span class="s">&quot;ApplicationName&quot;</span>, <span class="r205 r">appName</span>);
                }
 
                <span class="r204 r">powerShell</span>.<a href="../../hostifaces/PowerShell.cs.html#40674f99a3618f4b" class="i method">AddParameter</a>(<span class="s">&quot;SessionOption&quot;</span>, <a href="#3cb42a4c0e27b883" class="i method">GetSessionOptions</a>(<span class="r202 r">wsmanConnectionInfo</span>));
 
                <span class="r203 r">result</span> = <span class="r204 r">powerShell</span>.<a href="../../hostifaces/PowerShell.cs.html#184e23c46120523e" class="i method">Invoke</a>();
            }
 
            <b>return</b> <span class="r203 r">result</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets an array of XmlElement objects representing each running command</span>
        <span class="c">///</span><span class="c"> on the specified runspace pool with the shellid Guid.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r206 r">shellId</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Guid of shellId (runspacepool Id).</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r207 r">wsmanConnectionInfo</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Specifies the remote server to connect to.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span><span class="c">]</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">Collection of XmlElement objects.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal static</b> <span class="i">Collection</span>&lt;<a href="../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt; <a id="f29f5a0d04de1449" href="../../../R/f29f5a0d04de1449.html" target="n" data-glyph="74,1" class="i method">GetRemoteCommands</a>(<span class="i">Guid</span> <span id="r206 rd" class="r206 r">shellId</span>, <a href="../common/RunspaceConnectionInfo.cs.html#2d9d176ef419be5a" class="t t">WSManConnectionInfo</a> <span id="r207 rd" class="r207 r">wsmanConnectionInfo</span>)
        {
            <span class="i">Collection</span>&lt;<a href="../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt; <span id="r208 rd" class="r208 r">result</span>;
            <b>using</b> (<a href="../../hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShell</a> <span id="r209 rd" class="r209 r">powerShell</span> = <a href="../../hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShell</a>.<a href="../../hostifaces/PowerShell.cs.html#40345bc4625ff918" class="i method">Create</a>())
            {
                <span class="c">// Enumerate remote runspace commands using the Get-WSManInstance cmdlet.</span>
                <span class="r209 r">powerShell</span>.<a href="../../hostifaces/PowerShell.cs.html#9cc79c297f6cced9" class="i method">AddCommand</a>(<span class="s">&quot;Get-WSManInstance&quot;</span>);
 
                <span class="c">// Add parameters to enumerate commands.</span>
                <b>string</b> <span id="r210 rd" class="r210 r">filterStr</span> = <b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>, <span class="s">&quot;ShellId=&#39;{0}&#39;&quot;</span>, <span class="r206 r">shellId</span>.<span class="i">ToString</span>().<span class="i">ToUpperInvariant</span>());
                <span class="r209 r">powerShell</span>.<a href="../../hostifaces/PowerShell.cs.html#40674f99a3618f4b" class="i method">AddParameter</a>(<span class="s">&quot;ResourceURI&quot;</span>, <span class="s">@&quot;Shell/Command&quot;</span>);
                <span class="r209 r">powerShell</span>.<a href="../../hostifaces/PowerShell.cs.html#40674f99a3618f4b" class="i method">AddParameter</a>(<span class="s">&quot;Enumerate&quot;</span>, <b>true</b>);
                <span class="r209 r">powerShell</span>.<a href="../../hostifaces/PowerShell.cs.html#40674f99a3618f4b" class="i method">AddParameter</a>(<span class="s">&quot;Dialect&quot;</span>, <span class="s">&quot;Selector&quot;</span>);
                <span class="r209 r">powerShell</span>.<a href="../../hostifaces/PowerShell.cs.html#40674f99a3618f4b" class="i method">AddParameter</a>(<span class="s">&quot;Filter&quot;</span>, <span class="r210 r">filterStr</span>);
 
                <span class="c">// Add parameters for server connection.</span>
                <span class="r209 r">powerShell</span>.<a href="../../hostifaces/PowerShell.cs.html#40674f99a3618f4b" class="i method">AddParameter</a>(<span class="s">&quot;ComputerName&quot;</span>, <span class="r207 r">wsmanConnectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#74b71e9668d24a47" class="i property">ComputerName</a>);
                <span class="r209 r">powerShell</span>.<a href="../../hostifaces/PowerShell.cs.html#40674f99a3618f4b" class="i method">AddParameter</a>(<span class="s">&quot;Authentication&quot;</span>, <a href="#31e827722abe3997" class="i method">ConvertPSAuthToWSManAuth</a>(<span class="r207 r">wsmanConnectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#e1a2e5b5a5d08c41" class="i property">AuthenticationMechanism</a>));
                <b>if</b> (<span class="r207 r">wsmanConnectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#5a783a782d2a0c8e" class="i property">Credential</a> != <b>null</b>)
                {
                    <span class="r209 r">powerShell</span>.<a href="../../hostifaces/PowerShell.cs.html#40674f99a3618f4b" class="i method">AddParameter</a>(<span class="s">&quot;Credential&quot;</span>, <span class="r207 r">wsmanConnectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#5a783a782d2a0c8e" class="i property">Credential</a>);
                }
 
                <b>if</b> (<span class="r207 r">wsmanConnectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#4589105955753e41" class="i property">CertificateThumbprint</a> != <b>null</b>)
                {
                    <span class="r209 r">powerShell</span>.<a href="../../hostifaces/PowerShell.cs.html#40674f99a3618f4b" class="i method">AddParameter</a>(<span class="s">&quot;CertificateThumbprint&quot;</span>, <span class="r207 r">wsmanConnectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#4589105955753e41" class="i property">CertificateThumbprint</a>);
                }
 
                <b>if</b> (<span class="r207 r">wsmanConnectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#bf1ee40cfa31bba1" class="i property">PortSetting</a> != -1)
                {
                    <span class="r209 r">powerShell</span>.<a href="../../hostifaces/PowerShell.cs.html#40674f99a3618f4b" class="i method">AddParameter</a>(<span class="s">&quot;Port&quot;</span>, <span class="r207 r">wsmanConnectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#1aeb2cc802b3a879" class="i property">Port</a>);
                }
 
                <b>if</b> (<a href="#6de9aae89711c6dc" class="i method">CheckForSSL</a>(<span class="r207 r">wsmanConnectionInfo</span>))
                {
                    <span class="r209 r">powerShell</span>.<a href="../../hostifaces/PowerShell.cs.html#40674f99a3618f4b" class="i method">AddParameter</a>(<span class="s">&quot;UseSSL&quot;</span>, <b>true</b>);
                }
 
                <b>if</b> (!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r207 r">wsmanConnectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#0757157b257825db" class="i property">AppName</a>))
                {
                    <span class="c">// Remove prepended path character.</span>
                    <b>string</b> <span id="r211 rd" class="r211 r">appName</span> = <span class="r207 r">wsmanConnectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#0757157b257825db" class="i property">AppName</a>.<span class="i">TrimStart</span>(<span class="s">&#39;/&#39;</span>);
                    <span class="r209 r">powerShell</span>.<a href="../../hostifaces/PowerShell.cs.html#40674f99a3618f4b" class="i method">AddParameter</a>(<span class="s">&quot;ApplicationName&quot;</span>, <span class="r211 r">appName</span>);
                }
 
                <span class="r209 r">powerShell</span>.<a href="../../hostifaces/PowerShell.cs.html#40674f99a3618f4b" class="i method">AddParameter</a>(<span class="s">&quot;SessionOption&quot;</span>, <a href="#3cb42a4c0e27b883" class="i method">GetSessionOptions</a>(<span class="r207 r">wsmanConnectionInfo</span>));
 
                <span class="r208 r">result</span> = <span class="r209 r">powerShell</span>.<a href="../../hostifaces/PowerShell.cs.html#184e23c46120523e" class="i method">Invoke</a>();
            }
 
            <b>return</b> <span class="r208 r">result</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Use the WSMan New-WSManSessionOption cmdlet to create a session options</span>
        <span class="c">///</span><span class="c"> object used for Get-WSManInstance queries.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r212 r">wsmanConnectionInfo</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">WSManConnectionInfo.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">WSMan session options object.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>private static object</b> <a id="3cb42a4c0e27b883" href="../../../R/3cb42a4c0e27b883.html" target="n" data-glyph="76,1" class="i method">GetSessionOptions</a>(<a href="../common/RunspaceConnectionInfo.cs.html#2d9d176ef419be5a" class="t t">WSManConnectionInfo</a> <span id="r212 rd" class="r212 r">wsmanConnectionInfo</span>)
        {
            <span class="i">Collection</span>&lt;<a href="../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt; <span id="r213 rd" class="r213 r">result</span>;
            <b>using</b> (<a href="../../hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShell</a> <span id="r214 rd" class="r214 r">powerShell</span> = <a href="../../hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShell</a>.<a href="../../hostifaces/PowerShell.cs.html#40345bc4625ff918" class="i method">Create</a>())
            {
                <span class="r214 r">powerShell</span>.<a href="../../hostifaces/PowerShell.cs.html#9cc79c297f6cced9" class="i method">AddCommand</a>(<span class="s">&quot;New-WSManSessionOption&quot;</span>);
 
                <b>if</b> (<span class="r212 r">wsmanConnectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#9845f779385f9669" class="i property">ProxyAccessType</a> != <a href="../commands/PSRemotingCmdlet.cs.html#859b8c6a1b0a04ef" class="t t">ProxyAccessType</a>.<a href="../commands/PSRemotingCmdlet.cs.html#b8abe0a20c41194e" class="i field">None</a>)
                {
                    <span class="r214 r">powerShell</span>.<span class="i">AddParameter</span>(<span class="s">&quot;ProxyAccessType&quot;</span>, <span class="s">&quot;Proxy&quot;</span> + <span class="r212 r">wsmanConnectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#9845f779385f9669" class="i property">ProxyAccessType</a>.<span class="i">ToString</span>());
                    <span class="r214 r">powerShell</span>.<span class="i">AddParameter</span>(<span class="s">&quot;ProxyAuthentication&quot;</span>, <span class="r212 r">wsmanConnectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#d95258451cb68b3b" class="i property">ProxyAuthentication</a>.<span class="i">ToString</span>());
 
                    <b>if</b> (<span class="r212 r">wsmanConnectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#b90c1ed41e87c2ea" class="i property">ProxyCredential</a> != <b>null</b>)
                    {
                        <span class="r214 r">powerShell</span>.<a href="../../hostifaces/PowerShell.cs.html#40674f99a3618f4b" class="i method">AddParameter</a>(<span class="s">&quot;ProxyCredential&quot;</span>, <span class="r212 r">wsmanConnectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#b90c1ed41e87c2ea" class="i property">ProxyCredential</a>);
                    }
                }
 
                <span class="c">// New-WSManSessionOption uses the SPNPort number here to enable SPN</span>
                <span class="c">// server authentication.  It looks like any value &gt; 0 will enable</span>
                <span class="c">// this.  Since the Port property always returns a valid port value (&gt;0)</span>
                <span class="c">// just pass the WSManConnectionInfo port parameter.</span>
                <b>if</b> (<span class="r212 r">wsmanConnectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#7c39032b57cd7818" class="i property">IncludePortInSPN</a>)
                {
                    <span class="r214 r">powerShell</span>.<a href="../../hostifaces/PowerShell.cs.html#40674f99a3618f4b" class="i method">AddParameter</a>(<span class="s">&quot;SPNPort&quot;</span>, <span class="r212 r">wsmanConnectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#1aeb2cc802b3a879" class="i property">Port</a>);
                }
 
                <span class="r214 r">powerShell</span>.<a href="../../hostifaces/PowerShell.cs.html#40674f99a3618f4b" class="i method">AddParameter</a>(<span class="s">&quot;SkipCACheck&quot;</span>, <span class="r212 r">wsmanConnectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#1a6db05682add6a0" class="i property">SkipCACheck</a>);
                <span class="r214 r">powerShell</span>.<a href="../../hostifaces/PowerShell.cs.html#40674f99a3618f4b" class="i method">AddParameter</a>(<span class="s">&quot;SkipCNCheck&quot;</span>, <span class="r212 r">wsmanConnectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#62a5656f8055cfb5" class="i property">SkipCNCheck</a>);
                <span class="r214 r">powerShell</span>.<a href="../../hostifaces/PowerShell.cs.html#40674f99a3618f4b" class="i method">AddParameter</a>(<span class="s">&quot;SkipRevocationCheck&quot;</span>, <span class="r212 r">wsmanConnectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#db5f31fe8eaa8600" class="i property">SkipRevocationCheck</a>);
 
                <span class="r214 r">powerShell</span>.<a href="../../hostifaces/PowerShell.cs.html#40674f99a3618f4b" class="i method">AddParameter</a>(<span class="s">&quot;OperationTimeout&quot;</span>, <span class="r212 r">wsmanConnectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#53cee291a23086f5" class="i property">OperationTimeout</a>);
                <span class="r214 r">powerShell</span>.<a href="../../hostifaces/PowerShell.cs.html#40674f99a3618f4b" class="i method">AddParameter</a>(<span class="s">&quot;NoEncryption&quot;</span>, <span class="r212 r">wsmanConnectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#14ce6561582cbf9c" class="i property">NoEncryption</a>);
                <span class="r214 r">powerShell</span>.<a href="../../hostifaces/PowerShell.cs.html#40674f99a3618f4b" class="i method">AddParameter</a>(<span class="s">&quot;UseUTF16&quot;</span>, <span class="r212 r">wsmanConnectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#9b6f0e89a27da3f2" class="i property">UseUTF16</a>);
 
                <span class="r213 r">result</span> = <span class="r214 r">powerShell</span>.<a href="../../hostifaces/PowerShell.cs.html#184e23c46120523e" class="i method">Invoke</a>();
            }
 
            <b>return</b> <span class="r213 r">result</span>[0].<span class="i">BaseObject</span>;
        }
 
        <b>private static bool</b> <a id="6de9aae89711c6dc" href="../../../R/6de9aae89711c6dc.html" target="n" data-glyph="76,1" class="i method">CheckForSSL</a>(<a href="../common/RunspaceConnectionInfo.cs.html#2d9d176ef419be5a" class="t t">WSManConnectionInfo</a> <span id="r215 rd" class="r215 r">wsmanConnectionInfo</span>)
        {
            <b>return</b> (!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r215 r">wsmanConnectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#d29b8b073c4a8931" class="i property">Scheme</a>) &amp;&amp;
                    <span class="r215 r">wsmanConnectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#d29b8b073c4a8931" class="i property">Scheme</a>.<span class="i">Contains</span>(<a href="../common/RunspaceConnectionInfo.cs.html#2d9d176ef419be5a" class="t t">WSManConnectionInfo</a>.<a href="../common/RunspaceConnectionInfo.cs.html#e8cee89627b2168d" class="i field">HttpsScheme</a>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>));
        }
 
        <b>private static int</b> <a id="31e827722abe3997" href="../../../R/31e827722abe3997.html" target="n" data-glyph="76,1" class="i method">ConvertPSAuthToWSManAuth</a>(<a href="../common/RunspaceConnectionInfo.cs.html#f2f89adf00d05f44" class="t t">AuthenticationMechanism</a> <span id="r216 rd" class="r216 r">psAuth</span>)
        {
            <b>int</b> <span id="r217 rd" class="r217 r">wsmanAuth</span>;
 
            <b>switch</b> (<span class="r216 r">psAuth</span>)
            {
                <b>case</b> <a href="../common/RunspaceConnectionInfo.cs.html#f2f89adf00d05f44" class="t t">AuthenticationMechanism</a>.<a href="../common/RunspaceConnectionInfo.cs.html#aa044b4cbb803265" class="i field">Default</a>:
                    <span class="r217 r">wsmanAuth</span> = 0x1;
                    <b>break</b>;
 
                <b>case</b> <a href="../common/RunspaceConnectionInfo.cs.html#f2f89adf00d05f44" class="t t">AuthenticationMechanism</a>.<a href="../common/RunspaceConnectionInfo.cs.html#aa56bb950a6fa6df" class="i field">Basic</a>:
                    <span class="r217 r">wsmanAuth</span> = 0x8;
                    <b>break</b>;
 
                <b>case</b> <a href="../common/RunspaceConnectionInfo.cs.html#f2f89adf00d05f44" class="t t">AuthenticationMechanism</a>.<a href="../common/RunspaceConnectionInfo.cs.html#7094d14a65d8f900" class="i field">Digest</a>:
                    <span class="r217 r">wsmanAuth</span> = 0x2;
                    <b>break</b>;
 
                <b>case</b> <a href="../common/RunspaceConnectionInfo.cs.html#f2f89adf00d05f44" class="t t">AuthenticationMechanism</a>.<a href="../common/RunspaceConnectionInfo.cs.html#c657d2680f8f48a8" class="i field">Credssp</a>:
                    <span class="r217 r">wsmanAuth</span> = 0x80;
                    <b>break</b>;
 
                <b>case</b> <a href="../common/RunspaceConnectionInfo.cs.html#f2f89adf00d05f44" class="t t">AuthenticationMechanism</a>.<a href="../common/RunspaceConnectionInfo.cs.html#b2d61e2011af528f" class="i field">Kerberos</a>:
                    <span class="r217 r">wsmanAuth</span> = 0x10;
                    <b>break</b>;
 
                <b>case</b> <a href="../common/RunspaceConnectionInfo.cs.html#f2f89adf00d05f44" class="t t">AuthenticationMechanism</a>.<a href="../common/RunspaceConnectionInfo.cs.html#e6aff575bfa34071" class="i field">Negotiate</a>:
                    <span class="r217 r">wsmanAuth</span> = 0x4;
                    <b>break</b>;
 
                <b>default</b>:
                    <span class="r217 r">wsmanAuth</span> = 0x1;
                    <b>break</b>;
            }
 
            <b>return</b> <span class="r217 r">wsmanAuth</span>;
        }
    }
 
    <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
}
</pre></td></tr></table></div></body></html>
