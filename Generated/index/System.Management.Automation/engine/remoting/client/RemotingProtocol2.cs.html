<!DOCTYPE html>
<html><head><title>RemotingProtocol2.cs</title><link rel="stylesheet" href="../../../../styles.css"><script src="../../../../scripts.js"></script></head>
<body class="cB" onload="i(1637);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#System.Management.Automation/engine/remoting/client/RemotingProtocol2.cs" target="_top">engine\remoting\client\RemotingProtocol2.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#System.Management.Automation" target="_top">src\System.Management.Automation\System.Management.Automation.csproj</a> (System.Management.Automation)</td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation.</span>
<span class="c">// Licensed under the MIT License.</span>
 
<b>using</b> <span class="i n">System</span>.<span class="i">Collections</span>.<span class="i">Generic</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Collections</span>.<span class="i">ObjectModel</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Host</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Remoting</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Remoting</span>.<span class="i n">Client</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Runspaces</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Runspaces</span>.<span class="i n">Internal</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Tracing</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Threading</span>;
 
<b>using</b> <span class="t">Dbg</span> = <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Diagnostics</a>;
 
<b>namespace</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Internal</span>
{
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Handles all PowerShell data structure handler communication with the</span>
    <span class="c">///</span><span class="c"> server side RunspacePool.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>internal class</b> <a id="7269f3ebd9b81159" href="../../../R/7269f3ebd9b81159.html" target="n" data-glyph="2,0" class="t t">ClientRunspacePoolDataStructureHandler</a> : <span class="i">IDisposable</span>
    {
        <b>private bool</b> <a id="f67c06a03f6c0cc5" href="../../../R/f67c06a03f6c0cc5.html" target="n" data-glyph="46,1" class="i field">_reconnecting</a> = <b>false</b>;
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Constructors
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Constructor which takes a client runspace pool and creates</span>
        <span class="c">///</span><span class="c"> an associated ClientRunspacePoolDataStructureHandler.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r0 r">clientRunspacePool</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Client runspace pool object.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r1 r">typeTable</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Typetable to use for serialization/deserialization.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal</b> <a id="361d769aef2a93b5" href="../../../R/361d769aef2a93b5.html" target="n" data-glyph="74,1" class="t constructor">ClientRunspacePoolDataStructureHandler</a>(<a href="RemoteRunspacePoolInternal.cs.html#1aba79be5da56f57" class="t t">RemoteRunspacePoolInternal</a> <span id="r0 rd" class="r0 r">clientRunspacePool</span>,
            <a href="../../../P/a09d9b2cb7b1f0db.html#a09d9b2cb7b1f0db" class="t t">TypeTable</a> <span id="r1 rd" class="r1 r">typeTable</span>)
        {
            <a href="#c7680ad27c52e9a2" class="i field">_clientRunspacePoolId</a> = <span class="r0 r">clientRunspacePool</span>.<a href="../../hostifaces/RunspacePoolInternal.cs.html#76aedcc22e17e7e5" class="i property">InstanceId</a>;
            <a href="#ea09cda41db8e1b8" class="i field">_minRunspaces</a> = <span class="r0 r">clientRunspacePool</span>.<a href="../../hostifaces/RunspacePoolInternal.cs.html#9495be2d7cb89fd4" class="i method">GetMinRunspaces</a>();
            <a href="#f8df7167331f0b77" class="i field">_maxRunspaces</a> = <span class="r0 r">clientRunspacePool</span>.<a href="../../hostifaces/RunspacePoolInternal.cs.html#15765c6e67d44ff7" class="i method">GetMaxRunspaces</a>();
            <a href="#977015cff2484129" class="i field">_host</a> = <span class="r0 r">clientRunspacePool</span>.<a href="RemoteRunspacePoolInternal.cs.html#836d29f1e729f0db" class="i property">Host</a>;
            <a href="#8eaf4f369f817435" class="i field">_applicationArguments</a> = <span class="r0 r">clientRunspacePool</span>.<a href="RemoteRunspacePoolInternal.cs.html#8e2e1d8a212d75a0" class="i property">ApplicationArguments</a>;
            <a href="#e60f2ab4626e155d" class="i property">RemoteSession</a> = <a href="#60e3359e5ddfdebe" class="i method">CreateClientRemoteSession</a>(<span class="r0 r">clientRunspacePool</span>);
            <span class="c">// TODO: Assign remote session name.. should be passed from clientRunspacePool</span>
            <a href="#9fffaae3a3ec9f83" class="i field">_transportManager</a> = <a href="#e60f2ab4626e155d" class="i property">RemoteSession</a>.<a href="clientremotesession.cs.html#9ca39992bfec8bf8" class="i property">SessionDataStructureHandler</a>.<a href="remotingprotocol.cs.html#c480a490ddf94096" class="i property">TransportManager</a>;
            <a href="#9fffaae3a3ec9f83" class="i field">_transportManager</a>.<a href="../fanin/BaseTransportManager.cs.html#0ded339d7f7c59f8" class="i property">TypeTable</a> = <span class="r1 r">typeTable</span>;
            <a href="#e60f2ab4626e155d" class="i property">RemoteSession</a>.<a href="clientremotesession.cs.html#64a8d5455f513c3a" class="i">StateChanged</a> += <span class="i">HandleClientRemoteSessionStateChanged</span>;
            <a href="#f67c06a03f6c0cc5" class="i field">_reconnecting</a> = <b>false</b>;
 
            <a href="#9fffaae3a3ec9f83" class="i field">_transportManager</a>.<a href="../fanin/BaseTransportManager.cs.html#1acdba1dd243046f" class="i">RobustConnectionNotification</a> += <span class="i">HandleRobustConnectionNotification</span>;
            <a href="#9fffaae3a3ec9f83" class="i field">_transportManager</a>.<a href="../fanin/BaseTransportManager.cs.html#b775a320b2c726cd" class="i">CreateCompleted</a> += <span class="i">HandleSessionCreateCompleted</span>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Constructors
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Data Structure Handler Methods
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Create a runspace pool asynchronously (and opens) it</span>
        <span class="c">///</span><span class="c"> on the server.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="f02881912a691d25" href="../../../R/f02881912a691d25.html" target="n" data-glyph="74,1" class="i method">CreateRunspacePoolAndOpenAsync</a>()
        {
            <span class="c">// #1: Connect to remote session</span>
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<a href="#e60f2ab4626e155d" class="i property">RemoteSession</a>.<a href="clientremotesession.cs.html#9ca39992bfec8bf8" class="i property">SessionDataStructureHandler</a>.<a href="remotingprotocol.cs.html#505271895ffdf1a0" class="i property">StateMachine</a>.<a href="clientremotesessionprotocolstatemachine.cs.html#f9016af4ea5ec99d" class="i property">State</a> == <a href="../common/misc.cs.html#278607b7d2274446" class="t t">RemoteSessionState</a>.<a href="../common/misc.cs.html#9b2f27eacc9ec7e9" class="i field">Idle</a>,
                <span class="s">&quot;State of ClientRemoteSession is expected to be idle before connection is established&quot;</span>);
            <a href="#e60f2ab4626e155d" class="i property">RemoteSession</a>.<a href="clientremotesession.cs.html#27424125d8089a6a" class="i method">CreateAsync</a>();
 
            <span class="c">// #2: send the message for runspace pool creation</span>
            <span class="c">// this is done in HandleClientRemoteSessionStateChanged</span>
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Closes the server runspace pool asynchronously.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="b00e0e445baebc5b" href="../../../R/b00e0e445baebc5b.html" target="n" data-glyph="74,1" class="i method">CloseRunspacePoolAsync</a>()
        {
            <a href="#e60f2ab4626e155d" class="i property">RemoteSession</a>.<a href="clientremotesession.cs.html#69914150d7e8acfb" class="i method">CloseAsync</a>();
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Suspends connection to a runspace pool asynchronously.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="72044423843601ca" href="../../../R/72044423843601ca.html" target="n" data-glyph="74,1" class="i method">DisconnectPoolAsync</a>()
        {
            <span class="c">// Prepare running commands for disconnect and start disconnect</span>
            <span class="c">// when ready.</span>
            <a href="#f5b45457df0225c8" class="i method">PrepareForAndStartDisconnect</a>();
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Restore connection to a runspace pool asynchronously.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="1777e1865ec532fe" href="../../../R/1777e1865ec532fe.html" target="n" data-glyph="74,1" class="i method">ReconnectPoolAsync</a>()
        {
            <span class="c">// TODO: Integrate this into state machine</span>
            <a href="#f67c06a03f6c0cc5" class="i field">_reconnecting</a> = <b>true</b>;
            <a href="#b36535d72946b995" class="i method">PrepareForConnect</a>();
            <a href="#e60f2ab4626e155d" class="i property">RemoteSession</a>.<a href="clientremotesession.cs.html#0d942a72ca167e5c" class="i method">ReconnectAsync</a>();
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Creates a connection to an existing remote runspace pool.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="a61cd929044577ba" href="../../../R/a61cd929044577ba.html" target="n" data-glyph="74,1" class="i method">ConnectPoolAsync</a>()
        {
            <a href="#b36535d72946b995" class="i method">PrepareForConnect</a>();
            <a href="#e60f2ab4626e155d" class="i property">RemoteSession</a>.<a href="clientremotesession.cs.html#4de70852c24e5b40" class="i method">ConnectAsync</a>();
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Process the data received from the runspace pool</span>
        <span class="c">///</span><span class="c"> on the server.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r2 r">receivedData</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Data received.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="e84f84e8146715ec" href="../../../R/e84f84e8146715ec.html" target="n" data-glyph="74,1" class="i method">ProcessReceivedData</a>(<a href="../common/WireDataFormat/RemotingDataObject.cs.html#ca4629603c976aab" class="t t">RemoteDataObject</a>&lt;<a href="../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt; <span id="r2 rd" class="r2 r">receivedData</span>)
        {
            <span class="c">// verify if this data structure handler is the intended recipient</span>
            <b>if</b> (<span class="r2 r">receivedData</span>.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#df5fe91d15e5ba71" class="i property">RunspacePoolId</a> != <a href="#c7680ad27c52e9a2" class="i field">_clientRunspacePoolId</a>)
            {
                <b>throw</b> <b>new</b> <span class="t">PSRemotingDataStructureException</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">RunspaceIdsDoNotMatch</span>,
                                <span class="r2 r">receivedData</span>.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#df5fe91d15e5ba71" class="i property">RunspacePoolId</a>, <a href="#c7680ad27c52e9a2" class="i field">_clientRunspacePoolId</a>);
            }
 
            <span class="c">// take appropriate action based on the action type</span>
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r2 r">receivedData</span>.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#6975a2b0635b9f80" class="i property">TargetInterface</a> == <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#1d73dff2a8d6a0bf" class="t t">RemotingTargetInterface</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#405ccc8b1bd2a170" class="i field">RunspacePool</a>,
                <span class="s">&quot;Target interface is expected to be RunspacePool&quot;</span>);
 
            <b>switch</b> (<span class="r2 r">receivedData</span>.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#97d7621b092d013f" class="i property">DataType</a>)
            {
                <b>case</b> <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#296cbb5be87abd08" class="t t">RemotingDataType</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#039fa54a21ae924c" class="i field">RemoteHostCallUsingRunspaceHost</a>:
                    {
                        <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<a href="#04f3f3687cb34938" class="i">RemoteHostCallReceived</a> != <b>null</b>,
                            <span class="s">&quot;RemoteRunspacePoolInternal should subscribe to all data structure handler events&quot;</span>);
 
                        <a href="../common/WireDataFormat/RemoteHost.cs.html#8bf334b011b63f92" class="t t">RemoteHostCall</a> <span id="r3 rd" class="r3 r">remoteHostCall</span> = <a href="../common/WireDataFormat/RemoteHost.cs.html#8bf334b011b63f92" class="t t">RemoteHostCall</a>.<a href="../common/WireDataFormat/RemoteHost.cs.html#c603556c125f7c63" class="i method">Decode</a>(<span class="r2 r">receivedData</span>.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#d13e5d3038741f3e" class="i property">Data</a>);
                        <a href="#04f3f3687cb34938" class="i">RemoteHostCallReceived</a>.<span class="i">SafeInvoke</span>(<a href="#7269f3ebd9b81159" class="k">this</a>, <b>new</b> <a href="../common/misc.cs.html#79fd22f37cbd3e2d" class="t constructor">RemoteDataEventArgs</a>&lt;<a href="../common/WireDataFormat/RemoteHost.cs.html#8bf334b011b63f92" class="t t">RemoteHostCall</a>&gt;(<span class="r3 r">remoteHostCall</span>));
                    }
 
                    <b>break</b>;
 
                <b>case</b> <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#296cbb5be87abd08" class="t t">RemotingDataType</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#e41c5058f62206db" class="i field">RunspacePoolInitData</a>:
                    {
                        <a href="../common/RunspaceInitInfo.cs.html#3c3057f316390745" class="t t">RunspacePoolInitInfo</a> <span id="r4 rd" class="r4 r">initInfo</span> = <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#6f71f8c4cc2ac041" class="t t">RemotingDecoder</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#807ab5db183a009e" class="i method">GetRunspacePoolInitInfo</a>(<span class="r2 r">receivedData</span>.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#d13e5d3038741f3e" class="i property">Data</a>);
 
                        <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<a href="#bf58d5a4ed614edf" class="i">RSPoolInitInfoReceived</a> != <b>null</b>,
                            <span class="s">&quot;RemoteRunspacePoolInternal should subscribe to all data structure handler events&quot;</span>);
                        <a href="#bf58d5a4ed614edf" class="i">RSPoolInitInfoReceived</a>.<span class="i">SafeInvoke</span>(<a href="#7269f3ebd9b81159" class="k">this</a>,
                            <b>new</b> <a href="../common/misc.cs.html#79fd22f37cbd3e2d" class="t constructor">RemoteDataEventArgs</a>&lt;<a href="../common/RunspaceInitInfo.cs.html#3c3057f316390745" class="t t">RunspacePoolInitInfo</a>&gt;(<span class="r4 r">initInfo</span>));
                    }
 
                    <b>break</b>;
 
                <b>case</b> <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#296cbb5be87abd08" class="t t">RemotingDataType</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#0aee2d3c8d9b0076" class="i field">RunspacePoolStateInfo</a>:
                    {
                        <a href="../common/RunspacePoolStateInfo.cs.html#8b9143609d7a0363" class="t t">RunspacePoolStateInfo</a> <span id="r5 rd" class="r5 r">stateInfo</span> =
                            <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#6f71f8c4cc2ac041" class="t t">RemotingDecoder</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#44cac9843d77a5ba" class="i method">GetRunspacePoolStateInfo</a>(<span class="r2 r">receivedData</span>.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#d13e5d3038741f3e" class="i property">Data</a>);
 
                        <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<a href="#fa0a7b8972a210b1" class="i">StateInfoReceived</a> != <b>null</b>,
                            <span class="s">&quot;RemoteRunspacePoolInternal should subscribe to all data structure handler events&quot;</span>);
                        <a href="#fa0a7b8972a210b1" class="i">StateInfoReceived</a>.<span class="i">SafeInvoke</span>(<a href="#7269f3ebd9b81159" class="k">this</a>,
                            <b>new</b> <a href="../common/misc.cs.html#79fd22f37cbd3e2d" class="t constructor">RemoteDataEventArgs</a>&lt;<a href="../common/RunspacePoolStateInfo.cs.html#8b9143609d7a0363" class="t t">RunspacePoolStateInfo</a>&gt;(<span class="r5 r">stateInfo</span>));
 
                        <a href="#cb1987ee5fd37e17" class="i method">NotifyAssociatedPowerShells</a>(<span class="r5 r">stateInfo</span>);
                    }
 
                    <b>break</b>;
 
                <b>case</b> <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#296cbb5be87abd08" class="t t">RemotingDataType</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#2d2c451c38d5530c" class="i field">ApplicationPrivateData</a>:
                    {
                        <a href="../../serialization.cs.html#04756020c00714fe" class="t t">PSPrimitiveDictionary</a> <span id="r6 rd" class="r6 r">applicationPrivateData</span> = <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#6f71f8c4cc2ac041" class="t t">RemotingDecoder</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#216ee960fdab1445" class="i method">GetApplicationPrivateData</a>(<span class="r2 r">receivedData</span>.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#d13e5d3038741f3e" class="i property">Data</a>);
                        <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<a href="#fb769c5336c2662c" class="i">ApplicationPrivateDataReceived</a> != <b>null</b>,
                            <span class="s">&quot;RemoteRunspacePoolInternal should subscribe to all data structure handler events&quot;</span>);
                        <a href="#fb769c5336c2662c" class="i">ApplicationPrivateDataReceived</a>.<span class="i">SafeInvoke</span>(<a href="#7269f3ebd9b81159" class="k">this</a>,
                            <b>new</b> <a href="../common/misc.cs.html#79fd22f37cbd3e2d" class="t constructor">RemoteDataEventArgs</a>&lt;<a href="../../serialization.cs.html#04756020c00714fe" class="t t">PSPrimitiveDictionary</a>&gt;(<span class="r6 r">applicationPrivateData</span>));
                    }
 
                    <b>break</b>;
 
                <b>case</b> <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#296cbb5be87abd08" class="t t">RemotingDataType</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#3b51a682ea77ca94" class="i field">RunspacePoolOperationResponse</a>:
                    {
                        <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<a href="#51a9e31e7d8d7778" class="i">SetMaxMinRunspacesResponseReceived</a> != <b>null</b>,
                            <span class="s">&quot;RemoteRunspacePoolInternal should subscribe to all data structure handler events&quot;</span>);
 
                        <a href="#51a9e31e7d8d7778" class="i">SetMaxMinRunspacesResponseReceived</a>.<span class="i">SafeInvoke</span>(<a href="#7269f3ebd9b81159" class="k">this</a>, <b>new</b> <a href="../common/misc.cs.html#79fd22f37cbd3e2d" class="t constructor">RemoteDataEventArgs</a>&lt;<a href="../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt;(<span class="r2 r">receivedData</span>.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#d13e5d3038741f3e" class="i property">Data</a>));
                    }
 
                    <b>break</b>;
 
                <b>case</b> <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#296cbb5be87abd08" class="t t">RemotingDataType</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#0922a637409a0869" class="i field">PSEventArgs</a>:
                    {
                        <a href="../../EventManager.cs.html#7210411b2f4a8407" class="t t">PSEventArgs</a> <span id="r7 rd" class="r7 r">psEventArgs</span> = <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#6f71f8c4cc2ac041" class="t t">RemotingDecoder</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#377d82ad8589858d" class="i method">GetPSEventArgs</a>(<span class="r2 r">receivedData</span>.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#d13e5d3038741f3e" class="i property">Data</a>);
 
                        <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<a href="#06dff54382619c9e" class="i">PSEventArgsReceived</a> != <b>null</b>,
                            <span class="s">&quot;RemoteRunspacePoolInternal should subscribe to all data structure handler events&quot;</span>);
 
                        <a href="#06dff54382619c9e" class="i">PSEventArgsReceived</a>.<span class="i">SafeInvoke</span>(<a href="#7269f3ebd9b81159" class="k">this</a>, <b>new</b> <a href="../common/misc.cs.html#79fd22f37cbd3e2d" class="t constructor">RemoteDataEventArgs</a>&lt;<a href="../../EventManager.cs.html#7210411b2f4a8407" class="t t">PSEventArgs</a>&gt;(<span class="r7 r">psEventArgs</span>));
                    }
 
                    <b>break</b>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Creates a PowerShell data structure handler instance associated</span>
        <span class="c">///</span><span class="c"> with this runspace pool data structure handler.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r8 r">shell</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Associated powershell.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">PowerShell data structure handler object.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal</b> <a href="#ef96db27814e82f4" class="t t">ClientPowerShellDataStructureHandler</a> <a id="6fe92268c28aa446" href="../../../R/6fe92268c28aa446.html" target="n" data-glyph="74,1" class="i method">CreatePowerShellDataStructureHandler</a>(
            <a href="ClientRemotePowerShell.cs.html#b4d2ac017883b31c" class="t t">ClientRemotePowerShell</a> <span id="r8 rd" class="r8 r">shell</span>)
        {
            <a href="../fanin/BaseTransportManager.cs.html#fa455a694094fdc2" class="t t">BaseClientCommandTransportManager</a> <span id="r9 rd" class="r9 r">clientTransportMgr</span> =
                <a href="#e60f2ab4626e155d" class="i property">RemoteSession</a>.<a href="clientremotesession.cs.html#9ca39992bfec8bf8" class="i property">SessionDataStructureHandler</a>.<a href="remotingprotocol.cs.html#b63183f38c5fbb17" class="i method">CreateClientCommandTransportManager</a>(<span class="r8 r">shell</span>, <span class="r8 r">shell</span>.<a href="ClientRemotePowerShell.cs.html#c3bd35b8d6fe0404" class="i property">NoInput</a>);
 
            <b>return</b> <b>new</b> <a href="#53f4e658ecaeff3a" class="t constructor">ClientPowerShellDataStructureHandler</a>(
                <span class="r9 r">clientTransportMgr</span>, <a href="#c7680ad27c52e9a2" class="i field">_clientRunspacePoolId</a>, <span class="r8 r">shell</span>.<a href="ClientRemotePowerShell.cs.html#71022daeee1769bc" class="i property">InstanceId</a>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Creates a PowerShell instances on the server, associates it</span>
        <span class="c">///</span><span class="c"> with this runspace pool and invokes.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r10 r">shell</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The client remote powershell.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="945cfb8a49d583cf" href="../../../R/945cfb8a49d583cf.html" target="n" data-glyph="74,1" class="i method">CreatePowerShellOnServerAndInvoke</a>(<a href="ClientRemotePowerShell.cs.html#b4d2ac017883b31c" class="t t">ClientRemotePowerShell</a> <span id="r10 rd" class="r10 r">shell</span>)
        {
            <span class="c">// add to associated powershell list and send request to server</span>
            <b>lock</b> (<a href="#7bcaed378b172a37" class="i field">_associationSyncObject</a>)
            {
                <a href="#f74c5f6b1e3e9fe5" class="i field">_associatedPowerShellDSHandlers</a>.<span class="i">Add</span>(<span class="r10 r">shell</span>.<a href="ClientRemotePowerShell.cs.html#71022daeee1769bc" class="i property">InstanceId</a>, <span class="r10 r">shell</span>.<a href="ClientRemotePowerShell.cs.html#ed443312f1d49fb1" class="i property">DataStructureHandler</a>);
            }
 
            <span class="r10 r">shell</span>.<a href="ClientRemotePowerShell.cs.html#ed443312f1d49fb1" class="i property">DataStructureHandler</a>.<a href="#1e1c7bde6009d12a" class="i">RemoveAssociation</a> += <span class="i">HandleRemoveAssociation</span>;
 
            <span class="c">// Find out if this is an invoke and disconnect operation and if so whether the endpoint</span>
            <span class="c">// supports disconnect.  Throw exception if disconnect is not supported.</span>
            <b>bool</b> <span id="r11 rd" class="r11 r">invokeAndDisconnect</span> = <span class="r10 r">shell</span>.<a href="ClientRemotePowerShell.cs.html#0a76510a18071d39" class="i property">Settings</a> != <b>null</b> &amp;&amp; <span class="r10 r">shell</span>.<a href="ClientRemotePowerShell.cs.html#0a76510a18071d39" class="i property">Settings</a>.<a href="../../hostifaces/PowerShell.cs.html#14c829f9d290d4cc" class="i property">InvokeAndDisconnect</a>;
            <b>if</b> (<span class="r11 r">invokeAndDisconnect</span> &amp;&amp; !<a href="#5462b7ca1ee4d850" class="i property">EndpointSupportsDisconnect</a>)
            {
                <b>throw</b> <b>new</b> <span class="t">PSRemotingDataStructureException</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">EndpointDoesNotSupportDisconnect</span>);
            }
 
            <b>if</b> (<a href="#e60f2ab4626e155d" class="i property">RemoteSession</a> == <b>null</b>)
            {
                <b>throw</b> <b>new</b> <span class="i">ObjectDisposedException</span>(<span class="s">&quot;ClientRunspacePoolDataStructureHandler&quot;</span>);
            }
 
            <span class="r10 r">shell</span>.<a href="ClientRemotePowerShell.cs.html#ed443312f1d49fb1" class="i property">DataStructureHandler</a>.<a href="#d723a299036cbb7a" class="i method">Start</a>(<a href="#e60f2ab4626e155d" class="i property">RemoteSession</a>.<a href="clientremotesession.cs.html#9ca39992bfec8bf8" class="i property">SessionDataStructureHandler</a>.<a href="remotingprotocol.cs.html#505271895ffdf1a0" class="i property">StateMachine</a>, <span class="r11 r">invokeAndDisconnect</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Add a ClientPowerShellDataStructureHandler to association list.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r12 r">psShellInstanceId</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">PowerShell Instance Id.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r13 r">psDSHandler</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">ClientPowerShellDataStructureHandler for PowerShell.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="a4102d885e8b1ec7" href="../../../R/a4102d885e8b1ec7.html" target="n" data-glyph="74,1" class="i method">AddRemotePowerShellDSHandler</a>(<span class="i">Guid</span> <span id="r12 rd" class="r12 r">psShellInstanceId</span>, <a href="#ef96db27814e82f4" class="t t">ClientPowerShellDataStructureHandler</a> <span id="r13 rd" class="r13 r">psDSHandler</span>)
        {
            <b>lock</b> (<a href="#7bcaed378b172a37" class="i field">_associationSyncObject</a>)
            {
                <span class="c">// Remove old DSHandler and replace with new.</span>
                <a href="#f74c5f6b1e3e9fe5" class="i field">_associatedPowerShellDSHandlers</a>[<span class="r12 r">psShellInstanceId</span>] = <span class="r13 r">psDSHandler</span>;
            }
 
            <span class="r13 r">psDSHandler</span>.<a href="#1e1c7bde6009d12a" class="i">RemoveAssociation</a> += <span class="i">HandleRemoveAssociation</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Dispatch the message to the associated powershell data structure handler.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r14 r">rcvdData</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Message received.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="da27441f3ee29d1f" href="../../../R/da27441f3ee29d1f.html" target="n" data-glyph="74,1" class="i method">DispatchMessageToPowerShell</a>(<a href="../common/WireDataFormat/RemotingDataObject.cs.html#ca4629603c976aab" class="t t">RemoteDataObject</a>&lt;<a href="../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt; <span id="r14 rd" class="r14 r">rcvdData</span>)
        {
            <a href="#ef96db27814e82f4" class="t t">ClientPowerShellDataStructureHandler</a> <span id="r15 rd" class="r15 r">dsHandler</span> =
                <a href="#c0b572db52bd0f64" class="i method">GetAssociatedPowerShellDataStructureHandler</a>(<span class="r14 r">rcvdData</span>.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#767aea3474afdc8e" class="i property">PowerShellId</a>);
 
            <span class="c">// if a data structure handler does not exist it means</span>
            <span class="c">// the association has been removed -</span>
            <span class="c">// discard messages</span>
            <b>if</b> (<span class="r15 r">dsHandler</span> != <b>null</b>)
            {
                <span class="r15 r">dsHandler</span>.<a href="#c8d5a8987499c580" class="i method">ProcessReceivedData</a>(<span class="r14 r">rcvdData</span>);
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Send the host response to the server.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r16 r">hostResponse</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Host response object to send.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="3a23ef12d93e8d6b" href="../../../R/3a23ef12d93e8d6b.html" target="n" data-glyph="74,1" class="i method">SendHostResponseToServer</a>(<a href="../common/WireDataFormat/RemoteHost.cs.html#2088d050a88e3ac6" class="t t">RemoteHostResponse</a> <span id="r16 rd" class="r16 r">hostResponse</span>)
        {
            <a href="#7b5677ebc3b3b419" class="i method">SendDataAsync</a>(<span class="r16 r">hostResponse</span>.<a href="../common/WireDataFormat/RemoteHost.cs.html#657b141251f02e27" class="i method">Encode</a>(), <a href="../fanin/PriorityCollection.cs.html#f0975201467fdc06" class="t t">DataPriorityType</a>.<a href="../fanin/PriorityCollection.cs.html#ef28607d20d8e243" class="i field">PromptResponse</a>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Send a message to the server instructing it to reset its runspace state.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r17 r">callId</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Caller Id.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="c094016d47c8ba81" href="../../../R/c094016d47c8ba81.html" target="n" data-glyph="74,1" class="i method">SendResetRunspaceStateToServer</a>(<b>long</b> <span id="r17 rd" class="r17 r">callId</span>)
        {
            <a href="../common/WireDataFormat/RemotingDataObject.cs.html#3856dcbea775cab8" class="t t">RemoteDataObject</a> <span id="r18 rd" class="r18 r">message</span> =
                <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#88b19073d823ce05" class="t t">RemotingEncoder</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#77ca4d1b1bd3fadf" class="i method">GenerateResetRunspaceState</a>(<a href="#c7680ad27c52e9a2" class="i field">_clientRunspacePoolId</a>, <span class="r17 r">callId</span>);
 
            <a href="#9afa9af97e6ea63a" class="i method">SendDataAsync</a>(<span class="r18 r">message</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Sent a message to modify the max runspaces of the runspace pool.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r19 r">maxRunspaces</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">New maxrunspaces to set.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r20 r">callId</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">call id on which the calling method will</span>
        <span class="c">///</span><span class="c"> be blocked on</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="e8b3b9c5905097a8" href="../../../R/e8b3b9c5905097a8.html" target="n" data-glyph="74,1" class="i method">SendSetMaxRunspacesToServer</a>(<b>int</b> <span id="r19 rd" class="r19 r">maxRunspaces</span>, <b>long</b> <span id="r20 rd" class="r20 r">callId</span>)
        {
            <a href="../common/WireDataFormat/RemotingDataObject.cs.html#3856dcbea775cab8" class="t t">RemoteDataObject</a> <span id="r21 rd" class="r21 r">message</span> =
                <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#88b19073d823ce05" class="t t">RemotingEncoder</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#1e0efb543e1c620b" class="i method">GenerateSetMaxRunspaces</a>(<a href="#c7680ad27c52e9a2" class="i field">_clientRunspacePoolId</a>, <span class="r19 r">maxRunspaces</span>, <span class="r20 r">callId</span>);
 
            <a href="#9afa9af97e6ea63a" class="i method">SendDataAsync</a>(<span class="r21 r">message</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Send a message to modify the min runspaces of the runspace pool.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r22 r">minRunspaces</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">New minrunspaces to set.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r23 r">callId</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">call id on which the calling method will</span>
        <span class="c">///</span><span class="c"> be blocked on</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="c9d35a601e824eae" href="../../../R/c9d35a601e824eae.html" target="n" data-glyph="74,1" class="i method">SendSetMinRunspacesToServer</a>(<b>int</b> <span id="r22 rd" class="r22 r">minRunspaces</span>, <b>long</b> <span id="r23 rd" class="r23 r">callId</span>)
        {
            <a href="../common/WireDataFormat/RemotingDataObject.cs.html#3856dcbea775cab8" class="t t">RemoteDataObject</a> <span id="r24 rd" class="r24 r">message</span> =
                <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#88b19073d823ce05" class="t t">RemotingEncoder</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#204bc8dc1d0b50d2" class="i method">GenerateSetMinRunspaces</a>(<a href="#c7680ad27c52e9a2" class="i field">_clientRunspacePoolId</a>, <span class="r22 r">minRunspaces</span>, <span class="r23 r">callId</span>);
 
            <a href="#9afa9af97e6ea63a" class="i method">SendDataAsync</a>(<span class="r24 r">message</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Send a message to get the available runspaces from the server.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r25 r">callId</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">call id on which the calling method will</span>
        <span class="c">///</span><span class="c"> be blocked on</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="86b426e98414de12" href="../../../R/86b426e98414de12.html" target="n" data-glyph="74,1" class="i method">SendGetAvailableRunspacesToServer</a>(<b>long</b> <span id="r25 rd" class="r25 r">callId</span>)
        {
            <a href="#9afa9af97e6ea63a" class="i method">SendDataAsync</a>(<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#88b19073d823ce05" class="t t">RemotingEncoder</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#5d247ae1ffab9a07" class="i method">GenerateGetAvailableRunspaces</a>(<a href="#c7680ad27c52e9a2" class="i field">_clientRunspacePoolId</a>, <span class="r25 r">callId</span>));
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Data Structure Handler Methods
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Data Structure Handler events
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Event raised when a host call is received.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal event</b> <span class="i">EventHandler</span>&lt;<a href="../common/misc.cs.html#16d1e16a7ed9f8cc" class="t t">RemoteDataEventArgs</a>&lt;<a href="../common/WireDataFormat/RemoteHost.cs.html#8bf334b011b63f92" class="t t">RemoteHostCall</a>&gt;&gt; <a id="04f3f3687cb34938" href="../../../R/04f3f3687cb34938.html" target="n" data-glyph="32,1" class="i">RemoteHostCallReceived</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Event raised when state information is received.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal event</b> <span class="i">EventHandler</span>&lt;<a href="../common/misc.cs.html#16d1e16a7ed9f8cc" class="t t">RemoteDataEventArgs</a>&lt;<a href="../common/RunspacePoolStateInfo.cs.html#8b9143609d7a0363" class="t t">RunspacePoolStateInfo</a>&gt;&gt; <a id="fa0a7b8972a210b1" href="../../../R/fa0a7b8972a210b1.html" target="n" data-glyph="32,1" class="i">StateInfoReceived</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Event raised when RunspacePoolInitInfo is received. This is the first runspace pool message expected</span>
        <span class="c">///</span><span class="c"> after connecting to an existing remote runspace pool. RemoteRunspacePoolInternal should use this</span>
        <span class="c">///</span><span class="c"> notification to set the state of a reconstructed runspace to &quot;Opened State&quot; and use the</span>
        <span class="c">///</span><span class="c"> minRunspace and MaxRunspaces information to set its state.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal event</b> <span class="i">EventHandler</span>&lt;<a href="../common/misc.cs.html#16d1e16a7ed9f8cc" class="t t">RemoteDataEventArgs</a>&lt;<a href="../common/RunspaceInitInfo.cs.html#3c3057f316390745" class="t t">RunspacePoolInitInfo</a>&gt;&gt; <a id="bf58d5a4ed614edf" href="../../../R/bf58d5a4ed614edf.html" target="n" data-glyph="32,1" class="i">RSPoolInitInfoReceived</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Event raised when application private data is received.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal event</b> <span class="i">EventHandler</span>&lt;<a href="../common/misc.cs.html#16d1e16a7ed9f8cc" class="t t">RemoteDataEventArgs</a>&lt;<a href="../../serialization.cs.html#04756020c00714fe" class="t t">PSPrimitiveDictionary</a>&gt;&gt; <a id="fb769c5336c2662c" href="../../../R/fb769c5336c2662c.html" target="n" data-glyph="32,1" class="i">ApplicationPrivateDataReceived</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Event raised when a PSEventArgs is received.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal event</b> <span class="i">EventHandler</span>&lt;<a href="../common/misc.cs.html#16d1e16a7ed9f8cc" class="t t">RemoteDataEventArgs</a>&lt;<a href="../../EventManager.cs.html#7210411b2f4a8407" class="t t">PSEventArgs</a>&gt;&gt; <a id="06dff54382619c9e" href="../../../R/06dff54382619c9e.html" target="n" data-glyph="32,1" class="i">PSEventArgsReceived</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Event raised when the session is closed.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal event</b> <span class="i">EventHandler</span>&lt;<a href="../common/misc.cs.html#16d1e16a7ed9f8cc" class="t t">RemoteDataEventArgs</a>&lt;<span class="i">Exception</span>&gt;&gt; <a id="23d0434265cec36a" href="../../../R/23d0434265cec36a.html" target="n" data-glyph="32,1" class="i">SessionClosed</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal event</b> <span class="i">EventHandler</span>&lt;<a href="../common/misc.cs.html#16d1e16a7ed9f8cc" class="t t">RemoteDataEventArgs</a>&lt;<span class="i">Exception</span>&gt;&gt; <a id="397e074e3b0ebf78" href="../../../R/397e074e3b0ebf78.html" target="n" data-glyph="32,1" class="i">SessionDisconnected</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal event</b> <span class="i">EventHandler</span>&lt;<a href="../common/misc.cs.html#16d1e16a7ed9f8cc" class="t t">RemoteDataEventArgs</a>&lt;<span class="i">Exception</span>&gt;&gt; <a id="91398fc57675dda3" href="../../../R/91398fc57675dda3.html" target="n" data-glyph="32,1" class="i">SessionReconnected</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Event raised when the session is closing.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal event</b> <span class="i">EventHandler</span>&lt;<a href="../common/misc.cs.html#16d1e16a7ed9f8cc" class="t t">RemoteDataEventArgs</a>&lt;<span class="i">Exception</span>&gt;&gt; <a id="dffa826144552f7a" href="../../../R/dffa826144552f7a.html" target="n" data-glyph="32,1" class="i">SessionClosing</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Event raised when a response to a SetMaxRunspaces or SetMinRunspaces call</span>
        <span class="c">///</span><span class="c"> is received.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal event</b> <span class="i">EventHandler</span>&lt;<a href="../common/misc.cs.html#16d1e16a7ed9f8cc" class="t t">RemoteDataEventArgs</a>&lt;<a href="../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt;&gt; <a id="51a9e31e7d8d7778" href="../../../R/51a9e31e7d8d7778.html" target="n" data-glyph="32,1" class="i">SetMaxMinRunspacesResponseReceived</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> EventHandler used to report connection URI redirections to the application.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal event</b> <span class="i">EventHandler</span>&lt;<a href="../common/misc.cs.html#16d1e16a7ed9f8cc" class="t t">RemoteDataEventArgs</a>&lt;<span class="i">Uri</span>&gt;&gt; <a id="a349be0ddd33b0cd" href="../../../R/a349be0ddd33b0cd.html" target="n" data-glyph="32,1" class="i">URIRedirectionReported</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Indicates that a disconnect has been initiated by the WinRM robust connections layer.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal event</b> <span class="i">EventHandler</span>&lt;<a href="../common/misc.cs.html#16d1e16a7ed9f8cc" class="t t">RemoteDataEventArgs</a>&lt;<span class="i">Exception</span>&gt;&gt; <a id="2cbf947810fb0658" href="../../../R/2cbf947810fb0658.html" target="n" data-glyph="32,1" class="i">SessionRCDisconnecting</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Notification that session creation has completed.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal event</b> <span class="i">EventHandler</span>&lt;<a href="../fanin/BaseTransportManager.cs.html#7d43cc7a3ac54680" class="t t">CreateCompleteEventArgs</a>&gt; <a id="c0f2f1dcd50aeb85" href="../../../R/c0f2f1dcd50aeb85.html" target="n" data-glyph="32,1" class="i">SessionCreateCompleted</a>;
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Data Structure Handler events
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Private Methods
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Send the data specified as a RemoteDataObject asynchronously</span>
        <span class="c">///</span><span class="c"> to the runspace pool on the remote session.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r26 r">data</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Data to send.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span><span class="c">This overload takes a RemoteDataObject and should be</span>
        <span class="c">///</span><span class="c"> the one used within the code</span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>private void</b> <a id="9afa9af97e6ea63a" href="../../../R/9afa9af97e6ea63a.html" target="n" data-glyph="76,1" class="i method">SendDataAsync</a>(<a href="../common/WireDataFormat/RemotingDataObject.cs.html#3856dcbea775cab8" class="t t">RemoteDataObject</a> <span id="r26 rd" class="r26 r">data</span>)
        {
            <a href="#9fffaae3a3ec9f83" class="i field">_transportManager</a>.<a href="../fanin/BaseTransportManager.cs.html#f8317afa9f690e3b" class="i property">DataToBeSentCollection</a>.<a href="../fanin/PriorityCollection.cs.html#82212f989f1c53a3" class="i method">Add</a>&lt;<b>object</b>&gt;(<span class="r26 r">data</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Send the data asynchronously to runspace pool driver on remote</span>
        <span class="c">///</span><span class="c"> session with the specified priority.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">typeparam</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r27 r t">T</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">typeparam</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r28 r">data</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Data to be sent to server.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r29 r">priority</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Priority with which to send data.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="efe688abf2cbc79f" href="../../../R/../../0000000000.html" target="n" data-glyph="74,1" class="i method">SendDataAsync</a>&lt;<span id="r27 rd t" class="r27 r t">T</span>&gt;(<a href="../common/WireDataFormat/RemotingDataObject.cs.html#ca4629603c976aab" class="t t">RemoteDataObject</a>&lt;<span class="r27 r t">T</span>&gt; <span id="r28 rd" class="r28 r">data</span>, <a href="../fanin/PriorityCollection.cs.html#f0975201467fdc06" class="t t">DataPriorityType</a> <span id="r29 rd" class="r29 r">priority</span>)
        {
            <a href="#9fffaae3a3ec9f83" class="i field">_transportManager</a>.<a href="../fanin/BaseTransportManager.cs.html#f8317afa9f690e3b" class="i property">DataToBeSentCollection</a>.<a href="../fanin/PriorityCollection.cs.html#442d0537a5958ee8" class="i method">Add</a>&lt;<span class="r27 r t">T</span>&gt;(<span class="r28 r">data</span>, <span class="r29 r">priority</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Send the data asynchronously to runspace pool driver on remote</span>
        <span class="c">///</span><span class="c"> session with the specified priority.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r30 r">data</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Data object to send.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r31 r">priority</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Priority with which to send data.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="7b5677ebc3b3b419" href="../../../R/7b5677ebc3b3b419.html" target="n" data-glyph="74,1" class="i method">SendDataAsync</a>(<a href="../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r30 rd" class="r30 r">data</span>, <a href="../fanin/PriorityCollection.cs.html#f0975201467fdc06" class="t t">DataPriorityType</a> <span id="r31 rd" class="r31 r">priority</span>)
        {
            <a href="../common/WireDataFormat/RemotingDataObject.cs.html#ca4629603c976aab" class="t t">RemoteDataObject</a>&lt;<a href="../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt; <span id="r32 rd" class="r32 r">dataToBeSent</span> = <a href="../common/WireDataFormat/RemotingDataObject.cs.html#ca4629603c976aab" class="t t">RemoteDataObject</a>&lt;<a href="../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt;.<span class="i">CreateFrom</span>(<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#45c72046001f69b8" class="t t">RemotingDestination</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#061ac750e6d280da" class="i field">Server</a>,
                <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#296cbb5be87abd08" class="t t">RemotingDataType</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#2b11ab2bb6f1d7aa" class="i field">InvalidDataType</a>, <a href="#c7680ad27c52e9a2" class="i field">_clientRunspacePoolId</a>, <span class="i">Guid</span>.<span class="i">Empty</span>, <span class="r30 r">data</span>);
 
            <a href="#9fffaae3a3ec9f83" class="i field">_transportManager</a>.<a href="../fanin/BaseTransportManager.cs.html#f8317afa9f690e3b" class="i property">DataToBeSentCollection</a>.<a href="../fanin/PriorityCollection.cs.html#82212f989f1c53a3" class="i method">Add</a>&lt;<a href="../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt;(<span class="r32 r">dataToBeSent</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Create a client remote session based on the connection info.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r33 r">rsPoolInternal</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The RunspacePool object this session should map to.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>private</b> <a href="clientremotesession.cs.html#0a61ff623f7d8c5e" class="t t">ClientRemoteSessionImpl</a> <a id="60e3359e5ddfdebe" href="../../../R/60e3359e5ddfdebe.html" target="n" data-glyph="76,1" class="i method">CreateClientRemoteSession</a>(
                    <a href="RemoteRunspacePoolInternal.cs.html#1aba79be5da56f57" class="t t">RemoteRunspacePoolInternal</a> <span id="r33 rd" class="r33 r">rsPoolInternal</span>)
        {
            <a href="clientremotesession.cs.html#e2e97fb58c308155" class="t t">ClientRemoteSession</a>.<a href="clientremotesession.cs.html#e9dff0e743b410a7" class="t t">URIDirectionReported</a> <span id="r34 rd" class="r34 r">uriRedirectionHandler</span> =
                <b>new</b> <a href="clientremotesession.cs.html#e2e97fb58c308155" class="t t">ClientRemoteSession</a>.<span class="t">URIDirectionReported</span>(<a href="#73eb340dd2c11064" class="i method">HandleURIDirectionReported</a>);
            <b>return</b> <b>new</b> <a href="clientremotesession.cs.html#f4184375369d386b" class="t constructor">ClientRemoteSessionImpl</a>(<span class="r33 r">rsPoolInternal</span>,
                                               <span class="r34 r">uriRedirectionHandler</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Handler for handling all session events.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r35 r">sender</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Sender of this event.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r36 r">e</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Object describing this event.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>private void</b> <a id="a9ed8b6d3cd0cfb1" href="../../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">HandleClientRemoteSessionStateChanged</a>(
                        <b>object</b> <span id="r35 rd" class="r35 r">sender</span>, <a href="../common/misc.cs.html#7e5c4afe334f8fc9" class="t t">RemoteSessionStateEventArgs</a> <span id="r36 rd" class="r36 r">e</span>)
        {
            <span class="c">// send create runspace request while sending negotiation packet. This will</span>
            <span class="c">// save 1 network call to create a runspace on the server.</span>
            <b>if</b> (<span class="r36 r">e</span>.<a href="../common/misc.cs.html#973536ebdade9102" class="i property">SessionStateInfo</a>.<a href="../common/misc.cs.html#fe0ec9ba677d85ef" class="i property">State</a> == <a href="../common/misc.cs.html#278607b7d2274446" class="t t">RemoteSessionState</a>.<a href="../common/misc.cs.html#02873a55aa6133c3" class="i field">NegotiationSending</a>)
            {
                <b>if</b> (<a href="#a4e2d21462f3ca39" class="i field">_createRunspaceCalled</a>)
                {
                    <b>return</b>;
                }
 
                <b>lock</b> (<a href="#eea2244df39359df" class="i field">_syncObject</a>)
                {
                    <span class="c">// We are doing this check because Established event</span>
                    <span class="c">// is raised more than once</span>
                    <b>if</b> (<a href="#a4e2d21462f3ca39" class="i field">_createRunspaceCalled</a>)
                    {
                        <span class="c">// TODO: Put an assert here. NegotiationSending cannot</span>
                        <span class="c">// occur multiple time in v2 remoting.</span>
                        <b>return</b>;
                    }
 
                    <a href="#a4e2d21462f3ca39" class="i field">_createRunspaceCalled</a> = <b>true</b>;
                }
 
                <span class="c">// make client&#39;s PSVersionTable available to the server using applicationArguments</span>
                <a href="../../serialization.cs.html#04756020c00714fe" class="t t">PSPrimitiveDictionary</a> <span id="r37 rd" class="r37 r">argumentsWithVersionTable</span> =
                    <a href="../../serialization.cs.html#04756020c00714fe" class="t t">PSPrimitiveDictionary</a>.<a href="../../serialization.cs.html#e247a6e030dd9d9f" class="i method">CloneAndAddPSVersionTable</a>(<a href="#8eaf4f369f817435" class="i field">_applicationArguments</a>);
                <span class="c">// send a message to the server..</span>
                <a href="#9afa9af97e6ea63a" class="i method">SendDataAsync</a>(<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#88b19073d823ce05" class="t t">RemotingEncoder</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#d8e79bbd9fb4f335" class="i method">GenerateCreateRunspacePool</a>(
                    <a href="#c7680ad27c52e9a2" class="i field">_clientRunspacePoolId</a>, <a href="#ea09cda41db8e1b8" class="i field">_minRunspaces</a>, <a href="#f8df7167331f0b77" class="i field">_maxRunspaces</a>, <a href="#e60f2ab4626e155d" class="i property">RemoteSession</a>.<a href="clientremotesession.cs.html#e8997fdb5a3c5f81" class="i property">RemoteRunspacePoolInternal</a>, <a href="#977015cff2484129" class="i field">_host</a>,
                    <span class="r37 r">argumentsWithVersionTable</span>));
            }
 
            <b>if</b> (<span class="r36 r">e</span>.<a href="../common/misc.cs.html#973536ebdade9102" class="i property">SessionStateInfo</a>.<a href="../common/misc.cs.html#fe0ec9ba677d85ef" class="i property">State</a> == <a href="../common/misc.cs.html#278607b7d2274446" class="t t">RemoteSessionState</a>.<a href="../common/misc.cs.html#2603336a7a6ceec5" class="i field">NegotiationSendingOnConnect</a>)
            {
                <span class="c">// send connect message to the server.</span>
                <a href="#9afa9af97e6ea63a" class="i method">SendDataAsync</a>(<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#88b19073d823ce05" class="t t">RemotingEncoder</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#bc137df3af0e9851" class="i method">GenerateConnectRunspacePool</a>(
                    <a href="#c7680ad27c52e9a2" class="i field">_clientRunspacePoolId</a>, <a href="#ea09cda41db8e1b8" class="i field">_minRunspaces</a>, <a href="#f8df7167331f0b77" class="i field">_maxRunspaces</a>));
            }
            <b>else</b> <b>if</b> (<span class="r36 r">e</span>.<a href="../common/misc.cs.html#973536ebdade9102" class="i property">SessionStateInfo</a>.<a href="../common/misc.cs.html#fe0ec9ba677d85ef" class="i property">State</a> == <a href="../common/misc.cs.html#278607b7d2274446" class="t t">RemoteSessionState</a>.<a href="../common/misc.cs.html#5e7bbe4ce8336771" class="i field">ClosingConnection</a>)
            {
                <span class="c">// use the first reason which caused the error</span>
                <span class="i">Exception</span> <span id="r38 rd" class="r38 r">reason</span> = <a href="#1179654ce1c24b6d" class="i field">_closingReason</a>;
                <b>if</b> (<span class="r38 r">reason</span> == <b>null</b>)
                {
                    <span class="r38 r">reason</span> = <span class="r36 r">e</span>.<a href="../common/misc.cs.html#973536ebdade9102" class="i property">SessionStateInfo</a>.<a href="../common/misc.cs.html#91101c327c02f6db" class="i property">Reason</a>;
                    <a href="#1179654ce1c24b6d" class="i field">_closingReason</a> = <span class="r38 r">reason</span>;
                }
 
                <span class="c">// close transport managers of the associated commands</span>
                <span class="i">List</span>&lt;<a href="#ef96db27814e82f4" class="t t">ClientPowerShellDataStructureHandler</a>&gt; <span id="r39 rd" class="r39 r">dsHandlers</span>;
                <b>lock</b> (<a href="#7bcaed378b172a37" class="i field">_associationSyncObject</a>)
                {
                    <span class="r39 r">dsHandlers</span> = <b>new</b> <span class="i">List</span>&lt;<a href="#ef96db27814e82f4" class="t t">ClientPowerShellDataStructureHandler</a>&gt;(<a href="#f74c5f6b1e3e9fe5" class="i field">_associatedPowerShellDSHandlers</a>.<span class="i">Values</span>);
                }
 
                <b>foreach</b> (<a href="#ef96db27814e82f4" class="t t">ClientPowerShellDataStructureHandler</a> <span id="r40 rd" class="r40 r">dsHandler</span> <b>in</b> <span class="r39 r">dsHandlers</span>)
                {
                    <span class="r40 r">dsHandler</span>.<a href="#4db2ec6f0f51c664" class="i method">CloseConnectionAsync</a>(<a href="#1179654ce1c24b6d" class="i field">_closingReason</a>);
                }
 
                <a href="#dffa826144552f7a" class="i">SessionClosing</a>.<span class="i">SafeInvoke</span>(<a href="#7269f3ebd9b81159" class="k">this</a>, <b>new</b> <span class="t">RemoteDataEventArgs</span>&lt;<span class="i">Exception</span>&gt;(<span class="r38 r">reason</span>));
            }
            <b>else</b> <b>if</b> (<span class="r36 r">e</span>.<a href="../common/misc.cs.html#973536ebdade9102" class="i property">SessionStateInfo</a>.<a href="../common/misc.cs.html#fe0ec9ba677d85ef" class="i property">State</a> == <a href="../common/misc.cs.html#278607b7d2274446" class="t t">RemoteSessionState</a>.<a href="../common/misc.cs.html#7436cd78255d3040" class="i field">Closed</a>)
            {
                <span class="c">// use the first reason which caused the error</span>
                <span class="i">Exception</span> <span id="r41 rd" class="r41 r">reason</span> = <a href="#1179654ce1c24b6d" class="i field">_closingReason</a>;
                <b>if</b> (<span class="r41 r">reason</span> == <b>null</b>)
                {
                    <span class="r41 r">reason</span> = <span class="r36 r">e</span>.<a href="../common/misc.cs.html#973536ebdade9102" class="i property">SessionStateInfo</a>.<a href="../common/misc.cs.html#91101c327c02f6db" class="i property">Reason</a>;
                    <a href="#1179654ce1c24b6d" class="i field">_closingReason</a> = <span class="r41 r">reason</span>;
                }
 
                <span class="c">// if there is a reason associated, then most likely the</span>
                <span class="c">// runspace pool has broken, so notify accordingly</span>
                <b>if</b> (<span class="r41 r">reason</span> != <b>null</b>)
                {
                    <a href="#cb1987ee5fd37e17" class="i method">NotifyAssociatedPowerShells</a>(<b>new</b> <a href="../common/RunspacePoolStateInfo.cs.html#c7dae263df1aded0" class="t constructor">RunspacePoolStateInfo</a>(<a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#48a121178c7c288f" class="i field">Broken</a>, <span class="r41 r">reason</span>));
                }
                <b>else</b>
                {
                    <span class="c">// notify the associated powershells that this</span>
                    <span class="c">// runspace pool has closed</span>
                    <a href="#cb1987ee5fd37e17" class="i method">NotifyAssociatedPowerShells</a>(<b>new</b> <a href="../common/RunspacePoolStateInfo.cs.html#c7dae263df1aded0" class="t constructor">RunspacePoolStateInfo</a>(<a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#494904731e18b593" class="i field">Closed</a>, <span class="r41 r">reason</span>));
                }
 
                <a href="#23d0434265cec36a" class="i">SessionClosed</a>.<span class="i">SafeInvoke</span>(<a href="#7269f3ebd9b81159" class="k">this</a>, <b>new</b> <span class="t">RemoteDataEventArgs</span>&lt;<span class="i">Exception</span>&gt;(<span class="r41 r">reason</span>));
            }
            <b>else</b> <b>if</b> (<span class="r36 r">e</span>.<a href="../common/misc.cs.html#973536ebdade9102" class="i property">SessionStateInfo</a>.<a href="../common/misc.cs.html#fe0ec9ba677d85ef" class="i property">State</a> == <a href="../common/misc.cs.html#278607b7d2274446" class="t t">RemoteSessionState</a>.<a href="../common/misc.cs.html#424ec7ae9be7e81a" class="i field">Connected</a>)
            {
                <span class="c">// write a transfer event here</span>
                <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<a href="../../../utils/tracing/PSEtwLog.cs.html#c0ba03442a1969ee" class="i method">ReplaceActivityIdForCurrentThread</a>(<a href="#c7680ad27c52e9a2" class="i field">_clientRunspacePoolId</a>, <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#8583d6074d3ae378" class="i field">OperationalTransferEventRunspacePool</a>,
                    <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#eae064d680934e47" class="i field">AnalyticTransferEventRunspacePool</a>, <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#193d289333be8934" class="i field">Runspace</a>, <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#752e56066810e4f0" class="i field">CreateRunspace</a>);
            }
            <b>else</b> <b>if</b> (<span class="r36 r">e</span>.<a href="../common/misc.cs.html#973536ebdade9102" class="i property">SessionStateInfo</a>.<a href="../common/misc.cs.html#fe0ec9ba677d85ef" class="i property">State</a> == <a href="../common/misc.cs.html#278607b7d2274446" class="t t">RemoteSessionState</a>.<a href="../common/misc.cs.html#e7e3451dd912571c" class="i field">Disconnected</a>)
            {
                <a href="#cb1987ee5fd37e17" class="i method">NotifyAssociatedPowerShells</a>(<b>new</b> <a href="../common/RunspacePoolStateInfo.cs.html#c7dae263df1aded0" class="t constructor">RunspacePoolStateInfo</a>(
                    <a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#fb0d368190577383" class="i field">Disconnected</a>,
                    <span class="r36 r">e</span>.<a href="../common/misc.cs.html#973536ebdade9102" class="i property">SessionStateInfo</a>.<a href="../common/misc.cs.html#91101c327c02f6db" class="i property">Reason</a>));
                <a href="#397e074e3b0ebf78" class="i">SessionDisconnected</a>.<span class="i">SafeInvoke</span>(<a href="#7269f3ebd9b81159" class="k">this</a>, <b>new</b> <span class="t">RemoteDataEventArgs</span>&lt;<span class="i">Exception</span>&gt;(<span class="r36 r">e</span>.<a href="../common/misc.cs.html#973536ebdade9102" class="i property">SessionStateInfo</a>.<a href="../common/misc.cs.html#91101c327c02f6db" class="i property">Reason</a>));
            }
            <b>else</b> <b>if</b> (<a href="#f67c06a03f6c0cc5" class="i field">_reconnecting</a> &amp;&amp; <span class="r36 r">e</span>.<a href="../common/misc.cs.html#973536ebdade9102" class="i property">SessionStateInfo</a>.<a href="../common/misc.cs.html#fe0ec9ba677d85ef" class="i property">State</a> == <a href="../common/misc.cs.html#278607b7d2274446" class="t t">RemoteSessionState</a>.<a href="../common/misc.cs.html#8d4705ab67b3b753" class="i field">Established</a>)
            {
                <a href="#91398fc57675dda3" class="i">SessionReconnected</a>.<span class="i">SafeInvoke</span>(<a href="#7269f3ebd9b81159" class="k">this</a>, <b>new</b> <a href="../common/misc.cs.html#79fd22f37cbd3e2d" class="t constructor">RemoteDataEventArgs</a>&lt;<span class="i">Exception</span>&gt;(<b>null</b>));
                <a href="#f67c06a03f6c0cc5" class="i field">_reconnecting</a> = <b>false</b>;
            }
            <b>else</b> <b>if</b> (<span class="r36 r">e</span>.<a href="../common/misc.cs.html#973536ebdade9102" class="i property">SessionStateInfo</a>.<a href="../common/misc.cs.html#fe0ec9ba677d85ef" class="i property">State</a> == <a href="../common/misc.cs.html#278607b7d2274446" class="t t">RemoteSessionState</a>.<a href="../common/misc.cs.html#e7684106e39f8202" class="i field">RCDisconnecting</a>)
            {
                <a href="#2cbf947810fb0658" class="i">SessionRCDisconnecting</a>.<span class="i">SafeInvoke</span>(<a href="#7269f3ebd9b81159" class="k">this</a>, <b>new</b> <a href="../common/misc.cs.html#79fd22f37cbd3e2d" class="t constructor">RemoteDataEventArgs</a>&lt;<span class="i">Exception</span>&gt;(<b>null</b>));
            }
            <b>else</b>
            {
                <b>if</b> (<span class="r36 r">e</span>.<a href="../common/misc.cs.html#973536ebdade9102" class="i property">SessionStateInfo</a>.<a href="../common/misc.cs.html#91101c327c02f6db" class="i property">Reason</a> != <b>null</b>)
                {
                    <a href="#1179654ce1c24b6d" class="i field">_closingReason</a> = <span class="r36 r">e</span>.<a href="../common/misc.cs.html#973536ebdade9102" class="i property">SessionStateInfo</a>.<a href="../common/misc.cs.html#91101c327c02f6db" class="i property">Reason</a>;
                }
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Session is reporting that URI is getting redirected.</span>
        <span class="c">///</span><span class="c"> Report this information to the user by writing a warning message.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r42 r">newURI</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>private void</b> <a id="73eb340dd2c11064" href="../../../R/73eb340dd2c11064.html" target="n" data-glyph="76,1" class="i method">HandleURIDirectionReported</a>(<span class="i">Uri</span> <span id="r42 rd" class="r42 r">newURI</span>)
        {
            <a href="#a349be0ddd33b0cd" class="i">URIRedirectionReported</a>.<span class="i">SafeInvoke</span>(<a href="#7269f3ebd9b81159" class="k">this</a>, <b>new</b> <span class="t">RemoteDataEventArgs</span>&lt;<span class="i">Uri</span>&gt;(<span class="r42 r">newURI</span>));
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Notifies associated powershell&#39;s of the runspace pool state change.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r43 r">stateInfo</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">state information that need to</span>
        <span class="c">///</span><span class="c"> be notified</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>private void</b> <a id="cb1987ee5fd37e17" href="../../../R/cb1987ee5fd37e17.html" target="n" data-glyph="76,1" class="i method">NotifyAssociatedPowerShells</a>(<a href="../common/RunspacePoolStateInfo.cs.html#8b9143609d7a0363" class="t t">RunspacePoolStateInfo</a> <span id="r43 rd" class="r43 r">stateInfo</span>)
        {
            <span class="i">List</span>&lt;<a href="#ef96db27814e82f4" class="t t">ClientPowerShellDataStructureHandler</a>&gt; <span id="r44 rd" class="r44 r">dsHandlers</span>;
 
            <b>if</b> (<span class="r43 r">stateInfo</span>.<a href="../common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a> == <a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#fb0d368190577383" class="i field">Disconnected</a>)
            {
                <b>lock</b> (<a href="#7bcaed378b172a37" class="i field">_associationSyncObject</a>)
                {
                    <span class="r44 r">dsHandlers</span> = <b>new</b> <span class="i">List</span>&lt;<a href="#ef96db27814e82f4" class="t t">ClientPowerShellDataStructureHandler</a>&gt;(<a href="#f74c5f6b1e3e9fe5" class="i field">_associatedPowerShellDSHandlers</a>.<span class="i">Values</span>);
                }
 
                <b>foreach</b> (<a href="#ef96db27814e82f4" class="t t">ClientPowerShellDataStructureHandler</a> <span id="r45 rd" class="r45 r">dsHandler</span> <b>in</b> <span class="r44 r">dsHandlers</span>)
                {
                    <span class="r45 r">dsHandler</span>.<a href="#bbd2a6f6af97fd90" class="i method">ProcessDisconnect</a>(<span class="r43 r">stateInfo</span>);
                }
 
                <b>return</b>;
            }
 
            <span class="c">// if the runspace pool is broken or closed then set all</span>
            <span class="c">// associated powershells to stopped</span>
            <b>if</b> (<span class="r43 r">stateInfo</span>.<a href="../common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a> == <a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#48a121178c7c288f" class="i field">Broken</a> || <span class="r43 r">stateInfo</span>.<a href="../common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a> == <a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#494904731e18b593" class="i field">Closed</a>)
            {
                <b>lock</b> (<a href="#7bcaed378b172a37" class="i field">_associationSyncObject</a>)
                {
                    <span class="r44 r">dsHandlers</span> = <b>new</b> <span class="i">List</span>&lt;<a href="#ef96db27814e82f4" class="t t">ClientPowerShellDataStructureHandler</a>&gt;(<a href="#f74c5f6b1e3e9fe5" class="i field">_associatedPowerShellDSHandlers</a>.<span class="i">Values</span>);
                    <a href="#f74c5f6b1e3e9fe5" class="i field">_associatedPowerShellDSHandlers</a>.<span class="i">Clear</span>();
                }
 
                <b>if</b> (<span class="r43 r">stateInfo</span>.<a href="../common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a> == <a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#48a121178c7c288f" class="i field">Broken</a>)
                {
                    <span class="c">// set the state to failed, outside the lock</span>
                    <b>foreach</b> (<a href="#ef96db27814e82f4" class="t t">ClientPowerShellDataStructureHandler</a> <span id="r46 rd" class="r46 r">dsHandler</span> <b>in</b> <span class="r44 r">dsHandlers</span>)
                    {
                        <span class="r46 r">dsHandler</span>.<a href="#6f85276a26403b96" class="i method">SetStateToFailed</a>(<span class="r43 r">stateInfo</span>.<a href="../common/RunspacePoolStateInfo.cs.html#dcad0aee1f0be83d" class="i property">Reason</a>);
                    }
                }
                <b>else</b> <b>if</b> (<span class="r43 r">stateInfo</span>.<a href="../common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a> == <a href="../../hostifaces/RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="../../hostifaces/RunspacePool.cs.html#494904731e18b593" class="i field">Closed</a>)
                {
                    <b>foreach</b> (<a href="#ef96db27814e82f4" class="t t">ClientPowerShellDataStructureHandler</a> <span id="r47 rd" class="r47 r">dsHandler</span> <b>in</b> <span class="r44 r">dsHandlers</span>)
                    {
                        <span class="r47 r">dsHandler</span>.<a href="#82a912eb6a5841d4" class="i method">SetStateToStopped</a>(<span class="r43 r">stateInfo</span>.<a href="../common/RunspacePoolStateInfo.cs.html#dcad0aee1f0be83d" class="i property">Reason</a>);
                    }
                }
 
                <b>return</b>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the ClientPowerShellDataStructureHandler instance for the specified id.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r48 r">clientPowerShellId</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Id of the client remote powershell.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">ClientPowerShellDataStructureHandler object.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>private</b> <a href="#ef96db27814e82f4" class="t t">ClientPowerShellDataStructureHandler</a> <a id="c0b572db52bd0f64" href="../../../R/c0b572db52bd0f64.html" target="n" data-glyph="76,1" class="i method">GetAssociatedPowerShellDataStructureHandler</a>
            (<span class="i">Guid</span> <span id="r48 rd" class="r48 r">clientPowerShellId</span>)
        {
            <a href="#ef96db27814e82f4" class="t t">ClientPowerShellDataStructureHandler</a> <span id="r49 rd" class="r49 r">dsHandler</span> = <b>null</b>;
 
            <b>lock</b> (<a href="#7bcaed378b172a37" class="i field">_associationSyncObject</a>)
            {
                <b>bool</b> <span id="r50 rd" class="r50 r">success</span> = <a href="#f74c5f6b1e3e9fe5" class="i field">_associatedPowerShellDSHandlers</a>.<span class="i">TryGetValue</span>(<span class="r48 r">clientPowerShellId</span>, <b>out</b> <span class="r49 r">dsHandler</span>);
 
                <b>if</b> (!<span class="r50 r">success</span>)
                {
                    <span class="r49 r">dsHandler</span> = <b>null</b>;
                }
            }
 
            <b>return</b> <span class="r49 r">dsHandler</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Remove the association of the powershell from the runspace pool.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r51 r">sender</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Sender of this event.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r52 r">e</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Unused.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>private void</b> <a id="e6f9035ff9c75f8c" href="../../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">HandleRemoveAssociation</a>(<b>object</b> <span id="r51 rd" class="r51 r">sender</span>, <span class="i">EventArgs</span> <span id="r52 rd" class="r52 r">e</span>)
        {
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r51 r">sender</span> <b>is</b> <a href="#ef96db27814e82f4" class="t t">ClientPowerShellDataStructureHandler</a>, <span class="s">@&quot;sender of the event
                must be ClientPowerShellDataStructureHandler&quot;</span>);
 
            <a href="#ef96db27814e82f4" class="t t">ClientPowerShellDataStructureHandler</a> <span id="r53 rd" class="r53 r">dsHandler</span> =
                <span class="r51 r">sender</span> <b>as</b> <a href="#ef96db27814e82f4" class="t t">ClientPowerShellDataStructureHandler</a>;
 
            <b>lock</b> (<a href="#7bcaed378b172a37" class="i field">_associationSyncObject</a>)
            {
                <a href="#f74c5f6b1e3e9fe5" class="i field">_associatedPowerShellDSHandlers</a>.<span class="i">Remove</span>(<span class="r53 r">dsHandler</span>.<a href="#1ca8c287c75fe3ec" class="i property">PowerShellId</a>);
            }
 
            <a href="#9fffaae3a3ec9f83" class="i field">_transportManager</a>.<a href="../fanin/BaseTransportManager.cs.html#f35971d48e2cbd33" class="i method">RemoveCommandTransportManager</a>(<span class="r53 r">dsHandler</span>.<a href="#1ca8c287c75fe3ec" class="i property">PowerShellId</a>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Calls each running command Transport manager PrepareForDisconnect method.</span>
        <span class="c">///</span><span class="c"> Each transport manager object will raise an event when the command/transport</span>
        <span class="c">///</span><span class="c"> is ready to be disconnected.  Disconnect will begin when all is ready.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private void</b> <a id="f5b45457df0225c8" href="../../../R/f5b45457df0225c8.html" target="n" data-glyph="76,1" class="i method">PrepareForAndStartDisconnect</a>()
        {
            <b>bool</b> <span id="r54 rd" class="r54 r">startDisconnectNow</span>;
 
            <b>lock</b> (<a href="#7bcaed378b172a37" class="i field">_associationSyncObject</a>)
            {
                <b>if</b> (<a href="#f74c5f6b1e3e9fe5" class="i field">_associatedPowerShellDSHandlers</a>.<span class="i">Count</span> == 0)
                {
                    <span class="c">// There are no running commands associated with this runspace pool.</span>
                    <span class="r54 r">startDisconnectNow</span> = <b>true</b>;
                    <a href="#2df09929181b6ae1" class="i field">_preparingForDisconnectList</a> = <b>null</b>;
                }
                <b>else</b>
                {
                    <span class="c">// Delay starting the disconnect operation until all running commands are prepared.</span>
                    <span class="r54 r">startDisconnectNow</span> = <b>false</b>;
 
                    <span class="c">// Create and fill list of active transportmanager objects to be disconnected.</span>
                    <span class="c">// Add ready-for-disconnect callback handler to DSHandler transportmanager objects.</span>
                    <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<a href="#2df09929181b6ae1" class="i field">_preparingForDisconnectList</a> == <b>null</b>, <span class="s">&quot;Cannot prepare for disconnect while disconnect is pending.&quot;</span>);
                    <a href="#2df09929181b6ae1" class="i field">_preparingForDisconnectList</a> = <b>new</b> <span class="i">List</span>&lt;<a href="../fanin/BaseTransportManager.cs.html#fa455a694094fdc2" class="t t">BaseClientCommandTransportManager</a>&gt;();
                    <b>foreach</b> (<a href="#ef96db27814e82f4" class="t t">ClientPowerShellDataStructureHandler</a> <span id="r55 rd" class="r55 r">dsHandler</span> <b>in</b> <a href="#f74c5f6b1e3e9fe5" class="i field">_associatedPowerShellDSHandlers</a>.<span class="i">Values</span>)
                    {
                        <a href="#2df09929181b6ae1" class="i field">_preparingForDisconnectList</a>.<span class="i">Add</span>(<span class="r55 r">dsHandler</span>.<a href="#d4654360189d8f15" class="i property">TransportManager</a>);
                        <span class="r55 r">dsHandler</span>.<a href="#d4654360189d8f15" class="i property">TransportManager</a>.<a href="../fanin/BaseTransportManager.cs.html#3deb153387243216" class="i">ReadyForDisconnect</a> += <span class="i">HandleReadyForDisconnect</span>;
                    }
                }
            }
 
            <b>if</b> (<span class="r54 r">startDisconnectNow</span>)
            {
                <span class="c">// Ok to start on this thread.</span>
                <a href="#d6ca3546d07d31cb" class="i method">StartDisconnectAsync</a>(<a href="#e60f2ab4626e155d" class="i property">RemoteSession</a>);
            }
            <b>else</b>
            {
                <span class="c">// Start preparation for disconnect.  The HandleReadyForDisconnect callback will be</span>
                <span class="c">// called when a transportManager is ready for disconnect.</span>
                <span class="i">List</span>&lt;<a href="#ef96db27814e82f4" class="t t">ClientPowerShellDataStructureHandler</a>&gt; <span id="r56 rd" class="r56 r">dsHandlers</span>;
                <b>lock</b> (<a href="#7bcaed378b172a37" class="i field">_associationSyncObject</a>)
                {
                    <span class="r56 r">dsHandlers</span> = <b>new</b> <span class="i">List</span>&lt;<a href="#ef96db27814e82f4" class="t t">ClientPowerShellDataStructureHandler</a>&gt;(<a href="#f74c5f6b1e3e9fe5" class="i field">_associatedPowerShellDSHandlers</a>.<span class="i">Values</span>);
                }
 
                <b>foreach</b> (<a href="#ef96db27814e82f4" class="t t">ClientPowerShellDataStructureHandler</a> <span id="r57 rd" class="r57 r">dsHandler</span> <b>in</b> <span class="r56 r">dsHandlers</span>)
                {
                    <span class="r57 r">dsHandler</span>.<a href="#d4654360189d8f15" class="i property">TransportManager</a>.<a href="../fanin/BaseTransportManager.cs.html#bca7f9a7141c0084" class="i method">PrepareForDisconnect</a>();
                }
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Allows each running command to resume processing command input for when</span>
        <span class="c">///</span><span class="c"> the runspacepool and running commands are connected.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private void</b> <a id="b36535d72946b995" href="../../../R/b36535d72946b995.html" target="n" data-glyph="76,1" class="i method">PrepareForConnect</a>()
        {
            <span class="i">List</span>&lt;<a href="#ef96db27814e82f4" class="t t">ClientPowerShellDataStructureHandler</a>&gt; <span id="r58 rd" class="r58 r">dsHandlers</span>;
            <b>lock</b> (<a href="#7bcaed378b172a37" class="i field">_associationSyncObject</a>)
            {
                <span class="r58 r">dsHandlers</span> = <b>new</b> <span class="i">List</span>&lt;<a href="#ef96db27814e82f4" class="t t">ClientPowerShellDataStructureHandler</a>&gt;(<a href="#f74c5f6b1e3e9fe5" class="i field">_associatedPowerShellDSHandlers</a>.<span class="i">Values</span>);
            }
 
            <b>foreach</b> (<a href="#ef96db27814e82f4" class="t t">ClientPowerShellDataStructureHandler</a> <span id="r59 rd" class="r59 r">dsHandler</span> <b>in</b> <span class="r58 r">dsHandlers</span>)
            {
                <span class="r59 r">dsHandler</span>.<a href="#d4654360189d8f15" class="i property">TransportManager</a>.<a href="../fanin/BaseTransportManager.cs.html#3deb153387243216" class="i">ReadyForDisconnect</a> -= <span class="i">HandleReadyForDisconnect</span>;
                <span class="r59 r">dsHandler</span>.<a href="#d4654360189d8f15" class="i property">TransportManager</a>.<a href="../fanin/BaseTransportManager.cs.html#6b9e13ba52d26e1d" class="i method">PrepareForConnect</a>();
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Handler of the transport ReadyForDisconnect event.  When all command</span>
        <span class="c">///</span><span class="c"> transports are ready for disconnect we can start the disconnect process.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r60 r">sender</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r61 r">args</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>private void</b> <a id="61173f1881d80d89" href="../../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">HandleReadyForDisconnect</a>(<b>object</b> <span id="r60 rd" class="r60 r">sender</span>, <span class="i">EventArgs</span> <span id="r61 rd" class="r61 r">args</span>)
        {
            <b>if</b> (<span class="r60 r">sender</span> == <b>null</b>)
            {
                <b>return</b>;
            }
 
            <a href="../fanin/BaseTransportManager.cs.html#fa455a694094fdc2" class="t t">BaseClientCommandTransportManager</a> <span id="r62 rd" class="r62 r">bcmdTM</span> = (<a href="../fanin/BaseTransportManager.cs.html#fa455a694094fdc2" class="t t">BaseClientCommandTransportManager</a>)<span class="r60 r">sender</span>;
 
            <b>lock</b> (<a href="#7bcaed378b172a37" class="i field">_associationSyncObject</a>)
            {
                <span class="c">// Ignore extra event calls after disconnect is started.</span>
                <b>if</b> (<a href="#2df09929181b6ae1" class="i field">_preparingForDisconnectList</a> == <b>null</b>)
                {
                    <b>return</b>;
                }
 
                <b>if</b> (<a href="#2df09929181b6ae1" class="i field">_preparingForDisconnectList</a>.<span class="i">Contains</span>(<span class="r62 r">bcmdTM</span>))
                {
                    <a href="#2df09929181b6ae1" class="i field">_preparingForDisconnectList</a>.<span class="i">Remove</span>(<span class="r62 r">bcmdTM</span>);
                }
 
                <b>if</b> (<a href="#2df09929181b6ae1" class="i field">_preparingForDisconnectList</a>.<span class="i">Count</span> == 0)
                {
                    <a href="#2df09929181b6ae1" class="i field">_preparingForDisconnectList</a> = <b>null</b>;
 
                    <span class="c">// Start the asynchronous disconnect on a worker thread because we don&#39;t know</span>
                    <span class="c">// what thread this callback is made from.  If it was made from a transport</span>
                    <span class="c">// callback event then a deadlock may occur when DisconnectAsync is called on</span>
                    <span class="c">// that same thread.</span>
                    <span class="i">ThreadPool</span>.<span class="i">QueueUserWorkItem</span>(<b>new</b> <span class="i">WaitCallback</span>(<span class="i">StartDisconnectAsync</span>), <a href="#e60f2ab4626e155d" class="i property">RemoteSession</a>);
                }
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> WaitCallback method to start an asynchronous disconnect.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r63 r">remoteSession</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>private void</b> <a id="d6ca3546d07d31cb" href="../../../R/d6ca3546d07d31cb.html" target="n" data-glyph="76,1" class="i method">StartDisconnectAsync</a>(<b>object</b> <span id="r63 rd" class="r63 r">remoteSession</span>)
        {
            ((<a href="clientremotesession.cs.html#e2e97fb58c308155" class="t t">ClientRemoteSession</a>)<span class="r63 r">remoteSession</span>).<a href="clientremotesession.cs.html#76ea50cf25d38ce4" class="i method">DisconnectAsync</a>();
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Forwards robust connection notifications to associated PowerShell clients.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r64 r">sender</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r65 r">e</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>private void</b> <a id="5f2d7d8ce1d26b1c" href="../../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">HandleRobustConnectionNotification</a>(
            <b>object</b> <span id="r64 rd" class="r64 r">sender</span>,
            <a href="../fanin/BaseTransportManager.cs.html#598698ed70e51507" class="t t">ConnectionStatusEventArgs</a> <span id="r65 rd" class="r65 r">e</span>)
        {
            <span class="i">List</span>&lt;<a href="#ef96db27814e82f4" class="t t">ClientPowerShellDataStructureHandler</a>&gt; <span id="r66 rd" class="r66 r">dsHandlers</span>;
            <b>lock</b> (<a href="#7bcaed378b172a37" class="i field">_associationSyncObject</a>)
            {
                <span class="r66 r">dsHandlers</span> = <b>new</b> <span class="i">List</span>&lt;<a href="#ef96db27814e82f4" class="t t">ClientPowerShellDataStructureHandler</a>&gt;(<a href="#f74c5f6b1e3e9fe5" class="i field">_associatedPowerShellDSHandlers</a>.<span class="i">Values</span>);
            }
 
            <b>foreach</b> (<a href="#ef96db27814e82f4" class="t t">ClientPowerShellDataStructureHandler</a> <span id="r67 rd" class="r67 r">dsHandler</span> <b>in</b> <span class="r66 r">dsHandlers</span>)
            {
                <span class="r67 r">dsHandler</span>.<a href="#0178fc07655713bc" class="i method">ProcessRobustConnectionNotification</a>(<span class="r65 r">e</span>);
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Forwards the session create completion event.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r68 r">sender</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Transport sender.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r69 r">eventArgs</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">CreateCompleteEventArgs.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>private void</b> <a id="2bcf7515f2db48fb" href="../../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">HandleSessionCreateCompleted</a>(<b>object</b> <span id="r68 rd" class="r68 r">sender</span>, <a href="../fanin/BaseTransportManager.cs.html#7d43cc7a3ac54680" class="t t">CreateCompleteEventArgs</a> <span id="r69 rd" class="r69 r">eventArgs</span>)
        {
            <a href="#c0f2f1dcd50aeb85" class="i">SessionCreateCompleted</a>.<span class="i">SafeInvoke</span>&lt;<a href="../fanin/BaseTransportManager.cs.html#7d43cc7a3ac54680" class="t t">CreateCompleteEventArgs</a>&gt;(<a href="#7269f3ebd9b81159" class="k">this</a>, <span class="r69 r">eventArgs</span>);
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Private Methods
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Private Members
 
        <b>private readonly</b> <span class="i">Guid</span> <a id="c7680ad27c52e9a2" href="../../../R/c7680ad27c52e9a2.html" target="n" data-glyph="46,1" class="i field">_clientRunspacePoolId</a>;
        <b>private readonly object</b> <a id="eea2244df39359df" href="../../../R/eea2244df39359df.html" target="n" data-glyph="46,1" class="i field">_syncObject</a> = <b>new</b> <b>object</b>();
        <b>private bool</b> <a id="a4e2d21462f3ca39" href="../../../R/a4e2d21462f3ca39.html" target="n" data-glyph="46,1" class="i field">_createRunspaceCalled</a> = <b>false</b>;
        <b>private</b> <span class="i">Exception</span> <a id="1179654ce1c24b6d" href="../../../R/1179654ce1c24b6d.html" target="n" data-glyph="46,1" class="i field">_closingReason</a>;
        <b>private readonly int</b> <a id="ea09cda41db8e1b8" href="../../../R/ea09cda41db8e1b8.html" target="n" data-glyph="46,1" class="i field">_minRunspaces</a>;
        <b>private readonly int</b> <a id="f8df7167331f0b77" href="../../../R/f8df7167331f0b77.html" target="n" data-glyph="46,1" class="i field">_maxRunspaces</a>;
        <b>private readonly</b> <a href="../../hostifaces/MshHost.cs.html#7b79cd90e035740e" class="t t">PSHost</a> <a id="977015cff2484129" href="../../../R/977015cff2484129.html" target="n" data-glyph="46,1" class="i field">_host</a>;
        <b>private readonly</b> <a href="../../serialization.cs.html#04756020c00714fe" class="t t">PSPrimitiveDictionary</a> <a id="8eaf4f369f817435" href="../../../R/8eaf4f369f817435.html" target="n" data-glyph="46,1" class="i field">_applicationArguments</a>;
 
        <b>private readonly</b> <span class="i">Dictionary</span>&lt;<span class="i">Guid</span>, <a href="#ef96db27814e82f4" class="t t">ClientPowerShellDataStructureHandler</a>&gt; <a id="f74c5f6b1e3e9fe5" href="../../../R/f74c5f6b1e3e9fe5.html" target="n" data-glyph="46,1" class="i field">_associatedPowerShellDSHandlers</a>
            = <b>new</b> <span class="i">Dictionary</span>&lt;<span class="i">Guid</span>, <a href="#ef96db27814e82f4" class="t t">ClientPowerShellDataStructureHandler</a>&gt;();
 
        <span class="c">// data structure handlers of all ClientRemotePowerShell which are</span>
        <span class="c">// associated with this runspace pool</span>
        <b>private readonly object</b> <a id="7bcaed378b172a37" href="../../../R/7bcaed378b172a37.html" target="n" data-glyph="46,1" class="i field">_associationSyncObject</a> = <b>new</b> <b>object</b>();
        <span class="c">// object to synchronize operations to above</span>
        <b>private readonly</b> <a href="../fanin/BaseTransportManager.cs.html#19883ec4df424177" class="t t">BaseClientSessionTransportManager</a> <a id="9fffaae3a3ec9f83" href="../../../R/9fffaae3a3ec9f83.html" target="n" data-glyph="46,1" class="i field">_transportManager</a>;
        <span class="c">// session transport manager associated with this runspace</span>
 
        <b>private</b> <span class="i">List</span>&lt;<a href="../fanin/BaseTransportManager.cs.html#fa455a694094fdc2" class="t t">BaseClientCommandTransportManager</a>&gt; <a id="2df09929181b6ae1" href="../../../R/2df09929181b6ae1.html" target="n" data-glyph="46,1" class="i field">_preparingForDisconnectList</a>;
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Private Members
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Internal Properties
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The remote session associated with this runspace pool</span>
        <span class="c">///</span><span class="c"> data structure handler.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal</b> <a href="clientremotesession.cs.html#e2e97fb58c308155" class="t t">ClientRemoteSession</a> <a id="e60f2ab4626e155d" href="../../../R/e60f2ab4626e155d.html" target="n" data-glyph="104,1" class="i property">RemoteSession</a> { <b>get</b>; <b>private set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Transport manager used by this data structure handler.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal</b> <a href="../fanin/BaseTransportManager.cs.html#19883ec4df424177" class="t t">BaseClientSessionTransportManager</a> <a id="38c23f3a35d84598" href="../../../R/38c23f3a35d84598.html" target="n" data-glyph="104,1" class="i property">TransportManager</a>
        {
            <b>get</b>
            {
                <b>if</b> (<a href="#e60f2ab4626e155d" class="i property">RemoteSession</a> != <b>null</b>)
                {
                    <b>return</b> <a href="#e60f2ab4626e155d" class="i property">RemoteSession</a>.<a href="clientremotesession.cs.html#9ca39992bfec8bf8" class="i property">SessionDataStructureHandler</a>.<a href="remotingprotocol.cs.html#c480a490ddf94096" class="i property">TransportManager</a>;
                }
                <b>else</b>
                {
                    <b>return</b> <b>null</b>;
                }
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Returns robust connection maximum retry time in milliseconds, if supported</span>
        <span class="c">///</span><span class="c"> by underlying transport manager.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal int</b> <a id="871adff805ee69f0" href="../../../R/871adff805ee69f0.html" target="n" data-glyph="104,1" class="i property">MaxRetryConnectionTime</a>
        {
            <b>get</b>
            {
                <b>if</b> (<a href="#9fffaae3a3ec9f83" class="i field">_transportManager</a> != <b>null</b> &amp;&amp;
                    <a href="#9fffaae3a3ec9f83" class="i field">_transportManager</a> <b>is</b> <a href="../fanin/WSManTransportManager.cs.html#693b43214373ab1e" class="t t">WSManClientSessionTransportManager</a>)
                {
                    <b>return</b> ((<a href="../fanin/WSManTransportManager.cs.html#693b43214373ab1e" class="t t">WSManClientSessionTransportManager</a>)(<a href="#9fffaae3a3ec9f83" class="i field">_transportManager</a>)).<a href="../fanin/WSManTransportManager.cs.html#c49f6acabd3d369e" class="i property">MaxRetryConnectionTime</a>;
                }
 
                <b>return</b> 0;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Indicates whether the currently connected runspace endpoint supports</span>
        <span class="c">///</span><span class="c"> disconnect/connect semantics.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal bool</b> <a id="5462b7ca1ee4d850" href="../../../R/5462b7ca1ee4d850.html" target="n" data-glyph="104,1" class="i property">EndpointSupportsDisconnect</a>
        {
            <b>get</b>
            {
                <a href="../fanin/WSManTransportManager.cs.html#693b43214373ab1e" class="t t">WSManClientSessionTransportManager</a> <span id="r70 rd" class="r70 r">wsmanTransportManager</span> = <a href="#9fffaae3a3ec9f83" class="i field">_transportManager</a> <b>as</b> <a href="../fanin/WSManTransportManager.cs.html#693b43214373ab1e" class="t t">WSManClientSessionTransportManager</a>;
                <b>return</b> <span class="r70 r">wsmanTransportManager</span> != <b>null</b> &amp;&amp; <span class="r70 r">wsmanTransportManager</span>.<a href="../fanin/WSManTransportManager.cs.html#a8f057948cd2a14c" class="i property">SupportsDisconnect</a>;
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Internal Properties
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> IDisposable
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Public interface for dispose.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public void</b> <a id="5380ac714f19c9b7" href="../../../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">Dispose</a>()
        {
            <a href="#057f0ddfa0705e07" class="i method">Dispose</a>(<b>true</b>);
 
            <span class="i">GC</span>.<span class="i">SuppressFinalize</span>(<a href="#7269f3ebd9b81159" class="k">this</a>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Release all resources.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r71 r">disposing</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">If true, release all managed resources.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>public void</b> <a id="057f0ddfa0705e07" href="../../../R/057f0ddfa0705e07.html" target="n" data-glyph="72,1" class="i method">Dispose</a>(<b>bool</b> <span id="r71 rd" class="r71 r">disposing</span>)
        {
            <b>if</b> (<span class="r71 r">disposing</span>)
            {
                <b>if</b> (<a href="#e60f2ab4626e155d" class="i property">RemoteSession</a> != <b>null</b>)
                {
                    ((<a href="clientremotesession.cs.html#0a61ff623f7d8c5e" class="t t">ClientRemoteSessionImpl</a>)<a href="#e60f2ab4626e155d" class="i property">RemoteSession</a>).<a href="clientremotesession.cs.html#d476deb901209eff" class="i method">Dispose</a>();
                    <a href="#e60f2ab4626e155d" class="i property">RemoteSession</a> = <b>null</b>;
                }
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> IDisposable
    }
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Base class for ClientPowerShellDataStructureHandler to handle all</span>
    <span class="c">///</span><span class="c"> references.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>internal class</b> <a id="ef96db27814e82f4" href="../../../R/ef96db27814e82f4.html" target="n" data-glyph="2,0" class="t t">ClientPowerShellDataStructureHandler</a>
    {
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Data Structure Handler events
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This event is raised when the state of associated</span>
        <span class="c">///</span><span class="c"> powershell is terminal and the runspace pool has</span>
        <span class="c">///</span><span class="c"> to detach the association.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal event</b> <span class="i">EventHandler</span> <a id="1e1c7bde6009d12a" href="../../../R/1e1c7bde6009d12a.html" target="n" data-glyph="32,1" class="i">RemoveAssociation</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This event is raised when a state information object</span>
        <span class="c">///</span><span class="c"> is received from the server.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal event</b> <span class="i">EventHandler</span>&lt;<a href="../common/misc.cs.html#16d1e16a7ed9f8cc" class="t t">RemoteDataEventArgs</a>&lt;<a href="../../hostifaces/PowerShell.cs.html#42e325836d1ae967" class="t t">PSInvocationStateInfo</a>&gt;&gt; <a id="ef5c7524bb659078" href="../../../R/ef5c7524bb659078.html" target="n" data-glyph="32,1" class="i">InvocationStateInfoReceived</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This event is raised when an output object is received</span>
        <span class="c">///</span><span class="c"> from the server.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal event</b> <span class="i">EventHandler</span>&lt;<a href="../common/misc.cs.html#16d1e16a7ed9f8cc" class="t t">RemoteDataEventArgs</a>&lt;<b>object</b>&gt;&gt; <a id="97826a5b80db389d" href="../../../R/97826a5b80db389d.html" target="n" data-glyph="32,1" class="i">OutputReceived</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This event is raised when an error record is received</span>
        <span class="c">///</span><span class="c"> from the server.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal event</b> <span class="i">EventHandler</span>&lt;<a href="../common/misc.cs.html#16d1e16a7ed9f8cc" class="t t">RemoteDataEventArgs</a>&lt;<a href="../../ErrorPackage.cs.html#fe2b46733a081db9" class="t t">ErrorRecord</a>&gt;&gt; <a id="743c4d5ca42b19f7" href="../../../R/743c4d5ca42b19f7.html" target="n" data-glyph="32,1" class="i">ErrorReceived</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This event is raised when an informational message -</span>
        <span class="c">///</span><span class="c"> debug, verbose, warning, progress is received from</span>
        <span class="c">///</span><span class="c"> the server.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal event</b> <span class="i">EventHandler</span>&lt;<a href="../common/misc.cs.html#16d1e16a7ed9f8cc" class="t t">RemoteDataEventArgs</a>&lt;<a href="#e44e8a34c9f4b3f9" class="t t">InformationalMessage</a>&gt;&gt; <a id="53ad87a815f6bf93" href="../../../R/53ad87a815f6bf93.html" target="n" data-glyph="32,1" class="i">InformationalMessageReceived</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This event is raised when a host call is targeted to the</span>
        <span class="c">///</span><span class="c"> powershell.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal event</b> <span class="i">EventHandler</span>&lt;<a href="../common/misc.cs.html#16d1e16a7ed9f8cc" class="t t">RemoteDataEventArgs</a>&lt;<a href="../common/WireDataFormat/RemoteHost.cs.html#8bf334b011b63f92" class="t t">RemoteHostCall</a>&gt;&gt; <a id="d69edffc081d58a7" href="../../../R/d69edffc081d58a7.html" target="n" data-glyph="32,1" class="i">HostCallReceived</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This event is raised when a runspace pool data structure handler notifies an</span>
        <span class="c">///</span><span class="c"> associated powershell data structure handler that its closed.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal event</b> <span class="i">EventHandler</span>&lt;<a href="../common/misc.cs.html#16d1e16a7ed9f8cc" class="t t">RemoteDataEventArgs</a>&lt;<span class="i">Exception</span>&gt;&gt; <a id="abc36726071eb735" href="../../../R/abc36726071eb735.html" target="n" data-glyph="32,1" class="i">ClosedNotificationFromRunspacePool</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Event that is raised when a remote connection is successfully closed. The event is raised</span>
        <span class="c">///</span><span class="c"> from a WSMan transport thread. Since this thread can hold on to a HTTP</span>
        <span class="c">///</span><span class="c"> connection, the event handler should complete processing as fast as possible.</span>
        <span class="c">///</span><span class="c"> Importantly the event handler should not generate any call that results in a</span>
        <span class="c">///</span><span class="c"> user request like host.ReadLine().</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> Errors (occurred during connection attempt) are reported through WSManTransportErrorOccured</span>
        <span class="c">///</span><span class="c"> event.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The eventhandler should make sure not to throw any exceptions.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>internal event</b> <span class="i">EventHandler</span>&lt;<span class="i">EventArgs</span>&gt; <a id="923f3e397ef11ba8" href="../../../R/923f3e397ef11ba8.html" target="n" data-glyph="32,1" class="i">CloseCompleted</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This event is raised when a runspace pool data structure handler notifies an</span>
        <span class="c">///</span><span class="c"> associated powershell data structure handler that its broken.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal event</b> <span class="i">EventHandler</span>&lt;<a href="../common/misc.cs.html#16d1e16a7ed9f8cc" class="t t">RemoteDataEventArgs</a>&lt;<span class="i">Exception</span>&gt;&gt; <a id="478180bef6c04e8a" href="../../../R/478180bef6c04e8a.html" target="n" data-glyph="32,1" class="i">BrokenNotificationFromRunspacePool</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This event is raised when reconnect async operation on the associated powershell/pipeline instance is completed.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal event</b> <span class="i">EventHandler</span>&lt;<a href="../common/misc.cs.html#16d1e16a7ed9f8cc" class="t t">RemoteDataEventArgs</a>&lt;<span class="i">Exception</span>&gt;&gt; <a id="f33f2d79dc5a0e4a" href="../../../R/f33f2d79dc5a0e4a.html" target="n" data-glyph="32,1" class="i">ReconnectCompleted</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This event is raised when connect async operation on the associated powershell/pipeline instance is completed.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal event</b> <span class="i">EventHandler</span>&lt;<a href="../common/misc.cs.html#16d1e16a7ed9f8cc" class="t t">RemoteDataEventArgs</a>&lt;<span class="i">Exception</span>&gt;&gt; <a id="102c8d30d1adaadd" href="../../../R/102c8d30d1adaadd.html" target="n" data-glyph="32,1" class="i">ConnectCompleted</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This event is raised when a Robust Connection layer notification is available.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal event</b> <span class="i">EventHandler</span>&lt;<a href="../fanin/BaseTransportManager.cs.html#598698ed70e51507" class="t t">ConnectionStatusEventArgs</a>&gt; <a id="a1ee4a583ed95c45" href="../../../R/a1ee4a583ed95c45.html" target="n" data-glyph="32,1" class="i">RobustConnectionNotification</a>;
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Data Structure Handler events
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Data Structure Handler Methods
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Start the command operation.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="d723a299036cbb7a" href="../../../R/d723a299036cbb7a.html" target="n" data-glyph="74,1" class="i method">Start</a>(<a href="clientremotesessionprotocolstatemachine.cs.html#039f4a3a46a31204" class="t t">ClientRemoteSessionDSHandlerStateMachine</a> <span id="r72 rd" class="r72 r">stateMachine</span>, <b>bool</b> <span id="r73 rd" class="r73 r">inDisconnectMode</span>)
        {
            <span class="c">// Add all callbacks to transport manager.</span>
            <a href="#3d52b9ea65f824ec" class="i method">SetupTransportManager</a>(<span class="r73 r">inDisconnectMode</span>);
            <a href="#d4654360189d8f15" class="i property">TransportManager</a>.<a href="../fanin/BaseTransportManager.cs.html#647d3fc66fbadafe" class="i method">CreateAsync</a>();
        }
 
        <b>private void</b> <a id="f871ae71751da37d" href="../../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">HandleDelayStreamRequestProcessed</a>(<b>object</b> <span id="r74 rd" class="r74 r">sender</span>, <span class="i">EventArgs</span> <span id="r75 rd" class="r75 r">e</span>)
        {
            <span class="c">// client&#39;s request to start pipeline in disconnected mode has been successfully processed</span>
            <a href="#bbd2a6f6af97fd90" class="i method">ProcessDisconnect</a>(<b>null</b>);
        }
 
        <b>internal void</b> <a id="e4aeaa8c155b38eb" href="../../../R/../../0000000000.html" target="n" data-glyph="74,1" class="i method">HandleReconnectCompleted</a>(<b>object</b> <span id="r76 rd" class="r76 r">sender</span>, <span class="i">EventArgs</span> <span id="r77 rd" class="r77 r">args</span>)
        {
            <b>int</b> <span id="r78 rd" class="r78 r">currentState</span> = <span class="i">Interlocked</span>.<span class="i">CompareExchange</span>(<b>ref</b> <a href="#fbce8528c61888cb" class="i field">_connectionState</a>, (<b>int</b>)<a href="#bb2a74c3f73948d4" class="t t">connectionStates</a>.<a href="#5c0f9d5cb7a951f7" class="i field">Connected</a>, (<b>int</b>)<a href="#bb2a74c3f73948d4" class="t t">connectionStates</a>.<a href="#c14e5d42be0d15bf" class="i field">Reconnecting</a>);
 
            <a href="#f33f2d79dc5a0e4a" class="i">ReconnectCompleted</a>.<span class="i">SafeInvoke</span>(<a href="#ef96db27814e82f4" class="k">this</a>, <b>new</b> <a href="../common/misc.cs.html#79fd22f37cbd3e2d" class="t constructor">RemoteDataEventArgs</a>&lt;<span class="i">Exception</span>&gt;(<b>null</b>));
            <b>return</b>;
        }
 
        <b>internal void</b> <a id="2ecd5a253597dd53" href="../../../R/../../0000000000.html" target="n" data-glyph="74,1" class="i method">HandleConnectCompleted</a>(<b>object</b> <span id="r79 rd" class="r79 r">sender</span>, <span class="i">EventArgs</span> <span id="r80 rd" class="r80 r">args</span>)
        {
            <b>int</b> <span id="r81 rd" class="r81 r">currentState</span> = <span class="i">Interlocked</span>.<span class="i">CompareExchange</span>(<b>ref</b> <a href="#fbce8528c61888cb" class="i field">_connectionState</a>, (<b>int</b>)<a href="#bb2a74c3f73948d4" class="t t">connectionStates</a>.<a href="#5c0f9d5cb7a951f7" class="i field">Connected</a>, (<b>int</b>)<a href="#bb2a74c3f73948d4" class="t t">connectionStates</a>.<a href="#f5b68011b7e3277f" class="i field">Connecting</a>);
 
            <a href="#102c8d30d1adaadd" class="i">ConnectCompleted</a>.<span class="i">SafeInvoke</span>(<a href="#ef96db27814e82f4" class="k">this</a>, <b>new</b> <a href="../common/misc.cs.html#79fd22f37cbd3e2d" class="t constructor">RemoteDataEventArgs</a>&lt;<span class="i">Exception</span>&gt;(<b>null</b>));
            <b>return</b>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Handler which handles transport errors.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r82 r">sender</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r83 r">e</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="86213084ee858074" href="../../../R/../../0000000000.html" target="n" data-glyph="74,1" class="i method">HandleTransportError</a>(<b>object</b> <span id="r82 rd" class="r82 r">sender</span>, <a href="../fanin/BaseTransportManager.cs.html#7e70b34f9332dfcd" class="t t">TransportErrorOccuredEventArgs</a> <span id="r83 rd" class="r83 r">e</span>)
        {
            <span class="c">// notify associated powershell about the error and close transport manager</span>
            <a href="../../hostifaces/PowerShell.cs.html#42e325836d1ae967" class="t t">PSInvocationStateInfo</a> <span id="r84 rd" class="r84 r">stateInfo</span> = <b>new</b> <span class="t">PSInvocationStateInfo</span>(<a href="../../hostifaces/PowerShell.cs.html#24cc37ccdc118b7a" class="t t">PSInvocationState</a>.<a href="../../hostifaces/PowerShell.cs.html#35065a8449cad351" class="i field">Failed</a>, <span class="r83 r">e</span>.<a href="../fanin/BaseTransportManager.cs.html#f82124202b7ff8f0" class="i property">Exception</a>);
            <a href="#ef5c7524bb659078" class="i">InvocationStateInfoReceived</a>.<span class="i">SafeInvoke</span>(<a href="#ef96db27814e82f4" class="k">this</a>, <b>new</b> <a href="../common/misc.cs.html#79fd22f37cbd3e2d" class="t constructor">RemoteDataEventArgs</a>&lt;<a href="../../hostifaces/PowerShell.cs.html#42e325836d1ae967" class="t t">PSInvocationStateInfo</a>&gt;(<span class="r84 r">stateInfo</span>));
 
            <span class="c">// The handler to InvocationStateInfoReceived would have already</span>
            <span class="c">// closed the connection. No need to do it here again</span>
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Send a stop powershell message to the server.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="2142258b25ca28cd" href="../../../R/2142258b25ca28cd.html" target="n" data-glyph="74,1" class="i method">SendStopPowerShellMessage</a>()
        {
            <a href="#d4654360189d8f15" class="i property">TransportManager</a>.<a href="../fanin/BaseTransportManager.cs.html#30975a92e0bc8f5d" class="i property">CryptoHelper</a>.<a href="../../../utils/CryptoUtils.cs.html#7796a9d103b11aea" class="i method">CompleteKeyExchange</a>();
            <a href="#d4654360189d8f15" class="i property">TransportManager</a>.<a href="../fanin/BaseTransportManager.cs.html#474a5a730ecaf63e" class="i method">SendStopSignal</a>();
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Event that gets raised when stop signal is completed.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r85 r">sender</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r86 r">e</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>private void</b> <a id="0e402ca5aebd7bff" href="../../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">OnSignalCompleted</a>(<b>object</b> <span id="r85 rd" class="r85 r">sender</span>, <span class="i">EventArgs</span> <span id="r86 rd" class="r86 r">e</span>)
        {
            <span class="c">// Raise stopped event locally...By the time this event</span>
            <span class="c">// is raised, the remote server would have sent state changed info.</span>
            <span class="c">// A bad server may not send appropriate sate info, in which case we</span>
            <span class="c">// fail safely</span>
            <a href="../common/remotingexceptions.cs.html#553740d8dd522b58" class="t t">PSRemotingDataStructureException</a> <span id="r87 rd" class="r87 r">exception</span> = <b>new</b> <span class="t">PSRemotingDataStructureException</span>(
                <span class="i">RemotingErrorIdStrings</span>.<span class="i">PipelineStopped</span>);
            <a href="#ef5c7524bb659078" class="i">InvocationStateInfoReceived</a>.<span class="i">SafeInvoke</span>(<a href="#ef96db27814e82f4" class="k">this</a>,
                <b>new</b> <a href="../common/misc.cs.html#79fd22f37cbd3e2d" class="t constructor">RemoteDataEventArgs</a>&lt;<a href="../../hostifaces/PowerShell.cs.html#42e325836d1ae967" class="t t">PSInvocationStateInfo</a>&gt;(
                    <b>new</b> <span class="t">PSInvocationStateInfo</span>(<a href="../../hostifaces/PowerShell.cs.html#24cc37ccdc118b7a" class="t t">PSInvocationState</a>.<a href="../../hostifaces/PowerShell.cs.html#6a6866e7df063875" class="i field">Stopped</a>, <span class="r87 r">exception</span>)));
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Send the host response to the server.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r88 r">hostResponse</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Host response to send.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="018723f865f89d32" href="../../../R/018723f865f89d32.html" target="n" data-glyph="74,1" class="i method">SendHostResponseToServer</a>(<a href="../common/WireDataFormat/RemoteHost.cs.html#2088d050a88e3ac6" class="t t">RemoteHostResponse</a> <span id="r88 rd" class="r88 r">hostResponse</span>)
        {
            <a href="../common/WireDataFormat/RemotingDataObject.cs.html#ca4629603c976aab" class="t t">RemoteDataObject</a>&lt;<a href="../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt; <span id="r89 rd" class="r89 r">dataToBeSent</span> =
                <a href="../common/WireDataFormat/RemotingDataObject.cs.html#ca4629603c976aab" class="t t">RemoteDataObject</a>&lt;<a href="../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt;.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#892b04684918b3a0" class="i method">CreateFrom</a>(<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#45c72046001f69b8" class="t t">RemotingDestination</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#061ac750e6d280da" class="i field">Server</a>,
                <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#296cbb5be87abd08" class="t t">RemotingDataType</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#54fb34cf1704608e" class="i field">RemotePowerShellHostResponseData</a>,
                <a href="#e3c616760ac663d0" class="i field">clientRunspacePoolId</a>,
                <a href="#383c59f0c05e7bc5" class="i field">clientPowerShellId</a>,
                <span class="r88 r">hostResponse</span>.<a href="../common/WireDataFormat/RemoteHost.cs.html#657b141251f02e27" class="i method">Encode</a>());
 
            <a href="#d4654360189d8f15" class="i property">TransportManager</a>.<a href="../fanin/BaseTransportManager.cs.html#f8317afa9f690e3b" class="i property">DataToBeSentCollection</a>.<a href="../fanin/PriorityCollection.cs.html#442d0537a5958ee8" class="i method">Add</a>&lt;<a href="../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt;(<span class="r89 r">dataToBeSent</span>,
                <a href="../fanin/PriorityCollection.cs.html#f0975201467fdc06" class="t t">DataPriorityType</a>.<a href="../fanin/PriorityCollection.cs.html#ef28607d20d8e243" class="i field">PromptResponse</a>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Attach the specified data collection as input</span>
        <span class="c">///</span><span class="c"> to the remote powershell.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r90 r">inputstream</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="fdd76101fb249e43" href="../../../R/fdd76101fb249e43.html" target="n" data-glyph="74,1" class="i method">SendInput</a>(<a href="../../../utils/ObjectStream.cs.html#27e9349816faeecb" class="t t">ObjectStreamBase</a> <span id="r90 rd" class="r90 r">inputstream</span>)
        {
            <b>if</b> (!<span class="r90 r">inputstream</span>.<a href="../../../utils/ObjectStream.cs.html#eff54ee10bba7a56" class="i property">IsOpen</a> &amp;&amp; <span class="r90 r">inputstream</span>.<a href="../../../utils/ObjectStream.cs.html#01c58f66ddc41629" class="i property">Count</a> == 0)
            {
                <span class="c">// there is no input, send an end of input</span>
                <span class="c">// message</span>
                <b>lock</b> (<a href="#e51947f928347fae" class="i field">_inputSyncObject</a>)
                {
                    <span class="c">// send input closed information to server</span>
                    <a href="#3a7cebb01f7e85e4" class="i method">SendDataAsync</a>(<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#88b19073d823ce05" class="t t">RemotingEncoder</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#25682c1fc5df530f" class="i method">GeneratePowerShellInputEnd</a>(
                        <a href="#e3c616760ac663d0" class="i field">clientRunspacePoolId</a>, <a href="#383c59f0c05e7bc5" class="i field">clientPowerShellId</a>));
                }
            }
            <b>else</b>
            {
                <span class="c">// its possible that in client input data is written in a thread</span>
                <span class="c">// other than the current thread. Since we want to write input</span>
                <span class="c">// to the server in the order in which it was received, this</span>
                <span class="c">// operation of writing to the server need to be synced</span>
                <span class="c">// Also we need to ensure that all the data currently available</span>
                <span class="c">// for enumeration are written out before any newly added data</span>
                <span class="c">// is written. Hence the lock is made even before the handler is</span>
                <span class="c">// registered</span>
                <b>lock</b> (<a href="#e51947f928347fae" class="i field">_inputSyncObject</a>)
                {
                    <span class="r90 r">inputstream</span>.<a href="../../../utils/ObjectStream.cs.html#16ab48f9b8a043bb" class="i">DataReady</a> += <span class="i">HandleInputDataReady</span>;
                    <a href="#66c5036dc77b6e59" class="i method">WriteInput</a>(<span class="r90 r">inputstream</span>);
                }
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Process the data received from the runspace pool</span>
        <span class="c">///</span><span class="c"> on the server.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r91 r">receivedData</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Data received.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="c8d5a8987499c580" href="../../../R/c8d5a8987499c580.html" target="n" data-glyph="74,1" class="i method">ProcessReceivedData</a>(<a href="../common/WireDataFormat/RemotingDataObject.cs.html#ca4629603c976aab" class="t t">RemoteDataObject</a>&lt;<a href="../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt; <span id="r91 rd" class="r91 r">receivedData</span>)
        {
            <span class="c">// verify if this data structure handler is the intended recipient</span>
            <b>if</b> (<span class="r91 r">receivedData</span>.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#767aea3474afdc8e" class="i property">PowerShellId</a> != <a href="#383c59f0c05e7bc5" class="i field">clientPowerShellId</a>)
            {
                <b>throw</b> <b>new</b> <span class="t">PSRemotingDataStructureException</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">PipelineIdsDoNotMatch</span>,
                                <span class="r91 r">receivedData</span>.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#767aea3474afdc8e" class="i property">PowerShellId</a>, <a href="#383c59f0c05e7bc5" class="i field">clientPowerShellId</a>);
            }
 
            <span class="c">// decode the message and take appropriate action</span>
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r91 r">receivedData</span>.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#6975a2b0635b9f80" class="i property">TargetInterface</a> == <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#1d73dff2a8d6a0bf" class="t t">RemotingTargetInterface</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#f4078f88b2ce5495" class="i field">PowerShell</a>,
                <span class="s">&quot;Target interface is expected to be Pipeline&quot;</span>);
 
            <b>switch</b> (<span class="r91 r">receivedData</span>.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#97d7621b092d013f" class="i property">DataType</a>)
            {
                <b>case</b> <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#296cbb5be87abd08" class="t t">RemotingDataType</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#dfd57951d114980b" class="i field">PowerShellStateInfo</a>:
                    {
                        <a href="../../hostifaces/PowerShell.cs.html#42e325836d1ae967" class="t t">PSInvocationStateInfo</a> <span id="r92 rd" class="r92 r">stateInfo</span> =
                            <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#6f71f8c4cc2ac041" class="t t">RemotingDecoder</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#00f6cb797709ad8f" class="i method">GetPowerShellStateInfo</a>(<span class="r91 r">receivedData</span>.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#d13e5d3038741f3e" class="i property">Data</a>);
 
                        <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<a href="#ef5c7524bb659078" class="i">InvocationStateInfoReceived</a> != <b>null</b>,
                            <span class="s">&quot;ClientRemotePowerShell should subscribe to all data structure handler events&quot;</span>);
                        <a href="#ef5c7524bb659078" class="i">InvocationStateInfoReceived</a>.<span class="i">SafeInvoke</span>(<a href="#ef96db27814e82f4" class="k">this</a>,
                            <b>new</b> <a href="../common/misc.cs.html#79fd22f37cbd3e2d" class="t constructor">RemoteDataEventArgs</a>&lt;<a href="../../hostifaces/PowerShell.cs.html#42e325836d1ae967" class="t t">PSInvocationStateInfo</a>&gt;(<span class="r92 r">stateInfo</span>));
                    }
 
                    <b>break</b>;
 
                <b>case</b> <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#296cbb5be87abd08" class="t t">RemotingDataType</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#f6941c9a7d9e0a2f" class="i field">PowerShellOutput</a>:
                    {
                        <b>object</b> <span id="r93 rd" class="r93 r">outputObject</span> =
                            <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#6f71f8c4cc2ac041" class="t t">RemotingDecoder</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#b97939d32ca1b1bd" class="i method">GetPowerShellOutput</a>(<span class="r91 r">receivedData</span>.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#d13e5d3038741f3e" class="i property">Data</a>);
 
                        <span class="c">// since it is possible that powershell can have</span>
                        <span class="c">// strongly typed output, origin information will</span>
                        <span class="c">// not be added in this case. If a remoting cmdlet</span>
                        <span class="c">// is using PowerShell, then it should take care</span>
                        <span class="c">// of adding the origin information</span>
                        <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<a href="#97826a5b80db389d" class="i">OutputReceived</a> != <b>null</b>,
                            <span class="s">&quot;ClientRemotePowerShell should subscribe to all data structure handler events&quot;</span>);
                        <a href="#97826a5b80db389d" class="i">OutputReceived</a>.<span class="i">SafeInvoke</span>(<a href="#ef96db27814e82f4" class="k">this</a>,
                            <b>new</b> <a href="../common/misc.cs.html#79fd22f37cbd3e2d" class="t constructor">RemoteDataEventArgs</a>&lt;<b>object</b>&gt;(<span class="r93 r">outputObject</span>));
                    }
 
                    <b>break</b>;
 
                <b>case</b> <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#296cbb5be87abd08" class="t t">RemotingDataType</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#2bfdbd03af00a40c" class="i field">PowerShellErrorRecord</a>:
                    {
                        <a href="../../ErrorPackage.cs.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r94 rd" class="r94 r">errorRecord</span> =
                            <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#6f71f8c4cc2ac041" class="t t">RemotingDecoder</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#bb281af0bee4a742" class="i method">GetPowerShellError</a>(<span class="r91 r">receivedData</span>.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#d13e5d3038741f3e" class="i property">Data</a>);
 
                        <span class="c">// since it is possible that powershell can have</span>
                        <span class="c">// strongly typed output, origin information will</span>
                        <span class="c">// not be added for output. Therefore, origin</span>
                        <span class="c">// information will not be added for error records</span>
                        <span class="c">// as well. If a remoting cmdlet</span>
                        <span class="c">// is using PowerShell, then it should take care</span>
                        <span class="c">// of adding the origin information</span>
                        <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<a href="#743c4d5ca42b19f7" class="i">ErrorReceived</a> != <b>null</b>,
                                <span class="s">&quot;ClientRemotePowerShell should subscribe to all data structure handler events&quot;</span>);
 
                        <a href="#743c4d5ca42b19f7" class="i">ErrorReceived</a>.<span class="i">SafeInvoke</span>(<a href="#ef96db27814e82f4" class="k">this</a>,
                            <b>new</b> <a href="../common/misc.cs.html#79fd22f37cbd3e2d" class="t constructor">RemoteDataEventArgs</a>&lt;<a href="../../ErrorPackage.cs.html#fe2b46733a081db9" class="t t">ErrorRecord</a>&gt;(<span class="r94 r">errorRecord</span>));
                    }
 
                    <b>break</b>;
                <b>case</b> <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#296cbb5be87abd08" class="t t">RemotingDataType</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#9305a742d83a6da8" class="i field">PowerShellDebug</a>:
                    {
                        <a href="../../hostifaces/InformationalRecord.cs.html#8954d4e40287d3de" class="t t">DebugRecord</a> <span id="r95 rd" class="r95 r">record</span> = <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#6f71f8c4cc2ac041" class="t t">RemotingDecoder</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#d8145ef4fe7bbb59" class="i method">GetPowerShellDebug</a>(<span class="r91 r">receivedData</span>.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#d13e5d3038741f3e" class="i property">Data</a>);
 
                        <a href="#53ad87a815f6bf93" class="i">InformationalMessageReceived</a>.<span class="i">SafeInvoke</span>(<a href="#ef96db27814e82f4" class="k">this</a>,
                            <b>new</b> <a href="../common/misc.cs.html#79fd22f37cbd3e2d" class="t constructor">RemoteDataEventArgs</a>&lt;<a href="#e44e8a34c9f4b3f9" class="t t">InformationalMessage</a>&gt;(
                                <b>new</b> <a href="#ae90857a05f652f4" class="t constructor">InformationalMessage</a>(<span class="r95 r">record</span>, <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#296cbb5be87abd08" class="t t">RemotingDataType</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#9305a742d83a6da8" class="i field">PowerShellDebug</a>)));
                    }
 
                    <b>break</b>;
 
                <b>case</b> <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#296cbb5be87abd08" class="t t">RemotingDataType</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#1036eaaa6058e728" class="i field">PowerShellVerbose</a>:
                    {
                        <a href="../../hostifaces/InformationalRecord.cs.html#5d56339940b0040b" class="t t">VerboseRecord</a> <span id="r96 rd" class="r96 r">record</span> = <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#6f71f8c4cc2ac041" class="t t">RemotingDecoder</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#7d01a3a943851c87" class="i method">GetPowerShellVerbose</a>(<span class="r91 r">receivedData</span>.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#d13e5d3038741f3e" class="i property">Data</a>);
 
                        <a href="#53ad87a815f6bf93" class="i">InformationalMessageReceived</a>.<span class="i">SafeInvoke</span>(<a href="#ef96db27814e82f4" class="k">this</a>,
                            <b>new</b> <a href="../common/misc.cs.html#79fd22f37cbd3e2d" class="t constructor">RemoteDataEventArgs</a>&lt;<a href="#e44e8a34c9f4b3f9" class="t t">InformationalMessage</a>&gt;(
                                <b>new</b> <a href="#ae90857a05f652f4" class="t constructor">InformationalMessage</a>(<span class="r96 r">record</span>, <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#296cbb5be87abd08" class="t t">RemotingDataType</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#1036eaaa6058e728" class="i field">PowerShellVerbose</a>)));
                    }
 
                    <b>break</b>;
 
                <b>case</b> <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#296cbb5be87abd08" class="t t">RemotingDataType</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#df7036213bef9576" class="i field">PowerShellWarning</a>:
                    {
                        <a href="../../hostifaces/InformationalRecord.cs.html#59cd69dde48b9557" class="t t">WarningRecord</a> <span id="r97 rd" class="r97 r">record</span> = <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#6f71f8c4cc2ac041" class="t t">RemotingDecoder</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#d40bf90dfc2be117" class="i method">GetPowerShellWarning</a>(<span class="r91 r">receivedData</span>.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#d13e5d3038741f3e" class="i property">Data</a>);
 
                        <a href="#53ad87a815f6bf93" class="i">InformationalMessageReceived</a>.<span class="i">SafeInvoke</span>(<a href="#ef96db27814e82f4" class="k">this</a>,
                            <b>new</b> <a href="../common/misc.cs.html#79fd22f37cbd3e2d" class="t constructor">RemoteDataEventArgs</a>&lt;<a href="#e44e8a34c9f4b3f9" class="t t">InformationalMessage</a>&gt;(
                                <b>new</b> <a href="#ae90857a05f652f4" class="t constructor">InformationalMessage</a>(<span class="r97 r">record</span>, <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#296cbb5be87abd08" class="t t">RemotingDataType</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#df7036213bef9576" class="i field">PowerShellWarning</a>)));
                    }
 
                    <b>break</b>;
 
                <b>case</b> <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#296cbb5be87abd08" class="t t">RemotingDataType</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#b701f1d4d5503ca9" class="i field">PowerShellProgress</a>:
                    {
                        <a href="../../ProgressRecord.cs.html#d79b27687c6ed8c8" class="t t">ProgressRecord</a> <span id="r98 rd" class="r98 r">record</span> = <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#6f71f8c4cc2ac041" class="t t">RemotingDecoder</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#75e34edda9100a51" class="i method">GetPowerShellProgress</a>(<span class="r91 r">receivedData</span>.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#d13e5d3038741f3e" class="i property">Data</a>);
 
                        <a href="#53ad87a815f6bf93" class="i">InformationalMessageReceived</a>.<span class="i">SafeInvoke</span>(<a href="#ef96db27814e82f4" class="k">this</a>,
                            <b>new</b> <a href="../common/misc.cs.html#79fd22f37cbd3e2d" class="t constructor">RemoteDataEventArgs</a>&lt;<a href="#e44e8a34c9f4b3f9" class="t t">InformationalMessage</a>&gt;(
                                <b>new</b> <a href="#ae90857a05f652f4" class="t constructor">InformationalMessage</a>(<span class="r98 r">record</span>, <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#296cbb5be87abd08" class="t t">RemotingDataType</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#b701f1d4d5503ca9" class="i field">PowerShellProgress</a>)));
                    }
 
                    <b>break</b>;
 
                <b>case</b> <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#296cbb5be87abd08" class="t t">RemotingDataType</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#752bf1e010416aa1" class="i field">PowerShellInformationStream</a>:
                    {
                        <a href="../../InformationRecord.cs.html#508a9dbac37ec093" class="t t">InformationRecord</a> <span id="r99 rd" class="r99 r">record</span> = <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#6f71f8c4cc2ac041" class="t t">RemotingDecoder</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#462d4e1e3f0f05bc" class="i method">GetPowerShellInformation</a>(<span class="r91 r">receivedData</span>.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#d13e5d3038741f3e" class="i property">Data</a>);
 
                        <a href="#53ad87a815f6bf93" class="i">InformationalMessageReceived</a>.<span class="i">SafeInvoke</span>(<a href="#ef96db27814e82f4" class="k">this</a>,
                            <b>new</b> <a href="../common/misc.cs.html#79fd22f37cbd3e2d" class="t constructor">RemoteDataEventArgs</a>&lt;<a href="#e44e8a34c9f4b3f9" class="t t">InformationalMessage</a>&gt;(
                                <b>new</b> <a href="#ae90857a05f652f4" class="t constructor">InformationalMessage</a>(<span class="r99 r">record</span>, <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#296cbb5be87abd08" class="t t">RemotingDataType</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#752bf1e010416aa1" class="i field">PowerShellInformationStream</a>)));
                    }
 
                    <b>break</b>;
 
                <b>case</b> <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#296cbb5be87abd08" class="t t">RemotingDataType</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#055d2ba11ad1263c" class="i field">RemoteHostCallUsingPowerShellHost</a>:
                    {
                        <a href="../common/WireDataFormat/RemoteHost.cs.html#8bf334b011b63f92" class="t t">RemoteHostCall</a> <span id="r100 rd" class="r100 r">remoteHostCall</span> = <a href="../common/WireDataFormat/RemoteHost.cs.html#8bf334b011b63f92" class="t t">RemoteHostCall</a>.<a href="../common/WireDataFormat/RemoteHost.cs.html#c603556c125f7c63" class="i method">Decode</a>(<span class="r91 r">receivedData</span>.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#d13e5d3038741f3e" class="i property">Data</a>);
                        <a href="#d69edffc081d58a7" class="i">HostCallReceived</a>.<span class="i">SafeInvoke</span>(<a href="#ef96db27814e82f4" class="k">this</a>, <b>new</b> <a href="../common/misc.cs.html#79fd22f37cbd3e2d" class="t constructor">RemoteDataEventArgs</a>&lt;<a href="../common/WireDataFormat/RemoteHost.cs.html#8bf334b011b63f92" class="t t">RemoteHostCall</a>&gt;(<span class="r100 r">remoteHostCall</span>));
                    }
 
                    <b>break</b>;
 
                <b>default</b>:
                    {
                        <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<b>false</b>, <span class="s">&quot;we should not be encountering this&quot;</span>);
                    }
 
                    <b>break</b>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Set the state of the associated powershell to stopped.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r101 r">reason</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">reason why this state change</span>
        <span class="c">///</span><span class="c"> should occur</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span><span class="c">This method is called by the associated</span>
        <span class="c">///</span><span class="c"> runspace pool data structure handler when the server runspace pool</span>
        <span class="c">///</span><span class="c"> goes into a closed or broken state</span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="6f85276a26403b96" href="../../../R/6f85276a26403b96.html" target="n" data-glyph="74,1" class="i method">SetStateToFailed</a>(<span class="i">Exception</span> <span id="r101 rd" class="r101 r">reason</span>)
        {
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<a href="#478180bef6c04e8a" class="i">BrokenNotificationFromRunspacePool</a> != <b>null</b>,
                <span class="s">&quot;ClientRemotePowerShell should subscribe to all data structure handler events&quot;</span>);
 
            <a href="#478180bef6c04e8a" class="i">BrokenNotificationFromRunspacePool</a>.<span class="i">SafeInvoke</span>(<a href="#ef96db27814e82f4" class="k">this</a>, <b>new</b> <span class="t">RemoteDataEventArgs</span>&lt;<span class="i">Exception</span>&gt;(<span class="r101 r">reason</span>));
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Sets the state of the powershell to stopped.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r102 r">reason</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">reason why the powershell has to be</span>
        <span class="c">///</span><span class="c"> set to a stopped state.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="82a912eb6a5841d4" href="../../../R/82a912eb6a5841d4.html" target="n" data-glyph="74,1" class="i method">SetStateToStopped</a>(<span class="i">Exception</span> <span id="r102 rd" class="r102 r">reason</span>)
        {
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<a href="#abc36726071eb735" class="i">ClosedNotificationFromRunspacePool</a> != <b>null</b>,
                <span class="s">&quot;ClientRemotePowerShell should subscribe to all data structure handler events&quot;</span>);
 
            <a href="#abc36726071eb735" class="i">ClosedNotificationFromRunspacePool</a>.<span class="i">SafeInvoke</span>(<a href="#ef96db27814e82f4" class="k">this</a>, <b>new</b> <span class="t">RemoteDataEventArgs</span>&lt;<span class="i">Exception</span>&gt;(<span class="r102 r">reason</span>));
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Closes transport manager.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="4db2ec6f0f51c664" href="../../../R/4db2ec6f0f51c664.html" target="n" data-glyph="74,1" class="i method">CloseConnectionAsync</a>(<span class="i">Exception</span> <span id="r103 rd" class="r103 r">sessionCloseReason</span>)
        {
            <a href="#58677af68f74b152" class="i field">_sessionClosedReason</a> = <span class="r103 r">sessionCloseReason</span>;
 
            <span class="c">// wait for the close to complete and then dispose the transport manager</span>
            <a href="#d4654360189d8f15" class="i property">TransportManager</a>.<a href="../fanin/BaseTransportManager.cs.html#a237a80d5d4b9bee" class="i">CloseCompleted</a> += (<b>object</b> <span id="r104 rd" class="r104 r">source</span>, <span class="i">EventArgs</span> <span id="r105 rd" class="r105 r">args</span>) =&gt;
            {
                <b>if</b> (<a href="#923f3e397ef11ba8" class="i">CloseCompleted</a> != <b>null</b>)
                {
                    <span class="c">// If the provided event args are empty then call CloseCompleted with</span>
                    <span class="c">// RemoteSessionStateEventArgs containing session closed reason exception.</span>
                    <span class="i">EventArgs</span> <span id="r106 rd" class="r106 r">closeCompletedEventArgs</span> = (<span class="r105 r">args</span> == <span class="i">EventArgs</span>.<span class="i">Empty</span>) ?
                        <b>new</b> <a href="../common/misc.cs.html#1f7fb79f08327947" class="t constructor">RemoteSessionStateEventArgs</a>(<b>new</b> <a href="../common/misc.cs.html#745c8c11c741ab08" class="t constructor">RemoteSessionStateInfo</a>(<a href="../common/misc.cs.html#278607b7d2274446" class="t t">RemoteSessionState</a>.<a href="../common/misc.cs.html#7436cd78255d3040" class="i field">Closed</a>, <a href="#58677af68f74b152" class="i field">_sessionClosedReason</a>)) :
                        <span class="r105 r">args</span>;
 
                    <a href="#923f3e397ef11ba8" class="i">CloseCompleted</a>(<a href="#ef96db27814e82f4" class="k">this</a>, <span class="r106 r">closeCompletedEventArgs</span>);
                }
 
                <a href="#d4654360189d8f15" class="i property">TransportManager</a>.<a href="../fanin/BaseTransportManager.cs.html#087693e06bcea17a" class="i method">Dispose</a>();
            };
 
            <a href="#d4654360189d8f15" class="i property">TransportManager</a>.<a href="../fanin/BaseTransportManager.cs.html#8487786a35819f66" class="i method">CloseAsync</a>();
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Raise a remove association event. This is raised</span>
        <span class="c">///</span><span class="c"> when the powershell has gone into a terminal state</span>
        <span class="c">///</span><span class="c"> and the runspace pool need not maintain any further</span>
        <span class="c">///</span><span class="c"> associations.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="1689f772ee97a7bc" href="../../../R/1689f772ee97a7bc.html" target="n" data-glyph="74,1" class="i method">RaiseRemoveAssociationEvent</a>()
        {
            <a href="#1e1c7bde6009d12a" class="i">RemoveAssociation</a>.<span class="i">SafeInvoke</span>(<a href="#ef96db27814e82f4" class="k">this</a>, <span class="i">EventArgs</span>.<span class="i">Empty</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Called from runspace DS handler while disconnecting</span>
        <span class="c">///</span><span class="c"> This will set the state of the pipeline DS handler to disconnected.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="bbd2a6f6af97fd90" href="../../../R/bbd2a6f6af97fd90.html" target="n" data-glyph="74,1" class="i method">ProcessDisconnect</a>(<a href="../common/RunspacePoolStateInfo.cs.html#8b9143609d7a0363" class="t t">RunspacePoolStateInfo</a> <span id="r107 rd" class="r107 r">rsStateInfo</span>)
        {
            <span class="c">// disconnect may be called on a pipeline that is already disconnected.</span>
            <a href="../../hostifaces/PowerShell.cs.html#42e325836d1ae967" class="t t">PSInvocationStateInfo</a> <span id="r108 rd" class="r108 r">stateInfo</span> =
                            <b>new</b> <span class="t">PSInvocationStateInfo</span>(<a href="../../hostifaces/PowerShell.cs.html#24cc37ccdc118b7a" class="t t">PSInvocationState</a>.<a href="../../hostifaces/PowerShell.cs.html#55f5ed5d1c0f010a" class="i field">Disconnected</a>,
                                <span class="r107 r">rsStateInfo</span>?.<a href="../common/RunspacePoolStateInfo.cs.html#dcad0aee1f0be83d" class="i property">Reason</a>);
 
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<a href="#ef5c7524bb659078" class="i">InvocationStateInfoReceived</a> != <b>null</b>,
                <span class="s">&quot;ClientRemotePowerShell should subscribe to all data structure handler events&quot;</span>);
            <a href="#ef5c7524bb659078" class="i">InvocationStateInfoReceived</a>.<span class="i">SafeInvoke</span>(<a href="#ef96db27814e82f4" class="k">this</a>,
                <b>new</b> <a href="../common/misc.cs.html#79fd22f37cbd3e2d" class="t constructor">RemoteDataEventArgs</a>&lt;<a href="../../hostifaces/PowerShell.cs.html#42e325836d1ae967" class="t t">PSInvocationStateInfo</a>&gt;(<span class="r108 r">stateInfo</span>));
 
            <span class="i">Interlocked</span>.<span class="i">CompareExchange</span>(<b>ref</b> <a href="#fbce8528c61888cb" class="i field">_connectionState</a>, (<b>int</b>)<a href="#bb2a74c3f73948d4" class="t t">connectionStates</a>.<a href="#fa9f9f419aa1bd71" class="i field">Disconnected</a>, (<b>int</b>)<a href="#bb2a74c3f73948d4" class="t t">connectionStates</a>.<a href="#5c0f9d5cb7a951f7" class="i field">Connected</a>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This does not ensure that the corresponding session/runspacepool is in connected stated</span>
        <span class="c">///</span><span class="c"> Its the caller responsiblity to ensure that this is the case</span>
        <span class="c">///</span><span class="c"> At the protocols layers, this logic is delegated to the transport layer.</span>
        <span class="c">///</span><span class="c"> WSMan transport ensures that WinRS commands cannot be reconnected when the parent shell is not in connected state.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="9fd63afdd81cecca" href="../../../R/9fd63afdd81cecca.html" target="n" data-glyph="74,1" class="i method">ReconnectAsync</a>()
        {
            <b>int</b> <span id="r109 rd" class="r109 r">currentState</span> = <span class="i">Interlocked</span>.<span class="i">CompareExchange</span>(<b>ref</b> <a href="#fbce8528c61888cb" class="i field">_connectionState</a>, (<b>int</b>)<a href="#bb2a74c3f73948d4" class="t t">connectionStates</a>.<a href="#c14e5d42be0d15bf" class="i field">Reconnecting</a>, (<b>int</b>)<a href="#bb2a74c3f73948d4" class="t t">connectionStates</a>.<a href="#fa9f9f419aa1bd71" class="i field">Disconnected</a>);
            <b>if</b> ((<span class="r109 r">currentState</span> != (<b>int</b>)<a href="#bb2a74c3f73948d4" class="t t">connectionStates</a>.<a href="#fa9f9f419aa1bd71" class="i field">Disconnected</a>))
            {
                <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<b>false</b>, <span class="s">&quot;Pipeline DS Handler is in unexpected connection state&quot;</span>);
 
                <span class="c">// TODO: Raise appropriate exception</span>
                <b>return</b>;
            }
 
            <a href="#d4654360189d8f15" class="i property">TransportManager</a>.<a href="../fanin/BaseTransportManager.cs.html#7f1db74e3f1dc999" class="i method">ReconnectAsync</a>();
        }
 
        <span class="c">// Called from session DSHandler. Connects to a remote powershell instance.</span>
        <b>internal void</b> <a id="a9fa9f162d3db021" href="../../../R/a9fa9f162d3db021.html" target="n" data-glyph="74,1" class="i method">ConnectAsync</a>()
        {
            <b>int</b> <span id="r110 rd" class="r110 r">currentState</span> = <span class="i">Interlocked</span>.<span class="i">CompareExchange</span>(<b>ref</b> <a href="#fbce8528c61888cb" class="i field">_connectionState</a>, (<b>int</b>)<a href="#bb2a74c3f73948d4" class="t t">connectionStates</a>.<a href="#f5b68011b7e3277f" class="i field">Connecting</a>, (<b>int</b>)<a href="#bb2a74c3f73948d4" class="t t">connectionStates</a>.<a href="#fa9f9f419aa1bd71" class="i field">Disconnected</a>);
 
            <span class="c">// Connect is called for *reconstruct* connection case and so</span>
            <span class="c">// we need to set up all transport manager callbacks.</span>
            <a href="#3d52b9ea65f824ec" class="i method">SetupTransportManager</a>(<b>false</b>);
            <a href="#d4654360189d8f15" class="i property">TransportManager</a>.<a href="../fanin/BaseTransportManager.cs.html#c25dbbf00143cb5e" class="i method">ConnectAsync</a>();
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Called from session DSHandler.  Notify client of robust connection</span>
        <span class="c">///</span><span class="c"> message.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r111 r">e</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="0178fc07655713bc" href="../../../R/0178fc07655713bc.html" target="n" data-glyph="74,1" class="i method">ProcessRobustConnectionNotification</a>(
            <a href="../fanin/BaseTransportManager.cs.html#598698ed70e51507" class="t t">ConnectionStatusEventArgs</a> <span id="r111 rd" class="r111 r">e</span>)
        {
            <span class="c">// Raise event for PowerShell client.</span>
            <a href="#a1ee4a583ed95c45" class="i">RobustConnectionNotification</a>.<span class="i">SafeInvoke</span>(<a href="#ef96db27814e82f4" class="k">this</a>, <span class="r111 r">e</span>);
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Data Structure Handler Methods
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Protected Members
 
        <b>protected</b> <span class="i">Guid</span> <a id="e3c616760ac663d0" href="../../../R/e3c616760ac663d0.html" target="n" data-glyph="45,1" class="i field">clientRunspacePoolId</a>;
        <b>protected</b> <span class="i">Guid</span> <a id="383c59f0c05e7bc5" href="../../../R/383c59f0c05e7bc5.html" target="n" data-glyph="45,1" class="i field">clientPowerShellId</a>;
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Protected Members
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Constructors
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Default internal constructor.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r112 r">clientRunspacePoolId</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">id of the client</span>
        <span class="c">///</span><span class="c"> remote runspace pool associated with this data structure handler</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r113 r">clientPowerShellId</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">id of the client</span>
        <span class="c">///</span><span class="c"> powershell associated with this data structure handler</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r114 r">transportManager</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">transport manager associated</span>
        <span class="c">///</span><span class="c"> with this connection</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal</b> <a id="53f4e658ecaeff3a" href="../../../R/53f4e658ecaeff3a.html" target="n" data-glyph="74,1" class="t constructor">ClientPowerShellDataStructureHandler</a>(<a href="../fanin/BaseTransportManager.cs.html#fa455a694094fdc2" class="t t">BaseClientCommandTransportManager</a> <span id="r114 rd" class="r114 r">transportManager</span>,
                    <span class="i">Guid</span> <span id="r112 rd" class="r112 r">clientRunspacePoolId</span>, <span class="i">Guid</span> <span id="r113 rd" class="r113 r">clientPowerShellId</span>)
        {
            <a href="#d4654360189d8f15" class="i property">TransportManager</a> = <span class="r114 r">transportManager</span>;
            <a href="#ef96db27814e82f4" class="k">this</a>.<a href="#e3c616760ac663d0" class="i field">clientRunspacePoolId</a> = <span class="r112 r">clientRunspacePoolId</span>;
            <a href="#ef96db27814e82f4" class="k">this</a>.<a href="#383c59f0c05e7bc5" class="i field">clientPowerShellId</a> = <span class="r113 r">clientPowerShellId</span>;
            <span class="r114 r">transportManager</span>.<a href="../fanin/BaseTransportManager.cs.html#a9500d08805982a8" class="i">SignalCompleted</a> += <span class="i">OnSignalCompleted</span>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Constructors
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Internal Methods
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Client PowerShell Id of the powershell this</span>
        <span class="c">///</span><span class="c"> data structure handler is associated with.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal</b> <span class="i">Guid</span> <a id="1ca8c287c75fe3ec" href="../../../R/1ca8c287c75fe3ec.html" target="n" data-glyph="104,1" class="i property">PowerShellId</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#383c59f0c05e7bc5" class="i field">clientPowerShellId</a>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Transport manager used by this data structure handler.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal</b> <a href="../fanin/BaseTransportManager.cs.html#fa455a694094fdc2" class="t t">BaseClientCommandTransportManager</a> <a id="d4654360189d8f15" href="../../../R/d4654360189d8f15.html" target="n" data-glyph="104,1" class="i property">TransportManager</a> { <b>get</b>; }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Internal Methods
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Private Methods
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Send the data specified as a RemoteDataObject asynchronously</span>
        <span class="c">///</span><span class="c"> to the powershell on server.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r115 r">data</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Data to send.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span><span class="c">This overload takes a RemoteDataObject and should be</span>
        <span class="c">///</span><span class="c"> the one used within the code</span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>private void</b> <a id="3a7cebb01f7e85e4" href="../../../R/3a7cebb01f7e85e4.html" target="n" data-glyph="76,1" class="i method">SendDataAsync</a>(<a href="../common/WireDataFormat/RemotingDataObject.cs.html#3856dcbea775cab8" class="t t">RemoteDataObject</a> <span id="r115 rd" class="r115 r">data</span>)
        {
            <a href="../common/WireDataFormat/RemotingDataObject.cs.html#ca4629603c976aab" class="t t">RemoteDataObject</a>&lt;<b>object</b>&gt; <span id="r116 rd" class="r116 r">dataToBeSent</span> = (<a href="../common/WireDataFormat/RemotingDataObject.cs.html#ca4629603c976aab" class="t t">RemoteDataObject</a>&lt;<b>object</b>&gt;)<span class="r115 r">data</span>;
            <a href="#d4654360189d8f15" class="i property">TransportManager</a>.<a href="../fanin/BaseTransportManager.cs.html#f8317afa9f690e3b" class="i property">DataToBeSentCollection</a>.<a href="../fanin/PriorityCollection.cs.html#82212f989f1c53a3" class="i method">Add</a>&lt;<b>object</b>&gt;(<span class="r116 r">dataToBeSent</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Handle data added to input.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r117 r">sender</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Sender of this event.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r118 r">e</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Information describing this event.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>private void</b> <a id="d7660ebf8d68e9c7" href="../../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">HandleInputDataReady</a>(<b>object</b> <span id="r117 rd" class="r117 r">sender</span>, <span class="i">EventArgs</span> <span id="r118 rd" class="r118 r">e</span>)
        {
            <span class="c">// make sure only one thread calls the WriteInput.</span>
            <b>lock</b> (<a href="#e51947f928347fae" class="i field">_inputSyncObject</a>)
            {
                <a href="../../../utils/ObjectStream.cs.html#27e9349816faeecb" class="t t">ObjectStreamBase</a> <span id="r119 rd" class="r119 r">inputstream</span> = <span class="r117 r">sender</span> <b>as</b> <a href="../../../utils/ObjectStream.cs.html#27e9349816faeecb" class="t t">ObjectStreamBase</a>;
                <a href="#66c5036dc77b6e59" class="i method">WriteInput</a>(<span class="r119 r">inputstream</span>);
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span><span class="c">This method doesn&#39;t lock and its the responsibility</span>
        <span class="c">///</span><span class="c"> of the caller to actually do the locking</span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r120 r">inputstream</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>private void</b> <a id="66c5036dc77b6e59" href="../../../R/66c5036dc77b6e59.html" target="n" data-glyph="76,1" class="i method">WriteInput</a>(<a href="../../../utils/ObjectStream.cs.html#27e9349816faeecb" class="t t">ObjectStreamBase</a> <span id="r120 rd" class="r120 r">inputstream</span>)
        {
            <span class="i">Collection</span>&lt;<b>object</b>&gt; <span id="r121 rd" class="r121 r">inputObjects</span> = <span class="r120 r">inputstream</span>.<a href="../../../utils/ObjectStream.cs.html#8ea6b41cfdf95aa1" class="i property">ObjectReader</a>.<span class="i">NonBlockingRead</span>(<span class="i">Int32</span>.<span class="i">MaxValue</span>);
 
            <b>foreach</b> (<b>object</b> <span id="r122 rd" class="r122 r">inputObject</span> <b>in</b> <span class="r121 r">inputObjects</span>)
            {
                <a href="#3a7cebb01f7e85e4" class="i method">SendDataAsync</a>(<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#88b19073d823ce05" class="t t">RemotingEncoder</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#306edcedbcf31dae" class="i method">GeneratePowerShellInput</a>(<span class="r122 r">inputObject</span>,
                    <a href="#e3c616760ac663d0" class="i field">clientRunspacePoolId</a>, <a href="#383c59f0c05e7bc5" class="i field">clientPowerShellId</a>));
            }
 
            <b>if</b> (!<span class="r120 r">inputstream</span>.<a href="../../../utils/ObjectStream.cs.html#eff54ee10bba7a56" class="i property">IsOpen</a>)
            {
                <span class="c">// Write any data written after the NonBlockingRead call above.</span>
                <span class="r121 r">inputObjects</span> = <span class="r120 r">inputstream</span>.<a href="../../../utils/ObjectStream.cs.html#8ea6b41cfdf95aa1" class="i property">ObjectReader</a>.<span class="i">NonBlockingRead</span>(<span class="i">Int32</span>.<span class="i">MaxValue</span>);
 
                <b>foreach</b> (<b>object</b> <span id="r123 rd" class="r123 r">inputObject</span> <b>in</b> <span class="r121 r">inputObjects</span>)
                {
                    <a href="#3a7cebb01f7e85e4" class="i method">SendDataAsync</a>(<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#88b19073d823ce05" class="t t">RemotingEncoder</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#306edcedbcf31dae" class="i method">GeneratePowerShellInput</a>(<span class="r123 r">inputObject</span>,
                        <a href="#e3c616760ac663d0" class="i field">clientRunspacePoolId</a>, <a href="#383c59f0c05e7bc5" class="i field">clientPowerShellId</a>));
                }
 
                <span class="c">// we are sending input end to the server. Ignore the future</span>
                <span class="c">// DataReady events (A DataReady event is raised while Closing</span>
                <span class="c">// the stream as well)</span>
                <span class="r120 r">inputstream</span>.<a href="../../../utils/ObjectStream.cs.html#16ab48f9b8a043bb" class="i">DataReady</a> -= <span class="i">HandleInputDataReady</span>;
                <span class="c">// stream close: send end of input</span>
                <a href="#3a7cebb01f7e85e4" class="i method">SendDataAsync</a>(<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#88b19073d823ce05" class="t t">RemotingEncoder</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#25682c1fc5df530f" class="i method">GeneratePowerShellInputEnd</a>(
                    <a href="#e3c616760ac663d0" class="i field">clientRunspacePoolId</a>, <a href="#383c59f0c05e7bc5" class="i field">clientPowerShellId</a>));
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Helper method to add transport manager callbacks and set transport</span>
        <span class="c">///</span><span class="c"> manager disconnected state.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r124 r">inDisconnectMode</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Boolean.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>private void</b> <a id="3d52b9ea65f824ec" href="../../../R/3d52b9ea65f824ec.html" target="n" data-glyph="76,1" class="i method">SetupTransportManager</a>(<b>bool</b> <span id="r124 rd" class="r124 r">inDisconnectMode</span>)
        {
            <a href="#d4654360189d8f15" class="i property">TransportManager</a>.<a href="../fanin/BaseTransportManager.cs.html#85d6a6f2ebae43ff" class="i">WSManTransportErrorOccured</a> += <span class="i">HandleTransportError</span>;
            <a href="#d4654360189d8f15" class="i property">TransportManager</a>.<a href="../fanin/BaseTransportManager.cs.html#ab98168ad401f31e" class="i">ReconnectCompleted</a> += <span class="i">HandleReconnectCompleted</span>;
            <a href="#d4654360189d8f15" class="i property">TransportManager</a>.<a href="../fanin/BaseTransportManager.cs.html#99a709b2ef3c3bf4" class="i">ConnectCompleted</a> += <span class="i">HandleConnectCompleted</span>;
            <a href="#d4654360189d8f15" class="i property">TransportManager</a>.<a href="../fanin/BaseTransportManager.cs.html#7eeb502235c781ec" class="i">DelayStreamRequestProcessed</a> += <span class="i">HandleDelayStreamRequestProcessed</span>;
            <a href="#d4654360189d8f15" class="i property">TransportManager</a>.<a href="../fanin/BaseTransportManager.cs.html#ac907f25779bf298" class="i field">startInDisconnectedMode</a> = <span class="r124 r">inDisconnectMode</span>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Private Methods
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Private Members
 
        <span class="c">// object for synchronizing input to be sent</span>
        <span class="c">// to server powershell</span>
        <b>private readonly object</b> <a id="e51947f928347fae" href="../../../R/e51947f928347fae.html" target="n" data-glyph="46,1" class="i field">_inputSyncObject</a> = <b>new</b> <b>object</b>();
 
        <b>private enum</b> <a id="bb2a74c3f73948d4" href="../../../R/bb2a74c3f73948d4.html" target="n" data-glyph="22,1" class="t t"><span id="0c05df4d77c69949">connectionStates</span></a>
        {
            <a id="5c0f9d5cb7a951f7" href="../../../R/5c0f9d5cb7a951f7.html" target="n" data-glyph="24,2" class="i field">Connected</a> = 1, <a id="fa9f9f419aa1bd71" href="../../../R/fa9f9f419aa1bd71.html" target="n" data-glyph="24,2" class="i field">Disconnected</a> = 3, <a id="c14e5d42be0d15bf" href="../../../R/c14e5d42be0d15bf.html" target="n" data-glyph="24,2" class="i field">Reconnecting</a> = 4, <a id="f5b68011b7e3277f" href="../../../R/f5b68011b7e3277f.html" target="n" data-glyph="24,2" class="i field">Connecting</a> = 5
        }
 
        <b>private int</b> <a id="fbce8528c61888cb" href="../../../R/fbce8528c61888cb.html" target="n" data-glyph="46,1" class="i field">_connectionState</a> = (<b>int</b>)<a href="#bb2a74c3f73948d4" class="t t">connectionStates</a>.<a href="#5c0f9d5cb7a951f7" class="i field">Connected</a>;
 
        <span class="c">// Contains the associated session closed reason exception if any,</span>
        <span class="c">// otherwise is null.</span>
        <b>private</b> <span class="i">Exception</span> <a id="58677af68f74b152" href="../../../R/58677af68f74b152.html" target="n" data-glyph="46,1" class="i field">_sessionClosedReason</a>;
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Private Members
    }
 
    <b>internal class</b> <a id="e44e8a34c9f4b3f9" href="../../../R/e44e8a34c9f4b3f9.html" target="n" data-glyph="2,0" class="t t">InformationalMessage</a>
    {
        <b>internal object</b> <a id="69bb4026b2b467e6" href="../../../R/69bb4026b2b467e6.html" target="n" data-glyph="104,1" class="i property">Message</a> { <b>get</b>; }
 
        <b>internal</b> <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#296cbb5be87abd08" class="t t">RemotingDataType</a> <a id="ef6a16ccbbc1fc04" href="../../../R/ef6a16ccbbc1fc04.html" target="n" data-glyph="104,1" class="i property">DataType</a> { <b>get</b>; }
 
        <b>internal</b> <a id="ae90857a05f652f4" href="../../../R/ae90857a05f652f4.html" target="n" data-glyph="74,1" class="t constructor">InformationalMessage</a>(<b>object</b> <span id="r125 rd" class="r125 r">message</span>, <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#296cbb5be87abd08" class="t t">RemotingDataType</a> <span id="r126 rd" class="r126 r">dataType</span>)
        {
            <a href="#ef6a16ccbbc1fc04" class="i property">DataType</a> = <span class="r126 r">dataType</span>;
            <a href="#69bb4026b2b467e6" class="i property">Message</a> = <span class="r125 r">message</span>;
        }
    }
}
</pre></td></tr></table></div></body></html>
