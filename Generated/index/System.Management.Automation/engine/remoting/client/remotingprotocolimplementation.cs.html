<!DOCTYPE html>
<html><head><title>remotingprotocolimplementation.cs</title><link rel="stylesheet" href="../../../../styles.css"><script src="../../../../scripts.js"></script></head>
<body class="cB" onload="i(792);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#System.Management.Automation/engine/remoting/client/remotingprotocolimplementation.cs" target="_top">engine\remoting\client\remotingprotocolimplementation.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#System.Management.Automation" target="_top">src\System.Management.Automation\System.Management.Automation.csproj</a> (System.Management.Automation)</td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation.</span>
<span class="c">// Licensed under the MIT License.</span>
 
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Internal</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Remoting</span>.<span class="i n">Client</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Runspaces</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Runspaces</span>.<span class="i n">Internal</span>;
 
<b>using</b> <span class="t">Dbg</span> = <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Diagnostics</a>;
 
<b>namespace</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Remoting</span>
{
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Implements ServerRemoteSessionDataStructureHandler.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>internal class</b> <a id="eff965b51f1e9c1d" href="../../../R/eff965b51f1e9c1d.html" target="n" data-glyph="2,0" class="t t">ClientRemoteSessionDSHandlerImpl</a> : <a href="remotingprotocol.cs.html#b91142778dab17fd" class="t t">ClientRemoteSessionDataStructureHandler</a>, <span class="i">IDisposable</span>
    {
        [<span class="i">TraceSourceAttribute</span>(<span class="s">&quot;CRSDSHdlerImpl&quot;</span>, <span class="s">&quot;ClientRemoteSessionDSHandlerImpl&quot;</span>)]
        <b>private static readonly</b> <a href="../../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a> <a id="ff76a8f82c889b68" href="../../../R/ff76a8f82c889b68.html" target="n" data-glyph="46,1" class="i field">s_trace</a> = <a href="../../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../../../utils/MshTraceSource.cs.html#697b06ec70e3c537" class="i method">GetTracer</a>(<span class="s">&quot;CRSDSHdlerImpl&quot;</span>, <span class="s">&quot;ClientRemoteSessionDSHandlerImpl&quot;</span>);
 
        <b>private const string</b> <a id="c337fdebd2aa8213" href="../../../R/../../0000000000.html" target="n" data-glyph="10,1" class="i field">resBaseName</a> = <span class="s">&quot;remotingerroridstrings&quot;</span>;
 
        <b>private readonly</b> <a href="../fanin/BaseTransportManager.cs.html#19883ec4df424177" class="t t">BaseClientSessionTransportManager</a> <a id="bc2db2da522293dc" href="../../../R/bc2db2da522293dc.html" target="n" data-glyph="46,1" class="i field">_transportManager</a>;
        <b>private readonly</b> <a href="clientremotesessionprotocolstatemachine.cs.html#039f4a3a46a31204" class="t t">ClientRemoteSessionDSHandlerStateMachine</a> <a id="ad0ab9cf6a29b328" href="../../../R/ad0ab9cf6a29b328.html" target="n" data-glyph="46,1" class="i field">_stateMachine</a>;
        <b>private readonly</b> <a href="clientremotesession.cs.html#e2e97fb58c308155" class="t t">ClientRemoteSession</a> <a id="243e93e02f070707" href="../../../R/243e93e02f070707.html" target="n" data-glyph="46,1" class="i field">_session</a>;
        <b>private readonly</b> <a href="../common/RunspaceConnectionInfo.cs.html#e07ed56a8a1da829" class="t t">RunspaceConnectionInfo</a> <a id="cc7cad8febcc764d" href="../../../R/cc7cad8febcc764d.html" target="n" data-glyph="46,1" class="i field">_connectionInfo</a>;
        <span class="c">// used for connection redirection.</span>
        <b>private</b> <span class="i">Uri</span> <a id="1e07e2effabc46c8" href="../../../R/1e07e2effabc46c8.html" target="n" data-glyph="46,1" class="i field">_redirectUri</a>;
        <b>private int</b> <a id="869009e966405d36" href="../../../R/869009e966405d36.html" target="n" data-glyph="46,1" class="i field">_maxUriRedirectionCount</a>;
        <b>private bool</b> <a id="78d6e935f92ae266" href="../../../R/78d6e935f92ae266.html" target="n" data-glyph="46,1" class="i field">_isCloseCalled</a>;
        <b>private readonly object</b> <a id="0640fa7b59bf25d2" href="../../../R/0640fa7b59bf25d2.html" target="n" data-glyph="46,1" class="i field">_syncObject</a> = <b>new</b> <b>object</b>();
        <b>private readonly</b> <a href="../../../utils/CryptoUtils.cs.html#1999dfb2439af5a0" class="t t">PSRemotingCryptoHelper</a> <a id="e234fb5053fcac38" href="../../../R/e234fb5053fcac38.html" target="n" data-glyph="46,1" class="i field">_cryptoHelper</a>;
 
        <b>private readonly</b> <a href="clientremotesession.cs.html#e2e97fb58c308155" class="t t">ClientRemoteSession</a>.<a href="clientremotesession.cs.html#e9dff0e743b410a7" class="t t">URIDirectionReported</a> <a id="79ef92b54a630414" href="../../../R/79ef92b54a630414.html" target="n" data-glyph="46,1" class="i field">_uriRedirectionHandler</a>;
 
        <b>internal override</b> <a href="../fanin/BaseTransportManager.cs.html#19883ec4df424177" class="t t">BaseClientSessionTransportManager</a> <a id="d9d447bfef4c65c3" href="../../../R/d9d447bfef4c65c3.html" target="n" data-glyph="104,1" class="i property">TransportManager</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#bc2db2da522293dc" class="i field">_transportManager</a>;
            }
        }
 
        <b>internal override</b> <a href="../fanin/BaseTransportManager.cs.html#fa455a694094fdc2" class="t t">BaseClientCommandTransportManager</a> <a id="79a3479e7362a2c1" href="../../../R/79a3479e7362a2c1.html" target="n" data-glyph="74,1" class="i method">CreateClientCommandTransportManager</a>(
            <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Runspaces</span>.<span class="i n">Internal</span>.<a href="ClientRemotePowerShell.cs.html#b4d2ac017883b31c" class="t t">ClientRemotePowerShell</a> <span id="r0 rd" class="r0 r">cmd</span>,
            <b>bool</b> <span id="r1 rd" class="r1 r">noInput</span>)
        {
            <a href="../fanin/BaseTransportManager.cs.html#fa455a694094fdc2" class="t t">BaseClientCommandTransportManager</a> <span id="r2 rd" class="r2 r">cmdTransportMgr</span> =
                <a href="#bc2db2da522293dc" class="i field">_transportManager</a>.<a href="../fanin/BaseTransportManager.cs.html#c47fbfe767c9bd0a" class="i method">CreateClientCommandTransportManager</a>(<a href="#cc7cad8febcc764d" class="i field">_connectionInfo</a>, <span class="r0 r">cmd</span>, <span class="r1 r">noInput</span>);
            <span class="c">// listen to data ready events.</span>
            <span class="r2 r">cmdTransportMgr</span>.<a href="../fanin/BaseTransportManager.cs.html#7b8ef65b8a2a6a41" class="i">DataReceived</a> += <span class="i">DispatchInputQueueData</span>;
 
            <b>return</b> <span class="r2 r">cmdTransportMgr</span>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> constructors
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Creates an instance of ClientRemoteSessionDSHandlerImpl.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal</b> <a id="b6f27bcf6767a21b" href="../../../R/b6f27bcf6767a21b.html" target="n" data-glyph="74,1" class="t constructor">ClientRemoteSessionDSHandlerImpl</a>(<a href="clientremotesession.cs.html#e2e97fb58c308155" class="t t">ClientRemoteSession</a> <span id="r3 rd" class="r3 r">session</span>,
            <a href="../../../utils/CryptoUtils.cs.html#1999dfb2439af5a0" class="t t">PSRemotingCryptoHelper</a> <span id="r4 rd" class="r4 r">cryptoHelper</span>,
            <a href="../common/RunspaceConnectionInfo.cs.html#e07ed56a8a1da829" class="t t">RunspaceConnectionInfo</a> <span id="r5 rd" class="r5 r">connectionInfo</span>,
            <a href="clientremotesession.cs.html#e2e97fb58c308155" class="t t">ClientRemoteSession</a>.<a href="clientremotesession.cs.html#e9dff0e743b410a7" class="t t">URIDirectionReported</a> <span id="r6 rd" class="r6 r">uriRedirectionHandler</span>)
        {
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<a href="#869009e966405d36" class="i field">_maxUriRedirectionCount</a> &gt;= 0, <span class="s">&quot;maxUriRedirectionCount cannot be less than 0.&quot;</span>);
 
            <b>if</b> (<span class="r3 r">session</span> == <b>null</b>)
            {
                <b>throw</b> <a href="../../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../../../utils/MshTraceSource.cs.html#fbe67220ad7522a0" class="i method">NewArgumentNullException</a>(<b>nameof</b>(<span class="r3 r">session</span>));
            }
 
            <a href="#243e93e02f070707" class="i field">_session</a> = <span class="r3 r">session</span>;
 
            <span class="c">// Create state machine</span>
            <a href="#ad0ab9cf6a29b328" class="i field">_stateMachine</a> = <b>new</b> <a href="clientremotesessionprotocolstatemachine.cs.html#f3a4ae7c6f2c182b" class="t constructor">ClientRemoteSessionDSHandlerStateMachine</a>();
            <a href="#ad0ab9cf6a29b328" class="i field">_stateMachine</a>.<a href="clientremotesessionprotocolstatemachine.cs.html#7144d1f987a602b2" class="i">StateChanged</a> += <span class="i">HandleStateChanged</span>;
 
            <a href="#cc7cad8febcc764d" class="i field">_connectionInfo</a> = <span class="r5 r">connectionInfo</span>;
 
            <span class="c">// Create transport manager</span>
            <a href="#e234fb5053fcac38" class="i field">_cryptoHelper</a> = <span class="r4 r">cryptoHelper</span>;
            <a href="#bc2db2da522293dc" class="i field">_transportManager</a> = <a href="#cc7cad8febcc764d" class="i field">_connectionInfo</a>.<a href="../common/RunspaceConnectionInfo.cs.html#77794e475b9232e2" class="i method">CreateClientSessionTransportManager</a>(
                <a href="#243e93e02f070707" class="i field">_session</a>.<a href="clientremotesession.cs.html#e8997fdb5a3c5f81" class="i property">RemoteRunspacePoolInternal</a>.<a href="../../hostifaces/RunspacePoolInternal.cs.html#76aedcc22e17e7e5" class="i property">InstanceId</a>,
                <a href="#243e93e02f070707" class="i field">_session</a>.<a href="clientremotesession.cs.html#e8997fdb5a3c5f81" class="i property">RemoteRunspacePoolInternal</a>.<a href="RemoteRunspacePoolInternal.cs.html#1a2dda11a58f900f" class="i property">Name</a>,
                <span class="r4 r">cryptoHelper</span>);
 
            <a href="#bc2db2da522293dc" class="i field">_transportManager</a>.<a href="../fanin/BaseTransportManager.cs.html#7b8ef65b8a2a6a41" class="i">DataReceived</a> += <span class="i">DispatchInputQueueData</span>;
            <a href="#bc2db2da522293dc" class="i field">_transportManager</a>.<a href="../fanin/BaseTransportManager.cs.html#85d6a6f2ebae43ff" class="i">WSManTransportErrorOccured</a> += <span class="i">HandleTransportError</span>;
            <a href="#bc2db2da522293dc" class="i field">_transportManager</a>.<a href="../fanin/BaseTransportManager.cs.html#a237a80d5d4b9bee" class="i">CloseCompleted</a> += <span class="i">HandleCloseComplete</span>;
            <a href="#bc2db2da522293dc" class="i field">_transportManager</a>.<a href="../fanin/BaseTransportManager.cs.html#dc2c612e7bab7e2a" class="i">DisconnectCompleted</a> += <span class="i">HandleDisconnectComplete</span>;
            <a href="#bc2db2da522293dc" class="i field">_transportManager</a>.<a href="../fanin/BaseTransportManager.cs.html#ab98168ad401f31e" class="i">ReconnectCompleted</a> += <span class="i">HandleReconnectComplete</span>;
 
            <a href="#bc2db2da522293dc" class="i field">_transportManager</a>.<a href="../fanin/BaseTransportManager.cs.html#1acdba1dd243046f" class="i">RobustConnectionNotification</a> += <span class="i">HandleRobustConnectionNotification</span>;
 
            <a href="../common/RunspaceConnectionInfo.cs.html#2d9d176ef419be5a" class="t t">WSManConnectionInfo</a> <span id="r7 rd" class="r7 r">wsmanConnectionInfo</span> = <a href="#cc7cad8febcc764d" class="i field">_connectionInfo</a> <b>as</b> <a href="../common/RunspaceConnectionInfo.cs.html#2d9d176ef419be5a" class="t t">WSManConnectionInfo</a>;
            <b>if</b> (<span class="r7 r">wsmanConnectionInfo</span> != <b>null</b>)
            {
                <span class="c">// only WSMan transport supports redirection</span>
 
                <span class="c">// store the uri redirection handler and authmechanism</span>
                <span class="c">// for uri redirection.</span>
                <a href="#79ef92b54a630414" class="i field">_uriRedirectionHandler</a> = <span class="r6 r">uriRedirectionHandler</span>;
                <a href="#869009e966405d36" class="i field">_maxUriRedirectionCount</a> = <span class="r7 r">wsmanConnectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#21431be8484ed16e" class="i property">MaximumConnectionRedirectionCount</a>;
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> constructors
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> create
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Makes a create call asynchronously.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal override void</b> <a id="44d61954b351ffa1" href="../../../R/44d61954b351ffa1.html" target="n" data-glyph="74,1" class="i method">CreateAsync</a>()
        {
            <span class="c">// errors are reported through WSManTransportErrorOccured event on</span>
            <span class="c">// the transport manager.</span>
            <a href="#bc2db2da522293dc" class="i field">_transportManager</a>.<a href="../fanin/BaseTransportManager.cs.html#b775a320b2c726cd" class="i">CreateCompleted</a> += <span class="i">HandleCreateComplete</span>;
            <a href="#bc2db2da522293dc" class="i field">_transportManager</a>.<a href="../fanin/BaseTransportManager.cs.html#647d3fc66fbadafe" class="i method">CreateAsync</a>();
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This callback is called on complete of async connect call.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r8 r">sender</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r9 r">args</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>private void</b> <a id="13a78068d3dc530d" href="../../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">HandleCreateComplete</a>(<b>object</b> <span id="r8 rd" class="r8 r">sender</span>, <span class="i">EventArgs</span> <span id="r9 rd" class="r9 r">args</span>)
        {
            <span class="c">// This is a no-op at the moment..as we dont need to inform anything to</span>
            <span class="c">// state machine here..StateMachine must already have reached NegotiationSent</span>
            <span class="c">// state and waiting for Negotiation Received which will happen only from</span>
            <span class="c">// DataReceived event.</span>
        }
 
        <b>private void</b> <a id="b397501380c31dde" href="../../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">HandleConnectComplete</a>(<b>object</b> <span id="r10 rd" class="r10 r">sender</span>, <span class="i">EventArgs</span> <span id="r11 rd" class="r11 r">args</span>)
        {
            <span class="c">// No-OP. Once the negotiation messages are exchanged and the session gets into established state,</span>
            <span class="c">// it will take care of spawning the receive operation on the connected session</span>
            <span class="c">// There is however a caveat.</span>
            <span class="c">// A rouge remote server if it does not send the required negotiation data in the Connect Response,</span>
            <span class="c">// then the state machine can never get into the established state and the runspace can never get into a opened state</span>
            <span class="c">// Living with this for now.</span>
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> create
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> disconnect
        <b>internal override void</b> <a id="52477d3321b46d84" href="../../../R/52477d3321b46d84.html" target="n" data-glyph="74,1" class="i method">DisconnectAsync</a>()
        {
            <a href="#bc2db2da522293dc" class="i field">_transportManager</a>.<a href="../fanin/BaseTransportManager.cs.html#f3331593837e57e2" class="i method">DisconnectAsync</a>();
        }
 
        <b>private void</b> <a id="21c92e07ade91b9b" href="../../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">HandleDisconnectComplete</a>(<b>object</b> <span id="r12 rd" class="r12 r">sender</span>, <span class="i">EventArgs</span> <span id="r13 rd" class="r13 r">args</span>)
        {
            <span class="c">// Set statemachine event</span>
            <a href="../common/misc.cs.html#e012d9ffab9d7da0" class="t t">RemoteSessionStateMachineEventArgs</a> <span id="r14 rd" class="r14 r">disconnectCompletedArg</span> = <b>new</b> <a href="../common/misc.cs.html#77708abdda1be0a8" class="t constructor">RemoteSessionStateMachineEventArgs</a>(<a href="../common/misc.cs.html#75ac2ac4117af9a2" class="t t">RemoteSessionEvent</a>.<a href="../common/misc.cs.html#acf6786192b8c617" class="i field">DisconnectCompleted</a>);
            <a href="#32d33b5f48709bf2" class="i property">StateMachine</a>.<a href="clientremotesessionprotocolstatemachine.cs.html#0f71c1a2e194203d" class="i method">RaiseEvent</a>(<span class="r14 r">disconnectCompletedArg</span>);
        }
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> disconnect
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> RobustConnection events
 
        <b>private void</b> <a id="13e863d0d426d6aa" href="../../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">HandleRobustConnectionNotification</a>(<b>object</b> <span id="r15 rd" class="r15 r">sender</span>, <a href="../fanin/BaseTransportManager.cs.html#598698ed70e51507" class="t t">ConnectionStatusEventArgs</a> <span id="r16 rd" class="r16 r">e</span>)
        {
            <a href="../common/misc.cs.html#e012d9ffab9d7da0" class="t t">RemoteSessionStateMachineEventArgs</a> <span id="r17 rd" class="r17 r">eventArgument</span> = <b>null</b>;
            <b>switch</b> (<span class="r16 r">e</span>.<a href="../fanin/BaseTransportManager.cs.html#40c02c7ffd5fa7d4" class="i property">Notification</a>)
            {
                <b>case</b> <a href="../fanin/BaseTransportManager.cs.html#6ddc495529412646" class="t t">ConnectionStatus</a>.<a href="../fanin/BaseTransportManager.cs.html#f0d6555b08ab5f74" class="i field">AutoDisconnectStarting</a>:
                    <span class="r17 r">eventArgument</span> = <b>new</b> <a href="../common/misc.cs.html#77708abdda1be0a8" class="t constructor">RemoteSessionStateMachineEventArgs</a>(<a href="../common/misc.cs.html#75ac2ac4117af9a2" class="t t">RemoteSessionEvent</a>.<a href="../common/misc.cs.html#6081a8d6127fa9e9" class="i field">RCDisconnectStarted</a>);
                    <b>break</b>;
 
                <b>case</b> <a href="../fanin/BaseTransportManager.cs.html#6ddc495529412646" class="t t">ConnectionStatus</a>.<a href="../fanin/BaseTransportManager.cs.html#de98a76dc253e5fe" class="i field">AutoDisconnectSucceeded</a>:
                    <span class="r17 r">eventArgument</span> = <b>new</b> <span class="t">RemoteSessionStateMachineEventArgs</span>(<a href="../common/misc.cs.html#75ac2ac4117af9a2" class="t t">RemoteSessionEvent</a>.<a href="../common/misc.cs.html#acf6786192b8c617" class="i field">DisconnectCompleted</a>,
                        <b>new</b> <a href="../../../utils/RuntimeException.cs.html#e4538a388d78c143" class="t constructor">RuntimeException</a>(
                            <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">RCAutoDisconnectingError</span>,
                                <a href="#243e93e02f070707" class="i field">_session</a>.<a href="clientremotesession.cs.html#e8997fdb5a3c5f81" class="i property">RemoteRunspacePoolInternal</a>.<a href="RemoteRunspacePoolInternal.cs.html#adb799cd03979b7a" class="i property">ConnectionInfo</a>.<a href="../common/RunspaceConnectionInfo.cs.html#64143b41c05cd7ea" class="i property">ComputerName</a>)));
                    <b>break</b>;
 
                <b>case</b> <a href="../fanin/BaseTransportManager.cs.html#6ddc495529412646" class="t t">ConnectionStatus</a>.<a href="../fanin/BaseTransportManager.cs.html#8c22e95737ef7dd8" class="i field">InternalErrorAbort</a>:
                    <span class="r17 r">eventArgument</span> = <b>new</b> <a href="../common/misc.cs.html#77708abdda1be0a8" class="t constructor">RemoteSessionStateMachineEventArgs</a>(<a href="../common/misc.cs.html#75ac2ac4117af9a2" class="t t">RemoteSessionEvent</a>.<a href="../common/misc.cs.html#1389dea06ebf9587" class="i field">FatalError</a>);
                    <b>break</b>;
            }
 
            <b>if</b> (<span class="r17 r">eventArgument</span> != <b>null</b>)
            {
                <a href="#32d33b5f48709bf2" class="i property">StateMachine</a>.<a href="clientremotesessionprotocolstatemachine.cs.html#0f71c1a2e194203d" class="i method">RaiseEvent</a>(<span class="r17 r">eventArgument</span>);
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> reconnect
        <b>internal override void</b> <a id="b0d22e4727add6a4" href="../../../R/b0d22e4727add6a4.html" target="n" data-glyph="74,1" class="i method">ReconnectAsync</a>()
        {
            <a href="#bc2db2da522293dc" class="i field">_transportManager</a>.<a href="../fanin/BaseTransportManager.cs.html#c09916546be3d983" class="i method">ReconnectAsync</a>();
        }
 
        <b>private void</b> <a id="3567b2af4ab6f4cc" href="../../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">HandleReconnectComplete</a>(<b>object</b> <span id="r18 rd" class="r18 r">sender</span>, <span class="i">EventArgs</span> <span id="r19 rd" class="r19 r">args</span>)
        {
            <span class="c">// Set statemachine event</span>
            <a href="../common/misc.cs.html#e012d9ffab9d7da0" class="t t">RemoteSessionStateMachineEventArgs</a> <span id="r20 rd" class="r20 r">reconnectCompletedArg</span> = <b>new</b> <a href="../common/misc.cs.html#77708abdda1be0a8" class="t constructor">RemoteSessionStateMachineEventArgs</a>(<a href="../common/misc.cs.html#75ac2ac4117af9a2" class="t t">RemoteSessionEvent</a>.<a href="../common/misc.cs.html#19a7c9fca66697c2" class="i field">ReconnectCompleted</a>);
            <a href="#32d33b5f48709bf2" class="i property">StateMachine</a>.<a href="clientremotesessionprotocolstatemachine.cs.html#0f71c1a2e194203d" class="i method">RaiseEvent</a>(<span class="r20 r">reconnectCompletedArg</span>);
        }
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> reconnect
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> close
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Close the connection asynchronously.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal override void</b> <a id="09546a65c48b0902" href="../../../R/09546a65c48b0902.html" target="n" data-glyph="74,1" class="i method">CloseConnectionAsync</a>()
        {
            <b>lock</b> (<a href="#0640fa7b59bf25d2" class="i field">_syncObject</a>)
            {
                <b>if</b> (<a href="#78d6e935f92ae266" class="i field">_isCloseCalled</a>)
                {
                    <b>return</b>;
                }
 
                <a href="#bc2db2da522293dc" class="i field">_transportManager</a>.<a href="../fanin/BaseTransportManager.cs.html#8487786a35819f66" class="i method">CloseAsync</a>();
                <a href="#78d6e935f92ae266" class="i field">_isCloseCalled</a> = <b>true</b>;
            }
        }
 
        <b>private void</b> <a id="36b94b2d7992936e" href="../../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">HandleCloseComplete</a>(<b>object</b> <span id="r21 rd" class="r21 r">sender</span>, <span class="i">EventArgs</span> <span id="r22 rd" class="r22 r">args</span>)
        {
            <span class="c">// This event gets raised only when the connection is closed successfully.</span>
 
            <a href="../common/misc.cs.html#e012d9ffab9d7da0" class="t t">RemoteSessionStateMachineEventArgs</a> <span id="r23 rd" class="r23 r">closeCompletedArg</span> = <b>new</b> <a href="../common/misc.cs.html#77708abdda1be0a8" class="t constructor">RemoteSessionStateMachineEventArgs</a>(<a href="../common/misc.cs.html#75ac2ac4117af9a2" class="t t">RemoteSessionEvent</a>.<a href="../common/misc.cs.html#6fa9ce621d9e7aab" class="i field">CloseCompleted</a>);
            <a href="#ad0ab9cf6a29b328" class="i field">_stateMachine</a>.<a href="clientremotesessionprotocolstatemachine.cs.html#0f71c1a2e194203d" class="i method">RaiseEvent</a>(<span class="r23 r">closeCompletedArg</span>);
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> close
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> negotiation
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Sends the negotiation package asynchronously.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal override void</b> <a id="b486221b70a4c914" href="../../../R/b486221b70a4c914.html" target="n" data-glyph="74,1" class="i method">SendNegotiationAsync</a>(<a href="../common/misc.cs.html#278607b7d2274446" class="t t">RemoteSessionState</a> <span id="r24 rd" class="r24 r">sessionState</span>)
        {
            <span class="c">// This state change is made before the call to CreateAsync to ensure the state machine</span>
            <span class="c">// is prepared for a NegotiationReceived response.  Otherwise a race condition can</span>
            <span class="c">// occur when the transport NegotiationReceived arrives too soon, breaking the session.</span>
            <span class="c">// This race condition was observed for OutOfProc transport when reusing the OutOfProc process.</span>
            <span class="c">// this will change StateMachine to NegotiationSent.</span>
            <a href="../common/misc.cs.html#e012d9ffab9d7da0" class="t t">RemoteSessionStateMachineEventArgs</a> <span id="r25 rd" class="r25 r">negotiationSendCompletedArg</span> =
                <b>new</b> <a href="../common/misc.cs.html#77708abdda1be0a8" class="t constructor">RemoteSessionStateMachineEventArgs</a>(<a href="../common/misc.cs.html#75ac2ac4117af9a2" class="t t">RemoteSessionEvent</a>.<a href="../common/misc.cs.html#af2b93f6859b4283" class="i field">NegotiationSendCompleted</a>);
            <a href="#ad0ab9cf6a29b328" class="i field">_stateMachine</a>.<a href="clientremotesessionprotocolstatemachine.cs.html#0f71c1a2e194203d" class="i method">RaiseEvent</a>(<span class="r25 r">negotiationSendCompletedArg</span>);
 
            <b>if</b> (<span class="r24 r">sessionState</span> == <a href="../common/misc.cs.html#278607b7d2274446" class="t t">RemoteSessionState</a>.<a href="../common/misc.cs.html#02873a55aa6133c3" class="i field">NegotiationSending</a>)
            {
                <a href="#bc2db2da522293dc" class="i field">_transportManager</a>.<a href="../fanin/BaseTransportManager.cs.html#647d3fc66fbadafe" class="i method">CreateAsync</a>();
            }
            <b>else</b> <b>if</b> (<span class="r24 r">sessionState</span> == <a href="../common/misc.cs.html#278607b7d2274446" class="t t">RemoteSessionState</a>.<a href="../common/misc.cs.html#2603336a7a6ceec5" class="i field">NegotiationSendingOnConnect</a>)
            {
                <a href="#bc2db2da522293dc" class="i field">_transportManager</a>.<a href="../fanin/BaseTransportManager.cs.html#99a709b2ef3c3bf4" class="i">ConnectCompleted</a> += <span class="i">HandleConnectComplete</span>;
                <a href="#bc2db2da522293dc" class="i field">_transportManager</a>.<a href="../fanin/BaseTransportManager.cs.html#c25dbbf00143cb5e" class="i method">ConnectAsync</a>();
            }
            <b>else</b>
            {
                <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<b>false</b>, <span class="s">&quot;SendNegotiationAsync called in unexpected session state&quot;</span>);
            }
        }
 
        <b>internal override event</b> <span class="i">EventHandler</span>&lt;<a href="../common/misc.cs.html#5ec41d83163c4dae" class="t t">RemoteSessionNegotiationEventArgs</a>&gt; <a id="18f9b3f7605b0391" href="../../../R/18f9b3f7605b0391.html" target="n" data-glyph="32,1" class="i">NegotiationReceived</a>;
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> negotiation
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> state change
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This event indicates that the connection state has changed.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal override event</b> <span class="i">EventHandler</span>&lt;<a href="../common/misc.cs.html#7e5c4afe334f8fc9" class="t t">RemoteSessionStateEventArgs</a>&gt; <a id="13fc776f6e8d6c6f" href="../../../R/13fc776f6e8d6c6f.html" target="n" data-glyph="32,1" class="i">ConnectionStateChanged</a>;
 
        <b>private void</b> <a id="e0177d2d5ab55ec2" href="../../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">HandleStateChanged</a>(<b>object</b> <span id="r26 rd" class="r26 r">sender</span>, <a href="../common/misc.cs.html#7e5c4afe334f8fc9" class="t t">RemoteSessionStateEventArgs</a> <span id="r27 rd" class="r27 r">arg</span>)
        {
            <b>if</b> (<span class="r27 r">arg</span> == <b>null</b>)
            {
                <b>throw</b> <a href="../../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../../../utils/MshTraceSource.cs.html#fbe67220ad7522a0" class="i method">NewArgumentNullException</a>(<b>nameof</b>(<span class="r27 r">arg</span>));
            }
 
            <span class="c">// Enqueue session related negotiation packets first</span>
            <b>if</b> ((<span class="r27 r">arg</span>.<a href="../common/misc.cs.html#973536ebdade9102" class="i property">SessionStateInfo</a>.<a href="../common/misc.cs.html#fe0ec9ba677d85ef" class="i property">State</a> == <a href="../common/misc.cs.html#278607b7d2274446" class="t t">RemoteSessionState</a>.<a href="../common/misc.cs.html#02873a55aa6133c3" class="i field">NegotiationSending</a>) || (<span class="r27 r">arg</span>.<a href="../common/misc.cs.html#973536ebdade9102" class="i property">SessionStateInfo</a>.<a href="../common/misc.cs.html#fe0ec9ba677d85ef" class="i property">State</a> == <a href="../common/misc.cs.html#278607b7d2274446" class="t t">RemoteSessionState</a>.<a href="../common/misc.cs.html#2603336a7a6ceec5" class="i field">NegotiationSendingOnConnect</a>))
            {
                <a href="#fc2641352e61f7c0" class="i method">HandleNegotiationSendingStateChange</a>();
            }
 
            <span class="c">// this will enable top-layers to enqueue any packets during NegotiationSending and</span>
            <span class="c">// during other states.</span>
            <a href="#13fc776f6e8d6c6f" class="i">ConnectionStateChanged</a>.<span class="i">SafeInvoke</span>(<a href="#eff965b51f1e9c1d" class="k">this</a>, <span class="r27 r">arg</span>);
 
            <b>if</b> ((<span class="r27 r">arg</span>.<a href="../common/misc.cs.html#973536ebdade9102" class="i property">SessionStateInfo</a>.<a href="../common/misc.cs.html#fe0ec9ba677d85ef" class="i property">State</a> == <a href="../common/misc.cs.html#278607b7d2274446" class="t t">RemoteSessionState</a>.<a href="../common/misc.cs.html#02873a55aa6133c3" class="i field">NegotiationSending</a>) || (<span class="r27 r">arg</span>.<a href="../common/misc.cs.html#973536ebdade9102" class="i property">SessionStateInfo</a>.<a href="../common/misc.cs.html#fe0ec9ba677d85ef" class="i property">State</a> == <a href="../common/misc.cs.html#278607b7d2274446" class="t t">RemoteSessionState</a>.<a href="../common/misc.cs.html#2603336a7a6ceec5" class="i field">NegotiationSendingOnConnect</a>))
            {
                <a href="#b486221b70a4c914" class="i method">SendNegotiationAsync</a>(<span class="r27 r">arg</span>.<a href="../common/misc.cs.html#973536ebdade9102" class="i property">SessionStateInfo</a>.<a href="../common/misc.cs.html#fe0ec9ba677d85ef" class="i property">State</a>);
            }
 
            <span class="c">// once session is established.. start receiving data (if not already done and only apples to wsmanclientsessionTM)</span>
            <b>if</b> (<span class="r27 r">arg</span>.<a href="../common/misc.cs.html#973536ebdade9102" class="i property">SessionStateInfo</a>.<a href="../common/misc.cs.html#fe0ec9ba677d85ef" class="i property">State</a> == <a href="../common/misc.cs.html#278607b7d2274446" class="t t">RemoteSessionState</a>.<a href="../common/misc.cs.html#8d4705ab67b3b753" class="i field">Established</a>)
            {
                <a href="../fanin/WSManTransportManager.cs.html#693b43214373ab1e" class="t t">WSManClientSessionTransportManager</a> <span id="r28 rd" class="r28 r">tm</span> = <a href="#bc2db2da522293dc" class="i field">_transportManager</a> <b>as</b> <a href="../fanin/WSManTransportManager.cs.html#693b43214373ab1e" class="t t">WSManClientSessionTransportManager</a>;
                <b>if</b> (<span class="r28 r">tm</span> != <b>null</b>)
                {
                    <span class="r28 r">tm</span>.<a href="../fanin/WSManTransportManager.cs.html#df0f1d6179928fe0" class="i method">AdjustForProtocolVariations</a>(<a href="#243e93e02f070707" class="i field">_session</a>.<a href="clientremotesession.cs.html#d2df597c6a77cd17" class="i property">ServerProtocolVersion</a>);
                    <span class="r28 r">tm</span>.<a href="../fanin/WSManTransportManager.cs.html#7188a5e1aa5f5bf2" class="i method">StartReceivingData</a>();
                }
            }
 
            <span class="c">// Close the transport manager only after powershell&#39;s close their transports</span>
            <span class="c">// Powershell&#39;s close their transport using the ConnectionStateChanged event notification.</span>
            <b>if</b> (<span class="r27 r">arg</span>.<a href="../common/misc.cs.html#973536ebdade9102" class="i property">SessionStateInfo</a>.<a href="../common/misc.cs.html#fe0ec9ba677d85ef" class="i property">State</a> == <a href="../common/misc.cs.html#278607b7d2274446" class="t t">RemoteSessionState</a>.<a href="../common/misc.cs.html#5e7bbe4ce8336771" class="i field">ClosingConnection</a>)
            {
                <a href="#09546a65c48b0902" class="i method">CloseConnectionAsync</a>();
            }
 
            <span class="c">// process disconnect</span>
            <b>if</b> (<span class="r27 r">arg</span>.<a href="../common/misc.cs.html#973536ebdade9102" class="i property">SessionStateInfo</a>.<a href="../common/misc.cs.html#fe0ec9ba677d85ef" class="i property">State</a> == <a href="../common/misc.cs.html#278607b7d2274446" class="t t">RemoteSessionState</a>.<a href="../common/misc.cs.html#71f847fefe34fd8a" class="i field">Disconnecting</a>)
            {
                <a href="#52477d3321b46d84" class="i method">DisconnectAsync</a>();
            }
 
            <span class="c">// process reconnect</span>
            <b>if</b> (<span class="r27 r">arg</span>.<a href="../common/misc.cs.html#973536ebdade9102" class="i property">SessionStateInfo</a>.<a href="../common/misc.cs.html#fe0ec9ba677d85ef" class="i property">State</a> == <a href="../common/misc.cs.html#278607b7d2274446" class="t t">RemoteSessionState</a>.<a href="../common/misc.cs.html#183c36493d939baa" class="i field">Reconnecting</a>)
            {
                <a href="#b0d22e4727add6a4" class="i method">ReconnectAsync</a>();
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Clubing negotiation packet + runspace creation and then doing transportManager.ConnectAsync().</span>
        <span class="c">///</span><span class="c"> This will save us 2 network calls by doing all the work in one network call.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private void</b> <a id="fc2641352e61f7c0" href="../../../R/fc2641352e61f7c0.html" target="n" data-glyph="76,1" class="i method">HandleNegotiationSendingStateChange</a>()
        {
            <a href="../common/WireDataFormat/RemoteSessionCapability.cs.html#410d0e97ea446fd9" class="t t">RemoteSessionCapability</a> <span id="r29 rd" class="r29 r">clientCapability</span> = <a href="#243e93e02f070707" class="i field">_session</a>.<a href="clientremotesession.cs.html#75e3905f04f086e2" class="i property">Context</a>.<a href="clientremotesession.cs.html#61da171c8cd63a02" class="i property">ClientCapability</a>;
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r29 r">clientCapability</span>.<a href="../common/WireDataFormat/RemoteSessionCapability.cs.html#52b37865634e104b" class="i property">RemotingDestination</a> == <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#45c72046001f69b8" class="t t">RemotingDestination</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#061ac750e6d280da" class="i field">Server</a>, <span class="s">&quot;Expected clientCapability.RemotingDestination == RemotingDestination.Server&quot;</span>);
 
            <span class="c">// Encode and send the negotiation reply</span>
            <a href="../common/WireDataFormat/RemotingDataObject.cs.html#3856dcbea775cab8" class="t t">RemoteDataObject</a> <span id="r30 rd" class="r30 r">data</span> = <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#88b19073d823ce05" class="t t">RemotingEncoder</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#9d8299131960d30e" class="i method">GenerateClientSessionCapability</a>(
                                        <span class="r29 r">clientCapability</span>, <a href="#243e93e02f070707" class="i field">_session</a>.<a href="clientremotesession.cs.html#e8997fdb5a3c5f81" class="i property">RemoteRunspacePoolInternal</a>.<a href="../../hostifaces/RunspacePoolInternal.cs.html#76aedcc22e17e7e5" class="i property">InstanceId</a>);
            <a href="../common/WireDataFormat/RemotingDataObject.cs.html#ca4629603c976aab" class="t t">RemoteDataObject</a>&lt;<a href="../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt; <span id="r31 rd" class="r31 r">dataAsPSObject</span> = <a href="../common/WireDataFormat/RemotingDataObject.cs.html#ca4629603c976aab" class="t t">RemoteDataObject</a>&lt;<a href="../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt;.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#892b04684918b3a0" class="i method">CreateFrom</a>(
                <span class="r30 r">data</span>.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#36fad9981dff9219" class="i property">Destination</a>, <span class="r30 r">data</span>.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#97d7621b092d013f" class="i property">DataType</a>, <span class="r30 r">data</span>.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#df5fe91d15e5ba71" class="i property">RunspacePoolId</a>, <span class="r30 r">data</span>.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#767aea3474afdc8e" class="i property">PowerShellId</a>, (<a href="../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>)<span class="r30 r">data</span>.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#d13e5d3038741f3e" class="i property">Data</a>);
            <a href="#bc2db2da522293dc" class="i field">_transportManager</a>.<a href="../fanin/BaseTransportManager.cs.html#f8317afa9f690e3b" class="i property">DataToBeSentCollection</a>.<a href="../fanin/PriorityCollection.cs.html#82212f989f1c53a3" class="i method">Add</a>&lt;<a href="../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt;(<span class="r31 r">dataAsPSObject</span>);
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> state change
 
        <b>internal override</b> <a href="clientremotesessionprotocolstatemachine.cs.html#039f4a3a46a31204" class="t t">ClientRemoteSessionDSHandlerStateMachine</a> <a id="32d33b5f48709bf2" href="../../../R/32d33b5f48709bf2.html" target="n" data-glyph="104,1" class="i property">StateMachine</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#ad0ab9cf6a29b328" class="i field">_stateMachine</a>;
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> URI Redirection
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Transport reported an error saying that uri is redirected. This method</span>
        <span class="c">///</span><span class="c"> will perform the redirection to the new URI by doing the following:</span>
        <span class="c">///</span><span class="c"> 1. Close the current transport manager to clean resources</span>
        <span class="c">///</span><span class="c"> 2. Raise a warning that URI is getting redirected.</span>
        <span class="c">///</span><span class="c"> 3. Using the new URI, ask the same transport manager to redirect</span>
        <span class="c">///</span><span class="c"> Step 1 is performed here. Step2-3 is performed in another method.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r32 r">newURIString</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">ArgumentNullException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> newURIString is a null reference.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">UriFormatException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> uriString is empty.</span>
        <span class="c">///</span><span class="c"> The scheme specified in uriString is invalid.</span>
        <span class="c">///</span><span class="c"> uriString contains too many slashes.</span>
        <span class="c">///</span><span class="c"> The password specified in uriString is invalid.</span>
        <span class="c">///</span><span class="c"> The host name specified in uriString is invalid.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>private void</b> <a id="6b9ad0185eb9d58b" href="../../../R/6b9ad0185eb9d58b.html" target="n" data-glyph="76,1" class="i method">PerformURIRedirection</a>(<b>string</b> <span id="r32 rd" class="r32 r">newURIString</span>)
        {
            <a href="#1e07e2effabc46c8" class="i field">_redirectUri</a> = <b>new</b> <span class="i">Uri</span>(<span class="r32 r">newURIString</span>);
 
            <span class="c">// make sure connection is not closed while we are handling the redirection.</span>
            <b>lock</b> (<a href="#0640fa7b59bf25d2" class="i field">_syncObject</a>)
            {
                <span class="c">// if connection is closed by the user..no need to redirect</span>
                <b>if</b> (<a href="#78d6e935f92ae266" class="i field">_isCloseCalled</a>)
                {
                    <b>return</b>;
                }
 
                <span class="c">// clear our current close complete &amp; Error handlers</span>
                <a href="#bc2db2da522293dc" class="i field">_transportManager</a>.<a href="../fanin/BaseTransportManager.cs.html#a237a80d5d4b9bee" class="i">CloseCompleted</a> -= <span class="i">HandleCloseComplete</span>;
                <a href="#bc2db2da522293dc" class="i field">_transportManager</a>.<a href="../fanin/BaseTransportManager.cs.html#85d6a6f2ebae43ff" class="i">WSManTransportErrorOccured</a> -= <span class="i">HandleTransportError</span>;
 
                <span class="c">// perform other steps only after transport manager is closed.</span>
                <a href="#bc2db2da522293dc" class="i field">_transportManager</a>.<a href="../fanin/BaseTransportManager.cs.html#a237a80d5d4b9bee" class="i">CloseCompleted</a> += <span class="i">HandleTransportCloseCompleteForRedirection</span>;
                <span class="c">// Handle errors happened while redirecting differently..We need to reset the</span>
                <span class="c">// original handlers in this case.</span>
                <a href="#bc2db2da522293dc" class="i field">_transportManager</a>.<a href="../fanin/BaseTransportManager.cs.html#85d6a6f2ebae43ff" class="i">WSManTransportErrorOccured</a> += <span class="i">HandleTransportErrorForRedirection</span>;
 
                <a href="#bc2db2da522293dc" class="i field">_transportManager</a>.<a href="../fanin/BaseTransportManager.cs.html#6ed67e5c9c8c26bc" class="i method">PrepareForRedirection</a>();
            }
        }
 
        <b>private void</b> <a id="2ea2a5e9520505f4" href="../../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">HandleTransportCloseCompleteForRedirection</a>(<b>object</b> <span id="r33 rd" class="r33 r">source</span>, <span class="i">EventArgs</span> <span id="r34 rd" class="r34 r">args</span>)
        {
            <a href="#bc2db2da522293dc" class="i field">_transportManager</a>.<a href="../fanin/BaseTransportManager.cs.html#a237a80d5d4b9bee" class="i">CloseCompleted</a> -= <span class="i">HandleTransportCloseCompleteForRedirection</span>;
            <a href="#bc2db2da522293dc" class="i field">_transportManager</a>.<a href="../fanin/BaseTransportManager.cs.html#85d6a6f2ebae43ff" class="i">WSManTransportErrorOccured</a> -= <span class="i">HandleTransportErrorForRedirection</span>;
 
            <span class="c">// reattach the close complete and error handlers</span>
            <a href="#bc2db2da522293dc" class="i field">_transportManager</a>.<a href="../fanin/BaseTransportManager.cs.html#a237a80d5d4b9bee" class="i">CloseCompleted</a> += <span class="i">HandleCloseComplete</span>;
            <a href="#bc2db2da522293dc" class="i field">_transportManager</a>.<a href="../fanin/BaseTransportManager.cs.html#85d6a6f2ebae43ff" class="i">WSManTransportErrorOccured</a> += <span class="i">HandleTransportError</span>;
 
            <span class="i">PerformURIRedirectionStep2</span>(<a href="#1e07e2effabc46c8" class="i field">_redirectUri</a>);
        }
 
        <b>private void</b> <a id="aa4ce7b203d01030" href="../../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">HandleTransportErrorForRedirection</a>(<b>object</b> <span id="r35 rd" class="r35 r">sender</span>, <a href="../fanin/BaseTransportManager.cs.html#7e70b34f9332dfcd" class="t t">TransportErrorOccuredEventArgs</a> <span id="r36 rd" class="r36 r">e</span>)
        {
            <a href="#bc2db2da522293dc" class="i field">_transportManager</a>.<a href="../fanin/BaseTransportManager.cs.html#a237a80d5d4b9bee" class="i">CloseCompleted</a> -= <span class="i">HandleTransportCloseCompleteForRedirection</span>;
            <a href="#bc2db2da522293dc" class="i field">_transportManager</a>.<a href="../fanin/BaseTransportManager.cs.html#85d6a6f2ebae43ff" class="i">WSManTransportErrorOccured</a> -= <span class="i">HandleTransportErrorForRedirection</span>;
 
            <span class="c">// reattach the close complete and error handlers</span>
            <a href="#bc2db2da522293dc" class="i field">_transportManager</a>.<a href="../fanin/BaseTransportManager.cs.html#a237a80d5d4b9bee" class="i">CloseCompleted</a> += <span class="i">HandleCloseComplete</span>;
            <a href="#bc2db2da522293dc" class="i field">_transportManager</a>.<a href="../fanin/BaseTransportManager.cs.html#85d6a6f2ebae43ff" class="i">WSManTransportErrorOccured</a> += <span class="i">HandleTransportError</span>;
 
            <a href="#e04bcce54a63b00c" class="i method">HandleTransportError</a>(<span class="r35 r">sender</span>, <span class="r36 r">e</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This is step 2 of URI redirection. This is called after the current transport manager</span>
        <span class="c">///</span><span class="c"> is closed. This is usually called from the close complete callback.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r37 r">newURI</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>private void</b> <a id="a86d35451bd2123e" href="../../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">PerformURIRedirectionStep2</a>(<span class="i n">System</span>.<span class="i">Uri</span> <span id="r37 rd" class="r37 r">newURI</span>)
        {
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r37 r">newURI</span> != <b>null</b>, <span class="s">&quot;Uri cannot be null&quot;</span>);
            <b>lock</b> (<a href="#0640fa7b59bf25d2" class="i field">_syncObject</a>)
            {
                <span class="c">// if connection is closed by the user..no need to redirect</span>
                <b>if</b> (<a href="#78d6e935f92ae266" class="i field">_isCloseCalled</a>)
                {
                    <b>return</b>;
                }
 
                <span class="c">// raise warning to report the redirection</span>
                <a href="#79ef92b54a630414" class="i field">_uriRedirectionHandler</a>?.<span class="i">Invoke</span>(<span class="r37 r">newURI</span>);
 
                <span class="c">// start a new connection</span>
                <a href="#bc2db2da522293dc" class="i field">_transportManager</a>.<span class="i">Redirect</span>(<span class="r37 r">newURI</span>, <a href="#cc7cad8febcc764d" class="i field">_connectionInfo</a>);
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> data handling
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Handler which handles transport errors.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r38 r">sender</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r39 r">e</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="e04bcce54a63b00c" href="../../../R/e04bcce54a63b00c.html" target="n" data-glyph="74,1" class="i method">HandleTransportError</a>(<b>object</b> <span id="r38 rd" class="r38 r">sender</span>, <a href="../fanin/BaseTransportManager.cs.html#7e70b34f9332dfcd" class="t t">TransportErrorOccuredEventArgs</a> <span id="r39 rd" class="r39 r">e</span>)
        {
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r39 r">e</span> != <b>null</b>, <span class="s">&quot;HandleTransportError expects non-null eventargs&quot;</span>);
            <span class="c">// handle uri redirections</span>
            <a href="../common/remotingexceptions.cs.html#e8fb45bc6d3d0b85" class="t t">PSRemotingTransportRedirectException</a> <span id="r40 rd" class="r40 r">redirectException</span> = <span class="r39 r">e</span>.<a href="../fanin/BaseTransportManager.cs.html#f82124202b7ff8f0" class="i property">Exception</a> <b>as</b> <a href="../common/remotingexceptions.cs.html#e8fb45bc6d3d0b85" class="t t">PSRemotingTransportRedirectException</a>;
            <b>if</b> ((<span class="r40 r">redirectException</span> != <b>null</b>) &amp;&amp; (<a href="#869009e966405d36" class="i field">_maxUriRedirectionCount</a> &gt; 0))
            {
                <span class="i">Exception</span> <span id="r41 rd" class="r41 r">exception</span> = <b>null</b>;
 
                <b>try</b>
                {
                    <span class="c">// honor max redirection count given by the user.</span>
                    <a href="#869009e966405d36" class="i field">_maxUriRedirectionCount</a>--;
                    <a href="#6b9ad0185eb9d58b" class="i method">PerformURIRedirection</a>(<span class="r40 r">redirectException</span>.<a href="../common/remotingexceptions.cs.html#e09b4377ed2ad24e" class="i property">RedirectLocation</a>);
                    <b>return</b>;
                }
                <b>catch</b> (<span class="i">ArgumentNullException</span> <span id="r42 rd" class="r42 r">argumentException</span>)
                {
                    <span class="r41 r">exception</span> = <span class="r42 r">argumentException</span>;
                }
                <b>catch</b> (<span class="i">UriFormatException</span> <span id="r43 rd" class="r43 r">uriFormatException</span>)
                {
                    <span class="r41 r">exception</span> = <span class="r43 r">uriFormatException</span>;
                }
                <span class="c">// if we are here, there must be an exception constructing a uri</span>
                <b>if</b> (<span class="r41 r">exception</span> != <b>null</b>)
                {
                    <a href="../common/remotingexceptions.cs.html#0bb8687f97d91059" class="t t">PSRemotingTransportException</a> <span id="r44 rd" class="r44 r">newException</span> =
                        <b>new</b> <span class="t">PSRemotingTransportException</span>(<a href="../common/remotingexceptions.cs.html#a969589d7508bf05" class="t t">PSRemotingErrorId</a>.<a href="../common/remotingexceptions.cs.html#c59b0ee3a0a39286" class="i field">RedirectedURINotWellFormatted</a>, <span class="i">RemotingErrorIdStrings</span>.<span class="i">RedirectedURINotWellFormatted</span>,
                            <a href="#243e93e02f070707" class="i field">_session</a>.<a href="clientremotesession.cs.html#75e3905f04f086e2" class="i property">Context</a>.<a href="clientremotesession.cs.html#4691fd2d7339b303" class="i property">RemoteAddress</a>.<span class="i">OriginalString</span>,
                            <span class="r40 r">redirectException</span>.<a href="../common/remotingexceptions.cs.html#e09b4377ed2ad24e" class="i property">RedirectLocation</a>);
                    <span class="r44 r">newException</span>.<a href="../common/remotingexceptions.cs.html#9008a0cafbbfa4d3" class="i property">TransportMessage</a> = <span class="r39 r">e</span>.<a href="../fanin/BaseTransportManager.cs.html#f82124202b7ff8f0" class="i property">Exception</a>.<a href="../common/remotingexceptions.cs.html#9008a0cafbbfa4d3" class="i property">TransportMessage</a>;
                    <span class="r39 r">e</span>.<a href="../fanin/BaseTransportManager.cs.html#f82124202b7ff8f0" class="i property">Exception</a> = <span class="r44 r">newException</span>;
                }
            }
 
            <a href="../common/misc.cs.html#75ac2ac4117af9a2" class="t t">RemoteSessionEvent</a> <span id="r45 rd" class="r45 r">sessionEvent</span> = <a href="../common/misc.cs.html#75ac2ac4117af9a2" class="t t">RemoteSessionEvent</a>.<a href="../common/misc.cs.html#a3cf592c2b4f317e" class="i field">ConnectFailed</a>;
 
            <b>switch</b> (<span class="r39 r">e</span>.<a href="../fanin/BaseTransportManager.cs.html#15ff1bff6090f5d7" class="i property">ReportingTransportMethod</a>)
            {
                <b>case</b> <a href="../fanin/BaseTransportManager.cs.html#33678df914ca9daf" class="t t">TransportMethodEnum</a>.<a href="../fanin/BaseTransportManager.cs.html#a8019a6497e609cf" class="i field">CreateShellEx</a>:
                    <span class="r45 r">sessionEvent</span> = <a href="../common/misc.cs.html#75ac2ac4117af9a2" class="t t">RemoteSessionEvent</a>.<a href="../common/misc.cs.html#a3cf592c2b4f317e" class="i field">ConnectFailed</a>;
                    <b>break</b>;
                <b>case</b> <a href="../fanin/BaseTransportManager.cs.html#33678df914ca9daf" class="t t">TransportMethodEnum</a>.<a href="../fanin/BaseTransportManager.cs.html#5ae525a3ca59a711" class="i field">SendShellInputEx</a>:
                <b>case</b> <a href="../fanin/BaseTransportManager.cs.html#33678df914ca9daf" class="t t">TransportMethodEnum</a>.<a href="../fanin/BaseTransportManager.cs.html#431d95f3744e9b1c" class="i field">CommandInputEx</a>:
                    <span class="r45 r">sessionEvent</span> = <a href="../common/misc.cs.html#75ac2ac4117af9a2" class="t t">RemoteSessionEvent</a>.<a href="../common/misc.cs.html#dd3d9d5b5442e94d" class="i field">SendFailed</a>;
                    <b>break</b>;
                <b>case</b> <a href="../fanin/BaseTransportManager.cs.html#33678df914ca9daf" class="t t">TransportMethodEnum</a>.<a href="../fanin/BaseTransportManager.cs.html#c91edb639e1ae62a" class="i field">ReceiveShellOutputEx</a>:
                <b>case</b> <a href="../fanin/BaseTransportManager.cs.html#33678df914ca9daf" class="t t">TransportMethodEnum</a>.<a href="../fanin/BaseTransportManager.cs.html#1aa4ae0cf31f0f4c" class="i field">ReceiveCommandOutputEx</a>:
                    <span class="r45 r">sessionEvent</span> = <a href="../common/misc.cs.html#75ac2ac4117af9a2" class="t t">RemoteSessionEvent</a>.<a href="../common/misc.cs.html#7559d0a1c791c0c1" class="i field">ReceiveFailed</a>;
                    <b>break</b>;
                <b>case</b> <a href="../fanin/BaseTransportManager.cs.html#33678df914ca9daf" class="t t">TransportMethodEnum</a>.<a href="../fanin/BaseTransportManager.cs.html#2cc9ee1cdce7fca6" class="i field">CloseShellOperationEx</a>:
                    <span class="r45 r">sessionEvent</span> = <a href="../common/misc.cs.html#75ac2ac4117af9a2" class="t t">RemoteSessionEvent</a>.<a href="../common/misc.cs.html#5e267fbc67921ad8" class="i field">CloseFailed</a>;
                    <b>break</b>;
                <b>case</b> <a href="../fanin/BaseTransportManager.cs.html#33678df914ca9daf" class="t t">TransportMethodEnum</a>.<a href="../fanin/BaseTransportManager.cs.html#e160f65b31655451" class="i field">DisconnectShellEx</a>:
                    <span class="r45 r">sessionEvent</span> = <a href="../common/misc.cs.html#75ac2ac4117af9a2" class="t t">RemoteSessionEvent</a>.<a href="../common/misc.cs.html#eccec87cecd536cc" class="i field">DisconnectFailed</a>;
                    <b>break</b>;
                <b>case</b> <a href="../fanin/BaseTransportManager.cs.html#33678df914ca9daf" class="t t">TransportMethodEnum</a>.<a href="../fanin/BaseTransportManager.cs.html#f540cc47457e7954" class="i field">ReconnectShellEx</a>:
                    <span class="r45 r">sessionEvent</span> = <a href="../common/misc.cs.html#75ac2ac4117af9a2" class="t t">RemoteSessionEvent</a>.<a href="../common/misc.cs.html#c9bdaeea7b86fc2c" class="i field">ReconnectFailed</a>;
                    <b>break</b>;
            }
 
            <a href="../common/misc.cs.html#e012d9ffab9d7da0" class="t t">RemoteSessionStateMachineEventArgs</a> <span id="r46 rd" class="r46 r">errorArgs</span> =
                <b>new</b> <span class="t">RemoteSessionStateMachineEventArgs</span>(<span class="r45 r">sessionEvent</span>, <span class="r39 r">e</span>.<a href="../fanin/BaseTransportManager.cs.html#f82124202b7ff8f0" class="i property">Exception</a>);
            <a href="#ad0ab9cf6a29b328" class="i field">_stateMachine</a>.<a href="clientremotesessionprotocolstatemachine.cs.html#0f71c1a2e194203d" class="i method">RaiseEvent</a>(<span class="r46 r">errorArgs</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Dispatches data when it arrives from the input queue.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r47 r">sender</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r48 r">dataArg</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> arg which contains the data received from input queue</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="cdfa210f95a9059a" href="../../../R/../../0000000000.html" target="n" data-glyph="74,1" class="i method">DispatchInputQueueData</a>(<b>object</b> <span id="r47 rd" class="r47 r">sender</span>, <a href="../common/misc.cs.html#5953d27b0d5ec137" class="t t">RemoteDataEventArgs</a> <span id="r48 rd" class="r48 r">dataArg</span>)
        {
            <b>if</b> (<span class="r48 r">dataArg</span> == <b>null</b>)
            {
                <b>throw</b> <a href="../../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../../../utils/MshTraceSource.cs.html#fbe67220ad7522a0" class="i method">NewArgumentNullException</a>(<b>nameof</b>(<span class="r48 r">dataArg</span>));
            }
 
            <a href="../common/WireDataFormat/RemotingDataObject.cs.html#ca4629603c976aab" class="t t">RemoteDataObject</a>&lt;<a href="../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt; <span id="r49 rd" class="r49 r">rcvdData</span> = <span class="r48 r">dataArg</span>.<a href="../common/misc.cs.html#38ed693bebe3d7fd" class="i property">ReceivedData</a>;
 
            <b>if</b> (<span class="r49 r">rcvdData</span> == <b>null</b>)
            {
                <b>throw</b> <a href="../../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../../../utils/MshTraceSource.cs.html#fed5f40dc0075d41" class="i method">NewArgumentException</a>(<b>nameof</b>(<span class="r48 r">dataArg</span>));
            }
 
            <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#45c72046001f69b8" class="t t">RemotingDestination</a> <span id="r50 rd" class="r50 r">destination</span> = <span class="r49 r">rcvdData</span>.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#36fad9981dff9219" class="i property">Destination</a>;
 
            <b>if</b> ((<span class="r50 r">destination</span> &amp; <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#45c72046001f69b8" class="t t">RemotingDestination</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#5e2f9f14c9ab7c84" class="i field">Client</a>) != <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#45c72046001f69b8" class="t t">RemotingDestination</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#5e2f9f14c9ab7c84" class="i field">Client</a>)
            {
                <b>throw</b> <b>new</b> <span class="t">PSRemotingDataStructureException</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">RemotingDestinationNotForMe</span>, <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#45c72046001f69b8" class="t t">RemotingDestination</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#5e2f9f14c9ab7c84" class="i field">Client</a>, <span class="r50 r">destination</span>);
            }
 
            <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#1d73dff2a8d6a0bf" class="t t">RemotingTargetInterface</a> <span id="r51 rd" class="r51 r">targetInterface</span> = <span class="r49 r">rcvdData</span>.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#6975a2b0635b9f80" class="i property">TargetInterface</a>;
            <b>switch</b> (<span class="r51 r">targetInterface</span>)
            {
                <b>case</b> <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#1d73dff2a8d6a0bf" class="t t">RemotingTargetInterface</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#8b83aadf9f585adb" class="i field">Session</a>:
                    {
                        <span class="c">// Messages for session can cause statemachine state to change.</span>
                        <span class="c">// These messages are first processed by Sessiondata structure handler and depending</span>
                        <span class="c">// on the type of message, appropriate event is raised in state machine</span>
                        <a href="#59833ed775337235" class="i method">ProcessSessionMessages</a>(<span class="r48 r">dataArg</span>);
                        <b>break</b>;
                    }
 
                <b>case</b> <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#1d73dff2a8d6a0bf" class="t t">RemotingTargetInterface</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#405ccc8b1bd2a170" class="i field">RunspacePool</a>:
                <b>case</b> <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#1d73dff2a8d6a0bf" class="t t">RemotingTargetInterface</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#f4078f88b2ce5495" class="i field">PowerShell</a>:
                    <span class="c">// Non Session messages do not change the state of the statemachine.</span>
                    <span class="c">// However instead of forwarding them to Runspace/pipeline here, an</span>
                    <span class="c">// event is raised in state machine which verified that state is</span>
                    <span class="c">// suitable for accepting these messages. if state is suitable statemachine</span>
                    <span class="c">// will call DoMessageForwading which will forward the messages appropriately</span>
                    <a href="../common/misc.cs.html#e012d9ffab9d7da0" class="t t">RemoteSessionStateMachineEventArgs</a> <span id="r52 rd" class="r52 r">msgRcvArg</span> = <b>new</b> <a href="../common/misc.cs.html#d6c2cb8af807b450" class="t constructor">RemoteSessionStateMachineEventArgs</a>(<a href="../common/misc.cs.html#75ac2ac4117af9a2" class="t t">RemoteSessionEvent</a>.<a href="../common/misc.cs.html#f2d9ed322eacd8a5" class="i field">MessageReceived</a>, <b>null</b>);
                    <b>if</b> (<a href="#32d33b5f48709bf2" class="i property">StateMachine</a>.<a href="clientremotesessionprotocolstatemachine.cs.html#fea96bca41a2c80a" class="i method">CanByPassRaiseEvent</a>(<span class="r52 r">msgRcvArg</span>))
                    {
                        <a href="#308603da6dafa934" class="i method">ProcessNonSessionMessages</a>(<span class="r48 r">dataArg</span>.<a href="../common/misc.cs.html#38ed693bebe3d7fd" class="i property">ReceivedData</a>);
                    }
                    <b>else</b>
                    {
                        <a href="#32d33b5f48709bf2" class="i property">StateMachine</a>.<a href="clientremotesessionprotocolstatemachine.cs.html#0f71c1a2e194203d" class="i method">RaiseEvent</a>(<span class="r52 r">msgRcvArg</span>);
                    }
 
                    <b>break</b>;
                <b>default</b>:
                    {
                        <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<b>false</b>, <span class="s">&quot;we should not be encountering this&quot;</span>);
                    }
 
                    <b>break</b>;
            }
        }
 
        <span class="c">// TODO: If this is not used remove this</span>
        <span class="c">// internal override event EventHandler&lt;RemoteDataEventArgs&gt; DataReceived;</span>
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This processes the object received from transport which are</span>
        <span class="c">///</span><span class="c"> targeted for session.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r53 r">arg</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> argument contains the data object</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>private void</b> <a id="59833ed775337235" href="../../../R/59833ed775337235.html" target="n" data-glyph="76,1" class="i method">ProcessSessionMessages</a>(<a href="../common/misc.cs.html#5953d27b0d5ec137" class="t t">RemoteDataEventArgs</a> <span id="r53 rd" class="r53 r">arg</span>)
        {
            <b>if</b> (<span class="r53 r">arg</span> == <b>null</b> || <span class="r53 r">arg</span>.<a href="../common/misc.cs.html#38ed693bebe3d7fd" class="i property">ReceivedData</a> == <b>null</b>)
            {
                <b>throw</b> <a href="../../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../../../utils/MshTraceSource.cs.html#fbe67220ad7522a0" class="i method">NewArgumentNullException</a>(<b>nameof</b>(<span class="r53 r">arg</span>));
            }
 
            <a href="../common/WireDataFormat/RemotingDataObject.cs.html#ca4629603c976aab" class="t t">RemoteDataObject</a>&lt;<a href="../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt; <span id="r54 rd" class="r54 r">rcvdData</span> = <span class="r53 r">arg</span>.<a href="../common/misc.cs.html#38ed693bebe3d7fd" class="i property">ReceivedData</a>;
 
            <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#1d73dff2a8d6a0bf" class="t t">RemotingTargetInterface</a> <span id="r55 rd" class="r55 r">targetInterface</span> = <span class="r54 r">rcvdData</span>.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#6975a2b0635b9f80" class="i property">TargetInterface</a>;
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r55 r">targetInterface</span> == <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#1d73dff2a8d6a0bf" class="t t">RemotingTargetInterface</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#8b83aadf9f585adb" class="i field">Session</a>, <span class="s">&quot;targetInterface must be Session&quot;</span>);
 
            <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#296cbb5be87abd08" class="t t">RemotingDataType</a> <span id="r56 rd" class="r56 r">dataType</span> = <span class="r54 r">rcvdData</span>.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#97d7621b092d013f" class="i property">DataType</a>;
 
            <b>switch</b> (<span class="r56 r">dataType</span>)
            {
                <b>case</b> <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#296cbb5be87abd08" class="t t">RemotingDataType</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#cba3be6717291b3e" class="i field">CloseSession</a>:
                    <a href="../common/remotingexceptions.cs.html#553740d8dd522b58" class="t t">PSRemotingDataStructureException</a> <span id="r57 rd" class="r57 r">reasonOfClose</span> = <b>new</b> <span class="t">PSRemotingDataStructureException</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">ServerRequestedToCloseSession</span>);
                    <a href="../common/misc.cs.html#e012d9ffab9d7da0" class="t t">RemoteSessionStateMachineEventArgs</a> <span id="r58 rd" class="r58 r">closeSessionArg</span> = <b>new</b> <span class="t">RemoteSessionStateMachineEventArgs</span>(<a href="../common/misc.cs.html#75ac2ac4117af9a2" class="t t">RemoteSessionEvent</a>.<a href="../common/misc.cs.html#5f2a20db247782f7" class="i field">Close</a>, <span class="r57 r">reasonOfClose</span>);
                    <a href="#ad0ab9cf6a29b328" class="i field">_stateMachine</a>.<a href="clientremotesessionprotocolstatemachine.cs.html#0f71c1a2e194203d" class="i method">RaiseEvent</a>(<span class="r58 r">closeSessionArg</span>);
                    <b>break</b>;
 
                <b>case</b> <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#296cbb5be87abd08" class="t t">RemotingDataType</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#6b685d32d77b181a" class="i field">SessionCapability</a>:
                    <a href="../common/WireDataFormat/RemoteSessionCapability.cs.html#410d0e97ea446fd9" class="t t">RemoteSessionCapability</a> <span id="r59 rd" class="r59 r">capability</span> = <b>null</b>;
                    <b>try</b>
                    {
                        <span class="r59 r">capability</span> = <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#6f71f8c4cc2ac041" class="t t">RemotingDecoder</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#3c9069d4f153d7e0" class="i method">GetSessionCapability</a>(<span class="r54 r">rcvdData</span>.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#d13e5d3038741f3e" class="i property">Data</a>);
                    }
                    <b>catch</b> (<a href="../common/remotingexceptions.cs.html#553740d8dd522b58" class="t t">PSRemotingDataStructureException</a> <span id="r60 rd" class="r60 r">dse</span>)
                    {
                        <span class="c">// this will happen if expected properties are not</span>
                        <span class="c">// received for session capability</span>
                        <b>throw</b> <b>new</b> <span class="t">PSRemotingDataStructureException</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">ClientNotFoundCapabilityProperties</span>,
                            <span class="r60 r">dse</span>.<span class="i">Message</span>, <a href="../../PSVersionInfo.cs.html#be287f9ea52b8d2f" class="t t">PSVersionInfo</a>.<a href="../../PSVersionInfo.cs.html#624934150adfee0d" class="i property">GitCommitId</a>, <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#d19a1042a44001e8" class="t t">RemotingConstants</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#c5be07ec763d4c13" class="i field">ProtocolVersion</a>);
                    }
 
                    <a href="../common/misc.cs.html#e012d9ffab9d7da0" class="t t">RemoteSessionStateMachineEventArgs</a> <span id="r61 rd" class="r61 r">capabilityArg</span> = <b>new</b> <a href="../common/misc.cs.html#77708abdda1be0a8" class="t constructor">RemoteSessionStateMachineEventArgs</a>(<a href="../common/misc.cs.html#75ac2ac4117af9a2" class="t t">RemoteSessionEvent</a>.<a href="../common/misc.cs.html#4cee2bb76cc2f1d7" class="i field">NegotiationReceived</a>);
                    <span class="r61 r">capabilityArg</span>.<a href="../common/misc.cs.html#c8e0072d135e2296" class="i property">RemoteSessionCapability</a> = <span class="r59 r">capability</span>;
                    <a href="#ad0ab9cf6a29b328" class="i field">_stateMachine</a>.<a href="clientremotesessionprotocolstatemachine.cs.html#0f71c1a2e194203d" class="i method">RaiseEvent</a>(<span class="r61 r">capabilityArg</span>);
 
                    <a href="../common/misc.cs.html#5ec41d83163c4dae" class="t t">RemoteSessionNegotiationEventArgs</a> <span id="r62 rd" class="r62 r">negotiationArg</span> = <b>new</b> <a href="../common/misc.cs.html#b07dd553f6c0eede" class="t constructor">RemoteSessionNegotiationEventArgs</a>(<span class="r59 r">capability</span>);
                    <a href="#18f9b3f7605b0391" class="i">NegotiationReceived</a>.<span class="i">SafeInvoke</span>(<a href="#eff965b51f1e9c1d" class="k">this</a>, <span class="r62 r">negotiationArg</span>);
                    <b>break</b>;
 
                <b>case</b> <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#296cbb5be87abd08" class="t t">RemotingDataType</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#c0cf64f5fbe0969f" class="i field">EncryptedSessionKey</a>:
                    {
                        <b>string</b> <span id="r63 rd" class="r63 r">encryptedSessionKey</span> = <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#6f71f8c4cc2ac041" class="t t">RemotingDecoder</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#2d0ab3510e62f5af" class="i method">GetEncryptedSessionKey</a>(<span class="r54 r">rcvdData</span>.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#d13e5d3038741f3e" class="i property">Data</a>);
                        <a href="#9ea68d4785169396" class="i">EncryptedSessionKeyReceived</a>.<span class="i">SafeInvoke</span>(<a href="#eff965b51f1e9c1d" class="k">this</a>, <b>new</b> <a href="../common/misc.cs.html#79fd22f37cbd3e2d" class="t constructor">RemoteDataEventArgs</a>&lt;<b>string</b>&gt;(<span class="r63 r">encryptedSessionKey</span>));
                    }
 
                    <b>break</b>;
 
                <b>case</b> <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#296cbb5be87abd08" class="t t">RemotingDataType</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#b069e4b681ec21a5" class="i field">PublicKeyRequest</a>:
                    {
                        <a href="#4d6e31a7f69c05e3" class="i">PublicKeyRequestReceived</a>.<span class="i">SafeInvoke</span>(<a href="#eff965b51f1e9c1d" class="k">this</a>, <b>new</b> <span class="t">RemoteDataEventArgs</span>&lt;<b>string</b>&gt;(<b>string</b>.<span class="i">Empty</span>));
                    }
 
                    <b>break</b>;
 
                <b>default</b>:
                    {
                        <b>throw</b> <b>new</b> <span class="t">PSRemotingDataStructureException</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">ReceivedUnsupportedAction</span>, <span class="r56 r">dataType</span>);
                    }
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This processes the object received from transport which are</span>
        <span class="c">///</span><span class="c"> not targeted for session.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r64 r">rcvdData</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> received data.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="308603da6dafa934" href="../../../R/308603da6dafa934.html" target="n" data-glyph="74,1" class="i method">ProcessNonSessionMessages</a>(<a href="../common/WireDataFormat/RemotingDataObject.cs.html#ca4629603c976aab" class="t t">RemoteDataObject</a>&lt;<a href="../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt; <span id="r64 rd" class="r64 r">rcvdData</span>)
        {
            <span class="c">// TODO: Consider changing to Dbg.Assert()</span>
            <b>if</b> (<span class="r64 r">rcvdData</span> == <b>null</b>)
            {
                <b>throw</b> <a href="../../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../../../utils/MshTraceSource.cs.html#fbe67220ad7522a0" class="i method">NewArgumentNullException</a>(<b>nameof</b>(<span class="r64 r">rcvdData</span>));
            }
 
            <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#1d73dff2a8d6a0bf" class="t t">RemotingTargetInterface</a> <span id="r65 rd" class="r65 r">targetInterface</span> = <span class="r64 r">rcvdData</span>.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#6975a2b0635b9f80" class="i property">TargetInterface</a>;
 
            <span class="i">Guid</span> <span id="r66 rd" class="r66 r">clientRunspacePoolId</span>;
            <a href="RemoteRunspacePoolInternal.cs.html#1aba79be5da56f57" class="t t">RemoteRunspacePoolInternal</a> <span id="r67 rd" class="r67 r">runspacePool</span>;
 
            <b>switch</b> (<span class="r65 r">targetInterface</span>)
            {
                <b>case</b> <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#1d73dff2a8d6a0bf" class="t t">RemotingTargetInterface</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#8b83aadf9f585adb" class="i field">Session</a>:
 
                    <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<b>false</b>,
                        <span class="s">&quot;The session remote data is handled my session data structure handler, not here&quot;</span>);
                    <b>break</b>;
 
                <b>case</b> <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#1d73dff2a8d6a0bf" class="t t">RemotingTargetInterface</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#405ccc8b1bd2a170" class="i field">RunspacePool</a>:
                    <span class="r66 r">clientRunspacePoolId</span> = <span class="r64 r">rcvdData</span>.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#df5fe91d15e5ba71" class="i property">RunspacePoolId</a>;
                    <span class="r67 r">runspacePool</span> = <a href="#243e93e02f070707" class="i field">_session</a>.<a href="clientremotesession.cs.html#060adf8a7a142cd3" class="i method">GetRunspacePool</a>(<span class="r66 r">clientRunspacePoolId</span>);
 
                    <b>if</b> (<span class="r67 r">runspacePool</span> != <b>null</b>)
                    {
                        <span class="c">// GETBACK</span>
                        <span class="r67 r">runspacePool</span>.<a href="RemoteRunspacePoolInternal.cs.html#6629c704c27c6e09" class="i property">DataStructureHandler</a>.<a href="RemotingProtocol2.cs.html#e84f84e8146715ec" class="i method">ProcessReceivedData</a>(<span class="r64 r">rcvdData</span>);
                    }
                    <b>else</b>
                    {
                        <span class="c">// The runspace pool may have been removed on the client side,</span>
                        <span class="c">// so, we should just ignore the message.</span>
                        <a href="#ff76a8f82c889b68" class="i field">s_trace</a>.<span class="i">WriteLine</span>(<span class="s">@&quot;Client received data for Runspace (id: {0}),
                            but the Runspace cannot be found&quot;</span>, <span class="r66 r">clientRunspacePoolId</span>);
                    }
 
                    <b>break</b>;
 
                <b>case</b> <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#1d73dff2a8d6a0bf" class="t t">RemotingTargetInterface</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#f4078f88b2ce5495" class="i field">PowerShell</a>:
                    <span class="r66 r">clientRunspacePoolId</span> = <span class="r64 r">rcvdData</span>.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#df5fe91d15e5ba71" class="i property">RunspacePoolId</a>;
                    <span class="r67 r">runspacePool</span> = <a href="#243e93e02f070707" class="i field">_session</a>.<a href="clientremotesession.cs.html#060adf8a7a142cd3" class="i method">GetRunspacePool</a>(<span class="r66 r">clientRunspacePoolId</span>);
 
                    <span class="c">// GETBACK</span>
                    <span class="r67 r">runspacePool</span>.<a href="RemoteRunspacePoolInternal.cs.html#6629c704c27c6e09" class="i property">DataStructureHandler</a>.<a href="RemotingProtocol2.cs.html#da27441f3ee29d1f" class="i method">DispatchMessageToPowerShell</a>(<span class="r64 r">rcvdData</span>);
                    <b>break</b>;
 
                <b>default</b>:
 
                    <b>break</b>;
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> data handling
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> IDisposable
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Public method for dispose.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public void</b> <a id="1cd21c3e77cbc8d5" href="../../../R/1cd21c3e77cbc8d5.html" target="n" data-glyph="72,1" class="i method">Dispose</a>()
        {
            <a href="#2405dc64d1af0986" class="i method">Dispose</a>(<b>true</b>);
 
            <span class="i">GC</span>.<span class="i">SuppressFinalize</span>(<a href="#eff965b51f1e9c1d" class="k">this</a>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Release all resources.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r68 r">disposing</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">If true, release all managed resources.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>protected void</b> <a id="2405dc64d1af0986" href="../../../R/2405dc64d1af0986.html" target="n" data-glyph="75,1" class="i method">Dispose</a>(<b>bool</b> <span id="r68 rd" class="r68 r">disposing</span>)
        {
            <b>if</b> (<span class="r68 r">disposing</span>)
            {
                <a href="#bc2db2da522293dc" class="i field">_transportManager</a>.<a href="../fanin/BaseTransportManager.cs.html#087693e06bcea17a" class="i method">Dispose</a>();
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> IDisposable
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Key Exchange
 
        <b>internal override event</b> <span class="i">EventHandler</span>&lt;<a href="../common/misc.cs.html#16d1e16a7ed9f8cc" class="t t">RemoteDataEventArgs</a>&lt;<b>string</b>&gt;&gt; <a id="9ea68d4785169396" href="../../../R/9ea68d4785169396.html" target="n" data-glyph="32,1" class="i">EncryptedSessionKeyReceived</a>;
 
        <b>internal override event</b> <span class="i">EventHandler</span>&lt;<a href="../common/misc.cs.html#16d1e16a7ed9f8cc" class="t t">RemoteDataEventArgs</a>&lt;<b>string</b>&gt;&gt; <a id="4d6e31a7f69c05e3" href="../../../R/4d6e31a7f69c05e3.html" target="n" data-glyph="32,1" class="i">PublicKeyRequestReceived</a>;
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Send the specified local public key to the remote end.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r69 r">localPublicKey</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Local public key as a string.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal override void</b> <a id="d34701a8f2d2732e" href="../../../R/d34701a8f2d2732e.html" target="n" data-glyph="74,1" class="i method">SendPublicKeyAsync</a>(<b>string</b> <span id="r69 rd" class="r69 r">localPublicKey</span>)
        {
            <a href="#bc2db2da522293dc" class="i field">_transportManager</a>.<a href="../fanin/BaseTransportManager.cs.html#f8317afa9f690e3b" class="i property">DataToBeSentCollection</a>.<a href="../fanin/PriorityCollection.cs.html#82212f989f1c53a3" class="i method">Add</a>&lt;<b>object</b>&gt;(
                <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#88b19073d823ce05" class="t t">RemotingEncoder</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#049cdc8d34ce0666" class="i method">GenerateMyPublicKey</a>(<a href="#243e93e02f070707" class="i field">_session</a>.<a href="clientremotesession.cs.html#e8997fdb5a3c5f81" class="i property">RemoteRunspacePoolInternal</a>.<a href="../../hostifaces/RunspacePoolInternal.cs.html#76aedcc22e17e7e5" class="i property">InstanceId</a>,
                    <span class="r69 r">localPublicKey</span>, <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#45c72046001f69b8" class="t t">RemotingDestination</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#061ac750e6d280da" class="i field">Server</a>));
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Raise the public key received event.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r70 r">receivedData</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Received data.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span><span class="c">This method is a hook to be called</span>
        <span class="c">///</span><span class="c"> from the transport manager</span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>internal override void</b> <a id="cc85fbb3967d5d82" href="../../../R/cc85fbb3967d5d82.html" target="n" data-glyph="74,1" class="i method">RaiseKeyExchangeMessageReceived</a>(<a href="../common/WireDataFormat/RemotingDataObject.cs.html#ca4629603c976aab" class="t t">RemoteDataObject</a>&lt;<a href="../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt; <span id="r70 rd" class="r70 r">receivedData</span>)
        {
            <a href="#59833ed775337235" class="i method">ProcessSessionMessages</a>(<b>new</b> <a href="../common/misc.cs.html#af43ac696a2be0b8" class="t constructor">RemoteDataEventArgs</a>(<span class="r70 r">receivedData</span>));
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Key Exchange
    }
}
</pre></td></tr></table></div></body></html>
