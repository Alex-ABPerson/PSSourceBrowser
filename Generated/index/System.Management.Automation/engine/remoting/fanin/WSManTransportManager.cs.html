<!DOCTYPE html>
<html><head><title>WSManTransportManager.cs</title><link rel="stylesheet" href="../../../../styles.css"><script src="../../../../scripts.js"></script></head>
<body class="cB" onload="i(4172);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#System.Management.Automation/engine/remoting/fanin/WSManTransportManager.cs" target="_top">engine\remoting\fanin\WSManTransportManager.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#System.Management.Automation" target="_top">src\System.Management.Automation\System.Management.Automation.csproj</a> (System.Management.Automation)</td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation.</span>
<span class="c">// Licensed under the MIT License.</span>
 
<span class="c">/*
 * Common file that contains implementation for both server and client transport
 * managers based on WSMan protocol.
 *
 */</span>
 
<b>using</b> <span class="i n">System</span>.<span class="i">Collections</span>.<span class="i">Generic</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Diagnostics</span>.<span class="i">CodeAnalysis</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Globalization</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">IO</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Internal</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Remoting</span>.<span class="i n">Server</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Runspaces</span>.<span class="i n">Internal</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Tracing</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Runtime</span>.<span class="i">InteropServices</span>;
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">UNIX</span>
<b>using</b> <span class="i n">System</span>.<span class="i">Security</span>.<span class="i">Principal</span>;
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
<b>using</b> <span class="i n">System</span>.<span class="i">Xml</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Threading</span>;
 
<b>using</b> <span class="t">PSRemotingCryptoHelper</span> = <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Internal</span>.<a href="../../../utils/CryptoUtils.cs.html#1999dfb2439af5a0" class="t t">PSRemotingCryptoHelper</a>;
<b>using</b> <span class="t">WSManConnectionInfo</span> = <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Runspaces</span>.<a href="../common/RunspaceConnectionInfo.cs.html#2d9d176ef419be5a" class="t t">WSManConnectionInfo</a>;
<b>using</b> <span class="t">RunspaceConnectionInfo</span> = <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Runspaces</span>.<a href="../common/RunspaceConnectionInfo.cs.html#e07ed56a8a1da829" class="t t">RunspaceConnectionInfo</a>;
<b>using</b> <span class="t">AuthenticationMechanism</span> = <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Runspaces</span>.<a href="../common/RunspaceConnectionInfo.cs.html#f2f89adf00d05f44" class="t t">AuthenticationMechanism</a>;
<b>using</b> <span class="t">Dbg</span> = <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Diagnostics</a>;
 
<b>namespace</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Remoting</span>.<span class="i n">Client</span>
{
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> WSMan TransportManager related utils.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>internal static class</b> <a id="b4291df75d9bc408" href="../../../R/b4291df75d9bc408.html" target="n" data-glyph="2,0" class="t t">WSManTransportManagerUtils</a>
    {
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Static Data
 
        <span class="c">// Fully qualified error Id modifiers based on transport (WinRM) error codes.</span>
        <b>private static readonly</b> <span class="i">Dictionary</span>&lt;<b>int</b>, <b>string</b>&gt; <a id="884d177836415420" href="../../../R/884d177836415420.html" target="n" data-glyph="46,1" class="i field">s_transportErrorCodeToFQEID</a> = <b>new</b> <span class="i">Dictionary</span>&lt;<b>int</b>, <b>string</b>&gt;()
        {
            {<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#82b57076eb584d3d" class="i field">ERROR_WSMAN_ACCESS_DENIED</a>, <span class="s">&quot;AccessDenied&quot;</span>},
            {<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#d8e793acb18b5bea" class="i field">ERROR_WSMAN_OUTOF_MEMORY</a>, <span class="s">&quot;ServerOutOfMemory&quot;</span>},
            {<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#35b0bb23bcf533fa" class="i field">ERROR_WSMAN_NETWORKPATH_NOTFOUND</a>, <span class="s">&quot;NetworkPathNotFound&quot;</span>},
            {<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#1c0864d326b8093c" class="i field">ERROR_WSMAN_COMPUTER_NOTFOUND</a>, <span class="s">&quot;ComputerNotFound&quot;</span>},
            {<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#4d26a09cbdc7f012" class="i field">ERROR_WSMAN_AUTHENTICATION_FAILED</a>, <span class="s">&quot;AuthenticationFailed&quot;</span>},
            {<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#a9b4040111b34a6a" class="i field">ERROR_WSMAN_LOGON_FAILURE</a>, <span class="s">&quot;LogonFailure&quot;</span>},
            {<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#0132dca2b19bdd62" class="i field">ERROR_WSMAN_IMPROPER_RESPONSE</a>, <span class="s">&quot;ImproperResponse&quot;</span>},
            {<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#8c946e459d470e8a" class="i field">ERROR_WSMAN_INCORRECT_PROTOCOLVERSION</a>, <span class="s">&quot;IncorrectProtocolVersion&quot;</span>},
            {<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#555c2ee01109d2c5" class="i field">ERROR_WSMAN_SENDDATA_CANNOT_COMPLETE</a>, <span class="s">&quot;WinRMOperationTimeout&quot;</span>},
            {<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#2c82cad02e089372" class="i field">ERROR_WSMAN_URL_NOTAVAILABLE</a>, <span class="s">&quot;URLNotAvailable&quot;</span>},
            {<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#42bce97949b29c7f" class="i field">ERROR_WSMAN_SENDDATA_CANNOT_CONNECT</a>, <span class="s">&quot;CannotConnect&quot;</span>},
            {<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#873f5440df59bf59" class="i field">ERROR_WSMAN_INVALID_RESOURCE_URI</a>, <span class="s">&quot;InvalidResourceUri&quot;</span>},
            {<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#728972c090c1c619" class="i field">ERROR_WSMAN_INUSE_CANNOT_RECONNECT</a>, <span class="s">&quot;CannotConnectAlreadyConnected&quot;</span>},
            {<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#eaef8781750617c5" class="i field">ERROR_WSMAN_INVALID_AUTHENTICATION</a>, <span class="s">&quot;InvalidAuthentication&quot;</span>},
            {<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#45acf66e937fc0ef" class="i field">ERROR_WSMAN_SHUTDOWN_INPROGRESS</a>, <span class="s">&quot;ShutDownInProgress&quot;</span>},
            {<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#2a1ea5cefdac71dd" class="i field">ERROR_WSMAN_CANNOT_CONNECT_INVALID</a>, <span class="s">&quot;CannotConnectInvalidOperation&quot;</span>},
            {<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#45e3dd7a9e1dc0b1" class="i field">ERROR_WSMAN_CANNOT_CONNECT_MISMATCH</a>, <span class="s">&quot;CannotConnectMismatchSessions&quot;</span>},
            {<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#6f925c7f5d59136c" class="i field">ERROR_WSMAN_CANNOT_CONNECT_RUNASFAILED</a>, <span class="s">&quot;CannotConnectRunAsFailed&quot;</span>},
            {<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#6a3cd9a446731b73" class="i field">ERROR_WSMAN_CREATEFAILED_INVALIDNAME</a>, <span class="s">&quot;SessionCreateFailedInvalidName&quot;</span>},
            {<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#1512da0c98e3c02b" class="i field">ERROR_WSMAN_TARGETSESSION_DOESNOTEXIST</a>, <span class="s">&quot;CannotConnectTargetSessionDoesNotExist&quot;</span>},
            {<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#196d3ce1cc2abbfb" class="i field">ERROR_WSMAN_REMOTESESSION_DISALLOWED</a>, <span class="s">&quot;RemoteSessionDisallowed&quot;</span>},
            {<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#80b0dbc890333302" class="i field">ERROR_WSMAN_REMOTECONNECTION_DISALLOWED</a>, <span class="s">&quot;RemoteConnectionDisallowed&quot;</span>},
            {<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#2e5ed187321ea631" class="i field">ERROR_WSMAN_INVALID_RESOURCE_URI2</a>, <span class="s">&quot;InvalidResourceUri&quot;</span>},
            {<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#d5c5dbbc9890fffa" class="i field">ERROR_WSMAN_CORRUPTED_CONFIG</a>, <span class="s">&quot;CorruptedWinRMConfig&quot;</span>},
            {<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#f5c48d5d91b05694" class="i field">ERROR_WSMAN_OPERATION_ABORTED</a>, <span class="s">&quot;WinRMOperationAborted&quot;</span>},
            {<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#07f57c582b7352a5" class="i field">ERROR_WSMAN_URI_LIMIT</a>, <span class="s">&quot;URIExceedsMaxAllowedSize&quot;</span>},
            {<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#7fc0ec817cc483d5" class="i field">ERROR_WSMAN_CLIENT_KERBEROS_DISABLED</a>, <span class="s">&quot;ClientKerberosDisabled&quot;</span>},
            {<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#e682f38cfa33c666" class="i field">ERROR_WSMAN_SERVER_NOTTRUSTED</a>, <span class="s">&quot;ServerNotTrusted&quot;</span>},
            {<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#63c8fb55bc487132" class="i field">ERROR_WSMAN_WORKGROUP_NO_KERBEROS</a>, <span class="s">&quot;WorkgroupCannotUseKerberos&quot;</span>},
            {<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#86098acc10c452c1" class="i field">ERROR_WSMAN_EXPLICIT_CREDENTIALS_REQUIRED</a>, <span class="s">&quot;ExplicitCredentialsRequired&quot;</span>},
            {<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#99934ed715345df2" class="i field">ERROR_WSMAN_REDIRECT_LOCATION_INVALID</a>, <span class="s">&quot;RedirectLocationInvalid&quot;</span>},
            {<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#325ee0cf8be4313d" class="i field">ERROR_WSMAN_REDIRECT_REQUESTED</a>, <span class="s">&quot;RedirectInformationRequired&quot;</span>},
            {<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#9ef6648eb121e23d" class="i field">ERROR_WSMAN_BAD_METHOD</a>, <span class="s">&quot;WinRMOperationNotSupportedOnServer&quot;</span>},
            {<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#d27141b364d9bc76" class="i field">ERROR_WSMAN_HTTP_SERVICE_UNAVAILABLE</a>, <span class="s">&quot;CannotConnectWinRMService&quot;</span>},
            {<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#4ea7a2b87f034192" class="i field">ERROR_WSMAN_HTTP_SERVICE_ERROR</a>, <span class="s">&quot;WinRMHttpError&quot;</span>},
            {<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#7c2a80911e288063" class="i field">ERROR_WSMAN_TARGET_UNKNOWN</a>, <span class="s">&quot;TargetUnknown&quot;</span>},
            {<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#aa6c836ce5b7cf58" class="i field">ERROR_WSMAN_CANNOTUSE_IP</a>, <span class="s">&quot;CannotUseIPAddress&quot;</span>}
        };
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Helper Methods
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Constructs a WSManTransportErrorOccuredEventArgs instance from the supplied data.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r0 r">wsmanAPIHandle</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> WSMan API handle to use to get error messages from WSMan error id(s)</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r1 r">wsmanSessionTM</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Session Transportmanager to use to get error messages (for redirect)</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r2 r">errorStruct</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Error structure supplied by callbacks from WSMan API</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r3 r">transportMethodReportingError</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The transport method call that reported this error.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r4 r">resourceString</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> resource string that holds the message.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r5 r">resourceArgs</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Arguments to pass to the resource</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> An instance of WSManTransportErrorOccuredEventArgs</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal static</b> <a href="BaseTransportManager.cs.html#7e70b34f9332dfcd" class="t t">TransportErrorOccuredEventArgs</a> <a id="9faadd52785aaccc" href="../../../R/../../0000000000.html" target="n" data-glyph="74,1" class="i method">ConstructTransportErrorEventArgs</a>(<span class="i">IntPtr</span> <span id="r0 rd" class="r0 r">wsmanAPIHandle</span>,
            <a href="#693b43214373ab1e" class="t t">WSManClientSessionTransportManager</a> <span id="r1 rd" class="r1 r">wsmanSessionTM</span>,
            <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#587a4e1f26edb30b" class="t t">WSManError</a> <span id="r2 rd" class="r2 r">errorStruct</span>,
            <a href="BaseTransportManager.cs.html#33678df914ca9daf" class="t t">TransportMethodEnum</a> <span id="r3 rd" class="r3 r">transportMethodReportingError</span>,
            <b>string</b> <span id="r4 rd" class="r4 r">resourceString</span>,
            <b>params object</b>[] <span id="r5 rd" class="r5 r">resourceArgs</span>)
        {
            <a href="../common/remotingexceptions.cs.html#0bb8687f97d91059" class="t t">PSRemotingTransportException</a> <span id="r6 rd" class="r6 r">e</span>;
 
            <span class="c">// For the first two special error conditions, it is remotely possible that the wsmanSessionTM is null when the failures are returned</span>
            <span class="c">// as part of command TM operations (could be returned because of RC retries under the hood)</span>
            <span class="c">// Not worth to handle these cases separately as there are very corner scenarios, but need to make sure wsmanSessionTM is not referenced</span>
 
            <span class="c">// Destination server is reporting that URI redirect is required for this user.</span>
            <b>if</b> ((<span class="r2 r">errorStruct</span>.<a href="WSManNativeAPI.cs.html#3bfbb0e97567321f" class="i field">errorCode</a> == <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#325ee0cf8be4313d" class="i field">ERROR_WSMAN_REDIRECT_REQUESTED</a>) &amp;&amp; (<span class="r1 r">wsmanSessionTM</span> != <b>null</b>))
            {
                <span class="i">IntPtr</span> <span id="r7 rd" class="r7 r">wsmanSessionHandle</span> = <span class="r1 r">wsmanSessionTM</span>.<a href="#e8c30b78e828e9e3" class="i property">SessionHandle</a>;
                <span class="c">// populate the transport message with the redirection uri..this will</span>
                <span class="c">// allow caller to make a new connection.</span>
                <b>string</b> <span id="r8 rd" class="r8 r">redirectLocation</span> = <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#33b73b64e5ac34f5" class="i method">WSManGetSessionOptionAsString</a>(<span class="r7 r">wsmanSessionHandle</span>,
                    <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#f99c2939972a9aca" class="t t">WSManSessionOption</a>.<a href="WSManNativeAPI.cs.html#485c49ad2544b4d7" class="i field">WSMAN_OPTION_REDIRECT_LOCATION</a>);
                <b>string</b> <span id="r9 rd" class="r9 r">winrmMessage</span> = <a href="#95feb8ba0fde2a13" class="i method">ParseEscapeWSManErrorMessage</a>(
                    <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#0daa89ea27b8128f" class="i method">WSManGetErrorMessage</a>(<span class="r0 r">wsmanAPIHandle</span>, <span class="r2 r">errorStruct</span>.<a href="WSManNativeAPI.cs.html#3bfbb0e97567321f" class="i field">errorCode</a>)).<span class="i">Trim</span>();
 
                <span class="r6 r">e</span> = <b>new</b> <span class="t">PSRemotingTransportRedirectException</span>(<span class="r8 r">redirectLocation</span>,
                    <a href="../common/remotingexceptions.cs.html#a969589d7508bf05" class="t t">PSRemotingErrorId</a>.<a href="../common/remotingexceptions.cs.html#b9e4aa71627c7c56" class="i field">URIEndPointNotResolved</a>,
                    <span class="i">RemotingErrorIdStrings</span>.<span class="i">URIEndPointNotResolved</span>,
                    <span class="r9 r">winrmMessage</span>,
                    <span class="r8 r">redirectLocation</span>);
            }
            <b>else</b> <b>if</b> ((<span class="r2 r">errorStruct</span>.<a href="WSManNativeAPI.cs.html#3bfbb0e97567321f" class="i field">errorCode</a> == <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#873f5440df59bf59" class="i field">ERROR_WSMAN_INVALID_RESOURCE_URI</a>) &amp;&amp; (<span class="r1 r">wsmanSessionTM</span> != <b>null</b>))
            {
                <b>string</b> <span id="r10 rd" class="r10 r">configurationName</span> =
                    <span class="r1 r">wsmanSessionTM</span>.<a href="#c09ce13debcbb880" class="i property">ConnectionInfo</a>.<a href="../common/RunspaceConnectionInfo.cs.html#a0ee4c890acec948" class="i property">ShellUri</a>.<span class="i">Replace</span>(<span class="i n">Remoting</span>.<span class="i n">Client</span>.<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#f383edcf61712f90" class="i field">ResourceURIPrefix</a>, <b>string</b>.<span class="i">Empty</span>);
                <b>string</b> <span id="r11 rd" class="r11 r">errorMessage</span> = <a href="../common/remotingexceptions.cs.html#53047fc052e9b445" class="t t">PSRemotingErrorInvariants</a>.<span class="i">FormatResourceString</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">InvalidConfigurationName</span>,
                                                   <span class="r10 r">configurationName</span>,
                                                   <span class="r1 r">wsmanSessionTM</span>.<a href="#c09ce13debcbb880" class="i property">ConnectionInfo</a>.<a href="../common/RunspaceConnectionInfo.cs.html#74b71e9668d24a47" class="i property">ComputerName</a>);
 
                <span class="r6 r">e</span> = <b>new</b> <span class="t">PSRemotingTransportException</span>(<a href="../common/remotingexceptions.cs.html#a969589d7508bf05" class="t t">PSRemotingErrorId</a>.<a href="../common/remotingexceptions.cs.html#9b2f10cc1952c10e" class="i field">InvalidConfigurationName</a>,
                                                   <span class="i">RemotingErrorIdStrings</span>.<span class="i">ConnectExCallBackError</span>, <span class="r1 r">wsmanSessionTM</span>.<a href="#c09ce13debcbb880" class="i property">ConnectionInfo</a>.<a href="../common/RunspaceConnectionInfo.cs.html#74b71e9668d24a47" class="i property">ComputerName</a>, <span class="r11 r">errorMessage</span>);
 
                <span class="r6 r">e</span>.<a href="../common/remotingexceptions.cs.html#9008a0cafbbfa4d3" class="i property">TransportMessage</a> = <a href="#95feb8ba0fde2a13" class="i method">ParseEscapeWSManErrorMessage</a>(
                   <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#0daa89ea27b8128f" class="i method">WSManGetErrorMessage</a>(<span class="r0 r">wsmanAPIHandle</span>, <span class="r2 r">errorStruct</span>.<a href="WSManNativeAPI.cs.html#3bfbb0e97567321f" class="i field">errorCode</a>));
            }
            <b>else</b>
            {
                <span class="c">// Construct specific error message and then append this message pointing to our own</span>
                <span class="c">// help topic. PowerShell&#39;s about help topic &quot;about_Remote_Troubleshooting&quot; should</span>
                <span class="c">// contain all the trouble shooting information.</span>
                <b>string</b> <span id="r12 rd" class="r12 r">wsManErrorMessage</span> = <a href="../common/remotingexceptions.cs.html#53047fc052e9b445" class="t t">PSRemotingErrorInvariants</a>.<a href="../common/remotingexceptions.cs.html#5f4bcb44bc0f3ab2" class="i method">FormatResourceString</a>(<span class="r4 r">resourceString</span>, <span class="r5 r">resourceArgs</span>);
                <span class="r6 r">e</span> = <b>new</b> <span class="t">PSRemotingTransportException</span>(<a href="../common/remotingexceptions.cs.html#a969589d7508bf05" class="t t">PSRemotingErrorId</a>.<a href="../common/remotingexceptions.cs.html#6d56608962536fb3" class="i field">TroubleShootingHelpTopic</a>,
                    <span class="i">RemotingErrorIdStrings</span>.<span class="i">TroubleShootingHelpTopic</span>,
                    <span class="r12 r">wsManErrorMessage</span>);
 
                <span class="r6 r">e</span>.<a href="../common/remotingexceptions.cs.html#9008a0cafbbfa4d3" class="i property">TransportMessage</a> = <a href="#95feb8ba0fde2a13" class="i method">ParseEscapeWSManErrorMessage</a>(
                    <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#0daa89ea27b8128f" class="i method">WSManGetErrorMessage</a>(<span class="r0 r">wsmanAPIHandle</span>, <span class="r2 r">errorStruct</span>.<a href="WSManNativeAPI.cs.html#3bfbb0e97567321f" class="i field">errorCode</a>));
            }
 
            <span class="r6 r">e</span>.<a href="../common/remotingexceptions.cs.html#f96218464c4b7244" class="i property">ErrorCode</a> = <span class="r2 r">errorStruct</span>.<a href="WSManNativeAPI.cs.html#3bfbb0e97567321f" class="i field">errorCode</a>;
            <a href="BaseTransportManager.cs.html#7e70b34f9332dfcd" class="t t">TransportErrorOccuredEventArgs</a> <span id="r13 rd" class="r13 r">eventargs</span> =
                <b>new</b> <a href="BaseTransportManager.cs.html#c420864940871a42" class="t constructor">TransportErrorOccuredEventArgs</a>(<span class="r6 r">e</span>, <span class="r3 r">transportMethodReportingError</span>);
            <b>return</b> <span class="r13 r">eventargs</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Helper method that escapes powershell parser recognized strings like &quot;@{&quot; from the error message</span>
        <span class="c">///</span><span class="c"> string. This is needed to make error messages look authentic. Some WSMan error messages provide a</span>
        <span class="c">///</span><span class="c"> command line to run to fix certain issues. WSMan command line has syntax that allows use of @{}.</span>
        <span class="c">///</span><span class="c"> PowerShell parser treats them differently..and so when user cut and paste the command line in a</span>
        <span class="c">///</span><span class="c"> PowerShell console, it wont work. This escape logic works around the issue.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r14 r">errorMessage</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal static string</b> <a id="95feb8ba0fde2a13" href="../../../R/95feb8ba0fde2a13.html" target="n" data-glyph="74,1" class="i method">ParseEscapeWSManErrorMessage</a>(<b>string</b> <span id="r14 rd" class="r14 r">errorMessage</span>)
        {
            <span class="c">// currently we do special processing only for &quot;@{&quot; construct.</span>
            <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r14 r">errorMessage</span>) || (!<span class="r14 r">errorMessage</span>.<span class="i">Contains</span>(<span class="s">&quot;@{&quot;</span>)))
            {
                <b>return</b> <span class="r14 r">errorMessage</span>;
            }
 
            <b>string</b> <span id="r15 rd" class="r15 r">result</span> = <span class="r14 r">errorMessage</span>.<span class="i">Replace</span>(<span class="s">&quot;@{&quot;</span>, <span class="s">&quot;&#39;@{&quot;</span>).<span class="i">Replace</span>(<span class="s">&quot;}&quot;</span>, <span class="s">&quot;}&#39;&quot;</span>);
            <b>return</b> <span class="r15 r">result</span>;
 
            <span class="c">/*
             * Use this pattern if we need to escape other characters.
             *
            try
            {
                StringBuilder msgSB = new StringBuilder(errorMessage);
 
                Collection&lt;PSParseError&gt; parserErrors = new Collection&lt;PSParseError&gt;();
                Collection&lt;PSToken&gt; tokens = PSParser.Tokenize(errorMessage, out parserErrors);
                if (parserErrors.Count &gt; 0)
                {
                    tracer.WriteLine(string.Format(CultureInfo.InvariantCulture,
                        &quot;There were errors parsing string &#39;{0}&#39;&quot;, errorMessage);
                    return errorMessage;
                }
 
                for (int index = tokens.Count - 1; index &gt; 0; index--)
                {
                    PSToken currentToken = tokens[index];
                    switch(currentToken.Type)
                    {
                        case PSTokenType.GroupStart:
                            msgSB.Insert(currentToken.StartColumn - 1, &quot;&#39;&quot;, 1);
                            break;
                        case PSTokenType.GroupEnd:
                            if (msgSB.Length &lt;= currentToken.EndColumn)
                            {
                                msgSB.Append(&quot;&#39;&quot;);
                            }
                            else
                            {
                                msgSB.Insert(currentToken.EndColumn - 1, &quot;,&quot;, 1);
                            }
 
                            break;
                    }
                }
 
                return msgSB.ToString();
            }
            // ignore possible exceptions manipulating the string.
            catch(ArgumentOutOfRangeException)
            {
            }
            catch(RuntimeException)
            {
            }
 
            return errorMessage;*/</span>
        }
 
        <b>internal enum</b> <a id="591d3d3614fb4562" href="../../../R/591d3d3614fb4562.html" target="n" data-glyph="20,1" class="t t"><span id="c357fbbad6a24700">tmStartModes</span></a>
        {
            <a id="6cebc3fa4e6113a6" href="../../../R/6cebc3fa4e6113a6.html" target="n" data-glyph="24,2" class="i field">None</a> = 1, <a id="8a9271ccb43791fe" href="../../../R/8a9271ccb43791fe.html" target="n" data-glyph="24,2" class="i field">Create</a> = 2, <a id="59c1f5d2f991538b" href="../../../R/59c1f5d2f991538b.html" target="n" data-glyph="24,2" class="i field">Connect</a> = 3
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Helper method to convert a transport error code value</span>
        <span class="c">///</span><span class="c"> to a fully qualified error Id string.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r16 r">transportErrorCode</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Transport error code.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r17 r">defaultFQEID</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Default FQEID.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">Fully qualified error Id string.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal static string</b> <a id="d3bf2dfca72ae399" href="../../../R/d3bf2dfca72ae399.html" target="n" data-glyph="74,1" class="i method">GetFQEIDFromTransportError</a>(
            <b>int</b> <span id="r16 rd" class="r16 r">transportErrorCode</span>,
            <b>string</b> <span id="r17 rd" class="r17 r">defaultFQEID</span>)
        {
            <b>string</b> <span id="r18 rd" class="r18 r">specificErrorId</span>;
            <b>if</b> (<a href="#884d177836415420" class="i field">s_transportErrorCodeToFQEID</a>.<span class="i">TryGetValue</span>(<span class="r16 r">transportErrorCode</span>, <b>out</b> <span class="r18 r">specificErrorId</span>))
            {
                <b>return</b> <span class="r18 r">specificErrorId</span> + <span class="s">&quot;,&quot;</span> + <span class="r17 r">defaultFQEID</span>;
            }
            <b>else</b> <b>if</b> (<span class="r16 r">transportErrorCode</span> != 0)
            {
                <span class="c">// Provide error code to uniquely identify the error Id.</span>
                <b>return</b> <span class="r16 r">transportErrorCode</span>.<span class="i">ToString</span>(<span class="i n">System</span>.<span class="i">Globalization</span>.<span class="i">NumberFormatInfo</span>.<span class="i">InvariantInfo</span>) + <span class="s">&quot;,&quot;</span> + <span class="r17 r">defaultFQEID</span>;
            }
 
            <b>return</b> <span class="r17 r">defaultFQEID</span>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
    }
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Class that manages a server session. This doesn&#39;t implement IDisposable. Use Close method</span>
    <span class="c">///</span><span class="c"> to clean the resources.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>internal sealed class</b> <a id="693b43214373ab1e" href="../../../R/693b43214373ab1e.html" target="n" data-glyph="2,0" class="t t">WSManClientSessionTransportManager</a> : <a href="BaseTransportManager.cs.html#19883ec4df424177" class="t t">BaseClientSessionTransportManager</a>
    {
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Consts
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Max uri redirection count session variable.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal const string</b> <a id="3fa5cf409f7d3fac" href="../../../R/../../0000000000.html" target="n" data-glyph="8,1" class="i field">MAX_URI_REDIRECTION_COUNT_VARIABLE</a> = <span class="s">&quot;WSManMaxRedirectionCount&quot;</span>;
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Default max uri redirection count - wsman.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal const int</b> <a id="0cf29153bbf23033" href="../../../R/../../0000000000.html" target="n" data-glyph="8,1" class="i field">MAX_URI_REDIRECTION_COUNT</a> = 5;
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Enums
 
        <b>private enum</b> <a id="ed02d4fc471b4338" href="../../../R/ed02d4fc471b4338.html" target="n" data-glyph="22,1" class="t t"><span id="d2bd137bee3a518e">CompletionNotification</span></a>
        {
            <a id="6d885bea5bdd70f8" href="../../../R/6d885bea5bdd70f8.html" target="n" data-glyph="24,2" class="i field">DisconnectCompleted</a>
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> CompletionEventArgs
 
        <b>private sealed class</b> <a id="856d8234e22306d6" href="../../../R/856d8234e22306d6.html" target="n" data-glyph="4,1" class="t t">CompletionEventArgs</a> : <span class="i">EventArgs</span>
        {
            <b>internal</b> <a id="7a3b840fd435be57" href="../../../R/7a3b840fd435be57.html" target="n" data-glyph="74,2" class="t constructor">CompletionEventArgs</a>(<a href="#ed02d4fc471b4338" class="t t">CompletionNotification</a> <span id="r19 rd" class="r19 r">notification</span>)
            {
                <a href="#15b4e7aca265588d" class="i property">Notification</a> = <span class="r19 r">notification</span>;
            }
 
            <b>internal</b> <a href="#ed02d4fc471b4338" class="t t">CompletionNotification</a> <a id="15b4e7aca265588d" href="../../../R/15b4e7aca265588d.html" target="n" data-glyph="104,2" class="i property">Notification</a> { <b>get</b>; }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Private Data
        <span class="c">// operation handles are owned by WSMan</span>
        [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Reliability&quot;</span>, <span class="s">&quot;CA2006:UseSafeHandleToEncapsulateNativeResources&quot;</span>)]
        <b>private</b> <span class="i">IntPtr</span> <a id="e71b1b284f1d2a52" href="../../../R/e71b1b284f1d2a52.html" target="n" data-glyph="46,1" class="i field">_wsManSessionHandle</a>;
 
        [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Reliability&quot;</span>, <span class="s">&quot;CA2006:UseSafeHandleToEncapsulateNativeResources&quot;</span>)]
        <b>private</b> <span class="i">IntPtr</span> <a id="5120ad7297341362" href="../../../R/5120ad7297341362.html" target="n" data-glyph="46,1" class="i field">_wsManShellOperationHandle</a>;
 
        [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Reliability&quot;</span>, <span class="s">&quot;CA2006:UseSafeHandleToEncapsulateNativeResources&quot;</span>)]
        <b>private</b> <span class="i">IntPtr</span> <a id="13bf3d1545f10c0d" href="../../../R/13bf3d1545f10c0d.html" target="n" data-glyph="46,1" class="i field">_wsManReceiveOperationHandle</a>;
 
        [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Reliability&quot;</span>, <span class="s">&quot;CA2006:UseSafeHandleToEncapsulateNativeResources&quot;</span>)]
        <b>private</b> <span class="i">IntPtr</span> <a id="1cd15cdc83709878" href="../../../R/1cd15cdc83709878.html" target="n" data-glyph="46,1" class="i field">_wsManSendOperationHandle</a>;
        <span class="c">// this is used with WSMan callbacks to represent a session transport manager.</span>
        <b>private long</b> <a id="63bdfff34ccd5ad2" href="../../../R/63bdfff34ccd5ad2.html" target="n" data-glyph="46,1" class="i field">_sessionContextID</a>;
 
        <b>private</b> <a href="#b4291df75d9bc408" class="t t">WSManTransportManagerUtils</a>.<a href="#591d3d3614fb4562" class="t t">tmStartModes</a> <a id="60520c410fa716ee" href="../../../R/60520c410fa716ee.html" target="n" data-glyph="46,1" class="i field">_startMode</a> = <a href="#b4291df75d9bc408" class="t t">WSManTransportManagerUtils</a>.<a href="#591d3d3614fb4562" class="t t">tmStartModes</a>.<a href="#6cebc3fa4e6113a6" class="i field">None</a>;
 
        <b>private readonly string</b> <a id="4b7746154b548bec" href="../../../R/4b7746154b548bec.html" target="n" data-glyph="46,1" class="i field">_sessionName</a>;
 
        <span class="c">// callbacks</span>
        <b>private readonly</b> <a href="PriorityCollection.cs.html#0fa204cb5092e738" class="t t">PrioritySendDataCollection</a>.<a href="PriorityCollection.cs.html#81c7391587f527f6" class="t t">OnDataAvailableCallback</a> <a id="714021c56de8e1d8" href="../../../R/714021c56de8e1d8.html" target="n" data-glyph="46,1" class="i field">_onDataAvailableToSendCallback</a>;
 
        <span class="c">// instance callback handlers</span>
        <b>private</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#5659ff525f41a5f1" class="t t">WSManShellAsync</a> <a id="50df0d6aba0ff464" href="../../../R/50df0d6aba0ff464.html" target="n" data-glyph="46,1" class="i field">_createSessionCallback</a>;
        <b>private</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#5659ff525f41a5f1" class="t t">WSManShellAsync</a> <a id="971d9b6b19cb0ae3" href="../../../R/971d9b6b19cb0ae3.html" target="n" data-glyph="46,1" class="i field">_receivedFromRemote</a>;
        <b>private</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#5659ff525f41a5f1" class="t t">WSManShellAsync</a> <a id="7db9e01d865492bd" href="../../../R/7db9e01d865492bd.html" target="n" data-glyph="46,1" class="i field">_sendToRemoteCompleted</a>;
        <b>private</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#5659ff525f41a5f1" class="t t">WSManShellAsync</a> <a id="1fef853d09949cce" href="../../../R/1fef853d09949cce.html" target="n" data-glyph="46,1" class="i field">_disconnectSessionCompleted</a>;
        <b>private</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#5659ff525f41a5f1" class="t t">WSManShellAsync</a> <a id="3a47dcb9064d8157" href="../../../R/3a47dcb9064d8157.html" target="n" data-glyph="46,1" class="i field">_reconnectSessionCompleted</a>;
        <b>private</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#5659ff525f41a5f1" class="t t">WSManShellAsync</a> <a id="a240d6a8fd1c1826" href="../../../R/a240d6a8fd1c1826.html" target="n" data-glyph="46,1" class="i field">_connectSessionCallback</a>;
        <span class="c">// TODO: This GCHandle is required as it seems WSMan is calling create callback</span>
        <span class="c">// after we call Close. This seems wrong. Opened bug on WSMan to track this.</span>
        <b>private</b> <span class="i">GCHandle</span> <a id="1fb2fbc7b82eea45" href="../../../R/1fb2fbc7b82eea45.html" target="n" data-glyph="46,1" class="i field">_createSessionCallbackGCHandle</a>;
        <b>private</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#5659ff525f41a5f1" class="t t">WSManShellAsync</a> <a id="b58b1df0b8db7760" href="../../../R/b58b1df0b8db7760.html" target="n" data-glyph="46,1" class="i field">_closeSessionCompleted</a>;
 
        <span class="c">// used by WSManCreateShell call to send additional data (like negotiation)</span>
        <span class="c">// during shell creation. This is an instance variable to allow for redirection.</span>
        <b>private</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#c08fd7c84904da7c" class="t t">WSManData_ManToUn</a> <a id="b636a4d17100c22a" href="../../../R/b636a4d17100c22a.html" target="n" data-glyph="46,1" class="i field">_openContent</a>;
        <span class="c">// By default WSMan compresses data sent on the network..use this flag to not do</span>
        <span class="c">// this.</span>
        <b>private bool</b> <a id="dd251fce18794104" href="../../../R/dd251fce18794104.html" target="n" data-glyph="46,1" class="i field">_noCompression</a>;
        <b>private bool</b> <a id="0f8b6e6298fc6a90" href="../../../R/0f8b6e6298fc6a90.html" target="n" data-glyph="46,1" class="i field">_noMachineProfile</a>;
 
        <b>private int</b> <a id="cb2ec538b7b3197c" href="../../../R/cb2ec538b7b3197c.html" target="n" data-glyph="46,1" class="i field">_connectionRetryCount</a>;
 
        <b>private const string</b> <a id="e6e489e431dc1e9e" href="../../../R/../../0000000000.html" target="n" data-glyph="10,1" class="i field">resBaseName</a> = <span class="s">&quot;remotingerroridstrings&quot;</span>;
 
        <span class="c">// Robust connections maximum retry time value in milliseconds.</span>
        <b>private int</b> <a id="bee8d0056d995215" href="../../../R/bee8d0056d995215.html" target="n" data-glyph="46,1" class="i field">_maxRetryTime</a>;
 
        <b>private void</b> <a id="1943689d51db70d7" href="../../../R/1943689d51db70d7.html" target="n" data-glyph="76,1" class="i method">ProcessShellData</a>(<b>string</b> <span id="r20 rd" class="r20 r">data</span>)
        {
            <b>try</b>
            {
                <span class="i">XmlReaderSettings</span> <span id="r21 rd" class="r21 r">settings</span> = <a href="../../serialization.cs.html#758c46d6a86d6840" class="t t">InternalDeserializer</a>.<a href="../../serialization.cs.html#b7ced31d9e3d32cb" class="i property">XmlReaderSettingsForUntrustedXmlDocument</a>.<span class="i">Clone</span>();
                <span class="r21 r">settings</span>.<span class="i">MaxCharactersFromEntities</span> = 1024;      <span class="c">// 1024 is a generous upperbound for shell Xml entries</span>
                <span class="r21 r">settings</span>.<span class="i">MaxCharactersInDocument</span> = 1024 * 30;
                <span class="r21 r">settings</span>.<span class="i">DtdProcessing</span> = <span class="i n">System</span>.<span class="i">Xml</span>.<span class="i">DtdProcessing</span>.<span class="i">Prohibit</span>;
 
                <b>using</b> (<span class="i">XmlReader</span> <span id="r22 rd" class="r22 r">reader</span> = <span class="i">XmlReader</span>.<span class="i">Create</span>(<b>new</b> <span class="i">StringReader</span>(<span class="r20 r">data</span>), <span class="r21 r">settings</span>))
                {
                    <b>while</b> (<span class="r22 r">reader</span>.<span class="i">Read</span>())
                    {
                        <b>if</b> (<span class="r22 r">reader</span>.<span class="i">NodeType</span> == <span class="i">XmlNodeType</span>.<span class="i">Element</span>)
                        {
                            <b>if</b> (<span class="r22 r">reader</span>.<span class="i">LocalName</span>.<span class="i">Equals</span>(<span class="s">&quot;IdleTimeOut&quot;</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>) ||
                                <span class="r22 r">reader</span>.<span class="i">LocalName</span>.<span class="i">Equals</span>(<span class="s">&quot;MaxIdleTimeOut&quot;</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
                            {
                                <b>bool</b> <span id="r23 rd" class="r23 r">settingIdleTimeout</span> =
                                    !<span class="r22 r">reader</span>.<span class="i">LocalName</span>.<span class="i">Equals</span>(<span class="s">&quot;MaxIdleTimeOut&quot;</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>);
 
                                <b>string</b> <span id="r24 rd" class="r24 r">timeoutString</span> = <span class="r22 r">reader</span>.<span class="i">ReadElementContentAsString</span>();
                                <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<span class="i">Assert</span>(<span class="r24 r">timeoutString</span>.<span class="i">Substring</span>(0, 2).<span class="i">Equals</span>(<span class="s">&quot;PT&quot;</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>),
                                    <span class="s">&quot;IdleTimeout is not in expected format&quot;</span>);
 
                                <b>int</b> <span id="r25 rd" class="r25 r">decimalIndex</span> = <span class="r24 r">timeoutString</span>.<span class="i">IndexOf</span>(<span class="s">&#39;.&#39;</span>);
                                <b>try</b>
                                {
                                    <b>int</b> <span id="r26 rd" class="r26 r">timeout</span> = <span class="i">Convert</span>.<span class="i">ToInt32</span>(<span class="r24 r">timeoutString</span>.<span class="i">Substring</span>(2, <span class="r25 r">decimalIndex</span> - 2), <span class="i">NumberFormatInfo</span>.<span class="i">InvariantInfo</span>) * 1000 + <span class="i">Convert</span>.<span class="i">ToInt32</span>(<span class="r24 r">timeoutString</span>.<span class="i">Substring</span>(<span class="r25 r">decimalIndex</span> + 1, 3), <span class="i">NumberFormatInfo</span>.<span class="i">InvariantInfo</span>);
                                    <b>if</b> (<span class="r23 r">settingIdleTimeout</span>)
                                    {
                                        <a href="#c09ce13debcbb880" class="i property">ConnectionInfo</a>.<a href="../common/RunspaceConnectionInfo.cs.html#0c117c8cb5b1de8b" class="i property">IdleTimeout</a> = <span class="r26 r">timeout</span>;
                                    }
                                    <b>else</b>
                                    {
                                        <a href="#c09ce13debcbb880" class="i property">ConnectionInfo</a>.<a href="../common/RunspaceConnectionInfo.cs.html#8f5fff031b021f8b" class="i property">MaxIdleTimeout</a> = <span class="r26 r">timeout</span>;
                                    }
                                }
                                <b>catch</b> (<span class="i">InvalidCastException</span>)
                                {
                                    <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<b>false</b>, <span class="s">&quot;IdleTimeout is not in expected format&quot;</span>);
                                }
                            }
                            <b>else</b> <b>if</b> (<span class="r22 r">reader</span>.<span class="i">LocalName</span>.<span class="i">Equals</span>(<span class="s">&quot;BufferMode&quot;</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
                            {
                                <b>string</b> <span id="r27 rd" class="r27 r">bufferMode</span> = <span class="r22 r">reader</span>.<span class="i">ReadElementContentAsString</span>();
 
                                <b>if</b> (<span class="r27 r">bufferMode</span>.<span class="i">Equals</span>(<span class="s">&quot;Block&quot;</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
                                {
                                    <a href="#c09ce13debcbb880" class="i property">ConnectionInfo</a>.<a href="../common/RunspaceConnectionInfo.cs.html#10ef35a810ea13c2" class="i property">OutputBufferingMode</a> = <span class="i n">Runspaces</span>.<a href="../common/RunspaceConnectionInfo.cs.html#9cb40ac520a09a1d" class="t t">OutputBufferingMode</a>.<a href="../common/RunspaceConnectionInfo.cs.html#1973173f1a07408a" class="i field">Block</a>;
                                }
                                <b>else</b> <b>if</b> (<span class="r27 r">bufferMode</span>.<span class="i">Equals</span>(<span class="s">&quot;Drop&quot;</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
                                {
                                    <a href="#c09ce13debcbb880" class="i property">ConnectionInfo</a>.<a href="../common/RunspaceConnectionInfo.cs.html#10ef35a810ea13c2" class="i property">OutputBufferingMode</a> = <span class="i n">Runspaces</span>.<a href="../common/RunspaceConnectionInfo.cs.html#9cb40ac520a09a1d" class="t t">OutputBufferingMode</a>.<a href="../common/RunspaceConnectionInfo.cs.html#ffb9892e18d7c551" class="i field">Drop</a>;
                                }
                                <b>else</b>
                                {
                                    <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<b>false</b>, <span class="s">&quot;unexpected buffer mode&quot;</span>);
                                }
                            }
                        }
                    }
                }
            }
            <b>catch</b> (<span class="i">XmlException</span>)
            {
                <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<b>false</b>, <span class="s">&quot;shell xml is in unexpected format&quot;</span>);
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Static Data
 
        <span class="c">// static callback delegate</span>
        <b>private static</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#9855dfa19ee2dc9d" class="t t">WSManShellAsyncCallback</a> <a id="f3911029d149d577" href="../../../R/f3911029d149d577.html" target="n" data-glyph="46,1" class="i field">s_sessionCreateCallback</a>;
        <b>private static</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#9855dfa19ee2dc9d" class="t t">WSManShellAsyncCallback</a> <a id="8ce19afc5f4dbbe8" href="../../../R/8ce19afc5f4dbbe8.html" target="n" data-glyph="46,1" class="i field">s_sessionCloseCallback</a>;
        <b>private static</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#9855dfa19ee2dc9d" class="t t">WSManShellAsyncCallback</a> <a id="f4733d79a2e2decf" href="../../../R/f4733d79a2e2decf.html" target="n" data-glyph="46,1" class="i field">s_sessionReceiveCallback</a>;
        <b>private static</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#9855dfa19ee2dc9d" class="t t">WSManShellAsyncCallback</a> <a id="aa21f6e1b86c1390" href="../../../R/aa21f6e1b86c1390.html" target="n" data-glyph="46,1" class="i field">s_sessionSendCallback</a>;
        <b>private static</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#9855dfa19ee2dc9d" class="t t">WSManShellAsyncCallback</a> <a id="2a4b7151587a3aed" href="../../../R/2a4b7151587a3aed.html" target="n" data-glyph="46,1" class="i field">s_sessionDisconnectCallback</a>;
        <b>private static</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#9855dfa19ee2dc9d" class="t t">WSManShellAsyncCallback</a> <a id="5aef0fdcb186b30c" href="../../../R/5aef0fdcb186b30c.html" target="n" data-glyph="46,1" class="i field">s_sessionReconnectCallback</a>;
        <b>private static</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#9855dfa19ee2dc9d" class="t t">WSManShellAsyncCallback</a> <a id="613a73a8fc3a5a9d" href="../../../R/613a73a8fc3a5a9d.html" target="n" data-glyph="46,1" class="i field">s_sessionConnectCallback</a>;
 
        <span class="c">// This dictionary maintains active session transport managers to be used from various</span>
        <span class="c">// callbacks.</span>
        <b>private static readonly</b> <span class="i">Dictionary</span>&lt;<b>long</b>, <a href="#693b43214373ab1e" class="t t">WSManClientSessionTransportManager</a>&gt; <a id="8e29e1ab04d057b3" href="../../../R/8e29e1ab04d057b3.html" target="n" data-glyph="46,1" class="i field">s_sessionTMHandles</a> =
            <b>new</b> <span class="i">Dictionary</span>&lt;<b>long</b>, <a href="#693b43214373ab1e" class="t t">WSManClientSessionTransportManager</a>&gt;();
 
        <b>private static long</b> <a id="da75a649ef7a1b5c" href="../../../R/da75a649ef7a1b5c.html" target="n" data-glyph="46,1" class="i field">s_sessionTMSeed</a>;
 
        <span class="c">// generate unique session id</span>
        <b>private static long</b> <a id="ecba37fa08d1e9e1" href="../../../R/ecba37fa08d1e9e1.html" target="n" data-glyph="76,1" class="i method">GetNextSessionTMHandleId</a>()
        {
            <b>return</b> <span class="i n">System</span>.<span class="i">Threading</span>.<span class="i">Interlocked</span>.<span class="i">Increment</span>(<b>ref</b> <a href="#da75a649ef7a1b5c" class="i field">s_sessionTMSeed</a>);
        }
 
        <span class="c">// we need a synchronized add and remove so that multiple threads</span>
        <span class="c">// update the data store concurrently</span>
        <b>private static void</b> <a id="9005741d9643ab64" href="../../../R/9005741d9643ab64.html" target="n" data-glyph="76,1" class="i method">AddSessionTransportManager</a>(<b>long</b> <span id="r28 rd" class="r28 r">sessnTMId</span>,
            <a href="#693b43214373ab1e" class="t t">WSManClientSessionTransportManager</a> <span id="r29 rd" class="r29 r">sessnTransportManager</span>)
        {
            <b>lock</b> (<a href="#8e29e1ab04d057b3" class="i field">s_sessionTMHandles</a>)
            {
                <a href="#8e29e1ab04d057b3" class="i field">s_sessionTMHandles</a>.<span class="i">Add</span>(<span class="r28 r">sessnTMId</span>, <span class="r29 r">sessnTransportManager</span>);
            }
        }
 
        <b>private static void</b> <a id="821511033f76b57e" href="../../../R/821511033f76b57e.html" target="n" data-glyph="76,1" class="i method">RemoveSessionTransportManager</a>(<b>long</b> <span id="r30 rd" class="r30 r">sessnTMId</span>)
        {
            <b>lock</b> (<a href="#8e29e1ab04d057b3" class="i field">s_sessionTMHandles</a>)
            {
                <a href="#8e29e1ab04d057b3" class="i field">s_sessionTMHandles</a>.<span class="i">Remove</span>(<span class="r30 r">sessnTMId</span>);
            }
        }
 
        <span class="c">// we need a synchronized add and remove so that multiple threads</span>
        <span class="c">// update the data store concurrently</span>
        <b>private static bool</b> <a id="2a75e4ba1391788d" href="../../../R/2a75e4ba1391788d.html" target="n" data-glyph="76,1" class="i method">TryGetSessionTransportManager</a>(<span class="i">IntPtr</span> <span id="r31 rd" class="r31 r">operationContext</span>,
            <b>out</b> <a href="#693b43214373ab1e" class="t t">WSManClientSessionTransportManager</a> <span id="r32 rd" class="r32 r">sessnTransportManager</span>,
            <b>out long</b> <span id="r33 rd" class="r33 r">sessnTMId</span>)
        {
            <span class="r33 r">sessnTMId</span> = <span class="r31 r">operationContext</span>.<span class="i">ToInt64</span>();
            <span class="r32 r">sessnTransportManager</span> = <b>null</b>;
            <b>lock</b> (<a href="#8e29e1ab04d057b3" class="i field">s_sessionTMHandles</a>)
            {
                <b>return</b> <a href="#8e29e1ab04d057b3" class="i field">s_sessionTMHandles</a>.<span class="i">TryGetValue</span>(<span class="r33 r">sessnTMId</span>, <b>out</b> <span class="r32 r">sessnTransportManager</span>);
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> SHIM: Redirection delegates for test purposes
 
        <b>private static readonly</b> <span class="i">Delegate</span> <a id="687643a8ddd6f0bc" href="../../../R/687643a8ddd6f0bc.html" target="n" data-glyph="46,1" class="i field">s_sessionSendRedirect</a> = <b>null</b>;
        <b>private static readonly</b> <span class="i">Delegate</span> <a id="249d04171f6fe265" href="../../../R/249d04171f6fe265.html" target="n" data-glyph="46,1" class="i field">s_protocolVersionRedirect</a> = <b>null</b>;
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Constructors
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Static constructor to initialize WSMan Client stack.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>static</b> <a id="08cdda3c028c3e33" href="../../../R/../../0000000000.html" target="n" data-glyph="76,1" class="t method">WSManClientSessionTransportManager</a>()
        {
            <span class="c">// Initialize callback delegates</span>
            <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#e157acfccf186ce7" class="t t">WSManShellCompletionFunction</a> <span id="r34 rd" class="r34 r">createDelegate</span> =
                <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<span class="t">WSManShellCompletionFunction</span>(<a href="#40b11df684553a3c" class="i method">OnCreateSessionCallback</a>);
            <a href="#f3911029d149d577" class="i field">s_sessionCreateCallback</a> = <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#2af3c7c6053b5898" class="t constructor">WSManShellAsyncCallback</a>(<span class="r34 r">createDelegate</span>);
 
            <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#e157acfccf186ce7" class="t t">WSManShellCompletionFunction</a> <span id="r35 rd" class="r35 r">closeDelegate</span> =
                <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<span class="t">WSManShellCompletionFunction</span>(<a href="#dc2f938509fd0d71" class="i method">OnCloseSessionCompleted</a>);
            <a href="#8ce19afc5f4dbbe8" class="i field">s_sessionCloseCallback</a> = <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#2af3c7c6053b5898" class="t constructor">WSManShellAsyncCallback</a>(<span class="r35 r">closeDelegate</span>);
 
            <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#e157acfccf186ce7" class="t t">WSManShellCompletionFunction</a> <span id="r36 rd" class="r36 r">receiveDelegate</span> =
                <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<span class="t">WSManShellCompletionFunction</span>(<a href="#d89ac756e5cdbf71" class="i method">OnRemoteSessionDataReceived</a>);
            <a href="#f4733d79a2e2decf" class="i field">s_sessionReceiveCallback</a> = <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#2af3c7c6053b5898" class="t constructor">WSManShellAsyncCallback</a>(<span class="r36 r">receiveDelegate</span>);
 
            <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#e157acfccf186ce7" class="t t">WSManShellCompletionFunction</a> <span id="r37 rd" class="r37 r">sendDelegate</span> =
                <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<span class="t">WSManShellCompletionFunction</span>(<a href="#d18606befb8232b8" class="i method">OnRemoteSessionSendCompleted</a>);
            <a href="#aa21f6e1b86c1390" class="i field">s_sessionSendCallback</a> = <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#2af3c7c6053b5898" class="t constructor">WSManShellAsyncCallback</a>(<span class="r37 r">sendDelegate</span>);
 
            <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#e157acfccf186ce7" class="t t">WSManShellCompletionFunction</a> <span id="r38 rd" class="r38 r">disconnectDelegate</span> =
                <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<span class="t">WSManShellCompletionFunction</span>(<a href="#3fcf7707c14346d8" class="i method">OnRemoteSessionDisconnectCompleted</a>);
            <a href="#2a4b7151587a3aed" class="i field">s_sessionDisconnectCallback</a> = <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#2af3c7c6053b5898" class="t constructor">WSManShellAsyncCallback</a>(<span class="r38 r">disconnectDelegate</span>);
 
            <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#e157acfccf186ce7" class="t t">WSManShellCompletionFunction</a> <span id="r39 rd" class="r39 r">reconnectDelegate</span> =
                <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<span class="t">WSManShellCompletionFunction</span>(<a href="#c8506084008d58dd" class="i method">OnRemoteSessionReconnectCompleted</a>);
            <a href="#5aef0fdcb186b30c" class="i field">s_sessionReconnectCallback</a> = <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#2af3c7c6053b5898" class="t constructor">WSManShellAsyncCallback</a>(<span class="r39 r">reconnectDelegate</span>);
 
            <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#e157acfccf186ce7" class="t t">WSManShellCompletionFunction</a> <span id="r40 rd" class="r40 r">connectDelegate</span> =
                <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<span class="t">WSManShellCompletionFunction</span>(<a href="#530fa3f688c6fac5" class="i method">OnRemoteSessionConnectCallback</a>);
            <a href="#613a73a8fc3a5a9d" class="i field">s_sessionConnectCallback</a> = <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#2af3c7c6053b5898" class="t constructor">WSManShellAsyncCallback</a>(<span class="r40 r">connectDelegate</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Constructor. This will create a new PrioritySendDataCollection which should be used to</span>
        <span class="c">///</span><span class="c"> send data to the server.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r41 r">runspacePoolInstanceId</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This is used for logging trace/operational crimson messages. Having this id in the logs</span>
        <span class="c">///</span><span class="c"> helps a user to map which transport is created for which runspace.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r42 r">connectionInfo</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Connection info to use while connecting to the remote machine.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r43 r">cryptoHelper</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Crypto helper.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r44 r">sessionName</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Session friendly name.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="../../../utils/MshInvalidOperationException.cs.html#259a38c8b594783c" class="t t">PSInvalidOperationException</a><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> 1. Create Session failed with a non-zero error code.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>internal</b> <a id="9ceba7a90627fbde" href="../../../R/9ceba7a90627fbde.html" target="n" data-glyph="74,1" class="t constructor">WSManClientSessionTransportManager</a>(
            <span class="i">Guid</span> <span id="r41 rd" class="r41 r">runspacePoolInstanceId</span>,
            <a href="../common/RunspaceConnectionInfo.cs.html#2d9d176ef419be5a" class="t t">WSManConnectionInfo</a> <span id="r42 rd" class="r42 r">connectionInfo</span>,
            <a href="../../../utils/CryptoUtils.cs.html#1999dfb2439af5a0" class="t t">PSRemotingCryptoHelper</a> <span id="r43 rd" class="r43 r">cryptoHelper</span>,
            <b>string</b> <span id="r44 rd" class="r44 r">sessionName</span>)
            : <a href="BaseTransportManager.cs.html#be06f3503cfac6d4" class="k">base</a>(<span class="r41 r">runspacePoolInstanceId</span>, <span class="r43 r">cryptoHelper</span>)
        {
            <span class="c">// Initialize WSMan instance</span>
            <a href="#7616e1c5a9b266f9" class="i property">WSManAPIData</a> = <b>new</b> <a href="#81e0524cd7809211" class="t constructor">WSManAPIDataCommon</a>();
            <b>if</b> (<a href="#7616e1c5a9b266f9" class="i property">WSManAPIData</a>.<a href="#f386d97c12d99137" class="i property">WSManAPIHandle</a> == <span class="i">IntPtr</span>.<span class="i">Zero</span>)
            {
                <b>throw</b> <b>new</b> <a href="../common/remotingexceptions.cs.html#3d42c01e0f93455e" class="t constructor">PSRemotingTransportException</a>(
                    <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">WSManInitFailed</span>, <a href="#7616e1c5a9b266f9" class="i property">WSManAPIData</a>.<a href="#aab5d26a8e241769" class="i property">ErrorCode</a>));
            }
 
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r42 r">connectionInfo</span> != <b>null</b>, <span class="s">&quot;connectionInfo cannot be null&quot;</span>);
 
            <a href="BaseTransportManager.cs.html#30975a92e0bc8f5d" class="i property">CryptoHelper</a> = <span class="r43 r">cryptoHelper</span>;
            <a href="BaseTransportManager.cs.html#ee4a2ac1afa72dce" class="i field">dataToBeSent</a>.<a href="PriorityCollection.cs.html#84bdedfd536de402" class="i property">Fragmentor</a> = <a href="BaseTransportManager.cs.html#19883ec4df424177" class="k">base</a>.<a href="BaseTransportManager.cs.html#0597b18306926355" class="i property">Fragmentor</a>;
            <a href="#4b7746154b548bec" class="i field">_sessionName</a> = <span class="r44 r">sessionName</span>;
 
            <span class="c">// session transport manager can receive unlimited data..however each object is limited</span>
            <span class="c">// by maxRecvdObjectSize. this is to allow clients to use a session for an unlimited time..</span>
            <span class="c">// also the messages that can be sent to a session are limited and very controlled.</span>
            <span class="c">// However a command transport manager can be restricted to receive only a fixed amount of data</span>
            <span class="c">// controlled by maxRecvdDataSizeCommand..This is because commands can accept any number of input</span>
            <span class="c">// objects.</span>
            <a href="BaseTransportManager.cs.html#766c6c998b78695f" class="i property">ReceivedDataCollection</a>.<a href="PriorityCollection.cs.html#7a540327df6a2e2d" class="i property">MaximumReceivedDataSize</a> = <b>null</b>;
            <a href="BaseTransportManager.cs.html#766c6c998b78695f" class="i property">ReceivedDataCollection</a>.<a href="PriorityCollection.cs.html#24de42a1b1c1d4b9" class="i property">MaximumReceivedObjectSize</a> = <span class="r42 r">connectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#72cfe9a0c294ec04" class="i property">MaximumReceivedObjectSize</a>;
 
            <a href="#714021c56de8e1d8" class="i field">_onDataAvailableToSendCallback</a> =
                <b>new</b> <a href="PriorityCollection.cs.html#0fa204cb5092e738" class="t t">PrioritySendDataCollection</a>.<span class="t">OnDataAvailableCallback</span>(<a href="#e3dbec6c7a9edb03" class="i method">OnDataAvailableCallback</a>);
 
            <a href="#7136af64fcdcedf6" class="i method">Initialize</a>(<span class="r42 r">connectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#eb73ffdb9b586505" class="i property">ConnectionUri</a>, <span class="r42 r">connectionInfo</span>);
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Set Session Options
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Sets default timeout for all client operations in milliseconds.</span>
        <span class="c">///</span><span class="c"> TODO: Sync with WSMan and figure out what the default is if we</span>
        <span class="c">///</span><span class="c"> dont set.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r45 r">milliseconds</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="../../../utils/MshInvalidOperationException.cs.html#259a38c8b594783c" class="t t">PSInvalidOperationException</a><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Setting session option failed with a non-zero error code.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="f2ed25563d47e421" href="../../../R/f2ed25563d47e421.html" target="n" data-glyph="74,1" class="i method">SetDefaultTimeOut</a>(<b>int</b> <span id="r45 rd" class="r45 r">milliseconds</span>)
        {
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<a href="#e71b1b284f1d2a52" class="i field">_wsManSessionHandle</a> != <span class="i">IntPtr</span>.<span class="i">Zero</span>, <span class="s">&quot;Session handle cannot be null&quot;</span>);
            <b>using</b> (<a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<a href="../../../utils/StructuredTraceSource.cs.html#1d6ac2f38dece154" class="i method">TraceMethod</a>(<span class="s">&quot;Setting Default timeout: {0} milliseconds&quot;</span>, <span class="r45 r">milliseconds</span>))
            {
                <b>int</b> <span id="r46 rd" class="r46 r">result</span> = <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#8657f3f36882e0cf" class="i method">WSManSetSessionOption</a>(<a href="#e71b1b284f1d2a52" class="i field">_wsManSessionHandle</a>,
                    <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#f99c2939972a9aca" class="t t">WSManSessionOption</a>.<a href="WSManNativeAPI.cs.html#492be0cc81133200" class="i field">WSMAN_OPTION_DEFAULT_OPERATION_TIMEOUTMS</a>,
                    <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#3355ebe78b09feca" class="t constructor">WSManDataDWord</a>(<span class="r45 r">milliseconds</span>));
 
                <b>if</b> (<span class="r46 r">result</span> != 0)
                {
                    <span class="c">// Get the error message from WSMan</span>
                    <b>string</b> <span id="r47 rd" class="r47 r">errorMessage</span> = <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#0daa89ea27b8128f" class="i method">WSManGetErrorMessage</a>(<a href="#7616e1c5a9b266f9" class="i property">WSManAPIData</a>.<a href="#f386d97c12d99137" class="i property">WSManAPIHandle</a>, <span class="r46 r">result</span>);
 
                    <a href="../../../utils/MshInvalidOperationException.cs.html#259a38c8b594783c" class="t t">PSInvalidOperationException</a> <span id="r48 rd" class="r48 r">exception</span> = <b>new</b> <a href="../../../utils/MshInvalidOperationException.cs.html#de5b942a57457045" class="t constructor">PSInvalidOperationException</a>(<span class="r47 r">errorMessage</span>);
                    <b>throw</b> <span class="r48 r">exception</span>;
                }
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Sets timeout for Create operation in milliseconds.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r49 r">milliseconds</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="../../../utils/MshInvalidOperationException.cs.html#259a38c8b594783c" class="t t">PSInvalidOperationException</a><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Setting session option failed with a non-zero error code.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="96e9cf4880e8c3ae" href="../../../R/96e9cf4880e8c3ae.html" target="n" data-glyph="74,1" class="i method">SetConnectTimeOut</a>(<b>int</b> <span id="r49 rd" class="r49 r">milliseconds</span>)
        {
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<a href="#e71b1b284f1d2a52" class="i field">_wsManSessionHandle</a> != <span class="i">IntPtr</span>.<span class="i">Zero</span>, <span class="s">&quot;Session handle cannot be null&quot;</span>);
            <b>using</b> (<a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<a href="../../../utils/StructuredTraceSource.cs.html#1d6ac2f38dece154" class="i method">TraceMethod</a>(<span class="s">&quot;Setting CreateShell timeout: {0} milliseconds&quot;</span>, <span class="r49 r">milliseconds</span>))
            {
                <b>int</b> <span id="r50 rd" class="r50 r">result</span> = <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#8657f3f36882e0cf" class="i method">WSManSetSessionOption</a>(<a href="#e71b1b284f1d2a52" class="i field">_wsManSessionHandle</a>,
                    <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#f99c2939972a9aca" class="t t">WSManSessionOption</a>.<a href="WSManNativeAPI.cs.html#3d5e40670c495e56" class="i field">WSMAN_OPTION_TIMEOUTMS_CREATE_SHELL</a>,
                    <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#3355ebe78b09feca" class="t constructor">WSManDataDWord</a>(<span class="r49 r">milliseconds</span>));
 
                <b>if</b> (<span class="r50 r">result</span> != 0)
                {
                    <span class="c">// Get the error message from WSMan</span>
                    <b>string</b> <span id="r51 rd" class="r51 r">errorMessage</span> = <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#0daa89ea27b8128f" class="i method">WSManGetErrorMessage</a>(<a href="#7616e1c5a9b266f9" class="i property">WSManAPIData</a>.<a href="#f386d97c12d99137" class="i property">WSManAPIHandle</a>, <span class="r50 r">result</span>);
 
                    <a href="../../../utils/MshInvalidOperationException.cs.html#259a38c8b594783c" class="t t">PSInvalidOperationException</a> <span id="r52 rd" class="r52 r">exception</span> = <b>new</b> <a href="../../../utils/MshInvalidOperationException.cs.html#de5b942a57457045" class="t constructor">PSInvalidOperationException</a>(<span class="r51 r">errorMessage</span>);
                    <b>throw</b> <span class="r52 r">exception</span>;
                }
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Sets timeout for Close operation in milliseconds.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r53 r">milliseconds</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="../../../utils/MshInvalidOperationException.cs.html#259a38c8b594783c" class="t t">PSInvalidOperationException</a><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Setting session option failed with a non-zero error code.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="d2060f96de4cec57" href="../../../R/d2060f96de4cec57.html" target="n" data-glyph="74,1" class="i method">SetCloseTimeOut</a>(<b>int</b> <span id="r53 rd" class="r53 r">milliseconds</span>)
        {
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<a href="#e71b1b284f1d2a52" class="i field">_wsManSessionHandle</a> != <span class="i">IntPtr</span>.<span class="i">Zero</span>, <span class="s">&quot;Session handle cannot be null&quot;</span>);
            <b>using</b> (<a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<a href="../../../utils/StructuredTraceSource.cs.html#1d6ac2f38dece154" class="i method">TraceMethod</a>(<span class="s">&quot;Setting CloseShell timeout: {0} milliseconds&quot;</span>, <span class="r53 r">milliseconds</span>))
            {
                <b>int</b> <span id="r54 rd" class="r54 r">result</span> = <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#8657f3f36882e0cf" class="i method">WSManSetSessionOption</a>(<a href="#e71b1b284f1d2a52" class="i field">_wsManSessionHandle</a>,
                    <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#f99c2939972a9aca" class="t t">WSManSessionOption</a>.<a href="WSManNativeAPI.cs.html#d852effe02fa00b5" class="i field">WSMAN_OPTION_TIMEOUTMS_CLOSE_SHELL_OPERATION</a>,
                    <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#3355ebe78b09feca" class="t constructor">WSManDataDWord</a>(<span class="r53 r">milliseconds</span>));
 
                <b>if</b> (<span class="r54 r">result</span> != 0)
                {
                    <span class="c">// Get the error message from WSMan</span>
                    <b>string</b> <span id="r55 rd" class="r55 r">errorMessage</span> = <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#0daa89ea27b8128f" class="i method">WSManGetErrorMessage</a>(<a href="#7616e1c5a9b266f9" class="i property">WSManAPIData</a>.<a href="#f386d97c12d99137" class="i property">WSManAPIHandle</a>, <span class="r54 r">result</span>);
 
                    <a href="../../../utils/MshInvalidOperationException.cs.html#259a38c8b594783c" class="t t">PSInvalidOperationException</a> <span id="r56 rd" class="r56 r">exception</span> = <b>new</b> <a href="../../../utils/MshInvalidOperationException.cs.html#de5b942a57457045" class="t constructor">PSInvalidOperationException</a>(<span class="r55 r">errorMessage</span>);
                    <b>throw</b> <span class="r56 r">exception</span>;
                }
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Sets timeout for SendShellInput operation in milliseconds.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r57 r">milliseconds</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="../../../utils/MshInvalidOperationException.cs.html#259a38c8b594783c" class="t t">PSInvalidOperationException</a><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Setting session option failed with a non-zero error code.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="d41a4d7117410b71" href="../../../R/../../0000000000.html" target="n" data-glyph="74,1" class="i method">SetSendTimeOut</a>(<b>int</b> <span id="r57 rd" class="r57 r">milliseconds</span>)
        {
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<a href="#e71b1b284f1d2a52" class="i field">_wsManSessionHandle</a> != <span class="i">IntPtr</span>.<span class="i">Zero</span>, <span class="s">&quot;Session handle cannot be null&quot;</span>);
            <b>using</b> (<a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<a href="../../../utils/StructuredTraceSource.cs.html#1d6ac2f38dece154" class="i method">TraceMethod</a>(<span class="s">&quot;Setting SendShellInput timeout: {0} milliseconds&quot;</span>, <span class="r57 r">milliseconds</span>))
            {
                <b>int</b> <span id="r58 rd" class="r58 r">result</span> = <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#8657f3f36882e0cf" class="i method">WSManSetSessionOption</a>(<a href="#e71b1b284f1d2a52" class="i field">_wsManSessionHandle</a>,
                    <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#f99c2939972a9aca" class="t t">WSManSessionOption</a>.<a href="WSManNativeAPI.cs.html#78cf29445ec34e66" class="i field">WSMAN_OPTION_TIMEOUTMS_SEND_SHELL_INPUT</a>,
                    <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#3355ebe78b09feca" class="t constructor">WSManDataDWord</a>(<span class="r57 r">milliseconds</span>));
 
                <b>if</b> (<span class="r58 r">result</span> != 0)
                {
                    <span class="c">// Get the error message from WSMan</span>
                    <b>string</b> <span id="r59 rd" class="r59 r">errorMessage</span> = <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#0daa89ea27b8128f" class="i method">WSManGetErrorMessage</a>(<a href="#7616e1c5a9b266f9" class="i property">WSManAPIData</a>.<a href="#f386d97c12d99137" class="i property">WSManAPIHandle</a>, <span class="r58 r">result</span>);
 
                    <a href="../../../utils/MshInvalidOperationException.cs.html#259a38c8b594783c" class="t t">PSInvalidOperationException</a> <span id="r60 rd" class="r60 r">exception</span> = <b>new</b> <a href="../../../utils/MshInvalidOperationException.cs.html#de5b942a57457045" class="t constructor">PSInvalidOperationException</a>(<span class="r59 r">errorMessage</span>);
                    <b>throw</b> <span class="r60 r">exception</span>;
                }
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Sets timeout for Receive operation in milliseconds.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r61 r">milliseconds</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="../../../utils/MshInvalidOperationException.cs.html#259a38c8b594783c" class="t t">PSInvalidOperationException</a><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Setting session option failed with a non-zero error code.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="8cf2d335f2885b69" href="../../../R/../../0000000000.html" target="n" data-glyph="74,1" class="i method">SetReceiveTimeOut</a>(<b>int</b> <span id="r61 rd" class="r61 r">milliseconds</span>)
        {
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<a href="#e71b1b284f1d2a52" class="i field">_wsManSessionHandle</a> != <span class="i">IntPtr</span>.<span class="i">Zero</span>, <span class="s">&quot;Session handle cannot be null&quot;</span>);
            <b>using</b> (<a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<a href="../../../utils/StructuredTraceSource.cs.html#1d6ac2f38dece154" class="i method">TraceMethod</a>(<span class="s">&quot;Setting ReceiveShellOutput timeout: {0} milliseconds&quot;</span>, <span class="r61 r">milliseconds</span>))
            {
                <b>int</b> <span id="r62 rd" class="r62 r">result</span> = <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#8657f3f36882e0cf" class="i method">WSManSetSessionOption</a>(<a href="#e71b1b284f1d2a52" class="i field">_wsManSessionHandle</a>,
                    <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#f99c2939972a9aca" class="t t">WSManSessionOption</a>.<a href="WSManNativeAPI.cs.html#2cabe7c172f06d78" class="i field">WSMAN_OPTION_TIMEOUTMS_RECEIVE_SHELL_OUTPUT</a>,
                    <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#3355ebe78b09feca" class="t constructor">WSManDataDWord</a>(<span class="r61 r">milliseconds</span>));
 
                <b>if</b> (<span class="r62 r">result</span> != 0)
                {
                    <span class="c">// Get the error message from WSMan</span>
                    <b>string</b> <span id="r63 rd" class="r63 r">errorMessage</span> = <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#0daa89ea27b8128f" class="i method">WSManGetErrorMessage</a>(<a href="#7616e1c5a9b266f9" class="i property">WSManAPIData</a>.<a href="#f386d97c12d99137" class="i property">WSManAPIHandle</a>, <span class="r62 r">result</span>);
 
                    <a href="../../../utils/MshInvalidOperationException.cs.html#259a38c8b594783c" class="t t">PSInvalidOperationException</a> <span id="r64 rd" class="r64 r">exception</span> = <b>new</b> <a href="../../../utils/MshInvalidOperationException.cs.html#de5b942a57457045" class="t constructor">PSInvalidOperationException</a>(<span class="r63 r">errorMessage</span>);
                    <b>throw</b> <span class="r64 r">exception</span>;
                }
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Sets timeout for Signal operation in milliseconds.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r65 r">milliseconds</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="../../../utils/MshInvalidOperationException.cs.html#259a38c8b594783c" class="t t">PSInvalidOperationException</a><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Setting session option failed with a non-zero error code.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="fc4d3d676ba165ed" href="../../../R/fc4d3d676ba165ed.html" target="n" data-glyph="74,1" class="i method">SetSignalTimeOut</a>(<b>int</b> <span id="r65 rd" class="r65 r">milliseconds</span>)
        {
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<a href="#e71b1b284f1d2a52" class="i field">_wsManSessionHandle</a> != <span class="i">IntPtr</span>.<span class="i">Zero</span>, <span class="s">&quot;Session handle cannot be null&quot;</span>);
            <b>using</b> (<a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<a href="../../../utils/StructuredTraceSource.cs.html#1d6ac2f38dece154" class="i method">TraceMethod</a>(<span class="s">&quot;Setting SignalShell timeout: {0} milliseconds&quot;</span>, <span class="r65 r">milliseconds</span>))
            {
                <b>int</b> <span id="r66 rd" class="r66 r">result</span> = <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#8657f3f36882e0cf" class="i method">WSManSetSessionOption</a>(<a href="#e71b1b284f1d2a52" class="i field">_wsManSessionHandle</a>,
                    <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#f99c2939972a9aca" class="t t">WSManSessionOption</a>.<a href="WSManNativeAPI.cs.html#6dd1d3290294bc97" class="i field">WSMAN_OPTION_TIMEOUTMS_SIGNAL_SHELL</a>,
                    <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#3355ebe78b09feca" class="t constructor">WSManDataDWord</a>(<span class="r65 r">milliseconds</span>));
 
                <b>if</b> (<span class="r66 r">result</span> != 0)
                {
                    <span class="c">// Get the error message from WSMan</span>
                    <b>string</b> <span id="r67 rd" class="r67 r">errorMessage</span> = <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#0daa89ea27b8128f" class="i method">WSManGetErrorMessage</a>(<a href="#7616e1c5a9b266f9" class="i property">WSManAPIData</a>.<a href="#f386d97c12d99137" class="i property">WSManAPIHandle</a>, <span class="r66 r">result</span>);
 
                    <a href="../../../utils/MshInvalidOperationException.cs.html#259a38c8b594783c" class="t t">PSInvalidOperationException</a> <span id="r68 rd" class="r68 r">exception</span> = <b>new</b> <a href="../../../utils/MshInvalidOperationException.cs.html#de5b942a57457045" class="t constructor">PSInvalidOperationException</a>(<span class="r67 r">errorMessage</span>);
                    <b>throw</b> <span class="r68 r">exception</span>;
                }
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Sets a DWORD value for a WSMan Session option.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r69 r">option</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r70 r">dwordData</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="../../../utils/MshInvalidOperationException.cs.html#259a38c8b594783c" class="t t">PSInvalidOperationException</a><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Setting session option failed with a non-zero error code.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="6afd4b7993df20d4" href="../../../R/6afd4b7993df20d4.html" target="n" data-glyph="74,1" class="i method">SetWSManSessionOption</a>(<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#f99c2939972a9aca" class="t t">WSManSessionOption</a> <span id="r69 rd" class="r69 r">option</span>, <b>int</b> <span id="r70 rd" class="r70 r">dwordData</span>)
        {
            <b>int</b> <span id="r71 rd" class="r71 r">result</span> = <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#8657f3f36882e0cf" class="i method">WSManSetSessionOption</a>(<a href="#e71b1b284f1d2a52" class="i field">_wsManSessionHandle</a>,
                <span class="r69 r">option</span>, <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#3355ebe78b09feca" class="t constructor">WSManDataDWord</a>(<span class="r70 r">dwordData</span>));
 
            <b>if</b> (<span class="r71 r">result</span> != 0)
            {
                <span class="c">// Get the error message from WSMan</span>
                <b>string</b> <span id="r72 rd" class="r72 r">errorMessage</span> = <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#0daa89ea27b8128f" class="i method">WSManGetErrorMessage</a>(<a href="#7616e1c5a9b266f9" class="i property">WSManAPIData</a>.<a href="#f386d97c12d99137" class="i property">WSManAPIHandle</a>, <span class="r71 r">result</span>);
 
                <a href="../../../utils/MshInvalidOperationException.cs.html#259a38c8b594783c" class="t t">PSInvalidOperationException</a> <span id="r73 rd" class="r73 r">exception</span> = <b>new</b> <a href="../../../utils/MshInvalidOperationException.cs.html#de5b942a57457045" class="t constructor">PSInvalidOperationException</a>(<span class="r72 r">errorMessage</span>);
                <b>throw</b> <span class="r73 r">exception</span>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Sets a string value for a WSMan Session option.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r74 r">option</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r75 r">stringData</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="../../../utils/MshInvalidOperationException.cs.html#259a38c8b594783c" class="t t">PSInvalidOperationException</a><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Setting session option failed with a non-zero error code.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="474f20c06f78078f" href="../../../R/474f20c06f78078f.html" target="n" data-glyph="74,1" class="i method">SetWSManSessionOption</a>(<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#f99c2939972a9aca" class="t t">WSManSessionOption</a> <span id="r74 rd" class="r74 r">option</span>, <b>string</b> <span id="r75 rd" class="r75 r">stringData</span>)
        {
            <b>using</b> (<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#c08fd7c84904da7c" class="t t">WSManData_ManToUn</a> <span id="r76 rd" class="r76 r">data</span> = <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#52cf8f7c05242097" class="t constructor">WSManData_ManToUn</a>(<span class="r75 r">stringData</span>))
            {
                <b>int</b> <span id="r77 rd" class="r77 r">result</span> = <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#f90a5172f741cc29" class="i method">WSManSetSessionOption</a>(<a href="#e71b1b284f1d2a52" class="i field">_wsManSessionHandle</a>,
                      <span class="r74 r">option</span>, <span class="r76 r">data</span>);
 
                <b>if</b> (<span class="r77 r">result</span> != 0)
                {
                    <span class="c">// Get the error message from WSMan</span>
                    <b>string</b> <span id="r78 rd" class="r78 r">errorMessage</span> = <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#0daa89ea27b8128f" class="i method">WSManGetErrorMessage</a>(<a href="#7616e1c5a9b266f9" class="i property">WSManAPIData</a>.<a href="#f386d97c12d99137" class="i property">WSManAPIHandle</a>, <span class="r77 r">result</span>);
 
                    <a href="../../../utils/MshInvalidOperationException.cs.html#259a38c8b594783c" class="t t">PSInvalidOperationException</a> <span id="r79 rd" class="r79 r">exception</span> = <b>new</b> <a href="../../../utils/MshInvalidOperationException.cs.html#de5b942a57457045" class="t constructor">PSInvalidOperationException</a>(<span class="r78 r">errorMessage</span>);
                    <b>throw</b> <span class="r79 r">exception</span>;
                }
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Internal Methods / Properties
 
        <b>internal</b> <a href="#d144f8a5fae9b9c5" class="t t">WSManAPIDataCommon</a> <a id="7616e1c5a9b266f9" href="../../../R/7616e1c5a9b266f9.html" target="n" data-glyph="104,1" class="i property">WSManAPIData</a> { <b>get</b>; <b>private set</b>; }
 
        <b>internal bool</b> <a id="a8f057948cd2a14c" href="../../../R/a8f057948cd2a14c.html" target="n" data-glyph="104,1" class="i property">SupportsDisconnect</a> { <b>get</b>; <b>private set</b>; }
 
        <b>internal override void</b> <a id="1056edd22af5a813" href="../../../R/1056edd22af5a813.html" target="n" data-glyph="74,1" class="i method">DisconnectAsync</a>()
        {
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<span class="i">Assert</span>(!<a href="BaseTransportManager.cs.html#76271338de46dcf0" class="i field">isClosed</a>, <span class="s">&quot;object already disposed&quot;</span>);
 
            <span class="c">// Pass the WSManConnectionInfo object IdleTimeout value if it is</span>
            <span class="c">// valid.  Otherwise pass the default value that instructs the server</span>
            <span class="c">// to use its default IdleTimeout value.</span>
            <b>uint</b> <span id="r80 rd" class="r80 r">uIdleTimeout</span> = (<a href="#c09ce13debcbb880" class="i property">ConnectionInfo</a>.<a href="../common/RunspaceConnectionInfo.cs.html#0c117c8cb5b1de8b" class="i property">IdleTimeout</a> &gt; 0) ?
                (<b>uint</b>)<a href="#c09ce13debcbb880" class="i property">ConnectionInfo</a>.<a href="../common/RunspaceConnectionInfo.cs.html#0c117c8cb5b1de8b" class="i property">IdleTimeout</a> : <a href="BaseTransportManager.cs.html#2f4e1b8fd6f7fcfa" class="i field">UseServerDefaultIdleTimeoutUInt</a>;
 
            <span class="c">// startup info</span>
            <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#f44ddcd3dc4aede8" class="t t">WSManShellDisconnectInfo</a> <span id="r81 rd" class="r81 r">disconnectInfo</span> = <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#552375df4829fe3a" class="t constructor">WSManShellDisconnectInfo</a>(<span class="r80 r">uIdleTimeout</span>);
 
            <span class="c">// Add ETW traces</span>
 
            <span class="c">// disconnect Callback</span>
            <a href="#1fef853d09949cce" class="i field">_disconnectSessionCompleted</a> = <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#d3c47769c10efcdb" class="t constructor">WSManShellAsync</a>(<b>new</b> <span class="i">IntPtr</span>(<a href="#63bdfff34ccd5ad2" class="i field">_sessionContextID</a>), <a href="#2a4b7151587a3aed" class="i field">s_sessionDisconnectCallback</a>);
            <b>try</b>
            {
                <b>lock</b> (<a href="BaseTransportManager.cs.html#2b6037d6b3777ca1" class="i field">syncObject</a>)
                {
                    <b>if</b> (<a href="BaseTransportManager.cs.html#76271338de46dcf0" class="i field">isClosed</a>)
                    {
                        <span class="c">// the transport is already closed</span>
                        <span class="c">// anymore.</span>
                        <b>return</b>;
                    }
 
                    <b>int</b> <span id="r82 rd" class="r82 r">flags</span> = 0;
                    <span class="r82 r">flags</span> |= (<a href="#c09ce13debcbb880" class="i property">ConnectionInfo</a>.<a href="../common/RunspaceConnectionInfo.cs.html#10ef35a810ea13c2" class="i property">OutputBufferingMode</a> == <span class="i n">Runspaces</span>.<a href="../common/RunspaceConnectionInfo.cs.html#9cb40ac520a09a1d" class="t t">OutputBufferingMode</a>.<a href="../common/RunspaceConnectionInfo.cs.html#1973173f1a07408a" class="i field">Block</a>) ?
                                    (<b>int</b>)<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#98f13b30e065a9d0" class="t t">WSManShellFlag</a>.<a href="WSManNativeAPI.cs.html#1b56d88e8fd4e4f2" class="i field">WSMAN_FLAG_SERVER_BUFFERING_MODE_BLOCK</a> : 0;
                    <span class="r82 r">flags</span> |= (<a href="#c09ce13debcbb880" class="i property">ConnectionInfo</a>.<a href="../common/RunspaceConnectionInfo.cs.html#10ef35a810ea13c2" class="i property">OutputBufferingMode</a> == <span class="i n">Runspaces</span>.<a href="../common/RunspaceConnectionInfo.cs.html#9cb40ac520a09a1d" class="t t">OutputBufferingMode</a>.<a href="../common/RunspaceConnectionInfo.cs.html#ffb9892e18d7c551" class="i field">Drop</a>) ?
                                    (<b>int</b>)<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#98f13b30e065a9d0" class="t t">WSManShellFlag</a>.<a href="WSManNativeAPI.cs.html#c8402e04328c3ada" class="i field">WSMAN_FLAG_SERVER_BUFFERING_MODE_DROP</a> : 0;
 
                    <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#0541285cff743c76" class="i method">WSManDisconnectShellEx</a>(<a href="#5120ad7297341362" class="i field">_wsManShellOperationHandle</a>,
                            <span class="r82 r">flags</span>,
                            <span class="r81 r">disconnectInfo</span>,
                            <a href="#1fef853d09949cce" class="i field">_disconnectSessionCompleted</a>);
                }
            }
            <b>finally</b>
            {
                <span class="r81 r">disconnectInfo</span>.<a href="WSManNativeAPI.cs.html#25f1e6f0c109b240" class="i method">Dispose</a>();
            }
        }
 
        <b>internal override void</b> <a id="aa7c51df1ca62a78" href="../../../R/aa7c51df1ca62a78.html" target="n" data-glyph="74,1" class="i method">ReconnectAsync</a>()
        {
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<span class="i">Assert</span>(!<a href="BaseTransportManager.cs.html#76271338de46dcf0" class="i field">isClosed</a>, <span class="s">&quot;object already disposed&quot;</span>);
            <a href="BaseTransportManager.cs.html#766c6c998b78695f" class="i property">ReceivedDataCollection</a>.<a href="PriorityCollection.cs.html#a8845745894768de" class="i method">PrepareForStreamConnect</a>();
 
            <span class="c">// Add ETW traces</span>
 
            <span class="c">// reconnect Callback</span>
            <a href="#3a47dcb9064d8157" class="i field">_reconnectSessionCompleted</a> = <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#d3c47769c10efcdb" class="t constructor">WSManShellAsync</a>(<b>new</b> <span class="i">IntPtr</span>(<a href="#63bdfff34ccd5ad2" class="i field">_sessionContextID</a>), <a href="#5aef0fdcb186b30c" class="i field">s_sessionReconnectCallback</a>);
            <b>lock</b> (<a href="BaseTransportManager.cs.html#2b6037d6b3777ca1" class="i field">syncObject</a>)
            {
                <b>if</b> (<a href="BaseTransportManager.cs.html#76271338de46dcf0" class="i field">isClosed</a>)
                {
                    <span class="c">// the transport is already closed</span>
                    <span class="c">// anymore.</span>
                    <b>return</b>;
                }
 
                <b>int</b> <span id="r83 rd" class="r83 r">flags</span> = 0;
                <span class="r83 r">flags</span> |= (<a href="#c09ce13debcbb880" class="i property">ConnectionInfo</a>.<a href="../common/RunspaceConnectionInfo.cs.html#10ef35a810ea13c2" class="i property">OutputBufferingMode</a> == <span class="i n">Runspaces</span>.<a href="../common/RunspaceConnectionInfo.cs.html#9cb40ac520a09a1d" class="t t">OutputBufferingMode</a>.<a href="../common/RunspaceConnectionInfo.cs.html#1973173f1a07408a" class="i field">Block</a>) ?
                                (<b>int</b>)<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#98f13b30e065a9d0" class="t t">WSManShellFlag</a>.<a href="WSManNativeAPI.cs.html#1b56d88e8fd4e4f2" class="i field">WSMAN_FLAG_SERVER_BUFFERING_MODE_BLOCK</a> : 0;
                <span class="r83 r">flags</span> |= (<a href="#c09ce13debcbb880" class="i property">ConnectionInfo</a>.<a href="../common/RunspaceConnectionInfo.cs.html#10ef35a810ea13c2" class="i property">OutputBufferingMode</a> == <span class="i n">Runspaces</span>.<a href="../common/RunspaceConnectionInfo.cs.html#9cb40ac520a09a1d" class="t t">OutputBufferingMode</a>.<a href="../common/RunspaceConnectionInfo.cs.html#ffb9892e18d7c551" class="i field">Drop</a>) ?
                                (<b>int</b>)<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#98f13b30e065a9d0" class="t t">WSManShellFlag</a>.<a href="WSManNativeAPI.cs.html#c8402e04328c3ada" class="i field">WSMAN_FLAG_SERVER_BUFFERING_MODE_DROP</a> : 0;
 
                <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#69550c4c3e22d1a0" class="i method">WSManReconnectShellEx</a>(<a href="#5120ad7297341362" class="i field">_wsManShellOperationHandle</a>,
                        <span class="r83 r">flags</span>,
                        <a href="#3a47dcb9064d8157" class="i field">_reconnectSessionCompleted</a>);
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Starts connecting to an existing remote session. This will result in a WSManConnectShellEx WSMan</span>
        <span class="c">///</span><span class="c"> async call. Piggy backs available data in input stream as openXml in connect SOAP.</span>
        <span class="c">///</span><span class="c"> DSHandler will push negotiation related messages through the open content.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="../common/remotingexceptions.cs.html#0bb8687f97d91059" class="t t">PSRemotingTransportException</a><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> WSManConnectShellEx failed.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>internal override void</b> <a id="3b9d97927216055b" href="../../../R/3b9d97927216055b.html" target="n" data-glyph="74,1" class="i method">ConnectAsync</a>()
        {
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<span class="i">Assert</span>(!<a href="BaseTransportManager.cs.html#76271338de46dcf0" class="i field">isClosed</a>, <span class="s">&quot;object already disposed&quot;</span>);
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<span class="i">Assert</span>(!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<a href="#c09ce13debcbb880" class="i property">ConnectionInfo</a>.<a href="../common/RunspaceConnectionInfo.cs.html#a0ee4c890acec948" class="i property">ShellUri</a>), <span class="s">&quot;shell uri cannot be null or empty.&quot;</span>);
 
            <a href="BaseTransportManager.cs.html#766c6c998b78695f" class="i property">ReceivedDataCollection</a>.<a href="PriorityCollection.cs.html#a8845745894768de" class="i method">PrepareForStreamConnect</a>();
            <span class="c">// additional content with connect shell call. Negotiation and connect related messages</span>
            <span class="c">// should be included in payload</span>
            <b>if</b> (<a href="#b636a4d17100c22a" class="i field">_openContent</a> == <b>null</b>)
            {
                <a href="PriorityCollection.cs.html#f0975201467fdc06" class="t t">DataPriorityType</a> <span id="r84 rd" class="r84 r">additionalDataType</span>;
                <b>byte</b>[] <span id="r85 rd" class="r85 r">additionalData</span> = <a href="BaseTransportManager.cs.html#ee4a2ac1afa72dce" class="i field">dataToBeSent</a>.<a href="PriorityCollection.cs.html#56fbcab0ffda9766" class="i method">ReadOrRegisterCallback</a>(<b>null</b>, <b>out</b> <span class="r84 r">additionalDataType</span>);
 
                <b>if</b> (<span class="r85 r">additionalData</span> != <b>null</b>)
                {
                    <span class="c">// WSMan expects the data to be in XML format (which is text + xml tags)</span>
                    <span class="c">// so convert byte[] into base64 encoded format</span>
                    <b>string</b> <span id="r86 rd" class="r86 r">base64EncodedDataInXml</span> = <b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>, <span class="s">&quot;&lt;{0} xmlns=\&quot;{1}\&quot;&gt;{2}&lt;/{0}&gt;&quot;</span>,
                        <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#7e67862a7fd16f55" class="i field">PS_CONNECT_XML_TAG</a>,
                        <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#bc04bbaff8dec383" class="i field">PS_XML_NAMESPACE</a>,
                        <span class="i">Convert</span>.<span class="i">ToBase64String</span>(<span class="r85 r">additionalData</span>));
                    <a href="#b636a4d17100c22a" class="i field">_openContent</a> = <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#52cf8f7c05242097" class="t constructor">WSManData_ManToUn</a>(<span class="r86 r">base64EncodedDataInXml</span>);
                }
 
                <span class="c">// THERE SHOULD BE NO ADDITIONAL DATA. If there is, it means we are not able to push all initial negotiation related data</span>
                <span class="c">// as part of Connect SOAP. The connect algorithm is based on this assumption. So bail out.</span>
                <span class="r85 r">additionalData</span> = <a href="BaseTransportManager.cs.html#ee4a2ac1afa72dce" class="i field">dataToBeSent</a>.<a href="PriorityCollection.cs.html#56fbcab0ffda9766" class="i method">ReadOrRegisterCallback</a>(<b>null</b>, <b>out</b> <span class="r84 r">additionalDataType</span>);
                <b>if</b> (<span class="r85 r">additionalData</span> != <b>null</b>)
                {
                    <span class="c">// Negotiation payload does not fit in ConnectShell. bail out.</span>
                    <span class="c">// Assert for now. should be replaced with raising an exception so upper layers can catch.</span>
                    <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<b>false</b>, <span class="s">&quot;Negotiation payload does not fit in ConnectShell&quot;</span>);
                    <b>return</b>;
                }
            }
 
            <span class="c">// Create and store context for this shell operation. This context is used from various callbacks</span>
            <a href="#63bdfff34ccd5ad2" class="i field">_sessionContextID</a> = <a href="#ecba37fa08d1e9e1" class="i method">GetNextSessionTMHandleId</a>();
            <a href="#9005741d9643ab64" class="i method">AddSessionTransportManager</a>(<a href="#63bdfff34ccd5ad2" class="i field">_sessionContextID</a>, <a href="#693b43214373ab1e" class="k">this</a>);
 
            <span class="c">// session is implicitly assumed to support disconnect</span>
            <a href="#a8f057948cd2a14c" class="i property">SupportsDisconnect</a> = <b>true</b>;
 
            <span class="c">// Create Callback</span>
            <a href="#a240d6a8fd1c1826" class="i field">_connectSessionCallback</a> = <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#d3c47769c10efcdb" class="t constructor">WSManShellAsync</a>(<b>new</b> <span class="i">IntPtr</span>(<a href="#63bdfff34ccd5ad2" class="i field">_sessionContextID</a>), <a href="#613a73a8fc3a5a9d" class="i field">s_sessionConnectCallback</a>);
            <b>lock</b> (<a href="BaseTransportManager.cs.html#2b6037d6b3777ca1" class="i field">syncObject</a>)
            {
                <b>if</b> (<a href="BaseTransportManager.cs.html#76271338de46dcf0" class="i field">isClosed</a>)
                {
                    <span class="c">// the transport is already closed..so no need to connect</span>
                    <span class="c">// anymore.</span>
                    <b>return</b>;
                }
 
                <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<a href="#60520c410fa716ee" class="i field">_startMode</a> == <a href="#b4291df75d9bc408" class="t t">WSManTransportManagerUtils</a>.<a href="#591d3d3614fb4562" class="t t">tmStartModes</a>.<a href="#6cebc3fa4e6113a6" class="i field">None</a>, <span class="s">&quot;startMode is not in expected state&quot;</span>);
                <a href="#60520c410fa716ee" class="i field">_startMode</a> = <a href="#b4291df75d9bc408" class="t t">WSManTransportManagerUtils</a>.<a href="#591d3d3614fb4562" class="t t">tmStartModes</a>.<a href="#59c1f5d2f991538b" class="i field">Connect</a>;
 
                <b>int</b> <span id="r87 rd" class="r87 r">flags</span> = 0;
                <span class="r87 r">flags</span> |= (<a href="#c09ce13debcbb880" class="i property">ConnectionInfo</a>.<a href="../common/RunspaceConnectionInfo.cs.html#10ef35a810ea13c2" class="i property">OutputBufferingMode</a> == <span class="i n">Runspaces</span>.<a href="../common/RunspaceConnectionInfo.cs.html#9cb40ac520a09a1d" class="t t">OutputBufferingMode</a>.<a href="../common/RunspaceConnectionInfo.cs.html#1973173f1a07408a" class="i field">Block</a>) ?
                                (<b>int</b>)<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#98f13b30e065a9d0" class="t t">WSManShellFlag</a>.<a href="WSManNativeAPI.cs.html#1b56d88e8fd4e4f2" class="i field">WSMAN_FLAG_SERVER_BUFFERING_MODE_BLOCK</a> : 0;
                <span class="r87 r">flags</span> |= (<a href="#c09ce13debcbb880" class="i property">ConnectionInfo</a>.<a href="../common/RunspaceConnectionInfo.cs.html#10ef35a810ea13c2" class="i property">OutputBufferingMode</a> == <span class="i n">Runspaces</span>.<a href="../common/RunspaceConnectionInfo.cs.html#9cb40ac520a09a1d" class="t t">OutputBufferingMode</a>.<a href="../common/RunspaceConnectionInfo.cs.html#ffb9892e18d7c551" class="i field">Drop</a>) ?
                                (<b>int</b>)<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#98f13b30e065a9d0" class="t t">WSManShellFlag</a>.<a href="WSManNativeAPI.cs.html#c8402e04328c3ada" class="i field">WSMAN_FLAG_SERVER_BUFFERING_MODE_DROP</a> : 0;
 
                <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<span class="i">WSManConnectShellEx</span>(<a href="#e71b1b284f1d2a52" class="i field">_wsManSessionHandle</a>,
                    <span class="r87 r">flags</span>,
                    <a href="#c09ce13debcbb880" class="i property">ConnectionInfo</a>.<a href="../common/RunspaceConnectionInfo.cs.html#a0ee4c890acec948" class="i property">ShellUri</a>,
                    <a href="BaseTransportManager.cs.html#6b69cd5f8cc06fb7" class="i property">RunspacePoolInstanceId</a>.<span class="i">ToString</span>().<span class="i">ToUpperInvariant</span>(),  <span class="c">// wsman is case sensitive wrt shellId. so consistently using upper case</span>
                    <span class="i">IntPtr</span>.<span class="i">Zero</span>,
                    <a href="#b636a4d17100c22a" class="i field">_openContent</a>,
                    <a href="#a240d6a8fd1c1826" class="i field">_connectSessionCallback</a>,
                    <b>ref</b> <a href="#5120ad7297341362" class="i field">_wsManShellOperationHandle</a>);
            }
 
            <b>if</b> (<a href="#5120ad7297341362" class="i field">_wsManShellOperationHandle</a> == <span class="i">IntPtr</span>.<span class="i">Zero</span>)
            {
                <a href="BaseTransportManager.cs.html#7e70b34f9332dfcd" class="t t">TransportErrorOccuredEventArgs</a> <span id="r88 rd" class="r88 r">eventargs</span> = <a href="#b4291df75d9bc408" class="t t">WSManTransportManagerUtils</a>.<span class="i">ConstructTransportErrorEventArgs</span>(<a href="#7616e1c5a9b266f9" class="i property">WSManAPIData</a>.<a href="#f386d97c12d99137" class="i property">WSManAPIHandle</a>,
                    <a href="#693b43214373ab1e" class="k">this</a>,
                    <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<span class="t">WSManError</span>(),
                    <a href="BaseTransportManager.cs.html#33678df914ca9daf" class="t t">TransportMethodEnum</a>.<a href="BaseTransportManager.cs.html#cf9cf28252f73349" class="i field">ConnectShellEx</a>,
                    <span class="i">RemotingErrorIdStrings</span>.<span class="i">ConnectExFailed</span>, <a href="#693b43214373ab1e" class="k">this</a>.<a href="#c09ce13debcbb880" class="i property">ConnectionInfo</a>.<a href="../common/RunspaceConnectionInfo.cs.html#74b71e9668d24a47" class="i property">ComputerName</a>);
                <a href="#938e18940d5e6747" class="i method">ProcessWSManTransportError</a>(<span class="r88 r">eventargs</span>);
                <b>return</b>;
            }
        }
 
        <b>internal override void</b> <a id="7188a5e1aa5f5bf2" href="../../../R/7188a5e1aa5f5bf2.html" target="n" data-glyph="74,1" class="i method">StartReceivingData</a>()
        {
            <b>lock</b> (<a href="BaseTransportManager.cs.html#2b6037d6b3777ca1" class="i field">syncObject</a>)
            {
                <span class="c">// make sure the transport is not closed.</span>
                <b>if</b> (<a href="BaseTransportManager.cs.html#76271338de46dcf0" class="i field">isClosed</a>)
                {
                    <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<a href="../../../utils/StructuredTraceSource.cs.html#96aaf3813a5962a0" class="i method">WriteLine</a>(<span class="s">&quot;Client Session TM: Transport manager is closed. So returning&quot;</span>);
                    <b>return</b>;
                }
 
                <b>if</b> (<a href="BaseTransportManager.cs.html#9a295d18d9f027e1" class="i field">receiveDataInitiated</a>)
                {
                    <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<a href="../../../utils/StructuredTraceSource.cs.html#96aaf3813a5962a0" class="i method">WriteLine</a>(<span class="s">&quot;Client Session TM: ReceiveData has already been called.&quot;</span>);
                    <b>return</b>;
                }
 
                <a href="BaseTransportManager.cs.html#9a295d18d9f027e1" class="i field">receiveDataInitiated</a> = <b>true</b>;
                <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<a href="../../../utils/StructuredTraceSource.cs.html#96aaf3813a5962a0" class="i method">WriteLine</a>(<span class="s">&quot;Client Session TM: Placing Receive request using WSManReceiveShellOutputEx&quot;</span>);
                <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(
                    <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#6ef71440e19f814d" class="i field">WSManReceiveShellOutputEx</a>,
                    <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#75e7cd53604b1352" class="i field">Receive</a>, <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>, <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#c5d4a73b62c859ab" class="i field">Transport</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                    <a href="BaseTransportManager.cs.html#6b69cd5f8cc06fb7" class="i property">RunspacePoolInstanceId</a>.<span class="i">ToString</span>(), <span class="i">Guid</span>.<span class="i">Empty</span>.<span class="i">ToString</span>());
 
                <a href="#971d9b6b19cb0ae3" class="i field">_receivedFromRemote</a> = <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#d3c47769c10efcdb" class="t constructor">WSManShellAsync</a>(<b>new</b> <span class="i">IntPtr</span>(<a href="#63bdfff34ccd5ad2" class="i field">_sessionContextID</a>), <a href="#f4733d79a2e2decf" class="i field">s_sessionReceiveCallback</a>);
                <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<span class="i">WSManReceiveShellOutputEx</span>(<a href="#5120ad7297341362" class="i field">_wsManShellOperationHandle</a>,
                    <span class="i">IntPtr</span>.<span class="i">Zero</span>, 0, <a href="#7616e1c5a9b266f9" class="i property">WSManAPIData</a>.<a href="#e80e9dbb667bfefc" class="i property">OutputStreamSet</a>, <a href="#971d9b6b19cb0ae3" class="i field">_receivedFromRemote</a>,
                    <b>ref</b> <a href="#13bf3d1545f10c0d" class="i field">_wsManReceiveOperationHandle</a>);
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Starts connecting to remote end asynchronously. This will result in a WSManCreateShellEx WSMan</span>
        <span class="c">///</span><span class="c"> async call. By the time this call returns, we will have a valid handle, if the operation</span>
        <span class="c">///</span><span class="c"> succeeds. Make sure other methods are called only after this method returns. Thread</span>
        <span class="c">///</span><span class="c"> synchronization is left to the caller.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="../common/remotingexceptions.cs.html#0bb8687f97d91059" class="t t">PSRemotingTransportException</a><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> WSManCreateShellEx failed.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>internal override void</b> <a id="e6e7996b4f2cca17" href="../../../R/e6e7996b4f2cca17.html" target="n" data-glyph="74,1" class="i method">CreateAsync</a>()
        {
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<span class="i">Assert</span>(!<a href="BaseTransportManager.cs.html#76271338de46dcf0" class="i field">isClosed</a>, <span class="s">&quot;object already disposed&quot;</span>);
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<span class="i">Assert</span>(!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<a href="#c09ce13debcbb880" class="i property">ConnectionInfo</a>.<a href="../common/RunspaceConnectionInfo.cs.html#a0ee4c890acec948" class="i property">ShellUri</a>), <span class="s">&quot;shell uri cannot be null or empty.&quot;</span>);
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<a href="#7616e1c5a9b266f9" class="i property">WSManAPIData</a> != <b>null</b>, <span class="s">&quot;WSManApiData should always be created before session creation.&quot;</span>);
 
            <span class="i">List</span>&lt;<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#f3f2b67eaca5460e" class="t t">WSManOption</a>&gt; <span id="r89 rd" class="r89 r">shellOptions</span> = <b>new</b> <span class="i">List</span>&lt;<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#f3f2b67eaca5460e" class="t t">WSManOption</a>&gt;(<a href="#7616e1c5a9b266f9" class="i property">WSManAPIData</a>.<a href="#95447a4f3ec48ffa" class="i property">CommonOptionSet</a>);
 
            <span class="k preprocess">#</span><span class="k preprocess">region</span> SHIM: Redirection code for protocol version
 
            <b>if</b> (<a href="#249d04171f6fe265" class="i field">s_protocolVersionRedirect</a> != <b>null</b>)
            {
                <b>string</b> <span id="r90 rd" class="r90 r">newProtocolVersion</span> = (<b>string</b>)<a href="#249d04171f6fe265" class="i field">s_protocolVersionRedirect</a>.<span class="i">DynamicInvoke</span>();
                <span class="r89 r">shellOptions</span>.<span class="i">Clear</span>();
                <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#f3f2b67eaca5460e" class="t t">WSManOption</a> <span id="r91 rd" class="r91 r">newPrtVOption</span> = <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<span class="t">WSManOption</span>();
                <span class="r91 r">newPrtVOption</span>.<a href="WSManNativeAPI.cs.html#236eed2b4fe7a439" class="i field">name</a> = <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#7c9c1b0b95848ffd" class="t t">RemoteDataNameStrings</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#c416521156fef723" class="i field">PS_STARTUP_PROTOCOL_VERSION_NAME</a>;
                <span class="r91 r">newPrtVOption</span>.<a href="WSManNativeAPI.cs.html#fc9f90499a03780b" class="i field">value</a> = <span class="r90 r">newProtocolVersion</span>;
                <span class="r91 r">newPrtVOption</span>.<a href="WSManNativeAPI.cs.html#e4277700dc2720ce" class="i field">mustComply</a> = <b>true</b>;
                <span class="r89 r">shellOptions</span>.<span class="i">Add</span>(<span class="r91 r">newPrtVOption</span>);
            }
 
            <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
            <span class="c">// Pass the WSManConnectionInfo object IdleTimeout value if it is</span>
            <span class="c">// valid.  Otherwise pass the default value that instructs the server</span>
            <span class="c">// to use its default IdleTimeout value.</span>
            <b>uint</b> <span id="r92 rd" class="r92 r">uIdleTimeout</span> = (<a href="#c09ce13debcbb880" class="i property">ConnectionInfo</a>.<a href="../common/RunspaceConnectionInfo.cs.html#0c117c8cb5b1de8b" class="i property">IdleTimeout</a> &gt; 0) ?
                (<b>uint</b>)<a href="#c09ce13debcbb880" class="i property">ConnectionInfo</a>.<a href="../common/RunspaceConnectionInfo.cs.html#0c117c8cb5b1de8b" class="i property">IdleTimeout</a> : <a href="BaseTransportManager.cs.html#2f4e1b8fd6f7fcfa" class="i field">UseServerDefaultIdleTimeoutUInt</a>;
 
            <span class="c">// startup info</span>
            <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#a04acf0dae72dbd2" class="t t">WSManShellStartupInfo_ManToUn</a> <span id="r93 rd" class="r93 r">startupInfo</span> =
                <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#50260f68ca520319" class="t constructor">WSManShellStartupInfo_ManToUn</a>(<a href="#7616e1c5a9b266f9" class="i property">WSManAPIData</a>.<a href="#9aa68c6337bfdf52" class="i property">InputStreamSet</a>,
                <a href="#7616e1c5a9b266f9" class="i property">WSManAPIData</a>.<a href="#e80e9dbb667bfefc" class="i property">OutputStreamSet</a>,
                <span class="r92 r">uIdleTimeout</span>,
                <a href="#4b7746154b548bec" class="i field">_sessionName</a>);
 
            <span class="c">// additional content with create shell call. Piggy back first fragment from</span>
            <span class="c">// the dataToBeSent buffer.</span>
            <b>if</b> (<a href="#b636a4d17100c22a" class="i field">_openContent</a> == <b>null</b>)
            {
                <a href="PriorityCollection.cs.html#f0975201467fdc06" class="t t">DataPriorityType</a> <span id="r94 rd" class="r94 r">additionalDataType</span>;
                <b>byte</b>[] <span id="r95 rd" class="r95 r">additionalData</span> = <a href="BaseTransportManager.cs.html#ee4a2ac1afa72dce" class="i field">dataToBeSent</a>.<a href="PriorityCollection.cs.html#56fbcab0ffda9766" class="i method">ReadOrRegisterCallback</a>(<b>null</b>, <b>out</b> <span class="r94 r">additionalDataType</span>);
 
                <span class="k preprocess">#</span><span class="k preprocess">region</span> SHIM: Redirection code for session data send.
 
                <b>bool</b> <span id="r96 rd" class="r96 r">sendContinue</span> = <b>true</b>;
 
                <b>if</b> (<a href="#687643a8ddd6f0bc" class="i field">s_sessionSendRedirect</a> != <b>null</b>)
                {
                    <b>object</b>[] <span id="r97 rd" class="r97 r">arguments</span> = <b>new</b> <b>object</b>[2] { <b>null</b>, <span class="r95 r">additionalData</span> };
                    <span class="r96 r">sendContinue</span> = (<b>bool</b>)<a href="#687643a8ddd6f0bc" class="i field">s_sessionSendRedirect</a>.<span class="i">DynamicInvoke</span>(<span class="r97 r">arguments</span>);
                    <span class="r95 r">additionalData</span> = (<b>byte</b>[])<span class="r97 r">arguments</span>[0];
                }
 
                <b>if</b> (!<span class="r96 r">sendContinue</span>)
                    <b>return</b>;
 
                <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
                <b>if</b> (<span class="r95 r">additionalData</span> != <b>null</b>)
                {
                    <span class="c">// WSMan expects the data to be in XML format (which is text + xml tags)</span>
                    <span class="c">// so convert byte[] into base64 encoded format</span>
                    <b>string</b> <span id="r98 rd" class="r98 r">base64EncodedDataInXml</span> = <b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>, <span class="s">&quot;&lt;{0} xmlns=\&quot;{1}\&quot;&gt;{2}&lt;/{0}&gt;&quot;</span>,
                        <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#162d8410e5d5ba48" class="i field">PS_CREATION_XML_TAG</a>,
                        <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#bc04bbaff8dec383" class="i field">PS_XML_NAMESPACE</a>,
                        <span class="i">Convert</span>.<span class="i">ToBase64String</span>(<span class="r95 r">additionalData</span>));
                    <a href="#b636a4d17100c22a" class="i field">_openContent</a> = <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#52cf8f7c05242097" class="t constructor">WSManData_ManToUn</a>(<span class="r98 r">base64EncodedDataInXml</span>);
                }
            }
 
            <span class="c">// Create the session context information only once.  CreateAsync() can be called multiple</span>
            <span class="c">// times by RetrySessionCreation for flaky networks.</span>
            <b>if</b> (<a href="#63bdfff34ccd5ad2" class="i field">_sessionContextID</a> == 0)
            {
                <span class="c">// Create and store context for this shell operation. This context is used from various callbacks</span>
                <a href="#63bdfff34ccd5ad2" class="i field">_sessionContextID</a> = <a href="#ecba37fa08d1e9e1" class="i method">GetNextSessionTMHandleId</a>();
                <a href="#9005741d9643ab64" class="i method">AddSessionTransportManager</a>(<a href="#63bdfff34ccd5ad2" class="i field">_sessionContextID</a>, <a href="#693b43214373ab1e" class="k">this</a>);
 
                <span class="c">// Create Callback</span>
                <a href="#50df0d6aba0ff464" class="i field">_createSessionCallback</a> = <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#d3c47769c10efcdb" class="t constructor">WSManShellAsync</a>(<b>new</b> <span class="i">IntPtr</span>(<a href="#63bdfff34ccd5ad2" class="i field">_sessionContextID</a>), <a href="#f3911029d149d577" class="i field">s_sessionCreateCallback</a>);
                <a href="#1fb2fbc7b82eea45" class="i field">_createSessionCallbackGCHandle</a> = <span class="i">GCHandle</span>.<span class="i">Alloc</span>(<a href="#50df0d6aba0ff464" class="i field">_createSessionCallback</a>);
            }
 
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(
                <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#959d48274f222fdc" class="i field">WSManCreateShell</a>,
                <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#a0f7cf0d4987790f" class="i field">Connect</a>,
                <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#752e56066810e4f0" class="i field">CreateRunspace</a>, <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#c5d4a73b62c859ab" class="i field">Transport</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                <a href="BaseTransportManager.cs.html#6b69cd5f8cc06fb7" class="i property">RunspacePoolInstanceId</a>.<span class="i">ToString</span>());
 
            <b>try</b>
            {
                <b>lock</b> (<a href="BaseTransportManager.cs.html#2b6037d6b3777ca1" class="i field">syncObject</a>)
                {
                    <b>if</b> (<a href="BaseTransportManager.cs.html#76271338de46dcf0" class="i field">isClosed</a>)
                    {
                        <span class="c">// the transport is already closed..so no need to create a connection</span>
                        <span class="c">// anymore.</span>
                        <b>return</b>;
                    }
 
                    <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<a href="#60520c410fa716ee" class="i field">_startMode</a> == <a href="#b4291df75d9bc408" class="t t">WSManTransportManagerUtils</a>.<a href="#591d3d3614fb4562" class="t t">tmStartModes</a>.<a href="#6cebc3fa4e6113a6" class="i field">None</a>, <span class="s">&quot;startMode is not in expected state&quot;</span>);
                    <a href="#60520c410fa716ee" class="i field">_startMode</a> = <a href="#b4291df75d9bc408" class="t t">WSManTransportManagerUtils</a>.<a href="#591d3d3614fb4562" class="t t">tmStartModes</a>.<a href="#8a9271ccb43791fe" class="i field">Create</a>;
 
                    <b>if</b> (<a href="#0f8b6e6298fc6a90" class="i field">_noMachineProfile</a>)
                    {
                        <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#f3f2b67eaca5460e" class="t t">WSManOption</a> <span id="r99 rd" class="r99 r">noProfile</span> = <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<span class="t">WSManOption</span>();
                        <span class="r99 r">noProfile</span>.<a href="WSManNativeAPI.cs.html#236eed2b4fe7a439" class="i field">name</a> = <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#e60f4064626a99c8" class="i field">NoProfile</a>;
                        <span class="r99 r">noProfile</span>.<a href="WSManNativeAPI.cs.html#e4277700dc2720ce" class="i field">mustComply</a> = <b>true</b>;
                        <span class="r99 r">noProfile</span>.<a href="WSManNativeAPI.cs.html#fc9f90499a03780b" class="i field">value</a> = <span class="s">&quot;1&quot;</span>;
                        <span class="r89 r">shellOptions</span>.<span class="i">Add</span>(<span class="r99 r">noProfile</span>);
                    }
 
                    <b>int</b> <span id="r100 rd" class="r100 r">flags</span> = <a href="#dd251fce18794104" class="i field">_noCompression</a> ? (<b>int</b>)<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#98f13b30e065a9d0" class="t t">WSManShellFlag</a>.<a href="WSManNativeAPI.cs.html#0c7c3687b1134ef9" class="i field">WSMAN_FLAG_NO_COMPRESSION</a> : 0;
                    <span class="r100 r">flags</span> |= (<a href="#c09ce13debcbb880" class="i property">ConnectionInfo</a>.<a href="../common/RunspaceConnectionInfo.cs.html#10ef35a810ea13c2" class="i property">OutputBufferingMode</a> == <span class="i n">Runspaces</span>.<a href="../common/RunspaceConnectionInfo.cs.html#9cb40ac520a09a1d" class="t t">OutputBufferingMode</a>.<a href="../common/RunspaceConnectionInfo.cs.html#1973173f1a07408a" class="i field">Block</a>) ?
                                    (<b>int</b>)<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#98f13b30e065a9d0" class="t t">WSManShellFlag</a>.<a href="WSManNativeAPI.cs.html#1b56d88e8fd4e4f2" class="i field">WSMAN_FLAG_SERVER_BUFFERING_MODE_BLOCK</a> : 0;
                    <span class="r100 r">flags</span> |= (<a href="#c09ce13debcbb880" class="i property">ConnectionInfo</a>.<a href="../common/RunspaceConnectionInfo.cs.html#10ef35a810ea13c2" class="i property">OutputBufferingMode</a> == <span class="i n">Runspaces</span>.<a href="../common/RunspaceConnectionInfo.cs.html#9cb40ac520a09a1d" class="t t">OutputBufferingMode</a>.<a href="../common/RunspaceConnectionInfo.cs.html#ffb9892e18d7c551" class="i field">Drop</a>) ?
                                    (<b>int</b>)<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#98f13b30e065a9d0" class="t t">WSManShellFlag</a>.<a href="WSManNativeAPI.cs.html#c8402e04328c3ada" class="i field">WSMAN_FLAG_SERVER_BUFFERING_MODE_DROP</a> : 0;
 
                    <b>using</b> (<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#04451905aba58b51" class="t t">WSManOptionSet</a> <span id="r101 rd" class="r101 r">optionSet</span> = <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<span class="t">WSManOptionSet</span>(<span class="r89 r">shellOptions</span>.<span class="i">ToArray</span>()))
                    {
                        <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<span class="i">WSManCreateShellEx</span>(<a href="#e71b1b284f1d2a52" class="i field">_wsManSessionHandle</a>,
                            <span class="r100 r">flags</span>,
                            <a href="#c09ce13debcbb880" class="i property">ConnectionInfo</a>.<a href="../common/RunspaceConnectionInfo.cs.html#a0ee4c890acec948" class="i property">ShellUri</a>,
                            <a href="BaseTransportManager.cs.html#6b69cd5f8cc06fb7" class="i property">RunspacePoolInstanceId</a>.<span class="i">ToString</span>().<span class="i">ToUpperInvariant</span>(),
                            <span class="r93 r">startupInfo</span>,
                            <span class="r101 r">optionSet</span>,
                            <a href="#b636a4d17100c22a" class="i field">_openContent</a>,
                            <a href="#50df0d6aba0ff464" class="i field">_createSessionCallback</a>,
                            <b>ref</b> <a href="#5120ad7297341362" class="i field">_wsManShellOperationHandle</a>);
                    }
                }
 
                <b>if</b> (<a href="#5120ad7297341362" class="i field">_wsManShellOperationHandle</a> == <span class="i">IntPtr</span>.<span class="i">Zero</span>)
                {
                    <a href="BaseTransportManager.cs.html#7e70b34f9332dfcd" class="t t">TransportErrorOccuredEventArgs</a> <span id="r102 rd" class="r102 r">eventargs</span> = <a href="#b4291df75d9bc408" class="t t">WSManTransportManagerUtils</a>.<span class="i">ConstructTransportErrorEventArgs</span>(<a href="#7616e1c5a9b266f9" class="i property">WSManAPIData</a>.<a href="#f386d97c12d99137" class="i property">WSManAPIHandle</a>,
                        <a href="#693b43214373ab1e" class="k">this</a>,
                        <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<span class="t">WSManError</span>(),
                        <a href="BaseTransportManager.cs.html#33678df914ca9daf" class="t t">TransportMethodEnum</a>.<a href="BaseTransportManager.cs.html#a8019a6497e609cf" class="i field">CreateShellEx</a>,
                        <span class="i">RemotingErrorIdStrings</span>.<span class="i">ConnectExFailed</span>,
                        <a href="#693b43214373ab1e" class="k">this</a>.<a href="#c09ce13debcbb880" class="i property">ConnectionInfo</a>.<a href="../common/RunspaceConnectionInfo.cs.html#74b71e9668d24a47" class="i property">ComputerName</a>);
                    <a href="#938e18940d5e6747" class="i method">ProcessWSManTransportError</a>(<span class="r102 r">eventargs</span>);
                    <b>return</b>;
                }
            }
            <b>finally</b>
            {
                <span class="r93 r">startupInfo</span>.<a href="WSManNativeAPI.cs.html#2a00d4506220f9b6" class="i method">Dispose</a>();
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Closes the pending Create,Send,Receive operations and then closes the shell and release all the resources.</span>
        <span class="c">///</span><span class="c"> The caller should make sure this method is called only after calling ConnectAsync.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal override void</b> <a id="0bba96ce9c1bf65b" href="../../../R/0bba96ce9c1bf65b.html" target="n" data-glyph="74,1" class="i method">CloseAsync</a>()
        {
            <b>bool</b> <span id="r103 rd" class="r103 r">shouldRaiseCloseCompleted</span> = <b>false</b>;
            <span class="c">// let other threads release the lock before we clean up the resources.</span>
            <b>lock</b> (<a href="BaseTransportManager.cs.html#2b6037d6b3777ca1" class="i field">syncObject</a>)
            {
                <b>if</b> (<a href="BaseTransportManager.cs.html#76271338de46dcf0" class="i field">isClosed</a>)
                {
                    <b>return</b>;
                }
 
                <b>if</b> (<a href="#60520c410fa716ee" class="i field">_startMode</a> == <a href="#b4291df75d9bc408" class="t t">WSManTransportManagerUtils</a>.<a href="#591d3d3614fb4562" class="t t">tmStartModes</a>.<a href="#6cebc3fa4e6113a6" class="i field">None</a>)
                {
                    <span class="r103 r">shouldRaiseCloseCompleted</span> = <b>true</b>;
                }
                <b>else</b> <b>if</b> (<a href="#60520c410fa716ee" class="i field">_startMode</a> == <a href="#b4291df75d9bc408" class="t t">WSManTransportManagerUtils</a>.<a href="#591d3d3614fb4562" class="t t">tmStartModes</a>.<a href="#8a9271ccb43791fe" class="i field">Create</a> ||
                    <a href="#60520c410fa716ee" class="i field">_startMode</a> == <a href="#b4291df75d9bc408" class="t t">WSManTransportManagerUtils</a>.<a href="#591d3d3614fb4562" class="t t">tmStartModes</a>.<a href="#59c1f5d2f991538b" class="i field">Connect</a>)
                {
                    <b>if</b> (<a href="#5120ad7297341362" class="i field">_wsManShellOperationHandle</a> == <span class="i">IntPtr</span>.<span class="i">Zero</span>)
                    {
                        <span class="r103 r">shouldRaiseCloseCompleted</span> = <b>true</b>;
                    }
                }
                <b>else</b>
                {
                    <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<b>false</b>, <span class="s">&quot;startMode is in unexpected state&quot;</span>);
                }
 
                <span class="c">// Set boolean indicating that this session is closing.</span>
                <a href="BaseTransportManager.cs.html#76271338de46dcf0" class="i field">isClosed</a> = <b>true</b>;
            }
 
            <a href="BaseTransportManager.cs.html#19883ec4df424177" class="k">base</a>.<a href="BaseTransportManager.cs.html#8487786a35819f66" class="i method">CloseAsync</a>();
 
            <b>if</b> (<span class="r103 r">shouldRaiseCloseCompleted</span>)
            {
                <b>try</b>
                {
                    <a href="BaseTransportManager.cs.html#ce72d08b48a8f70f" class="i method">RaiseCloseCompleted</a>();
                }
                <b>finally</b>
                {
                    <a href="#821511033f76b57e" class="i method">RemoveSessionTransportManager</a>(<a href="#63bdfff34ccd5ad2" class="i field">_sessionContextID</a>);
                }
 
                <b>return</b>;
            }
 
            <span class="c">// TODO - On unexpected failures on a reconstructed session... we dont want to close server session</span>
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(
                <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#e194fca851222be4" class="i field">WSManCloseShell</a>,
                <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#f3d85cb80e62fe3e" class="i field">Disconnect</a>, <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>, <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#c5d4a73b62c859ab" class="i field">Transport</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                <a href="BaseTransportManager.cs.html#6b69cd5f8cc06fb7" class="i property">RunspacePoolInstanceId</a>.<span class="i">ToString</span>());
            <a href="#b58b1df0b8db7760" class="i field">_closeSessionCompleted</a> = <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#d3c47769c10efcdb" class="t constructor">WSManShellAsync</a>(<b>new</b> <span class="i">IntPtr</span>(<a href="#63bdfff34ccd5ad2" class="i field">_sessionContextID</a>), <a href="#8ce19afc5f4dbbe8" class="i field">s_sessionCloseCallback</a>);
            <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#cae66210aa59ea0f" class="i method">WSManCloseShell</a>(<a href="#5120ad7297341362" class="i field">_wsManShellOperationHandle</a>, 0, <a href="#b58b1df0b8db7760" class="i field">_closeSessionCompleted</a>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Adjusts for any variations in different protocol versions. Following changes are considered</span>
        <span class="c">///</span><span class="c"> - In V2, default max envelope size is 150KB while in V3 it has been changed to 500KB.</span>
        <span class="c">///</span><span class="c">   With default configuration remoting from V3 client to V2 server will break as V3 client can send upto 500KB in a single Send packet</span>
        <span class="c">///</span><span class="c">   So if server version is known to be V2, we&#39;ll downgrade the max env size to 150KB (V2&#39;s default) if the current value is 500KB (V3 default)</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r104 r">serverProtocolVersion</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Server negotiated protocol version.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="df0f1d6179928fe0" href="../../../R/df0f1d6179928fe0.html" target="n" data-glyph="74,1" class="i method">AdjustForProtocolVariations</a>(<span class="i">Version</span> <span id="r104 rd" class="r104 r">serverProtocolVersion</span>)
        {
            <b>if</b> (<span class="r104 r">serverProtocolVersion</span> &lt;= <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#d19a1042a44001e8" class="t t">RemotingConstants</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#cdbd21e6ffe53584" class="i field">ProtocolVersionWin7RTM</a>)
            {
                <b>int</b> <span id="r105 rd" class="r105 r">maxEnvSize</span>;
                <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#fbfe20dc1839a3de" class="i method">WSManGetSessionOptionAsDword</a>(<a href="#e71b1b284f1d2a52" class="i field">_wsManSessionHandle</a>,
                    <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#f99c2939972a9aca" class="t t">WSManSessionOption</a>.<a href="WSManNativeAPI.cs.html#647b2be6813d80f2" class="i field">WSMAN_OPTION_MAX_ENVELOPE_SIZE_KB</a>,
                    <b>out</b> <span class="r105 r">maxEnvSize</span>);
 
                <b>if</b> (<span class="r105 r">maxEnvSize</span> == <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#7d7f974cfffbad2e" class="i field">WSMAN_DEFAULT_MAX_ENVELOPE_SIZE_KB_V3</a>)
                {
                    <b>int</b> <span id="r106 rd" class="r106 r">result</span> = <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#8657f3f36882e0cf" class="i method">WSManSetSessionOption</a>(<a href="#e71b1b284f1d2a52" class="i field">_wsManSessionHandle</a>,
                    <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#f99c2939972a9aca" class="t t">WSManSessionOption</a>.<a href="WSManNativeAPI.cs.html#647b2be6813d80f2" class="i field">WSMAN_OPTION_MAX_ENVELOPE_SIZE_KB</a>,
                    <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#3355ebe78b09feca" class="t constructor">WSManDataDWord</a>(<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#872d3665c32b226b" class="i field">WSMAN_DEFAULT_MAX_ENVELOPE_SIZE_KB_V2</a>));
 
                    <b>if</b> (<span class="r106 r">result</span> != 0)
                    {
                        <span class="c">// Get the error message from WSMan</span>
                        <b>string</b> <span id="r107 rd" class="r107 r">errorMessage</span> = <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#0daa89ea27b8128f" class="i method">WSManGetErrorMessage</a>(<a href="#7616e1c5a9b266f9" class="i property">WSManAPIData</a>.<a href="#f386d97c12d99137" class="i property">WSManAPIHandle</a>, <span class="r106 r">result</span>);
 
                        <a href="../../../utils/MshInvalidOperationException.cs.html#259a38c8b594783c" class="t t">PSInvalidOperationException</a> <span id="r108 rd" class="r108 r">exception</span> = <b>new</b> <a href="../../../utils/MshInvalidOperationException.cs.html#de5b942a57457045" class="t constructor">PSInvalidOperationException</a>(<span class="r107 r">errorMessage</span>);
                        <b>throw</b> <span class="r108 r">exception</span>;
                    }
 
                    <span class="c">// retrieve the packet size again</span>
                    <b>int</b> <span id="r109 rd" class="r109 r">packetSize</span>;
                    <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#fbfe20dc1839a3de" class="i method">WSManGetSessionOptionAsDword</a>(<a href="#e71b1b284f1d2a52" class="i field">_wsManSessionHandle</a>,
                        <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#f99c2939972a9aca" class="t t">WSManSessionOption</a>.<a href="WSManNativeAPI.cs.html#6b4f7c20bd03908e" class="i field">WSMAN_OPTION_SHELL_MAX_DATA_SIZE_PER_MESSAGE_KB</a>,
                        <b>out</b> <span class="r109 r">packetSize</span>);
                    <span class="c">// packet size returned is in KB. Convert this into bytes</span>
                    <a href="BaseTransportManager.cs.html#0597b18306926355" class="i property">Fragmentor</a>.<a href="../common/fragmentor.cs.html#a4fa6a799e0782de" class="i property">FragmentSize</a> = <span class="r109 r">packetSize</span> &lt;&lt; 10;
                }
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Used by callers to prepare the session transportmanager for a URI redirection.</span>
        <span class="c">///</span><span class="c"> This must be called only after Create callback (or Error form create) is received.</span>
        <span class="c">///</span><span class="c"> This will close the internal WSMan Session handle. Callers must catch the close</span>
        <span class="c">///</span><span class="c"> completed event and call Redirect to perform the redirection.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal override void</b> <a id="ffc460716e4475bf" href="../../../R/ffc460716e4475bf.html" target="n" data-glyph="74,1" class="i method">PrepareForRedirection</a>()
        {
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<span class="i">Assert</span>(!<a href="BaseTransportManager.cs.html#76271338de46dcf0" class="i field">isClosed</a>, <span class="s">&quot;Transport manager must not be closed while preparing for redirection.&quot;</span>);
 
            <a href="#b58b1df0b8db7760" class="i field">_closeSessionCompleted</a> = <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#d3c47769c10efcdb" class="t constructor">WSManShellAsync</a>(<b>new</b> <span class="i">IntPtr</span>(<a href="#63bdfff34ccd5ad2" class="i field">_sessionContextID</a>), <a href="#8ce19afc5f4dbbe8" class="i field">s_sessionCloseCallback</a>);
            <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#cae66210aa59ea0f" class="i method">WSManCloseShell</a>(<a href="#5120ad7297341362" class="i field">_wsManShellOperationHandle</a>, 0, <a href="#b58b1df0b8db7760" class="i field">_closeSessionCompleted</a>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Redirect the transport manager to point to a new URI.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r110 r">newUri</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Redirect Uri to connect to.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r111 r">connectionInfo</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Connection info object used for retrieving credential, auth. mechanism etc.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="../../../utils/MshInvalidOperationException.cs.html#259a38c8b594783c" class="t t">PSInvalidOperationException</a><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> 1. Create Session failed with a non-zero error code.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>internal override void</b> <a id="ebace852d1489a2a" href="../../../R/ebace852d1489a2a.html" target="n" data-glyph="74,1" class="i method">Redirect</a>(<span class="i">Uri</span> <span id="r110 rd" class="r110 r">newUri</span>, <a href="../common/RunspaceConnectionInfo.cs.html#e07ed56a8a1da829" class="t t">RunspaceConnectionInfo</a> <span id="r111 rd" class="r111 r">connectionInfo</span>)
        {
            <a href="#ecf76fcc2b3850bc" class="i method">CloseSessionAndClearResources</a>();
            <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<span class="i">WriteLine</span>(<span class="s">&quot;Redirecting to URI: {0}&quot;</span>, <span class="r110 r">newUri</span>);
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(
                <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#7f7002cbfc667280" class="i field">URIRedirection</a>,
                <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#a0f7cf0d4987790f" class="i field">Connect</a>,
                <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#c5d4a73b62c859ab" class="i field">Transport</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                <a href="BaseTransportManager.cs.html#6b69cd5f8cc06fb7" class="i property">RunspacePoolInstanceId</a>.<span class="i">ToString</span>(),
                <span class="r110 r">newUri</span>.<span class="i">ToString</span>());
            <a href="#7136af64fcdcedf6" class="i method">Initialize</a>(<span class="r110 r">newUri</span>, (<a href="../common/RunspaceConnectionInfo.cs.html#2d9d176ef419be5a" class="t t">WSManConnectionInfo</a>)<span class="r111 r">connectionInfo</span>);
            <span class="c">// reset startmode</span>
            <a href="#60520c410fa716ee" class="i field">_startMode</a> = <a href="#b4291df75d9bc408" class="t t">WSManTransportManagerUtils</a>.<a href="#591d3d3614fb4562" class="t t">tmStartModes</a>.<a href="#6cebc3fa4e6113a6" class="i field">None</a>;
            <a href="#e6e7996b4f2cca17" class="i method">CreateAsync</a>();
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Creates a command transport manager. This will create a new PrioritySendDataCollection which should be used to</span>
        <span class="c">///</span><span class="c"> send data to the server.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r112 r">connectionInfo</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Connection info to be used for creating the command.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r113 r">cmd</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Command for which transport manager is created.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r114 r">noInput</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> true if the command has input.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal override</b> <a href="BaseTransportManager.cs.html#fa455a694094fdc2" class="t t">BaseClientCommandTransportManager</a> <a id="2174a60e7ceedc42" href="../../../R/2174a60e7ceedc42.html" target="n" data-glyph="74,1" class="i method">CreateClientCommandTransportManager</a>(<a href="../common/RunspaceConnectionInfo.cs.html#e07ed56a8a1da829" class="t t">RunspaceConnectionInfo</a> <span id="r112 rd" class="r112 r">connectionInfo</span>,
                    <a href="../client/ClientRemotePowerShell.cs.html#b4d2ac017883b31c" class="t t">ClientRemotePowerShell</a> <span id="r113 rd" class="r113 r">cmd</span>, <b>bool</b> <span id="r114 rd" class="r114 r">noInput</span>)
        {
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r113 r">cmd</span> != <b>null</b>, <span class="s">&quot;Cmd cannot be null&quot;</span>);
 
            <a href="../common/RunspaceConnectionInfo.cs.html#2d9d176ef419be5a" class="t t">WSManConnectionInfo</a> <span id="r115 rd" class="r115 r">wsmanConnectionInfo</span> = <span class="r112 r">connectionInfo</span> <b>as</b> <a href="../common/RunspaceConnectionInfo.cs.html#2d9d176ef419be5a" class="t t">WSManConnectionInfo</a>;
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r115 r">wsmanConnectionInfo</span> != <b>null</b>, <span class="s">&quot;ConnectionInfo must be WSManConnectionInfo&quot;</span>);
 
            <a href="#b521a47ccd5a3cc1" class="t t">WSManClientCommandTransportManager</a> <span id="r116 rd" class="r116 r">result</span> = <b>new</b>
                <a href="#61d42ec6ec4708ea" class="t constructor">WSManClientCommandTransportManager</a>(<span class="r115 r">wsmanConnectionInfo</span>, <a href="#5120ad7297341362" class="i field">_wsManShellOperationHandle</a>, <span class="r113 r">cmd</span>, <span class="r114 r">noInput</span>, <a href="#693b43214373ab1e" class="k">this</a>);
            <b>return</b> <span class="r116 r">result</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Initializes the session.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r117 r">connectionUri</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Uri to connect to.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r118 r">connectionInfo</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Connection info object used for retrieving credential, auth. mechanism etc.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="../../../utils/MshInvalidOperationException.cs.html#259a38c8b594783c" class="t t">PSInvalidOperationException</a><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> 1. Create Session failed with a non-zero error code.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>private void</b> <a id="7136af64fcdcedf6" href="../../../R/7136af64fcdcedf6.html" target="n" data-glyph="76,1" class="i method">Initialize</a>(<span class="i">Uri</span> <span id="r117 rd" class="r117 r">connectionUri</span>, <a href="../common/RunspaceConnectionInfo.cs.html#2d9d176ef419be5a" class="t t">WSManConnectionInfo</a> <span id="r118 rd" class="r118 r">connectionInfo</span>)
        {
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r118 r">connectionInfo</span> != <b>null</b>, <span class="s">&quot;connectionInfo cannot be null.&quot;</span>);
 
            <a href="#c09ce13debcbb880" class="i property">ConnectionInfo</a> = <span class="r118 r">connectionInfo</span>;
 
            <span class="c">// this will generate: http://ComputerName:port/appname?PSVersion=&lt;version&gt;</span>
            <span class="c">// PSVersion= pattern is needed to make Exchange compatible with PS V2 CTP3</span>
            <span class="c">// release. Using the PSVersion= logic, Exchange R4 server will redirect</span>
            <span class="c">// clients to an R3 endpoint.</span>
            <b>bool</b> <span id="r119 rd" class="r119 r">isSSLSpecified</span> = <b>false</b>;
            <b>string</b> <span id="r120 rd" class="r120 r">connectionStr</span> = <span class="r117 r">connectionUri</span>.<span class="i">OriginalString</span>;
            <b>if</b> ((<span class="r117 r">connectionUri</span> == <span class="r118 r">connectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#eb73ffdb9b586505" class="i property">ConnectionUri</a>) &amp;&amp;
                (<span class="r118 r">connectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#89e557efc35dc45d" class="i property">UseDefaultWSManPort</a>))
            {
                <span class="r120 r">connectionStr</span> = <a href="../common/RunspaceConnectionInfo.cs.html#2d9d176ef419be5a" class="t t">WSManConnectionInfo</a>.<a href="../common/RunspaceConnectionInfo.cs.html#3c2c874e25fea78a" class="i method">GetConnectionString</a>(<span class="r118 r">connectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#eb73ffdb9b586505" class="i property">ConnectionUri</a>,
                    <b>out</b> <span class="r119 r">isSSLSpecified</span>);
            }
 
            <span class="c">// TODO: Remove this after RDS moved to $using</span>
            <b>string</b> <span id="r121 rd" class="r121 r">additionalUriSuffixString</span> = <b>string</b>.<span class="i">Empty</span>;
            <b>if</b> (<a href="PSSessionConfigurationData.cs.html#a9929ed8e7a283e6" class="t t">PSSessionConfigurationData</a>.<a href="PSSessionConfigurationData.cs.html#d859a4dc89b8fed8" class="i field">IsServerManager</a>)
            {
                <span class="r121 r">additionalUriSuffixString</span> = <span class="s">&quot;;MSP=7a83d074-bb86-4e52-aa3e-6cc73cc066c8&quot;</span>;
            }
 
            <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r117 r">connectionUri</span>.<span class="i">Query</span>))
            {
                <span class="c">// if there is no query string already, create one..see RFC 3986</span>
                <span class="r120 r">connectionStr</span> = <b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>,
                    <span class="s">&quot;{0}?PSVersion={1}{2}&quot;</span>,
                    <span class="c">// Trimming the last &#39;/&#39; as this will allow WSMan to</span>
                    <span class="c">// properly apply URLPrefix.</span>
                    <span class="c">// Ex: http://localhost?PSVersion=2.0 will be converted</span>
                    <span class="c">// to http://localhost:&lt;port&gt;/&lt;urlprefix&gt;?PSVersion=2.0</span>
                    <span class="c">// by WSMan</span>
                    <span class="r120 r">connectionStr</span>.<span class="i">TrimEnd</span>(<span class="s">&#39;/&#39;</span>),
                    <a href="../../PSVersionInfo.cs.html#be287f9ea52b8d2f" class="t t">PSVersionInfo</a>.<a href="../../PSVersionInfo.cs.html#ad63365ac7690eeb" class="i property">PSVersion</a>,
                    <span class="r121 r">additionalUriSuffixString</span>);
            }
            <b>else</b>
            {
                <span class="c">// if there is already a query string, append using &amp; .. see RFC 3986</span>
                <span class="r120 r">connectionStr</span> = <b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>,
                       <span class="s">&quot;{0};PSVersion={1}{2}&quot;</span>,
                       <span class="r120 r">connectionStr</span>,
                       <a href="../../PSVersionInfo.cs.html#be287f9ea52b8d2f" class="t t">PSVersionInfo</a>.<a href="../../PSVersionInfo.cs.html#ad63365ac7690eeb" class="i property">PSVersion</a>,
                       <span class="r121 r">additionalUriSuffixString</span>);
            }
 
            <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#18d6c69c7828f052" class="t t">BaseWSManAuthenticationCredentials</a> <span id="r122 rd" class="r122 r">authCredentials</span>;
            <span class="c">// use certificate thumbprint for authentication</span>
            <b>if</b> (<span class="r118 r">connectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#4589105955753e41" class="i property">CertificateThumbprint</a> != <b>null</b>)
            {
                <span class="r122 r">authCredentials</span> = <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#a14cc31a651aa753" class="t constructor">WSManCertificateThumbprintCredentials</a>(<span class="r118 r">connectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#4589105955753e41" class="i property">CertificateThumbprint</a>);
            }
            <b>else</b>
            {
                <span class="c">// use credential based authentication</span>
                <b>string</b> <span id="r123 rd" class="r123 r">userName</span> = <b>null</b>;
                <span class="i n">System</span>.<span class="i">Security</span>.<span class="i">SecureString</span> <span id="r124 rd" class="r124 r">password</span> = <b>null</b>;
                <b>if</b> ((<span class="r118 r">connectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#5a783a782d2a0c8e" class="i property">Credential</a> != <b>null</b>) &amp;&amp; (!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r118 r">connectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#5a783a782d2a0c8e" class="i property">Credential</a>.<a href="../../Credential.cs.html#3fca673651eaeaff" class="i property">UserName</a>)))
                {
                    <span class="r123 r">userName</span> = <span class="r118 r">connectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#5a783a782d2a0c8e" class="i property">Credential</a>.<a href="../../Credential.cs.html#3fca673651eaeaff" class="i property">UserName</a>;
                    <span class="r124 r">password</span> = <span class="r118 r">connectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#5a783a782d2a0c8e" class="i property">Credential</a>.<a href="../../Credential.cs.html#828d5fa008f1755c" class="i property">Password</a>;
                }
 
                <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#ca42a41ca9a4cabc" class="t t">WSManUserNameAuthenticationCredentials</a> <span id="r125 rd" class="r125 r">userNameCredentials</span> =
                    <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#177e40f039b80130" class="t constructor">WSManUserNameAuthenticationCredentials</a>(<span class="r123 r">userName</span>,
                        <span class="r124 r">password</span>,
                        <span class="r118 r">connectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#fb303a9867ec0b83" class="i property">WSManAuthenticationMechanism</a>);
 
                <span class="r122 r">authCredentials</span> = <span class="r125 r">userNameCredentials</span>;
            }
 
            <span class="c">// proxy related data</span>
            <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#ca42a41ca9a4cabc" class="t t">WSManUserNameAuthenticationCredentials</a> <span id="r126 rd" class="r126 r">proxyAuthCredentials</span> = <b>null</b>;
            <b>if</b> (<span class="r118 r">connectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#b90c1ed41e87c2ea" class="i property">ProxyCredential</a> != <b>null</b>)
            {
                <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#242d5549ef0e4dbd" class="t t">WSManAuthenticationMechanism</a> <span id="r127 rd" class="r127 r">authMechanism</span> = <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#242d5549ef0e4dbd" class="t t">WSManAuthenticationMechanism</a>.<a href="WSManNativeAPI.cs.html#61cf55ffef78b4ea" class="i field">WSMAN_FLAG_AUTH_NEGOTIATE</a>;
                <b>string</b> <span id="r128 rd" class="r128 r">userName</span> = <b>null</b>;
                <span class="i n">System</span>.<span class="i">Security</span>.<span class="i">SecureString</span> <span id="r129 rd" class="r129 r">password</span> = <b>null</b>;
 
                <b>switch</b> (<span class="r118 r">connectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#d95258451cb68b3b" class="i property">ProxyAuthentication</a>)
                {
                    <b>case</b> <a href="../common/RunspaceConnectionInfo.cs.html#f2f89adf00d05f44" class="t t">AuthenticationMechanism</a>.<a href="../common/RunspaceConnectionInfo.cs.html#e6aff575bfa34071" class="i field">Negotiate</a>:
                        <span class="r127 r">authMechanism</span> = <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#242d5549ef0e4dbd" class="t t">WSManAuthenticationMechanism</a>.<a href="WSManNativeAPI.cs.html#61cf55ffef78b4ea" class="i field">WSMAN_FLAG_AUTH_NEGOTIATE</a>;
                        <b>break</b>;
                    <b>case</b> <a href="../common/RunspaceConnectionInfo.cs.html#f2f89adf00d05f44" class="t t">AuthenticationMechanism</a>.<a href="../common/RunspaceConnectionInfo.cs.html#aa56bb950a6fa6df" class="i field">Basic</a>:
                        <span class="r127 r">authMechanism</span> = <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#242d5549ef0e4dbd" class="t t">WSManAuthenticationMechanism</a>.<a href="WSManNativeAPI.cs.html#6b8867a7b5d205f8" class="i field">WSMAN_FLAG_AUTH_BASIC</a>;
                        <b>break</b>;
                    <b>case</b> <a href="../common/RunspaceConnectionInfo.cs.html#f2f89adf00d05f44" class="t t">AuthenticationMechanism</a>.<a href="../common/RunspaceConnectionInfo.cs.html#7094d14a65d8f900" class="i field">Digest</a>:
                        <span class="r127 r">authMechanism</span> = <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#242d5549ef0e4dbd" class="t t">WSManAuthenticationMechanism</a>.<a href="WSManNativeAPI.cs.html#10e08ad953e87fcb" class="i field">WSMAN_FLAG_AUTH_DIGEST</a>;
                        <b>break</b>;
                }
 
                <b>if</b> (!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r118 r">connectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#b90c1ed41e87c2ea" class="i property">ProxyCredential</a>.<a href="../../Credential.cs.html#3fca673651eaeaff" class="i property">UserName</a>))
                {
                    <span class="r128 r">userName</span> = <span class="r118 r">connectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#b90c1ed41e87c2ea" class="i property">ProxyCredential</a>.<a href="../../Credential.cs.html#3fca673651eaeaff" class="i property">UserName</a>;
                    <span class="r129 r">password</span> = <span class="r118 r">connectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#b90c1ed41e87c2ea" class="i property">ProxyCredential</a>.<a href="../../Credential.cs.html#828d5fa008f1755c" class="i property">Password</a>;
                }
 
                <span class="c">// use credential based authentication</span>
                <span class="r126 r">proxyAuthCredentials</span> = <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#177e40f039b80130" class="t constructor">WSManUserNameAuthenticationCredentials</a>(<span class="r128 r">userName</span>, <span class="r129 r">password</span>, <span class="r127 r">authMechanism</span>);
            }
 
            <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#4b0c4cdba66d06ba" class="t t">WSManProxyInfo</a> <span id="r130 rd" class="r130 r">proxyInfo</span> = (<span class="r118 r">connectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#9845f779385f9669" class="i property">ProxyAccessType</a> == <a href="../commands/PSRemotingCmdlet.cs.html#859b8c6a1b0a04ef" class="t t">ProxyAccessType</a>.<a href="../commands/PSRemotingCmdlet.cs.html#b8abe0a20c41194e" class="i field">None</a>) ?
                <b>null</b> :
                <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#7ec280da491cf029" class="t constructor">WSManProxyInfo</a>(<span class="r118 r">connectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#9845f779385f9669" class="i property">ProxyAccessType</a>, <span class="r126 r">proxyAuthCredentials</span>);
 
            <b>int</b> <span id="r131 rd" class="r131 r">result</span> = 0;
 
            <b>try</b>
            {
                <span class="r131 r">result</span> = <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<span class="i">WSManCreateSession</span>(<a href="#7616e1c5a9b266f9" class="i property">WSManAPIData</a>.<a href="#f386d97c12d99137" class="i property">WSManAPIHandle</a>, <span class="r120 r">connectionStr</span>, 0,
                     <span class="r122 r">authCredentials</span>.<a href="WSManNativeAPI.cs.html#19c31f0d2396c294" class="i method">GetMarshalledObject</a>(),
                     (<span class="r130 r">proxyInfo</span> == <b>null</b>) ? <span class="i">IntPtr</span>.<span class="i">Zero</span> : (<span class="i">IntPtr</span>)<span class="r130 r">proxyInfo</span>,
                     <b>ref</b> <a href="#e71b1b284f1d2a52" class="i field">_wsManSessionHandle</a>);
            }
            <b>finally</b>
            {
                <span class="c">// release resources</span>
                <b>if</b> (<span class="r126 r">proxyAuthCredentials</span> != <b>null</b>)
                {
                    <span class="r126 r">proxyAuthCredentials</span>.<a href="WSManNativeAPI.cs.html#1189c74270c84e9b" class="i method">Dispose</a>();
                }
 
                <b>if</b> (<span class="r130 r">proxyInfo</span> != <b>null</b>)
                {
                    <span class="r130 r">proxyInfo</span>.<a href="WSManNativeAPI.cs.html#84a682c4af6067af" class="i method">Dispose</a>();
                }
 
                <b>if</b> (<span class="r122 r">authCredentials</span> != <b>null</b>)
                {
                    <span class="r122 r">authCredentials</span>.<a href="WSManNativeAPI.cs.html#1189c74270c84e9b" class="i method">Dispose</a>();
                }
            }
 
            <b>if</b> (<span class="r131 r">result</span> != 0)
            {
                <span class="c">// Get the error message from WSMan</span>
                <b>string</b> <span id="r132 rd" class="r132 r">errorMessage</span> = <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#0daa89ea27b8128f" class="i method">WSManGetErrorMessage</a>(<a href="#7616e1c5a9b266f9" class="i property">WSManAPIData</a>.<a href="#f386d97c12d99137" class="i property">WSManAPIHandle</a>, <span class="r131 r">result</span>);
 
                <a href="../../../utils/MshInvalidOperationException.cs.html#259a38c8b594783c" class="t t">PSInvalidOperationException</a> <span id="r133 rd" class="r133 r">exception</span> = <b>new</b> <a href="../../../utils/MshInvalidOperationException.cs.html#de5b942a57457045" class="t constructor">PSInvalidOperationException</a>(<span class="r132 r">errorMessage</span>);
                <b>throw</b> <span class="r133 r">exception</span>;
            }
 
            <span class="c">// set the packet size for this session</span>
            <b>int</b> <span id="r134 rd" class="r134 r">packetSize</span>;
            <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#fbfe20dc1839a3de" class="i method">WSManGetSessionOptionAsDword</a>(<a href="#e71b1b284f1d2a52" class="i field">_wsManSessionHandle</a>,
                <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#f99c2939972a9aca" class="t t">WSManSessionOption</a>.<a href="WSManNativeAPI.cs.html#6b4f7c20bd03908e" class="i field">WSMAN_OPTION_SHELL_MAX_DATA_SIZE_PER_MESSAGE_KB</a>,
                <b>out</b> <span class="r134 r">packetSize</span>);
            <span class="c">// packet size returned is in KB. Convert this into bytes..</span>
            <a href="BaseTransportManager.cs.html#0597b18306926355" class="i property">Fragmentor</a>.<a href="../common/fragmentor.cs.html#a4fa6a799e0782de" class="i property">FragmentSize</a> = <span class="r134 r">packetSize</span> &lt;&lt; 10;
 
            <span class="c">// Get robust connections maximum retries time.</span>
            <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#fbfe20dc1839a3de" class="i method">WSManGetSessionOptionAsDword</a>(<a href="#e71b1b284f1d2a52" class="i field">_wsManSessionHandle</a>,
                <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#f99c2939972a9aca" class="t t">WSManSessionOption</a>.<a href="WSManNativeAPI.cs.html#45f9c56020c5e09e" class="i field">WSMAN_OPTION_MAX_RETRY_TIME</a>,
                <b>out</b> <a href="#bee8d0056d995215" class="i field">_maxRetryTime</a>);
 
            <a href="#693b43214373ab1e" class="k">this</a>.<a href="BaseTransportManager.cs.html#ee4a2ac1afa72dce" class="i field">dataToBeSent</a>.<a href="PriorityCollection.cs.html#84bdedfd536de402" class="i property">Fragmentor</a> = <a href="BaseTransportManager.cs.html#19883ec4df424177" class="k">base</a>.<a href="BaseTransportManager.cs.html#0597b18306926355" class="i property">Fragmentor</a>;
            <a href="#dd251fce18794104" class="i field">_noCompression</a> = !<span class="r118 r">connectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#1ec52b9b453e24eb" class="i property">UseCompression</a>;
            <a href="#0f8b6e6298fc6a90" class="i field">_noMachineProfile</a> = <span class="r118 r">connectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#c6c54cb9078f2a4c" class="i property">NoMachineProfile</a>;
 
            <span class="c">// set other WSMan session related defaults</span>
            <b>if</b> (<span class="r119 r">isSSLSpecified</span>)
            {
                <span class="c">// WSMan Port DCR related changes - BUG 542726</span>
                <span class="c">// this session option will tell WSMan to use port for HTTPS from</span>
                <span class="c">// config provider.</span>
                <a href="#6afd4b7993df20d4" class="i method">SetWSManSessionOption</a>(<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#f99c2939972a9aca" class="t t">WSManSessionOption</a>.<a href="WSManNativeAPI.cs.html#c747db8d211a9fff" class="i field">WSMAN_OPTION_USE_SSL</a>, 1);
            }
 
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">UNIX</span>
<span class="e">            // Explicitly disallow Basic auth over HTTP on Unix.
            if (connectionInfo.AuthenticationMechanism == AuthenticationMechanism.Basic &amp;&amp; !isSSLSpecified &amp;&amp; connectionUri.Scheme != Uri.UriSchemeHttps)
            {
                throw new PSRemotingTransportException(PSRemotingErrorId.ConnectFailed, RemotingErrorIdStrings.BasicAuthOverHttpNotSupported);
            }
 
            // The OMI client distributed with PowerShell does not support validating server certificates on Unix.
            // Check if third-party psrpclient and MI support the verification.
            // If WSManGetSessionOptionAsDword does not return 0 then it&#39;s not supported.
            bool verificationAvailable = WSManNativeApi.WSManGetSessionOptionAsDword(_wsManSessionHandle,
                WSManNativeApi.WSManSessionOption.WSMAN_OPTION_SKIP_CA_CHECK, out _) == 0;
 
            if (isSSLSpecified &amp;&amp; !verificationAvailable &amp;&amp; (!connectionInfo.SkipCACheck || !connectionInfo.SkipCNCheck))
            {
                throw new PSRemotingTransportException(PSRemotingErrorId.ConnectSkipCheckFailed, RemotingErrorIdStrings.UnixOnlyHttpsWithoutSkipCACheckNotSupported);
            }
</span><span class="k preprocess">#</span><span class="k preprocess">endif</span>
 
            <b>if</b> (<span class="r118 r">connectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#14ce6561582cbf9c" class="i property">NoEncryption</a>)
            {
                <span class="c">// send unencrypted messages</span>
                <a href="#6afd4b7993df20d4" class="i method">SetWSManSessionOption</a>(<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#f99c2939972a9aca" class="t t">WSManSessionOption</a>.<a href="WSManNativeAPI.cs.html#682b5cda7c47ebc2" class="i field">WSMAN_OPTION_UNENCRYPTED_MESSAGES</a>, 1);
            }
            <span class="c">// check if implicit credentials can be used for Negotiate</span>
            <b>if</b> (<span class="r118 r">connectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#1e6f82bf70a3e647" class="i property">AllowImplicitCredentialForNegotiate</a>)
            {
                <span class="r131 r">result</span> = <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#8657f3f36882e0cf" class="i method">WSManSetSessionOption</a>(<a href="#e71b1b284f1d2a52" class="i field">_wsManSessionHandle</a>,
                    <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#f99c2939972a9aca" class="t t">WSManSessionOption</a>.<a href="WSManNativeAPI.cs.html#c297eccf1cf6f818" class="i field">WSMAN_OPTION_ALLOW_NEGOTIATE_IMPLICIT_CREDENTIALS</a>,
                    <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#3355ebe78b09feca" class="t constructor">WSManDataDWord</a>(1));
            }
 
            <b>if</b> (<span class="r118 r">connectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#9b6f0e89a27da3f2" class="i property">UseUTF16</a>)
            {
                <a href="#6afd4b7993df20d4" class="i method">SetWSManSessionOption</a>(<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#f99c2939972a9aca" class="t t">WSManSessionOption</a>.<a href="WSManNativeAPI.cs.html#6b332062cfd1d39b" class="i field">WSMAN_OPTION_UTF16</a>, 1);
            }
 
            <b>if</b> (<span class="r118 r">connectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#1a6db05682add6a0" class="i property">SkipCACheck</a>)
            {
                <a href="#6afd4b7993df20d4" class="i method">SetWSManSessionOption</a>(<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#f99c2939972a9aca" class="t t">WSManSessionOption</a>.<a href="WSManNativeAPI.cs.html#9bb2c1422542a0b1" class="i field">WSMAN_OPTION_SKIP_CA_CHECK</a>, 1);
            }
 
            <b>if</b> (<span class="r118 r">connectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#62a5656f8055cfb5" class="i property">SkipCNCheck</a>)
            {
                <a href="#6afd4b7993df20d4" class="i method">SetWSManSessionOption</a>(<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#f99c2939972a9aca" class="t t">WSManSessionOption</a>.<a href="WSManNativeAPI.cs.html#1842c57f2189449c" class="i field">WSMAN_OPTION_SKIP_CN_CHECK</a>, 1);
            }
 
            <b>if</b> (<span class="r118 r">connectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#db5f31fe8eaa8600" class="i property">SkipRevocationCheck</a>)
            {
                <a href="#6afd4b7993df20d4" class="i method">SetWSManSessionOption</a>(<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#f99c2939972a9aca" class="t t">WSManSessionOption</a>.<a href="WSManNativeAPI.cs.html#917997fc614eb38d" class="i field">WSMAN_OPTION_SKIP_REVOCATION_CHECK</a>, 1);
            }
 
            <b>if</b> (<span class="r118 r">connectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#7c39032b57cd7818" class="i property">IncludePortInSPN</a>)
            {
                <a href="#6afd4b7993df20d4" class="i method">SetWSManSessionOption</a>(<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#f99c2939972a9aca" class="t t">WSManSessionOption</a>.<a href="WSManNativeAPI.cs.html#cd747326c0c441a9" class="i field">WSMAN_OPTION_ENABLE_SPN_SERVER_PORT</a>, 1);
            }
 
            <span class="c">// Set use interactive token flag based on EnableNetworkAccess property.</span>
            <a href="#6afd4b7993df20d4" class="i method">SetWSManSessionOption</a>(<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#f99c2939972a9aca" class="t t">WSManSessionOption</a>.<a href="WSManNativeAPI.cs.html#e758736b6303adc4" class="i field">WSMAN_OPTION_USE_INTERACTIVE_TOKEN</a>,
                (<span class="r118 r">connectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#bccff2b013731c62" class="i property">EnableNetworkAccess</a>) ? 1 : 0);
 
            <span class="c">// set UI Culture for this session from current thread&#39;s UI Culture</span>
            <b>string</b> <span id="r135 rd" class="r135 r">currentUICulture</span> = <span class="r118 r">connectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#27251d0ea7ef6aba" class="i property">UICulture</a>.<span class="i">Name</span>;
            <b>if</b> (!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r135 r">currentUICulture</span>))
            {
                <span class="c">// WSMan API cannot handle empty culture names</span>
                <a href="#474f20c06f78078f" class="i method">SetWSManSessionOption</a>(<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#f99c2939972a9aca" class="t t">WSManSessionOption</a>.<a href="WSManNativeAPI.cs.html#3b30ca6e4a23d15d" class="i field">WSMAN_OPTION_UI_LANGUAGE</a>, <span class="r135 r">currentUICulture</span>);
            }
 
            <span class="c">// set Culture for this session from current thread&#39;s Culture</span>
            <b>string</b> <span id="r136 rd" class="r136 r">currentCulture</span> = <span class="r118 r">connectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#237e4765cd52489b" class="i property">Culture</a>.<span class="i">Name</span>;
            <b>if</b> (!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r136 r">currentCulture</span>))
            {
                <a href="#474f20c06f78078f" class="i method">SetWSManSessionOption</a>(<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#f99c2939972a9aca" class="t t">WSManSessionOption</a>.<a href="WSManNativeAPI.cs.html#9ca39a3c5ba172e0" class="i field">WSMAN_OPTION_LOCALE</a>, <span class="r136 r">currentCulture</span>);
            }
 
            <span class="c">// set the PowerShell specific default client timeouts</span>
            <a href="#f2ed25563d47e421" class="i method">SetDefaultTimeOut</a>(<span class="r118 r">connectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#53cee291a23086f5" class="i property">OperationTimeout</a>);
            <a href="#96e9cf4880e8c3ae" class="i method">SetConnectTimeOut</a>(<span class="r118 r">connectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#a0a3c947f4d2fe9e" class="i property">OpenTimeout</a>);
            <a href="#d2060f96de4cec57" class="i method">SetCloseTimeOut</a>(<span class="r118 r">connectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#b136d8269dabb6c4" class="i property">CancelTimeout</a>);
            <a href="#fc4d3d676ba165ed" class="i method">SetSignalTimeOut</a>(<span class="r118 r">connectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#b136d8269dabb6c4" class="i property">CancelTimeout</a>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Handle transport error - calls EnqueueAndStartProcessingThread to process transport exception</span>
        <span class="c">///</span><span class="c"> in a different thread</span>
        <span class="c">///</span><span class="c"> Logic in transport callbacks should always use this to process a transport error.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="938e18940d5e6747" href="../../../R/938e18940d5e6747.html" target="n" data-glyph="74,1" class="i method">ProcessWSManTransportError</a>(<a href="BaseTransportManager.cs.html#7e70b34f9332dfcd" class="t t">TransportErrorOccuredEventArgs</a> <span id="r137 rd" class="r137 r">eventArgs</span>)
        {
            <a href="BaseTransportManager.cs.html#a152fe644f7ae9c1" class="i method">EnqueueAndStartProcessingThread</a>(<b>null</b>, <span class="r137 r">eventArgs</span>, <b>null</b>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Log the error message in the Crimson logger and raise error handler.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r138 r">eventArgs</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal override void</b> <a id="90dc9d72316cd2ed" href="../../../R/90dc9d72316cd2ed.html" target="n" data-glyph="74,1" class="i method">RaiseErrorHandler</a>(<a href="BaseTransportManager.cs.html#7e70b34f9332dfcd" class="t t">TransportErrorOccuredEventArgs</a> <span id="r138 rd" class="r138 r">eventArgs</span>)
        {
            <span class="c">// Look for a valid stack trace.</span>
            <b>string</b> <span id="r139 rd" class="r139 r">stackTrace</span>;
            <b>if</b> (!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r138 r">eventArgs</span>.<a href="BaseTransportManager.cs.html#f82124202b7ff8f0" class="i property">Exception</a>.<span class="i">StackTrace</span>))
            {
                <span class="r139 r">stackTrace</span> = <span class="r138 r">eventArgs</span>.<a href="BaseTransportManager.cs.html#f82124202b7ff8f0" class="i property">Exception</a>.<span class="i">StackTrace</span>;
            }
            <b>else</b> <b>if</b> (<span class="r138 r">eventArgs</span>.<a href="BaseTransportManager.cs.html#f82124202b7ff8f0" class="i property">Exception</a>.<span class="i">InnerException</span> != <b>null</b> &amp;&amp;
                     !<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r138 r">eventArgs</span>.<a href="BaseTransportManager.cs.html#f82124202b7ff8f0" class="i property">Exception</a>.<span class="i">InnerException</span>.<span class="i">StackTrace</span>))
            {
                <span class="r139 r">stackTrace</span> = <span class="r138 r">eventArgs</span>.<a href="BaseTransportManager.cs.html#f82124202b7ff8f0" class="i property">Exception</a>.<span class="i">InnerException</span>.<span class="i">StackTrace</span>;
            }
            <b>else</b>
            {
                <span class="r139 r">stackTrace</span> = <b>string</b>.<span class="i">Empty</span>;
            }
 
            <span class="c">// Write errors into both Operational and Analytical channels</span>
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogOperationalError</span>(
                <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#4ddb36cebdb0b70c" class="i field">TransportError</a>, <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#399fd86ea109ec79" class="i field">Open</a>, <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>, <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#05d709c2010b41d5" class="i field">UseAlwaysOperational</a>,
                <a href="BaseTransportManager.cs.html#6b69cd5f8cc06fb7" class="i property">RunspacePoolInstanceId</a>.<span class="i">ToString</span>(),
                <span class="i">Guid</span>.<span class="i">Empty</span>.<span class="i">ToString</span>(),
                <span class="r138 r">eventArgs</span>.<a href="BaseTransportManager.cs.html#f82124202b7ff8f0" class="i property">Exception</a>.<a href="../common/remotingexceptions.cs.html#f96218464c4b7244" class="i property">ErrorCode</a>.<span class="i">ToString</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>),
                <span class="r138 r">eventArgs</span>.<a href="BaseTransportManager.cs.html#f82124202b7ff8f0" class="i property">Exception</a>.<span class="i">Message</span>,
                <span class="r139 r">stackTrace</span>);
 
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticError</span>(
                <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#f50b10cdf9431275" class="i field">TransportError_Analytic</a>,
                <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#399fd86ea109ec79" class="i field">Open</a>, <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#c5d4a73b62c859ab" class="i field">Transport</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                <a href="BaseTransportManager.cs.html#6b69cd5f8cc06fb7" class="i property">RunspacePoolInstanceId</a>.<span class="i">ToString</span>(),
                <span class="i">Guid</span>.<span class="i">Empty</span>.<span class="i">ToString</span>(),
                <span class="r138 r">eventArgs</span>.<a href="BaseTransportManager.cs.html#f82124202b7ff8f0" class="i property">Exception</a>.<a href="../common/remotingexceptions.cs.html#f96218464c4b7244" class="i property">ErrorCode</a>.<span class="i">ToString</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>),
                <span class="r138 r">eventArgs</span>.<a href="BaseTransportManager.cs.html#f82124202b7ff8f0" class="i property">Exception</a>.<span class="i">Message</span>,
                <span class="r139 r">stackTrace</span>);
 
            <a href="BaseTransportManager.cs.html#19883ec4df424177" class="k">base</a>.<a href="BaseTransportManager.cs.html#8e00d8a2f8745652" class="i method">RaiseErrorHandler</a>(<span class="r138 r">eventArgs</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Receive/send operation handles and callback handles should be released/disposed from</span>
        <span class="c">///</span><span class="c"> receive/send callback only. Releasing them after CloseOperation() may not cover all</span>
        <span class="c">///</span><span class="c"> the scenarios, as WSMan does not guarantee that a rcv/send callback is not called after</span>
        <span class="c">///</span><span class="c"> Close completed callback.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r140 r">flags</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r141 r">shouldClearSend</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="6f8215a53ee62197" href="../../../R/6f8215a53ee62197.html" target="n" data-glyph="74,1" class="i method">ClearReceiveOrSendResources</a>(<b>int</b> <span id="r140 rd" class="r140 r">flags</span>, <b>bool</b> <span id="r141 rd" class="r141 r">shouldClearSend</span>)
        {
            <b>if</b> (<span class="r141 r">shouldClearSend</span>)
            {
                <b>if</b> (<a href="#7db9e01d865492bd" class="i field">_sendToRemoteCompleted</a> != <b>null</b>)
                {
                    <a href="#7db9e01d865492bd" class="i field">_sendToRemoteCompleted</a>.<a href="WSManNativeAPI.cs.html#c68800d727cb6a45" class="i method">Dispose</a>();
                    <a href="#7db9e01d865492bd" class="i field">_sendToRemoteCompleted</a> = <b>null</b>;
                }
 
                <span class="c">// For send..clear always</span>
                <b>if</b> (<a href="#1cd15cdc83709878" class="i field">_wsManSendOperationHandle</a> != <span class="i">IntPtr</span>.<span class="i">Zero</span>)
                {
                    <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#96b121ea122bb25a" class="i method">WSManCloseOperation</a>(<a href="#1cd15cdc83709878" class="i field">_wsManSendOperationHandle</a>, 0);
                    <a href="#1cd15cdc83709878" class="i field">_wsManSendOperationHandle</a> = <span class="i">IntPtr</span>.<span class="i">Zero</span>;
                }
            }
            <b>else</b>
            {
                <span class="c">// clearing for receive..Clear only when the end of operation is reached.</span>
                <b>if</b> (<span class="r140 r">flags</span> == (<b>int</b>)<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#4b939349c4d4b263" class="t t">WSManCallbackFlags</a>.<a href="WSManNativeAPI.cs.html#e14d6bd19f5d1f34" class="i field">WSMAN_FLAG_CALLBACK_END_OF_OPERATION</a>)
                {
                    <b>if</b> (<a href="#13bf3d1545f10c0d" class="i field">_wsManReceiveOperationHandle</a> != <span class="i">IntPtr</span>.<span class="i">Zero</span>)
                    {
                        <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#96b121ea122bb25a" class="i method">WSManCloseOperation</a>(<a href="#13bf3d1545f10c0d" class="i field">_wsManReceiveOperationHandle</a>, 0);
                        <a href="#13bf3d1545f10c0d" class="i field">_wsManReceiveOperationHandle</a> = <span class="i">IntPtr</span>.<span class="i">Zero</span>;
                    }
 
                    <b>if</b> (<a href="#971d9b6b19cb0ae3" class="i field">_receivedFromRemote</a> != <b>null</b>)
                    {
                        <a href="#971d9b6b19cb0ae3" class="i field">_receivedFromRemote</a>.<a href="WSManNativeAPI.cs.html#c68800d727cb6a45" class="i method">Dispose</a>();
                        <a href="#971d9b6b19cb0ae3" class="i field">_receivedFromRemote</a> = <b>null</b>;
                    }
                }
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Call back from worker thread / queue to raise Robust Connection notification event.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r142 r">privateData</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">ConnectionStatusEventArgs.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal override void</b> <a id="0e484821756b906c" href="../../../R/0e484821756b906c.html" target="n" data-glyph="74,1" class="i method">ProcessPrivateData</a>(<b>object</b> <span id="r142 rd" class="r142 r">privateData</span>)
        {
            <span class="c">// Raise the Robust</span>
            <a href="BaseTransportManager.cs.html#598698ed70e51507" class="t t">ConnectionStatusEventArgs</a> <span id="r143 rd" class="r143 r">rcArgs</span> = <span class="r142 r">privateData</span> <b>as</b> <a href="BaseTransportManager.cs.html#598698ed70e51507" class="t t">ConnectionStatusEventArgs</a>;
            <b>if</b> (<span class="r143 r">rcArgs</span> != <b>null</b>)
            {
                <a href="BaseTransportManager.cs.html#16bb9c3b15b05748" class="i method">RaiseRobustConnectionNotification</a>(<span class="r143 r">rcArgs</span>);
                <b>return</b>;
            }
 
            <a href="#856d8234e22306d6" class="t t">CompletionEventArgs</a> <span id="r144 rd" class="r144 r">completionArgs</span> = <span class="r142 r">privateData</span> <b>as</b> <a href="#856d8234e22306d6" class="t t">CompletionEventArgs</a>;
            <b>if</b> (<span class="r144 r">completionArgs</span> != <b>null</b>)
            {
                <b>switch</b> (<span class="r144 r">completionArgs</span>.<a href="#15b4e7aca265588d" class="i property">Notification</a>)
                {
                    <b>case</b> <a href="#ed02d4fc471b4338" class="t t">CompletionNotification</a>.<a href="#6d885bea5bdd70f8" class="i field">DisconnectCompleted</a>:
                        <a href="BaseTransportManager.cs.html#d26c71bd373e74ab" class="i method">RaiseDisconnectCompleted</a>();
                        <b>break</b>;
 
                    <b>default</b>:
                        <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<b>false</b>, <span class="s">&quot;Currently only DisconnectCompleted notification is handled on the worker thread queue.&quot;</span>);
                        <b>break</b>;
                }
 
                <b>return</b>;
            }
 
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<b>false</b>, <span class="s">&quot;Worker thread callback should always have ConnectionStatusEventArgs or CompletionEventArgs type for privateData.&quot;</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Robust connection maximum retry time in milliseconds.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal int</b> <a id="c49f6acabd3d369e" href="../../../R/c49f6acabd3d369e.html" target="n" data-glyph="104,1" class="i property">MaxRetryConnectionTime</a>
        {
            <b>get</b> { <b>return</b> <a href="#bee8d0056d995215" class="i field">_maxRetryTime</a>; }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Returns the WSMan&#39;s session handle that this Session transportmanager</span>
        <span class="c">///</span><span class="c"> is proxying.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal</b> <span class="i">IntPtr</span> <a id="e8c30b78e828e9e3" href="../../../R/e8c30b78e828e9e3.html" target="n" data-glyph="104,1" class="i property">SessionHandle</a>
        {
            <b>get</b> { <b>return</b> <a href="#e71b1b284f1d2a52" class="i field">_wsManSessionHandle</a>; }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Returns the WSManConnectionInfo used to make the connection.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal</b> <a href="../common/RunspaceConnectionInfo.cs.html#2d9d176ef419be5a" class="t t">WSManConnectionInfo</a> <a id="c09ce13debcbb880" href="../../../R/c09ce13debcbb880.html" target="n" data-glyph="104,1" class="i property">ConnectionInfo</a> { <b>get</b>; <b>private set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Examine the session create error code and if the error is one where a</span>
        <span class="c">///</span><span class="c"> session create/connect retry attempt may be beneficial then do the</span>
        <span class="c">///</span><span class="c"> retry attempt.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r145 r">sessionCreateErrorCode</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Error code returned from Create response.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">True if a session create retry has been started.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>private bool</b> <a id="b4ea4ca9b5837d7c" href="../../../R/b4ea4ca9b5837d7c.html" target="n" data-glyph="76,1" class="i method">RetrySessionCreation</a>(<b>int</b> <span id="r145 rd" class="r145 r">sessionCreateErrorCode</span>)
        {
            <b>if</b> (<a href="#cb2ec538b7b3197c" class="i field">_connectionRetryCount</a> &gt;= <a href="#c09ce13debcbb880" class="i property">ConnectionInfo</a>.<a href="../common/RunspaceConnectionInfo.cs.html#bab09f8d743ff058" class="i property">MaxConnectionRetryCount</a>) { <b>return</b> <b>false</b>; }
 
            <b>bool</b> <span id="r146 rd" class="r146 r">retryConnect</span>;
            <b>switch</b> (<span class="r145 r">sessionCreateErrorCode</span>)
            {
                <span class="c">// Continue with connect retry for these errors.</span>
                <b>case</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#42bce97949b29c7f" class="i field">ERROR_WSMAN_SENDDATA_CANNOT_CONNECT</a>:
                <b>case</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#f5c48d5d91b05694" class="i field">ERROR_WSMAN_OPERATION_ABORTED</a>:
                <b>case</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#0132dca2b19bdd62" class="i field">ERROR_WSMAN_IMPROPER_RESPONSE</a>:
                <b>case</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#2c82cad02e089372" class="i field">ERROR_WSMAN_URL_NOTAVAILABLE</a>:
                <b>case</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#2a1ea5cefdac71dd" class="i field">ERROR_WSMAN_CANNOT_CONNECT_INVALID</a>:
                <b>case</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#45e3dd7a9e1dc0b1" class="i field">ERROR_WSMAN_CANNOT_CONNECT_MISMATCH</a>:
                <b>case</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#d27141b364d9bc76" class="i field">ERROR_WSMAN_HTTP_SERVICE_UNAVAILABLE</a>:
                <b>case</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#4ea7a2b87f034192" class="i field">ERROR_WSMAN_HTTP_SERVICE_ERROR</a>:
                    <span class="r146 r">retryConnect</span> = <b>true</b>;
                    <b>break</b>;
 
                <span class="c">// For any other errors don&#39;t do connect retry.</span>
                <b>default</b>:
                    <span class="r146 r">retryConnect</span> = <b>false</b>;
                    <b>break</b>;
            }
 
            <b>if</b> (<span class="r146 r">retryConnect</span>)
            {
                ++<a href="#cb2ec538b7b3197c" class="i field">_connectionRetryCount</a>;
 
                <span class="c">// Write trace output</span>
                <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<span class="i">WriteLine</span>(<span class="s">&quot;Attempting session creation retry {0} for error code {1} on session Id {2}&quot;</span>,
                    <a href="#cb2ec538b7b3197c" class="i field">_connectionRetryCount</a>, <span class="r145 r">sessionCreateErrorCode</span>, <a href="BaseTransportManager.cs.html#6b69cd5f8cc06fb7" class="i property">RunspacePoolInstanceId</a>);
 
                <span class="c">// Create ETW log entry</span>
                <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogOperationalInformation</span>(
                    <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#fd917b7b06b04ff2" class="i field">RetrySessionCreation</a>, <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#399fd86ea109ec79" class="i field">Open</a>, <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                    <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#05d709c2010b41d5" class="i field">UseAlwaysOperational</a>,
                    <a href="#cb2ec538b7b3197c" class="i field">_connectionRetryCount</a>.<span class="i">ToString</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>),
                    <span class="r145 r">sessionCreateErrorCode</span>.<span class="i">ToString</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>),
                    <a href="BaseTransportManager.cs.html#6b69cd5f8cc06fb7" class="i property">RunspacePoolInstanceId</a>.<span class="i">ToString</span>());
 
                <span class="c">// Use worker pool thread to initiate retry, since WSMan does not allow method</span>
                <span class="c">// calls on its own call back thread.</span>
                <span class="i n">System</span>.<span class="i">Threading</span>.<span class="i">ThreadPool</span>.<span class="i">QueueUserWorkItem</span>(<span class="i">StartCreateRetry</span>);
            }
 
            <b>return</b> <span class="r146 r">retryConnect</span>;
        }
 
        <b>private void</b> <a id="a8dafd623f599a29" href="../../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">StartCreateRetry</a>(<b>object</b> <span id="r147 rd" class="r147 r">state</span>)
        {
            <span class="c">// Begin new session create attempt.</span>
            <a href="#60520c410fa716ee" class="i field">_startMode</a> = <a href="#b4291df75d9bc408" class="t t">WSManTransportManagerUtils</a>.<a href="#591d3d3614fb4562" class="t t">tmStartModes</a>.<a href="#6cebc3fa4e6113a6" class="i field">None</a>;
            <a href="#e6e7996b4f2cca17" class="i method">CreateAsync</a>();
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Static Callbacks from WSMan
 
        <span class="c">// callback that gets called when createshellex returns.</span>
        <b>private static void</b> <a id="40b11df684553a3c" href="../../../R/40b11df684553a3c.html" target="n" data-glyph="76,1" class="i method">OnCreateSessionCallback</a>(<span class="i">IntPtr</span> <span id="r148 rd" class="r148 r">operationContext</span>,
            <b>int</b> <span id="r149 rd" class="r149 r">flags</span>,
            <span class="i">IntPtr</span> <span id="r150 rd" class="r150 r">error</span>,
            <span class="i">IntPtr</span> <span id="r151 rd" class="r151 r">shellOperationHandle</span>,
            <span class="i">IntPtr</span> <span id="r152 rd" class="r152 r">commandOperationHandle</span>,
            <span class="i">IntPtr</span> <span id="r153 rd" class="r153 r">operationHandle</span>,
            <span class="i">IntPtr</span> <span id="r154 rd" class="r154 r">data</span>)
        {
            <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<a href="../../../utils/StructuredTraceSource.cs.html#96aaf3813a5962a0" class="i method">WriteLine</a>(<span class="s">&quot;Client Session TM: CreateShell callback received&quot;</span>);
 
            <b>long</b> <span id="r155 rd" class="r155 r">sessionTMHandle</span> = 0;
            <a href="#693b43214373ab1e" class="t t">WSManClientSessionTransportManager</a> <span id="r156 rd" class="r156 r">sessionTM</span> = <b>null</b>;
            <b>if</b> (!<a href="#2a75e4ba1391788d" class="i method">TryGetSessionTransportManager</a>(<span class="r148 r">operationContext</span>, <b>out</b> <span class="r156 r">sessionTM</span>, <b>out</b> <span class="r155 r">sessionTMHandle</span>))
            {
                <span class="c">// We dont have the session TM handle..just return.</span>
                <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<a href="../../../utils/StructuredTraceSource.cs.html#25fe29b46cfb1e10" class="i method">WriteLine</a>(<span class="s">&quot;Unable to find a transport manager for context {0}.&quot;</span>, <span class="r155 r">sessionTMHandle</span>);
                <b>return</b>;
            }
 
            <span class="c">// This callback is also used for robust connection notifications.  Check for and</span>
            <span class="c">// handle these notifications here.</span>
            <b>if</b> (<a href="#f8630aede3718229" class="i method">HandleRobustConnectionCallback</a>(<span class="r149 r">flags</span>, <span class="r156 r">sessionTM</span>))
            {
                <b>return</b>;
            }
 
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(
                <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#9c15dab839a863ae" class="i field">WSManCreateShellCallbackReceived</a>,
                <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#a0f7cf0d4987790f" class="i field">Connect</a>,
                <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#c5d4a73b62c859ab" class="i field">Transport</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                <span class="r156 r">sessionTM</span>.<a href="BaseTransportManager.cs.html#6b69cd5f8cc06fb7" class="i property">RunspacePoolInstanceId</a>.<span class="i">ToString</span>());
 
            <span class="c">// TODO: 188098 wsManShellOperationHandle should be populated by WSManCreateShellEx,</span>
            <span class="c">// but there is a thread timing bug in WSMan layer causing the callback to</span>
            <span class="c">// be called before WSManCreateShellEx returns. since we already validated the</span>
            <span class="c">// shell context exists, safely assigning the shellOperationHandle to shell transport manager.</span>
            <span class="c">// Remove this once WSMan fixes its code.</span>
            <span class="r156 r">sessionTM</span>.<a href="#5120ad7297341362" class="i field">_wsManShellOperationHandle</a> = <span class="r151 r">shellOperationHandle</span>;
 
            <b>lock</b> (<span class="r156 r">sessionTM</span>.<a href="BaseTransportManager.cs.html#2b6037d6b3777ca1" class="i field">syncObject</a>)
            {
                <span class="c">// Already close request is made. So return</span>
                <b>if</b> (<span class="r156 r">sessionTM</span>.<a href="BaseTransportManager.cs.html#76271338de46dcf0" class="i field">isClosed</a>)
                {
                    <b>return</b>;
                }
            }
 
            <b>if</b> (<span class="r150 r">error</span> != <span class="i">IntPtr</span>.<span class="i">Zero</span>)
            {
                <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#587a4e1f26edb30b" class="t t">WSManError</a> <span id="r157 rd" class="r157 r">errorStruct</span> = <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#587a4e1f26edb30b" class="t t">WSManError</a>.<a href="WSManNativeAPI.cs.html#0577f3d9734092d0" class="i method">UnMarshal</a>(<span class="r150 r">error</span>);
 
                <b>if</b> (<span class="r157 r">errorStruct</span>.<a href="WSManNativeAPI.cs.html#3bfbb0e97567321f" class="i field">errorCode</a> != 0)
                {
                    <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<span class="i">WriteLine</span>(<span class="s">&quot;Got error with error code {0}. Message {1}&quot;</span>, <span class="r157 r">errorStruct</span>.<a href="WSManNativeAPI.cs.html#3bfbb0e97567321f" class="i field">errorCode</a>.<span class="i">ToString</span>(), <span class="r157 r">errorStruct</span>.<a href="WSManNativeAPI.cs.html#5497bacefa3538a3" class="i field">errorDetail</a>);
 
                    <span class="c">// Test error code for possible session connection retry.</span>
                    <b>if</b> (<span class="r156 r">sessionTM</span>.<a href="#b4ea4ca9b5837d7c" class="i method">RetrySessionCreation</a>(<span class="r157 r">errorStruct</span>.<a href="WSManNativeAPI.cs.html#3bfbb0e97567321f" class="i field">errorCode</a>))
                    {
                        <span class="c">// If a connection retry is being attempted (on</span>
                        <span class="c">// another thread) then return without processing error.</span>
                        <b>return</b>;
                    }
 
                    <a href="BaseTransportManager.cs.html#7e70b34f9332dfcd" class="t t">TransportErrorOccuredEventArgs</a> <span id="r158 rd" class="r158 r">eventargs</span> = <a href="#b4291df75d9bc408" class="t t">WSManTransportManagerUtils</a>.<span class="i">ConstructTransportErrorEventArgs</span>(
                        <span class="r156 r">sessionTM</span>.<a href="#7616e1c5a9b266f9" class="i property">WSManAPIData</a>.<a href="#f386d97c12d99137" class="i property">WSManAPIHandle</a>,
                        <span class="r156 r">sessionTM</span>,
                        <span class="r157 r">errorStruct</span>,
                        <a href="BaseTransportManager.cs.html#33678df914ca9daf" class="t t">TransportMethodEnum</a>.<a href="BaseTransportManager.cs.html#a8019a6497e609cf" class="i field">CreateShellEx</a>,
                        <span class="i">RemotingErrorIdStrings</span>.<span class="i">ConnectExCallBackError</span>,
                        <b>new</b> <b>object</b>[] { <span class="r156 r">sessionTM</span>.<a href="#c09ce13debcbb880" class="i property">ConnectionInfo</a>.<a href="../common/RunspaceConnectionInfo.cs.html#74b71e9668d24a47" class="i property">ComputerName</a>, <a href="#b4291df75d9bc408" class="t t">WSManTransportManagerUtils</a>.<a href="#95feb8ba0fde2a13" class="i method">ParseEscapeWSManErrorMessage</a>(<span class="r157 r">errorStruct</span>.<a href="WSManNativeAPI.cs.html#5497bacefa3538a3" class="i field">errorDetail</a>) });
                    <span class="r156 r">sessionTM</span>.<a href="#938e18940d5e6747" class="i method">ProcessWSManTransportError</a>(<span class="r158 r">eventargs</span>);
 
                    <b>return</b>;
                }
            }
 
            <span class="c">// check if the session supports disconnect</span>
            <span class="r156 r">sessionTM</span>.<a href="#a8f057948cd2a14c" class="i property">SupportsDisconnect</a> = (<span class="r149 r">flags</span> &amp; (<b>int</b>)<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#4b939349c4d4b263" class="t t">WSManCallbackFlags</a>.<a href="WSManNativeAPI.cs.html#37220dfdda208a17" class="i field">WSMAN_FLAG_CALLBACK_SHELL_SUPPORTS_DISCONNECT</a>) != 0;
 
            <span class="c">// openContent is used by redirection ie., while redirecting to</span>
            <span class="c">// a new machine.. this is not needed anymore as the connection</span>
            <span class="c">// is successfully established.</span>
            <b>if</b> (<span class="r156 r">sessionTM</span>.<a href="#b636a4d17100c22a" class="i field">_openContent</a> != <b>null</b>)
            {
                <span class="r156 r">sessionTM</span>.<a href="#b636a4d17100c22a" class="i field">_openContent</a>.<a href="WSManNativeAPI.cs.html#a723a8d748579007" class="i method">Dispose</a>();
                <span class="r156 r">sessionTM</span>.<a href="#b636a4d17100c22a" class="i field">_openContent</a> = <b>null</b>;
            }
 
            <b>if</b> (<span class="r154 r">data</span> != <span class="i">IntPtr</span>.<span class="i">Zero</span>)
            {
                <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#d03b82b6a40c6238" class="t t">WSManCreateShellDataResult</a> <span id="r159 rd" class="r159 r">shellData</span> = <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#d03b82b6a40c6238" class="t t">WSManCreateShellDataResult</a>.<a href="WSManNativeAPI.cs.html#1362ad8d6d464ebe" class="i method">UnMarshal</a>(<span class="r154 r">data</span>);
                <b>if</b> (<span class="r159 r">shellData</span>.<a href="WSManNativeAPI.cs.html#3fe1643210e0fb7c" class="i field">data</a> != <b>null</b>)
                {
                    <b>string</b> <span id="r160 rd" class="r160 r">returnXml</span> = <span class="r159 r">shellData</span>.<a href="WSManNativeAPI.cs.html#3fe1643210e0fb7c" class="i field">data</a>;
 
                    <span class="r156 r">sessionTM</span>.<a href="#1943689d51db70d7" class="i method">ProcessShellData</a>(<span class="r160 r">returnXml</span>);
                }
            }
 
            <b>lock</b> (<span class="r156 r">sessionTM</span>.<a href="BaseTransportManager.cs.html#2b6037d6b3777ca1" class="i field">syncObject</a>)
            {
                <span class="c">// make sure the transport is not closed yet.</span>
                <b>if</b> (<span class="r156 r">sessionTM</span>.<a href="BaseTransportManager.cs.html#76271338de46dcf0" class="i field">isClosed</a>)
                {
                    <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<a href="../../../utils/StructuredTraceSource.cs.html#96aaf3813a5962a0" class="i method">WriteLine</a>(<span class="s">&quot;Client Session TM: Transport manager is closed. So returning&quot;</span>);
                    <b>return</b>;
                }
 
                <span class="c">// Successfully made a connection. Now report this by raising the CreateCompleted event.</span>
                <span class="c">// Pass updated connection information to event.</span>
                <span class="r156 r">sessionTM</span>.<a href="BaseTransportManager.cs.html#6d89008ab776a459" class="i method">RaiseCreateCompleted</a>(
                    <b>new</b> <a href="BaseTransportManager.cs.html#45cdeec22cf7f878" class="t constructor">CreateCompleteEventArgs</a>(<span class="r156 r">sessionTM</span>.<a href="#c09ce13debcbb880" class="i property">ConnectionInfo</a>.<a href="../common/RunspaceConnectionInfo.cs.html#34f8c1aa90e3af78" class="i method">Copy</a>()));
 
                <span class="c">// Since create shell is successful, put a receive request.</span>
                <span class="r156 r">sessionTM</span>.<a href="#7188a5e1aa5f5bf2" class="i method">StartReceivingData</a>();
            }
            <span class="c">// Start sending data if any.</span>
            <span class="r156 r">sessionTM</span>.<a href="#e227f54c5577105e" class="i method">SendOneItem</a>();
        }
 
        <span class="c">// callback that gets called when closeshellex returns.</span>
        <b>private static void</b> <a id="dc2f938509fd0d71" href="../../../R/dc2f938509fd0d71.html" target="n" data-glyph="76,1" class="i method">OnCloseSessionCompleted</a>(<span class="i">IntPtr</span> <span id="r161 rd" class="r161 r">operationContext</span>,
            <b>int</b> <span id="r162 rd" class="r162 r">flags</span>,
            <span class="i">IntPtr</span> <span id="r163 rd" class="r163 r">error</span>,
            <span class="i">IntPtr</span> <span id="r164 rd" class="r164 r">shellOperationHandle</span>,
            <span class="i">IntPtr</span> <span id="r165 rd" class="r165 r">commandOperationHandle</span>,
            <span class="i">IntPtr</span> <span id="r166 rd" class="r166 r">operationHandle</span>,
            <span class="i">IntPtr</span> <span id="r167 rd" class="r167 r">data</span>)
        {
            <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<a href="../../../utils/StructuredTraceSource.cs.html#96aaf3813a5962a0" class="i method">WriteLine</a>(<span class="s">&quot;Client Session TM: CloseShell callback received&quot;</span>);
 
            <b>long</b> <span id="r168 rd" class="r168 r">sessionTMHandle</span> = 0;
            <a href="#693b43214373ab1e" class="t t">WSManClientSessionTransportManager</a> <span id="r169 rd" class="r169 r">sessionTM</span> = <b>null</b>;
            <b>if</b> (!<a href="#2a75e4ba1391788d" class="i method">TryGetSessionTransportManager</a>(<span class="r161 r">operationContext</span>, <b>out</b> <span class="r169 r">sessionTM</span>, <b>out</b> <span class="r168 r">sessionTMHandle</span>))
            {
                <span class="c">// We dont have the session TM handle..just return.</span>
                <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<a href="../../../utils/StructuredTraceSource.cs.html#25fe29b46cfb1e10" class="i method">WriteLine</a>(<span class="s">&quot;Unable to find a transport manager for context {0}.&quot;</span>, <span class="r168 r">sessionTMHandle</span>);
                <b>return</b>;
            }
 
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(
                <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#eede3d08d2e133db" class="i field">WSManCloseShellCallbackReceived</a>,
                <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#f3d85cb80e62fe3e" class="i field">Disconnect</a>,
                <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#c5d4a73b62c859ab" class="i field">Transport</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                <span class="r169 r">sessionTM</span>.<a href="BaseTransportManager.cs.html#6b69cd5f8cc06fb7" class="i property">RunspacePoolInstanceId</a>.<span class="i">ToString</span>(),
                <span class="s">&quot;OnCloseSessionCompleted&quot;</span>);
 
            <b>if</b> (<span class="r163 r">error</span> != <span class="i">IntPtr</span>.<span class="i">Zero</span>)
            {
                <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#587a4e1f26edb30b" class="t t">WSManError</a> <span id="r170 rd" class="r170 r">errorStruct</span> = <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#587a4e1f26edb30b" class="t t">WSManError</a>.<a href="WSManNativeAPI.cs.html#0577f3d9734092d0" class="i method">UnMarshal</a>(<span class="r163 r">error</span>);
 
                <b>if</b> (<span class="r170 r">errorStruct</span>.<a href="WSManNativeAPI.cs.html#3bfbb0e97567321f" class="i field">errorCode</a> != 0)
                {
                    <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<span class="i">WriteLine</span>(<span class="s">&quot;Got error with error code {0}. Message {1}&quot;</span>, <span class="r170 r">errorStruct</span>.<a href="WSManNativeAPI.cs.html#3bfbb0e97567321f" class="i field">errorCode</a>.<span class="i">ToString</span>(), <span class="r170 r">errorStruct</span>.<a href="WSManNativeAPI.cs.html#5497bacefa3538a3" class="i field">errorDetail</a>);
 
                    <a href="BaseTransportManager.cs.html#7e70b34f9332dfcd" class="t t">TransportErrorOccuredEventArgs</a> <span id="r171 rd" class="r171 r">eventargs</span> = <a href="#b4291df75d9bc408" class="t t">WSManTransportManagerUtils</a>.<span class="i">ConstructTransportErrorEventArgs</span>(
                        <span class="r169 r">sessionTM</span>.<a href="#7616e1c5a9b266f9" class="i property">WSManAPIData</a>.<a href="#f386d97c12d99137" class="i property">WSManAPIHandle</a>,
                        <span class="r169 r">sessionTM</span>,
                        <span class="r170 r">errorStruct</span>,
                        <a href="BaseTransportManager.cs.html#33678df914ca9daf" class="t t">TransportMethodEnum</a>.<a href="BaseTransportManager.cs.html#2cc9ee1cdce7fca6" class="i field">CloseShellOperationEx</a>,
                        <span class="i">RemotingErrorIdStrings</span>.<span class="i">CloseExCallBackError</span>,
                        <b>new</b> <b>object</b>[] { <a href="#b4291df75d9bc408" class="t t">WSManTransportManagerUtils</a>.<a href="#95feb8ba0fde2a13" class="i method">ParseEscapeWSManErrorMessage</a>(<span class="r170 r">errorStruct</span>.<a href="WSManNativeAPI.cs.html#5497bacefa3538a3" class="i field">errorDetail</a>) });
                    <span class="r169 r">sessionTM</span>.<a href="#90dc9d72316cd2ed" class="i method">RaiseErrorHandler</a>(<span class="r171 r">eventargs</span>);
 
                    <b>return</b>;
                }
            }
 
            <span class="r169 r">sessionTM</span>.<a href="BaseTransportManager.cs.html#ce72d08b48a8f70f" class="i method">RaiseCloseCompleted</a>();
        }
 
        <b>private static void</b> <a id="3fcf7707c14346d8" href="../../../R/3fcf7707c14346d8.html" target="n" data-glyph="76,1" class="i method">OnRemoteSessionDisconnectCompleted</a>(<span class="i">IntPtr</span> <span id="r172 rd" class="r172 r">operationContext</span>,
            <b>int</b> <span id="r173 rd" class="r173 r">flags</span>,
            <span class="i">IntPtr</span> <span id="r174 rd" class="r174 r">error</span>,
            <span class="i">IntPtr</span> <span id="r175 rd" class="r175 r">shellOperationHandle</span>,
            <span class="i">IntPtr</span> <span id="r176 rd" class="r176 r">commandOperationHandle</span>,
            <span class="i">IntPtr</span> <span id="r177 rd" class="r177 r">operationHandle</span>,
            <span class="i">IntPtr</span> <span id="r178 rd" class="r178 r">data</span>)
        {
            <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<a href="../../../utils/StructuredTraceSource.cs.html#96aaf3813a5962a0" class="i method">WriteLine</a>(<span class="s">&quot;Client Session TM: CreateShell callback received&quot;</span>);
 
            <b>long</b> <span id="r179 rd" class="r179 r">sessionTMHandle</span> = 0;
            <a href="#693b43214373ab1e" class="t t">WSManClientSessionTransportManager</a> <span id="r180 rd" class="r180 r">sessionTM</span> = <b>null</b>;
            <b>if</b> (!<a href="#2a75e4ba1391788d" class="i method">TryGetSessionTransportManager</a>(<span class="r172 r">operationContext</span>, <b>out</b> <span class="r180 r">sessionTM</span>, <b>out</b> <span class="r179 r">sessionTMHandle</span>))
            {
                <span class="c">// We dont have the session TM handle..just return.</span>
                <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<a href="../../../utils/StructuredTraceSource.cs.html#25fe29b46cfb1e10" class="i method">WriteLine</a>(<span class="s">&quot;Unable to find a transport manager for context {0}.&quot;</span>, <span class="r179 r">sessionTMHandle</span>);
                <b>return</b>;
            }
 
            <span class="c">// LOG ETW EVENTS</span>
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(
                <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#eede3d08d2e133db" class="i field">WSManCloseShellCallbackReceived</a>,
                <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#f3d85cb80e62fe3e" class="i field">Disconnect</a>,
                <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#c5d4a73b62c859ab" class="i field">Transport</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                <span class="r180 r">sessionTM</span>.<a href="BaseTransportManager.cs.html#6b69cd5f8cc06fb7" class="i property">RunspacePoolInstanceId</a>.<span class="i">ToString</span>(),
                <span class="s">&quot;OnRemoteSessionDisconnectCompleted&quot;</span>);
 
            <span class="c">// Dispose the OnDisconnect callback as it is not needed anymore</span>
            <b>if</b> (<span class="r180 r">sessionTM</span>.<a href="#1fef853d09949cce" class="i field">_disconnectSessionCompleted</a> != <b>null</b>)
            {
                <span class="r180 r">sessionTM</span>.<a href="#1fef853d09949cce" class="i field">_disconnectSessionCompleted</a>.<a href="WSManNativeAPI.cs.html#c68800d727cb6a45" class="i method">Dispose</a>();
                <span class="r180 r">sessionTM</span>.<a href="#1fef853d09949cce" class="i field">_disconnectSessionCompleted</a> = <b>null</b>;
            }
 
            <b>if</b> (<span class="r174 r">error</span> != <span class="i">IntPtr</span>.<span class="i">Zero</span>)
            {
                <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#587a4e1f26edb30b" class="t t">WSManError</a> <span id="r181 rd" class="r181 r">errorStruct</span> = <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#587a4e1f26edb30b" class="t t">WSManError</a>.<a href="WSManNativeAPI.cs.html#0577f3d9734092d0" class="i method">UnMarshal</a>(<span class="r174 r">error</span>);
 
                <b>if</b> (<span class="r181 r">errorStruct</span>.<a href="WSManNativeAPI.cs.html#3bfbb0e97567321f" class="i field">errorCode</a> != 0)
                {
                    <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<span class="i">WriteLine</span>(<span class="s">&quot;Got error with error code {0}. Message {1}&quot;</span>, <span class="r181 r">errorStruct</span>.<a href="WSManNativeAPI.cs.html#3bfbb0e97567321f" class="i field">errorCode</a>.<span class="i">ToString</span>(), <span class="r181 r">errorStruct</span>.<a href="WSManNativeAPI.cs.html#5497bacefa3538a3" class="i field">errorDetail</a>);
 
                    <a href="BaseTransportManager.cs.html#7e70b34f9332dfcd" class="t t">TransportErrorOccuredEventArgs</a> <span id="r182 rd" class="r182 r">eventargs</span> = <a href="#b4291df75d9bc408" class="t t">WSManTransportManagerUtils</a>.<span class="i">ConstructTransportErrorEventArgs</span>(
                        <span class="r180 r">sessionTM</span>.<a href="#7616e1c5a9b266f9" class="i property">WSManAPIData</a>.<a href="#f386d97c12d99137" class="i property">WSManAPIHandle</a>,
                        <span class="r180 r">sessionTM</span>,
                        <span class="r181 r">errorStruct</span>,
                        <a href="BaseTransportManager.cs.html#33678df914ca9daf" class="t t">TransportMethodEnum</a>.<a href="BaseTransportManager.cs.html#e160f65b31655451" class="i field">DisconnectShellEx</a>,
                        <span class="i">RemotingErrorIdStrings</span>.<span class="i">DisconnectShellExFailed</span>,
                        <b>new</b> <b>object</b>[] { <span class="r180 r">sessionTM</span>.<a href="#c09ce13debcbb880" class="i property">ConnectionInfo</a>.<a href="../common/RunspaceConnectionInfo.cs.html#74b71e9668d24a47" class="i property">ComputerName</a>, <a href="#b4291df75d9bc408" class="t t">WSManTransportManagerUtils</a>.<a href="#95feb8ba0fde2a13" class="i method">ParseEscapeWSManErrorMessage</a>(<span class="r181 r">errorStruct</span>.<a href="WSManNativeAPI.cs.html#5497bacefa3538a3" class="i field">errorDetail</a>) });
                    <span class="r180 r">sessionTM</span>.<a href="#938e18940d5e6747" class="i method">ProcessWSManTransportError</a>(<span class="r182 r">eventargs</span>);
 
                    <b>return</b>;
                }
            }
 
            <b>lock</b> (<span class="r180 r">sessionTM</span>.<a href="BaseTransportManager.cs.html#2b6037d6b3777ca1" class="i field">syncObject</a>)
            {
                <span class="c">// make sure the transport is not closed yet.</span>
                <b>if</b> (<span class="r180 r">sessionTM</span>.<a href="BaseTransportManager.cs.html#76271338de46dcf0" class="i field">isClosed</a>)
                {
                    <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<a href="../../../utils/StructuredTraceSource.cs.html#96aaf3813a5962a0" class="i method">WriteLine</a>(<span class="s">&quot;Client Session TM: Transport manager is closed. So returning&quot;</span>);
                    <b>return</b>;
                }
 
                <span class="c">// successfully made a connection. Now report this by raising the ConnectCompleted event.</span>
                <span class="r180 r">sessionTM</span>.<a href="BaseTransportManager.cs.html#a152fe644f7ae9c1" class="i method">EnqueueAndStartProcessingThread</a>(<b>null</b>, <b>null</b>,
                    <b>new</b> <a href="#7a3b840fd435be57" class="t constructor">CompletionEventArgs</a>(<a href="#ed02d4fc471b4338" class="t t">CompletionNotification</a>.<a href="#6d885bea5bdd70f8" class="i field">DisconnectCompleted</a>));
 
                <span class="c">// Log ETW traces                </span>
                <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(
                    <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#eede3d08d2e133db" class="i field">WSManCloseShellCallbackReceived</a>,
                    <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#f3d85cb80e62fe3e" class="i field">Disconnect</a>,
                    <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                    <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#c5d4a73b62c859ab" class="i field">Transport</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                    <span class="r180 r">sessionTM</span>.<a href="BaseTransportManager.cs.html#6b69cd5f8cc06fb7" class="i property">RunspacePoolInstanceId</a>.<span class="i">ToString</span>(),
                    <span class="s">&quot;OnRemoteSessionReconnectCompleted: DisconnectCompleted&quot;</span>);
            }
 
            <b>return</b>;
        }
 
        <b>private static void</b> <a id="c8506084008d58dd" href="../../../R/c8506084008d58dd.html" target="n" data-glyph="76,1" class="i method">OnRemoteSessionReconnectCompleted</a>(<span class="i">IntPtr</span> <span id="r183 rd" class="r183 r">operationContext</span>,
            <b>int</b> <span id="r184 rd" class="r184 r">flags</span>,
            <span class="i">IntPtr</span> <span id="r185 rd" class="r185 r">error</span>,
            <span class="i">IntPtr</span> <span id="r186 rd" class="r186 r">shellOperationHandle</span>,
            <span class="i">IntPtr</span> <span id="r187 rd" class="r187 r">commandOperationHandle</span>,
            <span class="i">IntPtr</span> <span id="r188 rd" class="r188 r">operationHandle</span>,
            <span class="i">IntPtr</span> <span id="r189 rd" class="r189 r">data</span>)
        {
            <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<a href="../../../utils/StructuredTraceSource.cs.html#96aaf3813a5962a0" class="i method">WriteLine</a>(<span class="s">&quot;Client Session TM: CreateShell callback received&quot;</span>);
 
            <b>long</b> <span id="r190 rd" class="r190 r">sessionTMHandle</span> = 0;
            <a href="#693b43214373ab1e" class="t t">WSManClientSessionTransportManager</a> <span id="r191 rd" class="r191 r">sessionTM</span> = <b>null</b>;
            <b>if</b> (!<a href="#2a75e4ba1391788d" class="i method">TryGetSessionTransportManager</a>(<span class="r183 r">operationContext</span>, <b>out</b> <span class="r191 r">sessionTM</span>, <b>out</b> <span class="r190 r">sessionTMHandle</span>))
            {
                <span class="c">// We dont have the session TM handle..just return.</span>
                <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<a href="../../../utils/StructuredTraceSource.cs.html#25fe29b46cfb1e10" class="i method">WriteLine</a>(<span class="s">&quot;Unable to find a transport manager for context {0}.&quot;</span>, <span class="r190 r">sessionTMHandle</span>);
                <b>return</b>;
            }
 
            <span class="c">// Add ETW events</span>
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(
                <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#eede3d08d2e133db" class="i field">WSManCloseShellCallbackReceived</a>,
                <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#f3d85cb80e62fe3e" class="i field">Disconnect</a>,
                <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#c5d4a73b62c859ab" class="i field">Transport</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                <span class="r191 r">sessionTM</span>.<a href="BaseTransportManager.cs.html#6b69cd5f8cc06fb7" class="i property">RunspacePoolInstanceId</a>.<span class="i">ToString</span>(),
                <span class="s">&quot;OnRemoteSessionReconnectCompleted&quot;</span>);
 
            <span class="c">// Dispose the OnCreate callback as it is not needed anymore</span>
            <b>if</b> (<span class="r191 r">sessionTM</span>.<a href="#3a47dcb9064d8157" class="i field">_reconnectSessionCompleted</a> != <b>null</b>)
            {
                <span class="r191 r">sessionTM</span>.<a href="#3a47dcb9064d8157" class="i field">_reconnectSessionCompleted</a>.<a href="WSManNativeAPI.cs.html#c68800d727cb6a45" class="i method">Dispose</a>();
                <span class="r191 r">sessionTM</span>.<a href="#3a47dcb9064d8157" class="i field">_reconnectSessionCompleted</a> = <b>null</b>;
            }
 
            <b>if</b> (<span class="r185 r">error</span> != <span class="i">IntPtr</span>.<span class="i">Zero</span>)
            {
                <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#587a4e1f26edb30b" class="t t">WSManError</a> <span id="r192 rd" class="r192 r">errorStruct</span> = <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#587a4e1f26edb30b" class="t t">WSManError</a>.<a href="WSManNativeAPI.cs.html#0577f3d9734092d0" class="i method">UnMarshal</a>(<span class="r185 r">error</span>);
 
                <b>if</b> (<span class="r192 r">errorStruct</span>.<a href="WSManNativeAPI.cs.html#3bfbb0e97567321f" class="i field">errorCode</a> != 0)
                {
                    <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<span class="i">WriteLine</span>(<span class="s">&quot;Got error with error code {0}. Message {1}&quot;</span>, <span class="r192 r">errorStruct</span>.<a href="WSManNativeAPI.cs.html#3bfbb0e97567321f" class="i field">errorCode</a>.<span class="i">ToString</span>(), <span class="r192 r">errorStruct</span>.<a href="WSManNativeAPI.cs.html#5497bacefa3538a3" class="i field">errorDetail</a>);
 
                    <a href="BaseTransportManager.cs.html#7e70b34f9332dfcd" class="t t">TransportErrorOccuredEventArgs</a> <span id="r193 rd" class="r193 r">eventargs</span> = <a href="#b4291df75d9bc408" class="t t">WSManTransportManagerUtils</a>.<span class="i">ConstructTransportErrorEventArgs</span>(
                        <span class="r191 r">sessionTM</span>.<a href="#7616e1c5a9b266f9" class="i property">WSManAPIData</a>.<a href="#f386d97c12d99137" class="i property">WSManAPIHandle</a>,
                        <span class="r191 r">sessionTM</span>,
                        <span class="r192 r">errorStruct</span>,
                        <a href="BaseTransportManager.cs.html#33678df914ca9daf" class="t t">TransportMethodEnum</a>.<a href="BaseTransportManager.cs.html#f540cc47457e7954" class="i field">ReconnectShellEx</a>,
                        <span class="i">RemotingErrorIdStrings</span>.<span class="i">ReconnectShellExCallBackErrr</span>,
                        <b>new</b> <b>object</b>[] { <span class="r191 r">sessionTM</span>.<a href="#c09ce13debcbb880" class="i property">ConnectionInfo</a>.<a href="../common/RunspaceConnectionInfo.cs.html#74b71e9668d24a47" class="i property">ComputerName</a>, <a href="#b4291df75d9bc408" class="t t">WSManTransportManagerUtils</a>.<a href="#95feb8ba0fde2a13" class="i method">ParseEscapeWSManErrorMessage</a>(<span class="r192 r">errorStruct</span>.<a href="WSManNativeAPI.cs.html#5497bacefa3538a3" class="i field">errorDetail</a>) });
                    <span class="r191 r">sessionTM</span>.<a href="#938e18940d5e6747" class="i method">ProcessWSManTransportError</a>(<span class="r193 r">eventargs</span>);
 
                    <b>return</b>;
                }
            }
 
            <b>lock</b> (<span class="r191 r">sessionTM</span>.<a href="BaseTransportManager.cs.html#2b6037d6b3777ca1" class="i field">syncObject</a>)
            {
                <span class="c">// make sure the transport is not closed yet.</span>
                <b>if</b> (<span class="r191 r">sessionTM</span>.<a href="BaseTransportManager.cs.html#76271338de46dcf0" class="i field">isClosed</a>)
                {
                    <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<a href="../../../utils/StructuredTraceSource.cs.html#96aaf3813a5962a0" class="i method">WriteLine</a>(<span class="s">&quot;Client Session TM: Transport manager is closed. So returning&quot;</span>);
                    <b>return</b>;
                }
 
                <span class="c">// successfully made a connection. Now report this by raising the ConnectCompleted event.</span>
                <span class="r191 r">sessionTM</span>.<a href="BaseTransportManager.cs.html#ce88eff5144dd47c" class="i method">RaiseReconnectCompleted</a>();
            }
        }
 
        <b>private static bool</b> <a id="f8630aede3718229" href="../../../R/f8630aede3718229.html" target="n" data-glyph="76,1" class="i method">HandleRobustConnectionCallback</a>(<b>int</b> <span id="r194 rd" class="r194 r">flags</span>, <a href="#693b43214373ab1e" class="t t">WSManClientSessionTransportManager</a> <span id="r195 rd" class="r195 r">sessionTM</span>)
        {
            <b>if</b> (<span class="r194 r">flags</span> != (<b>int</b>)<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#4b939349c4d4b263" class="t t">WSManCallbackFlags</a>.<a href="WSManNativeAPI.cs.html#b75dc830c3d4c2ad" class="i field">WSMAN_FLAG_CALLBACK_SHELL_AUTODISCONNECTED</a> &amp;&amp;
                <span class="r194 r">flags</span> != (<b>int</b>)<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#4b939349c4d4b263" class="t t">WSManCallbackFlags</a>.<a href="WSManNativeAPI.cs.html#f545963b836576f8" class="i field">WSMAN_FLAG_CALLBACK_NETWORK_FAILURE_DETECTED</a> &amp;&amp;
                <span class="r194 r">flags</span> != (<b>int</b>)<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#4b939349c4d4b263" class="t t">WSManCallbackFlags</a>.<a href="WSManNativeAPI.cs.html#f87517a9a496651d" class="i field">WSMAN_FLAG_CALLBACK_RETRYING_AFTER_NETWORK_FAILURE</a> &amp;&amp;
                <span class="r194 r">flags</span> != (<b>int</b>)<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#4b939349c4d4b263" class="t t">WSManCallbackFlags</a>.<a href="WSManNativeAPI.cs.html#61e65b7c046ca200" class="i field">WSMAN_FLAG_CALLBACK_RECONNECTED_AFTER_NETWORK_FAILURE</a> &amp;&amp;
                <span class="r194 r">flags</span> != (<b>int</b>)<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#4b939349c4d4b263" class="t t">WSManCallbackFlags</a>.<a href="WSManNativeAPI.cs.html#23623b9d1c8a6329" class="i field">WSMAN_FLAG_CALLBACK_SHELL_AUTODISCONNECTING</a> &amp;&amp;
                <span class="r194 r">flags</span> != (<b>int</b>)<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#4b939349c4d4b263" class="t t">WSManCallbackFlags</a>.<a href="WSManNativeAPI.cs.html#7f4749e6e54e936d" class="i field">WSMAN_FLAG_CALLBACK_RETRY_ABORTED_DUE_TO_INTERNAL_ERROR</a>)
            {
                <b>return</b> <b>false</b>;
            }
 
            <span class="c">// Raise transport event notifying start of robust connections.</span>
            <b>if</b> (<span class="r194 r">flags</span> == (<b>int</b>)<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#4b939349c4d4b263" class="t t">WSManCallbackFlags</a>.<a href="WSManNativeAPI.cs.html#f545963b836576f8" class="i field">WSMAN_FLAG_CALLBACK_NETWORK_FAILURE_DETECTED</a>)
            {
                <b>try</b>
                {
                    <span class="r195 r">sessionTM</span>.<a href="#8a72740c6e80c668" class="i">RobustConnectionsInitiated</a>.<span class="i">SafeInvoke</span>(<span class="r195 r">sessionTM</span>, <span class="i">EventArgs</span>.<span class="i">Empty</span>);
                }
                <b>catch</b> (<span class="i">ObjectDisposedException</span>)
                { }
            }
 
            <span class="c">// Send robust notification to client.</span>
            <span class="r195 r">sessionTM</span>.<a href="BaseTransportManager.cs.html#6bfce6081289c88c" class="i method">QueueRobustConnectionNotification</a>(<span class="r194 r">flags</span>);
 
            <span class="c">// Raise transport event notifying completion of robust connections.</span>
            <b>if</b> (<span class="r194 r">flags</span> == (<b>int</b>)<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#4b939349c4d4b263" class="t t">WSManCallbackFlags</a>.<a href="WSManNativeAPI.cs.html#b75dc830c3d4c2ad" class="i field">WSMAN_FLAG_CALLBACK_SHELL_AUTODISCONNECTED</a> ||
                <span class="r194 r">flags</span> == (<b>int</b>)<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#4b939349c4d4b263" class="t t">WSManCallbackFlags</a>.<a href="WSManNativeAPI.cs.html#61e65b7c046ca200" class="i field">WSMAN_FLAG_CALLBACK_RECONNECTED_AFTER_NETWORK_FAILURE</a> ||
                <span class="r194 r">flags</span> == (<b>int</b>)<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#4b939349c4d4b263" class="t t">WSManCallbackFlags</a>.<a href="WSManNativeAPI.cs.html#7f4749e6e54e936d" class="i field">WSMAN_FLAG_CALLBACK_RETRY_ABORTED_DUE_TO_INTERNAL_ERROR</a>)
            {
                <b>try</b>
                {
                    <span class="r195 r">sessionTM</span>.<a href="#2ab967894e7c3b07" class="i">RobustConnectionsCompleted</a>.<span class="i">SafeInvoke</span>(<span class="r195 r">sessionTM</span>, <span class="i">EventArgs</span>.<span class="i">Empty</span>);
                }
                <b>catch</b> (<span class="i">ObjectDisposedException</span>)
                { }
            }
 
            <b>return</b> <b>true</b>;
        }
 
        <b>private static void</b> <a id="530fa3f688c6fac5" href="../../../R/530fa3f688c6fac5.html" target="n" data-glyph="76,1" class="i method">OnRemoteSessionConnectCallback</a>(<span class="i">IntPtr</span> <span id="r196 rd" class="r196 r">operationContext</span>,
            <b>int</b> <span id="r197 rd" class="r197 r">flags</span>,
            <span class="i">IntPtr</span> <span id="r198 rd" class="r198 r">error</span>,
            <span class="i">IntPtr</span> <span id="r199 rd" class="r199 r">shellOperationHandle</span>,
            <span class="i">IntPtr</span> <span id="r200 rd" class="r200 r">commandOperationHandle</span>,
            <span class="i">IntPtr</span> <span id="r201 rd" class="r201 r">operationHandle</span>,
            <span class="i">IntPtr</span> <span id="r202 rd" class="r202 r">data</span>)
        {
            <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<a href="../../../utils/StructuredTraceSource.cs.html#96aaf3813a5962a0" class="i method">WriteLine</a>(<span class="s">&quot;Client Session TM: Connect callback received&quot;</span>);
 
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<a href="../../../utils/tracing/PSEtwLog.cs.html#bd7ee9e01b1b8117" class="i method">LogAnalyticInformational</a>(
                <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#24e0ce157c99ef06" class="i field">WSManSendShellInputExCallbackReceived</a>,
                <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#a0f7cf0d4987790f" class="i field">Connect</a>,
                <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#c5d4a73b62c859ab" class="i field">Transport</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                <span class="s">&quot;OnRemoteSessionConnectCallback:Client Session TM: Connect callback received&quot;</span>);
 
            <b>long</b> <span id="r203 rd" class="r203 r">sessionTMHandle</span> = 0;
            <a href="#693b43214373ab1e" class="t t">WSManClientSessionTransportManager</a> <span id="r204 rd" class="r204 r">sessionTM</span> = <b>null</b>;
            <b>if</b> (!<a href="#2a75e4ba1391788d" class="i method">TryGetSessionTransportManager</a>(<span class="r196 r">operationContext</span>, <b>out</b> <span class="r204 r">sessionTM</span>, <b>out</b> <span class="r203 r">sessionTMHandle</span>))
            {
                <span class="c">// We dont have the session TM handle..just return.</span>
                <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<a href="../../../utils/StructuredTraceSource.cs.html#25fe29b46cfb1e10" class="i method">WriteLine</a>(<span class="s">&quot;Unable to find a transport manager for context {0}.&quot;</span>, <span class="r203 r">sessionTMHandle</span>);
                <b>return</b>;
            }
 
            <span class="c">// This callback is also used for robust connection notifications.  Check for and</span>
            <span class="c">// handle these notifications here.</span>
            <b>if</b> (<a href="#f8630aede3718229" class="i method">HandleRobustConnectionCallback</a>(<span class="r197 r">flags</span>, <span class="r204 r">sessionTM</span>))
            {
                <b>return</b>;
            }
 
            <b>if</b> (<span class="r198 r">error</span> != <span class="i">IntPtr</span>.<span class="i">Zero</span>)
            {
                <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#587a4e1f26edb30b" class="t t">WSManError</a> <span id="r205 rd" class="r205 r">errorStruct</span> = <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#587a4e1f26edb30b" class="t t">WSManError</a>.<a href="WSManNativeAPI.cs.html#0577f3d9734092d0" class="i method">UnMarshal</a>(<span class="r198 r">error</span>);
 
                <b>if</b> (<span class="r205 r">errorStruct</span>.<a href="WSManNativeAPI.cs.html#3bfbb0e97567321f" class="i field">errorCode</a> != 0)
                {
                    <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<span class="i">WriteLine</span>(<span class="s">&quot;Got error with error code {0}. Message {1}&quot;</span>, <span class="r205 r">errorStruct</span>.<a href="WSManNativeAPI.cs.html#3bfbb0e97567321f" class="i field">errorCode</a>.<span class="i">ToString</span>(), <span class="r205 r">errorStruct</span>.<a href="WSManNativeAPI.cs.html#5497bacefa3538a3" class="i field">errorDetail</a>);
 
                    <a href="BaseTransportManager.cs.html#7e70b34f9332dfcd" class="t t">TransportErrorOccuredEventArgs</a> <span id="r206 rd" class="r206 r">eventargs</span> = <a href="#b4291df75d9bc408" class="t t">WSManTransportManagerUtils</a>.<span class="i">ConstructTransportErrorEventArgs</span>(
                        <span class="r204 r">sessionTM</span>.<a href="#7616e1c5a9b266f9" class="i property">WSManAPIData</a>.<a href="#f386d97c12d99137" class="i property">WSManAPIHandle</a>,
                        <span class="r204 r">sessionTM</span>,
                        <span class="r205 r">errorStruct</span>,
                        <a href="BaseTransportManager.cs.html#33678df914ca9daf" class="t t">TransportMethodEnum</a>.<a href="BaseTransportManager.cs.html#cf9cf28252f73349" class="i field">ConnectShellEx</a>,
                        <span class="i">RemotingErrorIdStrings</span>.<span class="i">ConnectExCallBackError</span>,
                        <b>new</b> <b>object</b>[] { <span class="r204 r">sessionTM</span>.<a href="#c09ce13debcbb880" class="i property">ConnectionInfo</a>.<a href="../common/RunspaceConnectionInfo.cs.html#74b71e9668d24a47" class="i property">ComputerName</a>, <a href="#b4291df75d9bc408" class="t t">WSManTransportManagerUtils</a>.<a href="#95feb8ba0fde2a13" class="i method">ParseEscapeWSManErrorMessage</a>(<span class="r205 r">errorStruct</span>.<a href="WSManNativeAPI.cs.html#5497bacefa3538a3" class="i field">errorDetail</a>) });
                    <span class="r204 r">sessionTM</span>.<a href="#938e18940d5e6747" class="i method">ProcessWSManTransportError</a>(<span class="r206 r">eventargs</span>);
 
                    <b>return</b>;
                }
            }
 
            <span class="c">// dispose openContent</span>
            <b>if</b> (<span class="r204 r">sessionTM</span>.<a href="#b636a4d17100c22a" class="i field">_openContent</a> != <b>null</b>)
            {
                <span class="r204 r">sessionTM</span>.<a href="#b636a4d17100c22a" class="i field">_openContent</a>.<a href="WSManNativeAPI.cs.html#a723a8d748579007" class="i method">Dispose</a>();
                <span class="r204 r">sessionTM</span>.<a href="#b636a4d17100c22a" class="i field">_openContent</a> = <b>null</b>;
            }
 
            <b>lock</b> (<span class="r204 r">sessionTM</span>.<a href="BaseTransportManager.cs.html#2b6037d6b3777ca1" class="i field">syncObject</a>)
            {
                <span class="c">// make sure the transport is not closed yet.</span>
                <b>if</b> (<span class="r204 r">sessionTM</span>.<a href="BaseTransportManager.cs.html#76271338de46dcf0" class="i field">isClosed</a>)
                {
                    <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<a href="../../../utils/StructuredTraceSource.cs.html#96aaf3813a5962a0" class="i method">WriteLine</a>(<span class="s">&quot;Client Session TM: Transport manager is closed. So returning&quot;</span>);
                    <b>return</b>;
                }
            }
 
            <span class="c">// process returned Xml</span>
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r202 r">data</span> != <span class="i">IntPtr</span>.<span class="i">Zero</span>, <span class="s">&quot;WSManConnectShell callback returned null data&quot;</span>);
            <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#c0a7213e3beffad1" class="t t">WSManConnectDataResult</a> <span id="r207 rd" class="r207 r">connectData</span> = <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#c0a7213e3beffad1" class="t t">WSManConnectDataResult</a>.<a href="WSManNativeAPI.cs.html#2cdf5280502c1cfc" class="i method">UnMarshal</a>(<span class="r202 r">data</span>);
            <b>if</b> (<span class="r207 r">connectData</span>.<a href="WSManNativeAPI.cs.html#14ae052e7a3f769e" class="i field">data</a> != <b>null</b>)
            {
                <b>byte</b>[] <span id="r208 rd" class="r208 r">connectResponse</span> = <a href="BaseTransportManager.cs.html#e8f1ac90f941837f" class="t t">ServerOperationHelpers</a>.<a href="BaseTransportManager.cs.html#4cf9fbefd6b59fe6" class="i method">ExtractEncodedXmlElement</a>(<span class="r207 r">connectData</span>.<a href="WSManNativeAPI.cs.html#14ae052e7a3f769e" class="i field">data</a>, <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#bd71f1416f30f9a8" class="i field">PS_CONNECTRESPONSE_XML_TAG</a>);
                <span class="r204 r">sessionTM</span>.<a href="BaseTransportManager.cs.html#9b54d0029bdba5c6" class="i method">ProcessRawData</a>(<span class="r208 r">connectResponse</span>, <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#ab2f3becc1476649" class="i field">WSMAN_STREAM_ID_STDOUT</a>);
            }
 
            <span class="c">// Set up the data-to-send callback.</span>
            <span class="r204 r">sessionTM</span>.<a href="#e227f54c5577105e" class="i method">SendOneItem</a>();
 
            <span class="c">// successfully made a connection. Now report this by raising the ConnectCompleted event.</span>
            <span class="c">// Microsoft&#39;s PS 3.0 Server will return all negotiation related data in one shot in connect Data</span>
            <span class="c">// Note that we are not starting to receive data yet. the DSHandlers above will do that when the session</span>
            <span class="c">// gets to an established state.</span>
            <span class="r204 r">sessionTM</span>.<a href="BaseTransportManager.cs.html#ff51517e144ee45f" class="i method">RaiseConnectCompleted</a>();
        }
 
        <b>private static void</b> <a id="d18606befb8232b8" href="../../../R/d18606befb8232b8.html" target="n" data-glyph="76,1" class="i method">OnRemoteSessionSendCompleted</a>(<span class="i">IntPtr</span> <span id="r209 rd" class="r209 r">operationContext</span>,
            <b>int</b> <span id="r210 rd" class="r210 r">flags</span>,
            <span class="i">IntPtr</span> <span id="r211 rd" class="r211 r">error</span>,
            <span class="i">IntPtr</span> <span id="r212 rd" class="r212 r">shellOperationHandle</span>,
            <span class="i">IntPtr</span> <span id="r213 rd" class="r213 r">commandOperationHandle</span>,
            <span class="i">IntPtr</span> <span id="r214 rd" class="r214 r">operationHandle</span>,
            <span class="i">IntPtr</span> <span id="r215 rd" class="r215 r">data</span>)
        {
            <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<a href="../../../utils/StructuredTraceSource.cs.html#96aaf3813a5962a0" class="i method">WriteLine</a>(<span class="s">&quot;Client Session TM: SendComplete callback received&quot;</span>);
 
            <b>long</b> <span id="r216 rd" class="r216 r">sessionTMHandle</span> = 0;
            <a href="#693b43214373ab1e" class="t t">WSManClientSessionTransportManager</a> <span id="r217 rd" class="r217 r">sessionTM</span> = <b>null</b>;
            <b>if</b> (!<a href="#2a75e4ba1391788d" class="i method">TryGetSessionTransportManager</a>(<span class="r209 r">operationContext</span>, <b>out</b> <span class="r217 r">sessionTM</span>, <b>out</b> <span class="r216 r">sessionTMHandle</span>))
            {
                <span class="c">// We dont have the session TM handle..just return.</span>
                <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<a href="../../../utils/StructuredTraceSource.cs.html#25fe29b46cfb1e10" class="i method">WriteLine</a>(<span class="s">&quot;Unable to find a transport manager for context {0}.&quot;</span>, <span class="r216 r">sessionTMHandle</span>);
                <b>return</b>;
            }
 
            <span class="c">// do the logging for this send</span>
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(
                <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#24e0ce157c99ef06" class="i field">WSManSendShellInputExCallbackReceived</a>,
                <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#a0f7cf0d4987790f" class="i field">Connect</a>,
                <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#c5d4a73b62c859ab" class="i field">Transport</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                <span class="r217 r">sessionTM</span>.<a href="BaseTransportManager.cs.html#6b69cd5f8cc06fb7" class="i property">RunspacePoolInstanceId</a>.<span class="i">ToString</span>(),
                <span class="i">Guid</span>.<span class="i">Empty</span>.<span class="i">ToString</span>());
 
            <b>if</b> (!<span class="r212 r">shellOperationHandle</span>.<span class="i">Equals</span>(<span class="r217 r">sessionTM</span>.<a href="#5120ad7297341362" class="i field">_wsManShellOperationHandle</a>))
            {
                <span class="c">// WSMan returned data from a wrong shell..notify the caller</span>
                <span class="c">// about the same.</span>
                <a href="../common/remotingexceptions.cs.html#0bb8687f97d91059" class="t t">PSRemotingTransportException</a> <span id="r218 rd" class="r218 r">e</span> = <b>new</b> <a href="../common/remotingexceptions.cs.html#3d42c01e0f93455e" class="t constructor">PSRemotingTransportException</a>(
                    <a href="../common/remotingexceptions.cs.html#53047fc052e9b445" class="t t">PSRemotingErrorInvariants</a>.<span class="i">FormatResourceString</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">SendExFailed</span>, <span class="r217 r">sessionTM</span>.<a href="#c09ce13debcbb880" class="i property">ConnectionInfo</a>.<a href="../common/RunspaceConnectionInfo.cs.html#74b71e9668d24a47" class="i property">ComputerName</a>));
                <a href="BaseTransportManager.cs.html#7e70b34f9332dfcd" class="t t">TransportErrorOccuredEventArgs</a> <span id="r219 rd" class="r219 r">eventargs</span> =
                    <b>new</b> <a href="BaseTransportManager.cs.html#c420864940871a42" class="t constructor">TransportErrorOccuredEventArgs</a>(<span class="r218 r">e</span>, <a href="BaseTransportManager.cs.html#33678df914ca9daf" class="t t">TransportMethodEnum</a>.<a href="BaseTransportManager.cs.html#5ae525a3ca59a711" class="i field">SendShellInputEx</a>);
                <span class="r217 r">sessionTM</span>.<a href="#938e18940d5e6747" class="i method">ProcessWSManTransportError</a>(<span class="r219 r">eventargs</span>);
 
                <b>return</b>;
            }
 
            <span class="r217 r">sessionTM</span>.<a href="#6f8215a53ee62197" class="i method">ClearReceiveOrSendResources</a>(<span class="r210 r">flags</span>, <b>true</b>);
 
            <span class="c">// if the session is already closed ignore the errors and return.</span>
            <b>if</b> (<span class="r217 r">sessionTM</span>.<a href="BaseTransportManager.cs.html#76271338de46dcf0" class="i field">isClosed</a>)
            {
                <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<a href="../../../utils/StructuredTraceSource.cs.html#96aaf3813a5962a0" class="i method">WriteLine</a>(<span class="s">&quot;Client Session TM: Transport manager is closed. So returning&quot;</span>);
                <b>return</b>;
            }
 
            <b>if</b> (<span class="r211 r">error</span> != <span class="i">IntPtr</span>.<span class="i">Zero</span>)
            {
                <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#587a4e1f26edb30b" class="t t">WSManError</a> <span id="r220 rd" class="r220 r">errorStruct</span> = <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#587a4e1f26edb30b" class="t t">WSManError</a>.<a href="WSManNativeAPI.cs.html#0577f3d9734092d0" class="i method">UnMarshal</a>(<span class="r211 r">error</span>);
 
                <span class="c">// Ignore operation aborted error. operation aborted is raised by WSMan to</span>
                <span class="c">// notify operation complete. PowerShell protocol has its own</span>
                <span class="c">// way of notifying the same using state change events.</span>
                <b>if</b> ((<span class="r220 r">errorStruct</span>.<a href="WSManNativeAPI.cs.html#3bfbb0e97567321f" class="i field">errorCode</a> != 0) &amp;&amp; (<span class="r220 r">errorStruct</span>.<a href="WSManNativeAPI.cs.html#3bfbb0e97567321f" class="i field">errorCode</a> != 995))
                {
                    <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<span class="i">WriteLine</span>(<span class="s">&quot;Got error with error code {0}. Message {1}&quot;</span>, <span class="r220 r">errorStruct</span>.<a href="WSManNativeAPI.cs.html#3bfbb0e97567321f" class="i field">errorCode</a>.<span class="i">ToString</span>(), <span class="r220 r">errorStruct</span>.<a href="WSManNativeAPI.cs.html#5497bacefa3538a3" class="i field">errorDetail</a>);
 
                    <a href="BaseTransportManager.cs.html#7e70b34f9332dfcd" class="t t">TransportErrorOccuredEventArgs</a> <span id="r221 rd" class="r221 r">eventargs</span> = <a href="#b4291df75d9bc408" class="t t">WSManTransportManagerUtils</a>.<span class="i">ConstructTransportErrorEventArgs</span>(
                        <span class="r217 r">sessionTM</span>.<a href="#7616e1c5a9b266f9" class="i property">WSManAPIData</a>.<a href="#f386d97c12d99137" class="i property">WSManAPIHandle</a>,
                        <span class="r217 r">sessionTM</span>,
                        <span class="r220 r">errorStruct</span>,
                        <a href="BaseTransportManager.cs.html#33678df914ca9daf" class="t t">TransportMethodEnum</a>.<a href="BaseTransportManager.cs.html#5ae525a3ca59a711" class="i field">SendShellInputEx</a>,
                        <span class="i">RemotingErrorIdStrings</span>.<span class="i">SendExCallBackError</span>,
                        <b>new</b> <b>object</b>[] { <span class="r217 r">sessionTM</span>.<a href="#c09ce13debcbb880" class="i property">ConnectionInfo</a>.<a href="../common/RunspaceConnectionInfo.cs.html#74b71e9668d24a47" class="i property">ComputerName</a>, <a href="#b4291df75d9bc408" class="t t">WSManTransportManagerUtils</a>.<a href="#95feb8ba0fde2a13" class="i method">ParseEscapeWSManErrorMessage</a>(<span class="r220 r">errorStruct</span>.<a href="WSManNativeAPI.cs.html#5497bacefa3538a3" class="i field">errorDetail</a>) });
                    <span class="r217 r">sessionTM</span>.<a href="#938e18940d5e6747" class="i method">ProcessWSManTransportError</a>(<span class="r221 r">eventargs</span>);
 
                    <b>return</b>;
                }
            }
 
            <span class="c">// Send the next item, if available</span>
            <span class="r217 r">sessionTM</span>.<a href="#e227f54c5577105e" class="i method">SendOneItem</a>();
        }
 
        <span class="c">// WSMan will make sure this callback is synchronously called ie., if 1 callback</span>
        <span class="c">// is active, the callback will not be called from a different thread.</span>
        <b>private static void</b> <a id="d89ac756e5cdbf71" href="../../../R/d89ac756e5cdbf71.html" target="n" data-glyph="76,1" class="i method">OnRemoteSessionDataReceived</a>(<span class="i">IntPtr</span> <span id="r222 rd" class="r222 r">operationContext</span>,
            <b>int</b> <span id="r223 rd" class="r223 r">flags</span>,
            <span class="i">IntPtr</span> <span id="r224 rd" class="r224 r">error</span>,
            <span class="i">IntPtr</span> <span id="r225 rd" class="r225 r">shellOperationHandle</span>,
            <span class="i">IntPtr</span> <span id="r226 rd" class="r226 r">commandOperationHandle</span>,
            <span class="i">IntPtr</span> <span id="r227 rd" class="r227 r">operationHandle</span>,
            <span class="i">IntPtr</span> <span id="r228 rd" class="r228 r">data</span>)
        {
            <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<a href="../../../utils/StructuredTraceSource.cs.html#96aaf3813a5962a0" class="i method">WriteLine</a>(<span class="s">&quot;Client Session TM: OnRemoteDataReceived callback.&quot;</span>);
 
            <b>long</b> <span id="r229 rd" class="r229 r">sessionTMHandle</span> = 0;
            <a href="#693b43214373ab1e" class="t t">WSManClientSessionTransportManager</a> <span id="r230 rd" class="r230 r">sessionTM</span> = <b>null</b>;
            <b>if</b> (!<a href="#2a75e4ba1391788d" class="i method">TryGetSessionTransportManager</a>(<span class="r222 r">operationContext</span>, <b>out</b> <span class="r230 r">sessionTM</span>, <b>out</b> <span class="r229 r">sessionTMHandle</span>))
            {
                <span class="c">// We dont have the session TM handle..just return.</span>
                <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<a href="../../../utils/StructuredTraceSource.cs.html#25fe29b46cfb1e10" class="i method">WriteLine</a>(<span class="s">&quot;Unable to find a transport manager for context {0}.&quot;</span>, <span class="r229 r">sessionTMHandle</span>);
                <b>return</b>;
            }
 
            <span class="r230 r">sessionTM</span>.<a href="#6f8215a53ee62197" class="i method">ClearReceiveOrSendResources</a>(<span class="r223 r">flags</span>, <b>false</b>);
 
            <b>if</b> (<span class="r230 r">sessionTM</span>.<a href="BaseTransportManager.cs.html#76271338de46dcf0" class="i field">isClosed</a>)
            {
                <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<a href="../../../utils/StructuredTraceSource.cs.html#96aaf3813a5962a0" class="i method">WriteLine</a>(<span class="s">&quot;Client Session TM: Transport manager is closed. So returning&quot;</span>);
                <b>return</b>;
            }
 
            <b>if</b> (!<span class="r225 r">shellOperationHandle</span>.<span class="i">Equals</span>(<span class="r230 r">sessionTM</span>.<a href="#5120ad7297341362" class="i field">_wsManShellOperationHandle</a>))
            {
                <span class="c">// WSMan returned data from a wrong shell..notify the caller</span>
                <span class="c">// about the same.</span>
                <a href="../common/remotingexceptions.cs.html#0bb8687f97d91059" class="t t">PSRemotingTransportException</a> <span id="r231 rd" class="r231 r">e</span> = <b>new</b> <a href="../common/remotingexceptions.cs.html#3d42c01e0f93455e" class="t constructor">PSRemotingTransportException</a>(
                    <a href="../common/remotingexceptions.cs.html#53047fc052e9b445" class="t t">PSRemotingErrorInvariants</a>.<span class="i">FormatResourceString</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">ReceiveExFailed</span>, <span class="r230 r">sessionTM</span>.<a href="#c09ce13debcbb880" class="i property">ConnectionInfo</a>.<a href="../common/RunspaceConnectionInfo.cs.html#74b71e9668d24a47" class="i property">ComputerName</a>));
                <a href="BaseTransportManager.cs.html#7e70b34f9332dfcd" class="t t">TransportErrorOccuredEventArgs</a> <span id="r232 rd" class="r232 r">eventargs</span> =
                    <b>new</b> <a href="BaseTransportManager.cs.html#c420864940871a42" class="t constructor">TransportErrorOccuredEventArgs</a>(<span class="r231 r">e</span>, <a href="BaseTransportManager.cs.html#33678df914ca9daf" class="t t">TransportMethodEnum</a>.<a href="BaseTransportManager.cs.html#c91edb639e1ae62a" class="i field">ReceiveShellOutputEx</a>);
                <span class="r230 r">sessionTM</span>.<a href="#938e18940d5e6747" class="i method">ProcessWSManTransportError</a>(<span class="r232 r">eventargs</span>);
 
                <b>return</b>;
            }
 
            <b>if</b> (<span class="r224 r">error</span> != <span class="i">IntPtr</span>.<span class="i">Zero</span>)
            {
                <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#587a4e1f26edb30b" class="t t">WSManError</a> <span id="r233 rd" class="r233 r">errorStruct</span> = <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#587a4e1f26edb30b" class="t t">WSManError</a>.<a href="WSManNativeAPI.cs.html#0577f3d9734092d0" class="i method">UnMarshal</a>(<span class="r224 r">error</span>);
 
                <b>if</b> (<span class="r233 r">errorStruct</span>.<a href="WSManNativeAPI.cs.html#3bfbb0e97567321f" class="i field">errorCode</a> != 0)
                {
                    <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<span class="i">WriteLine</span>(<span class="s">&quot;Got error with error code {0}. Message {1}&quot;</span>, <span class="r233 r">errorStruct</span>.<a href="WSManNativeAPI.cs.html#3bfbb0e97567321f" class="i field">errorCode</a>.<span class="i">ToString</span>(), <span class="r233 r">errorStruct</span>.<a href="WSManNativeAPI.cs.html#5497bacefa3538a3" class="i field">errorDetail</a>);
 
                    <a href="BaseTransportManager.cs.html#7e70b34f9332dfcd" class="t t">TransportErrorOccuredEventArgs</a> <span id="r234 rd" class="r234 r">eventargs</span> = <a href="#b4291df75d9bc408" class="t t">WSManTransportManagerUtils</a>.<span class="i">ConstructTransportErrorEventArgs</span>(
                        <span class="r230 r">sessionTM</span>.<a href="#7616e1c5a9b266f9" class="i property">WSManAPIData</a>.<a href="#f386d97c12d99137" class="i property">WSManAPIHandle</a>,
                        <span class="r230 r">sessionTM</span>,
                        <span class="r233 r">errorStruct</span>,
                        <a href="BaseTransportManager.cs.html#33678df914ca9daf" class="t t">TransportMethodEnum</a>.<a href="BaseTransportManager.cs.html#c91edb639e1ae62a" class="i field">ReceiveShellOutputEx</a>,
                        <span class="i">RemotingErrorIdStrings</span>.<span class="i">ReceiveExCallBackError</span>,
                        <b>new</b> <b>object</b>[] { <span class="r230 r">sessionTM</span>.<a href="#c09ce13debcbb880" class="i property">ConnectionInfo</a>.<a href="../common/RunspaceConnectionInfo.cs.html#74b71e9668d24a47" class="i property">ComputerName</a>, <a href="#b4291df75d9bc408" class="t t">WSManTransportManagerUtils</a>.<a href="#95feb8ba0fde2a13" class="i method">ParseEscapeWSManErrorMessage</a>(<span class="r233 r">errorStruct</span>.<a href="WSManNativeAPI.cs.html#5497bacefa3538a3" class="i field">errorDetail</a>) });
                    <span class="r230 r">sessionTM</span>.<a href="#938e18940d5e6747" class="i method">ProcessWSManTransportError</a>(<span class="r234 r">eventargs</span>);
 
                    <b>return</b>;
                }
            }
 
            <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#42e20c3ae6d2041e" class="t t">WSManReceiveDataResult</a> <span id="r235 rd" class="r235 r">dataReceived</span> = <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#42e20c3ae6d2041e" class="t t">WSManReceiveDataResult</a>.<a href="WSManNativeAPI.cs.html#ff8bae8b21e53a27" class="i method">UnMarshal</a>(<span class="r228 r">data</span>);
            <b>if</b> (<span class="r235 r">dataReceived</span>.<a href="WSManNativeAPI.cs.html#46da8fe2d7e03572" class="i field">data</a> != <b>null</b>)
            {
                <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<span class="i">WriteLine</span>(<span class="s">&quot;Session Received Data : {0}&quot;</span>, <span class="r235 r">dataReceived</span>.<a href="WSManNativeAPI.cs.html#46da8fe2d7e03572" class="i field">data</a>.<span class="i">Length</span>);
                <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(
                    <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#1950f93b9ed312a7" class="i field">WSManReceiveShellOutputExCallbackReceived</a>, <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#75e7cd53604b1352" class="i field">Receive</a>, <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                    <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#c5d4a73b62c859ab" class="i field">Transport</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                    <span class="r230 r">sessionTM</span>.<a href="BaseTransportManager.cs.html#6b69cd5f8cc06fb7" class="i property">RunspacePoolInstanceId</a>.<span class="i">ToString</span>(),
                    <span class="i">Guid</span>.<span class="i">Empty</span>.<span class="i">ToString</span>(),
                    <span class="r235 r">dataReceived</span>.<a href="WSManNativeAPI.cs.html#46da8fe2d7e03572" class="i field">data</a>.<span class="i">Length</span>.<span class="i">ToString</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>));
                <span class="r230 r">sessionTM</span>.<a href="BaseTransportManager.cs.html#9b54d0029bdba5c6" class="i method">ProcessRawData</a>(<span class="r235 r">dataReceived</span>.<a href="WSManNativeAPI.cs.html#46da8fe2d7e03572" class="i field">data</a>, <span class="r235 r">dataReceived</span>.<a href="WSManNativeAPI.cs.html#e270270622375fa7" class="i field">stream</a>);
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Send Data Handling
 
        <b>private void</b> <a id="e227f54c5577105e" href="../../../R/e227f54c5577105e.html" target="n" data-glyph="76,1" class="i method">SendOneItem</a>()
        {
            <a href="PriorityCollection.cs.html#f0975201467fdc06" class="t t">DataPriorityType</a> <span id="r236 rd" class="r236 r">priorityType</span>;
            <span class="c">// This will either return data or register callback but doesn&#39;t do both.</span>
            <b>byte</b>[] <span id="r237 rd" class="r237 r">data</span> = <a href="BaseTransportManager.cs.html#ee4a2ac1afa72dce" class="i field">dataToBeSent</a>.<a href="PriorityCollection.cs.html#56fbcab0ffda9766" class="i method">ReadOrRegisterCallback</a>(<a href="#714021c56de8e1d8" class="i field">_onDataAvailableToSendCallback</a>,
                <b>out</b> <span class="r236 r">priorityType</span>);
            <b>if</b> (<span class="r237 r">data</span> != <b>null</b>)
            {
                <a href="#ec7c516f4b40800f" class="i method">SendData</a>(<span class="r237 r">data</span>, <span class="r236 r">priorityType</span>);
            }
        }
 
        <b>private void</b> <a id="e3dbec6c7a9edb03" href="../../../R/e3dbec6c7a9edb03.html" target="n" data-glyph="76,1" class="i method">OnDataAvailableCallback</a>(<b>byte</b>[] <span id="r238 rd" class="r238 r">data</span>, <a href="PriorityCollection.cs.html#f0975201467fdc06" class="t t">DataPriorityType</a> <span id="r239 rd" class="r239 r">priorityType</span>)
        {
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r238 r">data</span> != <b>null</b>, <span class="s">&quot;data cannot be null in the data available callback&quot;</span>);
 
            <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<a href="../../../utils/StructuredTraceSource.cs.html#96aaf3813a5962a0" class="i method">WriteLine</a>(<span class="s">&quot;Received data to be sent from the callback.&quot;</span>);
            <a href="#ec7c516f4b40800f" class="i method">SendData</a>(<span class="r238 r">data</span>, <span class="r239 r">priorityType</span>);
        }
 
        <b>private void</b> <a id="ec7c516f4b40800f" href="../../../R/ec7c516f4b40800f.html" target="n" data-glyph="76,1" class="i method">SendData</a>(<b>byte</b>[] <span id="r240 rd" class="r240 r">data</span>, <a href="PriorityCollection.cs.html#f0975201467fdc06" class="t t">DataPriorityType</a> <span id="r241 rd" class="r241 r">priorityType</span>)
        {
            <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<span class="i">WriteLine</span>(<span class="s">&quot;Session sending data of size : {0}&quot;</span>, <span class="r240 r">data</span>.<span class="i">Length</span>);
            <b>byte</b>[] <span id="r242 rd" class="r242 r">package</span> = <span class="r240 r">data</span>;
 
            <span class="k preprocess">#</span><span class="k preprocess">region</span> SHIM: Redirection code for session data send.
 
            <b>bool</b> <span id="r243 rd" class="r243 r">sendContinue</span> = <b>true</b>;
 
            <b>if</b> (<a href="#687643a8ddd6f0bc" class="i field">s_sessionSendRedirect</a> != <b>null</b>)
            {
                <b>object</b>[] <span id="r244 rd" class="r244 r">arguments</span> = <b>new</b> <b>object</b>[2] { <b>null</b>, <span class="r242 r">package</span> };
                <span class="r243 r">sendContinue</span> = (<b>bool</b>)<a href="#687643a8ddd6f0bc" class="i field">s_sessionSendRedirect</a>.<span class="i">DynamicInvoke</span>(<span class="r244 r">arguments</span>);
                <span class="r242 r">package</span> = (<b>byte</b>[])<span class="r244 r">arguments</span>[0];
            }
 
            <b>if</b> (!<span class="r243 r">sendContinue</span>)
                <b>return</b>;
 
            <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
            <b>using</b> (<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#c08fd7c84904da7c" class="t t">WSManData_ManToUn</a> <span id="r245 rd" class="r245 r">serializedContent</span> =
                         <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#53bab55b828c8016" class="t constructor">WSManData_ManToUn</a>(<span class="r242 r">package</span>))
            {
                <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(
                    <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#833085c622d127cb" class="i field">WSManSendShellInputEx</a>, <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#10dc07d70da5e17a" class="i field">Send</a>, <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                    <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#c5d4a73b62c859ab" class="i field">Transport</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                    <a href="BaseTransportManager.cs.html#6b69cd5f8cc06fb7" class="i property">RunspacePoolInstanceId</a>.<span class="i">ToString</span>(),
                    <span class="i">Guid</span>.<span class="i">Empty</span>.<span class="i">ToString</span>(),
                    <span class="r245 r">serializedContent</span>.<a href="WSManNativeAPI.cs.html#47798822d606f221" class="i property">BufferLength</a>.<span class="i">ToString</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>));
 
                <b>lock</b> (<a href="BaseTransportManager.cs.html#2b6037d6b3777ca1" class="i field">syncObject</a>)
                {
                    <span class="c">// make sure the transport is not closed.</span>
                    <b>if</b> (<a href="BaseTransportManager.cs.html#76271338de46dcf0" class="i field">isClosed</a>)
                    {
                        <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<a href="../../../utils/StructuredTraceSource.cs.html#96aaf3813a5962a0" class="i method">WriteLine</a>(<span class="s">&quot;Client Session TM: Transport manager is closed. So returning&quot;</span>);
                        <b>return</b>;
                    }
 
                    <span class="c">// send callback</span>
                    <a href="#7db9e01d865492bd" class="i field">_sendToRemoteCompleted</a> = <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#d3c47769c10efcdb" class="t constructor">WSManShellAsync</a>(<b>new</b> <span class="i">IntPtr</span>(<a href="#63bdfff34ccd5ad2" class="i field">_sessionContextID</a>), <a href="#aa21f6e1b86c1390" class="i field">s_sessionSendCallback</a>);
                    <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<span class="i">WSManSendShellInputEx</span>(<a href="#5120ad7297341362" class="i field">_wsManShellOperationHandle</a>, <span class="i">IntPtr</span>.<span class="i">Zero</span>, 0,
                        <span class="r241 r">priorityType</span> == <a href="PriorityCollection.cs.html#f0975201467fdc06" class="t t">DataPriorityType</a>.<a href="PriorityCollection.cs.html#e5092d1f4fa1babe" class="i field">Default</a> ?
                            <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#dc257aa7beeaf400" class="i field">WSMAN_STREAM_ID_STDIN</a> : <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#2dd82f73ca1e8381" class="i field">WSMAN_STREAM_ID_PROMPTRESPONSE</a>,
                        <span class="r245 r">serializedContent</span>,
                        <a href="#7db9e01d865492bd" class="i field">_sendToRemoteCompleted</a>,
                        <b>ref</b> <a href="#1cd15cdc83709878" class="i field">_wsManSendOperationHandle</a>);
                }
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Dispose / Destructor pattern
 
        [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Usage&quot;</span>, <span class="s">&quot;CA2213:DisposableFieldsShouldBeDisposed&quot;</span>)]
        <b>internal override void</b> <a id="9bf975b9c12b89ce" href="../../../R/9bf975b9c12b89ce.html" target="n" data-glyph="74,1" class="i method">Dispose</a>(<b>bool</b> <span id="r246 rd" class="r246 r">isDisposing</span>)
        {
            <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<span class="i">WriteLine</span>(<span class="s">&quot;Disposing session with session context: {0} Operation Context: {1}&quot;</span>, <a href="#63bdfff34ccd5ad2" class="i field">_sessionContextID</a>, <a href="#5120ad7297341362" class="i field">_wsManShellOperationHandle</a>);
 
            <a href="#ecf76fcc2b3850bc" class="i method">CloseSessionAndClearResources</a>();
 
            <a href="#e50f9ab8c706a4f7" class="i method">DisposeWSManAPIDataAsync</a>();
 
            <span class="c">// openContent is used by redirection ie., while redirecting to</span>
            <span class="c">// a new machine and hence this is cleared only when the session</span>
            <span class="c">// is disposing.</span>
            <b>if</b> (<span class="r246 r">isDisposing</span> &amp;&amp; (<a href="#b636a4d17100c22a" class="i field">_openContent</a> != <b>null</b>))
            {
                <a href="#b636a4d17100c22a" class="i field">_openContent</a>.<a href="WSManNativeAPI.cs.html#a723a8d748579007" class="i method">Dispose</a>();
                <a href="#b636a4d17100c22a" class="i field">_openContent</a> = <b>null</b>;
            }
 
            <a href="BaseTransportManager.cs.html#19883ec4df424177" class="k">base</a>.<a href="BaseTransportManager.cs.html#28896ed8464e84b5" class="i method">Dispose</a>(<span class="r246 r">isDisposing</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Closes current session handle by calling WSManCloseSession and clears</span>
        <span class="c">///</span><span class="c"> session related resources.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private void</b> <a id="ecf76fcc2b3850bc" href="../../../R/ecf76fcc2b3850bc.html" target="n" data-glyph="76,1" class="i method">CloseSessionAndClearResources</a>()
        {
            <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<span class="i">WriteLine</span>(<span class="s">&quot;Clearing session with session context: {0} Operation Context: {1}&quot;</span>, <a href="#63bdfff34ccd5ad2" class="i field">_sessionContextID</a>, <a href="#5120ad7297341362" class="i field">_wsManShellOperationHandle</a>);
 
            <span class="c">// Taking a copy of session handle as we should call WSManCloseSession only once and</span>
            <span class="c">// clear the original value. This will protect us if Dispose() is called twice.</span>
            <span class="i">IntPtr</span> <span id="r247 rd" class="r247 r">tempWSManSessionHandle</span> = <a href="#e71b1b284f1d2a52" class="i field">_wsManSessionHandle</a>;
            <a href="#e71b1b284f1d2a52" class="i field">_wsManSessionHandle</a> = <span class="i">IntPtr</span>.<span class="i">Zero</span>;
            <span class="c">// Call WSManCloseSession on a different thread as Dispose can be called from one of</span>
            <span class="c">// the WSMan callback threads. WSMan does not support closing a session in the callbacks.</span>
            <span class="i">ThreadPool</span>.<span class="i">QueueUserWorkItem</span>(<b>new</b> <span class="i">WaitCallback</span>(
                <span class="c">// wsManSessionHandle is passed as parameter to allow the thread to be independent</span>
                <span class="c">// of the rest of the parent object.</span>
                (<b>object</b> <span id="r248 rd" class="r248 r">state</span>) =&gt;
                {
                    <span class="i">IntPtr</span> <span id="r249 rd" class="r249 r">sessionHandle</span> = (<span class="i">IntPtr</span>)<span class="r248 r">state</span>;
                    <b>if</b> (<span class="r249 r">sessionHandle</span> != <span class="i">IntPtr</span>.<span class="i">Zero</span>)
                    {
                        <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#84cdff7876d8762a" class="i method">WSManCloseSession</a>(<span class="r249 r">sessionHandle</span>, 0);
                    }
                }), <span class="r247 r">tempWSManSessionHandle</span>);
 
            <span class="c">// remove session context from session handles dictionary</span>
            <a href="#821511033f76b57e" class="i method">RemoveSessionTransportManager</a>(<a href="#63bdfff34ccd5ad2" class="i field">_sessionContextID</a>);
 
            <b>if</b> (<a href="#b58b1df0b8db7760" class="i field">_closeSessionCompleted</a> != <b>null</b>)
            {
                <a href="#b58b1df0b8db7760" class="i field">_closeSessionCompleted</a>.<a href="WSManNativeAPI.cs.html#c68800d727cb6a45" class="i method">Dispose</a>();
                <a href="#b58b1df0b8db7760" class="i field">_closeSessionCompleted</a> = <b>null</b>;
            }
 
            <span class="c">// Dispose the create session completed callback here, since it is</span>
            <span class="c">// used for periodic robust connection retry/auto-disconnect</span>
            <span class="c">// notifications while the shell is active.</span>
            <b>if</b> (<a href="#50df0d6aba0ff464" class="i field">_createSessionCallback</a> != <b>null</b>)
            {
                <a href="#1fb2fbc7b82eea45" class="i field">_createSessionCallbackGCHandle</a>.<span class="i">Free</span>();
                <a href="#50df0d6aba0ff464" class="i field">_createSessionCallback</a>.<a href="WSManNativeAPI.cs.html#c68800d727cb6a45" class="i method">Dispose</a>();
                <a href="#50df0d6aba0ff464" class="i field">_createSessionCallback</a> = <b>null</b>;
            }
 
            <span class="c">// Dispose the OnConnect callback if one present</span>
            <b>if</b> (<a href="#a240d6a8fd1c1826" class="i field">_connectSessionCallback</a> != <b>null</b>)
            {
                <a href="#a240d6a8fd1c1826" class="i field">_connectSessionCallback</a>.<a href="WSManNativeAPI.cs.html#c68800d727cb6a45" class="i method">Dispose</a>();
                <a href="#a240d6a8fd1c1826" class="i field">_connectSessionCallback</a> = <b>null</b>;
            }
 
            <span class="c">// Reset the session context Id to zero so that a new one will be generated for</span>
            <span class="c">// any following redirected session.</span>
            <a href="#63bdfff34ccd5ad2" class="i field">_sessionContextID</a> = 0;
        }
 
        <b>private void</b> <a id="e50f9ab8c706a4f7" href="../../../R/e50f9ab8c706a4f7.html" target="n" data-glyph="76,1" class="i method">DisposeWSManAPIDataAsync</a>()
        {
            <a href="#d144f8a5fae9b9c5" class="t t">WSManAPIDataCommon</a> <span id="r250 rd" class="r250 r">tempWSManApiData</span> = <a href="#7616e1c5a9b266f9" class="i property">WSManAPIData</a>;
            <b>if</b> (<span class="r250 r">tempWSManApiData</span> == <b>null</b>) { <b>return</b>; }
 
            <a href="#7616e1c5a9b266f9" class="i property">WSManAPIData</a> = <b>null</b>;
 
            <span class="c">// Dispose and de-initialize the WSManAPIData instance object on separate worker thread to ensure</span>
            <span class="c">// it is not run on a WinRM thread (which will fail).</span>
            <span class="c">// Note that WSManAPIData.Dispose() method is thread safe.</span>
            <span class="i">ThreadPool</span>.<span class="i">QueueUserWorkItem</span>((<span id="r251 rd" class="r251 r">_</span>) =&gt; <span class="r250 r">tempWSManApiData</span>.<a href="#f6f8b0e0f2752985" class="i method">Dispose</a>());
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> WSManAPIDataCommon
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Class that manages WSManAPI data. Has information like APIHandle which is created</span>
        <span class="c">///</span><span class="c"> using WSManInitialize, InputStreamSet, OutputStreamSet.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal class</b> <a id="d144f8a5fae9b9c5" href="../../../R/d144f8a5fae9b9c5.html" target="n" data-glyph="2,1" class="t t">WSManAPIDataCommon</a> : <span class="i">IDisposable</span>
        {
            [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Reliability&quot;</span>, <span class="s">&quot;CA2006:UseSafeHandleToEncapsulateNativeResources&quot;</span>)]
            <b>private</b> <span class="i">IntPtr</span> <a id="aa2a6284df6e5bec" href="../../../R/aa2a6284df6e5bec.html" target="n" data-glyph="46,2" class="i field">_handle</a>;
            <span class="c">// if any</span>
            <b>private</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#69baba050509e5fa" class="t t">WSManStreamIDSet_ManToUn</a> <a id="6ffe8cdfe885c8b7" href="../../../R/6ffe8cdfe885c8b7.html" target="n" data-glyph="46,2" class="i field">_inputStreamSet</a>;
            <b>private</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#69baba050509e5fa" class="t t">WSManStreamIDSet_ManToUn</a> <a id="7aba3b3b1fee3855" href="../../../R/7aba3b3b1fee3855.html" target="n" data-glyph="46,2" class="i field">_outputStreamSet</a>;
            <span class="c">// Dispose</span>
            <b>private bool</b> <a id="d97d0893d23126fe" href="../../../R/d97d0893d23126fe.html" target="n" data-glyph="46,2" class="i field">_isDisposed</a>;
            <b>private readonly object</b> <a id="83be62171d226b78" href="../../../R/83be62171d226b78.html" target="n" data-glyph="46,2" class="i field">_syncObject</a> = <b>new</b> <b>object</b>();
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">UNIX</span>
            <b>private readonly</b> <span class="i">WindowsIdentity</span> <a id="7e904c0a5c813af8" href="../../../R/7e904c0a5c813af8.html" target="n" data-glyph="46,2" class="i field">_identityToImpersonate</a>;
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
 
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> Initializes handle by calling WSManInitialize API.</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
            <b>internal</b> <a id="81e0524cd7809211" href="../../../R/81e0524cd7809211.html" target="n" data-glyph="74,2" class="t constructor">WSManAPIDataCommon</a>()
            {
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">UNIX</span>
                <span class="c">// Check for thread impersonation and save identity for later de-initialization.</span>
                <a href="../../Utils.cs.html#9185d6ecbaebbec0" class="t t">Utils</a>.<a href="../../Utils.cs.html#9b44ca7f35bc8c39" class="i method">TryGetWindowsImpersonatedIdentity</a>(<b>out</b> <a href="#7e904c0a5c813af8" class="i field">_identityToImpersonate</a>);
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
 
                <a href="#aa2a6284df6e5bec" class="i field">_handle</a> = <span class="i">IntPtr</span>.<span class="i">Zero</span>;
 
                <b>try</b>
                {
                    <a href="#aab5d26a8e241769" class="i property">ErrorCode</a> = <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#b08552b284baf3a8" class="i method">WSManInitialize</a>(<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#08cd612f4eb2ae04" class="i field">WSMAN_FLAG_REQUESTED_API_VERSION_1_1</a>, <b>ref</b> <a href="#aa2a6284df6e5bec" class="i field">_handle</a>);
                }
                <b>catch</b> (<span class="i">DllNotFoundException</span> <span id="r252 rd" class="r252 r">ex</span>)
                {
                    <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogOperationalError</span>(
                        <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#4ddb36cebdb0b70c" class="i field">TransportError</a>,
                        <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#399fd86ea109ec79" class="i field">Open</a>,
                        <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                        <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#05d709c2010b41d5" class="i field">UseAlwaysOperational</a>,
                        <span class="s">&quot;WSManAPIDataCommon.ctor&quot;</span>,
                        <span class="s">&quot;WSManInitialize&quot;</span>,
                        <span class="r252 r">ex</span>.<span class="i">HResult</span>.<span class="i">ToString</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>),
                        <span class="r252 r">ex</span>.<span class="i">Message</span>,
                        <span class="r252 r">ex</span>.<span class="i">StackTrace</span>);
                    <b>throw</b> <b>new</b> <span class="t">PSRemotingTransportException</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">WSManClientDllNotAvailable</span>, <span class="r252 r">ex</span>);
                }
 
                <span class="c">// input / output streams common to all connections</span>
                <a href="#6ffe8cdfe885c8b7" class="i field">_inputStreamSet</a> = <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#93cfa4fd7fab6a22" class="t constructor">WSManStreamIDSet_ManToUn</a>(
                    <b>new</b> <b>string</b>[] {
                        <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#dc257aa7beeaf400" class="i field">WSMAN_STREAM_ID_STDIN</a>,
                        <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#2dd82f73ca1e8381" class="i field">WSMAN_STREAM_ID_PROMPTRESPONSE</a>
                    });
                <a href="#7aba3b3b1fee3855" class="i field">_outputStreamSet</a> = <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#93cfa4fd7fab6a22" class="t constructor">WSManStreamIDSet_ManToUn</a>(
                    <b>new</b> <b>string</b>[] { <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#ab2f3becc1476649" class="i field">WSMAN_STREAM_ID_STDOUT</a> });
 
                <span class="c">// startup options common to all connections</span>
                <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#f3f2b67eaca5460e" class="t t">WSManOption</a> <span id="r253 rd" class="r253 r">protocolStartupOption</span> = <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<span class="t">WSManOption</span>();
                <span class="r253 r">protocolStartupOption</span>.<a href="WSManNativeAPI.cs.html#236eed2b4fe7a439" class="i field">name</a> = <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#7c9c1b0b95848ffd" class="t t">RemoteDataNameStrings</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#c416521156fef723" class="i field">PS_STARTUP_PROTOCOL_VERSION_NAME</a>;
                <span class="r253 r">protocolStartupOption</span>.<a href="WSManNativeAPI.cs.html#fc9f90499a03780b" class="i field">value</a> = <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#d19a1042a44001e8" class="t t">RemotingConstants</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#c5be07ec763d4c13" class="i field">ProtocolVersion</a>.<span class="i">ToString</span>();
                <span class="r253 r">protocolStartupOption</span>.<a href="WSManNativeAPI.cs.html#e4277700dc2720ce" class="i field">mustComply</a> = <b>true</b>;
 
                <a href="#95447a4f3ec48ffa" class="i property">CommonOptionSet</a> = <b>new</b> <span class="i">List</span>&lt;<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#f3f2b67eaca5460e" class="t t">WSManOption</a>&gt;();
                <a href="#95447a4f3ec48ffa" class="i property">CommonOptionSet</a>.<span class="i">Add</span>(<span class="r253 r">protocolStartupOption</span>);
            }
 
            <b>internal int</b> <a id="aab5d26a8e241769" href="../../../R/aab5d26a8e241769.html" target="n" data-glyph="104,2" class="i property">ErrorCode</a> { <b>get</b>; }
 
            <b>internal</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#69baba050509e5fa" class="t t">WSManStreamIDSet_ManToUn</a> <a id="9aa68c6337bfdf52" href="../../../R/9aa68c6337bfdf52.html" target="n" data-glyph="104,2" class="i property">InputStreamSet</a> { <b>get</b> { <b>return</b> <a href="#6ffe8cdfe885c8b7" class="i field">_inputStreamSet</a>; } }
 
            <b>internal</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#69baba050509e5fa" class="t t">WSManStreamIDSet_ManToUn</a> <a id="e80e9dbb667bfefc" href="../../../R/e80e9dbb667bfefc.html" target="n" data-glyph="104,2" class="i property">OutputStreamSet</a> { <b>get</b> { <b>return</b> <a href="#7aba3b3b1fee3855" class="i field">_outputStreamSet</a>; } }
 
            <b>internal</b> <span class="i">List</span>&lt;<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#f3f2b67eaca5460e" class="t t">WSManOption</a>&gt; <a id="95447a4f3ec48ffa" href="../../../R/95447a4f3ec48ffa.html" target="n" data-glyph="104,2" class="i property">CommonOptionSet</a> { <b>get</b>; }
 
            <b>internal</b> <span class="i">IntPtr</span> <a id="f386d97c12d99137" href="../../../R/f386d97c12d99137.html" target="n" data-glyph="104,2" class="i property">WSManAPIHandle</a> { <b>get</b> { <b>return</b> <a href="#aa2a6284df6e5bec" class="i field">_handle</a>; } }
 
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
            <span class="c">///</span><span class="c"> Dispose.</span>
            <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
            <span class="c">// Suppress this message. The result is actually used, but only in checked builds....</span>
            [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Usage&quot;</span>, <span class="s">&quot;CA1806:DoNotIgnoreMethodResults&quot;</span>,
               <span class="i">MessageId</span> = <span class="s">&quot;System.Management.Automation.Remoting.Client.WSManNativeApi.WSManDeinitialize(System.IntPtr,System.Int32)&quot;</span>)]
            [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Usage&quot;</span>, <span class="s">&quot;CA2216:Disposabletypesshoulddeclarefinalizer&quot;</span>)]
            <b>public void</b> <a id="f6f8b0e0f2752985" href="../../../R/f6f8b0e0f2752985.html" target="n" data-glyph="72,2" class="i method">Dispose</a>()
            {
                <b>lock</b> (<a href="#83be62171d226b78" class="i field">_syncObject</a>)
                {
                    <b>if</b> (<a href="#d97d0893d23126fe" class="i field">_isDisposed</a>) { <b>return</b>; }
 
                    <a href="#d97d0893d23126fe" class="i field">_isDisposed</a> = <b>true</b>;
                }
 
                <a href="#6ffe8cdfe885c8b7" class="i field">_inputStreamSet</a>.<a href="WSManNativeAPI.cs.html#ba6d3ce48ff3247e" class="i method">Dispose</a>();
                <a href="#7aba3b3b1fee3855" class="i field">_outputStreamSet</a>.<a href="WSManNativeAPI.cs.html#ba6d3ce48ff3247e" class="i method">Dispose</a>();
 
                <b>if</b> (<a href="#aa2a6284df6e5bec" class="i field">_handle</a> != <span class="i">IntPtr</span>.<span class="i">Zero</span>)
                {
                    <b>int</b> <span id="r254 rd" class="r254 r">result</span> = 0;
 
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">UNIX</span>
                    <span class="c">// If we initialized with thread impersonation, make sure de-initialize is run with the same.</span>
                    <b>if</b> (<a href="#7e904c0a5c813af8" class="i field">_identityToImpersonate</a> != <b>null</b>)
                    {
                        <span class="r254 r">result</span> = <span class="i">WindowsIdentity</span>.<span class="i">RunImpersonated</span>(
                            <a href="#7e904c0a5c813af8" class="i field">_identityToImpersonate</a>.<span class="i">AccessToken</span>,
                            () =&gt; <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#890e76a5e680a7c1" class="i method">WSManDeinitialize</a>(<a href="#aa2a6284df6e5bec" class="i field">_handle</a>, 0));
                    }
                    <b>else</b>
                    {
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
                        <span class="r254 r">result</span> = <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#890e76a5e680a7c1" class="i method">WSManDeinitialize</a>(<a href="#aa2a6284df6e5bec" class="i field">_handle</a>, 0);
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">UNIX</span>
                    }
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
 
                    <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r254 r">result</span> == 0, <span class="s">&quot;WSManDeinitialize returned non-zero value&quot;</span>);
                    <a href="#aa2a6284df6e5bec" class="i field">_handle</a> = <span class="i">IntPtr</span>.<span class="i">Zero</span>;
                }
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> EventHandlers
 
        <b>internal event</b> <span class="i">EventHandler</span>&lt;<span class="i">EventArgs</span>&gt; <a id="8a72740c6e80c668" href="../../../R/8a72740c6e80c668.html" target="n" data-glyph="32,1" class="i">RobustConnectionsInitiated</a>;
 
        <b>internal event</b> <span class="i">EventHandler</span>&lt;<span class="i">EventArgs</span>&gt; <a id="2ab967894e7c3b07" href="../../../R/2ab967894e7c3b07.html" target="n" data-glyph="32,1" class="i">RobustConnectionsCompleted</a>;
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
    }
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> A class maintaining the transport of a command for the shell. Multiple commands will have</span>
    <span class="c">///</span><span class="c"> multiple transport managers. The Transport manager manages creating / sending /receiving</span>
    <span class="c">///</span><span class="c"> data and closing (terminating) the command.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>internal sealed class</b> <a id="b521a47ccd5a3cc1" href="../../../R/b521a47ccd5a3cc1.html" target="n" data-glyph="2,0" class="t t">WSManClientCommandTransportManager</a> : <a href="BaseTransportManager.cs.html#fa455a694094fdc2" class="t t">BaseClientCommandTransportManager</a>
    {
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Consts
 
        <b>internal const string</b> <a id="3e86351ee0864842" href="../../../R/3e86351ee0864842.html" target="n" data-glyph="8,1" class="i field">StopSignal</a> = <span class="s">@&quot;powershell/signal/crtl_c&quot;</span>;
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Private Data
 
        <span class="c">// operation handles</span>
        <b>private readonly</b> <span class="i">IntPtr</span> <a id="7f3442b679fa07aa" href="../../../R/7f3442b679fa07aa.html" target="n" data-glyph="46,1" class="i field">_wsManShellOperationHandle</a>;
 
        [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Reliability&quot;</span>, <span class="s">&quot;CA2006:UseSafeHandleToEncapsulateNativeResources&quot;</span>)]
        <b>private</b> <span class="i">IntPtr</span> <a id="01c2414243976ea8" href="../../../R/01c2414243976ea8.html" target="n" data-glyph="46,1" class="i field">_wsManCmdOperationHandle</a>;
 
        [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Reliability&quot;</span>, <span class="s">&quot;CA2006:UseSafeHandleToEncapsulateNativeResources&quot;</span>)]
        <b>private</b> <span class="i">IntPtr</span> <a id="dba133100f83c727" href="../../../R/dba133100f83c727.html" target="n" data-glyph="46,1" class="i field">_cmdSignalOperationHandle</a>;
 
        [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Reliability&quot;</span>, <span class="s">&quot;CA2006:UseSafeHandleToEncapsulateNativeResources&quot;</span>)]
        <b>private</b> <span class="i">IntPtr</span> <a id="aaeb079bf1222e92" href="../../../R/aaeb079bf1222e92.html" target="n" data-glyph="46,1" class="i field">_wsManReceiveOperationHandle</a>;
 
        [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Reliability&quot;</span>, <span class="s">&quot;CA2006:UseSafeHandleToEncapsulateNativeResources&quot;</span>)]
        <b>private</b> <span class="i">IntPtr</span> <a id="e0b96634e6e04f20" href="../../../R/e0b96634e6e04f20.html" target="n" data-glyph="46,1" class="i field">_wsManSendOperationHandle</a>;
        <span class="c">// this is used with WSMan callbacks to represent a command transport manager.</span>
        <b>private long</b> <a id="cc02a8a8120dfe1d" href="../../../R/cc02a8a8120dfe1d.html" target="n" data-glyph="46,1" class="i field">_cmdContextId</a>;
 
        <b>private readonly</b> <a href="PriorityCollection.cs.html#0fa204cb5092e738" class="t t">PrioritySendDataCollection</a>.<a href="PriorityCollection.cs.html#81c7391587f527f6" class="t t">OnDataAvailableCallback</a> <a id="39f0680093150e38" href="../../../R/39f0680093150e38.html" target="n" data-glyph="46,1" class="i field">_onDataAvailableToSendCallback</a>;
 
        <span class="c">// should be integrated with receiveDataInitiated</span>
        <b>private bool</b> <a id="27a16a3a5f5c884a" href="../../../R/27a16a3a5f5c884a.html" target="n" data-glyph="46,1" class="i field">_shouldStartReceivingData</a>;
 
        <span class="c">// bools used to track and send stop signal only after Create is completed.</span>
        <b>private bool</b> <a id="f46e93b97317819a" href="../../../R/f46e93b97317819a.html" target="n" data-glyph="46,1" class="i field">_isCreateCallbackReceived</a>;
        <b>private bool</b> <a id="f7f1092d9ea3a343" href="../../../R/f7f1092d9ea3a343.html" target="n" data-glyph="46,1" class="i field">_isStopSignalPending</a>;
        <b>private bool</b> <a id="5d59ea7e64b6101f" href="../../../R/5d59ea7e64b6101f.html" target="n" data-glyph="46,1" class="i field">_isDisconnectPending</a>;
        <b>private bool</b> <a id="7ceeeb92886e32b9" href="../../../R/7ceeeb92886e32b9.html" target="n" data-glyph="46,1" class="i field">_isSendingInput</a>;
        <b>private bool</b> <a id="8f171b9d04bc2973" href="../../../R/8f171b9d04bc2973.html" target="n" data-glyph="46,1" class="i field">_isDisconnectedOnInvoke</a>;
 
        <span class="c">// callbacks</span>
        <b>private</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#5659ff525f41a5f1" class="t t">WSManShellAsync</a> <a id="fd406ac145167469" href="../../../R/fd406ac145167469.html" target="n" data-glyph="46,1" class="i field">_createCmdCompleted</a>;
        <b>private</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#5659ff525f41a5f1" class="t t">WSManShellAsync</a> <a id="fec5609dcdeafac8" href="../../../R/fec5609dcdeafac8.html" target="n" data-glyph="46,1" class="i field">_receivedFromRemote</a>;
        <b>private</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#5659ff525f41a5f1" class="t t">WSManShellAsync</a> <a id="7a925c9a2ffed390" href="../../../R/7a925c9a2ffed390.html" target="n" data-glyph="46,1" class="i field">_sendToRemoteCompleted</a>;
        <b>private</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#5659ff525f41a5f1" class="t t">WSManShellAsync</a> <a id="ce0cc9b6aa97e797" href="../../../R/ce0cc9b6aa97e797.html" target="n" data-glyph="46,1" class="i field">_reconnectCmdCompleted</a>;
        <b>private</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#5659ff525f41a5f1" class="t t">WSManShellAsync</a> <a id="bbb8fa736fe480fa" href="../../../R/bbb8fa736fe480fa.html" target="n" data-glyph="46,1" class="i field">_connectCmdCompleted</a>;
        <span class="c">// TODO: This GCHandle is required as it seems WSMan is calling create callback</span>
        <span class="c">// after we call Close. This seems wrong. Opened bug on WSMan to track this.</span>
        <b>private</b> <span class="i">GCHandle</span> <a id="b2d3f4d9ad24a224" href="../../../R/b2d3f4d9ad24a224.html" target="n" data-glyph="46,1" class="i field">_createCmdCompletedGCHandle</a>;
        <b>private</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#5659ff525f41a5f1" class="t t">WSManShellAsync</a> <a id="c98a52d310bc6bbf" href="../../../R/c98a52d310bc6bbf.html" target="n" data-glyph="46,1" class="i field">_closeCmdCompleted</a>;
        <b>private</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#5659ff525f41a5f1" class="t t">WSManShellAsync</a> <a id="116efb269d3cd8af" href="../../../R/116efb269d3cd8af.html" target="n" data-glyph="46,1" class="i field">_signalCmdCompleted</a>;
        <span class="c">// this is the chunk that got delivered on onDataAvailableToSendCallback</span>
        <span class="c">// will be sent during subsequent SendOneItem()</span>
        <b>private</b> <a href="#090a9c5ea56dbeb0" class="t t">SendDataChunk</a> <a id="67ee6049ffe2af29" href="../../../R/67ee6049ffe2af29.html" target="n" data-glyph="46,1" class="i field">_chunkToSend</a>;
 
        <b>private readonly string</b> <a id="2acc5938101a87dc" href="../../../R/2acc5938101a87dc.html" target="n" data-glyph="46,1" class="i field">_cmdLine</a>;
        <b>private readonly</b> <a href="#693b43214373ab1e" class="t t">WSManClientSessionTransportManager</a> <a id="c75759e8604f93da" href="../../../R/c75759e8604f93da.html" target="n" data-glyph="46,1" class="i field">_sessnTm</a>;
 
        <b>private sealed class</b> <a id="090a9c5ea56dbeb0" href="../../../R/090a9c5ea56dbeb0.html" target="n" data-glyph="4,1" class="t t">SendDataChunk</a>
        {
            <b>public</b> <a id="9a4c40c1a04c9f80" href="../../../R/9a4c40c1a04c9f80.html" target="n" data-glyph="72,2" class="t constructor">SendDataChunk</a>(<b>byte</b>[] <span id="r255 rd" class="r255 r">data</span>, <a href="PriorityCollection.cs.html#f0975201467fdc06" class="t t">DataPriorityType</a> <span id="r256 rd" class="r256 r">type</span>)
            {
                <a href="#7c1e5881dd43fdd6" class="i property">Data</a> = <span class="r255 r">data</span>;
                <a href="#721d18918e832377" class="i property">Type</a> = <span class="r256 r">type</span>;
            }
 
            <b>public byte</b>[] <a id="7c1e5881dd43fdd6" href="../../../R/7c1e5881dd43fdd6.html" target="n" data-glyph="102,2" class="i property">Data</a> { <b>get</b>; }
 
            <b>public</b> <a href="PriorityCollection.cs.html#f0975201467fdc06" class="t t">DataPriorityType</a> <a id="721d18918e832377" href="../../../R/721d18918e832377.html" target="n" data-glyph="102,2" class="i property">Type</a> { <b>get</b>; }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Static Data
 
        <span class="c">// static callback delegate</span>
        <b>private static</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#9855dfa19ee2dc9d" class="t t">WSManShellAsyncCallback</a> <a id="791db9e5c67329dd" href="../../../R/791db9e5c67329dd.html" target="n" data-glyph="46,1" class="i field">s_cmdCreateCallback</a>;
        <b>private static</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#9855dfa19ee2dc9d" class="t t">WSManShellAsyncCallback</a> <a id="5a3b1d30e4629a22" href="../../../R/5a3b1d30e4629a22.html" target="n" data-glyph="46,1" class="i field">s_cmdCloseCallback</a>;
        <b>private static</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#9855dfa19ee2dc9d" class="t t">WSManShellAsyncCallback</a> <a id="6cc7b5d8cfd0a242" href="../../../R/6cc7b5d8cfd0a242.html" target="n" data-glyph="46,1" class="i field">s_cmdReceiveCallback</a>;
        <b>private static</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#9855dfa19ee2dc9d" class="t t">WSManShellAsyncCallback</a> <a id="9870925398ef76a0" href="../../../R/9870925398ef76a0.html" target="n" data-glyph="46,1" class="i field">s_cmdSendCallback</a>;
        <b>private static</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#9855dfa19ee2dc9d" class="t t">WSManShellAsyncCallback</a> <a id="d91b8166471d7716" href="../../../R/d91b8166471d7716.html" target="n" data-glyph="46,1" class="i field">s_cmdSignalCallback</a>;
        <b>private static</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#9855dfa19ee2dc9d" class="t t">WSManShellAsyncCallback</a> <a id="01d87a006497a3a0" href="../../../R/01d87a006497a3a0.html" target="n" data-glyph="46,1" class="i field">s_cmdReconnectCallback</a>;
        <b>private static</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#9855dfa19ee2dc9d" class="t t">WSManShellAsyncCallback</a> <a id="394161b27e89a36e" href="../../../R/394161b27e89a36e.html" target="n" data-glyph="46,1" class="i field">s_cmdConnectCallback</a>;
 
        <b>static</b> <a id="427fd8e5573d5f73" href="../../../R/../../0000000000.html" target="n" data-glyph="76,1" class="t method">WSManClientCommandTransportManager</a>()
        {
            <span class="c">// Initialize callback delegates</span>
            <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#e157acfccf186ce7" class="t t">WSManShellCompletionFunction</a> <span id="r257 rd" class="r257 r">createDelegate</span> =
                <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<span class="t">WSManShellCompletionFunction</span>(<a href="#7c8d2f473b5c952b" class="i method">OnCreateCmdCompleted</a>);
            <a href="#791db9e5c67329dd" class="i field">s_cmdCreateCallback</a> = <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#2af3c7c6053b5898" class="t constructor">WSManShellAsyncCallback</a>(<span class="r257 r">createDelegate</span>);
 
            <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#e157acfccf186ce7" class="t t">WSManShellCompletionFunction</a> <span id="r258 rd" class="r258 r">closeDelegate</span> =
                <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<span class="t">WSManShellCompletionFunction</span>(<a href="#e980e6030e69b858" class="i method">OnCloseCmdCompleted</a>);
            <a href="#5a3b1d30e4629a22" class="i field">s_cmdCloseCallback</a> = <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#2af3c7c6053b5898" class="t constructor">WSManShellAsyncCallback</a>(<span class="r258 r">closeDelegate</span>);
 
            <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#e157acfccf186ce7" class="t t">WSManShellCompletionFunction</a> <span id="r259 rd" class="r259 r">receiveDelegate</span> =
                <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<span class="t">WSManShellCompletionFunction</span>(<a href="#78cc7dad701baad9" class="i method">OnRemoteCmdDataReceived</a>);
            <a href="#6cc7b5d8cfd0a242" class="i field">s_cmdReceiveCallback</a> = <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#2af3c7c6053b5898" class="t constructor">WSManShellAsyncCallback</a>(<span class="r259 r">receiveDelegate</span>);
 
            <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#e157acfccf186ce7" class="t t">WSManShellCompletionFunction</a> <span id="r260 rd" class="r260 r">sendDelegate</span> =
                <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<span class="t">WSManShellCompletionFunction</span>(<a href="#8946ce6783c7572f" class="i method">OnRemoteCmdSendCompleted</a>);
            <a href="#9870925398ef76a0" class="i field">s_cmdSendCallback</a> = <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#2af3c7c6053b5898" class="t constructor">WSManShellAsyncCallback</a>(<span class="r260 r">sendDelegate</span>);
 
            <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#e157acfccf186ce7" class="t t">WSManShellCompletionFunction</a> <span id="r261 rd" class="r261 r">signalDelegate</span> =
                <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<span class="t">WSManShellCompletionFunction</span>(<a href="#877b0e2ab6965a59" class="i method">OnRemoteCmdSignalCompleted</a>);
            <a href="#d91b8166471d7716" class="i field">s_cmdSignalCallback</a> = <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#2af3c7c6053b5898" class="t constructor">WSManShellAsyncCallback</a>(<span class="r261 r">signalDelegate</span>);
 
            <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#e157acfccf186ce7" class="t t">WSManShellCompletionFunction</a> <span id="r262 rd" class="r262 r">reconnectDelegate</span> =
                <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<span class="t">WSManShellCompletionFunction</span>(<a href="#dc6cf413387a0000" class="i method">OnReconnectCmdCompleted</a>);
            <a href="#01d87a006497a3a0" class="i field">s_cmdReconnectCallback</a> = <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#2af3c7c6053b5898" class="t constructor">WSManShellAsyncCallback</a>(<span class="r262 r">reconnectDelegate</span>);
 
            <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#e157acfccf186ce7" class="t t">WSManShellCompletionFunction</a> <span id="r263 rd" class="r263 r">connectDelegate</span> =
                <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<span class="t">WSManShellCompletionFunction</span>(<a href="#a5437ff482db0c24" class="i method">OnConnectCmdCompleted</a>);
            <a href="#394161b27e89a36e" class="i field">s_cmdConnectCallback</a> = <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#2af3c7c6053b5898" class="t constructor">WSManShellAsyncCallback</a>(<span class="r263 r">connectDelegate</span>);
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Constructor
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This is an internal constructor used by WSManClientSessionTransportManager.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r264 r">connectionInfo</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> connection info to be used for creating the command.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r265 r">wsManShellOperationHandle</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Shell operation handle in whose context this transport manager sends/receives</span>
        <span class="c">///</span><span class="c"> data packets.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r266 r">shell</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The command to be sent to the remote end.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r267 r">noInput</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> true if the command has input, false otherwise.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r268 r">sessnTM</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Session transport manager creating this command transport manager instance.</span>
        <span class="c">///</span><span class="c"> Used by Command TM to apply session specific properties</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal</b> <a id="61d42ec6ec4708ea" href="../../../R/61d42ec6ec4708ea.html" target="n" data-glyph="74,1" class="t constructor">WSManClientCommandTransportManager</a>(
            <a href="../common/RunspaceConnectionInfo.cs.html#2d9d176ef419be5a" class="t t">WSManConnectionInfo</a> <span id="r264 rd" class="r264 r">connectionInfo</span>,
            <span class="i">IntPtr</span> <span id="r265 rd" class="r265 r">wsManShellOperationHandle</span>,
            <a href="../client/ClientRemotePowerShell.cs.html#b4d2ac017883b31c" class="t t">ClientRemotePowerShell</a> <span id="r266 rd" class="r266 r">shell</span>,
            <b>bool</b> <span id="r267 rd" class="r267 r">noInput</span>,
            <a href="#693b43214373ab1e" class="t t">WSManClientSessionTransportManager</a> <span id="r268 rd" class="r268 r">sessnTM</span>)
            : <a href="BaseTransportManager.cs.html#bd9431dfddb4513a" class="k">base</a>(<span class="r266 r">shell</span>, <span class="r268 r">sessnTM</span>.<a href="BaseTransportManager.cs.html#30975a92e0bc8f5d" class="i property">CryptoHelper</a>, <span class="r268 r">sessnTM</span>)
        {
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r265 r">wsManShellOperationHandle</span> != <span class="i">IntPtr</span>.<span class="i">Zero</span>, <span class="s">&quot;Shell operation handle cannot be IntPtr.Zero.&quot;</span>);
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r264 r">connectionInfo</span> != <b>null</b>, <span class="s">&quot;connectionInfo cannot be null&quot;</span>);
 
            <a href="#7f3442b679fa07aa" class="i field">_wsManShellOperationHandle</a> = <span class="r265 r">wsManShellOperationHandle</span>;
 
            <span class="c">// Apply quota limits.. allow for data to be unlimited..</span>
            <a href="BaseTransportManager.cs.html#766c6c998b78695f" class="i property">ReceivedDataCollection</a>.<a href="PriorityCollection.cs.html#7a540327df6a2e2d" class="i property">MaximumReceivedDataSize</a> = <span class="r264 r">connectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#acb325002c1b0d2a" class="i property">MaximumReceivedDataSizePerCommand</a>;
            <a href="BaseTransportManager.cs.html#766c6c998b78695f" class="i property">ReceivedDataCollection</a>.<a href="PriorityCollection.cs.html#24de42a1b1c1d4b9" class="i property">MaximumReceivedObjectSize</a> = <span class="r264 r">connectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#72cfe9a0c294ec04" class="i property">MaximumReceivedObjectSize</a>;
            <a href="#2acc5938101a87dc" class="i field">_cmdLine</a> = <span class="r266 r">shell</span>.<a href="../client/ClientRemotePowerShell.cs.html#c30957a9d4580098" class="i property">PowerShell</a>.<a href="../../hostifaces/PowerShell.cs.html#7bde27452e045465" class="i property">Commands</a>.<a href="../../hostifaces/PSCommand.cs.html#cc9b22e4391a9870" class="i property">Commands</a>.<a href="../../hostifaces/Command.cs.html#2f29888d02182b59" class="i method">GetCommandStringForHistory</a>();
            <a href="#39f0680093150e38" class="i field">_onDataAvailableToSendCallback</a> =
                <b>new</b> <a href="PriorityCollection.cs.html#0fa204cb5092e738" class="t t">PrioritySendDataCollection</a>.<span class="t">OnDataAvailableCallback</span>(<a href="#85f5b2369cc2aa6e" class="i method">OnDataAvailableCallback</a>);
            <a href="#c75759e8604f93da" class="i field">_sessnTm</a> = <span class="r268 r">sessnTM</span>;
            <span class="c">// Suspend queue on robust connections initiated event.</span>
            <span class="r268 r">sessnTM</span>.<a href="#8a72740c6e80c668" class="i">RobustConnectionsInitiated</a> += <span class="i">HandleRobustConnectionsInitiated</span>;
 
            <span class="c">// Resume queue on robust connections completed event.</span>
            <span class="r268 r">sessnTM</span>.<a href="#2ab967894e7c3b07" class="i">RobustConnectionsCompleted</a> += <span class="i">HandleRobusConnectionsCompleted</span>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> SHIM: Redirection delegate for command code send.
 
        <b>private static readonly</b> <span class="i">Delegate</span> <a id="257722f0ce4982a3" href="../../../R/257722f0ce4982a3.html" target="n" data-glyph="46,1" class="i field">s_commandCodeSendRedirect</a> = <b>null</b>;
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Internal Methods / Properties
 
        <b>private void</b> <a id="09f8f1620a498f23" href="../../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">HandleRobustConnectionsInitiated</a>(<b>object</b> <span id="r269 rd" class="r269 r">sender</span>, <span class="i">EventArgs</span> <span id="r270 rd" class="r270 r">e</span>)
        {
            <a href="BaseTransportManager.cs.html#67fbcc4583ff15b5" class="i method">SuspendQueue</a>();
        }
 
        <b>private void</b> <a id="c60f13ceb81b4527" href="../../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">HandleRobusConnectionsCompleted</a>(<b>object</b> <span id="r271 rd" class="r271 r">sender</span>, <span class="i">EventArgs</span> <span id="r272 rd" class="r272 r">e</span>)
        {
            <a href="BaseTransportManager.cs.html#1a3662753e2dd9a4" class="i method">ResumeQueue</a>();
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="../common/remotingexceptions.cs.html#0bb8687f97d91059" class="t t">PSRemotingTransportException</a><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> WSManConnectShellCommandEx failed.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>internal override void</b> <a id="0be0ebc0395ed311" href="../../../R/0be0ebc0395ed311.html" target="n" data-glyph="74,1" class="i method">ConnectAsync</a>()
        {
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<span class="i">Assert</span>(!<a href="BaseTransportManager.cs.html#76271338de46dcf0" class="i field">isClosed</a>, <span class="s">&quot;object already disposed&quot;</span>);
            <a href="BaseTransportManager.cs.html#766c6c998b78695f" class="i property">ReceivedDataCollection</a>.<a href="PriorityCollection.cs.html#a8845745894768de" class="i method">PrepareForStreamConnect</a>();
 
            <span class="c">// Empty the serializedPipeline data that contains PowerShell command information created in the</span>
            <span class="c">// constructor.  We are connecting to an existing command on the server and don&#39;t want to send</span>
            <span class="c">// information on a new command.</span>
            <a href="BaseTransportManager.cs.html#f0864e0c2b75fa58" class="i field">serializedPipeline</a>.<a href="../common/fragmentor.cs.html#6742b242d9687278" class="i method">Read</a>();
 
            <span class="c">// create cmdContextId</span>
            <a href="#cc02a8a8120dfe1d" class="i field">_cmdContextId</a> = <a href="#9220b9e7f82bd293" class="i method">GetNextCmdTMHandleId</a>();
            <a href="#f6b7255c7915d853" class="i method">AddCmdTransportManager</a>(<a href="#cc02a8a8120dfe1d" class="i field">_cmdContextId</a>, <a href="#b521a47ccd5a3cc1" class="k">this</a>);
 
            <span class="c">// Create Callback</span>
            <a href="#bbb8fa736fe480fa" class="i field">_connectCmdCompleted</a> = <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#d3c47769c10efcdb" class="t constructor">WSManShellAsync</a>(<b>new</b> <span class="i">IntPtr</span>(<a href="#cc02a8a8120dfe1d" class="i field">_cmdContextId</a>), <a href="#394161b27e89a36e" class="i field">s_cmdConnectCallback</a>);
            <a href="#ce0cc9b6aa97e797" class="i field">_reconnectCmdCompleted</a> = <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#d3c47769c10efcdb" class="t constructor">WSManShellAsync</a>(<b>new</b> <span class="i">IntPtr</span>(<a href="#cc02a8a8120dfe1d" class="i field">_cmdContextId</a>), <a href="#01d87a006497a3a0" class="i field">s_cmdReconnectCallback</a>);
            <b>lock</b> (<a href="BaseTransportManager.cs.html#2b6037d6b3777ca1" class="i field">syncObject</a>)
            {
                <b>if</b> (<a href="BaseTransportManager.cs.html#76271338de46dcf0" class="i field">isClosed</a>)
                {
                    <span class="c">// the transport is already closed..so no need to create a connection</span>
                    <span class="c">// anymore.</span>
                    <b>return</b>;
                }
 
                <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<span class="i">WSManConnectShellCommandEx</span>(<a href="#7f3442b679fa07aa" class="i field">_wsManShellOperationHandle</a>,
                    0,
                    <a href="BaseTransportManager.cs.html#48f7345377e9fbe3" class="i property">PowershellInstanceId</a>.<span class="i">ToString</span>().<span class="i">ToUpperInvariant</span>(),
                    <span class="i">IntPtr</span>.<span class="i">Zero</span>,
                    <span class="i">IntPtr</span>.<span class="i">Zero</span>,
                    <a href="#bbb8fa736fe480fa" class="i field">_connectCmdCompleted</a>,
                    <b>ref</b> <a href="#01c2414243976ea8" class="i field">_wsManCmdOperationHandle</a>);
            }
 
            <b>if</b> (<a href="#01c2414243976ea8" class="i field">_wsManCmdOperationHandle</a> == <span class="i">IntPtr</span>.<span class="i">Zero</span>)
            {
                <a href="../common/remotingexceptions.cs.html#0bb8687f97d91059" class="t t">PSRemotingTransportException</a> <span id="r273 rd" class="r273 r">e</span> = <b>new</b> <span class="t">PSRemotingTransportException</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">RunShellCommandExFailed</span>);
                <a href="BaseTransportManager.cs.html#7e70b34f9332dfcd" class="t t">TransportErrorOccuredEventArgs</a> <span id="r274 rd" class="r274 r">eventargs</span> =
                    <b>new</b> <a href="BaseTransportManager.cs.html#c420864940871a42" class="t constructor">TransportErrorOccuredEventArgs</a>(<span class="r273 r">e</span>, <a href="BaseTransportManager.cs.html#33678df914ca9daf" class="t t">TransportMethodEnum</a>.<a href="BaseTransportManager.cs.html#2166b6b8302add46" class="i field">ConnectShellCommandEx</a>);
                <a href="#644a9db700d6cbba" class="i method">ProcessWSManTransportError</a>(<span class="r274 r">eventargs</span>);
                <b>return</b>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="../common/remotingexceptions.cs.html#0bb8687f97d91059" class="t t">PSRemotingTransportException</a><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> WSManRunShellCommandEx failed.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>internal override void</b> <a id="7fe24ffc2ab0ff03" href="../../../R/7fe24ffc2ab0ff03.html" target="n" data-glyph="74,1" class="i method">CreateAsync</a>()
        {
            <b>byte</b>[] <span id="r275 rd" class="r275 r">cmdPart1</span> = <a href="BaseTransportManager.cs.html#f0864e0c2b75fa58" class="i field">serializedPipeline</a>.<a href="../common/fragmentor.cs.html#0020501682242305" class="i method">ReadOrRegisterCallback</a>(<b>null</b>);
            <b>if</b> (<span class="r275 r">cmdPart1</span> != <b>null</b>)
            {
                <span class="k preprocess">#</span><span class="k preprocess">region</span> SHIM: Redirection code for command code send.
 
                <b>bool</b> <span id="r276 rd" class="r276 r">sendContinue</span> = <b>true</b>;
 
                <b>if</b> (<a href="#257722f0ce4982a3" class="i field">s_commandCodeSendRedirect</a> != <b>null</b>)
                {
                    <b>object</b>[] <span id="r277 rd" class="r277 r">arguments</span> = <b>new</b> <b>object</b>[2] { <b>null</b>, <span class="r275 r">cmdPart1</span> };
                    <span class="r276 r">sendContinue</span> = (<b>bool</b>)<a href="#257722f0ce4982a3" class="i field">s_commandCodeSendRedirect</a>.<span class="i">DynamicInvoke</span>(<span class="r277 r">arguments</span>);
                    <span class="r275 r">cmdPart1</span> = (<b>byte</b>[])<span class="r277 r">arguments</span>[0];
                }
 
                <b>if</b> (!<span class="r276 r">sendContinue</span>)
                    <b>return</b>;
 
                <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
                <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#65e6a5b9a30e36c9" class="t t">WSManCommandArgSet</a> <span id="r278 rd" class="r278 r">argSet</span> = <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#5e6d9f2730be4090" class="t constructor">WSManCommandArgSet</a>(<span class="r275 r">cmdPart1</span>);
 
                <span class="c">// create cmdContextId</span>
                <a href="#cc02a8a8120dfe1d" class="i field">_cmdContextId</a> = <a href="#9220b9e7f82bd293" class="i method">GetNextCmdTMHandleId</a>();
                <a href="#f6b7255c7915d853" class="i method">AddCmdTransportManager</a>(<a href="#cc02a8a8120dfe1d" class="i field">_cmdContextId</a>, <a href="#b521a47ccd5a3cc1" class="k">this</a>);
 
                <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(
                    <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#329e9e85c0cfb782" class="i field">WSManCreateCommand</a>,
                    <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#a0f7cf0d4987790f" class="i field">Connect</a>,
                    <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#752e56066810e4f0" class="i field">CreateRunspace</a>,
                    <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#c5d4a73b62c859ab" class="i field">Transport</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                    <a href="BaseTransportManager.cs.html#6b69cd5f8cc06fb7" class="i property">RunspacePoolInstanceId</a>.<span class="i">ToString</span>(),
                    <a href="BaseTransportManager.cs.html#5485ee84e1e3c04d" class="i field">powershellInstanceId</a>.<span class="i">ToString</span>());
 
                <a href="#fd406ac145167469" class="i field">_createCmdCompleted</a> = <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#d3c47769c10efcdb" class="t constructor">WSManShellAsync</a>(<b>new</b> <span class="i">IntPtr</span>(<a href="#cc02a8a8120dfe1d" class="i field">_cmdContextId</a>), <a href="#791db9e5c67329dd" class="i field">s_cmdCreateCallback</a>);
                <a href="#b2d3f4d9ad24a224" class="i field">_createCmdCompletedGCHandle</a> = <span class="i">GCHandle</span>.<span class="i">Alloc</span>(<a href="#fd406ac145167469" class="i field">_createCmdCompleted</a>);
                <a href="#ce0cc9b6aa97e797" class="i field">_reconnectCmdCompleted</a> = <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#d3c47769c10efcdb" class="t constructor">WSManShellAsync</a>(<b>new</b> <span class="i">IntPtr</span>(<a href="#cc02a8a8120dfe1d" class="i field">_cmdContextId</a>), <a href="#01d87a006497a3a0" class="i field">s_cmdReconnectCallback</a>);
 
                <b>using</b> (<span class="r278 r">argSet</span>)
                {
                    <b>lock</b> (<a href="BaseTransportManager.cs.html#2b6037d6b3777ca1" class="i field">syncObject</a>)
                    {
                        <b>if</b> (!<a href="BaseTransportManager.cs.html#76271338de46dcf0" class="i field">isClosed</a>)
                        {
                            <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<span class="i">WSManRunShellCommandEx</span>(<a href="#7f3442b679fa07aa" class="i field">_wsManShellOperationHandle</a>,
                                0,
                                <a href="BaseTransportManager.cs.html#48f7345377e9fbe3" class="i property">PowershellInstanceId</a>.<span class="i">ToString</span>().<span class="i">ToUpperInvariant</span>(),
                                <span class="c">// WSManRunsShellCommand doesn&#39;t accept empty string &quot;&quot;.</span>
                                (<a href="#2acc5938101a87dc" class="i field">_cmdLine</a> == <b>null</b> || <a href="#2acc5938101a87dc" class="i field">_cmdLine</a>.<span class="i">Length</span> == 0) ? <span class="s">&quot; &quot;</span> : (<a href="#2acc5938101a87dc" class="i field">_cmdLine</a>.<span class="i">Length</span> &lt;= 256 ? <a href="#2acc5938101a87dc" class="i field">_cmdLine</a> : <a href="#2acc5938101a87dc" class="i field">_cmdLine</a>.<span class="i">Substring</span>(0, 255)),
                                <span class="r278 r">argSet</span>,
                                <span class="i">IntPtr</span>.<span class="i">Zero</span>,
                                <a href="#fd406ac145167469" class="i field">_createCmdCompleted</a>,
                                <b>ref</b> <a href="#01c2414243976ea8" class="i field">_wsManCmdOperationHandle</a>);
 
                            <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<span class="i">WriteLine</span>(<span class="s">&quot;Started cmd with command context : {0} Operation context: {1}&quot;</span>, <a href="#cc02a8a8120dfe1d" class="i field">_cmdContextId</a>, <a href="#01c2414243976ea8" class="i field">_wsManCmdOperationHandle</a>);
                        }
                    }
                }
            }
 
            <b>if</b> (<a href="#01c2414243976ea8" class="i field">_wsManCmdOperationHandle</a> == <span class="i">IntPtr</span>.<span class="i">Zero</span>)
            {
                <a href="../common/remotingexceptions.cs.html#0bb8687f97d91059" class="t t">PSRemotingTransportException</a> <span id="r279 rd" class="r279 r">e</span> = <b>new</b> <span class="t">PSRemotingTransportException</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">RunShellCommandExFailed</span>);
                <a href="BaseTransportManager.cs.html#7e70b34f9332dfcd" class="t t">TransportErrorOccuredEventArgs</a> <span id="r280 rd" class="r280 r">eventargs</span> =
                    <b>new</b> <a href="BaseTransportManager.cs.html#c420864940871a42" class="t constructor">TransportErrorOccuredEventArgs</a>(<span class="r279 r">e</span>, <a href="BaseTransportManager.cs.html#33678df914ca9daf" class="t t">TransportMethodEnum</a>.<a href="BaseTransportManager.cs.html#5d183ac69af9da42" class="i field">RunShellCommandEx</a>);
                <a href="#644a9db700d6cbba" class="i method">ProcessWSManTransportError</a>(<span class="r280 r">eventargs</span>);
                <b>return</b>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Restores connection on a disconnected command.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal override void</b> <a id="414531febf62fd21" href="../../../R/414531febf62fd21.html" target="n" data-glyph="74,1" class="i method">ReconnectAsync</a>()
        {
            <a href="BaseTransportManager.cs.html#766c6c998b78695f" class="i property">ReceivedDataCollection</a>.<a href="PriorityCollection.cs.html#a8845745894768de" class="i method">PrepareForStreamConnect</a>();
            <b>lock</b> (<a href="BaseTransportManager.cs.html#2b6037d6b3777ca1" class="i field">syncObject</a>)
            {
                <b>if</b> (<a href="BaseTransportManager.cs.html#76271338de46dcf0" class="i field">isClosed</a>)
                {
                    <b>return</b>;
                }
 
                <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#6225288ac5e2c374" class="i method">WSManReconnectShellCommandEx</a>(<a href="#01c2414243976ea8" class="i field">_wsManCmdOperationHandle</a>, 0, <a href="#ce0cc9b6aa97e797" class="i field">_reconnectCmdCompleted</a>);
            }
        }
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Used by powershell/pipeline to send a stop message to the server command.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal override void</b> <a id="b4aaead610683afb" href="../../../R/b4aaead610683afb.html" target="n" data-glyph="74,1" class="i method">SendStopSignal</a>()
        {
            <b>lock</b> (<a href="BaseTransportManager.cs.html#2b6037d6b3777ca1" class="i field">syncObject</a>)
            {
                <b>if</b> (<a href="BaseTransportManager.cs.html#76271338de46dcf0" class="i field">isClosed</a>)
                {
                    <b>return</b>;
                }
 
                <span class="c">// WSMan API do not allow a signal/input/receive be sent until RunShellCommand is</span>
                <span class="c">// successful (ie., callback is received)..so note that a signal is to be sent</span>
                <span class="c">// here and return.</span>
                <b>if</b> (!<a href="#f46e93b97317819a" class="i field">_isCreateCallbackReceived</a>)
                {
                    <a href="#f7f1092d9ea3a343" class="i field">_isStopSignalPending</a> = <b>true</b>;
                    <b>return</b>;
                }
                <span class="c">// we are about to send a signal..so clear pending bit.</span>
                <a href="#f7f1092d9ea3a343" class="i field">_isStopSignalPending</a> = <b>false</b>;
 
                <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<span class="i">WriteLine</span>(<span class="s">&quot;Sending stop signal with command context: {0} Operation Context {1}&quot;</span>, <a href="#cc02a8a8120dfe1d" class="i field">_cmdContextId</a>, <a href="#01c2414243976ea8" class="i field">_wsManCmdOperationHandle</a>);
                <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(
                    <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#fc7bf47ac7e81c7f" class="i field">WSManSignal</a>,
                    <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#f3d85cb80e62fe3e" class="i field">Disconnect</a>,
                    <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                    <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#c5d4a73b62c859ab" class="i field">Transport</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                    <a href="BaseTransportManager.cs.html#6b69cd5f8cc06fb7" class="i property">RunspacePoolInstanceId</a>.<span class="i">ToString</span>(),
                    <a href="BaseTransportManager.cs.html#5485ee84e1e3c04d" class="i field">powershellInstanceId</a>.<span class="i">ToString</span>(),
                    <a href="#3e86351ee0864842" class="i field">StopSignal</a>);
 
                <a href="#116efb269d3cd8af" class="i field">_signalCmdCompleted</a> = <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#d3c47769c10efcdb" class="t constructor">WSManShellAsync</a>(<b>new</b> <span class="i">IntPtr</span>(<a href="#cc02a8a8120dfe1d" class="i field">_cmdContextId</a>), <a href="#d91b8166471d7716" class="i field">s_cmdSignalCallback</a>);
                <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#1548b6cc07cef71b" class="i method">WSManSignalShellEx</a>(<a href="#7f3442b679fa07aa" class="i field">_wsManShellOperationHandle</a>, <a href="#01c2414243976ea8" class="i field">_wsManCmdOperationHandle</a>, 0,
                    <a href="#3e86351ee0864842" class="i field">StopSignal</a>, <a href="#116efb269d3cd8af" class="i field">_signalCmdCompleted</a>, <b>ref</b> <a href="#dba133100f83c727" class="i field">_cmdSignalOperationHandle</a>);
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Closes the pending Create,Send,Receive operations and then closes the shell and release all the resources.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal override void</b> <a id="e9c84ed065216b63" href="../../../R/e9c84ed065216b63.html" target="n" data-glyph="74,1" class="i method">CloseAsync</a>()
        {
            <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<span class="i">WriteLine</span>(<span class="s">&quot;Closing command with command context: {0} Operation Context {1}&quot;</span>, <a href="#cc02a8a8120dfe1d" class="i field">_cmdContextId</a>, <a href="#01c2414243976ea8" class="i field">_wsManCmdOperationHandle</a>);
 
            <b>bool</b> <span id="r281 rd" class="r281 r">shouldRaiseCloseCompleted</span> = <b>false</b>;
            <span class="c">// then let other threads release the lock before we cleaning up the resources.</span>
            <b>lock</b> (<a href="BaseTransportManager.cs.html#2b6037d6b3777ca1" class="i field">syncObject</a>)
            {
                <b>if</b> (<a href="BaseTransportManager.cs.html#76271338de46dcf0" class="i field">isClosed</a>)
                {
                    <b>return</b>;
                }
 
                <span class="c">// first change the state..so other threads</span>
                <span class="c">// will know that we are closing.</span>
                <a href="BaseTransportManager.cs.html#76271338de46dcf0" class="i field">isClosed</a> = <b>true</b>;
 
                <span class="c">// There is no valid cmd operation handle..so just</span>
                <span class="c">// raise close completed.</span>
                <b>if</b> (<a href="#01c2414243976ea8" class="i field">_wsManCmdOperationHandle</a> == <span class="i">IntPtr</span>.<span class="i">Zero</span>)
                {
                    <span class="r281 r">shouldRaiseCloseCompleted</span> = <b>true</b>;
                }
            }
 
            <a href="BaseTransportManager.cs.html#fa455a694094fdc2" class="k">base</a>.<a href="BaseTransportManager.cs.html#8487786a35819f66" class="i method">CloseAsync</a>();
 
            <b>if</b> (<span class="r281 r">shouldRaiseCloseCompleted</span>)
            {
                <b>try</b>
                {
                    <a href="BaseTransportManager.cs.html#ce72d08b48a8f70f" class="i method">RaiseCloseCompleted</a>();
                }
                <b>finally</b>
                {
                    <a href="#418e9c4131f8cf69" class="i method">RemoveCmdTransportManager</a>(<a href="#cc02a8a8120dfe1d" class="i field">_cmdContextId</a>);
                }
 
                <b>return</b>;
            }
 
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(
                <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#3526c72eedb5e7e7" class="i field">WSManCloseCommand</a>,
                <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#f3d85cb80e62fe3e" class="i field">Disconnect</a>,
                <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#c5d4a73b62c859ab" class="i field">Transport</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                <a href="BaseTransportManager.cs.html#6b69cd5f8cc06fb7" class="i property">RunspacePoolInstanceId</a>.<span class="i">ToString</span>(),
                <a href="BaseTransportManager.cs.html#5485ee84e1e3c04d" class="i field">powershellInstanceId</a>.<span class="i">ToString</span>());
            <a href="#c98a52d310bc6bbf" class="i field">_closeCmdCompleted</a> = <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#d3c47769c10efcdb" class="t constructor">WSManShellAsync</a>(<b>new</b> <span class="i">IntPtr</span>(<a href="#cc02a8a8120dfe1d" class="i field">_cmdContextId</a>), <a href="#5a3b1d30e4629a22" class="i field">s_cmdCloseCallback</a>);
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>((<span class="i">IntPtr</span>)<a href="#c98a52d310bc6bbf" class="i field">_closeCmdCompleted</a> != <span class="i">IntPtr</span>.<span class="i">Zero</span>, <span class="s">&quot;closeCmdCompleted callback is null in cmdTM.CloseAsync()&quot;</span>);
            <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#e17d44a476e64fa2" class="i method">WSManCloseCommand</a>(<a href="#01c2414243976ea8" class="i field">_wsManCmdOperationHandle</a>, 0, <a href="#c98a52d310bc6bbf" class="i field">_closeCmdCompleted</a>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Handle transport error - calls EnqueueAndStartProcessingThread to process transport exception</span>
        <span class="c">///</span><span class="c"> in a different thread</span>
        <span class="c">///</span><span class="c"> Logic in transport callbacks should always use this to process a transport error.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="644a9db700d6cbba" href="../../../R/644a9db700d6cbba.html" target="n" data-glyph="74,1" class="i method">ProcessWSManTransportError</a>(<a href="BaseTransportManager.cs.html#7e70b34f9332dfcd" class="t t">TransportErrorOccuredEventArgs</a> <span id="r282 rd" class="r282 r">eventArgs</span>)
        {
            <a href="BaseTransportManager.cs.html#a152fe644f7ae9c1" class="i method">EnqueueAndStartProcessingThread</a>(<b>null</b>, <span class="r282 r">eventArgs</span>, <b>null</b>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Log the error message in the Crimson logger and raise error handler.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r283 r">eventArgs</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal override void</b> <a id="c45bcdb8dc06666f" href="../../../R/c45bcdb8dc06666f.html" target="n" data-glyph="74,1" class="i method">RaiseErrorHandler</a>(<a href="BaseTransportManager.cs.html#7e70b34f9332dfcd" class="t t">TransportErrorOccuredEventArgs</a> <span id="r283 rd" class="r283 r">eventArgs</span>)
        {
            <span class="c">// Look for a valid stack trace.</span>
            <b>string</b> <span id="r284 rd" class="r284 r">stackTrace</span>;
            <b>if</b> (!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r283 r">eventArgs</span>.<a href="BaseTransportManager.cs.html#f82124202b7ff8f0" class="i property">Exception</a>.<span class="i">StackTrace</span>))
            {
                <span class="r284 r">stackTrace</span> = <span class="r283 r">eventArgs</span>.<a href="BaseTransportManager.cs.html#f82124202b7ff8f0" class="i property">Exception</a>.<span class="i">StackTrace</span>;
            }
            <b>else</b> <b>if</b> (<span class="r283 r">eventArgs</span>.<a href="BaseTransportManager.cs.html#f82124202b7ff8f0" class="i property">Exception</a>.<span class="i">InnerException</span> != <b>null</b> &amp;&amp;
                     !<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r283 r">eventArgs</span>.<a href="BaseTransportManager.cs.html#f82124202b7ff8f0" class="i property">Exception</a>.<span class="i">InnerException</span>.<span class="i">StackTrace</span>))
            {
                <span class="r284 r">stackTrace</span> = <span class="r283 r">eventArgs</span>.<a href="BaseTransportManager.cs.html#f82124202b7ff8f0" class="i property">Exception</a>.<span class="i">InnerException</span>.<span class="i">StackTrace</span>;
            }
            <b>else</b>
            {
                <span class="r284 r">stackTrace</span> = <b>string</b>.<span class="i">Empty</span>;
            }
 
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogOperationalError</span>(
                <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#4ddb36cebdb0b70c" class="i field">TransportError</a>, <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#399fd86ea109ec79" class="i field">Open</a>, <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#05d709c2010b41d5" class="i field">UseAlwaysOperational</a>,
                <a href="BaseTransportManager.cs.html#6b69cd5f8cc06fb7" class="i property">RunspacePoolInstanceId</a>.<span class="i">ToString</span>(),
                <a href="BaseTransportManager.cs.html#5485ee84e1e3c04d" class="i field">powershellInstanceId</a>.<span class="i">ToString</span>(),
                <span class="r283 r">eventArgs</span>.<a href="BaseTransportManager.cs.html#f82124202b7ff8f0" class="i property">Exception</a>.<a href="../common/remotingexceptions.cs.html#f96218464c4b7244" class="i property">ErrorCode</a>.<span class="i">ToString</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>),
                <span class="r283 r">eventArgs</span>.<a href="BaseTransportManager.cs.html#f82124202b7ff8f0" class="i property">Exception</a>.<span class="i">Message</span>,
                <span class="r284 r">stackTrace</span>);
 
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticError</span>(
                <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#f50b10cdf9431275" class="i field">TransportError_Analytic</a>, <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#399fd86ea109ec79" class="i field">Open</a>, <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#c5d4a73b62c859ab" class="i field">Transport</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                <a href="BaseTransportManager.cs.html#6b69cd5f8cc06fb7" class="i property">RunspacePoolInstanceId</a>.<span class="i">ToString</span>(),
                <a href="BaseTransportManager.cs.html#5485ee84e1e3c04d" class="i field">powershellInstanceId</a>.<span class="i">ToString</span>(),
                <span class="r283 r">eventArgs</span>.<a href="BaseTransportManager.cs.html#f82124202b7ff8f0" class="i property">Exception</a>.<a href="../common/remotingexceptions.cs.html#f96218464c4b7244" class="i property">ErrorCode</a>.<span class="i">ToString</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>),
                <span class="r283 r">eventArgs</span>.<a href="BaseTransportManager.cs.html#f82124202b7ff8f0" class="i property">Exception</a>.<span class="i">Message</span>,
                <span class="r284 r">stackTrace</span>);
 
            <a href="BaseTransportManager.cs.html#fa455a694094fdc2" class="k">base</a>.<a href="BaseTransportManager.cs.html#8e00d8a2f8745652" class="i method">RaiseErrorHandler</a>(<span class="r283 r">eventArgs</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Used by ServicePendingCallbacks to give the control to derived classes for</span>
        <span class="c">///</span><span class="c"> processing data that the base class does not understand.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r285 r">privateData</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Derived class specific data to process. For command transport manager this</span>
        <span class="c">///</span><span class="c"> should be a boolean.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal override void</b> <a id="a30d5db96c2d7e8b" href="../../../R/a30d5db96c2d7e8b.html" target="n" data-glyph="74,1" class="i method">ProcessPrivateData</a>(<b>object</b> <span id="r285 rd" class="r285 r">privateData</span>)
        {
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r285 r">privateData</span> != <b>null</b>, <span class="s">&quot;privateData cannot be null.&quot;</span>);
 
            <span class="c">// For this version...only a boolean can be used for privateData.</span>
            <b>bool</b> <span id="r286 rd" class="r286 r">shouldRaiseSignalCompleted</span> = (<b>bool</b>)<span class="r285 r">privateData</span>;
            <b>if</b> (<span class="r286 r">shouldRaiseSignalCompleted</span>)
            {
                <a href="BaseTransportManager.cs.html#fa455a694094fdc2" class="k">base</a>.<a href="BaseTransportManager.cs.html#4760a0a217eace5a" class="i method">RaiseSignalCompleted</a>();
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Receive/send operation handles and callback handles should be released/disposed from</span>
        <span class="c">///</span><span class="c"> receive/send callback only. Releasing them after CloseOperation() may not cover all</span>
        <span class="c">///</span><span class="c"> the scenarios, as WSMan does not guarantee that a rcv/send callback is not called after</span>
        <span class="c">///</span><span class="c"> Close completed callback.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r287 r">flags</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r288 r">shouldClearSend</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="315a616bfbc19c81" href="../../../R/315a616bfbc19c81.html" target="n" data-glyph="74,1" class="i method">ClearReceiveOrSendResources</a>(<b>int</b> <span id="r287 rd" class="r287 r">flags</span>, <b>bool</b> <span id="r288 rd" class="r288 r">shouldClearSend</span>)
        {
            <b>if</b> (<span class="r288 r">shouldClearSend</span>)
            {
                <b>if</b> (<a href="#7a925c9a2ffed390" class="i field">_sendToRemoteCompleted</a> != <b>null</b>)
                {
                    <a href="#7a925c9a2ffed390" class="i field">_sendToRemoteCompleted</a>.<a href="WSManNativeAPI.cs.html#c68800d727cb6a45" class="i method">Dispose</a>();
                    <a href="#7a925c9a2ffed390" class="i field">_sendToRemoteCompleted</a> = <b>null</b>;
                }
 
                <span class="c">// For send..clear always</span>
                <b>if</b> (<a href="#e0b96634e6e04f20" class="i field">_wsManSendOperationHandle</a> != <span class="i">IntPtr</span>.<span class="i">Zero</span>)
                {
                    <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#96b121ea122bb25a" class="i method">WSManCloseOperation</a>(<a href="#e0b96634e6e04f20" class="i field">_wsManSendOperationHandle</a>, 0);
                    <a href="#e0b96634e6e04f20" class="i field">_wsManSendOperationHandle</a> = <span class="i">IntPtr</span>.<span class="i">Zero</span>;
                }
            }
            <b>else</b>
            {
                <span class="c">// clearing for receive..Clear only when the end of operation is reached.</span>
                <b>if</b> (<span class="r287 r">flags</span> == (<b>int</b>)<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#4b939349c4d4b263" class="t t">WSManCallbackFlags</a>.<a href="WSManNativeAPI.cs.html#e14d6bd19f5d1f34" class="i field">WSMAN_FLAG_CALLBACK_END_OF_OPERATION</a>)
                {
                    <b>if</b> (<a href="#aaeb079bf1222e92" class="i field">_wsManReceiveOperationHandle</a> != <span class="i">IntPtr</span>.<span class="i">Zero</span>)
                    {
                        <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#96b121ea122bb25a" class="i method">WSManCloseOperation</a>(<a href="#aaeb079bf1222e92" class="i field">_wsManReceiveOperationHandle</a>, 0);
                        <a href="#aaeb079bf1222e92" class="i field">_wsManReceiveOperationHandle</a> = <span class="i">IntPtr</span>.<span class="i">Zero</span>;
                    }
 
                    <b>if</b> (<a href="#fec5609dcdeafac8" class="i field">_receivedFromRemote</a> != <b>null</b>)
                    {
                        <a href="#fec5609dcdeafac8" class="i field">_receivedFromRemote</a>.<a href="WSManNativeAPI.cs.html#c68800d727cb6a45" class="i method">Dispose</a>();
                        <a href="#fec5609dcdeafac8" class="i field">_receivedFromRemote</a> = <b>null</b>;
                    }
                }
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Method to have transport prepare for a disconnect operation.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal override void</b> <a id="8f920a2c870ef396" href="../../../R/8f920a2c870ef396.html" target="n" data-glyph="74,1" class="i method">PrepareForDisconnect</a>()
        {
            <a href="#5d59ea7e64b6101f" class="i field">_isDisconnectPending</a> = <b>true</b>;
 
            <span class="c">// If there is not input processing and the command has already been created</span>
            <span class="c">// on the server then this object is ready for Disconnect now.</span>
            <span class="c">// Otherwise let the sending input data call back handle it.</span>
            <b>if</b> (<a href="#b521a47ccd5a3cc1" class="k">this</a>.<a href="BaseTransportManager.cs.html#76271338de46dcf0" class="i field">isClosed</a> || <a href="#8f171b9d04bc2973" class="i field">_isDisconnectedOnInvoke</a> ||
                (<a href="#f46e93b97317819a" class="i field">_isCreateCallbackReceived</a> &amp;&amp;
                 <a href="#b521a47ccd5a3cc1" class="k">this</a>.<a href="BaseTransportManager.cs.html#f0864e0c2b75fa58" class="i field">serializedPipeline</a>.<a href="../common/fragmentor.cs.html#d22c9d5a8be2214d" class="i property">Length</a> == 0 &amp;&amp;
                 !<a href="#7ceeeb92886e32b9" class="i field">_isSendingInput</a>))
            {
                <a href="BaseTransportManager.cs.html#d740e262e7f09e2e" class="i method">RaiseReadyForDisconnect</a>();
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Method to resume post disconnect operations.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal override void</b> <a id="eeee4bcff54371f9" href="../../../R/eeee4bcff54371f9.html" target="n" data-glyph="74,1" class="i method">PrepareForConnect</a>()
        {
            <a href="#5d59ea7e64b6101f" class="i field">_isDisconnectPending</a> = <b>false</b>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Callbacks from WSMan
 
        <span class="c">// callback that gets called when WSManRunShellCommandEx returns.</span>
        <b>private static void</b> <a id="7c8d2f473b5c952b" href="../../../R/7c8d2f473b5c952b.html" target="n" data-glyph="76,1" class="i method">OnCreateCmdCompleted</a>(<span class="i">IntPtr</span> <span id="r289 rd" class="r289 r">operationContext</span>,
            <b>int</b> <span id="r290 rd" class="r290 r">flags</span>,
            <span class="i">IntPtr</span> <span id="r291 rd" class="r291 r">error</span>,
            <span class="i">IntPtr</span> <span id="r292 rd" class="r292 r">shellOperationHandle</span>,
            <span class="i">IntPtr</span> <span id="r293 rd" class="r293 r">commandOperationHandle</span>,
            <span class="i">IntPtr</span> <span id="r294 rd" class="r294 r">operationHandle</span>,
            <span class="i">IntPtr</span> <span id="r295 rd" class="r295 r">data</span>)
        {
            <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<a href="../../../utils/StructuredTraceSource.cs.html#96aaf3813a5962a0" class="i method">WriteLine</a>(<span class="s">&quot;OnCreateCmdCompleted callback received&quot;</span>);
 
            <b>long</b> <span id="r296 rd" class="r296 r">cmdContextId</span> = 0;
            <a href="#b521a47ccd5a3cc1" class="t t">WSManClientCommandTransportManager</a> <span id="r297 rd" class="r297 r">cmdTM</span> = <b>null</b>;
            <b>if</b> (!<a href="#90d601185c5a5777" class="i method">TryGetCmdTransportManager</a>(<span class="r289 r">operationContext</span>, <b>out</b> <span class="r297 r">cmdTM</span>, <b>out</b> <span class="r296 r">cmdContextId</span>))
            {
                <span class="c">// We dont have the command TM handle..just return.</span>
                <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<a href="../../../utils/StructuredTraceSource.cs.html#25fe29b46cfb1e10" class="i method">WriteLine</a>(<span class="s">&quot;OnCreateCmdCompleted: Unable to find a transport manager for the command context {0}.&quot;</span>, <span class="r296 r">cmdContextId</span>);
                <b>return</b>;
            }
 
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(
                <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#598416e68b47d104" class="i field">WSManCreateCommandCallbackReceived</a>,
                <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#a0f7cf0d4987790f" class="i field">Connect</a>,
                <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#c5d4a73b62c859ab" class="i field">Transport</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                <span class="r297 r">cmdTM</span>.<a href="BaseTransportManager.cs.html#6b69cd5f8cc06fb7" class="i property">RunspacePoolInstanceId</a>.<span class="i">ToString</span>(),
                <span class="r297 r">cmdTM</span>.<a href="BaseTransportManager.cs.html#5485ee84e1e3c04d" class="i field">powershellInstanceId</a>.<span class="i">ToString</span>());
 
            <span class="c">// dispose the cmdCompleted callback as it is not needed any more</span>
            <b>if</b> (<span class="r297 r">cmdTM</span>.<a href="#fd406ac145167469" class="i field">_createCmdCompleted</a> != <b>null</b>)
            {
                <span class="r297 r">cmdTM</span>.<a href="#b2d3f4d9ad24a224" class="i field">_createCmdCompletedGCHandle</a>.<span class="i">Free</span>();
                <span class="r297 r">cmdTM</span>.<a href="#fd406ac145167469" class="i field">_createCmdCompleted</a>.<a href="WSManNativeAPI.cs.html#c68800d727cb6a45" class="i method">Dispose</a>();
                <span class="r297 r">cmdTM</span>.<a href="#fd406ac145167469" class="i field">_createCmdCompleted</a> = <b>null</b>;
            }
 
            <span class="c">// TODO: 188098 wsManCmdOperationHandle should be populated by WSManRunShellCommandEx,</span>
            <span class="c">// but there is a thread timing bug in WSMan layer causing the callback to</span>
            <span class="c">// be called before WSManRunShellCommandEx returns. since we already validated the</span>
            <span class="c">// cmd context exists, safely assigning the commandOperationHandle to cmd transport manager.</span>
            <span class="c">// Remove this once WSMan fixes its code.</span>
            <span class="r297 r">cmdTM</span>.<a href="#01c2414243976ea8" class="i field">_wsManCmdOperationHandle</a> = <span class="r293 r">commandOperationHandle</span>;
 
            <b>if</b> (<span class="r291 r">error</span> != <span class="i">IntPtr</span>.<span class="i">Zero</span>)
            {
                <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#587a4e1f26edb30b" class="t t">WSManError</a> <span id="r298 rd" class="r298 r">errorStruct</span> = <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#587a4e1f26edb30b" class="t t">WSManError</a>.<a href="WSManNativeAPI.cs.html#0577f3d9734092d0" class="i method">UnMarshal</a>(<span class="r291 r">error</span>);
                <b>if</b> (<span class="r298 r">errorStruct</span>.<a href="WSManNativeAPI.cs.html#3bfbb0e97567321f" class="i field">errorCode</a> != 0)
                {
                    <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<a href="../../../utils/StructuredTraceSource.cs.html#25b8416175e53218" class="i method">WriteLine</a>(<span class="s">&quot;OnCreateCmdCompleted callback: WSMan reported an error: {0}&quot;</span>, <span class="r298 r">errorStruct</span>.<a href="WSManNativeAPI.cs.html#5497bacefa3538a3" class="i field">errorDetail</a>);
 
                    <a href="BaseTransportManager.cs.html#7e70b34f9332dfcd" class="t t">TransportErrorOccuredEventArgs</a> <span id="r299 rd" class="r299 r">eventargs</span> = <a href="#b4291df75d9bc408" class="t t">WSManTransportManagerUtils</a>.<span class="i">ConstructTransportErrorEventArgs</span>(
                        <span class="r297 r">cmdTM</span>.<a href="#c75759e8604f93da" class="i field">_sessnTm</a>.<a href="#7616e1c5a9b266f9" class="i property">WSManAPIData</a>.<a href="#f386d97c12d99137" class="i property">WSManAPIHandle</a>,
                        <b>null</b>,
                        <span class="r298 r">errorStruct</span>,
                        <a href="BaseTransportManager.cs.html#33678df914ca9daf" class="t t">TransportMethodEnum</a>.<a href="BaseTransportManager.cs.html#5d183ac69af9da42" class="i field">RunShellCommandEx</a>,
                        <span class="i">RemotingErrorIdStrings</span>.<span class="i">RunShellCommandExCallBackError</span>,
                         <b>new</b> <b>object</b>[] { <a href="#b4291df75d9bc408" class="t t">WSManTransportManagerUtils</a>.<a href="#95feb8ba0fde2a13" class="i method">ParseEscapeWSManErrorMessage</a>(<span class="r298 r">errorStruct</span>.<a href="WSManNativeAPI.cs.html#5497bacefa3538a3" class="i field">errorDetail</a>) });
                    <span class="r297 r">cmdTM</span>.<a href="#644a9db700d6cbba" class="i method">ProcessWSManTransportError</a>(<span class="r299 r">eventargs</span>);
 
                    <b>return</b>;
                }
            }
 
            <span class="c">// Send remaining cmd / parameter fragments.</span>
            <b>lock</b> (<span class="r297 r">cmdTM</span>.<a href="BaseTransportManager.cs.html#2b6037d6b3777ca1" class="i field">syncObject</a>)
            {
                <span class="r297 r">cmdTM</span>.<a href="#f46e93b97317819a" class="i field">_isCreateCallbackReceived</a> = <b>true</b>;
 
                <span class="c">// make sure the transport is not closed yet.</span>
                <b>if</b> (<span class="r297 r">cmdTM</span>.<a href="BaseTransportManager.cs.html#76271338de46dcf0" class="i field">isClosed</a>)
                {
                    <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<a href="../../../utils/StructuredTraceSource.cs.html#96aaf3813a5962a0" class="i method">WriteLine</a>(<span class="s">&quot;Client Session TM: Transport manager is closed. So returning&quot;</span>);
 
                    <b>if</b> (<span class="r297 r">cmdTM</span>.<a href="#5d59ea7e64b6101f" class="i field">_isDisconnectPending</a>)
                    {
                        <span class="r297 r">cmdTM</span>.<a href="BaseTransportManager.cs.html#d740e262e7f09e2e" class="i method">RaiseReadyForDisconnect</a>();
                    }
 
                    <b>return</b>;
                }
 
                <span class="c">// If a disconnect is pending at this point then we should not start</span>
                <span class="c">// receiving data or sending input and let the disconnect take place.</span>
                <b>if</b> (<span class="r297 r">cmdTM</span>.<a href="#5d59ea7e64b6101f" class="i field">_isDisconnectPending</a>)
                {
                    <span class="r297 r">cmdTM</span>.<a href="BaseTransportManager.cs.html#d740e262e7f09e2e" class="i method">RaiseReadyForDisconnect</a>();
                    <b>return</b>;
                }
 
                <b>if</b> (<span class="r297 r">cmdTM</span>.<a href="BaseTransportManager.cs.html#f0864e0c2b75fa58" class="i field">serializedPipeline</a>.<a href="../common/fragmentor.cs.html#d22c9d5a8be2214d" class="i property">Length</a> == 0)
                {
                    <span class="r297 r">cmdTM</span>.<a href="#27a16a3a5f5c884a" class="i field">_shouldStartReceivingData</a> = <b>true</b>;
                }
 
                <span class="c">// Start sending data if any..and see if we can initiate a receive.</span>
                <span class="r297 r">cmdTM</span>.<a href="#bcb75c1688eea088" class="i method">SendOneItem</a>();
 
                <span class="c">// WSMan API does not allow a signal/input/receive be sent until RunShellCommand is</span>
                <span class="c">// successful (ie., callback is received)</span>
                <b>if</b> (<span class="r297 r">cmdTM</span>.<a href="#f7f1092d9ea3a343" class="i field">_isStopSignalPending</a>)
                {
                    <span class="r297 r">cmdTM</span>.<a href="#b4aaead610683afb" class="i method">SendStopSignal</a>();
                }
            }
        }
 
        <b>private static void</b> <a id="a5437ff482db0c24" href="../../../R/a5437ff482db0c24.html" target="n" data-glyph="76,1" class="i method">OnConnectCmdCompleted</a>(<span class="i">IntPtr</span> <span id="r300 rd" class="r300 r">operationContext</span>,
            <b>int</b> <span id="r301 rd" class="r301 r">flags</span>,
            <span class="i">IntPtr</span> <span id="r302 rd" class="r302 r">error</span>,
            <span class="i">IntPtr</span> <span id="r303 rd" class="r303 r">shellOperationHandle</span>,
            <span class="i">IntPtr</span> <span id="r304 rd" class="r304 r">commandOperationHandle</span>,
            <span class="i">IntPtr</span> <span id="r305 rd" class="r305 r">operationHandle</span>,
            <span class="i">IntPtr</span> <span id="r306 rd" class="r306 r">data</span>)
        {
            <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<a href="../../../utils/StructuredTraceSource.cs.html#96aaf3813a5962a0" class="i method">WriteLine</a>(<span class="s">&quot;OnConnectCmdCompleted callback received&quot;</span>);
 
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<a href="../../../utils/tracing/PSEtwLog.cs.html#bd7ee9e01b1b8117" class="i method">LogAnalyticInformational</a>(
                <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#598416e68b47d104" class="i field">WSManCreateCommandCallbackReceived</a>,
                <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#a0f7cf0d4987790f" class="i field">Connect</a>,
                <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#c5d4a73b62c859ab" class="i field">Transport</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                <span class="s">&quot;OnConnectCmdCompleted: OnConnectCmdCompleted callback received&quot;</span>);
 
            <b>long</b> <span id="r307 rd" class="r307 r">cmdContextId</span> = 0;
            <a href="#b521a47ccd5a3cc1" class="t t">WSManClientCommandTransportManager</a> <span id="r308 rd" class="r308 r">cmdTM</span> = <b>null</b>;
            <b>if</b> (!<a href="#90d601185c5a5777" class="i method">TryGetCmdTransportManager</a>(<span class="r300 r">operationContext</span>, <b>out</b> <span class="r308 r">cmdTM</span>, <b>out</b> <span class="r307 r">cmdContextId</span>))
            {
                <span class="c">// We dont have the command TM handle..just return.</span>
                <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<a href="../../../utils/StructuredTraceSource.cs.html#25fe29b46cfb1e10" class="i method">WriteLine</a>(<span class="s">&quot;OnConnectCmdCompleted: Unable to find a transport manager for the command context {0}.&quot;</span>, <span class="r307 r">cmdContextId</span>);
                <b>return</b>;
            }
 
            <span class="c">// dispose the cmdCompleted callback as it is not needed any more</span>
            <b>if</b> (<span class="r308 r">cmdTM</span>.<a href="#bbb8fa736fe480fa" class="i field">_connectCmdCompleted</a> != <b>null</b>)
            {
                <span class="r308 r">cmdTM</span>.<a href="#bbb8fa736fe480fa" class="i field">_connectCmdCompleted</a>.<a href="WSManNativeAPI.cs.html#c68800d727cb6a45" class="i method">Dispose</a>();
                <span class="r308 r">cmdTM</span>.<a href="#bbb8fa736fe480fa" class="i field">_connectCmdCompleted</a> = <b>null</b>;
            }
 
            <span class="r308 r">cmdTM</span>.<a href="#01c2414243976ea8" class="i field">_wsManCmdOperationHandle</a> = <span class="r304 r">commandOperationHandle</span>;
 
            <b>if</b> (<span class="r302 r">error</span> != <span class="i">IntPtr</span>.<span class="i">Zero</span>)
            {
                <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#587a4e1f26edb30b" class="t t">WSManError</a> <span id="r309 rd" class="r309 r">errorStruct</span> = <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#587a4e1f26edb30b" class="t t">WSManError</a>.<a href="WSManNativeAPI.cs.html#0577f3d9734092d0" class="i method">UnMarshal</a>(<span class="r302 r">error</span>);
                <b>if</b> (<span class="r309 r">errorStruct</span>.<a href="WSManNativeAPI.cs.html#3bfbb0e97567321f" class="i field">errorCode</a> != 0)
                {
                    <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<a href="../../../utils/StructuredTraceSource.cs.html#25b8416175e53218" class="i method">WriteLine</a>(<span class="s">&quot;OnConnectCmdCompleted callback: WSMan reported an error: {0}&quot;</span>, <span class="r309 r">errorStruct</span>.<a href="WSManNativeAPI.cs.html#5497bacefa3538a3" class="i field">errorDetail</a>);
 
                    <a href="BaseTransportManager.cs.html#7e70b34f9332dfcd" class="t t">TransportErrorOccuredEventArgs</a> <span id="r310 rd" class="r310 r">eventargs</span> = <a href="#b4291df75d9bc408" class="t t">WSManTransportManagerUtils</a>.<span class="i">ConstructTransportErrorEventArgs</span>(
                        <span class="r308 r">cmdTM</span>.<a href="#c75759e8604f93da" class="i field">_sessnTm</a>.<a href="#7616e1c5a9b266f9" class="i property">WSManAPIData</a>.<a href="#f386d97c12d99137" class="i property">WSManAPIHandle</a>,
                        <b>null</b>,
                        <span class="r309 r">errorStruct</span>,
                        <a href="BaseTransportManager.cs.html#33678df914ca9daf" class="t t">TransportMethodEnum</a>.<a href="BaseTransportManager.cs.html#6e302be1fed98601" class="i field">ReconnectShellCommandEx</a>,
                        <span class="i">RemotingErrorIdStrings</span>.<span class="i">ReconnectShellCommandExCallBackError</span>,
                         <b>new</b> <b>object</b>[] { <a href="#b4291df75d9bc408" class="t t">WSManTransportManagerUtils</a>.<a href="#95feb8ba0fde2a13" class="i method">ParseEscapeWSManErrorMessage</a>(<span class="r309 r">errorStruct</span>.<a href="WSManNativeAPI.cs.html#5497bacefa3538a3" class="i field">errorDetail</a>) });
                    <span class="r308 r">cmdTM</span>.<a href="#644a9db700d6cbba" class="i method">ProcessWSManTransportError</a>(<span class="r310 r">eventargs</span>);
 
                    <b>return</b>;
                }
            }
 
            <b>lock</b> (<span class="r308 r">cmdTM</span>.<a href="BaseTransportManager.cs.html#2b6037d6b3777ca1" class="i field">syncObject</a>)
            {
                <span class="c">// If the transport is already closed then we are done.</span>
                <b>if</b> (<span class="r308 r">cmdTM</span>.<a href="BaseTransportManager.cs.html#76271338de46dcf0" class="i field">isClosed</a>)
                {
                    <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<a href="../../../utils/StructuredTraceSource.cs.html#96aaf3813a5962a0" class="i method">WriteLine</a>(<span class="s">&quot;Client Session TM: Transport manager is closed. So returning&quot;</span>);
 
                    <span class="c">// Release disconnect pending, if any.</span>
                    <b>if</b> (<span class="r308 r">cmdTM</span>.<a href="#5d59ea7e64b6101f" class="i field">_isDisconnectPending</a>)
                    {
                        <span class="r308 r">cmdTM</span>.<a href="BaseTransportManager.cs.html#d740e262e7f09e2e" class="i method">RaiseReadyForDisconnect</a>();
                    }
 
                    <b>return</b>;
                }
 
                <span class="c">// If a disconnect is pending at this point then we should not start</span>
                <span class="c">// receiving data or sending input and let the disconnect take place.</span>
                <b>if</b> (<span class="r308 r">cmdTM</span>.<a href="#5d59ea7e64b6101f" class="i field">_isDisconnectPending</a>)
                {
                    <span class="r308 r">cmdTM</span>.<a href="BaseTransportManager.cs.html#d740e262e7f09e2e" class="i method">RaiseReadyForDisconnect</a>();
                    <b>return</b>;
                }
 
                <span class="c">// Allow SendStopSignal.</span>
                <span class="r308 r">cmdTM</span>.<a href="#f46e93b97317819a" class="i field">_isCreateCallbackReceived</a> = <b>true</b>;
 
                <span class="c">// Send stop signal if it is pending.</span>
                <b>if</b> (<span class="r308 r">cmdTM</span>.<a href="#f7f1092d9ea3a343" class="i field">_isStopSignalPending</a>)
                {
                    <span class="r308 r">cmdTM</span>.<a href="#b4aaead610683afb" class="i method">SendStopSignal</a>();
                }
            }
 
            <span class="c">// Establish a client data to server callback so that the client can respond to prompts.</span>
            <span class="r308 r">cmdTM</span>.<a href="#bcb75c1688eea088" class="i method">SendOneItem</a>();
 
            <span class="r308 r">cmdTM</span>.<a href="BaseTransportManager.cs.html#ff51517e144ee45f" class="i method">RaiseConnectCompleted</a>();
            <span class="r308 r">cmdTM</span>.<a href="#0f3671529ab7c0c3" class="i method">StartReceivingData</a>();
        }
 
        <b>private static void</b> <a id="e980e6030e69b858" href="../../../R/e980e6030e69b858.html" target="n" data-glyph="76,1" class="i method">OnCloseCmdCompleted</a>(<span class="i">IntPtr</span> <span id="r311 rd" class="r311 r">operationContext</span>,
            <b>int</b> <span id="r312 rd" class="r312 r">flags</span>,
            <span class="i">IntPtr</span> <span id="r313 rd" class="r313 r">error</span>,
            <span class="i">IntPtr</span> <span id="r314 rd" class="r314 r">shellOperationHandle</span>,
            <span class="i">IntPtr</span> <span id="r315 rd" class="r315 r">commandOperationHandle</span>,
            <span class="i">IntPtr</span> <span id="r316 rd" class="r316 r">operationHandle</span>,
            <span class="i">IntPtr</span> <span id="r317 rd" class="r317 r">data</span>)
        {
            <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<span class="i">WriteLine</span>(<span class="s">&quot;OnCloseCmdCompleted callback received for operation context {0}&quot;</span>, <span class="r315 r">commandOperationHandle</span>);
 
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<a href="../../../utils/tracing/PSEtwLog.cs.html#bd7ee9e01b1b8117" class="i method">LogAnalyticInformational</a>(
                <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#f3ed9d3bada91125" class="i field">WSManCloseCommandCallbackReceived</a>,
                <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#a0f7cf0d4987790f" class="i field">Connect</a>,
                <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#c5d4a73b62c859ab" class="i field">Transport</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                <span class="s">&quot;OnCloseCmdCompleted: OnCloseCmdCompleted callback received&quot;</span>);
 
            <b>long</b> <span id="r318 rd" class="r318 r">cmdContextId</span> = 0;
            <a href="#b521a47ccd5a3cc1" class="t t">WSManClientCommandTransportManager</a> <span id="r319 rd" class="r319 r">cmdTM</span> = <b>null</b>;
            <b>if</b> (!<a href="#90d601185c5a5777" class="i method">TryGetCmdTransportManager</a>(<span class="r311 r">operationContext</span>, <b>out</b> <span class="r319 r">cmdTM</span>, <b>out</b> <span class="r318 r">cmdContextId</span>))
            {
                <span class="c">// We dont have the command TM handle..just return.</span>
                <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<a href="../../../utils/StructuredTraceSource.cs.html#25fe29b46cfb1e10" class="i method">WriteLine</a>(<span class="s">&quot;OnCloseCmdCompleted: Unable to find a transport manager for the command context {0}.&quot;</span>, <span class="r318 r">cmdContextId</span>);
                <b>return</b>;
            }
 
            <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<a href="../../../utils/StructuredTraceSource.cs.html#25fe29b46cfb1e10" class="i method">WriteLine</a>(<span class="s">&quot;Close completed callback received for command: {0}&quot;</span>, <span class="r319 r">cmdTM</span>.<a href="#cc02a8a8120dfe1d" class="i field">_cmdContextId</a>);
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(
                <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#f3ed9d3bada91125" class="i field">WSManCloseCommandCallbackReceived</a>,
                <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#f3d85cb80e62fe3e" class="i field">Disconnect</a>,
                <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#c5d4a73b62c859ab" class="i field">Transport</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                <span class="r319 r">cmdTM</span>.<a href="BaseTransportManager.cs.html#6b69cd5f8cc06fb7" class="i property">RunspacePoolInstanceId</a>.<span class="i">ToString</span>(),
                <span class="r319 r">cmdTM</span>.<a href="BaseTransportManager.cs.html#5485ee84e1e3c04d" class="i field">powershellInstanceId</a>.<span class="i">ToString</span>());
 
            <b>if</b> (<span class="r319 r">cmdTM</span>.<a href="#5d59ea7e64b6101f" class="i field">_isDisconnectPending</a>)
            {
                <span class="r319 r">cmdTM</span>.<a href="BaseTransportManager.cs.html#d740e262e7f09e2e" class="i method">RaiseReadyForDisconnect</a>();
            }
 
            <span class="r319 r">cmdTM</span>.<a href="BaseTransportManager.cs.html#ce72d08b48a8f70f" class="i method">RaiseCloseCompleted</a>();
        }
 
        <b>private static void</b> <a id="8946ce6783c7572f" href="../../../R/8946ce6783c7572f.html" target="n" data-glyph="76,1" class="i method">OnRemoteCmdSendCompleted</a>(<span class="i">IntPtr</span> <span id="r320 rd" class="r320 r">operationContext</span>,
            <b>int</b> <span id="r321 rd" class="r321 r">flags</span>,
            <span class="i">IntPtr</span> <span id="r322 rd" class="r322 r">error</span>,
            <span class="i">IntPtr</span> <span id="r323 rd" class="r323 r">shellOperationHandle</span>,
            <span class="i">IntPtr</span> <span id="r324 rd" class="r324 r">commandOperationHandle</span>,
            <span class="i">IntPtr</span> <span id="r325 rd" class="r325 r">operationHandle</span>,
            <span class="i">IntPtr</span> <span id="r326 rd" class="r326 r">data</span>)
        {
            <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<a href="../../../utils/StructuredTraceSource.cs.html#96aaf3813a5962a0" class="i method">WriteLine</a>(<span class="s">&quot;SendComplete callback received&quot;</span>);
 
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<a href="../../../utils/tracing/PSEtwLog.cs.html#bd7ee9e01b1b8117" class="i method">LogAnalyticInformational</a>(
                <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#24e0ce157c99ef06" class="i field">WSManSendShellInputExCallbackReceived</a>,
                <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#a0f7cf0d4987790f" class="i field">Connect</a>,
                <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#c5d4a73b62c859ab" class="i field">Transport</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                <span class="s">&quot;OnRemoteCmdSendCompleted: SendComplete callback received&quot;</span>);
 
            <b>long</b> <span id="r327 rd" class="r327 r">cmdContextId</span> = 0;
            <a href="#b521a47ccd5a3cc1" class="t t">WSManClientCommandTransportManager</a> <span id="r328 rd" class="r328 r">cmdTM</span> = <b>null</b>;
            <b>if</b> (!<a href="#90d601185c5a5777" class="i method">TryGetCmdTransportManager</a>(<span class="r320 r">operationContext</span>, <b>out</b> <span class="r328 r">cmdTM</span>, <b>out</b> <span class="r327 r">cmdContextId</span>))
            {
                <span class="c">// We dont have the command TM handle..just return.</span>
                <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<a href="../../../utils/StructuredTraceSource.cs.html#25fe29b46cfb1e10" class="i method">WriteLine</a>(<span class="s">&quot;Unable to find a transport manager for the command context {0}.&quot;</span>, <span class="r327 r">cmdContextId</span>);
                <b>return</b>;
            }
 
            <span class="r328 r">cmdTM</span>.<a href="#7ceeeb92886e32b9" class="i field">_isSendingInput</a> = <b>false</b>;
 
            <span class="c">// do the logging for this send</span>
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(
                <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#24e0ce157c99ef06" class="i field">WSManSendShellInputExCallbackReceived</a>,
                <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#a0f7cf0d4987790f" class="i field">Connect</a>,
                <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#c5d4a73b62c859ab" class="i field">Transport</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                <span class="r328 r">cmdTM</span>.<a href="BaseTransportManager.cs.html#6b69cd5f8cc06fb7" class="i property">RunspacePoolInstanceId</a>.<span class="i">ToString</span>(),
                <span class="r328 r">cmdTM</span>.<a href="BaseTransportManager.cs.html#5485ee84e1e3c04d" class="i field">powershellInstanceId</a>.<span class="i">ToString</span>());
 
            <b>if</b> ((!<span class="r323 r">shellOperationHandle</span>.<span class="i">Equals</span>(<span class="r328 r">cmdTM</span>.<a href="#7f3442b679fa07aa" class="i field">_wsManShellOperationHandle</a>)) ||
                (!<span class="r324 r">commandOperationHandle</span>.<span class="i">Equals</span>(<span class="r328 r">cmdTM</span>.<a href="#01c2414243976ea8" class="i field">_wsManCmdOperationHandle</a>)))
            {
                <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<a href="../../../utils/StructuredTraceSource.cs.html#96aaf3813a5962a0" class="i method">WriteLine</a>(<span class="s">&quot;SendShellInputEx callback: ShellOperationHandles are not the same as the Send is initiated with&quot;</span>);
                <span class="c">// WSMan returned data from a wrong shell..notify the caller</span>
                <span class="c">// about the same.</span>
                <a href="../common/remotingexceptions.cs.html#0bb8687f97d91059" class="t t">PSRemotingTransportException</a> <span id="r329 rd" class="r329 r">e</span> = <b>new</b> <span class="t">PSRemotingTransportException</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">CommandSendExFailed</span>);
                <a href="BaseTransportManager.cs.html#7e70b34f9332dfcd" class="t t">TransportErrorOccuredEventArgs</a> <span id="r330 rd" class="r330 r">eventargs</span> =
                    <b>new</b> <a href="BaseTransportManager.cs.html#c420864940871a42" class="t constructor">TransportErrorOccuredEventArgs</a>(<span class="r329 r">e</span>, <a href="BaseTransportManager.cs.html#33678df914ca9daf" class="t t">TransportMethodEnum</a>.<a href="BaseTransportManager.cs.html#431d95f3744e9b1c" class="i field">CommandInputEx</a>);
                <span class="r328 r">cmdTM</span>.<a href="#644a9db700d6cbba" class="i method">ProcessWSManTransportError</a>(<span class="r330 r">eventargs</span>);
 
                <b>return</b>;
            }
 
            <span class="c">// release the resources related to send</span>
            <span class="r328 r">cmdTM</span>.<a href="#315a616bfbc19c81" class="i method">ClearReceiveOrSendResources</a>(<span class="r321 r">flags</span>, <b>true</b>);
 
            <span class="c">// if the transport manager is already closed..ignore the errors and return</span>
            <b>if</b> (<span class="r328 r">cmdTM</span>.<a href="BaseTransportManager.cs.html#76271338de46dcf0" class="i field">isClosed</a>)
            {
                <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<a href="../../../utils/StructuredTraceSource.cs.html#96aaf3813a5962a0" class="i method">WriteLine</a>(<span class="s">&quot;Client Command TM: Transport manager is closed. So returning&quot;</span>);
 
                <b>if</b> (<span class="r328 r">cmdTM</span>.<a href="#5d59ea7e64b6101f" class="i field">_isDisconnectPending</a>)
                {
                    <span class="r328 r">cmdTM</span>.<a href="BaseTransportManager.cs.html#d740e262e7f09e2e" class="i method">RaiseReadyForDisconnect</a>();
                }
 
                <b>return</b>;
            }
 
            <b>if</b> (<span class="r322 r">error</span> != <span class="i">IntPtr</span>.<span class="i">Zero</span>)
            {
                <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#587a4e1f26edb30b" class="t t">WSManError</a> <span id="r331 rd" class="r331 r">errorStruct</span> = <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#587a4e1f26edb30b" class="t t">WSManError</a>.<a href="WSManNativeAPI.cs.html#0577f3d9734092d0" class="i method">UnMarshal</a>(<span class="r322 r">error</span>);
                <span class="c">// Ignore Command aborted error. Command aborted is raised by WSMan to</span>
                <span class="c">// notify command operation complete. PowerShell protocol has its own</span>
                <span class="c">// way of notifying the same using state change events.</span>
                <b>if</b> ((<span class="r331 r">errorStruct</span>.<a href="WSManNativeAPI.cs.html#3bfbb0e97567321f" class="i field">errorCode</a> != 0) &amp;&amp; (<span class="r331 r">errorStruct</span>.<a href="WSManNativeAPI.cs.html#3bfbb0e97567321f" class="i field">errorCode</a> != 995))
                {
                    <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<a href="../../../utils/StructuredTraceSource.cs.html#25b8416175e53218" class="i method">WriteLine</a>(<span class="s">&quot;CmdSend callback: WSMan reported an error: {0}&quot;</span>, <span class="r331 r">errorStruct</span>.<a href="WSManNativeAPI.cs.html#5497bacefa3538a3" class="i field">errorDetail</a>);
 
                    <a href="BaseTransportManager.cs.html#7e70b34f9332dfcd" class="t t">TransportErrorOccuredEventArgs</a> <span id="r332 rd" class="r332 r">eventargs</span> = <a href="#b4291df75d9bc408" class="t t">WSManTransportManagerUtils</a>.<span class="i">ConstructTransportErrorEventArgs</span>(
                        <span class="r328 r">cmdTM</span>.<a href="#c75759e8604f93da" class="i field">_sessnTm</a>.<a href="#7616e1c5a9b266f9" class="i property">WSManAPIData</a>.<a href="#f386d97c12d99137" class="i property">WSManAPIHandle</a>,
                        <b>null</b>,
                        <span class="r331 r">errorStruct</span>,
                        <a href="BaseTransportManager.cs.html#33678df914ca9daf" class="t t">TransportMethodEnum</a>.<a href="BaseTransportManager.cs.html#431d95f3744e9b1c" class="i field">CommandInputEx</a>,
                        <span class="i">RemotingErrorIdStrings</span>.<span class="i">CommandSendExCallBackError</span>,
                        <b>new</b> <b>object</b>[] { <a href="#b4291df75d9bc408" class="t t">WSManTransportManagerUtils</a>.<a href="#95feb8ba0fde2a13" class="i method">ParseEscapeWSManErrorMessage</a>(<span class="r331 r">errorStruct</span>.<a href="WSManNativeAPI.cs.html#5497bacefa3538a3" class="i field">errorDetail</a>) });
                    <span class="r328 r">cmdTM</span>.<a href="#644a9db700d6cbba" class="i method">ProcessWSManTransportError</a>(<span class="r332 r">eventargs</span>);
 
                    <b>return</b>;
                }
            }
 
            <span class="c">// Send the next item, if available</span>
            <span class="r328 r">cmdTM</span>.<a href="#bcb75c1688eea088" class="i method">SendOneItem</a>();
        }
 
        <b>private static void</b> <a id="78cc7dad701baad9" href="../../../R/78cc7dad701baad9.html" target="n" data-glyph="76,1" class="i method">OnRemoteCmdDataReceived</a>(<span class="i">IntPtr</span> <span id="r333 rd" class="r333 r">operationContext</span>,
            <b>int</b> <span id="r334 rd" class="r334 r">flags</span>,
            <span class="i">IntPtr</span> <span id="r335 rd" class="r335 r">error</span>,
            <span class="i">IntPtr</span> <span id="r336 rd" class="r336 r">shellOperationHandle</span>,
            <span class="i">IntPtr</span> <span id="r337 rd" class="r337 r">commandOperationHandle</span>,
            <span class="i">IntPtr</span> <span id="r338 rd" class="r338 r">operationHandle</span>,
            <span class="i">IntPtr</span> <span id="r339 rd" class="r339 r">data</span>)
        {
            <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<a href="../../../utils/StructuredTraceSource.cs.html#96aaf3813a5962a0" class="i method">WriteLine</a>(<span class="s">&quot;Remote Command DataReceived callback.&quot;</span>);
 
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<a href="../../../utils/tracing/PSEtwLog.cs.html#bd7ee9e01b1b8117" class="i method">LogAnalyticInformational</a>(
                <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#1950f93b9ed312a7" class="i field">WSManReceiveShellOutputExCallbackReceived</a>,
                <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#a0f7cf0d4987790f" class="i field">Connect</a>,
                <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#c5d4a73b62c859ab" class="i field">Transport</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                <span class="s">&quot;OnRemoteCmdDataReceived: Remote Command DataReceived callback&quot;</span>);
 
            <b>long</b> <span id="r340 rd" class="r340 r">cmdContextId</span> = 0;
            <a href="#b521a47ccd5a3cc1" class="t t">WSManClientCommandTransportManager</a> <span id="r341 rd" class="r341 r">cmdTM</span> = <b>null</b>;
            <b>if</b> (!<a href="#90d601185c5a5777" class="i method">TryGetCmdTransportManager</a>(<span class="r333 r">operationContext</span>, <b>out</b> <span class="r341 r">cmdTM</span>, <b>out</b> <span class="r340 r">cmdContextId</span>))
            {
                <span class="c">// We dont have the command TM handle..just return.</span>
                <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<a href="../../../utils/StructuredTraceSource.cs.html#25fe29b46cfb1e10" class="i method">WriteLine</a>(<span class="s">&quot;Unable to find a transport manager for the given command context {0}.&quot;</span>, <span class="r340 r">cmdContextId</span>);
                <b>return</b>;
            }
 
            <b>if</b> ((!<span class="r336 r">shellOperationHandle</span>.<span class="i">Equals</span>(<span class="r341 r">cmdTM</span>.<a href="#7f3442b679fa07aa" class="i field">_wsManShellOperationHandle</a>)) ||
                (!<span class="r337 r">commandOperationHandle</span>.<span class="i">Equals</span>(<span class="r341 r">cmdTM</span>.<a href="#01c2414243976ea8" class="i field">_wsManCmdOperationHandle</a>)))
            {
                <span class="c">// WSMan returned data from a wrong shell..notify the caller</span>
                <span class="c">// about the same.</span>
                <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<a href="../../../utils/StructuredTraceSource.cs.html#96aaf3813a5962a0" class="i method">WriteLine</a>(<span class="s">&quot;CmdReceive callback: ShellOperationHandles are not the same as the Receive is initiated with&quot;</span>);
                <a href="../common/remotingexceptions.cs.html#0bb8687f97d91059" class="t t">PSRemotingTransportException</a> <span id="r342 rd" class="r342 r">e</span> = <b>new</b> <span class="t">PSRemotingTransportException</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">CommandReceiveExFailed</span>);
                <a href="BaseTransportManager.cs.html#7e70b34f9332dfcd" class="t t">TransportErrorOccuredEventArgs</a> <span id="r343 rd" class="r343 r">eventargs</span> =
                    <b>new</b> <a href="BaseTransportManager.cs.html#c420864940871a42" class="t constructor">TransportErrorOccuredEventArgs</a>(<span class="r342 r">e</span>, <a href="BaseTransportManager.cs.html#33678df914ca9daf" class="t t">TransportMethodEnum</a>.<a href="BaseTransportManager.cs.html#1aa4ae0cf31f0f4c" class="i field">ReceiveCommandOutputEx</a>);
                <span class="r341 r">cmdTM</span>.<a href="#644a9db700d6cbba" class="i method">ProcessWSManTransportError</a>(<span class="r343 r">eventargs</span>);
 
                <b>return</b>;
            }
 
            <span class="c">// release the resources related to receive</span>
            <span class="r341 r">cmdTM</span>.<a href="#315a616bfbc19c81" class="i method">ClearReceiveOrSendResources</a>(<span class="r334 r">flags</span>, <b>false</b>);
 
            <span class="c">// if the transport manager is already closed..ignore the errors and return</span>
            <b>if</b> (<span class="r341 r">cmdTM</span>.<a href="BaseTransportManager.cs.html#76271338de46dcf0" class="i field">isClosed</a>)
            {
                <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<a href="../../../utils/StructuredTraceSource.cs.html#96aaf3813a5962a0" class="i method">WriteLine</a>(<span class="s">&quot;Client Command TM: Transport manager is closed. So returning&quot;</span>);
                <b>return</b>;
            }
 
            <b>if</b> (<span class="r335 r">error</span> != <span class="i">IntPtr</span>.<span class="i">Zero</span>)
            {
                <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#587a4e1f26edb30b" class="t t">WSManError</a> <span id="r344 rd" class="r344 r">errorStruct</span> = <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#587a4e1f26edb30b" class="t t">WSManError</a>.<a href="WSManNativeAPI.cs.html#0577f3d9734092d0" class="i method">UnMarshal</a>(<span class="r335 r">error</span>);
                <b>if</b> (<span class="r344 r">errorStruct</span>.<a href="WSManNativeAPI.cs.html#3bfbb0e97567321f" class="i field">errorCode</a> != 0)
                {
                    <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<a href="../../../utils/StructuredTraceSource.cs.html#25b8416175e53218" class="i method">WriteLine</a>(<span class="s">&quot;CmdReceive callback: WSMan reported an error: {0}&quot;</span>, <span class="r344 r">errorStruct</span>.<a href="WSManNativeAPI.cs.html#5497bacefa3538a3" class="i field">errorDetail</a>);
 
                    <a href="BaseTransportManager.cs.html#7e70b34f9332dfcd" class="t t">TransportErrorOccuredEventArgs</a> <span id="r345 rd" class="r345 r">eventargs</span> = <a href="#b4291df75d9bc408" class="t t">WSManTransportManagerUtils</a>.<span class="i">ConstructTransportErrorEventArgs</span>(
                        <span class="r341 r">cmdTM</span>.<a href="#c75759e8604f93da" class="i field">_sessnTm</a>.<a href="#7616e1c5a9b266f9" class="i property">WSManAPIData</a>.<a href="#f386d97c12d99137" class="i property">WSManAPIHandle</a>,
                        <b>null</b>,
                        <span class="r344 r">errorStruct</span>,
                        <a href="BaseTransportManager.cs.html#33678df914ca9daf" class="t t">TransportMethodEnum</a>.<a href="BaseTransportManager.cs.html#1aa4ae0cf31f0f4c" class="i field">ReceiveCommandOutputEx</a>,
                        <span class="i">RemotingErrorIdStrings</span>.<span class="i">CommandReceiveExCallBackError</span>,
                        <b>new</b> <b>object</b>[] { <span class="r344 r">errorStruct</span>.<a href="WSManNativeAPI.cs.html#5497bacefa3538a3" class="i field">errorDetail</a> });
                    <span class="r341 r">cmdTM</span>.<a href="#644a9db700d6cbba" class="i method">ProcessWSManTransportError</a>(<span class="r345 r">eventargs</span>);
 
                    <b>return</b>;
                }
            }
 
            <b>if</b> (<span class="r334 r">flags</span> == (<b>int</b>)<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#4b939349c4d4b263" class="t t">WSManCallbackFlags</a>.<a href="WSManNativeAPI.cs.html#77f419f8dc9e11af" class="i field">WSMAN_FLAG_RECEIVE_DELAY_STREAM_REQUEST_PROCESSED</a>)
            {
                <span class="r341 r">cmdTM</span>.<a href="#8f171b9d04bc2973" class="i field">_isDisconnectedOnInvoke</a> = <b>true</b>;
                <span class="r341 r">cmdTM</span>.<a href="BaseTransportManager.cs.html#145777d21d37fdbd" class="i method">RaiseDelayStreamProcessedEvent</a>();
                <b>return</b>;
            }
 
            <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#42e20c3ae6d2041e" class="t t">WSManReceiveDataResult</a> <span id="r346 rd" class="r346 r">dataReceived</span> = <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#42e20c3ae6d2041e" class="t t">WSManReceiveDataResult</a>.<a href="WSManNativeAPI.cs.html#ff8bae8b21e53a27" class="i method">UnMarshal</a>(<span class="r339 r">data</span>);
            <b>if</b> (<span class="r346 r">dataReceived</span>.<a href="WSManNativeAPI.cs.html#46da8fe2d7e03572" class="i field">data</a> != <b>null</b>)
            {
                <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<span class="i">WriteLine</span>(<span class="s">&quot;Cmd Received Data : {0}&quot;</span>, <span class="r346 r">dataReceived</span>.<a href="WSManNativeAPI.cs.html#46da8fe2d7e03572" class="i field">data</a>.<span class="i">Length</span>);
                <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(
                    <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#1950f93b9ed312a7" class="i field">WSManReceiveShellOutputExCallbackReceived</a>, <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#75e7cd53604b1352" class="i field">Receive</a>, <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                    <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#c5d4a73b62c859ab" class="i field">Transport</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                    <span class="r341 r">cmdTM</span>.<a href="BaseTransportManager.cs.html#6b69cd5f8cc06fb7" class="i property">RunspacePoolInstanceId</a>.<span class="i">ToString</span>(),
                    <span class="r341 r">cmdTM</span>.<a href="BaseTransportManager.cs.html#5485ee84e1e3c04d" class="i field">powershellInstanceId</a>.<span class="i">ToString</span>(),
                    <span class="r346 r">dataReceived</span>.<a href="WSManNativeAPI.cs.html#46da8fe2d7e03572" class="i field">data</a>.<span class="i">Length</span>.<span class="i">ToString</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>));
                <span class="r341 r">cmdTM</span>.<a href="BaseTransportManager.cs.html#9b54d0029bdba5c6" class="i method">ProcessRawData</a>(<span class="r346 r">dataReceived</span>.<a href="WSManNativeAPI.cs.html#46da8fe2d7e03572" class="i field">data</a>, <span class="r346 r">dataReceived</span>.<a href="WSManNativeAPI.cs.html#e270270622375fa7" class="i field">stream</a>);
            }
        }
 
        <b>private static void</b> <a id="dc6cf413387a0000" href="../../../R/dc6cf413387a0000.html" target="n" data-glyph="76,1" class="i method">OnReconnectCmdCompleted</a>(<span class="i">IntPtr</span> <span id="r347 rd" class="r347 r">operationContext</span>,
            <b>int</b> <span id="r348 rd" class="r348 r">flags</span>,
            <span class="i">IntPtr</span> <span id="r349 rd" class="r349 r">error</span>,
            <span class="i">IntPtr</span> <span id="r350 rd" class="r350 r">shellOperationHandle</span>,
            <span class="i">IntPtr</span> <span id="r351 rd" class="r351 r">commandOperationHandle</span>,
            <span class="i">IntPtr</span> <span id="r352 rd" class="r352 r">operationHandle</span>,
            <span class="i">IntPtr</span> <span id="r353 rd" class="r353 r">data</span>)
        {
            <b>long</b> <span id="r354 rd" class="r354 r">cmdContextId</span> = 0;
            <a href="#b521a47ccd5a3cc1" class="t t">WSManClientCommandTransportManager</a> <span id="r355 rd" class="r355 r">cmdTM</span> = <b>null</b>;
 
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<a href="../../../utils/tracing/PSEtwLog.cs.html#bd7ee9e01b1b8117" class="i method">LogAnalyticInformational</a>(
                <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#1950f93b9ed312a7" class="i field">WSManReceiveShellOutputExCallbackReceived</a>,
                <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#a0f7cf0d4987790f" class="i field">Connect</a>,
                <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#c5d4a73b62c859ab" class="i field">Transport</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                <span class="s">&quot;OnReconnectCmdCompleted&quot;</span>);
 
            <b>if</b> (!<a href="#90d601185c5a5777" class="i method">TryGetCmdTransportManager</a>(<span class="r347 r">operationContext</span>, <b>out</b> <span class="r355 r">cmdTM</span>, <b>out</b> <span class="r354 r">cmdContextId</span>))
            {
                <span class="c">// We dont have the command TM handle..just return.</span>
                <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<a href="../../../utils/StructuredTraceSource.cs.html#25fe29b46cfb1e10" class="i method">WriteLine</a>(<span class="s">&quot;Unable to find a transport manager for the given command context {0}.&quot;</span>, <span class="r354 r">cmdContextId</span>);
                <b>return</b>;
            }
 
            <b>if</b> ((!<span class="r350 r">shellOperationHandle</span>.<span class="i">Equals</span>(<span class="r355 r">cmdTM</span>.<a href="#7f3442b679fa07aa" class="i field">_wsManShellOperationHandle</a>)) ||
               (!<span class="r351 r">commandOperationHandle</span>.<span class="i">Equals</span>(<span class="r355 r">cmdTM</span>.<a href="#01c2414243976ea8" class="i field">_wsManCmdOperationHandle</a>)))
            {
                <span class="c">// WSMan returned data from a wrong shell..notify the caller</span>
                <span class="c">// about the same.</span>
                <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<a href="../../../utils/StructuredTraceSource.cs.html#96aaf3813a5962a0" class="i method">WriteLine</a>(<span class="s">&quot;Cmd Signal callback: ShellOperationHandles are not the same as the signal is initiated with&quot;</span>);
                <a href="../common/remotingexceptions.cs.html#0bb8687f97d91059" class="t t">PSRemotingTransportException</a> <span id="r356 rd" class="r356 r">e</span> = <b>new</b> <span class="t">PSRemotingTransportException</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">ReconnectShellCommandExCallBackError</span>);
                <a href="BaseTransportManager.cs.html#7e70b34f9332dfcd" class="t t">TransportErrorOccuredEventArgs</a> <span id="r357 rd" class="r357 r">eventargs</span> =
                    <b>new</b> <a href="BaseTransportManager.cs.html#c420864940871a42" class="t constructor">TransportErrorOccuredEventArgs</a>(<span class="r356 r">e</span>, <a href="BaseTransportManager.cs.html#33678df914ca9daf" class="t t">TransportMethodEnum</a>.<a href="BaseTransportManager.cs.html#6e302be1fed98601" class="i field">ReconnectShellCommandEx</a>);
                <span class="r355 r">cmdTM</span>.<a href="#644a9db700d6cbba" class="i method">ProcessWSManTransportError</a>(<span class="r357 r">eventargs</span>);
 
                <b>return</b>;
            }
 
            <b>if</b> (<span class="r349 r">error</span> != <span class="i">IntPtr</span>.<span class="i">Zero</span>)
            {
                <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#587a4e1f26edb30b" class="t t">WSManError</a> <span id="r358 rd" class="r358 r">errorStruct</span> = <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#587a4e1f26edb30b" class="t t">WSManError</a>.<a href="WSManNativeAPI.cs.html#0577f3d9734092d0" class="i method">UnMarshal</a>(<span class="r349 r">error</span>);
                <b>if</b> (<span class="r358 r">errorStruct</span>.<a href="WSManNativeAPI.cs.html#3bfbb0e97567321f" class="i field">errorCode</a> != 0)
                {
                    <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<a href="../../../utils/StructuredTraceSource.cs.html#25b8416175e53218" class="i method">WriteLine</a>(<span class="s">&quot;OnReconnectCmdCompleted callback: WSMan reported an error: {0}&quot;</span>, <span class="r358 r">errorStruct</span>.<a href="WSManNativeAPI.cs.html#5497bacefa3538a3" class="i field">errorDetail</a>);
 
                    <a href="BaseTransportManager.cs.html#7e70b34f9332dfcd" class="t t">TransportErrorOccuredEventArgs</a> <span id="r359 rd" class="r359 r">eventargs</span> = <a href="#b4291df75d9bc408" class="t t">WSManTransportManagerUtils</a>.<span class="i">ConstructTransportErrorEventArgs</span>(
                        <span class="r355 r">cmdTM</span>.<a href="#c75759e8604f93da" class="i field">_sessnTm</a>.<a href="#7616e1c5a9b266f9" class="i property">WSManAPIData</a>.<a href="#f386d97c12d99137" class="i property">WSManAPIHandle</a>,
                        <b>null</b>,
                        <span class="r358 r">errorStruct</span>,
                        <a href="BaseTransportManager.cs.html#33678df914ca9daf" class="t t">TransportMethodEnum</a>.<a href="BaseTransportManager.cs.html#6e302be1fed98601" class="i field">ReconnectShellCommandEx</a>,
                        <span class="i">RemotingErrorIdStrings</span>.<span class="i">ReconnectShellCommandExCallBackError</span>,
                         <b>new</b> <b>object</b>[] { <a href="#b4291df75d9bc408" class="t t">WSManTransportManagerUtils</a>.<a href="#95feb8ba0fde2a13" class="i method">ParseEscapeWSManErrorMessage</a>(<span class="r358 r">errorStruct</span>.<a href="WSManNativeAPI.cs.html#5497bacefa3538a3" class="i field">errorDetail</a>) });
                    <span class="r355 r">cmdTM</span>.<a href="#644a9db700d6cbba" class="i method">ProcessWSManTransportError</a>(<span class="r359 r">eventargs</span>);
 
                    <b>return</b>;
                }
            }
 
            <span class="c">// The command may have been disconnected before all input was read or</span>
            <span class="c">// the returned command data started to be received.</span>
            <span class="r355 r">cmdTM</span>.<a href="#27a16a3a5f5c884a" class="i field">_shouldStartReceivingData</a> = <b>true</b>;
            <span class="r355 r">cmdTM</span>.<a href="#bcb75c1688eea088" class="i method">SendOneItem</a>();
 
            <span class="r355 r">cmdTM</span>.<a href="BaseTransportManager.cs.html#ce88eff5144dd47c" class="i method">RaiseReconnectCompleted</a>();
        }
 
        <b>private static void</b> <a id="877b0e2ab6965a59" href="../../../R/877b0e2ab6965a59.html" target="n" data-glyph="76,1" class="i method">OnRemoteCmdSignalCompleted</a>(<span class="i">IntPtr</span> <span id="r360 rd" class="r360 r">operationContext</span>,
            <b>int</b> <span id="r361 rd" class="r361 r">flags</span>,
            <span class="i">IntPtr</span> <span id="r362 rd" class="r362 r">error</span>,
            <span class="i">IntPtr</span> <span id="r363 rd" class="r363 r">shellOperationHandle</span>,
            <span class="i">IntPtr</span> <span id="r364 rd" class="r364 r">commandOperationHandle</span>,
            <span class="i">IntPtr</span> <span id="r365 rd" class="r365 r">operationHandle</span>,
            <span class="i">IntPtr</span> <span id="r366 rd" class="r366 r">data</span>)
        {
            <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<a href="../../../utils/StructuredTraceSource.cs.html#96aaf3813a5962a0" class="i method">WriteLine</a>(<span class="s">&quot;Signal Completed callback received.&quot;</span>);
 
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<a href="../../../utils/tracing/PSEtwLog.cs.html#bd7ee9e01b1b8117" class="i method">LogAnalyticInformational</a>(<a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#f3deaa651d18fa4a" class="i field">WSManSignalCallbackReceived</a>, <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#f3d85cb80e62fe3e" class="i field">Disconnect</a>, <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>, <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#c5d4a73b62c859ab" class="i field">Transport</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>, <span class="s">&quot;OnRemoteCmdSignalCompleted&quot;</span>);
 
            <b>long</b> <span id="r367 rd" class="r367 r">cmdContextId</span> = 0;
            <a href="#b521a47ccd5a3cc1" class="t t">WSManClientCommandTransportManager</a> <span id="r368 rd" class="r368 r">cmdTM</span> = <b>null</b>;
            <b>if</b> (!<a href="#90d601185c5a5777" class="i method">TryGetCmdTransportManager</a>(<span class="r360 r">operationContext</span>, <b>out</b> <span class="r368 r">cmdTM</span>, <b>out</b> <span class="r367 r">cmdContextId</span>))
            {
                <span class="c">// We dont have the command TM handle..just return.</span>
                <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<a href="../../../utils/StructuredTraceSource.cs.html#25fe29b46cfb1e10" class="i method">WriteLine</a>(<span class="s">&quot;Unable to find a transport manager for the given command context {0}.&quot;</span>, <span class="r367 r">cmdContextId</span>);
                <b>return</b>;
            }
 
            <span class="c">// log the callback received event.</span>
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(
                <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#f3deaa651d18fa4a" class="i field">WSManSignalCallbackReceived</a>,
                <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#f3d85cb80e62fe3e" class="i field">Disconnect</a>,
                <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#c5d4a73b62c859ab" class="i field">Transport</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                <span class="r368 r">cmdTM</span>.<a href="BaseTransportManager.cs.html#6b69cd5f8cc06fb7" class="i property">RunspacePoolInstanceId</a>.<span class="i">ToString</span>(),
                <span class="r368 r">cmdTM</span>.<a href="BaseTransportManager.cs.html#5485ee84e1e3c04d" class="i field">powershellInstanceId</a>.<span class="i">ToString</span>());
 
            <b>if</b> ((!<span class="r363 r">shellOperationHandle</span>.<span class="i">Equals</span>(<span class="r368 r">cmdTM</span>.<a href="#7f3442b679fa07aa" class="i field">_wsManShellOperationHandle</a>)) ||
                (!<span class="r364 r">commandOperationHandle</span>.<span class="i">Equals</span>(<span class="r368 r">cmdTM</span>.<a href="#01c2414243976ea8" class="i field">_wsManCmdOperationHandle</a>)))
            {
                <span class="c">// WSMan returned data from a wrong shell..notify the caller</span>
                <span class="c">// about the same.</span>
                <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<a href="../../../utils/StructuredTraceSource.cs.html#96aaf3813a5962a0" class="i method">WriteLine</a>(<span class="s">&quot;Cmd Signal callback: ShellOperationHandles are not the same as the signal is initiated with&quot;</span>);
                <a href="../common/remotingexceptions.cs.html#0bb8687f97d91059" class="t t">PSRemotingTransportException</a> <span id="r369 rd" class="r369 r">e</span> = <b>new</b> <span class="t">PSRemotingTransportException</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">CommandSendExFailed</span>);
                <a href="BaseTransportManager.cs.html#7e70b34f9332dfcd" class="t t">TransportErrorOccuredEventArgs</a> <span id="r370 rd" class="r370 r">eventargs</span> =
                    <b>new</b> <a href="BaseTransportManager.cs.html#c420864940871a42" class="t constructor">TransportErrorOccuredEventArgs</a>(<span class="r369 r">e</span>, <a href="BaseTransportManager.cs.html#33678df914ca9daf" class="t t">TransportMethodEnum</a>.<a href="BaseTransportManager.cs.html#431d95f3744e9b1c" class="i field">CommandInputEx</a>);
                <span class="r368 r">cmdTM</span>.<a href="#644a9db700d6cbba" class="i method">ProcessWSManTransportError</a>(<span class="r370 r">eventargs</span>);
 
                <b>return</b>;
            }
 
            <span class="c">// release the resources related to signal</span>
            <b>if</b> (<span class="r368 r">cmdTM</span>.<a href="#dba133100f83c727" class="i field">_cmdSignalOperationHandle</a> != <span class="i">IntPtr</span>.<span class="i">Zero</span>)
            {
                <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#96b121ea122bb25a" class="i method">WSManCloseOperation</a>(<span class="r368 r">cmdTM</span>.<a href="#dba133100f83c727" class="i field">_cmdSignalOperationHandle</a>, 0);
                <span class="r368 r">cmdTM</span>.<a href="#dba133100f83c727" class="i field">_cmdSignalOperationHandle</a> = <span class="i">IntPtr</span>.<span class="i">Zero</span>;
            }
 
            <b>if</b> (<span class="r368 r">cmdTM</span>.<a href="#116efb269d3cd8af" class="i field">_signalCmdCompleted</a> != <b>null</b>)
            {
                <span class="r368 r">cmdTM</span>.<a href="#116efb269d3cd8af" class="i field">_signalCmdCompleted</a>.<a href="WSManNativeAPI.cs.html#c68800d727cb6a45" class="i method">Dispose</a>();
                <span class="r368 r">cmdTM</span>.<a href="#116efb269d3cd8af" class="i field">_signalCmdCompleted</a> = <b>null</b>;
            }
 
            <span class="c">// if the transport manager is already closed..ignore the errors and return</span>
            <b>if</b> (<span class="r368 r">cmdTM</span>.<a href="BaseTransportManager.cs.html#76271338de46dcf0" class="i field">isClosed</a>)
            {
                <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<a href="../../../utils/StructuredTraceSource.cs.html#96aaf3813a5962a0" class="i method">WriteLine</a>(<span class="s">&quot;Client Command TM: Transport manager is closed. So returning&quot;</span>);
                <b>return</b>;
            }
 
            <b>if</b> (<span class="r362 r">error</span> != <span class="i">IntPtr</span>.<span class="i">Zero</span>)
            {
                <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#587a4e1f26edb30b" class="t t">WSManError</a> <span id="r371 rd" class="r371 r">errorStruct</span> = <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#587a4e1f26edb30b" class="t t">WSManError</a>.<a href="WSManNativeAPI.cs.html#0577f3d9734092d0" class="i method">UnMarshal</a>(<span class="r362 r">error</span>);
                <b>if</b> (<span class="r371 r">errorStruct</span>.<a href="WSManNativeAPI.cs.html#3bfbb0e97567321f" class="i field">errorCode</a> != 0)
                {
                    <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<a href="../../../utils/StructuredTraceSource.cs.html#25b8416175e53218" class="i method">WriteLine</a>(<span class="s">&quot;Cmd Signal callback: WSMan reported an error: {0}&quot;</span>, <span class="r371 r">errorStruct</span>.<a href="WSManNativeAPI.cs.html#5497bacefa3538a3" class="i field">errorDetail</a>);
 
                    <a href="BaseTransportManager.cs.html#7e70b34f9332dfcd" class="t t">TransportErrorOccuredEventArgs</a> <span id="r372 rd" class="r372 r">eventargs</span> = <a href="#b4291df75d9bc408" class="t t">WSManTransportManagerUtils</a>.<span class="i">ConstructTransportErrorEventArgs</span>(
                        <span class="r368 r">cmdTM</span>.<a href="#c75759e8604f93da" class="i field">_sessnTm</a>.<a href="#7616e1c5a9b266f9" class="i property">WSManAPIData</a>.<a href="#f386d97c12d99137" class="i property">WSManAPIHandle</a>,
                        <b>null</b>,
                        <span class="r371 r">errorStruct</span>,
                        <a href="BaseTransportManager.cs.html#33678df914ca9daf" class="t t">TransportMethodEnum</a>.<a href="BaseTransportManager.cs.html#431d95f3744e9b1c" class="i field">CommandInputEx</a>,
                        <span class="i">RemotingErrorIdStrings</span>.<span class="i">CommandSendExCallBackError</span>,
                        <b>new</b> <b>object</b>[] { <a href="#b4291df75d9bc408" class="t t">WSManTransportManagerUtils</a>.<a href="#95feb8ba0fde2a13" class="i method">ParseEscapeWSManErrorMessage</a>(<span class="r371 r">errorStruct</span>.<a href="WSManNativeAPI.cs.html#5497bacefa3538a3" class="i field">errorDetail</a>) });
                    <span class="r368 r">cmdTM</span>.<a href="#644a9db700d6cbba" class="i method">ProcessWSManTransportError</a>(<span class="r372 r">eventargs</span>);
                    <b>return</b>;
                }
            }
 
            <span class="r368 r">cmdTM</span>.<a href="BaseTransportManager.cs.html#a152fe644f7ae9c1" class="i method">EnqueueAndStartProcessingThread</a>(<b>null</b>, <b>null</b>, <b>true</b>);
        }
 
        <b>private void</b> <a id="bcb75c1688eea088" href="../../../R/bcb75c1688eea088.html" target="n" data-glyph="76,1" class="i method">SendOneItem</a>()
        {
            <span class="c">// If a disconnect is completing then do not send any more data.</span>
            <span class="c">// Also raise the readyfordisconnect event.</span>
            <b>if</b> (<a href="#5d59ea7e64b6101f" class="i field">_isDisconnectPending</a>)
            {
                <a href="BaseTransportManager.cs.html#d740e262e7f09e2e" class="i method">RaiseReadyForDisconnect</a>();
                <b>return</b>;
            }
 
            <b>byte</b>[] <span id="r373 rd" class="r373 r">data</span> = <b>null</b>;
            <a href="PriorityCollection.cs.html#f0975201467fdc06" class="t t">DataPriorityType</a> <span id="r374 rd" class="r374 r">priorityType</span> = <a href="PriorityCollection.cs.html#f0975201467fdc06" class="t t">DataPriorityType</a>.<a href="PriorityCollection.cs.html#e5092d1f4fa1babe" class="i field">Default</a>;
            <span class="c">// serializedPipeline is static ie., data is added to this collection at construction time only</span>
            <span class="c">// and data is accessed by only one thread at any given time..so we can depend on this count</span>
            <b>if</b> (<a href="BaseTransportManager.cs.html#f0864e0c2b75fa58" class="i field">serializedPipeline</a>.<a href="../common/fragmentor.cs.html#d22c9d5a8be2214d" class="i property">Length</a> &gt; 0)
            {
                <span class="r373 r">data</span> = <a href="BaseTransportManager.cs.html#f0864e0c2b75fa58" class="i field">serializedPipeline</a>.<a href="../common/fragmentor.cs.html#0020501682242305" class="i method">ReadOrRegisterCallback</a>(<b>null</b>);
                <span class="c">// if there are no command / parameter fragments need to be sent</span>
                <span class="c">// start receiving data. Reason: Command will start its execution</span>
                <span class="c">// once command string + parameters are sent.</span>
                <b>if</b> (<a href="BaseTransportManager.cs.html#f0864e0c2b75fa58" class="i field">serializedPipeline</a>.<a href="../common/fragmentor.cs.html#d22c9d5a8be2214d" class="i property">Length</a> == 0)
                {
                    <a href="#27a16a3a5f5c884a" class="i field">_shouldStartReceivingData</a> = <b>true</b>;
                }
            }
            <b>else</b> <b>if</b> (<a href="#67ee6049ffe2af29" class="i field">_chunkToSend</a> != <b>null</b>) <span class="c">// there is a pending chunk to be sent</span>
            {
                <span class="r373 r">data</span> = <a href="#67ee6049ffe2af29" class="i field">_chunkToSend</a>.<a href="#7c1e5881dd43fdd6" class="i property">Data</a>;
                <span class="r374 r">priorityType</span> = <a href="#67ee6049ffe2af29" class="i field">_chunkToSend</a>.<a href="#721d18918e832377" class="i property">Type</a>;
                <a href="#67ee6049ffe2af29" class="i field">_chunkToSend</a> = <b>null</b>;
            }
            <b>else</b>
            {
                <span class="c">// This will either return data or register callback but doesn&#39;t do both.</span>
                <span class="r373 r">data</span> = <a href="BaseTransportManager.cs.html#ee4a2ac1afa72dce" class="i field">dataToBeSent</a>.<a href="PriorityCollection.cs.html#56fbcab0ffda9766" class="i method">ReadOrRegisterCallback</a>(<a href="#39f0680093150e38" class="i field">_onDataAvailableToSendCallback</a>, <b>out</b> <span class="r374 r">priorityType</span>);
            }
 
            <b>if</b> (<span class="r373 r">data</span> != <b>null</b>)
            {
                <a href="#7ceeeb92886e32b9" class="i field">_isSendingInput</a> = <b>true</b>;
                <a href="#8caab4571e41d3d0" class="i method">SendData</a>(<span class="r373 r">data</span>, <span class="r374 r">priorityType</span>);
            }
 
            <b>if</b> (<a href="#27a16a3a5f5c884a" class="i field">_shouldStartReceivingData</a>)
            {
                <a href="#0f3671529ab7c0c3" class="i method">StartReceivingData</a>();
            }
        }
 
        <b>private void</b> <a id="85f5b2369cc2aa6e" href="../../../R/85f5b2369cc2aa6e.html" target="n" data-glyph="76,1" class="i method">OnDataAvailableCallback</a>(<b>byte</b>[] <span id="r375 rd" class="r375 r">data</span>, <a href="PriorityCollection.cs.html#f0975201467fdc06" class="t t">DataPriorityType</a> <span id="r376 rd" class="r376 r">priorityType</span>)
        {
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r375 r">data</span> != <b>null</b>, <span class="s">&quot;data cannot be null in the data available callback&quot;</span>);
 
            <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<a href="../../../utils/StructuredTraceSource.cs.html#96aaf3813a5962a0" class="i method">WriteLine</a>(<span class="s">&quot;Received data from dataToBeSent store.&quot;</span>);
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<a href="#67ee6049ffe2af29" class="i field">_chunkToSend</a> == <b>null</b>, <span class="s">&quot;data callback received while a chunk is pending to be sent&quot;</span>);
            <a href="#67ee6049ffe2af29" class="i field">_chunkToSend</a> = <b>new</b> <a href="#9a4c40c1a04c9f80" class="t constructor">SendDataChunk</a>(<span class="r375 r">data</span>, <span class="r376 r">priorityType</span>);
            <a href="#bcb75c1688eea088" class="i method">SendOneItem</a>();
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> SHIM: Redirection delegate for command data send.
 
        <b>private static readonly</b> <span class="i">Delegate</span> <a id="15a30f6cce1e2823" href="../../../R/15a30f6cce1e2823.html" target="n" data-glyph="46,1" class="i field">s_commandSendRedirect</a> = <b>null</b>;
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <b>private void</b> <a id="8caab4571e41d3d0" href="../../../R/8caab4571e41d3d0.html" target="n" data-glyph="76,1" class="i method">SendData</a>(<b>byte</b>[] <span id="r377 rd" class="r377 r">data</span>, <a href="PriorityCollection.cs.html#f0975201467fdc06" class="t t">DataPriorityType</a> <span id="r378 rd" class="r378 r">priorityType</span>)
        {
            <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<span class="i">WriteLine</span>(<span class="s">&quot;Command sending data of size : {0}&quot;</span>, <span class="r377 r">data</span>.<span class="i">Length</span>);
            <b>byte</b>[] <span id="r379 rd" class="r379 r">package</span> = <span class="r377 r">data</span>;
 
            <span class="k preprocess">#</span><span class="k preprocess">region</span> SHIM: Redirection code for command data send.
 
            <b>bool</b> <span id="r380 rd" class="r380 r">sendContinue</span> = <b>true</b>;
 
            <b>if</b> (<a href="#15a30f6cce1e2823" class="i field">s_commandSendRedirect</a> != <b>null</b>)
            {
                <b>object</b>[] <span id="r381 rd" class="r381 r">arguments</span> = <b>new</b> <b>object</b>[2] { <b>null</b>, <span class="r379 r">package</span> };
                <span class="r380 r">sendContinue</span> = (<b>bool</b>)<a href="#15a30f6cce1e2823" class="i field">s_commandSendRedirect</a>.<span class="i">DynamicInvoke</span>(<span class="r381 r">arguments</span>);
                <span class="r379 r">package</span> = (<b>byte</b>[])<span class="r381 r">arguments</span>[0];
            }
 
            <b>if</b> (!<span class="r380 r">sendContinue</span>)
                <b>return</b>;
 
            <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
            <b>using</b> (<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#c08fd7c84904da7c" class="t t">WSManData_ManToUn</a> <span id="r382 rd" class="r382 r">serializedContent</span> =
                         <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#53bab55b828c8016" class="t constructor">WSManData_ManToUn</a>(<span class="r379 r">package</span>))
            {
                <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(
                    <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#833085c622d127cb" class="i field">WSManSendShellInputEx</a>, <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#10dc07d70da5e17a" class="i field">Send</a>, <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                    <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#c5d4a73b62c859ab" class="i field">Transport</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                    <a href="BaseTransportManager.cs.html#6b69cd5f8cc06fb7" class="i property">RunspacePoolInstanceId</a>.<span class="i">ToString</span>(),
                    <a href="BaseTransportManager.cs.html#5485ee84e1e3c04d" class="i field">powershellInstanceId</a>.<span class="i">ToString</span>(),
                    <span class="r382 r">serializedContent</span>.<a href="WSManNativeAPI.cs.html#47798822d606f221" class="i property">BufferLength</a>.<span class="i">ToString</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>));
 
                <b>lock</b> (<a href="BaseTransportManager.cs.html#2b6037d6b3777ca1" class="i field">syncObject</a>)
                {
                    <span class="c">// make sure the transport is not closed.</span>
                    <b>if</b> (<a href="BaseTransportManager.cs.html#76271338de46dcf0" class="i field">isClosed</a>)
                    {
                        <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<a href="../../../utils/StructuredTraceSource.cs.html#96aaf3813a5962a0" class="i method">WriteLine</a>(<span class="s">&quot;Client Session TM: Transport manager is closed. So returning&quot;</span>);
                        <b>return</b>;
                    }
 
                    <span class="c">// send callback</span>
                    <a href="#7a925c9a2ffed390" class="i field">_sendToRemoteCompleted</a> = <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#d3c47769c10efcdb" class="t constructor">WSManShellAsync</a>(<b>new</b> <span class="i">IntPtr</span>(<a href="#cc02a8a8120dfe1d" class="i field">_cmdContextId</a>), <a href="#9870925398ef76a0" class="i field">s_cmdSendCallback</a>);
                    <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#e388e7302395fdc4" class="i method">WSManSendShellInputEx</a>(<a href="#7f3442b679fa07aa" class="i field">_wsManShellOperationHandle</a>, <a href="#01c2414243976ea8" class="i field">_wsManCmdOperationHandle</a>, 0,
                        <span class="r378 r">priorityType</span> == <a href="PriorityCollection.cs.html#f0975201467fdc06" class="t t">DataPriorityType</a>.<a href="PriorityCollection.cs.html#e5092d1f4fa1babe" class="i field">Default</a> ?
                            <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#dc257aa7beeaf400" class="i field">WSMAN_STREAM_ID_STDIN</a> : <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#2dd82f73ca1e8381" class="i field">WSMAN_STREAM_ID_PROMPTRESPONSE</a>,
                        <span class="r382 r">serializedContent</span>,
                        <a href="#7a925c9a2ffed390" class="i field">_sendToRemoteCompleted</a>,
                        <b>ref</b> <a href="#e0b96634e6e04f20" class="i field">_wsManSendOperationHandle</a>);
                }
            }
        }
 
        <b>internal override void</b> <a id="0f3671529ab7c0c3" href="../../../R/0f3671529ab7c0c3.html" target="n" data-glyph="74,1" class="i method">StartReceivingData</a>()
        {
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(
                <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#6ef71440e19f814d" class="i field">WSManReceiveShellOutputEx</a>,
                <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#75e7cd53604b1352" class="i field">Receive</a>, <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>, <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#c5d4a73b62c859ab" class="i field">Transport</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                <a href="BaseTransportManager.cs.html#6b69cd5f8cc06fb7" class="i property">RunspacePoolInstanceId</a>.<span class="i">ToString</span>(), <a href="BaseTransportManager.cs.html#5485ee84e1e3c04d" class="i field">powershellInstanceId</a>.<span class="i">ToString</span>());
 
            <span class="c">// We should call Receive only once.. WSMan will call the callback multiple times.</span>
            <a href="#27a16a3a5f5c884a" class="i field">_shouldStartReceivingData</a> = <b>false</b>;
            <b>lock</b> (<a href="BaseTransportManager.cs.html#2b6037d6b3777ca1" class="i field">syncObject</a>)
            {
                <span class="c">// make sure the transport is not closed.</span>
                <b>if</b> (<a href="BaseTransportManager.cs.html#76271338de46dcf0" class="i field">isClosed</a>)
                {
                    <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<a href="../../../utils/StructuredTraceSource.cs.html#96aaf3813a5962a0" class="i method">WriteLine</a>(<span class="s">&quot;Client Session TM: Transport manager is closed. So returning&quot;</span>);
                    <b>return</b>;
                }
 
                <b>if</b> (<a href="BaseTransportManager.cs.html#9a295d18d9f027e1" class="i field">receiveDataInitiated</a>)
                {
                    <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<a href="../../../utils/StructuredTraceSource.cs.html#96aaf3813a5962a0" class="i method">WriteLine</a>(<span class="s">&quot;Client Session TM: ReceiveData has already been called.&quot;</span>);
                    <b>return</b>;
                }
 
                <a href="BaseTransportManager.cs.html#9a295d18d9f027e1" class="i field">receiveDataInitiated</a> = <b>true</b>;
                <span class="c">// receive callback</span>
                <a href="#fec5609dcdeafac8" class="i field">_receivedFromRemote</a> = <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#d3c47769c10efcdb" class="t constructor">WSManShellAsync</a>(<b>new</b> <span class="i">IntPtr</span>(<a href="#cc02a8a8120dfe1d" class="i field">_cmdContextId</a>), <a href="#6cc7b5d8cfd0a242" class="i field">s_cmdReceiveCallback</a>);
                <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#9f72cfa4b3088c36" class="i method">WSManReceiveShellOutputEx</a>(<a href="#7f3442b679fa07aa" class="i field">_wsManShellOperationHandle</a>,
                    <a href="#01c2414243976ea8" class="i field">_wsManCmdOperationHandle</a>, <a href="BaseTransportManager.cs.html#ac907f25779bf298" class="i field">startInDisconnectedMode</a> ? (<b>int</b>)<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#98f13b30e065a9d0" class="t t">WSManShellFlag</a>.<a href="WSManNativeAPI.cs.html#63c59446a96201e5" class="i field">WSMAN_FLAG_RECEIVE_DELAY_OUTPUT_STREAM</a> : 0,
                   <a href="#c75759e8604f93da" class="i field">_sessnTm</a>.<a href="#7616e1c5a9b266f9" class="i property">WSManAPIData</a>.<a href="#e80e9dbb667bfefc" class="i property">OutputStreamSet</a>,
                   <a href="#fec5609dcdeafac8" class="i field">_receivedFromRemote</a>, <b>ref</b> <a href="#aaeb079bf1222e92" class="i field">_wsManReceiveOperationHandle</a>);
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Dispose / Destructor pattern
 
        <b>internal override void</b> <a id="2b3a8ab319f87c98" href="../../../R/2b3a8ab319f87c98.html" target="n" data-glyph="74,1" class="i method">Dispose</a>(<b>bool</b> <span id="r383 rd" class="r383 r">isDisposing</span>)
        {
            <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<span class="i">WriteLine</span>(<span class="s">&quot;Disposing command with command context: {0} Operation Context: {1}&quot;</span>, <a href="#cc02a8a8120dfe1d" class="i field">_cmdContextId</a>, <a href="#01c2414243976ea8" class="i field">_wsManCmdOperationHandle</a>);
            <a href="BaseTransportManager.cs.html#fa455a694094fdc2" class="k">base</a>.<a href="BaseTransportManager.cs.html#9e284fd5b441a63a" class="i method">Dispose</a>(<span class="r383 r">isDisposing</span>);
 
            <span class="c">// remove command context from cmd handles dictionary</span>
            <a href="#418e9c4131f8cf69" class="i method">RemoveCmdTransportManager</a>(<a href="#cc02a8a8120dfe1d" class="i field">_cmdContextId</a>);
 
            <span class="c">// unregister event handlers</span>
            <b>if</b> (<a href="#c75759e8604f93da" class="i field">_sessnTm</a> != <b>null</b>)
            {
                <a href="#c75759e8604f93da" class="i field">_sessnTm</a>.<a href="#8a72740c6e80c668" class="i">RobustConnectionsInitiated</a> -= <span class="i">HandleRobustConnectionsInitiated</span>;
                <a href="#c75759e8604f93da" class="i field">_sessnTm</a>.<a href="#2ab967894e7c3b07" class="i">RobustConnectionsCompleted</a> -= <span class="i">HandleRobusConnectionsCompleted</span>;
            }
 
            <b>if</b> (<a href="#c98a52d310bc6bbf" class="i field">_closeCmdCompleted</a> != <b>null</b>)
            {
                <a href="#c98a52d310bc6bbf" class="i field">_closeCmdCompleted</a>.<a href="WSManNativeAPI.cs.html#c68800d727cb6a45" class="i method">Dispose</a>();
                <a href="#c98a52d310bc6bbf" class="i field">_closeCmdCompleted</a> = <b>null</b>;
            }
 
            <b>if</b> (<a href="#ce0cc9b6aa97e797" class="i field">_reconnectCmdCompleted</a> != <b>null</b>)
            {
                <a href="#ce0cc9b6aa97e797" class="i field">_reconnectCmdCompleted</a>.<a href="WSManNativeAPI.cs.html#c68800d727cb6a45" class="i method">Dispose</a>();
                <a href="#ce0cc9b6aa97e797" class="i field">_reconnectCmdCompleted</a> = <b>null</b>;
            }
 
            <a href="#01c2414243976ea8" class="i field">_wsManCmdOperationHandle</a> = <span class="i">IntPtr</span>.<span class="i">Zero</span>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Static Data / Methods
 
        <span class="c">// This dictionary maintains active command transport managers to be used from various</span>
        <span class="c">// callbacks.</span>
        <b>private static readonly</b> <span class="i">Dictionary</span>&lt;<b>long</b>, <a href="#b521a47ccd5a3cc1" class="t t">WSManClientCommandTransportManager</a>&gt; <a id="6f512f2180bcf6ed" href="../../../R/6f512f2180bcf6ed.html" target="n" data-glyph="46,1" class="i field">s_cmdTMHandles</a> =
            <b>new</b> <span class="i">Dictionary</span>&lt;<b>long</b>, <a href="#b521a47ccd5a3cc1" class="t t">WSManClientCommandTransportManager</a>&gt;();
 
        <b>private static long</b> <a id="38b343c73c8c7249" href="../../../R/38b343c73c8c7249.html" target="n" data-glyph="46,1" class="i field">s_cmdTMSeed</a>;
 
        <span class="c">// Generate command transport manager unique id</span>
        <b>private static long</b> <a id="9220b9e7f82bd293" href="../../../R/9220b9e7f82bd293.html" target="n" data-glyph="76,1" class="i method">GetNextCmdTMHandleId</a>()
        {
            <b>return</b> <span class="i n">System</span>.<span class="i">Threading</span>.<span class="i">Interlocked</span>.<span class="i">Increment</span>(<b>ref</b> <a href="#38b343c73c8c7249" class="i field">s_cmdTMSeed</a>);
        }
 
        <span class="c">// we need a synchronized add and remove so that multiple threads</span>
        <span class="c">// update the data store concurrently</span>
        <b>private static void</b> <a id="f6b7255c7915d853" href="../../../R/f6b7255c7915d853.html" target="n" data-glyph="76,1" class="i method">AddCmdTransportManager</a>(<b>long</b> <span id="r384 rd" class="r384 r">cmdTMId</span>,
            <a href="#b521a47ccd5a3cc1" class="t t">WSManClientCommandTransportManager</a> <span id="r385 rd" class="r385 r">cmdTransportManager</span>)
        {
            <b>lock</b> (<a href="#6f512f2180bcf6ed" class="i field">s_cmdTMHandles</a>)
            {
                <a href="#6f512f2180bcf6ed" class="i field">s_cmdTMHandles</a>.<span class="i">Add</span>(<span class="r384 r">cmdTMId</span>, <span class="r385 r">cmdTransportManager</span>);
            }
        }
 
        <b>private static void</b> <a id="418e9c4131f8cf69" href="../../../R/418e9c4131f8cf69.html" target="n" data-glyph="76,1" class="i method">RemoveCmdTransportManager</a>(<b>long</b> <span id="r386 rd" class="r386 r">cmdTMId</span>)
        {
            <b>lock</b> (<a href="#6f512f2180bcf6ed" class="i field">s_cmdTMHandles</a>)
            {
                <a href="#6f512f2180bcf6ed" class="i field">s_cmdTMHandles</a>.<span class="i">Remove</span>(<span class="r386 r">cmdTMId</span>);
            }
        }
 
        <span class="c">// we need a synchronized add and remove so that multiple threads</span>
        <span class="c">// update the data store concurrently</span>
        <b>private static bool</b> <a id="90d601185c5a5777" href="../../../R/90d601185c5a5777.html" target="n" data-glyph="76,1" class="i method">TryGetCmdTransportManager</a>(<span class="i">IntPtr</span> <span id="r387 rd" class="r387 r">operationContext</span>,
            <b>out</b> <a href="#b521a47ccd5a3cc1" class="t t">WSManClientCommandTransportManager</a> <span id="r388 rd" class="r388 r">cmdTransportManager</span>,
            <b>out long</b> <span id="r389 rd" class="r389 r">cmdTMId</span>)
        {
            <span class="r389 r">cmdTMId</span> = <span class="r387 r">operationContext</span>.<span class="i">ToInt64</span>();
            <span class="r388 r">cmdTransportManager</span> = <b>null</b>;
            <b>lock</b> (<a href="#6f512f2180bcf6ed" class="i field">s_cmdTMHandles</a>)
            {
                <b>return</b> <a href="#6f512f2180bcf6ed" class="i field">s_cmdTMHandles</a>.<span class="i">TryGetValue</span>(<span class="r389 r">cmdTMId</span>, <b>out</b> <span class="r388 r">cmdTransportManager</span>);
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
    }
}
</pre></td></tr></table></div></body></html>
