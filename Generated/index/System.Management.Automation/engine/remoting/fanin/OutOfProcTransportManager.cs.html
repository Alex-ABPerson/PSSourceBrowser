<!DOCTYPE html>
<html><head><title>OutOfProcTransportManager.cs</title><link rel="stylesheet" href="../../../../styles.css"><script src="../../../../scripts.js"></script></head>
<body class="cB" onload="i(2668);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#System.Management.Automation/engine/remoting/fanin/OutOfProcTransportManager.cs" target="_top">engine\remoting\fanin\OutOfProcTransportManager.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#System.Management.Automation" target="_top">src\System.Management.Automation\System.Management.Automation.csproj</a> (System.Management.Automation)</td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation.</span>
<span class="c">// Licensed under the MIT License.</span>
 
<span class="c">/*
 * Common file that contains implementation for both server and client transport
 * managers for Out-Of-Process and Named Pipe (on the local machine) remoting implementation.
 * These interfaces are used by *-Job cmdlets to support background jobs and
 * attach-to-process feature without depending on WinRM (WinRM has complex requirements like
 * elevation to support local machine remoting).
 */</span>
 
<b>using</b> <span class="i n">System</span>.<span class="i">Collections</span>.<span class="i">Concurrent</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Collections</span>.<span class="i">Generic</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Diagnostics</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Globalization</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">IO</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Internal</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Runspaces</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Tracing</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Net</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Threading</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Xml</span>;
 
<b>using</b> <span class="t">PSRemotingCryptoHelper</span> = <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Internal</span>.<a href="../../../utils/CryptoUtils.cs.html#1999dfb2439af5a0" class="t t">PSRemotingCryptoHelper</a>;
<b>using</b> <span class="t">PSRemotingCryptoHelperServer</span> = <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Internal</span>.<a href="../../../utils/CryptoUtils.cs.html#e11543478fd30f75" class="t t">PSRemotingCryptoHelperServer</a>;
<b>using</b> <span class="t">RunspaceConnectionInfo</span> = <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Runspaces</span>.<a href="../common/RunspaceConnectionInfo.cs.html#e07ed56a8a1da829" class="t t">RunspaceConnectionInfo</a>;
<b>using</b> <span class="t">ClientRemotePowerShell</span> = <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Runspaces</span>.<span class="i n">Internal</span>.<a href="../client/ClientRemotePowerShell.cs.html#b4d2ac017883b31c" class="t t">ClientRemotePowerShell</a>;
<b>using</b> <span class="t">NewProcessConnectionInfo</span> = <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Runspaces</span>.<a href="../common/RunspaceConnectionInfo.cs.html#93baa7a23006c771" class="t t">NewProcessConnectionInfo</a>;
<b>using</b> <span class="t">PSTask</span> = <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Internal</span>.<a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>;
<b>using</b> <span class="t">PSOpcode</span> = <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Internal</span>.<a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>;
<b>using</b> <span class="t">PSEventId</span> = <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Internal</span>.<a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>;
<b>using</b> <span class="t">TypeTable</span> = <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Runspaces</span>.<a href="../../../P/a09d9b2cb7b1f0db.html#a09d9b2cb7b1f0db" class="t t">TypeTable</a>;
<b>using</b> <span class="t">Dbg</span> = <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Diagnostics</a>;
 
<b>namespace</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Remoting</span>
{
    <b>internal static class</b> <a id="bb038d3403da3163" href="../../../R/bb038d3403da3163.html" target="n" data-glyph="2,0" class="t t">OutOfProcessUtils</a>
    {
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Helper Fields
 
        <b>internal const string</b> <a id="ce5bbc4acfcc1bda" href="../../../R/ce5bbc4acfcc1bda.html" target="n" data-glyph="8,1" class="i field">PS_OUT_OF_PROC_DATA_TAG</a> = <span class="s">&quot;Data&quot;</span>;
        <b>internal const string</b> <a id="da87a1160aef6567" href="../../../R/da87a1160aef6567.html" target="n" data-glyph="8,1" class="i field">PS_OUT_OF_PROC_DATA_ACK_TAG</a> = <span class="s">&quot;DataAck&quot;</span>;
        <b>internal const string</b> <a id="4a7258f5e4f5314b" href="../../../R/4a7258f5e4f5314b.html" target="n" data-glyph="8,1" class="i field">PS_OUT_OF_PROC_STREAM_ATTRIBUTE</a> = <span class="s">&quot;Stream&quot;</span>;
        <b>internal const string</b> <a id="4c3d3c59b947fb37" href="../../../R/4c3d3c59b947fb37.html" target="n" data-glyph="8,1" class="i field">PS_OUT_OF_PROC_PSGUID_ATTRIBUTE</a> = <span class="s">&quot;PSGuid&quot;</span>;
        <b>internal const string</b> <a id="f7cc1cc6451b9b2f" href="../../../R/f7cc1cc6451b9b2f.html" target="n" data-glyph="8,1" class="i field">PS_OUT_OF_PROC_CLOSE_TAG</a> = <span class="s">&quot;Close&quot;</span>;
        <b>internal const string</b> <a id="cbf4145e6462e3f2" href="../../../R/cbf4145e6462e3f2.html" target="n" data-glyph="8,1" class="i field">PS_OUT_OF_PROC_CLOSE_ACK_TAG</a> = <span class="s">&quot;CloseAck&quot;</span>;
        <b>internal const string</b> <a id="2c2544c4eaa270bc" href="../../../R/2c2544c4eaa270bc.html" target="n" data-glyph="8,1" class="i field">PS_OUT_OF_PROC_COMMAND_TAG</a> = <span class="s">&quot;Command&quot;</span>;
        <b>internal const string</b> <a id="a8df37661f74435c" href="../../../R/a8df37661f74435c.html" target="n" data-glyph="8,1" class="i field">PS_OUT_OF_PROC_COMMAND_ACK_TAG</a> = <span class="s">&quot;CommandAck&quot;</span>;
        <b>internal const string</b> <a id="ce99cfb65df7f3fd" href="../../../R/ce99cfb65df7f3fd.html" target="n" data-glyph="8,1" class="i field">PS_OUT_OF_PROC_SIGNAL_TAG</a> = <span class="s">&quot;Signal&quot;</span>;
        <b>internal const string</b> <a id="62d0487a88a3e0f0" href="../../../R/62d0487a88a3e0f0.html" target="n" data-glyph="8,1" class="i field">PS_OUT_OF_PROC_SIGNAL_ACK_TAG</a> = <span class="s">&quot;SignalAck&quot;</span>;
        <b>internal const int</b> <a id="f59994c1ad9f1ff7" href="../../../R/f59994c1ad9f1ff7.html" target="n" data-glyph="8,1" class="i field">EXITCODE_UNHANDLED_EXCEPTION</a> = 0x0FA0;
 
        <b>internal static</b> <span class="i">XmlReaderSettings</span> <a id="f4e1a38145de65ac" href="../../../R/f4e1a38145de65ac.html" target="n" data-glyph="44,1" class="i field">XmlReaderSettings</a>;
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Static Constructor
 
        <b>static</b> <a id="359fa8a289967ab8" href="../../../R/../../0000000000.html" target="n" data-glyph="76,1" class="t method">OutOfProcessUtils</a>()
        {
            <span class="c">// data coming from inputs stream is in Xml format. create appropriate</span>
            <span class="c">// xml reader settings only once and reuse the same settings for all</span>
            <span class="c">// the reads from StdIn stream.</span>
            <a href="#f4e1a38145de65ac" class="i field">XmlReaderSettings</a> = <b>new</b> <span class="i">XmlReaderSettings</span>();
            <a href="#f4e1a38145de65ac" class="i field">XmlReaderSettings</a>.<span class="i">CheckCharacters</span> = <b>false</b>;
            <a href="#f4e1a38145de65ac" class="i field">XmlReaderSettings</a>.<span class="i">IgnoreComments</span> = <b>true</b>;
            <a href="#f4e1a38145de65ac" class="i field">XmlReaderSettings</a>.<span class="i">IgnoreProcessingInstructions</span> = <b>true</b>;
            <a href="#f4e1a38145de65ac" class="i field">XmlReaderSettings</a>.<span class="i">XmlResolver</span> = <b>null</b>;
            <a href="#f4e1a38145de65ac" class="i field">XmlReaderSettings</a>.<span class="i">ConformanceLevel</span> = <span class="i">ConformanceLevel</span>.<span class="i">Fragment</span>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Packet Creation Helper Methods
 
        <b>internal static string</b> <a id="31d02b37bd6ce1aa" href="../../../R/31d02b37bd6ce1aa.html" target="n" data-glyph="74,1" class="i method">CreateDataPacket</a>(<b>byte</b>[] <span id="r0 rd" class="r0 r">data</span>, <a href="PriorityCollection.cs.html#f0975201467fdc06" class="t t">DataPriorityType</a> <span id="r1 rd" class="r1 r">streamType</span>, <span class="i">Guid</span> <span id="r2 rd" class="r2 r">psGuid</span>)
        {
            <b>string</b> <span id="r3 rd" class="r3 r">result</span> = <b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>,
                <span class="s">&quot;&lt;{0} {1}=&#39;{2}&#39; {3}=&#39;{4}&#39;&gt;{5}&lt;/{0}&gt;&quot;</span>,
                <a href="#ce5bbc4acfcc1bda" class="i field">PS_OUT_OF_PROC_DATA_TAG</a>,
                <a href="#4a7258f5e4f5314b" class="i field">PS_OUT_OF_PROC_STREAM_ATTRIBUTE</a>,
                <span class="r1 r">streamType</span>.<span class="i">ToString</span>(),
                <a href="#4c3d3c59b947fb37" class="i field">PS_OUT_OF_PROC_PSGUID_ATTRIBUTE</a>,
                <span class="r2 r">psGuid</span>.<span class="i">ToString</span>(),
                <span class="i">Convert</span>.<span class="i">ToBase64String</span>(<span class="r0 r">data</span>));
 
            <b>return</b> <span class="r3 r">result</span>;
        }
 
        <b>internal static string</b> <a id="406f6bc786a76226" href="../../../R/406f6bc786a76226.html" target="n" data-glyph="74,1" class="i method">CreateDataAckPacket</a>(<span class="i">Guid</span> <span id="r4 rd" class="r4 r">psGuid</span>)
        {
            <b>return</b> <a href="#b4fa29d25c16f092" class="i method">CreatePSGuidPacket</a>(<a href="#da87a1160aef6567" class="i field">PS_OUT_OF_PROC_DATA_ACK_TAG</a>, <span class="r4 r">psGuid</span>);
        }
 
        <b>internal static string</b> <a id="3b2032e4391060d7" href="../../../R/3b2032e4391060d7.html" target="n" data-glyph="74,1" class="i method">CreateCommandPacket</a>(<span class="i">Guid</span> <span id="r5 rd" class="r5 r">psGuid</span>)
        {
            <b>return</b> <a href="#b4fa29d25c16f092" class="i method">CreatePSGuidPacket</a>(<a href="#2c2544c4eaa270bc" class="i field">PS_OUT_OF_PROC_COMMAND_TAG</a>, <span class="r5 r">psGuid</span>);
        }
 
        <b>internal static string</b> <a id="24f01d680585ec4b" href="../../../R/24f01d680585ec4b.html" target="n" data-glyph="74,1" class="i method">CreateCommandAckPacket</a>(<span class="i">Guid</span> <span id="r6 rd" class="r6 r">psGuid</span>)
        {
            <b>return</b> <a href="#b4fa29d25c16f092" class="i method">CreatePSGuidPacket</a>(<a href="#a8df37661f74435c" class="i field">PS_OUT_OF_PROC_COMMAND_ACK_TAG</a>, <span class="r6 r">psGuid</span>);
        }
 
        <b>internal static string</b> <a id="99fd43ea1942a467" href="../../../R/99fd43ea1942a467.html" target="n" data-glyph="74,1" class="i method">CreateClosePacket</a>(<span class="i">Guid</span> <span id="r7 rd" class="r7 r">psGuid</span>)
        {
            <b>return</b> <a href="#b4fa29d25c16f092" class="i method">CreatePSGuidPacket</a>(<a href="#f7cc1cc6451b9b2f" class="i field">PS_OUT_OF_PROC_CLOSE_TAG</a>, <span class="r7 r">psGuid</span>);
        }
 
        <b>internal static string</b> <a id="3a7dd76dd0cb0539" href="../../../R/3a7dd76dd0cb0539.html" target="n" data-glyph="74,1" class="i method">CreateCloseAckPacket</a>(<span class="i">Guid</span> <span id="r8 rd" class="r8 r">psGuid</span>)
        {
            <b>return</b> <a href="#b4fa29d25c16f092" class="i method">CreatePSGuidPacket</a>(<a href="#cbf4145e6462e3f2" class="i field">PS_OUT_OF_PROC_CLOSE_ACK_TAG</a>, <span class="r8 r">psGuid</span>);
        }
 
        <b>internal static string</b> <a id="50293432a1529be3" href="../../../R/50293432a1529be3.html" target="n" data-glyph="74,1" class="i method">CreateSignalPacket</a>(<span class="i">Guid</span> <span id="r9 rd" class="r9 r">psGuid</span>)
        {
            <b>return</b> <a href="#b4fa29d25c16f092" class="i method">CreatePSGuidPacket</a>(<a href="#ce99cfb65df7f3fd" class="i field">PS_OUT_OF_PROC_SIGNAL_TAG</a>, <span class="r9 r">psGuid</span>);
        }
 
        <b>internal static string</b> <a id="2ba0e1a7d3dfc013" href="../../../R/2ba0e1a7d3dfc013.html" target="n" data-glyph="74,1" class="i method">CreateSignalAckPacket</a>(<span class="i">Guid</span> <span id="r10 rd" class="r10 r">psGuid</span>)
        {
            <b>return</b> <a href="#b4fa29d25c16f092" class="i method">CreatePSGuidPacket</a>(<a href="#62d0487a88a3e0f0" class="i field">PS_OUT_OF_PROC_SIGNAL_ACK_TAG</a>, <span class="r10 r">psGuid</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Common method to create a packet that contains only a PS Guid</span>
        <span class="c">///</span><span class="c"> with element name changing.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r11 r">element</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r12 r">psGuid</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>private static string</b> <a id="b4fa29d25c16f092" href="../../../R/b4fa29d25c16f092.html" target="n" data-glyph="76,1" class="i method">CreatePSGuidPacket</a>(<b>string</b> <span id="r11 rd" class="r11 r">element</span>, <span class="i">Guid</span> <span id="r12 rd" class="r12 r">psGuid</span>)
        {
            <b>string</b> <span id="r13 rd" class="r13 r">result</span> = <b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>,
                <span class="s">&quot;&lt;{0} {1}=&#39;{2}&#39; /&gt;&quot;</span>,
                <span class="r11 r">element</span>,
                <a href="#4c3d3c59b947fb37" class="i field">PS_OUT_OF_PROC_PSGUID_ATTRIBUTE</a>,
                <span class="r12 r">psGuid</span>.<span class="i">ToString</span>());
 
            <b>return</b> <span class="r13 r">result</span>;
        }
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Packet Processing Helper Methods / Delegates
 
        <b>internal delegate void</b> <a id="93f273e3e096beba" href="../../../R/93f273e3e096beba.html" target="n" data-glyph="14,1" class="t t"><span id="b0e7f4d74fef8182">DataPacketReceived</span></a>(<b>byte</b>[] <span id="r14 rd" class="r14 r">rawData</span>, <b>string</b> <span id="r15 rd" class="r15 r">stream</span>, <span class="i">Guid</span> <span id="r16 rd" class="r16 r">psGuid</span>);
 
        <b>internal delegate void</b> <a id="fa6be16791d68093" href="../../../R/fa6be16791d68093.html" target="n" data-glyph="14,1" class="t t"><span id="a6ed65fb520d2c65">DataAckPacketReceived</span></a>(<span class="i">Guid</span> <span id="r17 rd" class="r17 r">psGuid</span>);
 
        <b>internal delegate void</b> <a id="65e131cb23ba28c0" href="../../../R/65e131cb23ba28c0.html" target="n" data-glyph="14,1" class="t t"><span id="c3779acb60076ef4">CommandCreationPacketReceived</span></a>(<span class="i">Guid</span> <span id="r18 rd" class="r18 r">psGuid</span>);
 
        <b>internal delegate void</b> <a id="fb081c35d970ff8f" href="../../../R/fb081c35d970ff8f.html" target="n" data-glyph="14,1" class="t t"><span id="a24f4ab809d22e92">CommandCreationAckReceived</span></a>(<span class="i">Guid</span> <span id="r19 rd" class="r19 r">psGuid</span>);
 
        <b>internal delegate void</b> <a id="41a5b4b868617f57" href="../../../R/41a5b4b868617f57.html" target="n" data-glyph="14,1" class="t t"><span id="96f6d7982c668452">ClosePacketReceived</span></a>(<span class="i">Guid</span> <span id="r20 rd" class="r20 r">psGuid</span>);
 
        <b>internal delegate void</b> <a id="2f5df7937961e4f4" href="../../../R/2f5df7937961e4f4.html" target="n" data-glyph="14,1" class="t t"><span id="58bcc48b31b2f1ed">CloseAckPacketReceived</span></a>(<span class="i">Guid</span> <span id="r21 rd" class="r21 r">psGuid</span>);
 
        <b>internal delegate void</b> <a id="557080f0bd33f1a0" href="../../../R/557080f0bd33f1a0.html" target="n" data-glyph="14,1" class="t t"><span id="e32d87c4e97b5644">SignalPacketReceived</span></a>(<span class="i">Guid</span> <span id="r22 rd" class="r22 r">psGuid</span>);
 
        <b>internal delegate void</b> <a id="dabca5cc0ec8ee9a" href="../../../R/dabca5cc0ec8ee9a.html" target="n" data-glyph="14,1" class="t t"><span id="7f6f8430fc8970ae">SignalAckPacketReceived</span></a>(<span class="i">Guid</span> <span id="r23 rd" class="r23 r">psGuid</span>);
 
        <b>internal struct</b> <a id="d3319d959b3f01b4" href="../../../R/d3319d959b3f01b4.html" target="n" data-glyph="110,1" class="t t"><span id="cf2ba8d387eb3e7a">DataProcessingDelegates</span></a>
        {
            <b>internal</b> <a href="#93f273e3e096beba" class="t t">DataPacketReceived</a> <a id="cb5c0d4f23d23e92" href="../../../R/cb5c0d4f23d23e92.html" target="n" data-glyph="44,2" class="i field">DataPacketReceived</a>;
            <b>internal</b> <a href="#fa6be16791d68093" class="t t">DataAckPacketReceived</a> <a id="965174e291299456" href="../../../R/965174e291299456.html" target="n" data-glyph="44,2" class="i field">DataAckPacketReceived</a>;
            <b>internal</b> <a href="#65e131cb23ba28c0" class="t t">CommandCreationPacketReceived</a> <a id="86ed179bec374226" href="../../../R/86ed179bec374226.html" target="n" data-glyph="44,2" class="i field">CommandCreationPacketReceived</a>;
            <b>internal</b> <a href="#fb081c35d970ff8f" class="t t">CommandCreationAckReceived</a> <a id="c17901dc153a0229" href="../../../R/c17901dc153a0229.html" target="n" data-glyph="44,2" class="i field">CommandCreationAckReceived</a>;
            <b>internal</b> <a href="#557080f0bd33f1a0" class="t t">SignalPacketReceived</a> <a id="b36a4b4bf60b2658" href="../../../R/b36a4b4bf60b2658.html" target="n" data-glyph="44,2" class="i field">SignalPacketReceived</a>;
            <b>internal</b> <a href="#dabca5cc0ec8ee9a" class="t t">SignalAckPacketReceived</a> <a id="320b3821c4ddb687" href="../../../R/320b3821c4ddb687.html" target="n" data-glyph="44,2" class="i field">SignalAckPacketReceived</a>;
            <b>internal</b> <a href="#41a5b4b868617f57" class="t t">ClosePacketReceived</a> <a id="6200f3d3917d5c2b" href="../../../R/6200f3d3917d5c2b.html" target="n" data-glyph="44,2" class="i field">ClosePacketReceived</a>;
            <b>internal</b> <a href="#2f5df7937961e4f4" class="t t">CloseAckPacketReceived</a> <a id="b1a960f12d2a03a9" href="../../../R/b1a960f12d2a03a9.html" target="n" data-glyph="44,2" class="i field">CloseAckPacketReceived</a>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Process&#39;s data. Data should be a valid XML.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r24 r">data</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r25 r">callbacks</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="../common/remotingexceptions.cs.html#0bb8687f97d91059" class="t t">PSRemotingTransportException</a><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> 1. Expected only two attributes with names &quot;{0}&quot; and &quot;{1}&quot; in &quot;{2}&quot; element.</span>
        <span class="c">///</span><span class="c"> 2. Not enough data available to process &quot;{0}&quot; element.</span>
        <span class="c">///</span><span class="c"> 3. Unknown node &quot;{0}&quot; in &quot;{1}&quot; element. Only &quot;{2}&quot; is expected in &quot;{1}&quot; element.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>internal static void</b> <a id="0082a3c3a966ef97" href="../../../R/0082a3c3a966ef97.html" target="n" data-glyph="74,1" class="i method">ProcessData</a>(<b>string</b> <span id="r24 rd" class="r24 r">data</span>, <a href="#d3319d959b3f01b4" class="t t">DataProcessingDelegates</a> <span id="r25 rd" class="r25 r">callbacks</span>)
        {
            <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r24 r">data</span>))
            {
                <b>return</b>;
            }
 
            <span class="i">XmlReader</span> <span id="r26 rd" class="r26 r">reader</span> = <span class="i">XmlReader</span>.<span class="i">Create</span>(<b>new</b> <span class="i">StringReader</span>(<span class="r24 r">data</span>), <a href="#f4e1a38145de65ac" class="i field">XmlReaderSettings</a>);
            <b>while</b> (<span class="r26 r">reader</span>.<span class="i">Read</span>())
            {
                <b>switch</b> (<span class="r26 r">reader</span>.<span class="i">NodeType</span>)
                {
                    <b>case</b> <span class="i">XmlNodeType</span>.<span class="i">Element</span>:
                        <a href="#b8ab4286a2aa0146" class="i method">ProcessElement</a>(<span class="r26 r">reader</span>, <span class="r25 r">callbacks</span>);
                        <b>break</b>;
                    <b>case</b> <span class="i">XmlNodeType</span>.<span class="i">EndElement</span>:
                        <b>break</b>;
                    <b>case</b> <span class="i">XmlNodeType</span>.<span class="i">Text</span>:
                        <b>throw</b> <b>new</b> <a href="../common/remotingexceptions.cs.html#3d42c01e0f93455e" class="t constructor">PSRemotingTransportException</a>(<span class="r24 r">data</span>);
                    <b>default</b>:
                        <b>throw</b> <b>new</b> <span class="t">PSRemotingTransportException</span>(<a href="../common/remotingexceptions.cs.html#a969589d7508bf05" class="t t">PSRemotingErrorId</a>.<a href="../common/remotingexceptions.cs.html#84e5f1b58afe557a" class="i field">IPCUnknownNodeType</a>, <span class="i">RemotingErrorIdStrings</span>.<span class="i">IPCUnknownNodeType</span>,
                            <span class="r26 r">reader</span>.<span class="i">NodeType</span>.<span class="i">ToString</span>(),
                            <b>nameof</b>(<span class="i">XmlNodeType</span>.<span class="i">Element</span>),
                            <b>nameof</b>(<span class="i">XmlNodeType</span>.<span class="i">EndElement</span>));
                }
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Process an XmlElement. The element name must be one of the following:</span>
        <span class="c">///</span><span class="c">         &quot;Data&quot;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r27 r">xmlReader</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r28 r">callbacks</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="../common/remotingexceptions.cs.html#0bb8687f97d91059" class="t t">PSRemotingTransportException</a><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> 1. Expected only two attributes with names &quot;{0}&quot; and &quot;{1}&quot; in &quot;{2}&quot; element.</span>
        <span class="c">///</span><span class="c"> 2. Not enough data available to process &quot;{0}&quot; element.</span>
        <span class="c">///</span><span class="c"> 3. Unknown node &quot;{0}&quot; in &quot;{1}&quot; element. Only &quot;{2}&quot; is expected in &quot;{1}&quot; element.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>private static void</b> <a id="b8ab4286a2aa0146" href="../../../R/b8ab4286a2aa0146.html" target="n" data-glyph="76,1" class="i method">ProcessElement</a>(<span class="i">XmlReader</span> <span id="r27 rd" class="r27 r">xmlReader</span>, <a href="#d3319d959b3f01b4" class="t t">DataProcessingDelegates</a> <span id="r28 rd" class="r28 r">callbacks</span>)
        {
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r27 r">xmlReader</span> != <b>null</b>, <span class="s">&quot;xmlReader cannot be null.&quot;</span>);
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r27 r">xmlReader</span>.<span class="i">NodeType</span> == <span class="i">XmlNodeType</span>.<span class="i">Element</span>, <span class="s">&quot;xmlReader&#39;s NodeType should be of type Element&quot;</span>);
 
            <a href="../../../utils/PowerShellETWTracer.cs.html#3fd13a01d0177ce2" class="t t">PowerShellTraceSource</a> <span id="r29 rd" class="r29 r">tracer</span> = <a href="../../../utils/PowerShellETWTracer.cs.html#37e484a307a595c3" class="t t">PowerShellTraceSourceFactory</a>.<a href="../../../utils/PowerShellETWTracer.cs.html#c94a9fbfef99a75d" class="i method">GetTraceSource</a>();
 
            <b>switch</b> (<span class="r27 r">xmlReader</span>.<span class="i">LocalName</span>)
            {
                <b>case</b> <a href="#bb038d3403da3163" class="t t">OutOfProcessUtils</a>.<a href="#ce5bbc4acfcc1bda" class="i field">PS_OUT_OF_PROC_DATA_TAG</a>:
                    {
                        <span class="c">// A &lt;Data&gt; should have 1 attribute identifying the stream</span>
                        <b>if</b> (<span class="r27 r">xmlReader</span>.<span class="i">AttributeCount</span> != 2)
                        {
                            <b>throw</b> <b>new</b> <span class="t">PSRemotingTransportException</span>(<a href="../common/remotingexceptions.cs.html#a969589d7508bf05" class="t t">PSRemotingErrorId</a>.<a href="../common/remotingexceptions.cs.html#f6e533423aa9409d" class="i field">IPCWrongAttributeCountForDataElement</a>,
                                <span class="i">RemotingErrorIdStrings</span>.<span class="i">IPCWrongAttributeCountForDataElement</span>,
                                <a href="#bb038d3403da3163" class="t t">OutOfProcessUtils</a>.<a href="#4a7258f5e4f5314b" class="i field">PS_OUT_OF_PROC_STREAM_ATTRIBUTE</a>,
                                <a href="#bb038d3403da3163" class="t t">OutOfProcessUtils</a>.<a href="#4c3d3c59b947fb37" class="i field">PS_OUT_OF_PROC_PSGUID_ATTRIBUTE</a>,
                                <a href="#bb038d3403da3163" class="t t">OutOfProcessUtils</a>.<a href="#ce5bbc4acfcc1bda" class="i field">PS_OUT_OF_PROC_DATA_TAG</a>);
                        }
 
                        <b>string</b> <span id="r30 rd" class="r30 r">stream</span> = <span class="r27 r">xmlReader</span>.<span class="i">GetAttribute</span>(<a href="#bb038d3403da3163" class="t t">OutOfProcessUtils</a>.<a href="#4a7258f5e4f5314b" class="i field">PS_OUT_OF_PROC_STREAM_ATTRIBUTE</a>);
                        <b>string</b> <span id="r31 rd" class="r31 r">psGuidString</span> = <span class="r27 r">xmlReader</span>.<span class="i">GetAttribute</span>(<a href="#bb038d3403da3163" class="t t">OutOfProcessUtils</a>.<a href="#4c3d3c59b947fb37" class="i field">PS_OUT_OF_PROC_PSGUID_ATTRIBUTE</a>);
                        <span class="i">Guid</span> <span id="r32 rd" class="r32 r">psGuid</span> = <b>new</b> <span class="i">Guid</span>(<span class="r31 r">psGuidString</span>);
 
                        <span class="c">// Now move the reader to the data portion</span>
                        <b>if</b> (!<span class="r27 r">xmlReader</span>.<span class="i">Read</span>())
                        {
                            <b>throw</b> <b>new</b> <span class="t">PSRemotingTransportException</span>(<a href="../common/remotingexceptions.cs.html#a969589d7508bf05" class="t t">PSRemotingErrorId</a>.<a href="../common/remotingexceptions.cs.html#9b0be1ef56694fc7" class="i field">IPCInsufficientDataforElement</a>,
                                <span class="i">RemotingErrorIdStrings</span>.<span class="i">IPCInsufficientDataforElement</span>,
                                <a href="#bb038d3403da3163" class="t t">OutOfProcessUtils</a>.<a href="#ce5bbc4acfcc1bda" class="i field">PS_OUT_OF_PROC_DATA_TAG</a>);
                        }
 
                        <b>if</b> (<span class="r27 r">xmlReader</span>.<span class="i">NodeType</span> != <span class="i">XmlNodeType</span>.<span class="i">Text</span>)
                        {
                            <b>throw</b> <b>new</b> <span class="t">PSRemotingTransportException</span>(<a href="../common/remotingexceptions.cs.html#a969589d7508bf05" class="t t">PSRemotingErrorId</a>.<a href="../common/remotingexceptions.cs.html#edb8fdf6e3de93d8" class="i field">IPCOnlyTextExpectedInDataElement</a>,
                                <span class="i">RemotingErrorIdStrings</span>.<span class="i">IPCOnlyTextExpectedInDataElement</span>,
                                <span class="r27 r">xmlReader</span>.<span class="i">NodeType</span>, <a href="#bb038d3403da3163" class="t t">OutOfProcessUtils</a>.<a href="#ce5bbc4acfcc1bda" class="i field">PS_OUT_OF_PROC_DATA_TAG</a>, <span class="i">XmlNodeType</span>.<span class="i">Text</span>);
                        }
 
                        <b>string</b> <span id="r33 rd" class="r33 r">data</span> = <span class="r27 r">xmlReader</span>.<span class="i">Value</span>;
                        <span class="r29 r">tracer</span>.<span class="i">WriteMessage</span>(<span class="s">&quot;OutOfProcessUtils.ProcessElement : PS_OUT_OF_PROC_DATA received, psGuid : &quot;</span> + <span class="r32 r">psGuid</span>.<span class="i">ToString</span>());
                        <b>byte</b>[] <span id="r34 rd" class="r34 r">rawData</span> = <span class="i">Convert</span>.<span class="i">FromBase64String</span>(<span class="r33 r">data</span>);
                        <span class="r28 r">callbacks</span>.<a href="#cb5c0d4f23d23e92" class="i field">DataPacketReceived</a>(<span class="r34 r">rawData</span>, <span class="r30 r">stream</span>, <span class="r32 r">psGuid</span>);
                    }
 
                    <b>break</b>;
                <b>case</b> <a href="#bb038d3403da3163" class="t t">OutOfProcessUtils</a>.<a href="#da87a1160aef6567" class="i field">PS_OUT_OF_PROC_DATA_ACK_TAG</a>:
                    {
                        <b>if</b> (<span class="r27 r">xmlReader</span>.<span class="i">AttributeCount</span> != 1)
                        {
                            <b>throw</b> <b>new</b> <span class="t">PSRemotingTransportException</span>(<a href="../common/remotingexceptions.cs.html#a969589d7508bf05" class="t t">PSRemotingErrorId</a>.<a href="../common/remotingexceptions.cs.html#b81cf06a288acf7b" class="i field">IPCWrongAttributeCountForElement</a>,
                                <span class="i">RemotingErrorIdStrings</span>.<span class="i">IPCWrongAttributeCountForElement</span>,
                                <a href="#bb038d3403da3163" class="t t">OutOfProcessUtils</a>.<a href="#4c3d3c59b947fb37" class="i field">PS_OUT_OF_PROC_PSGUID_ATTRIBUTE</a>,
                                <a href="#bb038d3403da3163" class="t t">OutOfProcessUtils</a>.<a href="#da87a1160aef6567" class="i field">PS_OUT_OF_PROC_DATA_ACK_TAG</a>);
                        }
 
                        <b>string</b> <span id="r35 rd" class="r35 r">psGuidString</span> = <span class="r27 r">xmlReader</span>.<span class="i">GetAttribute</span>(<a href="#bb038d3403da3163" class="t t">OutOfProcessUtils</a>.<a href="#4c3d3c59b947fb37" class="i field">PS_OUT_OF_PROC_PSGUID_ATTRIBUTE</a>);
                        <span class="i">Guid</span> <span id="r36 rd" class="r36 r">psGuid</span> = <b>new</b> <span class="i">Guid</span>(<span class="r35 r">psGuidString</span>);
 
                        <span class="r29 r">tracer</span>.<span class="i">WriteMessage</span>(<span class="s">&quot;OutOfProcessUtils.ProcessElement : PS_OUT_OF_PROC_DATA_ACK received, psGuid : &quot;</span> + <span class="r36 r">psGuid</span>.<span class="i">ToString</span>());
                        <span class="r28 r">callbacks</span>.<a href="#965174e291299456" class="i field">DataAckPacketReceived</a>(<span class="r36 r">psGuid</span>);
                    }
 
                    <b>break</b>;
                <b>case</b> <a href="#bb038d3403da3163" class="t t">OutOfProcessUtils</a>.<a href="#2c2544c4eaa270bc" class="i field">PS_OUT_OF_PROC_COMMAND_TAG</a>:
                    {
                        <b>if</b> (<span class="r27 r">xmlReader</span>.<span class="i">AttributeCount</span> != 1)
                        {
                            <b>throw</b> <b>new</b> <span class="t">PSRemotingTransportException</span>(<a href="../common/remotingexceptions.cs.html#a969589d7508bf05" class="t t">PSRemotingErrorId</a>.<a href="../common/remotingexceptions.cs.html#b81cf06a288acf7b" class="i field">IPCWrongAttributeCountForElement</a>,
                                <span class="i">RemotingErrorIdStrings</span>.<span class="i">IPCWrongAttributeCountForElement</span>,
                                <a href="#bb038d3403da3163" class="t t">OutOfProcessUtils</a>.<a href="#4c3d3c59b947fb37" class="i field">PS_OUT_OF_PROC_PSGUID_ATTRIBUTE</a>,
                                <a href="#bb038d3403da3163" class="t t">OutOfProcessUtils</a>.<a href="#2c2544c4eaa270bc" class="i field">PS_OUT_OF_PROC_COMMAND_TAG</a>);
                        }
 
                        <b>string</b> <span id="r37 rd" class="r37 r">psGuidString</span> = <span class="r27 r">xmlReader</span>.<span class="i">GetAttribute</span>(<a href="#bb038d3403da3163" class="t t">OutOfProcessUtils</a>.<a href="#4c3d3c59b947fb37" class="i field">PS_OUT_OF_PROC_PSGUID_ATTRIBUTE</a>);
                        <span class="i">Guid</span> <span id="r38 rd" class="r38 r">psGuid</span> = <b>new</b> <span class="i">Guid</span>(<span class="r37 r">psGuidString</span>);
 
                        <span class="r29 r">tracer</span>.<span class="i">WriteMessage</span>(<span class="s">&quot;OutOfProcessUtils.ProcessElement : PS_OUT_OF_PROC_COMMAND received, psGuid : &quot;</span> + <span class="r38 r">psGuid</span>.<span class="i">ToString</span>());
                        <span class="r28 r">callbacks</span>.<a href="#86ed179bec374226" class="i field">CommandCreationPacketReceived</a>(<span class="r38 r">psGuid</span>);
                    }
 
                    <b>break</b>;
                <b>case</b> <a href="#bb038d3403da3163" class="t t">OutOfProcessUtils</a>.<a href="#a8df37661f74435c" class="i field">PS_OUT_OF_PROC_COMMAND_ACK_TAG</a>:
                    {
                        <b>if</b> (<span class="r27 r">xmlReader</span>.<span class="i">AttributeCount</span> != 1)
                        {
                            <b>throw</b> <b>new</b> <span class="t">PSRemotingTransportException</span>(<a href="../common/remotingexceptions.cs.html#a969589d7508bf05" class="t t">PSRemotingErrorId</a>.<a href="../common/remotingexceptions.cs.html#b81cf06a288acf7b" class="i field">IPCWrongAttributeCountForElement</a>,
                                <span class="i">RemotingErrorIdStrings</span>.<span class="i">IPCWrongAttributeCountForElement</span>,
                                <a href="#bb038d3403da3163" class="t t">OutOfProcessUtils</a>.<a href="#4c3d3c59b947fb37" class="i field">PS_OUT_OF_PROC_PSGUID_ATTRIBUTE</a>,
                                <a href="#bb038d3403da3163" class="t t">OutOfProcessUtils</a>.<a href="#a8df37661f74435c" class="i field">PS_OUT_OF_PROC_COMMAND_ACK_TAG</a>);
                        }
 
                        <b>string</b> <span id="r39 rd" class="r39 r">psGuidString</span> = <span class="r27 r">xmlReader</span>.<span class="i">GetAttribute</span>(<a href="#bb038d3403da3163" class="t t">OutOfProcessUtils</a>.<a href="#4c3d3c59b947fb37" class="i field">PS_OUT_OF_PROC_PSGUID_ATTRIBUTE</a>);
                        <span class="i">Guid</span> <span id="r40 rd" class="r40 r">psGuid</span> = <b>new</b> <span class="i">Guid</span>(<span class="r39 r">psGuidString</span>);
                        <span class="r29 r">tracer</span>.<span class="i">WriteMessage</span>(<span class="s">&quot;OutOfProcessUtils.ProcessElement : PS_OUT_OF_PROC_COMMAND_ACK received, psGuid : &quot;</span> + <span class="r40 r">psGuid</span>.<span class="i">ToString</span>());
                        <span class="r28 r">callbacks</span>.<a href="#c17901dc153a0229" class="i field">CommandCreationAckReceived</a>(<span class="r40 r">psGuid</span>);
                    }
 
                    <b>break</b>;
                <b>case</b> <a href="#bb038d3403da3163" class="t t">OutOfProcessUtils</a>.<a href="#f7cc1cc6451b9b2f" class="i field">PS_OUT_OF_PROC_CLOSE_TAG</a>:
                    {
                        <b>if</b> (<span class="r27 r">xmlReader</span>.<span class="i">AttributeCount</span> != 1)
                        {
                            <b>throw</b> <b>new</b> <span class="t">PSRemotingTransportException</span>(<a href="../common/remotingexceptions.cs.html#a969589d7508bf05" class="t t">PSRemotingErrorId</a>.<a href="../common/remotingexceptions.cs.html#b81cf06a288acf7b" class="i field">IPCWrongAttributeCountForElement</a>,
                                <span class="i">RemotingErrorIdStrings</span>.<span class="i">IPCWrongAttributeCountForElement</span>,
                                <a href="#bb038d3403da3163" class="t t">OutOfProcessUtils</a>.<a href="#4c3d3c59b947fb37" class="i field">PS_OUT_OF_PROC_PSGUID_ATTRIBUTE</a>,
                                <a href="#bb038d3403da3163" class="t t">OutOfProcessUtils</a>.<a href="#f7cc1cc6451b9b2f" class="i field">PS_OUT_OF_PROC_CLOSE_TAG</a>);
                        }
 
                        <b>string</b> <span id="r41 rd" class="r41 r">psGuidString</span> = <span class="r27 r">xmlReader</span>.<span class="i">GetAttribute</span>(<a href="#bb038d3403da3163" class="t t">OutOfProcessUtils</a>.<a href="#4c3d3c59b947fb37" class="i field">PS_OUT_OF_PROC_PSGUID_ATTRIBUTE</a>);
                        <span class="i">Guid</span> <span id="r42 rd" class="r42 r">psGuid</span> = <b>new</b> <span class="i">Guid</span>(<span class="r41 r">psGuidString</span>);
 
                        <span class="r29 r">tracer</span>.<span class="i">WriteMessage</span>(<span class="s">&quot;OutOfProcessUtils.ProcessElement : PS_OUT_OF_PROC_CLOSE received, psGuid : &quot;</span> + <span class="r42 r">psGuid</span>.<span class="i">ToString</span>());
                        <span class="r28 r">callbacks</span>.<a href="#6200f3d3917d5c2b" class="i field">ClosePacketReceived</a>(<span class="r42 r">psGuid</span>);
                    }
 
                    <b>break</b>;
                <b>case</b> <a href="#bb038d3403da3163" class="t t">OutOfProcessUtils</a>.<a href="#cbf4145e6462e3f2" class="i field">PS_OUT_OF_PROC_CLOSE_ACK_TAG</a>:
                    {
                        <b>if</b> (<span class="r27 r">xmlReader</span>.<span class="i">AttributeCount</span> != 1)
                        {
                            <b>throw</b> <b>new</b> <span class="t">PSRemotingTransportException</span>(<a href="../common/remotingexceptions.cs.html#a969589d7508bf05" class="t t">PSRemotingErrorId</a>.<a href="../common/remotingexceptions.cs.html#b81cf06a288acf7b" class="i field">IPCWrongAttributeCountForElement</a>,
                            <span class="i">RemotingErrorIdStrings</span>.<span class="i">IPCWrongAttributeCountForElement</span>,
                                <a href="#bb038d3403da3163" class="t t">OutOfProcessUtils</a>.<a href="#4c3d3c59b947fb37" class="i field">PS_OUT_OF_PROC_PSGUID_ATTRIBUTE</a>,
                                <a href="#bb038d3403da3163" class="t t">OutOfProcessUtils</a>.<a href="#cbf4145e6462e3f2" class="i field">PS_OUT_OF_PROC_CLOSE_ACK_TAG</a>);
                        }
 
                        <b>string</b> <span id="r43 rd" class="r43 r">psGuidString</span> = <span class="r27 r">xmlReader</span>.<span class="i">GetAttribute</span>(<a href="#bb038d3403da3163" class="t t">OutOfProcessUtils</a>.<a href="#4c3d3c59b947fb37" class="i field">PS_OUT_OF_PROC_PSGUID_ATTRIBUTE</a>);
                        <span class="i">Guid</span> <span id="r44 rd" class="r44 r">psGuid</span> = <b>new</b> <span class="i">Guid</span>(<span class="r43 r">psGuidString</span>);
                        <span class="r29 r">tracer</span>.<span class="i">WriteMessage</span>(<span class="s">&quot;OutOfProcessUtils.ProcessElement : PS_OUT_OF_PROC_CLOSE_ACK received, psGuid : &quot;</span> + <span class="r44 r">psGuid</span>.<span class="i">ToString</span>());
                        <span class="r28 r">callbacks</span>.<a href="#b1a960f12d2a03a9" class="i field">CloseAckPacketReceived</a>(<span class="r44 r">psGuid</span>);
                    }
 
                    <b>break</b>;
                <b>case</b> <a href="#bb038d3403da3163" class="t t">OutOfProcessUtils</a>.<a href="#ce99cfb65df7f3fd" class="i field">PS_OUT_OF_PROC_SIGNAL_TAG</a>:
                    {
                        <b>if</b> (<span class="r27 r">xmlReader</span>.<span class="i">AttributeCount</span> != 1)
                        {
                            <b>throw</b> <b>new</b> <span class="t">PSRemotingTransportException</span>(<a href="../common/remotingexceptions.cs.html#a969589d7508bf05" class="t t">PSRemotingErrorId</a>.<a href="../common/remotingexceptions.cs.html#b81cf06a288acf7b" class="i field">IPCWrongAttributeCountForElement</a>,
                            <span class="i">RemotingErrorIdStrings</span>.<span class="i">IPCWrongAttributeCountForElement</span>,
                                <a href="#bb038d3403da3163" class="t t">OutOfProcessUtils</a>.<a href="#4c3d3c59b947fb37" class="i field">PS_OUT_OF_PROC_PSGUID_ATTRIBUTE</a>,
                                <a href="#bb038d3403da3163" class="t t">OutOfProcessUtils</a>.<a href="#ce99cfb65df7f3fd" class="i field">PS_OUT_OF_PROC_SIGNAL_TAG</a>);
                        }
 
                        <b>string</b> <span id="r45 rd" class="r45 r">psGuidString</span> = <span class="r27 r">xmlReader</span>.<span class="i">GetAttribute</span>(<a href="#bb038d3403da3163" class="t t">OutOfProcessUtils</a>.<a href="#4c3d3c59b947fb37" class="i field">PS_OUT_OF_PROC_PSGUID_ATTRIBUTE</a>);
                        <span class="i">Guid</span> <span id="r46 rd" class="r46 r">psGuid</span> = <b>new</b> <span class="i">Guid</span>(<span class="r45 r">psGuidString</span>);
 
                        <span class="r29 r">tracer</span>.<span class="i">WriteMessage</span>(<span class="s">&quot;OutOfProcessUtils.ProcessElement : PS_OUT_OF_PROC_SIGNAL received, psGuid : &quot;</span> + <span class="r46 r">psGuid</span>.<span class="i">ToString</span>());
                        <span class="r28 r">callbacks</span>.<a href="#b36a4b4bf60b2658" class="i field">SignalPacketReceived</a>(<span class="r46 r">psGuid</span>);
                    }
 
                    <b>break</b>;
                <b>case</b> <a href="#bb038d3403da3163" class="t t">OutOfProcessUtils</a>.<a href="#62d0487a88a3e0f0" class="i field">PS_OUT_OF_PROC_SIGNAL_ACK_TAG</a>:
                    {
                        <b>if</b> (<span class="r27 r">xmlReader</span>.<span class="i">AttributeCount</span> != 1)
                        {
                            <b>throw</b> <b>new</b> <span class="t">PSRemotingTransportException</span>(<a href="../common/remotingexceptions.cs.html#a969589d7508bf05" class="t t">PSRemotingErrorId</a>.<a href="../common/remotingexceptions.cs.html#b81cf06a288acf7b" class="i field">IPCWrongAttributeCountForElement</a>,
                            <span class="i">RemotingErrorIdStrings</span>.<span class="i">IPCWrongAttributeCountForElement</span>,
                                <a href="#bb038d3403da3163" class="t t">OutOfProcessUtils</a>.<a href="#4c3d3c59b947fb37" class="i field">PS_OUT_OF_PROC_PSGUID_ATTRIBUTE</a>,
                                <a href="#bb038d3403da3163" class="t t">OutOfProcessUtils</a>.<a href="#62d0487a88a3e0f0" class="i field">PS_OUT_OF_PROC_SIGNAL_ACK_TAG</a>);
                        }
 
                        <b>string</b> <span id="r47 rd" class="r47 r">psGuidString</span> = <span class="r27 r">xmlReader</span>.<span class="i">GetAttribute</span>(<a href="#bb038d3403da3163" class="t t">OutOfProcessUtils</a>.<a href="#4c3d3c59b947fb37" class="i field">PS_OUT_OF_PROC_PSGUID_ATTRIBUTE</a>);
                        <span class="i">Guid</span> <span id="r48 rd" class="r48 r">psGuid</span> = <b>new</b> <span class="i">Guid</span>(<span class="r47 r">psGuidString</span>);
                        <span class="r29 r">tracer</span>.<span class="i">WriteMessage</span>(<span class="s">&quot;OutOfProcessUtils.ProcessElement : PS_OUT_OF_PROC_SIGNAL_ACK received, psGuid : &quot;</span> + <span class="r48 r">psGuid</span>.<span class="i">ToString</span>());
                        <span class="r28 r">callbacks</span>.<a href="#320b3821c4ddb687" class="i field">SignalAckPacketReceived</a>(<span class="r48 r">psGuid</span>);
                    }
 
                    <b>break</b>;
                <b>default</b>:
                    <b>throw</b> <b>new</b> <span class="t">PSRemotingTransportException</span>(<a href="../common/remotingexceptions.cs.html#a969589d7508bf05" class="t t">PSRemotingErrorId</a>.<a href="../common/remotingexceptions.cs.html#e4dabb20bede1ee9" class="i field">IPCUnknownElementReceived</a>,
                    <span class="i">RemotingErrorIdStrings</span>.<span class="i">IPCUnknownElementReceived</span>,
                        <span class="r27 r">xmlReader</span>.<span class="i">LocalName</span>);
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
    }
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> A wrapper around TextWriter to allow for synchronized writing to a stream.</span>
    <span class="c">///</span><span class="c"> Synchronization is required to avoid collision when multiple TransportManager&#39;s</span>
    <span class="c">///</span><span class="c"> write data at the same time to the same writer.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>internal class</b> <a id="3676916334ddb503" href="../../../R/3676916334ddb503.html" target="n" data-glyph="2,0" class="t t">OutOfProcessTextWriter</a>
    {
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Private Data
 
        <b>private readonly</b> <span class="i">TextWriter</span> <a id="43a4d37fa12d9eed" href="../../../R/43a4d37fa12d9eed.html" target="n" data-glyph="46,1" class="i field">_writer</a>;
        <b>private bool</b> <a id="6fea89954957c239" href="../../../R/6fea89954957c239.html" target="n" data-glyph="46,1" class="i field">_isStopped</a>;
        <b>private readonly object</b> <a id="1519c970e7c7ef9d" href="../../../R/1519c970e7c7ef9d.html" target="n" data-glyph="46,1" class="i field">_syncObject</a> = <b>new</b> <b>object</b>();
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Constructors
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Constructs the wrapper.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r49 r">writerToWrap</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal</b> <a id="967f1719da95fd5d" href="../../../R/967f1719da95fd5d.html" target="n" data-glyph="74,1" class="t constructor">OutOfProcessTextWriter</a>(<span class="i">TextWriter</span> <span id="r49 rd" class="r49 r">writerToWrap</span>)
        {
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r49 r">writerToWrap</span> != <b>null</b>, <span class="s">&quot;Cannot wrap a null writer.&quot;</span>);
            <a href="#43a4d37fa12d9eed" class="i field">_writer</a> = <span class="r49 r">writerToWrap</span>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Methods
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Calls writer.WriteLine() with data.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r50 r">data</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal virtual void</b> <a id="1fb9fbc09f4031a8" href="../../../R/1fb9fbc09f4031a8.html" target="n" data-glyph="74,1" class="i method">WriteLine</a>(<b>string</b> <span id="r50 rd" class="r50 r">data</span>)
        {
            <b>if</b> (<a href="#6fea89954957c239" class="i field">_isStopped</a>)
            {
                <b>return</b>;
            }
 
            <b>lock</b> (<a href="#1519c970e7c7ef9d" class="i field">_syncObject</a>)
            {
                <a href="#43a4d37fa12d9eed" class="i field">_writer</a>.<span class="i">WriteLine</span>(<span class="r50 r">data</span>);
                <a href="#43a4d37fa12d9eed" class="i field">_writer</a>.<span class="i">Flush</span>();
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Stops the writer from writing anything to the stream.</span>
        <span class="c">///</span><span class="c"> This is used by session transport manager when the server</span>
        <span class="c">///</span><span class="c"> process is exited but the session data structure handlers</span>
        <span class="c">///</span><span class="c"> are not notified yet. So while the data structure handler</span>
        <span class="c">///</span><span class="c"> is disposing we should not let anyone use the stream.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="d34489fc1e9abc0c" href="../../../R/d34489fc1e9abc0c.html" target="n" data-glyph="74,1" class="i method">StopWriting</a>()
        {
            <a href="#6fea89954957c239" class="i field">_isStopped</a> = <b>true</b>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
    }
}
 
<b>namespace</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Remoting</span>.<span class="i n">Client</span>
{
    <b>internal abstract class</b> <a id="d45b9c7a452bcb48" href="../../../R/d45b9c7a452bcb48.html" target="n" data-glyph="2,0" class="t t">OutOfProcessClientSessionTransportManagerBase</a> : <a href="BaseTransportManager.cs.html#19883ec4df424177" class="t t">BaseClientSessionTransportManager</a>
    {
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Data
 
        <b>private readonly</b> <span class="i">BlockingCollection</span>&lt;<b>string</b>&gt; <a id="d67a9791e55dd9f1" href="../../../R/d67a9791e55dd9f1.html" target="n" data-glyph="46,1" class="i field">_sessionMessageQueue</a>;
        <b>private readonly</b> <span class="i">BlockingCollection</span>&lt;<b>string</b>&gt; <a id="e7318c06f72ebfe8" href="../../../R/e7318c06f72ebfe8.html" target="n" data-glyph="46,1" class="i field">_commandMessageQueue</a>;
        <b>private readonly</b> <a href="PriorityCollection.cs.html#0fa204cb5092e738" class="t t">PrioritySendDataCollection</a>.<a href="PriorityCollection.cs.html#81c7391587f527f6" class="t t">OnDataAvailableCallback</a> <a id="9e3538c8802824ff" href="../../../R/9e3538c8802824ff.html" target="n" data-glyph="46,1" class="i field">_onDataAvailableToSendCallback</a>;
        <b>private</b> <a href="#bb038d3403da3163" class="t t">OutOfProcessUtils</a>.<a href="#d3319d959b3f01b4" class="t t">DataProcessingDelegates</a> <a id="481644073ee8830d" href="../../../R/481644073ee8830d.html" target="n" data-glyph="46,1" class="i field">_dataProcessingCallbacks</a>;
        <b>private readonly</b> <span class="i">Dictionary</span>&lt;<span class="i">Guid</span>, <a href="#920a85d8937fe495" class="t t">OutOfProcessClientCommandTransportManager</a>&gt; <a id="ec8dbfe2d3fa342d" href="../../../R/ec8dbfe2d3fa342d.html" target="n" data-glyph="46,1" class="i field">_cmdTransportManagers</a>;
        <b>private readonly</b> <span class="i">Timer</span> <a id="3a3e22027b208ef3" href="../../../R/3a3e22027b208ef3.html" target="n" data-glyph="46,1" class="i field">_closeTimeOutTimer</a>;
 
        <b>protected</b> <a href="#3676916334ddb503" class="t t">OutOfProcessTextWriter</a> <a id="908a2aa48b413a01" href="../../../R/908a2aa48b413a01.html" target="n" data-glyph="45,1" class="i field">stdInWriter</a>;
        <b>protected</b> <a href="../../../utils/PowerShellETWTracer.cs.html#3fd13a01d0177ce2" class="t t">PowerShellTraceSource</a> <a id="8de2a991a3b17128" href="../../../R/8de2a991a3b17128.html" target="n" data-glyph="45,1" class="i field">_tracer</a>;
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Constructor
 
        <b>internal</b> <a id="9c94004483e5b344" href="../../../R/9c94004483e5b344.html" target="n" data-glyph="74,1" class="t constructor">OutOfProcessClientSessionTransportManagerBase</a>(
            <span class="i">Guid</span> <span id="r51 rd" class="r51 r">runspaceId</span>,
            <a href="../../../utils/CryptoUtils.cs.html#1999dfb2439af5a0" class="t t">PSRemotingCryptoHelper</a> <span id="r52 rd" class="r52 r">cryptoHelper</span>)
            : <a href="BaseTransportManager.cs.html#be06f3503cfac6d4" class="k">base</a>(<span class="r51 r">runspaceId</span>, <span class="r52 r">cryptoHelper</span>)
        {
            <a href="#9e3538c8802824ff" class="i field">_onDataAvailableToSendCallback</a> =
                <b>new</b> <a href="PriorityCollection.cs.html#0fa204cb5092e738" class="t t">PrioritySendDataCollection</a>.<span class="t">OnDataAvailableCallback</span>(<a href="#99bb337337d6c7bb" class="i method">OnDataAvailableCallback</a>);
 
            <a href="#ec8dbfe2d3fa342d" class="i field">_cmdTransportManagers</a> = <b>new</b> <span class="i">Dictionary</span>&lt;<span class="i">Guid</span>, <a href="#920a85d8937fe495" class="t t">OutOfProcessClientCommandTransportManager</a>&gt;();
 
            <a href="#481644073ee8830d" class="i field">_dataProcessingCallbacks</a> = <b>new</b> <a href="#bb038d3403da3163" class="t t">OutOfProcessUtils</a>.<span class="t">DataProcessingDelegates</span>();
            <a href="#481644073ee8830d" class="i field">_dataProcessingCallbacks</a>.<a href="#cb5c0d4f23d23e92" class="i field">DataPacketReceived</a> += <b>new</b> <a href="#bb038d3403da3163" class="t t">OutOfProcessUtils</a>.<span class="t">DataPacketReceived</span>(<a href="#ad3a5768a216d92c" class="i method">OnDataPacketReceived</a>);
            <a href="#481644073ee8830d" class="i field">_dataProcessingCallbacks</a>.<a href="#965174e291299456" class="i field">DataAckPacketReceived</a> += <b>new</b> <a href="#bb038d3403da3163" class="t t">OutOfProcessUtils</a>.<span class="t">DataAckPacketReceived</span>(<a href="#782e4734887988c1" class="i method">OnDataAckPacketReceived</a>);
            <a href="#481644073ee8830d" class="i field">_dataProcessingCallbacks</a>.<a href="#86ed179bec374226" class="i field">CommandCreationPacketReceived</a> += <b>new</b> <a href="#bb038d3403da3163" class="t t">OutOfProcessUtils</a>.<span class="t">CommandCreationPacketReceived</span>(<a href="#5c8a1194b92c6e9e" class="i method">OnCommandCreationPacketReceived</a>);
            <a href="#481644073ee8830d" class="i field">_dataProcessingCallbacks</a>.<a href="#c17901dc153a0229" class="i field">CommandCreationAckReceived</a> += <b>new</b> <a href="#bb038d3403da3163" class="t t">OutOfProcessUtils</a>.<span class="t">CommandCreationAckReceived</span>(<a href="#33f14658aa08e140" class="i method">OnCommandCreationAckReceived</a>);
            <a href="#481644073ee8830d" class="i field">_dataProcessingCallbacks</a>.<a href="#b36a4b4bf60b2658" class="i field">SignalPacketReceived</a> += <b>new</b> <a href="#bb038d3403da3163" class="t t">OutOfProcessUtils</a>.<span class="t">SignalPacketReceived</span>(<a href="#85acaa64c34ebb05" class="i method">OnSignalPacketReceived</a>);
            <a href="#481644073ee8830d" class="i field">_dataProcessingCallbacks</a>.<a href="#320b3821c4ddb687" class="i field">SignalAckPacketReceived</a> += <b>new</b> <a href="#bb038d3403da3163" class="t t">OutOfProcessUtils</a>.<span class="t">SignalAckPacketReceived</span>(<a href="#cbb6feb5e5a8a563" class="i method">OnSignalAckPacketReceived</a>);
            <a href="#481644073ee8830d" class="i field">_dataProcessingCallbacks</a>.<a href="#6200f3d3917d5c2b" class="i field">ClosePacketReceived</a> += <b>new</b> <a href="#bb038d3403da3163" class="t t">OutOfProcessUtils</a>.<span class="t">ClosePacketReceived</span>(<a href="#17e1f4bec3847a12" class="i method">OnClosePacketReceived</a>);
            <a href="#481644073ee8830d" class="i field">_dataProcessingCallbacks</a>.<a href="#b1a960f12d2a03a9" class="i field">CloseAckPacketReceived</a> += <b>new</b> <a href="#bb038d3403da3163" class="t t">OutOfProcessUtils</a>.<span class="t">CloseAckPacketReceived</span>(<a href="#31e3c988a47aa163" class="i method">OnCloseAckReceived</a>);
 
            <a href="BaseTransportManager.cs.html#ee4a2ac1afa72dce" class="i field">dataToBeSent</a>.<a href="PriorityCollection.cs.html#84bdedfd536de402" class="i property">Fragmentor</a> = <a href="BaseTransportManager.cs.html#19883ec4df424177" class="k">base</a>.<a href="BaseTransportManager.cs.html#0597b18306926355" class="i property">Fragmentor</a>;
            <span class="c">// session transport manager can receive unlimited data..however each object is limited</span>
            <span class="c">// by maxRecvdObjectSize. this is to allow clients to use a session for an unlimited time..</span>
            <span class="c">// also the messages that can be sent to a session are limited and very controlled.</span>
            <span class="c">// However a command transport manager can be restricted to receive only a fixed amount of data</span>
            <span class="c">// controlled by maxRecvdDataSizeCommand..This is because commands can accept any number of input</span>
            <span class="c">// objects.</span>
            <a href="BaseTransportManager.cs.html#766c6c998b78695f" class="i property">ReceivedDataCollection</a>.<a href="PriorityCollection.cs.html#7a540327df6a2e2d" class="i property">MaximumReceivedDataSize</a> = <b>null</b>;
            <a href="BaseTransportManager.cs.html#766c6c998b78695f" class="i property">ReceivedDataCollection</a>.<a href="PriorityCollection.cs.html#24de42a1b1c1d4b9" class="i property">MaximumReceivedObjectSize</a> = <a href="BaseTransportManager.cs.html#9ccd7ea4a824f9d8" class="t t">BaseTransportManager</a>.<a href="BaseTransportManager.cs.html#f93a293eb909c256" class="i field">MaximumReceivedObjectSize</a>;
            <span class="c">// timers initialization</span>
            <a href="#3a3e22027b208ef3" class="i field">_closeTimeOutTimer</a> = <b>new</b> <span class="i">Timer</span>(<span class="i">OnCloseTimeOutTimerElapsed</span>, <b>null</b>, <span class="i">Timeout</span>.<span class="i">Infinite</span>, <span class="i">Timeout</span>.<span class="i">Infinite</span>);
 
            <span class="c">// Session message processing</span>
            <a href="#d67a9791e55dd9f1" class="i field">_sessionMessageQueue</a> = <b>new</b> <span class="i">BlockingCollection</span>&lt;<b>string</b>&gt;();
            <b>var</b> <span id="r53 rd" class="r53 r">sessionThread</span> = <b>new</b> <span class="i">Thread</span>(<span class="i">ProcessMessageProc</span>);
            <span class="r53 r">sessionThread</span>.<span class="i">Name</span> = <span class="s">&quot;SessionMessageProcessing&quot;</span>;
            <span class="r53 r">sessionThread</span>.<span class="i">IsBackground</span> = <b>true</b>;
            <span class="r53 r">sessionThread</span>.<span class="i">Start</span>(<a href="#d67a9791e55dd9f1" class="i field">_sessionMessageQueue</a>);
 
            <span class="c">// Command message processing</span>
            <a href="#e7318c06f72ebfe8" class="i field">_commandMessageQueue</a> = <b>new</b> <span class="i">BlockingCollection</span>&lt;<b>string</b>&gt;();
            <b>var</b> <span id="r54 rd" class="r54 r">commandThread</span> = <b>new</b> <span class="i">Thread</span>(<span class="i">ProcessMessageProc</span>);
            <span class="r54 r">commandThread</span>.<span class="i">Name</span> = <span class="s">&quot;CommandMessageProcessing&quot;</span>;
            <span class="r54 r">commandThread</span>.<span class="i">IsBackground</span> = <b>true</b>;
            <span class="r54 r">commandThread</span>.<span class="i">Start</span>(<a href="#e7318c06f72ebfe8" class="i field">_commandMessageQueue</a>);
 
            <a href="#8de2a991a3b17128" class="i field">_tracer</a> = <a href="../../../utils/PowerShellETWTracer.cs.html#37e484a307a595c3" class="t t">PowerShellTraceSourceFactory</a>.<a href="../../../utils/PowerShellETWTracer.cs.html#c94a9fbfef99a75d" class="i method">GetTraceSource</a>();
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Overrides
 
        <b>internal override void</b> <a id="f35b3720408e8716" href="../../../R/f35b3720408e8716.html" target="n" data-glyph="74,1" class="i method">ConnectAsync</a>()
        {
            <b>throw</b> <b>new</b> <span class="i">NotImplementedException</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">IPCTransportConnectError</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Closes the server process.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal override void</b> <a id="0f5b460979385f69" href="../../../R/0f5b460979385f69.html" target="n" data-glyph="74,1" class="i method">CloseAsync</a>()
        {
            <b>bool</b> <span id="r55 rd" class="r55 r">shouldRaiseCloseCompleted</span> = <b>false</b>;
            <b>lock</b> (<a href="BaseTransportManager.cs.html#2b6037d6b3777ca1" class="i field">syncObject</a>)
            {
                <b>if</b> (<a href="BaseTransportManager.cs.html#76271338de46dcf0" class="i field">isClosed</a>)
                {
                    <b>return</b>;
                }
 
                <span class="c">// first change the state..so other threads</span>
                <span class="c">// will know that we are closing.</span>
                <a href="BaseTransportManager.cs.html#76271338de46dcf0" class="i field">isClosed</a> = <b>true</b>;
 
                <b>if</b> (<a href="#908a2aa48b413a01" class="i field">stdInWriter</a> == <b>null</b>)
                {
                    <span class="c">// this will happen if CloseAsync() is called</span>
                    <span class="c">// before ConnectAsync()..in which case we</span>
                    <span class="c">// just need to raise close completed event.</span>
                    <span class="r55 r">shouldRaiseCloseCompleted</span> = <b>true</b>;
                }
            }
 
            <a href="BaseTransportManager.cs.html#19883ec4df424177" class="k">base</a>.<a href="BaseTransportManager.cs.html#8487786a35819f66" class="i method">CloseAsync</a>();
 
            <b>if</b> (<span class="r55 r">shouldRaiseCloseCompleted</span>)
            {
                <a href="BaseTransportManager.cs.html#ce72d08b48a8f70f" class="i method">RaiseCloseCompleted</a>();
                <b>return</b>;
            }
 
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(<a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#e194fca851222be4" class="i field">WSManCloseShell</a>,
                <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#f3d85cb80e62fe3e" class="i field">Disconnect</a>, <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>, <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#c5d4a73b62c859ab" class="i field">Transport</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                <a href="BaseTransportManager.cs.html#6b69cd5f8cc06fb7" class="i property">RunspacePoolInstanceId</a>.<span class="i">ToString</span>());
 
            <a href="#8de2a991a3b17128" class="i field">_tracer</a>.<span class="i">WriteMessage</span>(<span class="s">&quot;OutOfProcessClientSessionTransportManager.CloseAsync, when sending close session packet, progress command count should be zero, current cmd count: &quot;</span> + <a href="#ec8dbfe2d3fa342d" class="i field">_cmdTransportManagers</a>.<span class="i">Count</span> + <span class="s">&quot;, RunSpacePool Id : &quot;</span> + <a href="#d45b9c7a452bcb48" class="k">this</a>.<a href="BaseTransportManager.cs.html#6b69cd5f8cc06fb7" class="i property">RunspacePoolInstanceId</a>);
 
            <b>try</b>
            {
                <span class="c">// send Close signal to the server and let it die gracefully.</span>
                <a href="#908a2aa48b413a01" class="i field">stdInWriter</a>.<a href="#1fb9fbc09f4031a8" class="i method">WriteLine</a>(<a href="#bb038d3403da3163" class="t t">OutOfProcessUtils</a>.<span class="i">CreateClosePacket</span>(<span class="i">Guid</span>.<span class="i">Empty</span>));
 
                <span class="c">// start the timer..so client can fail deterministically</span>
                <a href="#3a3e22027b208ef3" class="i field">_closeTimeOutTimer</a>.<span class="i">Change</span>(60 * 1000, <span class="i">Timeout</span>.<span class="i">Infinite</span>);
            }
            <b>catch</b> (<span class="i">Exception</span> <span id="r56 rd" class="r56 r">ex</span>) <b>when</b> (<span class="r56 r">ex</span> <b>is</b> <span class="i">IOException</span> || <span class="r56 r">ex</span> <b>is</b> <span class="i">ObjectDisposedException</span>)
            {
                <span class="c">// Cannot communicate with server.  Allow client to complete close operation.</span>
                <span class="r55 r">shouldRaiseCloseCompleted</span> = <b>true</b>;
            }
 
            <b>if</b> (<span class="r55 r">shouldRaiseCloseCompleted</span>)
            {
                <a href="BaseTransportManager.cs.html#ce72d08b48a8f70f" class="i method">RaiseCloseCompleted</a>();
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Create a transport manager for command.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r57 r">connectionInfo</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r58 r">cmd</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r59 r">noInput</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal override</b> <a href="BaseTransportManager.cs.html#fa455a694094fdc2" class="t t">BaseClientCommandTransportManager</a> <a id="e5748617736f0ddd" href="../../../R/e5748617736f0ddd.html" target="n" data-glyph="74,1" class="i method">CreateClientCommandTransportManager</a>(
            <a href="../common/RunspaceConnectionInfo.cs.html#e07ed56a8a1da829" class="t t">RunspaceConnectionInfo</a> <span id="r57 rd" class="r57 r">connectionInfo</span>,
            <a href="../client/ClientRemotePowerShell.cs.html#b4d2ac017883b31c" class="t t">ClientRemotePowerShell</a> <span id="r58 rd" class="r58 r">cmd</span>,
            <b>bool</b> <span id="r59 rd" class="r59 r">noInput</span>)
        {
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r58 r">cmd</span> != <b>null</b>, <span class="s">&quot;Cmd cannot be null&quot;</span>);
 
            <a href="#920a85d8937fe495" class="t t">OutOfProcessClientCommandTransportManager</a> <span id="r60 rd" class="r60 r">result</span> = <b>new</b>
                <a href="#0feabc9f3cc636ae" class="t constructor">OutOfProcessClientCommandTransportManager</a>(<span class="r58 r">cmd</span>, <span class="r59 r">noInput</span>, <a href="#d45b9c7a452bcb48" class="k">this</a>, <a href="#908a2aa48b413a01" class="i field">stdInWriter</a>);
            <a href="#19916f5e78dfda10" class="i method">AddCommandTransportManager</a>(<span class="r58 r">cmd</span>.<a href="../client/ClientRemotePowerShell.cs.html#71022daeee1769bc" class="i property">InstanceId</a>, <span class="r60 r">result</span>);
 
            <b>return</b> <span class="r60 r">result</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Terminates the server process and disposes other resources.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r61 r">isDisposing</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal override void</b> <a id="78bbdada56985127" href="../../../R/78bbdada56985127.html" target="n" data-glyph="74,1" class="i method">Dispose</a>(<b>bool</b> <span id="r61 rd" class="r61 r">isDisposing</span>)
        {
            <a href="BaseTransportManager.cs.html#19883ec4df424177" class="k">base</a>.<a href="BaseTransportManager.cs.html#28896ed8464e84b5" class="i method">Dispose</a>(<span class="r61 r">isDisposing</span>);
            <b>if</b> (<span class="r61 r">isDisposing</span>)
            {
                <a href="#ec8dbfe2d3fa342d" class="i field">_cmdTransportManagers</a>.<span class="i">Clear</span>();
                <a href="#3a3e22027b208ef3" class="i field">_closeTimeOutTimer</a>.<span class="i">Dispose</span>();
                <a href="#5a8ad2d42b546b1d" class="i method">DisposeMessageQueue</a>();
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Helper Methods
 
        <b>private void</b> <a id="19916f5e78dfda10" href="../../../R/19916f5e78dfda10.html" target="n" data-glyph="76,1" class="i method">AddCommandTransportManager</a>(<span class="i">Guid</span> <span id="r62 rd" class="r62 r">key</span>, <a href="#920a85d8937fe495" class="t t">OutOfProcessClientCommandTransportManager</a> <span id="r63 rd" class="r63 r">cmdTM</span>)
        {
            <b>lock</b> (<a href="BaseTransportManager.cs.html#2b6037d6b3777ca1" class="i field">syncObject</a>)
            {
                <b>if</b> (<a href="BaseTransportManager.cs.html#76271338de46dcf0" class="i field">isClosed</a>)
                {
                    <span class="c">// It is possible for this add command to occur after/during session close via</span>
                    <span class="c">// asynchronous stop pipeline or Stop-Job.  In this case ignore the command.</span>
                    <a href="#8de2a991a3b17128" class="i field">_tracer</a>.<span class="i">WriteMessage</span>(<span class="s">&quot;OutOfProcessClientSessionTransportManager.AddCommandTransportManager, Adding command transport on closed session, RunSpacePool Id : &quot;</span> + <a href="#d45b9c7a452bcb48" class="k">this</a>.<a href="BaseTransportManager.cs.html#6b69cd5f8cc06fb7" class="i property">RunspacePoolInstanceId</a>);
                    <b>return</b>;
                }
 
                <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<span class="i">Assert</span>(!<a href="#ec8dbfe2d3fa342d" class="i field">_cmdTransportManagers</a>.<span class="i">ContainsKey</span>(<span class="r62 r">key</span>), <span class="s">&quot;key already exists&quot;</span>);
                <a href="#ec8dbfe2d3fa342d" class="i field">_cmdTransportManagers</a>.<span class="i">Add</span>(<span class="r62 r">key</span>, <span class="r63 r">cmdTM</span>);
            }
        }
 
        <b>internal override void</b> <a id="9bffa9adf149cd66" href="../../../R/9bffa9adf149cd66.html" target="n" data-glyph="74,1" class="i method">RemoveCommandTransportManager</a>(<span class="i">Guid</span> <span id="r64 rd" class="r64 r">key</span>)
        {
            <b>lock</b> (<a href="BaseTransportManager.cs.html#2b6037d6b3777ca1" class="i field">syncObject</a>)
            {
                <span class="c">// We always need to remove commands from collection, even if isClosed is true.</span>
                <span class="c">// If we don&#39;t then we will not respond because CloseAsync() will not complete until all</span>
                <span class="c">// commands are closed.</span>
                <b>if</b> (!<a href="#ec8dbfe2d3fa342d" class="i field">_cmdTransportManagers</a>.<span class="i">Remove</span>(<span class="r64 r">key</span>))
                {
                    <a href="#8de2a991a3b17128" class="i field">_tracer</a>.<a href="../../../utils/PowerShellETWTracer.cs.html#74d51c2de1926e3a" class="i method">WriteMessage</a>(<span class="s">&quot;key does not exist to remove from cmdTransportManagers&quot;</span>);
                }
            }
        }
 
        <b>private</b> <a href="#920a85d8937fe495" class="t t">OutOfProcessClientCommandTransportManager</a> <a id="b161090f7dabb5db" href="../../../R/b161090f7dabb5db.html" target="n" data-glyph="76,1" class="i method">GetCommandTransportManager</a>(<span class="i">Guid</span> <span id="r65 rd" class="r65 r">key</span>)
        {
            <b>lock</b> (<a href="BaseTransportManager.cs.html#2b6037d6b3777ca1" class="i field">syncObject</a>)
            {
                <a href="#920a85d8937fe495" class="t t">OutOfProcessClientCommandTransportManager</a> <span id="r66 rd" class="r66 r">result</span> = <b>null</b>;
                <a href="#ec8dbfe2d3fa342d" class="i field">_cmdTransportManagers</a>.<span class="i">TryGetValue</span>(<span class="r65 r">key</span>, <b>out</b> <span class="r66 r">result</span>);
                <b>return</b> <span class="r66 r">result</span>;
            }
        }
 
        <b>private void</b> <a id="70aa7fa0df2f5e32" href="../../../R/70aa7fa0df2f5e32.html" target="n" data-glyph="76,1" class="i method">OnCloseSessionCompleted</a>()
        {
            <span class="c">// stop timer</span>
            <a href="#3a3e22027b208ef3" class="i field">_closeTimeOutTimer</a>.<span class="i">Change</span>(<span class="i">Timeout</span>.<span class="i">Infinite</span>, <span class="i">Timeout</span>.<span class="i">Infinite</span>);
 
            <a href="BaseTransportManager.cs.html#ce72d08b48a8f70f" class="i method">RaiseCloseCompleted</a>();
            <a href="#28f9cd28ec8bf470" class="i method">CleanupConnection</a>();
        }
 
        <b>protected abstract void</b> <a id="28f9cd28ec8bf470" href="../../../R/28f9cd28ec8bf470.html" target="n" data-glyph="75,1" class="i method">CleanupConnection</a>();
 
        <b>private void</b> <a id="51c5c8953a28aaca" href="../../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">ProcessMessageProc</a>(<b>object</b> <span id="r67 rd" class="r67 r">state</span>)
        {
            <b>var</b> <span id="r68 rd" class="r68 r">messageQueue</span> = <span class="r67 r">state</span> <b>as</b> <span class="i">BlockingCollection</span>&lt;<b>string</b>&gt;;
 
            <b>try</b>
            {
                <b>while</b> (<b>true</b>)
                {
                    <b>var</b> <span id="r69 rd" class="r69 r">data</span> = <span class="r68 r">messageQueue</span>.<span class="i">Take</span>();
                    <b>try</b>
                    {
                        <a href="#bb038d3403da3163" class="t t">OutOfProcessUtils</a>.<span class="i">ProcessData</span>(<span class="r69 r">data</span>, <a href="#481644073ee8830d" class="i field">_dataProcessingCallbacks</a>);
                    }
                    <b>catch</b> (<span class="i">Exception</span> <span id="r70 rd" class="r70 r">exception</span>)
                    {
                        <a href="../common/remotingexceptions.cs.html#0bb8687f97d91059" class="t t">PSRemotingTransportException</a> <span id="r71 rd" class="r71 r">psrte</span> =
                            <b>new</b> <span class="t">PSRemotingTransportException</span>(
                                <a href="../common/remotingexceptions.cs.html#a969589d7508bf05" class="t t">PSRemotingErrorId</a>.<a href="../common/remotingexceptions.cs.html#c39f8f503fd0d7aa" class="i field">IPCErrorProcessingServerData</a>,
                                <span class="i">RemotingErrorIdStrings</span>.<span class="i">IPCErrorProcessingServerData</span>,
                                <span class="r70 r">exception</span>.<span class="i">Message</span>);
                        <a href="BaseTransportManager.cs.html#8e00d8a2f8745652" class="i method">RaiseErrorHandler</a>(<b>new</b> <a href="BaseTransportManager.cs.html#c420864940871a42" class="t constructor">TransportErrorOccuredEventArgs</a>(<span class="r71 r">psrte</span>, <a href="BaseTransportManager.cs.html#33678df914ca9daf" class="t t">TransportMethodEnum</a>.<a href="BaseTransportManager.cs.html#c91edb639e1ae62a" class="i field">ReceiveShellOutputEx</a>));
                    }
                }
            }
            <b>catch</b> (<span class="i">InvalidOperationException</span>)
            {
                <span class="c">// Normal session message processing thread end.</span>
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Event Handlers
 
        <b>private const string</b> <a id="d92dbe3b5d2aac98" href="../../../R/d92dbe3b5d2aac98.html" target="n" data-glyph="10,1" class="i field">SESSIONDMESSAGETAG</a> = <span class="s">&quot;PSGuid=&#39;00000000-0000-0000-0000-000000000000&#39;&quot;</span>;
 
        <b>protected void</b> <a id="01b8d088286a3591" href="../../../R/01b8d088286a3591.html" target="n" data-glyph="75,1" class="i method">HandleOutputDataReceived</a>(<b>string</b> <span id="r72 rd" class="r72 r">data</span>)
        {
            <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r72 r">data</span>))
            {
                <span class="c">// A null/empty data string indicates a problem in the transport,</span>
                <span class="c">// e.g., named pipe emitting a null packet because it closed or some reason.</span>
                <span class="c">// In this case we simply ignore the packet.</span>
                <b>return</b>;
            }
 
            <b>try</b>
            {
                <span class="c">// Route protocol message based on whether it is a session or command message.</span>
                <b>if</b> (<span class="r72 r">data</span>.<span class="i">Contains</span>(<a href="#d92dbe3b5d2aac98" class="i field">SESSIONDMESSAGETAG</a>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
                {
                    <span class="c">// Session message</span>
                    <a href="#d67a9791e55dd9f1" class="i field">_sessionMessageQueue</a>.<span class="i">Add</span>(<span class="r72 r">data</span>);
                }
                <b>else</b>
                {
                    <span class="c">// Command message</span>
                    <a href="#e7318c06f72ebfe8" class="i field">_commandMessageQueue</a>.<span class="i">Add</span>(<span class="r72 r">data</span>);
                }
            }
            <b>catch</b> (<span class="i">InvalidOperationException</span>)
            {
                <span class="c">// This exception will be thrown by the BlockingCollection message queue objects</span>
                <span class="c">// after they have been closed.</span>
            }
        }
 
        <b>protected void</b> <a id="da60ecb1a90ace20" href="../../../R/da60ecb1a90ace20.html" target="n" data-glyph="75,1" class="i method">HandleErrorDataReceived</a>(<b>string</b> <span id="r73 rd" class="r73 r">data</span>)
        {
            <b>lock</b> (<a href="BaseTransportManager.cs.html#2b6037d6b3777ca1" class="i field">syncObject</a>)
            {
                <b>if</b> (<a href="BaseTransportManager.cs.html#76271338de46dcf0" class="i field">isClosed</a>)
                {
                    <b>return</b>;
                }
            }
 
            <a href="../common/remotingexceptions.cs.html#0bb8687f97d91059" class="t t">PSRemotingTransportException</a> <span id="r74 rd" class="r74 r">psrte</span> = <b>new</b> <span class="t">PSRemotingTransportException</span>(<a href="../common/remotingexceptions.cs.html#a969589d7508bf05" class="t t">PSRemotingErrorId</a>.<a href="../common/remotingexceptions.cs.html#c5268fb78fd26d44" class="i field">IPCServerProcessReportedError</a>,
                <span class="i">RemotingErrorIdStrings</span>.<span class="i">IPCServerProcessReportedError</span>,
                <span class="r73 r">data</span>);
            <a href="BaseTransportManager.cs.html#8e00d8a2f8745652" class="i method">RaiseErrorHandler</a>(<b>new</b> <a href="BaseTransportManager.cs.html#c420864940871a42" class="t constructor">TransportErrorOccuredEventArgs</a>(<span class="r74 r">psrte</span>, <a href="BaseTransportManager.cs.html#33678df914ca9daf" class="t t">TransportMethodEnum</a>.<a href="BaseTransportManager.cs.html#ec9b351bc6228ffe" class="i field">Unknown</a>));
        }
 
        <b>protected void</b> <a id="19ceca204539c478" href="../../../R/../../0000000000.html" target="n" data-glyph="75,1" class="i method">OnExited</a>(<b>object</b> <span id="r75 rd" class="r75 r">sender</span>, <span class="i">EventArgs</span> <span id="r76 rd" class="r76 r">e</span>)
        {
            <a href="BaseTransportManager.cs.html#33678df914ca9daf" class="t t">TransportMethodEnum</a> <span id="r77 rd" class="r77 r">transportMethod</span> = <a href="BaseTransportManager.cs.html#33678df914ca9daf" class="t t">TransportMethodEnum</a>.<a href="BaseTransportManager.cs.html#ec9b351bc6228ffe" class="i field">Unknown</a>;
            <b>lock</b> (<a href="BaseTransportManager.cs.html#2b6037d6b3777ca1" class="i field">syncObject</a>)
            {
                <span class="c">// There is no need to return when IsClosed==true here as in a legitimate case process exits</span>
                <span class="c">// after Close is called..In that legitimate case, Exit handler is removed before</span>
                <span class="c">// calling Exit..So, this Exit must have been called abnormally.</span>
                <b>if</b> (<a href="BaseTransportManager.cs.html#76271338de46dcf0" class="i field">isClosed</a>)
                {
                    <span class="r77 r">transportMethod</span> = <a href="BaseTransportManager.cs.html#33678df914ca9daf" class="t t">TransportMethodEnum</a>.<a href="BaseTransportManager.cs.html#2cc9ee1cdce7fca6" class="i field">CloseShellOperationEx</a>;
                }
 
                <span class="c">// dont let the writer write new data as the process is exited.</span>
                <span class="c">// Not assigning null to stdInWriter to fix the race condition between OnExited() and CloseAsync() methods.</span>
                <span class="c">//</span>
                <a href="#908a2aa48b413a01" class="i field">stdInWriter</a>.<a href="#d34489fc1e9abc0c" class="i method">StopWriting</a>();
            }
 
            <span class="c">// Try to get details about why the process exited</span>
            <span class="c">// and if they&#39;re not available, give information as to why</span>
            <b>string</b> <span id="r78 rd" class="r78 r">processDiagnosticMessage</span>;
            <b>try</b>
            {
                <b>var</b> <span id="r79 rd" class="r79 r">jobProcess</span> = (<span class="i">Process</span>)<span class="r75 r">sender</span>;
                <span class="r78 r">processDiagnosticMessage</span> = <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(
                    <span class="i">RemotingErrorIdStrings</span>.<span class="i">ProcessExitInfo</span>,
                    <span class="r79 r">jobProcess</span>.<span class="i">ExitCode</span>,
                    <span class="r79 r">jobProcess</span>.<span class="i">StandardOutput</span>.<span class="i">ReadToEnd</span>(),
                    <span class="r79 r">jobProcess</span>.<span class="i">StandardError</span>.<span class="i">ReadToEnd</span>());
            }
            <b>catch</b> (<span class="i">Exception</span> <span id="r80 rd" class="r80 r">exception</span>)
            {
                <span class="r78 r">processDiagnosticMessage</span> = <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(
                    <span class="i">RemotingErrorIdStrings</span>.<span class="i">ProcessInfoNotRecoverable</span>,
                    <span class="r80 r">exception</span>.<span class="i">Message</span>);
            }
 
            <b>string</b> <span id="r81 rd" class="r81 r">exitErrorMsg</span> = <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(
                <span class="i">RemotingErrorIdStrings</span>.<span class="i">IPCServerProcessExited</span>,
                <span class="r78 r">processDiagnosticMessage</span>);
            <a href="../common/remotingexceptions.cs.html#0bb8687f97d91059" class="k">var</a> <span id="r82 rd" class="r82 r">psrte</span> = <b>new</b> <a href="../common/remotingexceptions.cs.html#3605c93f7ef1166e" class="t constructor">PSRemotingTransportException</a>(
                <a href="../common/remotingexceptions.cs.html#a969589d7508bf05" class="t t">PSRemotingErrorId</a>.<a href="../common/remotingexceptions.cs.html#5bfadaca405b41c8" class="i field">IPCServerProcessExited</a>,
                <span class="r81 r">exitErrorMsg</span>);
            <a href="BaseTransportManager.cs.html#8e00d8a2f8745652" class="i method">RaiseErrorHandler</a>(<b>new</b> <a href="BaseTransportManager.cs.html#c420864940871a42" class="t constructor">TransportErrorOccuredEventArgs</a>(<span class="r82 r">psrte</span>, <span class="r77 r">transportMethod</span>));
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Sending Data related Methods
 
        <b>protected void</b> <a id="b5ab391e61d975ce" href="../../../R/b5ab391e61d975ce.html" target="n" data-glyph="75,1" class="i method">SendOneItem</a>()
        {
            <a href="PriorityCollection.cs.html#f0975201467fdc06" class="t t">DataPriorityType</a> <span id="r83 rd" class="r83 r">priorityType</span>;
            <span class="c">// This will either return data or register callback but doesn&#39;t do both.</span>
            <b>byte</b>[] <span id="r84 rd" class="r84 r">data</span> = <a href="BaseTransportManager.cs.html#ee4a2ac1afa72dce" class="i field">dataToBeSent</a>.<a href="PriorityCollection.cs.html#56fbcab0ffda9766" class="i method">ReadOrRegisterCallback</a>(<a href="#9e3538c8802824ff" class="i field">_onDataAvailableToSendCallback</a>,
                <b>out</b> <span class="r83 r">priorityType</span>);
            <b>if</b> (<span class="r84 r">data</span> != <b>null</b>)
            {
                <a href="#edc06e9bf1ac9248" class="i method">SendData</a>(<span class="r84 r">data</span>, <span class="r83 r">priorityType</span>);
            }
        }
 
        <b>private void</b> <a id="99bb337337d6c7bb" href="../../../R/99bb337337d6c7bb.html" target="n" data-glyph="76,1" class="i method">OnDataAvailableCallback</a>(<b>byte</b>[] <span id="r85 rd" class="r85 r">data</span>, <a href="PriorityCollection.cs.html#f0975201467fdc06" class="t t">DataPriorityType</a> <span id="r86 rd" class="r86 r">priorityType</span>)
        {
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r85 r">data</span> != <b>null</b>, <span class="s">&quot;data cannot be null in the data available callback&quot;</span>);
 
            <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<a href="../../../utils/StructuredTraceSource.cs.html#96aaf3813a5962a0" class="i method">WriteLine</a>(<span class="s">&quot;Received data to be sent from the callback.&quot;</span>);
            <a href="#edc06e9bf1ac9248" class="i method">SendData</a>(<span class="r85 r">data</span>, <span class="r86 r">priorityType</span>);
        }
 
        <b>private void</b> <a id="edc06e9bf1ac9248" href="../../../R/edc06e9bf1ac9248.html" target="n" data-glyph="76,1" class="i method">SendData</a>(<b>byte</b>[] <span id="r87 rd" class="r87 r">data</span>, <a href="PriorityCollection.cs.html#f0975201467fdc06" class="t t">DataPriorityType</a> <span id="r88 rd" class="r88 r">priorityType</span>)
        {
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(
                       <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#833085c622d127cb" class="i field">WSManSendShellInputEx</a>, <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#10dc07d70da5e17a" class="i field">Send</a>, <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                       <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#c5d4a73b62c859ab" class="i field">Transport</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                       <a href="BaseTransportManager.cs.html#6b69cd5f8cc06fb7" class="i property">RunspacePoolInstanceId</a>.<span class="i">ToString</span>(),
                       <span class="i">Guid</span>.<span class="i">Empty</span>.<span class="i">ToString</span>(),
                       <span class="r87 r">data</span>.<span class="i">Length</span>.<span class="i">ToString</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>));
 
            <b>lock</b> (<a href="BaseTransportManager.cs.html#2b6037d6b3777ca1" class="i field">syncObject</a>)
            {
                <b>if</b> (<a href="BaseTransportManager.cs.html#76271338de46dcf0" class="i field">isClosed</a>)
                {
                    <b>return</b>;
                }
 
                <a href="#908a2aa48b413a01" class="i field">stdInWriter</a>.<a href="#1fb9fbc09f4031a8" class="i method">WriteLine</a>(<a href="#bb038d3403da3163" class="t t">OutOfProcessUtils</a>.<span class="i">CreateDataPacket</span>(<span class="r87 r">data</span>,
                    <span class="r88 r">priorityType</span>,
                    <span class="i">Guid</span>.<span class="i">Empty</span>));
            }
        }
 
        <b>private void</b> <a id="dbc7b9c2cfdaea14" href="../../../R/dbc7b9c2cfdaea14.html" target="n" data-glyph="76,1" class="i method">OnRemoteSessionSendCompleted</a>()
        {
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(<a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#24e0ce157c99ef06" class="i field">WSManSendShellInputExCallbackReceived</a>,
                <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#a0f7cf0d4987790f" class="i field">Connect</a>, <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>, <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#c5d4a73b62c859ab" class="i field">Transport</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                <a href="BaseTransportManager.cs.html#6b69cd5f8cc06fb7" class="i property">RunspacePoolInstanceId</a>.<span class="i">ToString</span>(), <span class="i">Guid</span>.<span class="i">Empty</span>.<span class="i">ToString</span>());
 
            <a href="#b5ab391e61d975ce" class="i method">SendOneItem</a>();
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Data Processing handlers
 
        <b>private void</b> <a id="ad3a5768a216d92c" href="../../../R/ad3a5768a216d92c.html" target="n" data-glyph="76,1" class="i method">OnDataPacketReceived</a>(<b>byte</b>[] <span id="r89 rd" class="r89 r">rawData</span>, <b>string</b> <span id="r90 rd" class="r90 r">stream</span>, <span class="i">Guid</span> <span id="r91 rd" class="r91 r">psGuid</span>)
        {
            <b>string</b> <span id="r92 rd" class="r92 r">streamTemp</span> = <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Remoting</span>.<span class="i n">Client</span>.<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#ab2f3becc1476649" class="i field">WSMAN_STREAM_ID_STDOUT</a>;
            <b>if</b> (<span class="r90 r">stream</span>.<span class="i">Equals</span>(<b>nameof</b>(<a href="PriorityCollection.cs.html#f0975201467fdc06" class="t t">DataPriorityType</a>.<a href="PriorityCollection.cs.html#ef28607d20d8e243" class="i field">PromptResponse</a>), <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
            {
                <span class="r92 r">streamTemp</span> = <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Remoting</span>.<span class="i n">Client</span>.<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#2dd82f73ca1e8381" class="i field">WSMAN_STREAM_ID_PROMPTRESPONSE</a>;
            }
 
            <b>if</b> (<span class="r91 r">psGuid</span> == <span class="i">Guid</span>.<span class="i">Empty</span>)
            {
                <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(
                    <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#1950f93b9ed312a7" class="i field">WSManReceiveShellOutputExCallbackReceived</a>, <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#75e7cd53604b1352" class="i field">Receive</a>, <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                    <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#c5d4a73b62c859ab" class="i field">Transport</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                    <a href="BaseTransportManager.cs.html#6b69cd5f8cc06fb7" class="i property">RunspacePoolInstanceId</a>.<span class="i">ToString</span>(),
                    <span class="i">Guid</span>.<span class="i">Empty</span>.<span class="i">ToString</span>(),
                    <span class="r89 r">rawData</span>.<span class="i">Length</span>.<span class="i">ToString</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>));
 
                <span class="c">// this data is meant for session.</span>
                <a href="BaseTransportManager.cs.html#19883ec4df424177" class="k">base</a>.<a href="BaseTransportManager.cs.html#9b54d0029bdba5c6" class="i method">ProcessRawData</a>(<span class="r89 r">rawData</span>, <span class="r92 r">streamTemp</span>);
            }
            <b>else</b>
            {
                <span class="c">// this is for a command</span>
                <a href="#920a85d8937fe495" class="t t">OutOfProcessClientCommandTransportManager</a> <span id="r93 rd" class="r93 r">cmdTM</span> = <a href="#b161090f7dabb5db" class="i method">GetCommandTransportManager</a>(<span class="r91 r">psGuid</span>);
                <b>if</b> (<span class="r93 r">cmdTM</span> != <b>null</b>)
                {
                    <span class="c">// not throwing the exception in null case as the command might have already</span>
                    <span class="c">// closed. The RS data structure handler does not wait for the close ack before</span>
                    <span class="c">// it clears the command transport manager..so this might happen.</span>
                    <span class="r93 r">cmdTM</span>.<a href="#2219ac63e4854a95" class="i method">OnRemoteCmdDataReceived</a>(<span class="r89 r">rawData</span>, <span class="r92 r">streamTemp</span>);
                }
            }
        }
 
        <b>private void</b> <a id="782e4734887988c1" href="../../../R/782e4734887988c1.html" target="n" data-glyph="76,1" class="i method">OnDataAckPacketReceived</a>(<span class="i">Guid</span> <span id="r94 rd" class="r94 r">psGuid</span>)
        {
            <b>if</b> (<span class="r94 r">psGuid</span> == <span class="i">Guid</span>.<span class="i">Empty</span>)
            {
                <span class="c">// this data is meant for session.</span>
                <a href="#dbc7b9c2cfdaea14" class="i method">OnRemoteSessionSendCompleted</a>();
            }
            <b>else</b>
            {
                <span class="c">// this is for a command</span>
                <a href="#920a85d8937fe495" class="t t">OutOfProcessClientCommandTransportManager</a> <span id="r95 rd" class="r95 r">cmdTM</span> = <a href="#b161090f7dabb5db" class="i method">GetCommandTransportManager</a>(<span class="r94 r">psGuid</span>);
                <b>if</b> (<span class="r95 r">cmdTM</span> != <b>null</b>)
                {
                    <span class="c">// not throwing the exception in null case as the command might have already</span>
                    <span class="c">// closed. The RS data structure handler does not wait for the close ack before</span>
                    <span class="c">// it clears the command transport manager..so this might happen.</span>
                    <span class="r95 r">cmdTM</span>.<a href="#21b8eaf5ca512d24" class="i method">OnRemoteCmdSendCompleted</a>();
                }
            }
        }
 
        <b>private void</b> <a id="5c8a1194b92c6e9e" href="../../../R/5c8a1194b92c6e9e.html" target="n" data-glyph="76,1" class="i method">OnCommandCreationPacketReceived</a>(<span class="i">Guid</span> <span id="r96 rd" class="r96 r">psGuid</span>)
        {
            <b>throw</b> <b>new</b> <span class="t">PSRemotingTransportException</span>(<a href="../common/remotingexceptions.cs.html#a969589d7508bf05" class="t t">PSRemotingErrorId</a>.<a href="../common/remotingexceptions.cs.html#e4dabb20bede1ee9" class="i field">IPCUnknownElementReceived</a>,
                <span class="i">RemotingErrorIdStrings</span>.<span class="i">IPCUnknownElementReceived</span>,
                   <a href="#bb038d3403da3163" class="t t">OutOfProcessUtils</a>.<a href="#2c2544c4eaa270bc" class="i field">PS_OUT_OF_PROC_COMMAND_TAG</a>);
        }
 
        <b>private void</b> <a id="33f14658aa08e140" href="../../../R/33f14658aa08e140.html" target="n" data-glyph="76,1" class="i method">OnCommandCreationAckReceived</a>(<span class="i">Guid</span> <span id="r97 rd" class="r97 r">psGuid</span>)
        {
            <a href="#920a85d8937fe495" class="t t">OutOfProcessClientCommandTransportManager</a> <span id="r98 rd" class="r98 r">cmdTM</span> = <a href="#b161090f7dabb5db" class="i method">GetCommandTransportManager</a>(<span class="r97 r">psGuid</span>);
            <b>if</b> (<span class="r98 r">cmdTM</span> == <b>null</b>)
            {
                <b>throw</b> <b>new</b> <span class="t">PSRemotingTransportException</span>(<a href="../common/remotingexceptions.cs.html#a969589d7508bf05" class="t t">PSRemotingErrorId</a>.<a href="../common/remotingexceptions.cs.html#4491cfa3d15f7e40" class="i field">IPCUnknownCommandGuid</a>,
                    <span class="i">RemotingErrorIdStrings</span>.<span class="i">IPCUnknownCommandGuid</span>,
                    <span class="r97 r">psGuid</span>.<span class="i">ToString</span>(), <a href="#bb038d3403da3163" class="t t">OutOfProcessUtils</a>.<a href="#a8df37661f74435c" class="i field">PS_OUT_OF_PROC_COMMAND_ACK_TAG</a>);
            }
 
            <span class="r98 r">cmdTM</span>.<a href="#d95315cb077ab762" class="i method">OnCreateCmdCompleted</a>();
 
            <a href="#8de2a991a3b17128" class="i field">_tracer</a>.<span class="i">WriteMessage</span>(<span class="s">&quot;OutOfProcessClientSessionTransportManager.OnCommandCreationAckReceived, in progress command count after cmd creation ACK : &quot;</span> + <a href="#ec8dbfe2d3fa342d" class="i field">_cmdTransportManagers</a>.<span class="i">Count</span> + <span class="s">&quot;, psGuid : &quot;</span> + <span class="r97 r">psGuid</span>.<span class="i">ToString</span>());
        }
 
        <b>private void</b> <a id="85acaa64c34ebb05" href="../../../R/85acaa64c34ebb05.html" target="n" data-glyph="76,1" class="i method">OnSignalPacketReceived</a>(<span class="i">Guid</span> <span id="r99 rd" class="r99 r">psGuid</span>)
        {
            <b>throw</b> <b>new</b> <span class="t">PSRemotingTransportException</span>(<a href="../common/remotingexceptions.cs.html#a969589d7508bf05" class="t t">PSRemotingErrorId</a>.<a href="../common/remotingexceptions.cs.html#e4dabb20bede1ee9" class="i field">IPCUnknownElementReceived</a>,
                <span class="i">RemotingErrorIdStrings</span>.<span class="i">IPCUnknownElementReceived</span>,
                   <a href="#bb038d3403da3163" class="t t">OutOfProcessUtils</a>.<a href="#ce99cfb65df7f3fd" class="i field">PS_OUT_OF_PROC_SIGNAL_TAG</a>);
        }
 
        <b>private void</b> <a id="cbb6feb5e5a8a563" href="../../../R/cbb6feb5e5a8a563.html" target="n" data-glyph="76,1" class="i method">OnSignalAckPacketReceived</a>(<span class="i">Guid</span> <span id="r100 rd" class="r100 r">psGuid</span>)
        {
            <b>if</b> (<span class="r100 r">psGuid</span> == <span class="i">Guid</span>.<span class="i">Empty</span>)
            {
                <b>throw</b> <b>new</b> <span class="t">PSRemotingTransportException</span>(<a href="../common/remotingexceptions.cs.html#a969589d7508bf05" class="t t">PSRemotingErrorId</a>.<a href="../common/remotingexceptions.cs.html#1f3d42cd5c6ce75a" class="i field">IPCNoSignalForSession</a>,
                    <span class="i">RemotingErrorIdStrings</span>.<span class="i">IPCNoSignalForSession</span>,
                    <a href="#bb038d3403da3163" class="t t">OutOfProcessUtils</a>.<a href="#62d0487a88a3e0f0" class="i field">PS_OUT_OF_PROC_SIGNAL_ACK_TAG</a>);
            }
            <b>else</b>
            {
                <a href="#920a85d8937fe495" class="t t">OutOfProcessClientCommandTransportManager</a> <span id="r101 rd" class="r101 r">cmdTM</span> = <a href="#b161090f7dabb5db" class="i method">GetCommandTransportManager</a>(<span class="r100 r">psGuid</span>);
                <b>if</b> (<span class="r101 r">cmdTM</span> != <b>null</b>)
                {
                    <span class="r101 r">cmdTM</span>.<a href="#f7947cf1b390b840" class="i method">OnRemoteCmdSignalCompleted</a>();
                }
            }
        }
 
        <b>private void</b> <a id="17e1f4bec3847a12" href="../../../R/17e1f4bec3847a12.html" target="n" data-glyph="76,1" class="i method">OnClosePacketReceived</a>(<span class="i">Guid</span> <span id="r102 rd" class="r102 r">psGuid</span>)
        {
            <b>throw</b> <b>new</b> <span class="t">PSRemotingTransportException</span>(<a href="../common/remotingexceptions.cs.html#a969589d7508bf05" class="t t">PSRemotingErrorId</a>.<a href="../common/remotingexceptions.cs.html#e4dabb20bede1ee9" class="i field">IPCUnknownElementReceived</a>,
                <span class="i">RemotingErrorIdStrings</span>.<span class="i">IPCUnknownElementReceived</span>,
                   <a href="#bb038d3403da3163" class="t t">OutOfProcessUtils</a>.<a href="#f7cc1cc6451b9b2f" class="i field">PS_OUT_OF_PROC_CLOSE_TAG</a>);
        }
 
        <b>private void</b> <a id="31e3c988a47aa163" href="../../../R/31e3c988a47aa163.html" target="n" data-glyph="76,1" class="i method">OnCloseAckReceived</a>(<span class="i">Guid</span> <span id="r103 rd" class="r103 r">psGuid</span>)
        {
            <b>int</b> <span id="r104 rd" class="r104 r">commandCount</span>;
            <b>lock</b> (<a href="BaseTransportManager.cs.html#2b6037d6b3777ca1" class="i field">syncObject</a>)
            {
                <span class="r104 r">commandCount</span> = <a href="#ec8dbfe2d3fa342d" class="i field">_cmdTransportManagers</a>.<span class="i">Count</span>;
            }
 
            <b>if</b> (<span class="r103 r">psGuid</span> == <span class="i">Guid</span>.<span class="i">Empty</span>)
            {
                <a href="#8de2a991a3b17128" class="i field">_tracer</a>.<span class="i">WriteMessage</span>(<span class="s">&quot;OutOfProcessClientSessionTransportManager.OnCloseAckReceived, progress command count after CLOSE ACK should be zero = &quot;</span> + <span class="r104 r">commandCount</span> + <span class="s">&quot; psGuid : &quot;</span> + <span class="r103 r">psGuid</span>.<span class="i">ToString</span>());
 
                <a href="#d45b9c7a452bcb48" class="k">this</a>.<a href="#70aa7fa0df2f5e32" class="i method">OnCloseSessionCompleted</a>();
            }
            <b>else</b>
            {
                <a href="#8de2a991a3b17128" class="i field">_tracer</a>.<span class="i">WriteMessage</span>(<span class="s">&quot;OutOfProcessClientSessionTransportManager.OnCloseAckReceived, in progress command count should be greater than zero: &quot;</span> + <span class="r104 r">commandCount</span> + <span class="s">&quot;, RunSpacePool Id : &quot;</span> + <a href="#d45b9c7a452bcb48" class="k">this</a>.<a href="BaseTransportManager.cs.html#6b69cd5f8cc06fb7" class="i property">RunspacePoolInstanceId</a> + <span class="s">&quot;, psGuid : &quot;</span> + <span class="r103 r">psGuid</span>.<span class="i">ToString</span>());
 
                <a href="#920a85d8937fe495" class="t t">OutOfProcessClientCommandTransportManager</a> <span id="r105 rd" class="r105 r">cmdTM</span> = <a href="#b161090f7dabb5db" class="i method">GetCommandTransportManager</a>(<span class="r103 r">psGuid</span>);
                <b>if</b> (<span class="r105 r">cmdTM</span> != <b>null</b>)
                {
                    <span class="c">// this might legitimately happen if cmd is already closed before we get an</span>
                    <span class="c">// ACK back from server.</span>
                    <span class="r105 r">cmdTM</span>.<a href="#3178e2491588430a" class="i method">OnCloseCmdCompleted</a>();
                }
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Private Timeout handlers
 
        <b>internal void</b> <a id="819c9a4bf63215e5" href="../../../R/../../0000000000.html" target="n" data-glyph="74,1" class="i method">OnCloseTimeOutTimerElapsed</a>(<b>object</b> <span id="r106 rd" class="r106 r">source</span>)
        {
            <a href="../common/remotingexceptions.cs.html#0bb8687f97d91059" class="t t">PSRemotingTransportException</a> <span id="r107 rd" class="r107 r">psrte</span> = <b>new</b> <span class="t">PSRemotingTransportException</span>(<a href="../common/remotingexceptions.cs.html#a969589d7508bf05" class="t t">PSRemotingErrorId</a>.<a href="../common/remotingexceptions.cs.html#43b4fa5401dcd096" class="i field">IPCCloseTimedOut</a>, <span class="i">RemotingErrorIdStrings</span>.<span class="i">IPCCloseTimedOut</span>);
            <a href="BaseTransportManager.cs.html#8e00d8a2f8745652" class="i method">RaiseErrorHandler</a>(<b>new</b> <a href="BaseTransportManager.cs.html#c420864940871a42" class="t constructor">TransportErrorOccuredEventArgs</a>(<span class="r107 r">psrte</span>, <a href="BaseTransportManager.cs.html#33678df914ca9daf" class="t t">TransportMethodEnum</a>.<a href="BaseTransportManager.cs.html#2cc9ee1cdce7fca6" class="i field">CloseShellOperationEx</a>));
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
    
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Protected Methods
 
        <b>protected void</b> <a id="5a8ad2d42b546b1d" href="../../../R/5a8ad2d42b546b1d.html" target="n" data-glyph="75,1" class="i method">DisposeMessageQueue</a>()
        {
            <span class="c">// Stop session processing thread.</span>
            <b>try</b>
            {
                <a href="#d67a9791e55dd9f1" class="i field">_sessionMessageQueue</a>.<span class="i">CompleteAdding</span>();
            }
            <b>catch</b> (<span class="i">ObjectDisposedException</span>)
            {
                <span class="c">// Object already disposed.</span>
            }
 
            <a href="#d67a9791e55dd9f1" class="i field">_sessionMessageQueue</a>.<span class="i">Dispose</span>();
 
            <span class="c">// Stop command processing thread.</span>
            <b>try</b>
            {
                <a href="#e7318c06f72ebfe8" class="i field">_commandMessageQueue</a>.<span class="i">CompleteAdding</span>();
            }
            <b>catch</b> (<span class="i">ObjectDisposedException</span>)
            {
                <span class="c">// Object already disposed.</span>
            }
 
            <a href="#e7318c06f72ebfe8" class="i field">_commandMessageQueue</a>.<span class="i">Dispose</span>();
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
    }
 
    <b>internal class</b> <a id="a6514f81b5714786" href="../../../R/a6514f81b5714786.html" target="n" data-glyph="2,0" class="t t">OutOfProcessClientSessionTransportManager</a> : <a href="#d45b9c7a452bcb48" class="t t">OutOfProcessClientSessionTransportManagerBase</a>
    {
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Private Data
 
        <b>private</b> <span class="i">Process</span> <a id="c9d76c1ebab10159" href="../../../R/c9d76c1ebab10159.html" target="n" data-glyph="46,1" class="i field">_serverProcess</a>;
        <b>private readonly</b> <a href="../common/RunspaceConnectionInfo.cs.html#93baa7a23006c771" class="t t">NewProcessConnectionInfo</a> <a id="81e9d7adf87abf0f" href="../../../R/81e9d7adf87abf0f.html" target="n" data-glyph="46,1" class="i field">_connectionInfo</a>;
        <b>private bool</b> <a id="59eecd96e49e41a1" href="../../../R/59eecd96e49e41a1.html" target="n" data-glyph="46,1" class="i field">_processCreated</a> = <b>true</b>;
        <b>private</b> <a href="../../hostifaces/PowerShellProcessInstance.cs.html#85e1d8f342ae7442" class="t t">PowerShellProcessInstance</a> <a id="650f67fb8c04ff1c" href="../../../R/650f67fb8c04ff1c.html" target="n" data-glyph="46,1" class="i field">_processInstance</a>;
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Constructor
 
        <b>internal</b> <a id="f233cd258df13531" href="../../../R/f233cd258df13531.html" target="n" data-glyph="74,1" class="t constructor">OutOfProcessClientSessionTransportManager</a>(<span class="i">Guid</span> <span id="r108 rd" class="r108 r">runspaceId</span>,
            <a href="../common/RunspaceConnectionInfo.cs.html#93baa7a23006c771" class="t t">NewProcessConnectionInfo</a> <span id="r109 rd" class="r109 r">connectionInfo</span>,
            <a href="../../../utils/CryptoUtils.cs.html#1999dfb2439af5a0" class="t t">PSRemotingCryptoHelper</a> <span id="r110 rd" class="r110 r">cryptoHelper</span>)
            : <a href="#9c94004483e5b344" class="k">base</a>(<span class="r108 r">runspaceId</span>, <span class="r110 r">cryptoHelper</span>)
        {
            <a href="#81e9d7adf87abf0f" class="i field">_connectionInfo</a> = <span class="r109 r">connectionInfo</span>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Overrides
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Launch a new Process (pwsh -s) to perform remoting. This is used by *-Job cmdlets</span>
        <span class="c">///</span><span class="c"> to support background jobs without depending on WinRM (WinRM has complex requirements like</span>
        <span class="c">///</span><span class="c"> elevation to support local machine remoting)</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">System</span>.<span class="i">InvalidOperationException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i n">System</span>.<span class="i">ComponentModel</span>.<span class="i">Win32Exception</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> 1. There was an error in opening the associated file.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>internal override void</b> <a id="cda1a12f42bc0a7a" href="../../../R/cda1a12f42bc0a7a.html" target="n" data-glyph="74,1" class="i method">CreateAsync</a>()
        {
            <b>if</b> (<a href="#81e9d7adf87abf0f" class="i field">_connectionInfo</a> != <b>null</b>)
            {
                <a href="#650f67fb8c04ff1c" class="i field">_processInstance</a> = <a href="#81e9d7adf87abf0f" class="i field">_connectionInfo</a>.<a href="../common/RunspaceConnectionInfo.cs.html#3700438a1679dca4" class="i property">Process</a> ?? <b>new</b> <a href="../../hostifaces/PowerShellProcessInstance.cs.html#0e2ed024900c3c49" class="t constructor">PowerShellProcessInstance</a>(<a href="#81e9d7adf87abf0f" class="i field">_connectionInfo</a>.<a href="../common/RunspaceConnectionInfo.cs.html#80441a03729049e6" class="i property">PSVersion</a>,
                                                                                           <a href="#81e9d7adf87abf0f" class="i field">_connectionInfo</a>.<a href="../common/RunspaceConnectionInfo.cs.html#10a16b560836ad1b" class="i property">Credential</a>,
                                                                                           <a href="#81e9d7adf87abf0f" class="i field">_connectionInfo</a>.<a href="../common/RunspaceConnectionInfo.cs.html#5b610004bf5ded30" class="i property">InitializationScript</a>,
                                                                                           <a href="#81e9d7adf87abf0f" class="i field">_connectionInfo</a>.<a href="../common/RunspaceConnectionInfo.cs.html#68cce0ea2c8c3180" class="i property">RunAs32</a>,
                                                                                           <a href="#81e9d7adf87abf0f" class="i field">_connectionInfo</a>.<a href="../common/RunspaceConnectionInfo.cs.html#4e1f955258f4d4c1" class="i property">WorkingDirectory</a>);
                <b>if</b> (<a href="#81e9d7adf87abf0f" class="i field">_connectionInfo</a>.<a href="../common/RunspaceConnectionInfo.cs.html#3700438a1679dca4" class="i property">Process</a> != <b>null</b>)
                {
                    <a href="#59eecd96e49e41a1" class="i field">_processCreated</a> = <b>false</b>;
                }
            }
 
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(<a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#959d48274f222fdc" class="i field">WSManCreateShell</a>, <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#a0f7cf0d4987790f" class="i field">Connect</a>,
                            <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#752e56066810e4f0" class="i field">CreateRunspace</a>, <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#c5d4a73b62c859ab" class="i field">Transport</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                            <a href="BaseTransportManager.cs.html#6b69cd5f8cc06fb7" class="i property">RunspacePoolInstanceId</a>.<span class="i">ToString</span>());
 
            <b>try</b>
            {
                <b>lock</b> (<a href="BaseTransportManager.cs.html#2b6037d6b3777ca1" class="i field">syncObject</a>)
                {
                    <b>if</b> (<a href="BaseTransportManager.cs.html#76271338de46dcf0" class="i field">isClosed</a>)
                    {
                        <b>return</b>;
                    }
 
                    <span class="c">// Attach handlers and start the process</span>
                    <a href="#c9d76c1ebab10159" class="i field">_serverProcess</a> = <a href="#650f67fb8c04ff1c" class="i field">_processInstance</a>.<a href="../../hostifaces/PowerShellProcessInstance.cs.html#2592a0e5d216c647" class="i property">Process</a>;
 
                    <b>if</b> (<a href="#650f67fb8c04ff1c" class="i field">_processInstance</a>.<a href="../../hostifaces/PowerShellProcessInstance.cs.html#c06727afec38040f" class="i property">RunspacePool</a> != <b>null</b>)
                    {
                        <a href="#650f67fb8c04ff1c" class="i field">_processInstance</a>.<a href="../../hostifaces/PowerShellProcessInstance.cs.html#c06727afec38040f" class="i property">RunspacePool</a>.<a href="../../hostifaces/RunspacePool.cs.html#1689eedd988353b0" class="i method">Close</a>();
                        <a href="#650f67fb8c04ff1c" class="i field">_processInstance</a>.<a href="../../hostifaces/PowerShellProcessInstance.cs.html#c06727afec38040f" class="i property">RunspacePool</a>.<a href="../../hostifaces/RunspacePool.cs.html#3db8df3e6fc80b2b" class="i method">Dispose</a>();
                    }
 
                    <a href="#c9d76c1ebab10159" class="i field">_serverProcess</a>.<span class="i">Exited</span> += <span class="i">OnExited</span>;
                    <a href="#650f67fb8c04ff1c" class="i field">_processInstance</a>.<a href="../../hostifaces/PowerShellProcessInstance.cs.html#32d605a6333681bf" class="i method">Start</a>();
 
                    <a href="#e33a387f4cb668e7" class="i method">StartRedirectionReaderThreads</a>(<a href="#c9d76c1ebab10159" class="i field">_serverProcess</a>);
                    <a href="#908a2aa48b413a01" class="i field">stdInWriter</a> = <b>new</b> <span class="t">OutOfProcessTextWriter</span>(<a href="#c9d76c1ebab10159" class="i field">_serverProcess</a>.<span class="i">StandardInput</span>);
                    <a href="#650f67fb8c04ff1c" class="i field">_processInstance</a>.<a href="../../hostifaces/PowerShellProcessInstance.cs.html#3b0244a6516ebadd" class="i property">StdInWriter</a> = <a href="#908a2aa48b413a01" class="i field">stdInWriter</a>;
                }
            }
            <b>catch</b> (<span class="i n">System</span>.<span class="i">ComponentModel</span>.<span class="i">Win32Exception</span> <span id="r111 rd" class="r111 r">w32e</span>)
            {
                <a href="../common/remotingexceptions.cs.html#0bb8687f97d91059" class="t t">PSRemotingTransportException</a> <span id="r112 rd" class="r112 r">psrte</span> = <b>new</b> <span class="t">PSRemotingTransportException</span>(<span class="r111 r">w32e</span>, <span class="i">RemotingErrorIdStrings</span>.<span class="i">IPCExceptionLaunchingProcess</span>,
                    <span class="r111 r">w32e</span>.<span class="i">Message</span>);
                <span class="r112 r">psrte</span>.<a href="../common/remotingexceptions.cs.html#f96218464c4b7244" class="i property">ErrorCode</a> = <span class="r111 r">w32e</span>.<span class="i">HResult</span>;
                <a href="BaseTransportManager.cs.html#7e70b34f9332dfcd" class="t t">TransportErrorOccuredEventArgs</a> <span id="r113 rd" class="r113 r">eventargs</span> = <b>new</b> <a href="BaseTransportManager.cs.html#c420864940871a42" class="t constructor">TransportErrorOccuredEventArgs</a>(<span class="r112 r">psrte</span>, <a href="BaseTransportManager.cs.html#33678df914ca9daf" class="t t">TransportMethodEnum</a>.<a href="BaseTransportManager.cs.html#a8019a6497e609cf" class="i field">CreateShellEx</a>);
                <a href="BaseTransportManager.cs.html#8e00d8a2f8745652" class="i method">RaiseErrorHandler</a>(<span class="r113 r">eventargs</span>);
                <b>return</b>;
            }
            <b>catch</b> (<span class="i">Exception</span> <span id="r114 rd" class="r114 r">e</span>)
            {
                <a href="../common/remotingexceptions.cs.html#0bb8687f97d91059" class="t t">PSRemotingTransportException</a> <span id="r115 rd" class="r115 r">psrte</span> = <b>new</b> <span class="t">PSRemotingTransportException</span>(<a href="../common/remotingexceptions.cs.html#a969589d7508bf05" class="t t">PSRemotingErrorId</a>.<a href="../common/remotingexceptions.cs.html#b7997107071a655f" class="i field">IPCExceptionLaunchingProcess</a>,
                <span class="i">RemotingErrorIdStrings</span>.<span class="i">IPCExceptionLaunchingProcess</span>,
                    <span class="r114 r">e</span>.<span class="i">Message</span>);
                <a href="BaseTransportManager.cs.html#7e70b34f9332dfcd" class="t t">TransportErrorOccuredEventArgs</a> <span id="r116 rd" class="r116 r">eventargs</span> = <b>new</b> <a href="BaseTransportManager.cs.html#c420864940871a42" class="t constructor">TransportErrorOccuredEventArgs</a>(<span class="r115 r">psrte</span>, <a href="BaseTransportManager.cs.html#33678df914ca9daf" class="t t">TransportMethodEnum</a>.<a href="BaseTransportManager.cs.html#a8019a6497e609cf" class="i field">CreateShellEx</a>);
                <a href="BaseTransportManager.cs.html#8e00d8a2f8745652" class="i method">RaiseErrorHandler</a>(<span class="r116 r">eventargs</span>);
                <b>return</b>;
            }
 
            <span class="c">// Send one fragment</span>
            <a href="#b5ab391e61d975ce" class="i method">SendOneItem</a>();
        }
 
        <b>private void</b> <a id="e33a387f4cb668e7" href="../../../R/e33a387f4cb668e7.html" target="n" data-glyph="76,1" class="i method">StartRedirectionReaderThreads</a>(<span class="i">Process</span> <span id="r117 rd" class="r117 r">serverProcess</span>)
        {
            <span class="i">Thread</span> <span id="r118 rd" class="r118 r">outputThread</span> = <b>new</b> <span class="i">Thread</span>(<span class="i">ProcessOutputData</span>);
            <span class="r118 r">outputThread</span>.<span class="i">IsBackground</span> = <b>true</b>;
            <span class="r118 r">outputThread</span>.<span class="i">Name</span> = <span class="s">&quot;Out-of-Proc Job Output Thread&quot;</span>;
 
            <span class="i">Thread</span> <span id="r119 rd" class="r119 r">errorThread</span> = <b>new</b> <span class="i">Thread</span>(<span class="i">ProcessErrorData</span>);
            <span class="r119 r">errorThread</span>.<span class="i">IsBackground</span> = <b>true</b>;
            <span class="r119 r">errorThread</span>.<span class="i">Name</span> = <span class="s">&quot;Out-of-Proc Job Error Thread&quot;</span>;
 
            <span class="r118 r">outputThread</span>.<span class="i">Start</span>(<span class="r117 r">serverProcess</span>.<span class="i">StandardOutput</span>);
            <span class="r119 r">errorThread</span>.<span class="i">Start</span>(<span class="r117 r">serverProcess</span>.<span class="i">StandardError</span>);
        }
 
        <b>private void</b> <a id="3a64ae5ac9e63608" href="../../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">ProcessOutputData</a>(<b>object</b> <span id="r120 rd" class="r120 r">arg</span>)
        {
            <b>if</b> (<span class="r120 r">arg</span> <b>is</b> <span class="i">StreamReader</span> <span id="r121 rd" class="r121 r">reader</span>)
            {
                <b>try</b>
                {
                    <b>string</b> <span id="r122 rd" class="r122 r">data</span> = <span class="r121 r">reader</span>.<span class="i">ReadLine</span>();
                    <b>while</b> (<span class="r122 r">data</span> != <b>null</b>)
                    {
                        <a href="#01b8d088286a3591" class="i method">HandleOutputDataReceived</a>(<span class="r122 r">data</span>);
                        <span class="r122 r">data</span> = <span class="r121 r">reader</span>.<span class="i">ReadLine</span>();
                    }
                }
                <b>catch</b> (<span class="i">IOException</span>)
                {
                    <span class="c">// Treat this as EOF, the same as what &#39;Process.BeginOutputReadLine()&#39; does.</span>
                }
                <b>catch</b> (<span class="i">Exception</span> <span id="r123 rd" class="r123 r">e</span>)
                {
                    <a href="#8de2a991a3b17128" class="i field">_tracer</a>.<span class="i">WriteMessage</span>(
                        <span class="s">&quot;OutOfProcessClientSessionTransportManager&quot;</span>,
                        <span class="s">&quot;ProcessOutputThread&quot;</span>,
                        <span class="i">Guid</span>.<span class="i">Empty</span>,
                        <span class="s">&quot;Transport manager output reader thread ended with error: {0}&quot;</span>,
                        <span class="r123 r">e</span>.<span class="i">Message</span> ?? <b>string</b>.<span class="i">Empty</span>);
                }
            }
            <b>else</b>
            {
                <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<b>false</b>, <span class="s">&quot;Invalid argument. Expecting a StreamReader object.&quot;</span>);
            }
        }
 
        <b>private void</b> <a id="20215ee2840278c2" href="../../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">ProcessErrorData</a>(<b>object</b> <span id="r124 rd" class="r124 r">arg</span>)
        {
            <b>if</b> (<span class="r124 r">arg</span> <b>is</b> <span class="i">StreamReader</span> <span id="r125 rd" class="r125 r">reader</span>)
            {
                <b>try</b>
                {
                    <b>string</b> <span id="r126 rd" class="r126 r">data</span> = <span class="r125 r">reader</span>.<span class="i">ReadLine</span>();
                    <b>while</b> (<span class="r126 r">data</span> != <b>null</b>)
                    {
                        <a href="#da60ecb1a90ace20" class="i method">HandleErrorDataReceived</a>(<span class="r126 r">data</span>);
                        <span class="r126 r">data</span> = <span class="r125 r">reader</span>.<span class="i">ReadLine</span>();
                    }
                }
                <b>catch</b> (<span class="i">IOException</span>)
                {
                    <span class="c">// Treat this as EOF, the same as what &#39;Process.BeginErrorReadLine()&#39; does.</span>
                }
                <b>catch</b> (<span class="i">Exception</span> <span id="r127 rd" class="r127 r">e</span>)
                {
                    <a href="#8de2a991a3b17128" class="i field">_tracer</a>.<span class="i">WriteMessage</span>(
                        <span class="s">&quot;OutOfProcessClientSessionTransportManager&quot;</span>,
                        <span class="s">&quot;ProcessErrorThread&quot;</span>,
                        <span class="i">Guid</span>.<span class="i">Empty</span>,
                        <span class="s">&quot;Transport manager error reader thread ended with error: {0}&quot;</span>,
                        <span class="r127 r">e</span>.<span class="i">Message</span> ?? <b>string</b>.<span class="i">Empty</span>);
                }
            }
            <b>else</b>
            {
                <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<b>false</b>, <span class="s">&quot;Invalid argument. Expecting a StreamReader object.&quot;</span>);
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Kills the server process and disposes other resources.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r128 r">isDisposing</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal override void</b> <a id="5e2a0e3b9cb3b748" href="../../../R/5e2a0e3b9cb3b748.html" target="n" data-glyph="74,1" class="i method">Dispose</a>(<b>bool</b> <span id="r128 rd" class="r128 r">isDisposing</span>)
        {
            <a href="#d45b9c7a452bcb48" class="k">base</a>.<a href="#78bbdada56985127" class="i method">Dispose</a>(<span class="r128 r">isDisposing</span>);
            <b>if</b> (<span class="r128 r">isDisposing</span>)
            {
                <a href="#46b08fa47b3a2fbc" class="i method">KillServerProcess</a>();
                <b>if</b> (<a href="#c9d76c1ebab10159" class="i field">_serverProcess</a> != <b>null</b> &amp;&amp; <a href="#59eecd96e49e41a1" class="i field">_processCreated</a>)
                {
                    <span class="c">// null can happen if Dispose is called before ConnectAsync()</span>
                    <a href="#c9d76c1ebab10159" class="i field">_serverProcess</a>.<span class="i">Dispose</span>();
                }
            }
        }
 
        <b>protected override void</b> <a id="16b5e0fe70cd4811" href="../../../R/16b5e0fe70cd4811.html" target="n" data-glyph="75,1" class="i method">CleanupConnection</a>()
        {
            <span class="c">// Clean up the child process</span>
            <a href="#46b08fa47b3a2fbc" class="i method">KillServerProcess</a>();
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Helper Methods
 
        <b>private void</b> <a id="46b08fa47b3a2fbc" href="../../../R/46b08fa47b3a2fbc.html" target="n" data-glyph="76,1" class="i method">KillServerProcess</a>()
        {
            <b>if</b> (<a href="#c9d76c1ebab10159" class="i field">_serverProcess</a> == <b>null</b>)
            {
                <span class="c">// this can happen if Dispose is called before ConnectAsync()</span>
                <b>return</b>;
            }
 
            <b>try</b>
            {
                <b>if</b> (!<a href="#c9d76c1ebab10159" class="i field">_serverProcess</a>.<span class="i">HasExited</span>)
                {
                    <a href="#c9d76c1ebab10159" class="i field">_serverProcess</a>.<span class="i">Exited</span> -= <span class="i">OnExited</span>;
 
                    <b>if</b> (<a href="#59eecd96e49e41a1" class="i field">_processCreated</a>)
                    {
                        <a href="#c9d76c1ebab10159" class="i field">_serverProcess</a>.<span class="i">Kill</span>();
                    }
                }
            }
            <b>catch</b> (<span class="i n">System</span>.<span class="i">ComponentModel</span>.<span class="i">Win32Exception</span>)
            {
                <b>try</b>
                {
                    <span class="c">// For processes running in an NTVDM, trying to kill with</span>
                    <span class="c">// the original handle fails with a Win32 error, so we&#39;ll</span>
                    <span class="c">// use the ID and try to get a new handle...</span>
                    <span class="i">Process</span> <span id="r129 rd" class="r129 r">newHandle</span> = <span class="i">Process</span>.<span class="i">GetProcessById</span>(<a href="#c9d76c1ebab10159" class="i field">_serverProcess</a>.<span class="i">Id</span>);
                    <span class="c">// If the process was not found, we won&#39;t get here...</span>
                    <b>if</b> (<a href="#59eecd96e49e41a1" class="i field">_processCreated</a>) <span class="r129 r">newHandle</span>.<span class="i">Kill</span>();
                }
                <b>catch</b> (<span class="i">Exception</span>)
                {
                }
            }
            <b>catch</b> (<span class="i">Exception</span>)
            {
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
    }
 
    <b>internal abstract class</b> <a id="e9dd0d27d8d6b798" href="../../../R/e9dd0d27d8d6b798.html" target="n" data-glyph="2,0" class="t t">HyperVSocketClientSessionTransportManagerBase</a> : <a href="#d45b9c7a452bcb48" class="t t">OutOfProcessClientSessionTransportManagerBase</a>
    {
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Data
 
        <b>protected</b> <a href="../common/RemoteSessionHyperVSocket.cs.html#c53df8761108165a" class="t t">RemoteSessionHyperVSocketClient</a> <a id="9e98403004225646" href="../../../R/9e98403004225646.html" target="n" data-glyph="45,1" class="i field">_client</a>;
 
        <b>private const string</b> <a id="2f131661bdfab8cd" href="../../../R/2f131661bdfab8cd.html" target="n" data-glyph="10,1" class="i field">_threadName</a> = <span class="s">&quot;HyperVSocketTransport Reader Thread&quot;</span>;
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Constructors
 
        <b>internal</b> <a id="1f840a8cfa1d4f72" href="../../../R/1f840a8cfa1d4f72.html" target="n" data-glyph="74,1" class="t constructor">HyperVSocketClientSessionTransportManagerBase</a>(
            <span class="i">Guid</span> <span id="r130 rd" class="r130 r">runspaceId</span>,
            <a href="../../../utils/CryptoUtils.cs.html#1999dfb2439af5a0" class="t t">PSRemotingCryptoHelper</a> <span id="r131 rd" class="r131 r">cryptoHelper</span>)
            : <a href="#9c94004483e5b344" class="k">base</a>(<span class="r130 r">runspaceId</span>, <span class="r131 r">cryptoHelper</span>)
        { }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Overrides
 
        <b>internal override void</b> <a id="429a19e1f7a42e47" href="../../../R/429a19e1f7a42e47.html" target="n" data-glyph="74,1" class="i method">Dispose</a>(<b>bool</b> <span id="r132 rd" class="r132 r">isDisposing</span>)
        {
            <a href="#d45b9c7a452bcb48" class="k">base</a>.<a href="#78bbdada56985127" class="i method">Dispose</a>(<span class="r132 r">isDisposing</span>);
 
            <b>if</b> (<span class="r132 r">isDisposing</span>)
            {
                <b>if</b> (<a href="#9e98403004225646" class="i field">_client</a> != <b>null</b>)
                {
                    <a href="#9e98403004225646" class="i field">_client</a>.<a href="../common/RemoteSessionHyperVSocket.cs.html#a0db02894bc69b66" class="i method">Dispose</a>();
                }
            }
        }
 
        <b>protected override void</b> <a id="9d35e7c64584c11c" href="../../../R/9d35e7c64584c11c.html" target="n" data-glyph="75,1" class="i method">CleanupConnection</a>()
        {
            <a href="#9e98403004225646" class="i field">_client</a>.<a href="../common/RemoteSessionHyperVSocket.cs.html#d87c64f33353bdc9" class="i method">Close</a>();
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Protected Methods
 
        <b>protected void</b> <a id="ffd999b86c11050f" href="../../../R/ffd999b86c11050f.html" target="n" data-glyph="75,1" class="i method">StartReaderThread</a>(
            <span class="i">StreamReader</span> <span id="r133 rd" class="r133 r">reader</span>)
        {
            <span class="i">Thread</span> <span id="r134 rd" class="r134 r">readerThread</span> = <b>new</b> <span class="i">Thread</span>(<span class="i">ProcessReaderThread</span>);
            <span class="r134 r">readerThread</span>.<span class="i">Name</span> = <a href="#2f131661bdfab8cd" class="i field">_threadName</a>;
            <span class="r134 r">readerThread</span>.<span class="i">IsBackground</span> = <b>true</b>;
            <span class="r134 r">readerThread</span>.<span class="i">Start</span>(<span class="r133 r">reader</span>);
        }
 
        <b>protected void</b> <a id="30c0e8b8482f3326" href="../../../R/../../0000000000.html" target="n" data-glyph="75,1" class="i method">ProcessReaderThread</a>(<b>object</b> <span id="r135 rd" class="r135 r">state</span>)
        {
            <b>try</b>
            {
                <span class="i">StreamReader</span> <span id="r136 rd" class="r136 r">reader</span> = <span class="r135 r">state</span> <b>as</b> <span class="i">StreamReader</span>;
                <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r136 r">reader</span> != <b>null</b>, <span class="s">&quot;Reader cannot be null.&quot;</span>);
 
                <span class="c">// Send one fragment.</span>
                <a href="#b5ab391e61d975ce" class="i method">SendOneItem</a>();
 
                <span class="c">// Start reader loop.</span>
                <b>while</b> (<b>true</b>)
                {
                    <b>string</b> <span id="r137 rd" class="r137 r">data</span> = <span class="r136 r">reader</span>.<span class="i">ReadLine</span>();
                    <b>if</b> (<span class="r137 r">data</span> == <b>null</b>)
                    {
                        <span class="c">// End of stream indicates the target process was lost.</span>
                        <span class="c">// Raise transport exception to invalidate the client remote runspace.</span>
                        <a href="../common/remotingexceptions.cs.html#0bb8687f97d91059" class="t t">PSRemotingTransportException</a> <span id="r138 rd" class="r138 r">psrte</span> = <b>new</b> <span class="t">PSRemotingTransportException</span>(
                            <a href="../common/remotingexceptions.cs.html#a969589d7508bf05" class="t t">PSRemotingErrorId</a>.<a href="../common/remotingexceptions.cs.html#c5268fb78fd26d44" class="i field">IPCServerProcessReportedError</a>,
                            <span class="i">RemotingErrorIdStrings</span>.<span class="i">IPCServerProcessReportedError</span>,
                            <span class="i">RemotingErrorIdStrings</span>.<span class="i">HyperVSocketTransportProcessEnded</span>);
                        <a href="BaseTransportManager.cs.html#8e00d8a2f8745652" class="i method">RaiseErrorHandler</a>(<b>new</b> <a href="BaseTransportManager.cs.html#c420864940871a42" class="t constructor">TransportErrorOccuredEventArgs</a>(<span class="r138 r">psrte</span>, <a href="BaseTransportManager.cs.html#33678df914ca9daf" class="t t">TransportMethodEnum</a>.<a href="BaseTransportManager.cs.html#c91edb639e1ae62a" class="i field">ReceiveShellOutputEx</a>));
                        <b>break</b>;
                    }
 
                    <b>if</b> (<span class="r137 r">data</span>.<span class="i">StartsWith</span>(<span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Remoting</span>.<span class="i n">Server</span>.<a href="../server/OutOfProcServerMediator.cs.html#4bbc940ab571872d" class="t t">HyperVSocketErrorTextWriter</a>.<a href="../server/OutOfProcServerMediator.cs.html#c128900a8072a3f4" class="i property">ErrorPrepend</a>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
                    {
                        <span class="c">// Error message from the server.</span>
                        <b>string</b> <span id="r139 rd" class="r139 r">errorData</span> = <span class="r137 r">data</span>.<span class="i">Substring</span>(<span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Remoting</span>.<span class="i n">Server</span>.<a href="../server/OutOfProcServerMediator.cs.html#4bbc940ab571872d" class="t t">HyperVSocketErrorTextWriter</a>.<a href="../server/OutOfProcServerMediator.cs.html#c128900a8072a3f4" class="i property">ErrorPrepend</a>.<span class="i">Length</span>);
                        <a href="#da60ecb1a90ace20" class="i method">HandleErrorDataReceived</a>(<span class="r139 r">errorData</span>);
                    }
                    <b>else</b>
                    {
                        <span class="c">// Normal output data.</span>
                        <a href="#01b8d088286a3591" class="i method">HandleOutputDataReceived</a>(<span class="r137 r">data</span>);
                    }
                }
            }
            <b>catch</b> (<span class="i">ObjectDisposedException</span>)
            {
                <span class="c">// Normal reader thread end.</span>
            }
            <b>catch</b> (<span class="i">Exception</span> <span id="r140 rd" class="r140 r">e</span>)
            {
                <b>if</b> (<span class="r140 r">e</span> <b>is</b> <span class="i">ArgumentOutOfRangeException</span>)
                {
                    <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<b>false</b>, <span class="s">&quot;Need to adjust transport fragmentor to accomodate read buffer size.&quot;</span>);
                }
 
                <b>string</b> <span id="r141 rd" class="r141 r">errorMsg</span> = <span class="r140 r">e</span>.<span class="i">Message</span> ?? <b>string</b>.<span class="i">Empty</span>;
                <a href="#8de2a991a3b17128" class="i field">_tracer</a>.<span class="i">WriteMessage</span>(<span class="s">&quot;HyperVSocketClientSessionTransportManager&quot;</span>, <span class="s">&quot;StartReaderThread&quot;</span>, <span class="i">Guid</span>.<span class="i">Empty</span>,
                    <span class="s">&quot;Transport manager reader thread ended with error: {0}&quot;</span>, <span class="r141 r">errorMsg</span>);
 
                <a href="../common/remotingexceptions.cs.html#0bb8687f97d91059" class="t t">PSRemotingTransportException</a> <span id="r142 rd" class="r142 r">psrte</span> = <b>new</b> <span class="t">PSRemotingTransportException</span>(
                    <a href="../common/remotingexceptions.cs.html#a969589d7508bf05" class="t t">PSRemotingErrorId</a>.<a href="../common/remotingexceptions.cs.html#c5268fb78fd26d44" class="i field">IPCServerProcessReportedError</a>,
                    <span class="i">RemotingErrorIdStrings</span>.<span class="i">IPCServerProcessReportedError</span>,
                    <span class="i">RemotingErrorIdStrings</span>.<span class="i">HyperVSocketTransportProcessEnded</span>);
                <a href="BaseTransportManager.cs.html#8e00d8a2f8745652" class="i method">RaiseErrorHandler</a>(<b>new</b> <a href="BaseTransportManager.cs.html#c420864940871a42" class="t constructor">TransportErrorOccuredEventArgs</a>(<span class="r142 r">psrte</span>, <a href="BaseTransportManager.cs.html#33678df914ca9daf" class="t t">TransportMethodEnum</a>.<a href="BaseTransportManager.cs.html#c91edb639e1ae62a" class="i field">ReceiveShellOutputEx</a>));
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
    }
 
    <b>internal sealed class</b> <a id="ecc47599219c6ba3" href="../../../R/ecc47599219c6ba3.html" target="n" data-glyph="2,0" class="t t">VMHyperVSocketClientSessionTransportManager</a> : <a href="#e9dd0d27d8d6b798" class="t t">HyperVSocketClientSessionTransportManagerBase</a>
    {
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Private Data
 
        <b>private readonly</b> <span class="i">Guid</span> <a id="75e49de9d1bfbc3e" href="../../../R/75e49de9d1bfbc3e.html" target="n" data-glyph="46,1" class="i field">_vmGuid</a>;
        <b>private readonly string</b> <a id="42a2b9b7f78fa639" href="../../../R/42a2b9b7f78fa639.html" target="n" data-glyph="46,1" class="i field">_configurationName</a>;
        <b>private readonly</b> <a href="../common/RunspaceConnectionInfo.cs.html#3906a420e89ab01e" class="t t">VMConnectionInfo</a> <a id="350a706bec4e1442" href="../../../R/350a706bec4e1442.html" target="n" data-glyph="46,1" class="i field">_connectionInfo</a>;
        <b>private readonly</b> <span class="i">NetworkCredential</span> <a id="871c273b676256ca" href="../../../R/871c273b676256ca.html" target="n" data-glyph="46,1" class="i field">_networkCredential</a>;
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Constructors
 
        <b>internal</b> <a id="b4dbc7a9f1f5d82f" href="../../../R/b4dbc7a9f1f5d82f.html" target="n" data-glyph="74,1" class="t constructor">VMHyperVSocketClientSessionTransportManager</a>(
            <a href="../common/RunspaceConnectionInfo.cs.html#3906a420e89ab01e" class="t t">VMConnectionInfo</a> <span id="r143 rd" class="r143 r">connectionInfo</span>,
            <span class="i">Guid</span> <span id="r144 rd" class="r144 r">runspaceId</span>,
            <a href="../../../utils/CryptoUtils.cs.html#1999dfb2439af5a0" class="t t">PSRemotingCryptoHelper</a> <span id="r145 rd" class="r145 r">cryptoHelper</span>,
            <span class="i">Guid</span> <span id="r146 rd" class="r146 r">vmGuid</span>,
            <b>string</b> <span id="r147 rd" class="r147 r">configurationName</span>)
            : <a href="#1f840a8cfa1d4f72" class="k">base</a>(<span class="r144 r">runspaceId</span>, <span class="r145 r">cryptoHelper</span>)
        {
            <b>if</b> (<span class="r143 r">connectionInfo</span> == <b>null</b>)
            {
                <b>throw</b> <b>new</b> <a href="../../../utils/MshArgumentNullException.cs.html#166e605c6cb05157" class="t constructor">PSArgumentNullException</a>(<b>nameof</b>(<span class="r143 r">connectionInfo</span>));
            }
 
            <a href="#350a706bec4e1442" class="i field">_connectionInfo</a> = <span class="r143 r">connectionInfo</span>;
            <a href="#75e49de9d1bfbc3e" class="i field">_vmGuid</a> = <span class="r146 r">vmGuid</span>;
            <a href="#42a2b9b7f78fa639" class="i field">_configurationName</a> = <span class="r147 r">configurationName</span>;
 
            <b>if</b> (<span class="r143 r">connectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#c860420833d917b0" class="i property">Credential</a> == <b>null</b>)
            {
                <a href="#871c273b676256ca" class="i field">_networkCredential</a> = <span class="i">CredentialCache</span>.<span class="i">DefaultNetworkCredentials</span>;
            }
            <b>else</b>
            {
                <a href="#871c273b676256ca" class="i field">_networkCredential</a> = <span class="r143 r">connectionInfo</span>.<a href="../common/RunspaceConnectionInfo.cs.html#c860420833d917b0" class="i property">Credential</a>.<a href="../../Credential.cs.html#ebb6efe250209ca7" class="i method">GetNetworkCredential</a>();
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Overrides
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Create a Hyper-V socket connection to the target process and set up</span>
        <span class="c">///</span><span class="c"> transport reader/writer.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal override void</b> <a id="8024e6b3f66cdda6" href="../../../R/8024e6b3f66cdda6.html" target="n" data-glyph="74,1" class="i method">CreateAsync</a>()
        {
            <a href="#9e98403004225646" class="i field">_client</a> = <b>new</b> <a href="../common/RemoteSessionHyperVSocket.cs.html#ae51da33e755d135" class="t constructor">RemoteSessionHyperVSocketClient</a>(<a href="#75e49de9d1bfbc3e" class="i field">_vmGuid</a>, <b>true</b>);
            <b>if</b> (!<a href="#9e98403004225646" class="i field">_client</a>.<a href="../common/RemoteSessionHyperVSocket.cs.html#1df51c6712c37806" class="i method">Connect</a>(<a href="#871c273b676256ca" class="i field">_networkCredential</a>, <a href="#42a2b9b7f78fa639" class="i field">_configurationName</a>, <b>true</b>))
            {
                <a href="#9e98403004225646" class="i field">_client</a>.<a href="../common/RemoteSessionHyperVSocket.cs.html#a0db02894bc69b66" class="i method">Dispose</a>();
                <b>throw</b> <b>new</b> <a href="../../../utils/MshInvalidOperationException.cs.html#26c9dca266e6a4d5" class="t constructor">PSInvalidOperationException</a>(
                    <a href="../common/remotingexceptions.cs.html#53047fc052e9b445" class="t t">PSRemotingErrorInvariants</a>.<span class="i">FormatResourceString</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">VMSessionConnectFailed</span>),
                    <b>null</b>,
                    <b>nameof</b>(<a href="../common/remotingexceptions.cs.html#a969589d7508bf05" class="t t">PSRemotingErrorId</a>.<a href="../common/remotingexceptions.cs.html#a576ec8481fb914b" class="i field">VMSessionConnectFailed</a>),
                    <a href="../../ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../../ErrorPackage.cs.html#b5cba3d51f976bb3" class="i field">InvalidOperation</a>,
                    <b>null</b>);
            }
 
            <span class="c">// TODO: remove below 3 lines when Hyper-V socket duplication is supported in .NET framework.</span>
            <a href="#9e98403004225646" class="i field">_client</a>.<a href="../common/RemoteSessionHyperVSocket.cs.html#a0db02894bc69b66" class="i method">Dispose</a>();
            <a href="#9e98403004225646" class="i field">_client</a> = <b>new</b> <a href="../common/RemoteSessionHyperVSocket.cs.html#ae51da33e755d135" class="t constructor">RemoteSessionHyperVSocketClient</a>(<a href="#75e49de9d1bfbc3e" class="i field">_vmGuid</a>, <b>false</b>);
            <b>if</b> (!<a href="#9e98403004225646" class="i field">_client</a>.<a href="../common/RemoteSessionHyperVSocket.cs.html#1df51c6712c37806" class="i method">Connect</a>(<a href="#871c273b676256ca" class="i field">_networkCredential</a>, <a href="#42a2b9b7f78fa639" class="i field">_configurationName</a>, <b>false</b>))
            {
                <a href="#9e98403004225646" class="i field">_client</a>.<a href="../common/RemoteSessionHyperVSocket.cs.html#a0db02894bc69b66" class="i method">Dispose</a>();
                <b>throw</b> <b>new</b> <a href="../../../utils/MshInvalidOperationException.cs.html#26c9dca266e6a4d5" class="t constructor">PSInvalidOperationException</a>(
                    <a href="../common/remotingexceptions.cs.html#53047fc052e9b445" class="t t">PSRemotingErrorInvariants</a>.<span class="i">FormatResourceString</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">VMSessionConnectFailed</span>),
                    <b>null</b>,
                    <b>nameof</b>(<a href="../common/remotingexceptions.cs.html#a969589d7508bf05" class="t t">PSRemotingErrorId</a>.<a href="../common/remotingexceptions.cs.html#a576ec8481fb914b" class="i field">VMSessionConnectFailed</a>),
                    <a href="../../ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../../ErrorPackage.cs.html#b5cba3d51f976bb3" class="i field">InvalidOperation</a>,
                    <b>null</b>);
            }
 
            <span class="c">// Create writer for Hyper-V socket.</span>
            <a href="#908a2aa48b413a01" class="i field">stdInWriter</a> = <b>new</b> <span class="t">OutOfProcessTextWriter</span>(<a href="#9e98403004225646" class="i field">_client</a>.<a href="../common/RemoteSessionHyperVSocket.cs.html#6f1dcc3c7f730bc9" class="i property">TextWriter</a>);
 
            <span class="c">// Create reader thread for Hyper-V socket.</span>
            <a href="#ffd999b86c11050f" class="i method">StartReaderThread</a>(<a href="#9e98403004225646" class="i field">_client</a>.<a href="../common/RemoteSessionHyperVSocket.cs.html#1ae902f33e29e03f" class="i property">TextReader</a>);
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
    }
 
    <b>internal sealed class</b> <a id="5954306e0805f693" href="../../../R/5954306e0805f693.html" target="n" data-glyph="2,0" class="t t">ContainerHyperVSocketClientSessionTransportManager</a> : <a href="#e9dd0d27d8d6b798" class="t t">HyperVSocketClientSessionTransportManagerBase</a>
    {
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Private Data
 
        <b>private readonly</b> <span class="i">Guid</span> <a id="c68ad7e69e5d32fd" href="../../../R/c68ad7e69e5d32fd.html" target="n" data-glyph="46,1" class="i field">_targetGuid</a>; <span class="c">// currently this is the utility vm guid in HyperV container scenario</span>
        <b>private readonly</b> <a href="../common/RunspaceConnectionInfo.cs.html#d2be2d5c63c76391" class="t t">ContainerConnectionInfo</a> <a id="e7a481693719f22b" href="../../../R/e7a481693719f22b.html" target="n" data-glyph="46,1" class="i field">_connectionInfo</a>;
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Constructors
 
        <b>internal</b> <a id="b270f1da49f6a69e" href="../../../R/b270f1da49f6a69e.html" target="n" data-glyph="74,1" class="t constructor">ContainerHyperVSocketClientSessionTransportManager</a>(
            <a href="../common/RunspaceConnectionInfo.cs.html#d2be2d5c63c76391" class="t t">ContainerConnectionInfo</a> <span id="r148 rd" class="r148 r">connectionInfo</span>,
            <span class="i">Guid</span> <span id="r149 rd" class="r149 r">runspaceId</span>,
            <a href="../../../utils/CryptoUtils.cs.html#1999dfb2439af5a0" class="t t">PSRemotingCryptoHelper</a> <span id="r150 rd" class="r150 r">cryptoHelper</span>,
            <span class="i">Guid</span> <span id="r151 rd" class="r151 r">targetGuid</span>)
            : <a href="#1f840a8cfa1d4f72" class="k">base</a>(<span class="r149 r">runspaceId</span>, <span class="r150 r">cryptoHelper</span>)
        {
            <b>if</b> (<span class="r148 r">connectionInfo</span> == <b>null</b>)
            {
                <b>throw</b> <b>new</b> <a href="../../../utils/MshArgumentNullException.cs.html#166e605c6cb05157" class="t constructor">PSArgumentNullException</a>(<b>nameof</b>(<span class="r148 r">connectionInfo</span>));
            }
 
            <a href="#e7a481693719f22b" class="i field">_connectionInfo</a> = <span class="r148 r">connectionInfo</span>;
            <a href="#c68ad7e69e5d32fd" class="i field">_targetGuid</a> = <span class="r151 r">targetGuid</span>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Overrides
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Create a Hyper-V socket connection to the target process and set up</span>
        <span class="c">///</span><span class="c"> transport reader/writer.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal override void</b> <a id="1ed53a755910beea" href="../../../R/1ed53a755910beea.html" target="n" data-glyph="74,1" class="i method">CreateAsync</a>()
        {
            <a href="#9e98403004225646" class="i field">_client</a> = <b>new</b> <a href="../common/RemoteSessionHyperVSocket.cs.html#ae51da33e755d135" class="t constructor">RemoteSessionHyperVSocketClient</a>(<a href="#c68ad7e69e5d32fd" class="i field">_targetGuid</a>, <b>false</b>, <b>true</b>);
            <b>if</b> (!<a href="#9e98403004225646" class="i field">_client</a>.<span class="i">Connect</span>(<b>null</b>, <b>string</b>.<span class="i">Empty</span>, <b>false</b>))
            {
                <a href="#9e98403004225646" class="i field">_client</a>.<a href="../common/RemoteSessionHyperVSocket.cs.html#a0db02894bc69b66" class="i method">Dispose</a>();
                <b>throw</b> <b>new</b> <a href="../../../utils/MshInvalidOperationException.cs.html#26c9dca266e6a4d5" class="t constructor">PSInvalidOperationException</a>(
                    <a href="../common/remotingexceptions.cs.html#53047fc052e9b445" class="t t">PSRemotingErrorInvariants</a>.<span class="i">FormatResourceString</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">ContainerSessionConnectFailed</span>),
                    <b>null</b>,
                    <b>nameof</b>(<a href="../common/remotingexceptions.cs.html#a969589d7508bf05" class="t t">PSRemotingErrorId</a>.<a href="../common/remotingexceptions.cs.html#56a0266a26832672" class="i field">ContainerSessionConnectFailed</a>),
                    <a href="../../ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../../ErrorPackage.cs.html#b5cba3d51f976bb3" class="i field">InvalidOperation</a>,
                    <b>null</b>);
            }
 
            <span class="c">// Create writer for Hyper-V socket.</span>
            <a href="#908a2aa48b413a01" class="i field">stdInWriter</a> = <b>new</b> <span class="t">OutOfProcessTextWriter</span>(<a href="#9e98403004225646" class="i field">_client</a>.<a href="../common/RemoteSessionHyperVSocket.cs.html#6f1dcc3c7f730bc9" class="i property">TextWriter</a>);
 
            <span class="c">// Create reader thread for Hyper-V socket.</span>
            <a href="#ffd999b86c11050f" class="i method">StartReaderThread</a>(<a href="#9e98403004225646" class="i field">_client</a>.<a href="../common/RemoteSessionHyperVSocket.cs.html#1ae902f33e29e03f" class="i property">TextReader</a>);
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
    }
 
    <b>internal sealed class</b> <a id="fce8bfa107f5c233" href="../../../R/fce8bfa107f5c233.html" target="n" data-glyph="2,0" class="t t">SSHClientSessionTransportManager</a> : <a href="#d45b9c7a452bcb48" class="t t">OutOfProcessClientSessionTransportManagerBase</a>
    {
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Data
 
        <b>private readonly</b> <a href="../common/RunspaceConnectionInfo.cs.html#c9fcf5b14ea1c33c" class="t t">SSHConnectionInfo</a> <a id="19c48ce66a0446db" href="../../../R/19c48ce66a0446db.html" target="n" data-glyph="46,1" class="i field">_connectionInfo</a>;
        <b>private int</b> <a id="8b8049efca6f3054" href="../../../R/8b8049efca6f3054.html" target="n" data-glyph="46,1" class="i field">_sshProcessId</a>;
        <b>private</b> <span class="i">StreamWriter</span> <a id="4a8f1ccd021d4188" href="../../../R/4a8f1ccd021d4188.html" target="n" data-glyph="46,1" class="i field">_stdInWriter</a>;
        <b>private</b> <span class="i">StreamReader</span> <a id="c58df1dd9c3ca892" href="../../../R/c58df1dd9c3ca892.html" target="n" data-glyph="46,1" class="i field">_stdOutReader</a>;
        <b>private</b> <span class="i">StreamReader</span> <a id="7e5e6935d66cea83" href="../../../R/7e5e6935d66cea83.html" target="n" data-glyph="46,1" class="i field">_stdErrReader</a>;
        <b>private bool</b> <a id="1fcdeae1586342e9" href="../../../R/1fcdeae1586342e9.html" target="n" data-glyph="46,1" class="i field">_connectionEstablished</a>;
        <b>private</b> <span class="i">Timer</span> <a id="addc3a63b61a166d" href="../../../R/addc3a63b61a166d.html" target="n" data-glyph="46,1" class="i field">_connectionTimer</a>;
 
        <b>private const string</b> <a id="e46fe67a6d2b93fc" href="../../../R/e46fe67a6d2b93fc.html" target="n" data-glyph="10,1" class="i field">_threadName</a> = <span class="s">&quot;SSHTransport Reader Thread&quot;</span>;
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Constructors
 
        <b>internal</b> <a id="c46030bf3f459363" href="../../../R/c46030bf3f459363.html" target="n" data-glyph="74,1" class="t constructor">SSHClientSessionTransportManager</a>(
            <a href="../common/RunspaceConnectionInfo.cs.html#c9fcf5b14ea1c33c" class="t t">SSHConnectionInfo</a> <span id="r152 rd" class="r152 r">connectionInfo</span>,
            <span class="i">Guid</span> <span id="r153 rd" class="r153 r">runspaceId</span>,
            <a href="../../../utils/CryptoUtils.cs.html#1999dfb2439af5a0" class="t t">PSRemotingCryptoHelper</a> <span id="r154 rd" class="r154 r">cryptoHelper</span>)
            : <a href="#9c94004483e5b344" class="k">base</a>(<span class="r153 r">runspaceId</span>, <span class="r154 r">cryptoHelper</span>)
        {
            <b>if</b> (<span class="r152 r">connectionInfo</span> == <b>null</b>) { <b>throw</b> <b>new</b> <a href="../../../utils/MshArgumentException.cs.html#095568dc2e26cb6e" class="t constructor">PSArgumentException</a>(<span class="s">&quot;connectionInfo&quot;</span>); }
 
            <a href="#19c48ce66a0446db" class="i field">_connectionInfo</a> = <span class="r152 r">connectionInfo</span>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Overrides
 
        <b>internal override void</b> <a id="a78e684d7622ff1a" href="../../../R/a78e684d7622ff1a.html" target="n" data-glyph="74,1" class="i method">Dispose</a>(<b>bool</b> <span id="r155 rd" class="r155 r">isDisposing</span>)
        {
            <a href="#d45b9c7a452bcb48" class="k">base</a>.<a href="#78bbdada56985127" class="i method">Dispose</a>(<span class="r155 r">isDisposing</span>);
 
            <b>if</b> (<span class="r155 r">isDisposing</span>)
            {
                <a href="#bd33e5add7690c9f" class="i method">CloseConnection</a>();
            }
        }
 
        <b>protected override void</b> <a id="0036c6b84a5019e9" href="../../../R/0036c6b84a5019e9.html" target="n" data-glyph="75,1" class="i method">CleanupConnection</a>()
        {
            <a href="#bd33e5add7690c9f" class="i method">CloseConnection</a>();
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Create an SSH connection to the target host and set up</span>
        <span class="c">///</span><span class="c"> transport reader/writer.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal override void</b> <a id="b30f397db45d5609" href="../../../R/b30f397db45d5609.html" target="n" data-glyph="74,1" class="i method">CreateAsync</a>()
        {
            <span class="c">// Create the ssh client process with connection to host target.</span>
            <a href="#8b8049efca6f3054" class="i field">_sshProcessId</a> = <a href="#19c48ce66a0446db" class="i field">_connectionInfo</a>.<a href="../common/RunspaceConnectionInfo.cs.html#b59200dab1d45d5b" class="i method">StartSSHProcess</a>(
                <b>out</b> <a href="#4a8f1ccd021d4188" class="i field">_stdInWriter</a>,
                <b>out</b> <a href="#c58df1dd9c3ca892" class="i field">_stdOutReader</a>,
                <b>out</b> <a href="#7e5e6935d66cea83" class="i field">_stdErrReader</a>);
 
            <span class="c">// Start error reader thread.</span>
            <a href="#a0851e610491c760" class="i method">StartErrorThread</a>(<a href="#7e5e6935d66cea83" class="i field">_stdErrReader</a>);
 
            <span class="c">// Create writer for named pipe.</span>
            <a href="#908a2aa48b413a01" class="i field">stdInWriter</a> = <b>new</b> <span class="t">OutOfProcessTextWriter</span>(<a href="#4a8f1ccd021d4188" class="i field">_stdInWriter</a>);
 
            <span class="c">// Create reader thread and send first PSRP message.</span>
            <a href="#3de6d8624b06a372" class="i method">StartReaderThread</a>(<a href="#c58df1dd9c3ca892" class="i field">_stdOutReader</a>);
 
            <b>if</b> (<a href="#19c48ce66a0446db" class="i field">_connectionInfo</a>.<a href="../common/RunspaceConnectionInfo.cs.html#86fc228db952144a" class="i property">ConnectingTimeout</a> &lt; 0)
            {
                <b>return</b>;
            }
 
            <span class="c">// Start connection timeout timer if requested.</span>
            <span class="c">// Timer callback occurs only once after timeout time.</span>
            <a href="#addc3a63b61a166d" class="i field">_connectionTimer</a> = <b>new</b> <span class="i">Timer</span>(
                <span class="i">callback</span>: (<span id="r156 rd" class="r156 r">_</span>) =&gt; 
                {
                    <b>if</b> (<a href="#1fcdeae1586342e9" class="i field">_connectionEstablished</a>)
                    {
                        <b>return</b>;
                    }
 
                    <span class="c">// Detect if SSH client process terminates prematurely.</span>
                    <b>bool</b> <span id="r157 rd" class="r157 r">sshTerminated</span> = <b>false</b>;
                    <b>try</b>
                    {
                        <b>using</b> (<b>var</b> <span id="r158 rd" class="r158 r">sshProcess</span> = <span class="i n">System</span>.<span class="i n">Diagnostics</span>.<span class="i">Process</span>.<span class="i">GetProcessById</span>(<a href="#8b8049efca6f3054" class="i field">_sshProcessId</a>))
                        {
                            <span class="r157 r">sshTerminated</span> = <span class="r158 r">sshProcess</span> == <b>null</b> || <span class="r158 r">sshProcess</span>.<span class="i">Handle</span> == <span class="i">IntPtr</span>.<span class="i">Zero</span> || <span class="r158 r">sshProcess</span>.<span class="i">HasExited</span>;
                        }
                    }
                    <b>catch</b>
                    {
                        <span class="r157 r">sshTerminated</span> = <b>true</b>;
                    }
 
                    <b>var</b> <span id="r159 rd" class="r159 r">errorMessage</span> = <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">SSHClientConnectTimeout</span>, <a href="#19c48ce66a0446db" class="i field">_connectionInfo</a>.<a href="../common/RunspaceConnectionInfo.cs.html#86fc228db952144a" class="i property">ConnectingTimeout</a> / 1000);
                    <b>if</b> (<span class="r157 r">sshTerminated</span>)
                    {
                        <span class="r159 r">errorMessage</span> += <span class="i">RemotingErrorIdStrings</span>.<span class="i">SSHClientConnectProcessTerminated</span>;
                    }
 
                    <span class="c">// Report error and terminate connection attempt.</span>
                    <a href="#0998dd6a1333d9af" class="i method">HandleSSHError</a>(
                        <b>new</b> <a href="../common/remotingexceptions.cs.html#3d42c01e0f93455e" class="t constructor">PSRemotingTransportException</a>(<span class="r159 r">errorMessage</span>));
                },
                <span class="i">state</span>: <b>null</b>,
                <span class="i">dueTime</span>: <a href="#19c48ce66a0446db" class="i field">_connectionInfo</a>.<a href="../common/RunspaceConnectionInfo.cs.html#86fc228db952144a" class="i property">ConnectingTimeout</a>,
                <span class="i">period</span>: <span class="i">Timeout</span>.<span class="i">Infinite</span>);
        }
 
        <b>internal override void</b> <a id="9b624163bf59f2a6" href="../../../R/9b624163bf59f2a6.html" target="n" data-glyph="74,1" class="i method">CloseAsync</a>()
        {
            <a href="#d45b9c7a452bcb48" class="k">base</a>.<a href="#0f5b460979385f69" class="i method">CloseAsync</a>();
 
            <b>if</b> (!<a href="#1fcdeae1586342e9" class="i field">_connectionEstablished</a>)
            {
                <span class="c">// If the connection is not yet estalished then clean up any existing connection state.</span>
                <a href="#bd33e5add7690c9f" class="i method">CloseConnection</a>();
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Private Methods
 
        <b>private void</b> <a id="bd33e5add7690c9f" href="../../../R/bd33e5add7690c9f.html" target="n" data-glyph="76,1" class="i method">CloseConnection</a>()
        {
            <span class="c">// Ensure message queue is disposed.</span>
            <a href="#5a8ad2d42b546b1d" class="i method">DisposeMessageQueue</a>();
 
            <b>var</b> <span id="r160 rd" class="r160 r">connectionTimer</span> = <span class="i">Interlocked</span>.<span class="i">Exchange</span>(<b>ref</b> <a href="#addc3a63b61a166d" class="i field">_connectionTimer</a>, <b>null</b>);
            <span class="r160 r">connectionTimer</span>?.<span class="i">Dispose</span>();
 
            <b>var</b> <span id="r161 rd" class="r161 r">stdInWriter</span> = <span class="i">Interlocked</span>.<span class="i">Exchange</span>(<b>ref</b> <a href="#4a8f1ccd021d4188" class="i field">_stdInWriter</a>, <b>null</b>);
            <span class="r161 r">stdInWriter</span>?.<span class="i">Dispose</span>();
 
            <b>var</b> <span id="r162 rd" class="r162 r">stdOutReader</span> = <span class="i">Interlocked</span>.<span class="i">Exchange</span>(<b>ref</b> <a href="#c58df1dd9c3ca892" class="i field">_stdOutReader</a>, <b>null</b>);
            <span class="r162 r">stdOutReader</span>?.<span class="i">Dispose</span>();
 
            <b>var</b> <span id="r163 rd" class="r163 r">stdErrReader</span> = <span class="i">Interlocked</span>.<span class="i">Exchange</span>(<b>ref</b> <a href="#7e5e6935d66cea83" class="i field">_stdErrReader</a>, <b>null</b>);
            <span class="r163 r">stdErrReader</span>?.<span class="i">Dispose</span>();
 
            <span class="c">// The CloseConnection() method can be called multiple times from multiple places.</span>
            <span class="c">// Set the _sshProcessId to zero here so that we go through the work of finding</span>
            <span class="c">// and terminating the SSH process just once.</span>
            <b>var</b> <span id="r164 rd" class="r164 r">sshProcessId</span> = <span class="i">Interlocked</span>.<span class="i">Exchange</span>(<b>ref</b> <a href="#8b8049efca6f3054" class="i field">_sshProcessId</a>, 0);
            <b>if</b> (<span class="r164 r">sshProcessId</span> != 0)
            {
                <b>try</b>
                {
                    <a href="#19c48ce66a0446db" class="i field">_connectionInfo</a>.<span class="i">KillSSHProcess</span>(<span class="r164 r">sshProcessId</span>);
                }
                <b>catch</b> (<span class="i">ArgumentException</span>) { }
                <b>catch</b> (<span class="i">InvalidOperationException</span>) { }
                <b>catch</b> (<span class="i">NotSupportedException</span>) { }
                <b>catch</b> (<span class="i n">System</span>.<span class="i">ComponentModel</span>.<span class="i">Win32Exception</span>) { }
            }
        }
 
        <b>private void</b> <a id="a0851e610491c760" href="../../../R/a0851e610491c760.html" target="n" data-glyph="76,1" class="i method">StartErrorThread</a>(
            <span class="i">StreamReader</span> <span id="r165 rd" class="r165 r">stdErrReader</span>)
        {
            <span class="i">Thread</span> <span id="r166 rd" class="r166 r">errorThread</span> = <b>new</b> <span class="i">Thread</span>(<span class="i">ProcessErrorThread</span>);
            <span class="r166 r">errorThread</span>.<span class="i">Name</span> = <span class="s">&quot;SSH Transport Error Thread&quot;</span>;
            <span class="r166 r">errorThread</span>.<span class="i">IsBackground</span> = <b>true</b>;
            <span class="r166 r">errorThread</span>.<span class="i">Start</span>(<span class="r165 r">stdErrReader</span>);
        }
 
        <b>private void</b> <a id="b9064e7cf2bc98d5" href="../../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">ProcessErrorThread</a>(<b>object</b> <span id="r167 rd" class="r167 r">state</span>)
        {
            <b>try</b>
            {
                <span class="i">StreamReader</span> <span id="r168 rd" class="r168 r">reader</span> = <span class="r167 r">state</span> <b>as</b> <span class="i">StreamReader</span>;
                <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r168 r">reader</span> != <b>null</b>, <span class="s">&quot;Reader cannot be null.&quot;</span>);
 
                <b>while</b> (<b>true</b>)
                {
                    <b>string</b> <span id="r169 rd" class="r169 r">error</span> = <a href="#deae1e6161d00b96" class="i method">ReadError</a>(<span class="r168 r">reader</span>);
 
                    <b>if</b> (<span class="r169 r">error</span>.<span class="i">Length</span> == 0)
                    {
                        <span class="c">// Ignore</span>
                        <b>continue</b>;
                    }
 
                    <span class="c">// Any SSH client error results in a broken session.</span>
                    <a href="../common/remotingexceptions.cs.html#0bb8687f97d91059" class="t t">PSRemotingTransportException</a> <span id="r170 rd" class="r170 r">psrte</span> = <b>new</b> <span class="t">PSRemotingTransportException</span>(
                        <a href="../common/remotingexceptions.cs.html#a969589d7508bf05" class="t t">PSRemotingErrorId</a>.<a href="../common/remotingexceptions.cs.html#c5268fb78fd26d44" class="i field">IPCServerProcessReportedError</a>,
                        <span class="i">RemotingErrorIdStrings</span>.<span class="i">IPCServerProcessReportedError</span>,
                        <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">SSHClientEndWithErrorMessage</span>, <span class="r169 r">error</span>));
                    <a href="#0998dd6a1333d9af" class="i method">HandleSSHError</a>(<span class="r170 r">psrte</span>);
                }
            }
            <b>catch</b> (<span class="i">ObjectDisposedException</span>)
            {
                <span class="c">// Normal reader thread end.</span>
            }
            <b>catch</b> (<span class="i">Exception</span> <span id="r171 rd" class="r171 r">e</span>)
            {
                <b>string</b> <span id="r172 rd" class="r172 r">errorMsg</span> = <span class="r171 r">e</span>.<span class="i">Message</span> ?? <b>string</b>.<span class="i">Empty</span>;
                <a href="#8de2a991a3b17128" class="i field">_tracer</a>.<span class="i">WriteMessage</span>(<span class="s">&quot;SSHClientSessionTransportManager&quot;</span>, <span class="s">&quot;ProcessErrorThread&quot;</span>, <span class="i">Guid</span>.<span class="i">Empty</span>,
                    <span class="s">&quot;Transport manager error thread ended with error: {0}&quot;</span>, <span class="r172 r">errorMsg</span>);
 
                <a href="../common/remotingexceptions.cs.html#0bb8687f97d91059" class="t t">PSRemotingTransportException</a> <span id="r173 rd" class="r173 r">psrte</span> = <b>new</b> <a href="../common/remotingexceptions.cs.html#d4cea43ac18f039f" class="t constructor">PSRemotingTransportException</a>(
                    <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">SSHClientEndWithErrorMessage</span>, <span class="r172 r">errorMsg</span>),
                    <span class="r171 r">e</span>);
                <a href="#0998dd6a1333d9af" class="i method">HandleSSHError</a>(<span class="r173 r">psrte</span>);
            }
        }
 
        <b>private void</b> <a id="0998dd6a1333d9af" href="../../../R/0998dd6a1333d9af.html" target="n" data-glyph="76,1" class="i method">HandleSSHError</a>(<a href="../common/remotingexceptions.cs.html#0bb8687f97d91059" class="t t">PSRemotingTransportException</a> <span id="r174 rd" class="r174 r">psrte</span>)
        {
            <a href="BaseTransportManager.cs.html#8e00d8a2f8745652" class="i method">RaiseErrorHandler</a>(<b>new</b> <a href="BaseTransportManager.cs.html#c420864940871a42" class="t constructor">TransportErrorOccuredEventArgs</a>(<span class="r174 r">psrte</span>, <a href="BaseTransportManager.cs.html#33678df914ca9daf" class="t t">TransportMethodEnum</a>.<a href="BaseTransportManager.cs.html#2cc9ee1cdce7fca6" class="i field">CloseShellOperationEx</a>));
            <a href="#bd33e5add7690c9f" class="i method">CloseConnection</a>();
        }
 
        <b>private static string</b> <a id="deae1e6161d00b96" href="../../../R/deae1e6161d00b96.html" target="n" data-glyph="76,1" class="i method">ReadError</a>(<span class="i">StreamReader</span> <span id="r175 rd" class="r175 r">reader</span>)
        {
            <span class="c">// Blocking read from StdError stream</span>
            <b>string</b> <span id="r176 rd" class="r176 r">error</span> = <span class="r175 r">reader</span>.<span class="i">ReadLine</span>();
 
            <b>if</b> (<span class="r176 r">error</span> == <b>null</b>)
            {
                <span class="c">// Stream is closed unexpectedly.</span>
                <b>throw</b> <b>new</b> <span class="t">PSInvalidOperationException</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">SSHAbruptlyTerminated</span>);
            }
 
            <b>if</b> ((<span class="r176 r">error</span>.<span class="i">Length</span> == 0) ||
                <span class="r176 r">error</span>.<span class="i">Contains</span>(<span class="s">&quot;WARNING:&quot;</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
            {
                <span class="c">// Handle as interactive warning message</span>
                <span class="i">Console</span>.<span class="i">WriteLine</span>(<span class="r176 r">error</span>);
                <b>return</b> <b>string</b>.<span class="i">Empty</span>;
            }
 
            <span class="c">// SSH may return a multi-line error message.</span>
            <span class="c">// The StdError pipe stream is open ended causing StreamReader read operations to block</span>
            <span class="c">// if there is no incoming data.  Since we don&#39;t know how many error message lines there</span>
            <span class="c">// will be we use an asynchronous read with timeout to prevent blocking indefinitely.</span>
            <span class="i n">System</span>.<span class="i">Text</span>.<span class="i">StringBuilder</span> <span id="r177 rd" class="r177 r">sb</span> = <b>new</b> <span class="i">Text</span>.<span class="i">StringBuilder</span>(<span class="r176 r">error</span>);
            <b>var</b> <span id="r178 rd" class="r178 r">running</span> = <b>true</b>;
            <b>while</b> (<span class="r178 r">running</span>)
            {
                <b>try</b>
                {
                    <b>var</b> <span id="r179 rd" class="r179 r">task</span> = <span class="r175 r">reader</span>.<span class="i">ReadLineAsync</span>();
                    <b>if</b> (<span class="r179 r">task</span>.<span class="i">Wait</span>(1000) &amp;&amp; (<span class="r179 r">task</span>.<span class="i">Result</span> != <b>null</b>))
                    {
                        <span class="r177 r">sb</span>.<span class="i">Append</span>(<span class="i">Environment</span>.<span class="i">NewLine</span>);
                        <span class="r177 r">sb</span>.<span class="i">Append</span>(<span class="r179 r">task</span>.<span class="i">Result</span>);
                    }
                    <b>else</b>
                    {
                        <span class="r178 r">running</span> = <b>false</b>;
                    }
                }
                <b>catch</b> (<span class="i">Exception</span>)
                {
                    <span class="r178 r">running</span> = <b>false</b>;
                }
            }
 
            <b>return</b> <span class="r177 r">sb</span>.<span class="i">ToString</span>();
        }
 
        <b>private void</b> <a id="3de6d8624b06a372" href="../../../R/3de6d8624b06a372.html" target="n" data-glyph="76,1" class="i method">StartReaderThread</a>(
            <span class="i">StreamReader</span> <span id="r180 rd" class="r180 r">reader</span>)
        {
            <span class="i">Thread</span> <span id="r181 rd" class="r181 r">readerThread</span> = <b>new</b> <span class="i">Thread</span>(<span class="i">ProcessReaderThread</span>);
            <span class="r181 r">readerThread</span>.<span class="i">Name</span> = <a href="#e46fe67a6d2b93fc" class="i field">_threadName</a>;
            <span class="r181 r">readerThread</span>.<span class="i">IsBackground</span> = <b>true</b>;
            <span class="r181 r">readerThread</span>.<span class="i">Start</span>(<span class="r180 r">reader</span>);
        }
 
        <b>private void</b> <a id="ae8dbd3957f17da8" href="../../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">ProcessReaderThread</a>(<b>object</b> <span id="r182 rd" class="r182 r">state</span>)
        {
            <b>try</b>
            {
                <span class="i">StreamReader</span> <span id="r183 rd" class="r183 r">reader</span> = <span class="r182 r">state</span> <b>as</b> <span class="i">StreamReader</span>;
                <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r183 r">reader</span> != <b>null</b>, <span class="s">&quot;Reader cannot be null.&quot;</span>);
 
                <span class="c">// Send one fragment.</span>
                <a href="#b5ab391e61d975ce" class="i method">SendOneItem</a>();
 
                <span class="c">// Start reader loop.</span>
                <b>while</b> (<b>true</b>)
                {
                    <b>string</b> <span id="r184 rd" class="r184 r">data</span> = <span class="r183 r">reader</span>.<span class="i">ReadLine</span>();
                    <b>if</b> (<span class="r184 r">data</span> == <b>null</b>)
                    {
                        <span class="c">// End of stream indicates that the SSH transport is broken.</span>
                        <span class="c">// SSH will return the appropriate error in StdErr stream so</span>
                        <span class="c">// let the error reader thread report the error.</span>
                        <b>break</b>;
                    }
 
                    <b>if</b> (<span class="r184 r">data</span>.<span class="i">StartsWith</span>(<span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Remoting</span>.<span class="i n">Server</span>.<a href="../server/OutOfProcServerMediator.cs.html#d6d492dbec355ed7" class="t t">NamedPipeErrorTextWriter</a>.<a href="../server/OutOfProcServerMediator.cs.html#21c7ad4feb2e15a5" class="i property">ErrorPrepend</a>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
                    {
                        <span class="c">// Error message from the server.</span>
                        <b>string</b> <span id="r185 rd" class="r185 r">errorData</span> = <span class="r184 r">data</span>.<span class="i">Substring</span>(<span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Remoting</span>.<span class="i n">Server</span>.<a href="../server/OutOfProcServerMediator.cs.html#d6d492dbec355ed7" class="t t">NamedPipeErrorTextWriter</a>.<a href="../server/OutOfProcServerMediator.cs.html#21c7ad4feb2e15a5" class="i property">ErrorPrepend</a>.<span class="i">Length</span>);
                        <a href="#da60ecb1a90ace20" class="i method">HandleErrorDataReceived</a>(<span class="r185 r">errorData</span>);
                    }
                    <b>else</b>
                    {
                        <span class="c">// The first received PSRP message from the server indicates that the connection is established and that PSRP is running.</span>
                        <b>if</b> (!<a href="#1fcdeae1586342e9" class="i field">_connectionEstablished</a>) { <a href="#1fcdeae1586342e9" class="i field">_connectionEstablished</a> = <b>true</b>; }
 
                        <span class="c">// Normal output data.</span>
                        <a href="#01b8d088286a3591" class="i method">HandleOutputDataReceived</a>(<span class="r184 r">data</span>);
                    }
                }
            }
            <b>catch</b> (<span class="i">ObjectDisposedException</span>)
            {
                <span class="c">// Normal reader thread end.</span>
            }
            <b>catch</b> (<span class="i">Exception</span> <span id="r186 rd" class="r186 r">e</span>)
            {
                <b>if</b> (<span class="r186 r">e</span> <b>is</b> <span class="i">ArgumentOutOfRangeException</span>)
                {
                    <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<b>false</b>, <span class="s">&quot;Need to adjust transport fragmentor to accomodate read buffer size.&quot;</span>);
                }
 
                <b>string</b> <span id="r187 rd" class="r187 r">errorMsg</span> = <span class="r186 r">e</span>.<span class="i">Message</span> ?? <b>string</b>.<span class="i">Empty</span>;
                <a href="#8de2a991a3b17128" class="i field">_tracer</a>.<span class="i">WriteMessage</span>(<span class="s">&quot;SSHClientSessionTransportManager&quot;</span>, <span class="s">&quot;ProcessReaderThread&quot;</span>, <span class="i">Guid</span>.<span class="i">Empty</span>,
                    <span class="s">&quot;Transport manager reader thread ended with error: {0}&quot;</span>, <span class="r187 r">errorMsg</span>);
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
    }
 
    <b>internal abstract class</b> <a id="1ef951c5d22186f5" href="../../../R/1ef951c5d22186f5.html" target="n" data-glyph="2,0" class="t t">NamedPipeClientSessionTransportManagerBase</a> : <a href="#d45b9c7a452bcb48" class="t t">OutOfProcessClientSessionTransportManagerBase</a>
    {
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Data
 
        <b>private readonly</b> <a href="../common/RunspaceConnectionInfo.cs.html#e07ed56a8a1da829" class="t t">RunspaceConnectionInfo</a> <a id="bde4c878aaa3a8e1" href="../../../R/bde4c878aaa3a8e1.html" target="n" data-glyph="46,1" class="i field">_connectionInfo</a>;
        <b>protected</b> <a href="../common/RemoteSessionNamedPipe.cs.html#565e9e795ba1a099" class="t t">NamedPipeClientBase</a> <a id="eaa25db180df6d05" href="../../../R/eaa25db180df6d05.html" target="n" data-glyph="45,1" class="i field">_clientPipe</a> = <b>new</b> <a href="../common/RemoteSessionNamedPipe.cs.html#7aa52d8366226bcc" class="t constructor">NamedPipeClientBase</a>();
        <b>private readonly string</b> <a id="a39aa2ddfd61cdd8" href="../../../R/a39aa2ddfd61cdd8.html" target="n" data-glyph="46,1" class="i field">_threadName</a>;
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Constructors
 
        <b>internal</b> <a id="58cb4d8bda916fc1" href="../../../R/58cb4d8bda916fc1.html" target="n" data-glyph="74,1" class="t constructor">NamedPipeClientSessionTransportManagerBase</a>(
            <a href="../common/RunspaceConnectionInfo.cs.html#e07ed56a8a1da829" class="t t">RunspaceConnectionInfo</a> <span id="r188 rd" class="r188 r">connectionInfo</span>,
            <span class="i">Guid</span> <span id="r189 rd" class="r189 r">runspaceId</span>,
            <a href="../../../utils/CryptoUtils.cs.html#1999dfb2439af5a0" class="t t">PSRemotingCryptoHelper</a> <span id="r190 rd" class="r190 r">cryptoHelper</span>,
            <b>string</b> <span id="r191 rd" class="r191 r">threadName</span>)
            : <a href="#9c94004483e5b344" class="k">base</a>(<span class="r189 r">runspaceId</span>, <span class="r190 r">cryptoHelper</span>)
        {
            <b>if</b> (<span class="r188 r">connectionInfo</span> == <b>null</b>)
            {
                <b>throw</b> <b>new</b> <a href="../../../utils/MshArgumentNullException.cs.html#166e605c6cb05157" class="t constructor">PSArgumentNullException</a>(<b>nameof</b>(<span class="r188 r">connectionInfo</span>));
            }
 
            <a href="#bde4c878aaa3a8e1" class="i field">_connectionInfo</a> = <span class="r188 r">connectionInfo</span>;
            <a href="#a39aa2ddfd61cdd8" class="i field">_threadName</a> = <span class="r191 r">threadName</span>;
            <a href="BaseTransportManager.cs.html#0597b18306926355" class="i property">Fragmentor</a>.<a href="../common/fragmentor.cs.html#a4fa6a799e0782de" class="i property">FragmentSize</a> = <a href="../common/RemoteSessionNamedPipe.cs.html#c14a08ba7cdb8bb2" class="t t">RemoteSessionNamedPipeServer</a>.<a href="../common/RemoteSessionNamedPipe.cs.html#0e40898fb21d19f1" class="i property">NamedPipeBufferSizeForRemoting</a>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Overrides
 
        <b>internal override void</b> <a id="997aecd5ca52c759" href="../../../R/997aecd5ca52c759.html" target="n" data-glyph="74,1" class="i method">Dispose</a>(<b>bool</b> <span id="r192 rd" class="r192 r">isDisposing</span>)
        {
            <a href="#d45b9c7a452bcb48" class="k">base</a>.<a href="#78bbdada56985127" class="i method">Dispose</a>(<span class="r192 r">isDisposing</span>);
 
            <b>if</b> (<span class="r192 r">isDisposing</span>)
            {
                <b>if</b> (<a href="#eaa25db180df6d05" class="i field">_clientPipe</a> != <b>null</b>)
                {
                    <a href="#eaa25db180df6d05" class="i field">_clientPipe</a>.<a href="../common/RemoteSessionNamedPipe.cs.html#b58dad3f69e597fb" class="i method">Dispose</a>();
                }
            }
        }
 
        <b>protected override void</b> <a id="0d9dc5f859e2e7cd" href="../../../R/0d9dc5f859e2e7cd.html" target="n" data-glyph="75,1" class="i method">CleanupConnection</a>()
        {
            <a href="#eaa25db180df6d05" class="i field">_clientPipe</a>.<a href="../common/RemoteSessionNamedPipe.cs.html#fa7a2e910f508d2e" class="i method">Close</a>();
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Protected Methods
 
        <b>protected void</b> <a id="cdeb211dcc246b34" href="../../../R/cdeb211dcc246b34.html" target="n" data-glyph="75,1" class="i method">StartReaderThread</a>(
            <span class="i">StreamReader</span> <span id="r193 rd" class="r193 r">reader</span>)
        {
            <span class="i">Thread</span> <span id="r194 rd" class="r194 r">readerThread</span> = <b>new</b> <span class="i">Thread</span>(<span class="i">ProcessReaderThread</span>);
            <span class="r194 r">readerThread</span>.<span class="i">Name</span> = <a href="#a39aa2ddfd61cdd8" class="i field">_threadName</a>;
            <span class="r194 r">readerThread</span>.<span class="i">IsBackground</span> = <b>true</b>;
            <span class="r194 r">readerThread</span>.<span class="i">Start</span>(<span class="r193 r">reader</span>);
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Private Methods
 
        <b>private void</b> <a id="40d5bf8521f0cf76" href="../../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">ProcessReaderThread</a>(<b>object</b> <span id="r195 rd" class="r195 r">state</span>)
        {
            <b>try</b>
            {
                <span class="i">StreamReader</span> <span id="r196 rd" class="r196 r">reader</span> = <span class="r195 r">state</span> <b>as</b> <span class="i">StreamReader</span>;
                <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r196 r">reader</span> != <b>null</b>, <span class="s">&quot;Reader cannot be null.&quot;</span>);
 
                <span class="c">// Send one fragment.</span>
                <a href="#b5ab391e61d975ce" class="i method">SendOneItem</a>();
 
                <span class="c">// Start reader loop.</span>
                <b>while</b> (<b>true</b>)
                {
                    <b>string</b> <span id="r197 rd" class="r197 r">data</span> = <span class="r196 r">reader</span>.<span class="i">ReadLine</span>();
                    <b>if</b> (<span class="r197 r">data</span> == <b>null</b>)
                    {
                        <span class="c">// End of stream indicates the target process was lost.</span>
                        <span class="c">// Raise transport exception to invalidate the client remote runspace.</span>
                        <a href="../common/remotingexceptions.cs.html#0bb8687f97d91059" class="t t">PSRemotingTransportException</a> <span id="r198 rd" class="r198 r">psrte</span> = <b>new</b> <span class="t">PSRemotingTransportException</span>(
                            <a href="../common/remotingexceptions.cs.html#a969589d7508bf05" class="t t">PSRemotingErrorId</a>.<a href="../common/remotingexceptions.cs.html#c5268fb78fd26d44" class="i field">IPCServerProcessReportedError</a>,
                            <span class="i">RemotingErrorIdStrings</span>.<span class="i">IPCServerProcessReportedError</span>,
                            <span class="i">RemotingErrorIdStrings</span>.<span class="i">NamedPipeTransportProcessEnded</span>);
                        <a href="BaseTransportManager.cs.html#8e00d8a2f8745652" class="i method">RaiseErrorHandler</a>(<b>new</b> <a href="BaseTransportManager.cs.html#c420864940871a42" class="t constructor">TransportErrorOccuredEventArgs</a>(<span class="r198 r">psrte</span>, <a href="BaseTransportManager.cs.html#33678df914ca9daf" class="t t">TransportMethodEnum</a>.<a href="BaseTransportManager.cs.html#c91edb639e1ae62a" class="i field">ReceiveShellOutputEx</a>));
                        <b>break</b>;
                    }
 
                    <b>if</b> (<span class="r197 r">data</span>.<span class="i">StartsWith</span>(<span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Remoting</span>.<span class="i n">Server</span>.<a href="../server/OutOfProcServerMediator.cs.html#d6d492dbec355ed7" class="t t">NamedPipeErrorTextWriter</a>.<a href="../server/OutOfProcServerMediator.cs.html#21c7ad4feb2e15a5" class="i property">ErrorPrepend</a>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
                    {
                        <span class="c">// Error message from the server.</span>
                        <b>string</b> <span id="r199 rd" class="r199 r">errorData</span> = <span class="r197 r">data</span>.<span class="i">Substring</span>(<span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Remoting</span>.<span class="i n">Server</span>.<a href="../server/OutOfProcServerMediator.cs.html#d6d492dbec355ed7" class="t t">NamedPipeErrorTextWriter</a>.<a href="../server/OutOfProcServerMediator.cs.html#21c7ad4feb2e15a5" class="i property">ErrorPrepend</a>.<span class="i">Length</span>);
                        <a href="#da60ecb1a90ace20" class="i method">HandleErrorDataReceived</a>(<span class="r199 r">errorData</span>);
                    }
                    <b>else</b>
                    {
                        <span class="c">// Normal output data.</span>
                        <a href="#01b8d088286a3591" class="i method">HandleOutputDataReceived</a>(<span class="r197 r">data</span>);
                    }
                }
            }
            <b>catch</b> (<span class="i">ObjectDisposedException</span>)
            {
                <span class="c">// Normal reader thread end.</span>
            }
            <b>catch</b> (<span class="i">Exception</span> <span id="r200 rd" class="r200 r">e</span>)
            {
                <b>if</b> (<span class="r200 r">e</span> <b>is</b> <span class="i">ArgumentOutOfRangeException</span>)
                {
                    <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<b>false</b>, <span class="s">&quot;Need to adjust transport fragmentor to accommodate read buffer size.&quot;</span>);
                }
 
                <b>string</b> <span id="r201 rd" class="r201 r">errorMsg</span> = <span class="r200 r">e</span>.<span class="i">Message</span> ?? <b>string</b>.<span class="i">Empty</span>;
                <a href="#8de2a991a3b17128" class="i field">_tracer</a>.<span class="i">WriteMessage</span>(<span class="s">&quot;NamedPipeClientSessionTransportManager&quot;</span>, <span class="s">&quot;StartReaderThread&quot;</span>, <span class="i">Guid</span>.<span class="i">Empty</span>,
                    <span class="s">&quot;Transport manager reader thread ended with error: {0}&quot;</span>, <span class="r201 r">errorMsg</span>);
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
    }
 
    <b>internal sealed class</b> <a id="96f96eb323f5892b" href="../../../R/96f96eb323f5892b.html" target="n" data-glyph="2,0" class="t t">NamedPipeClientSessionTransportManager</a> : <a href="#1ef951c5d22186f5" class="t t">NamedPipeClientSessionTransportManagerBase</a>
    {
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Private Data
 
        <b>private readonly</b> <a href="../common/RunspaceConnectionInfo.cs.html#b59a21e6663c2451" class="t t">NamedPipeConnectionInfo</a> <a id="f37fcf4b7238a9a8" href="../../../R/f37fcf4b7238a9a8.html" target="n" data-glyph="46,1" class="i field">_connectionInfo</a>;
 
        <b>private const string</b> <a id="e379f59942e23538" href="../../../R/e379f59942e23538.html" target="n" data-glyph="10,1" class="i field">_threadName</a> = <span class="s">&quot;NamedPipeTransport Reader Thread&quot;</span>;
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Constructors
 
        <b>internal</b> <a id="12abdfc07a48dbc4" href="../../../R/12abdfc07a48dbc4.html" target="n" data-glyph="74,1" class="t constructor">NamedPipeClientSessionTransportManager</a>(
            <a href="../common/RunspaceConnectionInfo.cs.html#b59a21e6663c2451" class="t t">NamedPipeConnectionInfo</a> <span id="r202 rd" class="r202 r">connectionInfo</span>,
            <span class="i">Guid</span> <span id="r203 rd" class="r203 r">runspaceId</span>,
            <a href="../../../utils/CryptoUtils.cs.html#1999dfb2439af5a0" class="t t">PSRemotingCryptoHelper</a> <span id="r204 rd" class="r204 r">cryptoHelper</span>)
            : <a href="#58cb4d8bda916fc1" class="k">base</a>(<span class="r202 r">connectionInfo</span>, <span class="r203 r">runspaceId</span>, <span class="r204 r">cryptoHelper</span>, <a href="#e379f59942e23538" class="i field">_threadName</a>)
        {
            <b>if</b> (<span class="r202 r">connectionInfo</span> == <b>null</b>)
            {
                <b>throw</b> <b>new</b> <a href="../../../utils/MshArgumentNullException.cs.html#166e605c6cb05157" class="t constructor">PSArgumentNullException</a>(<b>nameof</b>(<span class="r202 r">connectionInfo</span>));
            }
 
            <a href="#f37fcf4b7238a9a8" class="i field">_connectionInfo</a> = <span class="r202 r">connectionInfo</span>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Overrides
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Create a named pipe connection to the target process and set up</span>
        <span class="c">///</span><span class="c"> transport reader/writer.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal override void</b> <a id="4f028276bff8620c" href="../../../R/4f028276bff8620c.html" target="n" data-glyph="74,1" class="i method">CreateAsync</a>()
        {
            <a href="#eaa25db180df6d05" class="i field">_clientPipe</a> = <b>string</b>.<span class="i">IsNullOrEmpty</span>(<a href="#f37fcf4b7238a9a8" class="i field">_connectionInfo</a>.<a href="../common/RunspaceConnectionInfo.cs.html#ae19a20d35691fa8" class="i property">CustomPipeName</a>) ?
                <b>new</b> <a href="../common/RemoteSessionNamedPipe.cs.html#db122997adc333b7" class="t constructor">RemoteSessionNamedPipeClient</a>(<a href="#f37fcf4b7238a9a8" class="i field">_connectionInfo</a>.<a href="../common/RunspaceConnectionInfo.cs.html#92a696b39d4c2017" class="i property">ProcessId</a>, <a href="#f37fcf4b7238a9a8" class="i field">_connectionInfo</a>.<a href="../common/RunspaceConnectionInfo.cs.html#4074545a85fe2e8f" class="i property">AppDomainName</a>) :
                <b>new</b> <a href="../common/RemoteSessionNamedPipe.cs.html#7513b8983a34395e" class="t constructor">RemoteSessionNamedPipeClient</a>(<a href="#f37fcf4b7238a9a8" class="i field">_connectionInfo</a>.<a href="../common/RunspaceConnectionInfo.cs.html#ae19a20d35691fa8" class="i property">CustomPipeName</a>);
 
            <span class="c">// Wait for named pipe to connect.</span>
            <a href="#eaa25db180df6d05" class="i field">_clientPipe</a>.<a href="../common/RemoteSessionNamedPipe.cs.html#6cc2557d125b0059" class="i method">Connect</a>(<a href="#f37fcf4b7238a9a8" class="i field">_connectionInfo</a>.<a href="../common/RunspaceConnectionInfo.cs.html#a0a3c947f4d2fe9e" class="i property">OpenTimeout</a>);
 
            <span class="c">// Create writer for named pipe.</span>
            <a href="#908a2aa48b413a01" class="i field">stdInWriter</a> = <b>new</b> <span class="t">OutOfProcessTextWriter</span>(<a href="#eaa25db180df6d05" class="i field">_clientPipe</a>.<a href="../common/RemoteSessionNamedPipe.cs.html#857889df835323ab" class="i property">TextWriter</a>);
 
            <span class="c">// Create reader thread for named pipe.</span>
            <a href="#cdeb211dcc246b34" class="i method">StartReaderThread</a>(<a href="#eaa25db180df6d05" class="i field">_clientPipe</a>.<a href="../common/RemoteSessionNamedPipe.cs.html#29003eab6bc634b0" class="i property">TextReader</a>);
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Public Methods
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Aborts an existing connection attempt.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public void</b> <a id="30bba8565888ba13" href="../../../R/30bba8565888ba13.html" target="n" data-glyph="72,1" class="i method">AbortConnect</a>()
        {
            <b>if</b> (<a href="#eaa25db180df6d05" class="i field">_clientPipe</a> != <b>null</b>)
            {
                <a href="#eaa25db180df6d05" class="i field">_clientPipe</a>.<a href="../common/RemoteSessionNamedPipe.cs.html#5d02ad8a9f75f4c8" class="i method">AbortConnect</a>();
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
    }
 
    <b>internal sealed class</b> <a id="539f41287d1f1571" href="../../../R/539f41287d1f1571.html" target="n" data-glyph="2,0" class="t t">ContainerNamedPipeClientSessionTransportManager</a> : <a href="#1ef951c5d22186f5" class="t t">NamedPipeClientSessionTransportManagerBase</a>
    {
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Private Data
 
        <b>private readonly</b> <a href="../common/RunspaceConnectionInfo.cs.html#d2be2d5c63c76391" class="t t">ContainerConnectionInfo</a> <a id="96dbe6cd5b4f741d" href="../../../R/96dbe6cd5b4f741d.html" target="n" data-glyph="46,1" class="i field">_connectionInfo</a>;
 
        <b>private const string</b> <a id="ec5c43e0260eb0bd" href="../../../R/ec5c43e0260eb0bd.html" target="n" data-glyph="10,1" class="i field">_threadName</a> = <span class="s">&quot;ContainerNamedPipeTransport Reader Thread&quot;</span>;
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Constructors
 
        <b>internal</b> <a id="49d1e5b1bf7aa3ff" href="../../../R/49d1e5b1bf7aa3ff.html" target="n" data-glyph="74,1" class="t constructor">ContainerNamedPipeClientSessionTransportManager</a>(
            <a href="../common/RunspaceConnectionInfo.cs.html#d2be2d5c63c76391" class="t t">ContainerConnectionInfo</a> <span id="r205 rd" class="r205 r">connectionInfo</span>,
            <span class="i">Guid</span> <span id="r206 rd" class="r206 r">runspaceId</span>,
            <a href="../../../utils/CryptoUtils.cs.html#1999dfb2439af5a0" class="t t">PSRemotingCryptoHelper</a> <span id="r207 rd" class="r207 r">cryptoHelper</span>)
            : <a href="#58cb4d8bda916fc1" class="k">base</a>(<span class="r205 r">connectionInfo</span>, <span class="r206 r">runspaceId</span>, <span class="r207 r">cryptoHelper</span>, <a href="#ec5c43e0260eb0bd" class="i field">_threadName</a>)
        {
            <b>if</b> (<span class="r205 r">connectionInfo</span> == <b>null</b>)
            {
                <b>throw</b> <b>new</b> <a href="../../../utils/MshArgumentNullException.cs.html#166e605c6cb05157" class="t constructor">PSArgumentNullException</a>(<b>nameof</b>(<span class="r205 r">connectionInfo</span>));
            }
 
            <a href="#96dbe6cd5b4f741d" class="i field">_connectionInfo</a> = <span class="r205 r">connectionInfo</span>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Overrides
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Create a named pipe connection to the target process in target container and set up</span>
        <span class="c">///</span><span class="c"> transport reader/writer.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal override void</b> <a id="c9e137db1bf27dc5" href="../../../R/c9e137db1bf27dc5.html" target="n" data-glyph="74,1" class="i method">CreateAsync</a>()
        {
            <a href="#eaa25db180df6d05" class="i field">_clientPipe</a> = <b>new</b> <span class="t">ContainerSessionNamedPipeClient</span>(
                <a href="#96dbe6cd5b4f741d" class="i field">_connectionInfo</a>.<a href="../common/RunspaceConnectionInfo.cs.html#ee338ee5bc920bf9" class="i property">ContainerProc</a>.<a href="../common/RunspaceConnectionInfo.cs.html#ae164163259dda55" class="i property">ProcessId</a>,
                <b>string</b>.<span class="i">Empty</span>, <span class="c">// AppDomainName</span>
                <a href="#96dbe6cd5b4f741d" class="i field">_connectionInfo</a>.<a href="../common/RunspaceConnectionInfo.cs.html#ee338ee5bc920bf9" class="i property">ContainerProc</a>.<a href="../common/RunspaceConnectionInfo.cs.html#ac6478d5ef277987" class="i property">ContainerObRoot</a>);
 
            <span class="c">// Wait for named pipe to connect.</span>
            <a href="#eaa25db180df6d05" class="i field">_clientPipe</a>.<a href="../common/RemoteSessionNamedPipe.cs.html#6cc2557d125b0059" class="i method">Connect</a>(<a href="#96dbe6cd5b4f741d" class="i field">_connectionInfo</a>.<a href="../common/RunspaceConnectionInfo.cs.html#a0a3c947f4d2fe9e" class="i property">OpenTimeout</a>);
 
            <span class="c">// Create writer for named pipe.</span>
            <a href="#908a2aa48b413a01" class="i field">stdInWriter</a> = <b>new</b> <span class="t">OutOfProcessTextWriter</span>(<a href="#eaa25db180df6d05" class="i field">_clientPipe</a>.<a href="../common/RemoteSessionNamedPipe.cs.html#857889df835323ab" class="i property">TextWriter</a>);
 
            <span class="c">// Create reader thread for named pipe.</span>
            <a href="#cdeb211dcc246b34" class="i method">StartReaderThread</a>(<a href="#eaa25db180df6d05" class="i field">_clientPipe</a>.<a href="../common/RemoteSessionNamedPipe.cs.html#29003eab6bc634b0" class="i property">TextReader</a>);
        }
 
        <b>protected override void</b> <a id="c4fb46f702b9b921" href="../../../R/c4fb46f702b9b921.html" target="n" data-glyph="75,1" class="i method">CleanupConnection</a>()
        {
            <a href="#eaa25db180df6d05" class="i field">_clientPipe</a>.<a href="../common/RemoteSessionNamedPipe.cs.html#fa7a2e910f508d2e" class="i method">Close</a>();
 
            <span class="c">//</span>
            <span class="c">// We should terminate the PowerShell process inside container that</span>
            <span class="c">// is created for PowerShell Direct.</span>
            <span class="c">//</span>
            <b>if</b> (!<a href="#96dbe6cd5b4f741d" class="i field">_connectionInfo</a>.<a href="../common/RunspaceConnectionInfo.cs.html#9697a01efdf68c66" class="i method">TerminateContainerProcess</a>())
            {
                <a href="#8de2a991a3b17128" class="i field">_tracer</a>.<span class="i">WriteMessage</span>(<span class="s">&quot;ContainerNamedPipeClientSessionTransportManager&quot;</span>, <span class="s">&quot;CleanupConnection&quot;</span>, <span class="i">Guid</span>.<span class="i">Empty</span>,
                    <span class="s">&quot;Failed to terminate PowerShell process inside container&quot;</span>);
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
    }
 
    <b>internal class</b> <a id="920a85d8937fe495" href="../../../R/920a85d8937fe495.html" target="n" data-glyph="2,0" class="t t">OutOfProcessClientCommandTransportManager</a> : <a href="BaseTransportManager.cs.html#fa455a694094fdc2" class="t t">BaseClientCommandTransportManager</a>
    {
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Private Data
 
        <b>private readonly</b> <a href="#3676916334ddb503" class="t t">OutOfProcessTextWriter</a> <a id="fbc68a6a0a2f53af" href="../../../R/fbc68a6a0a2f53af.html" target="n" data-glyph="46,1" class="i field">_stdInWriter</a>;
        <b>private readonly</b> <a href="PriorityCollection.cs.html#0fa204cb5092e738" class="t t">PrioritySendDataCollection</a>.<a href="PriorityCollection.cs.html#81c7391587f527f6" class="t t">OnDataAvailableCallback</a> <a id="4660c0ecd0b7241f" href="../../../R/4660c0ecd0b7241f.html" target="n" data-glyph="46,1" class="i field">_onDataAvailableToSendCallback</a>;
        <b>private readonly</b> <span class="i">Timer</span> <a id="892dfafcfa9c0239" href="../../../R/892dfafcfa9c0239.html" target="n" data-glyph="46,1" class="i field">_signalTimeOutTimer</a>;
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Constructors
 
        <b>internal</b> <a id="0feabc9f3cc636ae" href="../../../R/0feabc9f3cc636ae.html" target="n" data-glyph="74,1" class="t constructor">OutOfProcessClientCommandTransportManager</a>(
            <a href="../client/ClientRemotePowerShell.cs.html#b4d2ac017883b31c" class="t t">ClientRemotePowerShell</a> <span id="r208 rd" class="r208 r">cmd</span>,
            <b>bool</b> <span id="r209 rd" class="r209 r">noInput</span>,
            <a href="#d45b9c7a452bcb48" class="t t">OutOfProcessClientSessionTransportManagerBase</a> <span id="r210 rd" class="r210 r">sessnTM</span>,
            <a href="#3676916334ddb503" class="t t">OutOfProcessTextWriter</a> <span id="r211 rd" class="r211 r">stdInWriter</span>) : <a href="BaseTransportManager.cs.html#bd9431dfddb4513a" class="k">base</a>(<span class="r208 r">cmd</span>, <span class="r210 r">sessnTM</span>.<a href="BaseTransportManager.cs.html#30975a92e0bc8f5d" class="i property">CryptoHelper</a>, <span class="r210 r">sessnTM</span>)
        {
            <a href="#fbc68a6a0a2f53af" class="i field">_stdInWriter</a> = <span class="r211 r">stdInWriter</span>;
            <a href="#4660c0ecd0b7241f" class="i field">_onDataAvailableToSendCallback</a> =
                <b>new</b> <a href="PriorityCollection.cs.html#0fa204cb5092e738" class="t t">PrioritySendDataCollection</a>.<span class="t">OnDataAvailableCallback</span>(<a href="#0221991fbe20a228" class="i method">OnDataAvailableCallback</a>);
            <a href="#892dfafcfa9c0239" class="i field">_signalTimeOutTimer</a> = <b>new</b> <span class="i">Timer</span>(<span class="i">OnSignalTimeOutTimerElapsed</span>, <b>null</b>, <span class="i">Timeout</span>.<span class="i">Infinite</span>, <span class="i">Timeout</span>.<span class="i">Infinite</span>);
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Overrides
 
        <b>internal override void</b> <a id="2770c04e34004554" href="../../../R/2770c04e34004554.html" target="n" data-glyph="74,1" class="i method">ConnectAsync</a>()
        {
            <b>throw</b> <b>new</b> <span class="i">NotImplementedException</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">IPCTransportConnectError</span>);
        }
 
        <b>internal override void</b> <a id="39c6cad54c638230" href="../../../R/39c6cad54c638230.html" target="n" data-glyph="74,1" class="i method">CreateAsync</a>()
        {
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(<a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#329e9e85c0cfb782" class="i field">WSManCreateCommand</a>, <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#a0f7cf0d4987790f" class="i field">Connect</a>,
                                <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#752e56066810e4f0" class="i field">CreateRunspace</a>,
                                <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#c5d4a73b62c859ab" class="i field">Transport</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                                <a href="BaseTransportManager.cs.html#6b69cd5f8cc06fb7" class="i property">RunspacePoolInstanceId</a>.<span class="i">ToString</span>(), <a href="BaseTransportManager.cs.html#5485ee84e1e3c04d" class="i field">powershellInstanceId</a>.<span class="i">ToString</span>());
 
            <a href="#fbc68a6a0a2f53af" class="i field">_stdInWriter</a>.<a href="#1fb9fbc09f4031a8" class="i method">WriteLine</a>(<a href="#bb038d3403da3163" class="t t">OutOfProcessUtils</a>.<a href="#3b2032e4391060d7" class="i method">CreateCommandPacket</a>(<a href="BaseTransportManager.cs.html#5485ee84e1e3c04d" class="i field">powershellInstanceId</a>));
        }
 
        <b>internal override void</b> <a id="c442cc4100b93ae8" href="../../../R/c442cc4100b93ae8.html" target="n" data-glyph="74,1" class="i method">CloseAsync</a>()
        {
            <b>lock</b> (<a href="BaseTransportManager.cs.html#2b6037d6b3777ca1" class="i field">syncObject</a>)
            {
                <b>if</b> (<a href="BaseTransportManager.cs.html#76271338de46dcf0" class="i field">isClosed</a>)
                {
                    <b>return</b>;
                }
 
                <span class="c">// first change the state..so other threads</span>
                <span class="c">// will know that we are closing.</span>
                <a href="BaseTransportManager.cs.html#76271338de46dcf0" class="i field">isClosed</a> = <b>true</b>;
            }
 
            <a href="BaseTransportManager.cs.html#fa455a694094fdc2" class="k">base</a>.<a href="BaseTransportManager.cs.html#8487786a35819f66" class="i method">CloseAsync</a>();
 
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(<a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#3526c72eedb5e7e7" class="i field">WSManCloseCommand</a>,
                <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#f3d85cb80e62fe3e" class="i field">Disconnect</a>, <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#c5d4a73b62c859ab" class="i field">Transport</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                <a href="BaseTransportManager.cs.html#6b69cd5f8cc06fb7" class="i property">RunspacePoolInstanceId</a>.<span class="i">ToString</span>(), <a href="BaseTransportManager.cs.html#5485ee84e1e3c04d" class="i field">powershellInstanceId</a>.<span class="i">ToString</span>());
 
            <span class="c">// Send Close information to the server</span>
            <b>if</b> (<a href="#fbc68a6a0a2f53af" class="i field">_stdInWriter</a> != <b>null</b>)
            {
                <b>try</b>
                {
                    <a href="#fbc68a6a0a2f53af" class="i field">_stdInWriter</a>.<a href="#1fb9fbc09f4031a8" class="i method">WriteLine</a>(<a href="#bb038d3403da3163" class="t t">OutOfProcessUtils</a>.<a href="#99fd43ea1942a467" class="i method">CreateClosePacket</a>(<a href="BaseTransportManager.cs.html#5485ee84e1e3c04d" class="i field">powershellInstanceId</a>));
                }
                <b>catch</b> (<span class="i">IOException</span> <span id="r212 rd" class="r212 r">e</span>)
                {
                    <a href="BaseTransportManager.cs.html#8e00d8a2f8745652" class="i method">RaiseErrorHandler</a>(
                        <b>new</b> <a href="BaseTransportManager.cs.html#c420864940871a42" class="t constructor">TransportErrorOccuredEventArgs</a>(
                            <b>new</b> <span class="t">PSRemotingTransportException</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">NamedPipeTransportProcessEnded</span>, <span class="r212 r">e</span>), <a href="BaseTransportManager.cs.html#33678df914ca9daf" class="t t">TransportMethodEnum</a>.<a href="BaseTransportManager.cs.html#2cc9ee1cdce7fca6" class="i field">CloseShellOperationEx</a>));
                }
            }
        }
 
        <b>internal override void</b> <a id="64d9e2e9a34d7c4b" href="../../../R/64d9e2e9a34d7c4b.html" target="n" data-glyph="74,1" class="i method">SendStopSignal</a>()
        {
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(<a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#fc7bf47ac7e81c7f" class="i field">WSManSignal</a>,
                <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#f3d85cb80e62fe3e" class="i field">Disconnect</a>, <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#c5d4a73b62c859ab" class="i field">Transport</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                <a href="BaseTransportManager.cs.html#6b69cd5f8cc06fb7" class="i property">RunspacePoolInstanceId</a>.<span class="i">ToString</span>(), <a href="BaseTransportManager.cs.html#5485ee84e1e3c04d" class="i field">powershellInstanceId</a>.<span class="i">ToString</span>(), <span class="s">&quot;stopsignal&quot;</span>);
            <span class="c">// make sure we dont send anymore data from now onwards.</span>
            <a href="BaseTransportManager.cs.html#fa455a694094fdc2" class="k">base</a>.<a href="BaseTransportManager.cs.html#8487786a35819f66" class="i method">CloseAsync</a>();
 
            <span class="c">// Stop is equivalent to closing on the server..</span>
            <a href="#fbc68a6a0a2f53af" class="i field">_stdInWriter</a>.<a href="#1fb9fbc09f4031a8" class="i method">WriteLine</a>(<a href="#bb038d3403da3163" class="t t">OutOfProcessUtils</a>.<a href="#50293432a1529be3" class="i method">CreateSignalPacket</a>(<a href="BaseTransportManager.cs.html#5485ee84e1e3c04d" class="i field">powershellInstanceId</a>));
 
            <span class="c">// start the timer..so client can fail deterministically</span>
            <span class="c">// set the interval to 60 seconds.</span>
            <a href="#892dfafcfa9c0239" class="i field">_signalTimeOutTimer</a>.<span class="i">Change</span>(60 * 1000, <span class="i">Timeout</span>.<span class="i">Infinite</span>);
        }
 
        <b>internal override void</b> <a id="b13c620e616d46bf" href="../../../R/b13c620e616d46bf.html" target="n" data-glyph="74,1" class="i method">Dispose</a>(<b>bool</b> <span id="r213 rd" class="r213 r">isDisposing</span>)
        {
            <a href="BaseTransportManager.cs.html#fa455a694094fdc2" class="k">base</a>.<a href="BaseTransportManager.cs.html#9e284fd5b441a63a" class="i method">Dispose</a>(<span class="r213 r">isDisposing</span>);
            <b>if</b> (<span class="r213 r">isDisposing</span>)
            {
                <a href="#0f742b54201caf38" class="i method">StopSignalTimerAndDecrementOperations</a>();
                <a href="#892dfafcfa9c0239" class="i field">_signalTimeOutTimer</a>.<span class="i">Dispose</span>();
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Helper Methods
 
        <b>internal void</b> <a id="d95315cb077ab762" href="../../../R/d95315cb077ab762.html" target="n" data-glyph="74,1" class="i method">OnCreateCmdCompleted</a>()
        {
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(<a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#598416e68b47d104" class="i field">WSManCreateCommandCallbackReceived</a>,
                <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#a0f7cf0d4987790f" class="i field">Connect</a>, <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#c5d4a73b62c859ab" class="i field">Transport</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                <a href="BaseTransportManager.cs.html#6b69cd5f8cc06fb7" class="i property">RunspacePoolInstanceId</a>.<span class="i">ToString</span>(), <a href="BaseTransportManager.cs.html#5485ee84e1e3c04d" class="i field">powershellInstanceId</a>.<span class="i">ToString</span>());
 
            <b>lock</b> (<a href="BaseTransportManager.cs.html#2b6037d6b3777ca1" class="i field">syncObject</a>)
            {
                <span class="c">// make sure the transport is not closed yet.</span>
                <b>if</b> (<a href="BaseTransportManager.cs.html#76271338de46dcf0" class="i field">isClosed</a>)
                {
                    <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<a href="../../../utils/StructuredTraceSource.cs.html#96aaf3813a5962a0" class="i method">WriteLine</a>(<span class="s">&quot;Client Session TM: Transport manager is closed. So returning&quot;</span>);
                    <b>return</b>;
                }
 
                <span class="c">// Start sending data if any..and see if we can initiate a receive.</span>
                <a href="#09e72dde90dba2f3" class="i method">SendOneItem</a>();
            }
        }
 
        <b>internal void</b> <a id="21b8eaf5ca512d24" href="../../../R/21b8eaf5ca512d24.html" target="n" data-glyph="74,1" class="i method">OnRemoteCmdSendCompleted</a>()
        {
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(<a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#24e0ce157c99ef06" class="i field">WSManSendShellInputExCallbackReceived</a>,
                <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#a0f7cf0d4987790f" class="i field">Connect</a>, <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#c5d4a73b62c859ab" class="i field">Transport</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                <a href="BaseTransportManager.cs.html#6b69cd5f8cc06fb7" class="i property">RunspacePoolInstanceId</a>.<span class="i">ToString</span>(), <a href="BaseTransportManager.cs.html#5485ee84e1e3c04d" class="i field">powershellInstanceId</a>.<span class="i">ToString</span>());
 
            <b>lock</b> (<a href="BaseTransportManager.cs.html#2b6037d6b3777ca1" class="i field">syncObject</a>)
            {
                <span class="c">// if the transport manager is already closed..return immediately</span>
                <b>if</b> (<a href="BaseTransportManager.cs.html#76271338de46dcf0" class="i field">isClosed</a>)
                {
                    <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<a href="../../../utils/StructuredTraceSource.cs.html#96aaf3813a5962a0" class="i method">WriteLine</a>(<span class="s">&quot;Client Command TM: Transport manager is closed. So returning&quot;</span>);
                    <b>return</b>;
                }
            }
 
            <a href="#09e72dde90dba2f3" class="i method">SendOneItem</a>();
        }
 
        <b>internal void</b> <a id="2219ac63e4854a95" href="../../../R/2219ac63e4854a95.html" target="n" data-glyph="74,1" class="i method">OnRemoteCmdDataReceived</a>(<b>byte</b>[] <span id="r214 rd" class="r214 r">rawData</span>, <b>string</b> <span id="r215 rd" class="r215 r">stream</span>)
        {
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(
                    <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#1950f93b9ed312a7" class="i field">WSManReceiveShellOutputExCallbackReceived</a>, <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#75e7cd53604b1352" class="i field">Receive</a>, <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                    <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#c5d4a73b62c859ab" class="i field">Transport</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                    <a href="BaseTransportManager.cs.html#6b69cd5f8cc06fb7" class="i property">RunspacePoolInstanceId</a>.<span class="i">ToString</span>(),
                    <a href="BaseTransportManager.cs.html#5485ee84e1e3c04d" class="i field">powershellInstanceId</a>.<span class="i">ToString</span>(),
                    <span class="r214 r">rawData</span>.<span class="i">Length</span>.<span class="i">ToString</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>));
 
            <span class="c">// if the transport manager is already closed..return immediately</span>
            <b>if</b> (<a href="BaseTransportManager.cs.html#76271338de46dcf0" class="i field">isClosed</a>)
            {
                <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<a href="../../../utils/StructuredTraceSource.cs.html#96aaf3813a5962a0" class="i method">WriteLine</a>(<span class="s">&quot;Client Command TM: Transport manager is closed. So returning&quot;</span>);
                <b>return</b>;
            }
 
            <a href="BaseTransportManager.cs.html#9b54d0029bdba5c6" class="i method">ProcessRawData</a>(<span class="r214 r">rawData</span>, <span class="r215 r">stream</span>);
        }
 
        <b>internal void</b> <a id="f7947cf1b390b840" href="../../../R/f7947cf1b390b840.html" target="n" data-glyph="74,1" class="i method">OnRemoteCmdSignalCompleted</a>()
        {
            <span class="c">// log the callback received event.</span>
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(<a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#f3deaa651d18fa4a" class="i field">WSManSignalCallbackReceived</a>,
                <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#f3d85cb80e62fe3e" class="i field">Disconnect</a>, <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#c5d4a73b62c859ab" class="i field">Transport</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                <a href="BaseTransportManager.cs.html#6b69cd5f8cc06fb7" class="i property">RunspacePoolInstanceId</a>.<span class="i">ToString</span>(), <a href="BaseTransportManager.cs.html#5485ee84e1e3c04d" class="i field">powershellInstanceId</a>.<span class="i">ToString</span>());
 
            <a href="#0f742b54201caf38" class="i method">StopSignalTimerAndDecrementOperations</a>();
 
            <b>if</b> (<a href="BaseTransportManager.cs.html#76271338de46dcf0" class="i field">isClosed</a>)
            {
                <b>return</b>;
            }
 
            <span class="c">// Call Signal completed from callback thread.</span>
            <a href="BaseTransportManager.cs.html#a152fe644f7ae9c1" class="i method">EnqueueAndStartProcessingThread</a>(<b>null</b>, <b>null</b>, <b>true</b>);
        }
 
        <b>internal void</b> <a id="eaca80b0f85e896a" href="../../../R/../../0000000000.html" target="n" data-glyph="74,1" class="i method">OnSignalTimeOutTimerElapsed</a>(<b>object</b> <span id="r216 rd" class="r216 r">source</span>)
        {
            <span class="c">// Signal timer is triggered only once</span>
 
            <b>if</b> (<a href="BaseTransportManager.cs.html#76271338de46dcf0" class="i field">isClosed</a>)
            {
                <b>return</b>;
            }
 
            <a href="../common/remotingexceptions.cs.html#0bb8687f97d91059" class="t t">PSRemotingTransportException</a> <span id="r217 rd" class="r217 r">psrte</span> = <b>new</b> <span class="t">PSRemotingTransportException</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">IPCSignalTimedOut</span>);
            <a href="BaseTransportManager.cs.html#8e00d8a2f8745652" class="i method">RaiseErrorHandler</a>(<b>new</b> <a href="BaseTransportManager.cs.html#c420864940871a42" class="t constructor">TransportErrorOccuredEventArgs</a>(<span class="r217 r">psrte</span>, <a href="BaseTransportManager.cs.html#33678df914ca9daf" class="t t">TransportMethodEnum</a>.<a href="BaseTransportManager.cs.html#c91edb639e1ae62a" class="i field">ReceiveShellOutputEx</a>));
        }
 
        <b>private void</b> <a id="0f742b54201caf38" href="../../../R/0f742b54201caf38.html" target="n" data-glyph="76,1" class="i method">StopSignalTimerAndDecrementOperations</a>()
        {
            <b>lock</b> (<a href="BaseTransportManager.cs.html#2b6037d6b3777ca1" class="i field">syncObject</a>)
            {
                <a href="#892dfafcfa9c0239" class="i field">_signalTimeOutTimer</a>.<span class="i">Change</span>(<span class="i">Timeout</span>.<span class="i">Infinite</span>, <span class="i">Timeout</span>.<span class="i">Infinite</span>);
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Used by ServicePendingCallbacks to give the control to derived classes for</span>
        <span class="c">///</span><span class="c"> processing data that the base class does not understand.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r218 r">privateData</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Derived class specific data to process. For command transport manager this</span>
        <span class="c">///</span><span class="c"> should be a boolean.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal override void</b> <a id="c152286235c894a4" href="../../../R/c152286235c894a4.html" target="n" data-glyph="74,1" class="i method">ProcessPrivateData</a>(<b>object</b> <span id="r218 rd" class="r218 r">privateData</span>)
        {
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r218 r">privateData</span> != <b>null</b>, <span class="s">&quot;privateData cannot be null.&quot;</span>);
 
            <span class="c">// For this version...only a boolean can be used for privateData.</span>
            <b>bool</b> <span id="r219 rd" class="r219 r">shouldRaiseSignalCompleted</span> = (<b>bool</b>)<span class="r218 r">privateData</span>;
            <b>if</b> (<span class="r219 r">shouldRaiseSignalCompleted</span>)
            {
                <a href="BaseTransportManager.cs.html#fa455a694094fdc2" class="k">base</a>.<a href="BaseTransportManager.cs.html#4760a0a217eace5a" class="i method">RaiseSignalCompleted</a>();
            }
        }
 
        <b>internal void</b> <a id="3178e2491588430a" href="../../../R/3178e2491588430a.html" target="n" data-glyph="74,1" class="i method">OnCloseCmdCompleted</a>()
        {
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(<a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#f3ed9d3bada91125" class="i field">WSManCloseCommandCallbackReceived</a>,
                <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#f3d85cb80e62fe3e" class="i field">Disconnect</a>, <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#c5d4a73b62c859ab" class="i field">Transport</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                <a href="BaseTransportManager.cs.html#6b69cd5f8cc06fb7" class="i property">RunspacePoolInstanceId</a>.<span class="i">ToString</span>(), <a href="BaseTransportManager.cs.html#5485ee84e1e3c04d" class="i field">powershellInstanceId</a>.<span class="i">ToString</span>());
 
            <span class="c">// Raising close completed only after receiving ACK from the server</span>
            <span class="c">// otherwise may introduce race conditions on the server side</span>
            <a href="BaseTransportManager.cs.html#ce72d08b48a8f70f" class="i method">RaiseCloseCompleted</a>();
        }
 
        <b>private void</b> <a id="09e72dde90dba2f3" href="../../../R/09e72dde90dba2f3.html" target="n" data-glyph="76,1" class="i method">SendOneItem</a>()
        {
            <b>byte</b>[] <span id="r220 rd" class="r220 r">data</span> = <b>null</b>;
            <a href="PriorityCollection.cs.html#f0975201467fdc06" class="t t">DataPriorityType</a> <span id="r221 rd" class="r221 r">priorityType</span> = <a href="PriorityCollection.cs.html#f0975201467fdc06" class="t t">DataPriorityType</a>.<a href="PriorityCollection.cs.html#e5092d1f4fa1babe" class="i field">Default</a>;
            <span class="c">// serializedPipeline is static ie., data is added to this collection at construction time only</span>
            <span class="c">// and data is accessed by only one thread at any given time..so we can depend on this count</span>
            <b>if</b> (<a href="BaseTransportManager.cs.html#f0864e0c2b75fa58" class="i field">serializedPipeline</a>.<a href="../common/fragmentor.cs.html#d22c9d5a8be2214d" class="i property">Length</a> &gt; 0)
            {
                <span class="r220 r">data</span> = <a href="BaseTransportManager.cs.html#f0864e0c2b75fa58" class="i field">serializedPipeline</a>.<a href="../common/fragmentor.cs.html#0020501682242305" class="i method">ReadOrRegisterCallback</a>(<b>null</b>);
            }
            <b>else</b>
            {
                <span class="c">// This will either return data or register callback but doesn&#39;t do both.</span>
                <span class="r220 r">data</span> = <a href="BaseTransportManager.cs.html#ee4a2ac1afa72dce" class="i field">dataToBeSent</a>.<a href="PriorityCollection.cs.html#56fbcab0ffda9766" class="i method">ReadOrRegisterCallback</a>(<a href="#4660c0ecd0b7241f" class="i field">_onDataAvailableToSendCallback</a>, <b>out</b> <span class="r221 r">priorityType</span>);
            }
 
            <b>if</b> (<span class="r220 r">data</span> != <b>null</b>)
            {
                <a href="#9ada9cc54af063f3" class="i method">SendData</a>(<span class="r220 r">data</span>, <span class="r221 r">priorityType</span>);
            }
        }
 
        <b>private void</b> <a id="9ada9cc54af063f3" href="../../../R/9ada9cc54af063f3.html" target="n" data-glyph="76,1" class="i method">SendData</a>(<b>byte</b>[] <span id="r222 rd" class="r222 r">data</span>, <a href="PriorityCollection.cs.html#f0975201467fdc06" class="t t">DataPriorityType</a> <span id="r223 rd" class="r223 r">priorityType</span>)
        {
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(
                    <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#833085c622d127cb" class="i field">WSManSendShellInputEx</a>, <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#10dc07d70da5e17a" class="i field">Send</a>, <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                    <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#c5d4a73b62c859ab" class="i field">Transport</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                    <a href="BaseTransportManager.cs.html#6b69cd5f8cc06fb7" class="i property">RunspacePoolInstanceId</a>.<span class="i">ToString</span>(),
                    <a href="BaseTransportManager.cs.html#5485ee84e1e3c04d" class="i field">powershellInstanceId</a>.<span class="i">ToString</span>(),
                    <span class="r222 r">data</span>.<span class="i">Length</span>.<span class="i">ToString</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>));
 
            <b>lock</b> (<a href="BaseTransportManager.cs.html#2b6037d6b3777ca1" class="i field">syncObject</a>)
            {
                <b>if</b> (<a href="BaseTransportManager.cs.html#76271338de46dcf0" class="i field">isClosed</a>)
                {
                    <b>return</b>;
                }
 
                <a href="#fbc68a6a0a2f53af" class="i field">_stdInWriter</a>.<a href="#1fb9fbc09f4031a8" class="i method">WriteLine</a>(<a href="#bb038d3403da3163" class="t t">OutOfProcessUtils</a>.<a href="#31d02b37bd6ce1aa" class="i method">CreateDataPacket</a>(<span class="r222 r">data</span>,
                    <span class="r223 r">priorityType</span>,
                    <a href="BaseTransportManager.cs.html#5485ee84e1e3c04d" class="i field">powershellInstanceId</a>));
            }
        }
 
        <b>private void</b> <a id="0221991fbe20a228" href="../../../R/0221991fbe20a228.html" target="n" data-glyph="76,1" class="i method">OnDataAvailableCallback</a>(<b>byte</b>[] <span id="r224 rd" class="r224 r">data</span>, <a href="PriorityCollection.cs.html#f0975201467fdc06" class="t t">DataPriorityType</a> <span id="r225 rd" class="r225 r">priorityType</span>)
        {
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r224 r">data</span> != <b>null</b>, <span class="s">&quot;data cannot be null in the data available callback&quot;</span>);
 
            <a href="BaseTransportManager.cs.html#d0bdc8aaec3faf80" class="i field">tracer</a>.<a href="../../../utils/StructuredTraceSource.cs.html#96aaf3813a5962a0" class="i method">WriteLine</a>(<span class="s">&quot;Received data from dataToBeSent store.&quot;</span>);
            <a href="#9ada9cc54af063f3" class="i method">SendData</a>(<span class="r224 r">data</span>, <span class="r225 r">priorityType</span>);
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
    }
}
 
<b>namespace</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Remoting</span>.<span class="i n">Server</span>
{
    <b>internal class</b> <a id="b0b666eeded95055" href="../../../R/b0b666eeded95055.html" target="n" data-glyph="2,0" class="t t">OutOfProcessServerSessionTransportManager</a> : <a href="BaseTransportManager.cs.html#18630eb940dac0a0" class="t t">AbstractServerSessionTransportManager</a>
    {
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Private Data
 
        <b>private readonly</b> <a href="#3676916334ddb503" class="t t">OutOfProcessTextWriter</a> <a id="e33cf48a8ef0d8ac" href="../../../R/e33cf48a8ef0d8ac.html" target="n" data-glyph="46,1" class="i field">_stdOutWriter</a>;
        <b>private readonly</b> <a href="#3676916334ddb503" class="t t">OutOfProcessTextWriter</a> <a id="dfea5e73907e785b" href="../../../R/dfea5e73907e785b.html" target="n" data-glyph="46,1" class="i field">_stdErrWriter</a>;
        <b>private readonly</b> <span class="i">Dictionary</span>&lt;<span class="i">Guid</span>, <a href="#ac1382cfd7eb40a5" class="t t">OutOfProcessServerTransportManager</a>&gt; <a id="31cd181e868bfd0f" href="../../../R/31cd181e868bfd0f.html" target="n" data-glyph="46,1" class="i field">_cmdTransportManagers</a>;
        <b>private readonly object</b> <a id="56a0bd96f80b34b0" href="../../../R/56a0bd96f80b34b0.html" target="n" data-glyph="46,1" class="i field">_syncObject</a> = <b>new</b> <b>object</b>();
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Constructors
 
        <b>internal</b> <a id="9304a07267187e08" href="../../../R/9304a07267187e08.html" target="n" data-glyph="74,1" class="t constructor">OutOfProcessServerSessionTransportManager</a>(<a href="#3676916334ddb503" class="t t">OutOfProcessTextWriter</a> <span id="r226 rd" class="r226 r">outWriter</span>, <a href="#3676916334ddb503" class="t t">OutOfProcessTextWriter</a> <span id="r227 rd" class="r227 r">errWriter</span>, <a href="../../../utils/CryptoUtils.cs.html#e11543478fd30f75" class="t t">PSRemotingCryptoHelperServer</a> <span id="r228 rd" class="r228 r">cryptoHelper</span>)
            : <a href="BaseTransportManager.cs.html#0789ba713b2eb040" class="k">base</a>(<a href="BaseTransportManager.cs.html#9ccd7ea4a824f9d8" class="t t">BaseTransportManager</a>.<a href="BaseTransportManager.cs.html#796de4ded764fff1" class="i field">DefaultFragmentSize</a>, <span class="r228 r">cryptoHelper</span>)
        {
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r226 r">outWriter</span> != <b>null</b>, <span class="s">&quot;outWriter cannot be null.&quot;</span>);
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r227 r">errWriter</span> != <b>null</b>, <span class="s">&quot;errWriter cannot be null.&quot;</span>);
            <a href="#e33cf48a8ef0d8ac" class="i field">_stdOutWriter</a> = <span class="r226 r">outWriter</span>;
            <a href="#dfea5e73907e785b" class="i field">_stdErrWriter</a> = <span class="r227 r">errWriter</span>;
            <a href="#31cd181e868bfd0f" class="i field">_cmdTransportManagers</a> = <b>new</b> <span class="i">Dictionary</span>&lt;<span class="i">Guid</span>, <a href="#ac1382cfd7eb40a5" class="t t">OutOfProcessServerTransportManager</a>&gt;();
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Overrides
 
        <b>internal override void</b> <a id="49c20743b961141c" href="../../../R/49c20743b961141c.html" target="n" data-glyph="74,1" class="i method">ProcessRawData</a>(<b>byte</b>[] <span id="r229 rd" class="r229 r">data</span>, <b>string</b> <span id="r230 rd" class="r230 r">stream</span>)
        {
            <a href="BaseTransportManager.cs.html#18630eb940dac0a0" class="k">base</a>.<a href="BaseTransportManager.cs.html#34fedc1c13dfc998" class="i method">ProcessRawData</a>(<span class="r229 r">data</span>, <span class="r230 r">stream</span>);
 
            <span class="c">// Send ACK back to the client as we have processed data.</span>
            <a href="#e33cf48a8ef0d8ac" class="i field">_stdOutWriter</a>.<a href="#1fb9fbc09f4031a8" class="i method">WriteLine</a>(<a href="#bb038d3403da3163" class="t t">OutOfProcessUtils</a>.<span class="i">CreateDataAckPacket</span>(<span class="i">Guid</span>.<span class="i">Empty</span>));
        }
 
        <b>internal override void</b> <a id="408967f23afc4612" href="../../../R/408967f23afc4612.html" target="n" data-glyph="74,1" class="i method">Prepare</a>()
        {
            <b>throw</b> <b>new</b> <span class="i">NotSupportedException</span>();
        }
 
        <b>protected override void</b> <a id="1630551daaec4512" href="../../../R/1630551daaec4512.html" target="n" data-glyph="75,1" class="i method">SendDataToClient</a>(<b>byte</b>[] <span id="r231 rd" class="r231 r">data</span>, <b>bool</b> <span id="r232 rd" class="r232 r">flush</span>, <b>bool</b> <span id="r233 rd" class="r233 r">reportAsPending</span>, <b>bool</b> <span id="r234 rd" class="r234 r">reportAsDataBoundary</span>)
        {
            <a href="#e33cf48a8ef0d8ac" class="i field">_stdOutWriter</a>.<a href="#1fb9fbc09f4031a8" class="i method">WriteLine</a>(<a href="#bb038d3403da3163" class="t t">OutOfProcessUtils</a>.<span class="i">CreateDataPacket</span>(<span class="r231 r">data</span>,
                <a href="PriorityCollection.cs.html#f0975201467fdc06" class="t t">DataPriorityType</a>.<a href="PriorityCollection.cs.html#e5092d1f4fa1babe" class="i field">Default</a>, <span class="i">Guid</span>.<span class="i">Empty</span>));
        }
 
        <b>internal override void</b> <a id="7148aa7e5d3c54af" href="../../../R/7148aa7e5d3c54af.html" target="n" data-glyph="74,1" class="i method">ReportExecutionStatusAsRunning</a>()
        {
            <span class="c">// No-OP for outofProc TMs</span>
        }
 
        <b>internal void</b> <a id="6be630996b674851" href="../../../R/6be630996b674851.html" target="n" data-glyph="74,1" class="i method">CreateCommandTransportManager</a>(<span class="i">Guid</span> <span id="r235 rd" class="r235 r">powerShellCmdId</span>)
        {
            <a href="#ac1382cfd7eb40a5" class="t t">OutOfProcessServerTransportManager</a> <span id="r236 rd" class="r236 r">cmdTM</span> = <b>new</b> <a href="#bcb3588f802da696" class="t constructor">OutOfProcessServerTransportManager</a>(<a href="#e33cf48a8ef0d8ac" class="i field">_stdOutWriter</a>, <a href="#dfea5e73907e785b" class="i field">_stdErrWriter</a>,
                <span class="r235 r">powerShellCmdId</span>, <a href="#b0b666eeded95055" class="k">this</a>.<a href="BaseTransportManager.cs.html#0ded339d7f7c59f8" class="i property">TypeTable</a>, <a href="#b0b666eeded95055" class="k">this</a>.<a href="BaseTransportManager.cs.html#0597b18306926355" class="i property">Fragmentor</a>.<a href="../common/fragmentor.cs.html#a4fa6a799e0782de" class="i property">FragmentSize</a>, <a href="#b0b666eeded95055" class="k">this</a>.<a href="BaseTransportManager.cs.html#30975a92e0bc8f5d" class="i property">CryptoHelper</a>);
            <span class="c">// this will make the Session&#39;s DataReady event handler handle</span>
            <span class="c">// the commands data as well. This is because the state machine</span>
            <span class="c">// is per session.</span>
            <span class="r236 r">cmdTM</span>.<a href="BaseTransportManager.cs.html#3b30f5a51ce0cc61" class="i method">MigrateDataReadyEventHandlers</a>(<a href="#b0b666eeded95055" class="k">this</a>);
 
            <b>lock</b> (<a href="#56a0bd96f80b34b0" class="i field">_syncObject</a>)
            {
                <span class="c">// the dictionary is cleared by ServerPowershellDataStructure handler</span>
                <span class="c">// once the clean up is complete for the transport manager</span>
                <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<span class="i">Assert</span>(!<a href="#31cd181e868bfd0f" class="i field">_cmdTransportManagers</a>.<span class="i">ContainsKey</span>(<span class="r235 r">powerShellCmdId</span>), <span class="s">&quot;key already exists&quot;</span>);
                <a href="#31cd181e868bfd0f" class="i field">_cmdTransportManagers</a>.<span class="i">Add</span>(<span class="r235 r">powerShellCmdId</span>, <span class="r236 r">cmdTM</span>);
            }
 
            <span class="c">// send command ack..so that client can start sending data</span>
            <a href="#e33cf48a8ef0d8ac" class="i field">_stdOutWriter</a>.<a href="#1fb9fbc09f4031a8" class="i method">WriteLine</a>(<a href="#bb038d3403da3163" class="t t">OutOfProcessUtils</a>.<a href="#24f01d680585ec4b" class="i method">CreateCommandAckPacket</a>(<span class="r235 r">powerShellCmdId</span>));
        }
 
        <b>internal override</b> <a href="BaseTransportManager.cs.html#3beeadac29de3a80" class="t t">AbstractServerTransportManager</a> <a id="d5b3015de506bf7e" href="../../../R/d5b3015de506bf7e.html" target="n" data-glyph="74,1" class="i method">GetCommandTransportManager</a>(<span class="i">Guid</span> <span id="r237 rd" class="r237 r">powerShellCmdId</span>)
        {
            <b>lock</b> (<a href="#56a0bd96f80b34b0" class="i field">_syncObject</a>)
            {
                <a href="#ac1382cfd7eb40a5" class="t t">OutOfProcessServerTransportManager</a> <span id="r238 rd" class="r238 r">result</span> = <b>null</b>;
                <a href="#31cd181e868bfd0f" class="i field">_cmdTransportManagers</a>.<span class="i">TryGetValue</span>(<span class="r237 r">powerShellCmdId</span>, <b>out</b> <span class="r238 r">result</span>);
                <b>return</b> <span class="r238 r">result</span>;
            }
        }
 
        <b>internal override void</b> <a id="6e6747646d0ac458" href="../../../R/6e6747646d0ac458.html" target="n" data-glyph="74,1" class="i method">RemoveCommandTransportManager</a>(<span class="i">Guid</span> <span id="r239 rd" class="r239 r">powerShellCmdId</span>)
        {
            <b>lock</b> (<a href="#56a0bd96f80b34b0" class="i field">_syncObject</a>)
            {
                <a href="#31cd181e868bfd0f" class="i field">_cmdTransportManagers</a>.<span class="i">Remove</span>(<span class="r239 r">powerShellCmdId</span>);
            }
        }
 
        <b>internal override void</b> <a id="9caebc4cfc3282a0" href="../../../R/9caebc4cfc3282a0.html" target="n" data-glyph="74,1" class="i method">Close</a>(<span class="i">Exception</span> <span id="r240 rd" class="r240 r">reasonForClose</span>)
        {
            <a href="BaseTransportManager.cs.html#26773d85900651e4" class="i method">RaiseClosingEvent</a>();
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
    }
 
    <b>internal class</b> <a id="ac1382cfd7eb40a5" href="../../../R/ac1382cfd7eb40a5.html" target="n" data-glyph="2,0" class="t t">OutOfProcessServerTransportManager</a> : <a href="BaseTransportManager.cs.html#3beeadac29de3a80" class="t t">AbstractServerTransportManager</a>
    {
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Private Data
 
        <b>private readonly</b> <a href="#3676916334ddb503" class="t t">OutOfProcessTextWriter</a> <a id="7ed150408d762461" href="../../../R/7ed150408d762461.html" target="n" data-glyph="46,1" class="i field">_stdOutWriter</a>;
        <b>private readonly</b> <a href="#3676916334ddb503" class="t t">OutOfProcessTextWriter</a> <a id="ba0825a5798d7f6d" href="../../../R/ba0825a5798d7f6d.html" target="n" data-glyph="46,1" class="i field">_stdErrWriter</a>;
        <b>private readonly</b> <span class="i">Guid</span> <a id="fe82b3a291daf35b" href="../../../R/fe82b3a291daf35b.html" target="n" data-glyph="46,1" class="i field">_powershellInstanceId</a>;
        <b>private bool</b> <a id="248343cf0535a48c" href="../../../R/248343cf0535a48c.html" target="n" data-glyph="46,1" class="i field">_isDataAckSendPending</a>;
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Constructors
 
        <b>internal</b> <a id="bcb3588f802da696" href="../../../R/bcb3588f802da696.html" target="n" data-glyph="74,1" class="t constructor">OutOfProcessServerTransportManager</a>(<a href="#3676916334ddb503" class="t t">OutOfProcessTextWriter</a> <span id="r241 rd" class="r241 r">stdOutWriter</span>, <a href="#3676916334ddb503" class="t t">OutOfProcessTextWriter</a> <span id="r242 rd" class="r242 r">stdErrWriter</span>,
            <span class="i">Guid</span> <span id="r243 rd" class="r243 r">powershellInstanceId</span>,
            <a href="../../../P/a09d9b2cb7b1f0db.html#a09d9b2cb7b1f0db" class="t t">TypeTable</a> <span id="r244 rd" class="r244 r">typeTableToUse</span>,
            <b>int</b> <span id="r245 rd" class="r245 r">fragmentSize</span>,
            <a href="../../../utils/CryptoUtils.cs.html#1999dfb2439af5a0" class="t t">PSRemotingCryptoHelper</a> <span id="r246 rd" class="r246 r">cryptoHelper</span>)
            : <a href="BaseTransportManager.cs.html#34137234abfd253c" class="k">base</a>(<span class="r245 r">fragmentSize</span>, <span class="r246 r">cryptoHelper</span>)
        {
            <a href="#7ed150408d762461" class="i field">_stdOutWriter</a> = <span class="r241 r">stdOutWriter</span>;
            <a href="#ba0825a5798d7f6d" class="i field">_stdErrWriter</a> = <span class="r242 r">stdErrWriter</span>;
            <a href="#fe82b3a291daf35b" class="i field">_powershellInstanceId</a> = <span class="r243 r">powershellInstanceId</span>;
            <a href="#ac1382cfd7eb40a5" class="k">this</a>.<a href="BaseTransportManager.cs.html#0ded339d7f7c59f8" class="i property">TypeTable</a> = <span class="r244 r">typeTableToUse</span>;
 
            <a href="#ac1382cfd7eb40a5" class="k">this</a>.<a href="BaseTransportManager.cs.html#85d6a6f2ebae43ff" class="i">WSManTransportErrorOccured</a> += <span class="i">HandleWSManTransportError</span>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Private Methods
 
        <b>private void</b> <a id="63fe19e2e59ede0e" href="../../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">HandleWSManTransportError</a>(<b>object</b> <span id="r247 rd" class="r247 r">sender</span>, <a href="BaseTransportManager.cs.html#7e70b34f9332dfcd" class="t t">TransportErrorOccuredEventArgs</a> <span id="r248 rd" class="r248 r">e</span>)
        {
            <a href="#ba0825a5798d7f6d" class="i field">_stdErrWriter</a>.<a href="#1fb9fbc09f4031a8" class="i method">WriteLine</a>(<a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">RemoteTransportError</span>, <span class="r248 r">e</span>.<a href="BaseTransportManager.cs.html#f82124202b7ff8f0" class="i property">Exception</a>.<a href="../common/remotingexceptions.cs.html#9008a0cafbbfa4d3" class="i property">TransportMessage</a>));
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Overrides
 
        <b>internal override void</b> <a id="bd3907ad991ba85a" href="../../../R/bd3907ad991ba85a.html" target="n" data-glyph="74,1" class="i method">ProcessRawData</a>(<b>byte</b>[] <span id="r249 rd" class="r249 r">data</span>, <b>string</b> <span id="r250 rd" class="r250 r">stream</span>)
        {
            <a href="#248343cf0535a48c" class="i field">_isDataAckSendPending</a> = <b>true</b>;
            <a href="BaseTransportManager.cs.html#3beeadac29de3a80" class="k">base</a>.<a href="BaseTransportManager.cs.html#34fedc1c13dfc998" class="i method">ProcessRawData</a>(<span class="r249 r">data</span>, <span class="r250 r">stream</span>);
 
            <b>if</b> (<a href="#248343cf0535a48c" class="i field">_isDataAckSendPending</a>)
            {
                <a href="#248343cf0535a48c" class="i field">_isDataAckSendPending</a> = <b>false</b>;
                <span class="c">// Send ACK back to the client as we have processed data.</span>
                <a href="#7ed150408d762461" class="i field">_stdOutWriter</a>.<a href="#1fb9fbc09f4031a8" class="i method">WriteLine</a>(<a href="#bb038d3403da3163" class="t t">OutOfProcessUtils</a>.<a href="#406f6bc786a76226" class="i method">CreateDataAckPacket</a>(<a href="#fe82b3a291daf35b" class="i field">_powershellInstanceId</a>));
            }
        }
 
        <b>internal override void</b> <a id="104540828cd2b84a" href="../../../R/104540828cd2b84a.html" target="n" data-glyph="74,1" class="i method">ReportExecutionStatusAsRunning</a>()
        {
            <span class="c">// No-OP for outofProc TMs</span>
        }
 
        <b>protected override void</b> <a id="5298edaf16baaece" href="../../../R/5298edaf16baaece.html" target="n" data-glyph="75,1" class="i method">SendDataToClient</a>(<b>byte</b>[] <span id="r251 rd" class="r251 r">data</span>, <b>bool</b> <span id="r252 rd" class="r252 r">flush</span>, <b>bool</b> <span id="r253 rd" class="r253 r">reportAsPending</span>, <b>bool</b> <span id="r254 rd" class="r254 r">reportAsDataBoundary</span>)
        {
            <a href="#7ed150408d762461" class="i field">_stdOutWriter</a>.<a href="#1fb9fbc09f4031a8" class="i method">WriteLine</a>(<a href="#bb038d3403da3163" class="t t">OutOfProcessUtils</a>.<a href="#31d02b37bd6ce1aa" class="i method">CreateDataPacket</a>(<span class="r251 r">data</span>,
                <a href="PriorityCollection.cs.html#f0975201467fdc06" class="t t">DataPriorityType</a>.<a href="PriorityCollection.cs.html#e5092d1f4fa1babe" class="i field">Default</a>, <a href="#fe82b3a291daf35b" class="i field">_powershellInstanceId</a>));
        }
 
        <b>internal override void</b> <a id="d20c117bfbcbb641" href="../../../R/d20c117bfbcbb641.html" target="n" data-glyph="74,1" class="i method">Prepare</a>()
        {
            <b>if</b> (<a href="#248343cf0535a48c" class="i field">_isDataAckSendPending</a>)
            {
                <a href="#248343cf0535a48c" class="i field">_isDataAckSendPending</a> = <b>false</b>;
                <span class="c">// let the base class prepare itself.</span>
                <a href="BaseTransportManager.cs.html#3beeadac29de3a80" class="k">base</a>.<a href="BaseTransportManager.cs.html#800a08f5b7eaeef4" class="i method">Prepare</a>();
                <span class="c">// Send ACK back to the client as we have processed data.</span>
                <a href="#7ed150408d762461" class="i field">_stdOutWriter</a>.<a href="#1fb9fbc09f4031a8" class="i method">WriteLine</a>(<a href="#bb038d3403da3163" class="t t">OutOfProcessUtils</a>.<a href="#406f6bc786a76226" class="i method">CreateDataAckPacket</a>(<a href="#fe82b3a291daf35b" class="i field">_powershellInstanceId</a>));
            }
        }
 
        <b>internal override void</b> <a id="7f94d85a0f52c3b1" href="../../../R/7f94d85a0f52c3b1.html" target="n" data-glyph="74,1" class="i method">Close</a>(<span class="i">Exception</span> <span id="r255 rd" class="r255 r">reasonForClose</span>)
        {
            <a href="BaseTransportManager.cs.html#26773d85900651e4" class="i method">RaiseClosingEvent</a>();
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
    }
}
</pre></td></tr></table></div></body></html>
