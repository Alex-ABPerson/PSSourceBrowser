<!DOCTYPE html>
<html><head><title>WSManPlugin.cs</title><link rel="stylesheet" href="../../../../styles.css"><script src="../../../../scripts.js"></script></head>
<body class="cB" onload="i(1927);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#System.Management.Automation/engine/remoting/fanin/WSManPlugin.cs" target="_top">engine\remoting\fanin\WSManPlugin.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#System.Management.Automation" target="_top">src\System.Management.Automation\System.Management.Automation.csproj</a> (System.Management.Automation)</td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation.</span>
<span class="c">// Licensed under the MIT License.</span>
 
<span class="c">// ----------------------------------------------------------------------</span>
<span class="c">//  Contents:  Entry points for managed PowerShell plugin worker used to</span>
<span class="c">//  host powershell in a WSMan service.</span>
<span class="c">// ----------------------------------------------------------------------</span>
 
<b>using</b> <span class="i n">System</span>.<span class="i">Threading</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Globalization</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Runtime</span>.<span class="i">InteropServices</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Security</span>.<span class="i">Principal</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Collections</span>.<span class="i">Generic</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i">Win32</span>.<span class="i">SafeHandles</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Internal</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Remoting</span>.<span class="i n">Client</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Remoting</span>.<span class="i n">Server</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Remoting</span>.<span class="i n">WSMan</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Tracing</span>;
 
<b>using</b> <span class="t">Dbg</span> = <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Diagnostics</a>;
 
<b>namespace</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Remoting</span>
{
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Consolidation of constants for uniformity.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>internal static class</b> <a id="f1ff81f0faba1926" href="../../../R/f1ff81f0faba1926.html" target="n" data-glyph="2,0" class="t t">WSManPluginConstants</a>
    {
        <b>internal const int</b> <a id="0a6d585154325685" href="../../../R/0a6d585154325685.html" target="n" data-glyph="8,1" class="i field">ExitCodeSuccess</a> = 0x00000000;
        <b>internal const int</b> <a id="c274af99f304f814" href="../../../R/c274af99f304f814.html" target="n" data-glyph="8,1" class="i field">ExitCodeFailure</a> = 0x00000001;
 
        <b>internal const string</b> <a id="b7539e67521d0ad3" href="../../../R/b7539e67521d0ad3.html" target="n" data-glyph="8,1" class="i field">CtrlCSignal</a> = <span class="s">&quot;powershell/signal/crtl_c&quot;</span>;
 
        <span class="c">// The following are the only supported streams in PowerShell remoting.</span>
        <span class="c">// see WSManNativeApi.cs. These are duplicated here to save on</span>
        <span class="c">// Marshalling time.</span>
        <b>internal const string</b> <a id="0a1132f3910cae6f" href="../../../R/0a1132f3910cae6f.html" target="n" data-glyph="8,1" class="i field">SupportedInputStream</a> = <span class="s">&quot;stdin&quot;</span>;
        <b>internal const string</b> <a id="3fcff45979da9258" href="../../../R/3fcff45979da9258.html" target="n" data-glyph="8,1" class="i field">SupportedOutputStream</a> = <span class="s">&quot;stdout&quot;</span>;
        <b>internal const string</b> <a id="f38fbda4b10a5573" href="../../../R/f38fbda4b10a5573.html" target="n" data-glyph="8,1" class="i field">SupportedPromptResponseStream</a> = <span class="s">&quot;pr&quot;</span>;
        <b>internal const string</b> <a id="ee4032509cb62f4f" href="../../../R/ee4032509cb62f4f.html" target="n" data-glyph="8,1" class="i field">PowerShellStartupProtocolVersionName</a> = <span class="s">&quot;protocolversion&quot;</span>;
        <b>internal const string</b> <a id="08e08a97aba4a5a5" href="../../../R/08e08a97aba4a5a5.html" target="n" data-glyph="8,1" class="i field">PowerShellStartupProtocolVersionValue</a> = <span class="s">&quot;2.0&quot;</span>;
        <b>internal const string</b> <a id="7f00904e7d75f092" href="../../../R/7f00904e7d75f092.html" target="n" data-glyph="8,1" class="i field">PowerShellOptionPrefix</a> = <span class="s">&quot;PS_&quot;</span>;
 
        <b>internal const int</b> <a id="9e6e9de7915623cc" href="../../../R/9e6e9de7915623cc.html" target="n" data-glyph="8,1" class="i field">WSManPluginParamsGetRequestedLocale</a> = 5;
        <b>internal const int</b> <a id="2e426cfd22d1ed6d" href="../../../R/2e426cfd22d1ed6d.html" target="n" data-glyph="8,1" class="i field">WSManPluginParamsGetRequestedDataLocale</a> = 6;
    }
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Definitions of HRESULT error codes that are passed to the client.</span>
    <span class="c">///</span><span class="c"> 0x8054.... means that it is a PowerShell HRESULT. The PowerShell facility</span>
    <span class="c">///</span><span class="c"> is 84 (0x54).</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>internal enum</b> <a id="a42b50e40ac07da8" href="../../../R/a42b50e40ac07da8.html" target="n" data-glyph="20,0" class="t t"><span id="cad79b9e83642384">WSManPluginErrorCodes</span></a> : <b>int</b>
    {
        <a id="52a260224a14ca51" href="../../../R/52a260224a14ca51.html" target="n" data-glyph="24,1" class="i field">NullPluginContext</a> = -2141976624, <span class="c">// 0x805407D0</span>
        <a id="d46eb6624c1acdff" href="../../../R/d46eb6624c1acdff.html" target="n" data-glyph="24,1" class="i field">PluginContextNotFound</a> = -2141976623, <span class="c">// 0x805407D1</span>
 
        <a id="9e60ead84c49e935" href="../../../R/9e60ead84c49e935.html" target="n" data-glyph="24,1" class="i field">NullInvalidInput</a> = -2141975624, <span class="c">// 0x80540BB8</span>
        <a id="ddebd763eb1e7d54" href="../../../R/ddebd763eb1e7d54.html" target="n" data-glyph="24,1" class="i field">NullInvalidStreamSets</a> = -2141975623, <span class="c">// 0x80540BB9</span>
        <a id="a624785bae29559a" href="../../../R/a624785bae29559a.html" target="n" data-glyph="24,1" class="i field">SessionCreationFailed</a> = -2141975622, <span class="c">// 0x80540BBA</span>
        <a id="583a37088b02d6e7" href="../../../R/583a37088b02d6e7.html" target="n" data-glyph="24,1" class="i field">NullShellContext</a> = -2141975621, <span class="c">// 0x80540BBB</span>
        <a id="71fab73a96d676a6" href="../../../R/71fab73a96d676a6.html" target="n" data-glyph="24,1" class="i field">InvalidShellContext</a> = -2141975620, <span class="c">// 0x80540BBC</span>
        <a id="c32d1ab79ca253fc" href="../../../R/c32d1ab79ca253fc.html" target="n" data-glyph="24,1" class="i field">InvalidCommandContext</a> = -2141975619, <span class="c">// 0x80540BBD</span>
        <a id="c53d6d00f838004c" href="../../../R/c53d6d00f838004c.html" target="n" data-glyph="24,1" class="i field">InvalidInputStream</a> = -2141975618, <span class="c">// 0x80540BBE</span>
        <a id="74b4027f79288629" href="../../../R/74b4027f79288629.html" target="n" data-glyph="24,1" class="i field">InvalidInputDatatype</a> = -2141975617, <span class="c">// 0x80540BBF</span>
        <a id="4f68857296a0a026" href="../../../R/4f68857296a0a026.html" target="n" data-glyph="24,1" class="i field">InvalidOutputStream</a> = -2141975616, <span class="c">// 0x80540BC0</span>
        <a id="a1a90d4dd7d6f7fa" href="../../../R/../../0000000000.html" target="n" data-glyph="24,1" class="i field">InvalidSenderDetails</a> = -2141975615, <span class="c">// 0x80540BC1</span>
        <a id="02606e5208484f85" href="../../../R/02606e5208484f85.html" target="n" data-glyph="24,1" class="i field">ShutdownRegistrationFailed</a> = -2141975614, <span class="c">// 0x80540BC2</span>
        <a id="0cf5a88230c90eed" href="../../../R/0cf5a88230c90eed.html" target="n" data-glyph="24,1" class="i field">ReportContextFailed</a> = -2141975613, <span class="c">// 0x80540BC3</span>
        <a id="d88fb2053da5fbc9" href="../../../R/d88fb2053da5fbc9.html" target="n" data-glyph="24,1" class="i field">InvalidArgSet</a> = -2141975612, <span class="c">// 0x80540BC4</span>
        <a id="26ce4a62f28b0198" href="../../../R/26ce4a62f28b0198.html" target="n" data-glyph="24,1" class="i field">ProtocolVersionNotMatch</a> = -2141975611, <span class="c">// 0x80540BC5</span>
        <a id="bc9d5dde9e2a3ba1" href="../../../R/bc9d5dde9e2a3ba1.html" target="n" data-glyph="24,1" class="i field">OptionNotUnderstood</a> = -2141975610, <span class="c">// 0x80540BC6</span>
        <a id="96e5126cf9336a88" href="../../../R/96e5126cf9336a88.html" target="n" data-glyph="24,1" class="i field">ProtocolVersionNotFound</a> = -2141975609, <span class="c">// 0x80540BC7</span>
 
        <a id="9884203a81bf3f15" href="../../../R/9884203a81bf3f15.html" target="n" data-glyph="24,1" class="i field">ManagedException</a> = -2141974624, <span class="c">// 0x80540FA0</span>
        <a id="7a69518083f7a0b8" href="../../../R/../../0000000000.html" target="n" data-glyph="24,1" class="i field">PluginOperationClose</a> = -2141974623, <span class="c">// 0x80540FA1</span>
        <a id="389370021fe07bd0" href="../../../R/../../0000000000.html" target="n" data-glyph="24,1" class="i field">PluginConnectNoNegotiationData</a> = -2141974622, <span class="c">// 0x80540FA2</span>
        <a id="22ba220ec2f5f0c9" href="../../../R/22ba220ec2f5f0c9.html" target="n" data-glyph="24,1" class="i field">PluginConnectOperationFailed</a> = -2141974621, <span class="c">// 0x80540FA3</span>
 
        <a id="39442c3488d17250" href="../../../R/39442c3488d17250.html" target="n" data-glyph="24,1" class="i field">NoError</a> = 0,
        <a id="b22ffa6e6f8f45d5" href="../../../R/b22ffa6e6f8f45d5.html" target="n" data-glyph="24,1" class="i field">OutOfMemory</a> = -2147024882  <span class="c">// 0x8007000E</span>
    }
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Class that holds plugin + shell context information used to handle</span>
    <span class="c">///</span><span class="c"> shutdown notifications.</span>
    <span class="c">///</span>
    <span class="c">///</span><span class="c"> Explicit destruction and release of the IntPtrs is not required because</span>
    <span class="c">///</span><span class="c"> their lifetime is managed by WinRM.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    [<span class="i">StructLayout</span>(<span class="i">LayoutKind</span>.<span class="i">Sequential</span>, <span class="i">CharSet</span> = <span class="i">CharSet</span>.<span class="i">Unicode</span>)]
    <b>internal class</b> <a id="3e5455aa49779e8c" href="../../../R/3e5455aa49779e8c.html" target="n" data-glyph="2,0" class="t t">WSManPluginOperationShutdownContext</a> <span class="c">// TODO: Rename to OperationShutdownContext when removing the MC++ module.</span>
    {
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Internal Members
 
        <b>internal</b> <span class="i">IntPtr</span> <a id="ad231a2a230ba5d7" href="../../../R/ad231a2a230ba5d7.html" target="n" data-glyph="44,1" class="i field">pluginContext</a>;
        <b>internal</b> <span class="i">IntPtr</span> <a id="d256ac29b2a57375" href="../../../R/d256ac29b2a57375.html" target="n" data-glyph="44,1" class="i field">shellContext</a>;
        <b>internal</b> <span class="i">IntPtr</span> <a id="13481c936788e297" href="../../../R/13481c936788e297.html" target="n" data-glyph="44,1" class="i field">commandContext</a>;
        <b>internal bool</b> <a id="11b9cfdb4ecabe88" href="../../../R/11b9cfdb4ecabe88.html" target="n" data-glyph="44,1" class="i field">isReceiveOperation</a>;
        <b>internal bool</b> <a id="a848dec07b8cdfdd" href="../../../R/a848dec07b8cdfdd.html" target="n" data-glyph="44,1" class="i field">isShuttingDown</a>;
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Constructors
 
        <b>internal</b> <a id="50876cb84abf1ce7" href="../../../R/50876cb84abf1ce7.html" target="n" data-glyph="74,1" class="t constructor">WSManPluginOperationShutdownContext</a>(
            <span class="i">IntPtr</span> <span id="r0 rd" class="r0 r">plgContext</span>,
            <span class="i">IntPtr</span> <span id="r1 rd" class="r1 r">shContext</span>,
            <span class="i">IntPtr</span> <span id="r2 rd" class="r2 r">cmdContext</span>,
            <b>bool</b> <span id="r3 rd" class="r3 r">isRcvOp</span>)
        {
            <a href="#ad231a2a230ba5d7" class="i field">pluginContext</a> = <span class="r0 r">plgContext</span>;
            <a href="#d256ac29b2a57375" class="i field">shellContext</a> = <span class="r1 r">shContext</span>;
            <a href="#13481c936788e297" class="i field">commandContext</a> = <span class="r2 r">cmdContext</span>;
            <a href="#11b9cfdb4ecabe88" class="i field">isReceiveOperation</a> = <span class="r3 r">isRcvOp</span>;
            <a href="#a848dec07b8cdfdd" class="i field">isShuttingDown</a> = <b>false</b>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
    }
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Represents the logical grouping of all actions required to handle the</span>
    <span class="c">///</span><span class="c"> lifecycle of shell sessions through the WinRM plugin.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>internal class</b> <a id="23ee55d6d8a367a2" href="../../../R/23ee55d6d8a367a2.html" target="n" data-glyph="2,0" class="t t">WSManPluginInstance</a>
    {
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Private Members
 
        <b>private readonly</b> <span class="i">Dictionary</span>&lt;<span class="i">IntPtr</span>, <a href="WSManPluginShellSession.cs.html#7345fbb9d90a70e9" class="t t">WSManPluginShellSession</a>&gt; <a id="77f086f1f10e52f8" href="../../../R/77f086f1f10e52f8.html" target="n" data-glyph="46,1" class="i field">_activeShellSessions</a>;
        <b>private readonly object</b> <a id="ecabb9ec882c717c" href="../../../R/ecabb9ec882c717c.html" target="n" data-glyph="46,1" class="i field">_syncObject</a>;
        <b>private static readonly</b> <span class="i">Dictionary</span>&lt;<span class="i">IntPtr</span>, <a href="#23ee55d6d8a367a2" class="t t">WSManPluginInstance</a>&gt; <a id="2a5df8eaf4582089" href="../../../R/2a5df8eaf4582089.html" target="n" data-glyph="46,1" class="i field">s_activePlugins</a> = <b>new</b> <span class="i">Dictionary</span>&lt;<span class="i">IntPtr</span>, <a href="#23ee55d6d8a367a2" class="t t">WSManPluginInstance</a>&gt;();
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Enables dependency injection after the static constructor is called.</span>
        <span class="c">///</span><span class="c"> This may be overridden in unit tests to enable different behavior.</span>
        <span class="c">///</span><span class="c"> It is static because static instances of this class use the facade. Otherwise,</span>
        <span class="c">///</span><span class="c"> it would be passed in via a parameterized constructor.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal static readonly</b> <a href="WSManNativeAPI.cs.html#28d2b5626ddfc6e5" class="t t">IWSManNativeApiFacade</a> <a id="3331cc0274ebff08" href="../../../R/3331cc0274ebff08.html" target="n" data-glyph="44,1" class="i field">wsmanPinvokeStatic</a> = <b>new</b> <span class="t">WSManNativeApiFacade</span>();
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Constructor and Destructor
 
        <b>internal</b> <a id="9be46567bcd26e5a" href="../../../R/9be46567bcd26e5a.html" target="n" data-glyph="74,1" class="t constructor">WSManPluginInstance</a>()
        {
            <a href="#77f086f1f10e52f8" class="i field">_activeShellSessions</a> = <b>new</b> <span class="i">Dictionary</span>&lt;<span class="i">IntPtr</span>, <a href="WSManPluginShellSession.cs.html#7345fbb9d90a70e9" class="t t">WSManPluginShellSession</a>&gt;();
            <a href="#ecabb9ec882c717c" class="i field">_syncObject</a> = <b>new</b> <b>object</b>();
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Static constructor to listen to unhandled exceptions</span>
        <span class="c">///</span><span class="c"> from the AppDomain and log the errors</span>
        <span class="c">///</span><span class="c"> Note: It is not necessary to instantiate IWSManNativeApi here because it is not used.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>static</b> <a id="8d2c8bfe69a3cea0" href="../../../R/../../0000000000.html" target="n" data-glyph="76,1" class="t method">WSManPluginInstance</a>()
        {
            <span class="c">// NOTE - the order is important here:</span>
            <span class="c">// because handler from WindowsErrorReporting is going to terminate the process</span>
            <span class="c">// we want it to fire last</span>
 
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">CORECLR</span>
<span class="e">            // Register our remoting handler for crashes
            AppDomain currentDomain = AppDomain.CurrentDomain;
            currentDomain.UnhandledException +=
                new UnhandledExceptionEventHandler(WSManPluginInstance.UnhandledExceptionHandler);
</span><span class="k preprocess">#</span><span class="k preprocess">endif</span>
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Create a new shell in the plugin context.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r4 r">pluginContext</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r5 r">requestDetails</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r6 r">flags</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r7 r">extraInfo</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r8 r">startupInfo</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r9 r">inboundShellInformation</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="8ae91ce3c983c72f" href="../../../R/8ae91ce3c983c72f.html" target="n" data-glyph="74,1" class="i method">CreateShell</a>(
            <span class="i">IntPtr</span> <span id="r4 rd" class="r4 r">pluginContext</span>,
            <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#07d21d2cee8c9d82" class="t t">WSManPluginRequest</a> <span id="r5 rd" class="r5 r">requestDetails</span>,
            <b>int</b> <span id="r6 rd" class="r6 r">flags</span>,
            <b>string</b> <span id="r7 rd" class="r7 r">extraInfo</span>,
            <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#19022ea5d98e6225" class="t t">WSManShellStartupInfo_UnToMan</a> <span id="r8 rd" class="r8 r">startupInfo</span>,
            <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#456a9677b88cb3ef" class="t t">WSManData_UnToMan</a> <span id="r9 rd" class="r9 r">inboundShellInformation</span>)
        {
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(
                <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#899f8d8479c02e43" class="i field">ServerCreateRemoteSession</a>,
                <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#a0f7cf0d4987790f" class="i field">Connect</a>,
                <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a59ff5f5d029e4d1" class="i field">ManagedPlugin</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                <span class="s">&quot;null&quot;</span>,
                <span class="s">&quot;CreateShell: Create a new shell in the plugin context&quot;</span>,
                <b>string</b>.<span class="i">Empty</span>);
 
            <b>if</b> (<span class="r5 r">requestDetails</span> == <b>null</b>)
            {
                <span class="c">// Nothing can be done because requestDetails are required to report operation complete</span>
                <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(<a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#ace81b72cf5e0c44" class="i field">ReportOperationComplete</a>,
                    <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#7bf2b73f1de59d2e" class="i field">Close</a>, <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                    <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a59ff5f5d029e4d1" class="i field">ManagedPlugin</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                    <span class="s">&quot;null&quot;</span>,
                    <span class="i">Convert</span>.<span class="i">ToString</span>(<a href="#a42b50e40ac07da8" class="t t">WSManPluginErrorCodes</a>.<a href="#9e60ead84c49e935" class="i field">NullInvalidInput</a>, <span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>),
                    <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(
                        <span class="i">RemotingErrorIdStrings</span>.<span class="i">WSManPluginNullInvalidInput</span>,
                        <span class="s">&quot;requestDetails&quot;</span>,
                        <span class="s">&quot;WSManPluginShell&quot;</span>),
                    <b>string</b>.<span class="i">Empty</span>);
                <b>return</b>;
            }
 
            <b>if</b> ((<span class="r5 r">requestDetails</span>.<a href="WSManNativeAPI.cs.html#10ad3eda597bdf65" class="i field">senderDetails</a> == <b>null</b>) ||
                (<span class="r5 r">requestDetails</span>.<a href="WSManNativeAPI.cs.html#8fa7923067133d6f" class="i field">operationInfo</a> == <b>null</b>))
            {
                <a href="#34bada9077aac474" class="i method">ReportOperationComplete</a>(
                    <span class="r5 r">requestDetails</span>,
                    <a href="#a42b50e40ac07da8" class="t t">WSManPluginErrorCodes</a>.<a href="#9e60ead84c49e935" class="i field">NullInvalidInput</a>,
                    <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(
                        <span class="i">RemotingErrorIdStrings</span>.<span class="i">WSManPluginNullInvalidInput</span>,
                        <span class="s">&quot;requestDetails&quot;</span>,
                        <span class="s">&quot;WSManPluginShell&quot;</span>));
                <b>return</b>;
            }
 
            <b>if</b> (<span class="r8 r">startupInfo</span> == <b>null</b>)
            {
                <a href="#34bada9077aac474" class="i method">ReportOperationComplete</a>(
                    <span class="r5 r">requestDetails</span>,
                    <a href="#a42b50e40ac07da8" class="t t">WSManPluginErrorCodes</a>.<a href="#9e60ead84c49e935" class="i field">NullInvalidInput</a>,
                    <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(
                        <span class="i">RemotingErrorIdStrings</span>.<span class="i">WSManPluginNullInvalidInput</span>,
                        <span class="s">&quot;startupInfo&quot;</span>,
                        <span class="s">&quot;WSManPluginShell&quot;</span>));
                <b>return</b>;
            }
 
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(
                <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#899f8d8479c02e43" class="i field">ServerCreateRemoteSession</a>,
                <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#a0f7cf0d4987790f" class="i field">Connect</a>,
                <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a59ff5f5d029e4d1" class="i field">ManagedPlugin</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                <span class="r5 r">requestDetails</span>.<span class="i">ToString</span>(),
                <span class="s">&quot;CreateShell: NULL checks being performed&quot;</span>,
                <b>string</b>.<span class="i">Empty</span>);
 
            <b>if</b> ((<span class="r8 r">startupInfo</span>.<a href="WSManNativeAPI.cs.html#ea47f38b3b5380a7" class="i field">inputStreamSet</a>.<a href="WSManNativeAPI.cs.html#719c43558d5c69a0" class="i field">streamIDsCount</a> == 0) || (<span class="r8 r">startupInfo</span>.<a href="WSManNativeAPI.cs.html#f076c27f80ed60be" class="i field">outputStreamSet</a>.<a href="WSManNativeAPI.cs.html#719c43558d5c69a0" class="i field">streamIDsCount</a> == 0))
            {
                <a href="#34bada9077aac474" class="i method">ReportOperationComplete</a>(
                    <span class="r5 r">requestDetails</span>,
                    <a href="#a42b50e40ac07da8" class="t t">WSManPluginErrorCodes</a>.<a href="#ddebd763eb1e7d54" class="i field">NullInvalidStreamSets</a>,
                    <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(
                        <span class="i">RemotingErrorIdStrings</span>.<span class="i">WSManPluginNullInvalidStreamSet</span>,
                        <a href="#f1ff81f0faba1926" class="t t">WSManPluginConstants</a>.<a href="#0a1132f3910cae6f" class="i field">SupportedInputStream</a>,
                        <a href="#f1ff81f0faba1926" class="t t">WSManPluginConstants</a>.<a href="#3fcff45979da9258" class="i field">SupportedOutputStream</a>));
                <b>return</b>;
            }
 
            <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r7 r">extraInfo</span>))
            {
                <a href="#34bada9077aac474" class="i method">ReportOperationComplete</a>(
                    <span class="r5 r">requestDetails</span>,
                    <a href="#a42b50e40ac07da8" class="t t">WSManPluginErrorCodes</a>.<a href="#9e60ead84c49e935" class="i field">NullInvalidInput</a>,
                    <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(
                        <span class="i">RemotingErrorIdStrings</span>.<span class="i">WSManPluginNullInvalidInput</span>,
                        <span class="s">&quot;extraInfo&quot;</span>,
                        <span class="s">&quot;WSManPluginShell&quot;</span>));
                <b>return</b>;
            }
 
            <a href="#23ee55d6d8a367a2" class="t t">WSManPluginInstance</a>.<a href="#cafbb195850f1ca3" class="i method">SetThreadProperties</a>(<span class="r5 r">requestDetails</span>);
 
            <span class="c">// check if protocolversion option is honored</span>
            <b>if</b> (!<a href="#9be3a24502ac5f4e" class="i method">EnsureOptionsComply</a>(<span class="r5 r">requestDetails</span>))
            {
                <b>return</b>;
            }
 
            <b>int</b> <span id="r10 rd" class="r10 r">result</span> = <a href="#f1ff81f0faba1926" class="t t">WSManPluginConstants</a>.<a href="#0a6d585154325685" class="i field">ExitCodeSuccess</a>;
            <a href="WSManPluginShellSession.cs.html#7345fbb9d90a70e9" class="t t">WSManPluginShellSession</a> <span id="r11 rd" class="r11 r">mgdShellSession</span>;
            <a href="#3e5455aa49779e8c" class="t t">WSManPluginOperationShutdownContext</a> <span id="r12 rd" class="r12 r">context</span>;
            <b>byte</b>[] <span id="r13 rd" class="r13 r">convertedBase64</span> = <b>null</b>;
 
            <b>try</b>
            {
                <a href="PSPrincipal.cs.html#eeedcf9113508cb9" class="t t">PSSenderInfo</a> <span id="r14 rd" class="r14 r">senderInfo</span> = <a href="#8c9dce77f7e4596c" class="i method">GetPSSenderInfo</a>(<span class="r5 r">requestDetails</span>.<a href="WSManNativeAPI.cs.html#10ad3eda597bdf65" class="i field">senderDetails</a>);
 
                <span class="c">// inbound shell information is already verified by pwrshplugin.dll.. so no need</span>
                <span class="c">// to verify here.</span>
                <a href="WSManPluginTransportManager.cs.html#deee4e3fe9fcc9c7" class="t t">WSManPluginServerTransportManager</a> <span id="r15 rd" class="r15 r">serverTransportMgr</span>;
 
                <b>if</b> (<a href="../../../CoreCLR/CorePsPlatform.cs.html#693813241122eb45" class="t t">Platform</a>.<a href="../../../CoreCLR/CorePsPlatform.cs.html#a0395f876114b36d" class="i property">IsWindows</a>)
                {
                    <span class="r15 r">serverTransportMgr</span> = <b>new</b> <a href="WSManPluginTransportManager.cs.html#c2f0349ba359555e" class="t constructor">WSManPluginServerTransportManager</a>(<a href="BaseTransportManager.cs.html#9ccd7ea4a824f9d8" class="t t">BaseTransportManager</a>.<a href="BaseTransportManager.cs.html#796de4ded764fff1" class="i field">DefaultFragmentSize</a>, <b>new</b> <a href="../../../utils/CryptoUtils.cs.html#71ecffd05c1623b9" class="t constructor">PSRemotingCryptoHelperServer</a>());
                }
                <b>else</b>
                {
                    <span class="r15 r">serverTransportMgr</span> = <b>new</b> <a href="WSManPluginTransportManager.cs.html#c2f0349ba359555e" class="t constructor">WSManPluginServerTransportManager</a>(<a href="BaseTransportManager.cs.html#9ccd7ea4a824f9d8" class="t t">BaseTransportManager</a>.<a href="BaseTransportManager.cs.html#796de4ded764fff1" class="i field">DefaultFragmentSize</a>, <b>null</b>);
                }
 
                <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(
                    <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#899f8d8479c02e43" class="i field">ServerCreateRemoteSession</a>,
                    <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#a0f7cf0d4987790f" class="i field">Connect</a>, <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                    <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a59ff5f5d029e4d1" class="i field">ManagedPlugin</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                    <span class="r5 r">requestDetails</span>.<span class="i">ToString</span>(), <span class="r14 r">senderInfo</span>.<a href="PSPrincipal.cs.html#ac3b737833cbe3e1" class="i property">UserInfo</a>.<a href="PSPrincipal.cs.html#be3c94a41767a974" class="i property">Identity</a>.<a href="PSPrincipal.cs.html#5ec5296e7ff7b744" class="i property">Name</a>, <span class="r5 r">requestDetails</span>.<a href="WSManNativeAPI.cs.html#b6c51fbca52e1bdd" class="i field">resourceUri</a>);
                <a href="../server/serverremotesession.cs.html#2224dac53a001a7b" class="t t">ServerRemoteSession</a> <span id="r16 rd" class="r16 r">remoteShellSession</span> = <a href="../server/serverremotesession.cs.html#2224dac53a001a7b" class="t t">ServerRemoteSession</a>.<a href="../server/serverremotesession.cs.html#28b246ab77078e6c" class="i method">CreateServerRemoteSession</a>(<span class="r14 r">senderInfo</span>,
                <span class="r5 r">requestDetails</span>.<a href="WSManNativeAPI.cs.html#b6c51fbca52e1bdd" class="i field">resourceUri</a>,
                <span class="r7 r">extraInfo</span>,
                <span class="r15 r">serverTransportMgr</span>);
 
                <b>if</b> (<span class="r16 r">remoteShellSession</span> == <b>null</b>)
                {
                    <a href="#23ee55d6d8a367a2" class="t t">WSManPluginInstance</a>.<a href="#27a43fd6d5b8200e" class="i method">ReportWSManOperationComplete</a>(
                        <span class="r5 r">requestDetails</span>,
                        <a href="#a42b50e40ac07da8" class="t t">WSManPluginErrorCodes</a>.<a href="#a624785bae29559a" class="i field">SessionCreationFailed</a>);
                    <b>return</b>;
                }
 
                <span class="r12 r">context</span> = <b>new</b> <span class="t">WSManPluginOperationShutdownContext</span>(<span class="r4 r">pluginContext</span>, <span class="r5 r">requestDetails</span>.<a href="WSManNativeAPI.cs.html#0bd4e014382d2f95" class="i field">unmanagedHandle</a>, <span class="i">IntPtr</span>.<span class="i">Zero</span>, <b>false</b>);
                <b>if</b> (<span class="r12 r">context</span> == <b>null</b>)
                {
                    <a href="#c8d0e78b633d4f66" class="i method">ReportOperationComplete</a>(<span class="r5 r">requestDetails</span>, <a href="#a42b50e40ac07da8" class="t t">WSManPluginErrorCodes</a>.<a href="#b22ffa6e6f8f45d5" class="i field">OutOfMemory</a>);
                    <b>return</b>;
                }
 
                <span class="c">// Create a shell session wrapper to track and service future interactions.</span>
                <span class="r11 r">mgdShellSession</span> = <b>new</b> <a href="WSManPluginShellSession.cs.html#06261f9549dc9d71" class="t constructor">WSManPluginShellSession</a>(<span class="r5 r">requestDetails</span>, <span class="r15 r">serverTransportMgr</span>, <span class="r16 r">remoteShellSession</span>, <span class="r12 r">context</span>);
                <a href="#375a560fb7633e2c" class="i method">AddToActiveShellSessions</a>(<span class="r11 r">mgdShellSession</span>);
                <span class="r11 r">mgdShellSession</span>.<a href="WSManPluginShellSession.cs.html#662a9de1016c6dd9" class="i">SessionClosed</a> += <span class="i">HandleShellSessionClosed</span>;
 
                <b>if</b> (<span class="r9 r">inboundShellInformation</span> != <b>null</b>)
                {
                    <b>if</b> (<span class="r9 r">inboundShellInformation</span>.<a href="WSManNativeAPI.cs.html#1e7e9090a55ed442" class="i property">Type</a> != (<b>uint</b>)<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#46ddd0c66b953490" class="t t">WSManDataType</a>.<a href="WSManNativeAPI.cs.html#1a9738dd5816811e" class="i field">WSMAN_DATA_TYPE_TEXT</a>)
                    {
                        <span class="c">// only text data is supported</span>
                        <a href="#34bada9077aac474" class="i method">ReportOperationComplete</a>(
                            <span class="r5 r">requestDetails</span>,
                            <a href="#a42b50e40ac07da8" class="t t">WSManPluginErrorCodes</a>.<a href="#74b4027f79288629" class="i field">InvalidInputDatatype</a>,
                            <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(
                                <span class="i">RemotingErrorIdStrings</span>.<span class="i">WSManPluginInvalidInputDataType</span>,
                                <span class="s">&quot;WSMAN_DATA_TYPE_TEXT&quot;</span>));
                        <a href="#6a2d3534931ddca5" class="i method">DeleteFromActiveShellSessions</a>(<span class="r5 r">requestDetails</span>.<a href="WSManNativeAPI.cs.html#0bd4e014382d2f95" class="i field">unmanagedHandle</a>);
                        <b>return</b>;
                    }
                    <b>else</b>
                    {
                        <span class="r13 r">convertedBase64</span> = <a href="BaseTransportManager.cs.html#e8f1ac90f941837f" class="t t">ServerOperationHelpers</a>.<a href="BaseTransportManager.cs.html#4cf9fbefd6b59fe6" class="i method">ExtractEncodedXmlElement</a>(
                            <span class="r9 r">inboundShellInformation</span>.<a href="WSManNativeAPI.cs.html#ed072da1616e6b8a" class="i property">Text</a>,
                            <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#162d8410e5d5ba48" class="i field">PS_CREATION_XML_TAG</a>);
                    }
                }
 
                <span class="c">// now report the shell context to WSMan.</span>
                <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(
                    <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#d241c56391acaf2d" class="i field">ReportContext</a>,
                    <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#a0f7cf0d4987790f" class="i field">Connect</a>, <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                    <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a59ff5f5d029e4d1" class="i field">ManagedPlugin</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                    <span class="r5 r">requestDetails</span>.<span class="i">ToString</span>(), <span class="r5 r">requestDetails</span>.<span class="i">ToString</span>());
                <span class="r10 r">result</span> = <a href="#3331cc0274ebff08" class="i field">wsmanPinvokeStatic</a>.<a href="WSManNativeAPI.cs.html#a076db435a6d32bd" class="i method">WSManPluginReportContext</a>(<span class="r5 r">requestDetails</span>.<a href="WSManNativeAPI.cs.html#0bd4e014382d2f95" class="i field">unmanagedHandle</a>, 0, <span class="r5 r">requestDetails</span>.<a href="WSManNativeAPI.cs.html#0bd4e014382d2f95" class="i field">unmanagedHandle</a>);
 
                <b>if</b> (<span class="r10 r">result</span> != <a href="#f1ff81f0faba1926" class="t t">WSManPluginConstants</a>.<a href="#0a6d585154325685" class="i field">ExitCodeSuccess</a>)
                {
                    <a href="#34bada9077aac474" class="i method">ReportOperationComplete</a>(
                        <span class="r5 r">requestDetails</span>,
                        <a href="#a42b50e40ac07da8" class="t t">WSManPluginErrorCodes</a>.<a href="#0cf5a88230c90eed" class="i field">ReportContextFailed</a>,
                        <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(
                                <span class="i">RemotingErrorIdStrings</span>.<span class="i">WSManPluginReportContextFailed</span>));
                    <a href="#6a2d3534931ddca5" class="i method">DeleteFromActiveShellSessions</a>(<span class="r5 r">requestDetails</span>.<a href="WSManNativeAPI.cs.html#0bd4e014382d2f95" class="i field">unmanagedHandle</a>);
                    <b>return</b>;
                }
            }
            <b>catch</b> (<span class="i n">System</span>.<span class="i">Exception</span> <span id="r17 rd" class="r17 r">e</span>)
            {
                <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogOperationalError</span>(<a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#4ddb36cebdb0b70c" class="i field">TransportError</a>,
                    <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#a0f7cf0d4987790f" class="i field">Connect</a>, <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>, <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#05d709c2010b41d5" class="i field">UseAlwaysOperational</a>, <a href="../../../../GuidAssembly/R/00000000-0000-0000-0000-000000000000.html" target="n" class="s">&quot;00000000-0000-0000-0000-000000000000&quot;</a>, <a href="../../../../GuidAssembly/R/00000000-0000-0000-0000-000000000000.html" target="n" class="s">&quot;00000000-0000-0000-0000-000000000000&quot;</a>,
                    <span class="i">Convert</span>.<span class="i">ToString</span>(<a href="#a42b50e40ac07da8" class="t t">WSManPluginErrorCodes</a>.<a href="#9884203a81bf3f15" class="i field">ManagedException</a>, <span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>), <span class="r17 r">e</span>.<span class="i">Message</span>, <span class="r17 r">e</span>.<span class="i">StackTrace</span>);
 
                <a href="#6a2d3534931ddca5" class="i method">DeleteFromActiveShellSessions</a>(<span class="r5 r">requestDetails</span>.<a href="WSManNativeAPI.cs.html#0bd4e014382d2f95" class="i field">unmanagedHandle</a>);
                <a href="#34bada9077aac474" class="i method">ReportOperationComplete</a>(
                    <span class="r5 r">requestDetails</span>,
                    <a href="#a42b50e40ac07da8" class="t t">WSManPluginErrorCodes</a>.<a href="#9884203a81bf3f15" class="i field">ManagedException</a>,
                    <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(
                        <span class="i">RemotingErrorIdStrings</span>.<span class="i">WSManPluginManagedException</span>,
                        <span class="r17 r">e</span>.<span class="i">Message</span>));
                <b>return</b>;
            }
 
            <b>bool</b> <span id="r18 rd" class="r18 r">isRegisterWaitForSingleObjectSucceeded</span> = <b>true</b>;
 
            <span class="c">// always synchronize calls to OperationComplete once notification handle is registered.. else duplicate OperationComplete calls are bound to happen</span>
            <b>lock</b> (<span class="r11 r">mgdShellSession</span>.<a href="WSManPluginShellSession.cs.html#8a89769497af759b" class="i field">shellSyncObject</a>)
            {
                <span class="r11 r">mgdShellSession</span>.<a href="WSManPluginShellSession.cs.html#8007b003b9ab8eaf" class="i field">registeredShutdownNotification</a> = 1;
 
                <span class="c">// Wrap the provided handle so it can be passed to the registration function</span>
                <span class="i">EventWaitHandle</span> <span id="r19 rd" class="r19 r">eventWaitHandle</span> = <b>new</b> <span class="i">EventWaitHandle</span>(<b>false</b>, <span class="i">EventResetMode</span>.<span class="i">AutoReset</span>);
 
                <b>if</b> (<a href="../../../CoreCLR/CorePsPlatform.cs.html#693813241122eb45" class="t t">Platform</a>.<a href="../../../CoreCLR/CorePsPlatform.cs.html#a0395f876114b36d" class="i property">IsWindows</a>)
                {
                    <span class="i">SafeWaitHandle</span> <span id="r20 rd" class="r20 r">safeWaitHandle</span> = <b>new</b> <span class="i">SafeWaitHandle</span>(<span class="r5 r">requestDetails</span>.<a href="WSManNativeAPI.cs.html#0e238bf7e1d2305e" class="i property">shutdownNotificationHandle</a>, <b>false</b>); <span class="c">// Owned by WinRM</span>
                    <span class="r19 r">eventWaitHandle</span>.<span class="i">SafeWaitHandle</span> = <span class="r20 r">safeWaitHandle</span>;
                }
                <b>else</b>
                {
                    <span class="c">// On non-windows platforms the shutdown notification is done through a callback instead of a windows event handle.</span>
                    <span class="c">// Register the callback and this will then signal the event. Note, the gch object is deleted in the shell shutdown</span>
                    <span class="c">// notification that will always come in to shut down the operation.</span>
 
                    <span class="i">GCHandle</span> <span id="r21 rd" class="r21 r">gch</span> = <span class="i">GCHandle</span>.<span class="i">Alloc</span>(<span class="r19 r">eventWaitHandle</span>);
                    <span class="i">IntPtr</span> <span id="r22 rd" class="r22 r">p</span> = <span class="i">GCHandle</span>.<span class="i">ToIntPtr</span>(<span class="r21 r">gch</span>);
 
                    <a href="#3331cc0274ebff08" class="i field">wsmanPinvokeStatic</a>.<a href="WSManNativeAPI.cs.html#1105e7684e34030a" class="i method">WSManPluginRegisterShutdownCallback</a>(
                                                           <span class="r5 r">requestDetails</span>.<a href="WSManNativeAPI.cs.html#0bd4e014382d2f95" class="i field">unmanagedHandle</a>,
                                                           <a href="WSManPluginFacade.cs.html#7abe8df412b63829" class="t t">WSManPluginManagedEntryWrapper</a>.<a href="WSManPluginFacade.cs.html#aab6ef72b9224260" class="i field">workerPtrs</a>.<a href="WSManPluginFacade.cs.html#5e02b53c022569f3" class="i property">UnmanagedStruct</a>.<a href="WSManPluginFacade.cs.html#2c388504e25f1d23" class="i field">wsManPluginShutdownCallbackNative</a>,
                                                           <span class="r22 r">p</span>);
                }
 
                <span class="r11 r">mgdShellSession</span>.<a href="WSManPluginShellSession.cs.html#9540fd8b845870f1" class="i field">registeredShutDownWaitHandle</a> = <span class="i">ThreadPool</span>.<span class="i">RegisterWaitForSingleObject</span>(
                                 <span class="r19 r">eventWaitHandle</span>,
                                 <b>new</b> <span class="i">WaitOrTimerCallback</span>(<a href="WSManPluginFacade.cs.html#7abe8df412b63829" class="t t">WSManPluginManagedEntryWrapper</a>.<span class="i">PSPluginOperationShutdownCallback</span>),
                                 <span class="r12 r">context</span>,
                                 -1, <span class="c">// INFINITE</span>
                                 <b>true</b>); <span class="c">// TODO: Do I need to worry not being able to set missing WT_TRANSFER_IMPERSONATION?</span>
                <b>if</b> (<span class="r11 r">mgdShellSession</span>.<a href="WSManPluginShellSession.cs.html#9540fd8b845870f1" class="i field">registeredShutDownWaitHandle</a> == <b>null</b>)
                {
                    <span class="r18 r">isRegisterWaitForSingleObjectSucceeded</span> = <b>false</b>;
                }
            }
 
            <b>if</b> (!<span class="r18 r">isRegisterWaitForSingleObjectSucceeded</span>)
            {
                <span class="r11 r">mgdShellSession</span>.<a href="WSManPluginShellSession.cs.html#8007b003b9ab8eaf" class="i field">registeredShutdownNotification</a> = 0;
                <a href="#23ee55d6d8a367a2" class="t t">WSManPluginInstance</a>.<a href="#27a43fd6d5b8200e" class="i method">ReportWSManOperationComplete</a>(
                    <span class="r5 r">requestDetails</span>,
                    <a href="#a42b50e40ac07da8" class="t t">WSManPluginErrorCodes</a>.<a href="#02606e5208484f85" class="i field">ShutdownRegistrationFailed</a>);
                <a href="#6a2d3534931ddca5" class="i method">DeleteFromActiveShellSessions</a>(<span class="r5 r">requestDetails</span>.<a href="WSManNativeAPI.cs.html#0bd4e014382d2f95" class="i field">unmanagedHandle</a>);
                <b>return</b>;
            }
 
            <b>try</b>
            {
                <b>if</b> (<span class="r13 r">convertedBase64</span> != <b>null</b>)
                {
                    <span class="r11 r">mgdShellSession</span>.<a href="WSManPluginShellSession.cs.html#ddbdec30183374dd" class="i method">SendOneItemToSessionHelper</a>(<span class="r13 r">convertedBase64</span>, <a href="#f1ff81f0faba1926" class="t t">WSManPluginConstants</a>.<a href="#0a1132f3910cae6f" class="i field">SupportedInputStream</a>);
                }
            }
            <b>catch</b> (<span class="i n">System</span>.<span class="i">Exception</span> <span id="r23 rd" class="r23 r">e</span>)
            {
                <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogOperationalError</span>(<a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#4ddb36cebdb0b70c" class="i field">TransportError</a>,
                    <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#a0f7cf0d4987790f" class="i field">Connect</a>, <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>, <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#05d709c2010b41d5" class="i field">UseAlwaysOperational</a>, <a href="../../../../GuidAssembly/R/00000000-0000-0000-0000-000000000000.html" target="n" class="s">&quot;00000000-0000-0000-0000-000000000000&quot;</a>, <a href="../../../../GuidAssembly/R/00000000-0000-0000-0000-000000000000.html" target="n" class="s">&quot;00000000-0000-0000-0000-000000000000&quot;</a>,
                    <span class="i">Convert</span>.<span class="i">ToString</span>(<a href="#a42b50e40ac07da8" class="t t">WSManPluginErrorCodes</a>.<a href="#9884203a81bf3f15" class="i field">ManagedException</a>, <span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>), <span class="r23 r">e</span>.<span class="i">Message</span>, <span class="r23 r">e</span>.<span class="i">StackTrace</span>);
 
                <b>if</b> (<span class="i">Interlocked</span>.<span class="i">Exchange</span>(<b>ref</b> <span class="r11 r">mgdShellSession</span>.<a href="WSManPluginShellSession.cs.html#8007b003b9ab8eaf" class="i field">registeredShutdownNotification</a>, 0) == 1)
                {
                    <span class="c">// unregister callback.. wait for any ongoing callbacks to complete.. nothing much we could do if this fails</span>
                    <b>bool</b> <span id="r24 rd" class="r24 r">ignore</span> = <span class="r11 r">mgdShellSession</span>.<a href="WSManPluginShellSession.cs.html#9540fd8b845870f1" class="i field">registeredShutDownWaitHandle</a>.<span class="i">Unregister</span>(<b>null</b>);
                    <span class="r11 r">mgdShellSession</span>.<a href="WSManPluginShellSession.cs.html#9540fd8b845870f1" class="i field">registeredShutDownWaitHandle</a> = <b>null</b>;
 
                    <span class="c">// this will called OperationComplete</span>
                    <a href="#2103a47783d6d1c5" class="i method">PerformCloseOperation</a>(<span class="r12 r">context</span>);
                }
 
                <b>return</b>;
            }
 
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(
                <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#899f8d8479c02e43" class="i field">ServerCreateRemoteSession</a>,
                <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#a0f7cf0d4987790f" class="i field">Connect</a>,
                <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a59ff5f5d029e4d1" class="i field">ManagedPlugin</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                <span class="r5 r">requestDetails</span>.<span class="i">ToString</span>(),
                <span class="s">&quot;CreateShell: Completed&quot;</span>,
                <b>string</b>.<span class="i">Empty</span>);
 
            <b>return</b>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This gets called on a thread pool thread once Shutdown wait handle is notified.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r25 r">context</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="87be4f0e6c2fbbfb" href="../../../R/87be4f0e6c2fbbfb.html" target="n" data-glyph="74,1" class="i method">CloseShellOperation</a>(
            <a href="#3e5455aa49779e8c" class="t t">WSManPluginOperationShutdownContext</a> <span id="r25 rd" class="r25 r">context</span>)
        {
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(
                <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#b25e65847b8461b6" class="i field">ServerCloseOperation</a>,
                <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#f3d85cb80e62fe3e" class="i field">Disconnect</a>,
                <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a59ff5f5d029e4d1" class="i field">ManagedPlugin</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                ((<span class="i">IntPtr</span>)<span class="r25 r">context</span>.<a href="#d256ac29b2a57375" class="i field">shellContext</a>).<span class="i">ToString</span>(),
                ((<span class="i">IntPtr</span>)<span class="r25 r">context</span>.<a href="#13481c936788e297" class="i field">commandContext</a>).<span class="i">ToString</span>(),
                <span class="r25 r">context</span>.<a href="#11b9cfdb4ecabe88" class="i field">isReceiveOperation</a>.<span class="i">ToString</span>());
 
            <a href="WSManPluginShellSession.cs.html#7345fbb9d90a70e9" class="t t">WSManPluginShellSession</a> <span id="r26 rd" class="r26 r">mgdShellSession</span> = <a href="#679629142f46a807" class="i method">GetFromActiveShellSessions</a>(<span class="r25 r">context</span>.<a href="#d256ac29b2a57375" class="i field">shellContext</a>);
            <b>if</b> (<span class="r26 r">mgdShellSession</span> == <b>null</b>)
            {
                <span class="c">// this should never be the case. this will protect the service.</span>
                <span class="c">// Dbg.Assert(false, &quot;context.shellContext not matched&quot;);</span>
                <b>return</b>;
            }
 
            <span class="c">// update the internal data store only if this is not receive operation.</span>
            <b>if</b> (!<span class="r25 r">context</span>.<a href="#11b9cfdb4ecabe88" class="i field">isReceiveOperation</a>)
            {
                <a href="#6a2d3534931ddca5" class="i method">DeleteFromActiveShellSessions</a>(<span class="r25 r">context</span>.<a href="#d256ac29b2a57375" class="i field">shellContext</a>);
            }
 
            <span class="i n">System</span>.<span class="i">Exception</span> <span id="r27 rd" class="r27 r">reasonForClose</span> = <b>new</b> <span class="i n">System</span>.<span class="i">Exception</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">WSManPluginOperationClose</span>);
            <span class="r26 r">mgdShellSession</span>.<span class="i">CloseOperation</span>(<span class="r25 r">context</span>, <span class="r27 r">reasonForClose</span>);
 
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(
                <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#b25e65847b8461b6" class="i field">ServerCloseOperation</a>,
                <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#f3d85cb80e62fe3e" class="i field">Disconnect</a>,
                <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a59ff5f5d029e4d1" class="i field">ManagedPlugin</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                <span class="s">&quot;CloseShellOperation: Completed&quot;</span>,
                <b>string</b>.<span class="i">Empty</span>);
        }
 
        <b>internal void</b> <a id="fad0f9203aae26e0" href="../../../R/fad0f9203aae26e0.html" target="n" data-glyph="74,1" class="i method">CloseCommandOperation</a>(
            <a href="#3e5455aa49779e8c" class="t t">WSManPluginOperationShutdownContext</a> <span id="r28 rd" class="r28 r">context</span>)
        {
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(
                <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#b25e65847b8461b6" class="i field">ServerCloseOperation</a>,
                <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#f3d85cb80e62fe3e" class="i field">Disconnect</a>,
                <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a59ff5f5d029e4d1" class="i field">ManagedPlugin</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                <span class="r28 r">context</span>.<a href="#d256ac29b2a57375" class="i field">shellContext</a>.<span class="i">ToString</span>(),
                <span class="r28 r">context</span>.<a href="#13481c936788e297" class="i field">commandContext</a>.<span class="i">ToString</span>(),
                <span class="r28 r">context</span>.<a href="#11b9cfdb4ecabe88" class="i field">isReceiveOperation</a>.<span class="i">ToString</span>());
 
            <a href="WSManPluginShellSession.cs.html#7345fbb9d90a70e9" class="t t">WSManPluginShellSession</a> <span id="r29 rd" class="r29 r">mgdShellSession</span> = <a href="#679629142f46a807" class="i method">GetFromActiveShellSessions</a>(<span class="r28 r">context</span>.<a href="#d256ac29b2a57375" class="i field">shellContext</a>);
            <b>if</b> (<span class="r29 r">mgdShellSession</span> == <b>null</b>)
            {
                <span class="c">// this should never be the case. this will protect the service.</span>
                <span class="c">// Dbg.Assert(false, &quot;context.shellContext not matched&quot;);</span>
                <b>return</b>;
            }
 
            <span class="r29 r">mgdShellSession</span>.<a href="WSManPluginShellSession.cs.html#d4f67dd1a0c45553" class="i method">CloseCommandOperation</a>(<span class="r28 r">context</span>);
 
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(
                <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#b25e65847b8461b6" class="i field">ServerCloseOperation</a>,
                <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#f3d85cb80e62fe3e" class="i field">Disconnect</a>,
                <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a59ff5f5d029e4d1" class="i field">ManagedPlugin</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                <span class="s">&quot;CloseCommandOperation: Completed&quot;</span>,
                <b>string</b>.<span class="i">Empty</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Adds shell session to activeShellSessions store and returns the id</span>
        <span class="c">///</span><span class="c"> at which the session is added.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r30 r">newShellSession</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>private void</b> <a id="375a560fb7633e2c" href="../../../R/375a560fb7633e2c.html" target="n" data-glyph="76,1" class="i method">AddToActiveShellSessions</a>(
            <a href="WSManPluginShellSession.cs.html#7345fbb9d90a70e9" class="t t">WSManPluginShellSession</a> <span id="r30 rd" class="r30 r">newShellSession</span>)
        {
            <b>int</b> <span id="r31 rd" class="r31 r">count</span> = -1;
            <b>lock</b> (<a href="#ecabb9ec882c717c" class="i field">_syncObject</a>)
            {
                <span class="i">IntPtr</span> <span id="r32 rd" class="r32 r">key</span> = <span class="r30 r">newShellSession</span>.<a href="WSManPluginShellSession.cs.html#7e624f9f2bb530f2" class="i field">creationRequestDetails</a>.<a href="WSManNativeAPI.cs.html#0bd4e014382d2f95" class="i field">unmanagedHandle</a>;
                <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r32 r">key</span> != <span class="i">IntPtr</span>.<span class="i">Zero</span>, <span class="s">&quot;NULL handles should not be provided&quot;</span>);
 
                <b>if</b> (!<a href="#77f086f1f10e52f8" class="i field">_activeShellSessions</a>.<span class="i">ContainsKey</span>(<span class="r32 r">key</span>))
                {
                    <a href="#77f086f1f10e52f8" class="i field">_activeShellSessions</a>.<span class="i">Add</span>(<span class="r32 r">key</span>, <span class="r30 r">newShellSession</span>);
 
                    <span class="c">// trigger an event outside the lock</span>
                    <span class="r31 r">count</span> = <a href="#77f086f1f10e52f8" class="i field">_activeShellSessions</a>.<span class="i">Count</span>;
                }
            }
 
            <b>if</b> (<span class="r31 r">count</span> != -1)
            {
                <span class="c">// Raise session count changed event</span>
                <a href="../server/WSManChannelEvents.cs.html#a84a5b2aea040993" class="t t">WSManServerChannelEvents</a>.<a href="../server/WSManChannelEvents.cs.html#95424c919fa4fe1c" class="i method">RaiseActiveSessionsChangedEvent</a>(<b>new</b> <a href="../server/WSManChannelEvents.cs.html#c104d47895f2c575" class="t constructor">ActiveSessionsChangedEventArgs</a>(<span class="r31 r">count</span>));
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Retrieves a WSManPluginShellSession if matched.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r33 r">key</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Shell context (WSManPluginRequest.unmanagedHandle).</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">Null WSManPluginShellSession if not matched. The object if matched.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>private</b> <a href="WSManPluginShellSession.cs.html#7345fbb9d90a70e9" class="t t">WSManPluginShellSession</a> <a id="679629142f46a807" href="../../../R/679629142f46a807.html" target="n" data-glyph="76,1" class="i method">GetFromActiveShellSessions</a>(
            <span class="i">IntPtr</span> <span id="r33 rd" class="r33 r">key</span>)
        {
            <b>lock</b> (<a href="#ecabb9ec882c717c" class="i field">_syncObject</a>)
            {
                <a href="WSManPluginShellSession.cs.html#7345fbb9d90a70e9" class="t t">WSManPluginShellSession</a> <span id="r34 rd" class="r34 r">result</span>;
                <a href="#77f086f1f10e52f8" class="i field">_activeShellSessions</a>.<span class="i">TryGetValue</span>(<span class="r33 r">key</span>, <b>out</b> <span class="r34 r">result</span>);
                <b>return</b> <span class="r34 r">result</span>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Removes a WSManPluginShellSession from tracking.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r35 r">keyToDelete</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">IntPtr of a WSManPluginRequest structure.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>private void</b> <a id="6a2d3534931ddca5" href="../../../R/6a2d3534931ddca5.html" target="n" data-glyph="76,1" class="i method">DeleteFromActiveShellSessions</a>(
            <span class="i">IntPtr</span> <span id="r35 rd" class="r35 r">keyToDelete</span>)
        {
            <b>int</b> <span id="r36 rd" class="r36 r">count</span> = -1;
            <b>lock</b> (<a href="#ecabb9ec882c717c" class="i field">_syncObject</a>)
            {
                <b>if</b> (<a href="#77f086f1f10e52f8" class="i field">_activeShellSessions</a>.<span class="i">Remove</span>(<span class="r35 r">keyToDelete</span>))
                {
                    <span class="c">// trigger an event outside the lock</span>
                    <span class="r36 r">count</span> = <a href="#77f086f1f10e52f8" class="i field">_activeShellSessions</a>.<span class="i">Count</span>;
                }
            }
 
            <b>if</b> (<span class="r36 r">count</span> != -1)
            {
                <span class="c">// Raise session count changed event</span>
                <a href="../server/WSManChannelEvents.cs.html#a84a5b2aea040993" class="t t">WSManServerChannelEvents</a>.<a href="../server/WSManChannelEvents.cs.html#95424c919fa4fe1c" class="i method">RaiseActiveSessionsChangedEvent</a>(<b>new</b> <a href="../server/WSManChannelEvents.cs.html#c104d47895f2c575" class="t constructor">ActiveSessionsChangedEventArgs</a>(<span class="r36 r">count</span>));
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Triggers a shell close from an event handler.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r37 r">source</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Shell context.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r38 r">e</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>private void</b> <a id="1796ff7578dd9a8f" href="../../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">HandleShellSessionClosed</a>(
            <b>object</b> <span id="r37 rd" class="r37 r">source</span>,
            <span class="i">EventArgs</span> <span id="r38 rd" class="r38 r">e</span>)
        {
            <a href="#6a2d3534931ddca5" class="i method">DeleteFromActiveShellSessions</a>((<span class="i">IntPtr</span>)<span class="r37 r">source</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Helper function to validate incoming values.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r39 r">requestDetails</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r40 r">shellContext</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r41 r">inputFunctionName</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>private static bool</b> <a id="997362670c9d4a38" href="../../../R/997362670c9d4a38.html" target="n" data-glyph="76,1" class="i method">validateIncomingContexts</a>(
            <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#07d21d2cee8c9d82" class="t t">WSManPluginRequest</a> <span id="r39 rd" class="r39 r">requestDetails</span>,
            <span class="i">IntPtr</span> <span id="r40 rd" class="r40 r">shellContext</span>,
            <b>string</b> <span id="r41 rd" class="r41 r">inputFunctionName</span>)
        {
            <b>if</b> (<span class="r39 r">requestDetails</span> == <b>null</b>)
            {
                <span class="c">// Nothing can be done because requestDetails are required to report operation complete</span>
                <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(
                    <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#ace81b72cf5e0c44" class="i field">ReportOperationComplete</a>,
                    <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#7bf2b73f1de59d2e" class="i field">Close</a>, <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                    <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a59ff5f5d029e4d1" class="i field">ManagedPlugin</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                    <span class="s">&quot;null&quot;</span>,
                    <span class="i">Convert</span>.<span class="i">ToString</span>(<a href="#a42b50e40ac07da8" class="t t">WSManPluginErrorCodes</a>.<a href="#9e60ead84c49e935" class="i field">NullInvalidInput</a>, <span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>),
                    <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(
                        <span class="i">RemotingErrorIdStrings</span>.<span class="i">WSManPluginNullInvalidInput</span>,
                        <span class="s">&quot;requestDetails&quot;</span>,
                        <span class="r41 r">inputFunctionName</span>),
                    <b>string</b>.<span class="i">Empty</span>);
                <b>return</b> <b>false</b>;
            }
 
            <b>if</b> (<span class="r40 r">shellContext</span> == <span class="i">IntPtr</span>.<span class="i">Zero</span>)
            {
                <a href="#34bada9077aac474" class="i method">ReportOperationComplete</a>(
                    <span class="r39 r">requestDetails</span>,
                    <a href="#a42b50e40ac07da8" class="t t">WSManPluginErrorCodes</a>.<a href="#583a37088b02d6e7" class="i field">NullShellContext</a>,
                    <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(
                        <span class="i">RemotingErrorIdStrings</span>.<span class="i">WSManPluginNullShellContext</span>,
                        <span class="s">&quot;ShellContext&quot;</span>,
                        <span class="r41 r">inputFunctionName</span>));
                <b>return</b> <b>false</b>;
            }
 
            <b>return</b> <b>true</b>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Create a new command in the shell context.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r42 r">pluginContext</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r43 r">requestDetails</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r44 r">flags</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r45 r">shellContext</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r46 r">commandLine</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r47 r">arguments</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="e0a49fce578693e6" href="../../../R/e0a49fce578693e6.html" target="n" data-glyph="74,1" class="i method">CreateCommand</a>(
            <span class="i">IntPtr</span> <span id="r42 rd" class="r42 r">pluginContext</span>,
            <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#07d21d2cee8c9d82" class="t t">WSManPluginRequest</a> <span id="r43 rd" class="r43 r">requestDetails</span>,
            <b>int</b> <span id="r44 rd" class="r44 r">flags</span>,
            <span class="i">IntPtr</span> <span id="r45 rd" class="r45 r">shellContext</span>,
            <b>string</b> <span id="r46 rd" class="r46 r">commandLine</span>,
            <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#65e6a5b9a30e36c9" class="t t">WSManCommandArgSet</a> <span id="r47 rd" class="r47 r">arguments</span>)
        {
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(
                <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#b26e4f2cd139e681" class="i field">ServerCreateCommandSession</a>,
                <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#a0f7cf0d4987790f" class="i field">Connect</a>,
                <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a59ff5f5d029e4d1" class="i field">ManagedPlugin</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                <b>string</b>.<span class="i">Empty</span>,
                <span class="s">&quot;CreateCommand: Create a new command in the shell context&quot;</span>,
                <b>string</b>.<span class="i">Empty</span>);
 
            <b>if</b> (!<a href="#997362670c9d4a38" class="i method">validateIncomingContexts</a>(<span class="r43 r">requestDetails</span>, <span class="r45 r">shellContext</span>, <span class="s">&quot;WSManRunShellCommandEx&quot;</span>))
            {
                <b>return</b>;
            }
 
            <a href="#cafbb195850f1ca3" class="i method">SetThreadProperties</a>(<span class="r43 r">requestDetails</span>);
 
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(
                <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#b26e4f2cd139e681" class="i field">ServerCreateCommandSession</a>,
                <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#a0f7cf0d4987790f" class="i field">Connect</a>, <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a59ff5f5d029e4d1" class="i field">ManagedPlugin</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                ((<span class="i">IntPtr</span>)<span class="r45 r">shellContext</span>).<span class="i">ToString</span>(), <span class="r43 r">requestDetails</span>.<span class="i">ToString</span>());
 
            <a href="WSManPluginShellSession.cs.html#7345fbb9d90a70e9" class="t t">WSManPluginShellSession</a> <span id="r48 rd" class="r48 r">mgdShellSession</span> = <a href="#679629142f46a807" class="i method">GetFromActiveShellSessions</a>(<span class="r45 r">shellContext</span>);
            <b>if</b> (<span class="r48 r">mgdShellSession</span> == <b>null</b>)
            {
                <a href="#34bada9077aac474" class="i method">ReportOperationComplete</a>(
                    <span class="r43 r">requestDetails</span>,
                    <a href="#a42b50e40ac07da8" class="t t">WSManPluginErrorCodes</a>.<a href="#71fab73a96d676a6" class="i field">InvalidShellContext</a>,
                    <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(
                        <span class="i">RemotingErrorIdStrings</span>.<span class="i">WSManPluginInvalidShellContext</span>));
                <b>return</b>;
            }
 
            <span class="r48 r">mgdShellSession</span>.<a href="WSManPluginShellSession.cs.html#c09a89df8df0a91d" class="i method">CreateCommand</a>(<span class="r42 r">pluginContext</span>, <span class="r43 r">requestDetails</span>, <span class="r44 r">flags</span>, <span class="r46 r">commandLine</span>, <span class="r47 r">arguments</span>);
 
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(
                <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#b26e4f2cd139e681" class="i field">ServerCreateCommandSession</a>,
                <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#a0f7cf0d4987790f" class="i field">Connect</a>,
                <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a59ff5f5d029e4d1" class="i field">ManagedPlugin</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                <b>string</b>.<span class="i">Empty</span>,
                <span class="s">&quot;CreateCommand: Create a new command in the shell context completed&quot;</span>,
                <b>string</b>.<span class="i">Empty</span>);
        }
 
        <b>internal void</b> <a id="9d17aab9b2b586d1" href="../../../R/9d17aab9b2b586d1.html" target="n" data-glyph="74,1" class="i method">StopCommand</a>(
            <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#07d21d2cee8c9d82" class="t t">WSManPluginRequest</a> <span id="r49 rd" class="r49 r">requestDetails</span>,
            <span class="i">IntPtr</span> <span id="r50 rd" class="r50 r">shellContext</span>,
            <span class="i">IntPtr</span> <span id="r51 rd" class="r51 r">commandContext</span>)
        {
            <b>if</b> (<span class="r49 r">requestDetails</span> == <b>null</b>)
            {
                <span class="c">// Nothing can be done because requestDetails are required to report operation complete</span>
                <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(
                    <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#ace81b72cf5e0c44" class="i field">ReportOperationComplete</a>,
                    <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#7bf2b73f1de59d2e" class="i field">Close</a>, <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                    <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a59ff5f5d029e4d1" class="i field">ManagedPlugin</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                    <span class="s">&quot;null&quot;</span>,
                    <span class="i">Convert</span>.<span class="i">ToString</span>(<a href="#a42b50e40ac07da8" class="t t">WSManPluginErrorCodes</a>.<a href="#9e60ead84c49e935" class="i field">NullInvalidInput</a>, <span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>),
                    <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(
                        <span class="i">RemotingErrorIdStrings</span>.<span class="i">WSManPluginNullInvalidInput</span>,
                        <span class="s">&quot;requestDetails&quot;</span>,
                        <span class="s">&quot;StopCommand&quot;</span>),
                    <b>string</b>.<span class="i">Empty</span>);
                <b>return</b>;
            }
 
            <a href="#cafbb195850f1ca3" class="i method">SetThreadProperties</a>(<span class="r49 r">requestDetails</span>);
 
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(
                <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#d59b4b549543cfef" class="i field">ServerStopCommand</a>,
                <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#f3d85cb80e62fe3e" class="i field">Disconnect</a>,
                <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a59ff5f5d029e4d1" class="i field">ManagedPlugin</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                ((<span class="i">IntPtr</span>)<span class="r50 r">shellContext</span>).<span class="i">ToString</span>(),
                ((<span class="i">IntPtr</span>)<span class="r51 r">commandContext</span>).<span class="i">ToString</span>(),
                <span class="r49 r">requestDetails</span>.<span class="i">ToString</span>());
 
            <a href="WSManPluginShellSession.cs.html#7345fbb9d90a70e9" class="t t">WSManPluginShellSession</a> <span id="r52 rd" class="r52 r">mgdShellSession</span> = <a href="#679629142f46a807" class="i method">GetFromActiveShellSessions</a>(<span class="r50 r">shellContext</span>);
            <b>if</b> (<span class="r52 r">mgdShellSession</span> == <b>null</b>)
            {
                <a href="#34bada9077aac474" class="i method">ReportOperationComplete</a>(
                    <span class="r49 r">requestDetails</span>,
                    <a href="#a42b50e40ac07da8" class="t t">WSManPluginErrorCodes</a>.<a href="#71fab73a96d676a6" class="i field">InvalidShellContext</a>,
                    <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(
                        <span class="i">RemotingErrorIdStrings</span>.<span class="i">WSManPluginInvalidShellContext</span>));
                <b>return</b>;
            }
 
            <a href="WSManPluginShellSession.cs.html#2f027a01381ecdba" class="t t">WSManPluginCommandSession</a> <span id="r53 rd" class="r53 r">mgdCommandSession</span> = <span class="r52 r">mgdShellSession</span>.<a href="WSManPluginShellSession.cs.html#04dbcf172e05dbc0" class="i method">GetCommandSession</a>(<span class="r51 r">commandContext</span>);
            <b>if</b> (<span class="r53 r">mgdCommandSession</span> == <b>null</b>)
            {
                <a href="#34bada9077aac474" class="i method">ReportOperationComplete</a>(
                    <span class="r49 r">requestDetails</span>,
                    <a href="#a42b50e40ac07da8" class="t t">WSManPluginErrorCodes</a>.<a href="#c32d1ab79ca253fc" class="i field">InvalidCommandContext</a>,
                    <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(
                        <span class="i">RemotingErrorIdStrings</span>.<span class="i">WSManPluginInvalidCommandContext</span>));
                <b>return</b>;
            }
 
            <span class="r53 r">mgdCommandSession</span>.<a href="WSManPluginShellSession.cs.html#7186fe1f7ac78f9c" class="i method">Stop</a>(<span class="r49 r">requestDetails</span>);
 
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(
                <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#d59b4b549543cfef" class="i field">ServerStopCommand</a>,
                <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#f3d85cb80e62fe3e" class="i field">Disconnect</a>,
                <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a59ff5f5d029e4d1" class="i field">ManagedPlugin</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                <span class="s">&quot;StopCommand: completed&quot;</span>,
                <b>string</b>.<span class="i">Empty</span>);
        }
 
        <b>internal void</b> <a id="5b310a9ed9de377c" href="../../../R/5b310a9ed9de377c.html" target="n" data-glyph="74,1" class="i method">Shutdown</a>()
        {
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<a href="../../../utils/tracing/PSEtwLog.cs.html#bd7ee9e01b1b8117" class="i method">LogAnalyticInformational</a>(
                <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#85a9e2ff70f2ace0" class="i field">WSManPluginShutdown</a>,
                <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#33e54f04efdd640c" class="i field">ShuttingDown</a>, <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a59ff5f5d029e4d1" class="i field">ManagedPlugin</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>);
 
            <span class="c">// all active shells should be closed at this point</span>
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<a href="#77f086f1f10e52f8" class="i field">_activeShellSessions</a>.<span class="i">Count</span> == 0, <span class="s">&quot;All active shells should be closed&quot;</span>);
 
            <span class="c">// raise shutting down notification</span>
            <a href="../server/WSManChannelEvents.cs.html#a84a5b2aea040993" class="t t">WSManServerChannelEvents</a>.<a href="../server/WSManChannelEvents.cs.html#63bd245b4ebf750d" class="i method">RaiseShuttingDownEvent</a>();
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Connect.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r54 r">requestDetails</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r55 r">flags</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r56 r">shellContext</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r57 r">commandContext</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r58 r">inboundConnectInformation</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="eb515c87e550b606" href="../../../R/eb515c87e550b606.html" target="n" data-glyph="74,1" class="i method">ConnectShellOrCommand</a>(
            <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#07d21d2cee8c9d82" class="t t">WSManPluginRequest</a> <span id="r54 rd" class="r54 r">requestDetails</span>,
            <b>int</b> <span id="r55 rd" class="r55 r">flags</span>,
            <span class="i">IntPtr</span> <span id="r56 rd" class="r56 r">shellContext</span>,
            <span class="i">IntPtr</span> <span id="r57 rd" class="r57 r">commandContext</span>,
            <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#456a9677b88cb3ef" class="t t">WSManData_UnToMan</a> <span id="r58 rd" class="r58 r">inboundConnectInformation</span>)
        {
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(
                <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#97a04fcf34529508" class="i field">ServerReceivedData</a>,
                <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#a0f7cf0d4987790f" class="i field">Connect</a>,
                <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a59ff5f5d029e4d1" class="i field">ManagedPlugin</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                <b>string</b>.<span class="i">Empty</span>,
                <span class="s">&quot;ConnectShellOrCommand: Connect&quot;</span>,
                <b>string</b>.<span class="i">Empty</span>);
 
            <b>if</b> (!<a href="#997362670c9d4a38" class="i method">validateIncomingContexts</a>(<span class="r54 r">requestDetails</span>, <span class="r56 r">shellContext</span>, <span class="s">&quot;ConnectShellOrCommand&quot;</span>))
            {
                <b>return</b>;
            }
 
            <span class="c">// TODO... What does this mean from a new client that has specified diff locale from original client?</span>
            <a href="#cafbb195850f1ca3" class="i method">SetThreadProperties</a>(<span class="r54 r">requestDetails</span>);
 
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(
                <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#97a04fcf34529508" class="i field">ServerReceivedData</a>,
                <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#a0f7cf0d4987790f" class="i field">Connect</a>,
                <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a59ff5f5d029e4d1" class="i field">ManagedPlugin</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                ((<span class="i">IntPtr</span>)<span class="r56 r">shellContext</span>).<span class="i">ToString</span>(),
                ((<span class="i">IntPtr</span>)<span class="r57 r">commandContext</span>).<span class="i">ToString</span>(),
                <span class="r54 r">requestDetails</span>.<span class="i">ToString</span>());
 
            <a href="WSManPluginShellSession.cs.html#7345fbb9d90a70e9" class="t t">WSManPluginShellSession</a> <span id="r59 rd" class="r59 r">mgdShellSession</span> = <a href="#679629142f46a807" class="i method">GetFromActiveShellSessions</a>(<span class="r56 r">shellContext</span>);
            <b>if</b> (<span class="r59 r">mgdShellSession</span> == <b>null</b>)
            {
                <a href="#34bada9077aac474" class="i method">ReportOperationComplete</a>(
                    <span class="r54 r">requestDetails</span>,
                    <a href="#a42b50e40ac07da8" class="t t">WSManPluginErrorCodes</a>.<a href="#71fab73a96d676a6" class="i field">InvalidShellContext</a>,
                    <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(
                        <span class="i">RemotingErrorIdStrings</span>.<span class="i">WSManPluginInvalidShellContext</span>));
                <b>return</b>;
            }
 
            <b>if</b> (<span class="r57 r">commandContext</span> == <span class="i">IntPtr</span>.<span class="i">Zero</span>)
            {
                <span class="r59 r">mgdShellSession</span>.<a href="WSManPluginShellSession.cs.html#2365ed343ddae591" class="i method">ExecuteConnect</a>(<span class="r54 r">requestDetails</span>, <span class="r55 r">flags</span>, <span class="r58 r">inboundConnectInformation</span>);
                <b>return</b>;
            }
 
            <span class="c">// this connect is on a command</span>
            <a href="WSManPluginShellSession.cs.html#2f027a01381ecdba" class="t t">WSManPluginCommandSession</a> <span id="r60 rd" class="r60 r">mgdCmdSession</span> = <span class="r59 r">mgdShellSession</span>.<a href="WSManPluginShellSession.cs.html#04dbcf172e05dbc0" class="i method">GetCommandSession</a>(<span class="r57 r">commandContext</span>);
            <b>if</b> (<span class="r60 r">mgdCmdSession</span> == <b>null</b>)
            {
                <a href="#34bada9077aac474" class="i method">ReportOperationComplete</a>(
                    <span class="r54 r">requestDetails</span>,
                    <a href="#a42b50e40ac07da8" class="t t">WSManPluginErrorCodes</a>.<a href="#c32d1ab79ca253fc" class="i field">InvalidCommandContext</a>,
                    <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(
                        <span class="i">RemotingErrorIdStrings</span>.<span class="i">WSManPluginInvalidCommandContext</span>));
                <b>return</b>;
            }
 
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(
                <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#97a04fcf34529508" class="i field">ServerReceivedData</a>,
                <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#a0f7cf0d4987790f" class="i field">Connect</a>,
                <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a59ff5f5d029e4d1" class="i field">ManagedPlugin</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                ((<span class="i">IntPtr</span>)<span class="r56 r">shellContext</span>).<span class="i">ToString</span>(),
                ((<span class="i">IntPtr</span>)<span class="r57 r">commandContext</span>).<span class="i">ToString</span>(),
                <span class="r54 r">requestDetails</span>.<span class="i">ToString</span>());
 
            <span class="r60 r">mgdCmdSession</span>.<a href="WSManPluginShellSession.cs.html#3efe54ba0ae3d86d" class="i method">ExecuteConnect</a>(<span class="r54 r">requestDetails</span>, <span class="r55 r">flags</span>, <span class="r58 r">inboundConnectInformation</span>);
 
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(
                <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#97a04fcf34529508" class="i field">ServerReceivedData</a>,
                <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#a0f7cf0d4987790f" class="i field">Connect</a>,
                <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a59ff5f5d029e4d1" class="i field">ManagedPlugin</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                <b>string</b>.<span class="i">Empty</span>,
                <span class="s">&quot;ConnectShellOrCommand: ExecuteConnect invoked&quot;</span>,
                <b>string</b>.<span class="i">Empty</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Send data to the shell / command specified.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r61 r">requestDetails</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r62 r">flags</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r63 r">shellContext</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r64 r">commandContext</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r65 r">stream</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r66 r">inboundData</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="3ec9bc371f514c24" href="../../../R/3ec9bc371f514c24.html" target="n" data-glyph="74,1" class="i method">SendOneItemToShellOrCommand</a>(
            <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#07d21d2cee8c9d82" class="t t">WSManPluginRequest</a> <span id="r61 rd" class="r61 r">requestDetails</span>,
            <b>int</b> <span id="r62 rd" class="r62 r">flags</span>,
            <span class="i">IntPtr</span> <span id="r63 rd" class="r63 r">shellContext</span>,
            <span class="i">IntPtr</span> <span id="r64 rd" class="r64 r">commandContext</span>,
            <b>string</b> <span id="r65 rd" class="r65 r">stream</span>,
            <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#456a9677b88cb3ef" class="t t">WSManData_UnToMan</a> <span id="r66 rd" class="r66 r">inboundData</span>)
        {
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(
                <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#97a04fcf34529508" class="i field">ServerReceivedData</a>,
                <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#399fd86ea109ec79" class="i field">Open</a>,
                <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a59ff5f5d029e4d1" class="i field">ManagedPlugin</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                <b>string</b>.<span class="i">Empty</span>,
                <span class="s">&quot;SendOneItemToShellOrCommand: Send data to the shell / command specified&quot;</span>,
                <b>string</b>.<span class="i">Empty</span>);
 
            <b>if</b> (!<a href="#997362670c9d4a38" class="i method">validateIncomingContexts</a>(<span class="r61 r">requestDetails</span>, <span class="r63 r">shellContext</span>, <span class="s">&quot;SendOneItemToShellOrCommand&quot;</span>))
            {
                <b>return</b>;
            }
 
            <a href="#cafbb195850f1ca3" class="i method">SetThreadProperties</a>(<span class="r61 r">requestDetails</span>);
 
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(
                <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#97a04fcf34529508" class="i field">ServerReceivedData</a>,
                <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#399fd86ea109ec79" class="i field">Open</a>,
                <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a59ff5f5d029e4d1" class="i field">ManagedPlugin</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                ((<span class="i">IntPtr</span>)<span class="r63 r">shellContext</span>).<span class="i">ToString</span>(),
                ((<span class="i">IntPtr</span>)<span class="r64 r">commandContext</span>).<span class="i">ToString</span>(),
                <span class="r61 r">requestDetails</span>.<span class="i">ToString</span>());
 
            <a href="WSManPluginShellSession.cs.html#7345fbb9d90a70e9" class="t t">WSManPluginShellSession</a> <span id="r67 rd" class="r67 r">mgdShellSession</span> = <a href="#679629142f46a807" class="i method">GetFromActiveShellSessions</a>(<span class="r63 r">shellContext</span>);
            <b>if</b> (<span class="r67 r">mgdShellSession</span> == <b>null</b>)
            {
                <a href="#34bada9077aac474" class="i method">ReportOperationComplete</a>(
                    <span class="r61 r">requestDetails</span>,
                    <a href="#a42b50e40ac07da8" class="t t">WSManPluginErrorCodes</a>.<a href="#71fab73a96d676a6" class="i field">InvalidShellContext</a>,
                    <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(
                        <span class="i">RemotingErrorIdStrings</span>.<span class="i">WSManPluginInvalidShellContext</span>)
                    );
                <b>return</b>;
            }
 
            <b>if</b> (<span class="r64 r">commandContext</span> == <span class="i">IntPtr</span>.<span class="i">Zero</span>)
            {
                <span class="c">// the data is destined for shell (runspace) session. so let shell handle it</span>
                <span class="r67 r">mgdShellSession</span>.<a href="WSManPluginShellSession.cs.html#f8d09185e76e55b0" class="i method">SendOneItemToSession</a>(<span class="r61 r">requestDetails</span>, <span class="r62 r">flags</span>, <span class="r65 r">stream</span>, <span class="r66 r">inboundData</span>);
                <b>return</b>;
            }
 
            <span class="c">// the data is destined for command.</span>
            <a href="WSManPluginShellSession.cs.html#2f027a01381ecdba" class="t t">WSManPluginCommandSession</a> <span id="r68 rd" class="r68 r">mgdCmdSession</span> = <span class="r67 r">mgdShellSession</span>.<a href="WSManPluginShellSession.cs.html#04dbcf172e05dbc0" class="i method">GetCommandSession</a>(<span class="r64 r">commandContext</span>);
            <b>if</b> (<span class="r68 r">mgdCmdSession</span> == <b>null</b>)
            {
                <a href="#34bada9077aac474" class="i method">ReportOperationComplete</a>(
                    <span class="r61 r">requestDetails</span>,
                    <a href="#a42b50e40ac07da8" class="t t">WSManPluginErrorCodes</a>.<a href="#c32d1ab79ca253fc" class="i field">InvalidCommandContext</a>,
                    <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(
                        <span class="i">RemotingErrorIdStrings</span>.<span class="i">WSManPluginInvalidCommandContext</span>));
                <b>return</b>;
            }
 
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(
                <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#97a04fcf34529508" class="i field">ServerReceivedData</a>,
                <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#399fd86ea109ec79" class="i field">Open</a>,
                <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a59ff5f5d029e4d1" class="i field">ManagedPlugin</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                ((<span class="i">IntPtr</span>)<span class="r63 r">shellContext</span>).<span class="i">ToString</span>(),
                ((<span class="i">IntPtr</span>)<span class="r64 r">commandContext</span>).<span class="i">ToString</span>(),
                <span class="r61 r">requestDetails</span>.<span class="i">ToString</span>());
 
            <span class="r68 r">mgdCmdSession</span>.<a href="WSManPluginShellSession.cs.html#f8d09185e76e55b0" class="i method">SendOneItemToSession</a>(<span class="r61 r">requestDetails</span>, <span class="r62 r">flags</span>, <span class="r65 r">stream</span>, <span class="r66 r">inboundData</span>);
 
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(
                <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#97a04fcf34529508" class="i field">ServerReceivedData</a>,
                <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#399fd86ea109ec79" class="i field">Open</a>,
                <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a59ff5f5d029e4d1" class="i field">ManagedPlugin</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                <b>string</b>.<span class="i">Empty</span>,
                <span class="s">&quot;SendOneItemToShellOrCommand: SendOneItemToSession invoked&quot;</span>,
                <b>string</b>.<span class="i">Empty</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Unlock the shell / command specified so that the shell / command</span>
        <span class="c">///</span><span class="c"> starts sending data to the client.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r69 r">pluginContext</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r70 r">requestDetails</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r71 r">flags</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r72 r">shellContext</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r73 r">commandContext</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r74 r">streamSet</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="9bb2a20db2bd7792" href="../../../R/9bb2a20db2bd7792.html" target="n" data-glyph="74,1" class="i method">EnableShellOrCommandToSendDataToClient</a>(
            <span class="i">IntPtr</span> <span id="r69 rd" class="r69 r">pluginContext</span>,
            <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#07d21d2cee8c9d82" class="t t">WSManPluginRequest</a> <span id="r70 rd" class="r70 r">requestDetails</span>,
            <b>int</b> <span id="r71 rd" class="r71 r">flags</span>,
            <span class="i">IntPtr</span> <span id="r72 rd" class="r72 r">shellContext</span>,
            <span class="i">IntPtr</span> <span id="r73 rd" class="r73 r">commandContext</span>,
            <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#7ff909a68a591c73" class="t t">WSManStreamIDSet_UnToMan</a> <span id="r74 rd" class="r74 r">streamSet</span>)
        {
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(
                <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#ec52d48fc47a3ab0" class="i field">ServerClientReceiveRequest</a>,
                <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#399fd86ea109ec79" class="i field">Open</a>,
                <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a59ff5f5d029e4d1" class="i field">ManagedPlugin</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                <b>string</b>.<span class="i">Empty</span>,
                <span class="s">&quot;EnableShellOrCommandToSendDataToClient: unlock the shell / command specified so that the shell / command starts sending data to the client.&quot;</span>,
                <b>string</b>.<span class="i">Empty</span>);
 
            <b>if</b> (!<a href="#997362670c9d4a38" class="i method">validateIncomingContexts</a>(<span class="r70 r">requestDetails</span>, <span class="r72 r">shellContext</span>, <span class="s">&quot;EnableShellOrCommandToSendDataToClient&quot;</span>))
            {
                <b>return</b>;
            }
 
            <a href="#cafbb195850f1ca3" class="i method">SetThreadProperties</a>(<span class="r70 r">requestDetails</span>);
 
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(
                <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#ec52d48fc47a3ab0" class="i field">ServerClientReceiveRequest</a>,
                <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#399fd86ea109ec79" class="i field">Open</a>,
                <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a59ff5f5d029e4d1" class="i field">ManagedPlugin</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                ((<span class="i">IntPtr</span>)<span class="r72 r">shellContext</span>).<span class="i">ToString</span>(),
                ((<span class="i">IntPtr</span>)<span class="r73 r">commandContext</span>).<span class="i">ToString</span>(),
                <span class="r70 r">requestDetails</span>.<span class="i">ToString</span>());
 
            <a href="WSManPluginShellSession.cs.html#7345fbb9d90a70e9" class="t t">WSManPluginShellSession</a> <span id="r75 rd" class="r75 r">mgdShellSession</span> = <a href="#679629142f46a807" class="i method">GetFromActiveShellSessions</a>(<span class="r72 r">shellContext</span>);
            <b>if</b> (<span class="r75 r">mgdShellSession</span> == <b>null</b>)
            {
                <a href="#34bada9077aac474" class="i method">ReportOperationComplete</a>(
                    <span class="r70 r">requestDetails</span>,
                    <a href="#a42b50e40ac07da8" class="t t">WSManPluginErrorCodes</a>.<a href="#71fab73a96d676a6" class="i field">InvalidShellContext</a>,
                    <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(
                        <span class="i">RemotingErrorIdStrings</span>.<span class="i">WSManPluginInvalidShellContext</span>)
                    );
                <b>return</b>;
            }
 
            <a href="#3e5455aa49779e8c" class="t t">WSManPluginOperationShutdownContext</a> <span id="r76 rd" class="r76 r">ctxtToReport</span> = <b>new</b> <span class="t">WSManPluginOperationShutdownContext</span>(<span class="r69 r">pluginContext</span>, <span class="r72 r">shellContext</span>, <span class="i">IntPtr</span>.<span class="i">Zero</span>, <b>true</b>);
            <b>if</b> (<span class="r76 r">ctxtToReport</span> == <b>null</b>)
            {
                <a href="#c8d0e78b633d4f66" class="i method">ReportOperationComplete</a>(<span class="r70 r">requestDetails</span>, <a href="#a42b50e40ac07da8" class="t t">WSManPluginErrorCodes</a>.<a href="#b22ffa6e6f8f45d5" class="i field">OutOfMemory</a>);
                <b>return</b>;
            }
 
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(
                <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#ec52d48fc47a3ab0" class="i field">ServerClientReceiveRequest</a>,
                <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#399fd86ea109ec79" class="i field">Open</a>,
                <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a59ff5f5d029e4d1" class="i field">ManagedPlugin</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                <b>string</b>.<span class="i">Empty</span>,
                <span class="s">&quot;EnableShellOrCommandToSendDataToClient: Instruction destined to shell or for command&quot;</span>,
                <b>string</b>.<span class="i">Empty</span>);
 
            <b>if</b> (<span class="r73 r">commandContext</span> == <span class="i">IntPtr</span>.<span class="i">Zero</span>)
            {
                <span class="c">// the instruction is destined for shell (runspace) session. so let shell handle it</span>
                <b>if</b> (<span class="r75 r">mgdShellSession</span>.<a href="WSManPluginShellSession.cs.html#2058790b443d813b" class="i method">EnableSessionToSendDataToClient</a>(<span class="r70 r">requestDetails</span>, <span class="r71 r">flags</span>, <span class="r74 r">streamSet</span>, <span class="r76 r">ctxtToReport</span>))
                {
                    <b>return</b>;
                }
            }
            <b>else</b>
            {
                <span class="c">// the instruction is destined for command</span>
                <span class="r76 r">ctxtToReport</span>.<a href="#13481c936788e297" class="i field">commandContext</a> = <span class="r73 r">commandContext</span>;
                <a href="WSManPluginShellSession.cs.html#2f027a01381ecdba" class="t t">WSManPluginCommandSession</a> <span id="r77 rd" class="r77 r">mgdCmdSession</span> = <span class="r75 r">mgdShellSession</span>.<a href="WSManPluginShellSession.cs.html#04dbcf172e05dbc0" class="i method">GetCommandSession</a>(<span class="r73 r">commandContext</span>);
 
                <b>if</b> (<span class="r77 r">mgdCmdSession</span> == <b>null</b>)
                {
                    <a href="#34bada9077aac474" class="i method">ReportOperationComplete</a>(
                        <span class="r70 r">requestDetails</span>,
                        <a href="#a42b50e40ac07da8" class="t t">WSManPluginErrorCodes</a>.<a href="#c32d1ab79ca253fc" class="i field">InvalidCommandContext</a>,
                        <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(
                            <span class="i">RemotingErrorIdStrings</span>.<span class="i">WSManPluginInvalidCommandContext</span>));
                    <b>return</b>;
                }
 
                <b>if</b> (<span class="r77 r">mgdCmdSession</span>.<a href="WSManPluginShellSession.cs.html#2058790b443d813b" class="i method">EnableSessionToSendDataToClient</a>(<span class="r70 r">requestDetails</span>, <span class="r71 r">flags</span>, <span class="r74 r">streamSet</span>, <span class="r76 r">ctxtToReport</span>))
                {
                    <b>return</b>;
                }
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Used to create PSPrincipal object from senderDetails struct.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r78 r">senderDetails</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>private static</b> <a href="PSPrincipal.cs.html#eeedcf9113508cb9" class="t t">PSSenderInfo</a> <a id="8c9dce77f7e4596c" href="../../../R/8c9dce77f7e4596c.html" target="n" data-glyph="76,1" class="i method">GetPSSenderInfo</a>(
            <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#8148734a21006dcf" class="t t">WSManSenderDetails</a> <span id="r78 rd" class="r78 r">senderDetails</span>)
        {
            <span class="c">// senderDetails will not be null.</span>
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r78 r">senderDetails</span> != <b>null</b>, <span class="s">&quot;senderDetails cannot be null&quot;</span>);
 
            <span class="c">// Construct PSIdentity</span>
            <a href="PSPrincipal.cs.html#51c78fc6fd1d052d" class="t t">PSCertificateDetails</a> <span id="r79 rd" class="r79 r">psCertDetails</span> = <b>null</b>;
            <span class="c">// Construct Certificate Details</span>
            <b>if</b> (<span class="r78 r">senderDetails</span>.<a href="WSManNativeAPI.cs.html#a889db7b39ac6999" class="i field">certificateDetails</a> != <b>null</b>)
            {
                <span class="r79 r">psCertDetails</span> = <b>new</b> <a href="PSPrincipal.cs.html#14df078d42c823bc" class="t constructor">PSCertificateDetails</a>(
                    <span class="r78 r">senderDetails</span>.<a href="WSManNativeAPI.cs.html#a889db7b39ac6999" class="i field">certificateDetails</a>.<a href="WSManNativeAPI.cs.html#e95fa434cdbc63d9" class="i field">subject</a>,
                    <span class="r78 r">senderDetails</span>.<a href="WSManNativeAPI.cs.html#a889db7b39ac6999" class="i field">certificateDetails</a>.<a href="WSManNativeAPI.cs.html#9dd858bdd1fe9391" class="i field">issuerName</a>,
                    <span class="r78 r">senderDetails</span>.<a href="WSManNativeAPI.cs.html#a889db7b39ac6999" class="i field">certificateDetails</a>.<a href="WSManNativeAPI.cs.html#6d4cc8d6f04fdfa4" class="i field">issuerThumbprint</a>);
            }
 
            <span class="c">// Construct PSPrincipal</span>
            <a href="PSPrincipal.cs.html#39528f52ff89f7c2" class="t t">PSIdentity</a> <span id="r80 rd" class="r80 r">psIdentity</span> = <b>new</b> <a href="PSPrincipal.cs.html#3c9c1564875caeb1" class="t constructor">PSIdentity</a>(<span class="r78 r">senderDetails</span>.<a href="WSManNativeAPI.cs.html#996d9e3e97a36880" class="i field">authenticationMechanism</a>, <b>true</b>, <span class="r78 r">senderDetails</span>.<a href="WSManNativeAPI.cs.html#6220ec7bb9cff9b0" class="i field">senderName</a>, <span class="r79 r">psCertDetails</span>);
 
            <span class="c">// For Virtual and RunAs accounts WSMan specifies the client token via an environment variable and</span>
            <span class="c">// senderDetails.clientToken should not be used.</span>
            <span class="i">IntPtr</span> <span id="r81 rd" class="r81 r">clientToken</span> = <a href="#b0962946f470b9ad" class="i method">GetRunAsClientToken</a>();
            <span class="r81 r">clientToken</span> = (<span class="r81 r">clientToken</span> != <span class="i">IntPtr</span>.<span class="i">Zero</span>) ? <span class="r81 r">clientToken</span> : <span class="r78 r">senderDetails</span>.<a href="WSManNativeAPI.cs.html#61851d4bd57bd864" class="i field">clientToken</a>;
            <span class="i">WindowsIdentity</span> <span id="r82 rd" class="r82 r">windowsIdentity</span> = <b>null</b>;
            <b>if</b> (<span class="r81 r">clientToken</span> != <span class="i">IntPtr</span>.<span class="i">Zero</span>)
            {
                <b>try</b>
                {
                    <span class="r82 r">windowsIdentity</span> = <b>new</b> <span class="i">WindowsIdentity</span>(<span class="r81 r">clientToken</span>, <span class="r78 r">senderDetails</span>.<a href="WSManNativeAPI.cs.html#996d9e3e97a36880" class="i field">authenticationMechanism</a>);
                }
                <span class="c">// Suppress exceptions..So windowsIdentity = null in these cases</span>
                <b>catch</b> (<span class="i">ArgumentException</span>)
                {
                    <span class="c">// userToken is 0.</span>
                    <span class="c">// -or-</span>
                    <span class="c">// userToken is duplicated and invalid for impersonation.</span>
                }
                <b>catch</b> (<span class="i n">System</span>.<span class="i">Security</span>.<span class="i">SecurityException</span>)
                {
                    <span class="c">// The caller does not have the correct permissions.</span>
                    <span class="c">// -or-</span>
                    <span class="c">// A Win32 error occurred.</span>
                }
            }
 
            <a href="PSPrincipal.cs.html#f38f79fd26abc753" class="t t">PSPrincipal</a> <span id="r83 rd" class="r83 r">userPrincipal</span> = <b>new</b> <a href="PSPrincipal.cs.html#9fa65de366a45f51" class="t constructor">PSPrincipal</a>(<span class="r80 r">psIdentity</span>, <span class="r82 r">windowsIdentity</span>);
            <a href="PSPrincipal.cs.html#eeedcf9113508cb9" class="t t">PSSenderInfo</a> <span id="r84 rd" class="r84 r">result</span> = <b>new</b> <a href="PSPrincipal.cs.html#041d397e8ed43c11" class="t constructor">PSSenderInfo</a>(<span class="r83 r">userPrincipal</span>, <span class="r78 r">senderDetails</span>.<a href="WSManNativeAPI.cs.html#38231d1fc9effcef" class="i field">httpUrl</a>);
            <b>return</b> <span class="r84 r">result</span>;
        }
 
        <b>private const string</b> <a id="937ab606951c076f" href="../../../R/937ab606951c076f.html" target="n" data-glyph="10,1" class="i field">WSManRunAsClientTokenName</a> = <span class="s">&quot;__WINRM_RUNAS_CLIENT_TOKEN__&quot;</span>;
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Helper method to retrieve the WSMan client token from the __WINRM_RUNAS_CLIENT_TOKEN__</span>
        <span class="c">///</span><span class="c"> environment variable, which is set in the WSMan layer for Virtual or RunAs accounts.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">ClientToken IntPtr.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>private static</b> <span class="i">IntPtr</span> <a id="b0962946f470b9ad" href="../../../R/b0962946f470b9ad.html" target="n" data-glyph="76,1" class="i method">GetRunAsClientToken</a>()
        {
            <b>string</b> <span id="r85 rd" class="r85 r">clientTokenStr</span> = <span class="i n">System</span>.<span class="i">Environment</span>.<span class="i">GetEnvironmentVariable</span>(<a href="#937ab606951c076f" class="i field">WSManRunAsClientTokenName</a>);
            <b>if</b> (<span class="r85 r">clientTokenStr</span> != <b>null</b>)
            {
                <span class="c">// Remove the token value from the environment variable</span>
                <span class="i n">System</span>.<span class="i">Environment</span>.<span class="i">SetEnvironmentVariable</span>(<a href="#937ab606951c076f" class="i field">WSManRunAsClientTokenName</a>, <b>null</b>);
 
                <b>int</b> <span id="r86 rd" class="r86 r">clientTokenInt</span>;
                <b>if</b> (<b>int</b>.<span class="i">TryParse</span>(<span class="r85 r">clientTokenStr</span>, <span class="i">NumberStyles</span>.<span class="i">HexNumber</span>, <span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>, <b>out</b> <span class="r86 r">clientTokenInt</span>))
                {
                    <b>return</b> <b>new</b> <span class="i">IntPtr</span>(<span class="r86 r">clientTokenInt</span>);
                }
            }
 
            <b>return</b> <span class="i">IntPtr</span>.<span class="i">Zero</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Was private. Made protected internal for easier testing.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r87 r">requestDetails</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>protected internal bool</b> <a id="9be3a24502ac5f4e" href="../../../R/9be3a24502ac5f4e.html" target="n" data-glyph="75,1" class="i method">EnsureOptionsComply</a>(
            <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#07d21d2cee8c9d82" class="t t">WSManPluginRequest</a> <span id="r87 rd" class="r87 r">requestDetails</span>)
        {
            <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#f3f2b67eaca5460e" class="t t">WSManOption</a>[] <span id="r88 rd" class="r88 r">options</span> = <span class="r87 r">requestDetails</span>.<a href="WSManNativeAPI.cs.html#8fa7923067133d6f" class="i field">operationInfo</a>.<a href="WSManNativeAPI.cs.html#21f6aad990635900" class="i field">optionSet</a>.<a href="WSManNativeAPI.cs.html#1f13e273ca621f1d" class="i field">options</a>;
            <b>bool</b> <span id="r89 rd" class="r89 r">isProtocolVersionDeclared</span> = <b>false</b>;
 
            <b>for</b> (<b>int</b> <span id="r90 rd" class="r90 r">i</span> = 0; <span class="r90 r">i</span> &lt; <span class="r88 r">options</span>.<span class="i">Length</span>; <span class="r90 r">i</span>++) <span class="c">// What about requestDetails.operationInfo.optionSet.optionsCount? It is a hold over from the C++ API. Safer is Length.</span>
            {
                <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#f3f2b67eaca5460e" class="t t">WSManOption</a> <span id="r91 rd" class="r91 r">option</span> = <span class="r88 r">options</span>[<span class="r90 r">i</span>];
 
                <b>if</b> (<b>string</b>.<span class="i">Equals</span>(<span class="r91 r">option</span>.<a href="WSManNativeAPI.cs.html#236eed2b4fe7a439" class="i field">name</a>, <a href="#f1ff81f0faba1926" class="t t">WSManPluginConstants</a>.<a href="#ee4032509cb62f4f" class="i field">PowerShellStartupProtocolVersionName</a>, <span class="i">StringComparison</span>.<span class="i">Ordinal</span>))
                {
                    <b>if</b> (!<a href="#8fc509636b8f095d" class="i method">EnsureProtocolVersionComplies</a>(<span class="r87 r">requestDetails</span>, <span class="r91 r">option</span>.<a href="WSManNativeAPI.cs.html#fc9f90499a03780b" class="i field">value</a>))
                    {
                        <b>return</b> <b>false</b>;
                    }
 
                    <span class="r89 r">isProtocolVersionDeclared</span> = <b>true</b>;
                }
 
                <b>if</b> (<b>string</b>.<span class="i">Compare</span>(<span class="r91 r">option</span>.<a href="WSManNativeAPI.cs.html#236eed2b4fe7a439" class="i field">name</a>, 0, <a href="#f1ff81f0faba1926" class="t t">WSManPluginConstants</a>.<a href="#7f00904e7d75f092" class="i field">PowerShellOptionPrefix</a>, 0, <a href="#f1ff81f0faba1926" class="t t">WSManPluginConstants</a>.<a href="#7f00904e7d75f092" class="i field">PowerShellOptionPrefix</a>.<span class="i">Length</span>, <span class="i">StringComparison</span>.<span class="i">Ordinal</span>) == 0)
                {
                    <b>if</b> (<span class="r91 r">option</span>.<a href="WSManNativeAPI.cs.html#e4277700dc2720ce" class="i field">mustComply</a>)
                    {
                        <a href="#34bada9077aac474" class="i method">ReportOperationComplete</a>(
                            <span class="r87 r">requestDetails</span>,
                            <a href="#a42b50e40ac07da8" class="t t">WSManPluginErrorCodes</a>.<a href="#bc9d5dde9e2a3ba1" class="i field">OptionNotUnderstood</a>,
                            <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(
                                <span class="i">RemotingErrorIdStrings</span>.<span class="i">WSManPluginOptionNotUnderstood</span>,
                                <span class="r91 r">option</span>.<a href="WSManNativeAPI.cs.html#236eed2b4fe7a439" class="i field">name</a>,
                                <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="../../PSVersionInfo.cs.html#be287f9ea52b8d2f" class="t t">PSVersionInfo</a>.<a href="../../PSVersionInfo.cs.html#624934150adfee0d" class="i property">GitCommitId</a>,
                                <a href="#f1ff81f0faba1926" class="t t">WSManPluginConstants</a>.<a href="#08e08a97aba4a5a5" class="i field">PowerShellStartupProtocolVersionValue</a>));
                        <b>return</b> <b>false</b>;
                    }
                }
            }
 
            <b>if</b> (!<span class="r89 r">isProtocolVersionDeclared</span>)
            {
                <a href="#34bada9077aac474" class="i method">ReportOperationComplete</a>(
                    <span class="r87 r">requestDetails</span>,
                    <a href="#a42b50e40ac07da8" class="t t">WSManPluginErrorCodes</a>.<a href="#96e5126cf9336a88" class="i field">ProtocolVersionNotFound</a>,
                    <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(
                        <span class="i">RemotingErrorIdStrings</span>.<span class="i">WSManPluginProtocolVersionNotFound</span>,
                        <a href="#f1ff81f0faba1926" class="t t">WSManPluginConstants</a>.<a href="#ee4032509cb62f4f" class="i field">PowerShellStartupProtocolVersionName</a>,
                        <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="../../PSVersionInfo.cs.html#be287f9ea52b8d2f" class="t t">PSVersionInfo</a>.<a href="../../PSVersionInfo.cs.html#624934150adfee0d" class="i property">GitCommitId</a>,
                        <a href="#f1ff81f0faba1926" class="t t">WSManPluginConstants</a>.<a href="#08e08a97aba4a5a5" class="i field">PowerShellStartupProtocolVersionValue</a>));
                <b>return</b> <b>false</b>;
            }
 
            <b>return</b> <b>true</b>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Verifies that the protocol version is in the correct syntax and supported.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r92 r">requestDetails</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r93 r">clientVersionString</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>protected internal bool</b> <a id="8fc509636b8f095d" href="../../../R/8fc509636b8f095d.html" target="n" data-glyph="75,1" class="i method">EnsureProtocolVersionComplies</a>(
            <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#07d21d2cee8c9d82" class="t t">WSManPluginRequest</a> <span id="r92 rd" class="r92 r">requestDetails</span>,
            <b>string</b> <span id="r93 rd" class="r93 r">clientVersionString</span>)
        {
            <b>if</b> (<b>string</b>.<span class="i">Equals</span>(<span class="r93 r">clientVersionString</span>, <a href="#f1ff81f0faba1926" class="t t">WSManPluginConstants</a>.<a href="#08e08a97aba4a5a5" class="i field">PowerShellStartupProtocolVersionValue</a>, <span class="i">StringComparison</span>.<span class="i">Ordinal</span>))
            {
                <b>return</b> <b>true</b>;
            }
 
            <span class="c">// Check if major versions are equal and server&#39;s minor version is smaller..</span>
            <span class="c">// if so client&#39;s version is supported by the server. The understanding is</span>
            <span class="c">// that minor version changes do not break the protocol.</span>
            <span class="i n">System</span>.<span class="i">Version</span> <span id="r94 rd" class="r94 r">clientVersion</span> = <a href="../../Utils.cs.html#9185d6ecbaebbec0" class="t t">Utils</a>.<a href="../../Utils.cs.html#12d99513c4a52180" class="i method">StringToVersion</a>(<span class="r93 r">clientVersionString</span>);
            <span class="i n">System</span>.<span class="i">Version</span> <span id="r95 rd" class="r95 r">serverVersion</span> = <a href="../../Utils.cs.html#9185d6ecbaebbec0" class="t t">Utils</a>.<a href="../../Utils.cs.html#12d99513c4a52180" class="i method">StringToVersion</a>(<a href="#f1ff81f0faba1926" class="t t">WSManPluginConstants</a>.<a href="#08e08a97aba4a5a5" class="i field">PowerShellStartupProtocolVersionValue</a>);
 
            <b>if</b> ((<span class="r94 r">clientVersion</span> != <b>null</b>) &amp;&amp; (<span class="r95 r">serverVersion</span> != <b>null</b>) &amp;&amp;
                (<span class="r94 r">clientVersion</span>.<span class="i">Major</span> == <span class="r95 r">serverVersion</span>.<span class="i">Major</span>) &amp;&amp;
                (<span class="r94 r">clientVersion</span>.<span class="i">Minor</span> &gt;= <span class="r95 r">serverVersion</span>.<span class="i">Minor</span>))
            {
                <b>return</b> <b>true</b>;
            }
 
            <a href="#34bada9077aac474" class="i method">ReportOperationComplete</a>(
                <span class="r92 r">requestDetails</span>,
                <a href="#a42b50e40ac07da8" class="t t">WSManPluginErrorCodes</a>.<a href="#26ce4a62f28b0198" class="i field">ProtocolVersionNotMatch</a>,
                <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(
                    <span class="i">RemotingErrorIdStrings</span>.<span class="i">WSManPluginProtocolVersionNotMatch</span>,
                    <a href="#f1ff81f0faba1926" class="t t">WSManPluginConstants</a>.<a href="#08e08a97aba4a5a5" class="i field">PowerShellStartupProtocolVersionValue</a>,
                    <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="../../PSVersionInfo.cs.html#be287f9ea52b8d2f" class="t t">PSVersionInfo</a>.<a href="../../PSVersionInfo.cs.html#624934150adfee0d" class="i property">GitCommitId</a>,
                    <span class="r93 r">clientVersionString</span>));
            <b>return</b> <b>false</b>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Static func to take care of unmanaged to managed transitions.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r96 r">pluginContext</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r97 r">requestDetails</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r98 r">flags</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r99 r">extraInfo</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r100 r">startupInfo</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r101 r">inboundShellInformation</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal static void</b> <a id="c02ac579a160fce8" href="../../../R/c02ac579a160fce8.html" target="n" data-glyph="74,1" class="i method">PerformWSManPluginShell</a>(
            <span class="i">IntPtr</span> <span id="r96 rd" class="r96 r">pluginContext</span>, <span class="c">// PVOID</span>
            <span class="i">IntPtr</span> <span id="r97 rd" class="r97 r">requestDetails</span>, <span class="c">// WSMAN_PLUGIN_REQUEST*</span>
            <b>int</b> <span id="r98 rd" class="r98 r">flags</span>,
            <b>string</b> <span id="r99 rd" class="r99 r">extraInfo</span>,
            <span class="i">IntPtr</span> <span id="r100 rd" class="r100 r">startupInfo</span>, <span class="c">// WSMAN_SHELL_STARTUP_INFO*</span>
            <span class="i">IntPtr</span> <span id="r101 rd" class="r101 r">inboundShellInformation</span>) <span class="c">// WSMAN_DATA*</span>
        {
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(
                <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#959d48274f222fdc" class="i field">WSManCreateShell</a>,
                <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#399fd86ea109ec79" class="i field">Open</a>,
                <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a59ff5f5d029e4d1" class="i field">ManagedPlugin</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                <b>string</b>.<span class="i">Empty</span>,
                <span class="s">&quot;PerformWSManPluginShell: static func to take care of unmanaged to managed transitions.&quot;</span>,
                <b>string</b>.<span class="i">Empty</span>);
 
            <a href="#23ee55d6d8a367a2" class="t t">WSManPluginInstance</a> <span id="r102 rd" class="r102 r">pluginToUse</span> = <a href="#6cadb9a20812ea8b" class="i method">GetFromActivePlugins</a>(<span class="r96 r">pluginContext</span>);
 
            <b>if</b> (<span class="r102 r">pluginToUse</span> == <b>null</b>)
            {
                <b>lock</b> (<a href="#2a5df8eaf4582089" class="i field">s_activePlugins</a>)
                {
                    <span class="r102 r">pluginToUse</span> = <a href="#6cadb9a20812ea8b" class="i method">GetFromActivePlugins</a>(<span class="r96 r">pluginContext</span>);
                    <b>if</b> (<span class="r102 r">pluginToUse</span> == <b>null</b>)
                    {
                        <span class="c">// create a new plugin</span>
                        <a href="#23ee55d6d8a367a2" class="t t">WSManPluginInstance</a> <span id="r103 rd" class="r103 r">mgdPlugin</span> = <b>new</b> <a href="#9be46567bcd26e5a" class="t constructor">WSManPluginInstance</a>();
                        <a href="#57b040aee4281e27" class="i method">AddToActivePlugins</a>(<span class="r96 r">pluginContext</span>, <span class="r103 r">mgdPlugin</span>);
                        <span class="r102 r">pluginToUse</span> = <span class="r103 r">mgdPlugin</span>;
                    }
                }
            }
 
            <span class="c">// Marshal the incoming pointers into managed types prior to the call</span>
            <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#07d21d2cee8c9d82" class="t t">WSManPluginRequest</a> <span id="r104 rd" class="r104 r">requestDetailsInstance</span> = <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#07d21d2cee8c9d82" class="t t">WSManPluginRequest</a>.<a href="WSManNativeAPI.cs.html#11fd0761e282b189" class="i method">UnMarshal</a>(<span class="r97 r">requestDetails</span>);
            <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#19022ea5d98e6225" class="t t">WSManShellStartupInfo_UnToMan</a> <span id="r105 rd" class="r105 r">startupInfoInstance</span> = <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#19022ea5d98e6225" class="t t">WSManShellStartupInfo_UnToMan</a>.<a href="WSManNativeAPI.cs.html#b887d5f93050daf4" class="i method">UnMarshal</a>(<span class="r100 r">startupInfo</span>);
            <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#456a9677b88cb3ef" class="t t">WSManData_UnToMan</a> <span id="r106 rd" class="r106 r">inboundShellInfo</span> = <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#456a9677b88cb3ef" class="t t">WSManData_UnToMan</a>.<a href="WSManNativeAPI.cs.html#9a40a81d687a8c04" class="i method">UnMarshal</a>(<span class="r101 r">inboundShellInformation</span>);
 
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(
                <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#959d48274f222fdc" class="i field">WSManCreateShell</a>,
                <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#399fd86ea109ec79" class="i field">Open</a>,
                <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a59ff5f5d029e4d1" class="i field">ManagedPlugin</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                <span class="r104 r">requestDetailsInstance</span>.<span class="i">ToString</span>(),
                <span class="r104 r">requestDetailsInstance</span>.<a href="WSManNativeAPI.cs.html#b6c51fbca52e1bdd" class="i field">resourceUri</a>);
 
            <span class="r102 r">pluginToUse</span>.<a href="#8ae91ce3c983c72f" class="i method">CreateShell</a>(<span class="r96 r">pluginContext</span>, <span class="r104 r">requestDetailsInstance</span>, <span class="r98 r">flags</span>, <span class="r99 r">extraInfo</span>, <span class="r105 r">startupInfoInstance</span>, <span class="r106 r">inboundShellInfo</span>);
 
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(
                <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#959d48274f222fdc" class="i field">WSManCreateShell</a>,
                <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#399fd86ea109ec79" class="i field">Open</a>,
                <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a59ff5f5d029e4d1" class="i field">ManagedPlugin</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                <b>string</b>.<span class="i">Empty</span>,
                <span class="s">&quot;PerformWSManPluginShell: Completed&quot;</span>,
                <b>string</b>.<span class="i">Empty</span>);
        }
 
        <b>internal static void</b> <a id="b430214dba753480" href="../../../R/b430214dba753480.html" target="n" data-glyph="74,1" class="i method">PerformWSManPluginCommand</a>(
            <span class="i">IntPtr</span> <span id="r107 rd" class="r107 r">pluginContext</span>,
            <span class="i">IntPtr</span> <span id="r108 rd" class="r108 r">requestDetails</span>, <span class="c">// WSMAN_PLUGIN_REQUEST*</span>
            <b>int</b> <span id="r109 rd" class="r109 r">flags</span>,
            <span class="i">IntPtr</span> <span id="r110 rd" class="r110 r">shellContext</span>, <span class="c">// PVOID</span>
            [<span class="i">MarshalAs</span>(<span class="i">UnmanagedType</span>.<span class="i">LPWStr</span>)] <b>string</b> <span id="r111 rd" class="r111 r">commandLine</span>,
            <span class="i">IntPtr</span> <span id="r112 rd" class="r112 r">arguments</span>) <span class="c">// WSMAN_COMMAND_ARG_SET*</span>
        {
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(
                <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#959d48274f222fdc" class="i field">WSManCreateShell</a>,
                <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#399fd86ea109ec79" class="i field">Open</a>,
                <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a59ff5f5d029e4d1" class="i field">ManagedPlugin</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                <b>string</b>.<span class="i">Empty</span>,
                <span class="s">&quot;PerformWSManPluginCommand: static func to take care of unmanaged to managed transitions.&quot;</span>,
                <b>string</b>.<span class="i">Empty</span>);
 
            <a href="#23ee55d6d8a367a2" class="t t">WSManPluginInstance</a> <span id="r113 rd" class="r113 r">pluginToUse</span> = <a href="#6cadb9a20812ea8b" class="i method">GetFromActivePlugins</a>(<span class="r107 r">pluginContext</span>);
 
            <b>if</b> (<span class="r113 r">pluginToUse</span> == <b>null</b>)
            {
                <a href="#006f2e301f46b5b1" class="i method">ReportOperationComplete</a>(
                    <span class="r108 r">requestDetails</span>,
                    <a href="#a42b50e40ac07da8" class="t t">WSManPluginErrorCodes</a>.<a href="#d46eb6624c1acdff" class="i field">PluginContextNotFound</a>,
                    <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(
                        <span class="i">RemotingErrorIdStrings</span>.<span class="i">WSManPluginContextNotFound</span>));
                <b>return</b>;
            }
 
            <span class="c">// Marshal the incoming pointers into managed types prior to the call</span>
            <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#07d21d2cee8c9d82" class="t t">WSManPluginRequest</a> <span id="r114 rd" class="r114 r">request</span> = <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#07d21d2cee8c9d82" class="t t">WSManPluginRequest</a>.<a href="WSManNativeAPI.cs.html#11fd0761e282b189" class="i method">UnMarshal</a>(<span class="r108 r">requestDetails</span>);
            <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#65e6a5b9a30e36c9" class="t t">WSManCommandArgSet</a> <span id="r115 rd" class="r115 r">argSet</span> = <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#65e6a5b9a30e36c9" class="t t">WSManCommandArgSet</a>.<a href="WSManNativeAPI.cs.html#e16a7d6258509453" class="i method">UnMarshal</a>(<span class="r112 r">arguments</span>);
 
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(
                <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#959d48274f222fdc" class="i field">WSManCreateShell</a>,
                <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#399fd86ea109ec79" class="i field">Open</a>,
                <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a59ff5f5d029e4d1" class="i field">ManagedPlugin</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                <span class="r114 r">request</span>.<span class="i">ToString</span>(),
                <span class="r114 r">request</span>.<a href="WSManNativeAPI.cs.html#b6c51fbca52e1bdd" class="i field">resourceUri</a>);
 
            <span class="r113 r">pluginToUse</span>.<a href="#e0a49fce578693e6" class="i method">CreateCommand</a>(<span class="r107 r">pluginContext</span>, <span class="r114 r">request</span>, <span class="r109 r">flags</span>, <span class="r110 r">shellContext</span>, <span class="r111 r">commandLine</span>, <span class="r115 r">argSet</span>);
 
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(
                <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#959d48274f222fdc" class="i field">WSManCreateShell</a>,
                <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#399fd86ea109ec79" class="i field">Open</a>,
                <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a59ff5f5d029e4d1" class="i field">ManagedPlugin</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                <b>string</b>.<span class="i">Empty</span>,
                <span class="s">&quot;PerformWSManPluginCommand: Completed&quot;</span>,
                <b>string</b>.<span class="i">Empty</span>);
        }
 
        <b>internal static void</b> <a id="1d4606b16b8e9044" href="../../../R/1d4606b16b8e9044.html" target="n" data-glyph="74,1" class="i method">PerformWSManPluginConnect</a>(
            <span class="i">IntPtr</span> <span id="r116 rd" class="r116 r">pluginContext</span>,
            <span class="i">IntPtr</span> <span id="r117 rd" class="r117 r">requestDetails</span>,
            <b>int</b> <span id="r118 rd" class="r118 r">flags</span>,
            <span class="i">IntPtr</span> <span id="r119 rd" class="r119 r">shellContext</span>,
            <span class="i">IntPtr</span> <span id="r120 rd" class="r120 r">commandContext</span>,
            <span class="i">IntPtr</span> <span id="r121 rd" class="r121 r">inboundConnectInformation</span>)
        {
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(
                <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#959d48274f222fdc" class="i field">WSManCreateShell</a>,
                <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#399fd86ea109ec79" class="i field">Open</a>,
                <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a59ff5f5d029e4d1" class="i field">ManagedPlugin</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                <b>string</b>.<span class="i">Empty</span>,
                <span class="s">&quot;PerformWSManPluginConnect: static func to take care of unmanaged to managed transitions.&quot;</span>,
                <b>string</b>.<span class="i">Empty</span>);
 
            <a href="#23ee55d6d8a367a2" class="t t">WSManPluginInstance</a> <span id="r122 rd" class="r122 r">pluginToUse</span> = <a href="#6cadb9a20812ea8b" class="i method">GetFromActivePlugins</a>(<span class="r116 r">pluginContext</span>);
 
            <b>if</b> (<span class="r122 r">pluginToUse</span> == <b>null</b>)
            {
                <a href="#006f2e301f46b5b1" class="i method">ReportOperationComplete</a>(
                    <span class="r117 r">requestDetails</span>,
                    <a href="#a42b50e40ac07da8" class="t t">WSManPluginErrorCodes</a>.<a href="#d46eb6624c1acdff" class="i field">PluginContextNotFound</a>,
                    <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(
                        <span class="i">RemotingErrorIdStrings</span>.<span class="i">WSManPluginContextNotFound</span>));
                <b>return</b>;
            }
 
            <span class="c">// Marshal the incoming pointers into managed types prior to the call</span>
            <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#07d21d2cee8c9d82" class="t t">WSManPluginRequest</a> <span id="r123 rd" class="r123 r">request</span> = <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#07d21d2cee8c9d82" class="t t">WSManPluginRequest</a>.<a href="WSManNativeAPI.cs.html#11fd0761e282b189" class="i method">UnMarshal</a>(<span class="r117 r">requestDetails</span>);
            <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#456a9677b88cb3ef" class="t t">WSManData_UnToMan</a> <span id="r124 rd" class="r124 r">connectInformation</span> = <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#456a9677b88cb3ef" class="t t">WSManData_UnToMan</a>.<a href="WSManNativeAPI.cs.html#9a40a81d687a8c04" class="i method">UnMarshal</a>(<span class="r121 r">inboundConnectInformation</span>);
 
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(
                <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#959d48274f222fdc" class="i field">WSManCreateShell</a>,
                <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#399fd86ea109ec79" class="i field">Open</a>,
                <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a59ff5f5d029e4d1" class="i field">ManagedPlugin</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                <span class="r123 r">request</span>.<span class="i">ToString</span>(),
                <span class="r123 r">request</span>.<a href="WSManNativeAPI.cs.html#b6c51fbca52e1bdd" class="i field">resourceUri</a>);
 
            <span class="r122 r">pluginToUse</span>.<a href="#eb515c87e550b606" class="i method">ConnectShellOrCommand</a>(<span class="r123 r">request</span>, <span class="r118 r">flags</span>, <span class="r119 r">shellContext</span>, <span class="r120 r">commandContext</span>, <span class="r124 r">connectInformation</span>);
 
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(
                <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#959d48274f222fdc" class="i field">WSManCreateShell</a>,
                <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#399fd86ea109ec79" class="i field">Open</a>,
                <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a59ff5f5d029e4d1" class="i field">ManagedPlugin</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                <b>string</b>.<span class="i">Empty</span>,
                <span class="s">&quot;PerformWSManPluginConnect: Completed&quot;</span>,
                <b>string</b>.<span class="i">Empty</span>);
        }
 
        <b>internal static void</b> <a id="0fb9868d4c6c5fc6" href="../../../R/0fb9868d4c6c5fc6.html" target="n" data-glyph="74,1" class="i method">PerformWSManPluginSend</a>(
            <span class="i">IntPtr</span> <span id="r125 rd" class="r125 r">pluginContext</span>,
            <span class="i">IntPtr</span> <span id="r126 rd" class="r126 r">requestDetails</span>, <span class="c">// WSMAN_PLUGIN_REQUEST*</span>
            <b>int</b> <span id="r127 rd" class="r127 r">flags</span>,
            <span class="i">IntPtr</span> <span id="r128 rd" class="r128 r">shellContext</span>, <span class="c">// PVOID</span>
            <span class="i">IntPtr</span> <span id="r129 rd" class="r129 r">commandContext</span>, <span class="c">// PVOID</span>
            <b>string</b> <span id="r130 rd" class="r130 r">stream</span>,
            <span class="i">IntPtr</span> <span id="r131 rd" class="r131 r">inboundData</span>) <span class="c">// WSMAN_DATA*</span>
        {
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(
                <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#97a04fcf34529508" class="i field">ServerReceivedData</a>,
                <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#399fd86ea109ec79" class="i field">Open</a>,
                <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a59ff5f5d029e4d1" class="i field">ManagedPlugin</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                <b>string</b>.<span class="i">Empty</span>,
                <span class="s">&quot;PerformWSManPluginSend: Invoked&quot;</span>,
                <b>string</b>.<span class="i">Empty</span>);
 
            <a href="#23ee55d6d8a367a2" class="t t">WSManPluginInstance</a> <span id="r132 rd" class="r132 r">pluginToUse</span> = <a href="#6cadb9a20812ea8b" class="i method">GetFromActivePlugins</a>(<span class="r125 r">pluginContext</span>);
 
            <b>if</b> (<span class="r132 r">pluginToUse</span> == <b>null</b>)
            {
                <a href="#006f2e301f46b5b1" class="i method">ReportOperationComplete</a>(
                    <span class="r126 r">requestDetails</span>,
                    <a href="#a42b50e40ac07da8" class="t t">WSManPluginErrorCodes</a>.<a href="#d46eb6624c1acdff" class="i field">PluginContextNotFound</a>,
                    <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(
                        <span class="i">RemotingErrorIdStrings</span>.<span class="i">WSManPluginContextNotFound</span>));
                <b>return</b>;
            }
 
            <span class="c">// Marshal the incoming pointers into managed types prior to the call</span>
            <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#07d21d2cee8c9d82" class="t t">WSManPluginRequest</a> <span id="r133 rd" class="r133 r">request</span> = <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#07d21d2cee8c9d82" class="t t">WSManPluginRequest</a>.<a href="WSManNativeAPI.cs.html#11fd0761e282b189" class="i method">UnMarshal</a>(<span class="r126 r">requestDetails</span>);
            <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#456a9677b88cb3ef" class="t t">WSManData_UnToMan</a> <span id="r134 rd" class="r134 r">data</span> = <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#456a9677b88cb3ef" class="t t">WSManData_UnToMan</a>.<a href="WSManNativeAPI.cs.html#9a40a81d687a8c04" class="i method">UnMarshal</a>(<span class="r131 r">inboundData</span>);
 
            <span class="r132 r">pluginToUse</span>.<a href="#3ec9bc371f514c24" class="i method">SendOneItemToShellOrCommand</a>(<span class="r133 r">request</span>, <span class="r127 r">flags</span>, <span class="r128 r">shellContext</span>, <span class="r129 r">commandContext</span>, <span class="r130 r">stream</span>, <span class="r134 r">data</span>);
 
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(
                <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#97a04fcf34529508" class="i field">ServerReceivedData</a>,
                <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#399fd86ea109ec79" class="i field">Open</a>,
                <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a59ff5f5d029e4d1" class="i field">ManagedPlugin</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                <b>string</b>.<span class="i">Empty</span>,
                <span class="s">&quot;PerformWSManPluginSend: Completed&quot;</span>,
                <b>string</b>.<span class="i">Empty</span>);
        }
 
        <b>internal static void</b> <a id="c7dcd569b9a12b29" href="../../../R/c7dcd569b9a12b29.html" target="n" data-glyph="74,1" class="i method">PerformWSManPluginReceive</a>(
            <span class="i">IntPtr</span> <span id="r135 rd" class="r135 r">pluginContext</span>, <span class="c">// PVOID</span>
            <span class="i">IntPtr</span> <span id="r136 rd" class="r136 r">requestDetails</span>, <span class="c">// WSMAN_PLUGIN_REQUEST*</span>
            <b>int</b> <span id="r137 rd" class="r137 r">flags</span>,
            <span class="i">IntPtr</span> <span id="r138 rd" class="r138 r">shellContext</span>,
            <span class="i">IntPtr</span> <span id="r139 rd" class="r139 r">commandContext</span>,
            <span class="i">IntPtr</span> <span id="r140 rd" class="r140 r">streamSet</span>) <span class="c">// WSMAN_STREAM_ID_SET*</span>
        {
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(
                <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#97a04fcf34529508" class="i field">ServerReceivedData</a>,
                <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#399fd86ea109ec79" class="i field">Open</a>,
                <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a59ff5f5d029e4d1" class="i field">ManagedPlugin</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                <b>string</b>.<span class="i">Empty</span>,
                <span class="s">&quot;PerformWSManPluginReceive: Invoked&quot;</span>,
                <b>string</b>.<span class="i">Empty</span>);
 
            <a href="#23ee55d6d8a367a2" class="t t">WSManPluginInstance</a> <span id="r141 rd" class="r141 r">pluginToUse</span> = <a href="#6cadb9a20812ea8b" class="i method">GetFromActivePlugins</a>(<span class="r135 r">pluginContext</span>);
 
            <b>if</b> (<span class="r141 r">pluginToUse</span> == <b>null</b>)
            {
                <a href="#006f2e301f46b5b1" class="i method">ReportOperationComplete</a>(
                    <span class="r136 r">requestDetails</span>,
                    <a href="#a42b50e40ac07da8" class="t t">WSManPluginErrorCodes</a>.<a href="#d46eb6624c1acdff" class="i field">PluginContextNotFound</a>,
                    <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(
                        <span class="i">RemotingErrorIdStrings</span>.<span class="i">WSManPluginContextNotFound</span>));
                <b>return</b>;
            }
 
            <span class="c">// Marshal the incoming pointers into managed types prior to the call</span>
            <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#07d21d2cee8c9d82" class="t t">WSManPluginRequest</a> <span id="r142 rd" class="r142 r">request</span> = <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#07d21d2cee8c9d82" class="t t">WSManPluginRequest</a>.<a href="WSManNativeAPI.cs.html#11fd0761e282b189" class="i method">UnMarshal</a>(<span class="r136 r">requestDetails</span>);
            <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#7ff909a68a591c73" class="t t">WSManStreamIDSet_UnToMan</a> <span id="r143 rd" class="r143 r">streamIdSet</span> = <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#7ff909a68a591c73" class="t t">WSManStreamIDSet_UnToMan</a>.<a href="WSManNativeAPI.cs.html#8df5edd4ab8bdb9a" class="i method">UnMarshal</a>(<span class="r140 r">streamSet</span>);
 
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(
                <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#97a04fcf34529508" class="i field">ServerReceivedData</a>,
                <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#399fd86ea109ec79" class="i field">Open</a>,
                <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a59ff5f5d029e4d1" class="i field">ManagedPlugin</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                <span class="r142 r">request</span>.<span class="i">ToString</span>(),
                <span class="r142 r">request</span>.<a href="WSManNativeAPI.cs.html#b6c51fbca52e1bdd" class="i field">resourceUri</a>);
 
            <span class="r141 r">pluginToUse</span>.<a href="#9bb2a20db2bd7792" class="i method">EnableShellOrCommandToSendDataToClient</a>(<span class="r135 r">pluginContext</span>, <span class="r142 r">request</span>, <span class="r137 r">flags</span>, <span class="r138 r">shellContext</span>, <span class="r139 r">commandContext</span>, <span class="r143 r">streamIdSet</span>);
 
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(
                <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#97a04fcf34529508" class="i field">ServerReceivedData</a>,
                <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#399fd86ea109ec79" class="i field">Open</a>,
                <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a59ff5f5d029e4d1" class="i field">ManagedPlugin</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                <b>string</b>.<span class="i">Empty</span>,
                <span class="s">&quot;PerformWSManPluginReceive: Completed&quot;</span>,
                <b>string</b>.<span class="i">Empty</span>);
        }
 
        <b>internal static void</b> <a id="612d75f728c7436b" href="../../../R/612d75f728c7436b.html" target="n" data-glyph="74,1" class="i method">PerformWSManPluginSignal</a>(
            <span class="i">IntPtr</span> <span id="r144 rd" class="r144 r">pluginContext</span>, <span class="c">// PVOID</span>
            <span class="i">IntPtr</span> <span id="r145 rd" class="r145 r">requestDetails</span>, <span class="c">// WSMAN_PLUGIN_REQUEST*</span>
            <b>int</b> <span id="r146 rd" class="r146 r">flags</span>,
            <span class="i">IntPtr</span> <span id="r147 rd" class="r147 r">shellContext</span>, <span class="c">// PVOID</span>
            <span class="i">IntPtr</span> <span id="r148 rd" class="r148 r">commandContext</span>, <span class="c">// PVOID</span>
            <b>string</b> <span id="r149 rd" class="r149 r">code</span>)
        {
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(
                <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#97a04fcf34529508" class="i field">ServerReceivedData</a>,
                <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#399fd86ea109ec79" class="i field">Open</a>,
                <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a59ff5f5d029e4d1" class="i field">ManagedPlugin</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                <b>string</b>.<span class="i">Empty</span>,
                <span class="s">&quot;PerformWSManPluginSignal: Invoked&quot;</span>,
                <b>string</b>.<span class="i">Empty</span>);
 
            <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#07d21d2cee8c9d82" class="t t">WSManPluginRequest</a> <span id="r150 rd" class="r150 r">request</span> = <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#07d21d2cee8c9d82" class="t t">WSManPluginRequest</a>.<a href="WSManNativeAPI.cs.html#11fd0761e282b189" class="i method">UnMarshal</a>(<span class="r145 r">requestDetails</span>);
 
            <span class="c">// Close Command</span>
            <b>if</b> (<span class="r148 r">commandContext</span> != <span class="i">IntPtr</span>.<span class="i">Zero</span>)
            {
                <b>if</b> (!<b>string</b>.<span class="i">Equals</span>(<span class="r149 r">code</span>, <a href="#f1ff81f0faba1926" class="t t">WSManPluginConstants</a>.<a href="#b7539e67521d0ad3" class="i field">CtrlCSignal</a>, <span class="i">StringComparison</span>.<span class="i">Ordinal</span>))
                {
                    <span class="c">// Close operations associated with this command..</span>
                    <a href="#3e5455aa49779e8c" class="t t">WSManPluginOperationShutdownContext</a> <span id="r151 rd" class="r151 r">cmdCtxt</span> = <b>new</b> <a href="#50876cb84abf1ce7" class="t constructor">WSManPluginOperationShutdownContext</a>(<span class="r144 r">pluginContext</span>, <span class="r147 r">shellContext</span>, <span class="r148 r">commandContext</span>, <b>false</b>);
                    <b>if</b> (<span class="r151 r">cmdCtxt</span> != <b>null</b>)
                    {
                        <a href="#2103a47783d6d1c5" class="i method">PerformCloseOperation</a>(<span class="r151 r">cmdCtxt</span>);
                    }
                    <b>else</b>
                    {
                        <a href="#c8d0e78b633d4f66" class="i method">ReportOperationComplete</a>(<span class="r150 r">request</span>, <a href="#a42b50e40ac07da8" class="t t">WSManPluginErrorCodes</a>.<a href="#b22ffa6e6f8f45d5" class="i field">OutOfMemory</a>);
                        <b>return</b>;
                    }
                }
                <b>else</b>
                {
                    <span class="c">// we got crtl_c (stop) message from client. so stop powershell</span>
                    <a href="#23ee55d6d8a367a2" class="t t">WSManPluginInstance</a> <span id="r152 rd" class="r152 r">pluginToUse</span> = <a href="#6cadb9a20812ea8b" class="i method">GetFromActivePlugins</a>(<span class="r144 r">pluginContext</span>);
 
                    <b>if</b> (<span class="r152 r">pluginToUse</span> == <b>null</b>)
                    {
                        <a href="#34bada9077aac474" class="i method">ReportOperationComplete</a>(
                            <span class="r150 r">request</span>,
                            <a href="#a42b50e40ac07da8" class="t t">WSManPluginErrorCodes</a>.<a href="#d46eb6624c1acdff" class="i field">PluginContextNotFound</a>,
                            <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(
                                <span class="i">RemotingErrorIdStrings</span>.<span class="i">WSManPluginContextNotFound</span>));
                        <b>return</b>;
                    }
 
                    <span class="c">// this will ReportOperationComplete by itself..</span>
                    <span class="c">// so we just here.</span>
                    <span class="r152 r">pluginToUse</span>.<a href="#9d17aab9b2b586d1" class="i method">StopCommand</a>(<span class="r150 r">request</span>, <span class="r147 r">shellContext</span>, <span class="r148 r">commandContext</span>);
                    <b>return</b>;
                }
            }
 
            <a href="#c8d0e78b633d4f66" class="i method">ReportOperationComplete</a>(<span class="r150 r">request</span>, <a href="#a42b50e40ac07da8" class="t t">WSManPluginErrorCodes</a>.<a href="#39442c3488d17250" class="i field">NoError</a>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Close the operation specified by the supplied context.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r153 r">context</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal static void</b> <a id="2103a47783d6d1c5" href="../../../R/2103a47783d6d1c5.html" target="n" data-glyph="74,1" class="i method">PerformCloseOperation</a>(
            <a href="#3e5455aa49779e8c" class="t t">WSManPluginOperationShutdownContext</a> <span id="r153 rd" class="r153 r">context</span>)
        {
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(
                <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#97a04fcf34529508" class="i field">ServerReceivedData</a>,
                <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#399fd86ea109ec79" class="i field">Open</a>,
                <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a59ff5f5d029e4d1" class="i field">ManagedPlugin</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                <b>string</b>.<span class="i">Empty</span>,
                <span class="s">&quot;PerformCloseOperation: Invoked&quot;</span>,
                <b>string</b>.<span class="i">Empty</span>);
 
            <a href="#23ee55d6d8a367a2" class="t t">WSManPluginInstance</a> <span id="r154 rd" class="r154 r">pluginToUse</span> = <a href="#6cadb9a20812ea8b" class="i method">GetFromActivePlugins</a>(<span class="r153 r">context</span>.<a href="#ad231a2a230ba5d7" class="i field">pluginContext</a>);
 
            <b>if</b> (<span class="r154 r">pluginToUse</span> == <b>null</b>)
            {
                <b>return</b>;
            }
 
            <b>if</b> (<span class="r153 r">context</span>.<a href="#13481c936788e297" class="i field">commandContext</a> == <span class="i">IntPtr</span>.<span class="i">Zero</span>)
            {
                <span class="c">// this is targeted at shell</span>
                <span class="r154 r">pluginToUse</span>.<a href="#87be4f0e6c2fbbfb" class="i method">CloseShellOperation</a>(<span class="r153 r">context</span>);
            }
            <b>else</b>
            {
                <span class="c">// shutdown is targeted at command</span>
                <span class="r154 r">pluginToUse</span>.<a href="#fad0f9203aae26e0" class="i method">CloseCommandOperation</a>(<span class="r153 r">context</span>);
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Performs deinitialization during shutdown.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r155 r">pluginContext</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal static void</b> <a id="881be05170dd6b16" href="../../../R/881be05170dd6b16.html" target="n" data-glyph="74,1" class="i method">PerformShutdown</a>(
            <span class="i">IntPtr</span> <span id="r155 rd" class="r155 r">pluginContext</span>)
        {
            <a href="#23ee55d6d8a367a2" class="t t">WSManPluginInstance</a> <span id="r156 rd" class="r156 r">pluginToUse</span> = <a href="#6cadb9a20812ea8b" class="i method">GetFromActivePlugins</a>(<span class="r155 r">pluginContext</span>);
 
            <b>if</b> (<span class="r156 r">pluginToUse</span> == <b>null</b>)
            {
                <b>return</b>;
            }
 
            <span class="r156 r">pluginToUse</span>.<a href="#5b310a9ed9de377c" class="i method">Shutdown</a>();
        }
 
        <b>private static</b> <a href="#23ee55d6d8a367a2" class="t t">WSManPluginInstance</a> <a id="6cadb9a20812ea8b" href="../../../R/6cadb9a20812ea8b.html" target="n" data-glyph="76,1" class="i method">GetFromActivePlugins</a>(<span class="i">IntPtr</span> <span id="r157 rd" class="r157 r">pluginContext</span>)
        {
            <b>lock</b> (<a href="#2a5df8eaf4582089" class="i field">s_activePlugins</a>)
            {
                <a href="#23ee55d6d8a367a2" class="t t">WSManPluginInstance</a> <span id="r158 rd" class="r158 r">result</span> = <b>null</b>;
                <a href="#2a5df8eaf4582089" class="i field">s_activePlugins</a>.<span class="i">TryGetValue</span>(<span class="r157 r">pluginContext</span>, <b>out</b> <span class="r158 r">result</span>);
                <b>return</b> <span class="r158 r">result</span>;
            }
        }
 
        <b>private static void</b> <a id="57b040aee4281e27" href="../../../R/57b040aee4281e27.html" target="n" data-glyph="76,1" class="i method">AddToActivePlugins</a>(<span class="i">IntPtr</span> <span id="r159 rd" class="r159 r">pluginContext</span>, <a href="#23ee55d6d8a367a2" class="t t">WSManPluginInstance</a> <span id="r160 rd" class="r160 r">plugin</span>)
        {
            <b>lock</b> (<a href="#2a5df8eaf4582089" class="i field">s_activePlugins</a>)
            {
                <b>if</b> (!<a href="#2a5df8eaf4582089" class="i field">s_activePlugins</a>.<span class="i">ContainsKey</span>(<span class="r159 r">pluginContext</span>))
                {
                    <a href="#2a5df8eaf4582089" class="i field">s_activePlugins</a>.<span class="i">Add</span>(<span class="r159 r">pluginContext</span>, <span class="r160 r">plugin</span>);
                    <b>return</b>;
                }
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Utilities
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Report operation complete to WSMan and supply a reason (if any)</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r161 r">requestDetails</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r162 r">errorCode</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal static void</b> <a id="27a43fd6d5b8200e" href="../../../R/27a43fd6d5b8200e.html" target="n" data-glyph="74,1" class="i method">ReportWSManOperationComplete</a>(
            <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#07d21d2cee8c9d82" class="t t">WSManPluginRequest</a> <span id="r161 rd" class="r161 r">requestDetails</span>,
            <a href="#a42b50e40ac07da8" class="t t">WSManPluginErrorCodes</a> <span id="r162 rd" class="r162 r">errorCode</span>)
        {
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r161 r">requestDetails</span> != <b>null</b>, <span class="s">&quot;requestDetails cannot be null in operation complete.&quot;</span>);
 
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(
                <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#ace81b72cf5e0c44" class="i field">ReportOperationComplete</a>,
                <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#7bf2b73f1de59d2e" class="i field">Close</a>, <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a59ff5f5d029e4d1" class="i field">ManagedPlugin</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                (<span class="r161 r">requestDetails</span>.<a href="WSManNativeAPI.cs.html#0bd4e014382d2f95" class="i field">unmanagedHandle</a>).<span class="i">ToString</span>(),
                <span class="i">Convert</span>.<span class="i">ToString</span>(<span class="r162 r">errorCode</span>, <span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>),
                <b>string</b>.<span class="i">Empty</span>,
                <b>string</b>.<span class="i">Empty</span>);
 
            <a href="#006f2e301f46b5b1" class="i method">ReportOperationComplete</a>(<span class="r161 r">requestDetails</span>.<a href="WSManNativeAPI.cs.html#0bd4e014382d2f95" class="i field">unmanagedHandle</a>, <span class="r162 r">errorCode</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Extract message from exception (if any) and report operation complete with it to WSMan.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r163 r">requestDetails</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r164 r">reasonForClose</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal static void</b> <a id="22822c39bf35704d" href="../../../R/22822c39bf35704d.html" target="n" data-glyph="74,1" class="i method">ReportWSManOperationComplete</a>(
            <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#07d21d2cee8c9d82" class="t t">WSManPluginRequest</a> <span id="r163 rd" class="r163 r">requestDetails</span>,
            <span class="i">Exception</span> <span id="r164 rd" class="r164 r">reasonForClose</span>)
        {
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r163 r">requestDetails</span> != <b>null</b>, <span class="s">&quot;requestDetails cannot be null in operation complete.&quot;</span>);
 
            <a href="#a42b50e40ac07da8" class="t t">WSManPluginErrorCodes</a> <span id="r165 rd" class="r165 r">error</span> = <a href="#a42b50e40ac07da8" class="t t">WSManPluginErrorCodes</a>.<a href="#39442c3488d17250" class="i field">NoError</a>;
            <b>string</b> <span id="r166 rd" class="r166 r">errorMessage</span> = <b>string</b>.<span class="i">Empty</span>;
            <b>string</b> <span id="r167 rd" class="r167 r">stackTrace</span> = <b>string</b>.<span class="i">Empty</span>;
 
            <b>if</b> (<span class="r164 r">reasonForClose</span> != <b>null</b>)
            {
                <span class="r165 r">error</span> = <a href="#a42b50e40ac07da8" class="t t">WSManPluginErrorCodes</a>.<a href="#9884203a81bf3f15" class="i field">ManagedException</a>;
                <span class="r166 r">errorMessage</span> = <span class="r164 r">reasonForClose</span>.<span class="i">Message</span>;
                <span class="r167 r">stackTrace</span> = <span class="r164 r">reasonForClose</span>.<span class="i">StackTrace</span>;
            }
 
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(
                <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#ace81b72cf5e0c44" class="i field">ReportOperationComplete</a>,
                <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#7bf2b73f1de59d2e" class="i field">Close</a>, <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a59ff5f5d029e4d1" class="i field">ManagedPlugin</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                <span class="r163 r">requestDetails</span>.<span class="i">ToString</span>(),
                <span class="i">Convert</span>.<span class="i">ToString</span>(<span class="r165 r">error</span>, <span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>),
                <span class="r166 r">errorMessage</span>,
                <span class="r167 r">stackTrace</span>);
 
            <b>if</b> (<span class="r164 r">reasonForClose</span> != <b>null</b>)
            {
                <span class="c">// report operation complete to wsman with the error message (if any).</span>
                <a href="#34bada9077aac474" class="i method">ReportOperationComplete</a>(
                    <span class="r163 r">requestDetails</span>,
                    <a href="#a42b50e40ac07da8" class="t t">WSManPluginErrorCodes</a>.<a href="#9884203a81bf3f15" class="i field">ManagedException</a>,
                    <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(
                        <span class="i">RemotingErrorIdStrings</span>.<span class="i">WSManPluginManagedException</span>,
                        <span class="r164 r">reasonForClose</span>.<span class="i">Message</span>));
            }
            <b>else</b>
            {
                <a href="#006f2e301f46b5b1" class="i method">ReportOperationComplete</a>(
                    <span class="r163 r">requestDetails</span>.<a href="WSManNativeAPI.cs.html#0bd4e014382d2f95" class="i field">unmanagedHandle</a>,
                    <a href="#a42b50e40ac07da8" class="t t">WSManPluginErrorCodes</a>.<a href="#39442c3488d17250" class="i field">NoError</a>);
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Sets thread properties like UI Culture, Culture etc..This is needed as code is transitioning from</span>
        <span class="c">///</span><span class="c"> unmanaged heap to managed heap...and thread properties are not set correctly during this</span>
        <span class="c">///</span><span class="c"> transition.</span>
        <span class="c">///</span><span class="c"> Currently WSMan provider supplies only UI Culture related data..so only UI Culture is set.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r168 r">requestDetails</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal static void</b> <a id="cafbb195850f1ca3" href="../../../R/cafbb195850f1ca3.html" target="n" data-glyph="74,1" class="i method">SetThreadProperties</a>(
            <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#07d21d2cee8c9d82" class="t t">WSManPluginRequest</a> <span id="r168 rd" class="r168 r">requestDetails</span>)
        {
            <span class="c">// requestDetails cannot not be null.</span>
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r168 r">requestDetails</span> != <b>null</b>, <span class="s">&quot;requestDetails cannot be null&quot;</span>);
 
            <span class="c">// IntPtr nativeLocaleData = IntPtr.Zero;</span>
            <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#5c14c561aee60b63" class="t t">WSManDataStruct</a> <span id="r169 rd" class="r169 r">outputStruct</span> = <b>new</b> <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<span class="t">WSManDataStruct</span>();
            <b>int</b> <span id="r170 rd" class="r170 r">hResult</span> = <a href="#3331cc0274ebff08" class="i field">wsmanPinvokeStatic</a>.<a href="WSManNativeAPI.cs.html#ca3e0de4396c7f3c" class="i method">WSManPluginGetOperationParameters</a>(
                <span class="r168 r">requestDetails</span>.<a href="WSManNativeAPI.cs.html#0bd4e014382d2f95" class="i field">unmanagedHandle</a>,
                <a href="#f1ff81f0faba1926" class="t t">WSManPluginConstants</a>.<a href="#9e6e9de7915623cc" class="i field">WSManPluginParamsGetRequestedLocale</a>,
                <span class="r169 r">outputStruct</span>);
            <span class="c">// ref nativeLocaleData);</span>
            <b>bool</b> <span id="r171 rd" class="r171 r">retrievingLocaleSucceeded</span> = (<span class="r170 r">hResult</span> == 0);
            <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#456a9677b88cb3ef" class="t t">WSManData_UnToMan</a> <span id="r172 rd" class="r172 r">localeData</span> = <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#456a9677b88cb3ef" class="t t">WSManData_UnToMan</a>.<a href="WSManNativeAPI.cs.html#35b6d766c359db6f" class="i method">UnMarshal</a>(<span class="r169 r">outputStruct</span>); <span class="c">// nativeLocaleData</span>
 
            <span class="c">// IntPtr nativeDataLocaleData = IntPtr.Zero;</span>
            <span class="r170 r">hResult</span> = <a href="#3331cc0274ebff08" class="i field">wsmanPinvokeStatic</a>.<a href="WSManNativeAPI.cs.html#ca3e0de4396c7f3c" class="i method">WSManPluginGetOperationParameters</a>(
                <span class="r168 r">requestDetails</span>.<a href="WSManNativeAPI.cs.html#0bd4e014382d2f95" class="i field">unmanagedHandle</a>,
                <a href="#f1ff81f0faba1926" class="t t">WSManPluginConstants</a>.<a href="#2e426cfd22d1ed6d" class="i field">WSManPluginParamsGetRequestedDataLocale</a>,
                <span class="r169 r">outputStruct</span>);
            <span class="c">// ref nativeDataLocaleData);</span>
            <b>bool</b> <span id="r173 rd" class="r173 r">retrievingDataLocaleSucceeded</span> = (<span class="r170 r">hResult</span> == (<b>int</b>)<a href="#a42b50e40ac07da8" class="t t">WSManPluginErrorCodes</a>.<a href="#39442c3488d17250" class="i field">NoError</a>);
            <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#456a9677b88cb3ef" class="t t">WSManData_UnToMan</a> <span id="r174 rd" class="r174 r">dataLocaleData</span> = <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#456a9677b88cb3ef" class="t t">WSManData_UnToMan</a>.<a href="WSManNativeAPI.cs.html#35b6d766c359db6f" class="i method">UnMarshal</a>(<span class="r169 r">outputStruct</span>); <span class="c">// nativeDataLocaleData</span>
 
            <span class="c">// Set the UI Culture</span>
            <b>try</b>
            {
                <b>if</b> (<span class="r171 r">retrievingLocaleSucceeded</span> &amp;&amp; (<span class="r172 r">localeData</span>.<a href="WSManNativeAPI.cs.html#1e7e9090a55ed442" class="i property">Type</a> == (<b>uint</b>)<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#46ddd0c66b953490" class="t t">WSManDataType</a>.<a href="WSManNativeAPI.cs.html#1a9738dd5816811e" class="i field">WSMAN_DATA_TYPE_TEXT</a>))
                {
                    <span class="i">CultureInfo</span> <span id="r175 rd" class="r175 r">uiCultureToUse</span> = <b>new</b> <span class="i">CultureInfo</span>(<span class="r172 r">localeData</span>.<a href="WSManNativeAPI.cs.html#ed072da1616e6b8a" class="i property">Text</a>);
                    <span class="i">Thread</span>.<span class="i">CurrentThread</span>.<span class="i">CurrentUICulture</span> = <span class="r175 r">uiCultureToUse</span>;
                }
            }
            <span class="c">// ignore if there is any exception constructing the culture..</span>
            <b>catch</b> (<span class="i">ArgumentException</span>)
            {
            }
 
            <span class="c">// Set the Culture</span>
            <b>try</b>
            {
                <b>if</b> (<span class="r173 r">retrievingDataLocaleSucceeded</span> &amp;&amp; (<span class="r174 r">dataLocaleData</span>.<a href="WSManNativeAPI.cs.html#1e7e9090a55ed442" class="i property">Type</a> == (<b>uint</b>)<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#46ddd0c66b953490" class="t t">WSManDataType</a>.<a href="WSManNativeAPI.cs.html#1a9738dd5816811e" class="i field">WSMAN_DATA_TYPE_TEXT</a>))
                {
                    <span class="i">CultureInfo</span> <span id="r176 rd" class="r176 r">cultureToUse</span> = <b>new</b> <span class="i">CultureInfo</span>(<span class="r174 r">dataLocaleData</span>.<a href="WSManNativeAPI.cs.html#ed072da1616e6b8a" class="i property">Text</a>);
                    <span class="i">Thread</span>.<span class="i">CurrentThread</span>.<span class="i">CurrentCulture</span> = <span class="r176 r">cultureToUse</span>;
                }
            }
            <span class="c">// ignore if there is any exception constructing the culture..</span>
            <b>catch</b> (<span class="i">ArgumentException</span>)
            {
            }
        }
 
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">CORECLR</span>
<span class="e">        /// &lt;summary&gt;
        /// Handle any unhandled exceptions that get raised in the AppDomain
        /// This will log the exception into Crimson logs.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;sender&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;args&quot;&gt;&lt;/param&gt;
        internal static void UnhandledExceptionHandler(
            object sender,
            UnhandledExceptionEventArgs args)
        {
            // args can never be null.
            Exception exception = (Exception)args.ExceptionObject;
 
            PSEtwLog.LogOperationalError(PSEventId.AppDomainUnhandledException,
                    PSOpcode.Close, PSTask.None,
                    PSKeyword.UseAlwaysOperational,
                    exception.GetType().ToString(), exception.Message,
                    exception.StackTrace);
 
            PSEtwLog.LogAnalyticError(PSEventId.AppDomainUnhandledException_Analytic,
                    PSOpcode.Close, PSTask.None,
                    PSKeyword.ManagedPlugin | PSKeyword.UseAlwaysAnalytic,
                    exception.GetType().ToString(), exception.Message,
                    exception.StackTrace);
        }
</span><span class="k preprocess">#</span><span class="k preprocess">endif</span>
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Alternate wrapper for WSManPluginOperationComplete. TODO: Needed? I could easily use the handle instead and get rid of this? It is only for easier refactoring...</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r177 r">requestDetails</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r178 r">errorCode</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r179 r">errorMessage</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Pre-formatted localized string.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal static void</b> <a id="34bada9077aac474" href="../../../R/34bada9077aac474.html" target="n" data-glyph="74,1" class="i method">ReportOperationComplete</a>(
            <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#07d21d2cee8c9d82" class="t t">WSManPluginRequest</a> <span id="r177 rd" class="r177 r">requestDetails</span>,
            <a href="#a42b50e40ac07da8" class="t t">WSManPluginErrorCodes</a> <span id="r178 rd" class="r178 r">errorCode</span>,
            <b>string</b> <span id="r179 rd" class="r179 r">errorMessage</span>)
        {
            <b>if</b> (<span class="r177 r">requestDetails</span> != <b>null</b>)
            {
                <a href="#006f2e301f46b5b1" class="i method">ReportOperationComplete</a>(<span class="r177 r">requestDetails</span>.<a href="WSManNativeAPI.cs.html#0bd4e014382d2f95" class="i field">unmanagedHandle</a>, <span class="r178 r">errorCode</span>, <span class="r179 r">errorMessage</span>);
            }
            <span class="c">// else cannot report if requestDetails is null.</span>
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Wrapper for WSManPluginOperationComplete. It performs validation prior to making the call.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r180 r">requestDetails</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r181 r">errorCode</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal static void</b> <a id="c8d0e78b633d4f66" href="../../../R/c8d0e78b633d4f66.html" target="n" data-glyph="74,1" class="i method">ReportOperationComplete</a>(
            <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#07d21d2cee8c9d82" class="t t">WSManPluginRequest</a> <span id="r180 rd" class="r180 r">requestDetails</span>,
            <a href="#a42b50e40ac07da8" class="t t">WSManPluginErrorCodes</a> <span id="r181 rd" class="r181 r">errorCode</span>)
        {
            <b>if</b> (<span class="r180 r">requestDetails</span> != <b>null</b> &amp;&amp;
                <span class="r180 r">requestDetails</span>.<a href="WSManNativeAPI.cs.html#0bd4e014382d2f95" class="i field">unmanagedHandle</a> != <span class="i">IntPtr</span>.<span class="i">Zero</span>)
            {
                <a href="#3331cc0274ebff08" class="i field">wsmanPinvokeStatic</a>.<a href="WSManNativeAPI.cs.html#cfb1e739f56c60d3" class="i method">WSManPluginOperationComplete</a>(
                    <span class="r180 r">requestDetails</span>.<a href="WSManNativeAPI.cs.html#0bd4e014382d2f95" class="i field">unmanagedHandle</a>,
                    0,
                    (<b>int</b>)<span class="r181 r">errorCode</span>,
                    <b>null</b>);
            }
            <span class="c">// else cannot report if requestDetails is null.</span>
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Wrapper for WSManPluginOperationComplete. It performs validation prior to making the call.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r182 r">requestDetails</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r183 r">errorCode</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r184 r">errorMessage</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal static void</b> <a id="006f2e301f46b5b1" href="../../../R/006f2e301f46b5b1.html" target="n" data-glyph="74,1" class="i method">ReportOperationComplete</a>(
            <span class="i">IntPtr</span> <span id="r182 rd" class="r182 r">requestDetails</span>,
            <a href="#a42b50e40ac07da8" class="t t">WSManPluginErrorCodes</a> <span id="r183 rd" class="r183 r">errorCode</span>,
            <b>string</b> <span id="r184 rd" class="r184 r">errorMessage</span> = <span class="s">&quot;&quot;</span>)
        {
            <b>if</b> (<span class="r182 r">requestDetails</span> == <span class="i">IntPtr</span>.<span class="i">Zero</span>)
            {
                <span class="c">// cannot report if requestDetails is null.</span>
                <b>return</b>;
            }
 
            <a href="#3331cc0274ebff08" class="i field">wsmanPinvokeStatic</a>.<a href="WSManNativeAPI.cs.html#cfb1e739f56c60d3" class="i method">WSManPluginOperationComplete</a>(
                <span class="r182 r">requestDetails</span>,
                0,
                (<b>int</b>)<span class="r183 r">errorCode</span>,
                <span class="r184 r">errorMessage</span>);
 
            <b>return</b>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
    }
}
</pre></td></tr></table></div></body></html>
