<!DOCTYPE html>
<html><head><title>BaseTransportManager.cs</title><link rel="stylesheet" href="../../../../styles.css"><script src="../../../../scripts.js"></script></head>
<body class="cB" onload="i(1541);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#System.Management.Automation/engine/remoting/fanin/BaseTransportManager.cs" target="_top">engine\remoting\fanin\BaseTransportManager.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#System.Management.Automation" target="_top">src\System.Management.Automation\System.Management.Automation.csproj</a> (System.Management.Automation)</td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation.</span>
<span class="c">// Licensed under the MIT License.</span>
 
<span class="c">/*
 * Common file that contains interface definitions for generic server and client
 * transport managers.
 *
 */</span>
 
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Tracing</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Text</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">IO</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Xml</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Collections</span>.<span class="i">Generic</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Globalization</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Threading</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Internal</span>;
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">UNIX</span>
<b>using</b> <span class="i n">System</span>.<span class="i">Security</span>.<span class="i">Principal</span>;
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
 
<span class="c">// Don&#39;t expose the System.Management.Automation namespace here. This is transport layer</span>
<span class="c">// and it shouldn&#39;t know anything about the engine.</span>
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Remoting</span>.<span class="i n">Client</span>;
<span class="c">// TODO: this seems ugly...Remoting datatypes should be in remoting namespace</span>
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Runspaces</span>.<span class="i n">Internal</span>;
<b>using</b> <span class="t">PSRemotingCryptoHelper</span> = <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Internal</span>.<a href="../../../utils/CryptoUtils.cs.html#1999dfb2439af5a0" class="t t">PSRemotingCryptoHelper</a>;
<b>using</b> <span class="t">RunspaceConnectionInfo</span> = <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Runspaces</span>.<a href="../common/RunspaceConnectionInfo.cs.html#e07ed56a8a1da829" class="t t">RunspaceConnectionInfo</a>;
<b>using</b> <span class="t">TypeTable</span> = <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Runspaces</span>.<a href="../../../P/a09d9b2cb7b1f0db.html#a09d9b2cb7b1f0db" class="t t">TypeTable</a>;
<b>using</b> <span class="t">Dbg</span> = <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Diagnostics</a>;
 
<b>namespace</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Remoting</span>
{
    <span class="k preprocess">#</span><span class="k preprocess">region</span> TransportErrorOccuredEventArgs
 
    <b>internal enum</b> <a id="33678df914ca9daf" href="../../../R/33678df914ca9daf.html" target="n" data-glyph="20,0" class="t t"><span id="6e6c03666f3d24b2">TransportMethodEnum</span></a>
    {
        <a id="a8019a6497e609cf" href="../../../R/a8019a6497e609cf.html" target="n" data-glyph="24,1" class="i field">CreateShellEx</a> = 0,
        <a id="5d183ac69af9da42" href="../../../R/5d183ac69af9da42.html" target="n" data-glyph="24,1" class="i field">RunShellCommandEx</a> = 1,
        <a id="5ae525a3ca59a711" href="../../../R/5ae525a3ca59a711.html" target="n" data-glyph="24,1" class="i field">SendShellInputEx</a> = 2,
        <a id="c91edb639e1ae62a" href="../../../R/c91edb639e1ae62a.html" target="n" data-glyph="24,1" class="i field">ReceiveShellOutputEx</a> = 3,
        <a id="2cc9ee1cdce7fca6" href="../../../R/2cc9ee1cdce7fca6.html" target="n" data-glyph="24,1" class="i field">CloseShellOperationEx</a> = 4,
        <a id="431d95f3744e9b1c" href="../../../R/431d95f3744e9b1c.html" target="n" data-glyph="24,1" class="i field">CommandInputEx</a> = 5,
        <a id="1aa4ae0cf31f0f4c" href="../../../R/1aa4ae0cf31f0f4c.html" target="n" data-glyph="24,1" class="i field">ReceiveCommandOutputEx</a> = 6,
        <a id="e160f65b31655451" href="../../../R/e160f65b31655451.html" target="n" data-glyph="24,1" class="i field">DisconnectShellEx</a> = 7,
        <a id="f540cc47457e7954" href="../../../R/f540cc47457e7954.html" target="n" data-glyph="24,1" class="i field">ReconnectShellEx</a> = 8,
        <a id="cf9cf28252f73349" href="../../../R/cf9cf28252f73349.html" target="n" data-glyph="24,1" class="i field">ConnectShellEx</a> = 9,
        <a id="6e302be1fed98601" href="../../../R/6e302be1fed98601.html" target="n" data-glyph="24,1" class="i field">ReconnectShellCommandEx</a> = 10,
        <a id="2166b6b8302add46" href="../../../R/2166b6b8302add46.html" target="n" data-glyph="24,1" class="i field">ConnectShellCommandEx</a> = 11,
        <a id="ec9b351bc6228ffe" href="../../../R/ec9b351bc6228ffe.html" target="n" data-glyph="24,1" class="i field">Unknown</a> = 12,
    }
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Event arguments passed to TransportErrorOccured handlers.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>internal class</b> <a id="7e70b34f9332dfcd" href="../../../R/7e70b34f9332dfcd.html" target="n" data-glyph="2,0" class="t t">TransportErrorOccuredEventArgs</a> : <span class="i">EventArgs</span>
    {
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Constructor.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r0 r">e</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Error occurred.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r1 r">m</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The transport method that raised the error</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal</b> <a id="c420864940871a42" href="../../../R/c420864940871a42.html" target="n" data-glyph="74,1" class="t constructor">TransportErrorOccuredEventArgs</a>(<a href="../common/remotingexceptions.cs.html#0bb8687f97d91059" class="t t">PSRemotingTransportException</a> <span id="r0 rd" class="r0 r">e</span>,
            <a href="#33678df914ca9daf" class="t t">TransportMethodEnum</a> <span id="r1 rd" class="r1 r">m</span>)
        {
            <a href="#f82124202b7ff8f0" class="i property">Exception</a> = <span class="r0 r">e</span>;
            <a href="#15ff1bff6090f5d7" class="i property">ReportingTransportMethod</a> = <span class="r1 r">m</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the error occurred.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal</b> <a href="../common/remotingexceptions.cs.html#0bb8687f97d91059" class="t t">PSRemotingTransportException</a> <a id="f82124202b7ff8f0" href="../../../R/f82124202b7ff8f0.html" target="n" data-glyph="104,1" class="i property">Exception</a> { <b>get</b>; <b>set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Transport method that is reporting this error.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal</b> <a href="#33678df914ca9daf" class="t t">TransportMethodEnum</a> <a id="15ff1bff6090f5d7" href="../../../R/15ff1bff6090f5d7.html" target="n" data-glyph="104,1" class="i property">ReportingTransportMethod</a> { <b>get</b>; }
    }
 
    <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
    <span class="k preprocess">#</span><span class="k preprocess">region</span> ConnectionStatusEventArgs
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Robust Connection notifications.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>internal enum</b> <a id="6ddc495529412646" href="../../../R/6ddc495529412646.html" target="n" data-glyph="20,0" class="t t"><span id="5638a9c1cac3c654">ConnectionStatus</span></a>
    {
        <a id="db376fd8c7fe0b9b" href="../../../R/db376fd8c7fe0b9b.html" target="n" data-glyph="24,1" class="i field">NetworkFailureDetected</a> = 1,
        <a id="06149a477ad4b60b" href="../../../R/06149a477ad4b60b.html" target="n" data-glyph="24,1" class="i field">ConnectionRetryAttempt</a> = 2,
        <a id="f19577a101577365" href="../../../R/f19577a101577365.html" target="n" data-glyph="24,1" class="i field">ConnectionRetrySucceeded</a> = 3,
        <a id="f0d6555b08ab5f74" href="../../../R/f0d6555b08ab5f74.html" target="n" data-glyph="24,1" class="i field">AutoDisconnectStarting</a> = 4,
        <a id="de98a76dc253e5fe" href="../../../R/de98a76dc253e5fe.html" target="n" data-glyph="24,1" class="i field">AutoDisconnectSucceeded</a> = 5,
        <a id="8c22e95737ef7dd8" href="../../../R/8c22e95737ef7dd8.html" target="n" data-glyph="24,1" class="i field">InternalErrorAbort</a> = 6
    }
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> ConnectionStatusEventArgs.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>internal class</b> <a id="598698ed70e51507" href="../../../R/598698ed70e51507.html" target="n" data-glyph="2,0" class="t t">ConnectionStatusEventArgs</a> : <span class="i">EventArgs</span>
    {
        <b>internal</b> <a id="0f9f34d7fc3e602c" href="../../../R/0f9f34d7fc3e602c.html" target="n" data-glyph="74,1" class="t constructor">ConnectionStatusEventArgs</a>(<a href="#6ddc495529412646" class="t t">ConnectionStatus</a> <span id="r2 rd" class="r2 r">notification</span>)
        {
            <a href="#40c02c7ffd5fa7d4" class="i property">Notification</a> = <span class="r2 r">notification</span>;
        }
 
        <b>internal</b> <a href="#6ddc495529412646" class="t t">ConnectionStatus</a> <a id="40c02c7ffd5fa7d4" href="../../../R/40c02c7ffd5fa7d4.html" target="n" data-glyph="104,1" class="i property">Notification</a> { <b>get</b>; }
    }
 
    <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
    <span class="k preprocess">#</span><span class="k preprocess">region</span> CreateCompleteEventArgs
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> CreateCompleteEventArgs.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>internal class</b> <a id="7d43cc7a3ac54680" href="../../../R/7d43cc7a3ac54680.html" target="n" data-glyph="2,0" class="t t">CreateCompleteEventArgs</a> : <span class="i">EventArgs</span>
    {
        <b>internal</b> <a href="../common/RunspaceConnectionInfo.cs.html#e07ed56a8a1da829" class="t t">RunspaceConnectionInfo</a> <a id="42bc94ec2a83fd45" href="../../../R/42bc94ec2a83fd45.html" target="n" data-glyph="104,1" class="i property">ConnectionInfo</a> { <b>get</b>; }
 
        <b>internal</b> <a id="45cdeec22cf7f878" href="../../../R/45cdeec22cf7f878.html" target="n" data-glyph="74,1" class="t constructor">CreateCompleteEventArgs</a>(
            <a href="../common/RunspaceConnectionInfo.cs.html#e07ed56a8a1da829" class="t t">RunspaceConnectionInfo</a> <span id="r3 rd" class="r3 r">connectionInfo</span>)
        {
            <a href="#42bc94ec2a83fd45" class="i property">ConnectionInfo</a> = <span class="r3 r">connectionInfo</span>;
        }
    }
 
    <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Contains implementation that is common to both client and server</span>
    <span class="c">///</span><span class="c"> transport managers.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>internal abstract class</b> <a id="9ccd7ea4a824f9d8" href="../../../R/9ccd7ea4a824f9d8.html" target="n" data-glyph="2,0" class="t t">BaseTransportManager</a> : <span class="i">IDisposable</span>
    {
        <span class="k preprocess">#</span><span class="k preprocess">region</span> tracer
 
        [<span class="i">TraceSourceAttribute</span>(<span class="s">&quot;Transport&quot;</span>, <span class="s">&quot;Traces BaseWSManTransportManager&quot;</span>)]
        <b>private static readonly</b> <a href="../../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a> <a id="038467e260852711" href="../../../R/038467e260852711.html" target="n" data-glyph="46,1" class="i field">s_baseTracer</a> = <a href="../../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../../../utils/MshTraceSource.cs.html#697b06ec70e3c537" class="i method">GetTracer</a>(<span class="s">&quot;Transport&quot;</span>, <span class="s">&quot;Traces BaseWSManTransportManager&quot;</span>);
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Global Constants
 
        <span class="c">// KeepAlive: Server 4 minutes, Client 3 minutes</span>
        <span class="c">// The server timeout value has to be bigger than the client timeout value.</span>
        <span class="c">// This is due to the WinRM implementation on the Listener.</span>
        <span class="c">// So We added a 1 minute network delay to count for this.</span>
        <b>internal const int</b> <a id="28628a5e3ec42c6c" href="../../../R/28628a5e3ec42c6c.html" target="n" data-glyph="8,1" class="i field">ServerDefaultKeepAliveTimeoutMs</a> = 4 * 60 * 1000; <span class="c">// milliseconds = 4 minutes</span>
        <b>internal const int</b> <a id="21a6ee26ace3693f" href="../../../R/21a6ee26ace3693f.html" target="n" data-glyph="8,1" class="i field">ClientDefaultOperationTimeoutMs</a> = 3 * 60 * 1000; <span class="c">// milliseconds = 3 minutes</span>
        <span class="c">// Close timeout: to prevent unbounded close operation, we set a 1 minute bound.</span>
        <b>internal const int</b> <a id="15e8994ab378fbdd" href="../../../R/15e8994ab378fbdd.html" target="n" data-glyph="8,1" class="i field">ClientCloseTimeoutMs</a> = 60 * 1000;
 
        <span class="c">// This value instructs the server to use whatever setting it has for idle timeout.</span>
        <b>internal const int</b> <a id="1aeb21f2c249b1c1" href="../../../R/1aeb21f2c249b1c1.html" target="n" data-glyph="8,1" class="i field">UseServerDefaultIdleTimeout</a> = -1;
        <b>internal const uint</b> <a id="2f4e1b8fd6f7fcfa" href="../../../R/2f4e1b8fd6f7fcfa.html" target="n" data-glyph="8,1" class="i field">UseServerDefaultIdleTimeoutUInt</a> = <span class="i">UInt32</span>.<span class="i">MaxValue</span>;
 
        <span class="c">// Minimum allowed idle timeout time is 60 seconds.</span>
        <b>internal const int</b> <a id="d8495a878f117cdd" href="../../../R/d8495a878f117cdd.html" target="n" data-glyph="8,1" class="i field">MinimumIdleTimeout</a> = 60 * 1000;
 
        <b>internal const int</b> <a id="796de4ded764fff1" href="../../../R/796de4ded764fff1.html" target="n" data-glyph="8,1" class="i field">DefaultFragmentSize</a> = 32 &lt;&lt; 10; <span class="c">// 32KB</span>
 
        <span class="c">// Quota related consts and session variables.</span>
        <b>internal const int</b> <a id="7298ea980465451c" href="../../../R/7298ea980465451c.html" target="n" data-glyph="8,1" class="i field">MaximumReceivedDataSize</a> = 50 &lt;&lt; 20; <span class="c">// 50MB</span>
        <b>internal const int</b> <a id="f93a293eb909c256" href="../../../R/f93a293eb909c256.html" target="n" data-glyph="8,1" class="i field">MaximumReceivedObjectSize</a> = 10 &lt;&lt; 20; <span class="c">// 10MB</span>
 
        <span class="c">// Session variables supporting powershell quotas.</span>
        <b>internal const string</b> <a id="2e2911aec40d3de3" href="../../../R/../../0000000000.html" target="n" data-glyph="8,1" class="i field">MAX_RECEIVED_DATA_PER_COMMAND_MB</a> = <span class="s">&quot;PSMaximumReceivedDataSizePerCommandMB&quot;</span>;
        <b>internal const string</b> <a id="22c3aa14d94c582c" href="../../../R/../../0000000000.html" target="n" data-glyph="8,1" class="i field">MAX_RECEIVED_OBJECT_SIZE_MB</a> = <span class="s">&quot;PSMaximumReceivedObjectSizeMB&quot;</span>;
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Private Data
 
        <span class="c">// fragmentor used to fragment &amp; defragment objects added to this collection.</span>
        <b>private readonly</b> <a href="PriorityCollection.cs.html#b0dbabe933b81a2b" class="t t">ReceiveDataCollection</a>.<a href="PriorityCollection.cs.html#f79a7d2e805594f6" class="t t">OnDataAvailableCallback</a> <a id="3e20e9872c96eb46" href="../../../R/3e20e9872c96eb46.html" target="n" data-glyph="46,1" class="i field">_onDataAvailableCallback</a>;
 
        <span class="c">// crypto helper used for encrypting/decrypting</span>
        <span class="c">// secure string</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> EventHandlers
 
        <b>internal event</b> <span class="i">EventHandler</span>&lt;<a href="#7e70b34f9332dfcd" class="t t">TransportErrorOccuredEventArgs</a>&gt; <a id="85d6a6f2ebae43ff" href="../../../R/85d6a6f2ebae43ff.html" target="n" data-glyph="32,1" class="i">WSManTransportErrorOccured</a>;
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Event that is raised when a remote object is available. The event is raised</span>
        <span class="c">///</span><span class="c"> from a WSMan transport thread. Since this thread can hold on to a HTTP</span>
        <span class="c">///</span><span class="c"> connection, the event handler should complete processing as fast as possible.</span>
        <span class="c">///</span><span class="c"> Importantly the event handler should not generate any call that results in a</span>
        <span class="c">///</span><span class="c"> user request like host.ReadLine().</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal event</b> <span class="i">EventHandler</span>&lt;<a href="../common/misc.cs.html#5953d27b0d5ec137" class="t t">RemoteDataEventArgs</a>&gt; <a id="7b8ef65b8a2a6a41" href="../../../R/7b8ef65b8a2a6a41.html" target="n" data-glyph="32,1" class="i">DataReceived</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Listen to this event to observe the PowerShell guid of the processed object.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public event</b> <span class="i">EventHandler</span> <a id="94a8f941e97a279c" href="../../../R/94a8f941e97a279c.html" target="n" data-glyph="30,1" class="i">PowerShellGuidObserver</a>;
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Constructor
 
        <b>protected</b> <a id="78cdf954d5f46c58" href="../../../R/78cdf954d5f46c58.html" target="n" data-glyph="75,1" class="t constructor">BaseTransportManager</a>(<a href="../../../utils/CryptoUtils.cs.html#1999dfb2439af5a0" class="t t">PSRemotingCryptoHelper</a> <span id="r4 rd" class="r4 r">cryptoHelper</span>)
        {
            <a href="#30975a92e0bc8f5d" class="i property">CryptoHelper</a> = <span class="r4 r">cryptoHelper</span>;
            <span class="c">// create a common fragmentor used by this transport manager to send and receive data.</span>
            <span class="c">// so type information is serialized only the first time an object of a particular type</span>
            <span class="c">// is sent. only data is serialized for the rest of the objects of the same type.</span>
            <a href="#0597b18306926355" class="i property">Fragmentor</a> = <b>new</b> <a href="../common/fragmentor.cs.html#87c9a08087894441" class="t constructor">Fragmentor</a>(<a href="#796de4ded764fff1" class="i field">DefaultFragmentSize</a>, <span class="r4 r">cryptoHelper</span>);
            <a href="#766c6c998b78695f" class="i property">ReceivedDataCollection</a> = <b>new</b> <a href="PriorityCollection.cs.html#f294666cc37366a7" class="t constructor">PriorityReceiveDataCollection</a>(<a href="#0597b18306926355" class="i property">Fragmentor</a>, (<a href="#9ccd7ea4a824f9d8" class="k">this</a> <b>is</b> <a href="#ed2d81cd8d24599b" class="t t">BaseClientTransportManager</a>));
            <a href="#3e20e9872c96eb46" class="i field">_onDataAvailableCallback</a> = <b>new</b> <a href="PriorityCollection.cs.html#b0dbabe933b81a2b" class="t t">ReceiveDataCollection</a>.<span class="t">OnDataAvailableCallback</span>(<a href="#30b9165fa4b1d2aa" class="i method">OnDataAvailableCallback</a>);
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Helper Methods
 
        <b>internal</b> <a href="../common/fragmentor.cs.html#a24f4ee2533d5c38" class="t t">Fragmentor</a> <a id="0597b18306926355" href="../../../R/0597b18306926355.html" target="n" data-glyph="104,1" class="i property">Fragmentor</a> { <b>get</b>; <b>set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This is needed to deserialize objects coming from the network.</span>
        <span class="c">///</span><span class="c"> This may be null..in which case type rehydration does not happen.</span>
        <span class="c">///</span><span class="c"> At construction time we may not have typetable (server runspace</span>
        <span class="c">///</span><span class="c"> is created only when a request from the client)..so this is</span>
        <span class="c">///</span><span class="c"> a property on the base transport manager to allow for setting at</span>
        <span class="c">///</span><span class="c"> a later time.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal</b> <a href="../../../P/a09d9b2cb7b1f0db.html#a09d9b2cb7b1f0db" class="t t">TypeTable</a> <a id="0ded339d7f7c59f8" href="../../../R/0ded339d7f7c59f8.html" target="n" data-glyph="104,1" class="i property">TypeTable</a>
        {
            <b>get</b> { <b>return</b> <a href="#0597b18306926355" class="i property">Fragmentor</a>.<a href="../common/fragmentor.cs.html#68368520cad75c32" class="i property">TypeTable</a>; }
 
            <b>set</b> { <a href="#0597b18306926355" class="i property">Fragmentor</a>.<a href="../common/fragmentor.cs.html#68368520cad75c32" class="i property">TypeTable</a> = <b>value</b>; }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Uses the &quot;OnDataAvailableCallback&quot; to handle Deserialized objects.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r5 r">data</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> data to process</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r6 r">stream</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> priority stream this data belongs to</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal virtual void</b> <a id="34fedc1c13dfc998" href="../../../R/34fedc1c13dfc998.html" target="n" data-glyph="74,1" class="i method">ProcessRawData</a>(<b>byte</b>[] <span id="r5 rd" class="r5 r">data</span>, <b>string</b> <span id="r6 rd" class="r6 r">stream</span>)
        {
            <b>try</b>
            {
                <a href="#a3b20a16b9cde69a" class="i method">ProcessRawData</a>(<span class="r5 r">data</span>, <span class="r6 r">stream</span>, <a href="#3e20e9872c96eb46" class="i field">_onDataAvailableCallback</a>);
            }
            <b>catch</b> (<span class="i">Exception</span> <span id="r7 rd" class="r7 r">exception</span>)
            {
                <span class="c">// This will get executed on a thread pool thread..</span>
                <span class="c">// so we need to protect that thread, hence catching</span>
                <span class="c">// all exceptions</span>
                <a href="#038467e260852711" class="i field">s_baseTracer</a>.<span class="i">WriteLine</span>(<span class="s">&quot;Exception processing data. {0}&quot;</span>, <span class="r7 r">exception</span>.<span class="i">Message</span>);
 
                <a href="../common/remotingexceptions.cs.html#0bb8687f97d91059" class="t t">PSRemotingTransportException</a> <span id="r8 rd" class="r8 r">e</span> = <b>new</b> <span class="t">PSRemotingTransportException</span>(<span class="r7 r">exception</span>.<span class="i">Message</span>, <span class="r7 r">exception</span>);
                <a href="#7e70b34f9332dfcd" class="t t">TransportErrorOccuredEventArgs</a> <span id="r9 rd" class="r9 r">eventargs</span> =
                    <b>new</b> <a href="#c420864940871a42" class="t constructor">TransportErrorOccuredEventArgs</a>(<span class="r8 r">e</span>, <a href="#33678df914ca9daf" class="t t">TransportMethodEnum</a>.<a href="#c91edb639e1ae62a" class="i field">ReceiveShellOutputEx</a>);
                <a href="#8e00d8a2f8745652" class="i method">RaiseErrorHandler</a>(<span class="r9 r">eventargs</span>);
                <b>return</b>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r10 r">data</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> data to process</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r11 r">stream</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> priority stream this data belongs to</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r12 r">dataAvailableCallback</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> used by the caller to supply a callback to handle deserialized object.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">Exception</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Since dataAvailableCallback is called in this method, and the handler</span>
        <span class="c">///</span><span class="c"> may be handled by 3rd party code (eventually),this may throw any exception.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="a3b20a16b9cde69a" href="../../../R/a3b20a16b9cde69a.html" target="n" data-glyph="74,1" class="i method">ProcessRawData</a>(<b>byte</b>[] <span id="r10 rd" class="r10 r">data</span>,
            <b>string</b> <span id="r11 rd" class="r11 r">stream</span>,
            <a href="PriorityCollection.cs.html#b0dbabe933b81a2b" class="t t">ReceiveDataCollection</a>.<a href="PriorityCollection.cs.html#f79a7d2e805594f6" class="t t">OnDataAvailableCallback</a> <span id="r12 rd" class="r12 r">dataAvailableCallback</span>)
        {
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r10 r">data</span> != <b>null</b>, <span class="s">&quot;Cannot process null data&quot;</span>);
 
            <a href="#038467e260852711" class="i field">s_baseTracer</a>.<a href="../../../utils/StructuredTraceSource.cs.html#25b8416175e53218" class="i method">WriteLine</a>(<span class="s">&quot;Processing incoming data for stream {0}.&quot;</span>, <span class="r11 r">stream</span>);
 
            <b>bool</b> <span id="r13 rd" class="r13 r">shouldProcess</span> = <b>false</b>;
 
            <a href="PriorityCollection.cs.html#f0975201467fdc06" class="t t">DataPriorityType</a> <span id="r14 rd" class="r14 r">dataPriority</span> = <a href="PriorityCollection.cs.html#f0975201467fdc06" class="t t">DataPriorityType</a>.<a href="PriorityCollection.cs.html#e5092d1f4fa1babe" class="i field">Default</a>;
            <b>if</b> (<span class="r11 r">stream</span>.<span class="i">Equals</span>(<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#dc257aa7beeaf400" class="i field">WSMAN_STREAM_ID_STDIN</a>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>) ||
                <span class="r11 r">stream</span>.<span class="i">Equals</span>(<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#ab2f3becc1476649" class="i field">WSMAN_STREAM_ID_STDOUT</a>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
            {
                <span class="r13 r">shouldProcess</span> = <b>true</b>;
            }
            <b>else</b> <b>if</b> (<span class="r11 r">stream</span>.<span class="i">Equals</span>(<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#2dd82f73ca1e8381" class="i field">WSMAN_STREAM_ID_PROMPTRESPONSE</a>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
            {
                <span class="r14 r">dataPriority</span> = <a href="PriorityCollection.cs.html#f0975201467fdc06" class="t t">DataPriorityType</a>.<a href="PriorityCollection.cs.html#ef28607d20d8e243" class="i field">PromptResponse</a>;
                <span class="r13 r">shouldProcess</span> = <b>true</b>;
            }
 
            <b>if</b> (!<span class="r13 r">shouldProcess</span>)
            {
                <span class="c">// we dont support this stream..so ignore the data</span>
                <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<span class="i">Assert</span>(<b>false</b>,
                    <b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>, <span class="s">&quot;Data should be from one of the streams : {0} or {1} or {2}&quot;</span>,
                    <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#dc257aa7beeaf400" class="i field">WSMAN_STREAM_ID_STDIN</a>,
                    <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#ab2f3becc1476649" class="i field">WSMAN_STREAM_ID_STDOUT</a>,
                    <a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#2dd82f73ca1e8381" class="i field">WSMAN_STREAM_ID_PROMPTRESPONSE</a>));
                <a href="#038467e260852711" class="i field">s_baseTracer</a>.<a href="../../../utils/StructuredTraceSource.cs.html#25b8416175e53218" class="i method">WriteLine</a>(<span class="s">&quot;{0} is not a valid stream&quot;</span>, <span class="r11 r">stream</span>);
            }
            <span class="c">// process data</span>
            <a href="#766c6c998b78695f" class="i property">ReceivedDataCollection</a>.<a href="PriorityCollection.cs.html#98e30f2c73691b8f" class="i method">ProcessRawData</a>(<span class="r10 r">data</span>, <span class="r14 r">dataPriority</span>, <span class="r12 r">dataAvailableCallback</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r15 r">remoteObject</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">Exception</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The handler may be handled by 3rd party code (eventually),</span>
        <span class="c">///</span><span class="c"> this may throw any exception.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="30b9165fa4b1d2aa" href="../../../R/30b9165fa4b1d2aa.html" target="n" data-glyph="74,1" class="i method">OnDataAvailableCallback</a>(<a href="../common/WireDataFormat/RemotingDataObject.cs.html#ca4629603c976aab" class="t t">RemoteDataObject</a>&lt;<a href="../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt; <span id="r15 rd" class="r15 r">remoteObject</span>)
        {
            <span class="c">// log the data to crimson logs</span>
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(<a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#73c6aff550240da2" class="i field">TransportReceivedObject</a>, <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#399fd86ea109ec79" class="i field">Open</a>,
                                                  <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                                                  <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#c5d4a73b62c859ab" class="i field">Transport</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                                                  <span class="r15 r">remoteObject</span>.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#df5fe91d15e5ba71" class="i property">RunspacePoolId</a>.<span class="i">ToString</span>(),
                                                  <span class="r15 r">remoteObject</span>.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#767aea3474afdc8e" class="i property">PowerShellId</a>.<span class="i">ToString</span>(),
                                                  (<span class="i">UInt32</span>)(<span class="r15 r">remoteObject</span>.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#36fad9981dff9219" class="i property">Destination</a>),
                                                  (<span class="i">UInt32</span>)(<span class="r15 r">remoteObject</span>.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#97d7621b092d013f" class="i property">DataType</a>),
                                                  (<span class="i">UInt32</span>)(<span class="r15 r">remoteObject</span>.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#6975a2b0635b9f80" class="i property">TargetInterface</a>));
 
            <span class="c">// This might throw exceptions which the caller handles.</span>
            <a href="#94a8f941e97a279c" class="i">PowerShellGuidObserver</a>.<span class="i">SafeInvoke</span>(<span class="r15 r">remoteObject</span>.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#767aea3474afdc8e" class="i property">PowerShellId</a>, <span class="i">EventArgs</span>.<span class="i">Empty</span>);
 
            <a href="../common/misc.cs.html#5953d27b0d5ec137" class="t t">RemoteDataEventArgs</a> <span id="r16 rd" class="r16 r">eventArgs</span> = <b>new</b> <a href="../common/misc.cs.html#af43ac696a2be0b8" class="t constructor">RemoteDataEventArgs</a>(<span class="r15 r">remoteObject</span>);
            <a href="#7b8ef65b8a2a6a41" class="i">DataReceived</a>.<span class="i">SafeInvoke</span>(<a href="#9ccd7ea4a824f9d8" class="k">this</a>, <span class="r16 r">eventArgs</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Copy the DataReceived event handlers to the supplied transport Manager.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r17 r">transportManager</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>public void</b> <a id="3b30f5a51ce0cc61" href="../../../R/3b30f5a51ce0cc61.html" target="n" data-glyph="72,1" class="i method">MigrateDataReadyEventHandlers</a>(<a href="#9ccd7ea4a824f9d8" class="t t">BaseTransportManager</a> <span id="r17 rd" class="r17 r">transportManager</span>)
        {
            <b>foreach</b> (<span class="i">Delegate</span> <span id="r18 rd" class="r18 r">handler</span> <b>in</b> <span class="r17 r">transportManager</span>.<a href="#7b8ef65b8a2a6a41" class="i">DataReceived</a>.<span class="i">GetInvocationList</span>())
            {
                <a href="#7b8ef65b8a2a6a41" class="i">DataReceived</a> += (<span class="i">EventHandler</span>&lt;<a href="../common/misc.cs.html#5953d27b0d5ec137" class="t t">RemoteDataEventArgs</a>&gt;)<span class="r18 r">handler</span>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Raise the error handlers.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r19 r">eventArgs</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal virtual void</b> <a id="8e00d8a2f8745652" href="../../../R/8e00d8a2f8745652.html" target="n" data-glyph="74,1" class="i method">RaiseErrorHandler</a>(<a href="#7e70b34f9332dfcd" class="t t">TransportErrorOccuredEventArgs</a> <span id="r19 rd" class="r19 r">eventArgs</span>)
        {
            <a href="#85d6a6f2ebae43ff" class="i">WSManTransportErrorOccured</a>.<span class="i">SafeInvoke</span>(<a href="#9ccd7ea4a824f9d8" class="k">this</a>, <span class="r19 r">eventArgs</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Crypto handler to be used for encrypting/decrypting</span>
        <span class="c">///</span><span class="c"> secure strings.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal</b> <a href="../../../utils/CryptoUtils.cs.html#1999dfb2439af5a0" class="t t">PSRemotingCryptoHelper</a> <a id="30975a92e0bc8f5d" href="../../../R/30975a92e0bc8f5d.html" target="n" data-glyph="104,1" class="i property">CryptoHelper</a> { <b>get</b>; <b>set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> A data buffer used to store data received from remote machine.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal</b> <a href="PriorityCollection.cs.html#7f75e2bc64d1da2e" class="t t">PriorityReceiveDataCollection</a> <a id="766c6c998b78695f" href="../../../R/766c6c998b78695f.html" target="n" data-glyph="104,1" class="i property">ReceivedDataCollection</a> { <b>get</b>; }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> IDisposable implementation
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Dispose the transport and release resources.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public void</b> <a id="087693e06bcea17a" href="../../../R/087693e06bcea17a.html" target="n" data-glyph="72,1" class="i method">Dispose</a>()
        {
            <a href="#a9dbb33a8c08faaa" class="i method">Dispose</a>(<b>true</b>);
 
            <span class="c">// if already disposing..no need to let finalizer thread</span>
            <span class="c">// put resources to clean this object.</span>
            <span class="i n">System</span>.<span class="i">GC</span>.<span class="i">SuppressFinalize</span>(<a href="#9ccd7ea4a824f9d8" class="k">this</a>);
        }
 
        <b>internal virtual void</b> <a id="a9dbb33a8c08faaa" href="../../../R/a9dbb33a8c08faaa.html" target="n" data-glyph="74,1" class="i method">Dispose</a>(<b>bool</b> <span id="r20 rd" class="r20 r">isDisposing</span>)
        {
            <b>if</b> (<span class="r20 r">isDisposing</span>)
            {
                <a href="#766c6c998b78695f" class="i property">ReceivedDataCollection</a>.<a href="PriorityCollection.cs.html#887798f1f0f897b5" class="i method">Dispose</a>();
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
    }
}
 
<b>namespace</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Remoting</span>.<span class="i n">Client</span>
{
    <b>internal abstract class</b> <a id="ed2d81cd8d24599b" href="../../../R/ed2d81cd8d24599b.html" target="n" data-glyph="2,0" class="t t">BaseClientTransportManager</a> : <a href="#9ccd7ea4a824f9d8" class="t t">BaseTransportManager</a>, <span class="i">IDisposable</span>
    {
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Tracer
        [<span class="i">TraceSourceAttribute</span>(<span class="s">&quot;ClientTransport&quot;</span>, <span class="s">&quot;Traces ClientTransportManager&quot;</span>)]
        <b>protected static</b> <a href="../../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a> <a id="d0bdc8aaec3faf80" href="../../../R/d0bdc8aaec3faf80.html" target="n" data-glyph="45,1" class="i field">tracer</a> = <a href="../../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../../../utils/MshTraceSource.cs.html#697b06ec70e3c537" class="i method">GetTracer</a>(<span class="s">&quot;ClientTransport&quot;</span>, <span class="s">&quot;Traces ClientTransportManager&quot;</span>);
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Data
 
        <b>protected bool</b> <a id="76271338de46dcf0" href="../../../R/76271338de46dcf0.html" target="n" data-glyph="45,1" class="i field">isClosed</a>;
        <b>protected object</b> <a id="2b6037d6b3777ca1" href="../../../R/2b6037d6b3777ca1.html" target="n" data-glyph="45,1" class="i field">syncObject</a> = <b>new</b> <b>object</b>();
        <b>protected</b> <a href="PriorityCollection.cs.html#0fa204cb5092e738" class="t t">PrioritySendDataCollection</a> <a id="ee4a2ac1afa72dce" href="../../../R/ee4a2ac1afa72dce.html" target="n" data-glyph="45,1" class="i field">dataToBeSent</a>;
        <span class="c">// used to handle callbacks from the server..these are used to synchronize received callbacks</span>
        <b>private readonly</b> <span class="i">Queue</span>&lt;<a href="#847fa2a85ef1a3df" class="t t">CallbackNotificationInformation</a>&gt; <a id="ce5db200d48204fa" href="../../../R/ce5db200d48204fa.html" target="n" data-glyph="46,1" class="i field">_callbackNotificationQueue</a>;
        <b>private readonly</b> <a href="PriorityCollection.cs.html#b0dbabe933b81a2b" class="t t">ReceiveDataCollection</a>.<a href="PriorityCollection.cs.html#f79a7d2e805594f6" class="t t">OnDataAvailableCallback</a> <a id="e18dce3eba6f91bc" href="../../../R/e18dce3eba6f91bc.html" target="n" data-glyph="46,1" class="i field">_onDataAvailableCallback</a>;
        <b>private bool</b> <a id="d58c4a7ee8f9b7b3" href="../../../R/d58c4a7ee8f9b7b3.html" target="n" data-glyph="46,1" class="i field">_isServicingCallbacks</a>;
        <b>private bool</b> <a id="e9b0a5b99ebb694c" href="../../../R/e9b0a5b99ebb694c.html" target="n" data-glyph="46,1" class="i field">_suspendQueueServicing</a>;
        <b>private bool</b> <a id="fe0fc7c237cf7a19" href="../../../R/fe0fc7c237cf7a19.html" target="n" data-glyph="46,1" class="i field">_isDebuggerSuspend</a>;
 
        <span class="c">// this is used log crimson messages.</span>
 
        <span class="c">// keeps track of whether a receive request has been placed on transport</span>
        <b>protected bool</b> <a id="9a295d18d9f027e1" href="../../../R/9a295d18d9f027e1.html" target="n" data-glyph="45,1" class="i field">receiveDataInitiated</a>;
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Constructors
 
        <b>protected</b> <a id="a88452c7515e5700" href="../../../R/a88452c7515e5700.html" target="n" data-glyph="75,1" class="t constructor">BaseClientTransportManager</a>(<span class="i">Guid</span> <span id="r21 rd" class="r21 r">runspaceId</span>, <a href="../../../utils/CryptoUtils.cs.html#1999dfb2439af5a0" class="t t">PSRemotingCryptoHelper</a> <span id="r22 rd" class="r22 r">cryptoHelper</span>)
            : <a href="#78cdf954d5f46c58" class="k">base</a>(<span class="r22 r">cryptoHelper</span>)
        {
            <a href="#6b69cd5f8cc06fb7" class="i property">RunspacePoolInstanceId</a> = <span class="r21 r">runspaceId</span>;
            <a href="#ee4a2ac1afa72dce" class="i field">dataToBeSent</a> = <b>new</b> <a href="PriorityCollection.cs.html#4ed2b1f3350fac04" class="t constructor">PrioritySendDataCollection</a>();
            <a href="#e18dce3eba6f91bc" class="i field">_onDataAvailableCallback</a> = <b>new</b> <a href="PriorityCollection.cs.html#b0dbabe933b81a2b" class="t t">ReceiveDataCollection</a>.<span class="t">OnDataAvailableCallback</span>(<a href="#15de1a37f4681466" class="i method">OnDataAvailableHandler</a>);
            <a href="#ce5db200d48204fa" class="i field">_callbackNotificationQueue</a> = <b>new</b> <span class="i">Queue</span>&lt;<a href="#847fa2a85ef1a3df" class="t t">CallbackNotificationInformation</a>&gt;();
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Events
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Event that is raised when a create operation on transport has been successfully completed</span>
        <span class="c">///</span><span class="c"> The event is raised</span>
        <span class="c">///</span><span class="c"> from a WSMan transport thread. Since this thread can hold on to a HTTP</span>
        <span class="c">///</span><span class="c"> connection, the event handler should complete processing as fast as possible.</span>
        <span class="c">///</span><span class="c"> Importantly the event handler should not generate any call that results in a</span>
        <span class="c">///</span><span class="c"> user request like host.ReadLine().</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> Errors (occurred during connection attempt) are reported through WSManTransportErrorOccured</span>
        <span class="c">///</span><span class="c"> event.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal event</b> <span class="i">EventHandler</span>&lt;<a href="#7d43cc7a3ac54680" class="t t">CreateCompleteEventArgs</a>&gt; <a id="b775a320b2c726cd" href="../../../R/b775a320b2c726cd.html" target="n" data-glyph="32,1" class="i">CreateCompleted</a>;
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Event that is raised when a remote connection is successfully closed. The event is raised</span>
        <span class="c">///</span><span class="c"> from a WSMan transport thread. Since this thread can hold on to a HTTP</span>
        <span class="c">///</span><span class="c"> connection, the event handler should complete processing as fast as possible.</span>
        <span class="c">///</span><span class="c"> Importantly the event handler should not generate any call that results in a</span>
        <span class="c">///</span><span class="c"> user request like host.ReadLine().</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> Errors (occurred during connection attempt) are reported through WSManTransportErrorOccured</span>
        <span class="c">///</span><span class="c"> event.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The eventhandler should make sure not to throw any exceptions.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>internal event</b> <span class="i">EventHandler</span>&lt;<span class="i">EventArgs</span>&gt; <a id="a237a80d5d4b9bee" href="../../../R/a237a80d5d4b9bee.html" target="n" data-glyph="32,1" class="i">CloseCompleted</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Indicated successful completion of a connect operation on transport</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> Errors are reported through WSManTransportErrorOccured</span>
        <span class="c">///</span><span class="c"> event.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal event</b> <span class="i">EventHandler</span>&lt;<span class="i">EventArgs</span>&gt; <a id="99a709b2ef3c3bf4" href="../../../R/99a709b2ef3c3bf4.html" target="n" data-glyph="32,1" class="i">ConnectCompleted</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Indicated successful completion of a disconnect operation on transport</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> Errors are reported through WSManTransportErrorOccured</span>
        <span class="c">///</span><span class="c"> event.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal event</b> <span class="i">EventHandler</span>&lt;<span class="i">EventArgs</span>&gt; <a id="dc2c612e7bab7e2a" href="../../../R/dc2c612e7bab7e2a.html" target="n" data-glyph="32,1" class="i">DisconnectCompleted</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Indicated successful completion of a reconnect operation on transport</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> Errors are reported through WSManTransportErrorOccured</span>
        <span class="c">///</span><span class="c"> event.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal event</b> <span class="i">EventHandler</span>&lt;<span class="i">EventArgs</span>&gt; <a id="ab98168ad401f31e" href="../../../R/ab98168ad401f31e.html" target="n" data-glyph="32,1" class="i">ReconnectCompleted</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Indicates that the transport/command is ready for a disconnect operation.</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> Errors are reported through WSManTransportErrorOccured event.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal event</b> <span class="i">EventHandler</span>&lt;<span class="i">EventArgs</span>&gt; <a id="3deb153387243216" href="../../../R/3deb153387243216.html" target="n" data-glyph="32,1" class="i">ReadyForDisconnect</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Event to pass Robust Connection notifications to client.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal event</b> <span class="i">EventHandler</span>&lt;<a href="#598698ed70e51507" class="t t">ConnectionStatusEventArgs</a>&gt; <a id="1acdba1dd243046f" href="../../../R/1acdba1dd243046f.html" target="n" data-glyph="32,1" class="i">RobustConnectionNotification</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Indicates successful processing of a delay stream request on a receive operation</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> this event is useful when PS wants to invoke a pipeline in disconnected mode.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal event</b> <span class="i">EventHandler</span>&lt;<span class="i">EventArgs</span>&gt; <a id="7eeb502235c781ec" href="../../../R/7eeb502235c781ec.html" target="n" data-glyph="32,1" class="i">DelayStreamRequestProcessed</a>;
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Properties
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the data collection which is used by this transport manager to send</span>
        <span class="c">///</span><span class="c"> data to the server.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal</b> <a href="PriorityCollection.cs.html#0fa204cb5092e738" class="t t">PrioritySendDataCollection</a> <a id="f8317afa9f690e3b" href="../../../R/f8317afa9f690e3b.html" target="n" data-glyph="104,1" class="i property">DataToBeSentCollection</a>
        {
            <b>get</b> { <b>return</b> <a href="#ee4a2ac1afa72dce" class="i field">dataToBeSent</a>; }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Used to log crimson messages.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal</b> <span class="i">Guid</span> <a id="6b69cd5f8cc06fb7" href="../../../R/6b69cd5f8cc06fb7.html" target="n" data-glyph="104,1" class="i property">RunspacePoolInstanceId</a> { <b>get</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Raise the Connect completed handler.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="6d89008ab776a459" href="../../../R/6d89008ab776a459.html" target="n" data-glyph="74,1" class="i method">RaiseCreateCompleted</a>(<a href="#7d43cc7a3ac54680" class="t t">CreateCompleteEventArgs</a> <span id="r23 rd" class="r23 r">eventArgs</span>)
        {
            <a href="#b775a320b2c726cd" class="i">CreateCompleted</a>.<span class="i">SafeInvoke</span>(<a href="#ed2d81cd8d24599b" class="k">this</a>, <span class="r23 r">eventArgs</span>);
        }
 
        <b>internal void</b> <a id="ff51517e144ee45f" href="../../../R/ff51517e144ee45f.html" target="n" data-glyph="74,1" class="i method">RaiseConnectCompleted</a>()
        {
            <a href="#99a709b2ef3c3bf4" class="i">ConnectCompleted</a>.<span class="i">SafeInvoke</span>(<a href="#ed2d81cd8d24599b" class="k">this</a>, <span class="i">EventArgs</span>.<span class="i">Empty</span>);
        }
 
        <b>internal void</b> <a id="d26c71bd373e74ab" href="../../../R/d26c71bd373e74ab.html" target="n" data-glyph="74,1" class="i method">RaiseDisconnectCompleted</a>()
        {
            <a href="#dc2c612e7bab7e2a" class="i">DisconnectCompleted</a>.<span class="i">SafeInvoke</span>(<a href="#ed2d81cd8d24599b" class="k">this</a>, <span class="i">EventArgs</span>.<span class="i">Empty</span>);
        }
 
        <b>internal void</b> <a id="ce88eff5144dd47c" href="../../../R/ce88eff5144dd47c.html" target="n" data-glyph="74,1" class="i method">RaiseReconnectCompleted</a>()
        {
            <a href="#ab98168ad401f31e" class="i">ReconnectCompleted</a>.<span class="i">SafeInvoke</span>(<a href="#ed2d81cd8d24599b" class="k">this</a>, <span class="i">EventArgs</span>.<span class="i">Empty</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Raise the close completed handler.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="ce72d08b48a8f70f" href="../../../R/ce72d08b48a8f70f.html" target="n" data-glyph="74,1" class="i method">RaiseCloseCompleted</a>()
        {
            <a href="#a237a80d5d4b9bee" class="i">CloseCompleted</a>.<span class="i">SafeInvoke</span>(<a href="#ed2d81cd8d24599b" class="k">this</a>, <span class="i">EventArgs</span>.<span class="i">Empty</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Raise the ReadyForDisconnect event.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="d740e262e7f09e2e" href="../../../R/d740e262e7f09e2e.html" target="n" data-glyph="74,1" class="i method">RaiseReadyForDisconnect</a>()
        {
            <a href="#3deb153387243216" class="i">ReadyForDisconnect</a>.<span class="i">SafeInvoke</span>(<a href="#ed2d81cd8d24599b" class="k">this</a>, <span class="i">EventArgs</span>.<span class="i">Empty</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Queue the robust connection notification event.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r24 r">flags</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Determines what kind of notification.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="6bfce6081289c88c" href="../../../R/6bfce6081289c88c.html" target="n" data-glyph="74,1" class="i method">QueueRobustConnectionNotification</a>(<b>int</b> <span id="r24 rd" class="r24 r">flags</span>)
        {
            <a href="#598698ed70e51507" class="t t">ConnectionStatusEventArgs</a> <span id="r25 rd" class="r25 r">args</span> = <b>null</b>;
            <b>switch</b> (<span class="r24 r">flags</span>)
            {
                <b>case</b> (<b>int</b>)<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#4b939349c4d4b263" class="t t">WSManCallbackFlags</a>.<a href="WSManNativeAPI.cs.html#f545963b836576f8" class="i field">WSMAN_FLAG_CALLBACK_NETWORK_FAILURE_DETECTED</a>:
                    <span class="r25 r">args</span> = <b>new</b> <a href="#0f9f34d7fc3e602c" class="t constructor">ConnectionStatusEventArgs</a>(<a href="#6ddc495529412646" class="t t">ConnectionStatus</a>.<a href="#db376fd8c7fe0b9b" class="i field">NetworkFailureDetected</a>);
                    <b>break</b>;
 
                <b>case</b> (<b>int</b>)<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#4b939349c4d4b263" class="t t">WSManCallbackFlags</a>.<a href="WSManNativeAPI.cs.html#f87517a9a496651d" class="i field">WSMAN_FLAG_CALLBACK_RETRYING_AFTER_NETWORK_FAILURE</a>:
                    <span class="r25 r">args</span> = <b>new</b> <a href="#0f9f34d7fc3e602c" class="t constructor">ConnectionStatusEventArgs</a>(<a href="#6ddc495529412646" class="t t">ConnectionStatus</a>.<a href="#06149a477ad4b60b" class="i field">ConnectionRetryAttempt</a>);
                    <b>break</b>;
 
                <b>case</b> (<b>int</b>)<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#4b939349c4d4b263" class="t t">WSManCallbackFlags</a>.<a href="WSManNativeAPI.cs.html#61e65b7c046ca200" class="i field">WSMAN_FLAG_CALLBACK_RECONNECTED_AFTER_NETWORK_FAILURE</a>:
                    <span class="r25 r">args</span> = <b>new</b> <a href="#0f9f34d7fc3e602c" class="t constructor">ConnectionStatusEventArgs</a>(<a href="#6ddc495529412646" class="t t">ConnectionStatus</a>.<a href="#f19577a101577365" class="i field">ConnectionRetrySucceeded</a>);
                    <b>break</b>;
 
                <b>case</b> (<b>int</b>)<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#4b939349c4d4b263" class="t t">WSManCallbackFlags</a>.<a href="WSManNativeAPI.cs.html#23623b9d1c8a6329" class="i field">WSMAN_FLAG_CALLBACK_SHELL_AUTODISCONNECTING</a>:
                    <span class="r25 r">args</span> = <b>new</b> <a href="#0f9f34d7fc3e602c" class="t constructor">ConnectionStatusEventArgs</a>(<a href="#6ddc495529412646" class="t t">ConnectionStatus</a>.<a href="#f0d6555b08ab5f74" class="i field">AutoDisconnectStarting</a>);
                    <b>break</b>;
 
                <b>case</b> (<b>int</b>)<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#4b939349c4d4b263" class="t t">WSManCallbackFlags</a>.<a href="WSManNativeAPI.cs.html#b75dc830c3d4c2ad" class="i field">WSMAN_FLAG_CALLBACK_SHELL_AUTODISCONNECTED</a>:
                    <span class="r25 r">args</span> = <b>new</b> <a href="#0f9f34d7fc3e602c" class="t constructor">ConnectionStatusEventArgs</a>(<a href="#6ddc495529412646" class="t t">ConnectionStatus</a>.<a href="#de98a76dc253e5fe" class="i field">AutoDisconnectSucceeded</a>);
                    <b>break</b>;
 
                <b>case</b> (<b>int</b>)<a href="WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="WSManNativeAPI.cs.html#4b939349c4d4b263" class="t t">WSManCallbackFlags</a>.<a href="WSManNativeAPI.cs.html#7f4749e6e54e936d" class="i field">WSMAN_FLAG_CALLBACK_RETRY_ABORTED_DUE_TO_INTERNAL_ERROR</a>:
                    <span class="r25 r">args</span> = <b>new</b> <a href="#0f9f34d7fc3e602c" class="t constructor">ConnectionStatusEventArgs</a>(<a href="#6ddc495529412646" class="t t">ConnectionStatus</a>.<a href="#8c22e95737ef7dd8" class="i field">InternalErrorAbort</a>);
                    <b>break</b>;
            }
 
            <span class="c">// Queue worker item to raise the event so that all robust connection</span>
            <span class="c">// events are raised in the same order as received.</span>
            <a href="#a152fe644f7ae9c1" class="i method">EnqueueAndStartProcessingThread</a>(<b>null</b>, <b>null</b>, <span class="r25 r">args</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Raise the Robust Connection notification event.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r26 r">args</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">ConnectionStatusEventArgs.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="16bb9c3b15b05748" href="../../../R/16bb9c3b15b05748.html" target="n" data-glyph="74,1" class="i method">RaiseRobustConnectionNotification</a>(<a href="#598698ed70e51507" class="t t">ConnectionStatusEventArgs</a> <span id="r26 rd" class="r26 r">args</span>)
        {
            <a href="#1acdba1dd243046f" class="i">RobustConnectionNotification</a>.<span class="i">SafeInvoke</span>(<a href="#ed2d81cd8d24599b" class="k">this</a>, <span class="r26 r">args</span>);
        }
 
        <b>internal void</b> <a id="145777d21d37fdbd" href="../../../R/145777d21d37fdbd.html" target="n" data-glyph="74,1" class="i method">RaiseDelayStreamProcessedEvent</a>()
        {
            <a href="#7eeb502235c781ec" class="i">DelayStreamRequestProcessed</a>.<span class="i">SafeInvoke</span>(<a href="#ed2d81cd8d24599b" class="k">this</a>, <span class="i">EventArgs</span>.<span class="i">Empty</span>);
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Received Data Processing Thread
 
        <b>internal override void</b> <a id="9b54d0029bdba5c6" href="../../../R/9b54d0029bdba5c6.html" target="n" data-glyph="74,1" class="i method">ProcessRawData</a>(<b>byte</b>[] <span id="r27 rd" class="r27 r">data</span>, <b>string</b> <span id="r28 rd" class="r28 r">stream</span>)
        {
            <b>if</b> (<a href="#76271338de46dcf0" class="i field">isClosed</a>)
            {
                <b>return</b>;
            }
 
            <b>try</b>
            {
                <a href="#9ccd7ea4a824f9d8" class="k">base</a>.<a href="#a3b20a16b9cde69a" class="i method">ProcessRawData</a>(<span class="r27 r">data</span>, <span class="r28 r">stream</span>, <a href="#e18dce3eba6f91bc" class="i field">_onDataAvailableCallback</a>);
            }
            <b>catch</b> (<a href="../common/remotingexceptions.cs.html#0bb8687f97d91059" class="t t">PSRemotingTransportException</a> <span id="r29 rd" class="r29 r">pte</span>)
            {
                <span class="c">// PSRemotingTransportException need not be wrapped in another PSRemotingTransportException.</span>
                <a href="#d0bdc8aaec3faf80" class="i field">tracer</a>.<span class="i">WriteLine</span>(<span class="s">&quot;Exception processing data. {0}&quot;</span>, <span class="r29 r">pte</span>.<span class="i">Message</span>);
                <a href="#7e70b34f9332dfcd" class="t t">TransportErrorOccuredEventArgs</a> <span id="r30 rd" class="r30 r">eventargs</span> = <b>new</b> <a href="#c420864940871a42" class="t constructor">TransportErrorOccuredEventArgs</a>(<span class="r29 r">pte</span>,
                                    <a href="#33678df914ca9daf" class="t t">TransportMethodEnum</a>.<a href="#c91edb639e1ae62a" class="i field">ReceiveShellOutputEx</a>);
                <a href="#a152fe644f7ae9c1" class="i method">EnqueueAndStartProcessingThread</a>(<b>null</b>, <span class="r30 r">eventargs</span>, <b>null</b>);
 
                <b>return</b>;
            }
            <b>catch</b> (<span class="i">Exception</span> <span id="r31 rd" class="r31 r">exception</span>)
            {
                <span class="c">// Enqueue an Exception to process in a thread-pool thread. Processing</span>
                <span class="c">// Exception in a thread pool thread is important as calling</span>
                <span class="c">// WSManCloseShell/Command from a Receive callback results in a deadlock.</span>
                <a href="#d0bdc8aaec3faf80" class="i field">tracer</a>.<span class="i">WriteLine</span>(<span class="s">&quot;Exception processing data. {0}&quot;</span>, <span class="r31 r">exception</span>.<span class="i">Message</span>);
 
                <a href="../common/remotingexceptions.cs.html#0bb8687f97d91059" class="t t">PSRemotingTransportException</a> <span id="r32 rd" class="r32 r">e</span> = <b>new</b> <span class="t">PSRemotingTransportException</span>(<span class="r31 r">exception</span>.<span class="i">Message</span>);
                <a href="#7e70b34f9332dfcd" class="t t">TransportErrorOccuredEventArgs</a> <span id="r33 rd" class="r33 r">eventargs</span> = <b>new</b> <a href="#c420864940871a42" class="t constructor">TransportErrorOccuredEventArgs</a>(<span class="r32 r">e</span>,
                                    <a href="#33678df914ca9daf" class="t t">TransportMethodEnum</a>.<a href="#c91edb639e1ae62a" class="i field">ReceiveShellOutputEx</a>);
                <a href="#a152fe644f7ae9c1" class="i method">EnqueueAndStartProcessingThread</a>(<b>null</b>, <span class="r33 r">eventargs</span>, <b>null</b>);
                <b>return</b>;
            }
        }
 
        <b>private void</b> <a id="15de1a37f4681466" href="../../../R/15de1a37f4681466.html" target="n" data-glyph="76,1" class="i method">OnDataAvailableHandler</a>(<a href="../common/WireDataFormat/RemotingDataObject.cs.html#ca4629603c976aab" class="t t">RemoteDataObject</a>&lt;<a href="../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt; <span id="r34 rd" class="r34 r">remoteObject</span>)
        {
            <a href="#a152fe644f7ae9c1" class="i method">EnqueueAndStartProcessingThread</a>(<span class="r34 r">remoteObject</span>, <b>null</b>, <b>null</b>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Enqueue a deserialized object or an Exception to process in a thread pool</span>
        <span class="c">///</span><span class="c"> thread. Processing Exception in a thread pool thread is important as calling</span>
        <span class="c">///</span><span class="c"> WSManCloseShell/Command from a Receive callback results in a deadlock.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r35 r">remoteObject</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Deserialized Object to process in a thread-pool thread. This should be null</span>
        <span class="c">///</span><span class="c"> when </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="i">transportException</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> is specified.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r36 r">privateData</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Data that is neither RemoteObject or Exception. This is used by Client Command</span>
        <span class="c">///</span><span class="c"> Transport manager to raise SignalCompleted callback.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r37 r">transportErrorArgs</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Error containing transport exception.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="a152fe644f7ae9c1" href="../../../R/a152fe644f7ae9c1.html" target="n" data-glyph="74,1" class="i method">EnqueueAndStartProcessingThread</a>(<a href="../common/WireDataFormat/RemotingDataObject.cs.html#ca4629603c976aab" class="t t">RemoteDataObject</a>&lt;<a href="../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt; <span id="r35 rd" class="r35 r">remoteObject</span>,
            <a href="#7e70b34f9332dfcd" class="t t">TransportErrorOccuredEventArgs</a> <span id="r37 rd" class="r37 r">transportErrorArgs</span>,
            <b>object</b> <span id="r36 rd" class="r36 r">privateData</span>)
        {
            <b>if</b> (<a href="#76271338de46dcf0" class="i field">isClosed</a>)
            {
                <b>return</b>;
            }
 
            <b>lock</b> (<a href="#ce5db200d48204fa" class="i field">_callbackNotificationQueue</a>)
            {
                <b>if</b> ((<span class="r35 r">remoteObject</span> != <b>null</b>) || (<span class="r37 r">transportErrorArgs</span> != <b>null</b>) || (<span class="r36 r">privateData</span> != <b>null</b>))
                {
                    <a href="#847fa2a85ef1a3df" class="t t">CallbackNotificationInformation</a> <span id="r38 rd" class="r38 r">rcvdDataInfo</span> = <b>new</b> <span class="t">CallbackNotificationInformation</span>();
                    <span class="r38 r">rcvdDataInfo</span>.<a href="#7511c02f3d678feb" class="i field">remoteObject</a> = <span class="r35 r">remoteObject</span>;
                    <span class="r38 r">rcvdDataInfo</span>.<a href="#0a13781d74b79511" class="i field">transportError</a> = <span class="r37 r">transportErrorArgs</span>;
                    <span class="r38 r">rcvdDataInfo</span>.<a href="#7623c70b66581823" class="i field">privateData</a> = <span class="r36 r">privateData</span>;
 
                    <b>if</b> (<span class="r35 r">remoteObject</span> != <b>null</b> &amp;&amp; (<span class="r35 r">remoteObject</span>.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#97d7621b092d013f" class="i property">DataType</a> == <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#296cbb5be87abd08" class="t t">RemotingDataType</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#44a91e5fd10c9b8c" class="i field">PublicKey</a> ||
                                                 <span class="r35 r">remoteObject</span>.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#97d7621b092d013f" class="i property">DataType</a> == <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#296cbb5be87abd08" class="t t">RemotingDataType</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#c0cf64f5fbe0969f" class="i field">EncryptedSessionKey</a> ||
                                                 <span class="r35 r">remoteObject</span>.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#97d7621b092d013f" class="i property">DataType</a> == <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#296cbb5be87abd08" class="t t">RemotingDataType</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#b069e4b681ec21a5" class="i field">PublicKeyRequest</a>))
                    {
                        <a href="#30975a92e0bc8f5d" class="i property">CryptoHelper</a>.<a href="../../../utils/CryptoUtils.cs.html#8d792bdd7212ca3a" class="i property">Session</a>.<a href="../common/remotesession.cs.html#6bddfe4d3d69f1d6" class="i property">BaseSessionDataStructureHandler</a>.<a href="../client/remotingprotocol.cs.html#18a32682405e84e7" class="i method">RaiseKeyExchangeMessageReceived</a>(<span class="r35 r">remoteObject</span>);
                    }
                    <b>else</b>
                    {
                        <a href="#ce5db200d48204fa" class="i field">_callbackNotificationQueue</a>.<span class="i">Enqueue</span>(<span class="r38 r">rcvdDataInfo</span>);
                    }
                }
 
                <b>if</b> (<a href="#e9b0a5b99ebb694c" class="i field">_suspendQueueServicing</a> &amp;&amp; <a href="#fe0fc7c237cf7a19" class="i field">_isDebuggerSuspend</a>)
                {
                    <span class="c">// Remove debugger queue suspension if remoteObject requires user response.</span>
                    <a href="#e9b0a5b99ebb694c" class="i field">_suspendQueueServicing</a> = !<a href="#c2f4efddd31e959f" class="i method">CheckForInteractiveHostCall</a>(<span class="r35 r">remoteObject</span>);
                }
 
                <b>if</b> (<a href="#d58c4a7ee8f9b7b3" class="i field">_isServicingCallbacks</a> || <a href="#e9b0a5b99ebb694c" class="i field">_suspendQueueServicing</a>)
                {
                    <span class="c">// a thread pool thread is already processing callbacks or</span>
                    <span class="c">// the queue processing is suspended.</span>
                    <b>return</b>;
                }
 
                <b>if</b> (<a href="#ce5db200d48204fa" class="i field">_callbackNotificationQueue</a>.<span class="i">Count</span> &gt; 0)
                {
                    <a href="#d58c4a7ee8f9b7b3" class="i field">_isServicingCallbacks</a> = <b>true</b>;
 
                    <span class="c">// Start a thread pool thread to process callbacks.</span>
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">UNIX</span>
                    <span class="i">WindowsIdentity</span> <span id="r39 rd" class="r39 r">identityToImpersonate</span>;
                    <a href="../../Utils.cs.html#9185d6ecbaebbec0" class="t t">Utils</a>.<a href="../../Utils.cs.html#9b44ca7f35bc8c39" class="i method">TryGetWindowsImpersonatedIdentity</a>(<b>out</b> <span class="r39 r">identityToImpersonate</span>);
 
                    <a href="../../Utils.cs.html#9185d6ecbaebbec0" class="t t">Utils</a>.<a href="../../Utils.cs.html#4b3987980ff94442" class="i method">QueueWorkItemWithImpersonation</a>(
                        <span class="r39 r">identityToImpersonate</span>,
                        <b>new</b> <span class="i">WaitCallback</span>(<span class="i">ServicePendingCallbacks</span>),
                        <b>null</b>);
<span class="k preprocess">#</span><span class="k preprocess">else</span>
<span class="e">                    ThreadPool.QueueUserWorkItem(new WaitCallback(ServicePendingCallbacks));
</span><span class="k preprocess">#</span><span class="k preprocess">endif</span>
                }
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Helper method to check RemoteDataObject for a host call requiring user</span>
        <span class="c">///</span><span class="c"> interaction.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r40 r">remoteObject</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Remote data object.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">True if remote data object requires a user response.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>private static bool</b> <a id="c2f4efddd31e959f" href="../../../R/c2f4efddd31e959f.html" target="n" data-glyph="76,1" class="i method">CheckForInteractiveHostCall</a>(<a href="../common/WireDataFormat/RemotingDataObject.cs.html#ca4629603c976aab" class="t t">RemoteDataObject</a>&lt;<a href="../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt; <span id="r40 rd" class="r40 r">remoteObject</span>)
        {
            <b>bool</b> <span id="r41 rd" class="r41 r">interactiveHostCall</span> = <b>false</b>;
 
            <b>if</b> ((<span class="r40 r">remoteObject</span> != <b>null</b>) &amp;&amp;
                (<span class="r40 r">remoteObject</span>.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#97d7621b092d013f" class="i property">DataType</a> == <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#296cbb5be87abd08" class="t t">RemotingDataType</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#055d2ba11ad1263c" class="i field">RemoteHostCallUsingPowerShellHost</a>))
            {
                <a href="../host/RemoteHostMethodInfo.cs.html#de0cdb3501b9855e" class="t t">RemoteHostMethodId</a> <span id="r42 rd" class="r42 r">methodId</span> = 0;
 
                <b>try</b>
                {
                    <span class="r42 r">methodId</span> = <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#6f71f8c4cc2ac041" class="t t">RemotingDecoder</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#d3fee447c77dfb3b" class="i method">GetPropertyValue</a>&lt;<a href="../host/RemoteHostMethodInfo.cs.html#de0cdb3501b9855e" class="t t">RemoteHostMethodId</a>&gt;(<span class="r40 r">remoteObject</span>.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#d13e5d3038741f3e" class="i property">Data</a>, <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#7c9c1b0b95848ffd" class="t t">RemoteDataNameStrings</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#870eec6850f45e8d" class="i field">MethodId</a>);
                }
                <b>catch</b> (<a href="../../../utils/MshArgumentNullException.cs.html#efa3789145f41301" class="t t">PSArgumentNullException</a>) { }
                <b>catch</b> (<a href="../common/remotingexceptions.cs.html#553740d8dd522b58" class="t t">PSRemotingDataStructureException</a>) { }
 
                <span class="c">// If new remote host call methods are added then we need to evaluate if they are interactive.</span>
                <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r42 r">methodId</span> &lt;= <a href="../host/RemoteHostMethodInfo.cs.html#de0cdb3501b9855e" class="t t">RemoteHostMethodId</a>.<a href="../host/RemoteHostMethodInfo.cs.html#c2fef1a355fcf287" class="i field">PromptForChoiceMultipleSelection</a>, <span class="s">&quot;A new remote host method Id was added.  Update switch statement as needed.&quot;</span>);
 
                <b>switch</b> (<span class="r42 r">methodId</span>)
                {
                    <b>case</b> <a href="../host/RemoteHostMethodInfo.cs.html#de0cdb3501b9855e" class="t t">RemoteHostMethodId</a>.<a href="../host/RemoteHostMethodInfo.cs.html#b3c35fe2153d6573" class="i field">Prompt</a>:
                    <b>case</b> <a href="../host/RemoteHostMethodInfo.cs.html#de0cdb3501b9855e" class="t t">RemoteHostMethodId</a>.<a href="../host/RemoteHostMethodInfo.cs.html#0746b1e541fdab7d" class="i field">PromptForChoice</a>:
                    <b>case</b> <a href="../host/RemoteHostMethodInfo.cs.html#de0cdb3501b9855e" class="t t">RemoteHostMethodId</a>.<a href="../host/RemoteHostMethodInfo.cs.html#c2fef1a355fcf287" class="i field">PromptForChoiceMultipleSelection</a>:
                    <b>case</b> <a href="../host/RemoteHostMethodInfo.cs.html#de0cdb3501b9855e" class="t t">RemoteHostMethodId</a>.<a href="../host/RemoteHostMethodInfo.cs.html#2d54e78fda4aef54" class="i field">PromptForCredential1</a>:
                    <b>case</b> <a href="../host/RemoteHostMethodInfo.cs.html#de0cdb3501b9855e" class="t t">RemoteHostMethodId</a>.<a href="../host/RemoteHostMethodInfo.cs.html#9a7a94dc7b2818b4" class="i field">PromptForCredential2</a>:
                    <b>case</b> <a href="../host/RemoteHostMethodInfo.cs.html#de0cdb3501b9855e" class="t t">RemoteHostMethodId</a>.<a href="../host/RemoteHostMethodInfo.cs.html#d6a243fbc37589ad" class="i field">ReadKey</a>:
                    <b>case</b> <a href="../host/RemoteHostMethodInfo.cs.html#de0cdb3501b9855e" class="t t">RemoteHostMethodId</a>.<a href="../host/RemoteHostMethodInfo.cs.html#1bfbce84f7286219" class="i field">ReadLine</a>:
                    <b>case</b> <a href="../host/RemoteHostMethodInfo.cs.html#de0cdb3501b9855e" class="t t">RemoteHostMethodId</a>.<a href="../host/RemoteHostMethodInfo.cs.html#d6d0a2ac7064ebc7" class="i field">ReadLineAsSecureString</a>:
                        <span class="r41 r">interactiveHostCall</span> = <b>true</b>;
                        <b>break</b>;
                }
            }
 
            <b>return</b> <span class="r41 r">interactiveHostCall</span>;
        }
 
        <b>internal void</b> <a id="c486b9fc45e42009" href="../../../R/../../0000000000.html" target="n" data-glyph="74,1" class="i method">ServicePendingCallbacks</a>(<b>object</b> <span id="r43 rd" class="r43 r">objectToProcess</span>)
        {
            <a href="#d0bdc8aaec3faf80" class="i field">tracer</a>.<a href="../../../utils/StructuredTraceSource.cs.html#96aaf3813a5962a0" class="i method">WriteLine</a>(<span class="s">&quot;ServicePendingCallbacks thread is starting&quot;</span>);
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<a href="../../../utils/tracing/PSEtwLog.cs.html#c0ba03442a1969ee" class="i method">ReplaceActivityIdForCurrentThread</a>(<a href="#6b69cd5f8cc06fb7" class="i property">RunspacePoolInstanceId</a>,
                <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#8583d6074d3ae378" class="i field">OperationalTransferEventRunspacePool</a>,
                <a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#eae064d680934e47" class="i field">AnalyticTransferEventRunspacePool</a>,
                <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#c5d4a73b62c859ab" class="i field">Transport</a>,
                <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>);
 
            <b>try</b>
            {
                <b>while</b> (<b>true</b>)
                {
                    <span class="c">// if the transport manager is closed return.</span>
                    <b>if</b> (<a href="#76271338de46dcf0" class="i field">isClosed</a>)
                    {
                        <b>return</b>;
                    }
 
                    <a href="#847fa2a85ef1a3df" class="t t">CallbackNotificationInformation</a> <span id="r44 rd" class="r44 r">rcvdDataInfo</span> = <b>null</b>;
                    <b>lock</b> (<a href="#ce5db200d48204fa" class="i field">_callbackNotificationQueue</a>)
                    {
                        <span class="c">// If queue is empty or if queue servicing is suspended</span>
                        <span class="c">// then break out of loop.</span>
                        <b>if</b> (<a href="#ce5db200d48204fa" class="i field">_callbackNotificationQueue</a>.<span class="i">Count</span> == 0 || <a href="#e9b0a5b99ebb694c" class="i field">_suspendQueueServicing</a>)
                        {
                            <b>break</b>;
                        }
 
                        <span class="r44 r">rcvdDataInfo</span> = <a href="#ce5db200d48204fa" class="i field">_callbackNotificationQueue</a>.<span class="i">Dequeue</span>();
                    }
                    <span class="c">// Handle callback.</span>
                    <b>if</b> (<span class="r44 r">rcvdDataInfo</span> != <b>null</b>)
                    {
                        <span class="c">// Handling transport exception in thread-pool thread</span>
                        <b>if</b> (<span class="r44 r">rcvdDataInfo</span>.<a href="#0a13781d74b79511" class="i field">transportError</a> != <b>null</b>)
                        {
                            <a href="#8e00d8a2f8745652" class="i method">RaiseErrorHandler</a>(<span class="r44 r">rcvdDataInfo</span>.<a href="#0a13781d74b79511" class="i field">transportError</a>);
                            <b>break</b>;
                        }
                        <b>else</b> <b>if</b> (<span class="r44 r">rcvdDataInfo</span>.<a href="#7623c70b66581823" class="i field">privateData</a> != <b>null</b>)
                        {
                            <a href="#763ffe879947403e" class="i method">ProcessPrivateData</a>(<span class="r44 r">rcvdDataInfo</span>.<a href="#7623c70b66581823" class="i field">privateData</a>);
                        }
                        <b>else</b>
                        {
                            <a href="#9ccd7ea4a824f9d8" class="k">base</a>.<a href="#30b9165fa4b1d2aa" class="i method">OnDataAvailableCallback</a>(<span class="r44 r">rcvdDataInfo</span>.<a href="#7511c02f3d678feb" class="i field">remoteObject</a>);
                        }
                    }
                }
            }
            <b>catch</b> (<span class="i">Exception</span> <span id="r45 rd" class="r45 r">exception</span>)
            {
                <span class="c">// This will get executed on a thread pool thread..</span>
                <span class="c">// so we need to protect that thread, hence catching</span>
                <span class="c">// all exceptions</span>
                <a href="#d0bdc8aaec3faf80" class="i field">tracer</a>.<span class="i">WriteLine</span>(<span class="s">&quot;Exception processing data. {0}&quot;</span>, <span class="r45 r">exception</span>.<span class="i">Message</span>);
 
                <a href="../common/remotingexceptions.cs.html#0bb8687f97d91059" class="t t">PSRemotingTransportException</a> <span id="r46 rd" class="r46 r">e</span> = <b>new</b> <span class="t">PSRemotingTransportException</span>(<span class="r45 r">exception</span>.<span class="i">Message</span>, <span class="r45 r">exception</span>);
                <a href="#7e70b34f9332dfcd" class="t t">TransportErrorOccuredEventArgs</a> <span id="r47 rd" class="r47 r">eventargs</span> =
                    <b>new</b> <a href="#c420864940871a42" class="t constructor">TransportErrorOccuredEventArgs</a>(<span class="r46 r">e</span>, <a href="#33678df914ca9daf" class="t t">TransportMethodEnum</a>.<a href="#c91edb639e1ae62a" class="i field">ReceiveShellOutputEx</a>);
                <a href="#8e00d8a2f8745652" class="i method">RaiseErrorHandler</a>(<span class="r47 r">eventargs</span>);
                <b>return</b>;
            }
            <b>finally</b>
            {
                <b>lock</b> (<a href="#ce5db200d48204fa" class="i field">_callbackNotificationQueue</a>)
                {
                    <a href="#d0bdc8aaec3faf80" class="i field">tracer</a>.<a href="../../../utils/StructuredTraceSource.cs.html#96aaf3813a5962a0" class="i method">WriteLine</a>(<span class="s">&quot;ServicePendingCallbacks thread is exiting&quot;</span>);
                    <a href="#d58c4a7ee8f9b7b3" class="i field">_isServicingCallbacks</a> = <b>false</b>;
                    <span class="c">// check if any new runspace request has arrived..</span>
                    <a href="#a152fe644f7ae9c1" class="i method">EnqueueAndStartProcessingThread</a>(<b>null</b>, <b>null</b>, <b>null</b>);
                }
            }
        }
 
        <b>internal bool</b> <a id="df66df4d8de1d05e" href="../../../R/df66df4d8de1d05e.html" target="n" data-glyph="104,1" class="i property">IsServicing</a>
        {
            <b>get</b>
            {
                <b>lock</b> (<a href="#ce5db200d48204fa" class="i field">_callbackNotificationQueue</a>)
                {
                    <b>return</b> <a href="#d58c4a7ee8f9b7b3" class="i field">_isServicingCallbacks</a>;
                }
            }
        }
 
        <b>internal void</b> <a id="67fbcc4583ff15b5" href="../../../R/67fbcc4583ff15b5.html" target="n" data-glyph="74,1" class="i method">SuspendQueue</a>(<b>bool</b> <span id="r48 rd" class="r48 r">debuggerSuspend</span> = <b>false</b>)
        {
            <b>lock</b> (<a href="#ce5db200d48204fa" class="i field">_callbackNotificationQueue</a>)
            {
                <a href="#fe0fc7c237cf7a19" class="i field">_isDebuggerSuspend</a> = <span class="r48 r">debuggerSuspend</span>;
                <a href="#e9b0a5b99ebb694c" class="i field">_suspendQueueServicing</a> = <b>true</b>;
            }
        }
 
        <b>internal void</b> <a id="1a3662753e2dd9a4" href="../../../R/1a3662753e2dd9a4.html" target="n" data-glyph="74,1" class="i method">ResumeQueue</a>()
        {
            <b>lock</b> (<a href="#ce5db200d48204fa" class="i field">_callbackNotificationQueue</a>)
            {
                <a href="#fe0fc7c237cf7a19" class="i field">_isDebuggerSuspend</a> = <b>false</b>;
 
                <b>if</b> (<a href="#e9b0a5b99ebb694c" class="i field">_suspendQueueServicing</a>)
                {
                    <a href="#e9b0a5b99ebb694c" class="i field">_suspendQueueServicing</a> = <b>false</b>;
 
                    <span class="c">// Process any items in queue.</span>
                    <a href="#a152fe644f7ae9c1" class="i method">EnqueueAndStartProcessingThread</a>(<b>null</b>, <b>null</b>, <b>null</b>);
                }
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Used by ServicePendingCallbacks to give the control to derived classes for</span>
        <span class="c">///</span><span class="c"> processing data that the base class does not understand.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r49 r">privateData</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Derived class specific data to process. For command transport manager this</span>
        <span class="c">///</span><span class="c"> should be a boolean.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal virtual void</b> <a id="763ffe879947403e" href="../../../R/763ffe879947403e.html" target="n" data-glyph="74,1" class="i method">ProcessPrivateData</a>(<b>object</b> <span id="r49 rd" class="r49 r">privateData</span>)
        {
        }
 
        <b>internal class</b> <a id="847fa2a85ef1a3df" href="../../../R/847fa2a85ef1a3df.html" target="n" data-glyph="2,1" class="t t"><span id="075a88b7cb88200d">CallbackNotificationInformation</span></a>
        {
            <span class="c">// only one of the following 2 should be present..</span>
            <span class="c">// anyway transportException takes precedence over remoteObject.</span>
            <b>internal</b> <a href="../common/WireDataFormat/RemotingDataObject.cs.html#ca4629603c976aab" class="t t">RemoteDataObject</a>&lt;<a href="../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt; <a id="7511c02f3d678feb" href="../../../R/7511c02f3d678feb.html" target="n" data-glyph="44,2" class="i field">remoteObject</a>;
            <b>internal</b> <a href="#7e70b34f9332dfcd" class="t t">TransportErrorOccuredEventArgs</a> <a id="0a13781d74b79511" href="../../../R/0a13781d74b79511.html" target="n" data-glyph="44,2" class="i field">transportError</a>;
            <span class="c">// Used by ServicePendingCallbacks to give the control to derived classes for</span>
            <span class="c">// processing data that the base class does not understand.</span>
            <b>internal object</b> <a id="7623c70b66581823" href="../../../R/7623c70b66581823.html" target="n" data-glyph="44,2" class="i field">privateData</a>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Abstract / Virtual methods
 
        <b>internal abstract void</b> <a id="647d3fc66fbadafe" href="../../../R/647d3fc66fbadafe.html" target="n" data-glyph="74,1" class="i method">CreateAsync</a>();
 
        <b>internal abstract void</b> <a id="c25dbbf00143cb5e" href="../../../R/c25dbbf00143cb5e.html" target="n" data-glyph="74,1" class="i method">ConnectAsync</a>();
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The caller should make sure the call is synchronized.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal virtual void</b> <a id="8487786a35819f66" href="../../../R/8487786a35819f66.html" target="n" data-glyph="74,1" class="i method">CloseAsync</a>()
        {
            <span class="c">// Clear the send collection</span>
            <a href="#ee4a2ac1afa72dce" class="i field">dataToBeSent</a>.<a href="PriorityCollection.cs.html#112a4d4532ecf193" class="i method">Clear</a>();
        }
 
        <b>internal virtual void</b> <a id="5c2f4a8345c6d6cd" href="../../../R/5c2f4a8345c6d6cd.html" target="n" data-glyph="74,1" class="i method">StartReceivingData</a>()
        {
            <b>throw</b> <b>new</b> <span class="i">NotImplementedException</span>();
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Method to have transport prepare for a disconnect operation.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal virtual void</b> <a id="bca7f9a7141c0084" href="../../../R/bca7f9a7141c0084.html" target="n" data-glyph="74,1" class="i method">PrepareForDisconnect</a>()
        {
            <b>throw</b> <b>new</b> <span class="i">NotImplementedException</span>();
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Method to resume post disconnect operations.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal virtual void</b> <a id="6b9e13ba52d26e1d" href="../../../R/6b9e13ba52d26e1d.html" target="n" data-glyph="74,1" class="i method">PrepareForConnect</a>()
        {
            <b>throw</b> <b>new</b> <span class="i">NotImplementedException</span>();
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Clean up
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Finalizes an instance of the </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="#ed2d81cd8d24599b" class="t t">BaseClientTransportManager</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> class.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        ~<a id="80bac09fb7ae0328" href="../../../R/../../0000000000.html" target="n" data-glyph="75,1" class="t method">BaseClientTransportManager</a>()
        {
            <b>if</b> (<a href="#76271338de46dcf0" class="i field">isClosed</a>)
            {
                <a href="#28896ed8464e84b5" class="i method">Dispose</a>(<b>false</b>);
            }
            <b>else</b>
            {
                <span class="c">// wait for the close to be completed and then release the resources.</span>
                <a href="#ed2d81cd8d24599b" class="k">this</a>.<a href="#a237a80d5d4b9bee" class="i">CloseCompleted</a> += (<b>object</b> <span id="r50 rd" class="r50 r">source</span>, <span class="i">EventArgs</span> <span id="r51 rd" class="r51 r">args</span>) =&gt; <a href="#28896ed8464e84b5" class="i method">Dispose</a>(<b>false</b>);
 
                <b>try</b>
                {
                    <span class="c">// looks like Dispose is not called for this transport manager</span>
                    <span class="c">// try closing the transport manager.</span>
                    <a href="#8487786a35819f66" class="i method">CloseAsync</a>();
                }
                <b>catch</b> (<span class="i">ObjectDisposedException</span>)
                {
                    <span class="c">// intentionally blank</span>
                }
            }
        }
 
        <b>internal override void</b> <a id="28896ed8464e84b5" href="../../../R/28896ed8464e84b5.html" target="n" data-glyph="74,1" class="i method">Dispose</a>(<b>bool</b> <span id="r52 rd" class="r52 r">isDisposing</span>)
        {
            <span class="c">// clear event handlers</span>
            <a href="#ed2d81cd8d24599b" class="k">this</a>.<a href="#b775a320b2c726cd" class="i">CreateCompleted</a> = <b>null</b>;
            <a href="#ed2d81cd8d24599b" class="k">this</a>.<a href="#a237a80d5d4b9bee" class="i">CloseCompleted</a> = <b>null</b>;
            <a href="#ed2d81cd8d24599b" class="k">this</a>.<a href="#99a709b2ef3c3bf4" class="i">ConnectCompleted</a> = <b>null</b>;
            <a href="#ed2d81cd8d24599b" class="k">this</a>.<a href="#dc2c612e7bab7e2a" class="i">DisconnectCompleted</a> = <b>null</b>;
            <a href="#ed2d81cd8d24599b" class="k">this</a>.<a href="#ab98168ad401f31e" class="i">ReconnectCompleted</a> = <b>null</b>;
 
            <span class="c">// let base dispose its resources.</span>
            <a href="#9ccd7ea4a824f9d8" class="k">base</a>.<a href="#a9dbb33a8c08faaa" class="i method">Dispose</a>(<span class="r52 r">isDisposing</span>);
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
    }
 
    <b>internal abstract class</b> <a id="19883ec4df424177" href="../../../R/19883ec4df424177.html" target="n" data-glyph="2,0" class="t t">BaseClientSessionTransportManager</a> : <a href="#ed2d81cd8d24599b" class="t t">BaseClientTransportManager</a>, <span class="i">IDisposable</span>
    {
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Constructors
 
        <b>protected</b> <a id="be06f3503cfac6d4" href="../../../R/be06f3503cfac6d4.html" target="n" data-glyph="75,1" class="t constructor">BaseClientSessionTransportManager</a>(<span class="i">Guid</span> <span id="r53 rd" class="r53 r">runspaceId</span>, <a href="../../../utils/CryptoUtils.cs.html#1999dfb2439af5a0" class="t t">PSRemotingCryptoHelper</a> <span id="r54 rd" class="r54 r">cryptoHelper</span>)
            : <a href="#a88452c7515e5700" class="k">base</a>(<span class="r53 r">runspaceId</span>, <span class="r54 r">cryptoHelper</span>)
        {
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Abstract / Virtual Methods
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Creates a command transport manager. This will create a new PrioritySendDataCollection which should be used to</span>
        <span class="c">///</span><span class="c"> send data to the server.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r55 r">connectionInfo</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Connection info to be used for creating the command.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r56 r">cmd</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Command for which transport manager is created.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r57 r">noInput</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> true if the command has input.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal virtual</b> <a href="#fa455a694094fdc2" class="t t">BaseClientCommandTransportManager</a> <a id="c47fbfe767c9bd0a" href="../../../R/c47fbfe767c9bd0a.html" target="n" data-glyph="74,1" class="i method">CreateClientCommandTransportManager</a>(<a href="../common/RunspaceConnectionInfo.cs.html#e07ed56a8a1da829" class="t t">RunspaceConnectionInfo</a> <span id="r55 rd" class="r55 r">connectionInfo</span>,
                    <a href="../client/ClientRemotePowerShell.cs.html#b4d2ac017883b31c" class="t t">ClientRemotePowerShell</a> <span id="r56 rd" class="r56 r">cmd</span>, <b>bool</b> <span id="r57 rd" class="r57 r">noInput</span>)
        {
            <b>throw</b> <b>new</b> <span class="i">NotImplementedException</span>();
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> RunspacePool data structure handler uses this method to remove association of a command transport manager</span>
        <span class="c">///</span><span class="c"> from a session transport manager.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r58 r">powerShellCmdId</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal virtual void</b> <a id="f35971d48e2cbd33" href="../../../R/f35971d48e2cbd33.html" target="n" data-glyph="74,1" class="i method">RemoveCommandTransportManager</a>(<span class="i">Guid</span> <span id="r58 rd" class="r58 r">powerShellCmdId</span>)
        {
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Temporarily disconnect an active session.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal virtual void</b> <a id="f3331593837e57e2" href="../../../R/f3331593837e57e2.html" target="n" data-glyph="74,1" class="i method">DisconnectAsync</a>()
        {
            <b>throw</b> <b>new</b> <span class="i">NotImplementedException</span>();
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Reconnect back a temporarily disconnected session.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal virtual void</b> <a id="c09916546be3d983" href="../../../R/c09916546be3d983.html" target="n" data-glyph="74,1" class="i method">ReconnectAsync</a>()
        {
            <b>throw</b> <b>new</b> <span class="i">NotImplementedException</span>();
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Redirect the transport manager to point to a new URI.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r59 r">newUri</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Redirect Uri to connect to.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r60 r">connectionInfo</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Connection info object used for retrieving credential, auth. mechanism etc.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal virtual void</b> <a id="aa3549e21504d156" href="../../../R/aa3549e21504d156.html" target="n" data-glyph="74,1" class="i method">Redirect</a>(<span class="i">Uri</span> <span id="r59 rd" class="r59 r">newUri</span>, <a href="../common/RunspaceConnectionInfo.cs.html#e07ed56a8a1da829" class="t t">RunspaceConnectionInfo</a> <span id="r60 rd" class="r60 r">connectionInfo</span>)
        {
            <b>throw</b> <b>new</b> <span class="i">NotImplementedException</span>();
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Used by callers to prepare the session transportmanager for a URI redirection.</span>
        <span class="c">///</span><span class="c"> This must be called only after Create callback (or Error form create) is received.</span>
        <span class="c">///</span><span class="c"> Callers must catch the close completed event and call Redirect to perform the redirection.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal virtual void</b> <a id="6ed67e5c9c8c26bc" href="../../../R/6ed67e5c9c8c26bc.html" target="n" data-glyph="74,1" class="i method">PrepareForRedirection</a>()
        {
            <b>throw</b> <b>new</b> <span class="i">NotImplementedException</span>();
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
    }
 
    <b>internal abstract class</b> <a id="fa455a694094fdc2" href="../../../R/fa455a694094fdc2.html" target="n" data-glyph="2,0" class="t t">BaseClientCommandTransportManager</a> : <a href="#ed2d81cd8d24599b" class="t t">BaseClientTransportManager</a>, <span class="i">IDisposable</span>
    {
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Private / Protected Data
 
        <span class="c">// pipeline in the form cmd1 | cmd2.. this is used by authz module for early validation.</span>
        <b>protected</b> <span class="i">StringBuilder</span> <a id="0e93935ce5858e7c" href="../../../R/0e93935ce5858e7c.html" target="n" data-glyph="45,1" class="i field">cmdText</a>;
        <b>protected</b> <a href="../common/fragmentor.cs.html#d3a26c96b56add5c" class="t t">SerializedDataStream</a> <a id="f0864e0c2b75fa58" href="../../../R/f0864e0c2b75fa58.html" target="n" data-glyph="45,1" class="i field">serializedPipeline</a>;
        <b>protected</b> <span class="i">Guid</span> <a id="5485ee84e1e3c04d" href="../../../R/5485ee84e1e3c04d.html" target="n" data-glyph="45,1" class="i field">powershellInstanceId</a>;
 
        <b>protected</b> <span class="i">Guid</span> <a id="48f7345377e9fbe3" href="../../../R/48f7345377e9fbe3.html" target="n" data-glyph="105,1" class="i property">PowershellInstanceId</a>
        {
            <b>get</b> { <b>return</b> <a href="#5485ee84e1e3c04d" class="i field">powershellInstanceId</a>; }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <b>internal bool</b> <a id="ac907f25779bf298" href="../../../R/ac907f25779bf298.html" target="n" data-glyph="44,1" class="i field">startInDisconnectedMode</a> = <b>false</b>;
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Constructors
 
        <b>protected</b> <a id="bd9431dfddb4513a" href="../../../R/bd9431dfddb4513a.html" target="n" data-glyph="75,1" class="t constructor">BaseClientCommandTransportManager</a>(<a href="../client/ClientRemotePowerShell.cs.html#b4d2ac017883b31c" class="t t">ClientRemotePowerShell</a> <span id="r61 rd" class="r61 r">shell</span>,
            <a href="../../../utils/CryptoUtils.cs.html#1999dfb2439af5a0" class="t t">PSRemotingCryptoHelper</a> <span id="r62 rd" class="r62 r">cryptoHelper</span>,
            <a href="#19883ec4df424177" class="t t">BaseClientSessionTransportManager</a> <span id="r63 rd" class="r63 r">sessnTM</span>) : <a href="#a88452c7515e5700" class="k">base</a>(<span class="r63 r">sessnTM</span>.<a href="#6b69cd5f8cc06fb7" class="i property">RunspacePoolInstanceId</a>, <span class="r62 r">cryptoHelper</span>)
        {
            <a href="#0597b18306926355" class="i property">Fragmentor</a>.<a href="../common/fragmentor.cs.html#a4fa6a799e0782de" class="i property">FragmentSize</a> = <span class="r63 r">sessnTM</span>.<a href="#0597b18306926355" class="i property">Fragmentor</a>.<a href="../common/fragmentor.cs.html#a4fa6a799e0782de" class="i property">FragmentSize</a>;
            <a href="#0597b18306926355" class="i property">Fragmentor</a>.<a href="../common/fragmentor.cs.html#68368520cad75c32" class="i property">TypeTable</a> = <span class="r63 r">sessnTM</span>.<a href="#0597b18306926355" class="i property">Fragmentor</a>.<a href="../common/fragmentor.cs.html#68368520cad75c32" class="i property">TypeTable</a>;
            <a href="#ee4a2ac1afa72dce" class="i field">dataToBeSent</a>.<a href="PriorityCollection.cs.html#84bdedfd536de402" class="i property">Fragmentor</a> = <a href="#ed2d81cd8d24599b" class="k">base</a>.<a href="#0597b18306926355" class="i property">Fragmentor</a>;
            <span class="c">// used for Crimson logging.</span>
            <a href="#5485ee84e1e3c04d" class="i field">powershellInstanceId</a> = <span class="r61 r">shell</span>.<a href="../client/ClientRemotePowerShell.cs.html#c30957a9d4580098" class="i property">PowerShell</a>.<a href="../../hostifaces/PowerShell.cs.html#d8c9867186529e49" class="i property">InstanceId</a>;
 
            <a href="#0e93935ce5858e7c" class="i field">cmdText</a> = <b>new</b> <span class="i">StringBuilder</span>();
            <b>foreach</b> (<span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Runspaces</span>.<a href="../../hostifaces/Command.cs.html#b55b68a3bf75e612" class="t t">Command</a> <span id="r64 rd" class="r64 r">cmd</span> <b>in</b> <span class="r61 r">shell</span>.<a href="../client/ClientRemotePowerShell.cs.html#c30957a9d4580098" class="i property">PowerShell</a>.<a href="../../hostifaces/PowerShell.cs.html#7bde27452e045465" class="i property">Commands</a>.<a href="../../hostifaces/PSCommand.cs.html#cc9b22e4391a9870" class="i property">Commands</a>)
            {
                <a href="#0e93935ce5858e7c" class="i field">cmdText</a>.<span class="i">Append</span>(<span class="r64 r">cmd</span>.<a href="../../hostifaces/Command.cs.html#e67df99c50711b7c" class="i property">CommandText</a>);
                <a href="#0e93935ce5858e7c" class="i field">cmdText</a>.<span class="i">Append</span>(<span class="s">&quot; | &quot;</span>);
            }
 
            <a href="#0e93935ce5858e7c" class="i field">cmdText</a>.<span class="i">Remove</span>(<a href="#0e93935ce5858e7c" class="i field">cmdText</a>.<span class="i">Length</span> - 3, 3); <span class="c">// remove ending &quot; | &quot;</span>
 
            <a href="../common/WireDataFormat/RemotingDataObject.cs.html#3856dcbea775cab8" class="t t">RemoteDataObject</a> <span id="r65 rd" class="r65 r">message</span>;
            <b>if</b> (<span class="r61 r">shell</span>.<a href="../client/ClientRemotePowerShell.cs.html#c30957a9d4580098" class="i property">PowerShell</a>.<a href="../../hostifaces/PowerShell.cs.html#fe99bb3389416973" class="i property">IsGetCommandMetadataSpecialPipeline</a>)
            {
                <span class="r65 r">message</span> = <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#88b19073d823ce05" class="t t">RemotingEncoder</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#a4b8c2db2a6b1ee3" class="i method">GenerateGetCommandMetadata</a>(<span class="r61 r">shell</span>);
            }
            <b>else</b>
            {
                <span class="r65 r">message</span> = <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#88b19073d823ce05" class="t t">RemotingEncoder</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#4eb5eb99c2613315" class="i method">GenerateCreatePowerShell</a>(<span class="r61 r">shell</span>);
            }
 
            <a href="#f0864e0c2b75fa58" class="i field">serializedPipeline</a> = <b>new</b> <a href="../common/fragmentor.cs.html#b2d30b3f6669ee79" class="t constructor">SerializedDataStream</a>(<a href="#ed2d81cd8d24599b" class="k">base</a>.<a href="#0597b18306926355" class="i property">Fragmentor</a>.<a href="../common/fragmentor.cs.html#a4fa6a799e0782de" class="i property">FragmentSize</a>);
            <a href="#0597b18306926355" class="i property">Fragmentor</a>.<a href="../common/fragmentor.cs.html#a97b5918de0a99cf" class="i method">Fragment</a>&lt;<b>object</b>&gt;(<span class="r65 r">message</span>, <a href="#f0864e0c2b75fa58" class="i field">serializedPipeline</a>);
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Events
 
        <b>internal event</b> <span class="i">EventHandler</span>&lt;<span class="i">EventArgs</span>&gt; <a id="a9500d08805982a8" href="../../../R/a9500d08805982a8.html" target="n" data-glyph="32,1" class="i">SignalCompleted</a>;
 
        <b>internal void</b> <a id="4760a0a217eace5a" href="../../../R/4760a0a217eace5a.html" target="n" data-glyph="74,1" class="i method">RaiseSignalCompleted</a>()
        {
            <a href="#a9500d08805982a8" class="i">SignalCompleted</a>.<span class="i">SafeInvoke</span>(<a href="#fa455a694094fdc2" class="k">this</a>, <span class="i">EventArgs</span>.<span class="i">Empty</span>);
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Overrides
 
        <b>internal override void</b> <a id="9e284fd5b441a63a" href="../../../R/9e284fd5b441a63a.html" target="n" data-glyph="74,1" class="i method">Dispose</a>(<b>bool</b> <span id="r66 rd" class="r66 r">isDisposing</span>)
        {
            <a href="#ed2d81cd8d24599b" class="k">base</a>.<a href="#28896ed8464e84b5" class="i method">Dispose</a>(<span class="r66 r">isDisposing</span>);
 
            <b>if</b> (<span class="r66 r">isDisposing</span>)
            {
                <span class="c">// dispose serialized pipeline</span>
                <a href="#f0864e0c2b75fa58" class="i field">serializedPipeline</a>.<a href="../common/fragmentor.cs.html#a30a841d301fa560" class="i method">Dispose</a>();
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Abstract / Virtual Methods
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Reconnects a previously disconnected commandTM. Implemented by WSMan transport</span>
        <span class="c">///</span><span class="c"> Note that there is not explicit disconnect on commandTM. It is implicity disconnected</span>
        <span class="c">///</span><span class="c"> when disconnect is called on sessionTM . The TM&#39;s also dont maintain specific connection state</span>
        <span class="c">///</span><span class="c"> This is done by DSHandlers.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal virtual void</b> <a id="7f1db74e3f1dc999" href="../../../R/7f1db74e3f1dc999.html" target="n" data-glyph="74,1" class="i method">ReconnectAsync</a>()
        {
            <b>throw</b> <b>new</b> <span class="i">NotImplementedException</span>();
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Used by powershell/pipeline to send a stop message to the server command.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal virtual void</b> <a id="474a5a730ecaf63e" href="../../../R/474a5a730ecaf63e.html" target="n" data-glyph="74,1" class="i method">SendStopSignal</a>()
        {
            <b>throw</b> <b>new</b> <span class="i">NotImplementedException</span>();
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
    }
}
 
<b>namespace</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Remoting</span>.<span class="i n">Server</span>
{
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> This represents an abstraction for server transport manager.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>internal abstract class</b> <a id="3beeadac29de3a80" href="../../../R/3beeadac29de3a80.html" target="n" data-glyph="2,0" class="t t">AbstractServerTransportManager</a> : <a href="#9ccd7ea4a824f9d8" class="t t">BaseTransportManager</a>
    {
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Private Data
 
        <b>private readonly object</b> <a id="70287f733eea6745" href="../../../R/70287f733eea6745.html" target="n" data-glyph="46,1" class="i field">_syncObject</a> = <b>new</b> <b>object</b>();
        <span class="c">// used to listen to data available events from serialized datastream.</span>
        <b>private readonly</b> <a href="../common/fragmentor.cs.html#d3a26c96b56add5c" class="t t">SerializedDataStream</a>.<a href="../common/fragmentor.cs.html#6931116887ce476a" class="t t">OnDataAvailableCallback</a> <a id="18a4f0d667340c87" href="../../../R/18a4f0d667340c87.html" target="n" data-glyph="46,1" class="i field">_onDataAvailable</a>;
        <span class="c">// the following variable are used by onDataAvailableCallback.</span>
        <b>private bool</b> <a id="d2f32beb6d38f45c" href="../../../R/d2f32beb6d38f45c.html" target="n" data-glyph="46,1" class="i field">_shouldFlushData</a>;
        <b>private bool</b> <a id="8a0e6b54db494964" href="../../../R/8a0e6b54db494964.html" target="n" data-glyph="46,1" class="i field">_reportAsPending</a>;
        <b>private</b> <span class="i">Guid</span> <a id="cf312c8e9dac76f8" href="../../../R/cf312c8e9dac76f8.html" target="n" data-glyph="46,1" class="i field">_runspacePoolInstanceId</a>;
        <b>private</b> <span class="i">Guid</span> <a id="f852acefef7162a9" href="../../../R/f852acefef7162a9.html" target="n" data-glyph="46,1" class="i field">_powerShellInstanceId</a>;
        <b>private</b> <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#296cbb5be87abd08" class="t t">RemotingDataType</a> <a id="6bc3df74a7f8f866" href="../../../R/6bc3df74a7f8f866.html" target="n" data-glyph="46,1" class="i field">_dataType</a>;
        <b>private</b> <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#1d73dff2a8d6a0bf" class="t t">RemotingTargetInterface</a> <a id="617d1fa68ddbe101" href="../../../R/617d1fa68ddbe101.html" target="n" data-glyph="46,1" class="i field">_targetInterface</a>;
        <span class="c">// End: the following variable are used by onDataAvailableCallback.</span>
        <b>private</b> <span class="i">Queue</span>&lt;<span class="i">Tuple</span>&lt;<a href="../common/WireDataFormat/RemotingDataObject.cs.html#3856dcbea775cab8" class="t t">RemoteDataObject</a>, <b>bool</b>, <b>bool</b>&gt;&gt; <a id="4948c4fec475734c" href="../../../R/4948c4fec475734c.html" target="n" data-glyph="46,1" class="i field">_dataToBeSentQueue</a>;
        <b>private bool</b> <a id="e84f3cefad376d9c" href="../../../R/e84f3cefad376d9c.html" target="n" data-glyph="46,1" class="i field">_isSerializing</a>;
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Constructor
 
        <b>protected</b> <a id="34137234abfd253c" href="../../../R/34137234abfd253c.html" target="n" data-glyph="75,1" class="t constructor">AbstractServerTransportManager</a>(<b>int</b> <span id="r67 rd" class="r67 r">fragmentSize</span>, <a href="../../../utils/CryptoUtils.cs.html#1999dfb2439af5a0" class="t t">PSRemotingCryptoHelper</a> <span id="r68 rd" class="r68 r">cryptoHelper</span>)
            : <a href="#78cdf954d5f46c58" class="k">base</a>(<span class="r68 r">cryptoHelper</span>)
        {
            <a href="#9ccd7ea4a824f9d8" class="k">base</a>.<a href="#0597b18306926355" class="i property">Fragmentor</a>.<a href="../common/fragmentor.cs.html#a4fa6a799e0782de" class="i property">FragmentSize</a> = <span class="r67 r">fragmentSize</span>;
            <a href="#18a4f0d667340c87" class="i field">_onDataAvailable</a> = <b>new</b> <a href="../common/fragmentor.cs.html#d3a26c96b56add5c" class="t t">SerializedDataStream</a>.<span class="t">OnDataAvailableCallback</span>(<a href="#ab2c84aeb8c22a40" class="i method">OnDataAvailable</a>);
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Helper Methods
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Sends an object from the server end. The object is fragmented and each fragment is sent</span>
        <span class="c">///</span><span class="c"> separately. The call blocks until all the fragments are sent to the client. If there</span>
        <span class="c">///</span><span class="c"> is a failure sending any of the fragments WSManTransportErrorOccured event is raised.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">typeparam</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r69 r t">T</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">typeparam</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r70 r">data</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r71 r">flush</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> true to immediately send data to client.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r72 r">reportPending</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> reported as true when host message requests are sent to client</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="5b130cd293defcf8" href="../../../R/5b130cd293defcf8.html" target="n" data-glyph="74,1" class="i method">SendDataToClient</a>&lt;<span id="r69 rd t" class="r69 r t">T</span>&gt;(<a href="../common/WireDataFormat/RemotingDataObject.cs.html#ca4629603c976aab" class="t t">RemoteDataObject</a>&lt;<span class="r69 r t">T</span>&gt; <span id="r70 rd" class="r70 r">data</span>, <b>bool</b> <span id="r71 rd" class="r71 r">flush</span>, <b>bool</b> <span id="r72 rd" class="r72 r">reportPending</span> = <b>false</b>)
        {
            <span class="c">// make sure only one data packet can be sent in its entirety at any</span>
            <span class="c">// given point of time using this transport manager.</span>
            <b>lock</b> (<a href="#70287f733eea6745" class="i field">_syncObject</a>)
            {
                <span class="c">// Win8: 491001 Icm -computername $env:COMPUTERNAME {Get-NetIpInterface} fails with Unexpected ObjectId</span>
                <span class="c">// This is because the output object has some extended script properties. Getter of one of the</span>
                <span class="c">// script properties is calling write-progress. Write-Progress in turn results in a progress record</span>
                <span class="c">// being sent to client. This breaks the fragmentation rule when the original object (without progress)</span>
                <span class="c">// does not fit in fragmented packet.</span>
                <span class="c">// ******************** repro using powershell *********************************</span>
                <span class="c">//  icm . {</span>
                <span class="c">//        $a = new-object psobject</span>
                <span class="c">//        $a.pstypenames.Insert(0, &quot;Microsoft.PowerShell.Test.Bug491001&quot;)</span>
                <span class="c">//        Update-TypeData -TypeName Microsoft.PowerShell.Test.Bug491001 -MemberType ScriptProperty -MemberName name -Value {( 1..50kb | % { get-random -min 97 -max 122 | % { [char]$psitem } }) -join &quot;&quot;}</span>
                <span class="c">//        Update-TypeData -TypeName Microsoft.PowerShell.Test.Bug491001 -MemberType ScriptProperty -MemberName Verbose -Value {write-progress &quot;blah&quot; -Completed; &quot;Some verbose data&quot;}</span>
                <span class="c">//        Update-TypeData -TypeName Microsoft.PowerShell.Test.Bug491001 -MemberType ScriptProperty -MemberName zname -Value {( 1..10kb | % { get-random -min 97 -max 122 | % { [char]$psitem } }) -join &quot;&quot;}</span>
                <span class="c">//        $a</span>
                <span class="c">//   }</span>
                <span class="c">// 1. The value of &quot;name&quot; property is huge 50kb and cannot fit in one fragment (with fragment size 32kb)</span>
                <span class="c">// 2. The value of &quot;Verbose&quot; is actually writing a progress record</span>
                <span class="c">// 3. The value of &quot;zname&quot; property is also huge</span>
                <span class="c">// 4. Notice the ascending order of property names. This is because serializer serializes properties in sort order</span>
                <span class="c">// ******************** End of repro ******************************************</span>
                <span class="c">// To fix the issue, I am creating a Queue and enqueuing the data objects if we are already serializing another data object</span>
                <span class="c">// Notice this is in lock() above. An object is serialized in its entirety in one thread. So, in my example above &quot;name&quot;,</span>
                <span class="c">// &quot;verbose&quot;,&quot;zname&quot; properties are serialized in one thread. So lock() essentially protects from serializing other objects</span>
                <span class="c">// and not this (parent)object.</span>
                <a href="../common/WireDataFormat/RemotingDataObject.cs.html#3856dcbea775cab8" class="t t">RemoteDataObject</a> <span id="r73 rd" class="r73 r">dataToBeSent</span> = <a href="../common/WireDataFormat/RemotingDataObject.cs.html#3856dcbea775cab8" class="t t">RemoteDataObject</a>.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#6904bbcea2ac418a" class="i method">CreateFrom</a>(<span class="r70 r">data</span>.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#36fad9981dff9219" class="i property">Destination</a>, <span class="r70 r">data</span>.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#97d7621b092d013f" class="i property">DataType</a>,
                                                                            <span class="r70 r">data</span>.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#df5fe91d15e5ba71" class="i property">RunspacePoolId</a>, <span class="r70 r">data</span>.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#767aea3474afdc8e" class="i property">PowerShellId</a>,
                                                                            <span class="r70 r">data</span>.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#d13e5d3038741f3e" class="i property">Data</a>);
                <b>if</b> (<a href="#e84f3cefad376d9c" class="i field">_isSerializing</a>)
                {
                    <b>if</b> (<a href="#4948c4fec475734c" class="i field">_dataToBeSentQueue</a> == <b>null</b>)
                    {
                        <a href="#4948c4fec475734c" class="i field">_dataToBeSentQueue</a> = <b>new</b> <span class="i">Queue</span>&lt;<span class="i">Tuple</span>&lt;<a href="../common/WireDataFormat/RemotingDataObject.cs.html#3856dcbea775cab8" class="t t">RemoteDataObject</a>, <b>bool</b>, <b>bool</b>&gt;&gt;();
                    }
 
                    <a href="#4948c4fec475734c" class="i field">_dataToBeSentQueue</a>.<span class="i">Enqueue</span>(<b>new</b> <span class="i">Tuple</span>&lt;<a href="../common/WireDataFormat/RemotingDataObject.cs.html#3856dcbea775cab8" class="t t">RemoteDataObject</a>, <b>bool</b>, <b>bool</b>&gt;(<span class="r73 r">dataToBeSent</span>, <span class="r71 r">flush</span>, <span class="r72 r">reportPending</span>));
                    <b>return</b>;
                }
 
                <a href="#e84f3cefad376d9c" class="i field">_isSerializing</a> = <b>true</b>;
                <b>try</b>
                {
                    <b>do</b>
                    {
                        <span class="c">// tell stream to notify us whenever a fragment is available instead of writing data</span>
                        <span class="c">// into internal buffers. This will save write + read + dispose.)</span>
                        <b>using</b> (<a href="../common/fragmentor.cs.html#d3a26c96b56add5c" class="t t">SerializedDataStream</a> <span id="r74 rd" class="r74 r">serializedData</span> =
                            <b>new</b> <a href="../common/fragmentor.cs.html#c4343f179bba8500" class="t constructor">SerializedDataStream</a>(<a href="#0597b18306926355" class="i property">Fragmentor</a>.<a href="../common/fragmentor.cs.html#a4fa6a799e0782de" class="i property">FragmentSize</a>, <a href="#18a4f0d667340c87" class="i field">_onDataAvailable</a>))
                        {
                            <a href="#d2f32beb6d38f45c" class="i field">_shouldFlushData</a> = <span class="r71 r">flush</span>;
                            <a href="#8a0e6b54db494964" class="i field">_reportAsPending</a> = <span class="r72 r">reportPending</span>;
                            <a href="#cf312c8e9dac76f8" class="i field">_runspacePoolInstanceId</a> = <span class="r73 r">dataToBeSent</span>.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#df5fe91d15e5ba71" class="i property">RunspacePoolId</a>;
                            <a href="#f852acefef7162a9" class="i field">_powerShellInstanceId</a> = <span class="r73 r">dataToBeSent</span>.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#767aea3474afdc8e" class="i property">PowerShellId</a>;
                            <a href="#6bc3df74a7f8f866" class="i field">_dataType</a> = <span class="r73 r">dataToBeSent</span>.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#97d7621b092d013f" class="i property">DataType</a>;
                            <a href="#617d1fa68ddbe101" class="i field">_targetInterface</a> = <span class="r73 r">dataToBeSent</span>.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#6975a2b0635b9f80" class="i property">TargetInterface</a>;
                            <a href="#0597b18306926355" class="i property">Fragmentor</a>.<a href="../common/fragmentor.cs.html#a97b5918de0a99cf" class="i method">Fragment</a>&lt;<b>object</b>&gt;(<span class="r73 r">dataToBeSent</span>, <span class="r74 r">serializedData</span>);
                        }
 
                        <b>if</b> ((<a href="#4948c4fec475734c" class="i field">_dataToBeSentQueue</a> != <b>null</b>) &amp;&amp; (<a href="#4948c4fec475734c" class="i field">_dataToBeSentQueue</a>.<span class="i">Count</span> &gt; 0))
                        {
                            <span class="i">Tuple</span>&lt;<a href="../common/WireDataFormat/RemotingDataObject.cs.html#3856dcbea775cab8" class="t t">RemoteDataObject</a>, <b>bool</b>, <b>bool</b>&gt; <span id="r75 rd" class="r75 r">dataToBeSentQueueItem</span> = <a href="#4948c4fec475734c" class="i field">_dataToBeSentQueue</a>.<span class="i">Dequeue</span>();
                            <span class="r73 r">dataToBeSent</span> = <span class="r75 r">dataToBeSentQueueItem</span>.<span class="i">Item1</span>;
                            <span class="r71 r">flush</span> = <span class="r75 r">dataToBeSentQueueItem</span>.<span class="i">Item2</span>;
                            <span class="r72 r">reportPending</span> = <span class="r75 r">dataToBeSentQueueItem</span>.<span class="i">Item3</span>;
                        }
                        <b>else</b>
                        {
                            <span class="r73 r">dataToBeSent</span> = <b>null</b>;
                        }
                    } <b>while</b> (<span class="r73 r">dataToBeSent</span> != <b>null</b>);
                }
                <b>finally</b>
                {
                    <a href="#e84f3cefad376d9c" class="i field">_isSerializing</a> = <b>false</b>;
                }
            }
        }
 
        <b>private void</b> <a id="ab2c84aeb8c22a40" href="../../../R/ab2c84aeb8c22a40.html" target="n" data-glyph="76,1" class="i method">OnDataAvailable</a>(<b>byte</b>[] <span id="r76 rd" class="r76 r">dataToSend</span>, <b>bool</b> <span id="r77 rd" class="r77 r">isEndFragment</span>)
        {
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r76 r">dataToSend</span> != <b>null</b>, <span class="s">&quot;ServerTransportManager cannot send null fragment&quot;</span>);
            <span class="c">// log to crimson log.</span>
            <a href="../../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<span class="i">LogAnalyticInformational</span>(<a href="../common/PSETWTracer.cs.html#609c10dc18364c6e" class="t t">PSEventId</a>.<a href="../common/PSETWTracer.cs.html#b360f293cf803c6a" class="i field">ServerSendData</a>, <a href="../common/PSETWTracer.cs.html#2dd3393d77ef2dd0" class="t t">PSOpcode</a>.<a href="../common/PSETWTracer.cs.html#10dc07d70da5e17a" class="i field">Send</a>, <a href="../common/PSETWTracer.cs.html#6bc0e8b902470481" class="t t">PSTask</a>.<a href="../common/PSETWTracer.cs.html#c682d415f6327c59" class="i field">None</a>,
                <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#c5d4a73b62c859ab" class="i field">Transport</a> | <a href="../common/PSETWTracer.cs.html#d4b75692e500e678" class="t t">PSKeyword</a>.<a href="../common/PSETWTracer.cs.html#a3de02676385c3a4" class="i field">UseAlwaysAnalytic</a>,
                <a href="#cf312c8e9dac76f8" class="i field">_runspacePoolInstanceId</a>.<span class="i">ToString</span>(),
                <a href="#f852acefef7162a9" class="i field">_powerShellInstanceId</a>.<span class="i">ToString</span>(),
                <span class="r76 r">dataToSend</span>.<span class="i">Length</span>.<span class="i">ToString</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>),
                (<span class="i">UInt32</span>)<a href="#6bc3df74a7f8f866" class="i field">_dataType</a>,
                (<span class="i">UInt32</span>)<a href="#617d1fa68ddbe101" class="i field">_targetInterface</a>);
 
            <a href="#f36d6398fc745fd4" class="i method">SendDataToClient</a>(<span class="r76 r">dataToSend</span>, <span class="r77 r">isEndFragment</span> &amp;&amp; <a href="#d2f32beb6d38f45c" class="i field">_shouldFlushData</a>, <a href="#8a0e6b54db494964" class="i field">_reportAsPending</a>, <span class="r77 r">isEndFragment</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Sends an object to the server end. The object is fragmented and each fragment is sent</span>
        <span class="c">///</span><span class="c"> separately. The call blocks until all the fragments are sent to the client. If there</span>
        <span class="c">///</span><span class="c"> is a failure sending any of the fragments WSManTransportErrorOccured event is raised.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r78 r">psObjectData</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r79 r">flush</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> true to immediately send data to client.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r80 r">reportAsPending</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> reported as true when sending host message requests are reported true</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="49ea489c355e3169" href="../../../R/49ea489c355e3169.html" target="n" data-glyph="74,1" class="i method">SendDataToClient</a>(<a href="../common/WireDataFormat/RemotingDataObject.cs.html#3856dcbea775cab8" class="t t">RemoteDataObject</a> <span id="r78 rd" class="r78 r">psObjectData</span>, <b>bool</b> <span id="r79 rd" class="r79 r">flush</span>, <b>bool</b> <span id="r80 rd" class="r80 r">reportAsPending</span> = <b>false</b>)
        {
            <a href="#5b130cd293defcf8" class="i method">SendDataToClient</a>&lt;<b>object</b>&gt;((<a href="../common/WireDataFormat/RemotingDataObject.cs.html#ca4629603c976aab" class="t t">RemoteDataObject</a>&lt;<b>object</b>&gt;)(<span class="r78 r">psObjectData</span>), <span class="r79 r">flush</span>, <span class="r80 r">reportAsPending</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Reports error from a thread pool thread. Thread Pool is used in order to</span>
        <span class="c">///</span><span class="c"> not block Pipeline closing. This method is generally called when the</span>
        <span class="c">///</span><span class="c"> TransportManager fails to Send data (SendDataToClient). Pipeline Execution</span>
        <span class="c">///</span><span class="c"> Thread directly calls SendDataToClient method from its execution thread,</span>
        <span class="c">///</span><span class="c"> so we cannot call Stop from the same thread (as it will result in a deadlock)</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="5fb547c0ef9c383b" href="../../../R/5fb547c0ef9c383b.html" target="n" data-glyph="74,1" class="i method">ReportError</a>(<b>int</b> <span id="r81 rd" class="r81 r">errorCode</span>, <b>string</b> <span id="r82 rd" class="r82 r">methodName</span>)
        {
            <b>string</b> <span id="r83 rd" class="r83 r">messageResource</span> = <span class="i">RemotingErrorIdStrings</span>.<span class="i">GeneralError</span>;
            <b>string</b> <span id="r84 rd" class="r84 r">errorMessage</span> = <b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>,
                <span class="r83 r">messageResource</span>, <b>new</b> <b>object</b>[] { <span class="r81 r">errorCode</span>, <span class="r82 r">methodName</span> });
 
            <a href="../common/remotingexceptions.cs.html#0bb8687f97d91059" class="t t">PSRemotingTransportException</a> <span id="r85 rd" class="r85 r">e</span> = <b>new</b> <a href="../common/remotingexceptions.cs.html#3d42c01e0f93455e" class="t constructor">PSRemotingTransportException</a>(<span class="r84 r">errorMessage</span>);
            <span class="r85 r">e</span>.<a href="../common/remotingexceptions.cs.html#f96218464c4b7244" class="i property">ErrorCode</a> = <span class="r81 r">errorCode</span>;
 
            <span class="c">// Use thread-pool thread to raise the error handler..see explanation</span>
            <span class="c">// in the method summary</span>
            <span class="i">ThreadPool</span>.<span class="i">QueueUserWorkItem</span>(<b>new</b> <span class="i">WaitCallback</span>(
                (<b>object</b> <span id="r86 rd" class="r86 r">state</span>) =&gt;
                {
                    <a href="#7e70b34f9332dfcd" class="t t">TransportErrorOccuredEventArgs</a> <span id="r87 rd" class="r87 r">eventArgs</span> = <b>new</b> <a href="#c420864940871a42" class="t constructor">TransportErrorOccuredEventArgs</a>(<span class="r85 r">e</span>,
                        <a href="#33678df914ca9daf" class="t t">TransportMethodEnum</a>.<a href="#ec9b351bc6228ffe" class="i field">Unknown</a>);
                    <a href="#8e00d8a2f8745652" class="i method">RaiseErrorHandler</a>(<span class="r87 r">eventArgs</span>);
                }));
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Raises the closing event.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="26773d85900651e4" href="../../../R/26773d85900651e4.html" target="n" data-glyph="74,1" class="i method">RaiseClosingEvent</a>()
        {
            <a href="#2fd00aae4537bede" class="i">Closing</a>.<span class="i">SafeInvoke</span>(<a href="#3beeadac29de3a80" class="k">this</a>, <span class="i">EventArgs</span>.<span class="i">Empty</span>);
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Event Handlers
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Event that is raised when this transport manager is closing.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal event</b> <span class="i">EventHandler</span> <a id="2fd00aae4537bede" href="../../../R/2fd00aae4537bede.html" target="n" data-glyph="32,1" class="i">Closing</a>;
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Abstract interfaces
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r88 r">data</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r89 r">flush</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> flush data by sending data immediately to the client.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r90 r">reportAsPending</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> reported as true when sending host message requests to client</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r91 r">reportAsDataBoundary</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> reported as true when data being reported is as object boundary, i.e the corresponding fragment is an end fragment</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>protected abstract void</b> <a id="f36d6398fc745fd4" href="../../../R/f36d6398fc745fd4.html" target="n" data-glyph="75,1" class="i method">SendDataToClient</a>(<b>byte</b>[] <span id="r88 rd" class="r88 r">data</span>, <b>bool</b> <span id="r89 rd" class="r89 r">flush</span>, <b>bool</b> <span id="r90 rd" class="r90 r">reportAsPending</span>, <b>bool</b> <span id="r91 rd" class="r91 r">reportAsDataBoundary</span>);
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal abstract void</b> <a id="6cbb8114566035b4" href="../../../R/6cbb8114566035b4.html" target="n" data-glyph="74,1" class="i method">ReportExecutionStatusAsRunning</a>();
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r92 r">reasonForClose</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> message describing why the transport manager must be closed</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal abstract void</b> <a id="394a627c71edfcbe" href="../../../R/394a627c71edfcbe.html" target="n" data-glyph="74,1" class="i method">Close</a>(<span class="i">Exception</span> <span id="r92 rd" class="r92 r">reasonForClose</span>);
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Prepare the transport manager to send data (because a command</span>
        <span class="c">///</span><span class="c"> is about to start). This is used by underlying infrastructure</span>
        <span class="c">///</span><span class="c"> to send ACK to client..so client can start sending input and</span>
        <span class="c">///</span><span class="c"> other data to server.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal virtual void</b> <a id="800a08f5b7eaeef4" href="../../../R/800a08f5b7eaeef4.html" target="n" data-glyph="74,1" class="i method">Prepare</a>()
        {
            <span class="c">// command may hijack the calling thread to run the command</span>
            <span class="c">// so this method call notifies the ReceivedData buffer to</span>
            <span class="c">// allow another thread to ProcessRawData.</span>
            <a href="#766c6c998b78695f" class="i property">ReceivedDataCollection</a>.<a href="PriorityCollection.cs.html#b8482b44fc8fc3a2" class="i method">AllowTwoThreadsToProcessRawData</a>();
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
    }
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> This represents an abstraction for server session transport manager.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>internal abstract class</b> <a id="18630eb940dac0a0" href="../../../R/18630eb940dac0a0.html" target="n" data-glyph="2,0" class="t t">AbstractServerSessionTransportManager</a> : <a href="#3beeadac29de3a80" class="t t">AbstractServerTransportManager</a>
    {
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Constructors
 
        <b>protected</b> <a id="0789ba713b2eb040" href="../../../R/0789ba713b2eb040.html" target="n" data-glyph="75,1" class="t constructor">AbstractServerSessionTransportManager</a>(<b>int</b> <span id="r93 rd" class="r93 r">fragmentSize</span>, <a href="../../../utils/CryptoUtils.cs.html#1999dfb2439af5a0" class="t t">PSRemotingCryptoHelper</a> <span id="r94 rd" class="r94 r">cryptoHelper</span>)
            : <a href="#34137234abfd253c" class="k">base</a>(<span class="r93 r">fragmentSize</span>, <span class="r94 r">cryptoHelper</span>)
        {
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Abstract interfaces
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Server RunspacePool driver uses this method to attach to a server transport manager.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r95 r">powerShellCmdId</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal abstract</b> <a href="#3beeadac29de3a80" class="t t">AbstractServerTransportManager</a> <a id="b9e44401311d2bc3" href="../../../R/b9e44401311d2bc3.html" target="n" data-glyph="74,1" class="i method">GetCommandTransportManager</a>(<span class="i">Guid</span> <span id="r95 rd" class="r95 r">powerShellCmdId</span>);
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Server RunspacePool driver uses this method to remove association of a command transport manager</span>
        <span class="c">///</span><span class="c"> from a session transport manager.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r96 r">powerShellCmdId</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal abstract void</b> <a id="ead93e5ba7011758" href="../../../R/ead93e5ba7011758.html" target="n" data-glyph="74,1" class="i method">RemoveCommandTransportManager</a>(<span class="i">Guid</span> <span id="r96 rd" class="r96 r">powerShellCmdId</span>);
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
    }
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> A container for helper functions that accomplish common client and server tasks.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>internal static class</b> <a id="e8f1ac90f941837f" href="../../../R/e8f1ac90f941837f.html" target="n" data-glyph="2,0" class="t t">ServerOperationHelpers</a>
    {
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Public Helper Methods
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> A helper method to extract a base-64 encoded XML element from a specified input</span>
        <span class="c">///</span><span class="c"> buffer. The calls required are not compatible with the Managed C++ CoreCLR</span>
        <span class="c">///</span><span class="c"> mscorlib, but this operation is supported as managed C# code.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r97 r">xmlBuffer</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The input buffer to search. It must be base-64 encoded XML.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r98 r">xmlTag</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The XML tag used to identify the value to extract.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">The extracted tag converted from a base-64 string.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal static byte</b>[] <a id="4cf9fbefd6b59fe6" href="../../../R/4cf9fbefd6b59fe6.html" target="n" data-glyph="74,1" class="i method">ExtractEncodedXmlElement</a>(<b>string</b> <span id="r97 rd" class="r97 r">xmlBuffer</span>, <b>string</b> <span id="r98 rd" class="r98 r">xmlTag</span>)
        {
            <b>if</b> (<span class="r97 r">xmlBuffer</span> == <b>null</b> || <span class="r98 r">xmlTag</span> == <b>null</b>)
                <b>return</b> <b>new</b> <b>byte</b>[1];
 
            <span class="c">// the inboundShellInformation is in Xml format as per the SOAP WSMan spec.</span>
            <span class="c">// Retrieve the string (Base64 encoded) we are interested in.</span>
            <span class="i">XmlReaderSettings</span> <span id="r99 rd" class="r99 r">readerSettings</span> = <b>new</b> <span class="i">XmlReaderSettings</span>();
            <span class="r99 r">readerSettings</span>.<span class="i">CheckCharacters</span> = <b>false</b>;
            <span class="r99 r">readerSettings</span>.<span class="i">IgnoreComments</span> = <b>true</b>;
            <span class="r99 r">readerSettings</span>.<span class="i">IgnoreProcessingInstructions</span> = <b>true</b>;
            <span class="r99 r">readerSettings</span>.<span class="i">XmlResolver</span> = <b>null</b>;
            <span class="r99 r">readerSettings</span>.<span class="i">ConformanceLevel</span> = <span class="i">ConformanceLevel</span>.<span class="i">Fragment</span>;
            <span class="r99 r">readerSettings</span>.<span class="i">MaxCharactersFromEntities</span> = 1024;
            <span class="r99 r">readerSettings</span>.<span class="i">DtdProcessing</span> = <span class="i n">System</span>.<span class="i">Xml</span>.<span class="i">DtdProcessing</span>.<span class="i">Prohibit</span>;
            <span class="i">XmlReader</span> <span id="r100 rd" class="r100 r">reader</span> = <span class="i">XmlReader</span>.<span class="i">Create</span>(<b>new</b> <span class="i">StringReader</span>(<span class="r97 r">xmlBuffer</span>), <span class="r99 r">readerSettings</span>);
 
            <b>string</b> <span id="r101 rd" class="r101 r">additionalData</span>;
            <b>if</b> (<span class="r100 r">reader</span>.<span class="i">MoveToContent</span>() == <span class="i">XmlNodeType</span>.<span class="i">Element</span>)
            {
                <span class="r101 r">additionalData</span> = <span class="r100 r">reader</span>.<span class="i">ReadElementContentAsString</span>(<span class="r98 r">xmlTag</span>, <span class="r100 r">reader</span>.<span class="i">NamespaceURI</span>);
            }
            <b>else</b> <span class="c">// No element found, so return a default value</span>
            {
                <b>return</b> <b>new</b> <b>byte</b>[1];
            }
 
            <b>return</b> <span class="i">Convert</span>.<span class="i">FromBase64String</span>(<span class="r101 r">additionalData</span>);
        }
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
    }
}
</pre></td></tr></table></div></body></html>
