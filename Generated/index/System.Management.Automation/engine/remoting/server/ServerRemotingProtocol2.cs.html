<!DOCTYPE html>
<html><head><title>ServerRemotingProtocol2.cs</title><link rel="stylesheet" href="../../../../styles.css"><script src="../../../../scripts.js"></script></head>
<body class="cB" onload="i(814);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#System.Management.Automation/engine/remoting/server/ServerRemotingProtocol2.cs" target="_top">engine\remoting\server\ServerRemotingProtocol2.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#System.Management.Automation" target="_top">src\System.Management.Automation\System.Management.Automation.csproj</a> (System.Management.Automation)</td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation.</span>
<span class="c">// Licensed under the MIT License.</span>
 
<b>using</b> <span class="i n">System</span>.<span class="i">Collections</span>.<span class="i">Generic</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Remoting</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Remoting</span>.<span class="i n">Server</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Runspaces</span>;
 
<b>using</b> <span class="t">Dbg</span> = <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Diagnostics</a>;
 
<b>namespace</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>
{
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Handles all data structure handler communication with the client</span>
    <span class="c">///</span><span class="c"> runspace pool.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>internal class</b> <a id="009d06bea79ad646" href="../../../R/009d06bea79ad646.html" target="n" data-glyph="2,0" class="t t">ServerRunspacePoolDataStructureHandler</a>
    {
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Constructors
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Constructor which takes a server runspace pool driver and</span>
        <span class="c">///</span><span class="c"> creates an associated ServerRunspacePoolDataStructureHandler.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r0 r">driver</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r1 r">transportManager</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal</b> <a id="52ff8105828cda74" href="../../../R/52ff8105828cda74.html" target="n" data-glyph="74,1" class="t constructor">ServerRunspacePoolDataStructureHandler</a>(<a href="ServerRunspacePoolDriver.cs.html#a13c57c874abb0c5" class="t t">ServerRunspacePoolDriver</a> <span id="r0 rd" class="r0 r">driver</span>,
            <a href="../fanin/BaseTransportManager.cs.html#18630eb940dac0a0" class="t t">AbstractServerSessionTransportManager</a> <span id="r1 rd" class="r1 r">transportManager</span>)
        {
            <a href="#0573dee38b1833bb" class="i field">_clientRunspacePoolId</a> = <span class="r0 r">driver</span>.<a href="ServerRunspacePoolDriver.cs.html#4bfa83b8eb92f06f" class="i property">InstanceId</a>;
            <a href="#f71d849d27fad741" class="i field">_transportManager</a> = <span class="r1 r">transportManager</span>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Constructors
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Data Structure Handler Methods
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Send a message with application private data to the client.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r2 r">applicationPrivateData</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">ApplicationPrivateData to send.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r3 r">serverCapability</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Server capability negotiated during initial exchange of remoting messages / session capabilities of client and server.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="6fccfbc477a8007e" href="../../../R/6fccfbc477a8007e.html" target="n" data-glyph="74,1" class="i method">SendApplicationPrivateDataToClient</a>(<a href="../../serialization.cs.html#04756020c00714fe" class="t t">PSPrimitiveDictionary</a> <span id="r2 rd" class="r2 r">applicationPrivateData</span>, <a href="../common/WireDataFormat/RemoteSessionCapability.cs.html#410d0e97ea446fd9" class="t t">RemoteSessionCapability</a> <span id="r3 rd" class="r3 r">serverCapability</span>)
        {
            <span class="c">// make server&#39;s PSVersionTable available to the client using ApplicationPrivateData</span>
            <a href="../../serialization.cs.html#04756020c00714fe" class="t t">PSPrimitiveDictionary</a> <span id="r4 rd" class="r4 r">applicationPrivateDataWithVersionTable</span> =
                <a href="../../serialization.cs.html#04756020c00714fe" class="t t">PSPrimitiveDictionary</a>.<a href="../../serialization.cs.html#e247a6e030dd9d9f" class="i method">CloneAndAddPSVersionTable</a>(<span class="r2 r">applicationPrivateData</span>);
 
            <span class="c">// override the hardcoded version numbers with the stuff that was reported to the client during negotiation</span>
            <a href="../../serialization.cs.html#04756020c00714fe" class="t t">PSPrimitiveDictionary</a> <span id="r5 rd" class="r5 r">versionTable</span> = (<a href="../../serialization.cs.html#04756020c00714fe" class="t t">PSPrimitiveDictionary</a>)<span class="r4 r">applicationPrivateDataWithVersionTable</span><a href="../../serialization.cs.html#ef1aa37a4f65ba77">[</a><a href="../../PSVersionInfo.cs.html#be287f9ea52b8d2f" class="t t">PSVersionInfo</a>.<a href="../../PSVersionInfo.cs.html#6f3eb6d7f2bfc1d8" class="i field">PSVersionTableName</a>];
            <span class="r5 r">versionTable</span><a href="../../serialization.cs.html#ef1aa37a4f65ba77">[</a><a href="../../PSVersionInfo.cs.html#be287f9ea52b8d2f" class="t t">PSVersionInfo</a>.<a href="../../PSVersionInfo.cs.html#a1769a49a5895018" class="i field">PSRemotingProtocolVersionName</a>] = <span class="r3 r">serverCapability</span>.<a href="../common/WireDataFormat/RemoteSessionCapability.cs.html#e0172342f9aadac0" class="i property">ProtocolVersion</a>;
            <span class="r5 r">versionTable</span><a href="../../serialization.cs.html#ef1aa37a4f65ba77">[</a><a href="../../PSVersionInfo.cs.html#be287f9ea52b8d2f" class="t t">PSVersionInfo</a>.<a href="../../PSVersionInfo.cs.html#d8ea3c97eef11d3d" class="i field">SerializationVersionName</a>] = <span class="r3 r">serverCapability</span>.<a href="../common/WireDataFormat/RemoteSessionCapability.cs.html#4cbbb234181ff56e" class="i property">SerializationVersion</a>;
 
            <span class="c">// Pass back the true PowerShell version to the client via application private data.</span>
            <span class="r5 r">versionTable</span><a href="../../serialization.cs.html#ef1aa37a4f65ba77">[</a><a href="../../PSVersionInfo.cs.html#be287f9ea52b8d2f" class="t t">PSVersionInfo</a>.<a href="../../PSVersionInfo.cs.html#6452abbf2d72fad5" class="i field">PSVersionName</a>] = <a href="../../PSVersionInfo.cs.html#be287f9ea52b8d2f" class="t t">PSVersionInfo</a>.<a href="../../PSVersionInfo.cs.html#ad63365ac7690eeb" class="i property">PSVersion</a>;
 
            <a href="../common/WireDataFormat/RemotingDataObject.cs.html#3856dcbea775cab8" class="t t">RemoteDataObject</a> <span id="r6 rd" class="r6 r">data</span> = <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#88b19073d823ce05" class="t t">RemotingEncoder</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#58d663bb675c65e9" class="i method">GenerateApplicationPrivateData</a>(
                <a href="#0573dee38b1833bb" class="i field">_clientRunspacePoolId</a>, <span class="r4 r">applicationPrivateDataWithVersionTable</span>);
 
            <a href="#e41c4cd54f3a2dd8" class="i method">SendDataAsync</a>(<span class="r6 r">data</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Send a message with the RunspacePoolStateInfo to the client.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r7 r">stateInfo</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">State info to send.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="31f21b7dd4e21b61" href="../../../R/31f21b7dd4e21b61.html" target="n" data-glyph="74,1" class="i method">SendStateInfoToClient</a>(<a href="../common/RunspacePoolStateInfo.cs.html#8b9143609d7a0363" class="t t">RunspacePoolStateInfo</a> <span id="r7 rd" class="r7 r">stateInfo</span>)
        {
            <a href="../common/WireDataFormat/RemotingDataObject.cs.html#3856dcbea775cab8" class="t t">RemoteDataObject</a> <span id="r8 rd" class="r8 r">data</span> = <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#88b19073d823ce05" class="t t">RemotingEncoder</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#d63dc62e20c6faf1" class="i method">GenerateRunspacePoolStateInfo</a>(
                    <a href="#0573dee38b1833bb" class="i field">_clientRunspacePoolId</a>, <span class="r7 r">stateInfo</span>);
 
            <a href="#e41c4cd54f3a2dd8" class="i method">SendDataAsync</a>(<span class="r8 r">data</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Send a message with the PSEventArgs to the client.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r9 r">e</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Event to send.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="debf8979c9406af0" href="../../../R/debf8979c9406af0.html" target="n" data-glyph="74,1" class="i method">SendPSEventArgsToClient</a>(<a href="../../EventManager.cs.html#7210411b2f4a8407" class="t t">PSEventArgs</a> <span id="r9 rd" class="r9 r">e</span>)
        {
            <a href="../common/WireDataFormat/RemotingDataObject.cs.html#3856dcbea775cab8" class="t t">RemoteDataObject</a> <span id="r10 rd" class="r10 r">data</span> = <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#88b19073d823ce05" class="t t">RemotingEncoder</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#705937a9166e71a4" class="i method">GeneratePSEventArgs</a>(<a href="#0573dee38b1833bb" class="i field">_clientRunspacePoolId</a>, <span class="r9 r">e</span>);
 
            <a href="#e41c4cd54f3a2dd8" class="i method">SendDataAsync</a>(<span class="r10 r">data</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Called when session is connected from a new client</span>
        <span class="c">///</span><span class="c"> call into the sessionconnect handlers for each associated powershell dshandler.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="8ef9d48af13dd214" href="../../../R/8ef9d48af13dd214.html" target="n" data-glyph="74,1" class="i method">ProcessConnect</a>()
        {
            <span class="i">List</span>&lt;<a href="#21dc790594e0a9f8" class="t t">ServerPowerShellDataStructureHandler</a>&gt; <span id="r11 rd" class="r11 r">dsHandlers</span>;
            <b>lock</b> (<a href="#e9cea004f0a8fbaa" class="i field">_associationSyncObject</a>)
            {
                <span class="r11 r">dsHandlers</span> = <b>new</b> <span class="i">List</span>&lt;<a href="#21dc790594e0a9f8" class="t t">ServerPowerShellDataStructureHandler</a>&gt;(<a href="#d1d162d93684a28a" class="i field">_associatedShells</a>.<span class="i">Values</span>);
            }
 
            <b>foreach</b> (<b>var</b> <span id="r12 rd" class="r12 r">dsHandler</span> <b>in</b> <span class="r11 r">dsHandlers</span>)
            {
                <span class="r12 r">dsHandler</span>.<span class="i">ProcessConnect</span>();
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Process the data received from the runspace pool on</span>
        <span class="c">///</span><span class="c"> the server.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r13 r">receivedData</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Data received.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="38de9af2c5bdcad5" href="../../../R/38de9af2c5bdcad5.html" target="n" data-glyph="74,1" class="i method">ProcessReceivedData</a>(<a href="../common/WireDataFormat/RemotingDataObject.cs.html#ca4629603c976aab" class="t t">RemoteDataObject</a>&lt;<a href="../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt; <span id="r13 rd" class="r13 r">receivedData</span>)
        {
            <b>if</b> (<span class="r13 r">receivedData</span> == <b>null</b>)
            {
                <b>throw</b> <a href="../../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../../../utils/MshTraceSource.cs.html#fbe67220ad7522a0" class="i method">NewArgumentNullException</a>(<b>nameof</b>(<span class="r13 r">receivedData</span>));
            }
 
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r13 r">receivedData</span>.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#6975a2b0635b9f80" class="i property">TargetInterface</a> == <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#1d73dff2a8d6a0bf" class="t t">RemotingTargetInterface</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#405ccc8b1bd2a170" class="i field">RunspacePool</a>,
                <span class="s">&quot;RemotingTargetInterface must be Runspace&quot;</span>);
 
            <b>switch</b> (<span class="r13 r">receivedData</span>.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#97d7621b092d013f" class="i property">DataType</a>)
            {
                <b>case</b> <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#296cbb5be87abd08" class="t t">RemotingDataType</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#8941649eed4c5b4c" class="i field">CreatePowerShell</a>:
                    {
                        <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<a href="#07f70d7701183a55" class="i">CreateAndInvokePowerShell</a> != <b>null</b>,
                            <span class="s">&quot;The ServerRunspacePoolDriver should subscribe to all data structure handler events&quot;</span>);
 
                        <a href="#07f70d7701183a55" class="i">CreateAndInvokePowerShell</a>.<span class="i">SafeInvoke</span>(<a href="#009d06bea79ad646" class="k">this</a>, <b>new</b> <a href="../common/misc.cs.html#79fd22f37cbd3e2d" class="t constructor">RemoteDataEventArgs</a>&lt;<a href="../common/WireDataFormat/RemotingDataObject.cs.html#ca4629603c976aab" class="t t">RemoteDataObject</a>&lt;<a href="../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt;&gt;(<span class="r13 r">receivedData</span>));
                    }
 
                    <b>break</b>;
 
                <b>case</b> <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#296cbb5be87abd08" class="t t">RemotingDataType</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#6b9c2480be4dabfb" class="i field">GetCommandMetadata</a>:
                    {
                        <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<a href="#9cb87f6ce81f4781" class="i">GetCommandMetadata</a> != <b>null</b>,
                            <span class="s">&quot;The ServerRunspacePoolDriver should subscribe to all data structure handler events&quot;</span>);
 
                        <a href="#9cb87f6ce81f4781" class="i">GetCommandMetadata</a>.<span class="i">SafeInvoke</span>(<a href="#009d06bea79ad646" class="k">this</a>, <b>new</b> <a href="../common/misc.cs.html#79fd22f37cbd3e2d" class="t constructor">RemoteDataEventArgs</a>&lt;<a href="../common/WireDataFormat/RemotingDataObject.cs.html#ca4629603c976aab" class="t t">RemoteDataObject</a>&lt;<a href="../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt;&gt;(<span class="r13 r">receivedData</span>));
                    }
 
                    <b>break</b>;
 
                <b>case</b> <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#296cbb5be87abd08" class="t t">RemotingDataType</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#9796e4c77fc83e5c" class="i field">RemoteRunspaceHostResponseData</a>:
                    {
                        <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<a href="#ec38642f3daebd0b" class="i">HostResponseReceived</a> != <b>null</b>,
                            <span class="s">&quot;The ServerRunspacePoolDriver should subscribe to all data structure handler events&quot;</span>);
 
                        <a href="../common/WireDataFormat/RemoteHost.cs.html#2088d050a88e3ac6" class="t t">RemoteHostResponse</a> <span id="r14 rd" class="r14 r">remoteHostResponse</span> = <a href="../common/WireDataFormat/RemoteHost.cs.html#2088d050a88e3ac6" class="t t">RemoteHostResponse</a>.<a href="../common/WireDataFormat/RemoteHost.cs.html#bb70fcce88a4188e" class="i method">Decode</a>(<span class="r13 r">receivedData</span>.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#d13e5d3038741f3e" class="i property">Data</a>);
 
                        <span class="c">// part of host message robustness algo. Now the host response is back, report to transport that</span>
                        <span class="c">// execution status is back to running</span>
                        <a href="#f71d849d27fad741" class="i field">_transportManager</a>.<a href="../fanin/BaseTransportManager.cs.html#6cbb8114566035b4" class="i method">ReportExecutionStatusAsRunning</a>();
 
                        <a href="#ec38642f3daebd0b" class="i">HostResponseReceived</a>.<span class="i">SafeInvoke</span>(<a href="#009d06bea79ad646" class="k">this</a>, <b>new</b> <a href="../common/misc.cs.html#79fd22f37cbd3e2d" class="t constructor">RemoteDataEventArgs</a>&lt;<a href="../common/WireDataFormat/RemoteHost.cs.html#2088d050a88e3ac6" class="t t">RemoteHostResponse</a>&gt;(<span class="r14 r">remoteHostResponse</span>));
                    }
 
                    <b>break</b>;
 
                <b>case</b> <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#296cbb5be87abd08" class="t t">RemotingDataType</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#106fd8fc888670f5" class="i field">SetMaxRunspaces</a>:
                    {
                        <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<a href="#26dc24aa6a255ba7" class="i">SetMaxRunspacesReceived</a> != <b>null</b>,
                            <span class="s">&quot;The ServerRunspacePoolDriver should subscribe to all data structure handler events&quot;</span>);
 
                        <a href="#26dc24aa6a255ba7" class="i">SetMaxRunspacesReceived</a>.<span class="i">SafeInvoke</span>(<a href="#009d06bea79ad646" class="k">this</a>, <b>new</b> <a href="../common/misc.cs.html#79fd22f37cbd3e2d" class="t constructor">RemoteDataEventArgs</a>&lt;<a href="../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt;(<span class="r13 r">receivedData</span>.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#d13e5d3038741f3e" class="i property">Data</a>));
                    }
 
                    <b>break</b>;
 
                <b>case</b> <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#296cbb5be87abd08" class="t t">RemotingDataType</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#d9fbe248918ae2c4" class="i field">SetMinRunspaces</a>:
                    {
                        <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<a href="#c74ca275ccc29f44" class="i">SetMinRunspacesReceived</a> != <b>null</b>,
                            <span class="s">&quot;The ServerRunspacePoolDriver should subscribe to all data structure handler events&quot;</span>);
 
                        <a href="#c74ca275ccc29f44" class="i">SetMinRunspacesReceived</a>.<span class="i">SafeInvoke</span>(<a href="#009d06bea79ad646" class="k">this</a>, <b>new</b> <a href="../common/misc.cs.html#79fd22f37cbd3e2d" class="t constructor">RemoteDataEventArgs</a>&lt;<a href="../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt;(<span class="r13 r">receivedData</span>.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#d13e5d3038741f3e" class="i property">Data</a>));
                    }
 
                    <b>break</b>;
 
                <b>case</b> <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#296cbb5be87abd08" class="t t">RemotingDataType</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#5457c2b97b9a6efb" class="i field">AvailableRunspaces</a>:
                    {
                        <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<a href="#05c3fba8b29b35ff" class="i">GetAvailableRunspacesReceived</a> != <b>null</b>,
                            <span class="s">&quot;The ServerRunspacePoolDriver should subscribe to all data structure handler events&quot;</span>);
 
                        <a href="#05c3fba8b29b35ff" class="i">GetAvailableRunspacesReceived</a>.<span class="i">SafeInvoke</span>(<a href="#009d06bea79ad646" class="k">this</a>, <b>new</b> <a href="../common/misc.cs.html#79fd22f37cbd3e2d" class="t constructor">RemoteDataEventArgs</a>&lt;<a href="../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt;(<span class="r13 r">receivedData</span>.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#d13e5d3038741f3e" class="i property">Data</a>));
                    }
 
                    <b>break</b>;
 
                <b>case</b> <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#296cbb5be87abd08" class="t t">RemotingDataType</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#395e49a743d4abcc" class="i field">ResetRunspaceState</a>:
                    {
                        <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<a href="#f1ebe33397f48ba6" class="i">ResetRunspaceState</a> != <b>null</b>,
                            <span class="s">&quot;The ServerRunspacePoolDriver should subscribe to all data structure handler events.&quot;</span>);
 
                        <a href="#f1ebe33397f48ba6" class="i">ResetRunspaceState</a>.<span class="i">SafeInvoke</span>(<a href="#009d06bea79ad646" class="k">this</a>, <b>new</b> <a href="../common/misc.cs.html#79fd22f37cbd3e2d" class="t constructor">RemoteDataEventArgs</a>&lt;<a href="../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt;(<span class="r13 r">receivedData</span>.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#d13e5d3038741f3e" class="i property">Data</a>));
                    }
 
                    <b>break</b>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Creates a powershell data structure handler from this runspace pool.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r15 r">instanceId</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Powershell instance id.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r16 r">runspacePoolId</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Runspace pool id.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r17 r">remoteStreamOptions</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Remote stream options.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r18 r">localPowerShell</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Local PowerShell object.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">ServerPowerShellDataStructureHandler.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal</b> <a href="#21dc790594e0a9f8" class="t t">ServerPowerShellDataStructureHandler</a> <a id="bcac18c640e1f5d6" href="../../../R/bcac18c640e1f5d6.html" target="n" data-glyph="74,1" class="i method">CreatePowerShellDataStructureHandler</a>(
            <span class="i">Guid</span> <span id="r15 rd" class="r15 r">instanceId</span>, <span class="i">Guid</span> <span id="r16 rd" class="r16 r">runspacePoolId</span>, <a href="../../hostifaces/PowerShell.cs.html#3a466dc47c692c8e" class="t t">RemoteStreamOptions</a> <span id="r17 rd" class="r17 r">remoteStreamOptions</span>, <a href="../../hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShell</a> <span id="r18 rd" class="r18 r">localPowerShell</span>)
        {
            <span class="c">// start with pool&#39;s transport manager.</span>
            <a href="../fanin/BaseTransportManager.cs.html#3beeadac29de3a80" class="t t">AbstractServerTransportManager</a> <span id="r19 rd" class="r19 r">cmdTransportManager</span> = <a href="#f71d849d27fad741" class="i field">_transportManager</a>;
 
            <b>if</b> (<span class="r15 r">instanceId</span> != <span class="i">Guid</span>.<span class="i">Empty</span>)
            {
                <span class="r19 r">cmdTransportManager</span> = <a href="#f71d849d27fad741" class="i field">_transportManager</a>.<a href="../fanin/BaseTransportManager.cs.html#b9e44401311d2bc3" class="i method">GetCommandTransportManager</a>(<span class="r15 r">instanceId</span>);
                <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r19 r">cmdTransportManager</span>.<a href="../fanin/BaseTransportManager.cs.html#0ded339d7f7c59f8" class="i property">TypeTable</a> != <b>null</b>, <span class="s">&quot;This should be already set in managed C++ code&quot;</span>);
            }
 
            <a href="#21dc790594e0a9f8" class="t t">ServerPowerShellDataStructureHandler</a> <span id="r20 rd" class="r20 r">dsHandler</span> =
                <b>new</b> <a href="#9ae5b86dae57516a" class="t constructor">ServerPowerShellDataStructureHandler</a>(<span class="r15 r">instanceId</span>, <span class="r16 r">runspacePoolId</span>, <span class="r17 r">remoteStreamOptions</span>, <span class="r19 r">cmdTransportManager</span>, <span class="r18 r">localPowerShell</span>);
 
            <b>lock</b> (<a href="#e9cea004f0a8fbaa" class="i field">_associationSyncObject</a>)
            {
                <a href="#d1d162d93684a28a" class="i field">_associatedShells</a>.<span class="i">Add</span>(<span class="r20 r">dsHandler</span>.<a href="#7fe3b81af8a909ca" class="i property">PowerShellId</a>, <span class="r20 r">dsHandler</span>);
            }
 
            <span class="r20 r">dsHandler</span>.<a href="#82b3dfa73d39cbba" class="i">RemoveAssociation</a> += <span class="i">HandleRemoveAssociation</span>;
 
            <b>return</b> <span class="r20 r">dsHandler</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Returns the currently active PowerShell datastructure handler.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> ServerPowerShellDataStructureHandler if one is present, null otherwise.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal</b> <a href="#21dc790594e0a9f8" class="t t">ServerPowerShellDataStructureHandler</a> <a id="236558dce2cfa090" href="../../../R/236558dce2cfa090.html" target="n" data-glyph="74,1" class="i method">GetPowerShellDataStructureHandler</a>()
        {
            <b>lock</b> (<a href="#e9cea004f0a8fbaa" class="i field">_associationSyncObject</a>)
            {
                <b>if</b> (<a href="#d1d162d93684a28a" class="i field">_associatedShells</a>.<span class="i">Count</span> &gt; 0)
                {
                    <b>foreach</b> (<b>object</b> <span id="r21 rd" class="r21 r">o</span> <b>in</b> <a href="#d1d162d93684a28a" class="i field">_associatedShells</a>.<span class="i">Values</span>)
                    {
                        <a href="#21dc790594e0a9f8" class="t t">ServerPowerShellDataStructureHandler</a> <span id="r22 rd" class="r22 r">result</span> = <span class="r21 r">o</span> <b>as</b> <a href="#21dc790594e0a9f8" class="t t">ServerPowerShellDataStructureHandler</a>;
                        <b>if</b> (<span class="r22 r">result</span> != <b>null</b>)
                        {
                            <b>return</b> <span class="r22 r">result</span>;
                        }
                    }
                }
            }
 
            <b>return</b> <b>null</b>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Dispatch the message to the associated powershell data structure handler.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r23 r">rcvdData</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Message to dispatch.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="e15015fd2707e0e9" href="../../../R/e15015fd2707e0e9.html" target="n" data-glyph="74,1" class="i method">DispatchMessageToPowerShell</a>(<a href="../common/WireDataFormat/RemotingDataObject.cs.html#ca4629603c976aab" class="t t">RemoteDataObject</a>&lt;<a href="../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt; <span id="r23 rd" class="r23 r">rcvdData</span>)
        {
            <a href="#21dc790594e0a9f8" class="t t">ServerPowerShellDataStructureHandler</a> <span id="r24 rd" class="r24 r">dsHandler</span> =
                <a href="#46b34f1962a8dd5f" class="i method">GetAssociatedPowerShellDataStructureHandler</a>(<span class="r23 r">rcvdData</span>.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#767aea3474afdc8e" class="i property">PowerShellId</a>);
 
            <span class="c">// if data structure handler is not found, then association has already been</span>
            <span class="c">// removed, discard message</span>
            <b>if</b> (<span class="r24 r">dsHandler</span> != <b>null</b>)
            {
                <span class="r24 r">dsHandler</span>.<a href="#57f5c4e1e6a9e855" class="i method">ProcessReceivedData</a>(<span class="r23 r">rcvdData</span>);
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Send the specified response to the client. The client call will</span>
        <span class="c">///</span><span class="c"> be blocked on the same.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r25 r">callId</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Call id on the client.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r26 r">response</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Response to send.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="1706779012404689" href="../../../R/1706779012404689.html" target="n" data-glyph="74,1" class="i method">SendResponseToClient</a>(<b>long</b> <span id="r25 rd" class="r25 r">callId</span>, <b>object</b> <span id="r26 rd" class="r26 r">response</span>)
        {
            <a href="../common/WireDataFormat/RemotingDataObject.cs.html#3856dcbea775cab8" class="t t">RemoteDataObject</a> <span id="r27 rd" class="r27 r">message</span> =
                <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#88b19073d823ce05" class="t t">RemotingEncoder</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#8a849da6d49471b1" class="i method">GenerateRunspacePoolOperationResponse</a>(<a href="#0573dee38b1833bb" class="i field">_clientRunspacePoolId</a>, <span class="r26 r">response</span>, <span class="r25 r">callId</span>);
 
            <a href="#e41c4cd54f3a2dd8" class="i method">SendDataAsync</a>(<span class="r27 r">message</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> TypeTable used for Serialization/Deserialization.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal</b> <a href="../../../P/a09d9b2cb7b1f0db.html#a09d9b2cb7b1f0db" class="t t">TypeTable</a> <a id="e84d23a4699638c5" href="../../../R/e84d23a4699638c5.html" target="n" data-glyph="104,1" class="i property">TypeTable</a>
        {
            <b>get</b> { <b>return</b> <a href="#f71d849d27fad741" class="i field">_transportManager</a>.<a href="../fanin/BaseTransportManager.cs.html#0ded339d7f7c59f8" class="i property">TypeTable</a>; }
 
            <b>set</b> { <a href="#f71d849d27fad741" class="i field">_transportManager</a>.<a href="../fanin/BaseTransportManager.cs.html#0ded339d7f7c59f8" class="i property">TypeTable</a> = <b>value</b>; }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Data Structure Handler Methods
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Data Structure Handler events
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This event is raised whenever there is a request from the</span>
        <span class="c">///</span><span class="c"> client to create a powershell on the server and invoke it.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal event</b> <span class="i">EventHandler</span>&lt;<a href="../common/misc.cs.html#16d1e16a7ed9f8cc" class="t t">RemoteDataEventArgs</a>&lt;<a href="../common/WireDataFormat/RemotingDataObject.cs.html#ca4629603c976aab" class="t t">RemoteDataObject</a>&lt;<a href="../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt;&gt;&gt; <a id="07f70d7701183a55" href="../../../R/07f70d7701183a55.html" target="n" data-glyph="32,1" class="i">CreateAndInvokePowerShell</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This event is raised whenever there is a request from the</span>
        <span class="c">///</span><span class="c"> client to run command discovery pipeline.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal event</b> <span class="i">EventHandler</span>&lt;<a href="../common/misc.cs.html#16d1e16a7ed9f8cc" class="t t">RemoteDataEventArgs</a>&lt;<a href="../common/WireDataFormat/RemotingDataObject.cs.html#ca4629603c976aab" class="t t">RemoteDataObject</a>&lt;<a href="../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt;&gt;&gt; <a id="9cb87f6ce81f4781" href="../../../R/9cb87f6ce81f4781.html" target="n" data-glyph="32,1" class="i">GetCommandMetadata</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This event is raised when a host call response is received.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal event</b> <span class="i">EventHandler</span>&lt;<a href="../common/misc.cs.html#16d1e16a7ed9f8cc" class="t t">RemoteDataEventArgs</a>&lt;<a href="../common/WireDataFormat/RemoteHost.cs.html#2088d050a88e3ac6" class="t t">RemoteHostResponse</a>&gt;&gt; <a id="ec38642f3daebd0b" href="../../../R/ec38642f3daebd0b.html" target="n" data-glyph="32,1" class="i">HostResponseReceived</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This event is raised when there is a request to modify the</span>
        <span class="c">///</span><span class="c"> maximum runspaces in the runspace pool.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal event</b> <span class="i">EventHandler</span>&lt;<a href="../common/misc.cs.html#16d1e16a7ed9f8cc" class="t t">RemoteDataEventArgs</a>&lt;<a href="../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt;&gt; <a id="26dc24aa6a255ba7" href="../../../R/26dc24aa6a255ba7.html" target="n" data-glyph="32,1" class="i">SetMaxRunspacesReceived</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This event is raised when there is a request to modify the</span>
        <span class="c">///</span><span class="c"> minimum runspaces in the runspace pool.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal event</b> <span class="i">EventHandler</span>&lt;<a href="../common/misc.cs.html#16d1e16a7ed9f8cc" class="t t">RemoteDataEventArgs</a>&lt;<a href="../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt;&gt; <a id="c74ca275ccc29f44" href="../../../R/c74ca275ccc29f44.html" target="n" data-glyph="32,1" class="i">SetMinRunspacesReceived</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This event is raised when there is a request to get the</span>
        <span class="c">///</span><span class="c"> available runspaces in the runspace pool.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal event</b> <span class="i">EventHandler</span>&lt;<a href="../common/misc.cs.html#16d1e16a7ed9f8cc" class="t t">RemoteDataEventArgs</a>&lt;<a href="../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt;&gt; <a id="05c3fba8b29b35ff" href="../../../R/05c3fba8b29b35ff.html" target="n" data-glyph="32,1" class="i">GetAvailableRunspacesReceived</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This event is raised when the client requests the runspace state</span>
        <span class="c">///</span><span class="c"> to be reset.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal event</b> <span class="i">EventHandler</span>&lt;<a href="../common/misc.cs.html#16d1e16a7ed9f8cc" class="t t">RemoteDataEventArgs</a>&lt;<a href="../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt;&gt; <a id="f1ebe33397f48ba6" href="../../../R/f1ebe33397f48ba6.html" target="n" data-glyph="32,1" class="i">ResetRunspaceState</a>;
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Data Structure Handler events
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Private Methods
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Send the data specified as a RemoteDataObject asynchronously</span>
        <span class="c">///</span><span class="c"> to the runspace pool on the remote session.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r28 r">data</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Data to send.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span><span class="c">This overload takes a RemoteDataObject and should</span>
        <span class="c">///</span><span class="c"> be the one thats used to send data from within this</span>
        <span class="c">///</span><span class="c"> data structure handler class</span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>private void</b> <a id="e41c4cd54f3a2dd8" href="../../../R/e41c4cd54f3a2dd8.html" target="n" data-glyph="76,1" class="i method">SendDataAsync</a>(<a href="../common/WireDataFormat/RemotingDataObject.cs.html#3856dcbea775cab8" class="t t">RemoteDataObject</a> <span id="r28 rd" class="r28 r">data</span>)
        {
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r28 r">data</span> != <b>null</b>, <span class="s">&quot;Cannot send null object.&quot;</span>);
            <a href="#f71d849d27fad741" class="i field">_transportManager</a>.<a href="../fanin/BaseTransportManager.cs.html#49ea489c355e3169" class="i method">SendDataToClient</a>(<span class="r28 r">data</span>, <b>true</b>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Get the associated powershell data structure handler for the specified</span>
        <span class="c">///</span><span class="c"> powershell id.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r29 r">clientPowerShellId</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">powershell id for the</span>
        <span class="c">///</span><span class="c"> powershell data structure handler</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">ServerPowerShellDataStructureHandler.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal</b> <a href="#21dc790594e0a9f8" class="t t">ServerPowerShellDataStructureHandler</a> <a id="46b34f1962a8dd5f" href="../../../R/46b34f1962a8dd5f.html" target="n" data-glyph="74,1" class="i method">GetAssociatedPowerShellDataStructureHandler</a>
            (<span class="i">Guid</span> <span id="r29 rd" class="r29 r">clientPowerShellId</span>)
        {
            <a href="#21dc790594e0a9f8" class="t t">ServerPowerShellDataStructureHandler</a> <span id="r30 rd" class="r30 r">dsHandler</span> = <b>null</b>;
 
            <b>lock</b> (<a href="#e9cea004f0a8fbaa" class="i field">_associationSyncObject</a>)
            {
                <b>bool</b> <span id="r31 rd" class="r31 r">success</span> = <a href="#d1d162d93684a28a" class="i field">_associatedShells</a>.<span class="i">TryGetValue</span>(<span class="r29 r">clientPowerShellId</span>, <b>out</b> <span class="r30 r">dsHandler</span>);
 
                <b>if</b> (!<span class="r31 r">success</span>)
                {
                    <span class="r30 r">dsHandler</span> = <b>null</b>;
                }
            }
 
            <b>return</b> <span class="r30 r">dsHandler</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Remove the association of the powershell from the runspace pool.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r32 r">sender</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Sender of this event.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r33 r">e</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Unused.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>private void</b> <a id="a8cc950f5f8718d0" href="../../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">HandleRemoveAssociation</a>(<b>object</b> <span id="r32 rd" class="r32 r">sender</span>, <span class="i">EventArgs</span> <span id="r33 rd" class="r33 r">e</span>)
        {
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r32 r">sender</span> <b>is</b> <a href="#21dc790594e0a9f8" class="t t">ServerPowerShellDataStructureHandler</a>, <span class="s">@&quot;sender of the event
                must be ServerPowerShellDataStructureHandler&quot;</span>);
 
            <a href="#21dc790594e0a9f8" class="t t">ServerPowerShellDataStructureHandler</a> <span id="r34 rd" class="r34 r">dsHandler</span> = <span class="r32 r">sender</span> <b>as</b> <a href="#21dc790594e0a9f8" class="t t">ServerPowerShellDataStructureHandler</a>;
 
            <b>lock</b> (<a href="#e9cea004f0a8fbaa" class="i field">_associationSyncObject</a>)
            {
                <a href="#d1d162d93684a28a" class="i field">_associatedShells</a>.<span class="i">Remove</span>(<span class="r34 r">dsHandler</span>.<a href="#7fe3b81af8a909ca" class="i property">PowerShellId</a>);
            }
 
            <span class="c">// let session transport manager remove its association of command transport manager.</span>
            <a href="#f71d849d27fad741" class="i field">_transportManager</a>.<a href="../fanin/BaseTransportManager.cs.html#ead93e5ba7011758" class="i method">RemoveCommandTransportManager</a>(<span class="r34 r">dsHandler</span>.<a href="#7fe3b81af8a909ca" class="i property">PowerShellId</a>);
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Private Methods
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Private Members
 
        <b>private readonly</b> <span class="i">Guid</span> <a id="0573dee38b1833bb" href="../../../R/0573dee38b1833bb.html" target="n" data-glyph="46,1" class="i field">_clientRunspacePoolId</a>;
        <span class="c">// transport manager using which this</span>
        <span class="c">// runspace pool driver handles all client</span>
        <span class="c">// communication</span>
        <b>private readonly</b> <a href="../fanin/BaseTransportManager.cs.html#18630eb940dac0a0" class="t t">AbstractServerSessionTransportManager</a> <a id="f71d849d27fad741" href="../../../R/f71d849d27fad741.html" target="n" data-glyph="46,1" class="i field">_transportManager</a>;
 
        <b>private readonly</b> <span class="i">Dictionary</span>&lt;<span class="i">Guid</span>, <a href="#21dc790594e0a9f8" class="t t">ServerPowerShellDataStructureHandler</a>&gt; <a id="d1d162d93684a28a" href="../../../R/d1d162d93684a28a.html" target="n" data-glyph="46,1" class="i field">_associatedShells</a>
            = <b>new</b> <span class="i">Dictionary</span>&lt;<span class="i">Guid</span>, <a href="#21dc790594e0a9f8" class="t t">ServerPowerShellDataStructureHandler</a>&gt;();
 
        <span class="c">// powershell data structure handlers associated with this</span>
        <span class="c">// runspace pool data structure handler</span>
        <b>private readonly object</b> <a id="e9cea004f0a8fbaa" href="../../../R/e9cea004f0a8fbaa.html" target="n" data-glyph="46,1" class="i field">_associationSyncObject</a> = <b>new</b> <b>object</b>();
        <span class="c">// object to synchronize operations to above</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Private Members
    }
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Handles all PowerShell data structure handler communication</span>
    <span class="c">///</span><span class="c"> with the client side PowerShell.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>internal class</b> <a id="21dc790594e0a9f8" href="../../../R/21dc790594e0a9f8.html" target="n" data-glyph="2,0" class="t t">ServerPowerShellDataStructureHandler</a>
    {
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Private Members
        <span class="c">// transport manager using which this</span>
        <span class="c">// powershell driver handles all client</span>
        <span class="c">// communication</span>
        <b>private readonly</b> <a href="../fanin/BaseTransportManager.cs.html#3beeadac29de3a80" class="t t">AbstractServerTransportManager</a> <a id="05b007617d300c7f" href="../../../R/05b007617d300c7f.html" target="n" data-glyph="46,1" class="i field">_transportManager</a>;
        <b>private readonly</b> <span class="i">Guid</span> <a id="991efc4681ed13ba" href="../../../R/991efc4681ed13ba.html" target="n" data-glyph="46,1" class="i field">_clientRunspacePoolId</a>;
        <b>private readonly</b> <span class="i">Guid</span> <a id="043ea7e6bfd146a2" href="../../../R/043ea7e6bfd146a2.html" target="n" data-glyph="46,1" class="i field">_clientPowerShellId</a>;
        <b>private readonly</b> <a href="../../hostifaces/PowerShell.cs.html#3a466dc47c692c8e" class="t t">RemoteStreamOptions</a> <a id="b11be9459937c1dd" href="../../../R/b11be9459937c1dd.html" target="n" data-glyph="46,1" class="i field">_streamSerializationOptions</a>;
        <b>private</b> <a href="../../hostifaces/Connection.cs.html#7e5b8eab1aa16fd7" class="t t">Runspace</a> <a id="99dbbe425f9747f3" href="../../../R/99dbbe425f9747f3.html" target="n" data-glyph="46,1" class="i field">_rsUsedToInvokePowerShell</a>;
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Private Members
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Constructors
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Default constructor for creating ServerPowerShellDataStructureHandler</span>
        <span class="c">///</span><span class="c"> instance.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r35 r">instanceId</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Powershell instance id.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r36 r">runspacePoolId</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Runspace pool id.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r37 r">remoteStreamOptions</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Remote stream options.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r38 r">transportManager</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Transport manager.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r39 r">localPowerShell</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Local powershell object.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal</b> <a id="9ae5b86dae57516a" href="../../../R/9ae5b86dae57516a.html" target="n" data-glyph="74,1" class="t constructor">ServerPowerShellDataStructureHandler</a>(<span class="i">Guid</span> <span id="r35 rd" class="r35 r">instanceId</span>, <span class="i">Guid</span> <span id="r36 rd" class="r36 r">runspacePoolId</span>, <a href="../../hostifaces/PowerShell.cs.html#3a466dc47c692c8e" class="t t">RemoteStreamOptions</a> <span id="r37 rd" class="r37 r">remoteStreamOptions</span>,
            <a href="../fanin/BaseTransportManager.cs.html#3beeadac29de3a80" class="t t">AbstractServerTransportManager</a> <span id="r38 rd" class="r38 r">transportManager</span>, <a href="../../hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShell</a> <span id="r39 rd" class="r39 r">localPowerShell</span>)
        {
            <a href="#043ea7e6bfd146a2" class="i field">_clientPowerShellId</a> = <span class="r35 r">instanceId</span>;
            <a href="#991efc4681ed13ba" class="i field">_clientRunspacePoolId</a> = <span class="r36 r">runspacePoolId</span>;
            <a href="#05b007617d300c7f" class="i field">_transportManager</a> = <span class="r38 r">transportManager</span>;
            <a href="#b11be9459937c1dd" class="i field">_streamSerializationOptions</a> = <span class="r37 r">remoteStreamOptions</span>;
            <span class="r38 r">transportManager</span>.<a href="../fanin/BaseTransportManager.cs.html#2fd00aae4537bede" class="i">Closing</a> += <span class="i">HandleTransportClosing</span>;
 
            <b>if</b> (<span class="r39 r">localPowerShell</span> != <b>null</b>)
            {
                <span class="r39 r">localPowerShell</span>.<a href="../../hostifaces/PowerShell.cs.html#e97b43f065651a57" class="i">RunspaceAssigned</a> += <span class="i">LocalPowerShell_RunspaceAssigned</span>;
            }
        }
 
        <b>private void</b> <a id="c63d2be4ed4f505d" href="../../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">LocalPowerShell_RunspaceAssigned</a>(<b>object</b> <span id="r40 rd" class="r40 r">sender</span>, <a href="../../EventManager.cs.html#03e55926b6f7cfe0" class="t t">PSEventArgs</a>&lt;<a href="../../hostifaces/Connection.cs.html#7e5b8eab1aa16fd7" class="t t">Runspace</a>&gt; <span id="r41 rd" class="r41 r">e</span>)
        {
            <a href="#99dbbe425f9747f3" class="i field">_rsUsedToInvokePowerShell</a> = <span class="r41 r">e</span>.<a href="../../EventManager.cs.html#cdbb095803b6c0a4" class="i field">Args</a>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Constructors
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Data Structure Handler Methods
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Prepare transport manager to send data to client.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="8c0131b96308481c" href="../../../R/8c0131b96308481c.html" target="n" data-glyph="74,1" class="i method">Prepare</a>()
        {
            <span class="c">// When Guid.Empty is used, PowerShell must be using pool&#39;s transport manager</span>
            <span class="c">// to send data to client. so we dont need to prepare command transport manager</span>
            <b>if</b> (<a href="#043ea7e6bfd146a2" class="i field">_clientPowerShellId</a> != <span class="i">Guid</span>.<span class="i">Empty</span>)
            {
                <a href="#05b007617d300c7f" class="i field">_transportManager</a>.<a href="../fanin/BaseTransportManager.cs.html#800a08f5b7eaeef4" class="i method">Prepare</a>();
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Send the state information to the client.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r42 r">stateInfo</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">state information to be</span>
        <span class="c">///</span><span class="c"> sent to the client</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="46f1edf9010fb3d7" href="../../../R/46f1edf9010fb3d7.html" target="n" data-glyph="74,1" class="i method">SendStateChangedInformationToClient</a>(<a href="../../hostifaces/PowerShell.cs.html#42e325836d1ae967" class="t t">PSInvocationStateInfo</a>
            <span id="r42 rd" class="r42 r">stateInfo</span>)
        {
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>((<span class="r42 r">stateInfo</span>.<a href="../../hostifaces/PowerShell.cs.html#7a70ff5163d0f044" class="i property">State</a> == <a href="../../hostifaces/PowerShell.cs.html#24cc37ccdc118b7a" class="t t">PSInvocationState</a>.<a href="../../hostifaces/PowerShell.cs.html#89ec15a2a933a2b6" class="i field">Completed</a>) ||
                       (<span class="r42 r">stateInfo</span>.<a href="../../hostifaces/PowerShell.cs.html#7a70ff5163d0f044" class="i property">State</a> == <a href="../../hostifaces/PowerShell.cs.html#24cc37ccdc118b7a" class="t t">PSInvocationState</a>.<a href="../../hostifaces/PowerShell.cs.html#35065a8449cad351" class="i field">Failed</a>) ||
                       (<span class="r42 r">stateInfo</span>.<a href="../../hostifaces/PowerShell.cs.html#7a70ff5163d0f044" class="i property">State</a> == <a href="../../hostifaces/PowerShell.cs.html#24cc37ccdc118b7a" class="t t">PSInvocationState</a>.<a href="../../hostifaces/PowerShell.cs.html#6a6866e7df063875" class="i field">Stopped</a>),
                       <span class="s">&quot;SendStateChangedInformationToClient should be called to notify a termination state&quot;</span>);
            <a href="#28f17c55bbc91893" class="i method">SendDataAsync</a>(<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#88b19073d823ce05" class="t t">RemotingEncoder</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#fa3bc030b5f82cf1" class="i method">GeneratePowerShellStateInfo</a>(
                <span class="r42 r">stateInfo</span>, <a href="#043ea7e6bfd146a2" class="i field">_clientPowerShellId</a>, <a href="#991efc4681ed13ba" class="i field">_clientRunspacePoolId</a>));
 
            <span class="c">// Close the transport manager only if the PowerShell Guid != Guid.Empty.</span>
            <span class="c">// When Guid.Empty is used, PowerShell must be using pool&#39;s transport manager</span>
            <span class="c">// to send data to client.</span>
            <b>if</b> (<a href="#043ea7e6bfd146a2" class="i field">_clientPowerShellId</a> != <span class="i">Guid</span>.<span class="i">Empty</span>)
            {
                <span class="c">// no need to listen for closing events as we are initiating the close</span>
                <a href="#05b007617d300c7f" class="i field">_transportManager</a>.<a href="../fanin/BaseTransportManager.cs.html#2fd00aae4537bede" class="i">Closing</a> -= <span class="i">HandleTransportClosing</span>;
                <span class="c">// if terminal state is reached close the transport manager instead of letting</span>
                <span class="c">// the client initiate the close.</span>
                <a href="#05b007617d300c7f" class="i field">_transportManager</a>.<a href="../fanin/BaseTransportManager.cs.html#394a627c71edfcbe" class="i method">Close</a>(<b>null</b>);
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Send the output data to the client.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r43 r">data</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Data to send.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="70ae6724d0f4c16b" href="../../../R/70ae6724d0f4c16b.html" target="n" data-glyph="74,1" class="i method">SendOutputDataToClient</a>(<a href="../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r43 rd" class="r43 r">data</span>)
        {
            <a href="#28f17c55bbc91893" class="i method">SendDataAsync</a>(<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#88b19073d823ce05" class="t t">RemotingEncoder</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#b2103be7ea06d0f5" class="i method">GeneratePowerShellOutput</a>(<span class="r43 r">data</span>,
                <a href="#043ea7e6bfd146a2" class="i field">_clientPowerShellId</a>, <a href="#991efc4681ed13ba" class="i field">_clientRunspacePoolId</a>));
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Send the error record to client.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r44 r">errorRecord</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Error record to send.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="004da7550b9cbc80" href="../../../R/004da7550b9cbc80.html" target="n" data-glyph="74,1" class="i method">SendErrorRecordToClient</a>(<a href="../../ErrorPackage.cs.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r44 rd" class="r44 r">errorRecord</span>)
        {
            <span class="r44 r">errorRecord</span>.<a href="../../ErrorPackage.cs.html#b342040c9a68cad7" class="i property">SerializeExtendedInfo</a> = (<a href="#b11be9459937c1dd" class="i field">_streamSerializationOptions</a> &amp; <a href="../../hostifaces/PowerShell.cs.html#3a466dc47c692c8e" class="t t">RemoteStreamOptions</a>.<a href="../../hostifaces/PowerShell.cs.html#3c8f9d90815b10d6" class="i field">AddInvocationInfoToErrorRecord</a>) != 0;
 
            <a href="#28f17c55bbc91893" class="i method">SendDataAsync</a>(<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#88b19073d823ce05" class="t t">RemotingEncoder</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#a5be10c18434836f" class="i method">GeneratePowerShellError</a>(
                <span class="r44 r">errorRecord</span>, <a href="#991efc4681ed13ba" class="i field">_clientRunspacePoolId</a>, <a href="#043ea7e6bfd146a2" class="i field">_clientPowerShellId</a>));
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Send the specified warning record to client.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r45 r">record</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Warning record.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="a72d8b6e35f7ed34" href="../../../R/a72d8b6e35f7ed34.html" target="n" data-glyph="74,1" class="i method">SendWarningRecordToClient</a>(<a href="../../hostifaces/InformationalRecord.cs.html#59cd69dde48b9557" class="t t">WarningRecord</a> <span id="r45 rd" class="r45 r">record</span>)
        {
            <span class="r45 r">record</span>.<a href="../../hostifaces/InformationalRecord.cs.html#a6ea6c97d8408487" class="i property">SerializeExtendedInfo</a> = (<a href="#b11be9459937c1dd" class="i field">_streamSerializationOptions</a> &amp; <a href="../../hostifaces/PowerShell.cs.html#3a466dc47c692c8e" class="t t">RemoteStreamOptions</a>.<a href="../../hostifaces/PowerShell.cs.html#6ca41fa7db493957" class="i field">AddInvocationInfoToWarningRecord</a>) != 0;
 
            <a href="#28f17c55bbc91893" class="i method">SendDataAsync</a>(<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#88b19073d823ce05" class="t t">RemotingEncoder</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#e2974ac650b955ff" class="i method">GeneratePowerShellInformational</a>(
                <span class="r45 r">record</span>, <a href="#991efc4681ed13ba" class="i field">_clientRunspacePoolId</a>, <a href="#043ea7e6bfd146a2" class="i field">_clientPowerShellId</a>, <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#296cbb5be87abd08" class="t t">RemotingDataType</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#df7036213bef9576" class="i field">PowerShellWarning</a>));
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Send the specified debug record to client.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r46 r">record</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Debug record.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="0e39ffca7145c068" href="../../../R/0e39ffca7145c068.html" target="n" data-glyph="74,1" class="i method">SendDebugRecordToClient</a>(<a href="../../hostifaces/InformationalRecord.cs.html#8954d4e40287d3de" class="t t">DebugRecord</a> <span id="r46 rd" class="r46 r">record</span>)
        {
            <span class="r46 r">record</span>.<a href="../../hostifaces/InformationalRecord.cs.html#a6ea6c97d8408487" class="i property">SerializeExtendedInfo</a> = (<a href="#b11be9459937c1dd" class="i field">_streamSerializationOptions</a> &amp; <a href="../../hostifaces/PowerShell.cs.html#3a466dc47c692c8e" class="t t">RemoteStreamOptions</a>.<a href="../../hostifaces/PowerShell.cs.html#a7f1a5d0154feae0" class="i field">AddInvocationInfoToDebugRecord</a>) != 0;
 
            <a href="#28f17c55bbc91893" class="i method">SendDataAsync</a>(<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#88b19073d823ce05" class="t t">RemotingEncoder</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#e2974ac650b955ff" class="i method">GeneratePowerShellInformational</a>(
                <span class="r46 r">record</span>, <a href="#991efc4681ed13ba" class="i field">_clientRunspacePoolId</a>, <a href="#043ea7e6bfd146a2" class="i field">_clientPowerShellId</a>, <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#296cbb5be87abd08" class="t t">RemotingDataType</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#9305a742d83a6da8" class="i field">PowerShellDebug</a>));
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Send the specified verbose record to client.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r47 r">record</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Warning record.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="90af8e2a21b9a42d" href="../../../R/90af8e2a21b9a42d.html" target="n" data-glyph="74,1" class="i method">SendVerboseRecordToClient</a>(<a href="../../hostifaces/InformationalRecord.cs.html#5d56339940b0040b" class="t t">VerboseRecord</a> <span id="r47 rd" class="r47 r">record</span>)
        {
            <span class="r47 r">record</span>.<a href="../../hostifaces/InformationalRecord.cs.html#a6ea6c97d8408487" class="i property">SerializeExtendedInfo</a> = (<a href="#b11be9459937c1dd" class="i field">_streamSerializationOptions</a> &amp; <a href="../../hostifaces/PowerShell.cs.html#3a466dc47c692c8e" class="t t">RemoteStreamOptions</a>.<a href="../../hostifaces/PowerShell.cs.html#8322dcc5699dda06" class="i field">AddInvocationInfoToVerboseRecord</a>) != 0;
 
            <a href="#28f17c55bbc91893" class="i method">SendDataAsync</a>(<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#88b19073d823ce05" class="t t">RemotingEncoder</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#e2974ac650b955ff" class="i method">GeneratePowerShellInformational</a>(
                <span class="r47 r">record</span>, <a href="#991efc4681ed13ba" class="i field">_clientRunspacePoolId</a>, <a href="#043ea7e6bfd146a2" class="i field">_clientPowerShellId</a>, <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#296cbb5be87abd08" class="t t">RemotingDataType</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#1036eaaa6058e728" class="i field">PowerShellVerbose</a>));
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Send the specified progress record to client.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r48 r">record</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Progress record.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="74acd3b5ad20dd74" href="../../../R/74acd3b5ad20dd74.html" target="n" data-glyph="74,1" class="i method">SendProgressRecordToClient</a>(<a href="../../ProgressRecord.cs.html#d79b27687c6ed8c8" class="t t">ProgressRecord</a> <span id="r48 rd" class="r48 r">record</span>)
        {
            <a href="#28f17c55bbc91893" class="i method">SendDataAsync</a>(<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#88b19073d823ce05" class="t t">RemotingEncoder</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#5b4db63f3e48d17e" class="i method">GeneratePowerShellInformational</a>(
                <span class="r48 r">record</span>, <a href="#991efc4681ed13ba" class="i field">_clientRunspacePoolId</a>, <a href="#043ea7e6bfd146a2" class="i field">_clientPowerShellId</a>));
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Send the specified information record to client.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r49 r">record</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Information record.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="01a4fb787a592907" href="../../../R/01a4fb787a592907.html" target="n" data-glyph="74,1" class="i method">SendInformationRecordToClient</a>(<a href="../../InformationRecord.cs.html#508a9dbac37ec093" class="t t">InformationRecord</a> <span id="r49 rd" class="r49 r">record</span>)
        {
            <a href="#28f17c55bbc91893" class="i method">SendDataAsync</a>(<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#88b19073d823ce05" class="t t">RemotingEncoder</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#2d621139116d4b5d" class="i method">GeneratePowerShellInformational</a>(
                <span class="r49 r">record</span>, <a href="#991efc4681ed13ba" class="i field">_clientRunspacePoolId</a>, <a href="#043ea7e6bfd146a2" class="i field">_clientPowerShellId</a>));
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Called when session is connected from a new client</span>
        <span class="c">///</span><span class="c"> calls into observers of this event.</span>
        <span class="c">///</span><span class="c"> observers include corresponding driver that shutdown</span>
        <span class="c">///</span><span class="c"> input stream is present.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="c2542d918621dd77" href="../../../R/../../0000000000.html" target="n" data-glyph="74,1" class="i method">ProcessConnect</a>()
        {
            <a href="#6a03b726ee82cc8b" class="i">OnSessionConnected</a>.<span class="i">SafeInvoke</span>(<a href="#21dc790594e0a9f8" class="k">this</a>, <span class="i">EventArgs</span>.<span class="i">Empty</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Process the data received from the powershell on</span>
        <span class="c">///</span><span class="c"> the client.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r50 r">receivedData</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Data received.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="57f5c4e1e6a9e855" href="../../../R/57f5c4e1e6a9e855.html" target="n" data-glyph="74,1" class="i method">ProcessReceivedData</a>(<a href="../common/WireDataFormat/RemotingDataObject.cs.html#ca4629603c976aab" class="t t">RemoteDataObject</a>&lt;<a href="../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt; <span id="r50 rd" class="r50 r">receivedData</span>)
        {
            <b>if</b> (<span class="r50 r">receivedData</span> == <b>null</b>)
            {
                <b>throw</b> <a href="../../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../../../utils/MshTraceSource.cs.html#fbe67220ad7522a0" class="i method">NewArgumentNullException</a>(<b>nameof</b>(<span class="r50 r">receivedData</span>));
            }
 
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r50 r">receivedData</span>.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#6975a2b0635b9f80" class="i property">TargetInterface</a> == <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#1d73dff2a8d6a0bf" class="t t">RemotingTargetInterface</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#f4078f88b2ce5495" class="i field">PowerShell</a>,
                <span class="s">&quot;RemotingTargetInterface must be PowerShell&quot;</span>);
 
            <b>switch</b> (<span class="r50 r">receivedData</span>.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#97d7621b092d013f" class="i property">DataType</a>)
            {
                <b>case</b> <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#296cbb5be87abd08" class="t t">RemotingDataType</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#0ad4d2a13292e39f" class="i field">StopPowerShell</a>:
                    {
                        <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<a href="#9035f98228459fbf" class="i">StopPowerShellReceived</a> != <b>null</b>,
                            <span class="s">&quot;ServerPowerShellDriver should subscribe to all data structure handler events&quot;</span>);
                        <a href="#9035f98228459fbf" class="i">StopPowerShellReceived</a>.<span class="i">SafeInvoke</span>(<a href="#21dc790594e0a9f8" class="k">this</a>, <span class="i">EventArgs</span>.<span class="i">Empty</span>);
                    }
 
                    <b>break</b>;
 
                <b>case</b> <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#296cbb5be87abd08" class="t t">RemotingDataType</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#1c6bd042904ee46b" class="i field">PowerShellInput</a>:
                    {
                        <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<a href="#ccb6a545458d9971" class="i">InputReceived</a> != <b>null</b>,
                            <span class="s">&quot;ServerPowerShellDriver should subscribe to all data structure handler events&quot;</span>);
                        <a href="#ccb6a545458d9971" class="i">InputReceived</a>.<span class="i">SafeInvoke</span>(<a href="#21dc790594e0a9f8" class="k">this</a>, <b>new</b> <a href="../common/misc.cs.html#79fd22f37cbd3e2d" class="t constructor">RemoteDataEventArgs</a>&lt;<b>object</b>&gt;(<span class="r50 r">receivedData</span>.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#d13e5d3038741f3e" class="i property">Data</a>));
                    }
 
                    <b>break</b>;
 
                <b>case</b> <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#296cbb5be87abd08" class="t t">RemotingDataType</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#313b6d1d71e0521b" class="i field">PowerShellInputEnd</a>:
                    {
                        <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<a href="#26bf08683394fb4f" class="i">InputEndReceived</a> != <b>null</b>,
                            <span class="s">&quot;ServerPowerShellDriver should subscribe to all data structure handler events&quot;</span>);
                        <a href="#26bf08683394fb4f" class="i">InputEndReceived</a>.<span class="i">SafeInvoke</span>(<a href="#21dc790594e0a9f8" class="k">this</a>, <span class="i">EventArgs</span>.<span class="i">Empty</span>);
                    }
 
                    <b>break</b>;
 
                <b>case</b> <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#296cbb5be87abd08" class="t t">RemotingDataType</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#54fb34cf1704608e" class="i field">RemotePowerShellHostResponseData</a>:
                    {
                        <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<a href="#7610139ddbd61e24" class="i">HostResponseReceived</a> != <b>null</b>,
                            <span class="s">&quot;ServerPowerShellDriver should subscribe to all data structure handler events&quot;</span>);
 
                        <a href="../common/WireDataFormat/RemoteHost.cs.html#2088d050a88e3ac6" class="t t">RemoteHostResponse</a> <span id="r51 rd" class="r51 r">remoteHostResponse</span> = <a href="../common/WireDataFormat/RemoteHost.cs.html#2088d050a88e3ac6" class="t t">RemoteHostResponse</a>.<a href="../common/WireDataFormat/RemoteHost.cs.html#bb70fcce88a4188e" class="i method">Decode</a>(<span class="r50 r">receivedData</span>.<a href="../common/WireDataFormat/RemotingDataObject.cs.html#d13e5d3038741f3e" class="i property">Data</a>);
 
                        <span class="c">// part of host message robustness algo. Now the host response is back, report to transport that</span>
                        <span class="c">// execution status is back to running</span>
                        <a href="#05b007617d300c7f" class="i field">_transportManager</a>.<a href="../fanin/BaseTransportManager.cs.html#6cbb8114566035b4" class="i method">ReportExecutionStatusAsRunning</a>();
 
                        <a href="#7610139ddbd61e24" class="i">HostResponseReceived</a>.<span class="i">SafeInvoke</span>(<a href="#21dc790594e0a9f8" class="k">this</a>, <b>new</b> <a href="../common/misc.cs.html#79fd22f37cbd3e2d" class="t constructor">RemoteDataEventArgs</a>&lt;<a href="../common/WireDataFormat/RemoteHost.cs.html#2088d050a88e3ac6" class="t t">RemoteHostResponse</a>&gt;(<span class="r51 r">remoteHostResponse</span>));
                    }
 
                    <b>break</b>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Raise a remove association event. This is raised</span>
        <span class="c">///</span><span class="c"> when the powershell has gone into a terminal state</span>
        <span class="c">///</span><span class="c"> and the runspace pool need not maintain any further</span>
        <span class="c">///</span><span class="c"> associations.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="e1015deefedc6893" href="../../../R/e1015deefedc6893.html" target="n" data-glyph="74,1" class="i method">RaiseRemoveAssociationEvent</a>()
        {
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<a href="#82b3dfa73d39cbba" class="i">RemoveAssociation</a> != <b>null</b>, <span class="s">@&quot;The ServerRunspacePoolDataStructureHandler should subscribe
                to the RemoveAssociation event of ServerPowerShellDataStructureHandler&quot;</span>);
            <a href="#82b3dfa73d39cbba" class="i">RemoveAssociation</a>.<span class="i">SafeInvoke</span>(<a href="#21dc790594e0a9f8" class="k">this</a>, <span class="i">EventArgs</span>.<span class="i">Empty</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Creates a ServerRemoteHost which is associated with this powershell.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r52 r">powerShellHostInfo</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Host information about the host associated</span>
        <span class="c">///</span><span class="c"> PowerShell object on the client.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r53 r">runspaceServerRemoteHost</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Host associated with the RunspacePool</span>
        <span class="c">///</span><span class="c"> on the server.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">A new ServerRemoteHost for the PowerShell.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal</b> <a href="ServerRemoteHost.cs.html#ecbb655f955c09fc" class="t t">ServerRemoteHost</a> <a id="8fcc1adbca1c758a" href="../../../R/8fcc1adbca1c758a.html" target="n" data-glyph="74,1" class="i method">GetHostAssociatedWithPowerShell</a>(
            <a href="../common/WireDataFormat/RemoteSessionCapability.cs.html#4fc7c4b336de518c" class="t t">HostInfo</a> <span id="r52 rd" class="r52 r">powerShellHostInfo</span>,
            <a href="ServerRemoteHost.cs.html#ecbb655f955c09fc" class="t t">ServerRemoteHost</a> <span id="r53 rd" class="r53 r">runspaceServerRemoteHost</span>)
        {
            <a href="../common/WireDataFormat/RemoteSessionCapability.cs.html#4fc7c4b336de518c" class="t t">HostInfo</a> <span id="r54 rd" class="r54 r">hostInfo</span>;
 
            <span class="c">// If host was null use the runspace&#39;s host for this powershell; otherwise,</span>
            <span class="c">// use the HostInfo to create a proxy host of the powershell&#39;s host.</span>
            <b>if</b> (<span class="r52 r">powerShellHostInfo</span>.<a href="../common/WireDataFormat/RemoteSessionCapability.cs.html#ccba904c55d54568" class="i property">UseRunspaceHost</a>)
            {
                <span class="r54 r">hostInfo</span> = <span class="r53 r">runspaceServerRemoteHost</span>.<a href="ServerRemoteHost.cs.html#a0dd7cdadaf12138" class="i property">HostInfo</a>;
            }
            <b>else</b>
            {
                <span class="r54 r">hostInfo</span> = <span class="r52 r">powerShellHostInfo</span>;
            }
 
            <span class="c">// If the host was not null on the client, then the PowerShell object should</span>
            <span class="c">// get a brand spanking new host.</span>
            <b>return</b> <b>new</b> <a href="ServerRemoteHost.cs.html#a8d2f018c8225ed5" class="t constructor">ServerRemoteHost</a>(<a href="#991efc4681ed13ba" class="i field">_clientRunspacePoolId</a>, <a href="#043ea7e6bfd146a2" class="i field">_clientPowerShellId</a>, <span class="r54 r">hostInfo</span>,
                <a href="#05b007617d300c7f" class="i field">_transportManager</a>, <span class="r53 r">runspaceServerRemoteHost</span>.<a href="ServerRemoteHost.cs.html#a181afe04897bdb3" class="i property">Runspace</a>, <span class="r53 r">runspaceServerRemoteHost</span> <b>as</b> <a href="ServerRemoteHost.cs.html#1186c46a3c18ebd3" class="t t">ServerDriverRemoteHost</a>);
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Data Structure Handler Methods
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Data Structure Handler events
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This event is raised when the state of associated</span>
        <span class="c">///</span><span class="c"> powershell is terminal and the runspace pool has</span>
        <span class="c">///</span><span class="c"> to detach the association.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal event</b> <span class="i">EventHandler</span> <a id="82b3dfa73d39cbba" href="../../../R/82b3dfa73d39cbba.html" target="n" data-glyph="32,1" class="i">RemoveAssociation</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This event is raised when the a message to stop the</span>
        <span class="c">///</span><span class="c"> powershell is received from the client.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal event</b> <span class="i">EventHandler</span> <a id="9035f98228459fbf" href="../../../R/9035f98228459fbf.html" target="n" data-glyph="32,1" class="i">StopPowerShellReceived</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This event is raised when an input object is received</span>
        <span class="c">///</span><span class="c"> from the client.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal event</b> <span class="i">EventHandler</span>&lt;<a href="../common/misc.cs.html#16d1e16a7ed9f8cc" class="t t">RemoteDataEventArgs</a>&lt;<b>object</b>&gt;&gt; <a id="ccb6a545458d9971" href="../../../R/ccb6a545458d9971.html" target="n" data-glyph="32,1" class="i">InputReceived</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This event is raised when end of input is received from</span>
        <span class="c">///</span><span class="c"> the client.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal event</b> <span class="i">EventHandler</span> <a id="26bf08683394fb4f" href="../../../R/26bf08683394fb4f.html" target="n" data-glyph="32,1" class="i">InputEndReceived</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Raised when server session is connected from a new client.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal event</b> <span class="i">EventHandler</span> <a id="6a03b726ee82cc8b" href="../../../R/6a03b726ee82cc8b.html" target="n" data-glyph="32,1" class="i">OnSessionConnected</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This event is raised when a host response is received.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal event</b> <span class="i">EventHandler</span>&lt;<a href="../common/misc.cs.html#16d1e16a7ed9f8cc" class="t t">RemoteDataEventArgs</a>&lt;<a href="../common/WireDataFormat/RemoteHost.cs.html#2088d050a88e3ac6" class="t t">RemoteHostResponse</a>&gt;&gt; <a id="7610139ddbd61e24" href="../../../R/7610139ddbd61e24.html" target="n" data-glyph="32,1" class="i">HostResponseReceived</a>;
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Data Structure Handler events
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Internal Methods
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Client powershell id.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal</b> <span class="i">Guid</span> <a id="7fe3b81af8a909ca" href="../../../R/7fe3b81af8a909ca.html" target="n" data-glyph="104,1" class="i property">PowerShellId</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#043ea7e6bfd146a2" class="i field">_clientPowerShellId</a>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Runspace used to invoke PowerShell, this is used by the steppable</span>
        <span class="c">///</span><span class="c"> pipeline driver.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal</b> <a href="../../hostifaces/Connection.cs.html#7e5b8eab1aa16fd7" class="t t">Runspace</a> <a id="5398b179efa4b91f" href="../../../R/5398b179efa4b91f.html" target="n" data-glyph="104,1" class="i property">RunspaceUsedToInvokePowerShell</a>
        {
            <b>get</b> { <b>return</b> <a href="#99dbbe425f9747f3" class="i field">_rsUsedToInvokePowerShell</a>; }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Internal Methods
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Private Methods
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Send the data specified as a RemoteDataObject asynchronously</span>
        <span class="c">///</span><span class="c"> to the runspace pool on the remote session.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r55 r">data</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Data to send.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span><span class="c">This overload takes a RemoteDataObject and should</span>
        <span class="c">///</span><span class="c"> be the one thats used to send data from within this</span>
        <span class="c">///</span><span class="c"> data structure handler class</span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>private void</b> <a id="28f17c55bbc91893" href="../../../R/28f17c55bbc91893.html" target="n" data-glyph="76,1" class="i method">SendDataAsync</a>(<a href="../common/WireDataFormat/RemotingDataObject.cs.html#3856dcbea775cab8" class="t t">RemoteDataObject</a> <span id="r55 rd" class="r55 r">data</span>)
        {
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r55 r">data</span> != <b>null</b>, <span class="s">&quot;Cannot send null object.&quot;</span>);
            <span class="c">// this is from a command execution..let transport manager collect</span>
            <span class="c">// as much data as possible and send bigger buffer to client.</span>
            <a href="#05b007617d300c7f" class="i field">_transportManager</a>.<a href="../fanin/BaseTransportManager.cs.html#49ea489c355e3169" class="i method">SendDataToClient</a>(<span class="r55 r">data</span>, <b>false</b>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Handle transport manager&#39;s closing event.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r56 r">sender</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r57 r">args</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>private void</b> <a id="da17e67ad72ac0bd" href="../../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">HandleTransportClosing</a>(<b>object</b> <span id="r56 rd" class="r56 r">sender</span>, <span class="i">EventArgs</span> <span id="r57 rd" class="r57 r">args</span>)
        {
            <a href="#9035f98228459fbf" class="i">StopPowerShellReceived</a>.<a href="../../../utils/ExtensionMethods.cs.html#79207b44c90e7eac" class="i method">SafeInvoke</a>(<a href="#21dc790594e0a9f8" class="k">this</a>, <span class="r57 r">args</span>);
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Private Methods
    }
}
</pre></td></tr></table></div></body></html>
