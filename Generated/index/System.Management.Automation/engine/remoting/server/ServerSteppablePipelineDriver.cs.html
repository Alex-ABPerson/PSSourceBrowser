<!DOCTYPE html>
<html><head><title>ServerSteppablePipelineDriver.cs</title><link rel="stylesheet" href="../../../../styles.css"><script src="../../../../scripts.js"></script></head>
<body class="cB" onload="i(493);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#System.Management.Automation/engine/remoting/server/ServerSteppablePipelineDriver.cs" target="_top">engine\remoting\server\ServerSteppablePipelineDriver.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#System.Management.Automation" target="_top">src\System.Management.Automation\System.Management.Automation.csproj</a> (System.Management.Automation)</td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation.</span>
<span class="c">// Licensed under the MIT License.</span>
 
<b>using</b> <span class="i n">System</span>.<span class="i">Collections</span>.<span class="i">Generic</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Host</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Remoting</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Runspaces</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Threading</span>;
 
<b>using</b> <span class="t">Dbg</span> = <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Diagnostics</a>;
 
<b>namespace</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>
{
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Execution context used for stepping.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>internal sealed class</b> <a id="b87dd8a65cc08068" href="../../../R/b87dd8a65cc08068.html" target="n" data-glyph="2,0" class="t t">ExecutionContextForStepping</a> : <span class="i">IDisposable</span>
    {
        <b>private readonly</b> <a href="../../ExecutionContext.cs.html#130bda5418e8559c" class="t t">ExecutionContext</a> <a id="ce052fade07a24f0" href="../../../R/ce052fade07a24f0.html" target="n" data-glyph="46,1" class="i field">_executionContext</a>;
        <b>private</b> <a href="../../hostifaces/PSDataCollection.cs.html#b80567add938623b" class="t t">PSInformationalBuffers</a> <a id="4780a5df79768f37" href="../../../R/4780a5df79768f37.html" target="n" data-glyph="46,1" class="i field">_originalInformationalBuffers</a>;
        <b>private</b> <a href="../../hostifaces/MshHost.cs.html#7b79cd90e035740e" class="t t">PSHost</a> <a id="c8aa30ef89ea2589" href="../../../R/c8aa30ef89ea2589.html" target="n" data-glyph="46,1" class="i field">_originalHost</a>;
 
        <b>private</b> <a id="4269213ff96a90cf" href="../../../R/4269213ff96a90cf.html" target="n" data-glyph="76,1" class="t constructor">ExecutionContextForStepping</a>(<a href="../../ExecutionContext.cs.html#130bda5418e8559c" class="t t">ExecutionContext</a> <span id="r0 rd" class="r0 r">ctxt</span>)
        {
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r0 r">ctxt</span> != <b>null</b>, <span class="s">&quot;ExecutionContext cannot be null.&quot;</span>);
            <a href="#ce052fade07a24f0" class="i field">_executionContext</a> = <span class="r0 r">ctxt</span>;
        }
 
        <b>internal static</b> <a href="#b87dd8a65cc08068" class="t t">ExecutionContextForStepping</a> <a id="c607815d4f3fd0dd" href="../../../R/c607815d4f3fd0dd.html" target="n" data-glyph="74,1" class="i method">PrepareExecutionContext</a>(
            <a href="../../ExecutionContext.cs.html#130bda5418e8559c" class="t t">ExecutionContext</a> <span id="r1 rd" class="r1 r">ctxt</span>,
            <a href="../../hostifaces/PSDataCollection.cs.html#b80567add938623b" class="t t">PSInformationalBuffers</a> <span id="r2 rd" class="r2 r">newBuffers</span>,
            <a href="../../hostifaces/MshHost.cs.html#7b79cd90e035740e" class="t t">PSHost</a> <span id="r3 rd" class="r3 r">newHost</span>)
        {
            <a href="#b87dd8a65cc08068" class="t t">ExecutionContextForStepping</a> <span id="r4 rd" class="r4 r">result</span> = <b>new</b> <a href="#4269213ff96a90cf" class="t constructor">ExecutionContextForStepping</a>(<span class="r1 r">ctxt</span>);
 
            <span class="r4 r">result</span>.<a href="#4780a5df79768f37" class="i field">_originalInformationalBuffers</a>
                = <span class="r1 r">ctxt</span>.<a href="../../ExecutionContext.cs.html#ad328d08127401c1" class="i property">InternalHost</a>.<a href="../../hostifaces/InternalHost.cs.html#1bea3254cf92b0e3" class="i property">InternalUI</a>.<a href="../../hostifaces/InternalHostUserInterface.cs.html#a989da37fda41ae7" class="i method">GetInformationalMessageBuffers</a>();
            <span class="r4 r">result</span>.<a href="#c8aa30ef89ea2589" class="i field">_originalHost</a> = <span class="r1 r">ctxt</span>.<a href="../../ExecutionContext.cs.html#ad328d08127401c1" class="i property">InternalHost</a>.<a href="../../hostifaces/InternalHost.cs.html#f25431d0ab961179" class="i property">ExternalHost</a>;
 
            <span class="r1 r">ctxt</span>.<a href="../../ExecutionContext.cs.html#ad328d08127401c1" class="i property">InternalHost</a>.<a href="../../hostifaces/InternalHost.cs.html#1bea3254cf92b0e3" class="i property">InternalUI</a>.<a href="../../hostifaces/InternalHostUserInterface.cs.html#7afcd7a731c61c23" class="i method">SetInformationalMessageBuffers</a>(<span class="r2 r">newBuffers</span>);
            <span class="r1 r">ctxt</span>.<a href="../../ExecutionContext.cs.html#ad328d08127401c1" class="i property">InternalHost</a>.<a href="../../hostifaces/InternalHost.cs.html#537447f36276d774" class="i method">SetHostRef</a>(<span class="r3 r">newHost</span>);
 
            <b>return</b> <span class="r4 r">result</span>;
        }
 
        <span class="c">// Summary:</span>
        <span class="c">//     Performs application-defined tasks associated with freeing, releasing, or</span>
        <span class="c">//     resetting unmanaged resources.</span>
        <b>void</b> <span class="i">IDisposable</span>.<a id="48c159977f8bdaa1" href="../../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">Dispose</a>()
        {
            <a href="#ce052fade07a24f0" class="i field">_executionContext</a>.<a href="../../ExecutionContext.cs.html#ad328d08127401c1" class="i property">InternalHost</a>.<a href="../../hostifaces/InternalHost.cs.html#1bea3254cf92b0e3" class="i property">InternalUI</a>.<a href="../../hostifaces/InternalHostUserInterface.cs.html#7afcd7a731c61c23" class="i method">SetInformationalMessageBuffers</a>(<a href="#4780a5df79768f37" class="i field">_originalInformationalBuffers</a>);
            <a href="#ce052fade07a24f0" class="i field">_executionContext</a>.<a href="../../ExecutionContext.cs.html#ad328d08127401c1" class="i property">InternalHost</a>.<a href="../../hostifaces/InternalHost.cs.html#537447f36276d774" class="i method">SetHostRef</a>(<a href="#c8aa30ef89ea2589" class="i field">_originalHost</a>);
            <span class="i">GC</span>.<span class="i">SuppressFinalize</span>(<a href="#b87dd8a65cc08068" class="k">this</a>);
        }
    }
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> This class wraps a RunspacePoolInternal object. It is used to function</span>
    <span class="c">///</span><span class="c"> as a server side runspacepool.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>internal class</b> <a id="44f68fc925ad7af2" href="../../../R/44f68fc925ad7af2.html" target="n" data-glyph="2,0" class="t t">ServerSteppablePipelineDriver</a>
    {
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Private Data
 
        <span class="c">// that is associated with this</span>
        <span class="c">// powershell driver</span>
        <span class="c">// associated with this powershell</span>
        <span class="c">// data structure handler object to handle all</span>
        <span class="c">// communications with the client</span>
        <span class="c">// private bool datasent = false;          // if the remaining data has been sent</span>
        <span class="c">// to the client before sending state</span>
        <span class="c">// information</span>
        <span class="c">// data to client</span>
        <span class="c">// was created</span>
        <b>private readonly bool</b> <a id="242d71561a9cbf90" href="../../../R/242d71561a9cbf90.html" target="n" data-glyph="46,1" class="i field">_addToHistory</a>;
        <span class="c">// associated with this powershell</span>
        <b>private readonly</b> <span class="i">ApartmentState</span> <a id="ca5bbeaf72c8679f" href="../../../R/ca5bbeaf72c8679f.html" target="n" data-glyph="46,1" class="i field">apartmentState</a>;  <span class="c">// apartment state for this powershell</span>
 
        <span class="c">// pipeline that runs the actual command.</span>
        <b>private readonly</b> <a href="ServerSteppablePipelineSubscriber.cs.html#8acd85db57a60851" class="t t">ServerSteppablePipelineSubscriber</a> <a id="89c26a36219ab752" href="../../../R/89c26a36219ab752.html" target="n" data-glyph="46,1" class="i field">_eventSubscriber</a>;
        <b>private readonly</b> <a href="../../hostifaces/PSDataCollection.cs.html#52e2b209c10ec0a4" class="t t">PSDataCollection</a>&lt;<b>object</b>&gt; <a id="55ec833985f84b8e" href="../../../R/55ec833985f84b8e.html" target="n" data-glyph="46,1" class="i field">_powershellInput</a>; <span class="c">// input collection of the PowerShell pipeline</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Default constructor for creating ServerSteppablePipelineDriver...Used by server to concurrently</span>
        <span class="c">///</span><span class="c"> run 2 pipelines.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r5 r">powershell</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Decoded powershell object.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r6 r">noInput</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Whether there is input for this powershell.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r7 r">clientPowerShellId</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The client powershell id.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r8 r">clientRunspacePoolId</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The client runspacepool id.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r9 r">runspacePoolDriver</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">runspace pool driver</span>
        <span class="c">///</span><span class="c"> which is creating this powershell driver</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r10 r">apartmentState</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Apartment state for this powershell.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r11 r">hostInfo</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">host info using which the host for</span>
        <span class="c">///</span><span class="c"> this powershell will be constructed</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r12 r">streamOptions</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Serialization options for the streams in this powershell.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r13 r">addToHistory</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> true if the command is to be added to history list of the runspace. false, otherwise.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r14 r">rsToUse</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If not null, this Runspace will be used to invoke Powershell.</span>
        <span class="c">///</span><span class="c"> If null, the RunspacePool pointed by </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r9 r">runspacePoolDriver</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> will be used.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r15 r">eventSubscriber</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Steppable pipeline event subscriber</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r16 r">powershellInput</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Input collection of the PowerShell pipeline.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal</b> <a id="34d873e79c72d1a7" href="../../../R/34d873e79c72d1a7.html" target="n" data-glyph="74,1" class="t constructor">ServerSteppablePipelineDriver</a>(<a href="../../hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShell</a> <span id="r5 rd" class="r5 r">powershell</span>, <b>bool</b> <span id="r6 rd" class="r6 r">noInput</span>, <span class="i">Guid</span> <span id="r7 rd" class="r7 r">clientPowerShellId</span>,
            <span class="i">Guid</span> <span id="r8 rd" class="r8 r">clientRunspacePoolId</span>, <a href="ServerRunspacePoolDriver.cs.html#a13c57c874abb0c5" class="t t">ServerRunspacePoolDriver</a> <span id="r9 rd" class="r9 r">runspacePoolDriver</span>,
            <span class="i">ApartmentState</span> <span id="r10 rd" class="r10 r">apartmentState</span>, <a href="../common/WireDataFormat/RemoteSessionCapability.cs.html#4fc7c4b336de518c" class="t t">HostInfo</a> <span id="r11 rd" class="r11 r">hostInfo</span>, <a href="../../hostifaces/PowerShell.cs.html#3a466dc47c692c8e" class="t t">RemoteStreamOptions</a> <span id="r12 rd" class="r12 r">streamOptions</span>,
            <b>bool</b> <span id="r13 rd" class="r13 r">addToHistory</span>, <a href="../../hostifaces/Connection.cs.html#7e5b8eab1aa16fd7" class="t t">Runspace</a> <span id="r14 rd" class="r14 r">rsToUse</span>, <a href="ServerSteppablePipelineSubscriber.cs.html#8acd85db57a60851" class="t t">ServerSteppablePipelineSubscriber</a> <span id="r15 rd" class="r15 r">eventSubscriber</span>, <a href="../../hostifaces/PSDataCollection.cs.html#52e2b209c10ec0a4" class="t t">PSDataCollection</a>&lt;<b>object</b>&gt; <span id="r16 rd" class="r16 r">powershellInput</span>)
        {
            <a href="#46f341f9797a7dd2" class="i property">LocalPowerShell</a> = <span class="r5 r">powershell</span>;
            <a href="#8778592ceb7ba036" class="i property">InstanceId</a> = <span class="r7 r">clientPowerShellId</span>;
            <a href="#78e18e8c0c0732c3" class="i property">RunspacePoolId</a> = <span class="r8 r">clientRunspacePoolId</span>;
            <a href="#f352a3e8d3b3734e" class="i property">RemoteStreamOptions</a> = <span class="r12 r">streamOptions</span>;
            <a href="#44f68fc925ad7af2" class="k">this</a>.<a href="#ca5bbeaf72c8679f" class="i field">apartmentState</a> = <span class="r10 r">apartmentState</span>;
            <a href="#0a51b7e4ac29fd79" class="i property">NoInput</a> = <span class="r6 r">noInput</span>;
            <a href="#242d71561a9cbf90" class="i field">_addToHistory</a> = <span class="r13 r">addToHistory</span>;
            <a href="#89c26a36219ab752" class="i field">_eventSubscriber</a> = <span class="r15 r">eventSubscriber</span>;
            <a href="#55ec833985f84b8e" class="i field">_powershellInput</a> = <span class="r16 r">powershellInput</span>;
 
            <a href="#74a0258b95e5e4e1" class="i property">Input</a> = <b>new</b> <a href="../../hostifaces/PSDataCollection.cs.html#ee85ce3306fe4e5b" class="t constructor">PSDataCollection</a>&lt;<b>object</b>&gt;();
            <a href="#43538d18a7e32f41" class="i property">InputEnumerator</a> = <a href="#74a0258b95e5e4e1" class="i property">Input</a>.<a href="../../hostifaces/PSDataCollection.cs.html#fa82432985fff86c" class="i method">GetEnumerator</a>();
            <a href="#74a0258b95e5e4e1" class="i property">Input</a>.<a href="../../hostifaces/PSDataCollection.cs.html#964a56f986986159" class="i property">ReleaseOnEnumeration</a> = <b>true</b>;
 
            <a href="#d50fde69ca93612a" class="i property">DataStructureHandler</a> = <span class="r9 r">runspacePoolDriver</span>.<a href="ServerRunspacePoolDriver.cs.html#8c8ba41ef94b9086" class="i property">DataStructureHandler</a>.<a href="ServerRemotingProtocol2.cs.html#bcac18c640e1f5d6" class="i method">CreatePowerShellDataStructureHandler</a>(<span class="r7 r">clientPowerShellId</span>, <span class="r8 r">clientRunspacePoolId</span>, <a href="#f352a3e8d3b3734e" class="i property">RemoteStreamOptions</a>, <b>null</b>);
            <a href="#6ba28533bc39e9ca" class="i property">RemoteHost</a> = <a href="#d50fde69ca93612a" class="i property">DataStructureHandler</a>.<a href="ServerRemotingProtocol2.cs.html#8fcc1adbca1c758a" class="i method">GetHostAssociatedWithPowerShell</a>(<span class="r11 r">hostInfo</span>, <span class="r9 r">runspacePoolDriver</span>.<a href="ServerRunspacePoolDriver.cs.html#4549b5f9b57aa1af" class="i property">ServerRemoteHost</a>);
 
            <span class="c">// subscribe to various data structure handler events</span>
            <a href="#d50fde69ca93612a" class="i property">DataStructureHandler</a>.<a href="ServerRemotingProtocol2.cs.html#26bf08683394fb4f" class="i">InputEndReceived</a> += <span class="i">HandleInputEndReceived</span>;
            <a href="#d50fde69ca93612a" class="i property">DataStructureHandler</a>.<a href="ServerRemotingProtocol2.cs.html#ccb6a545458d9971" class="i">InputReceived</a> += <span class="i">HandleInputReceived</span>;
            <a href="#d50fde69ca93612a" class="i property">DataStructureHandler</a>.<a href="ServerRemotingProtocol2.cs.html#9035f98228459fbf" class="i">StopPowerShellReceived</a> += <span class="i">HandleStopReceived</span>;
            <a href="#d50fde69ca93612a" class="i property">DataStructureHandler</a>.<a href="ServerRemotingProtocol2.cs.html#7610139ddbd61e24" class="i">HostResponseReceived</a> += <span class="i">HandleHostResponseReceived</span>;
            <a href="#d50fde69ca93612a" class="i property">DataStructureHandler</a>.<a href="ServerRemotingProtocol2.cs.html#6a03b726ee82cc8b" class="i">OnSessionConnected</a> += <span class="i">HandleSessionConnected</span>;
 
            <b>if</b> (<span class="r14 r">rsToUse</span> == <b>null</b>)
            {
                <b>throw</b> <a href="../../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<span class="i">NewInvalidOperationException</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">NestedPipelineMissingRunspace</span>);
            }
 
            <span class="c">// else, set the runspace pool and invoke this powershell</span>
            <a href="#46f341f9797a7dd2" class="i property">LocalPowerShell</a>.<a href="../../hostifaces/PowerShell.cs.html#ccf57242c9d46642" class="i property">Runspace</a> = <span class="r14 r">rsToUse</span>;
            <span class="r15 r">eventSubscriber</span>.<a href="ServerSteppablePipelineSubscriber.cs.html#0441d5a9bfc41c7c" class="i method">SubscribeEvents</a>(<a href="#44f68fc925ad7af2" class="k">this</a>);
 
            <a href="#1af5666fcc6431e0" class="i property">PipelineState</a> = <a href="../../hostifaces/PowerShell.cs.html#24cc37ccdc118b7a" class="t t">PSInvocationState</a>.<a href="../../hostifaces/PowerShell.cs.html#3eb81f39bc769d16" class="i field">NotStarted</a>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Internal Methods
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Local PowerShell instance.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal</b> <a href="../../hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShell</a> <a id="46f341f9797a7dd2" href="../../../R/46f341f9797a7dd2.html" target="n" data-glyph="104,1" class="i property">LocalPowerShell</a> { <b>get</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Instance id by which this powershell driver is</span>
        <span class="c">///</span><span class="c"> identified. This is the same as the id of the</span>
        <span class="c">///</span><span class="c"> powershell on the client side.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal</b> <span class="i">Guid</span> <a id="8778592ceb7ba036" href="../../../R/8778592ceb7ba036.html" target="n" data-glyph="104,1" class="i property">InstanceId</a> { <b>get</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Server remote host.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal</b> <a href="ServerRemoteHost.cs.html#ecbb655f955c09fc" class="t t">ServerRemoteHost</a> <a id="6ba28533bc39e9ca" href="../../../R/6ba28533bc39e9ca.html" target="n" data-glyph="104,1" class="i property">RemoteHost</a> { <b>get</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Serialization options for the streams in this powershell.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal</b> <a href="../../hostifaces/PowerShell.cs.html#3a466dc47c692c8e" class="t t">RemoteStreamOptions</a> <a id="f352a3e8d3b3734e" href="../../../R/f352a3e8d3b3734e.html" target="n" data-glyph="104,1" class="i property">RemoteStreamOptions</a> { <b>get</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Id of the runspace pool driver which created</span>
        <span class="c">///</span><span class="c"> this object. This is the same as the id of</span>
        <span class="c">///</span><span class="c"> the runspace pool at the client side which</span>
        <span class="c">///</span><span class="c"> is associated with the powershell on the</span>
        <span class="c">///</span><span class="c"> client side.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal</b> <span class="i">Guid</span> <a id="78e18e8c0c0732c3" href="../../../R/78e18e8c0c0732c3.html" target="n" data-glyph="104,1" class="i property">RunspacePoolId</a> { <b>get</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> ServerPowerShellDataStructureHandler associated with this</span>
        <span class="c">///</span><span class="c"> powershell driver.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal</b> <a href="ServerRemotingProtocol2.cs.html#21dc790594e0a9f8" class="t t">ServerPowerShellDataStructureHandler</a> <a id="d50fde69ca93612a" href="../../../R/d50fde69ca93612a.html" target="n" data-glyph="104,1" class="i property">DataStructureHandler</a> { <b>get</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Pipeline invocation state.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal</b> <a href="../../hostifaces/PowerShell.cs.html#24cc37ccdc118b7a" class="t t">PSInvocationState</a> <a id="1af5666fcc6431e0" href="../../../R/1af5666fcc6431e0.html" target="n" data-glyph="104,1" class="i property">PipelineState</a> { <b>get</b>; <b>private set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Checks if the steppable pipeline has input.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal bool</b> <a id="0a51b7e4ac29fd79" href="../../../R/0a51b7e4ac29fd79.html" target="n" data-glyph="104,1" class="i property">NoInput</a> { <b>get</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Steppablepipeline object.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal</b> <a href="../../lang/scriptblock.cs.html#5e20a8a88cfbe6cb" class="t t">SteppablePipeline</a> <a id="0057f606ad984234" href="../../../R/0057f606ad984234.html" target="n" data-glyph="104,1" class="i property">SteppablePipeline</a> { <b>get</b>; <b>set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Synchronization object.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal object</b> <a id="ffe6c0bd982dea75" href="../../../R/ffe6c0bd982dea75.html" target="n" data-glyph="104,1" class="i property">SyncObject</a> { <b>get</b>; } = <b>new</b> <b>object</b>();
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Processing input.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal bool</b> <a id="2675ebc6dc245a7c" href="../../../R/2675ebc6dc245a7c.html" target="n" data-glyph="104,1" class="i property">ProcessingInput</a> { <b>get</b>; <b>set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Input enumerator.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal</b> <span class="i">IEnumerator</span>&lt;<b>object</b>&gt; <a id="43538d18a7e32f41" href="../../../R/43538d18a7e32f41.html" target="n" data-glyph="104,1" class="i property">InputEnumerator</a> { <b>get</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Input collection.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal</b> <a href="../../hostifaces/PSDataCollection.cs.html#52e2b209c10ec0a4" class="t t">PSDataCollection</a>&lt;<b>object</b>&gt; <a id="74a0258b95e5e4e1" href="../../../R/74a0258b95e5e4e1.html" target="n" data-glyph="104,1" class="i property">Input</a> { <b>get</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Is the pipeline pulsed.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal bool</b> <a id="7fd56a7f7bd5fd84" href="../../../R/7fd56a7f7bd5fd84.html" target="n" data-glyph="104,1" class="i property">Pulsed</a> { <b>get</b>; <b>set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Total objects processed.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal int</b> <a id="a08846543890b0bc" href="../../../R/a08846543890b0bc.html" target="n" data-glyph="104,1" class="i property">TotalObjectsProcessed</a> { <b>get</b>; <b>set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Starts the exectution.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="15567f44900bdcdc" href="../../../R/15567f44900bdcdc.html" target="n" data-glyph="74,1" class="i method">Start</a>()
        {
            <a href="#1af5666fcc6431e0" class="i property">PipelineState</a> = <a href="../../hostifaces/PowerShell.cs.html#24cc37ccdc118b7a" class="t t">PSInvocationState</a>.<a href="../../hostifaces/PowerShell.cs.html#7142407e9e49cf13" class="i field">Running</a>;
 
            <a href="#89c26a36219ab752" class="i field">_eventSubscriber</a>.<a href="ServerSteppablePipelineSubscriber.cs.html#4553e29c0a178e49" class="i method">FireStartSteppablePipeline</a>(<a href="#44f68fc925ad7af2" class="k">this</a>);
 
            <b>if</b> (<a href="#55ec833985f84b8e" class="i field">_powershellInput</a> != <b>null</b>)
            {
                <a href="#55ec833985f84b8e" class="i field">_powershellInput</a>.<a href="../../hostifaces/PSDataCollection.cs.html#06dc3c236b950394" class="i method">Pulse</a>();
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Internal Methods
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> DataStructure related event handling / processing
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Close the input collection of the local powershell.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r17 r">sender</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Sender of this event, unused.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r18 r">eventArgs</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Arguments describing this event.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="34367fe774e33ef8" href="../../../R/../../0000000000.html" target="n" data-glyph="74,1" class="i method">HandleInputEndReceived</a>(<b>object</b> <span id="r17 rd" class="r17 r">sender</span>, <span class="i">EventArgs</span> <span id="r18 rd" class="r18 r">eventArgs</span>)
        {
            <a href="#74a0258b95e5e4e1" class="i property">Input</a>.<a href="../../hostifaces/PSDataCollection.cs.html#0a8262d798e33fc6" class="i method">Complete</a>();
 
            <a href="#d1b0e6f683cc9dfd" class="i method">CheckAndPulseForProcessing</a>(<b>true</b>);
 
            <b>if</b> (<a href="#55ec833985f84b8e" class="i field">_powershellInput</a> != <b>null</b>)
            {
                <a href="#55ec833985f84b8e" class="i field">_powershellInput</a>.<a href="../../hostifaces/PSDataCollection.cs.html#06dc3c236b950394" class="i method">Pulse</a>();
            }
        }
 
        <b>private void</b> <a id="a2cca63f07067324" href="../../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">HandleSessionConnected</a>(<b>object</b> <span id="r19 rd" class="r19 r">sender</span>, <span class="i">EventArgs</span> <span id="r20 rd" class="r20 r">eventArgs</span>)
        {
            <span class="c">// Close input if its active. no need to synchronize as input stream would have already been processed</span>
            <span class="c">// when connect call came into PS plugin</span>
            <b>if</b> (<a href="#74a0258b95e5e4e1" class="i property">Input</a> != <b>null</b>)
            {
                <a href="#74a0258b95e5e4e1" class="i property">Input</a>.<a href="../../hostifaces/PSDataCollection.cs.html#0a8262d798e33fc6" class="i method">Complete</a>();
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Handle a host message response received.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r21 r">sender</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Sender of this event, unused.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r22 r">eventArgs</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Arguments describing this event.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="1c231c34fe0d8103" href="../../../R/../../0000000000.html" target="n" data-glyph="74,1" class="i method">HandleHostResponseReceived</a>(<b>object</b> <span id="r21 rd" class="r21 r">sender</span>, <a href="../common/misc.cs.html#16d1e16a7ed9f8cc" class="t t">RemoteDataEventArgs</a>&lt;<a href="../common/WireDataFormat/RemoteHost.cs.html#2088d050a88e3ac6" class="t t">RemoteHostResponse</a>&gt; <span id="r22 rd" class="r22 r">eventArgs</span>)
        {
            <a href="#6ba28533bc39e9ca" class="i property">RemoteHost</a>.<a href="ServerRemoteHost.cs.html#f7e839b2399b6cb0" class="i property">ServerMethodExecutor</a>.<a href="ServerMethodExecutor.cs.html#826b0e13ea0c9e9d" class="i method">HandleRemoteHostResponseFromClient</a>(<span class="r22 r">eventArgs</span>.<a href="../common/misc.cs.html#0896dbbd394ce2e6" class="i property">Data</a>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Stop the local powershell.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r23 r">sender</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Sender of this event, unused.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r24 r">eventArgs</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Unused.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>private void</b> <a id="5e7cb874bd91cea4" href="../../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">HandleStopReceived</a>(<b>object</b> <span id="r23 rd" class="r23 r">sender</span>, <span class="i">EventArgs</span> <span id="r24 rd" class="r24 r">eventArgs</span>)
        {
            <b>lock</b> (<a href="#ffe6c0bd982dea75" class="i property">SyncObject</a>)
            {
                <a href="#1af5666fcc6431e0" class="i property">PipelineState</a> = <a href="../../hostifaces/PowerShell.cs.html#24cc37ccdc118b7a" class="t t">PSInvocationState</a>.<a href="../../hostifaces/PowerShell.cs.html#a9d235bf0dc5bfce" class="i field">Stopping</a>;
            }
 
            <a href="#694552a95856097c" class="i method">PerformStop</a>();
 
            <b>if</b> (<a href="#55ec833985f84b8e" class="i field">_powershellInput</a> != <b>null</b>)
            {
                <a href="#55ec833985f84b8e" class="i field">_powershellInput</a>.<a href="../../hostifaces/PSDataCollection.cs.html#06dc3c236b950394" class="i method">Pulse</a>();
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Add input to the local powershell&#39;s input collection.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r25 r">sender</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Sender of this event, unused.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r26 r">eventArgs</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Arguments describing this event.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>private void</b> <a id="5083f1394a305aa9" href="../../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">HandleInputReceived</a>(<b>object</b> <span id="r25 rd" class="r25 r">sender</span>, <a href="../common/misc.cs.html#16d1e16a7ed9f8cc" class="t t">RemoteDataEventArgs</a>&lt;<b>object</b>&gt; <span id="r26 rd" class="r26 r">eventArgs</span>)
        {
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<span class="i">Assert</span>(!<a href="#0a51b7e4ac29fd79" class="i property">NoInput</a>, <span class="s">&quot;Input data should not be received for powershells created with no input&quot;</span>);
 
            <b>if</b> (<a href="#74a0258b95e5e4e1" class="i property">Input</a> != <b>null</b>)
            {
                <b>lock</b> (<a href="#ffe6c0bd982dea75" class="i property">SyncObject</a>)
                {
                    <a href="#74a0258b95e5e4e1" class="i property">Input</a>.<a href="../../hostifaces/PSDataCollection.cs.html#681501d1e27b76df" class="i method">Add</a>(<span class="r26 r">eventArgs</span>.<a href="../common/misc.cs.html#0896dbbd394ce2e6" class="i property">Data</a>);
                }
 
                <a href="#d1b0e6f683cc9dfd" class="i method">CheckAndPulseForProcessing</a>(<b>false</b>);
 
                <b>if</b> (<a href="#55ec833985f84b8e" class="i field">_powershellInput</a> != <b>null</b>)
                {
                    <a href="#55ec833985f84b8e" class="i field">_powershellInput</a>.<a href="../../hostifaces/PSDataCollection.cs.html#06dc3c236b950394" class="i method">Pulse</a>();
                }
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Checks if there is any pending input that needs processing. If so, triggers RunProcessRecord</span>
        <span class="c">///</span><span class="c"> event. The pipeline execution thread catches this and calls us back when the pipeline is</span>
        <span class="c">///</span><span class="c"> suspended.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r27 r">complete</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="d1b0e6f683cc9dfd" href="../../../R/d1b0e6f683cc9dfd.html" target="n" data-glyph="74,1" class="i method">CheckAndPulseForProcessing</a>(<b>bool</b> <span id="r27 rd" class="r27 r">complete</span>)
        {
            <b>if</b> (<span class="r27 r">complete</span>)
            {
                <a href="#89c26a36219ab752" class="i field">_eventSubscriber</a>.<a href="ServerSteppablePipelineSubscriber.cs.html#3f759ac95a2b2120" class="i method">FireHandleProcessRecord</a>(<a href="#44f68fc925ad7af2" class="k">this</a>);
            }
            <b>else</b> <b>if</b> (!<a href="#7fd56a7f7bd5fd84" class="i property">Pulsed</a>)
            {
                <b>bool</b> <span id="r28 rd" class="r28 r">shouldPulse</span> = <b>false</b>;
                <b>lock</b> (<a href="#ffe6c0bd982dea75" class="i property">SyncObject</a>)
                {
                    <b>if</b> (<a href="#7fd56a7f7bd5fd84" class="i property">Pulsed</a>)
                    {
                        <b>return</b>;
                    }
 
                    <b>if</b> (!<a href="#2675ebc6dc245a7c" class="i property">ProcessingInput</a> &amp;&amp; ((<a href="#74a0258b95e5e4e1" class="i property">Input</a>.<a href="../../hostifaces/PSDataCollection.cs.html#e7cb43bbebbb4aca" class="i property">Count</a> &gt; <a href="#a08846543890b0bc" class="i property">TotalObjectsProcessed</a>)))
                    {
                        <span class="r28 r">shouldPulse</span> = <b>true</b>;
                        <a href="#7fd56a7f7bd5fd84" class="i property">Pulsed</a> = <b>true</b>;
                    }
                }
 
                <b>if</b> (<span class="r28 r">shouldPulse</span> &amp;&amp; (<a href="#1af5666fcc6431e0" class="i property">PipelineState</a> == <a href="../../hostifaces/PowerShell.cs.html#24cc37ccdc118b7a" class="t t">PSInvocationState</a>.<a href="../../hostifaces/PowerShell.cs.html#7142407e9e49cf13" class="i field">Running</a>))
                {
                    <a href="#89c26a36219ab752" class="i field">_eventSubscriber</a>.<a href="ServerSteppablePipelineSubscriber.cs.html#3f759ac95a2b2120" class="i method">FireHandleProcessRecord</a>(<a href="#44f68fc925ad7af2" class="k">this</a>);
                }
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Performs the stop operation.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="694552a95856097c" href="../../../R/694552a95856097c.html" target="n" data-glyph="74,1" class="i method">PerformStop</a>()
        {
            <b>bool</b> <span id="r29 rd" class="r29 r">shouldPerformStop</span> = <b>false</b>;
            <b>lock</b> (<a href="#ffe6c0bd982dea75" class="i property">SyncObject</a>)
            {
                <b>if</b> (!<a href="#2675ebc6dc245a7c" class="i property">ProcessingInput</a> &amp;&amp; (<a href="#1af5666fcc6431e0" class="i property">PipelineState</a> == <a href="../../hostifaces/PowerShell.cs.html#24cc37ccdc118b7a" class="t t">PSInvocationState</a>.<a href="../../hostifaces/PowerShell.cs.html#a9d235bf0dc5bfce" class="i field">Stopping</a>))
                {
                    <span class="r29 r">shouldPerformStop</span> = <b>true</b>;
                }
            }
 
            <b>if</b> (<span class="r29 r">shouldPerformStop</span>)
            {
                <span class="i">SetState</span>(<a href="../../hostifaces/PowerShell.cs.html#24cc37ccdc118b7a" class="t t">PSInvocationState</a>.<a href="../../hostifaces/PowerShell.cs.html#6a6866e7df063875" class="i field">Stopped</a>, <b>new</b> <a href="../../../utils/ExecutionExceptions.cs.html#105b0214d3aab114" class="t constructor">PipelineStoppedException</a>());
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Changes state and sends message to the client as needed.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r30 r">newState</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r31 r">reason</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="352c90fa8a78cb5f" href="../../../R/352c90fa8a78cb5f.html" target="n" data-glyph="74,1" class="i method">SetState</a>(<a href="../../hostifaces/PowerShell.cs.html#24cc37ccdc118b7a" class="t t">PSInvocationState</a> <span id="r30 rd" class="r30 r">newState</span>, <span class="i">Exception</span> <span id="r31 rd" class="r31 r">reason</span>)
        {
            <a href="../../hostifaces/PowerShell.cs.html#24cc37ccdc118b7a" class="t t">PSInvocationState</a> <span id="r32 rd" class="r32 r">copyState</span> = <a href="../../hostifaces/PowerShell.cs.html#24cc37ccdc118b7a" class="t t">PSInvocationState</a>.<a href="../../hostifaces/PowerShell.cs.html#3eb81f39bc769d16" class="i field">NotStarted</a>;
            <b>bool</b> <span id="r33 rd" class="r33 r">shouldRaiseEvents</span> = <b>false</b>;
            <b>lock</b> (<a href="#ffe6c0bd982dea75" class="i property">SyncObject</a>)
            {
                <b>switch</b> (<a href="#1af5666fcc6431e0" class="i property">PipelineState</a>)
                {
                    <b>case</b> <a href="../../hostifaces/PowerShell.cs.html#24cc37ccdc118b7a" class="t t">PSInvocationState</a>.<a href="../../hostifaces/PowerShell.cs.html#3eb81f39bc769d16" class="i field">NotStarted</a>:
                        {
                            <b>switch</b> (<span class="r30 r">newState</span>)
                            {
                                <b>case</b> <a href="../../hostifaces/PowerShell.cs.html#24cc37ccdc118b7a" class="t t">PSInvocationState</a>.<a href="../../hostifaces/PowerShell.cs.html#7142407e9e49cf13" class="i field">Running</a>:
                                <b>case</b> <a href="../../hostifaces/PowerShell.cs.html#24cc37ccdc118b7a" class="t t">PSInvocationState</a>.<a href="../../hostifaces/PowerShell.cs.html#a9d235bf0dc5bfce" class="i field">Stopping</a>:
                                <b>case</b> <a href="../../hostifaces/PowerShell.cs.html#24cc37ccdc118b7a" class="t t">PSInvocationState</a>.<a href="../../hostifaces/PowerShell.cs.html#89ec15a2a933a2b6" class="i field">Completed</a>:
                                <b>case</b> <a href="../../hostifaces/PowerShell.cs.html#24cc37ccdc118b7a" class="t t">PSInvocationState</a>.<a href="../../hostifaces/PowerShell.cs.html#6a6866e7df063875" class="i field">Stopped</a>:
                                <b>case</b> <a href="../../hostifaces/PowerShell.cs.html#24cc37ccdc118b7a" class="t t">PSInvocationState</a>.<a href="../../hostifaces/PowerShell.cs.html#35065a8449cad351" class="i field">Failed</a>:
                                    <span class="r32 r">copyState</span> = <span class="r30 r">newState</span>;
                                    <span class="c">// NotStarted -&gt; Running..we dont send</span>
                                    <span class="c">// state back to client.</span>
                                    <b>break</b>;
                            }
                        }
 
                        <b>break</b>;
 
                    <b>case</b> <a href="../../hostifaces/PowerShell.cs.html#24cc37ccdc118b7a" class="t t">PSInvocationState</a>.<a href="../../hostifaces/PowerShell.cs.html#7142407e9e49cf13" class="i field">Running</a>:
                        {
                            <b>switch</b> (<span class="r30 r">newState</span>)
                            {
                                <b>case</b> <a href="../../hostifaces/PowerShell.cs.html#24cc37ccdc118b7a" class="t t">PSInvocationState</a>.<a href="../../hostifaces/PowerShell.cs.html#3eb81f39bc769d16" class="i field">NotStarted</a>:
                                    <b>throw</b> <b>new</b> <span class="i">InvalidOperationException</span>();
                                <b>case</b> <a href="../../hostifaces/PowerShell.cs.html#24cc37ccdc118b7a" class="t t">PSInvocationState</a>.<a href="../../hostifaces/PowerShell.cs.html#7142407e9e49cf13" class="i field">Running</a>:
                                    <b>break</b>;
                                <b>case</b> <a href="../../hostifaces/PowerShell.cs.html#24cc37ccdc118b7a" class="t t">PSInvocationState</a>.<a href="../../hostifaces/PowerShell.cs.html#a9d235bf0dc5bfce" class="i field">Stopping</a>:
                                    <span class="r32 r">copyState</span> = <span class="r30 r">newState</span>;
                                    <b>break</b>;
                                <b>case</b> <a href="../../hostifaces/PowerShell.cs.html#24cc37ccdc118b7a" class="t t">PSInvocationState</a>.<a href="../../hostifaces/PowerShell.cs.html#89ec15a2a933a2b6" class="i field">Completed</a>:
                                <b>case</b> <a href="../../hostifaces/PowerShell.cs.html#24cc37ccdc118b7a" class="t t">PSInvocationState</a>.<a href="../../hostifaces/PowerShell.cs.html#6a6866e7df063875" class="i field">Stopped</a>:
                                <b>case</b> <a href="../../hostifaces/PowerShell.cs.html#24cc37ccdc118b7a" class="t t">PSInvocationState</a>.<a href="../../hostifaces/PowerShell.cs.html#35065a8449cad351" class="i field">Failed</a>:
                                    <span class="r32 r">copyState</span> = <span class="r30 r">newState</span>;
                                    <span class="r33 r">shouldRaiseEvents</span> = <b>true</b>;
                                    <b>break</b>;
                            }
                        }
 
                        <b>break</b>;
 
                    <b>case</b> <a href="../../hostifaces/PowerShell.cs.html#24cc37ccdc118b7a" class="t t">PSInvocationState</a>.<a href="../../hostifaces/PowerShell.cs.html#a9d235bf0dc5bfce" class="i field">Stopping</a>:
                        {
                            <b>switch</b> (<span class="r30 r">newState</span>)
                            {
                                <b>case</b> <a href="../../hostifaces/PowerShell.cs.html#24cc37ccdc118b7a" class="t t">PSInvocationState</a>.<a href="../../hostifaces/PowerShell.cs.html#89ec15a2a933a2b6" class="i field">Completed</a>:
                                <b>case</b> <a href="../../hostifaces/PowerShell.cs.html#24cc37ccdc118b7a" class="t t">PSInvocationState</a>.<a href="../../hostifaces/PowerShell.cs.html#35065a8449cad351" class="i field">Failed</a>:
                                    <span class="r32 r">copyState</span> = <a href="../../hostifaces/PowerShell.cs.html#24cc37ccdc118b7a" class="t t">PSInvocationState</a>.<a href="../../hostifaces/PowerShell.cs.html#6a6866e7df063875" class="i field">Stopped</a>;
                                    <span class="r33 r">shouldRaiseEvents</span> = <b>true</b>;
                                    <b>break</b>;
                                <b>case</b> <a href="../../hostifaces/PowerShell.cs.html#24cc37ccdc118b7a" class="t t">PSInvocationState</a>.<a href="../../hostifaces/PowerShell.cs.html#6a6866e7df063875" class="i field">Stopped</a>:
                                    <span class="r32 r">copyState</span> = <span class="r30 r">newState</span>;
                                    <span class="r33 r">shouldRaiseEvents</span> = <b>true</b>;
                                    <b>break</b>;
                                <b>default</b>:
                                    <b>throw</b> <b>new</b> <span class="i">InvalidOperationException</span>();
                            }
                        }
 
                        <b>break</b>;
 
                    <b>case</b> <a href="../../hostifaces/PowerShell.cs.html#24cc37ccdc118b7a" class="t t">PSInvocationState</a>.<a href="../../hostifaces/PowerShell.cs.html#6a6866e7df063875" class="i field">Stopped</a>:
                    <b>case</b> <a href="../../hostifaces/PowerShell.cs.html#24cc37ccdc118b7a" class="t t">PSInvocationState</a>.<a href="../../hostifaces/PowerShell.cs.html#89ec15a2a933a2b6" class="i field">Completed</a>:
                    <b>case</b> <a href="../../hostifaces/PowerShell.cs.html#24cc37ccdc118b7a" class="t t">PSInvocationState</a>.<a href="../../hostifaces/PowerShell.cs.html#35065a8449cad351" class="i field">Failed</a>:
                        <b>break</b>;
                }
 
                <a href="#1af5666fcc6431e0" class="i property">PipelineState</a> = <span class="r32 r">copyState</span>;
            }
 
            <b>if</b> (<span class="r33 r">shouldRaiseEvents</span>)
            {
                <span class="c">// send the state change notification to the client</span>
                <a href="#d50fde69ca93612a" class="i property">DataStructureHandler</a>.<a href="ServerRemotingProtocol2.cs.html#46f1edf9010fb3d7" class="i method">SendStateChangedInformationToClient</a>(
                    <b>new</b> <a href="../../hostifaces/PowerShell.cs.html#db44bd87590c83f5" class="t constructor">PSInvocationStateInfo</a>(<span class="r32 r">copyState</span>, <span class="r31 r">reason</span>));
            }
 
            <b>if</b> (<a href="#1af5666fcc6431e0" class="i property">PipelineState</a> == <a href="../../hostifaces/PowerShell.cs.html#24cc37ccdc118b7a" class="t t">PSInvocationState</a>.<a href="../../hostifaces/PowerShell.cs.html#89ec15a2a933a2b6" class="i field">Completed</a>
                || <a href="#1af5666fcc6431e0" class="i property">PipelineState</a> == <a href="../../hostifaces/PowerShell.cs.html#24cc37ccdc118b7a" class="t t">PSInvocationState</a>.<a href="../../hostifaces/PowerShell.cs.html#6a6866e7df063875" class="i field">Stopped</a>
                || <a href="#1af5666fcc6431e0" class="i property">PipelineState</a> == <a href="../../hostifaces/PowerShell.cs.html#24cc37ccdc118b7a" class="t t">PSInvocationState</a>.<a href="../../hostifaces/PowerShell.cs.html#35065a8449cad351" class="i field">Failed</a>)
            {
                <span class="c">// Remove itself from the runspace pool</span>
                <a href="#d50fde69ca93612a" class="i property">DataStructureHandler</a>.<a href="ServerRemotingProtocol2.cs.html#e1015deefedc6893" class="i method">RaiseRemoveAssociationEvent</a>();
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
    }
}
</pre></td></tr></table></div></body></html>
