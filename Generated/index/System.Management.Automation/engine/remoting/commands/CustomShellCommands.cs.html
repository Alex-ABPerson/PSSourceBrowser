<!DOCTYPE html>
<html><head><title>CustomShellCommands.cs</title><link rel="stylesheet" href="../../../../styles.css"><script src="../../../../scripts.js"></script></head>
<body class="cB" onload="i(5365);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#System.Management.Automation/engine/remoting/commands/CustomShellCommands.cs" target="_top">engine\remoting\commands\CustomShellCommands.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#System.Management.Automation" target="_top">src\System.Management.Automation\System.Management.Automation.csproj</a> (System.Management.Automation)</td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation.</span>
<span class="c">// Licensed under the MIT License.</span>
 
<b>using</b> <span class="i n">System</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Collections</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Collections</span>.<span class="i">Generic</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Collections</span>.<span class="i">ObjectModel</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Globalization</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">IO</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Internal</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Language</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Remoting</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Runspaces</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Security</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Security</span>.<span class="i">AccessControl</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Security</span>.<span class="i">Principal</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Text</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Threading</span>;
<b>using</b> <span class="t">Dbg</span> = <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Diagnostics</a>;
<b>using</b> <span class="t">PowerShellApi</span> = <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="../../hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShell</a>;
<b>using</b> <span class="t">WSManNativeApi</span> = <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Remoting</span>.<span class="i n">Client</span>.<a href="../fanin/WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>;
 
<b>namespace</b> <span class="i n">Microsoft</span>.<span class="i n">PowerShell</span>.<span class="i n">Commands</span>
{
    <span class="k preprocess">#</span><span class="k preprocess">region</span> Register-PSSessionConfiguration cmdlet
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Class implementing Register-PSSessionConfiguration.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    [<span class="i">Cmdlet</span>(<a href="../../../utils/Verbs.cs.html#1a8e85c66f6fff18" class="t t">VerbsLifecycle</a>.<a href="../../../utils/Verbs.cs.html#9780417e452f3943" class="i field">Register</a>, <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#d19a1042a44001e8" class="t t">RemotingConstants</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#3188dd90ac4b908b" class="i field">PSSessionConfigurationNoun</a>,
        <span class="i">DefaultParameterSetName</span> = <a href="#fc12f22923e252d9" class="t t">PSSessionConfigurationCommandBase</a>.<a href="#567a3254f0a1b9e7" class="i field">NameParameterSetName</a>,
        <span class="i">SupportsShouldProcess</span> = <b>true</b>,
        <span class="i">ConfirmImpact</span> = <a href="../../CommandBase.cs.html#ba94675b57c6d6e9" class="t t">ConfirmImpact</a>.<a href="../../CommandBase.cs.html#f2126d83835863e8" class="i field">Medium</a>, <span class="i">HelpUri</span> = <span class="s">&quot;https://go.microsoft.com/fwlink/?LinkID=2096793&quot;</span>)]
    <b>public sealed class</b> <a id="091dc53780f2780a" href="../../../R/091dc53780f2780a.html" target="n" data-glyph="0,0" class="t t"><span id="5586a3a5b7ae9854">RegisterPSSessionConfigurationCommand</span></a> : <a href="#fc12f22923e252d9" class="t t">PSSessionConfigurationCommandBase</a>
    {
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Private Data
 
        <span class="c">// To Escape &quot; -- &quot;&quot;</span>
        <b>private const string</b> <a id="ccabd1c0ecf1f55e" href="../../../R/ccabd1c0ecf1f55e.html" target="n" data-glyph="10,1" class="i field">newPluginSbFormat</a> = <span class="s">@&quot;
function Register-PSSessionConfiguration
{{
    [CmdletBinding(SupportsShouldProcess=$true, ConfirmImpact=&quot;&quot;Medium&quot;&quot;)]
    param(
      [string] $filepath,
      [string] $pluginName,
      [bool] $shouldShowUI,
      [bool] $force,
      [string] $restartWSManTarget,
      [string] $restartWSManAction,
      [string] $restartWSManRequired,
      [string] $runAsUserName,
      [system.security.securestring] $runAsPassword,
      [System.Management.Automation.Runspaces.PSSessionConfigurationAccessMode] $accessMode,
      [bool] $isSddlSpecified,
      [string] $configTableSddl
    )
 
    begin
    {{
        ## Construct SID for network users
        [system.security.principal.wellknownsidtype]$evst = &quot;&quot;NetworkSid&quot;&quot;
        $networkSID = new-object system.security.principal.securityidentifier $evst,$null
 
        ## If all session configurations have Network Access disabled,
        ## then we create this endpoint as Local as well.
        $newSDDL = $null
        $foundRemoteEndpoint = $false;
        Get-PSSessionConfiguration -Force:$force | Foreach-Object {{
            if ($_.Enabled)
            {{
                $sddl = $null
                if ($_.psobject.members[&quot;&quot;SecurityDescriptorSddl&quot;&quot;])
                {{
                    $sddl = $_.psobject.members[&quot;&quot;SecurityDescriptorSddl&quot;&quot;].Value
                }}
 
                if($sddl)
                {{
                    # See if it has &#39;Disable Network Access&#39;
                    $sd = new-object system.security.accesscontrol.commonsecuritydescriptor $false,$false,$sddl
                    $disableNetworkExists = $false
                    $sd.DiscretionaryAcl | ForEach-Object {{
                        if (($_.acequalifier -eq &quot;&quot;accessdenied&quot;&quot;) -and ($_.securityidentifier -match $networkSID) -and ($_.AccessMask -eq 268435456))
                        {{
                            $disableNetworkExists = $true
                        }}
                    }}
 
                    if(-not $disableNetworkExists) {{ $foundRemoteEndpoint = $true }}
                }}
            }}
        }}
 
        if(-not $foundRemoteEndpoint)
        {{
            $newSDDL = &quot;&quot;{1}&quot;&quot;
        }}
    }}
 
    process
    {{
        if ($force)
        {{
            if (Test-Path (Join-Path WSMan:\localhost\Plugin &quot;&quot;$pluginName&quot;&quot;))
            {{
                Unregister-PSSessionConfiguration -name &quot;&quot;$pluginName&quot;&quot; -force
            }}
        }}
 
        try
        {{
            new-item -path WSMan:\localhost\Plugin -file &quot;&quot;$filepath&quot;&quot; -name &quot;&quot;$pluginName&quot;&quot;
        }}
        catch [System.InvalidOperationException] # WS2012/R2 WinRM w/o WMF has limitation where MaxConcurrentUsers can&#39;t be greater than 100
        {{
            $xml = [xml](get-content &quot;&quot;$filepath&quot;&quot;)
            $xml.PlugInConfiguration.Quotas.MaxConcurrentUsers = 100
            Set-Content -path &quot;&quot;$filepath&quot;&quot; -Value $xml.OuterXml
            new-item -path WSMan:\localhost\Plugin -file &quot;&quot;$filepath&quot;&quot; -name &quot;&quot;$pluginName&quot;&quot;
        }}
 
        if ($? -and $runAsUserName)
        {{
            try {{
                $runAsCredential = new-object system.management.automation.PSCredential($runAsUserName, $runAsPassword)
                $pluginWsmanRunAsUserPath = [System.IO.Path]::Combine(&quot;&quot;WSMan:\localhost\Plugin&quot;&quot;, &quot;&quot;$pluginName&quot;&quot;, &quot;&quot;RunAsUser&quot;&quot;)
                set-item -WarningAction SilentlyContinue $pluginWsmanRunAsUserPath $runAsCredential -confirm:$false
            }} catch {{
 
                remove-item (Join-Path WSMan:\localhost\Plugin &quot;&quot;$pluginName&quot;&quot;) -recurse -force
                write-error $_
                # Do not add anymore clean up code after Write-Error, because if EA=Stop is set by user
                # any code at this point will not execute.
 
                return
            }}
        }}
 
        ## Replace the SDDL with any groups or restrictions defined in the PSSessionConfigurationFile
        if($? -and $configTableSddl -and (-not $isSddlSpecified))
        {{
            $null = Set-PSSessionConfiguration -Name $pluginName -SecurityDescriptorSddl $configTableSddl -Force:$force
        }}
 
        if ($? -and $shouldShowUI)
        {{
           $null = winrm configsddl &quot;&quot;{0}$pluginName&quot;&quot;
 
           # if AccessMode is Disabled OR the winrm configsddl failed, we just return
           if ([System.Management.Automation.Runspaces.PSSessionConfigurationAccessMode]::Disabled.Equals($accessMode) -or !$?)
           {{
               return
           }}
        }} # end of if ($shouldShowUI)
 
        if ($?)
        {{
           # if AccessMode is Local or Remote, we need to check the SDDL the user set in the UI or passed in to the cmdlet.
           $newSDDL = $null
           $curPlugin = Get-PSSessionConfiguration -Name $pluginName -Force:$force
           $curSDDL = $curPlugin.SecurityDescriptorSddl
           if (!$curSDDL)
           {{
               if ([System.Management.Automation.Runspaces.PSSessionConfigurationAccessMode]::Local.Equals($accessMode))
               {{
                    $newSDDL = &quot;&quot;{1}&quot;&quot;
               }}
           }}
           else
           {{
               # Construct SID for network users
               [system.security.principal.wellknownsidtype]$evst = &quot;&quot;NetworkSid&quot;&quot;
               $networkSID = new-object system.security.principal.securityidentifier $evst,$null
 
               $sd = new-object system.security.accesscontrol.commonsecuritydescriptor $false,$false,$curSDDL
               $haveDisableACE = $false
               $securityIdentifierToPurge = $null
               $sd.DiscretionaryAcl | ForEach-Object {{
                    if (($_.acequalifier -eq &quot;&quot;accessdenied&quot;&quot;) -and ($_.securityidentifier -match $networkSID) -and ($_.AccessMask -eq 268435456))
                    {{
                        $haveDisableACE = $true
                        $securityIdentifierToPurge = $_.securityidentifier
                    }}
               }}
 
               if (([System.Management.Automation.Runspaces.PSSessionConfigurationAccessMode]::Local.Equals($accessMode) -or
                    [System.Management.Automation.Runspaces.PSSessionConfigurationAccessMode]::Remote.Equals($accessMode)) -and $haveDisableACE)
               {{
                    # Add network deny ACE for local access or remote access with PSRemoting disabled.
                    $sd.DiscretionaryAcl.AddAccess(&quot;&quot;deny&quot;&quot;, $networkSID, 268435456, &quot;&quot;None&quot;&quot;, &quot;&quot;None&quot;&quot;)
                    $newSDDL = $sd.GetSddlForm(&quot;&quot;all&quot;&quot;)
               }}
 
               if ([System.Management.Automation.Runspaces.PSSessionConfigurationAccessMode]::Remote.Equals($accessMode) -and $haveDisableACE)
               {{
                    # Remove the specific ACE
                    $sd.discretionaryacl.RemoveAccessSpecific(&#39;Deny&#39;, $securityIdentifierToPurge, 268435456, &#39;none&#39;, &#39;none&#39;)
 
                    # if there is no discretionaryacl..add Builtin Administrators and Remote Management Users
                    # to the DACL group as this is the default WSMan behavior
                    if ($sd.discretionaryacl.count -eq 0)
                    {{
                        [system.security.principal.wellknownsidtype]$bast = &quot;&quot;BuiltinAdministratorsSid&quot;&quot;
                        $basid = new-object system.security.principal.securityidentifier $bast,$null
                        $sd.DiscretionaryAcl.AddAccess(&#39;Allow&#39;,$basid, 268435456, &#39;none&#39;, &#39;none&#39;)
 
                        # Remote Management Users, Win8+ only
                        if ([System.Environment]::OSVersion.Version -ge &quot;&quot;6.2.0.0&quot;&quot;)
                        {{
                            $rmSidId = new-object system.security.principal.securityidentifier &quot;&quot;{2}&quot;&quot;
                            $sd.DiscretionaryAcl.AddAccess(&#39;Allow&#39;, $rmSidId, 268435456, &#39;none&#39;, &#39;none&#39;)
                        }}
 
                        # Interactive Users
                        $iaSidId = new-object system.security.principal.securityidentifier &quot;&quot;{3}&quot;&quot;
                        $sd.DiscretionaryAcl.AddAccess(&#39;Allow&#39;, $iaSidId, 268435456, &#39;none&#39;, &#39;none&#39;)
                    }}
 
                    $newSDDL = $sd.GetSddlForm(&quot;&quot;all&quot;&quot;)
               }}
           }} # end of if(!$curSDDL)
        }} # end of if ($?)
 
        if ($? -and $newSDDL)
        {{
            try {{
                if ($runAsUserName)
                {{
                    $runAsCredential = new-object system.management.automation.PSCredential($runAsUserName, $runAsPassword)
                    $null = Set-PSSessionConfiguration -Name $pluginName -SecurityDescriptorSddl $newSDDL -NoServiceRestart -force -WarningAction 0 -RunAsCredential $runAsCredential
                }}
                else
                {{
                    $null = Set-PSSessionConfiguration -Name $pluginName -SecurityDescriptorSddl $newSDDL -NoServiceRestart -force -WarningAction 0
                }}
 
            }} catch {{
                remove-item (Join-Path WSMan:\localhost\Plugin &quot;&quot;$pluginName&quot;&quot;) -recurse -force
                write-error $_
                # Do not add anymore clean up code after Write-Error, because if EA=Stop is set by user
                # any code at this point will not execute.
 
                return
            }}
        }}
 
        if ($?){{
            try{{
                $s = New-PSSession -ComputerName localhost -ConfigurationName $pluginName -ErrorAction Stop
                # session is ok, no need to restart WinRM service
                Remove-PSSession $s -Confirm:$false
            }}catch{{
                # session is NOT ok, we need to restart winrm if -Force was specified, otherwise show a warning
                if ($force){{
                    Restart-Service -Name WinRM -Force -Confirm:$false
                }}else{{
                    $warningWSManRestart = [Microsoft.PowerShell.Commands.Internal.RemotingErrorResources]::WinRMRestartWarning -f $PSCmdlet.MyInvocation.MyCommand.Name
                    Write-Warning $warningWSManRestart
                }}
            }}
        }}
    }}
}}
 
if ($null -eq $args[14])
{{
    Register-PSSessionConfiguration -filepath $args[0] -pluginName $args[1] -shouldShowUI $args[2] -force $args[3] -whatif:$args[4] -confirm:$args[5] -restartWSManTarget $args[6] -restartWSManAction $args[7] -restartWSManRequired $args[8] -runAsUserName $args[9] -runAsPassword $args[10] -accessMode $args[11] -isSddlSpecified $args[12] -configTableSddl $args[13]
}}
else
{{
    Register-PSSessionConfiguration -filepath $args[0] -pluginName $args[1] -shouldShowUI $args[2] -force $args[3] -whatif:$args[4] -confirm:$args[5] -restartWSManTarget $args[6] -restartWSManAction $args[7] -restartWSManRequired $args[8] -runAsUserName $args[9] -runAsPassword $args[10] -accessMode $args[11] -isSddlSpecified $args[12] -configTableSddl $args[13] -erroraction $args[14]
}}
&quot;</span>;
 
        <b>private static readonly</b> <a href="../../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="t t">ScriptBlock</a> <a id="75f6fb95f431d4cb" href="../../../R/75f6fb95f431d4cb.html" target="n" data-glyph="46,1" class="i field">s_newPluginSb</a>;
 
        <b>private const string</b> <a id="65b373a8095f4d69" href="../../../R/65b373a8095f4d69.html" target="n" data-glyph="10,1" class="i field">pluginXmlFormat</a> = <span class="s">@&quot;
&lt;PlugInConfiguration xmlns=&#39;http://schemas.microsoft.com/wbem/wsman/1/config/PluginConfiguration&#39;
    Name=&#39;{0}&#39;
    Filename=&#39;{1}&#39;
    SDKVersion=&#39;{12}&#39;
    XmlRenderingType=&#39;text&#39; {2} {6} {7} {8} {9} {10}&gt;
  &lt;InitializationParameters&gt;
{3}
 
  &lt;/InitializationParameters&gt;
  &lt;Resources&gt;
    &lt;Resource ResourceUri=&#39;{4}&#39; SupportsOptions=&#39;true&#39; ExactMatch=&#39;true&#39;&gt;
{5}
 
      &lt;Capability Type=&#39;Shell&#39; /&gt;
    &lt;/Resource&gt;
  &lt;/Resources&gt;
  {11}
&lt;/PlugInConfiguration&gt;
&quot;</span>;
 
        <b>private const string</b> <a id="4f25328228011ad2" href="../../../R/4f25328228011ad2.html" target="n" data-glyph="10,1" class="i field">architectureAttribFormat</a> = <span class="s">@&quot;
    Architecture=&#39;{0}&#39;&quot;</span>;
 
        <b>private const string</b> <a id="d348fc315cd3ca4d" href="../../../R/d348fc315cd3ca4d.html" target="n" data-glyph="10,1" class="i field">sharedHostAttribFormat</a> = <span class="s">@&quot;
    UseSharedProcess=&#39;{0}&#39;&quot;</span>;
 
        <b>private const string</b> <a id="69950c18d0c95162" href="../../../R/69950c18d0c95162.html" target="n" data-glyph="10,1" class="i field">runasVirtualAccountAttribFormat</a> = <span class="s">@&quot;
    RunAsVirtualAccount=&#39;{0}&#39;&quot;</span>;
 
        <b>private const string</b> <a id="f03b8bd54f6b5232" href="../../../R/f03b8bd54f6b5232.html" target="n" data-glyph="10,1" class="i field">runAsVirtualAccountGroupsAttribFormat</a> = <span class="s">@&quot;
    RunAsVirtualAccountGroups=&#39;{0}&#39;&quot;</span>;
 
        <b>private const string</b> <a id="4992c1ef8a638b7d" href="../../../R/4992c1ef8a638b7d.html" target="n" data-glyph="10,1" class="i field">allowRemoteShellAccessFormat</a> = <span class="s">@&quot;
    Enabled=&#39;{0}&#39;&quot;</span>;
 
        <b>private const string</b> <a id="599324379f68eb37" href="../../../R/599324379f68eb37.html" target="n" data-glyph="10,1" class="i field">initParamFormat</a> = <span class="s">@&quot;
&lt;Param Name=&#39;{0}&#39; Value=&#39;{1}&#39; /&gt;{2}&quot;</span>;
 
        <b>private const string</b> <a id="4de6e7c0d3f37533" href="../../../R/4de6e7c0d3f37533.html" target="n" data-glyph="10,1" class="i field">privateDataFormat</a> = <span class="s">@&quot;&lt;Param Name=&#39;PrivateData&#39;&gt;{0}&lt;/Param&gt;&quot;</span>;
        <b>private const string</b> <a id="fa2e8e7ba3101f87" href="../../../R/fa2e8e7ba3101f87.html" target="n" data-glyph="10,1" class="i field">securityElementFormat</a> = <span class="s">&quot;&lt;Security Uri=&#39;{0}&#39; ExactMatch=&#39;true&#39; Sddl=&#39;{1}&#39; /&gt;&quot;</span>;
        <b>private const string</b> <a id="cacfc19fde4b23da" href="../../../R/cacfc19fde4b23da.html" target="n" data-glyph="10,1" class="i field">SessionConfigDataFormat</a> = <span class="s">@&quot;&lt;SessionConfigurationData&gt;{0}&lt;/SessionConfigurationData&gt;&quot;</span>;
 
        <b>private string</b> <a id="54bdf072b712f095" href="../../../R/54bdf072b712f095.html" target="n" data-glyph="46,1" class="i field">_gmsaAccount</a>;
        <b>private string</b> <a id="263a828153be5001" href="../../../R/263a828153be5001.html" target="n" data-glyph="46,1" class="i field">_configTableSDDL</a>;
 
        <span class="c">// true if there are errors running the wsman&#39;s configuration</span>
        <span class="c">// command</span>
        <b>private bool</b> <a id="517d9582d3e3e1f0" href="../../../R/517d9582d3e3e1f0.html" target="n" data-glyph="46,1" class="i field">_isErrorReported</a>;
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Parameters
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Parameter used to specify the Processor Architecture that this shell targets.</span>
        <span class="c">///</span><span class="c"> On a 64bit base OS, specifying a value of 32 means that the shell is configured</span>
        <span class="c">///</span><span class="c"> to launch like a 32bit process (WOW64).</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>()]
        [<span class="i">Alias</span>(<span class="s">&quot;PA&quot;</span>)]
        [<span class="i">ValidateNotNullOrEmpty</span>]
        [<span class="i">ValidateSet</span>(<span class="s">&quot;x86&quot;</span>, <span class="s">&quot;amd64&quot;</span>)]
        <b>public string</b> <a id="e6b634da33f87c0e" href="../../../R/e6b634da33f87c0e.html" target="n" data-glyph="102,1" class="i property">ProcessorArchitecture</a> { <b>get</b>; <b>set</b>; }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Constructors
 
        <b>static</b> <a id="9d3a0b782b7f63c8" href="../../../R/../../0000000000.html" target="n" data-glyph="76,1" class="t method">RegisterPSSessionConfigurationCommand</a>()
        {
            <b>string</b> <span id="r0 rd" class="r0 r">localSDDL</span> = <a href="#1cb9fa319955517b" class="i method">GetLocalSddl</a>();
 
            <span class="c">// compile the script block statically and reuse the same instance</span>
            <span class="c">// everytime the command is run..This will save on parsing time.</span>
            <b>string</b> <span id="r1 rd" class="r1 r">newPluginSbString</span> = <b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>,
                <a href="#ccabd1c0ecf1f55e" class="i field">newPluginSbFormat</a>,
                <a href="../fanin/WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="../fanin/WSManNativeAPI.cs.html#f383edcf61712f90" class="i field">ResourceURIPrefix</a>, <span class="r0 r">localSDDL</span>, <a href="#9d3d012f73c36bca" class="i field">RemoteManagementUsersSID</a>, <a href="#3040a1427951767d" class="i field">InteractiveUsersSID</a>);
 
            <a href="#75f6fb95f431d4cb" class="i field">s_newPluginSb</a> = <a href="../../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="t t">ScriptBlock</a>.<a href="../../lang/scriptblock.cs.html#adfac0fa7bf5725f" class="i method">Create</a>(<span class="r1 r">newPluginSbString</span>);
            <a href="#75f6fb95f431d4cb" class="i field">s_newPluginSb</a>.<a href="../../lang/scriptblock.cs.html#5e76a9fb0d1a7f12" class="i property">LanguageMode</a> = <a href="../../SessionStatePublic.cs.html#450052824aba2e3f" class="t t">PSLanguageMode</a>.<a href="../../SessionStatePublic.cs.html#eec721eb8c02f156" class="i field">FullLanguage</a>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Cmdlet Overrides
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">InvalidOperationException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> 1. Either both &quot;AssemblyName&quot; and &quot;ConfigurationTypeName&quot; must be specified</span>
        <span class="c">///</span><span class="c"> or both must not be specified.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>protected override void</b> <a id="9d02d0a27845c34f" href="../../../R/9d02d0a27845c34f.html" target="n" data-glyph="75,1" class="i method">BeginProcessing</a>()
        {
            <b>if</b> (<a href="#ea050dfcef60d743" class="i field">isSddlSpecified</a> &amp;&amp; <a href="#f5740b3f379662bf" class="i field">showUISpecified</a>)
            {
                <b>string</b> <span id="r2 rd" class="r2 r">message</span> = <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">ShowUIAndSDDLCannotExist</span>,
                    <span class="s">&quot;SecurityDescriptorSddl&quot;</span>,
                    <span class="s">&quot;ShowSecurityDescriptorUI&quot;</span>);
                <b>throw</b> <b>new</b> <a href="../../../utils/MshInvalidOperationException.cs.html#de5b942a57457045" class="t constructor">PSInvalidOperationException</a>(<span class="r2 r">message</span>);
            }
 
            <b>if</b> (<a href="#e2e889cb6609651d" class="i field">isRunAsCredentialSpecified</a>)
            {
                <span class="i">WriteWarning</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">RunAsSessionConfigurationSecurityWarning</span>);
            }
 
            <b>if</b> (<a href="#ea050dfcef60d743" class="i field">isSddlSpecified</a>)
            {
                <span class="c">// Constructor call should succeed. The sddl is check in the property setter</span>
                <span class="i">CommonSecurityDescriptor</span> <span id="r3 rd" class="r3 r">descriptor</span> = <b>new</b> <span class="i">CommonSecurityDescriptor</span>(<b>false</b>, <b>false</b>, <a href="#e47691b9a35b161f" class="i field">sddl</a>);
                <span class="i">SecurityIdentifier</span> <span id="r4 rd" class="r4 r">networkSidIdentifier</span> = <b>new</b> <span class="i">SecurityIdentifier</span>(<span class="i">WellKnownSidType</span>.<span class="i">NetworkSid</span>, <b>null</b>);
                <b>bool</b> <span id="r5 rd" class="r5 r">networkDenyAllExists</span> = <b>false</b>;
                <b>foreach</b> (<span class="i">CommonAce</span> <span id="r6 rd" class="r6 r">ace</span> <b>in</b> <span class="r3 r">descriptor</span>.<span class="i">DiscretionaryAcl</span>)
                {
                    <b>if</b> (<span class="r6 r">ace</span>.<span class="i">AceQualifier</span>.<span class="i">Equals</span>(<span class="i">AceQualifier</span>.<span class="i">AccessDenied</span>) &amp;&amp; <span class="r6 r">ace</span>.<span class="i">SecurityIdentifier</span>.<span class="i">Equals</span>(<span class="r4 r">networkSidIdentifier</span>) &amp;&amp; <span class="r6 r">ace</span>.<span class="i">AccessMask</span> == 268435456)
                    {
                        <span class="r5 r">networkDenyAllExists</span> = <b>true</b>;
                        <b>break</b>;
                    }
                }
 
                <b>switch</b> (<a href="#66d32f1366ccb752" class="i property">AccessMode</a>)
                {
                    <b>case</b> <a href="../common/RunspaceConnectionInfo.cs.html#10edf62c3f6a89b0" class="t t">PSSessionConfigurationAccessMode</a>.<a href="../common/RunspaceConnectionInfo.cs.html#e493a77e156a2d8d" class="i field">Local</a>:
                        <b>if</b> (!<span class="r5 r">networkDenyAllExists</span>)
                        {
                            <span class="r3 r">descriptor</span>.<span class="i">DiscretionaryAcl</span>.<span class="i">AddAccess</span>(<span class="i">AccessControlType</span>.<span class="i">Deny</span>, <span class="r4 r">networkSidIdentifier</span>, 268435456, <span class="i">InheritanceFlags</span>.<span class="i">None</span>, <span class="i">PropagationFlags</span>.<span class="i">None</span>);
                            <a href="#e47691b9a35b161f" class="i field">sddl</a> = <span class="r3 r">descriptor</span>.<span class="i">GetSddlForm</span>(<span class="i">AccessControlSections</span>.<span class="i">All</span>);
                        }
 
                        <b>break</b>;
                    <b>case</b> <a href="../common/RunspaceConnectionInfo.cs.html#10edf62c3f6a89b0" class="t t">PSSessionConfigurationAccessMode</a>.<a href="../common/RunspaceConnectionInfo.cs.html#f9938a92bb1a8e5f" class="i field">Remote</a>:
                        <b>if</b> (<span class="r5 r">networkDenyAllExists</span>)
                        {
                            <span class="c">// Remove the specific ACE</span>
                            <span class="r3 r">descriptor</span>.<span class="i">DiscretionaryAcl</span>.<span class="i">RemoveAccessSpecific</span>(<span class="i">AccessControlType</span>.<span class="i">Deny</span>, <span class="r4 r">networkSidIdentifier</span>, 268435456, <span class="i">InheritanceFlags</span>.<span class="i">None</span>, <span class="i">PropagationFlags</span>.<span class="i">None</span>);
                            <span class="c">// If the discretionaryAcl becomes empty, add the BA and RM which is the default WinRM behavior</span>
                            <b>if</b> (<span class="r3 r">descriptor</span>.<span class="i">DiscretionaryAcl</span>.<span class="i">Count</span> == 0)
                            {
                                <span class="c">// BA</span>
                                <span class="i">SecurityIdentifier</span> <span id="r7 rd" class="r7 r">baSidIdentifier</span> = <b>new</b> <span class="i">SecurityIdentifier</span>(<span class="i">WellKnownSidType</span>.<span class="i">BuiltinAdministratorsSid</span>, <b>null</b>);
                                <span class="r3 r">descriptor</span>.<span class="i">DiscretionaryAcl</span>.<span class="i">AddAccess</span>(<span class="i">AccessControlType</span>.<span class="i">Allow</span>, <span class="r7 r">baSidIdentifier</span>, 268435456, <span class="i">InheritanceFlags</span>.<span class="i">None</span>, <span class="i">PropagationFlags</span>.<span class="i">None</span>);
 
                                <span class="c">// Only for Win8+</span>
                                <b>if</b> (<span class="i">Environment</span>.<span class="i">OSVersion</span>.<span class="i">Version</span> &gt;= <b>new</b> <span class="i">Version</span>(6, 2))
                                {
                                    <span class="c">// Remote Management Users</span>
                                    <span class="i">SecurityIdentifier</span> <span id="r8 rd" class="r8 r">rmSidIdentifier</span> = <b>new</b> <span class="i">SecurityIdentifier</span>(<a href="#9d3d012f73c36bca" class="i field">RemoteManagementUsersSID</a>);
                                    <span class="r3 r">descriptor</span>.<span class="i">DiscretionaryAcl</span>.<span class="i">AddAccess</span>(<span class="i">AccessControlType</span>.<span class="i">Allow</span>, <span class="r8 r">rmSidIdentifier</span>, 268435456, <span class="i">InheritanceFlags</span>.<span class="i">None</span>, <span class="i">PropagationFlags</span>.<span class="i">None</span>);
                                }
 
                                <span class="c">// Interactive Users</span>
                                <span class="i">SecurityIdentifier</span> <span id="r9 rd" class="r9 r">iaSidIdentifier</span> = <b>new</b> <span class="i">SecurityIdentifier</span>(<a href="#3040a1427951767d" class="i field">InteractiveUsersSID</a>);
                                <span class="r3 r">descriptor</span>.<span class="i">DiscretionaryAcl</span>.<span class="i">AddAccess</span>(<span class="i">AccessControlType</span>.<span class="i">Allow</span>, <span class="r9 r">iaSidIdentifier</span>, 268435456, <span class="i">InheritanceFlags</span>.<span class="i">None</span>, <span class="i">PropagationFlags</span>.<span class="i">None</span>);
                            }
 
                            <a href="#e47691b9a35b161f" class="i field">sddl</a> = <span class="r3 r">descriptor</span>.<span class="i">GetSddlForm</span>(<span class="i">AccessControlSections</span>.<span class="i">All</span>);
                        }
 
                        <b>break</b>;
                    <b>case</b> <a href="../common/RunspaceConnectionInfo.cs.html#10edf62c3f6a89b0" class="t t">PSSessionConfigurationAccessMode</a>.<a href="../common/RunspaceConnectionInfo.cs.html#43e3b9106e6c81f0" class="i field">Disabled</a>:
                        <b>break</b>;
                }
            }
 
            <b>if</b> (!<a href="#ea050dfcef60d743" class="i field">isSddlSpecified</a> &amp;&amp; !<a href="#f5740b3f379662bf" class="i field">showUISpecified</a>)
            {
                <b>if</b> (<a href="#66d32f1366ccb752" class="i property">AccessMode</a>.<span class="i">Equals</span>(<a href="../common/RunspaceConnectionInfo.cs.html#10edf62c3f6a89b0" class="t t">PSSessionConfigurationAccessMode</a>.<a href="../common/RunspaceConnectionInfo.cs.html#e493a77e156a2d8d" class="i field">Local</a>))
                {
                    <span class="c">// If AccessMode is Local or Disabled and no SDDL specified, use the default local SDDL</span>
                    <a href="#e47691b9a35b161f" class="i field">sddl</a> = <a href="#1cb9fa319955517b" class="i method">GetLocalSddl</a>();
                }
                <b>else</b> <b>if</b> (<a href="#66d32f1366ccb752" class="i property">AccessMode</a>.<span class="i">Equals</span>(<a href="../common/RunspaceConnectionInfo.cs.html#10edf62c3f6a89b0" class="t t">PSSessionConfigurationAccessMode</a>.<a href="../common/RunspaceConnectionInfo.cs.html#f9938a92bb1a8e5f" class="i field">Remote</a>))
                {
                    <span class="c">// If AccessMode is Remote and no SDDL specified then use the default remote SDDL</span>
                    <a href="#e47691b9a35b161f" class="i field">sddl</a> = <a href="#d2c40f80d22c2cdd" class="i method">GetRemoteSddl</a>();
                }
            }
 
            <span class="c">// check if we have compatible WSMan</span>
            <a href="remotingcommandutil.cs.html#4c008a65630ba320" class="t t">RemotingCommandUtil</a>.<a href="remotingcommandutil.cs.html#668e049b2f134726" class="i method">CheckRemotingCmdletPrerequisites</a>();
            <a href="#2111ec231989f662" class="t t">PSSessionConfigurationCommandUtilities</a>.<a href="#e6567bb211cb1a98" class="i method">ThrowIfNotAdministrator</a>();
 
            <a href="NewPSSessionConfigurationOptionCommand.cs.html#d843a286698df072" class="t t">WSManConfigurationOption</a> <span id="r10 rd" class="r10 r">wsmanOption</span> = <a href="#47818cf18fb88e71" class="i field">transportOption</a> <b>as</b> <a href="NewPSSessionConfigurationOptionCommand.cs.html#d843a286698df072" class="t t">WSManConfigurationOption</a>;
 
            <b>if</b> (<span class="r10 r">wsmanOption</span> != <b>null</b>)
            {
                <b>if</b> (<span class="r10 r">wsmanOption</span>.<a href="NewPSSessionConfigurationOptionCommand.cs.html#25776535d7a98613" class="i property">ProcessIdleTimeoutSec</a> != <b>null</b> &amp;&amp; !<a href="#8534b4735dcf261a" class="i field">isUseSharedProcessSpecified</a>)
                {
                    <a href="../../../utils/MshInvalidOperationException.cs.html#259a38c8b594783c" class="t t">PSInvalidOperationException</a> <span id="r11 rd" class="r11 r">ioe</span> = <b>new</b> <a href="../../../utils/MshInvalidOperationException.cs.html#de5b942a57457045" class="t constructor">PSInvalidOperationException</a>(
                        <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">InvalidConfigurationXMLAttribute</span>, <span class="s">&quot;ProcessIdleTimeoutSec&quot;</span>,
                        <span class="s">&quot;UseSharedProcess&quot;</span>));
                    <a href="../../cmdlet.cs.html#e3346d70990a1763" class="i method">ThrowTerminatingError</a>(<span class="r11 r">ioe</span>.<a href="../../../utils/MshInvalidOperationException.cs.html#cf42d4181b27e3c1" class="i property">ErrorRecord</a>);
                }
            }
 
            <b>string</b> <span id="r12 rd" class="r12 r">pluginPath</span> = <a href="#2111ec231989f662" class="t t">PSSessionConfigurationCommandUtilities</a>.<a href="#5f8d86f0f38b335b" class="i method">GetWinrmPluginDllPath</a>();
            <span class="r12 r">pluginPath</span> = <span class="i">Environment</span>.<span class="i">ExpandEnvironmentVariables</span>(<span class="r12 r">pluginPath</span>);
            <b>if</b> (!<span class="i n">System</span>.<span class="i">IO</span>.<span class="i">File</span>.<span class="i">Exists</span>(<span class="r12 r">pluginPath</span>))
            {
                <a href="../../../utils/MshInvalidOperationException.cs.html#259a38c8b594783c" class="t t">PSInvalidOperationException</a> <span id="r13 rd" class="r13 r">ioe</span> = <b>new</b> <a href="../../../utils/MshInvalidOperationException.cs.html#de5b942a57457045" class="t constructor">PSInvalidOperationException</a>(
                        <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">PluginDllMissing</span>, <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#d19a1042a44001e8" class="t t">RemotingConstants</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#7cbb6da0d7ec5022" class="i field">PSPluginDLLName</a>));
                <a href="../../cmdlet.cs.html#e3346d70990a1763" class="i method">ThrowTerminatingError</a>(<span class="r13 r">ioe</span>.<a href="../../../utils/MshInvalidOperationException.cs.html#cf42d4181b27e3c1" class="i property">ErrorRecord</a>);
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> For each record, execute it, and push the results into the</span>
        <span class="c">///</span><span class="c"> success stream.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>protected override void</b> <a id="50ee2ecd23f0dd48" href="../../../R/50ee2ecd23f0dd48.html" target="n" data-glyph="75,1" class="i method">ProcessRecord</a>()
        {
            <a href="../../cmdlet.cs.html#377660744c64cd7e" class="i method">WriteVerbose</a>(<a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">NcsScriptMessageV</span>, <a href="#ccabd1c0ecf1f55e" class="i field">newPluginSbFormat</a>));
 
            <b>if</b> (!<a href="#06d26f0ccfb63d9a" class="i field">force</a>)
            {
                <b>string</b> <span id="r14 rd" class="r14 r">shouldProcessAction</span> = <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">CSShouldProcessAction</span>,
                    <a href="#091dc53780f2780a" class="k">this</a>.<a href="../../CommandBase.cs.html#1f4a1f38862b466a" class="i property">CommandInfo</a>.<a href="../../CommandInfo.cs.html#02e11b521c500195" class="i property">Name</a>);
                <b>string</b> <span id="r15 rd" class="r15 r">shouldProcessTarget</span>;
 
                <b>if</b> (<a href="#ea050dfcef60d743" class="i field">isSddlSpecified</a>)
                {
                    <span class="r15 r">shouldProcessTarget</span> = <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">NcsShouldProcessTargetSDDL</span>, <a href="#ff3d179414dbc3ad" class="i property">Name</a>, <a href="#e47691b9a35b161f" class="i field">sddl</a>);
                }
                <b>else</b>
                {
                    <span class="r15 r">shouldProcessTarget</span> = <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">CSShouldProcessTargetAdminEnable</span>, <a href="#ff3d179414dbc3ad" class="i property">Name</a>);
                }
 
                <b>string</b> <span id="r16 rd" class="r16 r">action</span> = <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">CSShouldProcessAction</span>,
                    <a href="#091dc53780f2780a" class="k">this</a>.<a href="../../CommandBase.cs.html#1f4a1f38862b466a" class="i property">CommandInfo</a>.<a href="../../CommandInfo.cs.html#02e11b521c500195" class="i property">Name</a>);
                <a href="../../cmdlet.cs.html#dda5a07d1a8a6cba" class="i method">WriteWarning</a>(<a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">WinRMRestartWarning</span>, <span class="r16 r">action</span>));
 
                <b>if</b> (!<a href="../../cmdlet.cs.html#5f125d2ab6d0970d" class="i method">ShouldProcess</a>(<span class="r15 r">shouldProcessTarget</span>, <span class="r14 r">shouldProcessAction</span>))
                {
                    <b>return</b>;
                }
            }
 
            <span class="c">// Configuration file copy information.</span>
            <b>string</b> <span id="r17 rd" class="r17 r">srcConfigFilePath</span>;
            <b>string</b> <span id="r18 rd" class="r18 r">destConfigFilePath</span>;
 
            <span class="c">// construct plugin config file.</span>
            <b>string</b> <span id="r19 rd" class="r19 r">pluginContent</span> = <a href="#6d8e9b48536cb745" class="i method">ConstructPluginContent</a>(<b>out</b> <span class="r17 r">srcConfigFilePath</span>, <b>out</b> <span class="r18 r">destConfigFilePath</span>);
 
            <span class="c">// Create temporary file with the content.</span>
            <b>string</b> <span id="r20 rd" class="r20 r">file</span> = <a href="#18eec0244e64e186" class="i method">ConstructTemporaryFile</a>(<span class="r19 r">pluginContent</span>);
 
            <span class="c">// Move the WinRM service to its own service host if the endpoint is given elevated credentials.</span>
            <b>if</b> (<a href="#e2e889cb6609651d" class="i field">isRunAsCredentialSpecified</a> || <a href="#73a5a75f7a76f61d" class="i property">RunAsVirtualAccountSpecified</a>)
            {
                <a href="#2111ec231989f662" class="t t">PSSessionConfigurationCommandUtilities</a>.<a href="#35e6a21548384ea9" class="i method">MoveWinRmToIsolatedServiceHost</a>(<a href="#73a5a75f7a76f61d" class="i property">RunAsVirtualAccountSpecified</a>);
            }
 
            <span class="c">// Use the Group Managed Service Account if provided.</span>
            <b>if</b> (!<a href="#e2e889cb6609651d" class="i field">isRunAsCredentialSpecified</a> &amp;&amp; !<b>string</b>.<span class="i">IsNullOrEmpty</span>(<a href="#54bdf072b712f095" class="i field">_gmsaAccount</a>))
            {
                <a href="#0c6742692211cee9" class="i field">runAsCredential</a> = <a href="#2111ec231989f662" class="t t">PSSessionConfigurationCommandUtilities</a>.<a href="#5655deae904cb964" class="i method">CreateGMSAAccountCredentials</a>(<a href="#54bdf072b712f095" class="i field">_gmsaAccount</a>);
            }
 
            <b>try</b>
            {
                <span class="c">// restart-service winrm to make the changes effective.</span>
                <b>string</b> <span id="r21 rd" class="r21 r">restartServiceAction</span> = <span class="i">RemotingErrorIdStrings</span>.<span class="i">RestartWSManServiceAction</span>;
                <b>string</b> <span id="r22 rd" class="r22 r">restartServiceTarget</span> = <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">RestartWSManServiceTarget</span>, <span class="s">&quot;WinRM&quot;</span>);
 
                <b>string</b> <span id="r23 rd" class="r23 r">restartWSManRequiredForUI</span> = <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">RestartWSManRequiredShowUI</span>,
                    <b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>,
                        <span class="s">&quot;Set-PSSessionConfiguration {0} -ShowSecurityDescriptorUI&quot;</span>,
                        <a href="#50e45ca03ff16b28" class="i field">shellName</a>));
 
                <span class="c">// gather -WhatIf, -Confirm parameter data and pass it to the script block</span>
                <b>bool</b> <span id="r24 rd" class="r24 r">whatIf</span> = <b>false</b>;
                <span class="c">// confirm is always true to start with</span>
                <b>bool</b> <span id="r25 rd" class="r25 r">confirm</span> = <b>true</b>;
                <a href="#2111ec231989f662" class="t t">PSSessionConfigurationCommandUtilities</a>.<a href="#62fe0a5dea8c58db" class="i method">CollectShouldProcessParameters</a>(<a href="#091dc53780f2780a" class="k">this</a>, <b>out</b> <span class="r24 r">whatIf</span>, <b>out</b> <span class="r25 r">confirm</span>);
                <span class="c">// gather -ErrorAction parameter data and pass it to the script block. if -ErrorAction is not set, pass $null in</span>
                <b>object</b> <span id="r26 rd" class="r26 r">errorAction</span> = <b>null</b>;
                <b>if</b> (<a href="../../CommandBase.cs.html#a41a765d70fc9c9d" class="i property">Context</a>.<a href="../../ExecutionContext.cs.html#1146573afe2845c8" class="i property">CurrentCommandProcessor</a>.<a href="../../CommandProcessorBase.cs.html#d539d84981be114a" class="i property">CommandRuntime</a>.<a href="../../MshCommandRuntime.cs.html#4e39bf0444feb43b" class="i property">IsErrorActionSet</a>)
                {
                    <span class="r26 r">errorAction</span> = <a href="../../CommandBase.cs.html#a41a765d70fc9c9d" class="i property">Context</a>.<a href="../../ExecutionContext.cs.html#1146573afe2845c8" class="i property">CurrentCommandProcessor</a>.<a href="../../CommandProcessorBase.cs.html#d539d84981be114a" class="i property">CommandRuntime</a>.<a href="../../MshCommandRuntime.cs.html#0135181adbe24516" class="i property">ErrorAction</a>;
                }
 
                <span class="i">ArrayList</span> <span id="r27 rd" class="r27 r">errorList</span> = (<span class="i">ArrayList</span>)<a href="../../CommandBase.cs.html#a41a765d70fc9c9d" class="i property">Context</a>.<a href="../../ExecutionContext.cs.html#9f5bde284d161965" class="i property">DollarErrorVariable</a>;
                <b>int</b> <span id="r28 rd" class="r28 r">errorCountBefore</span> = <span class="r27 r">errorList</span>.<span class="i">Count</span>;
 
                <b>if</b> (<a href="#06d26f0ccfb63d9a" class="i field">force</a> &amp;&amp;
                <a href="#091dc53780f2780a" class="k">this</a>.<a href="../../CommandBase.cs.html#a41a765d70fc9c9d" class="i property">Context</a> != <b>null</b> &amp;&amp;
                <a href="#091dc53780f2780a" class="k">this</a>.<a href="../../CommandBase.cs.html#a41a765d70fc9c9d" class="i property">Context</a>.<a href="../../ExecutionContext.cs.html#24a4a46de18d1004" class="i property">EngineHostInterface</a> != <b>null</b> &amp;&amp;
                <a href="#091dc53780f2780a" class="k">this</a>.<a href="../../CommandBase.cs.html#a41a765d70fc9c9d" class="i property">Context</a>.<a href="../../ExecutionContext.cs.html#24a4a46de18d1004" class="i property">EngineHostInterface</a>.<a href="../../hostifaces/InternalHost.cs.html#f25431d0ab961179" class="i property">ExternalHost</a> != <b>null</b> &amp;&amp;
                <a href="#091dc53780f2780a" class="k">this</a>.<a href="../../CommandBase.cs.html#a41a765d70fc9c9d" class="i property">Context</a>.<a href="../../ExecutionContext.cs.html#24a4a46de18d1004" class="i property">EngineHostInterface</a>.<a href="../../hostifaces/InternalHost.cs.html#f25431d0ab961179" class="i property">ExternalHost</a> <b>is</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Remoting</span>.<a href="../server/ServerRemoteHost.cs.html#ecbb655f955c09fc" class="t t">ServerRemoteHost</a>)
                {
                    <span class="i">WriteWarning</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">WinRMForceRestartWarning</span>);
                }
 
                <a href="#75f6fb95f431d4cb" class="i field">s_newPluginSb</a>.<span class="i">InvokeUsingCmdlet</span>(
                    <span class="i">contextCmdlet</span>: <a href="#091dc53780f2780a" class="k">this</a>,
                    <span class="i">useLocalScope</span>: <b>true</b>,
                    <span class="i">errorHandlingBehavior</span>: <a href="../../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="t t">ScriptBlock</a>.<a href="../../lang/scriptblock.cs.html#10c045824f712272" class="t t">ErrorHandlingBehavior</a>.<a href="../../lang/scriptblock.cs.html#5e78734ffe1c6ed3" class="i field">WriteToCurrentErrorPipe</a>,
                    <span class="i">dollarUnder</span>: <a href="../../AutomationNull.cs.html#681fbea4c40e4af1" class="t t">AutomationNull</a>.<a href="../../AutomationNull.cs.html#1cf7e193da582896" class="i property">Value</a>,
                    <span class="i">input</span>: <span class="i">Array</span>.<span class="i">Empty</span>&lt;<b>object</b>&gt;(),
                    <span class="i">scriptThis</span>: <a href="../../AutomationNull.cs.html#681fbea4c40e4af1" class="t t">AutomationNull</a>.<a href="../../AutomationNull.cs.html#1cf7e193da582896" class="i property">Value</a>,
                    <span class="i">args</span>: <b>new</b> <b>object</b>[] {
                                            <span class="r20 r">file</span>,
                                            <a href="#50e45ca03ff16b28" class="i field">shellName</a>,
                                            <a href="#e14e225be242dd67" class="i property">ShowSecurityDescriptorUI</a>.<a href="../../MshCmdlet.cs.html#1292a5d1a1a3e8e8" class="i method">ToBool</a>(),
                                            <a href="#06d26f0ccfb63d9a" class="i field">force</a>,
                                            <span class="r24 r">whatIf</span>,
                                            <span class="r25 r">confirm</span>,
                                            <span class="r22 r">restartServiceTarget</span>,
                                            <span class="r21 r">restartServiceAction</span>,
                                            <span class="r23 r">restartWSManRequiredForUI</span>,
                                            <a href="#0c6742692211cee9" class="i field">runAsCredential</a>?.<a href="../../Credential.cs.html#3fca673651eaeaff" class="i property">UserName</a>,
                                            <a href="#0c6742692211cee9" class="i field">runAsCredential</a>?.<a href="../../Credential.cs.html#828d5fa008f1755c" class="i property">Password</a>,
                                            <a href="#66d32f1366ccb752" class="i property">AccessMode</a>,
                                            <a href="#ea050dfcef60d743" class="i field">isSddlSpecified</a>,
                                            <a href="#263a828153be5001" class="i field">_configTableSDDL</a>,
                                            <span class="r26 r">errorAction</span>
                                       });
 
                <span class="r27 r">errorList</span> = (<span class="i">ArrayList</span>)<a href="../../CommandBase.cs.html#a41a765d70fc9c9d" class="i property">Context</a>.<a href="../../ExecutionContext.cs.html#9f5bde284d161965" class="i property">DollarErrorVariable</a>;
                <a href="#517d9582d3e3e1f0" class="i field">_isErrorReported</a> = <span class="r27 r">errorList</span>.<span class="i">Count</span> &gt; <span class="r28 r">errorCountBefore</span>;
            }
            <b>finally</b>
            {
                <a href="#00bc8eb8b894c942" class="i method">DeleteFile</a>(<span class="r20 r">file</span>);
            }
 
            <span class="c">// If the file no longer exists then re-copy the configuration file to the dest location after</span>
            <span class="c">// newPluginSb script is run the file no longer exists.</span>
            <b>if</b> ((<span class="r17 r">srcConfigFilePath</span> != <b>null</b>) &amp;&amp; (<span class="r18 r">destConfigFilePath</span> != <b>null</b>) &amp;&amp;
                !<span class="i">File</span>.<span class="i">Exists</span>(<span class="r18 r">destConfigFilePath</span>))
            {
                <b>try</b>
                {
                    <span class="i">File</span>.<span class="i">Copy</span>(<span class="r17 r">srcConfigFilePath</span>, <span class="r18 r">destConfigFilePath</span>, <b>true</b>);
                }
                <b>catch</b> (<span class="i">IOException</span>) { }
                <b>catch</b> (<span class="i">ArgumentException</span>) { }
                <b>catch</b> (<span class="i">NotSupportedException</span>) { }
                <b>catch</b> (<span class="i">UnauthorizedAccessException</span>) { }
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>protected override void</b> <a id="c4e92cf6e7f9b658" href="../../../R/c4e92cf6e7f9b658.html" target="n" data-glyph="75,1" class="i method">EndProcessing</a>()
        {
            <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Tracing</span>.<a href="../../../P/5b1d077d1aa35b55.html#5b1d077d1aa35b55" class="t t">Tracer</a> <span id="r29 rd" class="r29 r">tracer</span> = <b>new</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Tracing</span>.<a href="../../../utils/tracing/TracingGen.cs.html#3e4070d535f42333" class="t constructor">Tracer</a>();
            <span class="r29 r">tracer</span>.<span class="i">EndpointRegistered</span>(<a href="#091dc53780f2780a" class="k">this</a>.<a href="#ff3d179414dbc3ad" class="i property">Name</a>, <span class="i">WindowsIdentity</span>.<span class="i">GetCurrent</span>().<span class="i">Name</span>);
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Private Methods
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r30 r">tmpFileName</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">InvalidOperationException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> 1. New shell successfully registered. However cannot delete temporary plugin file {0}.</span>
        <span class="c">///</span><span class="c">    Reason for failure: {1}.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>private static void</b> <a id="00bc8eb8b894c942" href="../../../R/00bc8eb8b894c942.html" target="n" data-glyph="76,1" class="i method">DeleteFile</a>(<b>string</b> <span id="r30 rd" class="r30 r">tmpFileName</span>)
        {
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<span class="i">Assert</span>(!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r30 r">tmpFileName</span>), <span class="s">&quot;tmpFile cannot be null or empty.&quot;</span>);
 
            <span class="i">Exception</span> <span id="r31 rd" class="r31 r">e</span> = <b>null</b>;
            <b>try</b>
            {
                <span class="i">File</span>.<span class="i">Delete</span>(<span class="r30 r">tmpFileName</span>);
                <span class="c">// WriteWarning(tmpFileName);</span>
            }
            <b>catch</b> (<span class="i">UnauthorizedAccessException</span> <span id="r32 rd" class="r32 r">uae</span>)
            {
                <span class="r31 r">e</span> = <span class="r32 r">uae</span>;
            }
            <b>catch</b> (<span class="i">ArgumentException</span> <span id="r33 rd" class="r33 r">ae</span>)
            {
                <span class="r31 r">e</span> = <span class="r33 r">ae</span>;
            }
            <b>catch</b> (<span class="i">PathTooLongException</span> <span id="r34 rd" class="r34 r">pe</span>)
            {
                <span class="r31 r">e</span> = <span class="r34 r">pe</span>;
            }
            <b>catch</b> (<span class="i">DirectoryNotFoundException</span> <span id="r35 rd" class="r35 r">dnfe</span>)
            {
                <span class="r31 r">e</span> = <span class="r35 r">dnfe</span>;
            }
            <b>catch</b> (<span class="i">IOException</span> <span id="r36 rd" class="r36 r">ioe</span>)
            {
                <span class="r31 r">e</span> = <span class="r36 r">ioe</span>;
            }
            <b>catch</b> (<span class="i">NotSupportedException</span> <span id="r37 rd" class="r37 r">nse</span>)
            {
                <span class="r31 r">e</span> = <span class="r37 r">nse</span>;
            }
 
            <b>if</b> (<span class="r31 r">e</span> != <b>null</b>)
            {
                <b>throw</b> <a href="../../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<span class="i">NewInvalidOperationException</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">NcsCannotDeleteFileAfterInstall</span>,
                                                                 <span class="r30 r">tmpFileName</span>,
                                                                 <span class="r31 r">e</span>.<span class="i">Message</span>);
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r38 r">pluginContent</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">InvalidOperationException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> 1. Cannot delete temporary file {0}. Try again. Reason for failure: {1}.</span>
        <span class="c">///</span><span class="c"> 2. Cannot write shell configuration data into temporary file {0}. Try again.</span>
        <span class="c">///</span><span class="c">    Reason for failure: {1}.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>private static string</b> <a id="18eec0244e64e186" href="../../../R/18eec0244e64e186.html" target="n" data-glyph="76,1" class="i method">ConstructTemporaryFile</a>(<b>string</b> <span id="r38 rd" class="r38 r">pluginContent</span>)
        {
            <span class="c">// Path.GetTempFileName creates a temporary file whereas GetRandomFileName does not.</span>
            <b>string</b> <span id="r39 rd" class="r39 r">tmpFileName</span> = <span class="i n">System</span>.<span class="i">IO</span>.<span class="i">Path</span>.<span class="i">Combine</span>(<span class="i n">System</span>.<span class="i">IO</span>.<span class="i">Path</span>.<span class="i">GetTempPath</span>(), <span class="i n">System</span>.<span class="i">IO</span>.<span class="i">Path</span>.<span class="i">GetRandomFileName</span>()) + <span class="s">&quot;psshell.xml&quot;</span>;
 
            <span class="i">Exception</span> <span id="r40 rd" class="r40 r">e</span> = <b>null</b>;
            <span class="c">// Remove the temp file if it exists.</span>
            <b>if</b> (<span class="i">File</span>.<span class="i">Exists</span>(<span class="r39 r">tmpFileName</span>))
            {
                <span class="i">FileInfo</span> <span id="r41 rd" class="r41 r">destfile</span> = <b>new</b> <span class="i">FileInfo</span>(<span class="r39 r">tmpFileName</span>);
                <b>if</b> (<span class="r41 r">destfile</span> != <b>null</b>)
                {
                    <b>try</b>
                    {
                        <span class="c">// Make sure the file is not read only</span>
                        <span class="r41 r">destfile</span>.<span class="i">Attributes</span> &amp;= ~(<span class="i">FileAttributes</span>.<span class="i">ReadOnly</span> | <span class="i">FileAttributes</span>.<span class="i">Hidden</span>);
                        <span class="r41 r">destfile</span>.<span class="i">Delete</span>();
                    }
                    <b>catch</b> (<span class="i">FileNotFoundException</span> <span id="r42 rd" class="r42 r">fnf</span>)
                    {
                        <span class="r40 r">e</span> = <span class="r42 r">fnf</span>;
                    }
                    <b>catch</b> (<span class="i">DirectoryNotFoundException</span> <span id="r43 rd" class="r43 r">dnf</span>)
                    {
                        <span class="r40 r">e</span> = <span class="r43 r">dnf</span>;
                    }
                    <b>catch</b> (<span class="i">UnauthorizedAccessException</span> <span id="r44 rd" class="r44 r">uac</span>)
                    {
                        <span class="r40 r">e</span> = <span class="r44 r">uac</span>;
                    }
                    <b>catch</b> (<span class="i n">System</span>.<span class="i">Security</span>.<span class="i">SecurityException</span> <span id="r45 rd" class="r45 r">se</span>)
                    {
                        <span class="r40 r">e</span> = <span class="r45 r">se</span>;
                    }
                    <b>catch</b> (<span class="i">ArgumentNullException</span> <span id="r46 rd" class="r46 r">ane</span>)
                    {
                        <span class="r40 r">e</span> = <span class="r46 r">ane</span>;
                    }
                    <b>catch</b> (<span class="i">ArgumentException</span> <span id="r47 rd" class="r47 r">ae</span>)
                    {
                        <span class="r40 r">e</span> = <span class="r47 r">ae</span>;
                    }
                    <b>catch</b> (<span class="i">PathTooLongException</span> <span id="r48 rd" class="r48 r">pe</span>)
                    {
                        <span class="r40 r">e</span> = <span class="r48 r">pe</span>;
                    }
                    <b>catch</b> (<span class="i">NotSupportedException</span> <span id="r49 rd" class="r49 r">ns</span>)
                    {
                        <span class="r40 r">e</span> = <span class="r49 r">ns</span>;
                    }
                    <b>catch</b> (<span class="i">IOException</span> <span id="r50 rd" class="r50 r">ioe</span>)
                    {
                        <span class="r40 r">e</span> = <span class="r50 r">ioe</span>;
                    }
 
                    <b>if</b> (<span class="r40 r">e</span> != <b>null</b>)
                    {
                        <b>throw</b> <a href="../../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<span class="i">NewInvalidOperationException</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">NcsCannotDeleteFile</span>,
                                                                         <span class="r39 r">tmpFileName</span>,
                                                                         <span class="r40 r">e</span>.<span class="i">Message</span>);
                    }
                }
            }
 
            <b>try</b>
            {
                <b>using</b> (<span class="i">StreamWriter</span> <span id="r51 rd" class="r51 r">fileStream</span> = <span class="i">File</span>.<span class="i">CreateText</span>(<span class="r39 r">tmpFileName</span>))
                {
                    <span class="r51 r">fileStream</span>.<span class="i">Write</span>(<span class="r38 r">pluginContent</span>);
                    <span class="r51 r">fileStream</span>.<span class="i">Flush</span>();
                }
            }
            <b>catch</b> (<span class="i">UnauthorizedAccessException</span> <span id="r52 rd" class="r52 r">uae</span>)
            {
                <span class="r40 r">e</span> = <span class="r52 r">uae</span>;
            }
            <b>catch</b> (<span class="i">ArgumentException</span> <span id="r53 rd" class="r53 r">ae</span>)
            {
                <span class="r40 r">e</span> = <span class="r53 r">ae</span>;
            }
            <b>catch</b> (<span class="i">PathTooLongException</span> <span id="r54 rd" class="r54 r">pe</span>)
            {
                <span class="r40 r">e</span> = <span class="r54 r">pe</span>;
            }
            <b>catch</b> (<span class="i">DirectoryNotFoundException</span> <span id="r55 rd" class="r55 r">dnfe</span>)
            {
                <span class="r40 r">e</span> = <span class="r55 r">dnfe</span>;
            }
 
            <b>if</b> (<span class="r40 r">e</span> != <b>null</b>)
            {
                <b>throw</b> <a href="../../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<span class="i">NewInvalidOperationException</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">NcsCannotWritePluginContent</span>,
                                                                 <span class="r39 r">tmpFileName</span>,
                                                                 <span class="r40 r">e</span>.<span class="i">Message</span>);
            }
 
            <b>return</b> <span class="r39 r">tmpFileName</span>;
        }
 
        <b>private string</b> <a id="6d8e9b48536cb745" href="../../../R/6d8e9b48536cb745.html" target="n" data-glyph="76,1" class="i method">ConstructPluginContent</a>(<b>out string</b> <span id="r56 rd" class="r56 r">srcConfigFilePath</span>, <b>out string</b> <span id="r57 rd" class="r57 r">destConfigFilePath</span>)
        {
            <span class="r56 r">srcConfigFilePath</span> = <b>null</b>;
            <span class="r57 r">destConfigFilePath</span> = <b>null</b>;
            <span class="i">StringBuilder</span> <span id="r58 rd" class="r58 r">initParameters</span> = <b>new</b> <span class="i">StringBuilder</span>();
 
            <b>const bool</b> <span id="r59 rd" class="r59 r">assemblyAndTypeTokensSet</span> = <b>false</b>;
 
            <span class="c">// DISC endpoint</span>
            <b>if</b> (<a href="#7f0833e245fe41bc" class="i property">Path</a> != <b>null</b>)
            {
                <a href="../../DataStoreAdapterProvider.cs.html#dd4e1f2f8e73a1dd" class="t t">ProviderInfo</a> <span id="r60 rd" class="r60 r">provider</span> = <b>null</b>;
                <a href="../../DataStoreAdapter.cs.html#2d16b26a541ba185" class="t t">PSDriveInfo</a> <span id="r61 rd" class="r61 r">drive</span>;
                <b>string</b> <span id="r62 rd" class="r62 r">filePath</span> = <a href="../../CommandBase.cs.html#5078d443148de142" class="i property">SessionState</a>.<a href="../../SessionStatePublic.cs.html#3390cfbbdcffb036" class="i property">Path</a>.<a href="../../PathInterfaces.cs.html#89444ef2b32a4408" class="i method">GetUnresolvedProviderPathFromPSPath</a>(<a href="#7f0833e245fe41bc" class="i property">Path</a>, <b>out</b> <span class="r60 r">provider</span>, <b>out</b> <span class="r61 r">drive</span>);
 
                <b>if</b> (!<span class="r60 r">provider</span>.<a href="../../DataStoreAdapterProvider.cs.html#13e2cce7adaad137" class="i method">NameEquals</a>(<a href="../../CommandBase.cs.html#a41a765d70fc9c9d" class="i property">Context</a>.<a href="../../ExecutionContext.cs.html#733af3e5592e5947" class="i property">ProviderNames</a>.<a href="../../ProviderNames.cs.html#07509539bc35966f" class="i property">FileSystem</a>) || !<span class="r62 r">filePath</span>.<span class="i">EndsWith</span>(<a href="../../SessionStateStrings.cs.html#55ee11e42c7cf459" class="t t">StringLiterals</a>.<a href="../../SessionStateStrings.cs.html#f547328079c2f2df" class="i field">PowerShellDISCFileExtension</a>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
                {
                    <b>string</b> <span id="r63 rd" class="r63 r">message</span> = <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">InvalidPSSessionConfigurationFilePath</span>, <span class="r62 r">filePath</span>);
                    <span class="i">InvalidOperationException</span> <span id="r64 rd" class="r64 r">ioe</span> = <b>new</b> <span class="i">InvalidOperationException</span>(<span class="r63 r">message</span>);
                    <a href="../../ErrorPackage.cs.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r65 rd" class="r65 r">er</span> = <b>new</b> <span class="t">ErrorRecord</span>(<span class="r64 r">ioe</span>, <span class="s">&quot;InvalidPSSessionConfigurationFilePath&quot;</span>,
                        <a href="../../ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../../ErrorPackage.cs.html#846d2b572f2c4820" class="i field">InvalidArgument</a>, <a href="#7f0833e245fe41bc" class="i property">Path</a>);
                    <a href="../../cmdlet.cs.html#e3346d70990a1763" class="i method">ThrowTerminatingError</a>(<span class="r65 r">er</span>);
                }
 
                <span class="i">Guid</span> <span id="r66 rd" class="r66 r">sessionGuid</span> = <span class="i">Guid</span>.<span class="i">Empty</span>;
 
                <span class="c">// Load session GUID from config file</span>
                <b>string</b> <span id="r67 rd" class="r67 r">scriptName</span>;
                <a href="../../ExternalScriptInfo.cs.html#7806ac40f903221c" class="t t">ExternalScriptInfo</a> <span id="r68 rd" class="r68 r">scriptInfo</span> = <b>null</b>;
                <span class="i">Hashtable</span> <span id="r69 rd" class="r69 r">configTable</span> = <b>null</b>;
 
                <b>try</b>
                {
                    <span class="r68 r">scriptInfo</span> = <a href="../fanin/InitialSessionStateProvider.cs.html#78aacc47ea72f6a8" class="t t">DISCUtils</a>.<a href="../fanin/InitialSessionStateProvider.cs.html#cbbec5f551fd0e0c" class="i method">GetScriptInfoForFile</a>(<a href="#091dc53780f2780a" class="k">this</a>.<a href="../../CommandBase.cs.html#a41a765d70fc9c9d" class="i property">Context</a>, <span class="r62 r">filePath</span>, <b>out</b> <span class="r67 r">scriptName</span>);
                    <span class="r69 r">configTable</span> = <a href="../fanin/InitialSessionStateProvider.cs.html#78aacc47ea72f6a8" class="t t">DISCUtils</a>.<a href="../fanin/InitialSessionStateProvider.cs.html#165b977f5f1cf798" class="i method">LoadConfigFile</a>(<a href="#091dc53780f2780a" class="k">this</a>.<a href="../../CommandBase.cs.html#a41a765d70fc9c9d" class="i property">Context</a>, <span class="r68 r">scriptInfo</span>);
                }
                <b>catch</b> (<a href="../../../utils/RuntimeException.cs.html#bd88f263eb295545" class="t t">RuntimeException</a> <span id="r70 rd" class="r70 r">rte</span>)
                {
                    <b>string</b> <span id="r71 rd" class="r71 r">message</span> = <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">InvalidPSSessionConfigurationFileErrorProcessing</span>, <span class="r62 r">filePath</span>, <span class="r70 r">rte</span>.<span class="i">Message</span>);
                    <span class="i">InvalidOperationException</span> <span id="r72 rd" class="r72 r">ioe</span> = <b>new</b> <span class="i">InvalidOperationException</span>(<span class="r71 r">message</span>, <span class="r70 r">rte</span>);
                    <a href="../../ErrorPackage.cs.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r73 rd" class="r73 r">er</span> = <b>new</b> <span class="t">ErrorRecord</span>(<span class="r72 r">ioe</span>, <span class="s">&quot;InvalidPSSessionConfigurationFilePath&quot;</span>,
                        <a href="../../ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../../ErrorPackage.cs.html#846d2b572f2c4820" class="i field">InvalidArgument</a>, <a href="#7f0833e245fe41bc" class="i property">Path</a>);
                    <a href="../../cmdlet.cs.html#e3346d70990a1763" class="i method">ThrowTerminatingError</a>(<span class="r73 r">er</span>);
                }
 
                <b>if</b> (<span class="r69 r">configTable</span> == <b>null</b>)
                {
                    <b>string</b> <span id="r74 rd" class="r74 r">message</span> = <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">InvalidPSSessionConfigurationFile</span>, <span class="r62 r">filePath</span>);
                    <span class="i">InvalidOperationException</span> <span id="r75 rd" class="r75 r">ioe</span> = <b>new</b> <span class="i">InvalidOperationException</span>(<span class="r74 r">message</span>);
                    <a href="../../ErrorPackage.cs.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r76 rd" class="r76 r">er</span> = <b>new</b> <span class="t">ErrorRecord</span>(<span class="r75 r">ioe</span>, <span class="s">&quot;InvalidPSSessionConfigurationFile&quot;</span>,
                        <a href="../../ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../../ErrorPackage.cs.html#846d2b572f2c4820" class="i field">InvalidArgument</a>, <a href="#7f0833e245fe41bc" class="i property">Path</a>);
                    <a href="../../cmdlet.cs.html#e3346d70990a1763" class="i method">ThrowTerminatingError</a>(<span class="r76 r">er</span>);
                }
                <b>else</b>
                {
                    <b>if</b> (<span class="r69 r">configTable</span>.<span class="i">ContainsKey</span>(<a href="../fanin/InitialSessionStateProvider.cs.html#b1e495f9b52fbd4a" class="t t">ConfigFileConstants</a>.<a href="../fanin/InitialSessionStateProvider.cs.html#588d3101f5da21f7" class="i field">Guid</a>))
                    {
                        <b>try</b>
                        {
                            <b>if</b> (<span class="r69 r">configTable</span>[<a href="../fanin/InitialSessionStateProvider.cs.html#b1e495f9b52fbd4a" class="t t">ConfigFileConstants</a>.<a href="../fanin/InitialSessionStateProvider.cs.html#588d3101f5da21f7" class="i field">Guid</a>] != <b>null</b>)
                            {
                                <span class="r66 r">sessionGuid</span> = <span class="i">Guid</span>.<span class="i">Parse</span>(<span class="r69 r">configTable</span>[<a href="../fanin/InitialSessionStateProvider.cs.html#b1e495f9b52fbd4a" class="t t">ConfigFileConstants</a>.<a href="../fanin/InitialSessionStateProvider.cs.html#588d3101f5da21f7" class="i field">Guid</a>].<span class="i">ToString</span>());
                            }
                            <b>else</b>
                            {
                                <span class="i">InvalidOperationException</span> <span id="r77 rd" class="r77 r">invalidOperationException</span> = <b>new</b> <span class="i">InvalidOperationException</span>(<a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">ErrorParsingTheKeyInPSSessionConfigurationFile</span>, <a href="../fanin/InitialSessionStateProvider.cs.html#b1e495f9b52fbd4a" class="t t">ConfigFileConstants</a>.<a href="../fanin/InitialSessionStateProvider.cs.html#588d3101f5da21f7" class="i field">Guid</a>, <span class="r62 r">filePath</span>));
                                <a href="../../cmdlet.cs.html#e3346d70990a1763" class="i method">ThrowTerminatingError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r77 r">invalidOperationException</span>, <span class="s">&quot;InvalidGuidInPSSessionConfigurationFile&quot;</span>, <a href="../../ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../../ErrorPackage.cs.html#b5cba3d51f976bb3" class="i field">InvalidOperation</a>, <b>null</b>));
                            }
                        }
                        <b>catch</b> (<span class="i">FormatException</span> <span id="r78 rd" class="r78 r">e</span>)
                        {
                            <a href="../../cmdlet.cs.html#e3346d70990a1763" class="i method">ThrowTerminatingError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r78 r">e</span>, <span class="s">&quot;InvalidGuidInPSSessionConfigurationFile&quot;</span>, <a href="../../ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../../ErrorPackage.cs.html#b5cba3d51f976bb3" class="i field">InvalidOperation</a>, <b>null</b>));
                        }
                    }
 
                    <b>if</b> (<span class="r69 r">configTable</span>.<span class="i">ContainsKey</span>(<a href="../fanin/InitialSessionStateProvider.cs.html#b1e495f9b52fbd4a" class="t t">ConfigFileConstants</a>.<a href="../fanin/InitialSessionStateProvider.cs.html#b5b521e31e7f3529" class="i field">PowerShellVersion</a>))
                    {
                        <b>if</b> (!<a href="#461be9a9e6b577d5" class="i field">isPSVersionSpecified</a>)
                        {
                            <b>try</b>
                            {
                                <a href="#716174720103792d" class="i property">PSVersion</a> = <b>new</b> <span class="i">Version</span>(<span class="r69 r">configTable</span>[<a href="../fanin/InitialSessionStateProvider.cs.html#b1e495f9b52fbd4a" class="t t">ConfigFileConstants</a>.<a href="../fanin/InitialSessionStateProvider.cs.html#b5b521e31e7f3529" class="i field">PowerShellVersion</a>].<span class="i">ToString</span>());
                            }
                            <b>catch</b> (<span class="i">ArgumentException</span> <span id="r79 rd" class="r79 r">e</span>)
                            {
                                <a href="../../cmdlet.cs.html#e3346d70990a1763" class="i method">ThrowTerminatingError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r79 r">e</span>, <span class="s">&quot;InvalidPowerShellVersion&quot;</span>, <a href="../../ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../../ErrorPackage.cs.html#b5cba3d51f976bb3" class="i field">InvalidOperation</a>, <b>null</b>));
                            }
                            <b>catch</b> (<span class="i">FormatException</span> <span id="r80 rd" class="r80 r">e</span>)
                            {
                                <a href="../../cmdlet.cs.html#e3346d70990a1763" class="i method">ThrowTerminatingError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r80 r">e</span>, <span class="s">&quot;InvalidPowerShellVersion&quot;</span>, <a href="../../ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../../ErrorPackage.cs.html#b5cba3d51f976bb3" class="i field">InvalidOperation</a>, <b>null</b>));
                            }
                            <b>catch</b> (<span class="i">OverflowException</span> <span id="r81 rd" class="r81 r">e</span>)
                            {
                                <a href="../../cmdlet.cs.html#e3346d70990a1763" class="i method">ThrowTerminatingError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r81 r">e</span>, <span class="s">&quot;InvalidPowerShellVersion&quot;</span>, <a href="../../ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../../ErrorPackage.cs.html#b5cba3d51f976bb3" class="i field">InvalidOperation</a>, <b>null</b>));
                            }
                        }
                    }
 
                    <b>if</b> (<span class="r69 r">configTable</span>.<span class="i">ContainsKey</span>(<a href="../fanin/InitialSessionStateProvider.cs.html#b1e495f9b52fbd4a" class="t t">ConfigFileConstants</a>.<a href="../fanin/InitialSessionStateProvider.cs.html#6113c4097d4973ff" class="i field">RunAsVirtualAccount</a>))
                    {
                        <a href="#091dc53780f2780a" class="k">this</a>.<a href="#4dcf2ffea1a67e82" class="i property">RunAsVirtualAccount</a> = <a href="../../LanguagePrimitives.cs.html#6dac09d64da9900c" class="t t">LanguagePrimitives</a>.<span class="i">ConvertTo</span>&lt;<b>bool</b>&gt;(<span class="r69 r">configTable</span>[<a href="../fanin/InitialSessionStateProvider.cs.html#b1e495f9b52fbd4a" class="t t">ConfigFileConstants</a>.<a href="../fanin/InitialSessionStateProvider.cs.html#6113c4097d4973ff" class="i field">RunAsVirtualAccount</a>]);
                        <a href="#091dc53780f2780a" class="k">this</a>.<a href="#73a5a75f7a76f61d" class="i property">RunAsVirtualAccountSpecified</a> = <b>true</b>;
                    }
 
                    <b>if</b> (<span class="r69 r">configTable</span>.<span class="i">ContainsKey</span>(<a href="../fanin/InitialSessionStateProvider.cs.html#b1e495f9b52fbd4a" class="t t">ConfigFileConstants</a>.<a href="../fanin/InitialSessionStateProvider.cs.html#e724519e3a7dcc96" class="i field">RunAsVirtualAccountGroups</a>))
                    {
                        <a href="#091dc53780f2780a" class="k">this</a>.<a href="#2d1b945158ed0b9a" class="i property">RunAsVirtualAccountGroups</a> = <a href="#2111ec231989f662" class="t t">PSSessionConfigurationCommandUtilities</a>.<a href="#211ab6774bd12485" class="i method">GetRunAsVirtualAccountGroupsString</a>(
                            <a href="../fanin/InitialSessionStateProvider.cs.html#fc3ecbf6d041a5ca" class="t t">DISCPowerShellConfiguration</a>.<span class="i">TryGetStringArray</span>(<span class="r69 r">configTable</span>[<a href="../fanin/InitialSessionStateProvider.cs.html#b1e495f9b52fbd4a" class="t t">ConfigFileConstants</a>.<a href="../fanin/InitialSessionStateProvider.cs.html#e724519e3a7dcc96" class="i field">RunAsVirtualAccountGroups</a>]));
                    }
 
                    <b>if</b> (<span class="r69 r">configTable</span>.<span class="i">ContainsKey</span>(<a href="../fanin/InitialSessionStateProvider.cs.html#b1e495f9b52fbd4a" class="t t">ConfigFileConstants</a>.<a href="../fanin/InitialSessionStateProvider.cs.html#8b4e61e9c62fdd9b" class="i field">GMSAAccount</a>))
                    {
                        <a href="#54bdf072b712f095" class="i field">_gmsaAccount</a> = <span class="r69 r">configTable</span>[<a href="../fanin/InitialSessionStateProvider.cs.html#b1e495f9b52fbd4a" class="t t">ConfigFileConstants</a>.<a href="../fanin/InitialSessionStateProvider.cs.html#8b4e61e9c62fdd9b" class="i field">GMSAAccount</a>] <b>as string</b>;
                    }
 
                    <span class="c">// Get role account and group restriction SDDL from configuration table, if any.</span>
                    <a href="../../ErrorPackage.cs.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r82 rd" class="r82 r">error</span>;
                    <a href="#263a828153be5001" class="i field">_configTableSDDL</a> = <a href="#2111ec231989f662" class="t t">PSSessionConfigurationCommandUtilities</a>.<a href="#ac0adb98102375ba" class="i method">ComputeSDDLFromConfiguration</a>(
                        <span class="r69 r">configTable</span>,
                        <a href="#66d32f1366ccb752" class="i property">AccessMode</a>,
                        <b>out</b> <span class="r82 r">error</span>);
                    <b>if</b> (<span class="r82 r">error</span> != <b>null</b>)
                    {
                        <a href="../../cmdlet.cs.html#7746d1a8f41a36d5" class="i method">WriteError</a>(<span class="r82 r">error</span>);
                    }
 
                    <span class="c">// Update default Sddl with any group membership requirements.</span>
                    <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<a href="#263a828153be5001" class="i field">_configTableSDDL</a>) &amp;&amp; !<a href="#091dc53780f2780a" class="k">this</a>.<a href="#ea050dfcef60d743" class="i field">isSddlSpecified</a> &amp;&amp; !<b>string</b>.<span class="i">IsNullOrEmpty</span>(<a href="#e47691b9a35b161f" class="i field">sddl</a>))
                    {
                        <b>string</b> <span id="r83 rd" class="r83 r">configGroupMemberShipACE</span> = <a href="#2111ec231989f662" class="t t">PSSessionConfigurationCommandUtilities</a>.<a href="#1c46fc11bc8d31a2" class="i method">CreateConditionalACEFromConfig</a>(<span class="r69 r">configTable</span>);
                        <b>if</b> (!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r83 r">configGroupMemberShipACE</span>))
                        {
                            <a href="#e47691b9a35b161f" class="i field">sddl</a> = <a href="#2111ec231989f662" class="t t">PSSessionConfigurationCommandUtilities</a>.<a href="#dfdd360647794326" class="i method">UpdateSDDLUsersWithGroupConditional</a>(<a href="#e47691b9a35b161f" class="i field">sddl</a>, <span class="r83 r">configGroupMemberShipACE</span>);
                        }
                    }
 
                    <b>try</b>
                    {
                        <a href="../fanin/InitialSessionStateProvider.cs.html#78aacc47ea72f6a8" class="t t">DISCUtils</a>.<a href="../fanin/InitialSessionStateProvider.cs.html#564cb67b7d252b9d" class="i method">ValidateAbsolutePaths</a>(<a href="../../CommandBase.cs.html#5078d443148de142" class="i property">SessionState</a>, <span class="r69 r">configTable</span>, <a href="#7f0833e245fe41bc" class="i property">Path</a>);
                    }
                    <b>catch</b> (<span class="i">InvalidOperationException</span> <span id="r84 rd" class="r84 r">e</span>)
                    {
                        <a href="../../cmdlet.cs.html#e3346d70990a1763" class="i method">ThrowTerminatingError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r84 r">e</span>, <span class="s">&quot;RelativePathsNotSupported&quot;</span>, <a href="../../ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../../ErrorPackage.cs.html#b5cba3d51f976bb3" class="i field">InvalidOperation</a>, <b>null</b>));
                    }
 
                    <b>try</b>
                    {
                        <a href="../fanin/InitialSessionStateProvider.cs.html#78aacc47ea72f6a8" class="t t">DISCUtils</a>.<a href="../fanin/InitialSessionStateProvider.cs.html#26973397c620559d" class="i method">ValidateExtensions</a>(<span class="r69 r">configTable</span>, <a href="#7f0833e245fe41bc" class="i property">Path</a>);
                    }
                    <b>catch</b> (<span class="i">InvalidOperationException</span> <span id="r85 rd" class="r85 r">e</span>)
                    {
                        <a href="../../cmdlet.cs.html#e3346d70990a1763" class="i method">ThrowTerminatingError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r85 r">e</span>, <span class="s">&quot;FileExtensionNotSupported&quot;</span>, <a href="../../ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../../ErrorPackage.cs.html#b5cba3d51f976bb3" class="i field">InvalidOperation</a>, <b>null</b>));
                    }
                }
 
                <b>string</b> <span id="r86 rd" class="r86 r">destFolder</span> = <span class="i n">System</span>.<span class="i">IO</span>.<span class="i">Path</span>.<span class="i">Combine</span>(<a href="../../Utils.cs.html#9185d6ecbaebbec0" class="t t">Utils</a>.<a href="../../Utils.cs.html#c677cc800603f8f5" class="i property">DefaultPowerShellAppBase</a>, <span class="s">&quot;SessionConfig&quot;</span>);
                <b>if</b> (!<span class="i">Directory</span>.<span class="i">Exists</span>(<span class="r86 r">destFolder</span>))
                {
                    <span class="i">Directory</span>.<span class="i">CreateDirectory</span>(<span class="r86 r">destFolder</span>);
                }
 
                <b>string</b> <span id="r87 rd" class="r87 r">destPath</span> = <span class="i n">System</span>.<span class="i">IO</span>.<span class="i">Path</span>.<span class="i">Combine</span>(<span class="r86 r">destFolder</span>,
                    <a href="#50e45ca03ff16b28" class="i field">shellName</a> + <span class="s">&quot;_&quot;</span> + <span class="r66 r">sessionGuid</span>.<span class="i">ToString</span>() + <a href="../../SessionStateStrings.cs.html#55ee11e42c7cf459" class="t t">StringLiterals</a>.<a href="../../SessionStateStrings.cs.html#f547328079c2f2df" class="i field">PowerShellDISCFileExtension</a>);
                <b>if</b> (<b>string</b>.<span class="i">Equals</span>(<a href="#e6b634da33f87c0e" class="i property">ProcessorArchitecture</a>, <span class="s">&quot;x86&quot;</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
                {
                    <b>string</b> <span id="r88 rd" class="r88 r">procArch</span> = <span class="i">Environment</span>.<span class="i">GetEnvironmentVariable</span>(<span class="s">&quot;PROCESSOR_ARCHITECTURE&quot;</span>);
 
                    <b>if</b> (<b>string</b>.<span class="i">Equals</span>(<span class="r88 r">procArch</span>, <span class="s">&quot;amd64&quot;</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>) ||
                        <b>string</b>.<span class="i">Equals</span>(<span class="r88 r">procArch</span>, <span class="s">&quot;ia64&quot;</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
                    {
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">CORECLR</span>
                        <span class="i">InvalidOperationException</span> <span id="r89 rd" class="r89 r">ioe</span> = <b>new</b> <span class="i">InvalidOperationException</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">InvalidProcessorArchitecture</span>);
                        <a href="../../ErrorPackage.cs.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r90 rd" class="r90 r">er</span> = <b>new</b> <span class="t">ErrorRecord</span>(<span class="r89 r">ioe</span>, <span class="s">&quot;InvalidProcessorArchitecture&quot;</span>, <a href="../../ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../../ErrorPackage.cs.html#846d2b572f2c4820" class="i field">InvalidArgument</a>, <a href="#7f0833e245fe41bc" class="i property">Path</a>);
                        <a href="../../cmdlet.cs.html#e3346d70990a1763" class="i method">ThrowTerminatingError</a>(<span class="r90 r">er</span>);
<span class="k preprocess">#</span><span class="k preprocess">else</span>
<span class="e">                        // syswow64 is applicable only on 64 bit platforms.
                        destPath = destPath.ToLowerInvariant().Replace(&quot;\\system32\\&quot;, &quot;\\syswow64\\&quot;);
</span><span class="k preprocess">#</span><span class="k preprocess">endif</span>
                    }
                }
 
                <span class="c">// Return configuration file path names for later copy operation, if needed.</span>
                <span class="c">// We need to copy the file again if after running Register-PSSessionConfiguration</span>
                <span class="c">// removes the file which can happen if the endpoint already exists.</span>
                <span class="r56 r">srcConfigFilePath</span> = <span class="r62 r">filePath</span>;
                <span class="r57 r">destConfigFilePath</span> = <span class="r87 r">destPath</span>;
 
                <span class="c">// Copy File.</span>
                <b>string</b> <span id="r91 rd" class="r91 r">destConfigFileDirectory</span> = <span class="i n">System</span>.<span class="i">IO</span>.<span class="i">Path</span>.<span class="i">GetDirectoryName</span>(<span class="r57 r">destConfigFilePath</span>);
 
                <span class="c">// The directory is not auto-created for PowerShell.</span>
                <span class="c">// The call will create it or return its path if it already exists</span>
                <span class="i n">System</span>.<span class="i">IO</span>.<span class="i">Directory</span>.<span class="i">CreateDirectory</span>(<span class="r91 r">destConfigFileDirectory</span>);
 
                <span class="i">File</span>.<span class="i">Copy</span>(<span class="r56 r">srcConfigFilePath</span>, <span class="r57 r">destConfigFilePath</span>, <b>true</b>);
 
                <span class="r58 r">initParameters</span>.<span class="i">Append</span>(<b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>,
                    <a href="#599324379f68eb37" class="i field">initParamFormat</a>,
                    <a href="../fanin/InitialSessionStateProvider.cs.html#88c11924f622f7f5" class="t t">ConfigurationDataFromXML</a>.<a href="../fanin/InitialSessionStateProvider.cs.html#b483de7d25f4258e" class="i field">CONFIGFILEPATH_CamelCase</a>,
                    <span class="r87 r">destPath</span>,
                    <span class="i">Environment</span>.<span class="i">NewLine</span>));
            }
 
            <b>if</b> (!<span class="r59 r">assemblyAndTypeTokensSet</span>)
            {
                <b>if</b> (!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<a href="#074874d626401161" class="i field">configurationTypeName</a>))
                {
                    <span class="r58 r">initParameters</span>.<span class="i">Append</span>(<b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>,
                        <a href="#599324379f68eb37" class="i field">initParamFormat</a>,
                        <a href="../fanin/InitialSessionStateProvider.cs.html#88c11924f622f7f5" class="t t">ConfigurationDataFromXML</a>.<a href="../fanin/InitialSessionStateProvider.cs.html#5b4979d69407d7e3" class="i field">SHELLCONFIGTYPETOKEN</a>,
                        <a href="#074874d626401161" class="i field">configurationTypeName</a>,
                        <span class="i">Environment</span>.<span class="i">NewLine</span>));
                }
 
                <b>if</b> (!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<a href="#027266a61924c685" class="i field">assemblyName</a>))
                {
                    <span class="r58 r">initParameters</span>.<span class="i">Append</span>(<b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>,
                        <a href="#599324379f68eb37" class="i field">initParamFormat</a>,
                        <a href="../fanin/InitialSessionStateProvider.cs.html#88c11924f622f7f5" class="t t">ConfigurationDataFromXML</a>.<a href="../fanin/InitialSessionStateProvider.cs.html#a760798ff3d1d31c" class="i field">ASSEMBLYTOKEN</a>,
                        <a href="#027266a61924c685" class="i field">assemblyName</a>,
                        <span class="i">Environment</span>.<span class="i">NewLine</span>));
                }
            }
 
            <b>if</b> (!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<a href="#a175420dee4e8b20" class="i field">applicationBase</a>))
            {
                <span class="r58 r">initParameters</span>.<span class="i">Append</span>(<b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>,
                    <a href="#599324379f68eb37" class="i field">initParamFormat</a>,
                    <a href="../fanin/InitialSessionStateProvider.cs.html#88c11924f622f7f5" class="t t">ConfigurationDataFromXML</a>.<a href="../fanin/InitialSessionStateProvider.cs.html#c6bdad55d5b9cfe9" class="i field">APPBASETOKEN</a>,
                    <a href="#a175420dee4e8b20" class="i field">applicationBase</a>,
                    <span class="i">Environment</span>.<span class="i">NewLine</span>));
            }
 
            <b>if</b> (!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<a href="#fb73a00555a3f409" class="i field">configurationScript</a>))
            {
                <span class="r58 r">initParameters</span>.<span class="i">Append</span>(<b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>,
                    <a href="#599324379f68eb37" class="i field">initParamFormat</a>,
                    <a href="../fanin/InitialSessionStateProvider.cs.html#88c11924f622f7f5" class="t t">ConfigurationDataFromXML</a>.<a href="../fanin/InitialSessionStateProvider.cs.html#a5044dd5ccc8fb43" class="i field">STARTUPSCRIPTTOKEN</a>,
                    <a href="#fb73a00555a3f409" class="i field">configurationScript</a>,
                    <span class="i">Environment</span>.<span class="i">NewLine</span>));
            }
 
            <b>if</b> (<a href="#da4464aa9e583b35" class="i field">maxCommandSizeMB</a>.<span class="i">HasValue</span>)
            {
                <span class="r58 r">initParameters</span>.<span class="i">Append</span>(<b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>,
                    <a href="#599324379f68eb37" class="i field">initParamFormat</a>,
                    <a href="../fanin/InitialSessionStateProvider.cs.html#88c11924f622f7f5" class="t t">ConfigurationDataFromXML</a>.<a href="../fanin/InitialSessionStateProvider.cs.html#1f07f200d8e7326a" class="i field">MAXRCVDCMDSIZETOKEN</a>,
                    <a href="#da4464aa9e583b35" class="i field">maxCommandSizeMB</a>.<span class="i">Value</span>,
                    <span class="i">Environment</span>.<span class="i">NewLine</span>));
            }
 
            <b>if</b> (<a href="#37570a27dc4089f7" class="i field">maxObjectSizeMB</a>.<span class="i">HasValue</span>)
            {
                <span class="r58 r">initParameters</span>.<span class="i">Append</span>(<b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>,
                    <a href="#599324379f68eb37" class="i field">initParamFormat</a>,
                    <a href="../fanin/InitialSessionStateProvider.cs.html#88c11924f622f7f5" class="t t">ConfigurationDataFromXML</a>.<a href="../fanin/InitialSessionStateProvider.cs.html#10b5800d17b0f40c" class="i field">MAXRCVDOBJSIZETOKEN</a>,
                    <a href="#37570a27dc4089f7" class="i field">maxObjectSizeMB</a>.<span class="i">Value</span>,
                    <span class="i">Environment</span>.<span class="i">NewLine</span>));
            }
 
            <b>if</b> (<a href="#cef28738a403d686" class="i field">threadAptState</a>.<span class="i">HasValue</span>)
            {
                <span class="r58 r">initParameters</span>.<span class="i">Append</span>(<b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>,
                    <a href="#599324379f68eb37" class="i field">initParamFormat</a>,
                    <a href="../fanin/InitialSessionStateProvider.cs.html#88c11924f622f7f5" class="t t">ConfigurationDataFromXML</a>.<a href="../fanin/InitialSessionStateProvider.cs.html#49974ff8bb3d2d73" class="i field">THREADAPTSTATETOKEN</a>,
                    <a href="#cef28738a403d686" class="i field">threadAptState</a>.<span class="i">Value</span>,
                    <span class="i">Environment</span>.<span class="i">NewLine</span>));
            }
 
            <b>if</b> (<a href="#c123bdda35248dcf" class="i field">threadOptions</a>.<span class="i">HasValue</span>)
            {
                <span class="r58 r">initParameters</span>.<span class="i">Append</span>(<b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>,
                    <a href="#599324379f68eb37" class="i field">initParamFormat</a>,
                    <a href="../fanin/InitialSessionStateProvider.cs.html#88c11924f622f7f5" class="t t">ConfigurationDataFromXML</a>.<a href="../fanin/InitialSessionStateProvider.cs.html#cd5d7a116ed4a287" class="i field">THREADOPTIONSTOKEN</a>,
                    <a href="#c123bdda35248dcf" class="i field">threadOptions</a>.<span class="i">Value</span>,
                    <span class="i">Environment</span>.<span class="i">NewLine</span>));
            }
 
            <span class="c">// Default value for PSVersion</span>
            <b>if</b> (!<a href="#461be9a9e6b577d5" class="i field">isPSVersionSpecified</a>)
            {
                <a href="#9a883983f56cfb3d" class="i field">psVersion</a> = <a href="../../PSVersionInfo.cs.html#be287f9ea52b8d2f" class="t t">PSVersionInfo</a>.<a href="../../PSVersionInfo.cs.html#ad63365ac7690eeb" class="i property">PSVersion</a>;
            }
 
            <b>if</b> (<a href="#9a883983f56cfb3d" class="i field">psVersion</a> != <b>null</b>)
            {
                <span class="r58 r">initParameters</span>.<span class="i">Append</span>(<b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>,
                    <a href="#599324379f68eb37" class="i field">initParamFormat</a>,
                    <a href="../fanin/InitialSessionStateProvider.cs.html#88c11924f622f7f5" class="t t">ConfigurationDataFromXML</a>.<a href="../fanin/InitialSessionStateProvider.cs.html#cfdd5431fae23a53" class="i field">PSVERSIONTOKEN</a>,
                    <a href="#2111ec231989f662" class="t t">PSSessionConfigurationCommandUtilities</a>.<a href="#aab93b7be731e2b8" class="i method">ConstructVersionFormatForConfigXml</a>(<a href="#9a883983f56cfb3d" class="i field">psVersion</a>),
                    <span class="i">Environment</span>.<span class="i">NewLine</span>));
 
                <span class="c">// Calculate MaxPSVersion from PSVersion</span>
                <a href="#21f5de889788ab87" class="i field">MaxPSVersion</a> = <a href="#2111ec231989f662" class="t t">PSSessionConfigurationCommandUtilities</a>.<a href="#40e55d810510e76a" class="i method">CalculateMaxPSVersion</a>(<a href="#9a883983f56cfb3d" class="i field">psVersion</a>);
 
                <b>if</b> (<a href="#21f5de889788ab87" class="i field">MaxPSVersion</a> != <b>null</b>)
                {
                    <span class="r58 r">initParameters</span>.<span class="i">Append</span>(<b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>,
                        <a href="#599324379f68eb37" class="i field">initParamFormat</a>,
                        <a href="../fanin/InitialSessionStateProvider.cs.html#88c11924f622f7f5" class="t t">ConfigurationDataFromXML</a>.<a href="../fanin/InitialSessionStateProvider.cs.html#875775f1b987cd71" class="i field">MAXPSVERSIONTOKEN</a>,
                        <a href="#2111ec231989f662" class="t t">PSSessionConfigurationCommandUtilities</a>.<a href="#aab93b7be731e2b8" class="i method">ConstructVersionFormatForConfigXml</a>(<a href="#21f5de889788ab87" class="i field">MaxPSVersion</a>),
                        <span class="i">Environment</span>.<span class="i">NewLine</span>));
                }
            }
 
            <b>string</b> <span id="r92 rd" class="r92 r">securityParameters</span> = <b>string</b>.<span class="i">Empty</span>;
            <b>if</b> (!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<a href="#e47691b9a35b161f" class="i field">sddl</a>))
            {
                <span class="r92 r">securityParameters</span> = <b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>,
                    <a href="#fa2e8e7ba3101f87" class="i field">securityElementFormat</a>,
                    <a href="../fanin/WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="../fanin/WSManNativeAPI.cs.html#f383edcf61712f90" class="i field">ResourceURIPrefix</a> + <a href="#50e45ca03ff16b28" class="i field">shellName</a>,
                    <span class="i">SecurityElement</span>.<span class="i">Escape</span>(<a href="#e47691b9a35b161f" class="i field">sddl</a>));
            }
 
            <b>string</b> <span id="r93 rd" class="r93 r">architectureParameter</span> = <b>string</b>.<span class="i">Empty</span>;
            <b>if</b> (!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<a href="#e6b634da33f87c0e" class="i property">ProcessorArchitecture</a>))
            {
                <b>string</b> <span id="r94 rd" class="r94 r">tempValue</span> = <span class="s">&quot;32&quot;</span>;
                <b>switch</b> (<a href="#e6b634da33f87c0e" class="i property">ProcessorArchitecture</a>.<span class="i">ToLowerInvariant</span>())
                {
                    <b>case</b> <span class="s">&quot;x86&quot;</span>:
                        <span class="r94 r">tempValue</span> = <span class="s">&quot;32&quot;</span>;
                        <b>break</b>;
                    <b>case</b> <span class="s">&quot;amd64&quot;</span>:
                        <span class="r94 r">tempValue</span> = <span class="s">&quot;64&quot;</span>;
                        <b>break</b>;
                }
 
                <span class="r93 r">architectureParameter</span> = <b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>,
                    <a href="#4f25328228011ad2" class="i field">architectureAttribFormat</a>,
                    <span class="r94 r">tempValue</span>);
            }
 
            <b>string</b> <span id="r95 rd" class="r95 r">sharedHostParameter</span> = <b>string</b>.<span class="i">Empty</span>;
            <b>if</b> (<a href="#8534b4735dcf261a" class="i field">isUseSharedProcessSpecified</a>)
            {
                <span class="r95 r">sharedHostParameter</span> = <b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>,
                    <a href="#d348fc315cd3ca4d" class="i field">sharedHostAttribFormat</a>, <a href="#50cd764b2f18a757" class="i property">UseSharedProcess</a>.<a href="../../MshCmdlet.cs.html#e9f970ac2bab9866" class="i method">ToString</a>()
                );
            }
 
            <b>string</b> <span id="r96 rd" class="r96 r">runAsVirtualAccountParameter</span> = <b>string</b>.<span class="i">Empty</span>;
            <b>string</b> <span id="r97 rd" class="r97 r">runAsVirtualAccountGroupsParameter</span> = <b>string</b>.<span class="i">Empty</span>;
            <b>if</b> (<a href="#4dcf2ffea1a67e82" class="i property">RunAsVirtualAccount</a>)
            {
                <span class="r96 r">runAsVirtualAccountParameter</span> = <b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>,
                    <a href="#69950c18d0c95162" class="i field">runasVirtualAccountAttribFormat</a>, <a href="#4dcf2ffea1a67e82" class="i property">RunAsVirtualAccount</a>.<span class="i">ToString</span>()
                );
 
                <span class="c">// Include virtual account groups if any.</span>
                <b>if</b> (!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<a href="#2d1b945158ed0b9a" class="i property">RunAsVirtualAccountGroups</a>))
                {
                    <span class="r97 r">runAsVirtualAccountGroupsParameter</span> = <b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>,
                        <a href="#f03b8bd54f6b5232" class="i field">runAsVirtualAccountGroupsAttribFormat</a>, <a href="#2d1b945158ed0b9a" class="i property">RunAsVirtualAccountGroups</a>);
                }
            }
 
            <b>string</b> <span id="r98 rd" class="r98 r">allowRemoteShellAccessParameter</span> = <b>string</b>.<span class="i">Empty</span>;
            <b>switch</b> (<a href="#66d32f1366ccb752" class="i property">AccessMode</a>)
            {
                <b>case</b> <a href="../common/RunspaceConnectionInfo.cs.html#10edf62c3f6a89b0" class="t t">PSSessionConfigurationAccessMode</a>.<a href="../common/RunspaceConnectionInfo.cs.html#43e3b9106e6c81f0" class="i field">Disabled</a>:
                    <span class="r98 r">allowRemoteShellAccessParameter</span> = <b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>,
                        <a href="#4992c1ef8a638b7d" class="i field">allowRemoteShellAccessFormat</a>, <b>false</b>.<span class="i">ToString</span>());
                    <b>break</b>;
                <b>case</b> <a href="../common/RunspaceConnectionInfo.cs.html#10edf62c3f6a89b0" class="t t">PSSessionConfigurationAccessMode</a>.<a href="../common/RunspaceConnectionInfo.cs.html#e493a77e156a2d8d" class="i field">Local</a>:
                <b>case</b> <a href="../common/RunspaceConnectionInfo.cs.html#10edf62c3f6a89b0" class="t t">PSSessionConfigurationAccessMode</a>.<a href="../common/RunspaceConnectionInfo.cs.html#f9938a92bb1a8e5f" class="i field">Remote</a>:
                    <span class="r98 r">allowRemoteShellAccessParameter</span> = <b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>,
                        <a href="#4992c1ef8a638b7d" class="i field">allowRemoteShellAccessFormat</a>, <b>true</b>.<span class="i">ToString</span>());
                    <b>break</b>;
            }
 
            <span class="i">StringBuilder</span> <span id="r99 rd" class="r99 r">sessionConfigurationData</span> = <b>new</b> <span class="i">StringBuilder</span>();
 
            <b>if</b> (<a href="#647dbedff4303e3b" class="i field">modulesToImport</a> != <b>null</b> &amp;&amp; <a href="#647dbedff4303e3b" class="i field">modulesToImport</a>.<span class="i">Length</span> &gt; 0)
            {
                <span class="r99 r">sessionConfigurationData</span>.<span class="i">Append</span>(<b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>,
                                                <a href="#599324379f68eb37" class="i field">initParamFormat</a>,
                                                <a href="../fanin/PSSessionConfigurationData.cs.html#a9929ed8e7a283e6" class="t t">PSSessionConfigurationData</a>.<a href="../fanin/PSSessionConfigurationData.cs.html#e473b0c22548cf0a" class="i field">ModulesToImportToken</a>,
                                                <a href="#2111ec231989f662" class="t t">PSSessionConfigurationCommandUtilities</a>.<a href="#73ff792c03cd5e50" class="i method">GetModulePathAsString</a>(<a href="#647dbedff4303e3b" class="i field">modulesToImport</a>),
                                                <b>string</b>.<span class="i">Empty</span>));
            }
 
            <b>if</b> (<a href="#f113546061e03199" class="i field">sessionTypeOption</a> != <b>null</b>)
            {
                <span class="c">// TODO: This should probably be a terminating exception for Win8</span>
                <b>string</b> <span id="r100 rd" class="r100 r">privateData</span> = <a href="#091dc53780f2780a" class="k">this</a>.<a href="#f113546061e03199" class="i field">sessionTypeOption</a>.<a href="../common/PSSessionConfigurationTypeOption.cs.html#d1ee5d6672578519" class="i method">ConstructPrivateData</a>();
                <b>if</b> (!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r100 r">privateData</span>))
                {
                    <span class="r99 r">sessionConfigurationData</span>.<span class="i">Append</span>(<b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>, <a href="#4de6e7c0d3f37533" class="i field">privateDataFormat</a>, <span class="r100 r">privateData</span>));
                }
            }
 
            <b>if</b> (<span class="r99 r">sessionConfigurationData</span>.<span class="i">Length</span> &gt; 0)
            {
                <b>string</b> <span id="r101 rd" class="r101 r">sessionConfigData</span> = <b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>,
                                                         <a href="#cacfc19fde4b23da" class="i field">SessionConfigDataFormat</a>,
                                                         <span class="r99 r">sessionConfigurationData</span>);
                <b>string</b> <span id="r102 rd" class="r102 r">encodedSessionConfigData</span> = <span class="i">SecurityElement</span>.<span class="i">Escape</span>(<span class="r101 r">sessionConfigData</span>);
                <span class="r58 r">initParameters</span>.<span class="i">Append</span>(<b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>,
                                                    <a href="#599324379f68eb37" class="i field">initParamFormat</a>,
                                                    <a href="../fanin/InitialSessionStateProvider.cs.html#88c11924f622f7f5" class="t t">ConfigurationDataFromXML</a>.<a href="../fanin/InitialSessionStateProvider.cs.html#9e1f1c9b78ebd9a5" class="i field">SESSIONCONFIGTOKEN</a>,
                                                    <span class="r102 r">encodedSessionConfigData</span>,
                                                    <b>string</b>.<span class="i">Empty</span>));
            }
 
            <b>if</b> (<a href="#47818cf18fb88e71" class="i field">transportOption</a> == <b>null</b>)
            {
                <a href="#47818cf18fb88e71" class="i field">transportOption</a> = <b>new</b> <a href="NewPSSessionConfigurationOptionCommand.cs.html#c7b39167dea33e0a" class="t constructor">WSManConfigurationOption</a>();
            }
            <b>else</b>
            {
                <a href="#47818cf18fb88e71" class="i field">transportOption</a> = <a href="#47818cf18fb88e71" class="i field">transportOption</a>.<a href="../common/PSSessionConfigurationTypeOption.cs.html#344b378034a584e8" class="i method">Clone</a>() <b>as</b> <a href="../common/PSSessionConfigurationTypeOption.cs.html#4b3c3be23aa5f156" class="t t">PSTransportOption</a>;
            }
 
            <a href="#47818cf18fb88e71" class="i field">transportOption</a>.<a href="../common/PSSessionConfigurationTypeOption.cs.html#84a22d7a07d08969" class="i method">LoadFromDefaults</a>(<b>true</b>);
 
            <span class="c">// If useSharedHost is set to false, we need to set hostIdleTimeout to 0 as well, else WS-Man throws error</span>
            <b>if</b> (<a href="#8534b4735dcf261a" class="i field">isUseSharedProcessSpecified</a> &amp;&amp; !<a href="#50cd764b2f18a757" class="i property">UseSharedProcess</a>)
            {
                (<a href="#47818cf18fb88e71" class="i field">transportOption</a> <b>as</b> <a href="NewPSSessionConfigurationOptionCommand.cs.html#d843a286698df072" class="t t">WSManConfigurationOption</a>).<a href="NewPSSessionConfigurationOptionCommand.cs.html#25776535d7a98613" class="i property">ProcessIdleTimeoutSec</a> = 0;
            }
 
            <b>string</b> <span id="r103 rd" class="r103 r">psPluginDllPath</span> = <a href="#2111ec231989f662" class="t t">PSSessionConfigurationCommandUtilities</a>.<a href="#5f8d86f0f38b335b" class="i method">GetWinrmPluginDllPath</a>();
 
            <b>string</b> <span id="r104 rd" class="r104 r">result</span> = <b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>,
                <a href="#65b373a8095f4d69" class="i field">pluginXmlFormat</a>,
                <a href="#50e45ca03ff16b28" class="i field">shellName</a>, <span class="c">/* {0} */</span>
                <span class="r103 r">psPluginDllPath</span>, <span class="c">/* {1} */</span>
                <span class="r93 r">architectureParameter</span>, <span class="c">/* {2} */</span>
                <span class="r58 r">initParameters</span>.<span class="i">ToString</span>(), <span class="c">/* {3} */</span>
                <a href="../fanin/WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="../fanin/WSManNativeAPI.cs.html#f383edcf61712f90" class="i field">ResourceURIPrefix</a> + <a href="#50e45ca03ff16b28" class="i field">shellName</a>, <span class="c">/* {4} */</span>
                <span class="r92 r">securityParameters</span>, <span class="c">/* {5} */</span>
                <span class="r95 r">sharedHostParameter</span>, <span class="c">/* {6} */</span>
                <span class="r96 r">runAsVirtualAccountParameter</span>, <span class="c">/* {7} */</span>
                <span class="r97 r">runAsVirtualAccountGroupsParameter</span>, <span class="c">/* {8} */</span>
                <span class="r98 r">allowRemoteShellAccessParameter</span>, <span class="c">/* {9} */</span>
                <a href="#47818cf18fb88e71" class="i field">transportOption</a>.<a href="../common/PSSessionConfigurationTypeOption.cs.html#c4c869bc7228ea9c" class="i method">ConstructOptionsAsXmlAttributes</a>(), <span class="c">/* {10} */</span>
                <a href="#47818cf18fb88e71" class="i field">transportOption</a>.<a href="../common/PSSessionConfigurationTypeOption.cs.html#f6e164cc208eac9b" class="i method">ConstructQuotas</a>(), <span class="c">/* {11} */</span>
                (<a href="#9a883983f56cfb3d" class="i field">psVersion</a>.<span class="i">Major</span> &lt; 3) ? 1 : 2 <span class="c">/* {12} - Pass in SDK version. */</span>
            );
 
            <b>return</b> <span class="r104 r">result</span>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
    }
 
    <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Register-PSSessionConfiguration cmdlet
 
    <span class="k preprocess">#</span><span class="k preprocess">region</span> Utils
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Utilities for Custom shell commands.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>internal static class</b> <a id="2111ec231989f662" href="../../../R/2111ec231989f662.html" target="n" data-glyph="2,0" class="t t">PSSessionConfigurationCommandUtilities</a>
    {
        <b>internal const string</b> <a id="c7c6e2ea31306f08" href="../../../R/c7c6e2ea31306f08.html" target="n" data-glyph="8,1" class="i field">restartWSManFormat</a> = <span class="s">&quot;restart-service winrm -force -confirm:$false&quot;</span>;
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Internal Methods/Properties
 
        <b>internal const string</b> <a id="a3aefbc67c6d00d3" href="../../../R/a3aefbc67c6d00d3.html" target="n" data-glyph="8,1" class="i field">PSCustomShellTypeName</a> = <span class="s">&quot;Microsoft.PowerShell.Commands.PSSessionConfigurationCommands#PSSessionConfiguration&quot;</span>;
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Run script to restart the WinRM service. The script will write</span>
        <span class="c">///</span><span class="c"> output and error into the cmdlets streams.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r105 r">cmdlet</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Cmdlet&#39;s context in which the restart-service script is run.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r106 r">isErrorReported</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> if true, then this method is a no-op.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r107 r">force</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> if true, then the user will not be prompted.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r108 r">noServiceRestart</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> if true, we dont attempt to restart winrm service ie. this will be a no-op.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal static void</b> <a id="ba59a730ba64c719" href="../../../R/ba59a730ba64c719.html" target="n" data-glyph="74,1" class="i method">RestartWinRMService</a>(<a href="../../../P/30543a6971fed1fc.html#30543a6971fed1fc" class="t t">PSCmdlet</a> <span id="r105 rd" class="r105 r">cmdlet</span>, <b>bool</b> <span id="r106 rd" class="r106 r">isErrorReported</span>, <b>bool</b> <span id="r107 rd" class="r107 r">force</span>, <b>bool</b> <span id="r108 rd" class="r108 r">noServiceRestart</span>)
        {
            <span class="c">// restart the service only if there is no error running WSMan config command</span>
            <b>if</b> (!(<span class="r106 r">isErrorReported</span> || <span class="r108 r">noServiceRestart</span>))
            {
                <span class="c">// restart-service winrm to make the changes effective.</span>
                <b>string</b> <span id="r109 rd" class="r109 r">restartServiceAction</span> = <span class="i">RemotingErrorIdStrings</span>.<span class="i">RestartWSManServiceAction</span>;
                <b>string</b> <span id="r110 rd" class="r110 r">restartServiceTarget</span> = <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">RestartWSManServiceTarget</span>, <span class="s">&quot;WinRM&quot;</span>);
 
                <b>if</b> (<span class="r107 r">force</span> || <span class="r105 r">cmdlet</span>.<a href="../../cmdlet.cs.html#5f125d2ab6d0970d" class="i method">ShouldProcess</a>(<span class="r110 r">restartServiceTarget</span>, <span class="r109 r">restartServiceAction</span>))
                {
                    <span class="r105 r">cmdlet</span>.<a href="../../cmdlet.cs.html#377660744c64cd7e" class="i method">WriteVerbose</a>(<a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">RestartWSManServiceMessageV</span>));
 
                    <a href="../../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="t t">ScriptBlock</a> <span id="r111 rd" class="r111 r">restartServiceScript</span> = <span class="r105 r">cmdlet</span>.<a href="../../MshCmdlet.cs.html#515d359906da8f3d" class="i property">InvokeCommand</a>.<a href="../../MshCmdlet.cs.html#ac0cb14e542420b6" class="i method">NewScriptBlock</a>(<a href="#c7c6e2ea31306f08" class="i field">restartWSManFormat</a>);
                    <b>var</b> <span id="r112 rd" class="r112 r">emptyArray</span> = <span class="i">Array</span>.<span class="i">Empty</span>&lt;<b>object</b>&gt;();
                    <span class="r111 r">restartServiceScript</span>.<span class="i">InvokeUsingCmdlet</span>(
                        <span class="i">contextCmdlet</span>: <span class="r105 r">cmdlet</span>,
                        <span class="i">useLocalScope</span>: <b>true</b>,
                        <span class="i">errorHandlingBehavior</span>: <a href="../../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="t t">ScriptBlock</a>.<a href="../../lang/scriptblock.cs.html#10c045824f712272" class="t t">ErrorHandlingBehavior</a>.<a href="../../lang/scriptblock.cs.html#5e78734ffe1c6ed3" class="i field">WriteToCurrentErrorPipe</a>,
                        <span class="i">dollarUnder</span>: <a href="../../AutomationNull.cs.html#681fbea4c40e4af1" class="t t">AutomationNull</a>.<a href="../../AutomationNull.cs.html#1cf7e193da582896" class="i property">Value</a>,
                        <span class="i">input</span>: <span class="r112 r">emptyArray</span>,
                        <span class="i">scriptThis</span>: <a href="../../AutomationNull.cs.html#681fbea4c40e4af1" class="t t">AutomationNull</a>.<a href="../../AutomationNull.cs.html#1cf7e193da582896" class="i property">Value</a>,
                        <span class="i">args</span>: <span class="r112 r">emptyArray</span>);
                }
            }
        }
 
        <b>internal static void</b> <a id="35e6a21548384ea9" href="../../../R/35e6a21548384ea9.html" target="n" data-glyph="74,1" class="i method">MoveWinRmToIsolatedServiceHost</a>(<b>bool</b> <span id="r113 rd" class="r113 r">forVirtualAccount</span>)
        {
            <b>string</b> <span id="r114 rd" class="r114 r">moveScript</span> = <span class="s">&quot;sc.exe config winrm type= own&quot;</span>;
 
            <b>if</b> (<span class="r113 r">forVirtualAccount</span>)
            {
                <span class="r114 r">moveScript</span> += <span class="s">@&quot;
                    $requiredPrivileges = Get-ItemPropertyValue -Path HKLM:\SYSTEM\CurrentControlSet\Services\winrm -Name RequiredPrivileges
                    if($requiredPrivileges -notcontains &#39;SeTcbPrivilege&#39;)
                    {
                        $requiredPrivileges += @(&#39;SeTcbPrivilege&#39;)
                    }
 
                    Set-ItemProperty -Path HKLM:\SYSTEM\CurrentControlSet\Services\winrm -Name RequiredPrivileges -Value $requiredPrivileges
                    Set-ItemProperty -Path HKLM:\SYSTEM\CurrentControlSet\Services\winrm -Name ObjectName -Value &#39;LocalSystem&#39;&quot;</span>;
            }
 
            <b>using</b> (<span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="../../hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShell</a> <span id="r115 rd" class="r115 r">invoker</span> = <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="../../hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShell</a>.<a href="../../hostifaces/PowerShell.cs.html#1c6a51d3c837bb4d" class="i method">Create</a>(<a href="../../hostifaces/PowerShell.cs.html#c3c0f0e5e0b337ff" class="t t">RunspaceMode</a>.<a href="../../hostifaces/PowerShell.cs.html#75d224de5df87e75" class="i field">CurrentRunspace</a>))
            {
                <span class="r115 r">invoker</span>.<a href="../../hostifaces/PowerShell.cs.html#c97f8d15a2f93e31" class="i method">AddScript</a>(<span class="r114 r">moveScript</span>).<a href="../../hostifaces/PowerShell.cs.html#184e23c46120523e" class="i method">Invoke</a>();
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gathers WhatIf, Confirm parameter values from the cmdlet.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r116 r">cmdlet</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r117 r">whatIf</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r118 r">confirm</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal static void</b> <a id="62fe0a5dea8c58db" href="../../../R/62fe0a5dea8c58db.html" target="n" data-glyph="74,1" class="i method">CollectShouldProcessParameters</a>(<a href="../../../P/30543a6971fed1fc.html#30543a6971fed1fc" class="t t">PSCmdlet</a> <span id="r116 rd" class="r116 r">cmdlet</span>, <b>out bool</b> <span id="r117 rd" class="r117 r">whatIf</span>, <b>out bool</b> <span id="r118 rd" class="r118 r">confirm</span>)
        {
            <span class="c">// gather -WhatIf, -Confirm parameter data and pass it to the script block</span>
            <span class="r117 r">whatIf</span> = <b>false</b>;
            <span class="c">// confirm is always true to start with</span>
            <span class="r118 r">confirm</span> = <b>false</b>;
            <a href="../../MshCommandRuntime.cs.html#f9ebe6a3b284ab55" class="t t">MshCommandRuntime</a> <span id="r119 rd" class="r119 r">cmdRuntime</span> = <span class="r116 r">cmdlet</span>.<a href="../../cmdlet.cs.html#fa3830ca3ad4b256" class="i property">CommandRuntime</a> <b>as</b> <a href="../../MshCommandRuntime.cs.html#f9ebe6a3b284ab55" class="t t">MshCommandRuntime</a>;
            <b>if</b> (<span class="r119 r">cmdRuntime</span> != <b>null</b>)
            {
                <span class="r117 r">whatIf</span> = <span class="r119 r">cmdRuntime</span>.<a href="../../MshCommandRuntime.cs.html#bbd763fc28e57d9a" class="i property">WhatIf</a>;
                <span class="c">// take the value of confirm only if it is explicitly set by the user</span>
                <b>if</b> (<span class="r119 r">cmdRuntime</span>.<a href="../../MshCommandRuntime.cs.html#e98e9c7743290b43" class="i property">IsConfirmFlagSet</a>)
                {
                    <span class="r118 r">confirm</span> = <span class="r119 r">cmdRuntime</span>.<a href="../../MshCommandRuntime.cs.html#80b115f7d2831129" class="i property">Confirm</a>;
                }
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Checks if the current thread is running elevated. If not, throws an error.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">InvalidOperationException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> 1. Access is denied. You need to run this cmdlet from an elevated process.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>internal static void</b> <a id="e6567bb211cb1a98" href="../../../R/e6567bb211cb1a98.html" target="n" data-glyph="74,1" class="i method">ThrowIfNotAdministrator</a>()
        {
            <span class="i n">System</span>.<span class="i">Security</span>.<span class="i">Principal</span>.<span class="i">WindowsIdentity</span> <span id="r120 rd" class="r120 r">currentIdentity</span> = <span class="i n">System</span>.<span class="i">Security</span>.<span class="i">Principal</span>.<span class="i">WindowsIdentity</span>.<span class="i">GetCurrent</span>();
            <span class="i n">System</span>.<span class="i">Security</span>.<span class="i">Principal</span>.<span class="i">WindowsPrincipal</span> <span id="r121 rd" class="r121 r">principal</span> = <b>new</b> <span class="i n">System</span>.<span class="i">Security</span>.<span class="i">Principal</span>.<span class="i">WindowsPrincipal</span>(<span class="r120 r">currentIdentity</span>);
            <b>if</b> (!<span class="r121 r">principal</span>.<span class="i">IsInRole</span>(<span class="i n">System</span>.<span class="i">Security</span>.<span class="i">Principal</span>.<span class="i">WindowsBuiltInRole</span>.<span class="i">Administrator</span>))
            {
                <b>string</b> <span id="r122 rd" class="r122 r">message</span> = <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">EDcsRequiresElevation</span>);
                <b>throw</b> <b>new</b> <span class="i">InvalidOperationException</span>(<span class="r122 r">message</span>);
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Creates a Grouped Managed Service Account credential based on the passed in account name.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r123 r">gmsaAccount</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Group Managed Service Account name.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">PSCredential for GMS account.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">InvalidOperationException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Invalid account name.  Must be of form &#39;Domain\UserName&#39;.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>internal static</b> <a href="../../Credential.cs.html#6245dc122e2f1916" class="t t">PSCredential</a> <a id="5655deae904cb964" href="../../../R/5655deae904cb964.html" target="n" data-glyph="74,1" class="i method">CreateGMSAAccountCredentials</a>(<b>string</b> <span id="r123 rd" class="r123 r">gmsaAccount</span>)
        {
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<span class="i">Assert</span>(!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r123 r">gmsaAccount</span>), <span class="s">&quot;Should not be null or empty string.&quot;</span>);
 
            <span class="c">// Validate account name form (must be DomainName\UserName)</span>
            <b>var</b> <span id="r124 rd" class="r124 r">parts</span> = <span class="r123 r">gmsaAccount</span>.<span class="i">Split</span>(<a href="../../Utils.cs.html#9185d6ecbaebbec0" class="t t">Utils</a>.<a href="../../Utils.cs.html#6fd6d3492cb91f87" class="t t">Separators</a>.<a href="../../Utils.cs.html#247bb446a0dd1494" class="i field">Backslash</a>);
            <b>if</b> ((<span class="r124 r">parts</span>.<span class="i">Length</span> != 2) ||
                (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r124 r">parts</span>[0])) ||
                (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r124 r">parts</span>[1]))
               )
            {
                <b>throw</b> <b>new</b> <span class="i">InvalidOperationException</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">InvalidGMSAName</span>);
            }
 
            <span class="c">// Use the provided GMSA account name (Domain\UserName$) with empty password.</span>
            <b>string</b> <span id="r125 rd" class="r125 r">userName</span> = <span class="r123 r">gmsaAccount</span> + <span class="s">&quot;$&quot;</span>;
            <span class="i">SecureString</span> <span id="r126 rd" class="r126 r">password</span> = <b>new</b> <span class="i">SecureString</span>();
            <b>return</b> <b>new</b> <a href="../../Credential.cs.html#cddcf55c2817657f" class="t constructor">PSCredential</a>(<span class="r125 r">userName</span>, <span class="r126 r">password</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Calculates the MaxPSVersion in the config xml from psVersion.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r127 r">psVersion</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal static</b> <span class="i">Version</span> <a id="40e55d810510e76a" href="../../../R/40e55d810510e76a.html" target="n" data-glyph="74,1" class="i method">CalculateMaxPSVersion</a>(<span class="i">Version</span> <span id="r127 rd" class="r127 r">psVersion</span>)
        {
            <span class="i">Version</span> <span id="r128 rd" class="r128 r">maxPSVersion</span> = <b>null</b>;
            <b>if</b> (<span class="r127 r">psVersion</span> != <b>null</b> &amp;&amp; <span class="r127 r">psVersion</span>.<span class="i">Major</span> == 2)
            {
                <span class="r128 r">maxPSVersion</span> = <b>new</b> <span class="i">Version</span>(2, 0);
            }
 
            <b>return</b> <span class="r128 r">maxPSVersion</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Converts the module path represented in the string[] into a comma separated string.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal static string</b> <a id="73ff792c03cd5e50" href="../../../R/73ff792c03cd5e50.html" target="n" data-glyph="74,1" class="i method">GetModulePathAsString</a>(<b>object</b>[] <span id="r129 rd" class="r129 r">modulePath</span>)
        {
            <b>if</b> (<span class="r129 r">modulePath</span> != <b>null</b> &amp;&amp; <span class="r129 r">modulePath</span>.<span class="i">Length</span> &gt; 0)
            {
                <span class="i">StringBuilder</span> <span id="r130 rd" class="r130 r">sb</span> = <b>new</b> <span class="i">StringBuilder</span>();
                <b>foreach</b> (<b>object</b> <span id="r131 rd" class="r131 r">s</span> <b>in</b> <span class="r129 r">modulePath</span>)
                {
                    <b>var</b> <span id="r132 rd" class="r132 r">module</span> = <span class="r131 r">s</span> <b>as string</b>;
                    <b>if</b> (<span class="r132 r">module</span> != <b>null</b>)
                    {
                        <span class="r130 r">sb</span>.<span class="i">Append</span>(<span class="r131 r">s</span>);
                        <span class="r130 r">sb</span>.<span class="i">Append</span>(<span class="s">&#39;,&#39;</span>);
                    }
                    <b>else</b>
                    {
                        <a href="../../Modules/ModuleSpecification.cs.html#1fd961b021940b6a" class="k">var</a> <span id="r133 rd" class="r133 r">moduleSpec</span> = <span class="r131 r">s</span> <b>as</b> <a href="../../Modules/ModuleSpecification.cs.html#1fd961b021940b6a" class="t t">ModuleSpecification</a>;
                        <b>if</b> (<span class="r133 r">moduleSpec</span> != <b>null</b>)
                        {
                            <span class="c">// Double escaping on ModuleSpecification string is required to treat it as a single value along with module names/paths in SessionConfigurationData</span>
                            <span class="r130 r">sb</span>.<span class="i">Append</span>(<span class="i">SecurityElement</span>.<span class="i">Escape</span>(<span class="i">SecurityElement</span>.<span class="i">Escape</span>(<span class="r133 r">moduleSpec</span>.<a href="../../Modules/ModuleSpecification.cs.html#58661ffe9a4655b1" class="i method">ToString</a>())));
                            <span class="r130 r">sb</span>.<span class="i">Append</span>(<span class="s">&#39;,&#39;</span>);
                        }
                    }
                }
 
                <span class="r130 r">sb</span>.<span class="i">Remove</span>(<span class="r130 r">sb</span>.<span class="i">Length</span> - 1, 1);
                <b>return</b> <span class="r130 r">sb</span>.<span class="i">ToString</span>();
            }
 
            <b>return</b> <b>string</b>.<span class="i">Empty</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Converts the version number to the format &quot;Major.Minor&quot; which needs to be persisted in the config xml.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r134 r">psVersion</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal static</b> <span class="i">Version</span> <a id="aab93b7be731e2b8" href="../../../R/aab93b7be731e2b8.html" target="n" data-glyph="74,1" class="i method">ConstructVersionFormatForConfigXml</a>(<span class="i">Version</span> <span id="r134 rd" class="r134 r">psVersion</span>)
        {
            <span class="i">Version</span> <span id="r135 rd" class="r135 r">result</span> = <b>null</b>;
            <b>if</b> (<span class="r134 r">psVersion</span> != <b>null</b>)
            {
                <span class="r135 r">result</span> = <b>new</b> <span class="i">Version</span>(<span class="r134 r">psVersion</span>.<span class="i">Major</span>, <span class="r134 r">psVersion</span>.<span class="i">Minor</span>);
            }
 
            <b>return</b> <span class="r135 r">result</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Takes array of group name string objects and returns a semicolon delimited string.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r136 r">groups</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal static string</b> <a id="211ab6774bd12485" href="../../../R/211ab6774bd12485.html" target="n" data-glyph="74,1" class="i method">GetRunAsVirtualAccountGroupsString</a>(<b>string</b>[] <span id="r136 rd" class="r136 r">groups</span>)
        {
            <b>if</b> (<span class="r136 r">groups</span> == <b>null</b>) { <b>return</b> <b>string</b>.<span class="i">Empty</span>; }
 
            <b>return</b> <b>string</b>.<span class="i">Join</span>(<span class="s">&quot;;&quot;</span>, <span class="r136 r">groups</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Returns the default WinRM plugin shell name for this instance of PowerShell.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal static string</b> <a id="5feea7253cd275c1" href="../../../R/5feea7253cd275c1.html" target="n" data-glyph="74,1" class="i method">GetWinrmPluginShellName</a>()
        {
            <span class="c">// PowerShell uses a versioned directory to hold the plugin</span>
            <b>return</b> <b>string</b>.<span class="i">Concat</span>(<span class="s">&quot;PowerShell.&quot;</span>, <a href="../../PSVersionInfo.cs.html#be287f9ea52b8d2f" class="t t">PSVersionInfo</a>.<a href="../../PSVersionInfo.cs.html#624934150adfee0d" class="i property">GitCommitId</a>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Returns the default WinRM plugin DLL file path for this instance of PowerShell.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal static string</b> <a id="5f8d86f0f38b335b" href="../../../R/5f8d86f0f38b335b.html" target="n" data-glyph="74,1" class="i method">GetWinrmPluginDllPath</a>()
        {
            <span class="c">// PowerShell 6+ uses its versioned directory instead of system32</span>
            <b>string</b> <span id="r137 rd" class="r137 r">pluginDllDirectory</span> = <span class="i n">System</span>.<span class="i">IO</span>.<span class="i">Path</span>.<span class="i">Combine</span>(<span class="s">&quot;%windir%\\system32\\PowerShell&quot;</span>, <a href="../../PSVersionInfo.cs.html#be287f9ea52b8d2f" class="t t">PSVersionInfo</a>.<a href="../../PSVersionInfo.cs.html#624934150adfee0d" class="i property">GitCommitId</a>);
            <b>return</b> <span class="i n">System</span>.<span class="i">IO</span>.<span class="i">Path</span>.<span class="i">Combine</span>(<span class="r137 r">pluginDllDirectory</span>, <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#d19a1042a44001e8" class="t t">RemotingConstants</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#7cbb6da0d7ec5022" class="i field">PSPluginDLLName</a>);
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Group Conditional SDDL
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Builds a session SDDL based on the provided configuration hashtable.</span>
        <span class="c">///</span><span class="c"> Retrieves RequiredGroups information to add conditional group membership restrictions to SDDL.</span>
        <span class="c">///</span><span class="c"> Retrieves RoleDefinitions information to include role user accounts.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r138 r">configTable</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r139 r">accessMode</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r140 r">error</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">SDDL.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal static string</b> <a id="ac0adb98102375ba" href="../../../R/ac0adb98102375ba.html" target="n" data-glyph="74,1" class="i method">ComputeSDDLFromConfiguration</a>(
            <span class="i">Hashtable</span> <span id="r138 rd" class="r138 r">configTable</span>,
            <a href="../common/RunspaceConnectionInfo.cs.html#10edf62c3f6a89b0" class="t t">PSSessionConfigurationAccessMode</a> <span id="r139 rd" class="r139 r">accessMode</span>,
            <b>out</b> <a href="../../ErrorPackage.cs.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r140 rd" class="r140 r">error</span>)
        {
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r138 r">configTable</span> != <b>null</b>, <span class="s">&quot;configTable input parameter cannot be null.&quot;</span>);
 
            <b>string</b> <span id="r141 rd" class="r141 r">sddl</span> = <b>string</b>.<span class="i">Empty</span>;
            <span class="r140 r">error</span> = <b>null</b>;
 
            <span class="c">// RoleDefinitions</span>
            <b>if</b> (<span class="r138 r">configTable</span>.<span class="i">ContainsKey</span>(<a href="../fanin/InitialSessionStateProvider.cs.html#b1e495f9b52fbd4a" class="t t">ConfigFileConstants</a>.<a href="../fanin/InitialSessionStateProvider.cs.html#046aa0715b0841ad" class="i field">RoleDefinitions</a>))
            {
                <span class="c">// Start with known good security descriptor.</span>
                <b>if</b> (<span class="r139 r">accessMode</span> == <a href="../common/RunspaceConnectionInfo.cs.html#10edf62c3f6a89b0" class="t t">PSSessionConfigurationAccessMode</a>.<a href="../common/RunspaceConnectionInfo.cs.html#e493a77e156a2d8d" class="i field">Local</a>)
                {
                    <span class="r141 r">sddl</span> = <a href="#fc12f22923e252d9" class="t t">PSSessionConfigurationCommandBase</a>.<a href="#1cb9fa319955517b" class="i method">GetLocalSddl</a>();
                }
                <b>else</b> <b>if</b> (<span class="r139 r">accessMode</span> == <a href="../common/RunspaceConnectionInfo.cs.html#10edf62c3f6a89b0" class="t t">PSSessionConfigurationAccessMode</a>.<a href="../common/RunspaceConnectionInfo.cs.html#f9938a92bb1a8e5f" class="i field">Remote</a>)
                {
                    <span class="r141 r">sddl</span> = <a href="#fc12f22923e252d9" class="t t">PSSessionConfigurationCommandBase</a>.<a href="#d2c40f80d22c2cdd" class="i method">GetRemoteSddl</a>();
                }
 
                <span class="i">CommonSecurityDescriptor</span> <span id="r142 rd" class="r142 r">descriptor</span> = <b>new</b> <span class="i">CommonSecurityDescriptor</span>(<b>false</b>, <b>false</b>, <span class="r141 r">sddl</span>);
 
                <span class="c">// Purge all existing access rules so that only role definition principals are granted access.</span>
                <span class="i">List</span>&lt;<span class="i">SecurityIdentifier</span>&gt; <span id="r143 rd" class="r143 r">sidsToRemove</span> = <b>new</b> <span class="i">List</span>&lt;<span class="i">SecurityIdentifier</span>&gt;();
                <b>foreach</b> (<span class="i">CommonAce</span> <span id="r144 rd" class="r144 r">ace</span> <b>in</b> <span class="r142 r">descriptor</span>.<span class="i">DiscretionaryAcl</span>)
                {
                    <span class="r143 r">sidsToRemove</span>.<span class="i">Add</span>(<span class="r144 r">ace</span>.<span class="i">SecurityIdentifier</span>);
                }
 
                <b>foreach</b> (<b>var</b> <span id="r145 rd" class="r145 r">sidToRemove</span> <b>in</b> <span class="r143 r">sidsToRemove</span>)
                {
                    <span class="r142 r">descriptor</span>.<span class="i">PurgeAccessControl</span>(<span class="r145 r">sidToRemove</span>);
                }
 
                <span class="i">Hashtable</span> <span id="r146 rd" class="r146 r">roleNamesHash</span> = <span class="r138 r">configTable</span>[<a href="../fanin/InitialSessionStateProvider.cs.html#b1e495f9b52fbd4a" class="t t">ConfigFileConstants</a>.<a href="../fanin/InitialSessionStateProvider.cs.html#046aa0715b0841ad" class="i field">RoleDefinitions</a>] <b>as</b> <span class="i">Hashtable</span>;
                <b>foreach</b> (<b>object</b> <span id="r147 rd" class="r147 r">roleName</span> <b>in</b> <span class="r146 r">roleNamesHash</span>.<span class="i">Keys</span>)
                {
                    <b>string</b> <span id="r148 rd" class="r148 r">roleNameValue</span> = <span class="r147 r">roleName</span>.<span class="i">ToString</span>();
 
                    <b>try</b>
                    {
                        <span class="i">NTAccount</span> <span id="r149 rd" class="r149 r">ntAccount</span> = <b>new</b> <span class="i">NTAccount</span>(<span class="r148 r">roleNameValue</span>);
                        <span class="i">SecurityIdentifier</span> <span id="r150 rd" class="r150 r">accountSid</span> = (<span class="i">SecurityIdentifier</span>)<span class="r149 r">ntAccount</span>.<span class="i">Translate</span>(<b>typeof</b>(<span class="i">SecurityIdentifier</span>));
                        <span class="c">// AccessMask = 268435456 == 0x10000000 == GR == Generic Read</span>
                        <span class="r142 r">descriptor</span>.<span class="i">DiscretionaryAcl</span>.<span class="i">AddAccess</span>(<span class="i">AccessControlType</span>.<span class="i">Allow</span>, <span class="r150 r">accountSid</span>, 268435456, <span class="i">InheritanceFlags</span>.<span class="i">None</span>, <span class="i">PropagationFlags</span>.<span class="i">None</span>);
                    }
                    <b>catch</b> (<span class="i">IdentityNotMappedException</span> <span id="r151 rd" class="r151 r">e</span>)
                    {
                        <b>string</b> <span id="r152 rd" class="r152 r">message</span> = <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">CouldNotResolveRoleDefinitionPrincipal</span>, <span class="r148 r">roleNameValue</span>, <span class="r151 r">e</span>.<span class="i">Message</span>);
                        <span class="i">InvalidOperationException</span> <span id="r153 rd" class="r153 r">ioe</span> = <b>new</b> <span class="i">InvalidOperationException</span>(<span class="r152 r">message</span>, <span class="r151 r">e</span>);
                        <span class="r140 r">error</span> = <b>new</b> <span class="t">ErrorRecord</span>(<span class="r153 r">ioe</span>, <span class="s">&quot;CouldNotResolveRoleDefinitionPrincipal&quot;</span>, <a href="../../ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../../ErrorPackage.cs.html#9a72a7d3051ac7c5" class="i field">ObjectNotFound</a>, <span class="r148 r">roleNameValue</span>);
                    }
                }
 
                <b>if</b> (<span class="r142 r">descriptor</span>.<span class="i">DiscretionaryAcl</span>.<span class="i">Count</span> &gt; 0)
                {
                    <span class="r141 r">sddl</span> = <span class="r142 r">descriptor</span>.<span class="i">GetSddlForm</span>(<span class="i">AccessControlSections</span>.<span class="i">All</span>);
 
                    <span class="c">// RequiredGroups</span>
                    <b>string</b> <span id="r154 rd" class="r154 r">conditionalGroupACE</span> = <a href="#1c46fc11bc8d31a2" class="i method">CreateConditionalACEFromConfig</a>(<span class="r138 r">configTable</span>);
                    <b>if</b> (<span class="r154 r">conditionalGroupACE</span> != <b>null</b>)
                    {
                        <span class="r141 r">sddl</span> = <a href="#dfdd360647794326" class="i method">UpdateSDDLUsersWithGroupConditional</a>(<span class="r141 r">sddl</span>, <span class="r154 r">conditionalGroupACE</span>);
                    }
                }
            }
 
            <b>return</b> <span class="r141 r">sddl</span>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> SDDL Update
 
        <b>private const char</b> <a id="be311d8b8706d6a9" href="../../../R/be311d8b8706d6a9.html" target="n" data-glyph="10,1" class="i field">OpenParenChar</a> = <span class="s">&#39;(&#39;</span>;
        <b>private const char</b> <a id="b0a430cc22f7064b" href="../../../R/b0a430cc22f7064b.html" target="n" data-glyph="10,1" class="i field">CloseParenChar</a> = <span class="s">&#39;)&#39;</span>;
        <b>private const char</b> <a id="d5d86fea91aebf62" href="../../../R/d5d86fea91aebf62.html" target="n" data-glyph="10,1" class="i field">ACESeparatorChar</a> = <span class="s">&#39;;&#39;</span>;
        <b>private const string</b> <a id="6a89ecef385ced8e" href="../../../R/6a89ecef385ced8e.html" target="n" data-glyph="10,1" class="i field">ACESeparator</a> = <span class="s">&quot;;&quot;</span>;
        <b>private const string</b> <a id="fe04fd192a1981bc" href="../../../R/fe04fd192a1981bc.html" target="n" data-glyph="10,1" class="i field">ConditionalACEPrefix</a> = <span class="s">&quot;X&quot;</span>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Update SDDL user ACEs with provided conditional group ACE fragment.</span>
        <span class="c">///</span><span class="c"> SDDL:       O:NSG:BAD:P(A;;GA;;;BA)(A;;GA;;;RM)(A;;GA;;;IU)(A;;GA;;;S-1-5-21-2127438184-1604012920-1882527527)S:P(AU;FA;GA;;;WD)(AU;SA;GXGW;;;WD)</span>
        <span class="c">///</span><span class="c"> Cond ACE:   (Member_of {SID(2FA_GROUP_1)})</span>
        <span class="c">///</span><span class="c"> Cond SDDL:  O:NSG:BAD:P(XA;;GA;;;BA)(A;;GA;;;RM)(A;;GA;;;IU)(XA;;GA;;;S-1-5-21-2127438184-1604012920-1882527527;(Member_of {SID(2FA_GROUP_1)}))S:P(AU;FA;GA;;;WD)(AU;SA;GXGW;;;WD)</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r155 r">sddl</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r156 r">conditionalGroupACE</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal static string</b> <a id="dfdd360647794326" href="../../../R/dfdd360647794326.html" target="n" data-glyph="74,1" class="i method">UpdateSDDLUsersWithGroupConditional</a>(
            <b>string</b> <span id="r155 rd" class="r155 r">sddl</span>,
            <b>string</b> <span id="r156 rd" class="r156 r">conditionalGroupACE</span>)
        {
            <span class="c">// Parse sddl for DACL user ACEs.</span>
            <span class="c">// prologue string contains the beginning owner and primary group components</span>
            <span class="c">//    O:NSG:BAD:P</span>
            <span class="c">// epilogue string contains the ending (and optional) SACL components</span>
            <span class="c">//    S:P(AU;FA;GA;;;WD)(AU;SA;GXGW;;;WD)</span>
            <span class="c">// (https://msdn.microsoft.com/library/windows/desktop/aa379570(v=vs.85).aspx)</span>
            <b>string</b> <span id="r157 rd" class="r157 r">prologue</span>;
            <b>string</b> <span id="r158 rd" class="r158 r">epilogue</span>;
            <span class="i">Collection</span>&lt;<b>string</b>&gt; <span id="r159 rd" class="r159 r">aces</span> = <a href="#d692c453b0cef185" class="i method">ParseDACLACEs</a>(<span class="r155 r">sddl</span>, <b>out</b> <span class="r157 r">prologue</span>, <b>out</b> <span class="r158 r">epilogue</span>);
 
            <b>if</b> (<span class="r159 r">aces</span>.<span class="i">Count</span> == 0) { <b>return</b> <span class="r155 r">sddl</span>; }
 
            <span class="i">StringBuilder</span> <span id="r160 rd" class="r160 r">sb</span> = <b>new</b> <span class="i">StringBuilder</span>();
            <span class="r160 r">sb</span>.<span class="i">Append</span>(<span class="r157 r">prologue</span>);
 
            <span class="c">//</span>
            <span class="c">// Convert to conditional ACE</span>
            <span class="c">// Beginning (Regular) ACE has exactly 6 required fields and one (optional) field.</span>
            <span class="c">// We only manipulate ACEs that we create and we currently do not use the optional resource field,</span>
            <span class="c">// so we always expect a beginning ACE with exactly 6 fields.</span>
            <span class="c">// ace_type;ace_flags;rights;object_guid;inherit_object_guid;account_sid;(resource_attribute)</span>
            <span class="c">// (https://msdn.microsoft.com/library/windows/desktop/aa374928(v=vs.85).aspx)</span>
            <span class="c">//</span>
            <span class="c">// Converted (Conditional) ACE has exactly 7 required fields.  In addition the ACE type</span>
            <span class="c">// is prepended with &#39;X&#39; character.</span>
            <span class="c">// AceType;AceFlags;Rights;ObjectGuid;InheritObjectGuid;AccountSid;(ConditionalExpression)</span>
            <span class="c">// (https://msdn.microsoft.com/library/windows/desktop/dd981030(v=vs.85).aspx)</span>
            <span class="c">//</span>
            <span class="c">// e.g.</span>
            <span class="c">// Beginning ACE: (A;;GA;;;BA)</span>
            <span class="c">// Converted ACE: (XA;;GA;;;BA;(Member_of {SID(S-1-5-32-547)}))</span>
            <span class="c">//</span>
            <b>foreach</b> (<b>var</b> <span id="r161 rd" class="r161 r">ace</span> <b>in</b> <span class="r159 r">aces</span>)
            {
                <span class="c">// Parse ACE components.</span>
                <b>var</b> <span id="r162 rd" class="r162 r">components</span> = <span class="r161 r">ace</span>.<span class="i">Split</span>(<a href="#d5d86fea91aebf62" class="i field">ACESeparatorChar</a>);
                <b>if</b> (<span class="r162 r">components</span>.<span class="i">Length</span> != 6)
                {
                    <b>throw</b> <b>new</b> <a href="../../../utils/MshInvalidOperationException.cs.html#de5b942a57457045" class="t constructor">PSInvalidOperationException</a>(
                        <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">RequiredGroupsMalformedACE</span>, <span class="r161 r">ace</span>));
                }
 
                <span class="c">// Trim open and close parentheses from ACE string.</span>
                <span class="r162 r">components</span>[0] = <span class="r162 r">components</span>[0].<span class="i">TrimStart</span>(<a href="#be311d8b8706d6a9" class="i field">OpenParenChar</a>);
                <span class="r162 r">components</span>[5] = <span class="r162 r">components</span>[5].<span class="i">TrimEnd</span>(<a href="#b0a430cc22f7064b" class="i field">CloseParenChar</a>);
 
                <span class="c">// Building new conditional ACE</span>
                <span class="r160 r">sb</span>.<span class="i">Append</span>(<a href="#be311d8b8706d6a9" class="i field">OpenParenChar</a>);
 
                <span class="c">// Prepend the &#39;X&#39; character</span>
                <b>var</b> <span id="r163 rd" class="r163 r">accessType</span> = <a href="#fe04fd192a1981bc" class="i field">ConditionalACEPrefix</a> + <span class="r162 r">components</span>[0];
                <span class="r160 r">sb</span>.<span class="i">Append</span>(<span class="r163 r">accessType</span> + <a href="#6a89ecef385ced8e" class="i field">ACESeparator</a>);
                <b>for</b> (<b>int</b> <span id="r164 rd" class="r164 r">i</span> = 1; <span class="r164 r">i</span> &lt; 6; <span class="r164 r">i</span>++)
                {
                    <span class="r160 r">sb</span>.<span class="i">Append</span>(<span class="r162 r">components</span>[<span class="r164 r">i</span>] + <a href="#6a89ecef385ced8e" class="i field">ACESeparator</a>);
                }
 
                <span class="r160 r">sb</span>.<span class="i">Append</span>(<span class="r156 r">conditionalGroupACE</span>);
 
                <span class="r160 r">sb</span>.<span class="i">Append</span>(<a href="#b0a430cc22f7064b" class="i field">CloseParenChar</a>);
            }
 
            <span class="r160 r">sb</span>.<span class="i">Append</span>(<span class="r158 r">epilogue</span>);
 
            <b>return</b> <span class="r160 r">sb</span>.<span class="i">ToString</span>();
        }
 
        <b>private const string</b> <a id="dc668eb6e6a4f257" href="../../../R/dc668eb6e6a4f257.html" target="n" data-glyph="10,1" class="i field">DACLPrefix</a> = <span class="s">&quot;D:&quot;</span>;
 
        <b>private static</b> <span class="i">Collection</span>&lt;<b>string</b>&gt; <a id="d692c453b0cef185" href="../../../R/d692c453b0cef185.html" target="n" data-glyph="76,1" class="i method">ParseDACLACEs</a>(
            <b>string</b> <span id="r165 rd" class="r165 r">sddl</span>,
            <b>out string</b> <span id="r166 rd" class="r166 r">prologue</span>,
            <b>out string</b> <span id="r167 rd" class="r167 r">epilogue</span>)
        {
            <span class="c">//</span>
            <span class="c">// The format of the sddl is expected to be:</span>
            <span class="c">// owner (O:), primary group (G:), DACL (D:), and SACL (S:).</span>
            <span class="c">// (https://msdn.microsoft.com/library/windows/desktop/aa379570(v=vs.85).aspx)</span>
            <span class="c">// e.g.</span>
            <span class="c">// O:NSG:BAD:P(A;;GA;;;BA)(XA;;GA;;;RM)(XA;;GA;;;IU)S:P(AU;FA;GA;;;WD)(AU;SA;GXGW;;;WD)</span>
            <span class="c">// prologue  = &quot;O:NSG:BAD:P&quot;</span>
            <span class="c">// DACL ACEs = &quot;(A;;GA;;;BA)(XA;;GA;;;RM)(XA;;GA;;;IU)&quot;</span>
            <span class="c">// epilogue  = &quot;S:P(AU;FA;GA;;;WD)(AU;SA;GXGW;;;WD)&quot;</span>
            <span class="c">//</span>
            <span class="i">Collection</span>&lt;<b>string</b>&gt; <span id="r168 rd" class="r168 r">sddlACEs</span> = <b>new</b> <span class="i">Collection</span>&lt;<b>string</b>&gt;();
 
            <span class="c">// Find beginning of DACL ACEs</span>
            <b>int</b> <span id="r169 rd" class="r169 r">index</span> = <span class="r165 r">sddl</span>.<span class="i">IndexOf</span>(<a href="#dc668eb6e6a4f257" class="i field">DACLPrefix</a>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>);
            <b>if</b> (<span class="r169 r">index</span> &lt; 0)
            {
                <span class="r166 r">prologue</span> = <b>string</b>.<span class="i">Empty</span>;
                <span class="r167 r">epilogue</span> = <b>string</b>.<span class="i">Empty</span>;
                <b>return</b> <span class="r168 r">sddlACEs</span>;
            }
 
            <span class="c">// Advance index to beginning of DACL ACEs and save prologue</span>
            <span class="r169 r">index</span> = <span class="r165 r">sddl</span>.<span class="i">IndexOf</span>(<a href="#be311d8b8706d6a9" class="i field">OpenParenChar</a>, <span class="r169 r">index</span>);
            <b>if</b> (<span class="r169 r">index</span> &lt; 0)
            {
                <span class="r166 r">prologue</span> = <b>string</b>.<span class="i">Empty</span>;
                <span class="r167 r">epilogue</span> = <b>string</b>.<span class="i">Empty</span>;
                <b>return</b> <span class="r168 r">sddlACEs</span>;
            }
 
            <span class="r166 r">prologue</span> = <span class="r165 r">sddl</span>.<span class="i">Substring</span>(0, <span class="r169 r">index</span>);
 
            <b>int</b> <span id="r170 rd" class="r170 r">sddlLength</span> = <span class="r165 r">sddl</span>.<span class="i">Length</span>;
            <b>while</b> (<b>true</b>)
            {
                <span class="c">// Find ending of ACE</span>
                <b>int</b> <span id="r171 rd" class="r171 r">endIndex</span> = <span class="r165 r">sddl</span>.<span class="i">IndexOf</span>(<a href="#b0a430cc22f7064b" class="i field">CloseParenChar</a>, <span class="r169 r">index</span>);
                <b>if</b> (<span class="r171 r">endIndex</span> &lt; 0)
                {
                    <b>throw</b> <b>new</b> <a href="../../../utils/MshInvalidOperationException.cs.html#de5b942a57457045" class="t constructor">PSInvalidOperationException</a>(
                        <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">BadSDDLMismatchedParens</span>, <span class="r165 r">sddl</span>));
                }
 
                <b>string</b> <span id="r172 rd" class="r172 r">ace</span> = <span class="r165 r">sddl</span>.<span class="i">Substring</span>(<span class="r169 r">index</span>, (<span class="r171 r">endIndex</span> - <span class="r169 r">index</span> + 1));
                <span class="r168 r">sddlACEs</span>.<span class="i">Add</span>(<span class="r172 r">ace</span>);
 
                <span class="c">// Next ACE is indicated by an immediate open parenthesis character.</span>
                <span class="r169 r">index</span> = <span class="r171 r">endIndex</span> + 1;
                <b>if</b> ((<span class="r169 r">index</span> &gt;= <span class="r170 r">sddlLength</span>) || (<span class="r165 r">sddl</span>[<span class="r169 r">index</span>] != <a href="#be311d8b8706d6a9" class="i field">OpenParenChar</a>)) { <b>break</b>; }
            }
 
            <span class="c">// SACLs will be at the end of the sddl string.</span>
            <span class="r167 r">epilogue</span> = (<span class="r169 r">index</span> &lt; <span class="r170 r">sddlLength</span>) ? <span class="r165 r">sddl</span>.<span class="i">Substring</span>(<span class="r169 r">index</span>, (<span class="r170 r">sddlLength</span> - <span class="r169 r">index</span>)) : <b>string</b>.<span class="i">Empty</span>;
 
            <b>return</b> <span class="r168 r">sddlACEs</span>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Conditional ACE
 
        <b>private const string</b> <a id="6065529e523bea9e" href="../../../R/6065529e523bea9e.html" target="n" data-glyph="10,1" class="i field">AndOperator</a> = <span class="s">&quot;And&quot;</span>;
        <b>private const string</b> <a id="c2fd8edfdc015e2d" href="../../../R/c2fd8edfdc015e2d.html" target="n" data-glyph="10,1" class="i field">OrOperator</a> = <span class="s">&quot;Or&quot;</span>;
        <b>private const string</b> <a id="07cee71288afffd0" href="../../../R/07cee71288afffd0.html" target="n" data-glyph="10,1" class="i field">AndCondition</a> = <span class="s">&quot; &amp;&amp; &quot;</span>;
        <b>private const string</b> <a id="230d7b48521027e8" href="../../../R/230d7b48521027e8.html" target="n" data-glyph="10,1" class="i field">OrCondition</a> = <span class="s">&quot; || &quot;</span>;
        <b>private const string</b> <a id="0a857baa2ffa8528" href="../../../R/0a857baa2ffa8528.html" target="n" data-glyph="10,1" class="i field">MemberOfFormat</a> = <span class="s">&quot;Member_of {{SID({0})}}&quot;</span>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Parse RequiredGroups configuration and build conditional ACE string.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r173 r">configTable</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">// RequiredGroups:  @{ And = @{ Or = &#39;2FA_GROUP_1&#39;, &#39;2FA_GROUP_2&#39; }, @{ Or = &#39;TRUSTEDHOSTS_1&#39;, &#39;TRUSTEDHOSTS_2&#39; } }</span>
        <span class="c">// User ACE:        (XA;;GA;;;S-1-5-21-2127438184-1604012920-1882527527;ConditionalPart)</span>
        <span class="c">// ConditionalPart:   ((Member_of {SID(2FA_GROUP_1)} || Member_of {SID(2FA_GROUP_2)}) &amp;&amp; (Member_of {SID(TRUSTEDHOSTS_1)} || Member_of {TRUSTEDHOSTS_2}))</span>
        <span class="c">//         where:   2FA_GROUP_1, 2FA_GROUP_2, TRUSTEDHOSTS_1, TRUSTEDHOSTS_2 are resolved SIDs of the group names.</span>
        <span class="c">// (https://msdn.microsoft.com/library/windows/desktop/dd981030(v=vs.85).aspx)</span>
        <b>internal static string</b> <a id="1c46fc11bc8d31a2" href="../../../R/1c46fc11bc8d31a2.html" target="n" data-glyph="74,1" class="i method">CreateConditionalACEFromConfig</a>(
            <span class="i">Hashtable</span> <span id="r173 rd" class="r173 r">configTable</span>)
        {
            <b>if</b> (!<span class="r173 r">configTable</span>.<span class="i">ContainsKey</span>(<a href="../fanin/InitialSessionStateProvider.cs.html#b1e495f9b52fbd4a" class="t t">ConfigFileConstants</a>.<a href="../fanin/InitialSessionStateProvider.cs.html#791957e7bb634869" class="i field">RequiredGroups</a>))
            {
                <b>return</b> <b>null</b>;
            }
 
            <span class="i">StringBuilder</span> <span id="r174 rd" class="r174 r">conditionalACE</span> = <b>new</b> <span class="i">StringBuilder</span>();
            <b>if</b> (!(<span class="r173 r">configTable</span>[<a href="../fanin/InitialSessionStateProvider.cs.html#b1e495f9b52fbd4a" class="t t">ConfigFileConstants</a>.<a href="../fanin/InitialSessionStateProvider.cs.html#791957e7bb634869" class="i field">RequiredGroups</a>] <b>is</b> <span class="i">Hashtable</span> <span id="r175 rd" class="r175 r">requiredGroupsHash</span>))
            {
                <b>throw</b> <b>new</b> <span class="t">PSInvalidOperationException</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">RequiredGroupsNotHashTable</span>);
            }
 
            <b>if</b> (<span class="r175 r">requiredGroupsHash</span>.<span class="i">Count</span> == 0)
            {
                <b>return</b> <b>null</b>;
            }
 
            <span class="c">// Recursively create group membership conditional ACE for each hash table key.</span>
            <a href="#1fe14f96e177e1bd" class="i method">AddCondition</a>(<span class="r174 r">conditionalACE</span>, <span class="r175 r">requiredGroupsHash</span>);
 
            <b>return</b> <span class="r174 r">conditionalACE</span>.<span class="i">ToString</span>();
        }
 
        <b>private static void</b> <a id="1fe14f96e177e1bd" href="../../../R/1fe14f96e177e1bd.html" target="n" data-glyph="76,1" class="i method">AddCondition</a>(
            <span class="i">StringBuilder</span> <span id="r176 rd" class="r176 r">sb</span>,
            <span class="i">Hashtable</span> <span id="r177 rd" class="r177 r">condition</span>)
        {
            <span class="c">// We currently support only &#39;And&#39; and &#39;Or&#39; logical operations for group membership</span>
            <span class="c">// combinations.</span>
            <b>if</b> (<span class="r177 r">condition</span>.<span class="i">ContainsKey</span>(<a href="#6065529e523bea9e" class="i field">AndOperator</a>))
            {
                <b>object</b> <span id="r178 rd" class="r178 r">keyValue</span> = <span class="r177 r">condition</span>[<a href="#6065529e523bea9e" class="i field">AndOperator</a>];
                <a href="#d254ec0c9c88cf40" class="i method">ParseKeyValue</a>(<span class="r176 r">sb</span>, <span class="r178 r">keyValue</span>, <a href="#07cee71288afffd0" class="i field">AndCondition</a>);
            }
            <b>else</b> <b>if</b> (<span class="r177 r">condition</span>.<span class="i">ContainsKey</span>(<a href="#c2fd8edfdc015e2d" class="i field">OrOperator</a>))
            {
                <b>object</b> <span id="r179 rd" class="r179 r">keyValue</span> = <span class="r177 r">condition</span>[<a href="#c2fd8edfdc015e2d" class="i field">OrOperator</a>];
                <a href="#d254ec0c9c88cf40" class="i method">ParseKeyValue</a>(<span class="r176 r">sb</span>, <span class="r179 r">keyValue</span>, <a href="#230d7b48521027e8" class="i field">OrCondition</a>);
            }
            <b>else</b>
            {
                <b>throw</b> <b>new</b> <span class="t">PSInvalidOperationException</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">UnknownGroupMembershipKey</span>);
            }
        }
 
        <b>private static void</b> <a id="d254ec0c9c88cf40" href="../../../R/d254ec0c9c88cf40.html" target="n" data-glyph="76,1" class="i method">ParseKeyValue</a>(
            <span class="i">StringBuilder</span> <span id="r180 rd" class="r180 r">sb</span>,
            <b>object</b> <span id="r181 rd" class="r181 r">keyValue</span>,
            <b>string</b> <span id="r182 rd" class="r182 r">logicalOperator</span>)
        {
            <span class="c">// Start of condition</span>
            <span class="r180 r">sb</span>.<span class="i">Append</span>(<a href="#be311d8b8706d6a9" class="i field">OpenParenChar</a>);
 
            <span class="c">// Logical keyname value can contain:</span>
            <span class="c">//  Single group name</span>
            <span class="c">//      @{ Or = &#39;Group1&#39; }</span>
            <span class="c">//      (Member_of {SID(Group1)})</span>
            <span class="c">//  Multiple group names</span>
            <span class="c">//      @{ Or = &#39;Group1&#39;,&#39;Group2&#39; }</span>
            <span class="c">//      (Member_of {SID(Group2)} || Member_of {SID(Group2)})</span>
            <span class="c">//  Single hash table</span>
            <span class="c">//      @{ Or = @{ And = &#39;Group1&#39; } }</span>
            <span class="c">//      (Member_of {SID(Group1)})</span>
            <span class="c">//  Multiple hash table</span>
            <span class="c">//      @{ Or = @{ And = &#39;Group1&#39;,&#39;Group2&#39; }, @{ And = &#39;Group3&#39;,&#39;Group4&#39; } }</span>
            <span class="c">//      ((Member_of {SID(Group1)} &amp;&amp; Member_of {SID(Group2)}) || (Member_of {SID(Group3)} &amp;&amp; Member_of {SID(Group4)}))</span>
            <span class="c">//  Mixed</span>
            <span class="c">//      @{ Or = &#39;Group1&#39;, @{ And = &#39;Group2&#39;,&#39;Group3&#39; } }</span>
            <span class="c">//      (Member_of {SID(Group1)} || (Member_of {SID(Group2)} &amp;&amp; Member_of {SID(Group3)}))</span>
            <b>object</b>[] <span id="r183 rd" class="r183 r">values</span> = <span class="r181 r">keyValue</span> <b>as object</b>[];
            <b>if</b> (<span class="r183 r">values</span> != <b>null</b>)
            {
                <b>int</b> <span id="r184 rd" class="r184 r">count</span> = <span class="r183 r">values</span>.<span class="i">Length</span>;
                <b>for</b> (<b>int</b> <span id="r185 rd" class="r185 r">i</span> = 0; <span class="r185 r">i</span> &lt; <span class="r184 r">count</span>;)
                {
                    <a href="#a6fa25de82ee09f8" class="i method">ParseValues</a>(<span class="r180 r">sb</span>, <span class="r183 r">values</span>[<span class="r185 r">i</span>++]);
                    <b>if</b> (<span class="r185 r">i</span> &lt; <span class="r184 r">count</span>)
                    {
                        <span class="c">// Combine sub conditional ACEs with logical operator</span>
                        <span class="r180 r">sb</span>.<span class="i">Append</span>(<span class="r182 r">logicalOperator</span>);
                    }
                }
            }
            <b>else</b>
            {
                <a href="#a6fa25de82ee09f8" class="i method">ParseValues</a>(<span class="r180 r">sb</span>, <span class="r181 r">keyValue</span>);
            }
 
            <span class="c">// End of condition</span>
            <span class="r180 r">sb</span>.<span class="i">Append</span>(<a href="#b0a430cc22f7064b" class="i field">CloseParenChar</a>);
        }
 
        <b>private static void</b> <a id="a6fa25de82ee09f8" href="../../../R/a6fa25de82ee09f8.html" target="n" data-glyph="76,1" class="i method">ParseValues</a>(
            <span class="i">StringBuilder</span> <span id="r186 rd" class="r186 r">sb</span>,
            <b>object</b> <span id="r187 rd" class="r187 r">inValue</span>)
        {
            <span class="c">// Value to parse can be a single object or an array of objects</span>
            <b>object</b>[] <span id="r188 rd" class="r188 r">values</span> = <span class="r187 r">inValue</span> <b>as object</b>[];
            <b>if</b> (<span class="r188 r">values</span> != <b>null</b>)
            {
                <b>foreach</b> (<b>object</b> <span id="r189 rd" class="r189 r">value</span> <b>in</b> <span class="r188 r">values</span>)
                {
                    <a href="#1e96b9aee1f8819c" class="i method">ParseValue</a>(<span class="r186 r">sb</span>, <span class="r189 r">value</span>);
                }
            }
            <b>else</b>
            {
                <a href="#1e96b9aee1f8819c" class="i method">ParseValue</a>(<span class="r186 r">sb</span>, <span class="r187 r">inValue</span>);
            }
        }
 
        <b>private static void</b> <a id="1e96b9aee1f8819c" href="../../../R/1e96b9aee1f8819c.html" target="n" data-glyph="76,1" class="i method">ParseValue</a>(
            <span class="i">StringBuilder</span> <span id="r190 rd" class="r190 r">sb</span>,
            <b>object</b> <span id="r191 rd" class="r191 r">value</span>)
        {
            <span class="c">// Single value objects can be either a group name or a new logical hash table</span>
            <b>string</b> <span id="r192 rd" class="r192 r">groupName</span> = <span class="r191 r">value</span> <b>as string</b>;
            <b>if</b> (<span class="r192 r">groupName</span> != <b>null</b>)
            {
                <span class="c">// Resolve group name to SID</span>
                <span class="i">NTAccount</span> <span id="r193 rd" class="r193 r">ntAccount</span> = <b>new</b> <span class="i">NTAccount</span>(<span class="r192 r">groupName</span>);
                <span class="i">SecurityIdentifier</span> <span id="r194 rd" class="r194 r">accountSid</span> = (<span class="i">SecurityIdentifier</span>)<span class="r193 r">ntAccount</span>.<span class="i">Translate</span>(<b>typeof</b>(<span class="i">SecurityIdentifier</span>));
                <span class="r190 r">sb</span>.<span class="i">Append</span>(<a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<a href="#0a857baa2ffa8528" class="i field">MemberOfFormat</a>, <span class="r194 r">accountSid</span>.<span class="i">ToString</span>()));
            }
            <b>else</b>
            {
                <span class="i">Hashtable</span> <span id="r195 rd" class="r195 r">recurseCondition</span> = <span class="r191 r">value</span> <b>as</b> <span class="i">Hashtable</span>;
                <b>if</b> (<span class="r195 r">recurseCondition</span> != <b>null</b>)
                {
                    <span class="c">// Recurse to handle logical hash table</span>
                    <a href="#1fe14f96e177e1bd" class="i method">AddCondition</a>(<span class="r190 r">sb</span>, <span class="r195 r">recurseCondition</span>);
                }
                <b>else</b>
                {
                    <b>throw</b> <b>new</b> <span class="t">PSInvalidOperationException</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">UnknownGroupMembershipValue</span>);
                }
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
    }
 
    <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
    <span class="k preprocess">#</span><span class="k preprocess">region</span> PSCustomShellCommandBase
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Base class for PSCustomShell commands Register-PSSessionConfiguration, Set-PSSessionConfiguration.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>public class</b> <a id="fc12f22923e252d9" href="../../../R/fc12f22923e252d9.html" target="n" data-glyph="0,0" class="t t">PSSessionConfigurationCommandBase</a> : <a href="../../../P/30543a6971fed1fc.html#30543a6971fed1fc" class="t t">PSCmdlet</a>
    {
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Private Data
 
        <b>internal const string</b> <a id="567a3254f0a1b9e7" href="../../../R/567a3254f0a1b9e7.html" target="n" data-glyph="8,1" class="i field">NameParameterSetName</a> = <span class="s">&quot;NameParameterSet&quot;</span>;
        <b>internal const string</b> <a id="56f05157bcbc7dce" href="../../../R/56f05157bcbc7dce.html" target="n" data-glyph="8,1" class="i field">AssemblyNameParameterSetName</a> = <span class="s">&quot;AssemblyNameParameterSet&quot;</span>;
        <b>internal const string</b> <a id="f428f7553cdf4887" href="../../../R/f428f7553cdf4887.html" target="n" data-glyph="8,1" class="i field">SessionConfigurationFileParameterSetName</a> = <span class="s">&quot;SessionConfigurationFile&quot;</span>;
 
        <span class="c">// Deny network access but allow local access</span>
        <b>private const string</b> <a id="52ad2df09c3561b5" href="../../../R/52ad2df09c3561b5.html" target="n" data-glyph="10,1" class="i field">localSDDL</a> = <span class="s">&quot;O:NSG:BAD:P(D;;GA;;;NU)(A;;GA;;;BA)(A;;GA;;;IU)S:P(AU;FA;GA;;;WD)(AU;SA;GXGW;;;WD)&quot;</span>;
        <b>private const string</b> <a id="65edf6cd45d25661" href="../../../R/65edf6cd45d25661.html" target="n" data-glyph="10,1" class="i field">localSDDL_Win8</a> = <span class="s">&quot;O:NSG:BAD:P(D;;GA;;;NU)(A;;GA;;;BA)(A;;GA;;;RM)(A;;GA;;;IU)S:P(AU;FA;GA;;;WD)(AU;SA;GXGW;;;WD)&quot;</span>; <span class="c">// Win8+ only</span>
 
        <b>private const string</b> <a id="c42e76fbf36a2eff" href="../../../R/c42e76fbf36a2eff.html" target="n" data-glyph="10,1" class="i field">remoteSDDL</a> = <span class="s">&quot;O:NSG:BAD:P(A;;GA;;;BA)(A;;GA;;;IU)S:P(AU;FA;GA;;;WD)(AU;SA;GXGW;;;WD)&quot;</span>;
        <b>private const string</b> <a id="732fb7411f682cf3" href="../../../R/732fb7411f682cf3.html" target="n" data-glyph="10,1" class="i field">remoteSDDL_Win8</a> = <span class="s">&quot;O:NSG:BAD:P(A;;GA;;;BA)(A;;GA;;;RM)(A;;GA;;;IU)S:P(AU;FA;GA;;;WD)(AU;SA;GXGW;;;WD)&quot;</span>; <span class="c">// Win8 only</span>
 
        <span class="c">// Win8 only SID for Remote Management Users group.</span>
        <b>internal const string</b> <a id="9d3d012f73c36bca" href="../../../R/9d3d012f73c36bca.html" target="n" data-glyph="8,1" class="i field">RemoteManagementUsersSID</a> = <span class="s">&quot;S-1-5-32-580&quot;</span>;
 
        <span class="c">// SID for Interactive Users group.</span>
        <b>internal const string</b> <a id="3040a1427951767d" href="../../../R/3040a1427951767d.html" target="n" data-glyph="8,1" class="i field">InteractiveUsersSID</a> = <span class="s">&quot;S-1-5-4&quot;</span>;
 
        <b>internal</b> <span class="i">Version</span> <a id="21f5de889788ab87" href="../../../R/21f5de889788ab87.html" target="n" data-glyph="44,1" class="i field">MaxPSVersion</a> = <b>null</b>;
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Static methods
 
        <b>internal static string</b> <a id="1cb9fa319955517b" href="../../../R/1cb9fa319955517b.html" target="n" data-glyph="74,1" class="i method">GetLocalSddl</a>()
        {
            <b>return</b> (<span class="i">Environment</span>.<span class="i">OSVersion</span>.<span class="i">Version</span> &gt;= <b>new</b> <span class="i">Version</span>(6, 2)) ? <a href="#65edf6cd45d25661" class="i field">localSDDL_Win8</a> : <a href="#52ad2df09c3561b5" class="i field">localSDDL</a>;
        }
 
        <b>internal static string</b> <a id="d2c40f80d22c2cdd" href="../../../R/d2c40f80d22c2cdd.html" target="n" data-glyph="74,1" class="i method">GetRemoteSddl</a>()
        {
            <b>return</b> (<span class="i">Environment</span>.<span class="i">OSVersion</span>.<span class="i">Version</span> &gt;= <b>new</b> <span class="i">Version</span>(6, 2)) ? <a href="#732fb7411f682cf3" class="i field">remoteSDDL_Win8</a> : <a href="#c42e76fbf36a2eff" class="i field">remoteSDDL</a>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Parameters
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This parameter enables the user to specify a shell name for the</span>
        <span class="c">///</span><span class="c"> created custom shell.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>(<a href="../../Attributes.cs.html#d5ad471518092731" class="i property">Mandatory</a> = <b>true</b>, <a href="../../Attributes.cs.html#19ccfeb1cdbdb967" class="i property">Position</a> = 0, <a href="../../Attributes.cs.html#aded474eaec9cde8" class="i property">ValueFromPipelineByPropertyName</a> = <b>true</b>, <a href="../../Attributes.cs.html#91bee819daab0925" class="i property">ParameterSetName</a> = <a href="#567a3254f0a1b9e7" class="i field">NameParameterSetName</a>)]
        [<span class="i">Parameter</span>(<a href="../../Attributes.cs.html#d5ad471518092731" class="i property">Mandatory</a> = <b>true</b>, <a href="../../Attributes.cs.html#19ccfeb1cdbdb967" class="i property">Position</a> = 0, <a href="../../Attributes.cs.html#aded474eaec9cde8" class="i property">ValueFromPipelineByPropertyName</a> = <b>true</b>, <a href="../../Attributes.cs.html#91bee819daab0925" class="i property">ParameterSetName</a> = <a href="#56f05157bcbc7dce" class="i field">AssemblyNameParameterSetName</a>)]
        [<span class="i">Parameter</span>(<a href="../../Attributes.cs.html#d5ad471518092731" class="i property">Mandatory</a> = <b>true</b>, <a href="../../Attributes.cs.html#19ccfeb1cdbdb967" class="i property">Position</a> = 0, <a href="../../Attributes.cs.html#aded474eaec9cde8" class="i property">ValueFromPipelineByPropertyName</a> = <b>true</b>, <a href="../../Attributes.cs.html#91bee819daab0925" class="i property">ParameterSetName</a> = <a href="#f428f7553cdf4887" class="i field">SessionConfigurationFileParameterSetName</a>)]
        [<span class="i">ValidateNotNullOrEmpty</span>]
        <b>public string</b> <a id="ff3d179414dbc3ad" href="../../../R/ff3d179414dbc3ad.html" target="n" data-glyph="102,1" class="i property">Name</a>
        {
            <b>get</b> { <b>return</b> <a href="#50e45ca03ff16b28" class="i field">shellName</a>; }
 
            <b>set</b> { <a href="#50e45ca03ff16b28" class="i field">shellName</a> = <b>value</b>; }
        }
 
        <b>internal string</b> <a id="50e45ca03ff16b28" href="../../../R/50e45ca03ff16b28.html" target="n" data-glyph="44,1" class="i field">shellName</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This parameter enables the user to load an Assembly and supply</span>
        <span class="c">///</span><span class="c"> InitialSessionstate for each user connecting to the shell.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>(<a href="../../Attributes.cs.html#19ccfeb1cdbdb967" class="i property">Position</a> = 1, <a href="../../Attributes.cs.html#d5ad471518092731" class="i property">Mandatory</a> = <b>true</b>, <a href="../../Attributes.cs.html#91bee819daab0925" class="i property">ParameterSetName</a> = <a href="#fc12f22923e252d9" class="t t">PSSessionConfigurationCommandBase</a>.<a href="#56f05157bcbc7dce" class="i field">AssemblyNameParameterSetName</a>)]
        <b>public string</b> <a id="4f78c4d580e53d83" href="../../../R/../../0000000000.html" target="n" data-glyph="102,1" class="i property">AssemblyName</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#027266a61924c685" class="i field">assemblyName</a>;
            }
 
            <b>set</b>
            {
                <a href="#027266a61924c685" class="i field">assemblyName</a> = <b>value</b>;
                <a href="#c33288066c34ebf4" class="i field">isAssemblyNameSpecified</a> = <b>true</b>;
            }
        }
 
        <b>internal string</b> <a id="027266a61924c685" href="../../../R/027266a61924c685.html" target="n" data-glyph="44,1" class="i field">assemblyName</a>;
        <b>internal bool</b> <a id="c33288066c34ebf4" href="../../../R/c33288066c34ebf4.html" target="n" data-glyph="44,1" class="i field">isAssemblyNameSpecified</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This parameter can accompany with AssemblyName. This supplies</span>
        <span class="c">///</span><span class="c"> the directory to search while loading the assembly specified</span>
        <span class="c">///</span><span class="c"> with parameter AssemblyName. Environment variables are accepted</span>
        <span class="c">///</span><span class="c"> in the string value.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>(<a href="../../Attributes.cs.html#91bee819daab0925" class="i property">ParameterSetName</a> = <a href="#567a3254f0a1b9e7" class="i field">NameParameterSetName</a>)]
        [<span class="i">Parameter</span>(<a href="../../Attributes.cs.html#91bee819daab0925" class="i property">ParameterSetName</a> = <a href="#56f05157bcbc7dce" class="i field">AssemblyNameParameterSetName</a>)]
        <b>public string</b> <a id="7a6965fb22d3faad" href="../../../R/../../0000000000.html" target="n" data-glyph="102,1" class="i property">ApplicationBase</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#a175420dee4e8b20" class="i field">applicationBase</a>;
            }
 
            <b>set</b>
            {
                <a href="#a175420dee4e8b20" class="i field">applicationBase</a> = <b>value</b>;
                <a href="#008bf63d35c7416c" class="i field">isApplicationBaseSpecified</a> = <b>true</b>;
            }
        }
 
        <b>internal string</b> <a id="a175420dee4e8b20" href="../../../R/a175420dee4e8b20.html" target="n" data-glyph="44,1" class="i field">applicationBase</a>;
        <b>internal bool</b> <a id="008bf63d35c7416c" href="../../../R/008bf63d35c7416c.html" target="n" data-glyph="44,1" class="i field">isApplicationBaseSpecified</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This parameter should be specified with AssemblyName. This supplies</span>
        <span class="c">///</span><span class="c"> the type to load to get the InitialSessionState. The type should</span>
        <span class="c">///</span><span class="c"> be derived from </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="../fanin/InitialSessionStateProvider.cs.html#e35ba0e017aa5d6d" class="t t">PSSessionConfiguration</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c">.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>(<a href="../../Attributes.cs.html#19ccfeb1cdbdb967" class="i property">Position</a> = 2, <a href="../../Attributes.cs.html#d5ad471518092731" class="i property">Mandatory</a> = <b>true</b>, <a href="../../Attributes.cs.html#91bee819daab0925" class="i property">ParameterSetName</a> = <a href="#fc12f22923e252d9" class="t t">PSSessionConfigurationCommandBase</a>.<a href="#56f05157bcbc7dce" class="i field">AssemblyNameParameterSetName</a>)]
        <b>public string</b> <a id="18fdfb6f8fcc4581" href="../../../R/../../0000000000.html" target="n" data-glyph="102,1" class="i property">ConfigurationTypeName</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#074874d626401161" class="i field">configurationTypeName</a>;
            }
 
            <b>set</b>
            {
                <a href="#074874d626401161" class="i field">configurationTypeName</a> = <b>value</b>;
                <a href="#b2b50b4cfefbcf8c" class="i field">isConfigurationTypeNameSpecified</a> = <b>true</b>;
            }
        }
 
        <b>internal string</b> <a id="074874d626401161" href="../../../R/074874d626401161.html" target="n" data-glyph="44,1" class="i field">configurationTypeName</a>;
        <b>internal bool</b> <a id="b2b50b4cfefbcf8c" href="../../../R/b2b50b4cfefbcf8c.html" target="n" data-glyph="44,1" class="i field">isConfigurationTypeNameSpecified</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Parameter used to specify the RunAs credentials.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>, <span class="i">Credential</span>]
        <b>public</b> <a href="../../Credential.cs.html#6245dc122e2f1916" class="t t">PSCredential</a> <a id="37e94a91a5fa09d0" href="../../../R/../../0000000000.html" target="n" data-glyph="102,1" class="i property">RunAsCredential</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#0c6742692211cee9" class="i field">runAsCredential</a>;
            }
 
            <b>set</b>
            {
                <a href="#0c6742692211cee9" class="i field">runAsCredential</a> = <b>value</b>;
                <a href="#e2e889cb6609651d" class="i field">isRunAsCredentialSpecified</a> = <b>true</b>;
            }
        }
 
        <b>internal</b> <a href="../../Credential.cs.html#6245dc122e2f1916" class="t t">PSCredential</a> <a id="0c6742692211cee9" href="../../../R/0c6742692211cee9.html" target="n" data-glyph="44,1" class="i field">runAsCredential</a>;
        <b>internal bool</b> <a id="e2e889cb6609651d" href="../../../R/e2e889cb6609651d.html" target="n" data-glyph="44,1" class="i field">isRunAsCredentialSpecified</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> ApartmentState of the Runspace created for the shell.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>()]
        <b>public</b> <span class="i">ApartmentState</span> <a id="f9d42e4324bb5490" href="../../../R/../../0000000000.html" target="n" data-glyph="102,1" class="i property">ThreadApartmentState</a>
        {
            <b>get</b>
            {
                <b>if</b> (<a href="#cef28738a403d686" class="i field">threadAptState</a>.<span class="i">HasValue</span>)
                {
                    <b>return</b> <a href="#cef28738a403d686" class="i field">threadAptState</a>.<span class="i">Value</span>;
                }
 
                <b>return</b> <span class="i">ApartmentState</span>.<span class="i">Unknown</span>;
            }
 
            <b>set</b>
            {
                <a href="#cef28738a403d686" class="i field">threadAptState</a> = <b>value</b>;
            }
        }
 
        <b>internal</b> <span class="i">ApartmentState</span>? <a id="cef28738a403d686" href="../../../R/cef28738a403d686.html" target="n" data-glyph="44,1" class="i field">threadAptState</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> ThreadOptions of the Runspace created for the shell.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>()]
        <b>public</b> <a href="../../hostifaces/Connection.cs.html#e3e452d2492397a5" class="t t">PSThreadOptions</a> <a id="c7569cd7b5242d1a" href="../../../R/../../0000000000.html" target="n" data-glyph="102,1" class="i property">ThreadOptions</a>
        {
            <b>get</b>
            {
                <b>if</b> (<a href="#c123bdda35248dcf" class="i field">threadOptions</a>.<span class="i">HasValue</span>)
                {
                    <b>return</b> <a href="#c123bdda35248dcf" class="i field">threadOptions</a>.<span class="i">Value</span>;
                }
 
                <b>return</b> <a href="../../hostifaces/Connection.cs.html#e3e452d2492397a5" class="t t">PSThreadOptions</a>.<a href="../../hostifaces/Connection.cs.html#1eea8c0b04b31e81" class="i field">UseCurrentThread</a>;
            }
 
            <b>set</b>
            {
                <a href="#c123bdda35248dcf" class="i field">threadOptions</a> = <b>value</b>;
            }
        }
 
        <b>internal</b> <a href="../../hostifaces/Connection.cs.html#e3e452d2492397a5" class="t t">PSThreadOptions</a>? <a id="c123bdda35248dcf" href="../../../R/c123bdda35248dcf.html" target="n" data-glyph="44,1" class="i field">threadOptions</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Set access mode.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>]
        <b>public</b> <a href="../common/RunspaceConnectionInfo.cs.html#10edf62c3f6a89b0" class="t t">PSSessionConfigurationAccessMode</a> <a id="66d32f1366ccb752" href="../../../R/66d32f1366ccb752.html" target="n" data-glyph="102,1" class="i property">AccessMode</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#e81248849cd283ec" class="i field">_accessMode</a>;
            }
 
            <b>set</b>
            {
                <a href="#e81248849cd283ec" class="i field">_accessMode</a> = <b>value</b>;
                <a href="#2a410c15d6e039b9" class="i field">accessModeSpecified</a> = <b>true</b>;
            }
        }
 
        <b>private</b> <a href="../common/RunspaceConnectionInfo.cs.html#10edf62c3f6a89b0" class="t t">PSSessionConfigurationAccessMode</a> <a id="e81248849cd283ec" href="../../../R/e81248849cd283ec.html" target="n" data-glyph="46,1" class="i field">_accessMode</a> = <a href="../common/RunspaceConnectionInfo.cs.html#10edf62c3f6a89b0" class="t t">PSSessionConfigurationAccessMode</a>.<a href="../common/RunspaceConnectionInfo.cs.html#f9938a92bb1a8e5f" class="i field">Remote</a>;
        <b>internal bool</b> <a id="2a410c15d6e039b9" href="../../../R/2a410c15d6e039b9.html" target="n" data-glyph="44,1" class="i field">accessModeSpecified</a> = <b>false</b>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Host mode.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>]
        <b>public</b> <a href="../../MshCmdlet.cs.html#8260026027378f6c" class="t t">SwitchParameter</a> <a id="50cd764b2f18a757" href="../../../R/50cd764b2f18a757.html" target="n" data-glyph="102,1" class="i property">UseSharedProcess</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#346b980f935e9f08" class="i field">_useSharedProcess</a>;
            }
 
            <b>set</b>
            {
                <a href="#346b980f935e9f08" class="i field">_useSharedProcess</a> = <b>value</b>;
                <a href="#8534b4735dcf261a" class="i field">isUseSharedProcessSpecified</a> = <b>true</b>;
            }
        }
 
        <b>private bool</b> <a id="346b980f935e9f08" href="../../../R/346b980f935e9f08.html" target="n" data-glyph="46,1" class="i field">_useSharedProcess</a>;
        <b>internal bool</b> <a id="8534b4735dcf261a" href="../../../R/8534b4735dcf261a.html" target="n" data-glyph="44,1" class="i field">isUseSharedProcessSpecified</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Initialization script to run upon Runspace creation for this shell.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>()]
        <b>public string</b> <a id="9c584c5e98b1671b" href="../../../R/../../0000000000.html" target="n" data-glyph="102,1" class="i property">StartupScript</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#fb73a00555a3f409" class="i field">configurationScript</a>;
            }
 
            <b>set</b>
            {
                <a href="#fb73a00555a3f409" class="i field">configurationScript</a> = <b>value</b>;
                <a href="#4bd82b2f9c7eafd4" class="i field">isConfigurationScriptSpecified</a> = <b>true</b>;
            }
        }
 
        <b>internal string</b> <a id="fb73a00555a3f409" href="../../../R/fb73a00555a3f409.html" target="n" data-glyph="44,1" class="i field">configurationScript</a>;
        <b>internal bool</b> <a id="4bd82b2f9c7eafd4" href="../../../R/4bd82b2f9c7eafd4.html" target="n" data-glyph="44,1" class="i field">isConfigurationScriptSpecified</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Total data (in MB) that can be received from a remote machine</span>
        <span class="c">///</span><span class="c"> targeted towards a command.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>()]
        [<span class="i">AllowNull</span>]
        <b>public double</b>? <a id="4d3aa33d8456f9a9" href="../../../R/../../0000000000.html" target="n" data-glyph="102,1" class="i property">MaximumReceivedDataSizePerCommandMB</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#da4464aa9e583b35" class="i field">maxCommandSizeMB</a>;
            }
 
            <b>set</b>
            {
                <b>if</b> ((<b>value</b>.<span class="i">HasValue</span>) &amp;&amp; (<b>value</b>.<span class="i">Value</span> &lt; 0))
                {
                    <b>throw</b> <b>new</b> <span class="i">ArgumentException</span>(
                        <a href="../common/remotingexceptions.cs.html#53047fc052e9b445" class="t t">PSRemotingErrorInvariants</a>.<span class="i">FormatResourceString</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">CSCDoubleParameterOutOfRange</span>,
                            <b>value</b>.<span class="i">Value</span>, <span class="s">&quot;MaximumReceivedDataSizePerCommandMB&quot;</span>)
                        );
                }
 
                <a href="#da4464aa9e583b35" class="i field">maxCommandSizeMB</a> = <b>value</b>;
                <a href="#4a8486b780353476" class="i field">isMaxCommandSizeMBSpecified</a> = <b>true</b>;
            }
        }
 
        <b>internal double</b>? <a id="da4464aa9e583b35" href="../../../R/da4464aa9e583b35.html" target="n" data-glyph="44,1" class="i field">maxCommandSizeMB</a>;
        <b>internal bool</b> <a id="4a8486b780353476" href="../../../R/4a8486b780353476.html" target="n" data-glyph="44,1" class="i field">isMaxCommandSizeMBSpecified</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Maximum size (in MB) of a deserialized object received from a remote machine.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>()]
        [<span class="i">AllowNull</span>]
        <b>public double</b>? <a id="d45b57ca4b2d73af" href="../../../R/../../0000000000.html" target="n" data-glyph="102,1" class="i property">MaximumReceivedObjectSizeMB</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#37570a27dc4089f7" class="i field">maxObjectSizeMB</a>;
            }
 
            <b>set</b>
            {
                <b>if</b> ((<b>value</b>.<span class="i">HasValue</span>) &amp;&amp; (<b>value</b>.<span class="i">Value</span> &lt; 0))
                {
                    <b>throw</b> <b>new</b> <span class="i">ArgumentException</span>(
                        <a href="../common/remotingexceptions.cs.html#53047fc052e9b445" class="t t">PSRemotingErrorInvariants</a>.<span class="i">FormatResourceString</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">CSCDoubleParameterOutOfRange</span>,
                            <b>value</b>.<span class="i">Value</span>, <span class="s">&quot;MaximumReceivedObjectSizeMB&quot;</span>)
                        );
                }
 
                <a href="#37570a27dc4089f7" class="i field">maxObjectSizeMB</a> = <b>value</b>;
                <a href="#39b7869b95e51698" class="i field">isMaxObjectSizeMBSpecified</a> = <b>true</b>;
            }
        }
 
        <b>internal double</b>? <a id="37570a27dc4089f7" href="../../../R/37570a27dc4089f7.html" target="n" data-glyph="44,1" class="i field">maxObjectSizeMB</a>;
        <b>internal bool</b> <a id="39b7869b95e51698" href="../../../R/39b7869b95e51698.html" target="n" data-glyph="44,1" class="i field">isMaxObjectSizeMBSpecified</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This enables the user to specify an SDDL on the shell.</span>
        <span class="c">///</span><span class="c"> The default SDDL is the default used by Wsman.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>()]
        <b>public string</b> <a id="53763c26802a6073" href="../../../R/53763c26802a6073.html" target="n" data-glyph="102,1" class="i property">SecurityDescriptorSddl</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#e47691b9a35b161f" class="i field">sddl</a>;
            }
 
            <b>set</b>
            {
                <b>if</b> (!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<b>value</b>))
                {
                    <span class="c">// this will validate if the sddl is valid.</span>
                    <span class="i">CommonSecurityDescriptor</span> <span id="r196 rd" class="r196 r">c</span> = <b>new</b> <span class="i">CommonSecurityDescriptor</span>(<b>false</b>, <b>false</b>, <b>value</b>);
                    <span class="c">// this will never be the case..as constructor either constructs or throws.</span>
                    <span class="c">// this is used here to avoid FxCop violation.</span>
                    <b>if</b> (<span class="r196 r">c</span> == <b>null</b>)
                    {
                        <b>throw</b> <b>new</b> <span class="i">NotSupportedException</span>();
                    }
                }
 
                <a href="#e47691b9a35b161f" class="i field">sddl</a> = <b>value</b>;
                <a href="#ea050dfcef60d743" class="i field">isSddlSpecified</a> = <b>true</b>;
            }
        }
 
        <b>internal string</b> <a id="e47691b9a35b161f" href="../../../R/e47691b9a35b161f.html" target="n" data-glyph="44,1" class="i field">sddl</a>;
        <b>internal bool</b> <a id="ea050dfcef60d743" href="../../../R/ea050dfcef60d743.html" target="n" data-glyph="44,1" class="i field">isSddlSpecified</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Shows a UI to choose permissions/access rights for this session configuration.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>()]
        <b>public</b> <a href="../../MshCmdlet.cs.html#8260026027378f6c" class="t t">SwitchParameter</a> <a id="e14e225be242dd67" href="../../../R/e14e225be242dd67.html" target="n" data-glyph="102,1" class="i property">ShowSecurityDescriptorUI</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#27832e980c229721" class="i field">_showUI</a>;
            }
 
            <b>set</b>
            {
                <a href="#27832e980c229721" class="i field">_showUI</a> = <b>value</b>;
                <a href="#f5740b3f379662bf" class="i field">showUISpecified</a> = <b>true</b>;
            }
        }
 
        <b>private bool</b> <a id="27832e980c229721" href="../../../R/27832e980c229721.html" target="n" data-glyph="46,1" class="i field">_showUI</a>;
        <b>internal bool</b> <a id="f5740b3f379662bf" href="../../../R/f5740b3f379662bf.html" target="n" data-glyph="44,1" class="i field">showUISpecified</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Property that sets force parameter. This will allow</span>
        <span class="c">///</span><span class="c"> restarting the WinRM service after the changes were</span>
        <span class="c">///</span><span class="c"> made.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>()]
        <b>public</b> <a href="../../MshCmdlet.cs.html#8260026027378f6c" class="t t">SwitchParameter</a> <a id="e0d3550cf787fbdc" href="../../../R/e0d3550cf787fbdc.html" target="n" data-glyph="102,1" class="i property">Force</a>
        {
            <b>get</b> { <b>return</b> <a href="#06d26f0ccfb63d9a" class="i field">force</a>; }
 
            <b>set</b> { <a href="#06d26f0ccfb63d9a" class="i field">force</a> = <b>value</b>; }
        }
 
        <b>internal bool</b> <a id="06d26f0ccfb63d9a" href="../../../R/06d26f0ccfb63d9a.html" target="n" data-glyph="44,1" class="i field">force</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If true, then the cmdlet will not attempt to restart</span>
        <span class="c">///</span><span class="c"> WinRM service after completion. Typically WinRM service</span>
        <span class="c">///</span><span class="c"> need to be restarted for changes to take place.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>()]
        <b>public</b> <a href="../../MshCmdlet.cs.html#8260026027378f6c" class="t t">SwitchParameter</a> <a id="2fdf0b5c3e1edd16" href="../../../R/../../0000000000.html" target="n" data-glyph="102,1" class="i property">NoServiceRestart</a>
        {
            <b>get</b> { <b>return</b> <a href="#89e5f845fe6ddd31" class="i field">noRestart</a>; }
 
            <b>set</b> { <a href="#89e5f845fe6ddd31" class="i field">noRestart</a> = <b>value</b>; }
        }
 
        <b>internal bool</b> <a id="89e5f845fe6ddd31" href="../../../R/89e5f845fe6ddd31.html" target="n" data-glyph="44,1" class="i field">noRestart</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Property corresponding to PSVersion parameter in the ConfigXML. This is treated as the minimum PowerShell version to load.</span>
        <span class="c">///</span><span class="c"> This will allow existing endpoints creating during migration or upgrade that have PSVersion=2.0 to roll forward to PowerShell 3.0 automatically without changing the ConfigXML.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>(<a href="../../Attributes.cs.html#91bee819daab0925" class="i property">ParameterSetName</a> = <a href="#567a3254f0a1b9e7" class="i field">NameParameterSetName</a>)]
        [<span class="i">Parameter</span>(<a href="../../Attributes.cs.html#91bee819daab0925" class="i property">ParameterSetName</a> = <a href="#56f05157bcbc7dce" class="i field">AssemblyNameParameterSetName</a>)]
        [<span class="i">Alias</span>(<span class="s">&quot;PowerShellVersion&quot;</span>)]
        [<span class="i">ValidateNotNullOrEmpty</span>]
        <b>public</b> <span class="i">Version</span> <a id="716174720103792d" href="../../../R/716174720103792d.html" target="n" data-glyph="102,1" class="i property">PSVersion</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#9a883983f56cfb3d" class="i field">psVersion</a>;
            }
 
            <b>set</b>
            {
                <a href="remotingcommandutil.cs.html#4c008a65630ba320" class="t t">RemotingCommandUtil</a>.<a href="remotingcommandutil.cs.html#806a5de78f6245e4" class="i method">CheckPSVersion</a>(<b>value</b>);
 
                <span class="c">// Check if specified version of PowerShell is installed</span>
                <a href="remotingcommandutil.cs.html#4c008a65630ba320" class="t t">RemotingCommandUtil</a>.<a href="remotingcommandutil.cs.html#f3a218544b1ada2c" class="i method">CheckIfPowerShellVersionIsInstalled</a>(<b>value</b>);
 
                <a href="#9a883983f56cfb3d" class="i field">psVersion</a> = <b>value</b>;
                <a href="#461be9a9e6b577d5" class="i field">isPSVersionSpecified</a> = <b>true</b>;
            }
        }
 
        <b>internal</b> <span class="i">Version</span> <a id="9a883983f56cfb3d" href="../../../R/9a883983f56cfb3d.html" target="n" data-glyph="44,1" class="i field">psVersion</a>;
        <b>internal bool</b> <a id="461be9a9e6b577d5" href="../../../R/461be9a9e6b577d5.html" target="n" data-glyph="44,1" class="i field">isPSVersionSpecified</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> SessionTypeOption.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>(<a href="../../Attributes.cs.html#91bee819daab0925" class="i property">ParameterSetName</a> = <a href="#567a3254f0a1b9e7" class="i field">NameParameterSetName</a>)]
        [<span class="i">Parameter</span>(<a href="../../Attributes.cs.html#91bee819daab0925" class="i property">ParameterSetName</a> = <a href="#56f05157bcbc7dce" class="i field">AssemblyNameParameterSetName</a>)]
        <b>public</b> <a href="../common/PSSessionConfigurationTypeOption.cs.html#0fe5ad4095bca803" class="t t">PSSessionTypeOption</a> <a id="a7bb8e9e9934ad36" href="../../../R/../../0000000000.html" target="n" data-glyph="102,1" class="i property">SessionTypeOption</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#f113546061e03199" class="i field">sessionTypeOption</a>;
            }
 
            <b>set</b>
            {
                <a href="#f113546061e03199" class="i field">sessionTypeOption</a> = <b>value</b>;
            }
        }
 
        <b>internal</b> <a href="../common/PSSessionConfigurationTypeOption.cs.html#0fe5ad4095bca803" class="t t">PSSessionTypeOption</a> <a id="f113546061e03199" href="../../../R/f113546061e03199.html" target="n" data-glyph="44,1" class="i field">sessionTypeOption</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> TransportOption.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>]
        <b>public</b> <a href="../common/PSSessionConfigurationTypeOption.cs.html#4b3c3be23aa5f156" class="t t">PSTransportOption</a> <a id="b02ba966fd6892da" href="../../../R/../../0000000000.html" target="n" data-glyph="102,1" class="i property">TransportOption</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#47818cf18fb88e71" class="i field">transportOption</a>;
            }
 
            <b>set</b>
            {
                <a href="#47818cf18fb88e71" class="i field">transportOption</a> = <b>value</b>;
            }
        }
 
        <b>internal</b> <a href="../common/PSSessionConfigurationTypeOption.cs.html#4b3c3be23aa5f156" class="t t">PSTransportOption</a> <a id="47818cf18fb88e71" href="../../../R/47818cf18fb88e71.html" target="n" data-glyph="44,1" class="i field">transportOption</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> ModulesToImport.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>(<a href="../../Attributes.cs.html#91bee819daab0925" class="i property">ParameterSetName</a> = <a href="#567a3254f0a1b9e7" class="i field">NameParameterSetName</a>)]
        [<span class="i">Parameter</span>(<a href="../../Attributes.cs.html#91bee819daab0925" class="i property">ParameterSetName</a> = <a href="#56f05157bcbc7dce" class="i field">AssemblyNameParameterSetName</a>)]
        <b>public object</b>[] <a id="625d210cb45deb9c" href="../../../R/../../0000000000.html" target="n" data-glyph="102,1" class="i property">ModulesToImport</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#647dbedff4303e3b" class="i field">modulesToImport</a>;
            }
 
            <b>set</b>
            {
                <span class="i">List</span>&lt;<b>object</b>&gt; <span id="r197 rd" class="r197 r">modulesToImportList</span> = <b>new</b> <span class="i">List</span>&lt;<b>object</b>&gt;();
                <b>if</b> (<b>value</b> != <b>null</b>)
                {
                    <b>foreach</b> (<b>var</b> <span id="r198 rd" class="r198 r">s</span> <b>in</b> <b>value</b>)
                    {
                        <b>var</b> <span id="r199 rd" class="r199 r">hashtable</span> = <span class="r198 r">s</span> <b>as</b> <span class="i">Hashtable</span>;
 
                        <b>if</b> (<span class="r199 r">hashtable</span> != <b>null</b>)
                        {
                            <a href="../../Modules/ModuleSpecification.cs.html#1fd961b021940b6a" class="k">var</a> <span id="r200 rd" class="r200 r">moduleSpec</span> = <b>new</b> <a href="../../Modules/ModuleSpecification.cs.html#e40ff4979fd4b540" class="t constructor">ModuleSpecification</a>(<span class="r199 r">hashtable</span>);
                            <b>if</b> (<span class="r200 r">moduleSpec</span> != <b>null</b>)
                            {
                                <span class="r197 r">modulesToImportList</span>.<span class="i">Add</span>(<span class="r200 r">moduleSpec</span>);
                            }
 
                            <b>continue</b>;
                        }
 
                        <span class="c">// Getting the string value of the object if it is not a ModuleSpecification, this is required for the cases like PSObject is specified as ModulesToImport value.</span>
                        <b>string</b> <span id="r201 rd" class="r201 r">modulepath</span> = <span class="r198 r">s</span>.<span class="i">ToString</span>();
                        <span class="c">// Add this check after checking if it a path</span>
                        <b>if</b> (!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r201 r">modulepath</span>.<span class="i">Trim</span>()))
                        {
                            <b>if</b> ((<span class="r201 r">modulepath</span>.<span class="i">Contains</span>(<span class="s">&#39;\\&#39;</span>) || <span class="r201 r">modulepath</span>.<span class="i">Contains</span>(<span class="s">&#39;:&#39;</span>)) &amp;&amp;
                                !(<span class="i">Directory</span>.<span class="i">Exists</span>(<span class="r201 r">modulepath</span>) || <span class="i">File</span>.<span class="i">Exists</span>(<span class="r201 r">modulepath</span>)))
                            {
                                <b>throw</b> <b>new</b> <span class="i">ArgumentException</span>(
                                    <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(
                                        <span class="i">RemotingErrorIdStrings</span>.<span class="i">InvalidRegisterPSSessionConfigurationModulePath</span>,
                                        <span class="r201 r">modulepath</span>));
                            }
 
                            <span class="r197 r">modulesToImportList</span>.<span class="i">Add</span>(<span class="r201 r">modulepath</span>);
                        }
                    }
                }
 
                <a href="#647dbedff4303e3b" class="i field">modulesToImport</a> = <span class="r197 r">modulesToImportList</span>.<span class="i">ToArray</span>();
                <a href="#edd32a5daaa63fbd" class="i field">modulePathSpecified</a> = <b>true</b>;
            }
        }
 
        <b>internal object</b>[] <a id="647dbedff4303e3b" href="../../../R/647dbedff4303e3b.html" target="n" data-glyph="44,1" class="i field">modulesToImport</a>;
        <b>internal bool</b> <a id="edd32a5daaa63fbd" href="../../../R/edd32a5daaa63fbd.html" target="n" data-glyph="44,1" class="i field">modulePathSpecified</a> = <b>false</b>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Declaration initial session config file path.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>(<a href="../../Attributes.cs.html#d5ad471518092731" class="i property">Mandatory</a> = <b>true</b>, <a href="../../Attributes.cs.html#91bee819daab0925" class="i property">ParameterSetName</a> = <a href="#f428f7553cdf4887" class="i field">SessionConfigurationFileParameterSetName</a>)]
        [<span class="i">ValidateNotNullOrEmpty</span>]
        <b>public string</b> <a id="7f0833e245fe41bc" href="../../../R/7f0833e245fe41bc.html" target="n" data-glyph="102,1" class="i property">Path</a> { <b>get</b>; <b>set</b>; }
 
        <span class="c">// Other helper variables that come along with the path</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>protected bool</b> <a id="4dcf2ffea1a67e82" href="../../../R/4dcf2ffea1a67e82.html" target="n" data-glyph="105,1" class="i property">RunAsVirtualAccount</a> { <b>get</b>; <b>set</b>; } = <b>false</b>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>protected bool</b> <a id="73a5a75f7a76f61d" href="../../../R/73a5a75f7a76f61d.html" target="n" data-glyph="105,1" class="i property">RunAsVirtualAccountSpecified</a> { <b>get</b>; <b>set</b>; } = <b>false</b>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Comma delimited string specifying groups a virtual account is associated with.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>protected string</b> <a id="2d1b945158ed0b9a" href="../../../R/2d1b945158ed0b9a.html" target="n" data-glyph="105,1" class="i property">RunAsVirtualAccountGroups</a> { <b>get</b>; <b>set</b>; }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Constructor
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This is internal to make 3rd parties not derive from this cmdlet.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal</b> <a id="575fdc8a66a0fcbb" href="../../../R/../../0000000000.html" target="n" data-glyph="74,1" class="t constructor">PSSessionConfigurationCommandBase</a>()
        {
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
    }
 
    <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
    <span class="k preprocess">#</span><span class="k preprocess">region</span> Unregister-PSSessionConfiguration cmdlet
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Class implementing Unregister-PSSessionConfiguration.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    [<span class="i">Cmdlet</span>(<a href="../../../utils/Verbs.cs.html#1a8e85c66f6fff18" class="t t">VerbsLifecycle</a>.<a href="../../../utils/Verbs.cs.html#5a679ca92ff49d58" class="i field">Unregister</a>, <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#d19a1042a44001e8" class="t t">RemotingConstants</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#3188dd90ac4b908b" class="i field">PSSessionConfigurationNoun</a>,
        <span class="i">SupportsShouldProcess</span> = <b>true</b>, <span class="i">ConfirmImpact</span> = <a href="../../CommandBase.cs.html#ba94675b57c6d6e9" class="t t">ConfirmImpact</a>.<a href="../../CommandBase.cs.html#9bb946a0731a8a9e" class="i field">Low</a>, <span class="i">HelpUri</span> = <span class="s">&quot;https://go.microsoft.com/fwlink/?LinkID=2096803&quot;</span>)]
    <b>public sealed class</b> <a id="d9cf941b779180ee" href="../../../R/d9cf941b779180ee.html" target="n" data-glyph="0,0" class="t t"><span id="715c8ef1aa7c978d">UnregisterPSSessionConfigurationCommand</span></a> : <a href="../../../P/30543a6971fed1fc.html#30543a6971fed1fc" class="t t">PSCmdlet</a>
    {
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Private Data
 
        <span class="c">// To Escape &quot; -- &quot;&quot;</span>
        <b>private const string</b> <a id="5ea5c0a2a2a2b4bb" href="../../../R/5ea5c0a2a2a2b4bb.html" target="n" data-glyph="10,1" class="i field">removePluginSbFormat</a> = <span class="s">@&quot;
function Unregister-PSSessionConfiguration
{{
    [CmdletBinding(SupportsShouldProcess=$true, ConfirmImpact=&quot;&quot;Low&quot;&quot;)]
    param(
       $filter,
       $action,
       $targetTemplate,
       $shellNotErrMsgFormat,
       [bool]$force)
 
    begin
    {{
    }}
 
    process
    {{
        $shellsFound = 0
        Get-ChildItem &#39;WSMan:\localhost\Plugin\&#39; -Force:$force | Where-Object {{ $_.Name -like &quot;&quot;$filter&quot;&quot; }} | ForEach-Object {{
            $pluginFileNamePath = join-path &quot;&quot;$($_.pspath)&quot;&quot; &#39;FileName&#39;
            if (!(test-path &quot;&quot;$pluginFileNamePath&quot;&quot;))
            {{
                return
            }}
 
           $pluginFileName = get-item -literalpath &quot;&quot;$pluginFileNamePath&quot;&quot;
           if ((!$pluginFileName) -or ($pluginFileName.Value -notmatch &#39;{0}&#39;))
           {{
                return
           }}
           else
           {{
                if (($pluginFileName.Value -match &#39;system32\\{0}&#39;) -OR
                    ($pluginFileName.Value -match &#39;syswow64\\{0}&#39;))
                {{
                    # Filter out WindowsPowerShell endpoints when running as PowerShell 6+
                    return
                }}
           }}
 
           $shellsFound++
 
           $shouldProcessTargetString = $targetTemplate -f $_.Name
 
           $DISCConfigFilePath = [System.IO.Path]::Combine($_.PSPath, &quot;&quot;InitializationParameters&quot;&quot;)
           $DISCConfigFile = get-childitem -literalpath &quot;&quot;$DISCConfigFilePath&quot;&quot; | Where-Object {{$_.Name -like &quot;&quot;configFilePath&quot;&quot;}}
 
           if($null -ne $DISCConfigFile)
           {{
               if(test-path -LiteralPath &quot;&quot;$($DISCConfigFile.Value)&quot;&quot;) {{
                       remove-item -literalpath &quot;&quot;$($DISCConfigFile.Value)&quot;&quot; -recurse -force -confirm:$false
               }}
           }}
 
           if($force -or $pscmdlet.ShouldProcess($shouldProcessTargetString, $action))
           {{
                remove-item -literalpath &quot;&quot;$($_.pspath)&quot;&quot; -recurse -force -confirm:$false
           }}
        }}
 
        if (!$shellsFound)
        {{
            $errMsg = $shellNotErrMsgFormat -f $filter
            Write-Error $errMsg
        }}
    }} # end of Process block
}}
 
if ($null -eq $args[7])
{{
    Unregister-PSSessionConfiguration -filter $args[0] -whatif:$args[1] -confirm:$args[2] -action $args[3] -targetTemplate $args[4] -shellNotErrMsgFormat $args[5] -force $args[6]
}}
else
{{
    Unregister-PSSessionConfiguration -filter $args[0] -whatif:$args[1] -confirm:$args[2] -action $args[3] -targetTemplate $args[4] -shellNotErrMsgFormat $args[5] -force $args[6] -erroraction $args[7]
}}
&quot;</span>;
 
        <b>private static readonly</b> <a href="../../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="t t">ScriptBlock</a> <a id="88cd61ea7e626041" href="../../../R/88cd61ea7e626041.html" target="n" data-glyph="46,1" class="i field">s_removePluginSb</a>;
        <b>private bool</b> <a id="56eb52df8ef9614e" href="../../../R/56eb52df8ef9614e.html" target="n" data-glyph="46,1" class="i field">_isErrorReported</a>;
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Parameters
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This parameter enables the user to specify a shell name to</span>
        <span class="c">///</span><span class="c"> remove.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>(<a href="../../Attributes.cs.html#d5ad471518092731" class="i property">Mandatory</a> = <b>true</b>, <a href="../../Attributes.cs.html#19ccfeb1cdbdb967" class="i property">Position</a> = 0, <a href="../../Attributes.cs.html#aded474eaec9cde8" class="i property">ValueFromPipelineByPropertyName</a> = <b>true</b>)]
        [<span class="i">ValidateNotNullOrEmpty</span>]
        <b>public string</b> <a id="58ae0d68d57b712f" href="../../../R/58ae0d68d57b712f.html" target="n" data-glyph="102,1" class="i property">Name</a> { <b>get</b>; <b>set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Property that sets force parameter. This will allow</span>
        <span class="c">///</span><span class="c"> restarting the WinRM service after the changes were</span>
        <span class="c">///</span><span class="c"> made.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>()]
        <b>public</b> <a href="../../MshCmdlet.cs.html#8260026027378f6c" class="t t">SwitchParameter</a> <a id="17bfb35b074c49dd" href="../../../R/../../0000000000.html" target="n" data-glyph="102,1" class="i property">Force</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#7042b005c321192d" class="i field">_force</a>;
            }
 
            <b>set</b>
            {
                <a href="#7042b005c321192d" class="i field">_force</a> = <b>value</b>;
            }
        }
 
        <b>private bool</b> <a id="7042b005c321192d" href="../../../R/7042b005c321192d.html" target="n" data-glyph="46,1" class="i field">_force</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If true, then the cmdlet will not attempt to restart</span>
        <span class="c">///</span><span class="c"> WinRM service after completion. Typically WinRM service</span>
        <span class="c">///</span><span class="c"> need to be restarted for changes to take place.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>()]
        <b>public</b> <a href="../../MshCmdlet.cs.html#8260026027378f6c" class="t t">SwitchParameter</a> <a id="f81543a920cc2208" href="../../../R/../../0000000000.html" target="n" data-glyph="102,1" class="i property">NoServiceRestart</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#d1994454bcd91089" class="i field">_noRestart</a>;
            }
 
            <b>set</b>
            {
                <a href="#d1994454bcd91089" class="i field">_noRestart</a> = <b>value</b>;
            }
        }
 
        <b>private bool</b> <a id="d1994454bcd91089" href="../../../R/d1994454bcd91089.html" target="n" data-glyph="46,1" class="i field">_noRestart</a>;
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Constructors
 
        <b>static</b> <a id="fde4dd7f1b2245ec" href="../../../R/../../0000000000.html" target="n" data-glyph="76,1" class="t method">UnregisterPSSessionConfigurationCommand</a>()
        {
            <b>string</b> <span id="r202 rd" class="r202 r">removePluginScript</span> = <b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>,
                <a href="#5ea5c0a2a2a2b4bb" class="i field">removePluginSbFormat</a>,
                <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#d19a1042a44001e8" class="t t">RemotingConstants</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#7cbb6da0d7ec5022" class="i field">PSPluginDLLName</a>);
            <span class="c">// compile the script block statically and reuse the same instance</span>
            <span class="c">// everytime the command is run..This will save on parsing time.</span>
            <a href="#88cd61ea7e626041" class="i field">s_removePluginSb</a> = <a href="../../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="t t">ScriptBlock</a>.<a href="../../lang/scriptblock.cs.html#adfac0fa7bf5725f" class="i method">Create</a>(<span class="r202 r">removePluginScript</span>);
            <a href="#88cd61ea7e626041" class="i field">s_removePluginSb</a>.<a href="../../lang/scriptblock.cs.html#5e76a9fb0d1a7f12" class="i property">LanguageMode</a> = <a href="../../SessionStatePublic.cs.html#450052824aba2e3f" class="t t">PSLanguageMode</a>.<a href="../../SessionStatePublic.cs.html#eec721eb8c02f156" class="i field">FullLanguage</a>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Cmdlet Overrides
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Verifies if remoting cmdlets can be used.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>protected override void</b> <a id="fe7e3abe2e6af410" href="../../../R/fe7e3abe2e6af410.html" target="n" data-glyph="75,1" class="i method">BeginProcessing</a>()
        {
            <a href="remotingcommandutil.cs.html#4c008a65630ba320" class="t t">RemotingCommandUtil</a>.<a href="remotingcommandutil.cs.html#668e049b2f134726" class="i method">CheckRemotingCmdletPrerequisites</a>();
            <a href="#2111ec231989f662" class="t t">PSSessionConfigurationCommandUtilities</a>.<a href="#e6567bb211cb1a98" class="i method">ThrowIfNotAdministrator</a>();
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>protected override void</b> <a id="bd77202841796abd" href="../../../R/bd77202841796abd.html" target="n" data-glyph="75,1" class="i method">ProcessRecord</a>()
        {
            <a href="../../cmdlet.cs.html#377660744c64cd7e" class="i method">WriteVerbose</a>(<a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">RcsScriptMessageV</span>, <a href="#5ea5c0a2a2a2b4bb" class="i field">removePluginSbFormat</a>));
 
            <b>string</b> <span id="r203 rd" class="r203 r">action</span> = <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">CSShouldProcessAction</span>,
                <a href="#d9cf941b779180ee" class="k">this</a>.<a href="../../CommandBase.cs.html#1f4a1f38862b466a" class="i property">CommandInfo</a>.<a href="../../CommandInfo.cs.html#02e11b521c500195" class="i property">Name</a>);
            <b>string</b> <span id="r204 rd" class="r204 r">targetTemplate</span> = <span class="i">RemotingErrorIdStrings</span>.<span class="i">CSShouldProcessTarget</span>;
            <b>string</b> <span id="r205 rd" class="r205 r">csNotFoundMessageFormat</span> = <span class="i">RemotingErrorIdStrings</span>.<span class="i">CustomShellNotFound</span>;
 
            <span class="c">// gather -WhatIf, -Confirm parameter data and pass it to the script block</span>
            <b>bool</b> <span id="r206 rd" class="r206 r">whatIf</span> = <b>false</b>;
            <span class="c">// confirm is always true to start with</span>
            <b>bool</b> <span id="r207 rd" class="r207 r">confirm</span> = <b>true</b>;
            <a href="#2111ec231989f662" class="t t">PSSessionConfigurationCommandUtilities</a>.<a href="#62fe0a5dea8c58db" class="i method">CollectShouldProcessParameters</a>(<a href="#d9cf941b779180ee" class="k">this</a>, <b>out</b> <span class="r206 r">whatIf</span>, <b>out</b> <span class="r207 r">confirm</span>);
            <span class="c">// gather -ErrorAction parameter data and pass it to the script block. if -ErrorAction is not set, pass $null in</span>
            <b>object</b> <span id="r208 rd" class="r208 r">errorAction</span> = <b>null</b>;
            <b>if</b> (<a href="../../CommandBase.cs.html#a41a765d70fc9c9d" class="i property">Context</a>.<a href="../../ExecutionContext.cs.html#1146573afe2845c8" class="i property">CurrentCommandProcessor</a>.<a href="../../CommandProcessorBase.cs.html#d539d84981be114a" class="i property">CommandRuntime</a>.<a href="../../MshCommandRuntime.cs.html#4e39bf0444feb43b" class="i property">IsErrorActionSet</a>)
            {
                <span class="r208 r">errorAction</span> = <a href="../../CommandBase.cs.html#a41a765d70fc9c9d" class="i property">Context</a>.<a href="../../ExecutionContext.cs.html#1146573afe2845c8" class="i property">CurrentCommandProcessor</a>.<a href="../../CommandProcessorBase.cs.html#d539d84981be114a" class="i property">CommandRuntime</a>.<a href="../../MshCommandRuntime.cs.html#0135181adbe24516" class="i property">ErrorAction</a>;
            }
 
            <span class="i">ArrayList</span> <span id="r209 rd" class="r209 r">errorList</span> = (<span class="i">ArrayList</span>)<a href="../../CommandBase.cs.html#a41a765d70fc9c9d" class="i property">Context</a>.<a href="../../ExecutionContext.cs.html#9f5bde284d161965" class="i property">DollarErrorVariable</a>;
            <b>int</b> <span id="r210 rd" class="r210 r">errorCountBefore</span> = <span class="r209 r">errorList</span>.<span class="i">Count</span>;
 
            <a href="#88cd61ea7e626041" class="i field">s_removePluginSb</a>.<span class="i">InvokeUsingCmdlet</span>(
                <span class="i">contextCmdlet</span>: <a href="#d9cf941b779180ee" class="k">this</a>,
                <span class="i">useLocalScope</span>: <b>true</b>,
                <span class="i">errorHandlingBehavior</span>: <a href="../../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="t t">ScriptBlock</a>.<a href="../../lang/scriptblock.cs.html#10c045824f712272" class="t t">ErrorHandlingBehavior</a>.<a href="../../lang/scriptblock.cs.html#5e78734ffe1c6ed3" class="i field">WriteToCurrentErrorPipe</a>,
                <span class="i">dollarUnder</span>: <a href="../../AutomationNull.cs.html#681fbea4c40e4af1" class="t t">AutomationNull</a>.<a href="../../AutomationNull.cs.html#1cf7e193da582896" class="i property">Value</a>,
                <span class="i">input</span>: <span class="i">Array</span>.<span class="i">Empty</span>&lt;<b>object</b>&gt;(),
                <span class="i">scriptThis</span>: <a href="../../AutomationNull.cs.html#681fbea4c40e4af1" class="t t">AutomationNull</a>.<a href="../../AutomationNull.cs.html#1cf7e193da582896" class="i property">Value</a>,
                <span class="i">args</span>: <b>new</b> <b>object</b>[] {
                                           <a href="#58ae0d68d57b712f" class="i property">Name</a>,
                                           <span class="r206 r">whatIf</span>,
                                           <span class="r207 r">confirm</span>,
                                           <span class="r203 r">action</span>,
                                           <span class="r204 r">targetTemplate</span>,
                                           <span class="r205 r">csNotFoundMessageFormat</span>,
                                           <a href="#7042b005c321192d" class="i field">_force</a>,
                                           <span class="r208 r">errorAction</span>
                                    });
 
            <span class="r209 r">errorList</span> = (<span class="i">ArrayList</span>)<a href="../../CommandBase.cs.html#a41a765d70fc9c9d" class="i property">Context</a>.<a href="../../ExecutionContext.cs.html#9f5bde284d161965" class="i property">DollarErrorVariable</a>;
            <a href="#56eb52df8ef9614e" class="i field">_isErrorReported</a> = <span class="r209 r">errorList</span>.<span class="i">Count</span> &gt; <span class="r210 r">errorCountBefore</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>protected override void</b> <a id="f47c9c6c662ed33f" href="../../../R/f47c9c6c662ed33f.html" target="n" data-glyph="75,1" class="i method">EndProcessing</a>()
        {
            <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Tracing</span>.<a href="../../../P/5b1d077d1aa35b55.html#5b1d077d1aa35b55" class="t t">Tracer</a> <span id="r211 rd" class="r211 r">tracer</span> = <b>new</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Tracing</span>.<a href="../../../utils/tracing/TracingGen.cs.html#3e4070d535f42333" class="t constructor">Tracer</a>();
            <span class="r211 r">tracer</span>.<span class="i">EndpointUnregistered</span>(<a href="#d9cf941b779180ee" class="k">this</a>.<a href="#58ae0d68d57b712f" class="i property">Name</a>, <span class="i">WindowsIdentity</span>.<span class="i">GetCurrent</span>().<span class="i">Name</span>);
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
    }
 
    <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
    <span class="k preprocess">#</span><span class="k preprocess">region</span> Get-PSSessionConfiguration cmdlet
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Class implementing Get-PSSessionConfiguration.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    [<span class="i">Cmdlet</span>(<a href="../../../utils/Verbs.cs.html#d056c4b8c99405e5" class="t t">VerbsCommon</a>.<a href="../../../utils/Verbs.cs.html#7ee9f5441476f642" class="i field">Get</a>, <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#d19a1042a44001e8" class="t t">RemotingConstants</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#3188dd90ac4b908b" class="i field">PSSessionConfigurationNoun</a>, <span class="i">HelpUri</span> = <span class="s">&quot;https://go.microsoft.com/fwlink/?LinkID=2096790&quot;</span>)]
    [<span class="i">OutputType</span>(<span class="s">&quot;Microsoft.PowerShell.Commands.PSSessionConfigurationCommands#PSSessionConfiguration&quot;</span>)]
    <b>public sealed class</b> <a id="1dd3de040a657cc9" href="../../../R/1dd3de040a657cc9.html" target="n" data-glyph="0,0" class="t t"><span id="9121f552facff194">GetPSSessionConfigurationCommand</span></a> : <a href="../../../P/30543a6971fed1fc.html#30543a6971fed1fc" class="t t">PSCmdlet</a>
    {
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Private Data
 
        <span class="c">// To Escape { -- {{</span>
        <span class="c">// To Escape } -- }}</span>
        <span class="c">// To Escape &quot; -- &quot;&quot;</span>
 
        <b>private const string</b> <a id="d6b865e3b473fbde" href="../../../R/d6b865e3b473fbde.html" target="n" data-glyph="10,1" class="i field">getPluginSbFormat</a> = <span class="s">@&quot;
function ExtractPluginProperties([string]$pluginDir, $objectToWriteTo)
{{
    function Unescape-Xml($s) {{
        if ($s) {{
            $s = $s.Replace(&quot;&quot;&amp;lt;&quot;&quot;, &quot;&quot;&lt;&quot;&quot;);
            $s = $s.Replace(&quot;&quot;&amp;gt;&quot;&quot;, &quot;&quot;&gt;&quot;&quot;);
            $s = $s.Replace(&quot;&quot;&amp;quot;&quot;&quot;, &#39;&quot;&quot;&#39;);
            $s = $s.Replace(&quot;&quot;&amp;apos;&quot;&quot;, &quot;&quot;&#39;&quot;&quot;);
            $s = $s.Replace(&quot;&quot;&amp;#39;&quot;&quot;, &quot;&quot;&#39;&quot;&quot;);
            $s = $s.Replace(&quot;&quot;&amp;amp;&quot;&quot;, &quot;&quot;&amp;&quot;&quot;);
        }}
 
        return $s;
    }}
 
    # The default comparer is case insensitive and it is supported on Core CLR.
    $h = new-object system.collections.hashtable
 
    function Get-Details([string]$path, [hashtable]$h) {{
        foreach ($o in (get-childitem -LiteralPath $path)) {{
            if ($o.PSIsContainer) {{
                Get-Details $o.PSPath $h
            }} else {{
                $h[$o.Name] = $o.Value
            }}
        }}
    }}
 
    Get-Details $pluginDir $h
 
    if (test-path -LiteralPath $pluginDir\InitializationParameters\SessionConfigurationData) {{
        $xscd = [xml](Unescape-xml (Unescape-xml (get-item -LiteralPath $pluginDir\InitializationParameters\SessionConfigurationData).Value))
 
        foreach ($o in $xscd.SessionConfigurationData.Param) {{
            if ($o.Name -eq &quot;&quot;PrivateData&quot;&quot;) {{
                foreach($wf in $o.PrivateData.Param) {{
                    $h[$wf.Name] = $wf.Value
                }}
            }} else {{
                $h[$o.Name] = $o.Value
            }}
        }}
    }}
 
    ## Extract DISC related information
    if(test-path -LiteralPath $pluginDir\InitializationParameters\ConfigFilePath) {{
        $DISCFilePath = (get-item -LiteralPath $pluginDir\InitializationParameters\ConfigFilePath).Value
 
        if(test-path -LiteralPath $DISCFilePath) {{
            $DISCFileContent = get-content $DISCFilePath | out-string
            $DISCHash = invoke-expression $DISCFileContent
 
            foreach ($o in $DISCHash.Keys) {{
                if ($o -ne &quot;&quot;PowerShellVersion&quot;&quot;) {{
                    $objectToWriteTo = $objectToWriteTo | add-member -membertype noteproperty -name $o -value $DISCHash[$o] -force -passthru
                }}
            }}
        }}
    }}
 
    if ($h[&quot;&quot;SessionConfigurationData&quot;&quot;]) {{
        $h[&quot;&quot;SessionConfigurationData&quot;&quot;] = Unescape-Xml (Unescape-Xml $h[&quot;&quot;SessionConfigurationData&quot;&quot;])
    }}
 
    foreach ($o in $h.Keys) {{
        if ($o -eq &#39;sddl&#39;) {{
            $objectToWriteTo = $objectToWriteTo | add-member -membertype noteproperty -name &#39;SecurityDescriptorSddl&#39; -value $h[$o] -force -passthru
        }} else {{
            $objectToWriteTo = $objectToWriteTo | add-member -membertype noteproperty -name $o -value $h[$o] -force -passthru
        }}
    }}
}}
 
$shellNotErrMsgFormat = $args[1]
$force = $args[2]
$args[0] | ForEach-Object {{
    $shellsFound = 0;
    $filter = $_
    Get-ChildItem &#39;WSMan:\localhost\Plugin\&#39; -Force:$force | ? {{ $_.name -like &quot;&quot;$filter&quot;&quot; }} | ForEach-Object {{
        $customPluginObject = new-object object
        $customPluginObject.pstypenames.Insert(0, &#39;{0}&#39;)
        ExtractPluginProperties &quot;&quot;$($_.PSPath)&quot;&quot; $customPluginObject
        # This is powershell based custom shell only if its plugin dll is pwrshplugin.dll
        if (($customPluginObject.FileName) -and ($customPluginObject.FileName -match &#39;{1}&#39;))
        {{
            # Filter the endpoints based on the typeof PowerShell that is
            # executing the cmdlet. {1} in another location indicates that it
            # is a PowerShell 6+ endpoint
            if (!($customPluginObject.FileName -match &#39;system32\\{1}&#39;) -AND # WindowsPowerShell
                !($customPluginObject.FileName -match &#39;syswow64\\{1}&#39;))     # WOW64 WindowsPowerShell
            {{
                # Add the PowerShell 6+ endpoint when running PowerShell 6+
                $shellsFound++
                $customPluginObject
            }}
        }}
    }} # end of foreach
 
    if (!$shellsFound -and !([System.Management.Automation.WildcardPattern]::ContainsWildcardCharacters($_)))
    {{
      $errMsg = $shellNotErrMsgFormat -f $_
      Write-Error $errMsg
    }}
  }}
&quot;</span>;
 
        <b>private const string</b> <a id="b5e83dca6db331d8" href="../../../R/../../0000000000.html" target="n" data-glyph="10,1" class="i field">MODULEPATH</a> = <span class="s">&quot;ModulesToImport&quot;</span>;
 
        <b>private static readonly</b> <a href="../../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="t t">ScriptBlock</a> <a id="2616847a3f2beed3" href="../../../R/2616847a3f2beed3.html" target="n" data-glyph="46,1" class="i field">s_getPluginSb</a>;
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Constructors
 
        <b>static</b> <a id="eaceeaf810c29340" href="../../../R/../../0000000000.html" target="n" data-glyph="76,1" class="t method">GetPSSessionConfigurationCommand</a>()
        {
            <b>string</b> <span id="r212 rd" class="r212 r">scriptToRun</span> = <b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>,
                <a href="#d6b865e3b473fbde" class="i field">getPluginSbFormat</a>,
                <a href="#2111ec231989f662" class="t t">PSSessionConfigurationCommandUtilities</a>.<a href="#a3aefbc67c6d00d3" class="i field">PSCustomShellTypeName</a>,
                <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#d19a1042a44001e8" class="t t">RemotingConstants</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#7cbb6da0d7ec5022" class="i field">PSPluginDLLName</a>);
            <span class="c">// compile the script block statically and reuse the same instance</span>
            <span class="c">// everytime the command is run..This will save on parsing time.</span>
            <a href="#2616847a3f2beed3" class="i field">s_getPluginSb</a> = <a href="../../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="t t">ScriptBlock</a>.<a href="../../lang/scriptblock.cs.html#adfac0fa7bf5725f" class="i method">Create</a>(<span class="r212 r">scriptToRun</span>);
            <a href="#2616847a3f2beed3" class="i field">s_getPluginSb</a>.<a href="../../lang/scriptblock.cs.html#5e76a9fb0d1a7f12" class="i property">LanguageMode</a> = <a href="../../SessionStatePublic.cs.html#450052824aba2e3f" class="t t">PSLanguageMode</a>.<a href="../../SessionStatePublic.cs.html#eec721eb8c02f156" class="i field">FullLanguage</a>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Parameters
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>(<a href="../../Attributes.cs.html#19ccfeb1cdbdb967" class="i property">Position</a> = 0, <a href="../../Attributes.cs.html#d5ad471518092731" class="i property">Mandatory</a> = <b>false</b>)]
        [<span class="i">ValidateNotNullOrEmpty</span>()]
        <b>public string</b>[] <a id="b5b68404a0d8465e" href="../../../R/b5b68404a0d8465e.html" target="n" data-glyph="102,1" class="i property">Name</a> { <b>get</b>; <b>set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Force parameter.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>()]
        <b>public</b> <a href="../../MshCmdlet.cs.html#8260026027378f6c" class="t t">SwitchParameter</a> <a id="3cfcd505213a3c15" href="../../../R/../../0000000000.html" target="n" data-glyph="102,1" class="i property">Force</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#c01db3f6511e834a" class="i field">_force</a>;
            }
 
            <b>set</b>
            {
                <a href="#c01db3f6511e834a" class="i field">_force</a> = <b>value</b>;
            }
        }
 
        <b>private bool</b> <a id="c01db3f6511e834a" href="../../../R/c01db3f6511e834a.html" target="n" data-glyph="46,1" class="i field">_force</a>;
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Cmdlet Overrides
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Verifies if remoting cmdlets can be used.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>protected override void</b> <a id="a1cd9b2079c806ba" href="../../../R/a1cd9b2079c806ba.html" target="n" data-glyph="75,1" class="i method">BeginProcessing</a>()
        {
            <a href="remotingcommandutil.cs.html#4c008a65630ba320" class="t t">RemotingCommandUtil</a>.<a href="remotingcommandutil.cs.html#668e049b2f134726" class="i method">CheckRemotingCmdletPrerequisites</a>();
            <a href="#2111ec231989f662" class="t t">PSSessionConfigurationCommandUtilities</a>.<a href="#e6567bb211cb1a98" class="i method">ThrowIfNotAdministrator</a>();
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>protected override void</b> <a id="9f40aede2a92baf1" href="../../../R/9f40aede2a92baf1.html" target="n" data-glyph="75,1" class="i method">ProcessRecord</a>()
        {
            <a href="../../cmdlet.cs.html#377660744c64cd7e" class="i method">WriteVerbose</a>(<a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">GcsScriptMessageV</span>, <a href="#d6b865e3b473fbde" class="i field">getPluginSbFormat</a>));
 
            <b>string</b> <span id="r213 rd" class="r213 r">csNotFoundMessageFormat</span> = <span class="i">RemotingErrorIdStrings</span>.<span class="i">CustomShellNotFound</span>;
            <b>object</b> <span id="r214 rd" class="r214 r">arguments</span> = <span class="s">&quot;*&quot;</span>;
            <b>if</b> (<a href="#b5b68404a0d8465e" class="i property">Name</a> != <b>null</b>)
            {
                <span class="r214 r">arguments</span> = <a href="#b5b68404a0d8465e" class="i property">Name</a>;
            }
 
            <a href="../../CommandBase.cs.html#18f88a0529e26331" class="t t">ActionPreference</a> <span id="r215 rd" class="r215 r">backupPreference</span> = <a href="../../CommandBase.cs.html#a41a765d70fc9c9d" class="i property">Context</a>.<a href="../../ExecutionContext.cs.html#b6c4f7d12af19123" class="i property">ErrorActionPreferenceVariable</a>;
            <b>try</b>
            {
                <b>if</b> (<a href="../../CommandBase.cs.html#a41a765d70fc9c9d" class="i property">Context</a>.<a href="../../ExecutionContext.cs.html#1146573afe2845c8" class="i property">CurrentCommandProcessor</a>.<a href="../../CommandProcessorBase.cs.html#d539d84981be114a" class="i property">CommandRuntime</a>.<a href="../../MshCommandRuntime.cs.html#4e39bf0444feb43b" class="i property">IsErrorActionSet</a>)
                {
                    <a href="../../CommandBase.cs.html#a41a765d70fc9c9d" class="i property">Context</a>.<a href="../../ExecutionContext.cs.html#b6c4f7d12af19123" class="i property">ErrorActionPreferenceVariable</a> = <a href="../../CommandBase.cs.html#a41a765d70fc9c9d" class="i property">Context</a>.<a href="../../ExecutionContext.cs.html#1146573afe2845c8" class="i property">CurrentCommandProcessor</a>.<a href="../../CommandProcessorBase.cs.html#d539d84981be114a" class="i property">CommandRuntime</a>.<a href="../../MshCommandRuntime.cs.html#0135181adbe24516" class="i property">ErrorAction</a>;
                }
 
                <a href="#2616847a3f2beed3" class="i field">s_getPluginSb</a>.<span class="i">InvokeUsingCmdlet</span>(
                    <span class="i">contextCmdlet</span>: <a href="#1dd3de040a657cc9" class="k">this</a>,
                    <span class="i">useLocalScope</span>: <b>true</b>,
                    <span class="i">errorHandlingBehavior</span>: <a href="../../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="t t">ScriptBlock</a>.<a href="../../lang/scriptblock.cs.html#10c045824f712272" class="t t">ErrorHandlingBehavior</a>.<a href="../../lang/scriptblock.cs.html#5e78734ffe1c6ed3" class="i field">WriteToCurrentErrorPipe</a>,
                    <span class="i">dollarUnder</span>: <a href="../../AutomationNull.cs.html#681fbea4c40e4af1" class="t t">AutomationNull</a>.<a href="../../AutomationNull.cs.html#1cf7e193da582896" class="i property">Value</a>,
                    <span class="i">input</span>: <span class="i">Array</span>.<span class="i">Empty</span>&lt;<b>object</b>&gt;(),
                    <span class="i">scriptThis</span>: <a href="../../AutomationNull.cs.html#681fbea4c40e4af1" class="t t">AutomationNull</a>.<a href="../../AutomationNull.cs.html#1cf7e193da582896" class="i property">Value</a>,
                    <span class="i">args</span>: <b>new</b> <b>object</b>[] {
                                                   <span class="r214 r">arguments</span>,
                                                   <span class="r213 r">csNotFoundMessageFormat</span>,
                                                   <a href="#c01db3f6511e834a" class="i field">_force</a>}
                                            );
            }
            <b>finally</b>
            {
                <a href="../../CommandBase.cs.html#a41a765d70fc9c9d" class="i property">Context</a>.<a href="../../ExecutionContext.cs.html#b6c4f7d12af19123" class="i property">ErrorActionPreferenceVariable</a> = <span class="r215 r">backupPreference</span>;
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
    }
 
    <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
    <span class="k preprocess">#</span><span class="k preprocess">region</span> Set-PSSessionConfiguration cmdlet
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Class implementing Set-PSSessionConfiguration.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    [<span class="i">Cmdlet</span>(<a href="../../../utils/Verbs.cs.html#d056c4b8c99405e5" class="t t">VerbsCommon</a>.<a href="../../../utils/Verbs.cs.html#d881191bd45d8eb9" class="i field">Set</a>, <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#d19a1042a44001e8" class="t t">RemotingConstants</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#3188dd90ac4b908b" class="i field">PSSessionConfigurationNoun</a>,
       <span class="i">DefaultParameterSetName</span> = <a href="#fc12f22923e252d9" class="t t">PSSessionConfigurationCommandBase</a>.<a href="#567a3254f0a1b9e7" class="i field">NameParameterSetName</a>,
       <span class="i">SupportsShouldProcess</span> = <b>true</b>,
       <span class="i">ConfirmImpact</span> = <a href="../../CommandBase.cs.html#ba94675b57c6d6e9" class="t t">ConfirmImpact</a>.<a href="../../CommandBase.cs.html#f2126d83835863e8" class="i field">Medium</a>, <span class="i">HelpUri</span> = <span class="s">&quot;https://go.microsoft.com/fwlink/?LinkID=2096901&quot;</span>)]
    <b>public sealed class</b> <a id="cc2731857df70643" href="../../../R/cc2731857df70643.html" target="n" data-glyph="0,0" class="t t"><span id="cd67de5c28b98945">SetPSSessionConfigurationCommand</span></a> : <a href="#fc12f22923e252d9" class="t t">PSSessionConfigurationCommandBase</a>
    {
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Private Data
 
        <span class="c">// To Escape { -- {{</span>
        <span class="c">// To Escape } -- }}</span>
        <span class="c">// To Escape &quot; -- &quot;&quot;</span>
 
        <b>private const string</b> <a id="735e465165a745b9" href="../../../R/735e465165a745b9.html" target="n" data-glyph="10,1" class="i field">getSessionTypeFormat</a> = <span class="s">@&quot;(get-item &#39;WSMan::localhost\Plugin\{0}\InitializationParameters\sessiontype&#39; -ErrorAction SilentlyContinue).Value&quot;</span>;
        <b>private const string</b> <a id="5c6590d4ba37cdbc" href="../../../R/../../0000000000.html" target="n" data-glyph="10,1" class="i field">getCurrentIdleTimeoutmsFormat</a> = <span class="s">@&quot;(Get-Item &#39;WSMan:\localhost\Plugin\{0}\Quotas\IdleTimeoutms&#39;).Value&quot;</span>;
        <b>private const string</b> <a id="ffd1273166f36e27" href="../../../R/../../0000000000.html" target="n" data-glyph="10,1" class="i field">getAssemblyNameDataFormat</a> = <span class="s">@&quot;(Get-Item &#39;WSMan:\localhost\Plugin\{0}\InitializationParameters\assemblyname&#39;).Value&quot;</span>;
        <b>private const string</b> <a id="2f157f70a8fe84be" href="../../../R/2f157f70a8fe84be.html" target="n" data-glyph="10,1" class="i field">getSessionConfigurationDataSbFormat</a> = <span class="s">@&quot;(Get-Item &#39;WSMan:\localhost\Plugin\{0}\InitializationParameters\SessionConfigurationData&#39;).Value&quot;</span>;
 
        <b>private const string</b> <a id="521f39b08acbba0c" href="../../../R/521f39b08acbba0c.html" target="n" data-glyph="10,1" class="i field">setSessionConfigurationDataSbFormat</a> = <span class="s">@&quot;
function Set-SessionConfigurationData([string] $scd) {{
    if (test-path &#39;WSMan:\localhost\Plugin\{0}\InitializationParameters\&quot;</span> + <a href="../fanin/InitialSessionStateProvider.cs.html#88c11924f622f7f5" class="t t">ConfigurationDataFromXML</a>.<a href="../fanin/InitialSessionStateProvider.cs.html#9e1f1c9b78ebd9a5" class="i field">SESSIONCONFIGTOKEN</a> + <span class="s">@&quot;&#39;)
    {{
        set-item -WarningAction SilentlyContinue -Force &#39;WSMan:\localhost\Plugin\{0}\InitializationParameters\&quot;</span> + <a href="../fanin/InitialSessionStateProvider.cs.html#88c11924f622f7f5" class="t t">ConfigurationDataFromXML</a>.<a href="../fanin/InitialSessionStateProvider.cs.html#9e1f1c9b78ebd9a5" class="i field">SESSIONCONFIGTOKEN</a> + <span class="s">@&quot;&#39; -Value $scd
    }}
    else
    {{
        new-item -WarningAction SilentlyContinue -path &#39;WSMan:\localhost\Plugin\{0}\InitializationParameters&#39; -paramname &quot;</span> + <a href="../fanin/InitialSessionStateProvider.cs.html#88c11924f622f7f5" class="t t">ConfigurationDataFromXML</a>.<a href="../fanin/InitialSessionStateProvider.cs.html#9e1f1c9b78ebd9a5" class="i field">SESSIONCONFIGTOKEN</a> + <span class="s">@&quot; -paramValue $scd -Force
    }}
}}
Set-SessionConfigurationData $args[0]
&quot;</span>;
 
        <b>private const string</b> <a id="35781d4a7db9267e" href="../../../R/35781d4a7db9267e.html" target="n" data-glyph="10,1" class="i field">setSessionConfigurationQuotaSbFormat</a> = <span class="s">@&quot;
function Set-SessionPluginQuota([hashtable] $quotas) {{
    foreach($v in $quotas.GetEnumerator()) {{
        $name = $v.Name;
        $value = $v.Value;
        if (!$value) {{
            $value = [string]::empty;
        }}
 
        set-item -WarningAction SilentlyContinue (&#39;WSMan:\localhost\Plugin\{0}\Quotas\&#39; + $name) -Value $value -confirm:$false
    }}
}}
Set-SessionPluginQuota $args[0]
&quot;</span>;
 
        <b>private const string</b> <a id="1677ca86c364a3cd" href="../../../R/../../0000000000.html" target="n" data-glyph="10,1" class="i field">setSessionConfigurationTimeoutQuotasSbFormat</a> = <span class="s">@&quot;
function Set-SessionPluginIdleTimeoutQuotas([int] $maxIdleTimeoutms, [int] $idleTimeoutms, [bool] $setMaxIdleTimeoutFirst) {{
    if ($setMaxIdleTimeoutFirst) {{
        set-item -WarningAction SilentlyContinue &#39;WSMan:\localhost\Plugin\{0}\Quotas\MaxIdleTimeoutms&#39; -Value $maxIdleTimeoutms -confirm:$false
        set-item -WarningAction SilentlyContinue &#39;WSMan:\localhost\Plugin\{0}\Quotas\IdleTimeoutms&#39; -Value $idleTimeoutms -confirm:$false
    }}
    else {{
        set-item -WarningAction SilentlyContinue &#39;WSMan:\localhost\Plugin\{0}\Quotas\IdleTimeoutms&#39; -Value $idleTimeoutms -confirm:$false
        set-item -WarningAction SilentlyContinue &#39;WSMan:\localhost\Plugin\{0}\Quotas\MaxIdleTimeoutms&#39; -Value $maxIdleTimeoutms -confirm:$false
    }}
}}
Set-SessionPluginIdleTimeoutQuotas $args[0] $args[1] $args[2]
&quot;</span>;
 
        <b>private const string</b> <a id="81ce68a8a48be73b" href="../../../R/81ce68a8a48be73b.html" target="n" data-glyph="10,1" class="i field">setSessionConfigurationOptionsSbFormat</a> = <span class="s">@&quot;
function Set-SessionPluginOptions([hashtable] $options) {{
    if ($options[&quot;&quot;UsedSharedProcess&quot;&quot;]) {{
        $value = $options[&quot;&quot;UseSharedProcess&quot;&quot;];
        set-item -WarningAction SilentlyContinue &#39;WSMan:\localhost\Plugin\{0}\UseSharedProcess&#39; -Value $value -confirm:$false
        $options.Remove(&quot;&quot;UseSharedProcess&quot;&quot;);
    }}
 
    foreach($v in $options.GetEnumerator()) {{
        $name = $v.Name;
        $value = $v.Value
 
        if (!$value) {{
            $value = 0;
        }}
 
        set-item -WarningAction SilentlyContinue (&#39;WSMan:\localhost\Plugin\{0}\&#39; + $name) -Value $value -confirm:$false
    }}
}}
Set-SessionPluginOptions $args[0]
&quot;</span>;
 
        <b>private const string</b> <a id="590d53af92b6ef48" href="../../../R/590d53af92b6ef48.html" target="n" data-glyph="10,1" class="i field">setRunAsSbFormat</a> = <span class="s">@&quot;
function Set-RunAsCredential{{
    param (
        [string]$runAsUserName,
        [system.security.securestring]$runAsPassword
    )
 
    $cred = new-object System.Management.Automation.PSCredential($runAsUserName, $runAsPassword)
    set-item -WarningAction SilentlyContinue &#39;WSMan:\localhost\Plugin\{0}\RunAsUser&#39; $cred -confirm:$false
}}
Set-RunAsCredential $args[0] $args[1]
&quot;</span>;
 
        <b>private const string</b> <a id="ab76533611bbb83c" href="../../../R/ab76533611bbb83c.html" target="n" data-glyph="10,1" class="i field">setPluginSbFormat</a> = <span class="s">@&quot;
function Set-PSSessionConfiguration([PSObject]$customShellObject,
     [Array]$initParametersMap,
     [bool]$force,
     [string]$sddl,
     [bool]$isSddlSpecified,
     [bool]$shouldShowUI,
     [string]$resourceUri,
     [string]$pluginNotFoundErrorMsg,
     [string]$pluginNotPowerShellMsg,
     [string]$pluginForPowerShellCoreMsg,
     [string]$pluginForWindowsPowerShellMsg,
     [System.Management.Automation.Runspaces.PSSessionConfigurationAccessMode]$accessMode
)
{{
   $wsmanPluginDir = &#39;WSMan:\localhost\Plugin&#39;
   $pluginName = $customShellObject.Name;
   $pluginDir = Join-Path &quot;&quot;$wsmanPluginDir&quot;&quot; &quot;&quot;$pluginName&quot;&quot;
   if ((!$pluginName) -or !(test-path &quot;&quot;$pluginDir&quot;&quot;))
   {{
      Write-Error $pluginNotFoundErrorMsg
      return
   }}
 
   # check if the plugin is a PowerShell plugin
   $pluginFileNamePath = Join-Path &quot;&quot;$pluginDir&quot;&quot; &#39;FileName&#39;
   if (!(test-path &quot;&quot;$pluginFileNamePath&quot;&quot;))
   {{
      Write-Error $pluginNotPowerShellMsg
      return
   }}
 
   $pluginFileName = get-item -literalpath &quot;&quot;$pluginFileNamePath&quot;&quot;
   if ((!$pluginFileName) -or ($pluginFileName.Value -notmatch &#39;{0}&#39;))
   {{
      Write-Error $pluginNotPowerShellMsg
      return
   }}
   else
   {{
        # Filter out WindowsPowerShell endpoints when running as PowerShell 6+
        if (($pluginFileName.Value -match &#39;system32\\{0}&#39;) -OR
            ($pluginFileName.Value -match &#39;syswow64\\{0}&#39;))
        {{
            Write-Error $pluginForWindowsPowerShellMsg
            return
        }}
   }}
 
   # set Initialization Parameters
   $initParametersPath = Join-Path &quot;&quot;$pluginDir&quot;&quot; &#39;InitializationParameters&#39;
   foreach($initParameterName in $initParametersMap)
   {{
        if ($customShellObject | get-member $initParameterName)
        {{
            $parampath = Join-Path &quot;&quot;$initParametersPath&quot;&quot; $initParameterName
 
            if (test-path $parampath)
            {{
               remove-item -path &quot;&quot;$parampath&quot;&quot;
            }}
 
            # 0 is an accepted value for MaximumReceivedDataSizePerCommandMB and MaximumReceivedObjectSizeMB
            if (($customShellObject.$initParameterName) -or ($customShellObject.$initParameterName -eq 0))
            {{
               new-item -path &quot;&quot;$initParametersPath&quot;&quot; -paramname $initParameterName  -paramValue &quot;&quot;$($customShellObject.$initParameterName)&quot;&quot; -Force
            }}
        }}
   }}
 
   # sddl processing
   if ($isSddlSpecified)
   {{
       $resourcesPath = Join-Path &quot;&quot;$pluginDir&quot;&quot; &#39;Resources&#39;
       Get-ChildItem -literalpath &quot;&quot;$resourcesPath&quot;&quot; | ForEach-Object {{
            $securityPath = Join-Path &quot;&quot;$($_.pspath)&quot;&quot; &#39;Security&#39;
            if ((@(Get-ChildItem -literalpath &quot;&quot;$securityPath&quot;&quot;)).count -gt 0)
            {{
                Get-ChildItem -literalpath &quot;&quot;$securityPath&quot;&quot; | ForEach-Object {{
                    $securityIDPath = &quot;&quot;$($_.pspath)&quot;&quot;
                    remove-item -path &quot;&quot;$securityIDPath&quot;&quot; -recurse -force
                }} #end of securityPath
 
                if ($sddl)
                {{
                    new-item -path &quot;&quot;$securityPath&quot;&quot; -Sddl $sddl -force
                }}
            }}
            else
            {{
                if ($sddl)
                {{
                    new-item -path &quot;&quot;$securityPath&quot;&quot; -Sddl $sddl -force
                }}
            }}
       }} # end of resources
       return
   }} #end of sddl processing
   elseif ($shouldShowUI)
   {{
        $null = winrm configsddl $resourceUri
   }}
 
   # If accessmode is Disabled, we do not bother to check the sddl
   if ([System.Management.Automation.Runspaces.PSSessionConfigurationAccessMode]::Disabled.Equals($accessMode))
   {{
        return
   }}
 
   # Construct SID for network users
   [system.security.principal.wellknownsidtype]$evst = &quot;&quot;NetworkSid&quot;&quot;
   $networkSID = new-object system.security.principal.securityidentifier $evst,$null
 
   $resPath = Join-Path &quot;&quot;$pluginDir&quot;&quot; &#39;Resources&#39;
   Get-ChildItem -literalpath &quot;&quot;$resPath&quot;&quot; | ForEach-Object {{
        $securityPath = Join-Path &quot;&quot;$($_.pspath)&quot;&quot; &#39;Security&#39;
        if ((@(Get-ChildItem -literalpath &quot;&quot;$securityPath&quot;&quot;)).count -gt 0)
        {{
            Get-ChildItem -literalpath &quot;&quot;$securityPath&quot;&quot; | ForEach-Object {{
                $sddlPath = Join-Path &quot;&quot;$($_.pspath)&quot;&quot; &#39;Sddl&#39;
                $curSDDL = (get-item -path $sddlPath).value
                $sd = new-object system.security.accesscontrol.commonsecuritydescriptor $false,$false,$curSDDL
                $newSDDL = $null
 
                $disableNetworkExists = $false
                $securityIdentifierToPurge = $null
                $sd.DiscretionaryAcl | ForEach-Object {{
                    if (($_.acequalifier -eq &quot;&quot;accessdenied&quot;&quot;) -and ($_.securityidentifier -match $networkSID) -and ($_.AccessMask -eq 268435456))
                    {{
                        $disableNetworkExists = $true
                        $securityIdentifierToPurge = $_.securityidentifier
                    }}
                }}
 
                if ([System.Management.Automation.Runspaces.PSSessionConfigurationAccessMode]::Local.Equals($accessMode) -and !$disableNetworkExists)
                {{
                    $sd.DiscretionaryAcl.AddAccess(&quot;&quot;deny&quot;&quot;, $networkSID, 268435456, &quot;&quot;None&quot;&quot;, &quot;&quot;None&quot;&quot;)
                    $newSDDL = $sd.GetSddlForm(&quot;&quot;all&quot;&quot;)
                }}
 
                if ([System.Management.Automation.Runspaces.PSSessionConfigurationAccessMode]::Remote.Equals($accessMode) -and $disableNetworkExists)
                {{
                    # Remove the specific ACE
                    $sd.discretionaryacl.RemoveAccessSpecific(&#39;Deny&#39;, $securityIdentifierToPurge, 268435456, &#39;none&#39;, &#39;none&#39;)
 
                    # if there is no discretionaryacl..add Builtin Administrators and Remote Management Users
                    # to the DACL group as this is the default WSMan behavior
                    if ($sd.discretionaryacl.count -eq 0)
                    {{
                        # Built-in administrators
                        [system.security.principal.wellknownsidtype]$bast = &quot;&quot;BuiltinAdministratorsSid&quot;&quot;
                        $basid = new-object system.security.principal.securityidentifier $bast,$null
                        $sd.DiscretionaryAcl.AddAccess(&#39;Allow&#39;,$basid, 268435456, &#39;none&#39;, &#39;none&#39;)
 
                        # Remote Management Users, Win8+ only
                        if ([System.Environment]::OSVersion.Version -ge &quot;&quot;6.2.0.0&quot;&quot;)
                        {{
                            $rmSidId = new-object system.security.principal.securityidentifier &quot;&quot;{2}&quot;&quot;
                            $sd.DiscretionaryAcl.AddAccess(&#39;Allow&#39;, $rmSidId, 268435456, &#39;none&#39;, &#39;none&#39;)
                        }}
 
                        # Interactive Users
                        $iuSidId = new-object system.security.principal.securityidentifier &quot;&quot;{3}&quot;&quot;
                        $sd.DiscretionaryAcl.AddAccess(&#39;Allow&#39;, $iuSidId, 268435456, &#39;none&#39;, &#39;none&#39;)
                    }}
 
                    $newSDDL = $sd.GetSddlForm(&quot;&quot;all&quot;&quot;)
                }}
 
                if ($newSDDL)
                {{
                    set-item -WarningAction SilentlyContinue -path $sddlPath -value $newSDDL -force
                }}
            }}
        }}
        else
        {{
            if (([System.Management.Automation.Runspaces.PSSessionConfigurationAccessMode]::Local.Equals($accessMode)))
            {{
                new-item -path &quot;&quot;$securityPath&quot;&quot; -Sddl &quot;&quot;{1}&quot;&quot; -force
            }}
        }}
   }}
}}
 
Set-PSSessionConfiguration $args[0] $args[1] $args[2] $args[3] $args[4] $args[5] $args[6] $args[7] $args[8] $args[9] $args[10] $args[11]
&quot;</span>;
 
        <b>private const string</b> <a id="4221a2a3f4b7719e" href="../../../R/4221a2a3f4b7719e.html" target="n" data-glyph="10,1" class="i field">initParamFormat</a> = <span class="s">@&quot;&lt;Param Name=&#39;{0}&#39; Value=&#39;{1}&#39; /&gt;&quot;</span>;
        <b>private const string</b> <a id="498ff8e11d3f9998" href="../../../R/498ff8e11d3f9998.html" target="n" data-glyph="10,1" class="i field">privateDataFormat</a> = <span class="s">@&quot;&lt;Param Name=&#39;PrivateData&#39;&gt;{0}&lt;/Param&gt;&quot;</span>;
 
        <b>private const string</b> <a id="1b015a5247b3f62a" href="../../../R/1b015a5247b3f62a.html" target="n" data-glyph="10,1" class="i field">SessionConfigDataFormat</a> = <span class="s">@&quot;&lt;SessionConfigurationData&gt;{0}&lt;/SessionConfigurationData&gt;&quot;</span>;
 
        <b>private const string</b> <a id="6e4cbc09e612164f" href="../../../R/6e4cbc09e612164f.html" target="n" data-glyph="10,1" class="i field">UseSharedProcessToken</a> = <span class="s">&quot;UseSharedProcess&quot;</span>;
        <b>private const string</b> <a id="1609787001ba6215" href="../../../R/1609787001ba6215.html" target="n" data-glyph="10,1" class="i field">AllowRemoteAccessToken</a> = <span class="s">&quot;Enabled&quot;</span>;
 
        <b>private static readonly</b> <a href="../../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="t t">ScriptBlock</a> <a id="8af7db5681c8a020" href="../../../R/8af7db5681c8a020.html" target="n" data-glyph="46,1" class="i field">s_setPluginSb</a>;
        <span class="c">// property names used by the script to update InitParameters.</span>
        <b>private static readonly string</b>[] <a id="a2f5b3e97929fd62" href="../../../R/a2f5b3e97929fd62.html" target="n" data-glyph="46,1" class="i field">s_initParametersMap</a> = <b>new</b> <b>string</b>[] {
            <a href="../fanin/InitialSessionStateProvider.cs.html#88c11924f622f7f5" class="t t">ConfigurationDataFromXML</a>.<a href="../fanin/InitialSessionStateProvider.cs.html#c6bdad55d5b9cfe9" class="i field">APPBASETOKEN</a>,
            <a href="../fanin/InitialSessionStateProvider.cs.html#88c11924f622f7f5" class="t t">ConfigurationDataFromXML</a>.<a href="../fanin/InitialSessionStateProvider.cs.html#a760798ff3d1d31c" class="i field">ASSEMBLYTOKEN</a>,
            <a href="../fanin/InitialSessionStateProvider.cs.html#88c11924f622f7f5" class="t t">ConfigurationDataFromXML</a>.<a href="../fanin/InitialSessionStateProvider.cs.html#5b4979d69407d7e3" class="i field">SHELLCONFIGTYPETOKEN</a>,
            <a href="../fanin/InitialSessionStateProvider.cs.html#88c11924f622f7f5" class="t t">ConfigurationDataFromXML</a>.<a href="../fanin/InitialSessionStateProvider.cs.html#a5044dd5ccc8fb43" class="i field">STARTUPSCRIPTTOKEN</a>,
            <a href="../fanin/InitialSessionStateProvider.cs.html#88c11924f622f7f5" class="t t">ConfigurationDataFromXML</a>.<a href="../fanin/InitialSessionStateProvider.cs.html#10b5800d17b0f40c" class="i field">MAXRCVDOBJSIZETOKEN</a>,
            <a href="../fanin/InitialSessionStateProvider.cs.html#88c11924f622f7f5" class="t t">ConfigurationDataFromXML</a>.<a href="../fanin/InitialSessionStateProvider.cs.html#1f07f200d8e7326a" class="i field">MAXRCVDCMDSIZETOKEN</a>,
            <a href="../fanin/InitialSessionStateProvider.cs.html#88c11924f622f7f5" class="t t">ConfigurationDataFromXML</a>.<a href="../fanin/InitialSessionStateProvider.cs.html#cd5d7a116ed4a287" class="i field">THREADOPTIONSTOKEN</a>,
            <a href="../fanin/InitialSessionStateProvider.cs.html#88c11924f622f7f5" class="t t">ConfigurationDataFromXML</a>.<a href="../fanin/InitialSessionStateProvider.cs.html#49974ff8bb3d2d73" class="i field">THREADAPTSTATETOKEN</a>,
            <a href="../fanin/InitialSessionStateProvider.cs.html#88c11924f622f7f5" class="t t">ConfigurationDataFromXML</a>.<a href="../fanin/InitialSessionStateProvider.cs.html#cfdd5431fae23a53" class="i field">PSVERSIONTOKEN</a>,
            <a href="../fanin/InitialSessionStateProvider.cs.html#88c11924f622f7f5" class="t t">ConfigurationDataFromXML</a>.<a href="../fanin/InitialSessionStateProvider.cs.html#875775f1b987cd71" class="i field">MAXPSVERSIONTOKEN</a>,
            <a href="../fanin/InitialSessionStateProvider.cs.html#88c11924f622f7f5" class="t t">ConfigurationDataFromXML</a>.<a href="../fanin/InitialSessionStateProvider.cs.html#9e1f1c9b78ebd9a5" class="i field">SESSIONCONFIGTOKEN</a>,
        };
 
        <b>private bool</b> <a id="f1a01bf793f852ef" href="../../../R/f1a01bf793f852ef.html" target="n" data-glyph="46,1" class="i field">_isErrorReported</a>;
 
        <b>private</b> <span class="i">Hashtable</span> <a id="b56b06030a6c6977" href="../../../R/b56b06030a6c6977.html" target="n" data-glyph="46,1" class="i field">_configTable</a>;
        <b>private string</b> <a id="921af72d08d779f7" href="../../../R/921af72d08d779f7.html" target="n" data-glyph="46,1" class="i field">_configFilePath</a>;
 
        <b>private string</b> <a id="0bb3f7d73df06a34" href="../../../R/0bb3f7d73df06a34.html" target="n" data-glyph="46,1" class="i field">_gmsaAccount</a>;
        <b>private string</b> <a id="3ffa075fce6f44a5" href="../../../R/3ffa075fce6f44a5.html" target="n" data-glyph="46,1" class="i field">_configSddl</a>;
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Constructors
 
        <b>static</b> <a id="489fc2110f86303c" href="../../../R/../../0000000000.html" target="n" data-glyph="76,1" class="t method">SetPSSessionConfigurationCommand</a>()
        {
            <b>string</b> <span id="r216 rd" class="r216 r">localSDDL</span> = <a href="#1cb9fa319955517b" class="i method">GetLocalSddl</a>();
            <b>string</b> <span id="r217 rd" class="r217 r">setPluginScript</span> = <b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>,
                <a href="#ab76533611bbb83c" class="i field">setPluginSbFormat</a>,
                <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#d19a1042a44001e8" class="t t">RemotingConstants</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#7cbb6da0d7ec5022" class="i field">PSPluginDLLName</a>, <span class="r216 r">localSDDL</span>, <a href="#9d3d012f73c36bca" class="i field">RemoteManagementUsersSID</a>, <a href="#3040a1427951767d" class="i field">InteractiveUsersSID</a>);
 
            <span class="c">// compile the script block statically and reuse the same instance</span>
            <span class="c">// everytime the command is run..This will save on parsing time.</span>
            <a href="#8af7db5681c8a020" class="i field">s_setPluginSb</a> = <a href="../../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="t t">ScriptBlock</a>.<a href="../../lang/scriptblock.cs.html#adfac0fa7bf5725f" class="i method">Create</a>(<span class="r217 r">setPluginScript</span>);
            <a href="#8af7db5681c8a020" class="i field">s_setPluginSb</a>.<a href="../../lang/scriptblock.cs.html#5e76a9fb0d1a7f12" class="i property">LanguageMode</a> = <a href="../../SessionStatePublic.cs.html#450052824aba2e3f" class="t t">PSLanguageMode</a>.<a href="../../SessionStatePublic.cs.html#eec721eb8c02f156" class="i field">FullLanguage</a>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Cmdlet overrides
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">InvalidOperationException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> 1. Either both &quot;AssemblyName&quot; and &quot;ConfigurationTypeName&quot; must be specified</span>
        <span class="c">///</span><span class="c"> or both must not be specified.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>protected override void</b> <a id="3658ac01a6555d95" href="../../../R/3658ac01a6555d95.html" target="n" data-glyph="75,1" class="i method">BeginProcessing</a>()
        {
            <b>if</b> (<a href="#ea050dfcef60d743" class="i field">isSddlSpecified</a> &amp;&amp; <a href="#f5740b3f379662bf" class="i field">showUISpecified</a>)
            {
                <b>string</b> <span id="r218 rd" class="r218 r">message</span> = <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">ShowUIAndSDDLCannotExist</span>,
                    <span class="s">&quot;SecurityDescriptorSddl&quot;</span>,
                    <span class="s">&quot;ShowSecurityDescriptorUI&quot;</span>);
                <b>throw</b> <b>new</b> <a href="../../../utils/MshInvalidOperationException.cs.html#de5b942a57457045" class="t constructor">PSInvalidOperationException</a>(<span class="r218 r">message</span>);
            }
 
            <b>if</b> (<a href="#e2e889cb6609651d" class="i field">isRunAsCredentialSpecified</a>)
            {
                <span class="i">WriteWarning</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">RunAsSessionConfigurationSecurityWarning</span>);
            }
 
            <span class="c">// Populate the configTable hash, and get its SDDL if needed</span>
            <b>if</b> (<a href="#7f0833e245fe41bc" class="i property">Path</a> != <b>null</b>)
            {
                <a href="../../DataStoreAdapterProvider.cs.html#dd4e1f2f8e73a1dd" class="t t">ProviderInfo</a> <span id="r219 rd" class="r219 r">provider</span> = <b>null</b>;
                <a href="../../DataStoreAdapter.cs.html#2d16b26a541ba185" class="t t">PSDriveInfo</a> <span id="r220 rd" class="r220 r">drive</span>;
                <a href="#921af72d08d779f7" class="i field">_configFilePath</a> = <a href="../../CommandBase.cs.html#5078d443148de142" class="i property">SessionState</a>.<a href="../../SessionStatePublic.cs.html#3390cfbbdcffb036" class="i property">Path</a>.<a href="../../PathInterfaces.cs.html#89444ef2b32a4408" class="i method">GetUnresolvedProviderPathFromPSPath</a>(<a href="#7f0833e245fe41bc" class="i property">Path</a>, <b>out</b> <span class="r219 r">provider</span>, <b>out</b> <span class="r220 r">drive</span>);
 
                <b>string</b> <span id="r221 rd" class="r221 r">scriptName</span>;
                <a href="../../ExternalScriptInfo.cs.html#7806ac40f903221c" class="t t">ExternalScriptInfo</a> <span id="r222 rd" class="r222 r">scriptInfo</span> = <a href="../fanin/InitialSessionStateProvider.cs.html#78aacc47ea72f6a8" class="t t">DISCUtils</a>.<a href="../fanin/InitialSessionStateProvider.cs.html#cbbec5f551fd0e0c" class="i method">GetScriptInfoForFile</a>(<a href="#cc2731857df70643" class="k">this</a>.<a href="../../CommandBase.cs.html#a41a765d70fc9c9d" class="i property">Context</a>, <a href="#921af72d08d779f7" class="i field">_configFilePath</a>, <b>out</b> <span class="r221 r">scriptName</span>);
                <a href="#b56b06030a6c6977" class="i field">_configTable</a> = <a href="../fanin/InitialSessionStateProvider.cs.html#78aacc47ea72f6a8" class="t t">DISCUtils</a>.<a href="../fanin/InitialSessionStateProvider.cs.html#165b977f5f1cf798" class="i method">LoadConfigFile</a>(<a href="#cc2731857df70643" class="k">this</a>.<a href="../../CommandBase.cs.html#a41a765d70fc9c9d" class="i property">Context</a>, <span class="r222 r">scriptInfo</span>);
 
                <b>if</b> (!<a href="#ea050dfcef60d743" class="i field">isSddlSpecified</a>)
                {
                    <a href="../../ErrorPackage.cs.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r223 rd" class="r223 r">error</span>;
                    <a href="#3ffa075fce6f44a5" class="i field">_configSddl</a> = <a href="#2111ec231989f662" class="t t">PSSessionConfigurationCommandUtilities</a>.<a href="#ac0adb98102375ba" class="i method">ComputeSDDLFromConfiguration</a>(
                        <a href="#b56b06030a6c6977" class="i field">_configTable</a>,
                        <a href="#66d32f1366ccb752" class="i property">AccessMode</a>,
                        <b>out</b> <span class="r223 r">error</span>);
                    <b>if</b> (<span class="r223 r">error</span> != <b>null</b>)
                    {
                        <a href="../../cmdlet.cs.html#7746d1a8f41a36d5" class="i method">WriteError</a>(<span class="r223 r">error</span>);
                    }
 
                    <b>if</b> (!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<a href="#3ffa075fce6f44a5" class="i field">_configSddl</a>))
                    {
                        <span class="c">// Use Sddl from configuration.</span>
                        <a href="#ea050dfcef60d743" class="i field">isSddlSpecified</a> = <b>true</b>;
                        <a href="#53763c26802a6073" class="i property">SecurityDescriptorSddl</a> = <a href="#3ffa075fce6f44a5" class="i field">_configSddl</a>;
                    }
                }
 
                <b>if</b> (<a href="#b56b06030a6c6977" class="i field">_configTable</a>.<span class="i">ContainsKey</span>(<a href="../fanin/InitialSessionStateProvider.cs.html#b1e495f9b52fbd4a" class="t t">ConfigFileConstants</a>.<a href="../fanin/InitialSessionStateProvider.cs.html#6113c4097d4973ff" class="i field">RunAsVirtualAccount</a>))
                {
                    <a href="#cc2731857df70643" class="k">this</a>.<a href="#4dcf2ffea1a67e82" class="i property">RunAsVirtualAccount</a> = <a href="../../LanguagePrimitives.cs.html#6dac09d64da9900c" class="t t">LanguagePrimitives</a>.<span class="i">ConvertTo</span>&lt;<b>bool</b>&gt;(<a href="#b56b06030a6c6977" class="i field">_configTable</a>[<a href="../fanin/InitialSessionStateProvider.cs.html#b1e495f9b52fbd4a" class="t t">ConfigFileConstants</a>.<a href="../fanin/InitialSessionStateProvider.cs.html#6113c4097d4973ff" class="i field">RunAsVirtualAccount</a>]);
                    <a href="#cc2731857df70643" class="k">this</a>.<a href="#73a5a75f7a76f61d" class="i property">RunAsVirtualAccountSpecified</a> = <b>true</b>;
                }
 
                <b>if</b> (<a href="#b56b06030a6c6977" class="i field">_configTable</a>.<span class="i">ContainsKey</span>(<a href="../fanin/InitialSessionStateProvider.cs.html#b1e495f9b52fbd4a" class="t t">ConfigFileConstants</a>.<a href="../fanin/InitialSessionStateProvider.cs.html#e724519e3a7dcc96" class="i field">RunAsVirtualAccountGroups</a>))
                {
                    <a href="#cc2731857df70643" class="k">this</a>.<a href="#2d1b945158ed0b9a" class="i property">RunAsVirtualAccountGroups</a> = <a href="#2111ec231989f662" class="t t">PSSessionConfigurationCommandUtilities</a>.<a href="#211ab6774bd12485" class="i method">GetRunAsVirtualAccountGroupsString</a>(
                        <a href="../fanin/InitialSessionStateProvider.cs.html#fc3ecbf6d041a5ca" class="t t">DISCPowerShellConfiguration</a>.<span class="i">TryGetStringArray</span>(<a href="#b56b06030a6c6977" class="i field">_configTable</a>[<a href="../fanin/InitialSessionStateProvider.cs.html#b1e495f9b52fbd4a" class="t t">ConfigFileConstants</a>.<a href="../fanin/InitialSessionStateProvider.cs.html#e724519e3a7dcc96" class="i field">RunAsVirtualAccountGroups</a>]));
                }
            }
 
            <b>if</b> (<a href="#ea050dfcef60d743" class="i field">isSddlSpecified</a> &amp;&amp; <a href="#2a410c15d6e039b9" class="i field">accessModeSpecified</a>)
            {
                <span class="c">// Constructor call should succeed. The sddl is check in the property setter</span>
                <span class="i">CommonSecurityDescriptor</span> <span id="r224 rd" class="r224 r">descriptor</span> = <b>new</b> <span class="i">CommonSecurityDescriptor</span>(<b>false</b>, <b>false</b>, <a href="#e47691b9a35b161f" class="i field">sddl</a>);
                <span class="i">SecurityIdentifier</span> <span id="r225 rd" class="r225 r">networkSidIdentifier</span> = <b>new</b> <span class="i">SecurityIdentifier</span>(<span class="i">WellKnownSidType</span>.<span class="i">NetworkSid</span>, <b>null</b>);
                <b>bool</b> <span id="r226 rd" class="r226 r">networkDenyAllExists</span> = <b>false</b>;
                <b>foreach</b> (<span class="i">CommonAce</span> <span id="r227 rd" class="r227 r">ace</span> <b>in</b> <span class="r224 r">descriptor</span>.<span class="i">DiscretionaryAcl</span>)
                {
                    <b>if</b> (<span class="r227 r">ace</span>.<span class="i">AceQualifier</span>.<span class="i">Equals</span>(<span class="i">AceQualifier</span>.<span class="i">AccessDenied</span>) &amp;&amp; <span class="r227 r">ace</span>.<span class="i">SecurityIdentifier</span>.<span class="i">Equals</span>(<span class="r225 r">networkSidIdentifier</span>) &amp;&amp; <span class="r227 r">ace</span>.<span class="i">AccessMask</span> == 268435456)
                    {
                        <span class="r226 r">networkDenyAllExists</span> = <b>true</b>;
                        <b>break</b>;
                    }
                }
 
                <b>switch</b> (<a href="#66d32f1366ccb752" class="i property">AccessMode</a>)
                {
                    <b>case</b> <a href="../common/RunspaceConnectionInfo.cs.html#10edf62c3f6a89b0" class="t t">PSSessionConfigurationAccessMode</a>.<a href="../common/RunspaceConnectionInfo.cs.html#e493a77e156a2d8d" class="i field">Local</a>:
                        <b>if</b> (!<span class="r226 r">networkDenyAllExists</span>)
                        {
                            <span class="r224 r">descriptor</span>.<span class="i">DiscretionaryAcl</span>.<span class="i">AddAccess</span>(<span class="i">AccessControlType</span>.<span class="i">Deny</span>, <span class="r225 r">networkSidIdentifier</span>, 268435456, <span class="i">InheritanceFlags</span>.<span class="i">None</span>, <span class="i">PropagationFlags</span>.<span class="i">None</span>);
                            <a href="#e47691b9a35b161f" class="i field">sddl</a> = <span class="r224 r">descriptor</span>.<span class="i">GetSddlForm</span>(<span class="i">AccessControlSections</span>.<span class="i">All</span>);
                        }
 
                        <b>break</b>;
                    <b>case</b> <a href="../common/RunspaceConnectionInfo.cs.html#10edf62c3f6a89b0" class="t t">PSSessionConfigurationAccessMode</a>.<a href="../common/RunspaceConnectionInfo.cs.html#f9938a92bb1a8e5f" class="i field">Remote</a>:
                        <b>if</b> (<span class="r226 r">networkDenyAllExists</span>)
                        {
                            <span class="c">// Remove the specific ACE</span>
                            <span class="r224 r">descriptor</span>.<span class="i">DiscretionaryAcl</span>.<span class="i">RemoveAccessSpecific</span>(<span class="i">AccessControlType</span>.<span class="i">Deny</span>, <span class="r225 r">networkSidIdentifier</span>, 268435456, <span class="i">InheritanceFlags</span>.<span class="i">None</span>, <span class="i">PropagationFlags</span>.<span class="i">None</span>);
 
                            <span class="c">// If the discretionaryAcl becomes empty, add the BA and RM which is the default WinRM behavior</span>
                            <b>if</b> (<span class="r224 r">descriptor</span>.<span class="i">DiscretionaryAcl</span>.<span class="i">Count</span> == 0)
                            {
                                <a href="#e47691b9a35b161f" class="i field">sddl</a> = <a href="#d2c40f80d22c2cdd" class="i method">GetRemoteSddl</a>();
                            }
                            <b>else</b>
                            {
                                <a href="#e47691b9a35b161f" class="i field">sddl</a> = <span class="r224 r">descriptor</span>.<span class="i">GetSddlForm</span>(<span class="i">AccessControlSections</span>.<span class="i">All</span>);
                            }
                        }
 
                        <b>break</b>;
                    <b>case</b> <a href="../common/RunspaceConnectionInfo.cs.html#10edf62c3f6a89b0" class="t t">PSSessionConfigurationAccessMode</a>.<a href="../common/RunspaceConnectionInfo.cs.html#43e3b9106e6c81f0" class="i field">Disabled</a>:
                        <b>break</b>;
                }
            }
 
            <span class="c">// check if we have compatible WSMan</span>
            <a href="remotingcommandutil.cs.html#4c008a65630ba320" class="t t">RemotingCommandUtil</a>.<a href="remotingcommandutil.cs.html#668e049b2f134726" class="i method">CheckRemotingCmdletPrerequisites</a>();
            <a href="#2111ec231989f662" class="t t">PSSessionConfigurationCommandUtilities</a>.<a href="#e6567bb211cb1a98" class="i method">ThrowIfNotAdministrator</a>();
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>protected override void</b> <a id="c6d8c0a27cb9affe" href="../../../R/c6d8c0a27cb9affe.html" target="n" data-glyph="75,1" class="i method">ProcessRecord</a>()
        {
            <a href="../../cmdlet.cs.html#377660744c64cd7e" class="i method">WriteVerbose</a>(<a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">ScsScriptMessageV</span>, <a href="#ab76533611bbb83c" class="i field">setPluginSbFormat</a>));
 
            <b>string</b> <span id="r228 rd" class="r228 r">shouldProcessAction</span> = <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">CSShouldProcessAction</span>,
                <a href="#cc2731857df70643" class="k">this</a>.<a href="../../CommandBase.cs.html#1f4a1f38862b466a" class="i property">CommandInfo</a>.<a href="../../CommandInfo.cs.html#02e11b521c500195" class="i property">Name</a>);
            <b>string</b> <span id="r229 rd" class="r229 r">shouldProcessTarget</span>;
            <b>if</b> (!<a href="#ea050dfcef60d743" class="i field">isSddlSpecified</a>)
            {
                <span class="r229 r">shouldProcessTarget</span> = <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">CSShouldProcessTarget</span>,
                    <a href="#cc2731857df70643" class="k">this</a>.<a href="#ff3d179414dbc3ad" class="i property">Name</a>);
            }
            <b>else</b>
            {
                <span class="r229 r">shouldProcessTarget</span> = <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">ScsShouldProcessTargetSDDL</span>,
                    <a href="#cc2731857df70643" class="k">this</a>.<a href="#ff3d179414dbc3ad" class="i property">Name</a>,
                    <a href="#e47691b9a35b161f" class="i field">sddl</a>);
            }
 
            <b>if</b> (!<a href="#89e5f845fe6ddd31" class="i field">noRestart</a> &amp;&amp; !<a href="#06d26f0ccfb63d9a" class="i field">force</a>)
            {
                <b>string</b> <span id="r230 rd" class="r230 r">action</span> = <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">CSShouldProcessAction</span>,
                    <a href="#cc2731857df70643" class="k">this</a>.<a href="../../CommandBase.cs.html#1f4a1f38862b466a" class="i property">CommandInfo</a>.<a href="../../CommandInfo.cs.html#02e11b521c500195" class="i property">Name</a>);
                <a href="../../cmdlet.cs.html#dda5a07d1a8a6cba" class="i method">WriteWarning</a>(<a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">WinRMRestartWarning</span>, <span class="r230 r">action</span>));
            }
 
            <b>if</b> (!<a href="#06d26f0ccfb63d9a" class="i field">force</a> &amp;&amp; !<a href="../../cmdlet.cs.html#5f125d2ab6d0970d" class="i method">ShouldProcess</a>(<span class="r229 r">shouldProcessTarget</span>, <span class="r228 r">shouldProcessAction</span>))
            {
                <b>return</b>;
            }
 
            <span class="c">// Update the configuration to use a shared process</span>
            <b>if</b> (<a href="#8534b4735dcf261a" class="i field">isUseSharedProcessSpecified</a>)
            {
                <b>using</b> (<span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="../../hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShell</a> <span id="r231 rd" class="r231 r">ps</span> = <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="../../hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShell</a>.<a href="../../hostifaces/PowerShell.cs.html#40345bc4625ff918" class="i method">Create</a>())
                {
                    <span class="r231 r">ps</span>.<span class="i">AddScript</span>(<b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>, <a href="#735e465165a745b9" class="i field">getSessionTypeFormat</a>, <a href="../../lang/codegen.cs.html#ec5e2f0e22eb2223" class="t t">CodeGeneration</a>.<a href="../../lang/codegen.cs.html#99c5bb762439f325" class="i method">EscapeSingleQuotedStringContent</a>(<a href="#ff3d179414dbc3ad" class="i property">Name</a>)));
                    <span class="i">Collection</span>&lt;<a href="../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt; <span id="r232 rd" class="r232 r">psObjectCollection</span> = <span class="r231 r">ps</span>.<span class="i">Invoke</span>(<b>new</b> <b>object</b>[] { <a href="#ff3d179414dbc3ad" class="i property">Name</a> }) <b>as</b> <span class="i">Collection</span>&lt;<a href="../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt;;
                    <b>if</b> (<span class="r232 r">psObjectCollection</span> == <b>null</b> || <span class="r232 r">psObjectCollection</span>.<span class="i">Count</span> != 1)
                    {
                        <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<b>false</b>, <span class="s">&quot;This should never happen. ps.Invoke always return a Collection&lt;PSObject&gt;&quot;</span>);
                    }
                }
            }
 
            <span class="c">// Update the PSSC file if there was one</span>
            <b>if</b> (<a href="#b56b06030a6c6977" class="i field">_configTable</a> != <b>null</b>)
            {
                <span class="i">Guid</span> <span id="r233 rd" class="r233 r">sessionGuid</span> = <span class="i">Guid</span>.<span class="i">Empty</span>;
 
                <span class="c">// Extract the GUID for the configuration</span>
                <b>if</b> (<a href="#b56b06030a6c6977" class="i field">_configTable</a>.<span class="i">ContainsKey</span>(<a href="../fanin/InitialSessionStateProvider.cs.html#b1e495f9b52fbd4a" class="t t">ConfigFileConstants</a>.<a href="../fanin/InitialSessionStateProvider.cs.html#588d3101f5da21f7" class="i field">Guid</a>))
                {
                    <span class="r233 r">sessionGuid</span> = <span class="i">Guid</span>.<span class="i">Parse</span>(<a href="#b56b06030a6c6977" class="i field">_configTable</a>[<a href="../fanin/InitialSessionStateProvider.cs.html#b1e495f9b52fbd4a" class="t t">ConfigFileConstants</a>.<a href="../fanin/InitialSessionStateProvider.cs.html#588d3101f5da21f7" class="i field">Guid</a>].<span class="i">ToString</span>());
                }
 
                <span class="c">// Extract the GMSA account name if available</span>
                <b>if</b> (<a href="#b56b06030a6c6977" class="i field">_configTable</a>.<span class="i">ContainsKey</span>(<a href="../fanin/InitialSessionStateProvider.cs.html#b1e495f9b52fbd4a" class="t t">ConfigFileConstants</a>.<a href="../fanin/InitialSessionStateProvider.cs.html#8b4e61e9c62fdd9b" class="i field">GMSAAccount</a>))
                {
                    <a href="#0bb3f7d73df06a34" class="i field">_gmsaAccount</a> = <a href="#b56b06030a6c6977" class="i field">_configTable</a>[<a href="../fanin/InitialSessionStateProvider.cs.html#b1e495f9b52fbd4a" class="t t">ConfigFileConstants</a>.<a href="../fanin/InitialSessionStateProvider.cs.html#8b4e61e9c62fdd9b" class="i field">GMSAAccount</a>] <b>as string</b>;
                }
 
                <b>string</b> <span id="r234 rd" class="r234 r">destPath</span> = <span class="i n">System</span>.<span class="i">IO</span>.<span class="i">Path</span>.<span class="i">Combine</span>(<a href="../../Utils.cs.html#9185d6ecbaebbec0" class="t t">Utils</a>.<a href="../../Utils.cs.html#c677cc800603f8f5" class="i property">DefaultPowerShellAppBase</a>, <span class="s">&quot;SessionConfig&quot;</span>,
                    <a href="#50e45ca03ff16b28" class="i field">shellName</a> + <span class="s">&quot;_&quot;</span> + <span class="r233 r">sessionGuid</span>.<span class="i">ToString</span>() + <a href="../../SessionStateStrings.cs.html#55ee11e42c7cf459" class="t t">StringLiterals</a>.<a href="../../SessionStateStrings.cs.html#f547328079c2f2df" class="i field">PowerShellDISCFileExtension</a>);
 
                <span class="c">// If the config file with the same guid name already exists then it would be overwritten.</span>
                <span class="i">File</span>.<span class="i">Copy</span>(<a href="#921af72d08d779f7" class="i field">_configFilePath</a>, <span class="r234 r">destPath</span>, <b>true</b>);
            }
 
            <b>string</b> <span id="r235 rd" class="r235 r">shellNotFoundErrorMsg</span> = <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">CSCmdsShellNotFound</span>, <a href="#50e45ca03ff16b28" class="i field">shellName</a>);
            <b>string</b> <span id="r236 rd" class="r236 r">shellNotPowerShellMsg</span> = <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">CSCmdsShellNotPowerShellBased</span>, <a href="#50e45ca03ff16b28" class="i field">shellName</a>);
            <b>string</b> <span id="r237 rd" class="r237 r">shellForPowerShellCoreMsg</span> = <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">CSCmdsPowerShellCoreShellNotModifiable</span>, <a href="#50e45ca03ff16b28" class="i field">shellName</a>);
            <b>string</b> <span id="r238 rd" class="r238 r">shellForWindowsPowerShellMsg</span> = <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">CSCmdsWindowsPowerShellCoreNotModifiable</span>, <a href="#50e45ca03ff16b28" class="i field">shellName</a>);
 
            <span class="c">// construct object to update the properties</span>
            <a href="../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r239 rd" class="r239 r">propertiesToUpdate</span> = <a href="#d417f7627c115299" class="i method">ConstructPropertiesForUpdate</a>();
 
            <span class="c">// hack to see if there is any error reported running the script.</span>
            <span class="i">ArrayList</span> <span id="r240 rd" class="r240 r">errorList</span> = (<span class="i">ArrayList</span>)<a href="../../CommandBase.cs.html#a41a765d70fc9c9d" class="i property">Context</a>.<a href="../../ExecutionContext.cs.html#9f5bde284d161965" class="i property">DollarErrorVariable</a>;
            <b>int</b> <span id="r241 rd" class="r241 r">errorCountBefore</span> = <span class="r240 r">errorList</span>.<span class="i">Count</span>;
            <a href="#8af7db5681c8a020" class="i field">s_setPluginSb</a>.<span class="i">InvokeUsingCmdlet</span>(
                <span class="i">contextCmdlet</span>: <a href="#cc2731857df70643" class="k">this</a>,
                <span class="i">useLocalScope</span>: <b>true</b>,
                <span class="i">errorHandlingBehavior</span>: <a href="../../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="t t">ScriptBlock</a>.<a href="../../lang/scriptblock.cs.html#10c045824f712272" class="t t">ErrorHandlingBehavior</a>.<a href="../../lang/scriptblock.cs.html#5e78734ffe1c6ed3" class="i field">WriteToCurrentErrorPipe</a>,
                <span class="i">dollarUnder</span>: <a href="../../AutomationNull.cs.html#681fbea4c40e4af1" class="t t">AutomationNull</a>.<a href="../../AutomationNull.cs.html#1cf7e193da582896" class="i property">Value</a>,
                <span class="i">input</span>: <span class="i">Array</span>.<span class="i">Empty</span>&lt;<b>object</b>&gt;(),
                <span class="i">scriptThis</span>: <a href="../../AutomationNull.cs.html#681fbea4c40e4af1" class="t t">AutomationNull</a>.<a href="../../AutomationNull.cs.html#1cf7e193da582896" class="i property">Value</a>,
                <span class="i">args</span>: <b>new</b> <b>object</b>[] {
                                               <span class="r239 r">propertiesToUpdate</span>,
                                               <a href="#a2f5b3e97929fd62" class="i field">s_initParametersMap</a>,
                                               <a href="#06d26f0ccfb63d9a" class="i field">force</a>,
                                               <a href="#e47691b9a35b161f" class="i field">sddl</a>,
                                               <a href="#ea050dfcef60d743" class="i field">isSddlSpecified</a>,
                                               <a href="#e14e225be242dd67" class="i property">ShowSecurityDescriptorUI</a>.<a href="../../MshCmdlet.cs.html#1292a5d1a1a3e8e8" class="i method">ToBool</a>(),
                                               <a href="../fanin/WSManNativeAPI.cs.html#46dd878f72638b32" class="t t">WSManNativeApi</a>.<a href="../fanin/WSManNativeAPI.cs.html#f383edcf61712f90" class="i field">ResourceURIPrefix</a> + <a href="#50e45ca03ff16b28" class="i field">shellName</a>,
                                               <span class="r235 r">shellNotFoundErrorMsg</span>,
                                               <span class="r236 r">shellNotPowerShellMsg</span>,
                                               <span class="r237 r">shellForPowerShellCoreMsg</span>,
                                               <span class="r238 r">shellForWindowsPowerShellMsg</span>,
                                               <a href="#2a410c15d6e039b9" class="i field">accessModeSpecified</a> ? <a href="#66d32f1366ccb752" class="i property">AccessMode</a> : <a href="../common/RunspaceConnectionInfo.cs.html#10edf62c3f6a89b0" class="t t">PSSessionConfigurationAccessMode</a>.<a href="../common/RunspaceConnectionInfo.cs.html#43e3b9106e6c81f0" class="i field">Disabled</a>,
           });
 
            <span class="r240 r">errorList</span> = (<span class="i">ArrayList</span>)<a href="../../CommandBase.cs.html#a41a765d70fc9c9d" class="i property">Context</a>.<a href="../../ExecutionContext.cs.html#9f5bde284d161965" class="i property">DollarErrorVariable</a>;
 
            <b>if</b> (<span class="r240 r">errorList</span>.<span class="i">Count</span> &gt; <span class="r241 r">errorCountBefore</span>)
            {
                <a href="#f1a01bf793f852ef" class="i field">_isErrorReported</a> = <b>true</b>;
                <b>return</b>;
            }
 
            <a href="#9bcb4ba987c74a6c" class="i method">SetSessionConfigurationTypeOptions</a>();
 
            <b>if</b> (<span class="r240 r">errorList</span>.<span class="i">Count</span> &gt; <span class="r241 r">errorCountBefore</span>)
            {
                <a href="#f1a01bf793f852ef" class="i field">_isErrorReported</a> = <b>true</b>;
                <b>return</b>;
            }
 
            <a href="#b4cfb482e035dbf7" class="i method">SetQuotas</a>();
 
            <b>if</b> (<span class="r240 r">errorList</span>.<span class="i">Count</span> &gt; <span class="r241 r">errorCountBefore</span>)
            {
                <a href="#f1a01bf793f852ef" class="i field">_isErrorReported</a> = <b>true</b>;
                <b>return</b>;
            }
 
            <a href="#894f590eebb3e88e" class="i method">SetRunAs</a>();
 
            <b>if</b> (<span class="r240 r">errorList</span>.<span class="i">Count</span> &gt; <span class="r241 r">errorCountBefore</span>)
            {
                <a href="#f1a01bf793f852ef" class="i field">_isErrorReported</a> = <b>true</b>;
                <b>return</b>;
            }
 
            <a href="#d824bb3dd97a7eba" class="i method">SetVirtualAccount</a>();
 
            <b>if</b> (<span class="r240 r">errorList</span>.<span class="i">Count</span> &gt; <span class="r241 r">errorCountBefore</span>)
            {
                <a href="#f1a01bf793f852ef" class="i field">_isErrorReported</a> = <b>true</b>;
                <b>return</b>;
            }
 
            <span class="c">// Move the WinRM service to its own service host if the endpoint is given elevated credentials</span>
            <b>if</b> (<a href="#e2e889cb6609651d" class="i field">isRunAsCredentialSpecified</a> || <a href="#73a5a75f7a76f61d" class="i property">RunAsVirtualAccountSpecified</a>)
            {
                <a href="#2111ec231989f662" class="t t">PSSessionConfigurationCommandUtilities</a>.<a href="#35e6a21548384ea9" class="i method">MoveWinRmToIsolatedServiceHost</a>(<a href="#73a5a75f7a76f61d" class="i property">RunAsVirtualAccountSpecified</a>);
            }
 
            <b>if</b> (<span class="r240 r">errorList</span>.<span class="i">Count</span> &gt; <span class="r241 r">errorCountBefore</span>)
            {
                <a href="#f1a01bf793f852ef" class="i field">_isErrorReported</a> = <b>true</b>;
                <b>return</b>;
            }
 
            <a href="#feac6753600fb0b8" class="i method">SetOptions</a>();
 
            <b>if</b> (<span class="r240 r">errorList</span>.<span class="i">Count</span> &gt; <span class="r241 r">errorCountBefore</span>)
            {
                <a href="#f1a01bf793f852ef" class="i field">_isErrorReported</a> = <b>true</b>;
                <b>return</b>;
            }
        }
 
        <b>private void</b> <a id="894f590eebb3e88e" href="../../../R/894f590eebb3e88e.html" target="n" data-glyph="76,1" class="i method">SetRunAs</a>()
        {
            <b>if</b> (<a href="#cc2731857df70643" class="k">this</a>.<a href="#0c6742692211cee9" class="i field">runAsCredential</a> == <b>null</b>)
            {
                <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<a href="#0bb3f7d73df06a34" class="i field">_gmsaAccount</a>)) { <b>return</b>; }
 
                <a href="#0c6742692211cee9" class="i field">runAsCredential</a> = <a href="#2111ec231989f662" class="t t">PSSessionConfigurationCommandUtilities</a>.<a href="#5655deae904cb964" class="i method">CreateGMSAAccountCredentials</a>(<a href="#0bb3f7d73df06a34" class="i field">_gmsaAccount</a>);
            }
 
            <a href="../../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="t t">ScriptBlock</a> <span id="r242 rd" class="r242 r">setRunAsSbFormatSb</span> = <a href="../../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="t t">ScriptBlock</a>.<span class="i">Create</span>(
                <b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>, <a href="#590d53af92b6ef48" class="i field">setRunAsSbFormat</a>, <a href="../../lang/codegen.cs.html#ec5e2f0e22eb2223" class="t t">CodeGeneration</a>.<a href="../../lang/codegen.cs.html#99c5bb762439f325" class="i method">EscapeSingleQuotedStringContent</a>(<a href="#ff3d179414dbc3ad" class="i property">Name</a>)));
            <span class="r242 r">setRunAsSbFormatSb</span>.<a href="../../lang/scriptblock.cs.html#5e76a9fb0d1a7f12" class="i property">LanguageMode</a> = <a href="../../SessionStatePublic.cs.html#450052824aba2e3f" class="t t">PSLanguageMode</a>.<a href="../../SessionStatePublic.cs.html#eec721eb8c02f156" class="i field">FullLanguage</a>;
 
            <span class="r242 r">setRunAsSbFormatSb</span>.<span class="i">InvokeUsingCmdlet</span>(
                  <span class="i">contextCmdlet</span>: <a href="#cc2731857df70643" class="k">this</a>,
                  <span class="i">useLocalScope</span>: <b>true</b>,
                  <span class="i">errorHandlingBehavior</span>: <a href="../../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="t t">ScriptBlock</a>.<a href="../../lang/scriptblock.cs.html#10c045824f712272" class="t t">ErrorHandlingBehavior</a>.<a href="../../lang/scriptblock.cs.html#5e78734ffe1c6ed3" class="i field">WriteToCurrentErrorPipe</a>,
                  <span class="i">dollarUnder</span>: <a href="../../AutomationNull.cs.html#681fbea4c40e4af1" class="t t">AutomationNull</a>.<a href="../../AutomationNull.cs.html#1cf7e193da582896" class="i property">Value</a>,
                  <span class="i">input</span>: <span class="i">Array</span>.<span class="i">Empty</span>&lt;<b>object</b>&gt;(),
                  <span class="i">scriptThis</span>: <a href="../../AutomationNull.cs.html#681fbea4c40e4af1" class="t t">AutomationNull</a>.<a href="../../AutomationNull.cs.html#1cf7e193da582896" class="i property">Value</a>,
                  <span class="i">args</span>: <b>new</b> <b>object</b>[] {
                            <a href="#0c6742692211cee9" class="i field">runAsCredential</a>.<a href="../../Credential.cs.html#3fca673651eaeaff" class="i property">UserName</a>,
                            <a href="#0c6742692211cee9" class="i field">runAsCredential</a>.<a href="../../Credential.cs.html#828d5fa008f1755c" class="i property">Password</a>,
                        });
        }
 
        <b>private void</b> <a id="d824bb3dd97a7eba" href="../../../R/d824bb3dd97a7eba.html" target="n" data-glyph="76,1" class="i method">SetVirtualAccount</a>()
        {
            <b>if</b> (!<a href="#cc2731857df70643" class="k">this</a>.<a href="#73a5a75f7a76f61d" class="i property">RunAsVirtualAccountSpecified</a>)
                <b>return</b>;
 
            <b>using</b> (<span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="../../hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShell</a> <span id="r243 rd" class="r243 r">invoker</span> = <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="../../hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShell</a>.<a href="../../hostifaces/PowerShell.cs.html#1c6a51d3c837bb4d" class="i method">Create</a>(<a href="../../hostifaces/PowerShell.cs.html#c3c0f0e5e0b337ff" class="t t">RunspaceMode</a>.<a href="../../hostifaces/PowerShell.cs.html#75d224de5df87e75" class="i field">CurrentRunspace</a>))
            {
                <b>string</b> <span id="r244 rd" class="r244 r">pluginLocation</span> = <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<a href="../../../utils/StringUtil.cs.html#6dd43165d0b5d92f" class="i method">Format</a>(<span class="s">@&quot;WSMAN:\localhost\plugin\{0}\RunAsVirtualAccount&quot;</span>, <a href="#ff3d179414dbc3ad" class="i property">Name</a>);
                <span class="r243 r">invoker</span>.<a href="../../hostifaces/PowerShell.cs.html#9cc79c297f6cced9" class="i method">AddCommand</a>(<span class="s">&quot;Set-Item&quot;</span>).<a href="../../hostifaces/PowerShell.cs.html#40674f99a3618f4b" class="i method">AddParameter</a>(<span class="s">&quot;Path&quot;</span>, <span class="r244 r">pluginLocation</span>).<a href="../../hostifaces/PowerShell.cs.html#40674f99a3618f4b" class="i method">AddParameter</a>(<span class="s">&quot;Value&quot;</span>, <a href="#cc2731857df70643" class="k">this</a>.<a href="#4dcf2ffea1a67e82" class="i property">RunAsVirtualAccount</a>);
                <span class="r243 r">invoker</span>.<a href="../../hostifaces/PowerShell.cs.html#184e23c46120523e" class="i method">Invoke</a>();
            }
        }
 
        <b>private void</b> <a id="b4cfb482e035dbf7" href="../../../R/b4cfb482e035dbf7.html" target="n" data-glyph="76,1" class="i method">SetQuotas</a>()
        {
            <b>if</b> (<a href="#cc2731857df70643" class="k">this</a>.<a href="#47818cf18fb88e71" class="i field">transportOption</a> != <b>null</b>)
            {
                <a href="../../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="t t">ScriptBlock</a> <span id="r245 rd" class="r245 r">setQuotasSb</span> = <a href="../../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="t t">ScriptBlock</a>.<span class="i">Create</span>(
                       <b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>, <a href="#35781d4a7db9267e" class="i field">setSessionConfigurationQuotaSbFormat</a>, <a href="../../lang/codegen.cs.html#ec5e2f0e22eb2223" class="t t">CodeGeneration</a>.<a href="../../lang/codegen.cs.html#99c5bb762439f325" class="i method">EscapeSingleQuotedStringContent</a>(<a href="#ff3d179414dbc3ad" class="i property">Name</a>)));
                <span class="r245 r">setQuotasSb</span>.<a href="../../lang/scriptblock.cs.html#5e76a9fb0d1a7f12" class="i property">LanguageMode</a> = <a href="../../SessionStatePublic.cs.html#450052824aba2e3f" class="t t">PSLanguageMode</a>.<a href="../../SessionStatePublic.cs.html#eec721eb8c02f156" class="i field">FullLanguage</a>;
 
                <span class="i">Hashtable</span> <span id="r246 rd" class="r246 r">quotas</span> = <a href="#47818cf18fb88e71" class="i field">transportOption</a>.<a href="../common/PSSessionConfigurationTypeOption.cs.html#65c435f08d1a8fea" class="i method">ConstructQuotasAsHashtable</a>();
 
                <span class="r245 r">setQuotasSb</span>.<span class="i">InvokeUsingCmdlet</span>(
                    <span class="i">contextCmdlet</span>: <a href="#cc2731857df70643" class="k">this</a>,
                    <span class="i">useLocalScope</span>: <b>true</b>,
                    <span class="i">errorHandlingBehavior</span>: <a href="../../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="t t">ScriptBlock</a>.<a href="../../lang/scriptblock.cs.html#10c045824f712272" class="t t">ErrorHandlingBehavior</a>.<a href="../../lang/scriptblock.cs.html#5e78734ffe1c6ed3" class="i field">WriteToCurrentErrorPipe</a>,
                    <span class="i">dollarUnder</span>: <a href="../../AutomationNull.cs.html#681fbea4c40e4af1" class="t t">AutomationNull</a>.<a href="../../AutomationNull.cs.html#1cf7e193da582896" class="i property">Value</a>,
                    <span class="i">input</span>: <span class="i">Array</span>.<span class="i">Empty</span>&lt;<b>object</b>&gt;(),
                    <span class="i">scriptThis</span>: <a href="../../AutomationNull.cs.html#681fbea4c40e4af1" class="t t">AutomationNull</a>.<a href="../../AutomationNull.cs.html#1cf7e193da582896" class="i property">Value</a>,
                    <span class="i">args</span>: <b>new</b> <b>object</b>[] { <span class="r246 r">quotas</span>, });
            }
        }
 
        <b>private void</b> <a id="feac6753600fb0b8" href="../../../R/feac6753600fb0b8.html" target="n" data-glyph="76,1" class="i method">SetOptions</a>()
        {
            <a href="../../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="t t">ScriptBlock</a> <span id="r247 rd" class="r247 r">setOptionsSb</span> = <a href="../../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="t t">ScriptBlock</a>.<span class="i">Create</span>(
                   <b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>, <a href="#81ce68a8a48be73b" class="i field">setSessionConfigurationOptionsSbFormat</a>, <a href="../../lang/codegen.cs.html#ec5e2f0e22eb2223" class="t t">CodeGeneration</a>.<a href="../../lang/codegen.cs.html#99c5bb762439f325" class="i method">EscapeSingleQuotedStringContent</a>(<a href="#ff3d179414dbc3ad" class="i property">Name</a>)));
            <span class="r247 r">setOptionsSb</span>.<a href="../../lang/scriptblock.cs.html#5e76a9fb0d1a7f12" class="i property">LanguageMode</a> = <a href="../../SessionStatePublic.cs.html#450052824aba2e3f" class="t t">PSLanguageMode</a>.<a href="../../SessionStatePublic.cs.html#eec721eb8c02f156" class="i field">FullLanguage</a>;
 
            <span class="i">Hashtable</span> <span id="r248 rd" class="r248 r">optionsTable</span>
                = <a href="#47818cf18fb88e71" class="i field">transportOption</a> != <b>null</b>
                ? <a href="#47818cf18fb88e71" class="i field">transportOption</a>.<a href="../common/PSSessionConfigurationTypeOption.cs.html#26f02313d0b18859" class="i method">ConstructOptionsAsHashtable</a>()
                : <b>new</b> <span class="i">Hashtable</span>();
 
            <b>if</b> (<a href="#2a410c15d6e039b9" class="i field">accessModeSpecified</a>)
            {
                <b>switch</b> (<a href="#66d32f1366ccb752" class="i property">AccessMode</a>)
                {
                    <b>case</b> <a href="../common/RunspaceConnectionInfo.cs.html#10edf62c3f6a89b0" class="t t">PSSessionConfigurationAccessMode</a>.<a href="../common/RunspaceConnectionInfo.cs.html#43e3b9106e6c81f0" class="i field">Disabled</a>:
                        <span class="r248 r">optionsTable</span>[<a href="#1609787001ba6215" class="i field">AllowRemoteAccessToken</a>] = <b>false</b>.<span class="i">ToString</span>();
                        <b>break</b>;
                    <b>case</b> <a href="../common/RunspaceConnectionInfo.cs.html#10edf62c3f6a89b0" class="t t">PSSessionConfigurationAccessMode</a>.<a href="../common/RunspaceConnectionInfo.cs.html#e493a77e156a2d8d" class="i field">Local</a>:
                    <b>case</b> <a href="../common/RunspaceConnectionInfo.cs.html#10edf62c3f6a89b0" class="t t">PSSessionConfigurationAccessMode</a>.<a href="../common/RunspaceConnectionInfo.cs.html#f9938a92bb1a8e5f" class="i field">Remote</a>:
                        <span class="r248 r">optionsTable</span>[<a href="#1609787001ba6215" class="i field">AllowRemoteAccessToken</a>] = <b>true</b>.<span class="i">ToString</span>();
                        <b>break</b>;
                }
            }
 
            <b>if</b> (<a href="#8534b4735dcf261a" class="i field">isUseSharedProcessSpecified</a>)
            {
                <span class="r248 r">optionsTable</span>[<a href="#6e4cbc09e612164f" class="i field">UseSharedProcessToken</a>] = <a href="#50cd764b2f18a757" class="i property">UseSharedProcess</a>.<a href="../../MshCmdlet.cs.html#1292a5d1a1a3e8e8" class="i method">ToBool</a>().<span class="i">ToString</span>();
            }
 
            <span class="r247 r">setOptionsSb</span>.<span class="i">InvokeUsingCmdlet</span>(
                <span class="i">contextCmdlet</span>: <a href="#cc2731857df70643" class="k">this</a>,
                <span class="i">useLocalScope</span>: <b>true</b>,
                <span class="i">errorHandlingBehavior</span>: <a href="../../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="t t">ScriptBlock</a>.<a href="../../lang/scriptblock.cs.html#10c045824f712272" class="t t">ErrorHandlingBehavior</a>.<a href="../../lang/scriptblock.cs.html#5e78734ffe1c6ed3" class="i field">WriteToCurrentErrorPipe</a>,
                <span class="i">dollarUnder</span>: <a href="../../AutomationNull.cs.html#681fbea4c40e4af1" class="t t">AutomationNull</a>.<a href="../../AutomationNull.cs.html#1cf7e193da582896" class="i property">Value</a>,
                <span class="i">input</span>: <span class="i">Array</span>.<span class="i">Empty</span>&lt;<b>object</b>&gt;(),
                <span class="i">scriptThis</span>: <a href="../../AutomationNull.cs.html#681fbea4c40e4af1" class="t t">AutomationNull</a>.<a href="../../AutomationNull.cs.html#1cf7e193da582896" class="i property">Value</a>,
                <span class="i">args</span>: <b>new</b> <b>object</b>[] {
                            <span class="r248 r">optionsTable</span>,
                        });
        }
 
        <b>private void</b> <a id="9bcb4ba987c74a6c" href="../../../R/9bcb4ba987c74a6c.html" target="n" data-glyph="76,1" class="i method">SetSessionConfigurationTypeOptions</a>()
        {
            <b>if</b> (<a href="#f113546061e03199" class="i field">sessionTypeOption</a> != <b>null</b>)
            {
                <b>using</b> (<span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="../../hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShell</a> <span id="r249 rd" class="r249 r">ps</span> = <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="../../hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShell</a>.<a href="../../hostifaces/PowerShell.cs.html#40345bc4625ff918" class="i method">Create</a>())
                {
                    <span class="r249 r">ps</span>.<span class="i">AddScript</span>(<b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>, <a href="#2f157f70a8fe84be" class="i field">getSessionConfigurationDataSbFormat</a>, <a href="../../lang/codegen.cs.html#ec5e2f0e22eb2223" class="t t">CodeGeneration</a>.<a href="../../lang/codegen.cs.html#99c5bb762439f325" class="i method">EscapeSingleQuotedStringContent</a>(<a href="#ff3d179414dbc3ad" class="i property">Name</a>)));
                    <span class="i">Collection</span>&lt;<a href="../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt; <span id="r250 rd" class="r250 r">psObjectCollection</span> = <span class="r249 r">ps</span>.<span class="i">Invoke</span>(<b>new</b> <b>object</b>[] { <a href="#ff3d179414dbc3ad" class="i property">Name</a> }) <b>as</b> <span class="i">Collection</span>&lt;<a href="../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt;;
                    <b>if</b> (<span class="r250 r">psObjectCollection</span> == <b>null</b> || <span class="r250 r">psObjectCollection</span>.<span class="i">Count</span> != 1)
                    {
                        <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<b>false</b>, <span class="s">&quot;This should never happen.  Plugin must exist because caller code has already checked this.&quot;</span>);
                    }
 
                    <a href="../fanin/PSSessionConfigurationData.cs.html#a9929ed8e7a283e6" class="t t">PSSessionConfigurationData</a> <span id="r251 rd" class="r251 r">scd</span> = <a href="../fanin/PSSessionConfigurationData.cs.html#a9929ed8e7a283e6" class="t t">PSSessionConfigurationData</a>.<span class="i">Create</span>(<span class="r250 r">psObjectCollection</span>[0] == <b>null</b> ? <b>string</b>.<span class="i">Empty</span> : <a href="../fanin/PSSessionConfigurationData.cs.html#a9929ed8e7a283e6" class="t t">PSSessionConfigurationData</a>.<span class="i">Unescape</span>(<span class="r250 r">psObjectCollection</span>[0].<span class="i">BaseObject</span>.<span class="i">ToString</span>()));
                    <a href="../common/PSSessionConfigurationTypeOption.cs.html#0fe5ad4095bca803" class="t t">PSSessionTypeOption</a> <span id="r252 rd" class="r252 r">original</span> = <a href="#f113546061e03199" class="i field">sessionTypeOption</a>.<a href="../common/PSSessionConfigurationTypeOption.cs.html#a43f966b8253173a" class="i method">ConstructObjectFromPrivateData</a>(<span class="r251 r">scd</span>.<a href="../fanin/PSSessionConfigurationData.cs.html#bb9edd40d6d06bbd" class="i property">PrivateData</a>);
                    <span class="r252 r">original</span>.<a href="../common/PSSessionConfigurationTypeOption.cs.html#370f69e473bd9292" class="i method">CopyUpdatedValuesFrom</a>(<a href="#f113546061e03199" class="i field">sessionTypeOption</a>);
 
                    <span class="i">StringBuilder</span> <span id="r253 rd" class="r253 r">sessionConfigurationData</span> = <b>new</b> <span class="i">StringBuilder</span>();
 
                    <b>string</b> <span id="r254 rd" class="r254 r">modulePathParameter</span> = <b>null</b>;
                    <b>bool</b> <span id="r255 rd" class="r255 r">unsetModulePath</span> = <b>false</b>;
                    <b>if</b> (<a href="#edd32a5daaa63fbd" class="i field">modulePathSpecified</a>)
                    {
                        <b>if</b> (<a href="#647dbedff4303e3b" class="i field">modulesToImport</a> == <b>null</b> ||
                            <a href="#647dbedff4303e3b" class="i field">modulesToImport</a>.<span class="i">Length</span> == 0 ||
                            (<a href="#647dbedff4303e3b" class="i field">modulesToImport</a>.<span class="i">Length</span> == 1 &amp;&amp; <a href="#647dbedff4303e3b" class="i field">modulesToImport</a>[0] <b>is string</b> &amp;&amp; ((<b>string</b>)<a href="#647dbedff4303e3b" class="i field">modulesToImport</a>[0]).<span class="i">Equals</span>(<b>string</b>.<span class="i">Empty</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>)))
                        {
                            <span class="r255 r">unsetModulePath</span> = <b>true</b>;
                        }
                        <b>else</b>
                        {
                            <span class="r254 r">modulePathParameter</span> = <a href="#2111ec231989f662" class="t t">PSSessionConfigurationCommandUtilities</a>.<a href="#73ff792c03cd5e50" class="i method">GetModulePathAsString</a>(<a href="#cc2731857df70643" class="k">this</a>.<a href="#647dbedff4303e3b" class="i field">modulesToImport</a>).<span class="i">Trim</span>();
                        }
                    }
 
                    <span class="c">// If the ModulesToImport parameter is not specified, or it is specified, but modulePathParameter turns out to be an empty string,</span>
                    <span class="c">// we use the original module path</span>
                    <b>if</b> (!<span class="r255 r">unsetModulePath</span> &amp;&amp; <b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r254 r">modulePathParameter</span>))
                    {
                        <span class="r254 r">modulePathParameter</span> = (<span class="r251 r">scd</span>.<a href="../fanin/PSSessionConfigurationData.cs.html#951b2726df7b4965" class="i property">ModulesToImportInternal</a> == <b>null</b>) ? <b>null</b> : <a href="#2111ec231989f662" class="t t">PSSessionConfigurationCommandUtilities</a>.<span class="i">GetModulePathAsString</span>(<span class="r251 r">scd</span>.<a href="../fanin/PSSessionConfigurationData.cs.html#951b2726df7b4965" class="i property">ModulesToImportInternal</a>.<span class="i">ToArray</span>()).<span class="i">Trim</span>();
                    }
 
                    <span class="c">// 1. unsetModulePath is true. In this case, modulePathParameter is definitely null</span>
                    <span class="c">// 2. unsetModulePath is false.</span>
                    <span class="c">//    a. modulePathSpecified is false. In this case, modulePathParameter will be the original module path,</span>
                    <span class="c">//       and it&#39;s null or empty when the original module path is null or empty</span>
                    <span class="c">//    b. modulePathSpecified is true. In this case, the user specified modulePathParameter is empty after trim(),</span>
                    <span class="c">//       and it will be the original module path. It&#39;s null or empty when the original module path is null or empty.</span>
                    <b>if</b> (<span class="r255 r">unsetModulePath</span> || <b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r254 r">modulePathParameter</span>))
                    {
                        <span class="r253 r">sessionConfigurationData</span>.<span class="i">Append</span>(<b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>,
                                <a href="#4221a2a3f4b7719e" class="i field">initParamFormat</a>,
                                <a href="../fanin/PSSessionConfigurationData.cs.html#a9929ed8e7a283e6" class="t t">PSSessionConfigurationData</a>.<a href="../fanin/PSSessionConfigurationData.cs.html#e473b0c22548cf0a" class="i field">ModulesToImportToken</a>, <b>string</b>.<span class="i">Empty</span>));
                    }
                    <span class="c">// unsetModulePath is false AND modulePathParameter is not empty.</span>
                    <span class="c">// 1. modulePathSpecified is false. In this case, modulePathParameter will be the original module path.</span>
                    <span class="c">// 2. modulePathSpecified is true. In this case, the user is not unsetting the module path.</span>
                    <span class="c">//    a. the user specified module path is not empty.</span>
                    <span class="c">//    b. the user specified module path is empty after trim(), and modulePathParameter will be the original module path.</span>
                    <b>else</b>
                    {
                        <span class="r253 r">sessionConfigurationData</span>.<span class="i">Append</span>(<b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>,
                                <a href="#4221a2a3f4b7719e" class="i field">initParamFormat</a>,
                                <a href="../fanin/PSSessionConfigurationData.cs.html#a9929ed8e7a283e6" class="t t">PSSessionConfigurationData</a>.<a href="../fanin/PSSessionConfigurationData.cs.html#e473b0c22548cf0a" class="i field">ModulesToImportToken</a>,
                                <span class="r254 r">modulePathParameter</span>));
                    }
 
                    <b>string</b> <span id="r256 rd" class="r256 r">privateData</span> = <span class="r252 r">original</span>.<a href="../common/PSSessionConfigurationTypeOption.cs.html#d1ee5d6672578519" class="i method">ConstructPrivateData</a>();
                    <b>if</b> (!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r256 r">privateData</span>))
                    {
                        <span class="r253 r">sessionConfigurationData</span>.<span class="i">Append</span>(<b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>, <a href="#498ff8e11d3f9998" class="i field">privateDataFormat</a>, <span class="r256 r">privateData</span>));
                    }
 
                    <b>if</b> (<span class="r253 r">sessionConfigurationData</span>.<span class="i">Length</span> &gt; 0)
                    {
                        <b>string</b> <span id="r257 rd" class="r257 r">sessionConfigData</span> = <b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>,
                                                                 <a href="#1b015a5247b3f62a" class="i field">SessionConfigDataFormat</a>,
                                                                 <span class="r253 r">sessionConfigurationData</span>);
                        <b>string</b> <span id="r258 rd" class="r258 r">encodedSessionConfigData</span> = <span class="i">SecurityElement</span>.<span class="i">Escape</span>(<span class="r257 r">sessionConfigData</span>);
                        <a href="../../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="t t">ScriptBlock</a> <span id="r259 rd" class="r259 r">setSessionConfigurationSb</span> = <a href="../../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="t t">ScriptBlock</a>.<span class="i">Create</span>(
                            <b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>, <a href="#521f39b08acbba0c" class="i field">setSessionConfigurationDataSbFormat</a>, <a href="../../lang/codegen.cs.html#ec5e2f0e22eb2223" class="t t">CodeGeneration</a>.<a href="../../lang/codegen.cs.html#99c5bb762439f325" class="i method">EscapeSingleQuotedStringContent</a>(<a href="#ff3d179414dbc3ad" class="i property">Name</a>))
                        );
                        <span class="r259 r">setSessionConfigurationSb</span>.<a href="../../lang/scriptblock.cs.html#5e76a9fb0d1a7f12" class="i property">LanguageMode</a> = <a href="../../SessionStatePublic.cs.html#450052824aba2e3f" class="t t">PSLanguageMode</a>.<a href="../../SessionStatePublic.cs.html#eec721eb8c02f156" class="i field">FullLanguage</a>;
 
                        <span class="r259 r">setSessionConfigurationSb</span>.<span class="i">InvokeUsingCmdlet</span>(
                            <span class="i">contextCmdlet</span>: <a href="#cc2731857df70643" class="k">this</a>,
                            <span class="i">useLocalScope</span>: <b>true</b>,
                            <span class="i">errorHandlingBehavior</span>: <a href="../../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="t t">ScriptBlock</a>.<a href="../../lang/scriptblock.cs.html#10c045824f712272" class="t t">ErrorHandlingBehavior</a>.<a href="../../lang/scriptblock.cs.html#5e78734ffe1c6ed3" class="i field">WriteToCurrentErrorPipe</a>,
                            <span class="i">dollarUnder</span>: <a href="../../AutomationNull.cs.html#681fbea4c40e4af1" class="t t">AutomationNull</a>.<a href="../../AutomationNull.cs.html#1cf7e193da582896" class="i property">Value</a>,
                            <span class="i">input</span>: <span class="i">Array</span>.<span class="i">Empty</span>&lt;<b>object</b>&gt;(),
                            <span class="i">scriptThis</span>: <a href="../../AutomationNull.cs.html#681fbea4c40e4af1" class="t t">AutomationNull</a>.<a href="../../AutomationNull.cs.html#1cf7e193da582896" class="i property">Value</a>,
                            <span class="i">args</span>: <b>new</b> <b>object</b>[] {
                                                <span class="r258 r">encodedSessionConfigData</span>,
                                              });
                    }
                }
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>protected override void</b> <a id="f1440c218234266b" href="../../../R/f1440c218234266b.html" target="n" data-glyph="75,1" class="i method">EndProcessing</a>()
        {
            <a href="#2111ec231989f662" class="t t">PSSessionConfigurationCommandUtilities</a>.<a href="#ba59a730ba64c719" class="i method">RestartWinRMService</a>(<a href="#cc2731857df70643" class="k">this</a>, <a href="#f1a01bf793f852ef" class="i field">_isErrorReported</a>, <a href="#e0d3550cf787fbdc" class="i property">Force</a>, <a href="#89e5f845fe6ddd31" class="i field">noRestart</a>);
            <b>if</b> (!<a href="#f1a01bf793f852ef" class="i field">_isErrorReported</a> &amp;&amp; <a href="#89e5f845fe6ddd31" class="i field">noRestart</a>)
            {
                <b>string</b> <span id="r260 rd" class="r260 r">action</span> = <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">CSShouldProcessAction</span>, <a href="#cc2731857df70643" class="k">this</a>.<a href="../../CommandBase.cs.html#1f4a1f38862b466a" class="i property">CommandInfo</a>.<a href="../../CommandInfo.cs.html#02e11b521c500195" class="i property">Name</a>);
                <a href="../../cmdlet.cs.html#dda5a07d1a8a6cba" class="i method">WriteWarning</a>(<a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">WinRMRequiresRestart</span>, <span class="r260 r">action</span>));
            }
 
            <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Tracing</span>.<a href="../../../P/5b1d077d1aa35b55.html#5b1d077d1aa35b55" class="t t">Tracer</a> <span id="r261 rd" class="r261 r">tracer</span> = <b>new</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Tracing</span>.<a href="../../../utils/tracing/TracingGen.cs.html#3e4070d535f42333" class="t constructor">Tracer</a>();
            <span class="r261 r">tracer</span>.<span class="i">EndpointModified</span>(<a href="#cc2731857df70643" class="k">this</a>.<a href="#ff3d179414dbc3ad" class="i property">Name</a>, <span class="i">WindowsIdentity</span>.<span class="i">GetCurrent</span>().<span class="i">Name</span>);
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Private Methods
 
        <b>private</b> <a href="../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <a id="d417f7627c115299" href="../../../R/d417f7627c115299.html" target="n" data-glyph="76,1" class="i method">ConstructPropertiesForUpdate</a>()
        {
            <a href="../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r262 rd" class="r262 r">result</span> = <b>new</b> <a href="../../MshObject.cs.html#cbbe437e20e8b8b8" class="t constructor">PSObject</a>();
            <span class="r262 r">result</span>.<a href="../../MshObject.cs.html#59e9cd1ad57ccd34" class="i property">Properties</a>.<a href="../../MshMemberInfo.cs.html#a9e3a2dc56d98237" class="i method">Add</a>(<b>new</b> <a href="../../MshMemberInfo.cs.html#f4e5bccf8ccb9f2a" class="t constructor">PSNoteProperty</a>(<span class="s">&quot;Name&quot;</span>, <a href="#50e45ca03ff16b28" class="i field">shellName</a>));
 
            <b>if</b> (<a href="#c33288066c34ebf4" class="i field">isAssemblyNameSpecified</a>)
            {
                <span class="r262 r">result</span>.<a href="../../MshObject.cs.html#59e9cd1ad57ccd34" class="i property">Properties</a>.<a href="../../MshMemberInfo.cs.html#a9e3a2dc56d98237" class="i method">Add</a>(<b>new</b> <a href="../../MshMemberInfo.cs.html#f4e5bccf8ccb9f2a" class="t constructor">PSNoteProperty</a>(<a href="../fanin/InitialSessionStateProvider.cs.html#88c11924f622f7f5" class="t t">ConfigurationDataFromXML</a>.<a href="../fanin/InitialSessionStateProvider.cs.html#a760798ff3d1d31c" class="i field">ASSEMBLYTOKEN</a>, <a href="#027266a61924c685" class="i field">assemblyName</a>));
            }
 
            <b>if</b> (<a href="#008bf63d35c7416c" class="i field">isApplicationBaseSpecified</a>)
            {
                <span class="r262 r">result</span>.<a href="../../MshObject.cs.html#59e9cd1ad57ccd34" class="i property">Properties</a>.<a href="../../MshMemberInfo.cs.html#a9e3a2dc56d98237" class="i method">Add</a>(<b>new</b> <a href="../../MshMemberInfo.cs.html#f4e5bccf8ccb9f2a" class="t constructor">PSNoteProperty</a>(<a href="../fanin/InitialSessionStateProvider.cs.html#88c11924f622f7f5" class="t t">ConfigurationDataFromXML</a>.<a href="../fanin/InitialSessionStateProvider.cs.html#c6bdad55d5b9cfe9" class="i field">APPBASETOKEN</a>, <a href="#a175420dee4e8b20" class="i field">applicationBase</a>));
            }
 
            <b>if</b> (<a href="#b2b50b4cfefbcf8c" class="i field">isConfigurationTypeNameSpecified</a>)
            {
                <span class="r262 r">result</span>.<a href="../../MshObject.cs.html#59e9cd1ad57ccd34" class="i property">Properties</a>.<a href="../../MshMemberInfo.cs.html#a9e3a2dc56d98237" class="i method">Add</a>(<b>new</b> <a href="../../MshMemberInfo.cs.html#f4e5bccf8ccb9f2a" class="t constructor">PSNoteProperty</a>(<a href="../fanin/InitialSessionStateProvider.cs.html#88c11924f622f7f5" class="t t">ConfigurationDataFromXML</a>.<a href="../fanin/InitialSessionStateProvider.cs.html#5b4979d69407d7e3" class="i field">SHELLCONFIGTYPETOKEN</a>, <a href="#074874d626401161" class="i field">configurationTypeName</a>));
            }
 
            <b>if</b> (<a href="#4bd82b2f9c7eafd4" class="i field">isConfigurationScriptSpecified</a>)
            {
                <span class="r262 r">result</span>.<a href="../../MshObject.cs.html#59e9cd1ad57ccd34" class="i property">Properties</a>.<a href="../../MshMemberInfo.cs.html#a9e3a2dc56d98237" class="i method">Add</a>(<b>new</b> <a href="../../MshMemberInfo.cs.html#f4e5bccf8ccb9f2a" class="t constructor">PSNoteProperty</a>(<a href="../fanin/InitialSessionStateProvider.cs.html#88c11924f622f7f5" class="t t">ConfigurationDataFromXML</a>.<a href="../fanin/InitialSessionStateProvider.cs.html#a5044dd5ccc8fb43" class="i field">STARTUPSCRIPTTOKEN</a>, <a href="#fb73a00555a3f409" class="i field">configurationScript</a>));
            }
 
            <b>if</b> (<a href="#4a8486b780353476" class="i field">isMaxCommandSizeMBSpecified</a>)
            {
                <b>object</b> <span id="r263 rd" class="r263 r">input</span> = <a href="#da4464aa9e583b35" class="i field">maxCommandSizeMB</a>.<span class="i">HasValue</span> ? (<b>object</b>)<a href="#da4464aa9e583b35" class="i field">maxCommandSizeMB</a>.<span class="i">Value</span> : <b>null</b>;
                <span class="r262 r">result</span>.<a href="../../MshObject.cs.html#59e9cd1ad57ccd34" class="i property">Properties</a>.<a href="../../MshMemberInfo.cs.html#a9e3a2dc56d98237" class="i method">Add</a>(<b>new</b> <a href="../../MshMemberInfo.cs.html#f4e5bccf8ccb9f2a" class="t constructor">PSNoteProperty</a>(<a href="../fanin/InitialSessionStateProvider.cs.html#88c11924f622f7f5" class="t t">ConfigurationDataFromXML</a>.<a href="../fanin/InitialSessionStateProvider.cs.html#1f07f200d8e7326a" class="i field">MAXRCVDCMDSIZETOKEN</a>, <span class="r263 r">input</span>));
            }
 
            <b>if</b> (<a href="#39b7869b95e51698" class="i field">isMaxObjectSizeMBSpecified</a>)
            {
                <b>object</b> <span id="r264 rd" class="r264 r">input</span> = <a href="#37570a27dc4089f7" class="i field">maxObjectSizeMB</a>.<span class="i">HasValue</span> ? (<b>object</b>)<a href="#37570a27dc4089f7" class="i field">maxObjectSizeMB</a>.<span class="i">Value</span> : <b>null</b>;
                <span class="r262 r">result</span>.<a href="../../MshObject.cs.html#59e9cd1ad57ccd34" class="i property">Properties</a>.<a href="../../MshMemberInfo.cs.html#a9e3a2dc56d98237" class="i method">Add</a>(<b>new</b> <a href="../../MshMemberInfo.cs.html#f4e5bccf8ccb9f2a" class="t constructor">PSNoteProperty</a>(<a href="../fanin/InitialSessionStateProvider.cs.html#88c11924f622f7f5" class="t t">ConfigurationDataFromXML</a>.<a href="../fanin/InitialSessionStateProvider.cs.html#10b5800d17b0f40c" class="i field">MAXRCVDOBJSIZETOKEN</a>, <span class="r264 r">input</span>));
            }
 
            <b>if</b> (<a href="#cef28738a403d686" class="i field">threadAptState</a>.<span class="i">HasValue</span>)
            {
                <span class="r262 r">result</span>.<a href="../../MshObject.cs.html#59e9cd1ad57ccd34" class="i property">Properties</a>.<a href="../../MshMemberInfo.cs.html#a9e3a2dc56d98237" class="i method">Add</a>(<b>new</b> <span class="t">PSNoteProperty</span>(<a href="../fanin/InitialSessionStateProvider.cs.html#88c11924f622f7f5" class="t t">ConfigurationDataFromXML</a>.<a href="../fanin/InitialSessionStateProvider.cs.html#49974ff8bb3d2d73" class="i field">THREADAPTSTATETOKEN</a>, <a href="#cef28738a403d686" class="i field">threadAptState</a>.<span class="i">Value</span>));
            }
 
            <b>if</b> (<a href="#c123bdda35248dcf" class="i field">threadOptions</a>.<span class="i">HasValue</span>)
            {
                <span class="r262 r">result</span>.<a href="../../MshObject.cs.html#59e9cd1ad57ccd34" class="i property">Properties</a>.<a href="../../MshMemberInfo.cs.html#a9e3a2dc56d98237" class="i method">Add</a>(<b>new</b> <span class="t">PSNoteProperty</span>(<a href="../fanin/InitialSessionStateProvider.cs.html#88c11924f622f7f5" class="t t">ConfigurationDataFromXML</a>.<a href="../fanin/InitialSessionStateProvider.cs.html#cd5d7a116ed4a287" class="i field">THREADOPTIONSTOKEN</a>, <a href="#c123bdda35248dcf" class="i field">threadOptions</a>.<span class="i">Value</span>));
            }
 
            <b>if</b> (<a href="#461be9a9e6b577d5" class="i field">isPSVersionSpecified</a>)
            {
                <span class="r262 r">result</span>.<a href="../../MshObject.cs.html#59e9cd1ad57ccd34" class="i property">Properties</a>.<a href="../../MshMemberInfo.cs.html#a9e3a2dc56d98237" class="i method">Add</a>(<b>new</b> <span class="t">PSNoteProperty</span>(<a href="../fanin/InitialSessionStateProvider.cs.html#88c11924f622f7f5" class="t t">ConfigurationDataFromXML</a>.<a href="../fanin/InitialSessionStateProvider.cs.html#cfdd5431fae23a53" class="i field">PSVERSIONTOKEN</a>, <a href="#2111ec231989f662" class="t t">PSSessionConfigurationCommandUtilities</a>.<a href="#aab93b7be731e2b8" class="i method">ConstructVersionFormatForConfigXml</a>(<a href="#9a883983f56cfb3d" class="i field">psVersion</a>)));
                <a href="#21f5de889788ab87" class="i field">MaxPSVersion</a> = <a href="#2111ec231989f662" class="t t">PSSessionConfigurationCommandUtilities</a>.<a href="#40e55d810510e76a" class="i method">CalculateMaxPSVersion</a>(<a href="#9a883983f56cfb3d" class="i field">psVersion</a>);
 
                <span class="c">// We add MaxPSVersion to the result irrespective of whether the string is empty or not.</span>
                <span class="c">// This is done to cover the following scenario</span>
                <span class="c">// Register-PSSessionConfiguration -Name &quot;blah&quot; -PSVersion 2</span>
                <span class="c">//      followed by a</span>
                <span class="c">// Set-PSSessionConfiguration -Name &quot;blah&quot; -PSVersion 3</span>
                <span class="c">// If you create an end point with version 2 and then update it to 3, then the MaxPsVersion parameter should be removed from config xml</span>
                <span class="c">// So, we create a MaxPSVersion property with no value.</span>
                <span class="c">// In function Set-PSSessionConfiguration, the registry item MaxPSVersion will be removed.</span>
                <span class="c">// But it will not be created since the value is empty.</span>
                <span class="r262 r">result</span>.<a href="../../MshObject.cs.html#59e9cd1ad57ccd34" class="i property">Properties</a>.<a href="../../MshMemberInfo.cs.html#a9e3a2dc56d98237" class="i method">Add</a>(<b>new</b> <span class="t">PSNoteProperty</span>(<a href="../fanin/InitialSessionStateProvider.cs.html#88c11924f622f7f5" class="t t">ConfigurationDataFromXML</a>.<a href="../fanin/InitialSessionStateProvider.cs.html#875775f1b987cd71" class="i field">MAXPSVERSIONTOKEN</a>, <a href="#2111ec231989f662" class="t t">PSSessionConfigurationCommandUtilities</a>.<a href="#aab93b7be731e2b8" class="i method">ConstructVersionFormatForConfigXml</a>(<a href="#21f5de889788ab87" class="i field">MaxPSVersion</a>)));
            }
 
            <b>if</b> (<a href="#edd32a5daaa63fbd" class="i field">modulePathSpecified</a> &amp;&amp; <a href="#f113546061e03199" class="i field">sessionTypeOption</a> == <b>null</b>)
            {
                <b>bool</b> <span id="r265 rd" class="r265 r">unsetModulePath</span> = <b>false</b>;
                <b>string</b> <span id="r266 rd" class="r266 r">modulePathParameter</span> = <b>null</b>;
 
                <b>if</b> (<a href="#647dbedff4303e3b" class="i field">modulesToImport</a> == <b>null</b> || <a href="#647dbedff4303e3b" class="i field">modulesToImport</a>.<span class="i">Length</span> == 0 ||
                    (<a href="#647dbedff4303e3b" class="i field">modulesToImport</a>.<span class="i">Length</span> == 1 &amp;&amp; <a href="#647dbedff4303e3b" class="i field">modulesToImport</a>[0] <b>is string</b> &amp;&amp; ((<b>string</b>)<a href="#647dbedff4303e3b" class="i field">modulesToImport</a>[0]).<span class="i">Equals</span>(<b>string</b>.<span class="i">Empty</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>)))
                {
                    <span class="r265 r">unsetModulePath</span> = <b>true</b>;
                }
                <b>else</b>
                {
                    <span class="r266 r">modulePathParameter</span> = <a href="#2111ec231989f662" class="t t">PSSessionConfigurationCommandUtilities</a>.<a href="#73ff792c03cd5e50" class="i method">GetModulePathAsString</a>(<a href="#cc2731857df70643" class="k">this</a>.<a href="#647dbedff4303e3b" class="i field">modulesToImport</a>).<span class="i">Trim</span>();
                }
 
                <b>if</b> (<span class="r265 r">unsetModulePath</span> || !<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r266 r">modulePathParameter</span>))
                {
                    <b>using</b> (<span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="../../hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShell</a> <span id="r267 rd" class="r267 r">ps</span> = <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="../../hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShell</a>.<a href="../../hostifaces/PowerShell.cs.html#40345bc4625ff918" class="i method">Create</a>())
                    {
                        <span class="c">// Get the SessionConfigurationDataFormat</span>
                        <span class="r267 r">ps</span>.<span class="i">AddScript</span>(<b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>, <a href="#2f157f70a8fe84be" class="i field">getSessionConfigurationDataSbFormat</a>, <a href="../../lang/codegen.cs.html#ec5e2f0e22eb2223" class="t t">CodeGeneration</a>.<a href="../../lang/codegen.cs.html#99c5bb762439f325" class="i method">EscapeSingleQuotedStringContent</a>(<a href="#ff3d179414dbc3ad" class="i property">Name</a>)));
                        <span class="i">Collection</span>&lt;<a href="../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt; <span id="r268 rd" class="r268 r">psObjectCollection</span> = <span class="r267 r">ps</span>.<span class="i">Invoke</span>(<b>new</b> <b>object</b>[] { <a href="#ff3d179414dbc3ad" class="i property">Name</a> }) <b>as</b> <span class="i">Collection</span>&lt;<a href="../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt;;
                        <b>if</b> (<span class="r268 r">psObjectCollection</span> == <b>null</b> || <span class="r268 r">psObjectCollection</span>.<span class="i">Count</span> != 1)
                        {
                            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<b>false</b>, <span class="s">&quot;This should never happen. ps.Invoke always return a Collection&lt;PSObject&gt;&quot;</span>);
                        }
 
                        <span class="i">StringBuilder</span> <span id="r269 rd" class="r269 r">sessionConfigurationData</span> = <b>new</b> <span class="i">StringBuilder</span>();
 
                        <span class="c">// SessionConfigurationData doesn&#39;t exist in InitializationParameters</span>
                        <b>if</b> (<span class="r268 r">psObjectCollection</span>[0] == <b>null</b>)
                        {
                            <span class="c">// if unsetModulePath is false, we set the new sessionConfigurationData to contain the specified module path</span>
                            <b>if</b> (!<span class="r265 r">unsetModulePath</span>)
                            {
                                <span class="r269 r">sessionConfigurationData</span>.<span class="i">Append</span>(<b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>,
                                    <a href="#4221a2a3f4b7719e" class="i field">initParamFormat</a>,
                                    <a href="../fanin/PSSessionConfigurationData.cs.html#a9929ed8e7a283e6" class="t t">PSSessionConfigurationData</a>.<a href="../fanin/PSSessionConfigurationData.cs.html#e473b0c22548cf0a" class="i field">ModulesToImportToken</a>,
                                    <span class="r266 r">modulePathParameter</span>));
                            }
                            <span class="c">// if unsetModulePath is true, we don&#39;t need to do anything because ModulesToImport doesn&#39;t exist</span>
                            <span class="c">// in the original configuration. If it&#39;s a workflow config, it&#39;s not a valid one.</span>
                        }
                        <span class="c">// SessionConfigurationData exists in InitializationParameters</span>
                        <b>else</b>
                        {
                            <a href="../fanin/PSSessionConfigurationData.cs.html#a9929ed8e7a283e6" class="t t">PSSessionConfigurationData</a> <span id="r270 rd" class="r270 r">scd</span> = <a href="../fanin/PSSessionConfigurationData.cs.html#a9929ed8e7a283e6" class="t t">PSSessionConfigurationData</a>.<span class="i">Create</span>(<span class="r268 r">psObjectCollection</span>[0].<span class="i">BaseObject</span>.<span class="i">ToString</span>());
                            <b>string</b> <span id="r271 rd" class="r271 r">privateData</span> = <b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r270 r">scd</span>.<a href="../fanin/PSSessionConfigurationData.cs.html#bb9edd40d6d06bbd" class="i property">PrivateData</a>)
                                                     ? <b>null</b>
                                                     : <span class="r270 r">scd</span>.<a href="../fanin/PSSessionConfigurationData.cs.html#bb9edd40d6d06bbd" class="i property">PrivateData</a>.<span class="i">Replace</span>(<span class="s">&#39;&quot;&#39;</span>, <span class="s">&#39;\&#39;&#39;</span>);
                            <span class="c">// The user tries to unset the module path)</span>
                            <b>if</b> (<span class="r265 r">unsetModulePath</span>)
                            {
                                <span class="c">// ModulesToImport exist in the pssessionConfigurationData</span>
                                <b>if</b> (<span class="r270 r">scd</span>.<a href="../fanin/PSSessionConfigurationData.cs.html#951b2726df7b4965" class="i property">ModulesToImportInternal</a> != <b>null</b> &amp;&amp; <span class="r270 r">scd</span>.<a href="../fanin/PSSessionConfigurationData.cs.html#951b2726df7b4965" class="i property">ModulesToImportInternal</a>.<span class="i">Count</span> != 0)
                                {
                                    <span class="r269 r">sessionConfigurationData</span>.<span class="i">Append</span>(<b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>,
                                        <a href="#4221a2a3f4b7719e" class="i field">initParamFormat</a>,
                                        <a href="../fanin/PSSessionConfigurationData.cs.html#a9929ed8e7a283e6" class="t t">PSSessionConfigurationData</a>.<a href="../fanin/PSSessionConfigurationData.cs.html#e473b0c22548cf0a" class="i field">ModulesToImportToken</a>, <b>string</b>.<span class="i">Empty</span>));
                                    <b>if</b> (!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r271 r">privateData</span>))
                                    {
                                        <span class="r269 r">sessionConfigurationData</span>.<span class="i">Append</span>(<b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>, <a href="#498ff8e11d3f9998" class="i field">privateDataFormat</a>, <span class="r271 r">privateData</span>));
                                    }
                                }
                                <span class="c">// if ModulesToImport doesn&#39;t exist in the pssessionConfigurationData, we don&#39;t need to do anything.</span>
                                <span class="c">// in this case, if the current config is of type workflow, it&#39;s not a valid config.</span>
                            }
                            <b>else</b>
                            {
                                <span class="c">// Replace the old module path</span>
                                <span class="r269 r">sessionConfigurationData</span>.<span class="i">Append</span>(<b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>,
                                    <a href="#4221a2a3f4b7719e" class="i field">initParamFormat</a>,
                                    <a href="../fanin/PSSessionConfigurationData.cs.html#a9929ed8e7a283e6" class="t t">PSSessionConfigurationData</a>.<a href="../fanin/PSSessionConfigurationData.cs.html#e473b0c22548cf0a" class="i field">ModulesToImportToken</a>,
                                    <span class="r266 r">modulePathParameter</span>));
                                <b>if</b> (!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r271 r">privateData</span>))
                                {
                                    <span class="r269 r">sessionConfigurationData</span>.<span class="i">Append</span>(<b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>, <a href="#498ff8e11d3f9998" class="i field">privateDataFormat</a>, <span class="r271 r">privateData</span>));
                                }
                            }
                        }
 
                        <b>if</b> (<span class="r269 r">sessionConfigurationData</span>.<span class="i">Length</span> &gt; 0)
                        {
                            <b>string</b> <span id="r272 rd" class="r272 r">sessionConfigData</span> = <b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>,
                                                                     <a href="#1b015a5247b3f62a" class="i field">SessionConfigDataFormat</a>,
                                                                     <span class="r269 r">sessionConfigurationData</span>);
                            <b>string</b> <span id="r273 rd" class="r273 r">encodedSessionConfigData</span> = <span class="i">SecurityElement</span>.<span class="i">Escape</span>(<span class="r272 r">sessionConfigData</span>);
                            <span class="r262 r">result</span>.<a href="../../MshObject.cs.html#59e9cd1ad57ccd34" class="i property">Properties</a>.<a href="../../MshMemberInfo.cs.html#a9e3a2dc56d98237" class="i method">Add</a>(<b>new</b> <a href="../../MshMemberInfo.cs.html#f4e5bccf8ccb9f2a" class="t constructor">PSNoteProperty</a>(<a href="../fanin/InitialSessionStateProvider.cs.html#88c11924f622f7f5" class="t t">ConfigurationDataFromXML</a>.<a href="../fanin/InitialSessionStateProvider.cs.html#9e1f1c9b78ebd9a5" class="i field">SESSIONCONFIGTOKEN</a>, <span class="r273 r">encodedSessionConfigData</span>));
                        }
                    }
                }
            }
 
            <span class="c">// DISC endpoint</span>
            <b>if</b> (<a href="#7f0833e245fe41bc" class="i property">Path</a> != <b>null</b>)
            {
                <a href="../../DataStoreAdapterProvider.cs.html#dd4e1f2f8e73a1dd" class="t t">ProviderInfo</a> <span id="r274 rd" class="r274 r">provider</span> = <b>null</b>;
                <a href="../../DataStoreAdapter.cs.html#2d16b26a541ba185" class="t t">PSDriveInfo</a> <span id="r275 rd" class="r275 r">drive</span>;
                <b>string</b> <span id="r276 rd" class="r276 r">filePath</span> = <a href="../../CommandBase.cs.html#5078d443148de142" class="i property">SessionState</a>.<a href="../../SessionStatePublic.cs.html#3390cfbbdcffb036" class="i property">Path</a>.<a href="../../PathInterfaces.cs.html#89444ef2b32a4408" class="i method">GetUnresolvedProviderPathFromPSPath</a>(<a href="#7f0833e245fe41bc" class="i property">Path</a>, <b>out</b> <span class="r274 r">provider</span>, <b>out</b> <span class="r275 r">drive</span>);
 
                <b>if</b> (!<span class="r274 r">provider</span>.<a href="../../DataStoreAdapterProvider.cs.html#13e2cce7adaad137" class="i method">NameEquals</a>(<a href="../../CommandBase.cs.html#a41a765d70fc9c9d" class="i property">Context</a>.<a href="../../ExecutionContext.cs.html#733af3e5592e5947" class="i property">ProviderNames</a>.<a href="../../ProviderNames.cs.html#07509539bc35966f" class="i property">FileSystem</a>) || !<span class="r276 r">filePath</span>.<span class="i">EndsWith</span>(<a href="../../SessionStateStrings.cs.html#55ee11e42c7cf459" class="t t">StringLiterals</a>.<a href="../../SessionStateStrings.cs.html#f547328079c2f2df" class="i field">PowerShellDISCFileExtension</a>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
                {
                    <b>string</b> <span id="r277 rd" class="r277 r">message</span> = <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">InvalidPSSessionConfigurationFilePath</span>, <a href="#7f0833e245fe41bc" class="i property">Path</a>);
                    <span class="i">InvalidOperationException</span> <span id="r278 rd" class="r278 r">ioe</span> = <b>new</b> <span class="i">InvalidOperationException</span>(<span class="r277 r">message</span>);
                    <a href="../../ErrorPackage.cs.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r279 rd" class="r279 r">er</span> = <b>new</b> <span class="t">ErrorRecord</span>(<span class="r278 r">ioe</span>, <span class="s">&quot;InvalidPSSessionConfigurationFilePath&quot;</span>,
                        <a href="../../ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../../ErrorPackage.cs.html#846d2b572f2c4820" class="i field">InvalidArgument</a>, <a href="#7f0833e245fe41bc" class="i property">Path</a>);
                    <a href="../../cmdlet.cs.html#e3346d70990a1763" class="i method">ThrowTerminatingError</a>(<span class="r279 r">er</span>);
                }
 
                <span class="i">Guid</span> <span id="r280 rd" class="r280 r">sessionGuid</span> = <span class="i">Guid</span>.<span class="i">Empty</span>;
 
                <span class="c">// Load session GUID from config file</span>
                <b>string</b> <span id="r281 rd" class="r281 r">scriptName</span>;
                <a href="../../ExternalScriptInfo.cs.html#7806ac40f903221c" class="t t">ExternalScriptInfo</a> <span id="r282 rd" class="r282 r">scriptInfo</span> = <a href="../fanin/InitialSessionStateProvider.cs.html#78aacc47ea72f6a8" class="t t">DISCUtils</a>.<a href="../fanin/InitialSessionStateProvider.cs.html#cbbec5f551fd0e0c" class="i method">GetScriptInfoForFile</a>(<a href="#cc2731857df70643" class="k">this</a>.<a href="../../CommandBase.cs.html#a41a765d70fc9c9d" class="i property">Context</a>, <span class="r276 r">filePath</span>, <b>out</b> <span class="r281 r">scriptName</span>);
 
                <span class="i">Hashtable</span> <span id="r283 rd" class="r283 r">configTable</span> = <a href="../fanin/InitialSessionStateProvider.cs.html#78aacc47ea72f6a8" class="t t">DISCUtils</a>.<a href="../fanin/InitialSessionStateProvider.cs.html#165b977f5f1cf798" class="i method">LoadConfigFile</a>(<a href="#cc2731857df70643" class="k">this</a>.<a href="../../CommandBase.cs.html#a41a765d70fc9c9d" class="i property">Context</a>, <span class="r282 r">scriptInfo</span>);
 
                <b>foreach</b> (<b>object</b> <span id="r284 rd" class="r284 r">currentKey</span> <b>in</b> <span class="r283 r">configTable</span>.<span class="i">Keys</span>)
                {
                    <b>if</b> (<span class="r262 r">result</span>.<a href="../../MshObject.cs.html#59e9cd1ad57ccd34" class="i property">Properties</a>[<span class="r284 r">currentKey</span>.<span class="i">ToString</span>()] == <b>null</b>)
                    {
                        <span class="r262 r">result</span>.<a href="../../MshObject.cs.html#59e9cd1ad57ccd34" class="i property">Properties</a>.<a href="../../MshMemberInfo.cs.html#a9e3a2dc56d98237" class="i method">Add</a>(<b>new</b> <span class="t">PSNoteProperty</span>(<span class="r284 r">currentKey</span>.<span class="i">ToString</span>(), <span class="r283 r">configTable</span>[<span class="r284 r">currentKey</span>]));
                    }
                    <b>else</b>
                    {
                        <span class="r262 r">result</span>.<a href="../../MshObject.cs.html#59e9cd1ad57ccd34" class="i property">Properties</a>[<span class="r284 r">currentKey</span>.<span class="i">ToString</span>()].<a href="../../MshMemberInfo.cs.html#cd3a9989baedf3dd" class="i property">Value</a> = <span class="r283 r">configTable</span>[<span class="r284 r">currentKey</span>];
                    }
                }
            }
 
            <b>return</b> <span class="r262 r">result</span>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
    }
 
    <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
    <span class="k preprocess">#</span><span class="k preprocess">region</span> Enable/Disable-PSSessionConfiguration
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Class implementing Enable-PSSessionConfiguration cmdlet.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    [<span class="i">Cmdlet</span>(<a href="../../../utils/Verbs.cs.html#1a8e85c66f6fff18" class="t t">VerbsLifecycle</a>.<a href="../../../utils/Verbs.cs.html#2180c07f8e00f5a7" class="i field">Enable</a>, <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#d19a1042a44001e8" class="t t">RemotingConstants</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#3188dd90ac4b908b" class="i field">PSSessionConfigurationNoun</a>,
        <span class="i">SupportsShouldProcess</span> = <b>true</b>, <span class="i">ConfirmImpact</span> = <a href="../../CommandBase.cs.html#ba94675b57c6d6e9" class="t t">ConfirmImpact</a>.<a href="../../CommandBase.cs.html#f2126d83835863e8" class="i field">Medium</a>, <span class="i">HelpUri</span> = <span class="s">&quot;https://go.microsoft.com/fwlink/?LinkID=2096785&quot;</span>)]
    <b>public sealed class</b> <a id="320cd7da5b3b35ed" href="../../../R/320cd7da5b3b35ed.html" target="n" data-glyph="0,0" class="t t"><span id="e69ac2b564a1d2f9">EnablePSSessionConfigurationCommand</span></a> : <a href="../../../P/30543a6971fed1fc.html#30543a6971fed1fc" class="t t">PSCmdlet</a>
    {
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Private Data
 
        <b>private const string</b> <a id="d91f2c4e1f0e2e21" href="../../../R/d91f2c4e1f0e2e21.html" target="n" data-glyph="10,1" class="i field">setWSManConfigCommand</a> = <span class="s">&quot;Set-WSManQuickConfig&quot;</span>;
        <span class="c">// To Escape { -- {{</span>
        <span class="c">// To Escape } -- }}</span>
        <span class="c">// To Escape &quot; -- &quot;&quot;</span>
        <b>private const string</b> <a id="a94e212d17650df8" href="../../../R/a94e212d17650df8.html" target="n" data-glyph="10,1" class="i field">enablePluginSbFormat</a> = <span class="s">@&quot;
 
function Test-WinRMQuickConfigNeeded
{{
    # see issue #11005 - Function Test-WinRMQuickConfigNeeded needs to be updated:
    # 1) currently this function always returns $True
    # 2) checking for a firewall rule using Get-NetFirewallRule engages WinCompat code and has significant perf impact on Enable-PSRemoting; maybe change to Get-CimInstance -ClassName MSFT_NetFirewallRule
    return $True
 
# Checking the following items
#1. Starting or restarting (if already started) the WinRM service
#2. Setting the WinRM service startup type to Automatic
#3. Creating a listener to accept requests on any IP address
#4. Enabling Windows Firewall inbound rule exceptions for WS-Management traffic (for http only).
 
    $winrmQuickConfigNeeded = $false
 
    # check if WinRM service is running
    if ((Get-Service winrm).Status -ne &#39;Running&#39;){{
        $winrmQuickConfigNeeded = $true
    }}
 
    # check if WinRM service startup is Auto
    elseif ((Get-CimInstance -Query &quot;&quot;Select StartMode From Win32_Service Where Name=&#39;winmgmt&#39;&quot;&quot;).StartMode -ne &#39;Auto&#39;){{
        $winrmQuickConfigNeeded = $true
    }}
 
    # check if a winrm listener is present
    elseif (!(Test-Path WSMan:\localhost\Listener) -or ($null -eq (Get-ChildItem WSMan:\localhost\Listener))){{
        $winrmQuickConfigNeeded = $true
    }}
 
    # check if WinRM firewall is enabled for HTTP
    else{{
        if (Get-Command Get-NetFirewallRule -ErrorAction SilentlyContinue){{
            $winrmFirewall = Get-NetFirewallRule -Name &#39;WINRM-HTTP-In-TCP&#39; -ErrorAction SilentlyContinue
            if (!$winrmFirewall -or $winrmFirewall.Enabled -ne $true){{
                $winrmQuickConfigNeeded = $true
            }}
        }}
        else{{
            $winrmQuickConfigNeeded = $true
        }}
    }}
 
    $winrmQuickConfigNeeded
}}
 
function Enable-PSSessionConfiguration
{{
[CmdletBinding(SupportsShouldProcess=$true, ConfirmImpact=&quot;&quot;Medium&quot;&quot;)]
param(
    [Parameter(Position=0, ValueFromPipeline=$true)]
    [System.String]
    $Name,
 
    [Parameter()]
    [bool]
    $Force,
 
    [Parameter()]
    [string]
    $sddl,
 
    [Parameter()]
    [bool]
    $isSDDLSpecified,
 
    [Parameter()]
    [string]
    $queryForSet,
 
    [Parameter()]
    [string]
    $captionForSet,
 
    [Parameter()]
    [string]
    $queryForQC,
 
    [Parameter()]
    [string]
    $captionForQC,
 
    [Parameter()]
    [string]
    $shouldProcessDescForQC,
 
    [Parameter()]
    [string]
    $setEnabledTarget,
 
    [Parameter()]
    [string]
    $setEnabledAction,
 
    [Parameter()]
    [bool]
    $skipNetworkProfileCheck,
 
    [Parameter()]
    [bool]
    $noServiceRestart
    )
 
    begin
    {{
        $winrmQuickConfigNeeded = Test-WinRMQuickConfigNeeded
 
        if ($winrmQuickConfigNeeded -and ($force -or $pscmdlet.ShouldProcess($shouldProcessDescForQC, $queryForQC, $captionForQC)))
        {{
            # get the status of winrm before Quick Config. if it is already
            # running..restart the service after Quick Config.
            $svc = get-service winrm
            if ($skipNetworkProfileCheck)
            {{
                {0} -force -SkipNetworkProfileCheck
            }}
            else
            {{
                {0} -force
            }}
 
            if ($svc.Status -match &quot;&quot;Running&quot;&quot;)
            {{
               Restart-Service winrm -force -confirm:$false
            }}
        }}
    }} #end of Begin block
 
    process
    {{
       Get-PSSessionConfiguration $name -Force:$Force | ForEach-Object {{
 
          if ($_.Enabled -eq $false -and ($force -or $pscmdlet.ShouldProcess($setEnabledTarget, $setEnabledAction)))
          {{
             Set-Item -WarningAction SilentlyContinue -Path &quot;&quot;WSMan:\localhost\Plugin\$name\Enabled&quot;&quot; -Value $true -confirm:$false
          }}
 
          if (!$isSDDLSpecified)
          {{
             $sddlTemp = $null
             if ($_.psobject.members[&quot;&quot;SecurityDescriptorSddl&quot;&quot;])
             {{
                 $sddlTemp = $_.psobject.members[&quot;&quot;SecurityDescriptorSddl&quot;&quot;].Value
             }}
 
             $securityIdentifierToPurge = $null
             # strip out Disable-Everyone DACL from the SDDL
             if ($sddlTemp)
             {{
                # construct SID for &quot;&quot;EveryOne&quot;&quot;
                [system.security.principal.wellknownsidtype]$evst = &quot;&quot;worldsid&quot;&quot;
                $everyOneSID = new-object system.security.principal.securityidentifier $evst,$null
 
                $sd = new-object system.security.accesscontrol.commonsecuritydescriptor $false,$false,$sddlTemp
                $sd.DiscretionaryAcl | ForEach-Object {{
                    if (($_.acequalifier -eq &quot;&quot;accessdenied&quot;&quot;) -and ($_.securityidentifier -match $everyOneSID))
                    {{
                       $securityIdentifierToPurge = $_.securityidentifier
                    }}
                }}
 
                if ($securityIdentifierToPurge)
                {{
                   $sd.discretionaryacl.purge($securityIdentifierToPurge)
 
                   # if there is no discretionaryacl..add Builtin Administrators and Remote Management Users
                   # to the DACL group as this is the default WSMan behavior
                   if ($sd.discretionaryacl.count -eq 0)
                   {{
                      # Built-in administrators
                      [system.security.principal.wellknownsidtype]$bast = &quot;&quot;BuiltinAdministratorsSid&quot;&quot;
                      $basid = new-object system.security.principal.securityidentifier $bast,$null
                      $sd.DiscretionaryAcl.AddAccess(&#39;Allow&#39;,$basid, 268435456, &#39;none&#39;, &#39;none&#39;)
 
                      # Remote Management Users, Win8+ only
                      if ([System.Environment]::OSVersion.Version -ge &quot;&quot;6.2.0.0&quot;&quot;)
                      {{
                          $rmSidId = new-object system.security.principal.securityidentifier &quot;&quot;{1}&quot;&quot;
                          $sd.DiscretionaryAcl.AddAccess(&#39;Allow&#39;, $rmSidId, 268435456, &#39;none&#39;, &#39;none&#39;)
                      }}
 
                      # Interactive Users
                      $iuSidId = new-object system.security.principal.securityidentifier &quot;&quot;{2}&quot;&quot;
                      $sd.DiscretionaryAcl.AddAccess(&#39;Allow&#39;, $iuSidId, 268435456, &#39;none&#39;, &#39;none&#39;)
                   }}
 
                   $sddl = $sd.GetSddlForm(&quot;&quot;all&quot;&quot;)
                }}
             }} # if ($sddlTemp)
          }} # if (!$isSDDLSpecified)
 
          $qMessage = $queryForSet -f $_.name,$sddl
          if (($sddl -or $isSDDLSpecified) -and ($force -or $pscmdlet.ShouldProcess($qMessage, $captionForSet)))
          {{
              $null = Set-PSSessionConfiguration -Name $_.Name -SecurityDescriptorSddl $sddl -NoServiceRestart -force -WarningAction 0
          }}
       }} #end of Get-PSSessionConfiguration | foreach
    }} # end of Process block
 
    End
    {{
    }}
}}
 
$_ | Enable-PSSessionConfiguration -force $args[0] -sddl $args[1] -isSDDLSpecified $args[2] -queryForSet $args[3] -captionForSet $args[4] -queryForQC $args[5] -captionForQC $args[6] -whatif:$args[7] -confirm:$args[8] -shouldProcessDescForQC $args[9] -setEnabledTarget $args[10] -setEnabledAction $args[11] -skipNetworkProfileCheck $args[12] -noServiceRestart $args[13]
&quot;</span>;
 
        <b>private static readonly</b> <a href="../../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="t t">ScriptBlock</a> <a id="e17ff5d182ae7877" href="../../../R/e17ff5d182ae7877.html" target="n" data-glyph="46,1" class="i field">s_enablePluginSb</a>;
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Constructors
 
        <b>static</b> <a id="4a155d58f037820a" href="../../../R/../../0000000000.html" target="n" data-glyph="76,1" class="t method">EnablePSSessionConfigurationCommand</a>()
        {
            <b>string</b> <span id="r285 rd" class="r285 r">enablePluginScript</span> = <b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>,
                <a href="#a94e212d17650df8" class="i field">enablePluginSbFormat</a>, <a href="#d91f2c4e1f0e2e21" class="i field">setWSManConfigCommand</a>, <a href="#fc12f22923e252d9" class="t t">PSSessionConfigurationCommandBase</a>.<a href="#9d3d012f73c36bca" class="i field">RemoteManagementUsersSID</a>, <a href="#fc12f22923e252d9" class="t t">PSSessionConfigurationCommandBase</a>.<a href="#3040a1427951767d" class="i field">InteractiveUsersSID</a>);
 
            <span class="c">// compile the script block statically and reuse the same instance</span>
            <span class="c">// everytime the command is run..This will save on parsing time.</span>
            <a href="#e17ff5d182ae7877" class="i field">s_enablePluginSb</a> = <a href="../../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="t t">ScriptBlock</a>.<a href="../../lang/scriptblock.cs.html#adfac0fa7bf5725f" class="i method">Create</a>(<span class="r285 r">enablePluginScript</span>);
            <a href="#e17ff5d182ae7877" class="i field">s_enablePluginSb</a>.<a href="../../lang/scriptblock.cs.html#5e76a9fb0d1a7f12" class="i property">LanguageMode</a> = <a href="../../SessionStatePublic.cs.html#450052824aba2e3f" class="t t">PSLanguageMode</a>.<a href="../../SessionStatePublic.cs.html#eec721eb8c02f156" class="i field">FullLanguage</a>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Parameters
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Configurations to Enable.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>(<a href="../../Attributes.cs.html#19ccfeb1cdbdb967" class="i property">Position</a> = 0, <a href="../../Attributes.cs.html#4afbf5921ff6e967" class="i property">ValueFromPipeline</a> = <b>true</b>, <a href="../../Attributes.cs.html#aded474eaec9cde8" class="i property">ValueFromPipelineByPropertyName</a> = <b>true</b>)]
        [<span class="i">ValidateNotNullOrEmpty</span>]
        <b>public string</b>[] <a id="a790ec8fcd4762af" href="../../../R/a790ec8fcd4762af.html" target="n" data-glyph="102,1" class="i property">Name</a> { <b>get</b>; <b>set</b>; }
 
        <b>private readonly</b> <span class="i">Collection</span>&lt;<b>string</b>&gt; <a id="5a86e41e37bf80b5" href="../../../R/5a86e41e37bf80b5.html" target="n" data-glyph="46,1" class="i field">_shellsToEnable</a> = <b>new</b> <span class="i">Collection</span>&lt;<b>string</b>&gt;();
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Property that sets force parameter. This will allow</span>
        <span class="c">///</span><span class="c"> configuring the WinRM and enabling the session configurations</span>
        <span class="c">///</span><span class="c"> without prompting the user.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>()]
        <b>public</b> <a href="../../MshCmdlet.cs.html#8260026027378f6c" class="t t">SwitchParameter</a> <a id="f7c08dc5b1a4f02c" href="../../../R/../../0000000000.html" target="n" data-glyph="102,1" class="i property">Force</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#811e06c93d0125ce" class="i field">_force</a>;
            }
 
            <b>set</b>
            {
                <a href="#811e06c93d0125ce" class="i field">_force</a> = <b>value</b>;
            }
        }
 
        <b>private bool</b> <a id="811e06c93d0125ce" href="../../../R/811e06c93d0125ce.html" target="n" data-glyph="46,1" class="i field">_force</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This enables the user to specify an SDDL for whom the session</span>
        <span class="c">///</span><span class="c"> configuration is enabled.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>()]
        <b>public string</b> <a id="278dd30f624fa303" href="../../../R/../../0000000000.html" target="n" data-glyph="102,1" class="i property">SecurityDescriptorSddl</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#c454ba3bd1176e61" class="i field">sddl</a>;
            }
 
            <b>set</b>
            {
                <b>if</b> (!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<b>value</b>))
                {
                    <span class="c">// this will validate if the sddl is valid.</span>
                    <span class="i">CommonSecurityDescriptor</span> <span id="r286 rd" class="r286 r">c</span> = <b>new</b> <span class="i">CommonSecurityDescriptor</span>(<b>false</b>, <b>false</b>, <b>value</b>);
                    <span class="c">// this will never be the case..as constructor either constructs or throws.</span>
                    <span class="c">// this is used here to avoid FxCop violation.</span>
                    <b>if</b> (<span class="r286 r">c</span> == <b>null</b>)
                    {
                        <b>throw</b> <b>new</b> <span class="i">NotSupportedException</span>();
                    }
                }
 
                <a href="#c454ba3bd1176e61" class="i field">sddl</a> = <b>value</b>;
                <a href="#2bb0d6c748da4b48" class="i field">isSddlSpecified</a> = <b>true</b>;
            }
        }
 
        <b>internal string</b> <a id="c454ba3bd1176e61" href="../../../R/c454ba3bd1176e61.html" target="n" data-glyph="44,1" class="i field">sddl</a>;
        <b>internal bool</b> <a id="2bb0d6c748da4b48" href="../../../R/2bb0d6c748da4b48.html" target="n" data-glyph="44,1" class="i field">isSddlSpecified</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Property that will allow configuring WinRM with Public</span>
        <span class="c">///</span><span class="c"> profile exception enabled.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>()]
        <b>public</b> <a href="../../MshCmdlet.cs.html#8260026027378f6c" class="t t">SwitchParameter</a> <a id="baabc5bf55be6c88" href="../../../R/../../0000000000.html" target="n" data-glyph="102,1" class="i property">SkipNetworkProfileCheck</a>
        {
            <b>get</b> { <b>return</b> <a href="#2e51f779ff3762bd" class="i field">_skipNetworkProfileCheck</a>; }
 
            <b>set</b> { <a href="#2e51f779ff3762bd" class="i field">_skipNetworkProfileCheck</a> = <b>value</b>; }
        }
 
        <b>private bool</b> <a id="2e51f779ff3762bd" href="../../../R/2e51f779ff3762bd.html" target="n" data-glyph="46,1" class="i field">_skipNetworkProfileCheck</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If true, then the cmdlet will not attempt to restart</span>
        <span class="c">///</span><span class="c"> WinRM service after completion. Typically WinRM service</span>
        <span class="c">///</span><span class="c"> needs to be restarted for changes to take place.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>()]
        <b>public</b> <a href="../../MshCmdlet.cs.html#8260026027378f6c" class="t t">SwitchParameter</a> <a id="b780a097d0861a42" href="../../../R/../../0000000000.html" target="n" data-glyph="102,1" class="i property">NoServiceRestart</a>
        {
            <b>get</b> { <b>return</b> <a href="#80dc5799e6b2df17" class="i field">_noRestart</a>; }
 
            <b>set</b> { <a href="#80dc5799e6b2df17" class="i field">_noRestart</a> = <b>value</b>; }
        }
 
        <b>private bool</b> <a id="80dc5799e6b2df17" href="../../../R/80dc5799e6b2df17.html" target="n" data-glyph="46,1" class="i field">_noRestart</a>;
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Cmdlet Overrides
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">InvalidOperationException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> 1. Either both &quot;AssemblyName&quot; and &quot;ConfigurationTypeName&quot; must be specified</span>
        <span class="c">///</span><span class="c"> or both must not be specified.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>protected override void</b> <a id="9f69aa7942f7705e" href="../../../R/9f69aa7942f7705e.html" target="n" data-glyph="75,1" class="i method">BeginProcessing</a>()
        {
            <span class="c">// check if we have compatible WSMan</span>
            <a href="remotingcommandutil.cs.html#4c008a65630ba320" class="t t">RemotingCommandUtil</a>.<a href="remotingcommandutil.cs.html#668e049b2f134726" class="i method">CheckRemotingCmdletPrerequisites</a>();
            <a href="#2111ec231989f662" class="t t">PSSessionConfigurationCommandUtilities</a>.<a href="#e6567bb211cb1a98" class="i method">ThrowIfNotAdministrator</a>();
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>protected override void</b> <a id="9ad3b1e1103b9385" href="../../../R/9ad3b1e1103b9385.html" target="n" data-glyph="75,1" class="i method">ProcessRecord</a>()
        {
            <b>if</b> (<a href="#a790ec8fcd4762af" class="i property">Name</a> != <b>null</b>)
            {
                <b>foreach</b> (<b>string</b> <span id="r287 rd" class="r287 r">shell</span> <b>in</b> <a href="#a790ec8fcd4762af" class="i property">Name</a>)
                {
                    <a href="#5a86e41e37bf80b5" class="i field">_shellsToEnable</a>.<span class="i">Add</span>(<span class="r287 r">shell</span>);
                }
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>protected override void</b> <a id="170da1c1da62547b" href="../../../R/170da1c1da62547b.html" target="n" data-glyph="75,1" class="i method">EndProcessing</a>()
        {
            <span class="c">// if user did not specify any shell, act on the default shell.</span>
            <b>if</b> (<a href="#5a86e41e37bf80b5" class="i field">_shellsToEnable</a>.<span class="i">Count</span> == 0)
            {
                <a href="#5a86e41e37bf80b5" class="i field">_shellsToEnable</a>.<span class="i">Add</span>(<a href="#2111ec231989f662" class="t t">PSSessionConfigurationCommandUtilities</a>.<a href="#5feea7253cd275c1" class="i method">GetWinrmPluginShellName</a>());
            }
 
            <a href="../../cmdlet.cs.html#377660744c64cd7e" class="i method">WriteVerbose</a>(<a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">EcsScriptMessageV</span>, <a href="#a94e212d17650df8" class="i field">enablePluginSbFormat</a>));
 
            <span class="c">// gather -WhatIf, -Confirm parameter data and pass it to the script block</span>
            <b>bool</b> <span id="r288 rd" class="r288 r">whatIf</span> = <b>false</b>;
            <span class="c">// confirm is always true to start with</span>
            <b>bool</b> <span id="r289 rd" class="r289 r">confirm</span> = <b>true</b>;
            <a href="#2111ec231989f662" class="t t">PSSessionConfigurationCommandUtilities</a>.<a href="#62fe0a5dea8c58db" class="i method">CollectShouldProcessParameters</a>(<a href="#320cd7da5b3b35ed" class="k">this</a>, <b>out</b> <span class="r288 r">whatIf</span>, <b>out</b> <span class="r289 r">confirm</span>);
 
            <b>string</b> <span id="r290 rd" class="r290 r">qcCaptionMessage</span> = <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">EcsWSManQCCaption</span>);
            <b>string</b> <span id="r291 rd" class="r291 r">qcQueryMessage</span> = <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">EcsWSManQCQuery</span>, <a href="#d91f2c4e1f0e2e21" class="i field">setWSManConfigCommand</a>);
            <b>string</b> <span id="r292 rd" class="r292 r">qcShouldProcessDesc</span> = <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">EcsWSManShouldProcessDesc</span>, <a href="#d91f2c4e1f0e2e21" class="i field">setWSManConfigCommand</a>);
            <b>string</b> <span id="r293 rd" class="r293 r">setCaptionMessage</span> = <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">CSShouldProcessAction</span>,
                <span class="s">&quot;Set-PSSessionConfiguration&quot;</span>);
            <b>string</b> <span id="r294 rd" class="r294 r">setQueryMessage</span> = <span class="i">RemotingErrorIdStrings</span>.<span class="i">EcsShouldProcessTarget</span>;
            <b>string</b> <span id="r295 rd" class="r295 r">setEnabledAction</span> = <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">CSShouldProcessAction</span>, <span class="s">&quot;Set-Item&quot;</span>);
            <b>string</b> <span id="r296 rd" class="r296 r">setEnabledTarget</span> = <span class="i">RemotingErrorIdStrings</span>.<span class="i">SetEnabledTrueTarget</span>;
 
            <a href="#e17ff5d182ae7877" class="i field">s_enablePluginSb</a>.<span class="i">InvokeUsingCmdlet</span>(
                <span class="i">contextCmdlet</span>: <a href="#320cd7da5b3b35ed" class="k">this</a>,
                <span class="i">useLocalScope</span>: <b>true</b>,
                <span class="i">errorHandlingBehavior</span>: <a href="../../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="t t">ScriptBlock</a>.<a href="../../lang/scriptblock.cs.html#10c045824f712272" class="t t">ErrorHandlingBehavior</a>.<a href="../../lang/scriptblock.cs.html#5e78734ffe1c6ed3" class="i field">WriteToCurrentErrorPipe</a>,
                <span class="i">dollarUnder</span>: <a href="#5a86e41e37bf80b5" class="i field">_shellsToEnable</a>,
                <span class="i">input</span>: <span class="i">Array</span>.<span class="i">Empty</span>&lt;<b>object</b>&gt;(),
                <span class="i">scriptThis</span>: <a href="../../AutomationNull.cs.html#681fbea4c40e4af1" class="t t">AutomationNull</a>.<a href="../../AutomationNull.cs.html#1cf7e193da582896" class="i property">Value</a>,
                <span class="i">args</span>: <b>new</b> <b>object</b>[] {
                                               <a href="#811e06c93d0125ce" class="i field">_force</a>,
                                               <a href="#c454ba3bd1176e61" class="i field">sddl</a>,
                                               <a href="#2bb0d6c748da4b48" class="i field">isSddlSpecified</a>,
                                               <span class="r294 r">setQueryMessage</span>,
                                               <span class="r293 r">setCaptionMessage</span>,
                                               <span class="r291 r">qcQueryMessage</span>,
                                               <span class="r290 r">qcCaptionMessage</span>,
                                               <span class="r288 r">whatIf</span>,
                                               <span class="r289 r">confirm</span>,
                                               <span class="r292 r">qcShouldProcessDesc</span>,
                                               <span class="r296 r">setEnabledTarget</span>,
                                               <span class="r295 r">setEnabledAction</span>,
                                               <a href="#2e51f779ff3762bd" class="i field">_skipNetworkProfileCheck</a>,
                                               <a href="#80dc5799e6b2df17" class="i field">_noRestart</a>});
 
            <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Tracing</span>.<a href="../../../P/5b1d077d1aa35b55.html#5b1d077d1aa35b55" class="t t">Tracer</a> <span id="r297 rd" class="r297 r">tracer</span> = <b>new</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Tracing</span>.<a href="../../../utils/tracing/TracingGen.cs.html#3e4070d535f42333" class="t constructor">Tracer</a>();
 
            <span class="i">StringBuilder</span> <span id="r298 rd" class="r298 r">sb</span> = <b>new</b> <span class="i">StringBuilder</span>();
            <b>foreach</b> (<b>string</b> <span id="r299 rd" class="r299 r">endPointName</span> <b>in</b> <a href="#a790ec8fcd4762af" class="i property">Name</a> ?? <span class="i">Array</span>.<span class="i">Empty</span>&lt;<b>string</b>&gt;())
            {
                <span class="r298 r">sb</span>.<span class="i">Append</span>(<span class="r299 r">endPointName</span>);
                <span class="r298 r">sb</span>.<span class="i">Append</span>(<span class="s">&quot;, &quot;</span>);
            }
 
            <b>if</b> (<span class="r298 r">sb</span>.<span class="i">Length</span> &gt; 0)
            {
                <span class="r298 r">sb</span>.<span class="i">Remove</span>(<span class="r298 r">sb</span>.<span class="i">Length</span> - 2, 2);
            }
 
            <span class="r297 r">tracer</span>.<span class="i">EndpointEnabled</span>(<span class="r298 r">sb</span>.<span class="i">ToString</span>(), <span class="i">WindowsIdentity</span>.<span class="i">GetCurrent</span>().<span class="i">Name</span>);
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
    }
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    [<span class="i">Cmdlet</span>(<a href="../../../utils/Verbs.cs.html#1a8e85c66f6fff18" class="t t">VerbsLifecycle</a>.<a href="../../../utils/Verbs.cs.html#734c65c806b352fc" class="i field">Disable</a>, <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#d19a1042a44001e8" class="t t">RemotingConstants</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#3188dd90ac4b908b" class="i field">PSSessionConfigurationNoun</a>,
        <span class="i">SupportsShouldProcess</span> = <b>true</b>, <span class="i">ConfirmImpact</span> = <a href="../../CommandBase.cs.html#ba94675b57c6d6e9" class="t t">ConfirmImpact</a>.<a href="../../CommandBase.cs.html#9bb946a0731a8a9e" class="i field">Low</a>, <span class="i">HelpUri</span> = <span class="s">&quot;https://go.microsoft.com/fwlink/?LinkID=2096692&quot;</span>)]
    <b>public sealed class</b> <a id="44a32a91d25b6f39" href="../../../R/44a32a91d25b6f39.html" target="n" data-glyph="0,0" class="t t"><span id="cff12c5ab2106c3f">DisablePSSessionConfigurationCommand</span></a> : <a href="../../../P/30543a6971fed1fc.html#30543a6971fed1fc" class="t t">PSCmdlet</a>
    {
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Private Data
 
        <span class="c">// To Escape { -- {{</span>
        <span class="c">// To Escape } -- }}</span>
        <span class="c">// To Escape &quot; -- &quot;&quot;</span>
        <b>private const string</b> <a id="bb0d03a2aa3a0548" href="../../../R/bb0d03a2aa3a0548.html" target="n" data-glyph="10,1" class="i field">disablePluginSbFormat</a> = <span class="s">@&quot;
function Disable-PSSessionConfiguration
{{
[CmdletBinding(SupportsShouldProcess=$true, ConfirmImpact=&quot;&quot;Low&quot;&quot;)]
param(
    [Parameter(Position=0, ValueFromPipeline=$true, ValueFromPipelineByPropertyName=$true)]
    [System.String]
    $Name,
 
    [Parameter()]
    [bool]
    $Force,
 
    [Parameter()]
    [string]
    $restartWinRMMessage,
 
    [Parameter()]
    [string]
    $setEnabledTarget,
 
    [Parameter()]
    [string]
    $setEnabledAction,
 
    [Parameter()]
    [bool]
    $noServiceRestart
)
 
    begin
    {{
        if ($force -or $pscmdlet.ShouldProcess($restartWinRMMessage))
        {{
            $svc = get-service winrm
            if ($svc.Status -match &quot;&quot;Stopped&quot;&quot;)
            {{
               Restart-Service winrm -force -confirm:$false
            }}
        }}
    }} #end of Begin block
 
    process
    {{
       Get-PSSessionConfiguration $name -Force:$Force | ForEach-Object {{
 
           if ($_.Enabled -and ($force -or $pscmdlet.ShouldProcess($setEnabledTarget, $setEnabledAction)))
           {{
                Set-Item -WarningAction SilentlyContinue -Path &quot;&quot;WSMan:\localhost\Plugin\$name\Enabled&quot;&quot; -Value $false -Force -Confirm:$false
           }}
       }} # end of foreach block
    }} #end of process block
 
    # no longer necessary to restart the winrm to apply the config change
    End
    {{
    }}
}}
 
$_ | Disable-PSSessionConfiguration -force $args[0] -whatif:$args[1] -confirm:$args[2] -restartWinRMMessage $args[3] -setEnabledTarget $args[4] -setEnabledAction $args[5] -noServiceRestart $args[6]
&quot;</span>;
 
        <b>private static readonly</b> <a href="../../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="t t">ScriptBlock</a> <a id="93ffa03149fee578" href="../../../R/93ffa03149fee578.html" target="n" data-glyph="46,1" class="i field">s_disablePluginSb</a>;
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Constructors
 
        <b>static</b> <a id="bd68945580223397" href="../../../R/../../0000000000.html" target="n" data-glyph="76,1" class="t method">DisablePSSessionConfigurationCommand</a>()
        {
            <b>string</b> <span id="r300 rd" class="r300 r">disablePluginScript</span> = <b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>,
                <a href="#bb0d03a2aa3a0548" class="i field">disablePluginSbFormat</a>);
 
            <span class="c">// compile the script block statically and reuse the same instance</span>
            <span class="c">// everytime the command is run..This will save on parsing time.</span>
            <a href="#93ffa03149fee578" class="i field">s_disablePluginSb</a> = <a href="../../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="t t">ScriptBlock</a>.<a href="../../lang/scriptblock.cs.html#adfac0fa7bf5725f" class="i method">Create</a>(<span class="r300 r">disablePluginScript</span>);
            <a href="#93ffa03149fee578" class="i field">s_disablePluginSb</a>.<a href="../../lang/scriptblock.cs.html#5e76a9fb0d1a7f12" class="i property">LanguageMode</a> = <a href="../../SessionStatePublic.cs.html#450052824aba2e3f" class="t t">PSLanguageMode</a>.<a href="../../SessionStatePublic.cs.html#eec721eb8c02f156" class="i field">FullLanguage</a>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Parameters
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Configurations to Enable.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>(<a href="../../Attributes.cs.html#19ccfeb1cdbdb967" class="i property">Position</a> = 0, <a href="../../Attributes.cs.html#4afbf5921ff6e967" class="i property">ValueFromPipeline</a> = <b>true</b>, <a href="../../Attributes.cs.html#aded474eaec9cde8" class="i property">ValueFromPipelineByPropertyName</a> = <b>true</b>)]
        [<span class="i">ValidateNotNullOrEmpty</span>]
        <b>public string</b>[] <a id="7d33231579dd0028" href="../../../R/7d33231579dd0028.html" target="n" data-glyph="102,1" class="i property">Name</a> { <b>get</b>; <b>set</b>; }
 
        <b>private readonly</b> <span class="i">Collection</span>&lt;<b>string</b>&gt; <a id="3aed7854d14b3bb3" href="../../../R/3aed7854d14b3bb3.html" target="n" data-glyph="46,1" class="i field">_shellsToDisable</a> = <b>new</b> <span class="i">Collection</span>&lt;<b>string</b>&gt;();
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Property that sets force parameter. This will allow</span>
        <span class="c">///</span><span class="c"> configuring the WinRM and enabling the session configurations</span>
        <span class="c">///</span><span class="c"> without prompting the user.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>()]
        <b>public</b> <a href="../../MshCmdlet.cs.html#8260026027378f6c" class="t t">SwitchParameter</a> <a id="f6a9f0ae986d4a71" href="../../../R/../../0000000000.html" target="n" data-glyph="102,1" class="i property">Force</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#e5311d1a0215d66c" class="i field">_force</a>;
            }
 
            <b>set</b>
            {
                <a href="#e5311d1a0215d66c" class="i field">_force</a> = <b>value</b>;
            }
        }
 
        <b>private bool</b> <a id="e5311d1a0215d66c" href="../../../R/e5311d1a0215d66c.html" target="n" data-glyph="46,1" class="i field">_force</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If true, then the cmdlet will not attempt to restart</span>
        <span class="c">///</span><span class="c"> WinRM service after completion. Typically WinRM service</span>
        <span class="c">///</span><span class="c"> needs to be restarted for changes to take place.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>()]
        <b>public</b> <a href="../../MshCmdlet.cs.html#8260026027378f6c" class="t t">SwitchParameter</a> <a id="4170a3cd6bf9673f" href="../../../R/../../0000000000.html" target="n" data-glyph="102,1" class="i property">NoServiceRestart</a>
        {
            <b>get</b> { <b>return</b> <a href="#b8f8890f9ab10fca" class="i field">_noRestart</a>; }
 
            <b>set</b> { <a href="#b8f8890f9ab10fca" class="i field">_noRestart</a> = <b>value</b>; }
        }
 
        <b>private bool</b> <a id="b8f8890f9ab10fca" href="../../../R/b8f8890f9ab10fca.html" target="n" data-glyph="46,1" class="i field">_noRestart</a>;
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Cmdlet Overrides
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">InvalidOperationException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> 1. Either both &quot;AssemblyName&quot; and &quot;ConfigurationTypeName&quot; must be specified</span>
        <span class="c">///</span><span class="c"> or both must not be specified.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>protected override void</b> <a id="8505a19f22ab810e" href="../../../R/8505a19f22ab810e.html" target="n" data-glyph="75,1" class="i method">BeginProcessing</a>()
        {
            <span class="c">// check if we have compatible WSMan</span>
            <a href="remotingcommandutil.cs.html#4c008a65630ba320" class="t t">RemotingCommandUtil</a>.<a href="remotingcommandutil.cs.html#668e049b2f134726" class="i method">CheckRemotingCmdletPrerequisites</a>();
            <a href="#2111ec231989f662" class="t t">PSSessionConfigurationCommandUtilities</a>.<a href="#e6567bb211cb1a98" class="i method">ThrowIfNotAdministrator</a>();
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>protected override void</b> <a id="bafba71a15c40b03" href="../../../R/bafba71a15c40b03.html" target="n" data-glyph="75,1" class="i method">ProcessRecord</a>()
        {
            <b>if</b> (<a href="#7d33231579dd0028" class="i property">Name</a> != <b>null</b>)
            {
                <b>foreach</b> (<b>string</b> <span id="r301 rd" class="r301 r">shell</span> <b>in</b> <a href="#7d33231579dd0028" class="i property">Name</a>)
                {
                    <a href="#3aed7854d14b3bb3" class="i field">_shellsToDisable</a>.<span class="i">Add</span>(<span class="r301 r">shell</span>);
                }
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>protected override void</b> <a id="f310fe9536e4cfb8" href="../../../R/f310fe9536e4cfb8.html" target="n" data-glyph="75,1" class="i method">EndProcessing</a>()
        {
            <span class="c">// if user did not specify any shell, act on the default shell.</span>
            <b>if</b> (<a href="#3aed7854d14b3bb3" class="i field">_shellsToDisable</a>.<span class="i">Count</span> == 0)
            {
                <a href="#3aed7854d14b3bb3" class="i field">_shellsToDisable</a>.<span class="i">Add</span>(<a href="#2111ec231989f662" class="t t">PSSessionConfigurationCommandUtilities</a>.<a href="#5feea7253cd275c1" class="i method">GetWinrmPluginShellName</a>());
            }
 
            <span class="c">// WriteWarning(StringUtil.Format(RemotingErrorIdStrings.DcsWarningMessage));</span>
            <a href="../../cmdlet.cs.html#377660744c64cd7e" class="i method">WriteVerbose</a>(<a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">EcsScriptMessageV</span>, <a href="#bb0d03a2aa3a0548" class="i field">disablePluginSbFormat</a>));
 
            <span class="c">// gather -WhatIf, -Confirm parameter data and pass it to the script block</span>
            <b>bool</b> <span id="r302 rd" class="r302 r">whatIf</span> = <b>false</b>;
            <span class="c">// confirm is always true to start with</span>
            <b>bool</b> <span id="r303 rd" class="r303 r">confirm</span> = <b>true</b>;
            <a href="#2111ec231989f662" class="t t">PSSessionConfigurationCommandUtilities</a>.<a href="#62fe0a5dea8c58db" class="i method">CollectShouldProcessParameters</a>(<a href="#44a32a91d25b6f39" class="k">this</a>, <b>out</b> <span class="r302 r">whatIf</span>, <b>out</b> <span class="r303 r">confirm</span>);
 
            <b>string</b> <span id="r304 rd" class="r304 r">restartWinRMMessage</span> = <span class="i">RemotingErrorIdStrings</span>.<span class="i">RestartWinRMMessage</span>;
            <b>string</b> <span id="r305 rd" class="r305 r">setEnabledTarget</span> = <span class="i">RemotingErrorIdStrings</span>.<span class="i">SetEnabledFalseTarget</span>;
            <b>string</b> <span id="r306 rd" class="r306 r">setEnabledAction</span> = <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">CSShouldProcessAction</span>, <span class="s">&quot;Set-Item&quot;</span>);
 
            <a href="#93ffa03149fee578" class="i field">s_disablePluginSb</a>.<span class="i">InvokeUsingCmdlet</span>(
                <span class="i">contextCmdlet</span>: <a href="#44a32a91d25b6f39" class="k">this</a>,
                <span class="i">useLocalScope</span>: <b>true</b>,
                <span class="i">errorHandlingBehavior</span>: <a href="../../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="t t">ScriptBlock</a>.<a href="../../lang/scriptblock.cs.html#10c045824f712272" class="t t">ErrorHandlingBehavior</a>.<a href="../../lang/scriptblock.cs.html#5e78734ffe1c6ed3" class="i field">WriteToCurrentErrorPipe</a>,
                <span class="i">dollarUnder</span>: <a href="#3aed7854d14b3bb3" class="i field">_shellsToDisable</a>,
                <span class="i">input</span>: <span class="i">Array</span>.<span class="i">Empty</span>&lt;<b>object</b>&gt;(),
                <span class="i">scriptThis</span>: <a href="../../AutomationNull.cs.html#681fbea4c40e4af1" class="t t">AutomationNull</a>.<a href="../../AutomationNull.cs.html#1cf7e193da582896" class="i property">Value</a>,
                <span class="i">args</span>: <b>new</b> <b>object</b>[] {
                                               <a href="#e5311d1a0215d66c" class="i field">_force</a>,
                                               <span class="r302 r">whatIf</span>,
                                               <span class="r303 r">confirm</span>,
                                               <span class="r304 r">restartWinRMMessage</span>,
                                               <span class="r305 r">setEnabledTarget</span>,
                                               <span class="r306 r">setEnabledAction</span>,
                                               <a href="#b8f8890f9ab10fca" class="i field">_noRestart</a>});
 
            <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Tracing</span>.<a href="../../../P/5b1d077d1aa35b55.html#5b1d077d1aa35b55" class="t t">Tracer</a> <span id="r307 rd" class="r307 r">tracer</span> = <b>new</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Tracing</span>.<a href="../../../utils/tracing/TracingGen.cs.html#3e4070d535f42333" class="t constructor">Tracer</a>();
 
            <span class="i">StringBuilder</span> <span id="r308 rd" class="r308 r">sb</span> = <b>new</b> <span class="i">StringBuilder</span>();
            <b>foreach</b> (<b>string</b> <span id="r309 rd" class="r309 r">endPointName</span> <b>in</b> <a href="#7d33231579dd0028" class="i property">Name</a> ?? <span class="i">Array</span>.<span class="i">Empty</span>&lt;<b>string</b>&gt;())
            {
                <span class="r308 r">sb</span>.<span class="i">Append</span>(<span class="r309 r">endPointName</span>);
                <span class="r308 r">sb</span>.<span class="i">Append</span>(<span class="s">&quot;, &quot;</span>);
            }
 
            <b>if</b> (<span class="r308 r">sb</span>.<span class="i">Length</span> &gt; 0)
            {
                <span class="r308 r">sb</span>.<span class="i">Remove</span>(<span class="r308 r">sb</span>.<span class="i">Length</span> - 2, 2);
            }
 
            <span class="r307 r">tracer</span>.<span class="i">EndpointDisabled</span>(<span class="r308 r">sb</span>.<span class="i">ToString</span>(), <span class="i">WindowsIdentity</span>.<span class="i">GetCurrent</span>().<span class="i">Name</span>);
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
    }
 
    <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
    <span class="k preprocess">#</span><span class="k preprocess">region</span> Enable-PSRemoting
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    [<span class="i">Cmdlet</span>(<a href="../../../utils/Verbs.cs.html#1a8e85c66f6fff18" class="t t">VerbsLifecycle</a>.<a href="../../../utils/Verbs.cs.html#2180c07f8e00f5a7" class="i field">Enable</a>, <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#d19a1042a44001e8" class="t t">RemotingConstants</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#ed7ccaab0f1439c0" class="i field">PSRemotingNoun</a>,
        <span class="i">SupportsShouldProcess</span> = <b>true</b>, <span class="i">ConfirmImpact</span> = <a href="../../CommandBase.cs.html#ba94675b57c6d6e9" class="t t">ConfirmImpact</a>.<a href="../../CommandBase.cs.html#f2126d83835863e8" class="i field">Medium</a>, <span class="i">HelpUri</span> = <span class="s">&quot;https://go.microsoft.com/fwlink/?LinkID=2096577&quot;</span>)]
    <b>public sealed class</b> <a id="5ee20feca58bd195" href="../../../R/5ee20feca58bd195.html" target="n" data-glyph="0,0" class="t t"><span id="983b340ced1f7bd1">EnablePSRemotingCommand</span></a> : <a href="../../../P/30543a6971fed1fc.html#30543a6971fed1fc" class="t t">PSCmdlet</a>
    {
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Private Data
 
        <span class="c">// To Escape { -- {{</span>
        <span class="c">// To Escape } -- }}</span>
        <span class="c">// To Escape &quot; -- &quot;&quot;</span>
 
        <span class="c">// TODO: CLR4: Remove the logic for setting the MaxMemoryPerShellMB to 200 MB once IPMO-&gt;Get-Command-&gt;Get-Help memory usage issue is fixed.</span>
        <b>private const string</b> <a id="faab737febe5eb36" href="../../../R/faab737febe5eb36.html" target="n" data-glyph="10,1" class="i field">enableRemotingSbFormat</a> = <span class="s">@&quot;
Set-StrictMode -Version Latest
 
function New-PluginConfigFile
{{
[CmdletBinding(SupportsShouldProcess=$true, ConfirmImpact=&quot;&quot;Medium&quot;&quot;)]
param(
    [Parameter()] [string] $pluginInstallPath
)
    $pluginConfigFile = Join-Path $pluginInstallPath &quot;&quot;RemotePowerShellConfig.txt&quot;&quot;
 
    # This always overwrites the file with a new version of it (if it already exists)
    Set-Content -Path $pluginConfigFile -Value &quot;&quot;PSHOMEDIR=$PSHOME&quot;&quot; -ErrorAction Stop
    Add-Content -Path $pluginConfigFile -Value &quot;&quot;CORECLRDIR=$PSHOME&quot;&quot; -ErrorAction Stop
}}
 
function Copy-PluginToEndpoint
{{
param(
    [Parameter()] [string] $endpointDir
)
    $resolvedPluginInstallPath = &quot;&quot;&quot;&quot;
    $pluginInstallPath = Join-Path ([System.Environment]::GetFolderPath([System.Environment+SpecialFolder]::Windows) + &quot;&quot;\System32\PowerShell&quot;&quot;) $endpointDir
    if (!(Test-Path $pluginInstallPath))
    {{
        $resolvedPluginInstallPath = New-Item -Type Directory -Path $pluginInstallPath
    }}
    else
    {{
        $resolvedPluginInstallPath = Resolve-Path $pluginInstallPath
    }}
 
    if (!(Test-Path $resolvedPluginInstallPath\{4}))
    {{
        Copy-Item -Path $PSHOME\{4} -Destination $resolvedPluginInstallPath -Force -ErrorAction Stop
        if (!(Test-Path $resolvedPluginInstallPath\{4}))
        {{
            Write-Error ($errorMsgUnableToInstallPlugin -f &quot;&quot;{4}&quot;&quot;, $resolvedPluginInstallPath)
            return $null
        }}
    }}
 
    return $resolvedPluginInstallPath
}}
 
function Register-Endpoint
{{
param(
    [Parameter()] [string] $configurationName
)
    #
    # Section 1:
    # Move pwrshplugin.dll from $PSHOME to the endpoint directory
    #
    # The plugin directory pattern for endpoint configuration is:
    # &#39;$env:WINDIR\System32\PowerShell\&#39; + powershell_version,
    # so we call Copy-PluginToEndpoint function only with the PowerShell version argument.
 
    $pwshVersion = $configurationName.Replace(&quot;&quot;PowerShell.&quot;&quot;, &quot;&quot;&quot;&quot;)
    $resolvedPluginInstallPath = Copy-PluginToEndpoint $pwshVersion
    if (!$resolvedPluginInstallPath) {{
        return
    }}
 
    #
    # Section 2:
    # Generate the Plugin Configuration File
    #
    New-PluginConfigFile $resolvedPluginInstallPath
 
    #
    # Section 3:
    # Register the endpoint
    #
    $null = Register-PSSessionConfiguration -Name $configurationName -force -ErrorAction Stop
 
    set-item -WarningAction SilentlyContinue wsman:\localhost\plugin\$configurationName\Quotas\MaxShellsPerUser -value &quot;&quot;25&quot;&quot; -confirm:$false
    set-item -WarningAction SilentlyContinue wsman:\localhost\plugin\$configurationName\Quotas\MaxIdleTimeoutms -value {3} -confirm:$false
    restart-service winrm -confirm:$false
}}
 
function Register-EndpointIfNotPresent
{{
[CmdletBinding(SupportsShouldProcess=$true, ConfirmImpact=&quot;&quot;Medium&quot;&quot;)]
param(
    [Parameter()] [string] $Name,
    [Parameter()] [bool] $Force,
    [Parameter()] [string] $queryForRegisterDefault,
    [Parameter()] [string] $captionForRegisterDefault
)
    #
    # This cmdlet will make sure default powershell end points exist upon successful completion.
    #
    # Windows PowerShell:
    #   Microsoft.PowerShell
    #   Microsoft.PowerShell32 (wow64)
    #
    # PowerShell:
    #   PowerShell.&lt;version ID&gt;
    #
    $errorCount = $error.Count
    $endPoint = Get-PSSessionConfiguration $Name -Force:$Force -ErrorAction silentlycontinue 2&gt;&amp;1
    $newErrorCount = $error.Count
 
    # remove the &#39;No Session Configuration matches criteria&#39; errors
    for ($index = 0; $index -lt ($newErrorCount - $errorCount); $index ++)
    {{
        $error.RemoveAt(0)
    }}
 
    $qMessage = $queryForRegisterDefault -f &quot;&quot;$Name&quot;&quot;,&quot;&quot;Register-PSSessionConfiguration {0} -force&quot;&quot;
    if ((!$endpoint) -and
        ($force  -or $pscmdlet.ShouldProcess($qMessage, $captionForRegisterDefault)))
    {{
        Register-Endpoint $Name
    }}
}}
 
function Enable-PSRemoting
{{
[CmdletBinding(SupportsShouldProcess=$true, ConfirmImpact=&quot;&quot;Medium&quot;&quot;)]
param(
    [Parameter()] [bool] $Force,
    [Parameter()] [string] $queryForRegisterDefault,
    [Parameter()] [string] $captionForRegisterDefault,
    [Parameter()] [string] $queryForSet,
    [Parameter()] [string] $captionForSet,
    [Parameter()] [bool] $skipNetworkProfileCheck,
    [Parameter()] [string] $errorMsgUnableToInstallPlugin
)
 
    end
    {{
        # Enable all Session Configurations
        try {{
            $null = $PSBoundParameters.Remove(&quot;&quot;queryForRegisterDefault&quot;&quot;)
            $null = $PSBoundParameters.Remove(&quot;&quot;captionForRegisterDefault&quot;&quot;)
            $null = $PSBoundParameters.Remove(&quot;&quot;queryForSet&quot;&quot;)
            $null = $PSBoundParameters.Remove(&quot;&quot;captionForSet&quot;&quot;)
            $null = $PSBoundParameters.Remove(&quot;&quot;errorMsgUnableToInstallPlugin&quot;&quot;)
 
            $PSBoundParameters.Add(&quot;&quot;Name&quot;&quot;,&quot;&quot;*&quot;&quot;)
 
            # first try to enable all the sessions
            Enable-PSSessionConfiguration @PSBoundParameters
 
            Register-EndpointIfNotPresent -Name {0} $Force $queryForRegisterDefault $captionForRegisterDefault
 
            # Create the default PSSession configuration, not tied to specific PowerShell version
            # e. g. &#39;PowerShell.6&#39;.
            $powershellVersionMajor = $PSVersionTable.PSVersion.ToString()
            $dotPos = $powershellVersionMajor.IndexOf(&quot;&quot;.&quot;&quot;)
            if ($dotPos -ne -1) {{
                $powershellVersionMajor = $powershellVersionMajor.Substring(0, $dotPos)
            }}
            # If we are running a Preview version, we don&#39;t want to clobber the generic PowerShell.6 endpoint
            # but instead create a PowerShell.6-Preview endpoint
            if ($PSVersionTable.PSVersion.PreReleaseLabel)
            {{
                $powershellVersionMajor += &quot;&quot;-preview&quot;&quot;
            }}
 
            Register-EndpointIfNotPresent -Name (&quot;&quot;PowerShell.&quot;&quot; + $powershellVersionMajor) $Force $queryForRegisterDefault $captionForRegisterDefault
 
            # remove the &#39;network deny all&#39; tag
            Get-PSSessionConfiguration -Force:$Force | ForEach-Object {{
                $sddl = $null
                if ($_.psobject.members[&quot;&quot;SecurityDescriptorSddl&quot;&quot;])
                {{
                    $sddl = $_.psobject.members[&quot;&quot;SecurityDescriptorSddl&quot;&quot;].Value
                }}
 
                if ($sddl)
                {{
                    # Construct SID for network users
                    [system.security.principal.wellknownsidtype]$evst = &quot;&quot;NetworkSid&quot;&quot;
                    $networkSID = new-object system.security.principal.securityidentifier $evst,$null
 
                    $securityIdentifierToPurge = $null
                    $sd = new-object system.security.accesscontrol.commonsecuritydescriptor $false,$false,$sddl
                    $sd.DiscretionaryAcl | ForEach-Object {{
                        if (($_.acequalifier -eq &quot;&quot;accessdenied&quot;&quot;) -and ($_.securityidentifier -match $networkSID) -and ($_.AccessMask -eq 268435456))
                        {{
                            $securityIdentifierToPurge = $_.securityidentifier
                        }}
                    }}
 
                    if ($securityIdentifierToPurge)
                    {{
                        # Remove the specific ACE
                        $sd.discretionaryacl.RemoveAccessSpecific(&#39;Deny&#39;, $securityIdentifierToPurge, 268435456, &#39;none&#39;, &#39;none&#39;)
 
                        # if there is no discretionaryacl..add Builtin Administrators and Remote Management Users
                        # to the DACL group as this is the default WSMan behavior
                        if ($sd.discretionaryacl.count -eq 0)
                        {{
                            # Built-in administrators.
                            [system.security.principal.wellknownsidtype]$bast = &quot;&quot;BuiltinAdministratorsSid&quot;&quot;
                            $basid = new-object system.security.principal.securityidentifier $bast,$null
                            $sd.DiscretionaryAcl.AddAccess(&#39;Allow&#39;,$basid, 268435456, &#39;none&#39;, &#39;none&#39;)
 
                            # Remote Management Users, Win8+ only
                            if ([System.Environment]::OSVersion.Version -ge &quot;&quot;6.2.0.0&quot;&quot;)
                            {{
                                $rmSidId = new-object system.security.principal.securityidentifier &quot;&quot;{1}&quot;&quot;
                                $sd.DiscretionaryAcl.AddAccess(&#39;Allow&#39;, $rmSidId, 268435456, &#39;none&#39;, &#39;none&#39;)
                            }}
 
                            # Interactive Users
                            $iaSidId = new-object system.security.principal.securityidentifier &quot;&quot;{2}&quot;&quot;
                            $sd.DiscretionaryAcl.AddAccess(&#39;Allow&#39;, $iaSidId, 268435456, &#39;none&#39;, &#39;none&#39;)
                        }}
 
                        $sddl = $sd.GetSddlForm(&quot;&quot;all&quot;&quot;)
                    }}
                }} ## end of if($sddl)
 
                $qMessage = $queryForSet -f $_.name,$sddl
                if (($sddl) -and ($force -or $pscmdlet.ShouldProcess($qMessage, $captionForSet)))
                {{
                    $null = Set-PSSessionConfiguration -Name $_.Name -SecurityDescriptorSddl $sddl -NoServiceRestart -force -WarningAction 0
                }}
            }} ## end of foreach-object
        }}
        catch {{
            throw
        }}  # end of catch
    }} # end of end block
}} # end of Enable-PSRemoting
 
Enable-PSRemoting -force $args[0] -queryForRegisterDefault $args[1] -captionForRegisterDefault $args[2] -queryForSet $args[3] -captionForSet $args[4] -whatif:$args[5] -confirm:$args[6] -skipNetworkProfileCheck $args[7] -errorMsgUnableToInstallPlugin $args[8]
&quot;</span>;
 
        <b>private static readonly</b> <a href="../../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="t t">ScriptBlock</a> <a id="c2752938d3ee30ec" href="../../../R/c2752938d3ee30ec.html" target="n" data-glyph="46,1" class="i field">s_enableRemotingSb</a>;
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Constructors
 
        <b>static</b> <a id="8709eb7fcaf6dd5a" href="../../../R/../../0000000000.html" target="n" data-glyph="76,1" class="t method">EnablePSRemotingCommand</a>()
        {
            <b>string</b> <span id="r310 rd" class="r310 r">enableRemotingScript</span> = <b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>,
                <a href="#faab737febe5eb36" class="i field">enableRemotingSbFormat</a>, <a href="#2111ec231989f662" class="t t">PSSessionConfigurationCommandUtilities</a>.<a href="#5feea7253cd275c1" class="i method">GetWinrmPluginShellName</a>(),
                <a href="#fc12f22923e252d9" class="t t">PSSessionConfigurationCommandBase</a>.<a href="#9d3d012f73c36bca" class="i field">RemoteManagementUsersSID</a>, <a href="#fc12f22923e252d9" class="t t">PSSessionConfigurationCommandBase</a>.<a href="#3040a1427951767d" class="i field">InteractiveUsersSID</a>,
                <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#d19a1042a44001e8" class="t t">RemotingConstants</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#2542701c66e03ff5" class="i field">MaxIdleTimeoutMS</a>, <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#d19a1042a44001e8" class="t t">RemotingConstants</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#7cbb6da0d7ec5022" class="i field">PSPluginDLLName</a>);
 
            <span class="c">// compile the script block statically and reuse the same instance</span>
            <span class="c">// everytime the command is run..This will save on parsing time.</span>
            <a href="#c2752938d3ee30ec" class="i field">s_enableRemotingSb</a> = <a href="../../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="t t">ScriptBlock</a>.<a href="../../lang/scriptblock.cs.html#adfac0fa7bf5725f" class="i method">Create</a>(<span class="r310 r">enableRemotingScript</span>);
            <a href="#c2752938d3ee30ec" class="i field">s_enableRemotingSb</a>.<a href="../../lang/scriptblock.cs.html#5e76a9fb0d1a7f12" class="i property">LanguageMode</a> = <a href="../../SessionStatePublic.cs.html#450052824aba2e3f" class="t t">PSLanguageMode</a>.<a href="../../SessionStatePublic.cs.html#eec721eb8c02f156" class="i field">FullLanguage</a>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Parameters
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Property that sets force parameter. This will allow</span>
        <span class="c">///</span><span class="c"> configuring the WinRM and enabling the session configurations</span>
        <span class="c">///</span><span class="c"> without prompting the user.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>()]
        <b>public</b> <a href="../../MshCmdlet.cs.html#8260026027378f6c" class="t t">SwitchParameter</a> <a id="8e54ab6fae93b255" href="../../../R/../../0000000000.html" target="n" data-glyph="102,1" class="i property">Force</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#3e198484dbe67f3f" class="i field">_force</a>;
            }
 
            <b>set</b>
            {
                <a href="#3e198484dbe67f3f" class="i field">_force</a> = <b>value</b>;
            }
        }
 
        <b>private bool</b> <a id="3e198484dbe67f3f" href="../../../R/3e198484dbe67f3f.html" target="n" data-glyph="46,1" class="i field">_force</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Property that will allow configuring WinRM with Public</span>
        <span class="c">///</span><span class="c"> profile exception enabled.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>()]
        <b>public</b> <a href="../../MshCmdlet.cs.html#8260026027378f6c" class="t t">SwitchParameter</a> <a id="e2785037d1cd26d3" href="../../../R/../../0000000000.html" target="n" data-glyph="102,1" class="i property">SkipNetworkProfileCheck</a>
        {
            <b>get</b> { <b>return</b> <a href="#2af22c008a6b1e4d" class="i field">_skipNetworkProfileCheck</a>; }
 
            <b>set</b> { <a href="#2af22c008a6b1e4d" class="i field">_skipNetworkProfileCheck</a> = <b>value</b>; }
        }
 
        <b>private bool</b> <a id="2af22c008a6b1e4d" href="../../../R/2af22c008a6b1e4d.html" target="n" data-glyph="46,1" class="i field">_skipNetworkProfileCheck</a>;
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Cmdlet Overrides
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">InvalidOperationException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> 1. Either both &quot;AssemblyName&quot; and &quot;ConfigurationTypeName&quot; must be specified</span>
        <span class="c">///</span><span class="c"> or both must not be specified.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>protected override void</b> <a id="7d23a983f29f2583" href="../../../R/7d23a983f29f2583.html" target="n" data-glyph="75,1" class="i method">BeginProcessing</a>()
        {
            <span class="c">// check if we have compatible WSMan</span>
            <a href="remotingcommandutil.cs.html#4c008a65630ba320" class="t t">RemotingCommandUtil</a>.<a href="remotingcommandutil.cs.html#668e049b2f134726" class="i method">CheckRemotingCmdletPrerequisites</a>();
            <a href="#2111ec231989f662" class="t t">PSSessionConfigurationCommandUtilities</a>.<a href="#e6567bb211cb1a98" class="i method">ThrowIfNotAdministrator</a>();
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>protected override void</b> <a id="e45b10709c25317c" href="../../../R/e45b10709c25317c.html" target="n" data-glyph="75,1" class="i method">EndProcessing</a>()
        {
            <span class="i">WriteWarning</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">PSCoreRemotingEnableWarning</span>);
 
            <span class="c">// gather -WhatIf, -Confirm parameter data and pass it to the script block</span>
            <b>bool</b> <span id="r311 rd" class="r311 r">whatIf</span> = <b>false</b>;
            <span class="c">// confirm is always true to start with</span>
            <b>bool</b> <span id="r312 rd" class="r312 r">confirm</span> = <b>true</b>;
            <a href="#2111ec231989f662" class="t t">PSSessionConfigurationCommandUtilities</a>.<a href="#62fe0a5dea8c58db" class="i method">CollectShouldProcessParameters</a>(<a href="#5ee20feca58bd195" class="k">this</a>, <b>out</b> <span class="r311 r">whatIf</span>, <b>out</b> <span class="r312 r">confirm</span>);
 
            <b>string</b> <span id="r313 rd" class="r313 r">captionMessage</span> = <span class="i">RemotingErrorIdStrings</span>.<span class="i">ERemotingCaption</span>;
            <b>string</b> <span id="r314 rd" class="r314 r">queryMessage</span> = <span class="i">RemotingErrorIdStrings</span>.<span class="i">ERemotingQuery</span>;
 
            <b>string</b> <span id="r315 rd" class="r315 r">setCaptionMessage</span> = <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">CSShouldProcessAction</span>, <span class="s">&quot;Set-PSSessionConfiguration&quot;</span>);
            <b>string</b> <span id="r316 rd" class="r316 r">setQueryMessage</span> = <span class="i">RemotingErrorIdStrings</span>.<span class="i">EcsShouldProcessTarget</span>;
 
            <a href="#c2752938d3ee30ec" class="i field">s_enableRemotingSb</a>.<span class="i">InvokeUsingCmdlet</span>(
                <span class="i">contextCmdlet</span>: <a href="#5ee20feca58bd195" class="k">this</a>,
                <span class="i">useLocalScope</span>: <b>true</b>,
                <span class="i">errorHandlingBehavior</span>: <a href="../../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="t t">ScriptBlock</a>.<a href="../../lang/scriptblock.cs.html#10c045824f712272" class="t t">ErrorHandlingBehavior</a>.<a href="../../lang/scriptblock.cs.html#5e78734ffe1c6ed3" class="i field">WriteToCurrentErrorPipe</a>,
                <span class="i">dollarUnder</span>: <a href="../../AutomationNull.cs.html#681fbea4c40e4af1" class="t t">AutomationNull</a>.<a href="../../AutomationNull.cs.html#1cf7e193da582896" class="i property">Value</a>,
                <span class="i">input</span>: <span class="i">Array</span>.<span class="i">Empty</span>&lt;<b>object</b>&gt;(),
                <span class="i">scriptThis</span>: <a href="../../AutomationNull.cs.html#681fbea4c40e4af1" class="t t">AutomationNull</a>.<a href="../../AutomationNull.cs.html#1cf7e193da582896" class="i property">Value</a>,
                <span class="i">args</span>: <b>new</b> <b>object</b>[] {
                                               <a href="#3e198484dbe67f3f" class="i field">_force</a>,
                                               <span class="r314 r">queryMessage</span>,
                                               <span class="r313 r">captionMessage</span>,
                                               <span class="r316 r">setQueryMessage</span>,
                                               <span class="r315 r">setCaptionMessage</span>,
                                               <span class="r311 r">whatIf</span>,
                                               <span class="r312 r">confirm</span>,
                                               <a href="#2af22c008a6b1e4d" class="i field">_skipNetworkProfileCheck</a>,
                                               <span class="i">RemotingErrorIdStrings</span>.<span class="i">UnableToInstallPlugin</span>});
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
    }
 
    <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
    <span class="k preprocess">#</span><span class="k preprocess">region</span> Disable-PSRemoting
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Disable-PSRemoting cmdlet</span>
    <span class="c">///</span><span class="c"> Only disable the network access to the Session Configuration. The</span>
    <span class="c">///</span><span class="c"> local access is still enabled.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    [<span class="i">Cmdlet</span>(<a href="../../../utils/Verbs.cs.html#1a8e85c66f6fff18" class="t t">VerbsLifecycle</a>.<a href="../../../utils/Verbs.cs.html#734c65c806b352fc" class="i field">Disable</a>, <a href="../common/WireDataFormat/EncodeAndDecode.cs.html#d19a1042a44001e8" class="t t">RemotingConstants</a>.<a href="../common/WireDataFormat/EncodeAndDecode.cs.html#ed7ccaab0f1439c0" class="i field">PSRemotingNoun</a>,
        <span class="i">SupportsShouldProcess</span> = <b>true</b>, <span class="i">ConfirmImpact</span> = <a href="../../CommandBase.cs.html#ba94675b57c6d6e9" class="t t">ConfirmImpact</a>.<a href="../../CommandBase.cs.html#f2126d83835863e8" class="i field">Medium</a>, <span class="i">HelpUri</span> = <span class="s">&quot;https://go.microsoft.com/fwlink/?LinkID=2096482&quot;</span>)]
    <b>public sealed class</b> <a id="62dd6cca42c0ce20" href="../../../R/62dd6cca42c0ce20.html" target="n" data-glyph="0,0" class="t t"><span id="6f29baa3deae3c9b">DisablePSRemotingCommand</span></a> : <a href="../../../P/30543a6971fed1fc.html#30543a6971fed1fc" class="t t">PSCmdlet</a>
    {
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Private Data
 
        <span class="c">// To Escape { -- {{</span>
        <span class="c">// To Escape } -- }}</span>
        <span class="c">// To Escape &quot; -- &quot;&quot;</span>
        <b>private const string</b> <a id="4c7dc3ab48ef902d" href="../../../R/4c7dc3ab48ef902d.html" target="n" data-glyph="10,1" class="i field">disablePSRemotingFormat</a> = <span class="s">@&quot;
function Disable-PSRemoting
{{
[CmdletBinding(SupportsShouldProcess=$true, ConfirmImpact=&quot;&quot;Medium&quot;&quot;)]
param(
    [Parameter()]
    [switch]
    $force,
 
    [Parameter()]
    [string]
    $queryForSet,
 
    [Parameter()]
    [string]
    $captionForSet,
 
    [Parameter()]
    [string]
    $restartWinRMMessage
)
 
    begin
    {{
        if ($pscmdlet.ShouldProcess($restartWinRMMessage))
        {{
            $svc = get-service winrm
            if ($svc.Status -match &quot;&quot;Stopped&quot;&quot;)
            {{
                Restart-Service winrm -force -confirm:$false
            }}
        }}
    }} # end of begin block
 
    end
    {{
        # Disable the network for all Session Configurations
        Get-PSSessionConfiguration -Force:$force | ForEach-Object {{
 
            if ($_.Enabled)
            {{
                $sddl = $null
                if ($_.psobject.members[&quot;&quot;SecurityDescriptorSddl&quot;&quot;])
                {{
                    $sddl = $_.psobject.members[&quot;&quot;SecurityDescriptorSddl&quot;&quot;].Value
                }}
 
                if (!$sddl)
                {{
                    # Disable network users from accessing this configuration
                    $sddl = &quot;&quot;{0}&quot;&quot;
                }}
                else
                {{
                    # Construct SID for network users
                    [system.security.principal.wellknownsidtype]$evst = &quot;&quot;NetworkSid&quot;&quot;
                    $networkSID = new-object system.security.principal.securityidentifier $evst,$null
 
                    # Add disable network to the existing sddl
                    $sd = new-object system.security.accesscontrol.commonsecuritydescriptor $false,$false,$sddl
                    $disableNetworkExists = $false
                    $sd.DiscretionaryAcl | ForEach-Object {{
                        if (($_.acequalifier -eq &quot;&quot;accessdenied&quot;&quot;) -and ($_.securityidentifier -match $networkSID) -and ($_.AccessMask -eq 268435456))
                        {{
                            $disableNetworkExists = $true
                        }}
                    }}
 
                    if (!$disableNetworkExists)
                    {{
                        $sd.DiscretionaryAcl.AddAccess(&quot;&quot;deny&quot;&quot;, $networkSID, 268435456, &quot;&quot;None&quot;&quot;, &quot;&quot;None&quot;&quot;)
                        $sddl = $sd.GetSddlForm(&quot;&quot;all&quot;&quot;)
                    }}
                    else
                    {{
                        # since disable network GA already exists, we dont need to change anything.
                        $sddl = $null
                    }}
                }} ## end of if(!$sddl)
 
                $qMessage = $queryForSet -f $_.name,$sddl
                if (($sddl) -and ($force -or $pscmdlet.ShouldProcess($qMessage, $captionForSet)))
                {{
                    $null = Set-PSSessionConfiguration -Name $_.Name -SecurityDescriptorSddl $sddl -NoServiceRestart -force -WarningAction 0
                }}
            }} ## end of if($_.Enabled)
        }} ## end of %
    }} ## end of Process block
}}
 
Disable-PSRemoting -force:$args[0] -queryForSet $args[1] -captionForSet $args[2] -restartWinRMMessage $args[3] -whatif:$args[4] -confirm:$args[5]
&quot;</span>;
 
        <b>private static readonly</b> <a href="../../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="t t">ScriptBlock</a> <a id="9b11a02fd4084f61" href="../../../R/9b11a02fd4084f61.html" target="n" data-glyph="46,1" class="i field">s_disableRemotingSb</a>;
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Private Data
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Constructors
 
        <b>static</b> <a id="197c1512998e1e40" href="../../../R/../../0000000000.html" target="n" data-glyph="76,1" class="t method">DisablePSRemotingCommand</a>()
        {
            <b>string</b> <span id="r317 rd" class="r317 r">localSDDL</span> = <a href="#fc12f22923e252d9" class="t t">PSSessionConfigurationCommandBase</a>.<a href="#1cb9fa319955517b" class="i method">GetLocalSddl</a>();
            <b>string</b> <span id="r318 rd" class="r318 r">disableRemotingScript</span> = <b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>, <a href="#4c7dc3ab48ef902d" class="i field">disablePSRemotingFormat</a>, <span class="r317 r">localSDDL</span>);
 
            <span class="c">// compile the script block statically and reuse the same instance</span>
            <span class="c">// everytime the command is run..This will save on parsing time.</span>
            <a href="#9b11a02fd4084f61" class="i field">s_disableRemotingSb</a> = <a href="../../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="t t">ScriptBlock</a>.<a href="../../lang/scriptblock.cs.html#adfac0fa7bf5725f" class="i method">Create</a>(<span class="r318 r">disableRemotingScript</span>);
            <a href="#9b11a02fd4084f61" class="i field">s_disableRemotingSb</a>.<a href="../../lang/scriptblock.cs.html#5e76a9fb0d1a7f12" class="i property">LanguageMode</a> = <a href="../../SessionStatePublic.cs.html#450052824aba2e3f" class="t t">PSLanguageMode</a>.<a href="../../SessionStatePublic.cs.html#eec721eb8c02f156" class="i field">FullLanguage</a>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Constructors
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Parameters
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Force parameter.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>()]
        <b>public</b> <a href="../../MshCmdlet.cs.html#8260026027378f6c" class="t t">SwitchParameter</a> <a id="29970f25c527c700" href="../../../R/../../0000000000.html" target="n" data-glyph="102,1" class="i property">Force</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#9127057388ecdfc2" class="i field">_force</a>;
            }
 
            <b>set</b>
            {
                <a href="#9127057388ecdfc2" class="i field">_force</a> = <b>value</b>;
            }
        }
 
        <b>private bool</b> <a id="9127057388ecdfc2" href="../../../R/9127057388ecdfc2.html" target="n" data-glyph="46,1" class="i field">_force</a>;
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Parameters
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Cmdlet Override
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Check for prerequisites and elevation mode.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>protected override void</b> <a id="0e3386025a18176d" href="../../../R/0e3386025a18176d.html" target="n" data-glyph="75,1" class="i method">BeginProcessing</a>()
        {
            <span class="c">// check if we have compatible WSMan</span>
            <a href="remotingcommandutil.cs.html#4c008a65630ba320" class="t t">RemotingCommandUtil</a>.<a href="remotingcommandutil.cs.html#668e049b2f134726" class="i method">CheckRemotingCmdletPrerequisites</a>();
            <a href="#2111ec231989f662" class="t t">PSSessionConfigurationCommandUtilities</a>.<a href="#e6567bb211cb1a98" class="i method">ThrowIfNotAdministrator</a>();
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Invoke Disable-PSRemoting.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>protected override void</b> <a id="461f55b1749d26e8" href="../../../R/461f55b1749d26e8.html" target="n" data-glyph="75,1" class="i method">EndProcessing</a>()
        {
            <span class="i">WriteWarning</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">PSCoreRemotingDisableWarning</span>);
            <a href="../../cmdlet.cs.html#dda5a07d1a8a6cba" class="i method">WriteWarning</a>(<a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">DcsWarningMessage</span>));
            <a href="../../cmdlet.cs.html#377660744c64cd7e" class="i method">WriteVerbose</a>(<a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">EcsScriptMessageV</span>, <a href="#4c7dc3ab48ef902d" class="i field">disablePSRemotingFormat</a>));
 
            <span class="c">// gather -WhatIf, -Confirm parameter data and pass it to the script block</span>
            <b>bool</b> <span id="r319 rd" class="r319 r">whatIf</span> = <b>false</b>;
            <span class="c">// confirm is always true to start with</span>
            <b>bool</b> <span id="r320 rd" class="r320 r">confirm</span> = <b>true</b>;
            <a href="#2111ec231989f662" class="t t">PSSessionConfigurationCommandUtilities</a>.<a href="#62fe0a5dea8c58db" class="i method">CollectShouldProcessParameters</a>(<a href="#62dd6cca42c0ce20" class="k">this</a>, <b>out</b> <span class="r319 r">whatIf</span>, <b>out</b> <span class="r320 r">confirm</span>);
 
            <b>string</b> <span id="r321 rd" class="r321 r">captionMessage</span> = <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">CSShouldProcessAction</span>, <span class="s">&quot;Set-PSSessionConfiguration&quot;</span>);
            <b>string</b> <span id="r322 rd" class="r322 r">queryMessage</span> = <span class="i">RemotingErrorIdStrings</span>.<span class="i">DisableRemotingShouldProcessTarget</span>;
            <b>string</b> <span id="r323 rd" class="r323 r">restartWinRMMessage</span> = <span class="i">RemotingErrorIdStrings</span>.<span class="i">RestartWinRMMessage</span>;
 
            <a href="#9b11a02fd4084f61" class="i field">s_disableRemotingSb</a>.<span class="i">InvokeUsingCmdlet</span>(
                <span class="i">contextCmdlet</span>: <a href="#62dd6cca42c0ce20" class="k">this</a>,
                <span class="i">useLocalScope</span>: <b>true</b>,
                <span class="i">errorHandlingBehavior</span>: <a href="../../../P/eea83b421baeaca4.html#eea83b421baeaca4" class="t t">ScriptBlock</a>.<a href="../../lang/scriptblock.cs.html#10c045824f712272" class="t t">ErrorHandlingBehavior</a>.<a href="../../lang/scriptblock.cs.html#5e78734ffe1c6ed3" class="i field">WriteToCurrentErrorPipe</a>,
                <span class="i">dollarUnder</span>: <a href="../../AutomationNull.cs.html#681fbea4c40e4af1" class="t t">AutomationNull</a>.<a href="../../AutomationNull.cs.html#1cf7e193da582896" class="i property">Value</a>,
                <span class="i">input</span>: <span class="i">Array</span>.<span class="i">Empty</span>&lt;<b>object</b>&gt;(),
                <span class="i">scriptThis</span>: <a href="../../AutomationNull.cs.html#681fbea4c40e4af1" class="t t">AutomationNull</a>.<a href="../../AutomationNull.cs.html#1cf7e193da582896" class="i property">Value</a>,
                <span class="i">args</span>: <b>new</b> <b>object</b>[] {
                                               <a href="#9127057388ecdfc2" class="i field">_force</a>,
                                               <span class="r322 r">queryMessage</span>,
                                               <span class="r321 r">captionMessage</span>,
                                               <span class="r323 r">restartWinRMMessage</span>,
                                               <span class="r319 r">whatIf</span>,
                                               <span class="r320 r">confirm</span>});
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Cmdlet Override
    }
 
    <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
    <span class="k preprocess">#</span><span class="k preprocess">region</span> Get-PSSessionCapability
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Gets the capabilities of a constrained endpoint on the local machine for a specific user.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    [<span class="i">Cmdlet</span>(<a href="../../../utils/Verbs.cs.html#d056c4b8c99405e5" class="t t">VerbsCommon</a>.<a href="../../../utils/Verbs.cs.html#7ee9f5441476f642" class="i field">Get</a>, <span class="s">&quot;PSSessionCapability&quot;</span>, <span class="i">HelpUri</span> = <span class="s">&quot;https://go.microsoft.com/fwlink/?LinkId=623709&quot;</span>)]
    [<span class="i">OutputType</span>(<b>new</b> <span class="i">Type</span>[] { <b>typeof</b>(<span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="../../CommandInfo.cs.html#71babe57a99ca852" class="t t">CommandInfo</a>), <b>typeof</b>(<span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Runspaces</span>.<a href="../../InitialSessionState.cs.html#b17f88d4755d5fd7" class="t t">InitialSessionState</a>) })]
    <b>public sealed class</b> <a id="d304a97a9bb37b15" href="../../../R/d304a97a9bb37b15.html" target="n" data-glyph="0,0" class="t t"><span id="59f6b069a05eeafb">GetPSSessionCapabilityCommand</span></a> : <a href="../../../P/30543a6971fed1fc.html#30543a6971fed1fc" class="t t">PSCmdlet</a>
    {
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets or sets the session name that should be queried for its session capabilities.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>(<a href="../../Attributes.cs.html#d5ad471518092731" class="i property">Mandatory</a> = <b>true</b>, <a href="../../Attributes.cs.html#19ccfeb1cdbdb967" class="i property">Position</a> = 0)]
        <b>public string</b> <a id="d6f8980159ac8841" href="../../../R/d6f8980159ac8841.html" target="n" data-glyph="102,1" class="i property">ConfigurationName</a> { <b>get</b>; <b>set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets or sets the user name that should be applied to the session.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>(<a href="../../Attributes.cs.html#d5ad471518092731" class="i property">Mandatory</a> = <b>true</b>, <a href="../../Attributes.cs.html#19ccfeb1cdbdb967" class="i property">Position</a> = 1)]
        <b>public string</b> <a id="eb622e1d4f69b36d" href="../../../R/eb622e1d4f69b36d.html" target="n" data-glyph="102,1" class="i property">Username</a> { <b>get</b>; <b>set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets or sets the switch that determines whether just the commands should be returned,</span>
        <span class="c">///</span><span class="c"> or the entire Initial Session State.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>()]
        <b>public</b> <a href="../../MshCmdlet.cs.html#8260026027378f6c" class="t t">SwitchParameter</a> <a id="82b41cf49ed3782d" href="../../../R/82b41cf49ed3782d.html" target="n" data-glyph="102,1" class="i property">Full</a> { <b>get</b>; <b>set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>protected override void</b> <a id="fd5519111831b1c9" href="../../../R/fd5519111831b1c9.html" target="n" data-glyph="75,1" class="i method">BeginProcessing</a>()
        {
            <span class="c">// Validate that WinRM is OK and that the user can query system state</span>
            <a href="remotingcommandutil.cs.html#4c008a65630ba320" class="t t">RemotingCommandUtil</a>.<a href="remotingcommandutil.cs.html#668e049b2f134726" class="i method">CheckRemotingCmdletPrerequisites</a>();
            <a href="#2111ec231989f662" class="t t">PSSessionConfigurationCommandUtilities</a>.<a href="#e6567bb211cb1a98" class="i method">ThrowIfNotAdministrator</a>();
 
            <span class="c">// Get the configuration for the given endpoint</span>
            <span class="i">Collection</span>&lt;<a href="../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt; <span id="r324 rd" class="r324 r">configurations</span> = <b>null</b>;
            <b>using</b> (<a href="../../hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShellApi</a> <span id="r325 rd" class="r325 r">invoker</span> = <a href="../../hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShellApi</a>.<a href="../../hostifaces/PowerShell.cs.html#1c6a51d3c837bb4d" class="i method">Create</a>(<a href="../../hostifaces/PowerShell.cs.html#c3c0f0e5e0b337ff" class="t t">RunspaceMode</a>.<a href="../../hostifaces/PowerShell.cs.html#75d224de5df87e75" class="i field">CurrentRunspace</a>))
            {
                <span class="r325 r">invoker</span>.<a href="../../hostifaces/PowerShell.cs.html#9cc79c297f6cced9" class="i method">AddCommand</a>(<span class="s">&quot;Get-PSSessionConfiguration&quot;</span>).<a href="../../hostifaces/PowerShell.cs.html#40674f99a3618f4b" class="i method">AddParameter</a>(<span class="s">&quot;Name&quot;</span>, <a href="#d304a97a9bb37b15" class="k">this</a>.<a href="#d6f8980159ac8841" class="i property">ConfigurationName</a>).<a href="../../hostifaces/PowerShell.cs.html#40674f99a3618f4b" class="i method">AddParameter</a>(<span class="s">&quot;ErrorAction&quot;</span>, <span class="s">&quot;Stop&quot;</span>);
 
                <b>try</b>
                {
                    <span class="c">// If the session name doesn&#39;t exist, this Invoke() throws</span>
                    <span class="r324 r">configurations</span> = <span class="r325 r">invoker</span>.<a href="../../hostifaces/PowerShell.cs.html#184e23c46120523e" class="i method">Invoke</a>();
                }
                <b>catch</b> (<a href="../../../utils/ExecutionExceptions.cs.html#f896df45dff24981" class="t t">ActionPreferenceStopException</a> <span id="r326 rd" class="r326 r">e</span>)
                {
                    <a href="../../cmdlet.cs.html#e3346d70990a1763" class="i method">ThrowTerminatingError</a>(<b>new</b> <a href="../../ErrorPackage.cs.html#e9334565e5136f43" class="t constructor">ErrorRecord</a>(<span class="r326 r">e</span>.<a href="../../../utils/ExecutionExceptions.cs.html#81113987450d3603" class="i property">ErrorRecord</a>.<a href="../../ErrorPackage.cs.html#2c2498db91e737eb" class="i property">Exception</a>, <span class="s">&quot;CouldNotFindSessionConfiguration&quot;</span>, <a href="../../ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../../ErrorPackage.cs.html#9a72a7d3051ac7c5" class="i field">ObjectNotFound</a>, <a href="#d304a97a9bb37b15" class="k">this</a>.<a href="#d6f8980159ac8841" class="i property">ConfigurationName</a>));
                }
            }
 
            <span class="c">// The validator that will be applied to the role lookup</span>
            <span class="i">Func</span>&lt;<b>string</b>, <b>bool</b>&gt; <span id="r327 rd" class="r327 r">validator</span> = <b>static</b> (<span id="r328 rd" class="r328 r">role</span>) =&gt; <b>true</b>;
 
            <b>if</b> (!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<a href="#d304a97a9bb37b15" class="k">this</a>.<a href="#eb622e1d4f69b36d" class="i property">Username</a>))
            {
                <b>if</b> (<a href="#d304a97a9bb37b15" class="k">this</a>.<a href="#eb622e1d4f69b36d" class="i property">Username</a>.<span class="i">Contains</span>(<span class="s">&#39;\\&#39;</span>))
                {
                    <span class="r327 r">validator</span> = <b>null</b>;
 
                    <span class="c">// Convert DOMAIN\user to the upn (user@DOMAIN)</span>
                    <b>string</b>[] <span id="r329 rd" class="r329 r">upnComponents</span> = <a href="#d304a97a9bb37b15" class="k">this</a>.<a href="#eb622e1d4f69b36d" class="i property">Username</a>.<span class="i">Split</span>(<a href="../../Utils.cs.html#9185d6ecbaebbec0" class="t t">Utils</a>.<a href="../../Utils.cs.html#6fd6d3492cb91f87" class="t t">Separators</a>.<a href="../../Utils.cs.html#247bb446a0dd1494" class="i field">Backslash</a>);
                    <b>if</b> (<span class="r329 r">upnComponents</span>.<span class="i">Length</span> == 2)
                    {
                        <a href="#d304a97a9bb37b15" class="k">this</a>.<a href="#eb622e1d4f69b36d" class="i property">Username</a> = <span class="r329 r">upnComponents</span>[1] + <span class="s">&quot;@&quot;</span> + <span class="r329 r">upnComponents</span>[0];
                    }
                }
 
                <b>try</b>
                {
                    <span class="i n">System</span>.<span class="i">Security</span>.<span class="i">Principal</span>.<span class="i">WindowsPrincipal</span> <span id="r330 rd" class="r330 r">windowsPrincipal</span> = <b>new</b> <span class="i n">System</span>.<span class="i">Security</span>.<span class="i">Principal</span>.<span class="i">WindowsPrincipal</span>(
                        <b>new</b> <span class="i n">System</span>.<span class="i">Security</span>.<span class="i">Principal</span>.<span class="i">WindowsIdentity</span>(<a href="#d304a97a9bb37b15" class="k">this</a>.<a href="#eb622e1d4f69b36d" class="i property">Username</a>));
                    <span class="r327 r">validator</span> = (<span id="r331 rd" class="r331 r">role</span>) =&gt; <span class="r330 r">windowsPrincipal</span>.<span class="i">IsInRole</span>(<span class="r331 r">role</span>);
                }
                <b>catch</b> (<span class="i">SecurityException</span> <span id="r332 rd" class="r332 r">e</span>)
                {
                    <span class="c">// Identity could not be mapped</span>
                    <b>string</b> <span id="r333 rd" class="r333 r">message</span> = <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">CouldNotResolveUsername</span>, <a href="#d304a97a9bb37b15" class="k">this</a>.<a href="#eb622e1d4f69b36d" class="i property">Username</a>);
                    <span class="i">ArgumentException</span> <span id="r334 rd" class="r334 r">ioe</span> = <b>new</b> <span class="i">ArgumentException</span>(<span class="r333 r">message</span>, <span class="r332 r">e</span>);
                    <a href="../../ErrorPackage.cs.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r335 rd" class="r335 r">er</span> = <b>new</b> <span class="t">ErrorRecord</span>(<span class="r334 r">ioe</span>, <span class="s">&quot;CouldNotResolveUsername&quot;</span>, <a href="../../ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../../ErrorPackage.cs.html#846d2b572f2c4820" class="i field">InvalidArgument</a>, <a href="#d304a97a9bb37b15" class="k">this</a>.<a href="#eb622e1d4f69b36d" class="i property">Username</a>);
                    <a href="../../cmdlet.cs.html#e3346d70990a1763" class="i method">ThrowTerminatingError</a>(<span class="r335 r">er</span>);
                    <b>return</b>;
                }
            }
 
            <b>foreach</b> (<a href="../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r336 rd" class="r336 r">foundConfiguration</span> <b>in</b> <span class="r324 r">configurations</span>)
            {
                <b>string</b> <span id="r337 rd" class="r337 r">configFilePath</span> = <b>null</b>;
                <a href="../../MshMemberInfo.cs.html#13ab3796654e613c" class="t t">PSPropertyInfo</a> <span id="r338 rd" class="r338 r">configFilePathProperty</span> = <span class="r336 r">foundConfiguration</span>.<a href="../../MshObject.cs.html#59e9cd1ad57ccd34" class="i property">Properties</a><a href="../../MshMemberInfo.cs.html#f603b32aa49d3ffa">[</a><span class="s">&quot;ConfigFilePath&quot;</span>];
                <b>if</b> (<span class="r338 r">configFilePathProperty</span> != <b>null</b>)
                {
                    <span class="r337 r">configFilePath</span> = <span class="r338 r">configFilePathProperty</span>.<a href="../../MshMemberInfo.cs.html#cd3a9989baedf3dd" class="i property">Value</a> <b>as string</b>;
                }
 
                <span class="c">// If we could not get the config file, throw an error that it&#39;s not a configuration created with</span>
                <span class="c">// config file-based session configurations.</span>
                <b>if</b> (<span class="r337 r">configFilePath</span> == <b>null</b>)
                {
                    <b>string</b> <span id="r339 rd" class="r339 r">configurationName</span> = (<b>string</b>)<span class="r336 r">foundConfiguration</span>.<a href="../../MshObject.cs.html#59e9cd1ad57ccd34" class="i property">Properties</a><a href="../../MshMemberInfo.cs.html#f603b32aa49d3ffa">[</a><span class="s">&quot;Name&quot;</span>].<a href="../../MshMemberInfo.cs.html#cd3a9989baedf3dd" class="i property">Value</a>;
                    <b>string</b> <span id="r340 rd" class="r340 r">message</span> = <a href="../../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">SessionConfigurationMustBeFileBased</span>, <span class="r339 r">configurationName</span>);
                    <span class="i">ArgumentException</span> <span id="r341 rd" class="r341 r">ioe</span> = <b>new</b> <span class="i">ArgumentException</span>(<span class="r340 r">message</span>);
                    <a href="../../ErrorPackage.cs.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r342 rd" class="r342 r">er</span> = <b>new</b> <span class="t">ErrorRecord</span>(<span class="r341 r">ioe</span>, <span class="s">&quot;SessionConfigurationMustBeFileBased&quot;</span>, <a href="../../ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../../ErrorPackage.cs.html#846d2b572f2c4820" class="i field">InvalidArgument</a>, <span class="r336 r">foundConfiguration</span>);
                    <a href="../../cmdlet.cs.html#7746d1a8f41a36d5" class="i method">WriteError</a>(<span class="r342 r">er</span>);
                    <b>continue</b>;
                }
 
                <a href="../../InitialSessionState.cs.html#b17f88d4755d5fd7" class="t t">InitialSessionState</a> <span id="r343 rd" class="r343 r">iss</span> = <a href="../../InitialSessionState.cs.html#b17f88d4755d5fd7" class="t t">InitialSessionState</a>.<a href="../../InitialSessionState.cs.html#4b58619a48805094" class="i method">CreateFromSessionConfigurationFile</a>(<span class="r337 r">configFilePath</span>, <span class="r327 r">validator</span>);
                <b>if</b> (<a href="#d304a97a9bb37b15" class="k">this</a>.<a href="#82b41cf49ed3782d" class="i property">Full</a>)
                {
                    <a href="../../cmdlet.cs.html#d3cfb6f38afe5ee0" class="i method">WriteObject</a>(<span class="r343 r">iss</span>);
                }
                <b>else</b>
                {
                    <b>using</b> (<a href="../../hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShellApi</a> <span id="r344 rd" class="r344 r">analyzer</span> = <a href="../../hostifaces/PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShellApi</a>.<a href="../../hostifaces/PowerShell.cs.html#f41a8c4815429c5e" class="i method">Create</a>(<span class="r343 r">iss</span>))
                    {
                        <span class="r344 r">analyzer</span>.<a href="../../hostifaces/PowerShell.cs.html#9cc79c297f6cced9" class="i method">AddCommand</a>(<span class="s">&quot;Get-Command&quot;</span>).<a href="../../hostifaces/PowerShell.cs.html#40674f99a3618f4b" class="i method">AddParameter</a>(<span class="s">&quot;CommandType&quot;</span>, <span class="s">&quot;All&quot;</span>);
                        <b>foreach</b> (<a href="../../MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r345 rd" class="r345 r">output</span> <b>in</b> <span class="r344 r">analyzer</span>.<a href="../../hostifaces/PowerShell.cs.html#184e23c46120523e" class="i method">Invoke</a>())
                        {
                            <a href="../../cmdlet.cs.html#d3cfb6f38afe5ee0" class="i method">WriteObject</a>(<span class="r345 r">output</span>);
                        }
                    }
                }
            }
        }
    }
 
    <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
}
 
<b>namespace</b> <span class="i n">Microsoft</span>.<span class="i n">PowerShell</span>.<span class="i n">Commands</span>.<span class="i n">Internal</span>
{
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> This class is public for implementation reasons only and should not be used.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>public static class</b> <a id="9066ca0caa1adb3e" href="../../../R/../../0000000000.html" target="n" data-glyph="0,0" class="t t">RemotingErrorResources</a>
    {
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public static string</b> <a id="58f2887b6948f105" href="../../../R/../../0000000000.html" target="n" data-glyph="102,1" class="i property">WinRMRestartWarning</a> { <b>get</b> { <b>return</b> <span class="i">RemotingErrorIdStrings</span>.<span class="i">WinRMRestartWarning</span>; } }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public static string</b> <a id="d13452a4fd0c6ed0" href="../../../R/../../0000000000.html" target="n" data-glyph="102,1" class="i property">CouldNotResolveRoleDefinitionPrincipal</a> { <b>get</b> { <b>return</b> <span class="i">RemotingErrorIdStrings</span>.<span class="i">CouldNotResolveRoleDefinitionPrincipal</span>; } }
    }
}
</pre></td></tr></table></div></body></html>
