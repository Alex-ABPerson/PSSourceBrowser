<!DOCTYPE html>
<html><head><title>WaitJob.cs</title><link rel="stylesheet" href="../../../../styles.css"><script src="../../../../scripts.js"></script></head>
<body class="cB" onload="i(438);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#System.Management.Automation/engine/remoting/commands/WaitJob.cs" target="_top">engine\remoting\commands\WaitJob.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#System.Management.Automation" target="_top">src\System.Management.Automation\System.Management.Automation.csproj</a> (System.Management.Automation)</td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation.</span>
<span class="c">// Licensed under the MIT License.</span>
 
<b>using</b> <span class="i n">System</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Collections</span>.<span class="i">Generic</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Diagnostics</span>.<span class="i">CodeAnalysis</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Linq</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Threading</span>;
 
<b>using</b> <span class="t">Dbg</span> = <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Diagnostics</a>;
 
<b>namespace</b> <span class="i n">Microsoft</span>.<span class="i n">PowerShell</span>.<span class="i n">Commands</span>
{
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> This cmdlet waits for job to complete.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    [<span class="i">Cmdlet</span>(<a href="../../../utils/Verbs.cs.html#1a8e85c66f6fff18" class="t t">VerbsLifecycle</a>.<a href="../../../utils/Verbs.cs.html#fafb4547d252c77c" class="i field">Wait</a>, <span class="s">&quot;Job&quot;</span>, <span class="i">DefaultParameterSetName</span> = <a href="RemoveJob.cs.html#6d4a842df78cbd2d" class="t t">JobCmdletBase</a>.<a href="RemoveJob.cs.html#5b871caa1267d529" class="i field">SessionIdParameterSet</a>, <span class="i">HelpUri</span> = <span class="s">&quot;https://go.microsoft.com/fwlink/?LinkID=2096902&quot;</span>)]
    [<span class="i">OutputType</span>(<b>typeof</b>(<a href="../client/Job.cs.html#e1ff43f6998863de" class="t t">Job</a>))]
    <b>public class</b> <a id="347cafad3166fb52" href="../../../R/347cafad3166fb52.html" target="n" data-glyph="0,0" class="t t"><span id="9fb54fdb64d2bcdf">WaitJobCommand</span></a> : <a href="RemoveJob.cs.html#6d4a842df78cbd2d" class="t t">JobCmdletBase</a>, <span class="i">IDisposable</span>
    {
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Parameters
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Specifies the Jobs objects which need to be</span>
        <span class="c">///</span><span class="c"> removed.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>(<a href="../../Attributes.cs.html#d5ad471518092731" class="i property">Mandatory</a> = <b>true</b>,
            <a href="../../Attributes.cs.html#19ccfeb1cdbdb967" class="i property">Position</a> = 0,
            <a href="../../Attributes.cs.html#4afbf5921ff6e967" class="i property">ValueFromPipeline</a> = <b>true</b>,
            <a href="../../Attributes.cs.html#aded474eaec9cde8" class="i property">ValueFromPipelineByPropertyName</a> = <b>true</b>,
            <a href="../../Attributes.cs.html#91bee819daab0925" class="i property">ParameterSetName</a> = <a href="RemoveJob.cs.html#61d072004a97a004" class="t t">RemoveJobCommand</a>.<a href="RemoveJob.cs.html#1d8e9765284b68f7" class="i field">JobParameterSet</a>)]
        [<span class="i">ValidateNotNullOrEmpty</span>]
        [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Performance&quot;</span>, <span class="s">&quot;CA1819:PropertiesShouldNotReturnArrays&quot;</span>)]
        <b>public</b> <a href="../client/Job.cs.html#e1ff43f6998863de" class="t t">Job</a>[] <a id="be79bd9acbd2acd4" href="../../../R/be79bd9acbd2acd4.html" target="n" data-glyph="102,1" class="i property">Job</a> { <b>get</b>; <b>set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Complete the cmdlet when any of the job is completed, instead of waiting for all of them to be completed.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>]
        <b>public</b> <a href="../../MshCmdlet.cs.html#8260026027378f6c" class="t t">SwitchParameter</a> <a id="bd55f97d18c120de" href="../../../R/bd55f97d18c120de.html" target="n" data-glyph="102,1" class="i property">Any</a> { <b>get</b>; <b>set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If timeout is specified, the cmdlet will only wait for this number of seconds.</span>
        <span class="c">///</span><span class="c"> Value of -1 means never timeout.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>]
        [<span class="i">Alias</span>(<span class="s">&quot;TimeoutSec&quot;</span>)]
        [<span class="i">ValidateRangeAttribute</span>(-1, <span class="i">Int32</span>.<span class="i">MaxValue</span>)]
        <b>public int</b> <a id="a6d838f132cd4f9a" href="../../../R/../../0000000000.html" target="n" data-glyph="102,1" class="i property">Timeout</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#1aa8e50204d7625f" class="i field">_timeoutInSeconds</a>;
            }
 
            <b>set</b>
            {
                <a href="#1aa8e50204d7625f" class="i field">_timeoutInSeconds</a> = <b>value</b>;
            }
        }
 
        <b>private int</b> <a id="1aa8e50204d7625f" href="../../../R/1aa8e50204d7625f.html" target="n" data-glyph="46,1" class="i field">_timeoutInSeconds</a> = -1; <span class="c">// -1: infinite, this default is to wait for as long as it takes.</span>
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Forces the cmdlet to wait for Finished states (Completed, Failed, Stopped) instead of</span>
        <span class="c">///</span><span class="c"> persistent states, which also include Suspended and Disconnected.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">Parameter</span>]
        <b>public</b> <a href="../../MshCmdlet.cs.html#8260026027378f6c" class="t t">SwitchParameter</a> <a id="355affcd471b3bfe" href="../../../R/355affcd471b3bfe.html" target="n" data-glyph="102,1" class="i property">Force</a> { <b>get</b>; <b>set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public override string</b>[] <a id="e12766ead5f65ce0" href="../../../R/e12766ead5f65ce0.html" target="n" data-glyph="102,1" class="i property">Command</a> { <b>get</b>; <b>set</b>; }
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Parameters
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Coordinating how different events (timeout, stopprocessing, job finished, job blocked) affect what happens in EndProcessing
 
        <b>private readonly object</b> <a id="2c5d505d7e10d96b" href="../../../R/2c5d505d7e10d96b.html" target="n" data-glyph="46,1" class="i field">_endProcessingActionLock</a> = <b>new</b> <b>object</b>();
        <b>private</b> <span class="i">Action</span> <a id="e4d8cf9a0a4e3e49" href="../../../R/e4d8cf9a0a4e3e49.html" target="n" data-glyph="46,1" class="i field">_endProcessingAction</a>;
        <b>private readonly</b> <span class="i">ManualResetEventSlim</span> <a id="b2f81b36485ec4b6" href="../../../R/b2f81b36485ec4b6.html" target="n" data-glyph="46,1" class="i field">_endProcessingActionIsReady</a> = <b>new</b> <span class="i">ManualResetEventSlim</span>(<b>false</b>);
 
        <b>private void</b> <a id="98d66a27a256d4d6" href="../../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">SetEndProcessingAction</a>(<span class="i">Action</span> <span id="r0 rd" class="r0 r">endProcessingAction</span>)
        {
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r0 r">endProcessingAction</span> != <b>null</b>, <span class="s">&quot;Caller should verify endProcessingAction != null&quot;</span>);
            <b>lock</b> (<a href="#2c5d505d7e10d96b" class="i field">_endProcessingActionLock</a>)
            {
                <b>if</b> (<a href="#e4d8cf9a0a4e3e49" class="i field">_endProcessingAction</a> == <b>null</b>)
                {
                    <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<span class="i">Assert</span>(!<a href="#b2f81b36485ec4b6" class="i field">_endProcessingActionIsReady</a>.<span class="i">IsSet</span>, <span class="s">&quot;This line should execute only once&quot;</span>);
                    <a href="#e4d8cf9a0a4e3e49" class="i field">_endProcessingAction</a> = <span class="r0 r">endProcessingAction</span>;
                    <a href="#b2f81b36485ec4b6" class="i field">_endProcessingActionIsReady</a>.<span class="i">Set</span>();
                }
            }
        }
 
        <b>private void</b> <a id="2ebb8e0b154431cc" href="../../../R/2ebb8e0b154431cc.html" target="n" data-glyph="76,1" class="i method">InvokeEndProcessingAction</a>()
        {
            <a href="#b2f81b36485ec4b6" class="i field">_endProcessingActionIsReady</a>.<span class="i">Wait</span>();
 
            <span class="i">Action</span> <span id="r1 rd" class="r1 r">endProcessingAction</span>;
            <b>lock</b> (<a href="#2c5d505d7e10d96b" class="i field">_endProcessingActionLock</a>)
            {
                <span class="r1 r">endProcessingAction</span> = <a href="#e4d8cf9a0a4e3e49" class="i field">_endProcessingAction</a>;
            }
 
            <span class="c">// Invoke action outside lock.</span>
            <span class="r1 r">endProcessingAction</span>?.<span class="i">Invoke</span>();
        }
 
        <b>private void</b> <a id="a5ffaf86216a47c1" href="../../../R/a5ffaf86216a47c1.html" target="n" data-glyph="76,1" class="i method">CleanUpEndProcessing</a>()
        {
            <a href="#b2f81b36485ec4b6" class="i field">_endProcessingActionIsReady</a>.<span class="i">Dispose</span>();
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Support for triggering EndProcessing when jobs are finished or blocked
 
        <b>private readonly</b> <span class="i">HashSet</span>&lt;<a href="../client/Job.cs.html#e1ff43f6998863de" class="t t">Job</a>&gt; <a id="9674cd8b76f40139" href="../../../R/9674cd8b76f40139.html" target="n" data-glyph="46,1" class="i field">_finishedJobs</a> = <b>new</b> <span class="i">HashSet</span>&lt;<a href="../client/Job.cs.html#e1ff43f6998863de" class="t t">Job</a>&gt;();
        <b>private readonly</b> <span class="i">HashSet</span>&lt;<a href="../client/Job.cs.html#e1ff43f6998863de" class="t t">Job</a>&gt; <a id="32896a3f9dccca91" href="../../../R/32896a3f9dccca91.html" target="n" data-glyph="46,1" class="i field">_blockedJobs</a> = <b>new</b> <span class="i">HashSet</span>&lt;<a href="../client/Job.cs.html#e1ff43f6998863de" class="t t">Job</a>&gt;();
        <b>private readonly</b> <span class="i">List</span>&lt;<a href="../client/Job.cs.html#e1ff43f6998863de" class="t t">Job</a>&gt; <a id="86f3701d62afd046" href="../../../R/86f3701d62afd046.html" target="n" data-glyph="46,1" class="i field">_jobsToWaitFor</a> = <b>new</b> <span class="i">List</span>&lt;<a href="../client/Job.cs.html#e1ff43f6998863de" class="t t">Job</a>&gt;();
        <b>private readonly object</b> <a id="5a307ee8c6465986" href="../../../R/5a307ee8c6465986.html" target="n" data-glyph="46,1" class="i field">_jobTrackingLock</a> = <b>new</b> <b>object</b>();
 
        <b>private void</b> <a id="da91434670d529fa" href="../../../R/da91434670d529fa.html" target="n" data-glyph="76,1" class="i method">HandleJobStateChangedEvent</a>(<b>object</b> <span id="r2 rd" class="r2 r">source</span>, <a href="../client/Job.cs.html#efe480d4e86a46d4" class="t t">JobStateEventArgs</a> <span id="r3 rd" class="r3 r">eventArgs</span>)
        {
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r2 r">source</span> <b>is</b> <a href="../client/Job.cs.html#e1ff43f6998863de" class="t t">Job</a>, <span class="s">&quot;Caller should verify source is Job&quot;</span>);
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r3 r">eventArgs</span> != <b>null</b>, <span class="s">&quot;Caller should verify eventArgs != null&quot;</span>);
 
            <a href="../client/Job.cs.html#e1ff43f6998863de" class="k">var</a> <span id="r4 rd" class="r4 r">job</span> = (<a href="../client/Job.cs.html#e1ff43f6998863de" class="t t">Job</a>)<span class="r2 r">source</span>;
            <b>lock</b> (<a href="#5a307ee8c6465986" class="i field">_jobTrackingLock</a>)
            {
                <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<span class="i">Assert</span>(<a href="#32896a3f9dccca91" class="i field">_blockedJobs</a>.<span class="i">All</span>(<span id="r5 rd" class="r5 r">j</span> =&gt; !<a href="#9674cd8b76f40139" class="i field">_finishedJobs</a>.<span class="i">Contains</span>(<span class="r5 r">j</span>)), <span class="s">&quot;Job cannot be in *both* _blockedJobs and _finishedJobs&quot;</span>);
 
                <b>if</b> (<span class="r3 r">eventArgs</span>.<a href="../client/Job.cs.html#7e34bf23c7781be3" class="i property">JobStateInfo</a>.<a href="../client/Job.cs.html#245057a5f4a9ed30" class="i property">State</a> == <a href="../client/Job.cs.html#fac7cdff9aee3e4f" class="t t">JobState</a>.<a href="../client/Job.cs.html#d73e45c1ea393a18" class="i field">Blocked</a>)
                {
                    <a href="#32896a3f9dccca91" class="i field">_blockedJobs</a>.<span class="i">Add</span>(<span class="r4 r">job</span>);
                }
                <b>else</b>
                {
                    <a href="#32896a3f9dccca91" class="i field">_blockedJobs</a>.<span class="i">Remove</span>(<span class="r4 r">job</span>);
                }
 
                <span class="c">// Treat jobs in Disconnected state as finished jobs since the user</span>
                <span class="c">// will have to reconnect the job before more information can be</span>
                <span class="c">// obtained.</span>
                <span class="c">// Suspended jobs require a Resume-Job call. Both of these states are persistent</span>
                <span class="c">// without user interaction.</span>
                <span class="c">// Wait should wait until a job is in a persistent state, OR if the force parameter</span>
                <span class="c">// is specified, until the job is in a finished state, which is a subset of</span>
                <span class="c">// persistent states.</span>
                <b>if</b> (!<a href="#355affcd471b3bfe" class="i property">Force</a> &amp;&amp; <span class="r4 r">job</span>.<a href="../client/Job.cs.html#431bfb528e72aa9f" class="i method">IsPersistentState</a>(<span class="r3 r">eventArgs</span>.<a href="../client/Job.cs.html#7e34bf23c7781be3" class="i property">JobStateInfo</a>.<a href="../client/Job.cs.html#245057a5f4a9ed30" class="i property">State</a>) || (<a href="#355affcd471b3bfe" class="i property">Force</a> &amp;&amp; <span class="r4 r">job</span>.<a href="../client/Job.cs.html#d7179d2607549d3b" class="i method">IsFinishedState</a>(<span class="r3 r">eventArgs</span>.<a href="../client/Job.cs.html#7e34bf23c7781be3" class="i property">JobStateInfo</a>.<a href="../client/Job.cs.html#245057a5f4a9ed30" class="i property">State</a>)))
                {
                    <b>if</b> (!<span class="r4 r">job</span>.<a href="../client/Job.cs.html#d7179d2607549d3b" class="i method">IsFinishedState</a>(<span class="r3 r">eventArgs</span>.<a href="../client/Job.cs.html#7e34bf23c7781be3" class="i property">JobStateInfo</a>.<a href="../client/Job.cs.html#245057a5f4a9ed30" class="i property">State</a>))
                    {
                        <a href="#bf76a18ee127b293" class="i field">_warnNotTerminal</a> = <b>true</b>;
                    }
 
                    <a href="#9674cd8b76f40139" class="i field">_finishedJobs</a>.<span class="i">Add</span>(<span class="r4 r">job</span>);
                }
                <b>else</b>
                {
                    <a href="#9674cd8b76f40139" class="i field">_finishedJobs</a>.<span class="i">Remove</span>(<span class="r4 r">job</span>);
                }
 
                <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<span class="i">Assert</span>(<a href="#32896a3f9dccca91" class="i field">_blockedJobs</a>.<span class="i">All</span>(<span id="r6 rd" class="r6 r">j</span> =&gt; !<a href="#9674cd8b76f40139" class="i field">_finishedJobs</a>.<span class="i">Contains</span>(<span class="r6 r">j</span>)), <span class="s">&quot;Job cannot be in *both* _blockedJobs and _finishedJobs&quot;</span>);
 
                <b>if</b> (<a href="#347cafad3166fb52" class="k">this</a>.<a href="#bd55f97d18c120de" class="i property">Any</a>.<a href="../../MshCmdlet.cs.html#e9c777a85700d3da" class="i property">IsPresent</a>)
                {
                    <b>if</b> (<a href="#9674cd8b76f40139" class="i field">_finishedJobs</a>.<span class="i">Count</span> &gt; 0)
                    {
                        <a href="#347cafad3166fb52" class="k">this</a>.<span class="i">SetEndProcessingAction</span>(<a href="#347cafad3166fb52" class="k">this</a>.<span class="i">EndProcessingOutputSingleFinishedJob</span>);
                    }
                    <b>else</b> <b>if</b> (<a href="#32896a3f9dccca91" class="i field">_blockedJobs</a>.<span class="i">Count</span> == <a href="#86f3701d62afd046" class="i field">_jobsToWaitFor</a>.<span class="i">Count</span>)
                    {
                        <a href="#347cafad3166fb52" class="k">this</a>.<span class="i">SetEndProcessingAction</span>(<a href="#347cafad3166fb52" class="k">this</a>.<span class="i">EndProcessingBlockedJobsError</span>);
                    }
                }
                <b>else</b>
                {
                    <b>if</b> (<a href="#9674cd8b76f40139" class="i field">_finishedJobs</a>.<span class="i">Count</span> == <a href="#86f3701d62afd046" class="i field">_jobsToWaitFor</a>.<span class="i">Count</span>)
                    {
                        <a href="#347cafad3166fb52" class="k">this</a>.<span class="i">SetEndProcessingAction</span>(<a href="#347cafad3166fb52" class="k">this</a>.<span class="i">EndProcessingOutputAllFinishedJobs</span>);
                    }
                    <b>else</b> <b>if</b> (<a href="#32896a3f9dccca91" class="i field">_blockedJobs</a>.<span class="i">Count</span> &gt; 0)
                    {
                        <a href="#347cafad3166fb52" class="k">this</a>.<span class="i">SetEndProcessingAction</span>(<a href="#347cafad3166fb52" class="k">this</a>.<span class="i">EndProcessingBlockedJobsError</span>);
                    }
                }
            }
        }
 
        <b>private void</b> <a id="d4c8892f7d646e55" href="../../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">AddJobsThatNeedJobChangesTracking</a>(<span class="i">IEnumerable</span>&lt;<a href="../client/Job.cs.html#e1ff43f6998863de" class="t t">Job</a>&gt; <span id="r7 rd" class="r7 r">jobsToAdd</span>)
        {
            <a href="../../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r7 r">jobsToAdd</span> != <b>null</b>, <span class="s">&quot;Caller should verify jobs != null&quot;</span>);
 
            <b>lock</b> (<a href="#5a307ee8c6465986" class="i field">_jobTrackingLock</a>)
            {
                <a href="#86f3701d62afd046" class="i field">_jobsToWaitFor</a>.<span class="i">AddRange</span>(<span class="r7 r">jobsToAdd</span>);
            }
        }
 
        <b>private void</b> <a id="457b88f8f03855e7" href="../../../R/457b88f8f03855e7.html" target="n" data-glyph="76,1" class="i method">StartJobChangesTracking</a>()
        {
            <b>lock</b> (<a href="#5a307ee8c6465986" class="i field">_jobTrackingLock</a>)
            {
                <b>if</b> (<a href="#86f3701d62afd046" class="i field">_jobsToWaitFor</a>.<span class="i">Count</span> == 0)
                {
                    <a href="#347cafad3166fb52" class="k">this</a>.<span class="i">SetEndProcessingAction</span>(<a href="#347cafad3166fb52" class="k">this</a>.<span class="i">EndProcessingDoNothing</span>);
                    <b>return</b>;
                }
 
                <b>foreach</b> (<a href="../client/Job.cs.html#e1ff43f6998863de" class="t t">Job</a> <span id="r8 rd" class="r8 r">job</span> <b>in</b> <a href="#86f3701d62afd046" class="i field">_jobsToWaitFor</a>)
                {
                    <span class="r8 r">job</span>.<a href="../client/Job.cs.html#a099819afc059aeb" class="i">StateChanged</a> += <a href="#347cafad3166fb52" class="k">this</a>.<span class="i">HandleJobStateChangedEvent</span>;
                    <a href="#347cafad3166fb52" class="k">this</a>.<a href="#da91434670d529fa" class="i method">HandleJobStateChangedEvent</a>(<span class="r8 r">job</span>, <b>new</b> <a href="../client/Job.cs.html#541d6111289d0acf" class="t constructor">JobStateEventArgs</a>(<span class="r8 r">job</span>.<a href="../client/Job.cs.html#896d1d1f27daae5f" class="i property">JobStateInfo</a>));
                }
            }
        }
 
        <b>private void</b> <a id="c74aaf04fb587238" href="../../../R/c74aaf04fb587238.html" target="n" data-glyph="76,1" class="i method">CleanUpJobChangesTracking</a>()
        {
            <b>lock</b> (<a href="#5a307ee8c6465986" class="i field">_jobTrackingLock</a>)
            {
                <b>foreach</b> (<a href="../client/Job.cs.html#e1ff43f6998863de" class="t t">Job</a> <span id="r9 rd" class="r9 r">job</span> <b>in</b> <a href="#86f3701d62afd046" class="i field">_jobsToWaitFor</a>)
                {
                    <span class="r9 r">job</span>.<a href="../client/Job.cs.html#a099819afc059aeb" class="i">StateChanged</a> -= <a href="#347cafad3166fb52" class="k">this</a>.<span class="i">HandleJobStateChangedEvent</span>;
                }
            }
        }
 
        <b>private</b> <span class="i">List</span>&lt;<a href="../client/Job.cs.html#e1ff43f6998863de" class="t t">Job</a>&gt; <a id="f853c21b90613e7b" href="../../../R/f853c21b90613e7b.html" target="n" data-glyph="76,1" class="i method">GetFinishedJobs</a>()
        {
            <span class="i">List</span>&lt;<a href="../client/Job.cs.html#e1ff43f6998863de" class="t t">Job</a>&gt; <span id="r10 rd" class="r10 r">jobsToOutput</span>;
            <b>lock</b> (<a href="#5a307ee8c6465986" class="i field">_jobTrackingLock</a>)
            {
                <span class="r10 r">jobsToOutput</span> = <a href="#86f3701d62afd046" class="i field">_jobsToWaitFor</a>.<span class="i">Where</span>(<span id="r11 rd" class="r11 r">j</span> =&gt; ((!<a href="#355affcd471b3bfe" class="i property">Force</a> &amp;&amp; <span class="r11 r">j</span>.<span class="i">IsPersistentState</span>(<span class="r11 r">j</span>.<span class="i">JobStateInfo</span>.<span class="i">State</span>)) || (<a href="#355affcd471b3bfe" class="i property">Force</a> &amp;&amp; <span class="r11 r">j</span>.<span class="i">IsFinishedState</span>(<span class="r11 r">j</span>.<span class="i">JobStateInfo</span>.<span class="i">State</span>)))).<span class="i">ToList</span>();
            }
 
            <b>return</b> <span class="r10 r">jobsToOutput</span>;
        }
 
        <b>private</b> <a href="../client/Job.cs.html#e1ff43f6998863de" class="t t">Job</a> <a id="a64867c9838c1907" href="../../../R/a64867c9838c1907.html" target="n" data-glyph="76,1" class="i method">GetOneBlockedJob</a>()
        {
            <b>lock</b> (<a href="#5a307ee8c6465986" class="i field">_jobTrackingLock</a>)
            {
                <b>return</b> <a href="#86f3701d62afd046" class="i field">_jobsToWaitFor</a>.<span class="i">Find</span>(<b>static</b> <span id="r12 rd" class="r12 r">j</span> =&gt; <span class="r12 r">j</span>.<span class="i">JobStateInfo</span>.<span class="i">State</span> == <a href="../client/Job.cs.html#fac7cdff9aee3e4f" class="t t">JobState</a>.<a href="../client/Job.cs.html#d73e45c1ea393a18" class="i field">Blocked</a>);
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Support for triggering EndProcessing when timing out
 
        <b>private</b> <span class="i">Timer</span> <a id="8331adc138c17c61" href="../../../R/8331adc138c17c61.html" target="n" data-glyph="46,1" class="i field">_timer</a>;
        <b>private readonly object</b> <a id="dab5a8c4b757e476" href="../../../R/dab5a8c4b757e476.html" target="n" data-glyph="46,1" class="i field">_timerLock</a> = <b>new</b> <b>object</b>();
 
        <b>private void</b> <a id="5192471de118ff60" href="../../../R/5192471de118ff60.html" target="n" data-glyph="76,1" class="i method">StartTimeoutTracking</a>(<b>int</b> <span id="r13 rd" class="r13 r">timeoutInSeconds</span>)
        {
            <b>if</b> (<span class="r13 r">timeoutInSeconds</span> == 0)
            {
                <a href="#347cafad3166fb52" class="k">this</a>.<span class="i">SetEndProcessingAction</span>(<a href="#347cafad3166fb52" class="k">this</a>.<span class="i">EndProcessingDoNothing</span>);
            }
            <b>else</b> <b>if</b> (<span class="r13 r">timeoutInSeconds</span> &gt; 0)
            {
                <b>lock</b> (<a href="#dab5a8c4b757e476" class="i field">_timerLock</a>)
                {
                    <a href="#8331adc138c17c61" class="i field">_timer</a> = <b>new</b> <span class="i">Timer</span>((<span id="r14 rd" class="r14 r">_</span>) =&gt; <a href="#347cafad3166fb52" class="k">this</a>.<span class="i">SetEndProcessingAction</span>(<a href="#347cafad3166fb52" class="k">this</a>.<span class="i">EndProcessingDoNothing</span>), <b>null</b>, <span class="r13 r">timeoutInSeconds</span> * 1000, <span class="i n">System</span>.<span class="i">Threading</span>.<span class="i">Timeout</span>.<span class="i">Infinite</span>);
                }
            }
        }
 
        <b>private void</b> <a id="d43274b9da1e4b54" href="../../../R/d43274b9da1e4b54.html" target="n" data-glyph="76,1" class="i method">CleanUpTimeoutTracking</a>()
        {
            <b>lock</b> (<a href="#dab5a8c4b757e476" class="i field">_timerLock</a>)
            {
                <b>if</b> (<a href="#8331adc138c17c61" class="i field">_timer</a> != <b>null</b>)
                {
                    <a href="#8331adc138c17c61" class="i field">_timer</a>.<span class="i">Dispose</span>();
                    <a href="#8331adc138c17c61" class="i field">_timer</a> = <b>null</b>;
                }
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Overrides
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Cancel the Wait-Job cmdlet.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>protected override void</b> <a id="01cdeffd754782a6" href="../../../R/01cdeffd754782a6.html" target="n" data-glyph="75,1" class="i method">StopProcessing</a>()
        {
            <a href="#347cafad3166fb52" class="k">this</a>.<span class="i">SetEndProcessingAction</span>(<a href="#347cafad3166fb52" class="k">this</a>.<span class="i">EndProcessingDoNothing</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> In this method, we initialize the timer if timeout parameter is specified.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>protected override void</b> <a id="f5b93c0775c9442f" href="../../../R/f5b93c0775c9442f.html" target="n" data-glyph="75,1" class="i method">BeginProcessing</a>()
        {
            <a href="#347cafad3166fb52" class="k">this</a>.<a href="#5192471de118ff60" class="i method">StartTimeoutTracking</a>(<a href="#1aa8e50204d7625f" class="i field">_timeoutInSeconds</a>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This method just collects the Jobs which will be waited on in the EndProcessing method.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>protected override void</b> <a id="3f7b22e04a8a4734" href="../../../R/3f7b22e04a8a4734.html" target="n" data-glyph="75,1" class="i method">ProcessRecord</a>()
        {
            <span class="c">// List of jobs to wait</span>
            <span class="i">List</span>&lt;<a href="../client/Job.cs.html#e1ff43f6998863de" class="t t">Job</a>&gt; <span id="r15 rd" class="r15 r">matches</span>;
 
            <b>switch</b> (<a href="../../MshCmdlet.cs.html#f1ecb7c30328d049" class="i property">ParameterSetName</a>)
            {
                <b>case</b> <a href="RemoveJob.cs.html#f6461d28caff9c5c" class="i field">NameParameterSet</a>:
                    <span class="r15 r">matches</span> = <a href="RemoveJob.cs.html#f951c3eecc4e85e0" class="i method">FindJobsMatchingByName</a>(<b>true</b>, <b>false</b>, <b>true</b>, <b>false</b>);
                    <b>break</b>;
 
                <b>case</b> <a href="RemoveJob.cs.html#b9fcc6d73680e09f" class="i field">InstanceIdParameterSet</a>:
                    <span class="r15 r">matches</span> = <a href="RemoveJob.cs.html#faea27dc9874c464" class="i method">FindJobsMatchingByInstanceId</a>(<b>true</b>, <b>false</b>, <b>true</b>, <b>false</b>);
                    <b>break</b>;
 
                <b>case</b> <a href="RemoveJob.cs.html#5b871caa1267d529" class="i field">SessionIdParameterSet</a>:
                    <span class="r15 r">matches</span> = <a href="RemoveJob.cs.html#1bcdf7b70be6c851" class="i method">FindJobsMatchingBySessionId</a>(<b>true</b>, <b>false</b>, <b>true</b>, <b>false</b>);
                    <b>break</b>;
 
                <b>case</b> <a href="RemoveJob.cs.html#d0202bf60680c003" class="i field">StateParameterSet</a>:
                    <span class="r15 r">matches</span> = <a href="RemoveJob.cs.html#ac0b99f23202da2f" class="i method">FindJobsMatchingByState</a>(<b>false</b>);
                    <b>break</b>;
 
                <b>case</b> <a href="RemoveJob.cs.html#68ab1e0e7742703e" class="i field">FilterParameterSet</a>:
                    <span class="r15 r">matches</span> = <a href="RemoveJob.cs.html#53b57784e4b5b29c" class="i method">FindJobsMatchingByFilter</a>(<b>false</b>);
                    <b>break</b>;
 
                <b>default</b>:
                    <span class="r15 r">matches</span> = <a href="RemoveJob.cs.html#04e45c0550b343e8" class="i method">CopyJobsToList</a>(<a href="#347cafad3166fb52" class="k">this</a>.<a href="#be79bd9acbd2acd4" class="i property">Job</a>, <b>false</b>, <b>false</b>);
                    <b>break</b>;
            }
 
            <a href="#347cafad3166fb52" class="k">this</a>.<span class="i">AddJobsThatNeedJobChangesTracking</span>(<span class="r15 r">matches</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Wait on the collected Jobs.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>protected override void</b> <a id="cb454c6bc9b68abc" href="../../../R/cb454c6bc9b68abc.html" target="n" data-glyph="75,1" class="i method">EndProcessing</a>()
        {
            <a href="#347cafad3166fb52" class="k">this</a>.<a href="#457b88f8f03855e7" class="i method">StartJobChangesTracking</a>();
            <a href="#347cafad3166fb52" class="k">this</a>.<a href="#2ebb8e0b154431cc" class="i method">InvokeEndProcessingAction</a>();
            <b>if</b> (<a href="#bf76a18ee127b293" class="i field">_warnNotTerminal</a>)
            {
                <span class="i">WriteWarning</span>(<span class="i">RemotingErrorIdStrings</span>.<span class="i">JobSuspendedDisconnectedWaitWithForce</span>);
            }
        }
 
        <b>private void</b> <a id="f2864bc720c51bf6" href="../../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">EndProcessingOutputSingleFinishedJob</a>()
        {
            <a href="../client/Job.cs.html#e1ff43f6998863de" class="t t">Job</a> <span id="r16 rd" class="r16 r">finishedJob</span> = <a href="#347cafad3166fb52" class="k">this</a>.<a href="#f853c21b90613e7b" class="i method">GetFinishedJobs</a>().<span class="i">FirstOrDefault</span>();
            <b>if</b> (<span class="r16 r">finishedJob</span> != <b>null</b>)
            {
                <a href="#347cafad3166fb52" class="k">this</a>.<a href="../../cmdlet.cs.html#d3cfb6f38afe5ee0" class="i method">WriteObject</a>(<span class="r16 r">finishedJob</span>);
            }
        }
 
        <b>private void</b> <a id="bdd4a13691bc7f26" href="../../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">EndProcessingOutputAllFinishedJobs</a>()
        {
            <span class="i">IEnumerable</span>&lt;<a href="../client/Job.cs.html#e1ff43f6998863de" class="t t">Job</a>&gt; <span id="r17 rd" class="r17 r">finishedJobs</span> = <a href="#347cafad3166fb52" class="k">this</a>.<a href="#f853c21b90613e7b" class="i method">GetFinishedJobs</a>();
            <b>foreach</b> (<a href="../client/Job.cs.html#e1ff43f6998863de" class="t t">Job</a> <span id="r18 rd" class="r18 r">finishedJob</span> <b>in</b> <span class="r17 r">finishedJobs</span>)
            {
                <a href="#347cafad3166fb52" class="k">this</a>.<a href="../../cmdlet.cs.html#d3cfb6f38afe5ee0" class="i method">WriteObject</a>(<span class="r18 r">finishedJob</span>);
            }
        }
 
        <b>private void</b> <a id="713ab60ff140bbe4" href="../../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">EndProcessingBlockedJobsError</a>()
        {
            <b>string</b> <span id="r19 rd" class="r19 r">message</span> = <span class="i">RemotingErrorIdStrings</span>.<span class="i">JobBlockedSoWaitJobCannotContinue</span>;
            <span class="i">Exception</span> <span id="r20 rd" class="r20 r">exception</span> = <b>new</b> <span class="i">ArgumentException</span>(<span class="r19 r">message</span>);
            <a href="../../ErrorPackage.cs.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r21 rd" class="r21 r">errorRecord</span> = <b>new</b> <a href="../../ErrorPackage.cs.html#e9334565e5136f43" class="t constructor">ErrorRecord</a>(
                <span class="r20 r">exception</span>,
                <span class="s">&quot;BlockedJobsDeadlockWithWaitJob&quot;</span>,
                <a href="../../ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../../ErrorPackage.cs.html#167e6c3507b9e2a6" class="i field">DeadlockDetected</a>,
                <a href="#347cafad3166fb52" class="k">this</a>.<a href="#a64867c9838c1907" class="i method">GetOneBlockedJob</a>());
            <a href="#347cafad3166fb52" class="k">this</a>.<a href="../../cmdlet.cs.html#e3346d70990a1763" class="i method">ThrowTerminatingError</a>(<span class="r21 r">errorRecord</span>);
        }
 
        <b>private void</b> <a id="f9f0e5778a1f1a64" href="../../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">EndProcessingDoNothing</a>()
        {
            <span class="c">// do nothing</span>
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Overrides
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> IDisposable Members
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Dispose all managed resources. This will suppress finalizer on the object from getting called by</span>
        <span class="c">///</span><span class="c"> calling System.GC.SuppressFinalize(this).</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public void</b> <a id="aba09826fc94c667" href="../../../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">Dispose</a>()
        {
            <a href="#f4e90fc70440098a" class="i method">Dispose</a>(<b>true</b>);
            <span class="c">// To prevent derived types with finalizers from having to re-implement System.IDisposable to call it,</span>
            <span class="c">// unsealed types without finalizers should still call SuppressFinalize.</span>
            <span class="i n">System</span>.<span class="i">GC</span>.<span class="i">SuppressFinalize</span>(<a href="#347cafad3166fb52" class="k">this</a>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Release all the resources.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r22 r">disposing</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> if true, release all the managed objects.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>private void</b> <a id="f4e90fc70440098a" href="../../../R/f4e90fc70440098a.html" target="n" data-glyph="76,1" class="i method">Dispose</a>(<b>bool</b> <span id="r22 rd" class="r22 r">disposing</span>)
        {
            <b>if</b> (<span class="r22 r">disposing</span>)
            {
                <b>lock</b> (<a href="#3578b25504394ed4" class="i field">_disposableLock</a>)
                {
                    <b>if</b> (!<a href="#371fad60c17741bf" class="i field">_isDisposed</a>)
                    {
                        <a href="#371fad60c17741bf" class="i field">_isDisposed</a> = <b>true</b>;
 
                        <a href="#347cafad3166fb52" class="k">this</a>.<a href="#d43274b9da1e4b54" class="i method">CleanUpTimeoutTracking</a>();
                        <a href="#347cafad3166fb52" class="k">this</a>.<a href="#c74aaf04fb587238" class="i method">CleanUpJobChangesTracking</a>();
                        <a href="#347cafad3166fb52" class="k">this</a>.<a href="#a5ffaf86216a47c1" class="i method">CleanUpEndProcessing</a>(); <span class="c">// &lt;- has to be last</span>
                    }
                }
            }
        }
 
        <b>private bool</b> <a id="371fad60c17741bf" href="../../../R/371fad60c17741bf.html" target="n" data-glyph="46,1" class="i field">_isDisposed</a>;
        <b>private readonly object</b> <a id="3578b25504394ed4" href="../../../R/3578b25504394ed4.html" target="n" data-glyph="46,1" class="i field">_disposableLock</a> = <b>new</b> <b>object</b>();
        <b>private bool</b> <a id="bf76a18ee127b293" href="../../../R/bf76a18ee127b293.html" target="n" data-glyph="46,1" class="i field">_warnNotTerminal</a> = <b>false</b>;
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> IDisposable Members
    }
}
</pre></td></tr></table></div></body></html>
