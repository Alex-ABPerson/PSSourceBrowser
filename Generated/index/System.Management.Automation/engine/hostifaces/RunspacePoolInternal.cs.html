<!DOCTYPE html>
<html><head><title>RunspacePoolInternal.cs</title><link rel="stylesheet" href="../../../styles.css"><script src="../../../scripts.js"></script></head>
<body class="cB" onload="i(1663);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#System.Management.Automation/engine/hostifaces/RunspacePoolInternal.cs" target="_top">engine\hostifaces\RunspacePoolInternal.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#System.Management.Automation" target="_top">src\System.Management.Automation\System.Management.Automation.csproj</a> (System.Management.Automation)</td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation.</span>
<span class="c">// Licensed under the MIT License.</span>
 
<b>using</b> <span class="i n">System</span>.<span class="i">Collections</span>.<span class="i">Generic</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Collections</span>.<span class="i">ObjectModel</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Internal</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Security</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Tracing</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Threading</span>;
 
<b>using</b> <span class="t">Dbg</span> = <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="../../utils/assert.cs.html#c04955255430d32f" class="t t">Diagnostics</a>;
<b>using</b> <span class="t">PSHost</span> = <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Host</span>.<a href="MshHost.cs.html#7b79cd90e035740e" class="t t">PSHost</a>;
 
<b>namespace</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Runspaces</span>.<span class="i n">Internal</span>
{
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Class which supports pooling local powerShell runspaces.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>internal class</b> <a id="f2c8813b33dfca3f" href="../../R/f2c8813b33dfca3f.html" target="n" data-glyph="2,0" class="t t">RunspacePoolInternal</a>
    {
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Private data
 
        <b>protected int</b> <a id="eb45e1e66196a2b6" href="../../R/eb45e1e66196a2b6.html" target="n" data-glyph="45,1" class="i field">maxPoolSz</a>;
        <b>protected int</b> <a id="f6fb1db5180e27f3" href="../../R/f6fb1db5180e27f3.html" target="n" data-glyph="45,1" class="i field">minPoolSz</a>;
        <span class="c">// we need total active runspaces to avoid lock() statements everywhere</span>
        <b>protected int</b> <a id="d44d1efc92d291e9" href="../../R/d44d1efc92d291e9.html" target="n" data-glyph="45,1" class="i field">totalRunspaces</a>;
        <b>protected</b> <span class="i">List</span>&lt;<a href="Connection.cs.html#7e5b8eab1aa16fd7" class="t t">Runspace</a>&gt; <a id="43b18ffe73b89022" href="../../R/43b18ffe73b89022.html" target="n" data-glyph="45,1" class="i field">runspaceList</a> = <b>new</b> <span class="i">List</span>&lt;<a href="Connection.cs.html#7e5b8eab1aa16fd7" class="t t">Runspace</a>&gt;(); <span class="c">// info of all the runspaces in the pool.</span>
        <b>protected</b> <span class="i">Stack</span>&lt;<a href="Connection.cs.html#7e5b8eab1aa16fd7" class="t t">Runspace</a>&gt; <a id="86e97148ee0b7b2e" href="../../R/86e97148ee0b7b2e.html" target="n" data-glyph="45,1" class="i field">pool</a>; <span class="c">// stack of runspaces that are available.</span>
        <b>protected</b> <span class="i">Queue</span>&lt;<a href="RunspacePool.cs.html#f9f1d68e9fc0927c" class="t t">GetRunspaceAsyncResult</a>&gt; <a id="0b6c810cd4215eae" href="../../R/0b6c810cd4215eae.html" target="n" data-glyph="45,1" class="i field">runspaceRequestQueue</a>; <span class="c">// request queue.</span>
        <span class="c">// let requesters request on the runspaceRequestQueue..internally</span>
        <span class="c">// pool services on this queue.</span>
        <b>protected</b> <span class="i">Queue</span>&lt;<a href="RunspacePool.cs.html#f9f1d68e9fc0927c" class="t t">GetRunspaceAsyncResult</a>&gt; <a id="4f2590b152f5c1d3" href="../../R/4f2590b152f5c1d3.html" target="n" data-glyph="45,1" class="i field">ultimateRequestQueue</a>;
        <b>protected</b> <a href="../remoting/common/RunspacePoolStateInfo.cs.html#8b9143609d7a0363" class="t t">RunspacePoolStateInfo</a> <a id="37ed160e0fbfb67a" href="../../R/37ed160e0fbfb67a.html" target="n" data-glyph="45,1" class="i field">stateInfo</a>;
        <b>protected</b> <a href="../InitialSessionState.cs.html#b17f88d4755d5fd7" class="t t">InitialSessionState</a> <a id="62f65112c30c27b2" href="../../R/62f65112c30c27b2.html" target="n" data-glyph="45,1" class="i field">_initialSessionState</a>;
        <b>protected</b> <a href="MshHost.cs.html#7b79cd90e035740e" class="t t">PSHost</a> <a id="ceb434f916bd07a3" href="../../R/ceb434f916bd07a3.html" target="n" data-glyph="45,1" class="i field">host</a>;
        <b>protected</b> <span class="i">Guid</span> <a id="0d2daf8b32a561fc" href="../../R/0d2daf8b32a561fc.html" target="n" data-glyph="45,1" class="i field">instanceId</a>;
        <b>private bool</b> <a id="bc96f6a41dc93ca4" href="../../R/bc96f6a41dc93ca4.html" target="n" data-glyph="46,1" class="i field">_isDisposed</a>;
        <b>protected bool</b> <a id="277a81a88eb2f671" href="../../R/277a81a88eb2f671.html" target="n" data-glyph="45,1" class="i field">isServicingRequests</a>;
        <b>protected object</b> <a id="21db200b449932ac" href="../../R/21db200b449932ac.html" target="n" data-glyph="45,1" class="i field">syncObject</a> = <b>new</b> <b>object</b>();
 
        <b>private static readonly</b> <span class="i">TimeSpan</span> <a id="d88f99945ef67056" href="../../R/d88f99945ef67056.html" target="n" data-glyph="46,1" class="i field">s_defaultCleanupPeriod</a> = <b>new</b> <span class="i">TimeSpan</span>(0, 15, 0);   <span class="c">// 15 minutes.</span>
        <b>private</b> <span class="i">TimeSpan</span> <a id="3183719ab57b7be7" href="../../R/3183719ab57b7be7.html" target="n" data-glyph="46,1" class="i field">_cleanupInterval</a>;
        <b>private readonly</b> <span class="i">Timer</span> <a id="563d49ceba80af5d" href="../../R/563d49ceba80af5d.html" target="n" data-glyph="46,1" class="i field">_cleanupTimer</a>;
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Constructor
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Constructor which creates a RunspacePool using the</span>
        <span class="c">///</span><span class="c"> supplied </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="i">configuration</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c">, </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r0 r">minRunspaces</span><span class="c">&quot;</span><span class="c">/&gt;</span>
        <span class="c">///</span><span class="c"> and </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r1 r">maxRunspaces</span><span class="c">&quot;</span><span class="c">/&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r1 r">maxRunspaces</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The maximum number of Runspaces that can exist in this pool.</span>
        <span class="c">///</span><span class="c"> Should be greater than or equal to 1.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r0 r">minRunspaces</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The minimum number of Runspaces that can exist in this pool.</span>
        <span class="c">///</span><span class="c"> Should be greater than or equal to 1.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r2 r">host</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The explicit PSHost implementation.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">ArgumentNullException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Host is null.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">ArgumentException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Maximum runspaces is less than 1.</span>
        <span class="c">///</span><span class="c"> Minimum runspaces is less than 1.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>public</b> <a id="9a8ea17675409c3f" href="../../R/9a8ea17675409c3f.html" target="n" data-glyph="72,1" class="t constructor">RunspacePoolInternal</a>(<b>int</b> <span id="r0 rd" class="r0 r">minRunspaces</span>,
                <b>int</b> <span id="r1 rd" class="r1 r">maxRunspaces</span>,
                <a href="MshHost.cs.html#7b79cd90e035740e" class="t t">PSHost</a> <span id="r2 rd" class="r2 r">host</span>)
            : <a href="#d5847b3987568f15" class="k">this</a>(<span class="r0 r">minRunspaces</span>, <span class="r1 r">maxRunspaces</span>)
        {
            <b>if</b> (<span class="r2 r">host</span> == <b>null</b>)
            {
                <b>throw</b> <a href="../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../../utils/MshTraceSource.cs.html#fbe67220ad7522a0" class="i method">NewArgumentNullException</a>(<b>nameof</b>(<span class="r2 r">host</span>));
            }
 
            <a href="#f2c8813b33dfca3f" class="k">this</a>.<a href="#ceb434f916bd07a3" class="i field">host</a> = <span class="r2 r">host</span>;
            <a href="#86e97148ee0b7b2e" class="i field">pool</a> = <b>new</b> <span class="i">Stack</span>&lt;<a href="Connection.cs.html#7e5b8eab1aa16fd7" class="t t">Runspace</a>&gt;();
            <a href="#0b6c810cd4215eae" class="i field">runspaceRequestQueue</a> = <b>new</b> <span class="i">Queue</span>&lt;<a href="RunspacePool.cs.html#f9f1d68e9fc0927c" class="t t">GetRunspaceAsyncResult</a>&gt;();
            <a href="#4f2590b152f5c1d3" class="i field">ultimateRequestQueue</a> = <b>new</b> <span class="i">Queue</span>&lt;<a href="RunspacePool.cs.html#f9f1d68e9fc0927c" class="t t">GetRunspaceAsyncResult</a>&gt;();
            <a href="#62f65112c30c27b2" class="i field">_initialSessionState</a> = <a href="../InitialSessionState.cs.html#b17f88d4755d5fd7" class="t t">InitialSessionState</a>.<a href="../InitialSessionState.cs.html#212e45c73accc163" class="i method">CreateDefault</a>();
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Constructor which creates a RunspacePool using the</span>
        <span class="c">///</span><span class="c"> supplied </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="i">configuration</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c">, </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r3 r">minRunspaces</span><span class="c">&quot;</span><span class="c">/&gt;</span>
        <span class="c">///</span><span class="c"> and </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r4 r">maxRunspaces</span><span class="c">&quot;</span><span class="c">/&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r5 r">initialSessionState</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> InitialSessionState to use when creating a new Runspace.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r4 r">maxRunspaces</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The maximum number of Runspaces that can exist in this pool.</span>
        <span class="c">///</span><span class="c"> Should be greater than or equal to 1.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r3 r">minRunspaces</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The minimum number of Runspaces that can exist in this pool.</span>
        <span class="c">///</span><span class="c"> Should be greater than or equal to 1.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r6 r">host</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The explicit PSHost implementation.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">ArgumentNullException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> initialSessionState is null.</span>
        <span class="c">///</span><span class="c"> Host is null.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">ArgumentException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Maximum runspaces is less than 1.</span>
        <span class="c">///</span><span class="c"> Minimum runspaces is less than 1.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>public</b> <a id="7790ba5b4da811ef" href="../../R/7790ba5b4da811ef.html" target="n" data-glyph="72,1" class="t constructor">RunspacePoolInternal</a>(<b>int</b> <span id="r3 rd" class="r3 r">minRunspaces</span>,
                <b>int</b> <span id="r4 rd" class="r4 r">maxRunspaces</span>,
                <a href="../InitialSessionState.cs.html#b17f88d4755d5fd7" class="t t">InitialSessionState</a> <span id="r5 rd" class="r5 r">initialSessionState</span>,
                <a href="MshHost.cs.html#7b79cd90e035740e" class="t t">PSHost</a> <span id="r6 rd" class="r6 r">host</span>)
            : <a href="#d5847b3987568f15" class="k">this</a>(<span class="r3 r">minRunspaces</span>, <span class="r4 r">maxRunspaces</span>)
        {
            <b>if</b> (<span class="r5 r">initialSessionState</span> == <b>null</b>)
            {
                <b>throw</b> <a href="../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../../utils/MshTraceSource.cs.html#fbe67220ad7522a0" class="i method">NewArgumentNullException</a>(<b>nameof</b>(<span class="r5 r">initialSessionState</span>));
            }
 
            <b>if</b> (<span class="r6 r">host</span> == <b>null</b>)
            {
                <b>throw</b> <a href="../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../../utils/MshTraceSource.cs.html#fbe67220ad7522a0" class="i method">NewArgumentNullException</a>(<b>nameof</b>(<span class="r6 r">host</span>));
            }
 
            <a href="#62f65112c30c27b2" class="i field">_initialSessionState</a> = <span class="r5 r">initialSessionState</span>.<a href="../InitialSessionState.cs.html#9976cba0f7f0ac54" class="i method">Clone</a>();
            <a href="#f2c8813b33dfca3f" class="k">this</a>.<a href="#ceb434f916bd07a3" class="i field">host</a> = <span class="r6 r">host</span>;
            <a href="#3617244356b991d3" class="i property">ThreadOptions</a> = <span class="r5 r">initialSessionState</span>.<a href="../InitialSessionState.cs.html#2496a3df8744996f" class="i property">ThreadOptions</a>;
            <a href="#f2c8813b33dfca3f" class="k">this</a>.<a href="#3f9f0d0f8dd1c807" class="i property">ApartmentState</a> = <span class="r5 r">initialSessionState</span>.<a href="../InitialSessionState.cs.html#640e70a6a98fabbf" class="i property">ApartmentState</a>;
            <a href="#86e97148ee0b7b2e" class="i field">pool</a> = <b>new</b> <span class="i">Stack</span>&lt;<a href="Connection.cs.html#7e5b8eab1aa16fd7" class="t t">Runspace</a>&gt;();
            <a href="#0b6c810cd4215eae" class="i field">runspaceRequestQueue</a> = <b>new</b> <span class="i">Queue</span>&lt;<a href="RunspacePool.cs.html#f9f1d68e9fc0927c" class="t t">GetRunspaceAsyncResult</a>&gt;();
            <a href="#4f2590b152f5c1d3" class="i field">ultimateRequestQueue</a> = <b>new</b> <span class="i">Queue</span>&lt;<a href="RunspacePool.cs.html#f9f1d68e9fc0927c" class="t t">GetRunspaceAsyncResult</a>&gt;();
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Constructor for doing common initialization between</span>
        <span class="c">///</span><span class="c"> this class and its derivatives.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r7 r">maxRunspaces</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The maximum number of Runspaces that can exist in this pool.</span>
        <span class="c">///</span><span class="c"> Should be greater than or equal to 1.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r8 r">minRunspaces</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The minimum number of Runspaces that can exist in this pool.</span>
        <span class="c">///</span><span class="c"> Should be greater than or equal to 1.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>protected</b> <a id="d5847b3987568f15" href="../../R/d5847b3987568f15.html" target="n" data-glyph="75,1" class="t constructor">RunspacePoolInternal</a>(<b>int</b> <span id="r8 rd" class="r8 r">minRunspaces</span>, <b>int</b> <span id="r7 rd" class="r7 r">maxRunspaces</span>)
        {
            <b>if</b> (<span class="r7 r">maxRunspaces</span> &lt; 1)
            {
                <b>throw</b> <a href="../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<span class="i">NewArgumentException</span>(<b>nameof</b>(<span class="r7 r">maxRunspaces</span>), <span class="i">RunspacePoolStrings</span>.<span class="i">MaxPoolLessThan1</span>);
            }
 
            <b>if</b> (<span class="r8 r">minRunspaces</span> &lt; 1)
            {
                <b>throw</b> <a href="../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<span class="i">NewArgumentException</span>(<b>nameof</b>(<span class="r8 r">minRunspaces</span>), <span class="i">RunspacePoolStrings</span>.<span class="i">MinPoolLessThan1</span>);
            }
 
            <b>if</b> (<span class="r8 r">minRunspaces</span> &gt; <span class="r7 r">maxRunspaces</span>)
            {
                <b>throw</b> <a href="../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<span class="i">NewArgumentException</span>(<b>nameof</b>(<span class="r8 r">minRunspaces</span>), <span class="i">RunspacePoolStrings</span>.<span class="i">MinPoolGreaterThanMaxPool</span>);
            }
 
            <a href="#eb45e1e66196a2b6" class="i field">maxPoolSz</a> = <span class="r7 r">maxRunspaces</span>;
            <a href="#f6fb1db5180e27f3" class="i field">minPoolSz</a> = <span class="r8 r">minRunspaces</span>;
            <a href="#37ed160e0fbfb67a" class="i field">stateInfo</a> = <b>new</b> <a href="../remoting/common/RunspacePoolStateInfo.cs.html#c7dae263df1aded0" class="t constructor">RunspacePoolStateInfo</a>(<a href="RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="RunspacePool.cs.html#66c805b7b59385a4" class="i field">BeforeOpen</a>, <b>null</b>);
            <a href="#0d2daf8b32a561fc" class="i field">instanceId</a> = <span class="i">Guid</span>.<span class="i">NewGuid</span>();
            <a href="../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<a href="../../utils/tracing/PSEtwLog.cs.html#eb082c36055bc9a6" class="i method">SetActivityIdForCurrentThread</a>(<a href="#0d2daf8b32a561fc" class="i field">instanceId</a>);
 
            <a href="#3183719ab57b7be7" class="i field">_cleanupInterval</a> = <a href="#d88f99945ef67056" class="i field">s_defaultCleanupPeriod</a>;
            <a href="#563d49ceba80af5d" class="i field">_cleanupTimer</a> = <b>new</b> <span class="i">Timer</span>(<b>new</b> <span class="i">TimerCallback</span>(<span class="i">CleanupCallback</span>), <b>null</b>, <span class="i">Timeout</span>.<span class="i">Infinite</span>, <span class="i">Timeout</span>.<span class="i">Infinite</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Default constructor.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal</b> <a id="f847bc87f4df9353" href="../../R/../../0000000000.html" target="n" data-glyph="74,1" class="t constructor">RunspacePoolInternal</a>() { }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Public Properties
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Get unique id for this instance of runspace pool. It is primarily used</span>
        <span class="c">///</span><span class="c"> for logging purposes.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public</b> <span class="i">Guid</span> <a id="76aedcc22e17e7e5" href="../../R/76aedcc22e17e7e5.html" target="n" data-glyph="102,1" class="i property">InstanceId</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#0d2daf8b32a561fc" class="i field">instanceId</a>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets a boolean which describes if the runspace pool is disposed.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public bool</b> <a id="7e2a067cc2629817" href="../../R/7e2a067cc2629817.html" target="n" data-glyph="102,1" class="i property">IsDisposed</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#bc96f6a41dc93ca4" class="i field">_isDisposed</a>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets State of the current runspace pool.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public</b> <a href="../remoting/common/RunspacePoolStateInfo.cs.html#8b9143609d7a0363" class="t t">RunspacePoolStateInfo</a> <a id="f220504d3677222f" href="../../R/f220504d3677222f.html" target="n" data-glyph="102,1" class="i property">RunspacePoolStateInfo</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#37ed160e0fbfb67a" class="i field">stateInfo</a>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Private data to be used by applications built on top of PowerShell.</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> Local runspace pool is created with application private data set to an empty </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="../serialization.cs.html#04756020c00714fe" class="t t">PSPrimitiveDictionary</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c">.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal virtual</b> <a href="../serialization.cs.html#04756020c00714fe" class="t t">PSPrimitiveDictionary</a> <a id="4915b2d21c0cd306" href="../../R/4915b2d21c0cd306.html" target="n" data-glyph="74,1" class="i method">GetApplicationPrivateData</a>()
        {
            <b>if</b> (<a href="#7544dcba0f9d591c" class="i field">_applicationPrivateData</a> == <b>null</b>)
            {
                <b>lock</b> (<a href="#f2c8813b33dfca3f" class="k">this</a>.<a href="#21db200b449932ac" class="i field">syncObject</a>)
                {
                    <b>if</b> (<a href="#7544dcba0f9d591c" class="i field">_applicationPrivateData</a> == <b>null</b>)
                    {
                        <a href="#7544dcba0f9d591c" class="i field">_applicationPrivateData</a> = <b>new</b> <a href="../serialization.cs.html#8d1ee4ea90ea9904" class="t constructor">PSPrimitiveDictionary</a>();
                    }
                }
            }
 
            <b>return</b> <a href="#7544dcba0f9d591c" class="i field">_applicationPrivateData</a>;
        }
 
        <b>internal virtual void</b> <a id="297405db9d28f350" href="../../R/297405db9d28f350.html" target="n" data-glyph="74,1" class="i method">PropagateApplicationPrivateData</a>(<a href="Connection.cs.html#7e5b8eab1aa16fd7" class="t t">Runspace</a> <span id="r9 rd" class="r9 r">runspace</span>)
        {
            <span class="r9 r">runspace</span>.<a href="Connection.cs.html#29711178c3474b0a" class="i method">SetApplicationPrivateData</a>(<a href="#f2c8813b33dfca3f" class="k">this</a>.<a href="#4915b2d21c0cd306" class="i method">GetApplicationPrivateData</a>());
        }
 
        <b>private</b> <a href="../serialization.cs.html#04756020c00714fe" class="t t">PSPrimitiveDictionary</a> <a id="7544dcba0f9d591c" href="../../R/7544dcba0f9d591c.html" target="n" data-glyph="46,1" class="i field">_applicationPrivateData</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the InitialSessionState object that this pool uses</span>
        <span class="c">///</span><span class="c"> to create the runspaces.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public</b> <a href="../InitialSessionState.cs.html#b17f88d4755d5fd7" class="t t">InitialSessionState</a> <a id="735288dfc8499543" href="../../R/735288dfc8499543.html" target="n" data-glyph="102,1" class="i property">InitialSessionState</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#62f65112c30c27b2" class="i field">_initialSessionState</a>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The connection associated with this runspace pool.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public virtual</b> <a href="../remoting/common/RunspaceConnectionInfo.cs.html#e07ed56a8a1da829" class="t t">RunspaceConnectionInfo</a> <a id="adecbe65979c4490" href="../../R/adecbe65979c4490.html" target="n" data-glyph="102,1" class="i property">ConnectionInfo</a>
        {
            <b>get</b>
            {
                <b>return</b> <b>null</b>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Specifies how often unused runspaces are disposed.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public</b> <span class="i">TimeSpan</span> <a id="fe641c439ba50055" href="../../R/fe641c439ba50055.html" target="n" data-glyph="102,1" class="i property">CleanupInterval</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#3183719ab57b7be7" class="i field">_cleanupInterval</a>;
            }
 
            <b>set</b>
            {
                <b>lock</b> (<a href="#f2c8813b33dfca3f" class="k">this</a>.<a href="#21db200b449932ac" class="i field">syncObject</a>)
                {
                    <a href="#3183719ab57b7be7" class="i field">_cleanupInterval</a> = <b>value</b>;
                }
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Returns runspace pool availability.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public virtual</b> <a href="RunspacePool.cs.html#a2574df6d6211c0d" class="t t">RunspacePoolAvailability</a> <a id="acd5e3a5040e8caa" href="../../R/acd5e3a5040e8caa.html" target="n" data-glyph="102,1" class="i property">RunspacePoolAvailability</a>
        {
            <b>get</b>
            {
                <b>return</b> (<a href="#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../remoting/common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a> == <a href="RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="RunspacePool.cs.html#13cbf83371c004e0" class="i field">Opened</a>) ?
                    <a href="RunspacePool.cs.html#a2574df6d6211c0d" class="t t">RunspacePoolAvailability</a>.<a href="RunspacePool.cs.html#80d97f39fbc30ab0" class="i field">Available</a> :
                    <a href="RunspacePool.cs.html#a2574df6d6211c0d" class="t t">RunspacePoolAvailability</a>.<a href="RunspacePool.cs.html#080faa50d5a98f5b" class="i field">None</a>;
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> events
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Event raised when RunspacePoolState changes.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public event</b> <span class="i">EventHandler</span>&lt;<a href="RunspacePool.cs.html#ff0d60fc9c4fde6c" class="t t">RunspacePoolStateChangedEventArgs</a>&gt; <a id="f1aec6714a8e699b" href="../../R/f1aec6714a8e699b.html" target="n" data-glyph="30,1" class="i">StateChanged</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Event raised when one of the runspaces in the pool forwards an event to this instance.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public event</b> <span class="i">EventHandler</span>&lt;<a href="../EventManager.cs.html#7210411b2f4a8407" class="t t">PSEventArgs</a>&gt; <a id="1f21f3fbd0dee755" href="../../R/1f21f3fbd0dee755.html" target="n" data-glyph="30,1" class="i">ForwardEvent</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Event raised when a new Runspace is created by the pool.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal event</b> <span class="i">EventHandler</span>&lt;<a href="RunspacePool.cs.html#63e95a292a76e722" class="t t">RunspaceCreatedEventArgs</a>&gt; <a id="a8982cbf9849c30a" href="../../R/a8982cbf9849c30a.html" target="n" data-glyph="32,1" class="i">RunspaceCreated</a>;
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> events
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Disconnect-Connect Methods
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Synchronously disconnect runspace pool.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public virtual void</b> <a id="30fb4a4aedf8c1e2" href="../../R/30fb4a4aedf8c1e2.html" target="n" data-glyph="72,1" class="i method">Disconnect</a>()
        {
            <b>throw</b> <a href="../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<span class="i">NewInvalidOperationException</span>(<span class="i">RunspacePoolStrings</span>.<span class="i">RunspaceDisconnectConnectNotSupported</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Asynchronously disconnect runspace pool.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r10 r">callback</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r11 r">state</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public virtual</b> <span class="i">IAsyncResult</span> <a id="f04c98a53af69486" href="../../R/f04c98a53af69486.html" target="n" data-glyph="72,1" class="i method">BeginDisconnect</a>(<span class="i">AsyncCallback</span> <span id="r10 rd" class="r10 r">callback</span>, <b>object</b> <span id="r11 rd" class="r11 r">state</span>)
        {
            <b>throw</b> <a href="../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<span class="i">NewInvalidOperationException</span>(<span class="i">RunspacePoolStrings</span>.<span class="i">RunspaceDisconnectConnectNotSupported</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Wait for BeginDisconnect to complete.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r12 r">asyncResult</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>public virtual void</b> <a id="e04e9e2454f428dc" href="../../R/e04e9e2454f428dc.html" target="n" data-glyph="72,1" class="i method">EndDisconnect</a>(<span class="i">IAsyncResult</span> <span id="r12 rd" class="r12 r">asyncResult</span>)
        {
            <b>throw</b> <a href="../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<span class="i">NewInvalidOperationException</span>(<span class="i">RunspacePoolStrings</span>.<span class="i">RunspaceDisconnectConnectNotSupported</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Synchronously connect runspace pool.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public virtual void</b> <a id="b9ef642f6071d250" href="../../R/b9ef642f6071d250.html" target="n" data-glyph="72,1" class="i method">Connect</a>()
        {
            <b>throw</b> <a href="../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<span class="i">NewInvalidOperationException</span>(<span class="i">RunspacePoolStrings</span>.<span class="i">RunspaceDisconnectConnectNotSupported</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Asynchronously connect runspace pool.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r13 r">callback</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r14 r">state</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public virtual</b> <span class="i">IAsyncResult</span> <a id="8b2cac62a57a893d" href="../../R/8b2cac62a57a893d.html" target="n" data-glyph="72,1" class="i method">BeginConnect</a>(<span class="i">AsyncCallback</span> <span id="r13 rd" class="r13 r">callback</span>, <b>object</b> <span id="r14 rd" class="r14 r">state</span>)
        {
            <b>throw</b> <a href="../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<span class="i">NewInvalidOperationException</span>(<span class="i">RunspacePoolStrings</span>.<span class="i">RunspaceDisconnectConnectNotSupported</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Wait for BeginConnect to complete.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r15 r">asyncResult</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>public virtual void</b> <a id="00a34f42b4e57e9a" href="../../R/00a34f42b4e57e9a.html" target="n" data-glyph="72,1" class="i method">EndConnect</a>(<span class="i">IAsyncResult</span> <span id="r15 rd" class="r15 r">asyncResult</span>)
        {
            <b>throw</b> <a href="../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<span class="i">NewInvalidOperationException</span>(<span class="i">RunspacePoolStrings</span>.<span class="i">RunspaceDisconnectConnectNotSupported</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Creates an array of PowerShell objects that are in the Disconnected state for</span>
        <span class="c">///</span><span class="c"> all currently disconnected running commands associated with this runspace pool.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public virtual</b> <span class="i">Collection</span>&lt;<a href="PowerShell.cs.html#3d1b346df3be574c" class="t t">PowerShell</a>&gt; <a id="db50776271204387" href="../../R/db50776271204387.html" target="n" data-glyph="72,1" class="i method">CreateDisconnectedPowerShells</a>(<a href="RunspacePool.cs.html#c1948c2f22e6b527" class="t t">RunspacePool</a> <span id="r16 rd" class="r16 r">runspacePool</span>)
        {
            <b>throw</b> <a href="../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<span class="i">NewInvalidOperationException</span>(<span class="i">RunspacePoolStrings</span>.<span class="i">RunspaceDisconnectConnectNotSupported</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Returns RunspacePool capabilities.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">RunspacePoolCapability.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public virtual</b> <a href="RunspacePool.cs.html#ffda42f1dc806629" class="t t">RunspacePoolCapability</a> <a id="98ac73ae1afb032b" href="../../R/98ac73ae1afb032b.html" target="n" data-glyph="72,1" class="i method">GetCapabilities</a>()
        {
            <b>return</b> <a href="RunspacePool.cs.html#ffda42f1dc806629" class="t t">RunspacePoolCapability</a>.<a href="RunspacePool.cs.html#09eb0969c270accf" class="i field">Default</a>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Public Methods
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Resets the runspace state on a runspace pool with a single</span>
        <span class="c">///</span><span class="c"> runspace.</span>
        <span class="c">///</span><span class="c"> This is currently supported *only* for remote runspaces.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">True if successful.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal virtual bool</b> <a id="2db6a27e2c01e685" href="../../R/2db6a27e2c01e685.html" target="n" data-glyph="74,1" class="i method">ResetRunspaceState</a>()
        {
            <b>throw</b> <b>new</b> <a href="../../utils/MshNotSupportedException.cs.html#d102768354b20ef7" class="t constructor">PSNotSupportedException</a>();
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Sets the maximum number of Runspaces that can be active concurrently</span>
        <span class="c">///</span><span class="c"> in the pool. All requests above that number remain queued until</span>
        <span class="c">///</span><span class="c"> runspaces become available.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r17 r">maxRunspaces</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The maximum number of runspaces in the pool.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> true if the change is successful; otherwise, false.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> You cannot set the number of runspaces to a number smaller than</span>
        <span class="c">///</span><span class="c"> the minimum runspaces.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>internal virtual bool</b> <a id="0a983f97da67824e" href="../../R/0a983f97da67824e.html" target="n" data-glyph="74,1" class="i method">SetMaxRunspaces</a>(<b>int</b> <span id="r17 rd" class="r17 r">maxRunspaces</span>)
        {
            <b>bool</b> <span id="r18 rd" class="r18 r">isSizeIncreased</span> = <b>false</b>;
 
            <b>lock</b> (<a href="#86e97148ee0b7b2e" class="i field">pool</a>)
            {
                <b>if</b> (<span class="r17 r">maxRunspaces</span> &lt; <a href="#f2c8813b33dfca3f" class="k">this</a>.<a href="#f6fb1db5180e27f3" class="i field">minPoolSz</a>)
                {
                    <b>return</b> <b>false</b>;
                }
 
                <b>if</b> (<span class="r17 r">maxRunspaces</span> &gt; <a href="#f2c8813b33dfca3f" class="k">this</a>.<a href="#eb45e1e66196a2b6" class="i field">maxPoolSz</a>)
                {
                    <span class="r18 r">isSizeIncreased</span> = <b>true</b>;
                }
                <b>else</b>
                {
                    <span class="c">// since maxrunspaces limit is decreased</span>
                    <span class="c">// destroy unwanted runspaces from the top</span>
                    <span class="c">// of the pool.</span>
                    <b>while</b> (<a href="#86e97148ee0b7b2e" class="i field">pool</a>.<span class="i">Count</span> &gt; <span class="r17 r">maxRunspaces</span>)
                    {
                        <a href="Connection.cs.html#7e5b8eab1aa16fd7" class="t t">Runspace</a> <span id="r19 rd" class="r19 r">rsToDestroy</span> = <a href="#86e97148ee0b7b2e" class="i field">pool</a>.<span class="i">Pop</span>();
                        <a href="#241e509a06d5bc63" class="i method">DestroyRunspace</a>(<span class="r19 r">rsToDestroy</span>);
                    }
                }
 
                <a href="#eb45e1e66196a2b6" class="i field">maxPoolSz</a> = <span class="r17 r">maxRunspaces</span>;
            }
 
            <span class="c">// pool size is incremented.. check if we can release</span>
            <span class="c">// some requests.</span>
            <b>if</b> (<span class="r18 r">isSizeIncreased</span>)
            {
                <a href="#33ea6929a270c53b" class="i method">EnqueueCheckAndStartRequestServicingThread</a>(<b>null</b>, <b>false</b>);
            }
 
            <b>return</b> <b>true</b>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Retrieves the maximum number of runspaces the pool maintains.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The maximum number of runspaces in the pool</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public int</b> <a id="15765c6e67d44ff7" href="../../R/15765c6e67d44ff7.html" target="n" data-glyph="72,1" class="i method">GetMaxRunspaces</a>()
        {
            <b>return</b> <a href="#eb45e1e66196a2b6" class="i field">maxPoolSz</a>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Sets the minimum number of Runspaces that the pool maintains</span>
        <span class="c">///</span><span class="c"> in anticipation of new requests.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r20 r">minRunspaces</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The minimum number of runspaces in the pool.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> true if the change is successful; otherwise, false.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> You cannot set the number of idle runspaces to a number smaller than</span>
        <span class="c">///</span><span class="c"> 1 or greater than maximum number of active runspaces.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>internal virtual bool</b> <a id="5ae6fc99b0ac513b" href="../../R/5ae6fc99b0ac513b.html" target="n" data-glyph="74,1" class="i method">SetMinRunspaces</a>(<b>int</b> <span id="r20 rd" class="r20 r">minRunspaces</span>)
        {
            <b>lock</b> (<a href="#86e97148ee0b7b2e" class="i field">pool</a>)
            {
                <b>if</b> ((<span class="r20 r">minRunspaces</span> &lt; 1) || (<span class="r20 r">minRunspaces</span> &gt; <a href="#f2c8813b33dfca3f" class="k">this</a>.<a href="#eb45e1e66196a2b6" class="i field">maxPoolSz</a>))
                {
                    <b>return</b> <b>false</b>;
                }
 
                <a href="#f6fb1db5180e27f3" class="i field">minPoolSz</a> = <span class="r20 r">minRunspaces</span>;
            }
 
            <b>return</b> <b>true</b>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Retrieves the minimum number of runspaces the pool maintains.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The minimum number of runspaces in the pool</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public int</b> <a id="9495be2d7cb89fd4" href="../../R/9495be2d7cb89fd4.html" target="n" data-glyph="72,1" class="i method">GetMinRunspaces</a>()
        {
            <b>return</b> <a href="#f6fb1db5180e27f3" class="i field">minPoolSz</a>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Retrieves the number of runspaces available at the time of calling</span>
        <span class="c">///</span><span class="c"> this method.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">ArgumentException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If the RunspacePool failed or has been closed</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The number of available runspace in the pool.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal virtual int</b> <a id="fbb0a49a2955d66e" href="../../R/fbb0a49a2955d66e.html" target="n" data-glyph="74,1" class="i method">GetAvailableRunspaces</a>()
        {
            <span class="c">// Dont allow state changes while we get the count</span>
            <b>lock</b> (<a href="#21db200b449932ac" class="i field">syncObject</a>)
            {
                <b>if</b> (<a href="#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../remoting/common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a> == <a href="RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="RunspacePool.cs.html#13cbf83371c004e0" class="i field">Opened</a>)
                {
                    <span class="c">// Win8: 169492 RunspacePool can report that there are negative runspaces available.</span>
                    <span class="c">// totalRunspaces represents all the runspaces that were ever created by ths RunspacePool</span>
                    <span class="c">// pool.Count represents the runspaces that are currently available</span>
                    <span class="c">// maxPoolSz represents the total capacity w.r.t runspaces for this RunspacePool</span>
                    <span class="c">// Once the RunspacePool allocates a runspace to a consumer, RunspacePool cannot reclaim the</span>
                    <span class="c">// runspace until the consumer released the runspace back to the pool. A SetMaxRunspaces()</span>
                    <span class="c">// call can arrive before the runspace is released..It is bad to make SetMaxRunspaces()</span>
                    <span class="c">// wait for the consumers to release runspaces, so we let SetMaxRunspaces() go by changing</span>
                    <span class="c">// maxPoolSz. Because of this there may be cases where maxPoolSz - totalRunspaces will become</span>
                    <span class="c">// less than 0.</span>
                    <b>int</b> <span id="r21 rd" class="r21 r">unUsedCapacity</span> = (<a href="#eb45e1e66196a2b6" class="i field">maxPoolSz</a> - <a href="#d44d1efc92d291e9" class="i field">totalRunspaces</a>) &lt; 0 ? 0 : (<a href="#eb45e1e66196a2b6" class="i field">maxPoolSz</a> - <a href="#d44d1efc92d291e9" class="i field">totalRunspaces</a>);
                    <b>return</b> (<a href="#86e97148ee0b7b2e" class="i field">pool</a>.<span class="i">Count</span> + <span class="r21 r">unUsedCapacity</span>);
                }
                <b>else</b> <b>if</b> (<a href="#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../remoting/common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a> == <a href="RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="RunspacePool.cs.html#fb0d368190577383" class="i field">Disconnected</a>)
                {
                    <b>throw</b> <b>new</b> <span class="i">InvalidOperationException</span>(<span class="i">RunspacePoolStrings</span>.<span class="i">CannotWhileDisconnected</span>);
                }
                <b>else</b> <b>if</b> (<a href="#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../remoting/common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a> != <a href="RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="RunspacePool.cs.html#66c805b7b59385a4" class="i field">BeforeOpen</a> &amp;&amp; <a href="#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../remoting/common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a> != <a href="RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="RunspacePool.cs.html#3403f57e932b5ec3" class="i field">Opening</a>)
                {
                    <b>throw</b> <b>new</b> <span class="i">InvalidOperationException</span>(<span class="i">HostInterfaceExceptionsStrings</span>.<span class="i">RunspacePoolNotOpened</span>);
                }
                <b>else</b>
                {
                    <b>return</b> <a href="#eb45e1e66196a2b6" class="i field">maxPoolSz</a>;
                }
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Opens the runspacepool synchronously. RunspacePool must</span>
        <span class="c">///</span><span class="c"> be opened before it can be used.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="RunspacePool.cs.html#741ffc1755303d69" class="t t">InvalidRunspacePoolStateException</a><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> RunspacePoolState is not BeforeOpen</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>public virtual void</b> <a id="019ebd235d9c9768" href="../../R/019ebd235d9c9768.html" target="n" data-glyph="72,1" class="i method">Open</a>()
        {
            <a href="#0e55032f2f0707ee" class="i method">CoreOpen</a>(<b>false</b>, <b>null</b>, <b>null</b>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Opens the RunspacePool asynchronously. RunspacePool must</span>
        <span class="c">///</span><span class="c"> be opened before it can be used.</span>
        <span class="c">///</span><span class="c"> To get the exceptions that might have occurred, call</span>
        <span class="c">///</span><span class="c"> EndOpen.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r22 r">callback</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> A AsyncCallback to call once the BeginOpen completes.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r23 r">state</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> A user supplied state to call the </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r22 r">callback</span><span class="c">&quot;</span><span class="c">/&gt;</span>
        <span class="c">///</span><span class="c"> with.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> An AsyncResult object to monitor the state of the async</span>
        <span class="c">///</span><span class="c"> operation.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public</b> <span class="i">IAsyncResult</span> <a id="9d8fd4a2bd24a85c" href="../../R/9d8fd4a2bd24a85c.html" target="n" data-glyph="72,1" class="i method">BeginOpen</a>(<span class="i">AsyncCallback</span> <span id="r22 rd" class="r22 r">callback</span>, <b>object</b> <span id="r23 rd" class="r23 r">state</span>)
        {
            <b>return</b> <a href="#0e55032f2f0707ee" class="i method">CoreOpen</a>(<b>true</b>, <span class="r22 r">callback</span>, <span class="r23 r">state</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Waits for the pending asynchronous BeginOpen to complete.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">ArgumentNullException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> asyncResult is a null reference.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">ArgumentException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> asyncResult object was not created by calling BeginOpen</span>
        <span class="c">///</span><span class="c"> on this runspacepool instance.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="RunspacePool.cs.html#741ffc1755303d69" class="t t">InvalidRunspacePoolStateException</a><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> RunspacePoolState is not BeforeOpen.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> TODO: Behavior if EndOpen is called multiple times.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>public void</b> <a id="526c7cda137675a2" href="../../R/526c7cda137675a2.html" target="n" data-glyph="72,1" class="i method">EndOpen</a>(<span class="i">IAsyncResult</span> <span id="r24 rd" class="r24 r">asyncResult</span>)
        {
            <b>if</b> (<span class="r24 r">asyncResult</span> == <b>null</b>)
            {
                <b>throw</b> <a href="../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../../utils/MshTraceSource.cs.html#fbe67220ad7522a0" class="i method">NewArgumentNullException</a>(<b>nameof</b>(<span class="r24 r">asyncResult</span>));
            }
 
            <a href="RunspacePool.cs.html#bdf2646eeb96a548" class="t t">RunspacePoolAsyncResult</a> <span id="r25 rd" class="r25 r">rsAsyncResult</span> = <span class="r24 r">asyncResult</span> <b>as</b> <a href="RunspacePool.cs.html#bdf2646eeb96a548" class="t t">RunspacePoolAsyncResult</a>;
 
            <b>if</b> ((<span class="r25 r">rsAsyncResult</span> == <b>null</b>) ||
                (<span class="r25 r">rsAsyncResult</span>.<a href="AsyncResult.cs.html#c8afb8644f9407ba" class="i property">OwnerId</a> != <a href="#0d2daf8b32a561fc" class="i field">instanceId</a>) ||
                (!<span class="r25 r">rsAsyncResult</span>.<a href="RunspacePool.cs.html#52edc5f43955f90a" class="i property">IsAssociatedWithAsyncOpen</a>))
            {
                <b>throw</b> <a href="../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<span class="i">NewArgumentException</span>(<b>nameof</b>(<span class="r24 r">asyncResult</span>),
                                                         <span class="i">RunspacePoolStrings</span>.<span class="i">AsyncResultNotOwned</span>,
                                                         <span class="s">&quot;IAsyncResult&quot;</span>,
                                                         <span class="s">&quot;BeginOpen&quot;</span>);
            }
 
            <span class="r25 r">rsAsyncResult</span>.<a href="AsyncResult.cs.html#75f5584cab706e68" class="i method">EndInvoke</a>();
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Closes the RunspacePool and cleans all the internal</span>
        <span class="c">///</span><span class="c"> resources. This will close all the runspaces in the</span>
        <span class="c">///</span><span class="c"> runspacepool and release all the async operations</span>
        <span class="c">///</span><span class="c"> waiting for a runspace. If the pool is already closed</span>
        <span class="c">///</span><span class="c"> or broken or closing this will just return.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public virtual void</b> <a id="a64850dccc0b72dc" href="../../R/a64850dccc0b72dc.html" target="n" data-glyph="72,1" class="i method">Close</a>()
        {
            <a href="#786ec65b537c4c4e" class="i method">CoreClose</a>(<b>false</b>, <b>null</b>, <b>null</b>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Closes the RunspacePool asynchronously and cleans all the internal</span>
        <span class="c">///</span><span class="c"> resources. This will close all the runspaces in the</span>
        <span class="c">///</span><span class="c"> runspacepool and release all the async operations</span>
        <span class="c">///</span><span class="c"> waiting for a runspace. If the pool is already closed</span>
        <span class="c">///</span><span class="c"> or broken or closing this will just return.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r26 r">callback</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> A AsyncCallback to call once the BeginClose completes.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r27 r">state</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> A user supplied state to call the </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r26 r">callback</span><span class="c">&quot;</span><span class="c">/&gt;</span>
        <span class="c">///</span><span class="c"> with.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> An AsyncResult object to monitor the state of the async</span>
        <span class="c">///</span><span class="c"> operation.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public virtual</b> <span class="i">IAsyncResult</span> <a id="49ea97878bcde9c6" href="../../R/49ea97878bcde9c6.html" target="n" data-glyph="72,1" class="i method">BeginClose</a>(<span class="i">AsyncCallback</span> <span id="r26 rd" class="r26 r">callback</span>, <b>object</b> <span id="r27 rd" class="r27 r">state</span>)
        {
            <b>return</b> <a href="#786ec65b537c4c4e" class="i method">CoreClose</a>(<b>true</b>, <span class="r26 r">callback</span>, <span class="r27 r">state</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Waits for the pending asynchronous BeginClose to complete.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">ArgumentException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> asyncResult object was not created by calling BeginClose</span>
        <span class="c">///</span><span class="c"> on this runspacepool instance.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> TODO: Behavior if EndClose is called multiple times.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>public virtual void</b> <a id="d46d5ac54fd693af" href="../../R/d46d5ac54fd693af.html" target="n" data-glyph="72,1" class="i method">EndClose</a>(<span class="i">IAsyncResult</span> <span id="r28 rd" class="r28 r">asyncResult</span>)
        {
            <b>if</b> (<span class="r28 r">asyncResult</span> == <b>null</b>)
            {
                <b>throw</b> <a href="../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../../utils/MshTraceSource.cs.html#fbe67220ad7522a0" class="i method">NewArgumentNullException</a>(<b>nameof</b>(<span class="r28 r">asyncResult</span>));
            }
 
            <a href="RunspacePool.cs.html#bdf2646eeb96a548" class="t t">RunspacePoolAsyncResult</a> <span id="r29 rd" class="r29 r">rsAsyncResult</span> = <span class="r28 r">asyncResult</span> <b>as</b> <a href="RunspacePool.cs.html#bdf2646eeb96a548" class="t t">RunspacePoolAsyncResult</a>;
 
            <b>if</b> ((<span class="r29 r">rsAsyncResult</span> == <b>null</b>) ||
                (<span class="r29 r">rsAsyncResult</span>.<a href="AsyncResult.cs.html#c8afb8644f9407ba" class="i property">OwnerId</a> != <a href="#0d2daf8b32a561fc" class="i field">instanceId</a>) ||
                (<span class="r29 r">rsAsyncResult</span>.<a href="RunspacePool.cs.html#52edc5f43955f90a" class="i property">IsAssociatedWithAsyncOpen</a>))
            {
                <b>throw</b> <a href="../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<span class="i">NewArgumentException</span>(<b>nameof</b>(<span class="r28 r">asyncResult</span>),
                                                         <span class="i">RunspacePoolStrings</span>.<span class="i">AsyncResultNotOwned</span>,
                                                         <span class="s">&quot;IAsyncResult&quot;</span>,
                                                         <span class="s">&quot;BeginClose&quot;</span>);
            }
 
            <span class="r29 r">rsAsyncResult</span>.<a href="AsyncResult.cs.html#75f5584cab706e68" class="i method">EndInvoke</a>();
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets a Runspace from the pool. If no free runspace is available</span>
        <span class="c">///</span><span class="c"> and if max pool size is not reached, a new runspace is created.</span>
        <span class="c">///</span><span class="c"> Otherwise this will block a runspace is released and available.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> An opened Runspace.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="RunspacePool.cs.html#741ffc1755303d69" class="t t">InvalidRunspacePoolStateException</a><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Cannot perform operation because RunspacePool is</span>
        <span class="c">///</span><span class="c"> not in the opened state.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>public</b> <a href="Connection.cs.html#7e5b8eab1aa16fd7" class="t t">Runspace</a> <a id="a0221b4a7739af73" href="../../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">GetRunspace</a>()
        {
            <a href="#b6a80051dd5f9b76" class="i method">AssertPoolIsOpen</a>();
            <span class="c">// Get the runspace asynchronously.</span>
            <a href="RunspacePool.cs.html#f9f1d68e9fc0927c" class="t t">GetRunspaceAsyncResult</a> <span id="r30 rd" class="r30 r">asyncResult</span> = (<a href="RunspacePool.cs.html#f9f1d68e9fc0927c" class="t t">GetRunspaceAsyncResult</a>)<a href="#e94c3d58c7e5e600" class="i method">BeginGetRunspace</a>(<b>null</b>, <b>null</b>);
            <span class="c">// Wait for async operation to complete.</span>
            <span class="r30 r">asyncResult</span>.<a href="AsyncResult.cs.html#c2021ce461eda64c" class="i property">AsyncWaitHandle</a>.<span class="i">WaitOne</span>();
 
            <span class="c">// throw the exception that occurred while</span>
            <span class="c">// processing the async operation</span>
            <b>if</b> (<span class="r30 r">asyncResult</span>.<a href="AsyncResult.cs.html#31423c2394ef10f8" class="i property">Exception</a> != <b>null</b>)
            {
                <b>throw</b> <span class="r30 r">asyncResult</span>.<a href="AsyncResult.cs.html#31423c2394ef10f8" class="i property">Exception</a>;
            }
 
            <b>return</b> <span class="r30 r">asyncResult</span>.<a href="RunspacePool.cs.html#7bcf34c464baed9e" class="i property">Runspace</a>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Releases a Runspace to the pool. If pool is closed, this</span>
        <span class="c">///</span><span class="c"> will be a no-op.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r31 r">runspace</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Runspace to release to the pool.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">ArgumentException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r31 r">runspace</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> is null.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="RunspacePool.cs.html#741ffc1755303d69" class="t t">InvalidRunspacePoolStateException</a><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Runspool is not in Opened state.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">InvalidOperationException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Cannot release the runspace to this pool as the runspace</span>
        <span class="c">///</span><span class="c"> doesn&#39;t belong to this pool.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>public void</b> <a id="5038a34d88d95f4e" href="../../R/5038a34d88d95f4e.html" target="n" data-glyph="72,1" class="i method">ReleaseRunspace</a>(<a href="Connection.cs.html#7e5b8eab1aa16fd7" class="t t">Runspace</a> <span id="r31 rd" class="r31 r">runspace</span>)
        {
            <b>if</b> (<span class="r31 r">runspace</span> == <b>null</b>)
            {
                <b>throw</b> <a href="../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../../utils/MshTraceSource.cs.html#fbe67220ad7522a0" class="i method">NewArgumentNullException</a>(<b>nameof</b>(<span class="r31 r">runspace</span>));
            }
 
            <a href="#b6a80051dd5f9b76" class="i method">AssertPoolIsOpen</a>();
 
            <b>bool</b> <span id="r32 rd" class="r32 r">isRunspaceReleased</span> = <b>false</b>;
            <b>bool</b> <span id="r33 rd" class="r33 r">destroyRunspace</span> = <b>false</b>;
 
            <span class="c">// check if the runspace is owned by the pool</span>
            <b>lock</b> (<a href="#43b18ffe73b89022" class="i field">runspaceList</a>)
            {
                <b>if</b> (!<a href="#43b18ffe73b89022" class="i field">runspaceList</a>.<span class="i">Contains</span>(<span class="r31 r">runspace</span>))
                {
                    <b>throw</b> <a href="../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<span class="i">NewInvalidOperationException</span>(<span class="i">RunspacePoolStrings</span>.<span class="i">RunspaceNotBelongsToPool</span>);
                }
            }
 
            <span class="c">// Release this runspace only if it is in valid state and is</span>
            <span class="c">// owned by this pool.</span>
            <b>if</b> (<span class="r31 r">runspace</span>.<a href="Connection.cs.html#01b12fbdab6c561a" class="i property">RunspaceStateInfo</a>.<a href="Connection.cs.html#41627f067662d11c" class="i property">State</a> == <a href="Connection.cs.html#5da9dc65e996a685" class="t t">RunspaceState</a>.<a href="Connection.cs.html#9a99efb0eaa3c3db" class="i field">Opened</a>)
            {
                <b>lock</b> (<a href="#86e97148ee0b7b2e" class="i field">pool</a>)
                {
                    <b>if</b> (<a href="#86e97148ee0b7b2e" class="i field">pool</a>.<span class="i">Count</span> &lt; <a href="#eb45e1e66196a2b6" class="i field">maxPoolSz</a>)
                    {
                        <span class="r32 r">isRunspaceReleased</span> = <b>true</b>;
                        <a href="#86e97148ee0b7b2e" class="i field">pool</a>.<span class="i">Push</span>(<span class="r31 r">runspace</span>);
                    }
                    <b>else</b>
                    {
                        <span class="c">// this runspace is not going to be pooled as maxPoolSz is reduced.</span>
                        <span class="c">// so release the runspace and destroy it.</span>
                        <span class="r32 r">isRunspaceReleased</span> = <b>true</b>;
                        <span class="r33 r">destroyRunspace</span> = <b>true</b>;
                    }
                }
            }
            <b>else</b>
            {
                <span class="r33 r">destroyRunspace</span> = <b>true</b>;
                <span class="r32 r">isRunspaceReleased</span> = <b>true</b>;
            }
 
            <b>if</b> (<span class="r33 r">destroyRunspace</span>)
            {
                <span class="c">// Destroying a runspace might be costly.</span>
                <span class="c">// so doing this outside of the lock.</span>
                <a href="#241e509a06d5bc63" class="i method">DestroyRunspace</a>(<span class="r31 r">runspace</span>);
            }
 
            <span class="c">// it is important to release lock on Pool so that</span>
            <span class="c">// other threads can service requests.</span>
            <b>if</b> (<span class="r32 r">isRunspaceReleased</span>)
            {
                <span class="c">// service any pending runspace requests.</span>
                <a href="#33ea6929a270c53b" class="i method">EnqueueCheckAndStartRequestServicingThread</a>(<b>null</b>, <b>false</b>);
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Dispose off the current runspace pool.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r34 r">disposing</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> true to release all the internal resources.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>public virtual void</b> <a id="4adfd23f5bdd0610" href="../../R/4adfd23f5bdd0610.html" target="n" data-glyph="72,1" class="i method">Dispose</a>(<b>bool</b> <span id="r34 rd" class="r34 r">disposing</span>)
        {
            <b>if</b> (!<a href="#bc96f6a41dc93ca4" class="i field">_isDisposed</a>)
            {
                <b>if</b> (<span class="r34 r">disposing</span>)
                {
                    <a href="#a64850dccc0b72dc" class="i method">Close</a>();
                    <a href="#563d49ceba80af5d" class="i field">_cleanupTimer</a>.<span class="i">Dispose</span>();
                    <a href="#62f65112c30c27b2" class="i field">_initialSessionState</a> = <b>null</b>;
                    <a href="#ceb434f916bd07a3" class="i field">host</a> = <b>null</b>;
                }
 
                <a href="#bc96f6a41dc93ca4" class="i field">_isDisposed</a> = <b>true</b>;
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Internal Methods
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The value of this property is propagated to all the Runspaces in this pool;</span>
        <span class="c">///</span><span class="c"> it determines whether a new thread is create when a pipeline is executed.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Any updates to the value of this property must be done before the RunspacePool is opened</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>internal</b> <a href="Connection.cs.html#e3e452d2492397a5" class="t t">PSThreadOptions</a> <a id="3617244356b991d3" href="../../R/3617244356b991d3.html" target="n" data-glyph="104,1" class="i property">ThreadOptions</a> { <b>get</b>; <b>set</b>; } = <a href="Connection.cs.html#e3e452d2492397a5" class="t t">PSThreadOptions</a>.<a href="Connection.cs.html#84e3ebfc04cbd4e5" class="i field">Default</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The value of this property is propagated to all the Runspaces in this pool.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Any updates to the value of this property must be done before the RunspacePool is opened</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>internal</b> <span class="i">ApartmentState</span> <a id="3f9f0d0f8dd1c807" href="../../R/3f9f0d0f8dd1c807.html" target="n" data-glyph="104,1" class="i property">ApartmentState</a> { <b>get</b>; <b>set</b>; } = <a href="Connection.cs.html#7e5b8eab1aa16fd7" class="t t">Runspace</a>.<a href="Connection.cs.html#8d461e5a29a5440d" class="i field">DefaultApartmentState</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets Runspace asynchronously from the runspace pool. The caller</span>
        <span class="c">///</span><span class="c"> will get notified with the runspace using </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r35 r">callback</span><span class="c">&quot;</span><span class="c">/&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r35 r">callback</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> A AsyncCallback to call once the runspace is available.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r36 r">state</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> A user supplied state to call the </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r35 r">callback</span><span class="c">&quot;</span><span class="c">/&gt;</span>
        <span class="c">///</span><span class="c"> with.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> An IAsyncResult object to track the status of the Async operation.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal</b> <span class="i">IAsyncResult</span> <a id="e94c3d58c7e5e600" href="../../R/e94c3d58c7e5e600.html" target="n" data-glyph="74,1" class="i method">BeginGetRunspace</a>(
            <span class="i">AsyncCallback</span> <span id="r35 rd" class="r35 r">callback</span>, <b>object</b> <span id="r36 rd" class="r36 r">state</span>)
        {
            <a href="#b6a80051dd5f9b76" class="i method">AssertPoolIsOpen</a>();
 
            <a href="RunspacePool.cs.html#f9f1d68e9fc0927c" class="t t">GetRunspaceAsyncResult</a> <span id="r37 rd" class="r37 r">asyncResult</span> = <b>new</b> <a href="RunspacePool.cs.html#353600984ec20a4b" class="t constructor">GetRunspaceAsyncResult</a>(<a href="#f2c8813b33dfca3f" class="k">this</a>.<a href="#76aedcc22e17e7e5" class="i property">InstanceId</a>,
                <span class="r35 r">callback</span>, <span class="r36 r">state</span>);
 
            <span class="c">// Enqueue and start servicing thread in one go..saving multiple locks.</span>
            <a href="#33ea6929a270c53b" class="i method">EnqueueCheckAndStartRequestServicingThread</a>(<span class="r37 r">asyncResult</span>, <b>true</b>);
 
            <b>return</b> <span class="r37 r">asyncResult</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Cancels the pending asynchronous BeginGetRunspace operation.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r38 r">asyncResult</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="d8b908e34d56c73c" href="../../R/d8b908e34d56c73c.html" target="n" data-glyph="74,1" class="i method">CancelGetRunspace</a>(<span class="i">IAsyncResult</span> <span id="r38 rd" class="r38 r">asyncResult</span>)
        {
            <b>if</b> (<span class="r38 r">asyncResult</span> == <b>null</b>)
            {
                <b>throw</b> <a href="../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../../utils/MshTraceSource.cs.html#fbe67220ad7522a0" class="i method">NewArgumentNullException</a>(<b>nameof</b>(<span class="r38 r">asyncResult</span>));
            }
 
            <a href="RunspacePool.cs.html#f9f1d68e9fc0927c" class="t t">GetRunspaceAsyncResult</a> <span id="r39 rd" class="r39 r">grsAsyncResult</span> =
                <span class="r38 r">asyncResult</span> <b>as</b> <a href="RunspacePool.cs.html#f9f1d68e9fc0927c" class="t t">GetRunspaceAsyncResult</a>;
 
            <b>if</b> ((<span class="r39 r">grsAsyncResult</span> == <b>null</b>) || (<span class="r39 r">grsAsyncResult</span>.<a href="AsyncResult.cs.html#c8afb8644f9407ba" class="i property">OwnerId</a> != <a href="#0d2daf8b32a561fc" class="i field">instanceId</a>))
            {
                <b>throw</b> <a href="../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<span class="i">NewArgumentException</span>(<b>nameof</b>(<span class="r38 r">asyncResult</span>),
                                                         <span class="i">RunspacePoolStrings</span>.<span class="i">AsyncResultNotOwned</span>,
                                                         <span class="s">&quot;IAsyncResult&quot;</span>,
                                                         <span class="s">&quot;BeginGetRunspace&quot;</span>);
            }
 
            <span class="r39 r">grsAsyncResult</span>.<a href="RunspacePool.cs.html#ea99cb2205e6f78b" class="i property">IsActive</a> = <b>false</b>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Waits for the pending asynchronous BeginGetRunspace to complete.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r40 r">asyncResult</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">ArgumentNullException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> asyncResult is a null reference.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">ArgumentException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> asyncResult object was not created by calling BeginGetRunspace</span>
        <span class="c">///</span><span class="c"> on this runspacepool instance.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="RunspacePool.cs.html#741ffc1755303d69" class="t t">InvalidRunspacePoolStateException</a><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> RunspacePoolState is not BeforeOpen.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> TODO: Behavior if EndGetRunspace is called multiple times.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>internal</b> <a href="Connection.cs.html#7e5b8eab1aa16fd7" class="t t">Runspace</a> <a id="49c27bae43d8f47e" href="../../R/49c27bae43d8f47e.html" target="n" data-glyph="74,1" class="i method">EndGetRunspace</a>(<span class="i">IAsyncResult</span> <span id="r40 rd" class="r40 r">asyncResult</span>)
        {
            <b>if</b> (<span class="r40 r">asyncResult</span> == <b>null</b>)
            {
                <b>throw</b> <a href="../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../../utils/MshTraceSource.cs.html#fbe67220ad7522a0" class="i method">NewArgumentNullException</a>(<b>nameof</b>(<span class="r40 r">asyncResult</span>));
            }
 
            <a href="RunspacePool.cs.html#f9f1d68e9fc0927c" class="t t">GetRunspaceAsyncResult</a> <span id="r41 rd" class="r41 r">grsAsyncResult</span> =
                <span class="r40 r">asyncResult</span> <b>as</b> <a href="RunspacePool.cs.html#f9f1d68e9fc0927c" class="t t">GetRunspaceAsyncResult</a>;
 
            <b>if</b> ((<span class="r41 r">grsAsyncResult</span> == <b>null</b>) || (<span class="r41 r">grsAsyncResult</span>.<a href="AsyncResult.cs.html#c8afb8644f9407ba" class="i property">OwnerId</a> != <a href="#0d2daf8b32a561fc" class="i field">instanceId</a>))
            {
                <b>throw</b> <a href="../../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<span class="i">NewArgumentException</span>(<b>nameof</b>(<span class="r40 r">asyncResult</span>),
                                                         <span class="i">RunspacePoolStrings</span>.<span class="i">AsyncResultNotOwned</span>,
                                                         <span class="s">&quot;IAsyncResult&quot;</span>,
                                                         <span class="s">&quot;BeginGetRunspace&quot;</span>);
            }
 
            <span class="r41 r">grsAsyncResult</span>.<a href="AsyncResult.cs.html#75f5584cab706e68" class="i method">EndInvoke</a>();
            <b>return</b> <span class="r41 r">grsAsyncResult</span>.<a href="RunspacePool.cs.html#7bcf34c464baed9e" class="i property">Runspace</a>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Opens the runspacepool synchronously / asynchronously.</span>
        <span class="c">///</span><span class="c"> Runspace pool must be opened before it can be used.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r42 r">isAsync</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> true to open asynchronously</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r43 r">callback</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> A AsyncCallback to call once the BeginOpen completes.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r44 r">asyncState</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> A user supplied state to call the </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r43 r">callback</span><span class="c">&quot;</span><span class="c">/&gt;</span>
        <span class="c">///</span><span class="c"> with.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> asyncResult object to monitor status of the async</span>
        <span class="c">///</span><span class="c"> open operation. This is returned only if </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r42 r">isAsync</span><span class="c">&quot;</span><span class="c">/&gt;</span>
        <span class="c">///</span><span class="c"> is true.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="RunspacePool.cs.html#741ffc1755303d69" class="t t">InvalidRunspacePoolStateException</a><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Cannot open RunspacePool because RunspacePool is not in</span>
        <span class="c">///</span><span class="c"> the BeforeOpen state.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">OutOfMemoryException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> There is not enough memory available to start this asynchronously.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>protected virtual</b> <span class="i">IAsyncResult</span> <a id="0e55032f2f0707ee" href="../../R/0e55032f2f0707ee.html" target="n" data-glyph="75,1" class="i method">CoreOpen</a>(<b>bool</b> <span id="r42 rd" class="r42 r">isAsync</span>, <span class="i">AsyncCallback</span> <span id="r43 rd" class="r43 r">callback</span>,
            <b>object</b> <span id="r44 rd" class="r44 r">asyncState</span>)
        {
            <b>lock</b> (<a href="#21db200b449932ac" class="i field">syncObject</a>)
            {
                <a href="#38a7e17d18f5dbc9" class="i method">AssertIfStateIsBeforeOpen</a>();
 
                <a href="#37ed160e0fbfb67a" class="i field">stateInfo</a> = <b>new</b> <a href="../remoting/common/RunspacePoolStateInfo.cs.html#c7dae263df1aded0" class="t constructor">RunspacePoolStateInfo</a>(<a href="RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="RunspacePool.cs.html#3403f57e932b5ec3" class="i field">Opening</a>, <b>null</b>);
            }
 
            <span class="c">// only one thread will reach here, so no</span>
            <span class="c">// need to lock.</span>
            <a href="#c96a416ffa6d47a6" class="i method">RaiseStateChangeEvent</a>(<a href="#37ed160e0fbfb67a" class="i field">stateInfo</a>);
 
            <b>if</b> (<span class="r42 r">isAsync</span>)
            {
                <a href="AsyncResult.cs.html#f0fde6334f2a46e1" class="t t">AsyncResult</a> <span id="r45 rd" class="r45 r">asyncResult</span> = <b>new</b> <a href="RunspacePool.cs.html#5858f7ec065f0d15" class="t constructor">RunspacePoolAsyncResult</a>(<a href="#0d2daf8b32a561fc" class="i field">instanceId</a>, <span class="r43 r">callback</span>, <span class="r44 r">asyncState</span>, <b>true</b>);
                <span class="c">// Open pool in another thread</span>
                <span class="i">ThreadPool</span>.<span class="i">QueueUserWorkItem</span>(<b>new</b> <span class="i">WaitCallback</span>(<span class="i">OpenThreadProc</span>), <span class="r45 r">asyncResult</span>);
                <b>return</b> <span class="r45 r">asyncResult</span>;
            }
 
            <span class="c">// open the runspace synchronously</span>
            <a href="#03ab84d43b4ffa99" class="i method">OpenHelper</a>();
            <b>return</b> <b>null</b>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Creates a Runspace + opens it synchronously and</span>
        <span class="c">///</span><span class="c"> pushes it into the stack.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Caller to make sure this is thread safe.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>protected void</b> <a id="03ab84d43b4ffa99" href="../../R/03ab84d43b4ffa99.html" target="n" data-glyph="75,1" class="i method">OpenHelper</a>()
        {
            <b>try</b>
            {
                <a href="../../utils/tracing/PSEtwLog.cs.html#749e795b3c087a72" class="t t">PSEtwLog</a>.<a href="../../utils/tracing/PSEtwLog.cs.html#eb082c36055bc9a6" class="i method">SetActivityIdForCurrentThread</a>(<a href="#f2c8813b33dfca3f" class="k">this</a>.<a href="#76aedcc22e17e7e5" class="i property">InstanceId</a>);
                <span class="c">// Create a Runspace and store it in the pool</span>
                <span class="c">// for future use. This will validate whether</span>
                <span class="c">// a runspace can be created + opened successfully</span>
                <a href="Connection.cs.html#7e5b8eab1aa16fd7" class="t t">Runspace</a> <span id="r46 rd" class="r46 r">rs</span> = <a href="#10513baed86d2c9e" class="i method">CreateRunspace</a>();
                <a href="#86e97148ee0b7b2e" class="i field">pool</a>.<span class="i">Push</span>(<span class="r46 r">rs</span>);
            }
            <b>catch</b> (<span class="i">Exception</span> <span id="r47 rd" class="r47 r">exception</span>)
            {
                <a href="#086da3750bcd2ae1" class="i method">SetStateToBroken</a>(<span class="r47 r">exception</span>);
                <span class="c">// rethrow the exception</span>
                <b>throw</b>;
            }
 
            <b>bool</b> <span id="r48 rd" class="r48 r">shouldRaiseEvents</span> = <b>false</b>;
            <span class="c">// RunspacePool might be closed while we are still opening</span>
            <span class="c">// we should not change state from closed to opened..</span>
            <b>lock</b> (<a href="#21db200b449932ac" class="i field">syncObject</a>)
            {
                <b>if</b> (<a href="#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../remoting/common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a> == <a href="RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="RunspacePool.cs.html#3403f57e932b5ec3" class="i field">Opening</a>)
                {
                    <span class="c">// Change state to opened and notify the user.</span>
                    <a href="#37ed160e0fbfb67a" class="i field">stateInfo</a> = <b>new</b> <a href="../remoting/common/RunspacePoolStateInfo.cs.html#c7dae263df1aded0" class="t constructor">RunspacePoolStateInfo</a>(<a href="RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="RunspacePool.cs.html#13cbf83371c004e0" class="i field">Opened</a>, <b>null</b>);
                    <span class="r48 r">shouldRaiseEvents</span> = <b>true</b>;
                }
            }
 
            <b>if</b> (<span class="r48 r">shouldRaiseEvents</span>)
            {
                <a href="#c96a416ffa6d47a6" class="i method">RaiseStateChangeEvent</a>(<a href="#37ed160e0fbfb67a" class="i field">stateInfo</a>);
            }
        }
 
        <b>private void</b> <a id="086da3750bcd2ae1" href="../../R/086da3750bcd2ae1.html" target="n" data-glyph="76,1" class="i method">SetStateToBroken</a>(<span class="i">Exception</span> <span id="r49 rd" class="r49 r">reason</span>)
        {
            <b>bool</b> <span id="r50 rd" class="r50 r">shouldRaiseEvents</span> = <b>false</b>;
            <b>lock</b> (<a href="#21db200b449932ac" class="i field">syncObject</a>)
            {
                <b>if</b> ((<a href="#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../remoting/common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a> == <a href="RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="RunspacePool.cs.html#3403f57e932b5ec3" class="i field">Opening</a>) ||
                    (<a href="#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../remoting/common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a> == <a href="RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="RunspacePool.cs.html#13cbf83371c004e0" class="i field">Opened</a>) ||
                    (<a href="#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../remoting/common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a> == <a href="RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="RunspacePool.cs.html#91690c7b66b3081a" class="i field">Disconnecting</a>) ||
                    (<a href="#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../remoting/common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a> == <a href="RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="RunspacePool.cs.html#fb0d368190577383" class="i field">Disconnected</a>) ||
                    (<a href="#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../remoting/common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a> == <a href="RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="RunspacePool.cs.html#332d1241bf520aa3" class="i field">Connecting</a>))
                {
                    <a href="#37ed160e0fbfb67a" class="i field">stateInfo</a> = <b>new</b> <a href="../remoting/common/RunspacePoolStateInfo.cs.html#c7dae263df1aded0" class="t constructor">RunspacePoolStateInfo</a>(<a href="RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="RunspacePool.cs.html#48a121178c7c288f" class="i field">Broken</a>, <b>null</b>);
                    <span class="r50 r">shouldRaiseEvents</span> = <b>true</b>;
                }
            }
 
            <b>if</b> (<span class="r50 r">shouldRaiseEvents</span>)
            {
                <a href="../remoting/common/RunspacePoolStateInfo.cs.html#8b9143609d7a0363" class="t t">RunspacePoolStateInfo</a> <span id="r51 rd" class="r51 r">stateInfo</span> = <b>new</b> <a href="../remoting/common/RunspacePoolStateInfo.cs.html#c7dae263df1aded0" class="t constructor">RunspacePoolStateInfo</a>(<a href="#f2c8813b33dfca3f" class="k">this</a>.<a href="#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../remoting/common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a>,
                    <span class="r49 r">reason</span>);
                <a href="#c96a416ffa6d47a6" class="i method">RaiseStateChangeEvent</a>(<span class="r51 r">stateInfo</span>);
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Starting point for asynchronous thread.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> asyncResult object</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>protected void</b> <a id="a05dd2b78501b3bc" href="../../R/../../0000000000.html" target="n" data-glyph="75,1" class="i method">OpenThreadProc</a>(<b>object</b> <span id="r52 rd" class="r52 r">o</span>)
        {
            <a href="../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r52 r">o</span> <b>is</b> <a href="AsyncResult.cs.html#f0fde6334f2a46e1" class="t t">AsyncResult</a>, <span class="s">&quot;OpenThreadProc expects AsyncResult&quot;</span>);
            <span class="c">// Since this is an internal method, we can safely cast the</span>
            <span class="c">// object to AsyncResult object.</span>
            <a href="AsyncResult.cs.html#f0fde6334f2a46e1" class="t t">AsyncResult</a> <span id="r53 rd" class="r53 r">asyncObject</span> = (<a href="AsyncResult.cs.html#f0fde6334f2a46e1" class="t t">AsyncResult</a>)<span class="r52 r">o</span>;
            <span class="c">// variable to keep track of exceptions.</span>
            <span class="i">Exception</span> <span id="r54 rd" class="r54 r">exception</span> = <b>null</b>;
 
            <b>try</b>
            {
                <a href="#03ab84d43b4ffa99" class="i method">OpenHelper</a>();
            }
            <b>catch</b> (<span class="i">Exception</span> <span id="r55 rd" class="r55 r">e</span>)
            {
                <span class="c">// report non-severe exceptions to the user via the</span>
                <span class="c">// asyncresult object</span>
                <span class="r54 r">exception</span> = <span class="r55 r">e</span>;
            }
            <b>finally</b>
            {
                <span class="r53 r">asyncObject</span>.<a href="AsyncResult.cs.html#2d78c0fa1b51bb6e" class="i method">SetAsCompleted</a>(<span class="r54 r">exception</span>);
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Closes the runspacepool synchronously / asynchronously.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r56 r">isAsync</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> true to close asynchronously</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r57 r">callback</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> A AsyncCallback to call once the BeginClose completes.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r58 r">asyncState</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> A user supplied state to call the </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r57 r">callback</span><span class="c">&quot;</span><span class="c">/&gt;</span>
        <span class="c">///</span><span class="c"> with.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> asyncResult object to monitor status of the async</span>
        <span class="c">///</span><span class="c"> open operation. This is returned only if </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r56 r">isAsync</span><span class="c">&quot;</span><span class="c">/&gt;</span>
        <span class="c">///</span><span class="c"> is true.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>private</b> <span class="i">IAsyncResult</span> <a id="786ec65b537c4c4e" href="../../R/786ec65b537c4c4e.html" target="n" data-glyph="76,1" class="i method">CoreClose</a>(<b>bool</b> <span id="r56 rd" class="r56 r">isAsync</span>, <span class="i">AsyncCallback</span> <span id="r57 rd" class="r57 r">callback</span>, <b>object</b> <span id="r58 rd" class="r58 r">asyncState</span>)
        {
            <b>lock</b> (<a href="#21db200b449932ac" class="i field">syncObject</a>)
            {
                <b>if</b> ((<a href="#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../remoting/common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a> == <a href="RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="RunspacePool.cs.html#494904731e18b593" class="i field">Closed</a>) ||
                    (<a href="#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../remoting/common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a> == <a href="RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="RunspacePool.cs.html#48a121178c7c288f" class="i field">Broken</a>) ||
                    (<a href="#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../remoting/common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a> == <a href="RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="RunspacePool.cs.html#2b6027539b9d1816" class="i field">Closing</a>) ||
                    (<a href="#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../remoting/common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a> == <a href="RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="RunspacePool.cs.html#91690c7b66b3081a" class="i field">Disconnecting</a>) ||
                    (<a href="#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../remoting/common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a> == <a href="RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="RunspacePool.cs.html#fb0d368190577383" class="i field">Disconnected</a>))
                {
                    <b>if</b> (<span class="r56 r">isAsync</span>)
                    {
                        <a href="RunspacePool.cs.html#bdf2646eeb96a548" class="t t">RunspacePoolAsyncResult</a> <span id="r59 rd" class="r59 r">asyncResult</span> = <b>new</b> <a href="RunspacePool.cs.html#5858f7ec065f0d15" class="t constructor">RunspacePoolAsyncResult</a>(<a href="#0d2daf8b32a561fc" class="i field">instanceId</a>, <span class="r57 r">callback</span>, <span class="r58 r">asyncState</span>, <b>false</b>);
                        <span class="r59 r">asyncResult</span>.<a href="AsyncResult.cs.html#2d78c0fa1b51bb6e" class="i method">SetAsCompleted</a>(<b>null</b>);
                        <b>return</b> <span class="r59 r">asyncResult</span>;
                    }
                    <b>else</b>
                    {
                        <b>return</b> <b>null</b>;
                    }
                }
 
                <a href="#37ed160e0fbfb67a" class="i field">stateInfo</a> = <b>new</b> <a href="../remoting/common/RunspacePoolStateInfo.cs.html#c7dae263df1aded0" class="t constructor">RunspacePoolStateInfo</a>(<a href="RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="RunspacePool.cs.html#2b6027539b9d1816" class="i field">Closing</a>, <b>null</b>);
            }
 
            <span class="c">// only one thread will reach here.</span>
            <a href="#c96a416ffa6d47a6" class="i method">RaiseStateChangeEvent</a>(<a href="#37ed160e0fbfb67a" class="i field">stateInfo</a>);
 
            <b>if</b> (<span class="r56 r">isAsync</span>)
            {
                <a href="RunspacePool.cs.html#bdf2646eeb96a548" class="t t">RunspacePoolAsyncResult</a> <span id="r60 rd" class="r60 r">asyncResult</span> = <b>new</b> <a href="RunspacePool.cs.html#5858f7ec065f0d15" class="t constructor">RunspacePoolAsyncResult</a>(<a href="#0d2daf8b32a561fc" class="i field">instanceId</a>, <span class="r57 r">callback</span>, <span class="r58 r">asyncState</span>, <b>false</b>);
                <span class="c">// Open pool in another thread</span>
                <span class="i">ThreadPool</span>.<span class="i">QueueUserWorkItem</span>(<b>new</b> <span class="i">WaitCallback</span>(<span class="i">CloseThreadProc</span>), <span class="r60 r">asyncResult</span>);
                <b>return</b> <span class="r60 r">asyncResult</span>;
            }
 
            <span class="c">// open the runspace synchronously</span>
            <a href="#5abc5f10401a83cb" class="i method">CloseHelper</a>();
            <b>return</b> <b>null</b>;
        }
 
        <b>private void</b> <a id="5abc5f10401a83cb" href="../../R/5abc5f10401a83cb.html" target="n" data-glyph="76,1" class="i method">CloseHelper</a>()
        {
            <b>try</b>
            {
                <a href="#36a9edc8fa101a91" class="i method">InternalClearAllResources</a>();
            }
            <b>finally</b>
            {
                <a href="#37ed160e0fbfb67a" class="i field">stateInfo</a> = <b>new</b> <a href="../remoting/common/RunspacePoolStateInfo.cs.html#c7dae263df1aded0" class="t constructor">RunspacePoolStateInfo</a>(<a href="RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="RunspacePool.cs.html#494904731e18b593" class="i field">Closed</a>, <b>null</b>);
                <a href="#c96a416ffa6d47a6" class="i method">RaiseStateChangeEvent</a>(<a href="#37ed160e0fbfb67a" class="i field">stateInfo</a>);
            }
        }
 
        <b>private void</b> <a id="d4dba02cbb5be029" href="../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">CloseThreadProc</a>(<b>object</b> <span id="r61 rd" class="r61 r">o</span>)
        {
            <a href="../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r61 r">o</span> <b>is</b> <a href="AsyncResult.cs.html#f0fde6334f2a46e1" class="t t">AsyncResult</a>, <span class="s">&quot;CloseThreadProc expects AsyncResult&quot;</span>);
            <span class="c">// Since this is an internal method, we can safely cast the</span>
            <span class="c">// object to AsyncResult object.</span>
            <a href="AsyncResult.cs.html#f0fde6334f2a46e1" class="t t">AsyncResult</a> <span id="r62 rd" class="r62 r">asyncObject</span> = (<a href="AsyncResult.cs.html#f0fde6334f2a46e1" class="t t">AsyncResult</a>)<span class="r61 r">o</span>;
            <span class="c">// variable to keep track of exceptions.</span>
            <span class="i">Exception</span> <span id="r63 rd" class="r63 r">exception</span> = <b>null</b>;
 
            <b>try</b>
            {
                <a href="#5abc5f10401a83cb" class="i method">CloseHelper</a>();
            }
            <b>catch</b> (<span class="i">Exception</span> <span id="r64 rd" class="r64 r">e</span>)
            {
                <span class="c">// report non-severe exceptions to the user via the</span>
                <span class="c">// asyncresult object</span>
                <span class="r63 r">exception</span> = <span class="r64 r">e</span>;
            }
            <b>finally</b>
            {
                <span class="r62 r">asyncObject</span>.<a href="AsyncResult.cs.html#2d78c0fa1b51bb6e" class="i method">SetAsCompleted</a>(<span class="r63 r">exception</span>);
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Private Methods
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Raise state changed event based on the StateInfo</span>
        <span class="c">///</span><span class="c"> object.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r65 r">stateInfo</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">State information object.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>protected void</b> <a id="c96a416ffa6d47a6" href="../../R/c96a416ffa6d47a6.html" target="n" data-glyph="75,1" class="i method">RaiseStateChangeEvent</a>(<a href="../remoting/common/RunspacePoolStateInfo.cs.html#8b9143609d7a0363" class="t t">RunspacePoolStateInfo</a> <span id="r65 rd" class="r65 r">stateInfo</span>)
        {
            <a href="#f1aec6714a8e699b" class="i">StateChanged</a>.<span class="i">SafeInvoke</span>(<a href="#f2c8813b33dfca3f" class="k">this</a>,
                <b>new</b> <a href="RunspacePool.cs.html#843936ad6bee0e6e" class="t constructor">RunspacePoolStateChangedEventArgs</a>(<span class="r65 r">stateInfo</span>));
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Checks if the Pool is open to honour requests.</span>
        <span class="c">///</span><span class="c"> If not throws an exception.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="RunspacePool.cs.html#741ffc1755303d69" class="t t">InvalidRunspacePoolStateException</a><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Cannot perform operation because RunspacePool is</span>
        <span class="c">///</span><span class="c"> not in the opened state.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="b6a80051dd5f9b76" href="../../R/b6a80051dd5f9b76.html" target="n" data-glyph="74,1" class="i method">AssertPoolIsOpen</a>()
        {
            <b>lock</b> (<a href="#21db200b449932ac" class="i field">syncObject</a>)
            {
                <b>if</b> (<a href="#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../remoting/common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a> != <a href="RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="RunspacePool.cs.html#13cbf83371c004e0" class="i field">Opened</a>)
                {
                    <b>string</b> <span id="r66 rd" class="r66 r">message</span> = <a href="../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">RunspacePoolStrings</span>.<span class="i">InvalidRunspacePoolState</span>, <a href="RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="RunspacePool.cs.html#13cbf83371c004e0" class="i field">Opened</a>, <a href="#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../remoting/common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a>);
                    <b>throw</b> <b>new</b> <a href="RunspacePool.cs.html#53060b2dd310e4fc" class="t constructor">InvalidRunspacePoolStateException</a>(<span class="r66 r">message</span>,
                                     <a href="#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../remoting/common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a>, <a href="RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="RunspacePool.cs.html#13cbf83371c004e0" class="i field">Opened</a>);
                }
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Creates a new Runspace and initializes it by calling Open()</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> An opened Runspace.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> TODO: Exceptions thrown here need to be documented.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>protected</b> <a href="Connection.cs.html#7e5b8eab1aa16fd7" class="t t">Runspace</a> <a id="10513baed86d2c9e" href="../../R/10513baed86d2c9e.html" target="n" data-glyph="75,1" class="i method">CreateRunspace</a>()
        {
            <a href="../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<a href="#62f65112c30c27b2" class="i field">_initialSessionState</a> != <b>null</b>, <span class="s">&quot;_initialSessionState should not be null&quot;</span>);
            <span class="c">// TODO: exceptions thrown here need to be documented</span>
            <span class="c">// runspace.Open() did not document all the exceptions.</span>
            <a href="Connection.cs.html#7e5b8eab1aa16fd7" class="t t">Runspace</a> <span id="r67 rd" class="r67 r">result</span> = <a href="ConnectionFactory.cs.html#c5fbe142e4e21218" class="t t">RunspaceFactory</a>.<a href="ConnectionFactory.cs.html#3b7a274e8fe5d27d" class="i method">CreateRunspaceFromSessionStateNoClone</a>(<a href="#ceb434f916bd07a3" class="i field">host</a>, <a href="#62f65112c30c27b2" class="i field">_initialSessionState</a>);
 
            <span class="r67 r">result</span>.<a href="Connection.cs.html#bd7dc249cd7abc4e" class="i property">ThreadOptions</a> = <a href="#f2c8813b33dfca3f" class="k">this</a>.<a href="#3617244356b991d3" class="i property">ThreadOptions</a> == <a href="Connection.cs.html#e3e452d2492397a5" class="t t">PSThreadOptions</a>.<a href="Connection.cs.html#84e3ebfc04cbd4e5" class="i field">Default</a> ? <a href="Connection.cs.html#e3e452d2492397a5" class="t t">PSThreadOptions</a>.<a href="Connection.cs.html#d11fc99ab087227d" class="i field">ReuseThread</a> : <a href="#f2c8813b33dfca3f" class="k">this</a>.<a href="#3617244356b991d3" class="i property">ThreadOptions</a>;
            <span class="r67 r">result</span>.<a href="Connection.cs.html#7483ec8556438ee9" class="i property">ApartmentState</a> = <a href="#f2c8813b33dfca3f" class="k">this</a>.<a href="#3f9f0d0f8dd1c807" class="i property">ApartmentState</a>;
 
            <a href="#f2c8813b33dfca3f" class="k">this</a>.<a href="#297405db9d28f350" class="i method">PropagateApplicationPrivateData</a>(<span class="r67 r">result</span>);
 
            <span class="r67 r">result</span>.<a href="Connection.cs.html#61f55439fb78f2fe" class="i method">Open</a>();
 
            <span class="c">// Enforce the system lockdown policy if one is defined.</span>
            <a href="../Utils.cs.html#9185d6ecbaebbec0" class="t t">Utils</a>.<a href="../Utils.cs.html#dbcc27a19c6d4943" class="i method">EnforceSystemLockDownLanguageMode</a>(<span class="r67 r">result</span>.<a href="Connection.cs.html#3a36e24a88649363" class="i property">ExecutionContext</a>);
 
            <span class="r67 r">result</span>.<a href="Connection.cs.html#76f15a0f04e941d7" class="i property">Events</a>.<a href="../EventManager.cs.html#e341129bc262ba81" class="i">ForwardEvent</a> += <span class="i">OnRunspaceForwardEvent</span>; <span class="c">// this must be done after open since open initializes the ExecutionContext</span>
 
            <b>lock</b> (<a href="#43b18ffe73b89022" class="i field">runspaceList</a>)
            {
                <a href="#43b18ffe73b89022" class="i field">runspaceList</a>.<span class="i">Add</span>(<span class="r67 r">result</span>);
                <a href="#d44d1efc92d291e9" class="i field">totalRunspaces</a> = <a href="#43b18ffe73b89022" class="i field">runspaceList</a>.<span class="i">Count</span>;
            }
 
            <span class="c">// Start/Reset the cleanup timer to release idle runspaces in the pool.</span>
            <b>lock</b> (<a href="#f2c8813b33dfca3f" class="k">this</a>.<a href="#21db200b449932ac" class="i field">syncObject</a>)
            {
                <a href="#563d49ceba80af5d" class="i field">_cleanupTimer</a>.<span class="i">Change</span>(<a href="#fe641c439ba50055" class="i property">CleanupInterval</a>, <a href="#fe641c439ba50055" class="i property">CleanupInterval</a>);
            }
 
            <span class="c">// raise the RunspaceCreated event and let callers handle it.</span>
            <a href="#a8982cbf9849c30a" class="i">RunspaceCreated</a>.<span class="i">SafeInvoke</span>(<a href="#f2c8813b33dfca3f" class="k">this</a>, <b>new</b> <a href="RunspacePool.cs.html#a2c40eb236d69276" class="t constructor">RunspaceCreatedEventArgs</a>(<span class="r67 r">result</span>));
 
            <b>return</b> <span class="r67 r">result</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Cleans/Closes the runspace.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r68 r">runspace</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Runspace to be closed/cleaned</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>protected void</b> <a id="241e509a06d5bc63" href="../../R/241e509a06d5bc63.html" target="n" data-glyph="75,1" class="i method">DestroyRunspace</a>(<a href="Connection.cs.html#7e5b8eab1aa16fd7" class="t t">Runspace</a> <span id="r68 rd" class="r68 r">runspace</span>)
        {
            <a href="../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r68 r">runspace</span> != <b>null</b>, <span class="s">&quot;Runspace cannot be null&quot;</span>);
            <span class="r68 r">runspace</span>.<a href="Connection.cs.html#76f15a0f04e941d7" class="i property">Events</a>.<a href="../EventManager.cs.html#e341129bc262ba81" class="i">ForwardEvent</a> -= <span class="i">OnRunspaceForwardEvent</span>; <span class="c">// this must be done after open since open initializes the ExecutionContext</span>
            <span class="r68 r">runspace</span>.<a href="Connection.cs.html#e7b6aa3b7b07847b" class="i method">Close</a>();
            <span class="r68 r">runspace</span>.<a href="Connection.cs.html#47cd985e55a9f99c" class="i method">Dispose</a>();
            <b>lock</b> (<a href="#43b18ffe73b89022" class="i field">runspaceList</a>)
            {
                <a href="#43b18ffe73b89022" class="i field">runspaceList</a>.<span class="i">Remove</span>(<span class="r68 r">runspace</span>);
                <a href="#d44d1efc92d291e9" class="i field">totalRunspaces</a> = <a href="#43b18ffe73b89022" class="i field">runspaceList</a>.<span class="i">Count</span>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Cleans the pool closing the runspaces that are idle.</span>
        <span class="c">///</span><span class="c"> This method is called as part of a timer callback.</span>
        <span class="c">///</span><span class="c"> This method will make sure atleast minPoolSz number</span>
        <span class="c">///</span><span class="c"> of Runspaces are active.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r69 r">state</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>protected void</b> <a id="801c099f393c70f5" href="../../R/../../0000000000.html" target="n" data-glyph="75,1" class="i method">CleanupCallback</a>(<b>object</b> <span id="r69 rd" class="r69 r">state</span>)
        {
            <a href="../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>((<a href="#f2c8813b33dfca3f" class="k">this</a>.<a href="#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../remoting/common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a> != <a href="RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="RunspacePool.cs.html#fb0d368190577383" class="i field">Disconnected</a> &amp;&amp;
                        <a href="#f2c8813b33dfca3f" class="k">this</a>.<a href="#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../remoting/common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a> != <a href="RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="RunspacePool.cs.html#91690c7b66b3081a" class="i field">Disconnecting</a> &amp;&amp;
                        <a href="#f2c8813b33dfca3f" class="k">this</a>.<a href="#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../remoting/common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a> != <a href="RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="RunspacePool.cs.html#332d1241bf520aa3" class="i field">Connecting</a>),
                       <span class="s">&quot;Local RunspacePool cannot be in disconnect/connect states&quot;</span>);
 
            <b>bool</b> <span id="r70 rd" class="r70 r">isCleanupTimerChanged</span> = <b>false</b>;
            <span class="c">// Clean up the pool only if more runspaces</span>
            <span class="c">// than minimum requested are present.</span>
            <b>while</b> (<a href="#d44d1efc92d291e9" class="i field">totalRunspaces</a> &gt; <a href="#f6fb1db5180e27f3" class="i field">minPoolSz</a>)
            {
                <span class="c">// if the pool is closing just return..</span>
                <b>if</b> (<a href="#f2c8813b33dfca3f" class="k">this</a>.<a href="#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../remoting/common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a> == <a href="RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="RunspacePool.cs.html#2b6027539b9d1816" class="i field">Closing</a>)
                {
                    <b>return</b>;
                }
 
                <span class="c">// This is getting run on a threadpool thread</span>
                <span class="c">// it is ok to take the hit on locking and unlocking.</span>
                <span class="c">// this will release request threads depending</span>
                <span class="c">// on thread scheduling</span>
                <a href="Connection.cs.html#7e5b8eab1aa16fd7" class="t t">Runspace</a> <span id="r71 rd" class="r71 r">runspaceToDestroy</span> = <b>null</b>;
                <b>lock</b> (<a href="#86e97148ee0b7b2e" class="i field">pool</a>)
                {
                    <b>if</b> (<a href="#86e97148ee0b7b2e" class="i field">pool</a>.<span class="i">Count</span> == 0)
                    {
                        <b>break</b>; <span class="c">// break from while</span>
                    }
 
                    <span class="r71 r">runspaceToDestroy</span> = <a href="#86e97148ee0b7b2e" class="i field">pool</a>.<span class="i">Pop</span>();
                }
 
                <span class="c">// Stop the clean up timer only when we are about to clean runspaces.</span>
                <span class="c">// It will be restarted when a new runspace is created.</span>
                <b>if</b> (!<span class="r70 r">isCleanupTimerChanged</span>)
                {
                    <b>lock</b> (<a href="#f2c8813b33dfca3f" class="k">this</a>.<a href="#21db200b449932ac" class="i field">syncObject</a>)
                    {
                        <a href="#563d49ceba80af5d" class="i field">_cleanupTimer</a>.<span class="i">Change</span>(<span class="i">Timeout</span>.<span class="i">Infinite</span>, <span class="i">Timeout</span>.<span class="i">Infinite</span>);
                        <span class="r70 r">isCleanupTimerChanged</span> = <b>true</b>;
                    }
                }
 
                <span class="c">// destroy runspace outside of the lock</span>
                <a href="#241e509a06d5bc63" class="i method">DestroyRunspace</a>(<span class="r71 r">runspaceToDestroy</span>);
                <b>continue</b>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Close all the runspaces in the pool.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private void</b> <a id="36a9edc8fa101a91" href="../../R/36a9edc8fa101a91.html" target="n" data-glyph="76,1" class="i method">InternalClearAllResources</a>()
        {
            <b>string</b> <span id="r72 rd" class="r72 r">message</span> = <a href="../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">RunspacePoolStrings</span>.<span class="i">InvalidRunspacePoolState</span>, <a href="RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="RunspacePool.cs.html#13cbf83371c004e0" class="i field">Opened</a>, <a href="#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../remoting/common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a>);
            <span class="i">Exception</span> <span id="r73 rd" class="r73 r">invalidStateException</span> = <b>new</b> <a href="RunspacePool.cs.html#53060b2dd310e4fc" class="t constructor">InvalidRunspacePoolStateException</a>(<span class="r72 r">message</span>,
                 <a href="#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../remoting/common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a>, <a href="RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="RunspacePool.cs.html#13cbf83371c004e0" class="i field">Opened</a>);
            <a href="RunspacePool.cs.html#f9f1d68e9fc0927c" class="t t">GetRunspaceAsyncResult</a> <span id="r74 rd" class="r74 r">runspaceRequester</span>;
 
            <span class="c">// clear the request queue first..this way waiting threads</span>
            <span class="c">// are immediately notified.</span>
            <b>lock</b> (<a href="#0b6c810cd4215eae" class="i field">runspaceRequestQueue</a>)
            {
                <b>while</b> (<a href="#0b6c810cd4215eae" class="i field">runspaceRequestQueue</a>.<span class="i">Count</span> &gt; 0)
                {
                    <span class="r74 r">runspaceRequester</span> = <a href="#0b6c810cd4215eae" class="i field">runspaceRequestQueue</a>.<span class="i">Dequeue</span>();
                    <span class="r74 r">runspaceRequester</span>.<a href="AsyncResult.cs.html#2d78c0fa1b51bb6e" class="i method">SetAsCompleted</a>(<span class="r73 r">invalidStateException</span>);
                }
            }
 
            <b>lock</b> (<a href="#4f2590b152f5c1d3" class="i field">ultimateRequestQueue</a>)
            {
                <b>while</b> (<a href="#4f2590b152f5c1d3" class="i field">ultimateRequestQueue</a>.<span class="i">Count</span> &gt; 0)
                {
                    <span class="r74 r">runspaceRequester</span> = <a href="#4f2590b152f5c1d3" class="i field">ultimateRequestQueue</a>.<span class="i">Dequeue</span>();
                    <span class="r74 r">runspaceRequester</span>.<a href="AsyncResult.cs.html#2d78c0fa1b51bb6e" class="i method">SetAsCompleted</a>(<span class="r73 r">invalidStateException</span>);
                }
            }
 
            <span class="c">// close all the runspaces</span>
            <span class="i">List</span>&lt;<a href="Connection.cs.html#7e5b8eab1aa16fd7" class="t t">Runspace</a>&gt; <span id="r75 rd" class="r75 r">runspaceListCopy</span> = <b>new</b> <span class="i">List</span>&lt;<a href="Connection.cs.html#7e5b8eab1aa16fd7" class="t t">Runspace</a>&gt;();
 
            <b>lock</b> (<a href="#43b18ffe73b89022" class="i field">runspaceList</a>)
            {
                <span class="r75 r">runspaceListCopy</span>.<span class="i">AddRange</span>(<a href="#43b18ffe73b89022" class="i field">runspaceList</a>);
                <a href="#43b18ffe73b89022" class="i field">runspaceList</a>.<span class="i">Clear</span>();
            }
 
            <span class="c">// Start from the most recent runspace.</span>
            <b>for</b> (<b>int</b> <span id="r76 rd" class="r76 r">index</span> = <span class="r75 r">runspaceListCopy</span>.<span class="i">Count</span> - 1; <span class="r76 r">index</span> &gt;= 0; <span class="r76 r">index</span>--)
            {
                <span class="c">// close runspaces suppress exceptions</span>
                <b>try</b>
                {
                    <span class="c">// this will release pipelines executing in the</span>
                    <span class="c">// runspace.</span>
                    <span class="r75 r">runspaceListCopy</span>[<span class="r76 r">index</span>].<span class="i">Close</span>();
                    <span class="r75 r">runspaceListCopy</span>[<span class="r76 r">index</span>].<span class="i">Dispose</span>();
                }
                <b>catch</b> (<a href="Connection.cs.html#340ccbbd1c6e8b87" class="t t">InvalidRunspaceStateException</a>)
                {
                }
            }
 
            <b>lock</b> (<a href="#86e97148ee0b7b2e" class="i field">pool</a>)
            {
                <a href="#86e97148ee0b7b2e" class="i field">pool</a>.<span class="i">Clear</span>();
            }
 
            <span class="c">// dont release pool/runspacelist/runspaceRequestQueue/ultimateRequestQueue as they</span>
            <span class="c">// might be accessed in lock() statements from another thread.</span>
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r77 r">requestToEnqueue</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> is not null, enqueues the request.</span>
        <span class="c">///</span><span class="c"> Checks if a thread pool thread is queued to service pending requests</span>
        <span class="c">///</span><span class="c"> for runspace. If a thread is not queued, queues one.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r77 r">requestToEnqueue</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Used by calling threads to queue a request before checking and starting</span>
        <span class="c">///</span><span class="c"> servicing thread.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r78 r">useCallingThread</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> uses calling thread to assign available runspaces (if any) to runspace</span>
        <span class="c">///</span><span class="c"> requesters.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>protected void</b> <a id="33ea6929a270c53b" href="../../R/33ea6929a270c53b.html" target="n" data-glyph="75,1" class="i method">EnqueueCheckAndStartRequestServicingThread</a>(<a href="RunspacePool.cs.html#f9f1d68e9fc0927c" class="t t">GetRunspaceAsyncResult</a> <span id="r77 rd" class="r77 r">requestToEnqueue</span>,
            <b>bool</b> <span id="r78 rd" class="r78 r">useCallingThread</span>)
        {
            <b>bool</b> <span id="r79 rd" class="r79 r">shouldStartServicingInSameThread</span> = <b>false</b>;
            <b>lock</b> (<a href="#0b6c810cd4215eae" class="i field">runspaceRequestQueue</a>)
            {
                <b>if</b> (<span class="r77 r">requestToEnqueue</span> != <b>null</b>)
                {
                    <a href="#0b6c810cd4215eae" class="i field">runspaceRequestQueue</a>.<span class="i">Enqueue</span>(<span class="r77 r">requestToEnqueue</span>);
                }
 
                <span class="c">// if a thread is already servicing requests..just return.</span>
                <b>if</b> (<a href="#277a81a88eb2f671" class="i field">isServicingRequests</a>)
                {
                    <b>return</b>;
                }
 
                <b>if</b> ((<a href="#0b6c810cd4215eae" class="i field">runspaceRequestQueue</a>.<span class="i">Count</span> + <a href="#4f2590b152f5c1d3" class="i field">ultimateRequestQueue</a>.<span class="i">Count</span>) &gt; 0)
                {
                    <span class="c">// we have requests pending..check if a runspace is available to</span>
                    <span class="c">// service the requests.</span>
                    <b>lock</b> (<a href="#86e97148ee0b7b2e" class="i field">pool</a>)
                    {
                        <b>if</b> ((<a href="#86e97148ee0b7b2e" class="i field">pool</a>.<span class="i">Count</span> &gt; 0) || (<a href="#d44d1efc92d291e9" class="i field">totalRunspaces</a> &lt; <a href="#eb45e1e66196a2b6" class="i field">maxPoolSz</a>))
                        {
                            <a href="#277a81a88eb2f671" class="i field">isServicingRequests</a> = <b>true</b>;
                            <b>if</b> ((<span class="r78 r">useCallingThread</span>) &amp;&amp; (<a href="#4f2590b152f5c1d3" class="i field">ultimateRequestQueue</a>.<span class="i">Count</span> == 0))
                            {
                                <span class="r79 r">shouldStartServicingInSameThread</span> = <b>true</b>;
                            }
                            <b>else</b>
                            {
                                <span class="c">// release a async result object using a thread pool thread.</span>
                                <span class="c">// this way the calling thread will not block.</span>
                                <span class="i">ThreadPool</span>.<span class="i">QueueUserWorkItem</span>(<b>new</b> <span class="i">WaitCallback</span>(<span class="i">ServicePendingRequests</span>), <b>false</b>);
                            }
                        }
                    }
                }
            }
 
            <span class="c">// only one thread will be here if any..</span>
            <span class="c">// This will allow us to release lock.</span>
            <b>if</b> (<span class="r79 r">shouldStartServicingInSameThread</span>)
            {
                <a href="#128ff5a016139364" class="i method">ServicePendingRequests</a>(<b>true</b>);
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Releases any readers in the reader queue waiting for</span>
        <span class="c">///</span><span class="c"> Runspace.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r80 r">useCallingThreadState</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This is of type object..because this method is called from a ThreadPool</span>
        <span class="c">///</span><span class="c"> Thread.</span>
        <span class="c">///</span><span class="c"> true, if calling thread should be used to assign a runspace.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>protected void</b> <a id="128ff5a016139364" href="../../R/128ff5a016139364.html" target="n" data-glyph="75,1" class="i method">ServicePendingRequests</a>(<b>object</b> <span id="r80 rd" class="r80 r">useCallingThreadState</span>)
        {
            <span class="c">// Check if the pool is closed or closing..if so return.</span>
            <b>if</b> ((<a href="#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../remoting/common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a> == <a href="RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="RunspacePool.cs.html#494904731e18b593" class="i field">Closed</a>) || (<a href="#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../remoting/common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a> == <a href="RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="RunspacePool.cs.html#2b6027539b9d1816" class="i field">Closing</a>))
            {
                <b>return</b>;
            }
 
            <a href="../../utils/assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="../../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>((<a href="#f2c8813b33dfca3f" class="k">this</a>.<a href="#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../remoting/common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a> != <a href="RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="RunspacePool.cs.html#fb0d368190577383" class="i field">Disconnected</a> &amp;&amp;
                        <a href="#f2c8813b33dfca3f" class="k">this</a>.<a href="#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../remoting/common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a> != <a href="RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="RunspacePool.cs.html#91690c7b66b3081a" class="i field">Disconnecting</a> &amp;&amp;
                        <a href="#f2c8813b33dfca3f" class="k">this</a>.<a href="#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../remoting/common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a> != <a href="RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="RunspacePool.cs.html#332d1241bf520aa3" class="i field">Connecting</a>),
                       <span class="s">&quot;Local RunspacePool cannot be in disconnect/connect states&quot;</span>);
 
            <b>bool</b> <span id="r81 rd" class="r81 r">useCallingThread</span> = (<b>bool</b>)<span class="r80 r">useCallingThreadState</span>;
            <a href="RunspacePool.cs.html#f9f1d68e9fc0927c" class="t t">GetRunspaceAsyncResult</a> <span id="r82 rd" class="r82 r">runspaceRequester</span> = <b>null</b>;
 
            <b>try</b>
            {
                <b>while</b> (<b>true</b>)
                {
                    <b>lock</b> (<a href="#4f2590b152f5c1d3" class="i field">ultimateRequestQueue</a>)
                    {
                        <b>while</b> (<a href="#4f2590b152f5c1d3" class="i field">ultimateRequestQueue</a>.<span class="i">Count</span> &gt; 0)
                        {
                            <span class="c">// if the pool is closing just return..</span>
                            <b>if</b> (<a href="#f2c8813b33dfca3f" class="k">this</a>.<a href="#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../remoting/common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a> == <a href="RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="RunspacePool.cs.html#2b6027539b9d1816" class="i field">Closing</a>)
                            {
                                <b>return</b>;
                            }
 
                            <a href="Connection.cs.html#7e5b8eab1aa16fd7" class="t t">Runspace</a> <span id="r83 rd" class="r83 r">result</span>;
                            <b>lock</b> (<a href="#86e97148ee0b7b2e" class="i field">pool</a>)
                            {
                                <b>if</b> (<a href="#86e97148ee0b7b2e" class="i field">pool</a>.<span class="i">Count</span> &gt; 0)
                                {
                                    <span class="r83 r">result</span> = <a href="#86e97148ee0b7b2e" class="i field">pool</a>.<span class="i">Pop</span>();
                                }
                                <b>else</b> <b>if</b> (<a href="#d44d1efc92d291e9" class="i field">totalRunspaces</a> &gt;= <a href="#eb45e1e66196a2b6" class="i field">maxPoolSz</a>)
                                {
                                    <span class="c">// no runspace is available..</span>
                                    <b>return</b>;
                                }
                                <b>else</b>
                                {
                                    <span class="c">// TODO: how to handle exceptions if runspace</span>
                                    <span class="c">// creation fails.</span>
                                    <span class="c">// Create a new runspace..since the max limit is</span>
                                    <span class="c">// not reached.</span>
                                    <span class="r83 r">result</span> = <a href="#10513baed86d2c9e" class="i method">CreateRunspace</a>();
                                }
                            }
 
                            <span class="c">// Dequeue a runspace request</span>
                            <span class="r82 r">runspaceRequester</span> = <a href="#4f2590b152f5c1d3" class="i field">ultimateRequestQueue</a>.<span class="i">Dequeue</span>();
                            <span class="c">// if the runspace is not active send the runspace back to</span>
                            <span class="c">// the pool and process other requests</span>
                            <b>if</b> (!<span class="r82 r">runspaceRequester</span>.<a href="RunspacePool.cs.html#ea99cb2205e6f78b" class="i property">IsActive</a>)
                            {
                                <b>lock</b> (<a href="#86e97148ee0b7b2e" class="i field">pool</a>)
                                {
                                    <a href="#86e97148ee0b7b2e" class="i field">pool</a>.<span class="i">Push</span>(<span class="r83 r">result</span>);
                                }
                                <span class="c">// release the runspace requester</span>
                                <span class="r82 r">runspaceRequester</span>.<a href="AsyncResult.cs.html#112d0ced737442f7" class="i method">Release</a>();
                                <b>continue</b>;
                            }
                            <span class="c">// release readers waiting for runspace on a thread pool</span>
                            <span class="c">// thread.</span>
                            <span class="r82 r">runspaceRequester</span>.<a href="RunspacePool.cs.html#7bcf34c464baed9e" class="i property">Runspace</a> = <span class="r83 r">result</span>;
                            <span class="c">// release the async operation on a thread pool thread.</span>
                            <b>if</b> (<span class="r81 r">useCallingThread</span>)
                            {
                                <span class="c">// call DoComplete outside of the lock..as the</span>
                                <span class="c">// DoComplete handler may handle the runspace</span>
                                <span class="c">// in the same thread thereby blocking future</span>
                                <span class="c">// servicing requests.</span>
                                <b>goto</b> <span class="i">endOuterWhile</span>;
                            }
                            <b>else</b>
                            {
                                <span class="i">ThreadPool</span>.<span class="i">QueueUserWorkItem</span>(<b>new</b> <span class="i">WaitCallback</span>(<span class="r82 r">runspaceRequester</span>.<span class="i">DoComplete</span>));
                            }
                        }
                    }
 
                    <b>lock</b> (<a href="#0b6c810cd4215eae" class="i field">runspaceRequestQueue</a>)
                    {
                        <b>if</b> (<a href="#0b6c810cd4215eae" class="i field">runspaceRequestQueue</a>.<span class="i">Count</span> == 0)
                        {
                            <b>break</b>;
                        }
 
                        <span class="c">// copy requests from one queue to another and start</span>
                        <span class="c">// processing the other queue</span>
                        <b>while</b> (<a href="#0b6c810cd4215eae" class="i field">runspaceRequestQueue</a>.<span class="i">Count</span> &gt; 0)
                        {
                            <a href="#4f2590b152f5c1d3" class="i field">ultimateRequestQueue</a>.<span class="i">Enqueue</span>(<a href="#0b6c810cd4215eae" class="i field">runspaceRequestQueue</a>.<span class="i">Dequeue</span>());
                        }
                    }
                }
            <span class="i">endOuterWhile</span>:;
            }
            <b>finally</b>
            {
                <b>lock</b> (<a href="#0b6c810cd4215eae" class="i field">runspaceRequestQueue</a>)
                {
                    <a href="#277a81a88eb2f671" class="i field">isServicingRequests</a> = <b>false</b>;
                    <span class="c">// check if any new runspace request has arrived..</span>
                    <a href="#33ea6929a270c53b" class="i method">EnqueueCheckAndStartRequestServicingThread</a>(<b>null</b>, <b>false</b>);
                }
            }
 
            <b>if</b> ((<span class="r81 r">useCallingThread</span>) &amp;&amp; (<span class="r82 r">runspaceRequester</span> != <b>null</b>))
            {
                <span class="c">// call DoComplete outside of the lock and finally..as the</span>
                <span class="c">// DoComplete handler may handle the runspace in the same</span>
                <span class="c">// thread thereby blocking future servicing requests.</span>
                <span class="r82 r">runspaceRequester</span>.<a href="RunspacePool.cs.html#50b13122647ab222" class="i method">DoComplete</a>(<b>null</b>);
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Throws an exception if the runspace state is not</span>
        <span class="c">///</span><span class="c"> BeforeOpen.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>protected void</b> <a id="38a7e17d18f5dbc9" href="../../R/38a7e17d18f5dbc9.html" target="n" data-glyph="75,1" class="i method">AssertIfStateIsBeforeOpen</a>()
        {
            <b>if</b> (<a href="#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../remoting/common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a> != <a href="RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="RunspacePool.cs.html#66c805b7b59385a4" class="i field">BeforeOpen</a>)
            {
                <span class="c">// Call fails if RunspacePoolState is not BeforeOpen.</span>
                <a href="RunspacePool.cs.html#741ffc1755303d69" class="t t">InvalidRunspacePoolStateException</a> <span id="r84 rd" class="r84 r">e</span> =
                    <b>new</b> <a href="RunspacePool.cs.html#53060b2dd310e4fc" class="t constructor">InvalidRunspacePoolStateException</a>
                    (
                        <a href="../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">RunspacePoolStrings</span>.<span class="i">CannotOpenAgain</span>,
                            <b>new</b> <b>object</b>[] { <a href="#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../remoting/common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a>.<span class="i">ToString</span>() }
                        ),
                        <a href="#37ed160e0fbfb67a" class="i field">stateInfo</a>.<a href="../remoting/common/RunspacePoolStateInfo.cs.html#1260ebc06dcda58e" class="i property">State</a>,
                        <a href="RunspacePool.cs.html#b51dd15975151fb4" class="t t">RunspacePoolState</a>.<a href="RunspacePool.cs.html#66c805b7b59385a4" class="i field">BeforeOpen</a>
                    );
                <b>throw</b> <span class="r84 r">e</span>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Raises the ForwardEvent event.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>protected virtual void</b> <a id="b11455355be4eec7" href="../../R/b11455355be4eec7.html" target="n" data-glyph="75,1" class="i method">OnForwardEvent</a>(<a href="../EventManager.cs.html#7210411b2f4a8407" class="t t">PSEventArgs</a> <span id="r85 rd" class="r85 r">e</span>)
        {
            <a href="#f2c8813b33dfca3f" class="k">this</a>.<a href="#1f21f3fbd0dee755" class="i">ForwardEvent</a>?.<span class="i">Invoke</span>(<a href="#f2c8813b33dfca3f" class="k">this</a>, <span class="r85 r">e</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Forward runspace events to the pool&#39;s event queue.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private void</b> <a id="75348a60b7004459" href="../../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">OnRunspaceForwardEvent</a>(<b>object</b> <span id="r86 rd" class="r86 r">sender</span>, <a href="../EventManager.cs.html#7210411b2f4a8407" class="t t">PSEventArgs</a> <span id="r87 rd" class="r87 r">e</span>)
        {
            <b>if</b> (<span class="r87 r">e</span>.<a href="../EventManager.cs.html#d46e9434510d399e" class="i property">ForwardEvent</a>)
            {
                <a href="#b11455355be4eec7" class="i method">OnForwardEvent</a>(<span class="r87 r">e</span>);
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
    }
}
</pre></td></tr></table></div></body></html>
