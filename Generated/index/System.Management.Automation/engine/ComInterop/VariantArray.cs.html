<!DOCTYPE html>
<html><head><title>VariantArray.cs</title><link rel="stylesheet" href="../../../styles.css"><script src="../../../scripts.js"></script></head>
<body class="cB" onload="i(104);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#System.Management.Automation/engine/ComInterop/VariantArray.cs" target="_top">engine\ComInterop\VariantArray.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#System.Management.Automation" target="_top">src\System.Management.Automation\System.Management.Automation.csproj</a> (System.Management.Automation)</td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Licensed to the .NET Foundation under one or more agreements.</span>
<span class="c">// The .NET Foundation licenses this file to you under the MIT license.</span>
 
<b>using</b> <span class="i n">System</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Collections</span>.<span class="i">Generic</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Diagnostics</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Globalization</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Linq</span>.<span class="i">Expressions</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Reflection</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Reflection</span>.<span class="i">Emit</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">InteropServices</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Runtime</span>.<span class="i">InteropServices</span>;
 
<b>namespace</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">ComInterop</span>
{
    [<span class="i">StructLayout</span>(<span class="i">LayoutKind</span>.<span class="i">Sequential</span>)]
    <b>internal struct</b> <a id="c0368d19fa9e8a1b" href="../../R/c0368d19fa9e8a1b.html" target="n" data-glyph="110,0" class="t t"><span id="78e4462a9884b7f4">VariantArray1</span></a>
    {
        <b>public</b> <a href="../../P/8d6f8cfa0d0f7877.html#8d6f8cfa0d0f7877" class="t t">Variant</a> <a id="9e34a407840e4f02" href="../../R/../../0000000000.html" target="n" data-glyph="42,1" class="i field">Element0</a>;
    }
 
    [<span class="i">StructLayout</span>(<span class="i">LayoutKind</span>.<span class="i">Sequential</span>)]
    <b>internal struct</b> <a id="e446a7406381c488" href="../../R/e446a7406381c488.html" target="n" data-glyph="110,0" class="t t"><span id="385c4c1b2a510e84">VariantArray2</span></a>
    {
        <b>public</b> <a href="../../P/8d6f8cfa0d0f7877.html#8d6f8cfa0d0f7877" class="t t">Variant</a> <a id="4254ba0060ab203f" href="../../R/../../0000000000.html" target="n" data-glyph="42,1" class="i field">Element0</a>, <a id="79a215935d491aee" href="../../R/../../0000000000.html" target="n" data-glyph="42,1" class="i field">Element1</a>;
    }
 
    [<span class="i">StructLayout</span>(<span class="i">LayoutKind</span>.<span class="i">Sequential</span>)]
    <b>internal struct</b> <a id="e6e24442f484d759" href="../../R/e6e24442f484d759.html" target="n" data-glyph="110,0" class="t t"><span id="a678a4d1228b1836">VariantArray4</span></a>
    {
        <b>public</b> <a href="../../P/8d6f8cfa0d0f7877.html#8d6f8cfa0d0f7877" class="t t">Variant</a> <a id="2691d3c4b2ece2ee" href="../../R/../../0000000000.html" target="n" data-glyph="42,1" class="i field">Element0</a>, <a id="d63d4c068cbf80b5" href="../../R/../../0000000000.html" target="n" data-glyph="42,1" class="i field">Element1</a>, <a id="3e13e69c3d580742" href="../../R/../../0000000000.html" target="n" data-glyph="42,1" class="i field">Element2</a>, <a id="fa46e6913f0674e8" href="../../R/../../0000000000.html" target="n" data-glyph="42,1" class="i field">Element3</a>;
    }
 
    [<span class="i">StructLayout</span>(<span class="i">LayoutKind</span>.<span class="i">Sequential</span>)]
    <b>internal struct</b> <a id="7585b90d7356588c" href="../../R/7585b90d7356588c.html" target="n" data-glyph="110,0" class="t t"><span id="57a027c22d57e1b7">VariantArray8</span></a>
    {
        <b>public</b> <a href="../../P/8d6f8cfa0d0f7877.html#8d6f8cfa0d0f7877" class="t t">Variant</a> <a id="1879c3bd99bf3b57" href="../../R/../../0000000000.html" target="n" data-glyph="42,1" class="i field">Element0</a>, <a id="9a76c59427d6ab3d" href="../../R/../../0000000000.html" target="n" data-glyph="42,1" class="i field">Element1</a>, <a id="c16ecf39ef48fdc5" href="../../R/../../0000000000.html" target="n" data-glyph="42,1" class="i field">Element2</a>, <a id="9ce811223e7f13a2" href="../../R/../../0000000000.html" target="n" data-glyph="42,1" class="i field">Element3</a>, <a id="2099fa08f0b559d2" href="../../R/../../0000000000.html" target="n" data-glyph="42,1" class="i field">Element4</a>, <a id="8ee71fc241c4412c" href="../../R/../../0000000000.html" target="n" data-glyph="42,1" class="i field">Element5</a>, <a id="9c58ddddb8498a87" href="../../R/../../0000000000.html" target="n" data-glyph="42,1" class="i field">Element6</a>, <a id="bba0a35496bdaf99" href="../../R/../../0000000000.html" target="n" data-glyph="42,1" class="i field">Element7</a>;
    }
 
    <span class="c">//</span>
    <span class="c">// Helper for getting the right VariantArray struct for a given number of</span>
    <span class="c">// arguments. Will generate a struct if needed.</span>
    <span class="c">//</span>
    <span class="c">// We use this because we don&#39;t have stackalloc or pinning in Expression</span>
    <span class="c">// Trees, so we can&#39;t create an array of Variants directly.</span>
    <span class="c">//</span>
    <b>internal static class</b> <a id="09096252269e2bf3" href="../../R/09096252269e2bf3.html" target="n" data-glyph="2,0" class="t t">VariantArray</a>
    {
        <span class="c">// Don&#39;t need a dictionary for this, it will have very few elements</span>
        <span class="c">// (guaranteed less than 28, in practice 0-2)</span>
        <b>private static readonly</b> <span class="i">List</span>&lt;<span class="i">Type</span>&gt; <a id="f9a635341620b495" href="../../R/f9a635341620b495.html" target="n" data-glyph="46,1" class="i field">s_generatedTypes</a> = <b>new</b> <span class="i">List</span>&lt;<span class="i">Type</span>&gt;(0);
 
        <b>internal static</b> <span class="i">MemberExpression</span> <a id="59af321e60d19303" href="../../R/59af321e60d19303.html" target="n" data-glyph="74,1" class="i method">GetStructField</a>(<span class="i">ParameterExpression</span> <span id="r0 rd" class="r0 r">variantArray</span>, <b>int</b> <span id="r1 rd" class="r1 r">field</span>)
        {
            <b>return</b> <span class="i">Expression</span>.<span class="i">Field</span>(<span class="r0 r">variantArray</span>, <span class="s">&quot;Element&quot;</span> + <span class="r1 r">field</span>);
        }
 
        <b>internal static</b> <span class="i">Type</span> <a id="0ece072aa24b8afc" href="../../R/../../0000000000.html" target="n" data-glyph="74,1" class="i method">GetStructType</a>(<b>int</b> <span id="r2 rd" class="r2 r">args</span>)
        {
            <span class="i">Debug</span>.<span class="i">Assert</span>(<span class="r2 r">args</span> &gt;= 0);
            <b>if</b> (<span class="r2 r">args</span> &lt;= 1) <b>return</b> <b>typeof</b>(<a href="#c0368d19fa9e8a1b" class="t t">VariantArray1</a>);
            <b>if</b> (<span class="r2 r">args</span> &lt;= 2) <b>return</b> <b>typeof</b>(<a href="#e446a7406381c488" class="t t">VariantArray2</a>);
            <b>if</b> (<span class="r2 r">args</span> &lt;= 4) <b>return</b> <b>typeof</b>(<a href="#e6e24442f484d759" class="t t">VariantArray4</a>);
            <b>if</b> (<span class="r2 r">args</span> &lt;= 8) <b>return</b> <b>typeof</b>(<a href="#7585b90d7356588c" class="t t">VariantArray8</a>);
 
            <b>int</b> <span id="r3 rd" class="r3 r">size</span> = 1;
            <b>while</b> (<span class="r2 r">args</span> &gt; <span class="r3 r">size</span>)
            {
                <span class="r3 r">size</span> *= 2;
            }
 
            <b>lock</b> (<a href="#f9a635341620b495" class="i field">s_generatedTypes</a>)
            {
                <span class="c">// See if we can find an existing type</span>
                <b>foreach</b> (<span class="i">Type</span> <span id="r4 rd" class="r4 r">t</span> <b>in</b> <a href="#f9a635341620b495" class="i field">s_generatedTypes</a>)
                {
                    <b>int</b> <span id="r5 rd" class="r5 r">arity</span> = <b>int</b>.<span class="i">Parse</span>(<span class="r4 r">t</span>.<span class="i">Name</span>.<span class="i">AsSpan</span>(<span class="s">&quot;VariantArray&quot;</span>.<span class="i">Length</span>), <span class="i">NumberStyles</span>.<span class="i">Integer</span>, <span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>);
                    <b>if</b> (<span class="r3 r">size</span> == <span class="r5 r">arity</span>)
                    {
                        <b>return</b> <span class="r4 r">t</span>;
                    }
                }
 
                <span class="c">// Else generate a new type</span>
                <span class="i">Type</span> <span id="r6 rd" class="r6 r">type</span> = <a href="#1a7c7d6fe8de21ea" class="i method">CreateCustomType</a>(<span class="r3 r">size</span>).<span class="i">MakeGenericType</span>(<b>new</b> <span class="i">Type</span>[] { <b>typeof</b>(<a href="../../P/8d6f8cfa0d0f7877.html#8d6f8cfa0d0f7877" class="t t">Variant</a>) });
                <a href="#f9a635341620b495" class="i field">s_generatedTypes</a>.<span class="i">Add</span>(<span class="r6 r">type</span>);
                <b>return</b> <span class="r6 r">type</span>;
            }
        }
 
        <b>private static</b> <span class="i">Type</span> <a id="1a7c7d6fe8de21ea" href="../../R/1a7c7d6fe8de21ea.html" target="n" data-glyph="76,1" class="i method">CreateCustomType</a>(<b>int</b> <span id="r7 rd" class="r7 r">size</span>)
        {
            <span class="i">TypeAttributes</span> <span id="r8 rd" class="r8 r">attrs</span> = <span class="i">TypeAttributes</span>.<span class="i">NotPublic</span> | <span class="i">TypeAttributes</span>.<span class="i">SequentialLayout</span>;
            <span class="i">TypeBuilder</span> <span id="r9 rd" class="r9 r">type</span> = <a href="ComRuntimeHelpers.cs.html#4f4b31ce559633ec" class="t t">UnsafeMethods</a>.<a href="ComRuntimeHelpers.cs.html#b70e140d63ac3bfd" class="i property">DynamicModule</a>.<span class="i">DefineType</span>(<span class="s">&quot;VariantArray&quot;</span> + <span class="r7 r">size</span>, <span class="r8 r">attrs</span>, <b>typeof</b>(<span class="i">ValueType</span>));
            <span class="i">GenericTypeParameterBuilder</span> <span id="r10 rd" class="r10 r">T</span> = <span class="r9 r">type</span>.<span class="i">DefineGenericParameters</span>(<b>new</b> <b>string</b>[] { <span class="s">&quot;T&quot;</span> })[0];
            <b>for</b> (<b>int</b> <span id="r11 rd" class="r11 r">i</span> = 0; <span class="r11 r">i</span> &lt; <span class="r7 r">size</span>; <span class="r11 r">i</span>++)
            {
                <span class="r9 r">type</span>.<span class="i">DefineField</span>(<span class="s">&quot;Element&quot;</span> + <span class="r11 r">i</span>, <span class="r10 r">T</span>, <span class="i">FieldAttributes</span>.<span class="i">Public</span>);
            }
            <b>return</b> <span class="r9 r">type</span>.<span class="i">CreateType</span>();
        }
    }
}
</pre></td></tr></table></div></body></html>
