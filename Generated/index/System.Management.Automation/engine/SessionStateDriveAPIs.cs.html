<!DOCTYPE html>
<html><head><title>SessionStateDriveAPIs.cs</title><link rel="stylesheet" href="../../styles.css"><script src="../../scripts.js"></script></head>
<body class="cB" onload="i(1454);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#System.Management.Automation/engine/SessionStateDriveAPIs.cs" target="_top">engine\SessionStateDriveAPIs.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#System.Management.Automation" target="_top">src\System.Management.Automation\System.Management.Automation.csproj</a> (System.Management.Automation)</td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation.</span>
<span class="c">// Licensed under the MIT License.</span>
 
<b>using</b> <span class="i n">System</span>.<span class="i">Collections</span>.<span class="i">Generic</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Collections</span>.<span class="i">ObjectModel</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">ComponentModel</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Globalization</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">IO</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Provider</span>;
 
<b>using</b> <span class="i">Dbg</span> = <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>;
 
<span class="k preprocess">#</span><span class="k preprocess">pragma</span> <span class="k preprocess">warning</span> <span class="k preprocess">disable</span> 1634, 1691 <span class="c">// Stops compiler from warning about unknown warnings</span>
<span class="k preprocess">#</span><span class="k preprocess">pragma</span> <span class="k preprocess">warning</span> <span class="k preprocess">disable</span> 56500
 
<b>namespace</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>
{
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Holds the state of a Monad Shell session.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>internal sealed</b> <a href="../P/2dc1bd90a8299178.html" target="s" class="k">partial</a> <b>class</b> <a id="2dc1bd90a8299178" href="../R/2dc1bd90a8299178.html" target="n" data-glyph="2,0" class="t t">SessionStateInternal</a>
    {
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The currently active drive. It determines the current working directory.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private</b> <a href="DataStoreAdapter.cs.html#2d16b26a541ba185" class="t t">PSDriveInfo</a> <a id="d40730fe860ee8d2" href="../R/d40730fe860ee8d2.html" target="n" data-glyph="46,1" class="i field">_currentDrive</a>;
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> NewDrive
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Adds the specified drive to the current scope.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r0 r">drive</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The drive to be added to the current scope.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r1 r">scopeID</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The ID for the scope to add the drive to. The scope ID can be any of the</span>
        <span class="c">///</span><span class="c"> &quot;special&quot; scope identifiers like &quot;global&quot;, &quot;local&quot;, or &quot;private&quot; or it</span>
        <span class="c">///</span><span class="c"> can be a numeric identifier that is a count of the number of parent</span>
        <span class="c">///</span><span class="c"> scopes up from the current scope to put the drive in.</span>
        <span class="c">///</span><span class="c"> If this parameter is null or empty the drive will be placed in the</span>
        <span class="c">///</span><span class="c"> current scope.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The drive that was added, if any.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">ArgumentNullException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r0 r">drive</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> is null.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">ArgumentException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If the drive already exists,</span>
        <span class="c">///</span><span class="c"> or</span>
        <span class="c">///</span><span class="c"> If </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r0 r">drive</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c">.Name contains one or more invalid characters; ~ / \\ . :</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">NotSupportedException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If the provider is not a DriveCmdletProvider.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="../utils/SessionStateExceptions.cs.html#a58038dc730da896" class="t t">ProviderNotFoundException</a><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The provider for the </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r0 r">drive</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> could not be found.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="../utils/SessionStateExceptions.cs.html#35e07c15a7526bcd" class="t t">ProviderInvocationException</a><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If the provider threw an exception or returned null.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>internal</b> <a href="DataStoreAdapter.cs.html#2d16b26a541ba185" class="t t">PSDriveInfo</a> <a id="7ee14fec09efe153" href="../R/7ee14fec09efe153.html" target="n" data-glyph="74,1" class="i method">NewDrive</a>(<a href="DataStoreAdapter.cs.html#2d16b26a541ba185" class="t t">PSDriveInfo</a> <span id="r0 rd" class="r0 r">drive</span>, <b>string</b> <span id="r1 rd" class="r1 r">scopeID</span>)
        {
            <b>if</b> (<span class="r0 r">drive</span> == <b>null</b>)
            {
                <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../utils/MshTraceSource.cs.html#fbe67220ad7522a0" class="i method">NewArgumentNullException</a>(<b>nameof</b>(<span class="r0 r">drive</span>));
            }
 
            <a href="DataStoreAdapter.cs.html#2d16b26a541ba185" class="t t">PSDriveInfo</a> <span id="r2 rd" class="r2 r">result</span> = <b>null</b>;
 
            <span class="c">// Construct a CmdletProviderContext and call the override</span>
 
            <a href="../namespaces/CoreCommandContext.cs.html#1e83d35d5286e174" class="t t">CmdletProviderContext</a> <span id="r3 rd" class="r3 r">context</span> = <b>new</b> <a href="../namespaces/CoreCommandContext.cs.html#8a0e078b40b2fd0e" class="t constructor">CmdletProviderContext</a>(<a href="../P/2dc1bd90a8299178.html#2dc1bd90a8299178" class="k">this</a>.<a href="SessionState.cs.html#3ddff2db6bc01805" class="i property">ExecutionContext</a>);
 
            <a href="#d8b93c2661e22c2e" class="i method">NewDrive</a>(<span class="r0 r">drive</span>, <span class="r1 r">scopeID</span>, <span class="r3 r">context</span>);
 
            <span class="r3 r">context</span>.<a href="../namespaces/CoreCommandContext.cs.html#c8e1b5c9dc612598" class="i method">ThrowFirstErrorOrDoNothing</a>();
 
            <span class="i">Collection</span>&lt;<a href="MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt; <span id="r4 rd" class="r4 r">successObjects</span> = <span class="r3 r">context</span>.<a href="../namespaces/CoreCommandContext.cs.html#c2d4b021c21c5144" class="i method">GetAccumulatedObjects</a>();
 
            <b>if</b> (<span class="r4 r">successObjects</span> != <b>null</b> &amp;&amp;
                <span class="r4 r">successObjects</span>.<span class="i">Count</span> &gt; 0)
            {
                <span class="i n">Dbg</span>.<a href="../utils/assert.cs.html#c04955255430d32f" class="t t">Diagnostics</a>.<a href="../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(
                    <span class="r4 r">successObjects</span>.<span class="i">Count</span> == 1,
                    <span class="s">&quot;NewDrive should only add one PSDriveInfo object to the pipeline&quot;</span>);
 
                <span class="c">// set the return value to the first drive (should only be one).</span>
 
                <b>if</b> (!<span class="r4 r">successObjects</span>[0].<span class="i">ImmediateBaseObjectIsEmpty</span>)
                {
                    <span class="r2 r">result</span> = (<a href="DataStoreAdapter.cs.html#2d16b26a541ba185" class="t t">PSDriveInfo</a>)<span class="r4 r">successObjects</span>[0].<span class="i">BaseObject</span>;
                }
            }
 
            <b>return</b> <span class="r2 r">result</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Adds a drive to the PowerShell namespace.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r5 r">drive</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The new drive to be added.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r6 r">scopeID</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The ID for the scope to add the drive to. The scope ID can be any of the</span>
        <span class="c">///</span><span class="c"> &quot;special&quot; scope identifiers like &quot;global&quot;, &quot;local&quot;, or &quot;private&quot; or it</span>
        <span class="c">///</span><span class="c"> can be a numeric identifier that is a count of the number of parent</span>
        <span class="c">///</span><span class="c"> scopes up from the current scope to put the drive in.</span>
        <span class="c">///</span><span class="c"> If this parameter is null or empty the drive will be placed in the</span>
        <span class="c">///</span><span class="c"> current scope.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r7 r">context</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The context which the core command is running.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">ArgumentNullException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r5 r">drive</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> or </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r7 r">context</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> is null.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">ArgumentException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If the drive already exists</span>
        <span class="c">///</span><span class="c"> or</span>
        <span class="c">///</span><span class="c"> If </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r5 r">drive</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c">.Name contains one or more invalid characters; ~ / \\ . :</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">ArgumentOutOfRangeException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r6 r">scopeID</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> is less than zero or greater than the number of currently</span>
        <span class="c">///</span><span class="c"> active scopes.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">NotSupportedException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If the provider is not a DriveCmdletProvider.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="../utils/SessionStateExceptions.cs.html#a58038dc730da896" class="t t">ProviderNotFoundException</a><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The provider for the </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r5 r">drive</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> could not be found.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="../utils/SessionStateExceptions.cs.html#35e07c15a7526bcd" class="t t">ProviderInvocationException</a><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If the provider threw an exception or returned null.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="d8b93c2661e22c2e" href="../R/d8b93c2661e22c2e.html" target="n" data-glyph="74,1" class="i method">NewDrive</a>(<a href="DataStoreAdapter.cs.html#2d16b26a541ba185" class="t t">PSDriveInfo</a> <span id="r5 rd" class="r5 r">drive</span>, <b>string</b> <span id="r6 rd" class="r6 r">scopeID</span>, <a href="../namespaces/CoreCommandContext.cs.html#1e83d35d5286e174" class="t t">CmdletProviderContext</a> <span id="r7 rd" class="r7 r">context</span>)
        {
            <b>if</b> (<span class="r5 r">drive</span> == <b>null</b>)
            {
                <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../utils/MshTraceSource.cs.html#fbe67220ad7522a0" class="i method">NewArgumentNullException</a>(<b>nameof</b>(<span class="r5 r">drive</span>));
            }
 
            <b>if</b> (<span class="r7 r">context</span> == <b>null</b>)
            {
                <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../utils/MshTraceSource.cs.html#fbe67220ad7522a0" class="i method">NewArgumentNullException</a>(<b>nameof</b>(<span class="r7 r">context</span>));
            }
 
            <b>if</b> (!<a href="#425ce8380c5b8436" class="i method">IsValidDriveName</a>(<span class="r5 r">drive</span>.<a href="DataStoreAdapter.cs.html#7c2d83a1b2b425a9" class="i property">Name</a>))
            {
                <span class="i">ArgumentException</span> <span id="r8 rd" class="r8 r">e</span> =
                    <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<span class="i">NewArgumentException</span>(
                        <span class="s">&quot;drive.Name&quot;</span>,
                        <span class="i">SessionStateStrings</span>.<span class="i">DriveNameIllegalCharacters</span>);
 
                <b>throw</b> <span class="r8 r">e</span>;
            }
 
            <span class="c">// Allow the provider a chance to approve the drive and set</span>
            <span class="c">// provider specific data</span>
 
            <a href="DataStoreAdapter.cs.html#2d16b26a541ba185" class="t t">PSDriveInfo</a> <span id="r9 rd" class="r9 r">result</span> = <a href="SessionStateProviderAPIs.cs.html#cd42a4055289a2b6" class="i method">ValidateDriveWithProvider</a>(<span class="r5 r">drive</span>, <span class="r7 r">context</span>, <b>true</b>);
 
            <span class="c">// We assume that the provider wrote the error message as they</span>
            <span class="c">// are suppose to.</span>
            <b>if</b> (<span class="r9 r">result</span> == <b>null</b>)
            {
                <b>return</b>;
            }
 
            <b>if</b> (<b>string</b>.<span class="i">Equals</span>(<span class="r9 r">result</span>.<a href="DataStoreAdapter.cs.html#7c2d83a1b2b425a9" class="i property">Name</a>, <span class="r5 r">drive</span>.<a href="DataStoreAdapter.cs.html#7c2d83a1b2b425a9" class="i property">Name</a>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
            {
                <span class="c">// Set the drive in the current scope.</span>
 
                <b>try</b>
                {
                    <a href="SessionStateScope.cs.html#460261155e0163cb" class="t t">SessionStateScope</a> <span id="r10 rd" class="r10 r">scope</span> = <a href="SessionStateScopeAPIs.cs.html#5dfb91703808fccd" class="i field">_currentScope</a>;
 
                    <b>if</b> (!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r6 r">scopeID</span>))
                    {
                        <span class="r10 r">scope</span> = <a href="SessionStateScopeAPIs.cs.html#92e44fea6672dfdf" class="i method">GetScopeByID</a>(<span class="r6 r">scopeID</span>);
                    }
 
                    <span class="r10 r">scope</span>.<a href="SessionStateScope.cs.html#be5f4ca8939b8bec" class="i method">NewDrive</a>(<span class="r9 r">result</span>);
                }
                <b>catch</b> (<span class="i">ArgumentException</span> <span id="r11 rd" class="r11 r">argumentException</span>)
                {
                    <span class="c">// Wrap up the exception and write it to the error stream</span>
 
                    <span class="r7 r">context</span>.<a href="../namespaces/CoreCommandContext.cs.html#97661a296df11e6d" class="i method">WriteError</a>(
                        <b>new</b> <span class="t">ErrorRecord</span>(
                            <span class="r11 r">argumentException</span>,
                            <span class="s">&quot;NewDriveError&quot;</span>,
                            <a href="ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="ErrorPackage.cs.html#846d2b572f2c4820" class="i field">InvalidArgument</a>,
                            <span class="r9 r">result</span>));
                    <b>return</b>;
                }
                <b>catch</b> (<a href="../utils/SessionStateExceptions.cs.html#3f7cfda90a75013a" class="t t">SessionStateException</a>)
                {
                    <span class="c">// This should be a pipeline terminating condition</span>
                    <b>throw</b>;
                }
 
                <b>if</b> (<a href="SessionStateProviderAPIs.cs.html#5501f560faf2de0a" class="i property">ProvidersCurrentWorkingDrive</a>[<span class="r5 r">drive</span>.<a href="DataStoreAdapter.cs.html#599e6ea3519fc2d6" class="i property">Provider</a>] == <b>null</b>)
                {
                    <span class="c">// Set the new drive as the current</span>
                    <span class="c">// drive for the provider since there isn&#39;t one set.</span>
 
                    <a href="SessionStateProviderAPIs.cs.html#5501f560faf2de0a" class="i property">ProvidersCurrentWorkingDrive</a>[<span class="r5 r">drive</span>.<a href="DataStoreAdapter.cs.html#599e6ea3519fc2d6" class="i property">Provider</a>] = <span class="r5 r">drive</span>;
                }
 
                <span class="c">// Upon success, write the drive to the pipeline</span>
 
                <span class="r7 r">context</span>.<a href="../namespaces/CoreCommandContext.cs.html#09901f5e3c1e6a4e" class="i method">WriteObject</a>(<span class="r9 r">result</span>);
            }
            <b>else</b>
            {
                <a href="../utils/SessionStateExceptions.cs.html#35e07c15a7526bcd" class="t t">ProviderInvocationException</a> <span id="r12 rd" class="r12 r">e</span> =
                    <span class="i">NewProviderInvocationException</span>(
                        <span class="s">&quot;NewDriveProviderFailed&quot;</span>,
                        <span class="i">SessionStateStrings</span>.<span class="i">NewDriveProviderFailed</span>,
                        <span class="r5 r">drive</span>.<a href="DataStoreAdapter.cs.html#599e6ea3519fc2d6" class="i property">Provider</a>,
                        <span class="r5 r">drive</span>.<a href="DataStoreAdapter.cs.html#6c8f4db73167e8f9" class="i property">Root</a>,
                        <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../utils/MshTraceSource.cs.html#fed5f40dc0075d41" class="i method">NewArgumentException</a>(<span class="s">&quot;root&quot;</span>));
 
                <b>throw</b> <span class="r12 r">e</span>;
            }
        }
 
        <b>private static bool</b> <a id="425ce8380c5b8436" href="../R/425ce8380c5b8436.html" target="n" data-glyph="76,1" class="i method">IsValidDriveName</a>(<b>string</b> <span id="r13 rd" class="r13 r">name</span>)
        {
            <b>bool</b> <span id="r14 rd" class="r14 r">result</span> = <b>true</b>;
 
            <b>do</b>
            {
                <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r13 r">name</span>))
                {
                    <span class="r14 r">result</span> = <b>false</b>;
                    <b>break</b>;
                }
 
                <b>if</b> (<span class="r13 r">name</span>.<span class="i">IndexOfAny</span>(<a href="#421f17aaed55d200" class="i field">s_charactersInvalidInDriveName</a>) &gt;= 0)
                {
                    <span class="r14 r">result</span> = <b>false</b>;
                    <b>break</b>;
                }
            } <b>while</b> (<b>false</b>);
 
            <b>return</b> <span class="r14 r">result</span>;
        }
 
        <b>private static readonly char</b>[] <a id="421f17aaed55d200" href="../R/421f17aaed55d200.html" target="n" data-glyph="46,1" class="i field">s_charactersInvalidInDriveName</a> = <b>new</b> <b>char</b>[] { <span class="s">&#39;:&#39;</span>, <span class="s">&#39;/&#39;</span>, <span class="s">&#39;\\&#39;</span>, <span class="s">&#39;.&#39;</span>, <span class="s">&#39;~&#39;</span> };
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Tries to resolve the drive root as an MSH path. If it successfully resolves</span>
        <span class="c">///</span><span class="c"> to a single path then the resolved provider internal path is returned. If it</span>
        <span class="c">///</span><span class="c"> does not resolve to a single MSH path the root is returned as it was passed.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r15 r">root</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The root path of the drive to be resolved.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r16 r">provider</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The provider that should be used when resolving the path.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The new root path of the drive.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>private string</b> <a id="1c30c835cbe1588b" href="../R/1c30c835cbe1588b.html" target="n" data-glyph="76,1" class="i method">GetProviderRootFromSpecifiedRoot</a>(<b>string</b> <span id="r15 rd" class="r15 r">root</span>, <a href="DataStoreAdapterProvider.cs.html#dd4e1f2f8e73a1dd" class="t t">ProviderInfo</a> <span id="r16 rd" class="r16 r">provider</span>)
        {
            <span class="i n">Dbg</span>.<a href="../utils/assert.cs.html#c04955255430d32f" class="t t">Diagnostics</a>.<a href="../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(
                <span class="r15 r">root</span> != <b>null</b>,
                <span class="s">&quot;Caller should have verified the root&quot;</span>);
 
            <span class="i n">Dbg</span>.<a href="../utils/assert.cs.html#c04955255430d32f" class="t t">Diagnostics</a>.<a href="../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(
                <span class="r16 r">provider</span> != <b>null</b>,
                <span class="s">&quot;Caller should have verified the provider&quot;</span>);
 
            <b>string</b> <span id="r17 rd" class="r17 r">result</span> = <span class="r15 r">root</span>;
 
            <a href="SessionStatePublic.cs.html#0a202aa6b2d52930" class="t t">SessionState</a> <span id="r18 rd" class="r18 r">sessionState</span> = <b>new</b> <a href="SessionStatePublic.cs.html#45f5fbc7afc57ae4" class="t constructor">SessionState</a>(<a href="SessionState.cs.html#3ddff2db6bc01805" class="i property">ExecutionContext</a>.<a href="ExecutionContext.cs.html#95bc6698d12886ee" class="i property">TopLevelSessionState</a>);
            <span class="i">Collection</span>&lt;<b>string</b>&gt; <span id="r19 rd" class="r19 r">resolvedPaths</span> = <b>null</b>;
            <a href="DataStoreAdapterProvider.cs.html#dd4e1f2f8e73a1dd" class="t t">ProviderInfo</a> <span id="r20 rd" class="r20 r">resolvedProvider</span> = <b>null</b>;
 
            <b>try</b>
            {
                <span class="c">// First try to resolve the root as an MSH path</span>
 
                <span class="r19 r">resolvedPaths</span> =
                    <span class="r18 r">sessionState</span>.<a href="SessionStatePublic.cs.html#3390cfbbdcffb036" class="i property">Path</a>.<a href="PathInterfaces.cs.html#4931b2e78f6aaef1" class="i method">GetResolvedProviderPathFromPSPath</a>(<span class="r15 r">root</span>, <b>out</b> <span class="r20 r">resolvedProvider</span>);
 
                <span class="c">// If a single path was resolved...</span>
 
                <b>if</b> (<span class="r19 r">resolvedPaths</span> != <b>null</b> &amp;&amp;
                    <span class="r19 r">resolvedPaths</span>.<span class="i">Count</span> == 1)
                {
                    <span class="c">// and the provider used to resolve the path,</span>
                    <span class="c">// matches the one specified by the drive...</span>
 
                    <b>if</b> (<span class="r16 r">provider</span>.<a href="DataStoreAdapterProvider.cs.html#13e2cce7adaad137" class="i method">NameEquals</a>(<span class="r20 r">resolvedProvider</span>.<a href="DataStoreAdapterProvider.cs.html#91a8d08ee3ba5a61" class="i property">FullName</a>))
                    {
                        <span class="c">// and the item exists</span>
 
                        <a href="CmdletFamilyProviderInterfaces.cs.html#7e7c55aa110a0320" class="t t">ProviderIntrinsics</a> <span id="r21 rd" class="r21 r">providerIntrinsics</span> =
                            <b>new</b> <a href="CmdletFamilyProviderInterfaces.cs.html#19f570e1978a2f92" class="t constructor">ProviderIntrinsics</a>(<a href="../P/2dc1bd90a8299178.html#2dc1bd90a8299178" class="k">this</a>);
 
                        <b>if</b> (<span class="r21 r">providerIntrinsics</span>.<a href="CmdletFamilyProviderInterfaces.cs.html#982f59c2f3f056cc" class="i property">Item</a>.<a href="ItemCmdletProviderInterfaces.cs.html#050be1558d289c66" class="i method">Exists</a>(<span class="r15 r">root</span>))
                        {
                            <span class="c">// then use the resolved path as the root of the drive</span>
 
                            <span class="r17 r">result</span> = <span class="r19 r">resolvedPaths</span>[0];
                        }
                    }
                }
            }
            <b>catch</b> (<a href="lang/parserutils.cs.html#7aca1395e161031c" class="t t">LoopFlowException</a>)
            {
                <b>throw</b>;
            }
            <b>catch</b> (<a href="../utils/ExecutionExceptions.cs.html#1b159d1cae338f33" class="t t">PipelineStoppedException</a>)
            {
                <b>throw</b>;
            }
            <b>catch</b> (<a href="../utils/ExecutionExceptions.cs.html#f896df45dff24981" class="t t">ActionPreferenceStopException</a>)
            {
                <b>throw</b>;
            }
            <span class="c">// If any of the following exceptions are thrown we assume that</span>
            <span class="c">// the path is a file system path not an MSH path and try</span>
            <span class="c">// to create the drive with that root.</span>
            <b>catch</b> (<a href="../utils/SessionStateExceptions.cs.html#09140e6dc875019b" class="t t">DriveNotFoundException</a>)
            {
            }
            <b>catch</b> (<a href="../utils/SessionStateExceptions.cs.html#a58038dc730da896" class="t t">ProviderNotFoundException</a>)
            {
            }
            <b>catch</b> (<a href="../utils/SessionStateExceptions.cs.html#9ed59df3c4c15193" class="t t">ItemNotFoundException</a>)
            {
            }
            <b>catch</b> (<span class="i">NotSupportedException</span>)
            {
            }
            <b>catch</b> (<span class="i">InvalidOperationException</span>)
            {
            }
            <b>catch</b> (<a href="../utils/SessionStateExceptions.cs.html#35e07c15a7526bcd" class="t t">ProviderInvocationException</a>)
            {
            }
            <b>catch</b> (<span class="i">ArgumentException</span>)
            {
            }
 
            <b>return</b> <span class="r17 r">result</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets an object that defines the additional parameters for the NewDrive implementation</span>
        <span class="c">///</span><span class="c"> for a provider.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r22 r">providerId</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The provider ID for the drive that is being created.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r23 r">context</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The context under which this method is being called.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> An object that has properties and fields decorated with</span>
        <span class="c">///</span><span class="c"> parsing attributes similar to a cmdlet class.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">NotSupportedException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If the </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r22 r">providerId</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> is not a DriveCmdletProvider.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="../utils/SessionStateExceptions.cs.html#a58038dc730da896" class="t t">ProviderNotFoundException</a><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r22 r">providerId</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> does not exist.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>internal object</b> <a id="1fb71440880c0443" href="../R/1fb71440880c0443.html" target="n" data-glyph="74,1" class="i method">NewDriveDynamicParameters</a>(<b>string</b> <span id="r22 rd" class="r22 r">providerId</span>, <a href="../namespaces/CoreCommandContext.cs.html#1e83d35d5286e174" class="t t">CmdletProviderContext</a> <span id="r23 rd" class="r23 r">context</span>)
        {
            <b>if</b> (<span class="r22 r">providerId</span> == <b>null</b>)
            {
                <span class="c">// If the provider hasn&#39;t been specified yet, just return null.</span>
                <span class="c">// The provider can be specified as pipeline input.</span>
                <b>return</b> <b>null</b>;
            }
 
            <a href="../namespaces/DriveProviderBase.cs.html#44a855059013a4af" class="t t">DriveCmdletProvider</a> <span id="r24 rd" class="r24 r">provider</span> = <a href="SessionStateProviderAPIs.cs.html#906127de1c02f908" class="i method">GetDriveProviderInstance</a>(<span class="r22 r">providerId</span>);
 
            <b>object</b> <span id="r25 rd" class="r25 r">result</span> = <b>null</b>;
            <b>try</b>
            {
                <span class="r25 r">result</span> = <span class="r24 r">provider</span>.<a href="../namespaces/DriveProviderBase.cs.html#875ddebdb4df7a5c" class="i method">NewDriveDynamicParameters</a>(<span class="r23 r">context</span>);
            }
            <b>catch</b> (<span class="i">Exception</span> <span id="r26 rd" class="r26 r">e</span>) <span class="c">// Catch-all OK, 3rd party callout</span>
            {
                <b>throw</b>
                    <span class="i">NewProviderInvocationException</span>(
                        <span class="s">&quot;NewDriveDynamicParametersProviderException&quot;</span>,
                        <span class="i">SessionStateStrings</span>.<span class="i">NewDriveDynamicParametersProviderException</span>,
                        <span class="r24 r">provider</span>.<a href="../namespaces/ProviderBase.cs.html#6129ef83671ead76" class="i property">ProviderInfo</a>,
                        <b>null</b>,
                        <span class="r26 r">e</span>);
            }
 
            <b>return</b> <span class="r25 r">result</span>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> NewDrive
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> GetDrive
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Searches through the session state scopes to find a drive.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r27 r">name</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The name of a drive to find.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The drive information if the drive is found.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">ArgumentNullException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r27 r">name</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> is null.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="../utils/SessionStateExceptions.cs.html#09140e6dc875019b" class="t t">DriveNotFoundException</a><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If there is no drive with </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r27 r">name</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c">.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>internal</b> <a href="DataStoreAdapter.cs.html#2d16b26a541ba185" class="t t">PSDriveInfo</a> <a id="15a86754a7aab75a" href="../R/15a86754a7aab75a.html" target="n" data-glyph="74,1" class="i method">GetDrive</a>(<b>string</b> <span id="r27 rd" class="r27 r">name</span>)
        {
            <b>return</b> <a href="#39650ffd7766143d" class="i method">GetDrive</a>(<span class="r27 r">name</span>, <b>true</b>);
        }
 
        <b>private</b> <a href="DataStoreAdapter.cs.html#2d16b26a541ba185" class="t t">PSDriveInfo</a> <a id="39650ffd7766143d" href="../R/39650ffd7766143d.html" target="n" data-glyph="76,1" class="i method">GetDrive</a>(<b>string</b> <span id="r28 rd" class="r28 r">name</span>, <b>bool</b> <span id="r29 rd" class="r29 r">automount</span>)
        {
            <b>if</b> (<span class="r28 r">name</span> == <b>null</b>)
            {
                <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../utils/MshTraceSource.cs.html#fbe67220ad7522a0" class="i method">NewArgumentNullException</a>(<b>nameof</b>(<span class="r28 r">name</span>));
            }
 
            <a href="DataStoreAdapter.cs.html#2d16b26a541ba185" class="t t">PSDriveInfo</a> <span id="r30 rd" class="r30 r">result</span> = <b>null</b>;
 
            <span class="c">// Start searching through the scopes for the drive until the drive</span>
            <span class="c">// is found or the global scope is reached.</span>
 
            <a href="SessionStateScopeEnumerator.cs.html#8788a8469feccecf" class="t t">SessionStateScopeEnumerator</a> <span id="r31 rd" class="r31 r">scopeEnumerator</span> = <b>new</b> <a href="SessionStateScopeEnumerator.cs.html#5e5d2a8d36a22ba8" class="t constructor">SessionStateScopeEnumerator</a>(<a href="SessionStateScopeAPIs.cs.html#224987ad36a90f88" class="i property">CurrentScope</a>);
 
            <b>int</b> <span id="r32 rd" class="r32 r">scopeID</span> = 0;
 
            <b>foreach</b> (<a href="SessionStateScope.cs.html#460261155e0163cb" class="t t">SessionStateScope</a> <span id="r33 rd" class="r33 r">processingScope</span> <b>in</b> <span class="r31 r">scopeEnumerator</span>)
            {
                <span class="r30 r">result</span> = <span class="r33 r">processingScope</span>.<a href="SessionStateScope.cs.html#60d8a02344b18642" class="i method">GetDrive</a>(<span class="r28 r">name</span>);
 
                <b>if</b> (<span class="r30 r">result</span> != <b>null</b>)
                {
                    <b>if</b> (<span class="r30 r">result</span>.<a href="DataStoreAdapter.cs.html#84a02b38509aa94e" class="i property">IsAutoMounted</a>)
                    {
                        <span class="c">// Validate or remove the auto-mounted drive</span>
 
                        <b>if</b> (!<a href="#b3b285eac8659ef2" class="i method">ValidateOrRemoveAutoMountedDrive</a>(<span class="r30 r">result</span>, <span class="r33 r">processingScope</span>))
                        {
                            <span class="r30 r">result</span> = <b>null</b>;
                        }
                    }
 
                    <b>if</b> (<span class="r30 r">result</span> != <b>null</b>)
                    {
                        <a href="SessionState.cs.html#9a175ef52dd782b6" class="i field">s_tracer</a>.<a href="../utils/StructuredTraceSource.cs.html#70ee671c8687bfbd" class="i method">WriteLine</a>(<span class="s">&quot;Drive found in scope {0}&quot;</span>, <span class="r32 r">scopeID</span>);
                        <b>break</b>;
                    }
                }
 
                <span class="c">// Increment the scope ID</span>
                ++<span class="r32 r">scopeID</span>;
            }
 
            <b>if</b> (<span class="r30 r">result</span> == <b>null</b> &amp;&amp; <span class="r29 r">automount</span>)
            {
                <span class="c">// Attempt to automount as a file system drive</span>
                <span class="c">// or as a BuiltIn drive (e.g. &quot;Cert&quot;/&quot;Certificate&quot;/&quot;WSMan&quot;)</span>
                <span class="r30 r">result</span> = <a href="#000252b4fc0174aa" class="i method">AutomountFileSystemDrive</a>(<span class="r28 r">name</span>) ?? <a href="#1dc032998e8effa9" class="i method">AutomountBuiltInDrive</a>(<span class="r28 r">name</span>);
            }
 
            <b>if</b> (<span class="r30 r">result</span> == <b>null</b>)
            {
                <a href="../utils/SessionStateExceptions.cs.html#09140e6dc875019b" class="t t">DriveNotFoundException</a> <span id="r34 rd" class="r34 r">driveNotFound</span> =
                    <b>new</b> <span class="t">DriveNotFoundException</span>(
                        <span class="r28 r">name</span>,
                        <span class="s">&quot;DriveNotFound&quot;</span>,
                        <span class="i">SessionStateStrings</span>.<span class="i">DriveNotFound</span>);
 
                <b>throw</b> <span class="r34 r">driveNotFound</span>;
            }
 
            <b>return</b> <span class="r30 r">result</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Searches through the session state scopes looking</span>
        <span class="c">///</span><span class="c"> for a drive of the specified name.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r35 r">name</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The name of the drive to return.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r36 r">scopeID</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The scope ID of the scope to look in for the drive.</span>
        <span class="c">///</span><span class="c"> If this parameter is null or empty the drive will be</span>
        <span class="c">///</span><span class="c"> found by searching the scopes using the dynamic scoping</span>
        <span class="c">///</span><span class="c"> rules.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The drive for the given name in the given scope or null if</span>
        <span class="c">///</span><span class="c"> the drive was not found.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">ArgumentNullException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r35 r">name</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> is null.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">ArgumentException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r36 r">scopeID</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> is less than zero, or not</span>
        <span class="c">///</span><span class="c"> a number and not &quot;script&quot;, &quot;global&quot;, &quot;local&quot;, or &quot;private&quot;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">ArgumentOutOfRangeException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r36 r">scopeID</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> is less than zero or greater than the number of currently</span>
        <span class="c">///</span><span class="c"> active scopes.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>internal</b> <a href="DataStoreAdapter.cs.html#2d16b26a541ba185" class="t t">PSDriveInfo</a> <a id="41a41bc1365ec632" href="../R/41a41bc1365ec632.html" target="n" data-glyph="74,1" class="i method">GetDrive</a>(<b>string</b> <span id="r35 rd" class="r35 r">name</span>, <b>string</b> <span id="r36 rd" class="r36 r">scopeID</span>)
        {
            <b>if</b> (<span class="r35 r">name</span> == <b>null</b>)
            {
                <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../utils/MshTraceSource.cs.html#fbe67220ad7522a0" class="i method">NewArgumentNullException</a>(<b>nameof</b>(<span class="r35 r">name</span>));
            }
 
            <a href="DataStoreAdapter.cs.html#2d16b26a541ba185" class="t t">PSDriveInfo</a> <span id="r37 rd" class="r37 r">result</span> = <b>null</b>;
 
            <span class="c">// The scope ID wasn&#39;t defined or wasn&#39;t recognizable</span>
            <span class="c">// so do a search through the scopes looking for the</span>
            <span class="c">// drive.</span>
 
            <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r36 r">scopeID</span>))
            {
                <a href="SessionStateScopeEnumerator.cs.html#8788a8469feccecf" class="t t">SessionStateScopeEnumerator</a> <span id="r38 rd" class="r38 r">scopeEnumerator</span> =
                    <b>new</b> <a href="SessionStateScopeEnumerator.cs.html#5e5d2a8d36a22ba8" class="t constructor">SessionStateScopeEnumerator</a>(<a href="SessionStateScopeAPIs.cs.html#224987ad36a90f88" class="i property">CurrentScope</a>);
 
                <b>foreach</b> (<a href="SessionStateScope.cs.html#460261155e0163cb" class="t t">SessionStateScope</a> <span id="r39 rd" class="r39 r">scope</span> <b>in</b> <span class="r38 r">scopeEnumerator</span>)
                {
                    <span class="r37 r">result</span> = <span class="r39 r">scope</span>.<a href="SessionStateScope.cs.html#60d8a02344b18642" class="i method">GetDrive</a>(<span class="r35 r">name</span>);
 
                    <b>if</b> (<span class="r37 r">result</span> != <b>null</b>)
                    {
                        <b>if</b> (<span class="r37 r">result</span>.<a href="DataStoreAdapter.cs.html#84a02b38509aa94e" class="i property">IsAutoMounted</a>)
                        {
                            <span class="c">// Validate or remove the auto-mounted drive</span>
 
                            <b>if</b> (!<a href="#b3b285eac8659ef2" class="i method">ValidateOrRemoveAutoMountedDrive</a>(<span class="r37 r">result</span>, <span class="r39 r">scope</span>))
                            {
                                <span class="r37 r">result</span> = <b>null</b>;
                            }
                        }
 
                        <b>if</b> (<span class="r37 r">result</span> != <b>null</b>)
                        {
                            <b>break</b>;
                        }
                    }
                }
 
                <b>if</b> (<span class="r37 r">result</span> == <b>null</b>)
                {
                    <span class="r37 r">result</span> = <a href="#000252b4fc0174aa" class="i method">AutomountFileSystemDrive</a>(<span class="r35 r">name</span>);
                }
            }
            <b>else</b>
            {
                <a href="SessionStateScope.cs.html#460261155e0163cb" class="t t">SessionStateScope</a> <span id="r40 rd" class="r40 r">scope</span> = <a href="SessionStateScopeAPIs.cs.html#92e44fea6672dfdf" class="i method">GetScopeByID</a>(<span class="r36 r">scopeID</span>);
                <span class="r37 r">result</span> = <span class="r40 r">scope</span>.<a href="SessionStateScope.cs.html#60d8a02344b18642" class="i method">GetDrive</a>(<span class="r35 r">name</span>);
 
                <b>if</b> (<span class="r37 r">result</span> != <b>null</b>)
                {
                    <b>if</b> (<span class="r37 r">result</span>.<a href="DataStoreAdapter.cs.html#84a02b38509aa94e" class="i property">IsAutoMounted</a>)
                    {
                        <span class="c">// Validate or remove the auto-mounted drive</span>
 
                        <b>if</b> (!<a href="#b3b285eac8659ef2" class="i method">ValidateOrRemoveAutoMountedDrive</a>(<span class="r37 r">result</span>, <span class="r40 r">scope</span>))
                        {
                            <span class="r37 r">result</span> = <b>null</b>;
                        }
                    }
                }
                <b>else</b>
                {
                    <b>if</b> (<span class="r40 r">scope</span> == <a href="SessionStateScopeAPIs.cs.html#2b591e85d7ead426" class="i property">GlobalScope</a>)
                    {
                        <span class="r37 r">result</span> = <a href="#000252b4fc0174aa" class="i method">AutomountFileSystemDrive</a>(<span class="r35 r">name</span>);
                    }
                }
            }
 
            <b>return</b> <span class="r37 r">result</span>;
        }
 
        <b>private</b> <a href="DataStoreAdapter.cs.html#2d16b26a541ba185" class="t t">PSDriveInfo</a> <a id="000252b4fc0174aa" href="../R/000252b4fc0174aa.html" target="n" data-glyph="76,1" class="i method">AutomountFileSystemDrive</a>(<b>string</b> <span id="r41 rd" class="r41 r">name</span>)
        {
            <a href="DataStoreAdapter.cs.html#2d16b26a541ba185" class="t t">PSDriveInfo</a> <span id="r42 rd" class="r42 r">result</span> = <b>null</b>;
 
            <span class="c">// Check to see if it could be a &quot;auto-mounted&quot;</span>
            <span class="c">// file system drive.  If so, add the new drive</span>
            <span class="c">// to the global scope and return it</span>
 
            <b>if</b> (<span class="r41 r">name</span>.<span class="i">Length</span> == 1)
            {
                <b>try</b>
                {
                    <span class="i n">System</span>.<span class="i">IO</span>.<span class="i">DriveInfo</span> <span id="r43 rd" class="r43 r">driveInfo</span> = <b>new</b> <span class="i n">System</span>.<span class="i">IO</span>.<span class="i">DriveInfo</span>(<span class="r41 r">name</span>);
                    <span class="r42 r">result</span> = <a href="#c1b56479d89c7454" class="i method">AutomountFileSystemDrive</a>(<span class="r43 r">driveInfo</span>);
                }
                <b>catch</b> (<a href="lang/parserutils.cs.html#7aca1395e161031c" class="t t">LoopFlowException</a>)
                {
                    <b>throw</b>;
                }
                <b>catch</b> (<a href="../utils/ExecutionExceptions.cs.html#1b159d1cae338f33" class="t t">PipelineStoppedException</a>)
                {
                    <b>throw</b>;
                }
                <b>catch</b> (<a href="../utils/ExecutionExceptions.cs.html#f896df45dff24981" class="t t">ActionPreferenceStopException</a>)
                {
                    <b>throw</b>;
                }
                <b>catch</b> (<span class="i">Exception</span>)
                {
                    <span class="c">// Catch all exceptions and continue since the drive does not exist</span>
                    <span class="c">// This action wasn&#39;t requested by the user and as such we don&#39;t</span>
                    <span class="c">// want to expose the user to any error conditions other than</span>
                    <span class="c">// DriveNotFoundException which will be thrown by the caller</span>
                }
            }
 
            <b>return</b> <span class="r42 r">result</span>;
        }
 
        <b>private</b> <a href="DataStoreAdapter.cs.html#2d16b26a541ba185" class="t t">PSDriveInfo</a> <a id="c1b56479d89c7454" href="../R/c1b56479d89c7454.html" target="n" data-glyph="76,1" class="i method">AutomountFileSystemDrive</a>(<span class="i n">System</span>.<span class="i">IO</span>.<span class="i">DriveInfo</span> <span id="r44 rd" class="r44 r">systemDriveInfo</span>)
        {
            <a href="DataStoreAdapter.cs.html#2d16b26a541ba185" class="t t">PSDriveInfo</a> <span id="r45 rd" class="r45 r">result</span> = <b>null</b>;
 
            <b>if</b> (!<a href="SessionStateProviderAPIs.cs.html#dc359a601ce02a89" class="i method">IsProviderLoaded</a>(<a href="../P/2dc1bd90a8299178.html#2dc1bd90a8299178" class="k">this</a>.<a href="SessionState.cs.html#3ddff2db6bc01805" class="i property">ExecutionContext</a>.<a href="ExecutionContext.cs.html#733af3e5592e5947" class="i property">ProviderNames</a>.<a href="ProviderNames.cs.html#07509539bc35966f" class="i property">FileSystem</a>))
            {
                <a href="SessionState.cs.html#9a175ef52dd782b6" class="i field">s_tracer</a>.<a href="../utils/StructuredTraceSource.cs.html#25b8416175e53218" class="i method">WriteLine</a>(<span class="s">&quot;The {0} provider is not loaded&quot;</span>, <a href="../P/2dc1bd90a8299178.html#2dc1bd90a8299178" class="k">this</a>.<a href="SessionState.cs.html#3ddff2db6bc01805" class="i property">ExecutionContext</a>.<a href="ExecutionContext.cs.html#733af3e5592e5947" class="i property">ProviderNames</a>.<a href="ProviderNames.cs.html#07509539bc35966f" class="i property">FileSystem</a>);
                <b>return</b> <b>null</b>;
            }
 
            <span class="c">// Since the drive does exist, add it.</span>
 
            <b>try</b>
            {
                <span class="c">// Get the FS provider</span>
 
                <a href="../namespaces/DriveProviderBase.cs.html#44a855059013a4af" class="t t">DriveCmdletProvider</a> <span id="r46 rd" class="r46 r">driveProvider</span> =
                    <a href="SessionStateProviderAPIs.cs.html#906127de1c02f908" class="i method">GetDriveProviderInstance</a>(<a href="../P/2dc1bd90a8299178.html#2dc1bd90a8299178" class="k">this</a>.<a href="SessionState.cs.html#3ddff2db6bc01805" class="i property">ExecutionContext</a>.<a href="ExecutionContext.cs.html#733af3e5592e5947" class="i property">ProviderNames</a>.<a href="ProviderNames.cs.html#07509539bc35966f" class="i property">FileSystem</a>);
 
                <b>if</b> (<span class="r46 r">driveProvider</span> != <b>null</b>)
                {
                    <span class="c">// Create a new drive</span>
                    <b>string</b> <span id="r47 rd" class="r47 r">systemDriveName</span> = <span class="r44 r">systemDriveInfo</span>.<span class="i">Name</span>.<span class="i">Substring</span>(0, 1);
                    <b>string</b> <span id="r48 rd" class="r48 r">volumeLabel</span> = <b>string</b>.<span class="i">Empty</span>;
                    <b>string</b> <span id="r49 rd" class="r49 r">displayRoot</span> = <b>null</b>;
 
                    <b>try</b>
                    {
                        <span class="c">// When run in an AppContainer, we may not have access to the volume label.</span>
                        <span class="r48 r">volumeLabel</span> = <span class="r44 r">systemDriveInfo</span>.<span class="i">VolumeLabel</span>;
                    }
                    <b>catch</b> (<span class="i">UnauthorizedAccessException</span>) { }
 
                    <span class="c">// Get the actual root path for Network type drives</span>
                    <b>if</b> (<span class="r44 r">systemDriveInfo</span>.<span class="i">DriveType</span> == <span class="i">DriveType</span>.<span class="i">Network</span>)
                    {
                        <b>try</b>
                        {
                            <span class="r49 r">displayRoot</span> = <span class="i n">Microsoft</span>.<span class="i n">PowerShell</span>.<span class="i n">Commands</span>.<a href="../P/64a92af39f1cd630.html#64a92af39f1cd630" class="t t">FileSystemProvider</a>
                                            .<span class="i">GetRootPathForNetworkDriveOrDosDevice</span>(<span class="r44 r">systemDriveInfo</span>);
                        }
                        <span class="c">// We want to get root path of the network drive as extra information to display to the user.</span>
                        <span class="c">// It&#39;s okay we failed to get the root path for some reason. We don&#39;t want to throw exception</span>
                        <span class="c">// here as it would break the current behavior.</span>
                        <b>catch</b> (<span class="i">Win32Exception</span>) { }
                        <b>catch</b> (<span class="i">InvalidOperationException</span>) { }
                    }
 
                    <a href="DataStoreAdapter.cs.html#2d16b26a541ba185" class="t t">PSDriveInfo</a> <span id="r50 rd" class="r50 r">newPSDriveInfo</span> =
                        <b>new</b> <span class="t">PSDriveInfo</span>(
                            <span class="r47 r">systemDriveName</span>,
                            <span class="r46 r">driveProvider</span>.<a href="../namespaces/ProviderBase.cs.html#6129ef83671ead76" class="i property">ProviderInfo</a>,
                            <span class="r44 r">systemDriveInfo</span>.<span class="i">RootDirectory</span>.<span class="i">FullName</span>,
                            <span class="r48 r">volumeLabel</span>,
                            <b>null</b>,
                            <span class="r49 r">displayRoot</span>);
 
                    <span class="r50 r">newPSDriveInfo</span>.<a href="DataStoreAdapter.cs.html#84a02b38509aa94e" class="i property">IsAutoMounted</a> = <b>true</b>;
 
                    <a href="../namespaces/CoreCommandContext.cs.html#1e83d35d5286e174" class="t t">CmdletProviderContext</a> <span id="r51 rd" class="r51 r">context</span> = <b>new</b> <a href="../namespaces/CoreCommandContext.cs.html#8a0e078b40b2fd0e" class="t constructor">CmdletProviderContext</a>(<a href="../P/2dc1bd90a8299178.html#2dc1bd90a8299178" class="k">this</a>.<a href="SessionState.cs.html#3ddff2db6bc01805" class="i property">ExecutionContext</a>);
 
                    <span class="r50 r">newPSDriveInfo</span>.<a href="DataStoreAdapter.cs.html#fa0b26c8d8c60c3b" class="i property">DriveBeingCreated</a> = <b>true</b>;
 
                    <span class="c">// Validate the drive with the provider</span>
                    <span class="r45 r">result</span> = <a href="SessionStateProviderAPIs.cs.html#f0fa1bdc83f8c1ec" class="i method">ValidateDriveWithProvider</a>(<span class="r46 r">driveProvider</span>, <span class="r50 r">newPSDriveInfo</span>, <span class="r51 r">context</span>, <b>false</b>);
 
                    <span class="r50 r">newPSDriveInfo</span>.<a href="DataStoreAdapter.cs.html#fa0b26c8d8c60c3b" class="i property">DriveBeingCreated</a> = <b>false</b>;
 
                    <b>if</b> (<span class="r45 r">result</span> != <b>null</b> &amp;&amp; !<span class="r51 r">context</span>.<a href="../namespaces/CoreCommandContext.cs.html#98adf40dae698aee" class="i method">HasErrors</a>())
                    {
                        <span class="c">// Create the drive in the global scope.</span>
                        <a href="SessionStateScopeAPIs.cs.html#2b591e85d7ead426" class="i property">GlobalScope</a>.<a href="SessionStateScope.cs.html#be5f4ca8939b8bec" class="i method">NewDrive</a>(<span class="r45 r">result</span>);
                    }
                }
            }
            <b>catch</b> (<a href="lang/parserutils.cs.html#7aca1395e161031c" class="t t">LoopFlowException</a>)
            {
                <b>throw</b>;
            }
            <b>catch</b> (<a href="../utils/ExecutionExceptions.cs.html#1b159d1cae338f33" class="t t">PipelineStoppedException</a>)
            {
                <b>throw</b>;
            }
            <b>catch</b> (<a href="../utils/ExecutionExceptions.cs.html#f896df45dff24981" class="t t">ActionPreferenceStopException</a>)
            {
                <b>throw</b>;
            }
            <b>catch</b> (<span class="i">Exception</span> <span id="r52 rd" class="r52 r">e</span>)
            {
                <span class="c">// Since the user isn&#39;t expecting this behavior, we don&#39;t</span>
                <span class="c">// want to let errors find their way out. If there are any</span>
                <span class="c">// failures we just don&#39;t mount the drive.</span>
 
                <a href="../logging/MshLog.cs.html#c21af6f8f06e5873" class="t t">MshLog</a>.<a href="../logging/MshLog.cs.html#565c5a5f3608944d" class="i method">LogProviderHealthEvent</a>(
                    <a href="../P/2dc1bd90a8299178.html#2dc1bd90a8299178" class="k">this</a>.<a href="SessionState.cs.html#3ddff2db6bc01805" class="i property">ExecutionContext</a>,
                    <a href="../P/2dc1bd90a8299178.html#2dc1bd90a8299178" class="k">this</a>.<a href="SessionState.cs.html#3ddff2db6bc01805" class="i property">ExecutionContext</a>.<a href="ExecutionContext.cs.html#733af3e5592e5947" class="i property">ProviderNames</a>.<a href="ProviderNames.cs.html#07509539bc35966f" class="i property">FileSystem</a>,
                    <span class="r52 r">e</span>,
                    <a href="../logging/MshLog.cs.html#2b721dd17d857439" class="t t">Severity</a>.<a href="../logging/MshLog.cs.html#1440d51070db4217" class="i field">Warning</a>);
            }
 
            <b>return</b> <span class="r45 r">result</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Auto-mounts a built-in drive.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Calls GetDrive(name, false) internally.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r53 r">name</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The name of the drive to load.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal</b> <a href="DataStoreAdapter.cs.html#2d16b26a541ba185" class="t t">PSDriveInfo</a> <a id="1dc032998e8effa9" href="../R/1dc032998e8effa9.html" target="n" data-glyph="74,1" class="i method">AutomountBuiltInDrive</a>(<b>string</b> <span id="r53 rd" class="r53 r">name</span>)
        {
            <a href="#b209d41d45fa40e2" class="i method">MountDefaultDrive</a>(<span class="r53 r">name</span>, <a href="SessionState.cs.html#3ddff2db6bc01805" class="i property">ExecutionContext</a>);
            <a href="DataStoreAdapter.cs.html#2d16b26a541ba185" class="t t">PSDriveInfo</a> <span id="r54 rd" class="r54 r">result</span> = <a href="#39650ffd7766143d" class="i method">GetDrive</a>(<span class="r53 r">name</span>, <b>false</b>);
 
            <b>return</b> <span class="r54 r">result</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Automatically mount the specified drive.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Neither &#39;WSMan&#39; nor &#39;Certificate&#39; provider works in UNIX PS today.</span>
        <span class="c">///</span><span class="c"> So this method currently does nothing on UNIX.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>internal static void</b> <a id="b209d41d45fa40e2" href="../R/b209d41d45fa40e2.html" target="n" data-glyph="74,1" class="i method">MountDefaultDrive</a>(<b>string</b> <span id="r55 rd" class="r55 r">name</span>, <a href="ExecutionContext.cs.html#130bda5418e8559c" class="t t">ExecutionContext</a> <span id="r56 rd" class="r56 r">context</span>)
        {
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">UNIX</span>
            <a href="CommandDiscovery.cs.html#c476355d983131b8" class="t t">PSModuleAutoLoadingPreference</a> <span id="r57 rd" class="r57 r">moduleAutoLoadingPreference</span> =
                <a href="CommandDiscovery.cs.html#04905efdf0510fc2" class="t t">CommandDiscovery</a>.<a href="CommandDiscovery.cs.html#6495e4b39d68b6a7" class="i method">GetCommandDiscoveryPreference</a>(<span class="r56 r">context</span>, <a href="SpecialVariables.cs.html#07948374b47849e8" class="t t">SpecialVariables</a>.<a href="SpecialVariables.cs.html#e908f6da9e7bb762" class="i field">PSModuleAutoLoadingPreferenceVarPath</a>, <span class="s">&quot;PSModuleAutoLoadingPreference&quot;</span>);
            <b>if</b> (<span class="r57 r">moduleAutoLoadingPreference</span> == <a href="CommandDiscovery.cs.html#c476355d983131b8" class="t t">PSModuleAutoLoadingPreference</a>.<a href="CommandDiscovery.cs.html#8d4577abcb2c6b36" class="i field">None</a>)
            {
                <b>return</b>;
            }
 
            <b>string</b> <span id="r58 rd" class="r58 r">moduleName</span> = <b>null</b>;
 
            <span class="c">// Note: For the certificate provider, we actually support the provider name as an alternative to</span>
            <span class="c">// mount the default drive, since the provider names can be used for provider-qualified paths.</span>
            <span class="c">// The WSMAN drive is the same as the provider name.</span>
            <b>if</b> (
                <b>string</b>.<span class="i">Equals</span>(<span class="s">&quot;Cert&quot;</span>, <span class="r55 r">name</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>) ||
                <b>string</b>.<span class="i">Equals</span>(<span class="s">&quot;Certificate&quot;</span>, <span class="r55 r">name</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>)
                )
            {
                <span class="r58 r">moduleName</span> = <span class="s">&quot;Microsoft.PowerShell.Security&quot;</span>;
            }
            <b>else</b> <b>if</b> (<b>string</b>.<span class="i">Equals</span>(<span class="s">&quot;WSMan&quot;</span>, <span class="r55 r">name</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
            {
                <span class="r58 r">moduleName</span> = <span class="s">&quot;Microsoft.WSMan.Management&quot;</span>;
            }
 
            <b>if</b> (!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r58 r">moduleName</span>))
            {
                <a href="SessionState.cs.html#9a175ef52dd782b6" class="i field">s_tracer</a>.<a href="../utils/StructuredTraceSource.cs.html#25b8416175e53218" class="i method">WriteLine</a>(<span class="s">&quot;Auto-mounting built-in drive: {0}&quot;</span>, <span class="r55 r">name</span>);
                <a href="CommandInfo.cs.html#71babe57a99ca852" class="t t">CommandInfo</a> <span id="r59 rd" class="r59 r">commandInfo</span> = <b>new</b> <span class="t">CmdletInfo</span>(<span class="s">&quot;Import-Module&quot;</span>, <b>typeof</b>(<span class="i n">Microsoft</span>.<span class="i n">PowerShell</span>.<span class="i n">Commands</span>.<a href="Modules/ImportModuleCommand.cs.html#4a6e75cbbfb65b34" class="t t">ImportModuleCommand</a>), <b>null</b>, <b>null</b>, <span class="r56 r">context</span>);
                <span class="i">Exception</span> <span id="r60 rd" class="r60 r">exception</span> = <b>null</b>;
                <a href="SessionState.cs.html#9a175ef52dd782b6" class="i field">s_tracer</a>.<a href="../utils/StructuredTraceSource.cs.html#25b8416175e53218" class="i method">WriteLine</a>(<span class="s">&quot;Attempting to load module: {0}&quot;</span>, <span class="r58 r">moduleName</span>);
                <a href="CommandDiscovery.cs.html#04905efdf0510fc2" class="t t">CommandDiscovery</a>.<a href="CommandDiscovery.cs.html#c13a16be6d4187e9" class="i method">AutoloadSpecifiedModule</a>(<span class="r58 r">moduleName</span>, <span class="r56 r">context</span>, <span class="r59 r">commandInfo</span>.<a href="CommandInfo.cs.html#cb0c02415aeca7d5" class="i property">Visibility</a>, <b>out</b> <span class="r60 r">exception</span>);
                <b>if</b> (<span class="r60 r">exception</span> != <b>null</b>)
                {
                    <span class="c">// Call-out to user code, catch-all OK</span>
                }
            }
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Determines if the specified automounted drive still exists. If not,</span>
        <span class="c">///</span><span class="c"> the drive is removed.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r61 r">drive</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The drive to validate or remove.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r62 r">scope</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The scope the drive is in.  This will be used to remove the drive</span>
        <span class="c">///</span><span class="c"> if necessary.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> True if the drive is still valid, false if the drive was removed.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>private bool</b> <a id="b3b285eac8659ef2" href="../R/b3b285eac8659ef2.html" target="n" data-glyph="76,1" class="i method">ValidateOrRemoveAutoMountedDrive</a>(<a href="DataStoreAdapter.cs.html#2d16b26a541ba185" class="t t">PSDriveInfo</a> <span id="r61 rd" class="r61 r">drive</span>, <a href="SessionStateScope.cs.html#460261155e0163cb" class="t t">SessionStateScope</a> <span id="r62 rd" class="r62 r">scope</span>)
        {
            <b>bool</b> <span id="r63 rd" class="r63 r">result</span> = <b>true</b>;
            <b>try</b>
            {
                <span class="i n">System</span>.<span class="i">IO</span>.<span class="i">DriveInfo</span> <span id="r64 rd" class="r64 r">systemDriveInfo</span> = <b>new</b> <span class="i n">System</span>.<span class="i">IO</span>.<span class="i">DriveInfo</span>(<span class="r61 r">drive</span>.<a href="DataStoreAdapter.cs.html#7c2d83a1b2b425a9" class="i property">Name</a>);
                <span class="r63 r">result</span> = <span class="r64 r">systemDriveInfo</span>.<span class="i">DriveType</span> != <span class="i">DriveType</span>.<span class="i">NoRootDirectory</span>;
            }
            <b>catch</b> (<a href="lang/parserutils.cs.html#7aca1395e161031c" class="t t">LoopFlowException</a>)
            {
                <b>throw</b>;
            }
            <b>catch</b> (<a href="../utils/ExecutionExceptions.cs.html#1b159d1cae338f33" class="t t">PipelineStoppedException</a>)
            {
                <b>throw</b>;
            }
            <b>catch</b> (<a href="../utils/ExecutionExceptions.cs.html#f896df45dff24981" class="t t">ActionPreferenceStopException</a>)
            {
                <b>throw</b>;
            }
            <b>catch</b> (<span class="i">Exception</span>)
            {
                <span class="c">// Assume any exception means the drive is no longer valid and needs</span>
                <span class="c">// to be removed.</span>
 
                <span class="r63 r">result</span> = <b>false</b>;
            }
 
            <b>if</b> (!<span class="r63 r">result</span>)
            {
                <a href="../namespaces/DriveProviderBase.cs.html#44a855059013a4af" class="t t">DriveCmdletProvider</a> <span id="r65 rd" class="r65 r">driveProvider</span> = <b>null</b>;
 
                <b>try</b>
                {
                    <span class="r65 r">driveProvider</span> =
                        <a href="SessionStateProviderAPIs.cs.html#906127de1c02f908" class="i method">GetDriveProviderInstance</a>(<a href="../P/2dc1bd90a8299178.html#2dc1bd90a8299178" class="k">this</a>.<a href="SessionState.cs.html#3ddff2db6bc01805" class="i property">ExecutionContext</a>.<a href="ExecutionContext.cs.html#733af3e5592e5947" class="i property">ProviderNames</a>.<a href="ProviderNames.cs.html#07509539bc35966f" class="i property">FileSystem</a>);
                }
                <b>catch</b> (<span class="i">NotSupportedException</span>)
                {
                }
                <b>catch</b> (<a href="../utils/SessionStateExceptions.cs.html#a58038dc730da896" class="t t">ProviderNotFoundException</a>)
                {
                }
 
                <b>if</b> (<span class="r65 r">driveProvider</span> != <b>null</b>)
                {
                    <a href="../namespaces/CoreCommandContext.cs.html#1e83d35d5286e174" class="t t">CmdletProviderContext</a> <span id="r66 rd" class="r66 r">context</span> = <b>new</b> <a href="../namespaces/CoreCommandContext.cs.html#8a0e078b40b2fd0e" class="t constructor">CmdletProviderContext</a>(<a href="../P/2dc1bd90a8299178.html#2dc1bd90a8299178" class="k">this</a>.<a href="SessionState.cs.html#3ddff2db6bc01805" class="i property">ExecutionContext</a>);
 
                    <b>try</b>
                    {
                        <span class="c">// Give the provider a chance to cleanup</span>
                        <span class="r65 r">driveProvider</span>.<a href="../namespaces/DriveProviderBase.cs.html#d29373597e29cbcb" class="i method">RemoveDrive</a>(<span class="r61 r">drive</span>, <span class="r66 r">context</span>);
                    }
                    <span class="c">// Ignore any exceptions the provider throws because we</span>
                    <span class="c">// are doing this without an explicit request from the</span>
                    <span class="c">// user. Since the provider can throw any exception</span>
                    <span class="c">// we must catch all exceptions here.</span>
                    <b>catch</b> (<span class="i">Exception</span>)
                    {
                    }
 
                    <span class="r62 r">scope</span>.<a href="SessionStateScope.cs.html#235e4996b87173bd" class="i method">RemoveDrive</a>(<span class="r61 r">drive</span>);
                }
            }
 
            <b>return</b> <span class="r63 r">result</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If a VHD is mounted to a drive prior to the PowerShell session being launched,</span>
        <span class="c">///</span><span class="c"> then such a drive has to be validated for its existence before performing</span>
        <span class="c">///</span><span class="c"> any operations on that drive to make sure that the drive is not unmounted.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r67 r">drive</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">Absence of mounted drive for FileSystem provider or False for other provider types.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>private bool</b> <a id="0da44006fc97317d" href="../R/0da44006fc97317d.html" target="n" data-glyph="76,1" class="i method">IsAStaleVhdMountedDrive</a>(<a href="DataStoreAdapter.cs.html#2d16b26a541ba185" class="t t">PSDriveInfo</a> <span id="r67 rd" class="r67 r">drive</span>)
        {
            <b>bool</b> <span id="r68 rd" class="r68 r">result</span> = <b>false</b>;
 
            <span class="c">// check that drive&#39;s provider type is FileSystem</span>
            <b>if</b> ((<span class="r67 r">drive</span>.<a href="DataStoreAdapter.cs.html#599e6ea3519fc2d6" class="i property">Provider</a> != <b>null</b>) &amp;&amp; (!<span class="r67 r">drive</span>.<a href="DataStoreAdapter.cs.html#599e6ea3519fc2d6" class="i property">Provider</a>.<a href="DataStoreAdapterProvider.cs.html#13e2cce7adaad137" class="i method">NameEquals</a>(<a href="../P/2dc1bd90a8299178.html#2dc1bd90a8299178" class="k">this</a>.<a href="SessionState.cs.html#3ddff2db6bc01805" class="i property">ExecutionContext</a>.<a href="ExecutionContext.cs.html#733af3e5592e5947" class="i property">ProviderNames</a>.<a href="ProviderNames.cs.html#07509539bc35966f" class="i property">FileSystem</a>)))
            {
                <b>return</b> <b>false</b>;
            }
 
            <span class="c">// A VHD mounted drive gets detected with a DriveType of DriveType.Fixed</span>
            <span class="c">// when the VHD is mounted, however if the drive is unmounted, such a</span>
            <span class="c">// stale drive is no longer valid and gets detected with DriveType.NoRootDirectory.</span>
            <span class="c">// We would hit this situation in the following scenario:</span>
            <span class="c">//  1. Launch Powershell session &#39;A&#39; and mount the VHD.</span>
            <span class="c">//  2. Launch different powershell session &#39;B&#39;.</span>
            <span class="c">//  3. Unmount the VHD in session &#39;A&#39;.</span>
            <span class="c">// The drive pointing to VHD in session &#39;B&#39; gets detected as DriveType.NoRootDirectory</span>
            <span class="c">// after the VHD is removed in session &#39;A&#39;.</span>
            <b>if</b> (<span class="r67 r">drive</span> != <b>null</b> &amp;&amp; !<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r67 r">drive</span>.<a href="DataStoreAdapter.cs.html#7c2d83a1b2b425a9" class="i property">Name</a>) &amp;&amp; <span class="r67 r">drive</span>.<a href="DataStoreAdapter.cs.html#7c2d83a1b2b425a9" class="i property">Name</a>.<span class="i">Length</span> == 1)
            {
                <b>try</b>
                {
                    <b>char</b> <span id="r69 rd" class="r69 r">driveChar</span> = <span class="i">Convert</span>.<span class="i">ToChar</span>(<span class="r67 r">drive</span>.<a href="DataStoreAdapter.cs.html#7c2d83a1b2b425a9" class="i property">Name</a>, <span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>);
 
                    <b>if</b> (<b>char</b>.<span class="i">ToUpperInvariant</span>(<span class="r69 r">driveChar</span>) &gt;= <span class="s">&#39;A&#39;</span> &amp;&amp; <b>char</b>.<span class="i">ToUpperInvariant</span>(<span class="r69 r">driveChar</span>) &lt;= <span class="s">&#39;Z&#39;</span>)
                    {
                        <span class="i">DriveInfo</span> <span id="r70 rd" class="r70 r">systemDriveInfo</span> = <b>new</b> <span class="i">DriveInfo</span>(<span class="r67 r">drive</span>.<a href="DataStoreAdapter.cs.html#7c2d83a1b2b425a9" class="i property">Name</a>);
 
                        <b>if</b> (<span class="r70 r">systemDriveInfo</span>.<span class="i">DriveType</span> == <span class="i">DriveType</span>.<span class="i">NoRootDirectory</span>)
                        {
                            <b>if</b> (!<span class="i">Directory</span>.<span class="i">Exists</span>(<span class="r67 r">drive</span>.<a href="DataStoreAdapter.cs.html#6c8f4db73167e8f9" class="i property">Root</a>))
                            {
                                <span class="r68 r">result</span> = <b>true</b>;
                            }
                        }
                    }
                }
                <b>catch</b> (<span class="i">ArgumentException</span>)
                {
                    <span class="c">// At this point, We dont care if the drive is not a valid drive that does not host the VHD.</span>
                }
            }
 
            <b>return</b> <span class="r68 r">result</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets all the drives for a specific provider.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r71 r">providerId</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The identifier for the provider to retrieve the drives for.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> An IEnumerable that contains the drives for the specified provider.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal</b> <span class="i">Collection</span>&lt;<a href="DataStoreAdapter.cs.html#2d16b26a541ba185" class="t t">PSDriveInfo</a>&gt; <a id="4a709421313fe1ad" href="../R/4a709421313fe1ad.html" target="n" data-glyph="74,1" class="i method">GetDrivesForProvider</a>(<b>string</b> <span id="r71 rd" class="r71 r">providerId</span>)
        {
            <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r71 r">providerId</span>))
            {
                <b>return</b> <a href="#033714dcbf40ff39" class="i method">Drives</a>(<b>null</b>);
            }
 
            <span class="c">// Ensure that the provider name resolves to a single provider</span>
            <a href="SessionStateProviderAPIs.cs.html#02cfdb64abb0b450" class="i method">GetSingleProvider</a>(<span class="r71 r">providerId</span>);
 
            <span class="i">Collection</span>&lt;<a href="DataStoreAdapter.cs.html#2d16b26a541ba185" class="t t">PSDriveInfo</a>&gt; <span id="r72 rd" class="r72 r">drives</span> = <b>new</b> <span class="i">Collection</span>&lt;<a href="DataStoreAdapter.cs.html#2d16b26a541ba185" class="t t">PSDriveInfo</a>&gt;();
 
            <b>foreach</b> (<a href="DataStoreAdapter.cs.html#2d16b26a541ba185" class="t t">PSDriveInfo</a> <span id="r73 rd" class="r73 r">drive</span> <b>in</b> <a href="#033714dcbf40ff39" class="i method">Drives</a>(<b>null</b>))
            {
                <b>if</b> (<span class="r73 r">drive</span> != <b>null</b> &amp;&amp;
                    <span class="r73 r">drive</span>.<a href="DataStoreAdapter.cs.html#599e6ea3519fc2d6" class="i property">Provider</a>.<a href="DataStoreAdapterProvider.cs.html#13e2cce7adaad137" class="i method">NameEquals</a>(<span class="r71 r">providerId</span>))
                {
                    <span class="r72 r">drives</span>.<span class="i">Add</span>(<span class="r73 r">drive</span>);
                }
            }
 
            <b>return</b> <span class="r72 r">drives</span>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> GetDrive
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> RemoveDrive
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Removes the drive with the specified name.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r74 r">driveName</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The name of the drive to remove.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r75 r">force</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Determines whether drive should be forcefully removed even if there was errors.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r76 r">scopeID</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The ID of the scope from which to remove the drive.</span>
        <span class="c">///</span><span class="c"> If the scope ID is null or empty, the scope hierarchy will be searched</span>
        <span class="c">///</span><span class="c"> starting at the current scope through all the parent scopes to the</span>
        <span class="c">///</span><span class="c"> global scope until a drive of the given name is found to remove.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="f75c907f5ac5a640" href="../R/f75c907f5ac5a640.html" target="n" data-glyph="74,1" class="i method">RemoveDrive</a>(<b>string</b> <span id="r74 rd" class="r74 r">driveName</span>, <b>bool</b> <span id="r75 rd" class="r75 r">force</span>, <b>string</b> <span id="r76 rd" class="r76 r">scopeID</span>)
        {
            <b>if</b> (<span class="r74 r">driveName</span> == <b>null</b>)
            {
                <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../utils/MshTraceSource.cs.html#fbe67220ad7522a0" class="i method">NewArgumentNullException</a>(<b>nameof</b>(<span class="r74 r">driveName</span>));
            }
 
            <a href="DataStoreAdapter.cs.html#2d16b26a541ba185" class="t t">PSDriveInfo</a> <span id="r77 rd" class="r77 r">drive</span> = <a href="#41a41bc1365ec632" class="i method">GetDrive</a>(<span class="r74 r">driveName</span>, <span class="r76 r">scopeID</span>);
 
            <b>if</b> (<span class="r77 r">drive</span> == <b>null</b>)
            {
                <a href="../utils/SessionStateExceptions.cs.html#09140e6dc875019b" class="t t">DriveNotFoundException</a> <span id="r78 rd" class="r78 r">e</span> = <b>new</b> <span class="t">DriveNotFoundException</span>(
                    <span class="r74 r">driveName</span>,
                    <span class="s">&quot;DriveNotFound&quot;</span>,
                    <span class="i">SessionStateStrings</span>.<span class="i">DriveNotFound</span>);
                <b>throw</b> <span class="r78 r">e</span>;
            }
 
            <a href="#efe8494b1eb76744" class="i method">RemoveDrive</a>(<span class="r77 r">drive</span>, <span class="r75 r">force</span>, <span class="r76 r">scopeID</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Removes the drive with the specified name.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r79 r">driveName</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The name of the drive to remove.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r80 r">force</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Determines whether drive should be forcefully removed even if there was errors.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r81 r">scopeID</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The ID of the scope from which to remove the drive.</span>
        <span class="c">///</span><span class="c"> If the scope ID is null or empty, the scope hierarchy will be searched</span>
        <span class="c">///</span><span class="c"> starting at the current scope through all the parent scopes to the</span>
        <span class="c">///</span><span class="c"> global scope until a drive of the given name is found to remove.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r82 r">context</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The context of the command.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="2a2ad8b6353c3e63" href="../R/2a2ad8b6353c3e63.html" target="n" data-glyph="74,1" class="i method">RemoveDrive</a>(
            <b>string</b> <span id="r79 rd" class="r79 r">driveName</span>,
            <b>bool</b> <span id="r80 rd" class="r80 r">force</span>,
            <b>string</b> <span id="r81 rd" class="r81 r">scopeID</span>,
            <a href="../namespaces/CoreCommandContext.cs.html#1e83d35d5286e174" class="t t">CmdletProviderContext</a> <span id="r82 rd" class="r82 r">context</span>)
        {
            <b>if</b> (<span class="r79 r">driveName</span> == <b>null</b>)
            {
                <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../utils/MshTraceSource.cs.html#fbe67220ad7522a0" class="i method">NewArgumentNullException</a>(<b>nameof</b>(<span class="r79 r">driveName</span>));
            }
 
            <span class="i n">Dbg</span>.<a href="../utils/assert.cs.html#c04955255430d32f" class="t t">Diagnostics</a>.<a href="../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(
                <span class="r82 r">context</span> != <b>null</b>,
                <span class="s">&quot;The caller should verify the context&quot;</span>);
 
            <a href="DataStoreAdapter.cs.html#2d16b26a541ba185" class="t t">PSDriveInfo</a> <span id="r83 rd" class="r83 r">drive</span> = <a href="#41a41bc1365ec632" class="i method">GetDrive</a>(<span class="r79 r">driveName</span>, <span class="r81 r">scopeID</span>);
 
            <b>if</b> (<span class="r83 r">drive</span> == <b>null</b>)
            {
                <a href="../utils/SessionStateExceptions.cs.html#09140e6dc875019b" class="t t">DriveNotFoundException</a> <span id="r84 rd" class="r84 r">e</span> = <b>new</b> <span class="t">DriveNotFoundException</span>(
                    <span class="r79 r">driveName</span>,
                    <span class="s">&quot;DriveNotFound&quot;</span>,
                    <span class="i">SessionStateStrings</span>.<span class="i">DriveNotFound</span>);
                <span class="r82 r">context</span>.<a href="../namespaces/CoreCommandContext.cs.html#97661a296df11e6d" class="i method">WriteError</a>(<b>new</b> <span class="t">ErrorRecord</span>(<span class="r84 r">e</span>.<a href="../utils/SessionStateExceptions.cs.html#3efc34ad3d29e212" class="i property">ErrorRecord</a>, <span class="r84 r">e</span>));
            }
            <b>else</b>
            {
                <a href="#df6e103d8be4eaa0" class="i method">RemoveDrive</a>(<span class="r83 r">drive</span>, <span class="r80 r">force</span>, <span class="r81 r">scopeID</span>, <span class="r82 r">context</span>);
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Removes the specified drive.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r85 r">drive</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The drive to be removed.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r86 r">force</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Determines whether drive should be forcefully removed even if there was errors.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r87 r">scopeID</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The ID of the scope from which to remove the drive.</span>
        <span class="c">///</span><span class="c"> If the scope ID is null or empty, the scope hierarchy will be searched</span>
        <span class="c">///</span><span class="c"> starting at the current scope through all the parent scopes to the</span>
        <span class="c">///</span><span class="c"> global scope until a drive of the given name is found to remove.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="efe8494b1eb76744" href="../R/efe8494b1eb76744.html" target="n" data-glyph="74,1" class="i method">RemoveDrive</a>(<a href="DataStoreAdapter.cs.html#2d16b26a541ba185" class="t t">PSDriveInfo</a> <span id="r85 rd" class="r85 r">drive</span>, <b>bool</b> <span id="r86 rd" class="r86 r">force</span>, <b>string</b> <span id="r87 rd" class="r87 r">scopeID</span>)
        {
            <b>if</b> (<span class="r85 r">drive</span> == <b>null</b>)
            {
                <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../utils/MshTraceSource.cs.html#fbe67220ad7522a0" class="i method">NewArgumentNullException</a>(<b>nameof</b>(<span class="r85 r">drive</span>));
            }
 
            <a href="../namespaces/CoreCommandContext.cs.html#1e83d35d5286e174" class="t t">CmdletProviderContext</a> <span id="r88 rd" class="r88 r">context</span> = <b>new</b> <a href="../namespaces/CoreCommandContext.cs.html#8a0e078b40b2fd0e" class="t constructor">CmdletProviderContext</a>(<a href="../P/2dc1bd90a8299178.html#2dc1bd90a8299178" class="k">this</a>.<a href="SessionState.cs.html#3ddff2db6bc01805" class="i property">ExecutionContext</a>);
 
            <a href="#df6e103d8be4eaa0" class="i method">RemoveDrive</a>(<span class="r85 r">drive</span>, <span class="r86 r">force</span>, <span class="r87 r">scopeID</span>, <span class="r88 r">context</span>);
 
            <b>if</b> (<span class="r88 r">context</span>.<a href="../namespaces/CoreCommandContext.cs.html#98adf40dae698aee" class="i method">HasErrors</a>() &amp;&amp; !<span class="r86 r">force</span>)
            {
                <span class="r88 r">context</span>.<a href="../namespaces/CoreCommandContext.cs.html#c8e1b5c9dc612598" class="i method">ThrowFirstErrorOrDoNothing</a>();
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Removes the specified drive.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r89 r">drive</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The drive to be removed.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r90 r">force</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Determines whether drive should be forcefully removed even if there was errors.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r91 r">scopeID</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The ID of the scope from which to remove the drive.</span>
        <span class="c">///</span><span class="c"> If the scope ID is null or empty, the scope hierarchy will be searched</span>
        <span class="c">///</span><span class="c"> starting at the current scope through all the parent scopes to the</span>
        <span class="c">///</span><span class="c"> global scope until a drive of the given name is found to remove.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r92 r">context</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The context which the core command is running.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">ArgumentOutOfRangeException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r91 r">scopeID</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> is less than zero or greater than the number of currently</span>
        <span class="c">///</span><span class="c"> active scopes.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="df6e103d8be4eaa0" href="../R/df6e103d8be4eaa0.html" target="n" data-glyph="74,1" class="i method">RemoveDrive</a>(
            <a href="DataStoreAdapter.cs.html#2d16b26a541ba185" class="t t">PSDriveInfo</a> <span id="r89 rd" class="r89 r">drive</span>,
            <b>bool</b> <span id="r90 rd" class="r90 r">force</span>,
            <b>string</b> <span id="r91 rd" class="r91 r">scopeID</span>,
            <a href="../namespaces/CoreCommandContext.cs.html#1e83d35d5286e174" class="t t">CmdletProviderContext</a> <span id="r92 rd" class="r92 r">context</span>)
        {
            <span class="c">// Make sure that the CanRemoveDrive is called even if we are forcing</span>
            <span class="c">// the removal because we want the provider to have a chance to</span>
            <span class="c">// cleanup.</span>
 
            <b>bool</b> <span id="r93 rd" class="r93 r">canRemove</span> = <b>false</b>;
 
            <b>try</b>
            {
                <span class="r93 r">canRemove</span> = <a href="#da239818a7016dbb" class="i method">CanRemoveDrive</a>(<span class="r89 r">drive</span>, <span class="r92 r">context</span>);
            }
            <b>catch</b> (<a href="lang/parserutils.cs.html#7aca1395e161031c" class="t t">LoopFlowException</a>)
            {
                <b>throw</b>;
            }
            <b>catch</b> (<a href="../utils/ExecutionExceptions.cs.html#1b159d1cae338f33" class="t t">PipelineStoppedException</a>)
            {
                <b>throw</b>;
            }
            <b>catch</b> (<a href="../utils/ExecutionExceptions.cs.html#f896df45dff24981" class="t t">ActionPreferenceStopException</a>)
            {
                <b>throw</b>;
            }
            <b>catch</b> (<a href="../utils/SessionStateExceptions.cs.html#35e07c15a7526bcd" class="t t">ProviderInvocationException</a>)
            {
                <b>if</b> (!<span class="r90 r">force</span>)
                {
                    <b>throw</b>;
                }
            }
 
            <span class="c">// Now remove the drive if there was no error or we are forcing the removal</span>
 
            <b>if</b> (<span class="r93 r">canRemove</span> || <span class="r90 r">force</span>)
            {
                <span class="c">// The scope ID wasn&#39;t defined or wasn&#39;t recognizable</span>
                <span class="c">// so do a search through the scopes looking for the</span>
                <span class="c">// drive.</span>
 
                <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r91 r">scopeID</span>))
                {
                    <a href="SessionStateScopeEnumerator.cs.html#8788a8469feccecf" class="t t">SessionStateScopeEnumerator</a> <span id="r94 rd" class="r94 r">scopeEnumerator</span> =
                        <b>new</b> <a href="SessionStateScopeEnumerator.cs.html#5e5d2a8d36a22ba8" class="t constructor">SessionStateScopeEnumerator</a>(<a href="SessionStateScopeAPIs.cs.html#224987ad36a90f88" class="i property">CurrentScope</a>);
 
                    <b>foreach</b> (<a href="SessionStateScope.cs.html#460261155e0163cb" class="t t">SessionStateScope</a> <span id="r95 rd" class="r95 r">scope</span> <b>in</b> <span class="r94 r">scopeEnumerator</span>)
                    {
                        <b>try</b>
                        {
                            <a href="DataStoreAdapter.cs.html#2d16b26a541ba185" class="t t">PSDriveInfo</a> <span id="r96 rd" class="r96 r">result</span> = <span class="r95 r">scope</span>.<a href="SessionStateScope.cs.html#60d8a02344b18642" class="i method">GetDrive</a>(<span class="r89 r">drive</span>.<a href="DataStoreAdapter.cs.html#7c2d83a1b2b425a9" class="i property">Name</a>);
                            <b>if</b> (<span class="r96 r">result</span> != <b>null</b>)
                            {
                                <span class="r95 r">scope</span>.<a href="SessionStateScope.cs.html#235e4996b87173bd" class="i method">RemoveDrive</a>(<span class="r89 r">drive</span>);
 
                                <span class="c">// If the drive is the current drive for the provider, remove</span>
                                <span class="c">// it from the current drive list.</span>
 
                                <b>if</b> (<a href="SessionStateProviderAPIs.cs.html#5501f560faf2de0a" class="i property">ProvidersCurrentWorkingDrive</a>[<span class="r89 r">drive</span>.<a href="DataStoreAdapter.cs.html#599e6ea3519fc2d6" class="i property">Provider</a>] == <span class="r96 r">result</span>)
                                {
                                    <a href="SessionStateProviderAPIs.cs.html#5501f560faf2de0a" class="i property">ProvidersCurrentWorkingDrive</a>[<span class="r89 r">drive</span>.<a href="DataStoreAdapter.cs.html#599e6ea3519fc2d6" class="i property">Provider</a>] = <b>null</b>;
                                }
 
                                <b>break</b>;
                            }
                        }
                        <b>catch</b> (<span class="i">ArgumentException</span>)
                        {
                        }
                    }
                }
                <b>else</b>
                {
                    <a href="SessionStateScope.cs.html#460261155e0163cb" class="t t">SessionStateScope</a> <span id="r97 rd" class="r97 r">scope</span> = <a href="SessionStateScopeAPIs.cs.html#92e44fea6672dfdf" class="i method">GetScopeByID</a>(<span class="r91 r">scopeID</span>);
                    <span class="r97 r">scope</span>.<a href="SessionStateScope.cs.html#235e4996b87173bd" class="i method">RemoveDrive</a>(<span class="r89 r">drive</span>);
 
                    <span class="c">// If the drive is the current drive for the provider, remove</span>
                    <span class="c">// it from the current drive list.</span>
 
                    <b>if</b> (<a href="SessionStateProviderAPIs.cs.html#5501f560faf2de0a" class="i property">ProvidersCurrentWorkingDrive</a>[<span class="r89 r">drive</span>.<a href="DataStoreAdapter.cs.html#599e6ea3519fc2d6" class="i property">Provider</a>] == <span class="r89 r">drive</span>)
                    {
                        <a href="SessionStateProviderAPIs.cs.html#5501f560faf2de0a" class="i property">ProvidersCurrentWorkingDrive</a>[<span class="r89 r">drive</span>.<a href="DataStoreAdapter.cs.html#599e6ea3519fc2d6" class="i property">Provider</a>] = <b>null</b>;
                    }
                }
            }
            <b>else</b>
            {
                <a href="../utils/MshInvalidOperationException.cs.html#259a38c8b594783c" class="t t">PSInvalidOperationException</a> <span id="r98 rd" class="r98 r">e</span> =
                    (<a href="../utils/MshInvalidOperationException.cs.html#259a38c8b594783c" class="t t">PSInvalidOperationException</a>)<a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<span class="i">NewInvalidOperationException</span>(
                        <span class="i">SessionStateStrings</span>.<span class="i">DriveRemovalPreventedByProvider</span>,
                        <span class="r89 r">drive</span>.<a href="DataStoreAdapter.cs.html#7c2d83a1b2b425a9" class="i property">Name</a>,
                        <span class="r89 r">drive</span>.<a href="DataStoreAdapter.cs.html#599e6ea3519fc2d6" class="i property">Provider</a>);
 
                <span class="r92 r">context</span>.<a href="../namespaces/CoreCommandContext.cs.html#97661a296df11e6d" class="i method">WriteError</a>(
                    <b>new</b> <span class="t">ErrorRecord</span>(
                        <span class="r98 r">e</span>.<a href="../utils/MshInvalidOperationException.cs.html#cf42d4181b27e3c1" class="i property">ErrorRecord</a>,
                        <span class="r98 r">e</span>));
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Determines if the drive can be removed by calling the provider</span>
        <span class="c">///</span><span class="c"> for the drive.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r99 r">drive</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The drive to test for removal.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r100 r">context</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The context under which the command is running.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> True if the drive can be removed, false otherwise.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">ArgumentNullException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r99 r">drive</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> or </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r100 r">context</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> is null.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="../utils/SessionStateExceptions.cs.html#35e07c15a7526bcd" class="t t">ProviderInvocationException</a><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If the provider threw an exception when RemoveDrive was called.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>private bool</b> <a id="da239818a7016dbb" href="../R/da239818a7016dbb.html" target="n" data-glyph="76,1" class="i method">CanRemoveDrive</a>(<a href="DataStoreAdapter.cs.html#2d16b26a541ba185" class="t t">PSDriveInfo</a> <span id="r99 rd" class="r99 r">drive</span>, <a href="../namespaces/CoreCommandContext.cs.html#1e83d35d5286e174" class="t t">CmdletProviderContext</a> <span id="r100 rd" class="r100 r">context</span>)
        {
            <b>if</b> (<span class="r100 r">context</span> == <b>null</b>)
            {
                <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../utils/MshTraceSource.cs.html#fbe67220ad7522a0" class="i method">NewArgumentNullException</a>(<b>nameof</b>(<span class="r100 r">context</span>));
            }
 
            <b>if</b> (<span class="r99 r">drive</span> == <b>null</b>)
            {
                <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="../utils/MshTraceSource.cs.html#fbe67220ad7522a0" class="i method">NewArgumentNullException</a>(<b>nameof</b>(<span class="r99 r">drive</span>));
            }
 
            <a href="SessionState.cs.html#9a175ef52dd782b6" class="i field">s_tracer</a>.<a href="../utils/StructuredTraceSource.cs.html#25b8416175e53218" class="i method">WriteLine</a>(<span class="s">&quot;Drive name = {0}&quot;</span>, <span class="r99 r">drive</span>.<a href="DataStoreAdapter.cs.html#7c2d83a1b2b425a9" class="i property">Name</a>);
 
            <span class="c">// First set the drive data</span>
 
            <span class="r100 r">context</span>.<a href="../namespaces/CoreCommandContext.cs.html#f037b19aae477b8f" class="i property">Drive</a> = <span class="r99 r">drive</span>;
 
            <span class="c">// Now see if the provider will let us remove the drive</span>
 
            <a href="../namespaces/DriveProviderBase.cs.html#44a855059013a4af" class="t t">DriveCmdletProvider</a> <span id="r101 rd" class="r101 r">driveCmdletProvider</span> =
                <a href="SessionStateProviderAPIs.cs.html#684b564cf58f4962" class="i method">GetDriveProviderInstance</a>(<span class="r99 r">drive</span>.<a href="DataStoreAdapter.cs.html#599e6ea3519fc2d6" class="i property">Provider</a>);
 
            <b>bool</b> <span id="r102 rd" class="r102 r">driveRemovable</span> = <b>false</b>;
 
            <a href="DataStoreAdapter.cs.html#2d16b26a541ba185" class="t t">PSDriveInfo</a> <span id="r103 rd" class="r103 r">result</span> = <b>null</b>;
 
            <b>try</b>
            {
                <span class="r103 r">result</span> = <span class="r101 r">driveCmdletProvider</span>.<a href="../namespaces/DriveProviderBase.cs.html#d29373597e29cbcb" class="i method">RemoveDrive</a>(<span class="r99 r">drive</span>, <span class="r100 r">context</span>);
            }
            <b>catch</b> (<a href="lang/parserutils.cs.html#7aca1395e161031c" class="t t">LoopFlowException</a>)
            {
                <b>throw</b>;
            }
            <b>catch</b> (<a href="../utils/ExecutionExceptions.cs.html#1b159d1cae338f33" class="t t">PipelineStoppedException</a>)
            {
                <b>throw</b>;
            }
            <b>catch</b> (<a href="../utils/ExecutionExceptions.cs.html#f896df45dff24981" class="t t">ActionPreferenceStopException</a>)
            {
                <b>throw</b>;
            }
            <b>catch</b> (<span class="i">Exception</span> <span id="r104 rd" class="r104 r">e</span>) <span class="c">// Catch-all OK, 3rd party callout</span>
            {
                <b>throw</b> <span class="i">NewProviderInvocationException</span>(
                    <span class="s">&quot;RemoveDriveProviderException&quot;</span>,
                    <span class="i">SessionStateStrings</span>.<span class="i">RemoveDriveProviderException</span>,
                    <span class="r101 r">driveCmdletProvider</span>.<a href="../namespaces/ProviderBase.cs.html#6129ef83671ead76" class="i property">ProviderInfo</a>,
                    <b>null</b>,
                    <span class="r104 r">e</span>);
            }
 
            <b>if</b> (<span class="r103 r">result</span> != <b>null</b>)
            {
                <span class="c">// Make sure the provider didn&#39;t try to pull a fast one on us</span>
                <span class="c">// and substitute a different drive.</span>
 
                <b>if</b> (<b>string</b>.<span class="i">Equals</span>(<span class="r103 r">result</span>.<a href="DataStoreAdapter.cs.html#7c2d83a1b2b425a9" class="i property">Name</a>, <span class="r99 r">drive</span>.<a href="DataStoreAdapter.cs.html#7c2d83a1b2b425a9" class="i property">Name</a>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
                {
                    <span class="r102 r">driveRemovable</span> = <b>true</b>;
                }
            }
 
            <b>return</b> <span class="r102 r">driveRemovable</span>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> RemoveDrive
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Drives
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets an enumerable list of the drives that are mounted in</span>
        <span class="c">///</span><span class="c"> the specified scope.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r105 r">scope</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The scope to retrieve the drives from. If null or empty,</span>
        <span class="c">///</span><span class="c"> all drives from all scopes will be retrieved.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">ArgumentException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r105 r">scope</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> is less than zero, or not</span>
        <span class="c">///</span><span class="c"> a number and not &quot;script&quot;, &quot;global&quot;, &quot;local&quot;, or &quot;private&quot;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">ArgumentOutOfRangeException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="i">scopeID</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> is less than zero or greater than the number of currently</span>
        <span class="c">///</span><span class="c"> active scopes.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>internal</b> <span class="i">Collection</span>&lt;<a href="DataStoreAdapter.cs.html#2d16b26a541ba185" class="t t">PSDriveInfo</a>&gt; <a id="033714dcbf40ff39" href="../R/033714dcbf40ff39.html" target="n" data-glyph="74,1" class="i method">Drives</a>(<b>string</b> <span id="r105 rd" class="r105 r">scope</span>)
        {
            <span class="i">Dictionary</span>&lt;<b>string</b>, <a href="DataStoreAdapter.cs.html#2d16b26a541ba185" class="t t">PSDriveInfo</a>&gt; <span id="r106 rd" class="r106 r">driveTable</span> = <b>new</b> <span class="i">Dictionary</span>&lt;<b>string</b>, <a href="DataStoreAdapter.cs.html#2d16b26a541ba185" class="t t">PSDriveInfo</a>&gt;();
 
            <a href="SessionStateScope.cs.html#460261155e0163cb" class="t t">SessionStateScope</a> <span id="r107 rd" class="r107 r">startingScope</span> = <a href="SessionStateScopeAPIs.cs.html#5dfb91703808fccd" class="i field">_currentScope</a>;
 
            <b>if</b> (!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r105 r">scope</span>))
            {
                <span class="r107 r">startingScope</span> = <a href="SessionStateScopeAPIs.cs.html#92e44fea6672dfdf" class="i method">GetScopeByID</a>(<span class="r105 r">scope</span>);
            }
 
            <a href="SessionStateScopeEnumerator.cs.html#8788a8469feccecf" class="t t">SessionStateScopeEnumerator</a> <span id="r108 rd" class="r108 r">scopeEnumerator</span> =
                <b>new</b> <a href="SessionStateScopeEnumerator.cs.html#5e5d2a8d36a22ba8" class="t constructor">SessionStateScopeEnumerator</a>(<span class="r107 r">startingScope</span>);
            <span class="i">DriveInfo</span>[] <span id="r109 rd" class="r109 r">alldrives</span> = <span class="i">DriveInfo</span>.<span class="i">GetDrives</span>();
            <span class="i">Collection</span>&lt;<b>string</b>&gt; <span id="r110 rd" class="r110 r">driveNames</span> = <b>new</b> <span class="i">Collection</span>&lt;<b>string</b>&gt;();
            <b>foreach</b> (<span class="i">DriveInfo</span> <span id="r111 rd" class="r111 r">drive</span> <b>in</b> <span class="r109 r">alldrives</span>)
            {
                <span class="r110 r">driveNames</span>.<span class="i">Add</span>(<span class="r111 r">drive</span>.<span class="i">Name</span>.<span class="i">Substring</span>(0, 1));
            }
 
            <b>foreach</b> (<a href="SessionStateScope.cs.html#460261155e0163cb" class="t t">SessionStateScope</a> <span id="r112 rd" class="r112 r">lookupScope</span> <b>in</b> <span class="r108 r">scopeEnumerator</span>)
            {
                <b>foreach</b> (<a href="DataStoreAdapter.cs.html#2d16b26a541ba185" class="t t">PSDriveInfo</a> <span id="r113 rd" class="r113 r">drive</span> <b>in</b> <span class="r112 r">lookupScope</span>.<a href="SessionStateScope.cs.html#620dfb81e7623e3f" class="i property">Drives</a>)
                {
                    <span class="c">// It is the correct behavior for child scope</span>
                    <span class="c">// drives to overwrite parent scope drives of</span>
                    <span class="c">// the same name.</span>
 
                    <b>if</b> (<span class="r113 r">drive</span> != <b>null</b>)
                    {
                        <b>bool</b> <span id="r114 rd" class="r114 r">driveIsValid</span> = <b>true</b>;
 
                        <span class="c">// If the drive is auto-mounted, ensure that it still exists, or remove the drive.</span>
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">UNIX</span>
                        <b>if</b> (<span class="r113 r">drive</span>.<a href="DataStoreAdapter.cs.html#84a02b38509aa94e" class="i property">IsAutoMounted</a> || <a href="#0da44006fc97317d" class="i method">IsAStaleVhdMountedDrive</a>(<span class="r113 r">drive</span>))
                        {
                            <span class="r114 r">driveIsValid</span> = <a href="#b3b285eac8659ef2" class="i method">ValidateOrRemoveAutoMountedDrive</a>(<span class="r113 r">drive</span>, <span class="r112 r">lookupScope</span>);
                        }
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
                        <b>if</b> (<span class="r113 r">drive</span>.<a href="DataStoreAdapter.cs.html#7c2d83a1b2b425a9" class="i property">Name</a>.<span class="i">Length</span> == 1)
                        {
                            <b>if</b> (!(<span class="r110 r">driveNames</span>.<span class="i">Contains</span>(<span class="r113 r">drive</span>.<a href="DataStoreAdapter.cs.html#7c2d83a1b2b425a9" class="i property">Name</a>)))
                                <span class="r106 r">driveTable</span>.<span class="i">Remove</span>(<span class="r113 r">drive</span>.<a href="DataStoreAdapter.cs.html#7c2d83a1b2b425a9" class="i property">Name</a>);
                        }
 
                        <b>if</b> (<span class="r114 r">driveIsValid</span> &amp;&amp; !<span class="r106 r">driveTable</span>.<span class="i">ContainsKey</span>(<span class="r113 r">drive</span>.<a href="DataStoreAdapter.cs.html#7c2d83a1b2b425a9" class="i property">Name</a>))
                        {
                            <span class="r106 r">driveTable</span>[<span class="r113 r">drive</span>.<a href="DataStoreAdapter.cs.html#7c2d83a1b2b425a9" class="i property">Name</a>] = <span class="r113 r">drive</span>;
                        }
                    }
                }
 
                <span class="c">// If the scope was specified then don&#39;t loop</span>
                <span class="c">// through the other scopes</span>
 
                <b>if</b> (<span class="r105 r">scope</span> != <b>null</b> &amp;&amp; <span class="r105 r">scope</span>.<span class="i">Length</span> &gt; 0)
                {
                    <b>break</b>;
                }
            }
 
            <span class="c">// Now lookup all the file system drives and automount any that are not</span>
            <span class="c">// present</span>
 
            <b>try</b>
            {
                <b>foreach</b> (<span class="i n">System</span>.<span class="i">IO</span>.<span class="i">DriveInfo</span> <span id="r115 rd" class="r115 r">fsDriveInfo</span> <b>in</b> <span class="r109 r">alldrives</span>)
                {
                    <b>if</b> (<span class="r115 r">fsDriveInfo</span> != <b>null</b>)
                    {
                        <b>string</b> <span id="r116 rd" class="r116 r">fsDriveName</span> = <span class="r115 r">fsDriveInfo</span>.<span class="i">Name</span>.<span class="i">Substring</span>(0, 1);
                        <b>if</b> (!<span class="r106 r">driveTable</span>.<span class="i">ContainsKey</span>(<span class="r116 r">fsDriveName</span>))
                        {
                            <a href="DataStoreAdapter.cs.html#2d16b26a541ba185" class="t t">PSDriveInfo</a> <span id="r117 rd" class="r117 r">automountedDrive</span> = <a href="#c1b56479d89c7454" class="i method">AutomountFileSystemDrive</a>(<span class="r115 r">fsDriveInfo</span>);
                            <b>if</b> (<span class="r117 r">automountedDrive</span> != <b>null</b>)
                            {
                                <span class="r106 r">driveTable</span>[<span class="r117 r">automountedDrive</span>.<a href="DataStoreAdapter.cs.html#7c2d83a1b2b425a9" class="i property">Name</a>] = <span class="r117 r">automountedDrive</span>;
                            }
                        }
                    }
                }
            }
            <span class="c">// We don&#39;t want to have automounting cause an exception. We</span>
            <span class="c">// rather it just fail silently as it wasn&#39;t a result of an</span>
            <span class="c">// explicit request by the user anyway.</span>
            <b>catch</b> (<span class="i">IOException</span>)
            {
            }
            <b>catch</b> (<span class="i">UnauthorizedAccessException</span>)
            {
            }
 
            <span class="i">Collection</span>&lt;<a href="DataStoreAdapter.cs.html#2d16b26a541ba185" class="t t">PSDriveInfo</a>&gt; <span id="r118 rd" class="r118 r">results</span> = <b>new</b> <span class="i">Collection</span>&lt;<a href="DataStoreAdapter.cs.html#2d16b26a541ba185" class="t t">PSDriveInfo</a>&gt;();
            <b>foreach</b> (<a href="DataStoreAdapter.cs.html#2d16b26a541ba185" class="t t">PSDriveInfo</a> <span id="r119 rd" class="r119 r">drive</span> <b>in</b> <span class="r106 r">driveTable</span>.<span class="i">Values</span>)
            {
                <span class="r118 r">results</span>.<span class="i">Add</span>(<span class="r119 r">drive</span>);
            }
 
            <b>return</b> <span class="r118 r">results</span>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Drives
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets or sets the current working drive.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal</b> <a href="DataStoreAdapter.cs.html#2d16b26a541ba185" class="t t">PSDriveInfo</a> <a id="719e0929a853f471" href="../R/719e0929a853f471.html" target="n" data-glyph="104,1" class="i property">CurrentDrive</a>
        {
            <b>get</b>
            {
                <b>if</b> (<a href="../P/2dc1bd90a8299178.html#2dc1bd90a8299178" class="k">this</a> != <a href="SessionState.cs.html#3ddff2db6bc01805" class="i property">ExecutionContext</a>.<a href="ExecutionContext.cs.html#95bc6698d12886ee" class="i property">TopLevelSessionState</a>)
                    <b>return</b> <a href="SessionState.cs.html#3ddff2db6bc01805" class="i property">ExecutionContext</a>.<a href="ExecutionContext.cs.html#95bc6698d12886ee" class="i property">TopLevelSessionState</a>.<a href="#719e0929a853f471" class="i property">CurrentDrive</a>;
                <b>else</b>
                    <b>return</b> <a href="#d40730fe860ee8d2" class="i field">_currentDrive</a>;
            }
 
            <b>set</b>
            {
                <b>if</b> (<a href="../P/2dc1bd90a8299178.html#2dc1bd90a8299178" class="k">this</a> != <a href="SessionState.cs.html#3ddff2db6bc01805" class="i property">ExecutionContext</a>.<a href="ExecutionContext.cs.html#95bc6698d12886ee" class="i property">TopLevelSessionState</a>)
                    <a href="SessionState.cs.html#3ddff2db6bc01805" class="i property">ExecutionContext</a>.<a href="ExecutionContext.cs.html#95bc6698d12886ee" class="i property">TopLevelSessionState</a>.<a href="#719e0929a853f471" class="i property">CurrentDrive</a> = <b>value</b>;
                <b>else</b>
                    <a href="#d40730fe860ee8d2" class="i field">_currentDrive</a> = <b>value</b>;
            }
        }
    }
}
 
<span class="k preprocess">#</span><span class="k preprocess">pragma</span> <span class="k preprocess">warning</span> <span class="k preprocess">restore</span> 56500
 
</pre></td></tr></table></div></body></html>
