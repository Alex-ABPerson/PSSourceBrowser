<!DOCTYPE html>
<html><head><title>ComplexWriter.cs</title><link rel="stylesheet" href="../../../styles.css"><script src="../../../scripts.js"></script></head>
<body class="cB" onload="i(735);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#System.Management.Automation/FormatAndOutput/common/ComplexWriter.cs" target="_top">FormatAndOutput\common\ComplexWriter.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#System.Management.Automation" target="_top">src\System.Management.Automation\System.Management.Automation.csproj</a> (System.Management.Automation)</td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation.</span>
<span class="c">// Licensed under the MIT License.</span>
 
<b>using</b> <span class="i n">System</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Collections</span>.<span class="i">Generic</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Collections</span>.<span class="i">ObjectModel</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Collections</span>.<span class="i">Specialized</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Globalization</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Internal</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Text</span>;
 
<b>namespace</b> <span class="i n">Microsoft</span>.<span class="i n">PowerShell</span>.<span class="i n">Commands</span>.<span class="i n">Internal</span>.<span class="i n">Format</span>
{
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Writer class to handle Complex Object formatting.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>internal sealed class</b> <a id="dde06a7912f5417c" href="../../R/dde06a7912f5417c.html" target="n" data-glyph="2,0" class="t t"><span id="ac2330f4f8438e6c">ComplexWriter</span></a>
    {
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Initialization method to be called before any other operation.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r0 r">lineOutput</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">LineOutput interfaces to write to.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r1 r">numberOfTextColumns</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Number of columns used to write out.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="5e5a6185d20a34fb" href="../../R/5e5a6185d20a34fb.html" target="n" data-glyph="74,1" class="i method">Initialize</a>(<a href="ILineOutput.cs.html#bef25620bcca346e" class="t t">LineOutput</a> <span id="r0 rd" class="r0 r">lineOutput</span>, <b>int</b> <span id="r1 rd" class="r1 r">numberOfTextColumns</span>)
        {
            <a href="#bcb305dd0c600d77" class="i field">_lo</a> = <span class="r0 r">lineOutput</span>;
            <a href="#14ff0a3241acc45a" class="i field">_textColumns</a> = <span class="r1 r">numberOfTextColumns</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Writes a string.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r2 r">s</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="93cf2050ed478438" href="../../R/93cf2050ed478438.html" target="n" data-glyph="74,1" class="i method">WriteString</a>(<b>string</b> <span id="r2 rd" class="r2 r">s</span>)
        {
            <a href="#c839cfbad0831817" class="i field">_indentationManager</a>.<a href="#9d0fe2f7433b74b0" class="i method">Clear</a>();
 
            <a href="#724a9fb44b9e3d57" class="i method">AddToBuffer</a>(<span class="r2 r">s</span>);
 
            <a href="#acbdd909585799ae" class="i method">WriteToScreen</a>();
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> It interprets a list of format value tokens and outputs it.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r3 r">formatValueList</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">List of FormatValue tokens to interpret.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="6c3ead2b5662ffe5" href="../../R/6c3ead2b5662ffe5.html" target="n" data-glyph="74,1" class="i method">WriteObject</a>(<span class="i">List</span>&lt;<a href="FormattingObjects.cs.html#2bfca6d9f0ec67b7" class="t t">FormatValue</a>&gt; <span id="r3 rd" class="r3 r">formatValueList</span>)
        {
            <span class="c">// we always start with no indentation</span>
            <a href="#c839cfbad0831817" class="i field">_indentationManager</a>.<a href="#9d0fe2f7433b74b0" class="i method">Clear</a>();
 
            <b>foreach</b> (<a href="../../P/26a608afdff943e2.html#26a608afdff943e2" class="t t">FormatEntry</a> <span id="r4 rd" class="r4 r">fe</span> <b>in</b> <span class="r3 r">formatValueList</span>)
            {
                <span class="c">// operate on each directive inside the list,</span>
                <span class="c">// carrying the indentation from invocation to invocation</span>
                <a href="#4d5b7e418e031177" class="i method">GenerateFormatEntryDisplay</a>(<span class="r4 r">fe</span>, 0);
            }
            <span class="c">// make sure that, if we have pending text in the buffer it gets flushed</span>
            <a href="#acbdd909585799ae" class="i method">WriteToScreen</a>();
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Operate on a single entry.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r5 r">fe</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Entry to process.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r6 r">currentDepth</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Current depth of recursion.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>private void</b> <a id="4d5b7e418e031177" href="../../R/4d5b7e418e031177.html" target="n" data-glyph="76,1" class="i method">GenerateFormatEntryDisplay</a>(<a href="../../P/26a608afdff943e2.html#26a608afdff943e2" class="t t">FormatEntry</a> <span id="r5 rd" class="r5 r">fe</span>, <b>int</b> <span id="r6 rd" class="r6 r">currentDepth</span>)
        {
            <b>foreach</b> (<b>object</b> <span id="r7 rd" class="r7 r">obj</span> <b>in</b> <span class="r5 r">fe</span>.<a href="FormattingObjects.cs.html#50808a04a1fbd08f" class="i field">formatValueList</a>)
            {
                <a href="../../P/26a608afdff943e2.html#26a608afdff943e2" class="t t">FormatEntry</a> <span id="r8 rd" class="r8 r">feChild</span> = <span class="r7 r">obj</span> <b>as</b> <a href="../../P/26a608afdff943e2.html#26a608afdff943e2" class="t t">FormatEntry</a>;
                <b>if</b> (<span class="r8 r">feChild</span> != <b>null</b>)
                {
                    <b>if</b> (<span class="r6 r">currentDepth</span> &lt; <a href="#e90c761d39999691" class="i field">maxRecursionDepth</a>)
                    {
                        <b>if</b> (<span class="r8 r">feChild</span>.<a href="FormattingObjects.cs.html#734a043002f59427" class="i field">frameInfo</a> != <b>null</b>)
                        {
                            <span class="c">// if we have frame information, we need to push it on the</span>
                            <span class="c">// indentation stack</span>
                            <b>using</b> (<a href="#c839cfbad0831817" class="i field">_indentationManager</a>.<a href="#08f59f771f2ab356" class="i method">StackFrame</a>(<span class="r8 r">feChild</span>.<a href="FormattingObjects.cs.html#734a043002f59427" class="i field">frameInfo</a>))
                            {
                                <span class="i">GenerateFormatEntryDisplay</span>(<span class="r8 r">feChild</span>, <span class="r6 r">currentDepth</span> + 1);
                            }
                        }
                        <b>else</b>
                        {
                            <span class="c">// no need here of activating an indentation stack frame</span>
                            <span class="i">GenerateFormatEntryDisplay</span>(<span class="r8 r">feChild</span>, <span class="r6 r">currentDepth</span> + 1);
                        }
                    }
 
                    <b>continue</b>;
                }
 
                <b>if</b> (<span class="r7 r">obj</span> <b>is</b> <a href="FormattingObjects.cs.html#e58a5434cf604923" class="t t">FormatNewLine</a>)
                {
                    <a href="#dde06a7912f5417c" class="k">this</a>.<a href="#acbdd909585799ae" class="i method">WriteToScreen</a>();
                    <b>continue</b>;
                }
 
                <a href="../../P/a01601ca02f98310.html#a01601ca02f98310" class="t t">FormatTextField</a> <span id="r9 rd" class="r9 r">ftf</span> = <span class="r7 r">obj</span> <b>as</b> <a href="../../P/a01601ca02f98310.html#a01601ca02f98310" class="t t">FormatTextField</a>;
                <b>if</b> (<span class="r9 r">ftf</span> != <b>null</b>)
                {
                    <a href="#dde06a7912f5417c" class="k">this</a>.<a href="#724a9fb44b9e3d57" class="i method">AddToBuffer</a>(<span class="r9 r">ftf</span>.<a href="FormattingObjects.cs.html#429b438a5454027b" class="i field">text</a>);
                    <b>continue</b>;
                }
 
                <a href="../../P/03678054b01fd58e.html#03678054b01fd58e" class="t t">FormatPropertyField</a> <span id="r10 rd" class="r10 r">fpf</span> = <span class="r7 r">obj</span> <b>as</b> <a href="../../P/03678054b01fd58e.html#03678054b01fd58e" class="t t">FormatPropertyField</a>;
                <b>if</b> (<span class="r10 r">fpf</span> != <b>null</b>)
                {
                    <a href="#dde06a7912f5417c" class="k">this</a>.<a href="#724a9fb44b9e3d57" class="i method">AddToBuffer</a>(<span class="r10 r">fpf</span>.<a href="FormattingObjects.cs.html#5e8dcfb251ff14e3" class="i field">propertyValue</a>);
                }
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Add a string to the current buffer, waiting for a FlushBuffer()</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r11 r">s</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">String to add to buffer.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>private void</b> <a id="724a9fb44b9e3d57" href="../../R/724a9fb44b9e3d57.html" target="n" data-glyph="76,1" class="i method">AddToBuffer</a>(<b>string</b> <span id="r11 rd" class="r11 r">s</span>)
        {
            <a href="#ed71d71b24592fe6" class="i field">_stringBuffer</a>.<span class="i">Append</span>(<span class="r11 r">s</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Write to the output interface.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private void</b> <a id="acbdd909585799ae" href="../../R/acbdd909585799ae.html" target="n" data-glyph="76,1" class="i method">WriteToScreen</a>()
        {
            <b>int</b> <span id="r12 rd" class="r12 r">leftIndentation</span> = <a href="#c839cfbad0831817" class="i field">_indentationManager</a>.<a href="#03050180d038ff96" class="i property">LeftIndentation</a>;
            <b>int</b> <span id="r13 rd" class="r13 r">rightIndentation</span> = <a href="#c839cfbad0831817" class="i field">_indentationManager</a>.<a href="#3fc40c2a319fef9a" class="i property">RightIndentation</a>;
            <b>int</b> <span id="r14 rd" class="r14 r">firstLineIndentation</span> = <a href="#c839cfbad0831817" class="i field">_indentationManager</a>.<a href="#342d831c61610507" class="i property">FirstLineIndentation</a>;
 
            <span class="c">// VALIDITY CHECKS:</span>
 
            <span class="c">// check the useful (&quot;active&quot;) width</span>
            <b>int</b> <span id="r15 rd" class="r15 r">usefulWidth</span> = <a href="#14ff0a3241acc45a" class="i field">_textColumns</a> - <span class="r13 r">rightIndentation</span> - <span class="r12 r">leftIndentation</span>;
            <b>if</b> (<span class="r15 r">usefulWidth</span> &lt;= 0)
            {
                <span class="c">// fatal error, there is nothing to write to the device</span>
                <span class="c">// just clear the buffer and return</span>
                <a href="#ed71d71b24592fe6" class="i field">_stringBuffer</a> = <b>new</b> <span class="i">StringBuilder</span>();
            }
 
            <span class="c">// check indentation or hanging is not larger than the active width</span>
            <b>int</b> <span id="r16 rd" class="r16 r">indentationAbsoluteValue</span> = (<span class="r14 r">firstLineIndentation</span> &gt; 0) ? <span class="r14 r">firstLineIndentation</span> : -<span class="r14 r">firstLineIndentation</span>;
            <b>if</b> (<span class="r16 r">indentationAbsoluteValue</span> &gt;= <span class="r15 r">usefulWidth</span>)
            {
                <span class="c">// valu too big, we reset it to zero</span>
                <span class="r14 r">firstLineIndentation</span> = 0;
            }
 
            <span class="c">// compute the first line indentation or hanging</span>
            <b>int</b> <span id="r17 rd" class="r17 r">firstLineWidth</span> = <a href="#14ff0a3241acc45a" class="i field">_textColumns</a> - <span class="r13 r">rightIndentation</span> - <span class="r12 r">leftIndentation</span>;
            <b>int</b> <span id="r18 rd" class="r18 r">followingLinesWidth</span> = <span class="r17 r">firstLineWidth</span>;
 
            <b>if</b> (<span class="r14 r">firstLineIndentation</span> &gt;= 0)
            {
                <span class="c">// the first line has an indentation</span>
                <span class="r17 r">firstLineWidth</span> -= <span class="r14 r">firstLineIndentation</span>;
            }
            <b>else</b>
            {
                <span class="c">// the first line is hanging</span>
                <span class="r18 r">followingLinesWidth</span> += <span class="r14 r">firstLineIndentation</span>;
            }
 
            <span class="c">// error checking on invalid values</span>
 
            <span class="c">// generate the lines using the computed widths</span>
            <span class="i">StringCollection</span> <span id="r19 rd" class="r19 r">sc</span> = <a href="#ce52aabdba932938" class="t t">StringManipulationHelper</a>.<span class="i">GenerateLines</span>(<a href="#bcb305dd0c600d77" class="i field">_lo</a>.<a href="ILineOutput.cs.html#99386fe34bd7140c" class="i property">DisplayCells</a>, <a href="#ed71d71b24592fe6" class="i field">_stringBuffer</a>.<span class="i">ToString</span>(),
                                        <span class="r17 r">firstLineWidth</span>, <span class="r18 r">followingLinesWidth</span>);
 
            <span class="c">// compute padding</span>
            <b>int</b> <span id="r20 rd" class="r20 r">firstLinePadding</span> = <span class="r12 r">leftIndentation</span>;
            <b>int</b> <span id="r21 rd" class="r21 r">followingLinesPadding</span> = <span class="r12 r">leftIndentation</span>;
            <b>if</b> (<span class="r14 r">firstLineIndentation</span> &gt;= 0)
            {
                <span class="c">// the first line has an indentation</span>
                <span class="r20 r">firstLinePadding</span> += <span class="r14 r">firstLineIndentation</span>;
            }
            <b>else</b>
            {
                <span class="c">// the first line is hanging</span>
                <span class="r21 r">followingLinesPadding</span> -= <span class="r14 r">firstLineIndentation</span>;
            }
 
            <span class="c">// now write the lines on the screen</span>
            <b>bool</b> <span id="r22 rd" class="r22 r">firstLine</span> = <b>true</b>;
            <b>foreach</b> (<b>string</b> <span id="r23 rd" class="r23 r">s</span> <b>in</b> <span class="r19 r">sc</span>)
            {
                <b>if</b> (<span class="r22 r">firstLine</span>)
                {
                    <span class="r22 r">firstLine</span> = <b>false</b>;
                    <a href="#bcb305dd0c600d77" class="i field">_lo</a>.<a href="ILineOutput.cs.html#fd3191b17b478f7f" class="i method">WriteLine</a>(<a href="#ce52aabdba932938" class="t t">StringManipulationHelper</a>.<a href="#b30e2628f55d0b53" class="i method">PadLeft</a>(<span class="r23 r">s</span>, <span class="r20 r">firstLinePadding</span>));
                }
                <b>else</b>
                {
                    <a href="#bcb305dd0c600d77" class="i field">_lo</a>.<a href="ILineOutput.cs.html#fd3191b17b478f7f" class="i method">WriteLine</a>(<a href="#ce52aabdba932938" class="t t">StringManipulationHelper</a>.<a href="#b30e2628f55d0b53" class="i method">PadLeft</a>(<span class="r23 r">s</span>, <span class="r21 r">followingLinesPadding</span>));
                }
            }
 
            <a href="#ed71d71b24592fe6" class="i field">_stringBuffer</a> = <b>new</b> <span class="i">StringBuilder</span>();
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Helper object to manage the frame-based indentation and margins.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private readonly</b> <a href="#21ec7fe1c8df9e49" class="t t">IndentationManager</a> <a id="c839cfbad0831817" href="../../R/c839cfbad0831817.html" target="n" data-glyph="46,1" class="i field">_indentationManager</a> = <b>new</b> <span class="t">IndentationManager</span>();
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Buffer to accumulate partially constructed text.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private</b> <span class="i">StringBuilder</span> <a id="ed71d71b24592fe6" href="../../R/ed71d71b24592fe6.html" target="n" data-glyph="46,1" class="i field">_stringBuffer</a> = <b>new</b> <span class="i">StringBuilder</span>();
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Interface to write to.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private</b> <a href="ILineOutput.cs.html#bef25620bcca346e" class="t t">LineOutput</a> <a id="bcb305dd0c600d77" href="../../R/bcb305dd0c600d77.html" target="n" data-glyph="46,1" class="i field">_lo</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Number of columns for the output device.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private int</b> <a id="14ff0a3241acc45a" href="../../R/14ff0a3241acc45a.html" target="n" data-glyph="46,1" class="i field">_textColumns</a>;
 
        <b>private const int</b> <a id="e90c761d39999691" href="../../R/e90c761d39999691.html" target="n" data-glyph="10,1" class="i field">maxRecursionDepth</a> = 50;
    }
 
    <b>internal sealed class</b> <a id="21ec7fe1c8df9e49" href="../../R/21ec7fe1c8df9e49.html" target="n" data-glyph="2,0" class="t t"><span id="09ba2258dce1a740">IndentationManager</span></a>
    {
        <b>private sealed class</b> <a id="8f30fc0a14b35d54" href="../../R/8f30fc0a14b35d54.html" target="n" data-glyph="4,1" class="t t">IndentationStackFrame</a> : <span class="i">IDisposable</span>
        {
            <b>internal</b> <a id="3a5b95e6a18ef00e" href="../../R/3a5b95e6a18ef00e.html" target="n" data-glyph="74,2" class="t constructor">IndentationStackFrame</a>(<a href="#21ec7fe1c8df9e49" class="t t">IndentationManager</a> <span id="r24 rd" class="r24 r">mgr</span>)
            {
                <a href="#62ace40a94fa742d" class="i field">_mgr</a> = <span class="r24 r">mgr</span>;
            }
 
            <b>public void</b> <a id="05986fb61473652f" href="../../R/../../0000000000.html" target="n" data-glyph="72,2" class="i method">Dispose</a>()
            {
                <b>if</b> (<a href="#62ace40a94fa742d" class="i field">_mgr</a> != <b>null</b>)
                {
                    <a href="#62ace40a94fa742d" class="i field">_mgr</a>.<a href="#ff1e974cbb3c312a" class="i method">RemoveStackFrame</a>();
                }
            }
 
            <b>private readonly</b> <a href="#21ec7fe1c8df9e49" class="t t">IndentationManager</a> <a id="62ace40a94fa742d" href="../../R/62ace40a94fa742d.html" target="n" data-glyph="46,2" class="i field">_mgr</a>;
        }
 
        <b>internal void</b> <a id="9d0fe2f7433b74b0" href="../../R/9d0fe2f7433b74b0.html" target="n" data-glyph="74,1" class="i method">Clear</a>()
        {
            <a href="#17864e9bc2f41caa" class="i field">_frameInfoStack</a>.<span class="i">Clear</span>();
        }
 
        <b>internal</b> <span class="i">IDisposable</span> <a id="08f59f771f2ab356" href="../../R/08f59f771f2ab356.html" target="n" data-glyph="74,1" class="i method">StackFrame</a>(<a href="../../P/2d4496ea5d966815.html#2d4496ea5d966815" class="t t">FrameInfo</a> <span id="r25 rd" class="r25 r">frameInfo</span>)
        {
            <a href="#8f30fc0a14b35d54" class="t t">IndentationStackFrame</a> <span id="r26 rd" class="r26 r">frame</span> = <b>new</b> <a href="#3a5b95e6a18ef00e" class="t constructor">IndentationStackFrame</a>(<a href="#21ec7fe1c8df9e49" class="k">this</a>);
            <a href="#17864e9bc2f41caa" class="i field">_frameInfoStack</a>.<span class="i">Push</span>(<span class="r25 r">frameInfo</span>);
            <b>return</b> <span class="r26 r">frame</span>;
        }
 
        <b>private void</b> <a id="ff1e974cbb3c312a" href="../../R/ff1e974cbb3c312a.html" target="n" data-glyph="76,1" class="i method">RemoveStackFrame</a>()
        {
            <a href="#17864e9bc2f41caa" class="i field">_frameInfoStack</a>.<span class="i">Pop</span>();
        }
 
        <b>internal int</b> <a id="3fc40c2a319fef9a" href="../../R/3fc40c2a319fef9a.html" target="n" data-glyph="104,1" class="i property">RightIndentation</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#9fdf1a62717213c3" class="i method">ComputeRightIndentation</a>();
            }
        }
 
        <b>internal int</b> <a id="03050180d038ff96" href="../../R/03050180d038ff96.html" target="n" data-glyph="104,1" class="i property">LeftIndentation</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#2a9a5d789396ab68" class="i method">ComputeLeftIndentation</a>();
            }
        }
 
        <b>internal int</b> <a id="342d831c61610507" href="../../R/342d831c61610507.html" target="n" data-glyph="104,1" class="i property">FirstLineIndentation</a>
        {
            <b>get</b>
            {
                <b>if</b> (<a href="#17864e9bc2f41caa" class="i field">_frameInfoStack</a>.<span class="i">Count</span> == 0)
                    <b>return</b> 0;
                <b>return</b> <a href="#17864e9bc2f41caa" class="i field">_frameInfoStack</a>.<span class="i">Peek</span>().<span class="i">firstLine</span>;
            }
        }
 
        <b>private int</b> <a id="9fdf1a62717213c3" href="../../R/9fdf1a62717213c3.html" target="n" data-glyph="76,1" class="i method">ComputeRightIndentation</a>()
        {
            <b>int</b> <span id="r27 rd" class="r27 r">val</span> = 0;
            <b>foreach</b> (<a href="../../P/2d4496ea5d966815.html#2d4496ea5d966815" class="t t">FrameInfo</a> <span id="r28 rd" class="r28 r">fi</span> <b>in</b> <a href="#17864e9bc2f41caa" class="i field">_frameInfoStack</a>)
            {
                <span class="r27 r">val</span> += <span class="r28 r">fi</span>.<a href="FormattingObjects.cs.html#3193e186da1897ae" class="i field">rightIndentation</a>;
            }
 
            <b>return</b> <span class="r27 r">val</span>;
        }
 
        <b>private int</b> <a id="2a9a5d789396ab68" href="../../R/2a9a5d789396ab68.html" target="n" data-glyph="76,1" class="i method">ComputeLeftIndentation</a>()
        {
            <b>int</b> <span id="r29 rd" class="r29 r">val</span> = 0;
            <b>foreach</b> (<a href="../../P/2d4496ea5d966815.html#2d4496ea5d966815" class="t t">FrameInfo</a> <span id="r30 rd" class="r30 r">fi</span> <b>in</b> <a href="#17864e9bc2f41caa" class="i field">_frameInfoStack</a>)
            {
                <span class="r29 r">val</span> += <span class="r30 r">fi</span>.<a href="FormattingObjects.cs.html#32b84b84ce7d6de1" class="i field">leftIndentation</a>;
            }
 
            <b>return</b> <span class="r29 r">val</span>;
        }
 
        <b>private readonly</b> <span class="i">Stack</span>&lt;<a href="../../P/2d4496ea5d966815.html#2d4496ea5d966815" class="t t">FrameInfo</a>&gt; <a id="17864e9bc2f41caa" href="../../R/17864e9bc2f41caa.html" target="n" data-glyph="46,1" class="i field">_frameInfoStack</a> = <b>new</b> <span class="i">Stack</span>&lt;<a href="../../P/2d4496ea5d966815.html#2d4496ea5d966815" class="t t">FrameInfo</a>&gt;();
    }
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Result of GetWords.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>internal struct</b> <a id="ddd8674c020d1c81" href="../../R/ddd8674c020d1c81.html" target="n" data-glyph="110,0" class="t t"><span id="4bdee125cb67dc82">GetWordsResult</span></a>
    {
        <b>internal string</b> <a id="2d85e7a785a93a4f" href="../../R/2d85e7a785a93a4f.html" target="n" data-glyph="44,1" class="i field">Word</a>;
        <b>internal string</b> <a id="137ebdfe5a48ca2b" href="../../R/137ebdfe5a48ca2b.html" target="n" data-glyph="44,1" class="i field">Delim</a>;
    }
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Collection of helper functions for string formatting.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>internal sealed class</b> <a id="ce52aabdba932938" href="../../R/ce52aabdba932938.html" target="n" data-glyph="2,0" class="t t"><span id="fb17c389061383c1">StringManipulationHelper</span></a>
    {
        <b>private static readonly char</b> <a id="48c006dca7b5ddde" href="../../R/48c006dca7b5ddde.html" target="n" data-glyph="46,1" class="i field">s_softHyphen</a> = <span class="s">&#39;\u00AD&#39;</span>;
        <b>private static readonly char</b> <a id="cc76daa823ccae25" href="../../R/cc76daa823ccae25.html" target="n" data-glyph="46,1" class="i field">s_hardHyphen</a> = <span class="s">&#39;\u2011&#39;</span>;
        <b>private static readonly char</b> <a id="8fd81eefdfa3f5e3" href="../../R/8fd81eefdfa3f5e3.html" target="n" data-glyph="46,1" class="i field">s_nonBreakingSpace</a> = <span class="s">&#39;\u00A0&#39;</span>;
        <b>private static readonly</b> <span class="i">Collection</span>&lt;<b>string</b>&gt; <a id="6067d035b8b1b386" href="../../R/6067d035b8b1b386.html" target="n" data-glyph="46,1" class="i field">s_cultureCollection</a> = <b>new</b> <span class="i">Collection</span>&lt;<b>string</b>&gt;();
 
        <b>static</b> <a id="3b41da9b6a462f57" href="../../R/../../0000000000.html" target="n" data-glyph="76,1" class="t method">StringManipulationHelper</a>()
        {
            <a href="#6067d035b8b1b386" class="i field">s_cultureCollection</a>.<span class="i">Add</span>(<span class="s">&quot;en&quot;</span>);        <span class="c">// English</span>
            <a href="#6067d035b8b1b386" class="i field">s_cultureCollection</a>.<span class="i">Add</span>(<span class="s">&quot;fr&quot;</span>);        <span class="c">// French</span>
            <a href="#6067d035b8b1b386" class="i field">s_cultureCollection</a>.<span class="i">Add</span>(<span class="s">&quot;de&quot;</span>);        <span class="c">// German</span>
            <a href="#6067d035b8b1b386" class="i field">s_cultureCollection</a>.<span class="i">Add</span>(<span class="s">&quot;it&quot;</span>);        <span class="c">// Italian</span>
            <a href="#6067d035b8b1b386" class="i field">s_cultureCollection</a>.<span class="i">Add</span>(<span class="s">&quot;pt&quot;</span>);        <span class="c">// Portuguese</span>
            <a href="#6067d035b8b1b386" class="i field">s_cultureCollection</a>.<span class="i">Add</span>(<span class="s">&quot;es&quot;</span>);        <span class="c">// Spanish</span>
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Breaks a string into a collection of words</span>
        <span class="c">///</span><span class="c"> TODO: we might be able to improve this function in the future</span>
        <span class="c">///</span><span class="c"> so that we do not break paths etc.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r31 r">s</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Input string.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">A collection of words.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>private static</b> <span class="i">IEnumerable</span>&lt;<a href="#ddd8674c020d1c81" class="t t">GetWordsResult</a>&gt; <a id="e5f3cf9aaa57a4a1" href="../../R/e5f3cf9aaa57a4a1.html" target="n" data-glyph="76,1" class="i method">GetWords</a>(<b>string</b> <span id="r31 rd" class="r31 r">s</span>)
        {
            <span class="i">StringBuilder</span> <span id="r32 rd" class="r32 r">sb</span> = <b>new</b> <span class="i">StringBuilder</span>();
            <a href="#ddd8674c020d1c81" class="t t">GetWordsResult</a> <span id="r33 rd" class="r33 r">result</span> = <b>new</b> <span class="t">GetWordsResult</span>();
 
            <b>for</b> (<b>int</b> <span id="r34 rd" class="r34 r">i</span> = 0; <span class="r34 r">i</span> &lt; <span class="r31 r">s</span>.<span class="i">Length</span>; <span class="r34 r">i</span>++)
            {
                <span class="c">// Soft hyphen = \u00AD - Should break, and add a hyphen if needed. If not needed for a break, hyphen should be absent</span>
                <b>if</b> (<span class="r31 r">s</span>[<span class="r34 r">i</span>] == <span class="s">&#39; &#39;</span> || <span class="r31 r">s</span>[<span class="r34 r">i</span>] == <span class="s">&#39;\t&#39;</span> || <span class="r31 r">s</span>[<span class="r34 r">i</span>] == <a href="#48c006dca7b5ddde" class="i field">s_softHyphen</a>)
                {
                    <span class="r33 r">result</span>.<a href="#2d85e7a785a93a4f" class="i field">Word</a> = <span class="r32 r">sb</span>.<span class="i">ToString</span>();
                    <span class="r32 r">sb</span>.<span class="i">Clear</span>();
                    <span class="r33 r">result</span>.<a href="#137ebdfe5a48ca2b" class="i field">Delim</a> = <b>new</b> <b>string</b>(<span class="r31 r">s</span>[<span class="r34 r">i</span>], 1);
 
                    <b>yield</b> <b>return</b> <span class="r33 r">result</span>;
                }
                <span class="c">// Non-breaking space = \u00A0 - ideally shouldn&#39;t wrap</span>
                <span class="c">// Hard hyphen = \u2011 - Should not break</span>
                <b>else</b> <b>if</b> (<span class="r31 r">s</span>[<span class="r34 r">i</span>] == <a href="#cc76daa823ccae25" class="i field">s_hardHyphen</a> || <span class="r31 r">s</span>[<span class="r34 r">i</span>] == <a href="#8fd81eefdfa3f5e3" class="i field">s_nonBreakingSpace</a>)
                {
                    <span class="r33 r">result</span>.<a href="#2d85e7a785a93a4f" class="i field">Word</a> = <span class="r32 r">sb</span>.<span class="i">ToString</span>();
                    <span class="r32 r">sb</span>.<span class="i">Clear</span>();
                    <span class="r33 r">result</span>.<a href="#137ebdfe5a48ca2b" class="i field">Delim</a> = <b>string</b>.<span class="i">Empty</span>;
 
                    <b>yield</b> <b>return</b> <span class="r33 r">result</span>;
                }
                <b>else</b>
                {
                    <span class="r32 r">sb</span>.<span class="i">Append</span>(<span class="r31 r">s</span>[<span class="r34 r">i</span>]);
                }
            }
 
            <span class="r33 r">result</span>.<a href="#2d85e7a785a93a4f" class="i field">Word</a> = <span class="r32 r">sb</span>.<span class="i">ToString</span>();
            <span class="r33 r">result</span>.<a href="#137ebdfe5a48ca2b" class="i field">Delim</a> = <b>string</b>.<span class="i">Empty</span>;
 
            <b>yield</b> <b>return</b> <span class="r33 r">result</span>;
        }
 
        <b>internal static</b> <span class="i">StringCollection</span> <a id="d919cc7a3bb58a02" href="../../R/d919cc7a3bb58a02.html" target="n" data-glyph="74,1" class="i method">GenerateLines</a>(<a href="ILineOutput.cs.html#20795ffb5d8d2dc1" class="t t">DisplayCells</a> <span id="r35 rd" class="r35 r">displayCells</span>, <b>string</b> <span id="r36 rd" class="r36 r">val</span>, <b>int</b> <span id="r37 rd" class="r37 r">firstLineLen</span>, <b>int</b> <span id="r38 rd" class="r38 r">followingLinesLen</span>)
        {
            <b>if</b> (<a href="#6067d035b8b1b386" class="i field">s_cultureCollection</a>.<span class="i">Contains</span>(<span class="i">CultureInfo</span>.<span class="i">CurrentCulture</span>.<span class="i">TwoLetterISOLanguageName</span>))
            {
                <b>return</b> <a href="#4826b322195f7530" class="i method">GenerateLinesWithWordWrap</a>(<span class="r35 r">displayCells</span>, <span class="r36 r">val</span>, <span class="r37 r">firstLineLen</span>, <span class="r38 r">followingLinesLen</span>);
            }
            <b>else</b>
            {
                <b>return</b> <a href="#57cd8d143cb47051" class="i method">GenerateLinesWithoutWordWrap</a>(<span class="r35 r">displayCells</span>, <span class="r36 r">val</span>, <span class="r37 r">firstLineLen</span>, <span class="r38 r">followingLinesLen</span>);
            }
        }
 
        <b>private static</b> <span class="i">StringCollection</span> <a id="57cd8d143cb47051" href="../../R/57cd8d143cb47051.html" target="n" data-glyph="76,1" class="i method">GenerateLinesWithoutWordWrap</a>(<a href="ILineOutput.cs.html#20795ffb5d8d2dc1" class="t t">DisplayCells</a> <span id="r39 rd" class="r39 r">displayCells</span>, <b>string</b> <span id="r40 rd" class="r40 r">val</span>, <b>int</b> <span id="r41 rd" class="r41 r">firstLineLen</span>, <b>int</b> <span id="r42 rd" class="r42 r">followingLinesLen</span>)
        {
            <span class="i">StringCollection</span> <span id="r43 rd" class="r43 r">retVal</span> = <b>new</b> <span class="i">StringCollection</span>();
 
            <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r40 r">val</span>))
            {
                <span class="c">// if null or empty, just add and we are done</span>
                <span class="r43 r">retVal</span>.<span class="i">Add</span>(<span class="r40 r">val</span>);
                <b>return</b> <span class="r43 r">retVal</span>;
            }
 
            <span class="c">// break string on newlines and process each line separately</span>
            <b>string</b>[] <span id="r44 rd" class="r44 r">lines</span> = <a href="#d1560af19064ec89" class="i method">SplitLines</a>(<span class="r40 r">val</span>);
 
            <b>for</b> (<b>int</b> <span id="r45 rd" class="r45 r">k</span> = 0; <span class="r45 r">k</span> &lt; <span class="r44 r">lines</span>.<span class="i">Length</span>; <span class="r45 r">k</span>++)
            {
                <b>string</b> <span id="r46 rd" class="r46 r">currentLine</span> = <span class="r44 r">lines</span>[<span class="r45 r">k</span>];
 
                <b>if</b> (<span class="r46 r">currentLine</span> == <b>null</b> || <span class="r39 r">displayCells</span>.<a href="ILineOutput.cs.html#c7940c04c4b1ebce" class="i method">Length</a>(<span class="r46 r">currentLine</span>) &lt;= <span class="r41 r">firstLineLen</span>)
                {
                    <span class="c">// we do not need to split further, just add</span>
                    <span class="r43 r">retVal</span>.<span class="i">Add</span>(<span class="r46 r">currentLine</span>);
                    <b>continue</b>;
                }
 
                <span class="c">// the string does not fit, so we have to wrap around on multiple lines</span>
                <span class="c">// for each of these lines in the string, the first line will have</span>
                <span class="c">// a (potentially) different length (indentation or hanging)</span>
 
                <span class="c">// for each line, start a new state</span>
                <a href="#3b68055cd02ac6ec" class="t t">SplitLinesAccumulator</a> <span id="r47 rd" class="r47 r">accumulator</span> = <b>new</b> <a href="#e48c403d94f566e0" class="t constructor">SplitLinesAccumulator</a>(<span class="r43 r">retVal</span>, <span class="r41 r">firstLineLen</span>, <span class="r42 r">followingLinesLen</span>);
 
                <b>int</b> <span id="r48 rd" class="r48 r">offset</span> = 0; <span class="c">// offset into the line we are splitting</span>
 
                <b>while</b> (<span class="r48 r">offset</span> &lt; <span class="r46 r">currentLine</span>.<span class="i">Length</span>)
                {
                    <span class="c">// acquire the current active display line length (it can very from call to call)</span>
                    <b>int</b> <span id="r49 rd" class="r49 r">currentDisplayLen</span> = <span class="r47 r">accumulator</span>.<a href="#a337ae533eb8cc86" class="i property">ActiveLen</a>;
 
                    <span class="c">// determine if the current tail would fit or not</span>
 
                    <span class="c">// for the remaining part of the string, determine its display cell count</span>
                    <b>int</b> <span id="r50 rd" class="r50 r">currentCellsToFit</span> = <span class="r39 r">displayCells</span>.<a href="ILineOutput.cs.html#0c0b73815805f0b2" class="i method">Length</a>(<span class="r46 r">currentLine</span>, <span class="r48 r">offset</span>);
 
                    <span class="c">// determine if we fit into the line</span>
                    <b>int</b> <span id="r51 rd" class="r51 r">excessCells</span> = <span class="r50 r">currentCellsToFit</span> - <span class="r49 r">currentDisplayLen</span>;
 
                    <b>if</b> (<span class="r51 r">excessCells</span> &gt; 0)
                    {
                        <span class="c">// we are not at the end of the string, select a sub string</span>
                        <span class="c">// that would fit in the remaining display length</span>
                        <b>int</b> <span id="r52 rd" class="r52 r">charactersToAdd</span> = <span class="r39 r">displayCells</span>.<a href="ILineOutput.cs.html#54ca4d910db217f7" class="i method">GetHeadSplitLength</a>(<span class="r46 r">currentLine</span>, <span class="r48 r">offset</span>, <span class="r49 r">currentDisplayLen</span>);
 
                        <b>if</b> (<span class="r52 r">charactersToAdd</span> &lt;= 0)
                        {
                            <span class="c">// corner case: we have a two cell character and the current</span>
                            <span class="c">// display length is one.</span>
                            <span class="c">// add a single cell arbitrary character instead of the original</span>
                            <span class="c">// one and keep going</span>
                            <span class="r52 r">charactersToAdd</span> = 1;
                            <span class="r47 r">accumulator</span>.<a href="#5350fb1e88e508ec" class="i method">AddLine</a>(<span class="s">&quot;?&quot;</span>);
                        }
                        <b>else</b>
                        {
                            <span class="c">// of the given length, add it to the accumulator</span>
                            <span class="r47 r">accumulator</span>.<span class="i">AddLine</span>(<span class="r46 r">currentLine</span>.<span class="i">Substring</span>(<span class="r48 r">offset</span>, <span class="r52 r">charactersToAdd</span>));
                        }
 
                        <span class="c">// increase the offset by the # of characters added</span>
                        <span class="r48 r">offset</span> += <span class="r52 r">charactersToAdd</span>;
                    }
                    <b>else</b>
                    {
                        <span class="c">// we reached the last (partial) line, we add it all</span>
                        <span class="r47 r">accumulator</span>.<span class="i">AddLine</span>(<span class="r46 r">currentLine</span>.<span class="i">Substring</span>(<span class="r48 r">offset</span>));
                        <b>break</b>;
                    }
                }
            }
 
            <b>return</b> <span class="r43 r">retVal</span>;
        }
 
        <b>private sealed class</b> <a id="3b68055cd02ac6ec" href="../../R/3b68055cd02ac6ec.html" target="n" data-glyph="4,1" class="t t">SplitLinesAccumulator</a>
        {
            <b>internal</b> <a id="e48c403d94f566e0" href="../../R/e48c403d94f566e0.html" target="n" data-glyph="74,2" class="t constructor">SplitLinesAccumulator</a>(<span class="i">StringCollection</span> <span id="r53 rd" class="r53 r">retVal</span>, <b>int</b> <span id="r54 rd" class="r54 r">firstLineLen</span>, <b>int</b> <span id="r55 rd" class="r55 r">followingLinesLen</span>)
            {
                <a href="#20a1b90e722942dd" class="i field">_retVal</a> = <span class="r53 r">retVal</span>;
                <a href="#29f8d23bc0fac5a3" class="i field">_firstLineLen</a> = <span class="r54 r">firstLineLen</span>;
                <a href="#72dbae4fa229aa8c" class="i field">_followingLinesLen</a> = <span class="r55 r">followingLinesLen</span>;
            }
 
            <b>internal void</b> <a id="5350fb1e88e508ec" href="../../R/5350fb1e88e508ec.html" target="n" data-glyph="74,2" class="i method">AddLine</a>(<b>string</b> <span id="r56 rd" class="r56 r">s</span>)
            {
                <b>if</b> (!<a href="#b0ccb84e73660ecc" class="i field">_addedFirstLine</a>)
                {
                    <a href="#b0ccb84e73660ecc" class="i field">_addedFirstLine</a> = <b>true</b>;
                }
 
                <a href="#20a1b90e722942dd" class="i field">_retVal</a>.<span class="i">Add</span>(<span class="r56 r">s</span>);
            }
 
            <b>internal int</b> <a id="a337ae533eb8cc86" href="../../R/a337ae533eb8cc86.html" target="n" data-glyph="104,2" class="i property">ActiveLen</a>
            {
                <b>get</b>
                {
                    <b>if</b> (<a href="#b0ccb84e73660ecc" class="i field">_addedFirstLine</a>)
                        <b>return</b> <a href="#72dbae4fa229aa8c" class="i field">_followingLinesLen</a>;
                    <b>return</b> <a href="#29f8d23bc0fac5a3" class="i field">_firstLineLen</a>;
                }
            }
 
            <b>private readonly</b> <span class="i">StringCollection</span> <a id="20a1b90e722942dd" href="../../R/20a1b90e722942dd.html" target="n" data-glyph="46,2" class="i field">_retVal</a>;
            <b>private bool</b> <a id="b0ccb84e73660ecc" href="../../R/b0ccb84e73660ecc.html" target="n" data-glyph="46,2" class="i field">_addedFirstLine</a>;
            <b>private readonly int</b> <a id="29f8d23bc0fac5a3" href="../../R/29f8d23bc0fac5a3.html" target="n" data-glyph="46,2" class="i field">_firstLineLen</a>;
            <b>private readonly int</b> <a id="72dbae4fa229aa8c" href="../../R/72dbae4fa229aa8c.html" target="n" data-glyph="46,2" class="i field">_followingLinesLen</a>;
        }
 
        <b>private static</b> <span class="i">StringCollection</span> <a id="4826b322195f7530" href="../../R/4826b322195f7530.html" target="n" data-glyph="76,1" class="i method">GenerateLinesWithWordWrap</a>(<a href="ILineOutput.cs.html#20795ffb5d8d2dc1" class="t t">DisplayCells</a> <span id="r57 rd" class="r57 r">displayCells</span>, <b>string</b> <span id="r58 rd" class="r58 r">val</span>, <b>int</b> <span id="r59 rd" class="r59 r">firstLineLen</span>, <b>int</b> <span id="r60 rd" class="r60 r">followingLinesLen</span>)
        {
            <span class="i">StringCollection</span> <span id="r61 rd" class="r61 r">retVal</span> = <b>new</b> <span class="i">StringCollection</span>();
 
            <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r58 r">val</span>))
            {
                <span class="c">// if null or empty, just add and we are done</span>
                <span class="r61 r">retVal</span>.<span class="i">Add</span>(<span class="r58 r">val</span>);
                <b>return</b> <span class="r61 r">retVal</span>;
            }
 
            <span class="c">// break string on newlines and process each line separately</span>
            <b>string</b>[] <span id="r62 rd" class="r62 r">lines</span> = <a href="#d1560af19064ec89" class="i method">SplitLines</a>(<span class="r58 r">val</span>);
 
            <b>for</b> (<b>int</b> <span id="r63 rd" class="r63 r">k</span> = 0; <span class="r63 r">k</span> &lt; <span class="r62 r">lines</span>.<span class="i">Length</span>; <span class="r63 r">k</span>++)
            {
                <b>if</b> (<span class="r62 r">lines</span>[<span class="r63 r">k</span>] == <b>null</b> || <span class="r57 r">displayCells</span>.<a href="ILineOutput.cs.html#c7940c04c4b1ebce" class="i method">Length</a>(<span class="r62 r">lines</span>[<span class="r63 r">k</span>]) &lt;= <span class="r59 r">firstLineLen</span>)
                {
                    <span class="c">// we do not need to split further, just add</span>
                    <span class="r61 r">retVal</span>.<span class="i">Add</span>(<span class="r62 r">lines</span>[<span class="r63 r">k</span>]);
                    <b>continue</b>;
                }
 
                <b>int</b> <span id="r64 rd" class="r64 r">spacesLeft</span> = <span class="r59 r">firstLineLen</span>;
                <b>int</b> <span id="r65 rd" class="r65 r">lineWidth</span> = <span class="r59 r">firstLineLen</span>;
                <b>bool</b> <span id="r66 rd" class="r66 r">firstLine</span> = <b>true</b>;
                <span class="i">StringBuilder</span> <span id="r67 rd" class="r67 r">singleLine</span> = <b>new</b> <span class="i">StringBuilder</span>();
 
                <b>foreach</b> (<a href="#ddd8674c020d1c81" class="t t">GetWordsResult</a> <span id="r68 rd" class="r68 r">word</span> <b>in</b> <a href="#e5f3cf9aaa57a4a1" class="i method">GetWords</a>(<span class="r62 r">lines</span>[<span class="r63 r">k</span>]))
                {
                    <b>string</b> <span id="r69 rd" class="r69 r">wordToAdd</span> = <span class="r68 r">word</span>.<a href="#2d85e7a785a93a4f" class="i field">Word</a>;
 
                    <span class="c">// Handle soft hyphen</span>
                    <b>if</b> (<span class="r68 r">word</span>.<a href="#137ebdfe5a48ca2b" class="i field">Delim</a> == <a href="#48c006dca7b5ddde" class="i field">s_softHyphen</a>.<span class="i">ToString</span>())
                    {
                        <b>int</b> <span id="r70 rd" class="r70 r">wordWidthWithHyphen</span> = <span class="r57 r">displayCells</span>.<a href="ILineOutput.cs.html#c7940c04c4b1ebce" class="i method">Length</a>(<span class="r69 r">wordToAdd</span>) + <span class="r57 r">displayCells</span>.<span class="i">Length</span>(<a href="#48c006dca7b5ddde" class="i field">s_softHyphen</a>.<span class="i">ToString</span>());
 
                        <span class="c">// Add hyphen only if necessary</span>
                        <b>if</b> (<span class="r70 r">wordWidthWithHyphen</span> == <span class="r64 r">spacesLeft</span>)
                        {
                            <span class="r69 r">wordToAdd</span> += <span class="s">&quot;-&quot;</span>;
                        }
                    }
                    <b>else</b>
                    {
                        <b>if</b> (!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r68 r">word</span>.<a href="#137ebdfe5a48ca2b" class="i field">Delim</a>))
                        {
                            <span class="r69 r">wordToAdd</span> += <span class="r68 r">word</span>.<a href="#137ebdfe5a48ca2b" class="i field">Delim</a>;
                        }
                    }
 
                    <b>int</b> <span id="r71 rd" class="r71 r">wordWidth</span> = <span class="r57 r">displayCells</span>.<a href="ILineOutput.cs.html#c7940c04c4b1ebce" class="i method">Length</a>(<span class="r69 r">wordToAdd</span>);
 
                    <span class="c">// Handle zero width</span>
                    <b>if</b> (<span class="r65 r">lineWidth</span> == 0)
                    {
                        <b>if</b> (<span class="r66 r">firstLine</span>)
                        {
                            <span class="r66 r">firstLine</span> = <b>false</b>;
                            <span class="r65 r">lineWidth</span> = <span class="r60 r">followingLinesLen</span>;
                        }
 
                        <b>if</b> (<span class="r65 r">lineWidth</span> == 0)
                        {
                            <b>break</b>;
                        }
 
                        <span class="r64 r">spacesLeft</span> = <span class="r65 r">lineWidth</span>;
                    }
 
                    <span class="c">// Word is wider than a single line</span>
                    <b>if</b> (<span class="r71 r">wordWidth</span> &gt; <span class="r65 r">lineWidth</span>)
                    {
                        <b>foreach</b> (<b>char</b> <span id="r72 rd" class="r72 r">c</span> <b>in</b> <span class="r69 r">wordToAdd</span>)
                        {
                            <b>char</b> <span id="r73 rd" class="r73 r">charToAdd</span> = <span class="r72 r">c</span>;
                            <b>int</b> <span id="r74 rd" class="r74 r">charWidth</span> = <span class="r57 r">displayCells</span>.<a href="ILineOutput.cs.html#3a1b95d04bbe68e6" class="i method">Length</a>(<span class="r72 r">c</span>);
 
                            <span class="c">// corner case: we have a two cell character and the current</span>
                            <span class="c">// display length is one.</span>
                            <span class="c">// add a single cell arbitrary character instead of the original</span>
                            <span class="c">// one and keep going</span>
                            <b>if</b> (<span class="r74 r">charWidth</span> &gt; <span class="r65 r">lineWidth</span>)
                            {
                                <span class="r73 r">charToAdd</span> = <span class="s">&#39;?&#39;</span>;
                                <span class="r74 r">charWidth</span> = 1;
                            }
 
                            <b>if</b> (<span class="r74 r">charWidth</span> &gt; <span class="r64 r">spacesLeft</span>)
                            {
                                <span class="r61 r">retVal</span>.<span class="i">Add</span>(<span class="r67 r">singleLine</span>.<span class="i">ToString</span>());
                                <span class="r67 r">singleLine</span>.<span class="i">Clear</span>();
                                <span class="r67 r">singleLine</span>.<span class="i">Append</span>(<span class="r73 r">charToAdd</span>);
 
                                <b>if</b> (<span class="r66 r">firstLine</span>)
                                {
                                    <span class="r66 r">firstLine</span> = <b>false</b>;
                                    <span class="r65 r">lineWidth</span> = <span class="r60 r">followingLinesLen</span>;
                                }
 
                                <span class="r64 r">spacesLeft</span> = <span class="r65 r">lineWidth</span> - <span class="r74 r">charWidth</span>;
                            }
                            <b>else</b>
                            {
                                <span class="r67 r">singleLine</span>.<span class="i">Append</span>(<span class="r73 r">charToAdd</span>);
                                <span class="r64 r">spacesLeft</span> -= <span class="r74 r">charWidth</span>;
                            }
                        }
                    }
                    <b>else</b>
                    {
                        <b>if</b> (<span class="r71 r">wordWidth</span> &gt; <span class="r64 r">spacesLeft</span>)
                        {
                            <span class="r61 r">retVal</span>.<span class="i">Add</span>(<span class="r67 r">singleLine</span>.<span class="i">ToString</span>());
                            <span class="r67 r">singleLine</span>.<span class="i">Clear</span>();
                            <span class="r67 r">singleLine</span>.<span class="i">Append</span>(<span class="r69 r">wordToAdd</span>);
 
                            <b>if</b> (<span class="r66 r">firstLine</span>)
                            {
                                <span class="r66 r">firstLine</span> = <b>false</b>;
                                <span class="r65 r">lineWidth</span> = <span class="r60 r">followingLinesLen</span>;
                            }
 
                            <span class="r64 r">spacesLeft</span> = <span class="r65 r">lineWidth</span> - <span class="r71 r">wordWidth</span>;
                        }
                        <b>else</b>
                        {
                            <span class="r67 r">singleLine</span>.<span class="i">Append</span>(<span class="r69 r">wordToAdd</span>);
                            <span class="r64 r">spacesLeft</span> -= <span class="r71 r">wordWidth</span>;
                        }
                    }
                }
 
                <span class="r61 r">retVal</span>.<span class="i">Add</span>(<span class="r67 r">singleLine</span>.<span class="i">ToString</span>());
            }
 
            <b>return</b> <span class="r61 r">retVal</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Split a multiline string into an array of strings</span>
        <span class="c">///</span><span class="c"> by honoring both \n and \r\n.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r75 r">s</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">String to split.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">String array with the values.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal static string</b>[] <a id="d1560af19064ec89" href="../../R/d1560af19064ec89.html" target="n" data-glyph="74,1" class="i method">SplitLines</a>(<b>string</b> <span id="r75 rd" class="r75 r">s</span>)
        {
            <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r75 r">s</span>))
                <b>return</b> <b>new</b> <b>string</b>[1] { <span class="r75 r">s</span> };
 
            <span class="i">StringBuilder</span> <span id="r76 rd" class="r76 r">sb</span> = <b>new</b> <span class="i">StringBuilder</span>();
 
            <b>foreach</b> (<b>char</b> <span id="r77 rd" class="r77 r">c</span> <b>in</b> <span class="r75 r">s</span>)
            {
                <b>if</b> (<span class="r77 r">c</span> != <span class="s">&#39;\r&#39;</span>)
                    <span class="r76 r">sb</span>.<span class="i">Append</span>(<span class="r77 r">c</span>);
            }
 
            <b>return</b> <span class="r76 r">sb</span>.<span class="i">ToString</span>().<span class="i">Split</span>(<a href="#a6910a975bcfeaa2" class="i field">s_newLineChar</a>);
        }
 
<span class="k preprocess">#</span><span class="k preprocess">if</span> <b>false</b>
<span class="e">        internal static string StripNewLines (string s)
        {
            if (string.IsNullOrEmpty (s))
                return s;
 
            string[] lines = SplitLines (s);
 
            if (lines.Length == 0)
                return null;
 
            if (lines.Length == 1)
                return lines[0];
 
            StringBuilder sb = new StringBuilder ();
 
            for (int k = 0; k &lt; lines.Length; k++)
            {
                if (k == 0)
                    sb.Append (lines[k]);
                else
                    sb.Append (&quot; &quot; + lines[k]);
            }
 
            return sb.ToString ();
        }
</span><span class="k preprocess">#</span><span class="k preprocess">endif</span>
        <b>internal static string</b> <a id="bef24cc449cb3320" href="../../R/bef24cc449cb3320.html" target="n" data-glyph="74,1" class="i method">TruncateAtNewLine</a>(<b>string</b> <span id="r78 rd" class="r78 r">s</span>)
        {
            <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r78 r">s</span>))
            {
                <b>return</b> <b>string</b>.<span class="i">Empty</span>;
            }
 
            <b>int</b> <span id="r79 rd" class="r79 r">lineBreak</span> = <span class="r78 r">s</span>.<span class="i">IndexOfAny</span>(<a href="#0d6376e2f16c8637" class="i field">s_lineBreakChars</a>);
 
            <b>if</b> (<span class="r79 r">lineBreak</span> &lt; 0)
            {
                <b>return</b> <span class="r78 r">s</span>;
            }
 
            <b>return</b> <span class="r78 r">s</span>.<span class="i">Substring</span>(0, <span class="r79 r">lineBreak</span>) + <a href="Utilities/MshObjectUtil.cs.html#fa81a7bc4f9cb4f0" class="t t">PSObjectHelper</a>.<a href="Utilities/MshObjectUtil.cs.html#a5549bfa35c48a67" class="i field">Ellipsis</a>;
        }
 
        <b>internal static string</b> <a id="b30e2628f55d0b53" href="../../R/b30e2628f55d0b53.html" target="n" data-glyph="74,1" class="i method">PadLeft</a>(<b>string</b> <span id="r80 rd" class="r80 r">val</span>, <b>int</b> <span id="r81 rd" class="r81 r">count</span>)
        {
            <b>return</b> <a href="../../utils/StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<a href="../../utils/StringUtil.cs.html#946b4ff19a62bfcc" class="i method">Padding</a>(<span class="r81 r">count</span>) + <span class="r80 r">val</span>;
        }
 
        <b>private static readonly char</b>[] <a id="a6910a975bcfeaa2" href="../../R/a6910a975bcfeaa2.html" target="n" data-glyph="46,1" class="i field">s_newLineChar</a> = <b>new</b> <b>char</b>[] { <span class="s">&#39;\n&#39;</span> };
        <b>private static readonly char</b>[] <a id="0d6376e2f16c8637" href="../../R/0d6376e2f16c8637.html" target="n" data-glyph="46,1" class="i field">s_lineBreakChars</a> = <b>new</b> <b>char</b>[] { <span class="s">&#39;\n&#39;</span>, <span class="s">&#39;\r&#39;</span> };
    }
}
</pre></td></tr></table></div></body></html>
