<!DOCTYPE html>
<html><head><title>SecuritySupport.cs</title><link rel="stylesheet" href="../../styles.css"><script src="../../scripts.js"></script></head>
<body class="cB" onload="i(1644);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#System.Management.Automation/security/SecuritySupport.cs" target="_top">security\SecuritySupport.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#System.Management.Automation" target="_top">src\System.Management.Automation\System.Management.Automation.csproj</a> (System.Management.Automation)</td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation.</span>
<span class="c">// Licensed under the MIT License.</span>
 
<span class="k preprocess">#</span><span class="k preprocess">pragma</span> <span class="k preprocess">warning</span> <span class="k preprocess">disable</span> 1634, 1691
<span class="k preprocess">#</span><span class="k preprocess">pragma</span> <span class="k preprocess">warning</span> <span class="k preprocess">disable</span> 56523
 
<b>using</b> <span class="i n">System</span>.<span class="i">Collections</span>.<span class="i">Generic</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Collections</span>.<span class="i">ObjectModel</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Diagnostics</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Diagnostics</span>.<span class="i">CodeAnalysis</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">IO</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Globalization</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Configuration</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Internal</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Security</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Runtime</span>.<span class="i">InteropServices</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Security</span>.<span class="i">Cryptography</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Security</span>.<span class="i">Cryptography</span>.<span class="i">X509Certificates</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Text</span>;
 
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">PowerShell</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">PowerShell</span>.<span class="i n">Commands</span>;
 
<b>using</b> <span class="i">DWORD</span> = <span class="i n">System</span>.<span class="i">UInt32</span>;
 
<b>namespace</b> <span class="i n">Microsoft</span>.<span class="i n">PowerShell</span>
{
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Defines the different Execution Policies supported by the</span>
    <span class="c">///</span><span class="c"> PSAuthorizationManager class.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>public enum</b> <a id="73c2048fc177fabf" href="../R/73c2048fc177fabf.html" target="n" data-glyph="18,0" class="t t"><span id="6a43ef75b7e00674">ExecutionPolicy</span></a>
    {
        <span class="c">///</span><span class="c"> Unrestricted - No files must be signed.  If a file originates from the</span>
        <span class="c">///</span><span class="c">    internet, Monad provides a warning prompt to alert the user.  To</span>
        <span class="c">///</span><span class="c">    suppress this warning message, right-click on the file in File Explorer,</span>
        <span class="c">///</span><span class="c">    select &quot;Properties,&quot; and then &quot;Unblock.&quot;</span>
        <a id="220fd609c31e55e1" href="../R/220fd609c31e55e1.html" target="n" data-glyph="24,1" class="i field">Unrestricted</a> = 0,
 
        <span class="c">///</span><span class="c"> RemoteSigned - Only .msh and .mshxml files originating from the internet</span>
        <span class="c">///</span><span class="c">    must be digitally signed.  If remote, signed, and executed, Monad</span>
        <span class="c">///</span><span class="c">    prompts to determine if files from the signing publisher should be</span>
        <span class="c">///</span><span class="c">    run or not.  This is the default setting.</span>
        <a id="32725e91e6ec08e2" href="../R/32725e91e6ec08e2.html" target="n" data-glyph="24,1" class="i field">RemoteSigned</a> = 1,
 
        <span class="c">///</span><span class="c"> AllSigned - All .msh and .mshxml files must be digitally signed.  If</span>
        <span class="c">///</span><span class="c">    signed and executed, Monad prompts to determine if files from the</span>
        <span class="c">///</span><span class="c">    signing publisher should be run or not.</span>
        <a id="db1b3edc38853c2e" href="../R/db1b3edc38853c2e.html" target="n" data-glyph="24,1" class="i field">AllSigned</a> = 2,
 
        <span class="c">///</span><span class="c"> Restricted - All .msh files are blocked.  Mshxml files must be digitally</span>
        <span class="c">///</span><span class="c">    signed, and by a trusted publisher.  If you haven&#39;t made a trust decision</span>
        <span class="c">///</span><span class="c">    on the publisher yet, prompting is done as in AllSigned mode.</span>
        <a id="650065d32fb5aa16" href="../R/650065d32fb5aa16.html" target="n" data-glyph="24,1" class="i field">Restricted</a> = 3,
 
        <span class="c">///</span><span class="c"> Bypass - No files must be signed, and internet origin is not verified</span>
        <a id="ee4d51bbeed2574c" href="../R/ee4d51bbeed2574c.html" target="n" data-glyph="24,1" class="i field">Bypass</a> = 4,
 
        <span class="c">///</span><span class="c"> Undefined - Not specified at this scope</span>
        <a id="79672d3793dffebb" href="../R/79672d3793dffebb.html" target="n" data-glyph="24,1" class="i field">Undefined</a> = 5,
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Default - The most restrictive policy available.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <a id="c8b152ee17192868" href="../R/c8b152ee17192868.html" target="n" data-glyph="24,1" class="i field">Default</a> = <a href="#650065d32fb5aa16" class="i field">Restricted</a>
    }
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Defines the available configuration scopes for an execution</span>
    <span class="c">///</span><span class="c"> policy. They are in the following priority, with successive</span>
    <span class="c">///</span><span class="c"> elements overriding the items that precede them:</span>
    <span class="c">///</span><span class="c"> LocalMachine -&gt; CurrentUser -&gt; Runspace.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>public enum</b> <a id="a2a8c6696f673043" href="../R/a2a8c6696f673043.html" target="n" data-glyph="18,0" class="t t"><span id="558aac28056e8f79">ExecutionPolicyScope</span></a>
    {
        <span class="c">///</span><span class="c"> Execution policy is retrieved from the</span>
        <span class="c">///</span><span class="c"> PSExecutionPolicyPreference environment variable.</span>
        <a id="0b046bc9f6673ceb" href="../R/0b046bc9f6673ceb.html" target="n" data-glyph="24,1" class="i field">Process</a> = 0,
 
        <span class="c">///</span><span class="c"> Execution policy is retrieved from the HKEY_CURRENT_USER</span>
        <span class="c">///</span><span class="c"> registry hive for the current ShellId.</span>
        <a id="18a01c1cf7c5b914" href="../R/18a01c1cf7c5b914.html" target="n" data-glyph="24,1" class="i field">CurrentUser</a> = 1,
 
        <span class="c">///</span><span class="c"> Execution policy is retrieved from the HKEY_LOCAL_MACHINE</span>
        <span class="c">///</span><span class="c"> registry hive for the current ShellId.</span>
        <a id="9970b159c76dcaaf" href="../R/9970b159c76dcaaf.html" target="n" data-glyph="24,1" class="i field">LocalMachine</a> = 2,
 
        <span class="c">///</span><span class="c"> Execution policy is retrieved from the current user&#39;s</span>
        <span class="c">///</span><span class="c"> group policy setting.</span>
        <a id="932b1fdd2ce7fa88" href="../R/932b1fdd2ce7fa88.html" target="n" data-glyph="24,1" class="i field">UserPolicy</a> = 3,
 
        <span class="c">///</span><span class="c"> Execution policy is retrieved from the machine-wide</span>
        <span class="c">///</span><span class="c"> group policy setting.</span>
        <a id="36c000a7fdcc73a7" href="../R/36c000a7fdcc73a7.html" target="n" data-glyph="24,1" class="i field">MachinePolicy</a> = 4
    }
}
 
<b>namespace</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Internal</span>
{
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> The SAFER policy associated with this file.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>internal enum</b> <a id="58419a9424af463c" href="../R/58419a9424af463c.html" target="n" data-glyph="20,0" class="t t"><span id="562e4db4a75f6897">SaferPolicy</span></a>
    {
        <span class="c">///</span><span class="c"> Explicitly allowed through an Allow rule</span>
        <a id="c93207d55ca6f91e" href="../R/../../0000000000.html" target="n" data-glyph="24,1" class="i field">ExplicitlyAllowed</a> = 0,
 
        <span class="c">///</span><span class="c"> Allowed because it has not been explicitly disallowed</span>
        <a id="4c7bf0528b9fad3e" href="../R/4c7bf0528b9fad3e.html" target="n" data-glyph="24,1" class="i field">Allowed</a> = 1,
 
        <span class="c">///</span><span class="c"> Disallowed by a rule or policy.</span>
        <a id="4b51340b630e2fd5" href="../R/4b51340b630e2fd5.html" target="n" data-glyph="24,1" class="i field">Disallowed</a> = 2
    }
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Security Support APIs.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>public static class</b> <a id="5c234bd2337db61c" href="../R/5c234bd2337db61c.html" target="n" data-glyph="0,0" class="t t">SecuritySupport</a>
    {
        <span class="k preprocess">#</span><span class="k preprocess">region</span> execution policy
 
        <b>internal static</b> <a href="#a2a8c6696f673043" class="t t">ExecutionPolicyScope</a>[] <a id="06583da092cef325" href="../R/06583da092cef325.html" target="n" data-glyph="104,1" class="i property">ExecutionPolicyScopePreferences</a>
        {
            <b>get</b>
            {
                <b>return</b> <b>new</b> <a href="#a2a8c6696f673043" class="t t">ExecutionPolicyScope</a>[] {
                        <a href="#a2a8c6696f673043" class="t t">ExecutionPolicyScope</a>.<a href="#36c000a7fdcc73a7" class="i field">MachinePolicy</a>,
                        <a href="#a2a8c6696f673043" class="t t">ExecutionPolicyScope</a>.<a href="#932b1fdd2ce7fa88" class="i field">UserPolicy</a>,
                        <a href="#a2a8c6696f673043" class="t t">ExecutionPolicyScope</a>.<a href="#0b046bc9f6673ceb" class="i field">Process</a>,
                        <a href="#a2a8c6696f673043" class="t t">ExecutionPolicyScope</a>.<a href="#18a01c1cf7c5b914" class="i field">CurrentUser</a>,
                        <a href="#a2a8c6696f673043" class="t t">ExecutionPolicyScope</a>.<a href="#9970b159c76dcaaf" class="i field">LocalMachine</a>
                    };
            }
        }
 
        <b>internal static void</b> <a id="520b7f8d921f5404" href="../R/520b7f8d921f5404.html" target="n" data-glyph="74,1" class="i method">SetExecutionPolicy</a>(<a href="#a2a8c6696f673043" class="t t">ExecutionPolicyScope</a> <span id="r0 rd" class="r0 r">scope</span>, <a href="#73c2048fc177fabf" class="t t">ExecutionPolicy</a> <span id="r1 rd" class="r1 r">policy</span>, <b>string</b> <span id="r2 rd" class="r2 r">shellId</span>)
        {
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">UNIX</span>
<span class="e">            throw new PlatformNotSupportedException();
</span><span class="k preprocess">#</span><span class="k preprocess">else</span>
            <b>string</b> <span id="r3 rd" class="r3 r">executionPolicy</span> = <span class="s">&quot;Restricted&quot;</span>;
 
            <b>switch</b> (<span class="r1 r">policy</span>)
            {
                <b>case</b> <a href="#73c2048fc177fabf" class="t t">ExecutionPolicy</a>.<a href="#650065d32fb5aa16" class="i field">Restricted</a>:
                    <span class="r3 r">executionPolicy</span> = <span class="s">&quot;Restricted&quot;</span>;
                    <b>break</b>;
                <b>case</b> <a href="#73c2048fc177fabf" class="t t">ExecutionPolicy</a>.<a href="#db1b3edc38853c2e" class="i field">AllSigned</a>:
                    <span class="r3 r">executionPolicy</span> = <span class="s">&quot;AllSigned&quot;</span>;
                    <b>break</b>;
                <b>case</b> <a href="#73c2048fc177fabf" class="t t">ExecutionPolicy</a>.<a href="#32725e91e6ec08e2" class="i field">RemoteSigned</a>:
                    <span class="r3 r">executionPolicy</span> = <span class="s">&quot;RemoteSigned&quot;</span>;
                    <b>break</b>;
                <b>case</b> <a href="#73c2048fc177fabf" class="t t">ExecutionPolicy</a>.<a href="#220fd609c31e55e1" class="i field">Unrestricted</a>:
                    <span class="r3 r">executionPolicy</span> = <span class="s">&quot;Unrestricted&quot;</span>;
                    <b>break</b>;
                <b>case</b> <a href="#73c2048fc177fabf" class="t t">ExecutionPolicy</a>.<a href="#ee4d51bbeed2574c" class="i field">Bypass</a>:
                    <span class="r3 r">executionPolicy</span> = <span class="s">&quot;Bypass&quot;</span>;
                    <b>break</b>;
            }
 
            <span class="c">// Set the execution policy</span>
            <b>switch</b> (<span class="r0 r">scope</span>)
            {
                <b>case</b> <a href="#a2a8c6696f673043" class="t t">ExecutionPolicyScope</a>.<a href="#0b046bc9f6673ceb" class="i field">Process</a>:
 
                    <b>if</b> (<span class="r1 r">policy</span> == <a href="#73c2048fc177fabf" class="t t">ExecutionPolicy</a>.<a href="#79672d3793dffebb" class="i field">Undefined</a>)
                        <span class="r3 r">executionPolicy</span> = <b>null</b>;
 
                    <span class="i">Environment</span>.<span class="i">SetEnvironmentVariable</span>(<span class="s">&quot;PSExecutionPolicyPreference&quot;</span>, <span class="r3 r">executionPolicy</span>);
                    <b>break</b>;
 
                <b>case</b> <a href="#a2a8c6696f673043" class="t t">ExecutionPolicyScope</a>.<a href="#18a01c1cf7c5b914" class="i field">CurrentUser</a>:
 
                    <span class="c">// They want to remove it</span>
                    <b>if</b> (<span class="r1 r">policy</span> == <a href="#73c2048fc177fabf" class="t t">ExecutionPolicy</a>.<a href="#79672d3793dffebb" class="i field">Undefined</a>)
                    {
                        <a href="../engine/PSConfiguration.cs.html#9641e95401c2a85d" class="t t">PowerShellConfig</a>.<a href="../engine/PSConfiguration.cs.html#e4c913e160567f04" class="i field">Instance</a>.<a href="../engine/PSConfiguration.cs.html#9cc894ab9201f241" class="i method">RemoveExecutionPolicy</a>(<a href="../engine/PSConfiguration.cs.html#377f34beb5e362cf" class="t t">ConfigScope</a>.<a href="../engine/PSConfiguration.cs.html#2486a7ab834532b3" class="i field">CurrentUser</a>, <span class="r2 r">shellId</span>);
                    }
                    <b>else</b>
                    {
                        <a href="../engine/PSConfiguration.cs.html#9641e95401c2a85d" class="t t">PowerShellConfig</a>.<a href="../engine/PSConfiguration.cs.html#e4c913e160567f04" class="i field">Instance</a>.<a href="../engine/PSConfiguration.cs.html#a4e9ab2f59a5e27f" class="i method">SetExecutionPolicy</a>(<a href="../engine/PSConfiguration.cs.html#377f34beb5e362cf" class="t t">ConfigScope</a>.<a href="../engine/PSConfiguration.cs.html#2486a7ab834532b3" class="i field">CurrentUser</a>, <span class="r2 r">shellId</span>, <span class="r3 r">executionPolicy</span>);
                    }
 
                    <b>break</b>;
 
                <b>case</b> <a href="#a2a8c6696f673043" class="t t">ExecutionPolicyScope</a>.<a href="#9970b159c76dcaaf" class="i field">LocalMachine</a>:
 
                    <span class="c">// They want to remove it</span>
                    <b>if</b> (<span class="r1 r">policy</span> == <a href="#73c2048fc177fabf" class="t t">ExecutionPolicy</a>.<a href="#79672d3793dffebb" class="i field">Undefined</a>)
                    {
                        <a href="../engine/PSConfiguration.cs.html#9641e95401c2a85d" class="t t">PowerShellConfig</a>.<a href="../engine/PSConfiguration.cs.html#e4c913e160567f04" class="i field">Instance</a>.<a href="../engine/PSConfiguration.cs.html#9cc894ab9201f241" class="i method">RemoveExecutionPolicy</a>(<a href="../engine/PSConfiguration.cs.html#377f34beb5e362cf" class="t t">ConfigScope</a>.<a href="../engine/PSConfiguration.cs.html#378339620026a80d" class="i field">AllUsers</a>, <span class="r2 r">shellId</span>);
                    }
                    <b>else</b>
                    {
                        <a href="../engine/PSConfiguration.cs.html#9641e95401c2a85d" class="t t">PowerShellConfig</a>.<a href="../engine/PSConfiguration.cs.html#e4c913e160567f04" class="i field">Instance</a>.<a href="../engine/PSConfiguration.cs.html#a4e9ab2f59a5e27f" class="i method">SetExecutionPolicy</a>(<a href="../engine/PSConfiguration.cs.html#377f34beb5e362cf" class="t t">ConfigScope</a>.<a href="../engine/PSConfiguration.cs.html#378339620026a80d" class="i field">AllUsers</a>, <span class="r2 r">shellId</span>, <span class="r3 r">executionPolicy</span>);
                    }
 
                    <b>break</b>;
            }
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
        }
 
        <b>internal static</b> <a href="#73c2048fc177fabf" class="t t">ExecutionPolicy</a> <a id="a59f2b02414af627" href="../R/a59f2b02414af627.html" target="n" data-glyph="74,1" class="i method">GetExecutionPolicy</a>(<b>string</b> <span id="r4 rd" class="r4 r">shellId</span>)
        {
            <b>foreach</b> (<a href="#a2a8c6696f673043" class="t t">ExecutionPolicyScope</a> <span id="r5 rd" class="r5 r">scope</span> <b>in</b> <a href="#06583da092cef325" class="i property">ExecutionPolicyScopePreferences</a>)
            {
                <a href="#73c2048fc177fabf" class="t t">ExecutionPolicy</a> <span id="r6 rd" class="r6 r">policy</span> = <a href="#31588654c4c642dd" class="i method">GetExecutionPolicy</a>(<span class="r4 r">shellId</span>, <span class="r5 r">scope</span>);
                <b>if</b> (<span class="r6 r">policy</span> != <a href="#73c2048fc177fabf" class="t t">ExecutionPolicy</a>.<a href="#79672d3793dffebb" class="i field">Undefined</a>)
                    <b>return</b> <span class="r6 r">policy</span>;
            }
 
            <b>return</b> <a href="#73c2048fc177fabf" class="t t">ExecutionPolicy</a>.<a href="#650065d32fb5aa16" class="i field">Restricted</a>;
        }
 
        <b>private static bool</b>? <a id="039dc81ae94578c7" href="../R/039dc81ae94578c7.html" target="n" data-glyph="46,1" class="i field">_hasGpScriptParent</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> A value indicating that the current process was launched by GPScript.exe</span>
        <span class="c">///</span><span class="c"> Used to determine execution policy when group policies are in effect.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This is somewhat expensive to determine and does not change within the lifetime of the current process</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>private static bool</b> <a id="7ac4ac3285f045a3" href="../R/7ac4ac3285f045a3.html" target="n" data-glyph="106,1" class="i property">HasGpScriptParent</a>
        {
            <b>get</b>
            {
                <b>if</b> (!<a href="#039dc81ae94578c7" class="i field">_hasGpScriptParent</a>.<span class="i">HasValue</span>)
                {
                    <a href="#039dc81ae94578c7" class="i field">_hasGpScriptParent</a> = <a href="#659e2dc6a27a7ece" class="i method">IsCurrentProcessLaunchedByGpScript</a>();
                }
 
                <b>return</b> <a href="#039dc81ae94578c7" class="i field">_hasGpScriptParent</a>.<span class="i">Value</span>;
            }
        }
 
        <b>private static bool</b> <a id="659e2dc6a27a7ece" href="../R/659e2dc6a27a7ece.html" target="n" data-glyph="76,1" class="i method">IsCurrentProcessLaunchedByGpScript</a>()
        {
            <span class="i">Process</span> <span id="r7 rd" class="r7 r">currentProcess</span> = <span class="i">Process</span>.<span class="i">GetCurrentProcess</span>();
            <b>string</b> <span id="r8 rd" class="r8 r">gpScriptPath</span> = <span class="i">IO</span>.<span class="i">Path</span>.<span class="i">Combine</span>(
                <span class="i">Environment</span>.<span class="i">GetFolderPath</span>(<span class="i">Environment</span>.<span class="i">SpecialFolder</span>.<span class="i">System</span>),
                <span class="s">&quot;gpscript.exe&quot;</span>);
 
            <b>bool</b> <span id="r9 rd" class="r9 r">foundGpScriptParent</span> = <b>false</b>;
            <b>try</b>
            {
                <b>while</b> (<span class="r7 r">currentProcess</span> != <b>null</b>)
                {
                    <b>if</b> (<b>string</b>.<span class="i">Equals</span>(<span class="r8 r">gpScriptPath</span>,
                            <span class="r7 r">currentProcess</span>.<span class="i">MainModule</span>.<span class="i">FileName</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
                    {
                        <span class="r9 r">foundGpScriptParent</span> = <b>true</b>;
                        <b>break</b>;
                    }
                    <b>else</b>
                    {
                        <span class="r7 r">currentProcess</span> = <a href="../utils/PsUtils.cs.html#2010e19f156f8c91" class="t t">PsUtils</a>.<a href="../utils/PsUtils.cs.html#052a0531c6c08051" class="i method">GetParentProcess</a>(<span class="r7 r">currentProcess</span>);
                    }
                }
            }
            <b>catch</b> (<span class="i n">System</span>.<span class="i">ComponentModel</span>.<span class="i">Win32Exception</span>)
            {
                <span class="c">// If you attempt to retrieve the MainModule of a 64-bit process</span>
                <span class="c">// from a WOW64 (32-bit) process, the Win32 API has a fatal</span>
                <span class="c">// flaw that causes this to return the error:</span>
                <span class="c">//   &quot;Only part of a ReadProcessMemory or WriteProcessMemory</span>
                <span class="c">//   request was completed.&quot;</span>
                <span class="c">// In this case, we just catch the exception and eat it.</span>
                <span class="c">// The implication is that logon / logoff scripts that somehow</span>
                <span class="c">// launch the Wow64 version of PowerShell will be subject</span>
                <span class="c">// to the execution policy deployed by Group Policy (where</span>
                <span class="c">// our goal here is to not have the Group Policy execution policy</span>
                <span class="c">// affect logon / logoff scripts.</span>
            }
 
            <b>return</b> <span class="r9 r">foundGpScriptParent</span>;
        }
 
        <b>internal static</b> <a href="#73c2048fc177fabf" class="t t">ExecutionPolicy</a> <a id="31588654c4c642dd" href="../R/31588654c4c642dd.html" target="n" data-glyph="74,1" class="i method">GetExecutionPolicy</a>(<b>string</b> <span id="r10 rd" class="r10 r">shellId</span>, <a href="#a2a8c6696f673043" class="t t">ExecutionPolicyScope</a> <span id="r11 rd" class="r11 r">scope</span>)
        {
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">UNIX</span>
<span class="e">            return ExecutionPolicy.Unrestricted;
</span><span class="k preprocess">#</span><span class="k preprocess">else</span>
            <b>switch</b> (<span class="r11 r">scope</span>)
            {
                <b>case</b> <a href="#a2a8c6696f673043" class="t t">ExecutionPolicyScope</a>.<a href="#0b046bc9f6673ceb" class="i field">Process</a>:
                    {
                        <b>string</b> <span id="r12 rd" class="r12 r">policy</span> = <span class="i">Environment</span>.<span class="i">GetEnvironmentVariable</span>(<span class="s">&quot;PSExecutionPolicyPreference&quot;</span>);
 
                        <b>if</b> (!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r12 r">policy</span>))
                            <b>return</b> <a href="#f925e17549080dc1" class="i method">ParseExecutionPolicy</a>(<span class="r12 r">policy</span>);
                        <b>else</b>
                            <b>return</b> <a href="#73c2048fc177fabf" class="t t">ExecutionPolicy</a>.<a href="#79672d3793dffebb" class="i field">Undefined</a>;
                    }
 
                <b>case</b> <a href="#a2a8c6696f673043" class="t t">ExecutionPolicyScope</a>.<a href="#18a01c1cf7c5b914" class="i field">CurrentUser</a>:
                <b>case</b> <a href="#a2a8c6696f673043" class="t t">ExecutionPolicyScope</a>.<a href="#9970b159c76dcaaf" class="i field">LocalMachine</a>:
                    {
                        <b>string</b> <span id="r13 rd" class="r13 r">policy</span> = <a href="#304d4bf64c513f32" class="i method">GetLocalPreferenceValue</a>(<span class="r10 r">shellId</span>, <span class="r11 r">scope</span>);
 
                        <b>if</b> (!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r13 r">policy</span>))
                            <b>return</b> <a href="#f925e17549080dc1" class="i method">ParseExecutionPolicy</a>(<span class="r13 r">policy</span>);
                        <b>else</b>
                            <b>return</b> <a href="#73c2048fc177fabf" class="t t">ExecutionPolicy</a>.<a href="#79672d3793dffebb" class="i field">Undefined</a>;
                    }
 
                <span class="c">// TODO: Group Policy is only supported on Full systems, but !LINUX &amp;&amp; CORECLR</span>
                <span class="c">// will run there as well, so I don&#39;t think we should remove it.</span>
                <b>case</b> <a href="#a2a8c6696f673043" class="t t">ExecutionPolicyScope</a>.<a href="#932b1fdd2ce7fa88" class="i field">UserPolicy</a>:
                <b>case</b> <a href="#a2a8c6696f673043" class="t t">ExecutionPolicyScope</a>.<a href="#36c000a7fdcc73a7" class="i field">MachinePolicy</a>:
                    {
                        <b>string</b> <span id="r14 rd" class="r14 r">groupPolicyPreference</span> = <a href="#71cf715e0ca3d652" class="i method">GetGroupPolicyValue</a>(<span class="r10 r">shellId</span>, <span class="r11 r">scope</span>);
 
                        <span class="c">// Be sure we aren&#39;t being called by Group Policy</span>
                        <span class="c">// itself. A group policy should never block a logon /</span>
                        <span class="c">// logoff script.</span>
                        <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r14 r">groupPolicyPreference</span>) || <a href="#7ac4ac3285f045a3" class="i property">HasGpScriptParent</a>)
                        {
                            <b>return</b> <a href="#73c2048fc177fabf" class="t t">ExecutionPolicy</a>.<a href="#79672d3793dffebb" class="i field">Undefined</a>;
                        }
 
                        <b>return</b> <a href="#f925e17549080dc1" class="i method">ParseExecutionPolicy</a>(<span class="r14 r">groupPolicyPreference</span>);
                    }
            }
 
            <b>return</b> <a href="#73c2048fc177fabf" class="t t">ExecutionPolicy</a>.<a href="#650065d32fb5aa16" class="i field">Restricted</a>;
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
        }
 
        <b>internal static</b> <a href="#73c2048fc177fabf" class="t t">ExecutionPolicy</a> <a id="f925e17549080dc1" href="../R/f925e17549080dc1.html" target="n" data-glyph="74,1" class="i method">ParseExecutionPolicy</a>(<b>string</b> <span id="r15 rd" class="r15 r">policy</span>)
        {
            <b>if</b> (<b>string</b>.<span class="i">Equals</span>(<span class="r15 r">policy</span>, <span class="s">&quot;Bypass&quot;</span>,
                                   <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
            {
                <b>return</b> <a href="#73c2048fc177fabf" class="t t">ExecutionPolicy</a>.<a href="#ee4d51bbeed2574c" class="i field">Bypass</a>;
            }
            <b>else</b> <b>if</b> (<b>string</b>.<span class="i">Equals</span>(<span class="r15 r">policy</span>, <span class="s">&quot;Unrestricted&quot;</span>,
                                   <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
            {
                <b>return</b> <a href="#73c2048fc177fabf" class="t t">ExecutionPolicy</a>.<a href="#220fd609c31e55e1" class="i field">Unrestricted</a>;
            }
            <b>else</b> <b>if</b> (<b>string</b>.<span class="i">Equals</span>(<span class="r15 r">policy</span>, <span class="s">&quot;RemoteSigned&quot;</span>,
                                   <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
            {
                <b>return</b> <a href="#73c2048fc177fabf" class="t t">ExecutionPolicy</a>.<a href="#32725e91e6ec08e2" class="i field">RemoteSigned</a>;
            }
            <b>else</b> <b>if</b> (<b>string</b>.<span class="i">Equals</span>(<span class="r15 r">policy</span>, <span class="s">&quot;AllSigned&quot;</span>,
                              <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
            {
                <b>return</b> <a href="#73c2048fc177fabf" class="t t">ExecutionPolicy</a>.<a href="#db1b3edc38853c2e" class="i field">AllSigned</a>;
            }
            <b>else</b> <b>if</b> (<b>string</b>.<span class="i">Equals</span>(<span class="r15 r">policy</span>, <span class="s">&quot;Restricted&quot;</span>,
                         <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
            {
                <b>return</b> <a href="#73c2048fc177fabf" class="t t">ExecutionPolicy</a>.<a href="#650065d32fb5aa16" class="i field">Restricted</a>;
            }
            <b>else</b>
            {
                <b>return</b> <a href="#73c2048fc177fabf" class="t t">ExecutionPolicy</a>.<a href="#c8b152ee17192868" class="i field">Default</a>;
            }
        }
 
        <b>internal static string</b> <a id="7ae88114793549f9" href="../R/../../0000000000.html" target="n" data-glyph="74,1" class="i method">GetExecutionPolicy</a>(<a href="#73c2048fc177fabf" class="t t">ExecutionPolicy</a> <span id="r16 rd" class="r16 r">policy</span>)
        {
            <b>switch</b> (<span class="r16 r">policy</span>)
            {
                <b>case</b> <a href="#73c2048fc177fabf" class="t t">ExecutionPolicy</a>.<a href="#ee4d51bbeed2574c" class="i field">Bypass</a>:
                    <b>return</b> <span class="s">&quot;Bypass&quot;</span>;
                <b>case</b> <a href="#73c2048fc177fabf" class="t t">ExecutionPolicy</a>.<a href="#220fd609c31e55e1" class="i field">Unrestricted</a>:
                    <b>return</b> <span class="s">&quot;Unrestricted&quot;</span>;
                <b>case</b> <a href="#73c2048fc177fabf" class="t t">ExecutionPolicy</a>.<a href="#32725e91e6ec08e2" class="i field">RemoteSigned</a>:
                    <b>return</b> <span class="s">&quot;RemoteSigned&quot;</span>;
                <b>case</b> <a href="#73c2048fc177fabf" class="t t">ExecutionPolicy</a>.<a href="#db1b3edc38853c2e" class="i field">AllSigned</a>:
                    <b>return</b> <span class="s">&quot;AllSigned&quot;</span>;
                <b>case</b> <a href="#73c2048fc177fabf" class="t t">ExecutionPolicy</a>.<a href="#650065d32fb5aa16" class="i field">Restricted</a>:
                    <b>return</b> <span class="s">&quot;Restricted&quot;</span>;
                <b>default</b>:
                    <b>return</b> <span class="s">&quot;Restricted&quot;</span>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Returns true if file has product binary signature.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r17 r">file</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Name of file to check.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">True when file has product binary signature.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>public static bool</b> <a id="ce590ce9a9baa6b9" href="../R/ce590ce9a9baa6b9.html" target="n" data-glyph="72,1" class="i method">IsProductBinary</a>(<b>string</b> <span id="r17 rd" class="r17 r">file</span>)
        {
            <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r17 r">file</span>) || (!<span class="i">IO</span>.<span class="i">File</span>.<span class="i">Exists</span>(<span class="r17 r">file</span>)))
            {
                <b>return</b> <b>false</b>;
            }
 
            <span class="c">// Check if it is in the product folder, if not, skip checking the catalog</span>
            <span class="c">// and any other checks.</span>
            <b>var</b> <span id="r18 rd" class="r18 r">isUnderProductFolder</span> = <a href="../engine/Utils.cs.html#9185d6ecbaebbec0" class="t t">Utils</a>.<a href="../engine/Utils.cs.html#5824ed94fc599925" class="i method">IsUnderProductFolder</a>(<span class="r17 r">file</span>);
            <b>if</b> (!<span class="r18 r">isUnderProductFolder</span>)
            {
                <b>return</b> <b>false</b>;
            }
 
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">UNIX</span>
<span class="e">            // There is no signature support on non-Windows platforms (yet), when
            // execution reaches here, we are sure the file is under product folder
            return true;
</span><span class="k preprocess">#</span><span class="k preprocess">else</span>
            <span class="c">// Check the file signature</span>
            <a href="MshSignature.cs.html#83295f4a53c4ebb2" class="t t">Signature</a> <span id="r19 rd" class="r19 r">fileSignature</span> = <a href="Authenticode.cs.html#e9b013f194b66642" class="t t">SignatureHelper</a>.<a href="Authenticode.cs.html#9df06fe5ff05b73c" class="i method">GetSignature</a>(<span class="r17 r">file</span>, <b>null</b>);
            <b>if</b> ((<span class="r19 r">fileSignature</span> != <b>null</b>) &amp;&amp; (<span class="r19 r">fileSignature</span>.<a href="MshSignature.cs.html#ab40c4458e79bb02" class="i property">IsOSBinary</a>))
            {
                <b>return</b> <b>true</b>;
            }
 
            <span class="c">// WTGetSignatureInfo is used to verify catalog signature.</span>
            <span class="c">// On Win7, catalog API is not available.</span>
            <span class="c">// On OneCore SKUs like NanoServer/IoT, the API has a bug that makes it not able to find the</span>
            <span class="c">// corresponding catalog file for a given product file, so it doesn&#39;t work properly.</span>
            <span class="c">// In these cases, we just trust the &#39;isUnderProductFolder&#39; check.</span>
            <b>if</b> (<a href="MshSignature.cs.html#83295f4a53c4ebb2" class="t t">Signature</a>.<a href="MshSignature.cs.html#c4ff991e33688e1c" class="i field">CatalogApiAvailable</a>.<span class="i">HasValue</span> &amp;&amp; !<a href="MshSignature.cs.html#83295f4a53c4ebb2" class="t t">Signature</a>.<a href="MshSignature.cs.html#c4ff991e33688e1c" class="i field">CatalogApiAvailable</a>.<span class="i">Value</span>)
            {
                <span class="c">// When execution reaches here, we are sure the file is under product folder</span>
                <b>return</b> <b>true</b>;
            }
 
            <b>return</b> <b>false</b>;
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Returns the value of the Execution Policy as retrieved</span>
        <span class="c">///</span><span class="c"> from group policy.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">NULL if it is not defined at this level.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>private static string</b> <a id="71cf715e0ca3d652" href="../R/71cf715e0ca3d652.html" target="n" data-glyph="76,1" class="i method">GetGroupPolicyValue</a>(<b>string</b> <span id="r20 rd" class="r20 r">shellId</span>, <a href="#a2a8c6696f673043" class="t t">ExecutionPolicyScope</a> <span id="r21 rd" class="r21 r">scope</span>)
        {
            <a href="../engine/PSConfiguration.cs.html#377f34beb5e362cf" class="t t">ConfigScope</a>[] <span id="r22 rd" class="r22 r">scopeKey</span> = <b>null</b>;
 
            <b>switch</b> (<span class="r21 r">scope</span>)
            {
                <b>case</b> <a href="#a2a8c6696f673043" class="t t">ExecutionPolicyScope</a>.<a href="#36c000a7fdcc73a7" class="i field">MachinePolicy</a>:
                    <span class="r22 r">scopeKey</span> = <a href="../engine/Utils.cs.html#9185d6ecbaebbec0" class="t t">Utils</a>.<a href="../engine/Utils.cs.html#56b94f3ef7006dfe" class="i field">SystemWideOnlyConfig</a>;
                    <b>break</b>;
 
                <b>case</b> <a href="#a2a8c6696f673043" class="t t">ExecutionPolicyScope</a>.<a href="#932b1fdd2ce7fa88" class="i field">UserPolicy</a>:
                    <span class="r22 r">scopeKey</span> = <a href="../engine/Utils.cs.html#9185d6ecbaebbec0" class="t t">Utils</a>.<a href="../engine/Utils.cs.html#97ee8220b56a1889" class="i field">CurrentUserOnlyConfig</a>;
                    <b>break</b>;
            }
 
            <a href="../engine/PSConfiguration.cs.html#e6a5eb5440f63458" class="k">var</a> <span id="r23 rd" class="r23 r">scriptExecutionSetting</span> = <a href="../engine/Utils.cs.html#9185d6ecbaebbec0" class="t t">Utils</a>.<a href="../engine/Utils.cs.html#fb031837cf810b13" class="i method">GetPolicySetting</a>&lt;<a href="../engine/PSConfiguration.cs.html#e6a5eb5440f63458" class="t t">ScriptExecution</a>&gt;(<span class="r22 r">scopeKey</span>);
            <b>if</b> (<span class="r23 r">scriptExecutionSetting</span> != <b>null</b>)
            {
                <b>if</b> (<span class="r23 r">scriptExecutionSetting</span>.<a href="../engine/PSConfiguration.cs.html#ca722736c69691a0" class="i property">EnableScripts</a> == <b>false</b>)
                {
                    <span class="c">// Script execution is explicitly disabled</span>
                    <b>return</b> <span class="s">&quot;Restricted&quot;</span>;
                }
                <b>else</b> <b>if</b> (<span class="r23 r">scriptExecutionSetting</span>.<a href="../engine/PSConfiguration.cs.html#ca722736c69691a0" class="i property">EnableScripts</a> == <b>true</b>)
                {
                    <span class="c">// Script execution is explicitly enabled</span>
                    <b>return</b> <span class="r23 r">scriptExecutionSetting</span>.<a href="../engine/PSConfiguration.cs.html#cd8bc0b249cea0f0" class="i property">ExecutionPolicy</a>;
                }
            }
 
            <b>return</b> <b>null</b>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Returns the value of the Execution Policy as retrieved</span>
        <span class="c">///</span><span class="c"> from the local preference.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">NULL if it is not defined at this level.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>private static string</b> <a id="304d4bf64c513f32" href="../R/304d4bf64c513f32.html" target="n" data-glyph="76,1" class="i method">GetLocalPreferenceValue</a>(<b>string</b> <span id="r24 rd" class="r24 r">shellId</span>, <a href="#a2a8c6696f673043" class="t t">ExecutionPolicyScope</a> <span id="r25 rd" class="r25 r">scope</span>)
        {
            <b>switch</b> (<span class="r25 r">scope</span>)
            {
                <span class="c">// 1: Look up the current-user preference</span>
                <b>case</b> <a href="#a2a8c6696f673043" class="t t">ExecutionPolicyScope</a>.<a href="#18a01c1cf7c5b914" class="i field">CurrentUser</a>:
                    <b>return</b> <a href="../engine/PSConfiguration.cs.html#9641e95401c2a85d" class="t t">PowerShellConfig</a>.<a href="../engine/PSConfiguration.cs.html#e4c913e160567f04" class="i field">Instance</a>.<a href="../engine/PSConfiguration.cs.html#b6455f8da1415cfa" class="i method">GetExecutionPolicy</a>(<a href="../engine/PSConfiguration.cs.html#377f34beb5e362cf" class="t t">ConfigScope</a>.<a href="../engine/PSConfiguration.cs.html#2486a7ab834532b3" class="i field">CurrentUser</a>, <span class="r24 r">shellId</span>);
 
                <span class="c">// 2: Look up the system-wide preference</span>
                <b>case</b> <a href="#a2a8c6696f673043" class="t t">ExecutionPolicyScope</a>.<a href="#9970b159c76dcaaf" class="i field">LocalMachine</a>:
                    <b>return</b> <a href="../engine/PSConfiguration.cs.html#9641e95401c2a85d" class="t t">PowerShellConfig</a>.<a href="../engine/PSConfiguration.cs.html#e4c913e160567f04" class="i field">Instance</a>.<a href="../engine/PSConfiguration.cs.html#b6455f8da1415cfa" class="i method">GetExecutionPolicy</a>(<a href="../engine/PSConfiguration.cs.html#377f34beb5e362cf" class="t t">ConfigScope</a>.<a href="../engine/PSConfiguration.cs.html#378339620026a80d" class="i field">AllUsers</a>, <span class="r24 r">shellId</span>);
            }
 
            <b>return</b> <b>null</b>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> execution policy
 
        <b>private static bool</b> <a id="bc69a7f8b0bfe2d7" href="../R/bc69a7f8b0bfe2d7.html" target="n" data-glyph="46,1" class="i field">_saferIdentifyLevelApiSupported</a> = <b>true</b>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Get the pass / fail result of calling the SAFER API.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r26 r">path</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The path to the file in question.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r27 r">handle</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">A file handle to the file in question, if available.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        [<span class="i">ArchitectureSensitive</span>]
        [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Reliability&quot;</span>, <span class="s">&quot;CA2001:AvoidCallingProblematicMethods&quot;</span>)]
        <b>internal static</b> <a href="#58419a9424af463c" class="t t">SaferPolicy</a> <a id="03e8bd6c6938b551" href="../R/03e8bd6c6938b551.html" target="n" data-glyph="74,1" class="i method">GetSaferPolicy</a>(<b>string</b> <span id="r26 rd" class="r26 r">path</span>, <span class="i">SafeHandle</span> <span id="r27 rd" class="r27 r">handle</span>)
        {
            <a href="#58419a9424af463c" class="t t">SaferPolicy</a> <span id="r28 rd" class="r28 r">status</span> = <a href="#58419a9424af463c" class="t t">SaferPolicy</a>.<a href="#4c7bf0528b9fad3e" class="i field">Allowed</a>;
 
            <b>if</b> (!<a href="#bc69a7f8b0bfe2d7" class="i field">_saferIdentifyLevelApiSupported</a>)
            {
                <b>return</b> <span class="r28 r">status</span>;
            }
 
            <a href="nativeMethods.cs.html#049e6b87ba615ace" class="t t">SAFER_CODE_PROPERTIES</a> <span id="r29 rd" class="r29 r">codeProperties</span> = <b>new</b> <span class="t">SAFER_CODE_PROPERTIES</span>();
            <span class="i">IntPtr</span> <span id="r30 rd" class="r30 r">hAuthzLevel</span>;
 
            <span class="c">// Prepare the code properties struct.</span>
            <span class="r29 r">codeProperties</span>.<a href="nativeMethods.cs.html#3be490791f8c6f3d" class="i field">cbSize</a> = (<b>uint</b>)<span class="i">Marshal</span>.<span class="i">SizeOf</span>(<b>typeof</b>(<a href="nativeMethods.cs.html#049e6b87ba615ace" class="t t">SAFER_CODE_PROPERTIES</a>));
            <span class="r29 r">codeProperties</span>.<a href="nativeMethods.cs.html#84e443ef0f366853" class="i field">dwCheckFlags</a> = (
                <a href="../P/8710e5604ffa77bf.html#8710e5604ffa77bf" class="t t">NativeConstants</a>.<a href="nativeMethods.cs.html#5e1c593982250c8b" class="i field">SAFER_CRITERIA_IMAGEPATH</a> |
                <a href="../P/8710e5604ffa77bf.html#8710e5604ffa77bf" class="t t">NativeConstants</a>.<a href="nativeMethods.cs.html#f698a50143de406b" class="i field">SAFER_CRITERIA_IMAGEHASH</a> |
                <a href="../P/8710e5604ffa77bf.html#8710e5604ffa77bf" class="t t">NativeConstants</a>.<a href="nativeMethods.cs.html#1421bc6054d461f9" class="i field">SAFER_CRITERIA_AUTHENTICODE</a>);
            <span class="r29 r">codeProperties</span>.<a href="nativeMethods.cs.html#7779286298dff7bd" class="i field">ImagePath</a> = <span class="r26 r">path</span>;
 
            <b>if</b> (<span class="r27 r">handle</span> != <b>null</b>)
            {
                <span class="r29 r">codeProperties</span>.<a href="nativeMethods.cs.html#e92a1d1b2067db1a" class="i field">hImageFileHandle</a> = <span class="r27 r">handle</span>.<span class="i">DangerousGetHandle</span>();
            }
 
            <span class="c">// turn off WinVerifyTrust UI</span>
            <span class="r29 r">codeProperties</span>.<a href="nativeMethods.cs.html#5b7a74cd253ebefa" class="i field">dwWVTUIChoice</a> = <a href="../P/8710e5604ffa77bf.html#8710e5604ffa77bf" class="t t">NativeConstants</a>.<a href="nativeMethods.cs.html#8669194cca490212" class="i field">WTD_UI_NONE</a>;
 
            <span class="c">// Identify the level associated with the code</span>
            <b>if</b> (<a href="../P/8e47b880ffb978dc.html#8e47b880ffb978dc" class="t t">NativeMethods</a>.<a href="nativeMethods.cs.html#8bbce7a869205ec6" class="i method">SaferIdentifyLevel</a>(1, <b>ref</b> <span class="r29 r">codeProperties</span>, <b>out</b> <span class="r30 r">hAuthzLevel</span>, <a href="../P/8710e5604ffa77bf.html#8710e5604ffa77bf" class="t t">NativeConstants</a>.<a href="nativeMethods.cs.html#ed9966073c0ce587" class="i field">SRP_POLICY_SCRIPT</a>))
            {
                <span class="c">// We found an Authorization Level applicable to this application.</span>
                <span class="i">IntPtr</span> <span id="r31 rd" class="r31 r">hRestrictedToken</span> = <span class="i">IntPtr</span>.<span class="i">Zero</span>;
                <b>try</b>
                {
                    <b>if</b> (!<a href="../P/8e47b880ffb978dc.html#8e47b880ffb978dc" class="t t">NativeMethods</a>.<span class="i">SaferComputeTokenFromLevel</span>(
                                               <span class="r30 r">hAuthzLevel</span>,                    <span class="c">// Safer Level</span>
                                               <span class="i">IntPtr</span>.<span class="i">Zero</span>,                    <span class="c">// Test current process&#39; token</span>
                                               <b>ref</b> <span class="r31 r">hRestrictedToken</span>,           <span class="c">// target token</span>
                                               <a href="../P/8710e5604ffa77bf.html#8710e5604ffa77bf" class="t t">NativeConstants</a>.<a href="nativeMethods.cs.html#63bc2583060e665b" class="i field">SAFER_TOKEN_NULL_IF_EQUAL</a>,
                                               <span class="i">IntPtr</span>.<span class="i">Zero</span>))
                    {
                        <b>int</b> <span id="r32 rd" class="r32 r">lastError</span> = <span class="i">Marshal</span>.<span class="i">GetLastWin32Error</span>();
                        <b>if</b> ((<span class="r32 r">lastError</span> == <a href="../P/8710e5604ffa77bf.html#8710e5604ffa77bf" class="t t">NativeConstants</a>.<a href="nativeMethods.cs.html#48d70c2dd896fa62" class="i field">ERROR_ACCESS_DISABLED_BY_POLICY</a>) ||
                            (<span class="r32 r">lastError</span> == <a href="../P/8710e5604ffa77bf.html#8710e5604ffa77bf" class="t t">NativeConstants</a>.<a href="nativeMethods.cs.html#916b6bc740ae9d32" class="i field">ERROR_ACCESS_DISABLED_NO_SAFER_UI_BY_POLICY</a>))
                        {
                            <span class="r28 r">status</span> = <a href="#58419a9424af463c" class="t t">SaferPolicy</a>.<a href="#4b51340b630e2fd5" class="i field">Disallowed</a>;
                        }
                        <b>else</b>
                        {
                            <b>throw</b> <b>new</b> <span class="i n">System</span>.<span class="i">ComponentModel</span>.<span class="i">Win32Exception</span>();
                        }
                    }
                    <b>else</b>
                    {
                        <b>if</b> (<span class="r31 r">hRestrictedToken</span> == <span class="i">IntPtr</span>.<span class="i">Zero</span>)
                        {
                            <span class="c">// This is not necessarily the &quot;fully trusted&quot; level,</span>
                            <span class="c">// it means that the thread token is complies with the requested level</span>
                            <span class="r28 r">status</span> = <a href="#58419a9424af463c" class="t t">SaferPolicy</a>.<a href="#4c7bf0528b9fad3e" class="i field">Allowed</a>;
                        }
                        <b>else</b>
                        {
                            <span class="r28 r">status</span> = <a href="#58419a9424af463c" class="t t">SaferPolicy</a>.<a href="#4b51340b630e2fd5" class="i field">Disallowed</a>;
                            <a href="../P/8e47b880ffb978dc.html#8e47b880ffb978dc" class="t t">NativeMethods</a>.<span class="i">CloseHandle</span>(<span class="r31 r">hRestrictedToken</span>);
                        }
                    }
                }
                <b>finally</b>
                {
                    <a href="../P/8e47b880ffb978dc.html#8e47b880ffb978dc" class="t t">NativeMethods</a>.<a href="nativeMethods.cs.html#884b948b0387d2b8" class="i method">SaferCloseLevel</a>(<span class="r30 r">hAuthzLevel</span>);
                }
            }
            <b>else</b>
            {
                <b>int</b> <span id="r33 rd" class="r33 r">lastError</span> = <span class="i">Marshal</span>.<span class="i">GetLastWin32Error</span>();
                <b>if</b> (<span class="r33 r">lastError</span> == <a href="../P/8710e5604ffa77bf.html#8710e5604ffa77bf" class="t t">NativeConstants</a>.<a href="nativeMethods.cs.html#e1fa29a1d53b8abc" class="i field">FUNCTION_NOT_SUPPORTED</a>)
                {
                    <a href="#bc69a7f8b0bfe2d7" class="i field">_saferIdentifyLevelApiSupported</a> = <b>false</b>;
                }
                <b>else</b>
                {
                    <b>throw</b> <b>new</b> <span class="i n">System</span>.<span class="i">ComponentModel</span>.<span class="i">Win32Exception</span>(<span class="r33 r">lastError</span>);
                }
            }
 
            <b>return</b> <span class="r28 r">status</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Throw if file does not exist.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r34 r">filePath</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Path to file.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">Does not return a value.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal static void</b> <a id="b76b67f21d84ed4a" href="../R/b76b67f21d84ed4a.html" target="n" data-glyph="74,1" class="i method">CheckIfFileExists</a>(<b>string</b> <span id="r34 rd" class="r34 r">filePath</span>)
        {
            <b>if</b> (!<span class="i">File</span>.<span class="i">Exists</span>(<span class="r34 r">filePath</span>))
            {
                <b>throw</b> <b>new</b> <span class="i">FileNotFoundException</span>(<span class="r34 r">filePath</span>);
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Check to see if the specified cert is suitable to be</span>
        <span class="c">///</span><span class="c"> used as a code signing cert.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r35 r">c</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Certificate object.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">True on success, false otherwise.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal static bool</b> <a id="358bc0ab80edacce" href="../R/358bc0ab80edacce.html" target="n" data-glyph="74,1" class="i method">CertIsGoodForSigning</a>(<span class="i">X509Certificate2</span> <span id="r35 rd" class="r35 r">c</span>)
        {
            <b>if</b> (!<span class="r35 r">c</span>.<span class="i">HasPrivateKey</span>)
            {
                <b>return</b> <b>false</b>;
            }
 
            <b>return</b> <a href="#d3875bd365332cc8" class="i method">CertHasOid</a>(<span class="r35 r">c</span>, <a href="#f8fe0bbbcccd4eae" class="t t">CertificateFilterInfo</a>.<a href="#05a2d17a99ae6352" class="i field">CodeSigningOid</a>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Check to see if the specified cert is suitable to be</span>
        <span class="c">///</span><span class="c"> used as an encryption cert for PKI encryption. Note</span>
        <span class="c">///</span><span class="c"> that this cert doesn&#39;t require the private key.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r36 r">c</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Certificate object.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">True on success, false otherwise.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal static bool</b> <a id="3679796bcda7c0bd" href="../R/3679796bcda7c0bd.html" target="n" data-glyph="74,1" class="i method">CertIsGoodForEncryption</a>(<span class="i">X509Certificate2</span> <span id="r36 rd" class="r36 r">c</span>)
        {
            <b>return</b> (
                <a href="#d3875bd365332cc8" class="i method">CertHasOid</a>(<span class="r36 r">c</span>, <a href="#f8fe0bbbcccd4eae" class="t t">CertificateFilterInfo</a>.<a href="#a6b79f08d3941139" class="i field">DocumentEncryptionOid</a>) &amp;&amp;
                (<span class="i">CertHasKeyUsage</span>(<span class="r36 r">c</span>, <span class="i">X509KeyUsageFlags</span>.<span class="i">DataEncipherment</span>) ||
                 <span class="i">CertHasKeyUsage</span>(<span class="r36 r">c</span>, <span class="i">X509KeyUsageFlags</span>.<span class="i">KeyEncipherment</span>)));
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Check to see if the specified cert is expiring by the time.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r37 r">c</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Certificate object.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r38 r">expiring</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Certificate expire time.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">True on success, false otherwise.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal static bool</b> <a id="f47847f9fa68a028" href="../R/../../0000000000.html" target="n" data-glyph="74,1" class="i method">CertExpiresByTime</a>(<span class="i">X509Certificate2</span> <span id="r37 rd" class="r37 r">c</span>, <span class="i">DateTime</span> <span id="r38 rd" class="r38 r">expiring</span>)
        {
            <b>return</b> <span class="r37 r">c</span>.<span class="i">NotAfter</span> &lt; <span class="r38 r">expiring</span>;
        }
 
        <b>private static bool</b> <a id="d3875bd365332cc8" href="../R/d3875bd365332cc8.html" target="n" data-glyph="76,1" class="i method">CertHasOid</a>(<span class="i">X509Certificate2</span> <span id="r39 rd" class="r39 r">c</span>, <b>string</b> <span id="r40 rd" class="r40 r">oid</span>)
        {
            <b>foreach</b> (<b>var</b> <span id="r41 rd" class="r41 r">extension</span> <b>in</b> <span class="r39 r">c</span>.<span class="i">Extensions</span>)
            {
                <b>if</b> (<span class="r41 r">extension</span> <b>is</b> <span class="i">X509EnhancedKeyUsageExtension</span> <span id="r42 rd" class="r42 r">ext</span>)
                {
                    <b>foreach</b> (<span class="i">Oid</span> <span id="r43 rd" class="r43 r">ekuOid</span> <b>in</b> <span class="r42 r">ext</span>.<span class="i">EnhancedKeyUsages</span>)
                    {
                        <b>if</b> (<span class="r43 r">ekuOid</span>.<span class="i">Value</span> == <span class="r40 r">oid</span>)
                        {
                            <b>return</b> <b>true</b>;
                        }
                    }
                    <b>break</b>;
                }
            }
            <b>return</b> <b>false</b>;
        }
 
        <b>private static bool</b> <a id="8678baf04d64ccb8" href="../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">CertHasKeyUsage</a>(<span class="i">X509Certificate2</span> <span id="r44 rd" class="r44 r">c</span>, <span class="i">X509KeyUsageFlags</span> <span id="r45 rd" class="r45 r">keyUsage</span>)
        {
            <b>foreach</b> (<span class="i">X509Extension</span> <span id="r46 rd" class="r46 r">extension</span> <b>in</b> <span class="r44 r">c</span>.<span class="i">Extensions</span>)
            {
                <span class="i">X509KeyUsageExtension</span> <span id="r47 rd" class="r47 r">keyUsageExtension</span> = <span class="r46 r">extension</span> <b>as</b> <span class="i">X509KeyUsageExtension</span>;
                <b>if</b> (<span class="r47 r">keyUsageExtension</span> != <b>null</b>)
                {
                    <b>if</b> ((<span class="r47 r">keyUsageExtension</span>.<span class="i">KeyUsages</span> &amp; <span class="r45 r">keyUsage</span>) == <span class="r45 r">keyUsage</span>)
                    {
                        <b>return</b> <b>true</b>;
                    }
                    <b>break</b>;
                }
            }
            <b>return</b> <b>false</b>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Get the EKUs of a cert.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r48 r">cert</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Certificate object.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">A collection of cert eku strings.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        [<span class="i">ArchitectureSensitive</span>]
        <b>internal static</b> <span class="i">Collection</span>&lt;<b>string</b>&gt; <a id="0f71473b0696b222" href="../R/../../0000000000.html" target="n" data-glyph="74,1" class="i method">GetCertEKU</a>(<span class="i">X509Certificate2</span> <span id="r48 rd" class="r48 r">cert</span>)
        {
            <span class="i">Collection</span>&lt;<b>string</b>&gt; <span id="r49 rd" class="r49 r">ekus</span> = <b>new</b> <span class="i">Collection</span>&lt;<b>string</b>&gt;();
            <span class="i">IntPtr</span> <span id="r50 rd" class="r50 r">pCert</span> = <span class="r48 r">cert</span>.<span class="i">Handle</span>;
            <b>int</b> <span id="r51 rd" class="r51 r">structSize</span> = 0;
            <span class="i">IntPtr</span> <span id="r52 rd" class="r52 r">dummy</span> = <span class="i">IntPtr</span>.<span class="i">Zero</span>;
 
            <b>if</b> (<span class="i n">Security</span>.<a href="../P/8e47b880ffb978dc.html#8e47b880ffb978dc" class="t t">NativeMethods</a>.<span class="i">CertGetEnhancedKeyUsage</span>(<span class="r50 r">pCert</span>, 0, <span class="r52 r">dummy</span>,
                                                      <b>out</b> <span class="r51 r">structSize</span>))
            {
                <b>if</b> (<span class="r51 r">structSize</span> &gt; 0)
                {
                    <span class="i">IntPtr</span> <span id="r53 rd" class="r53 r">ekuBuffer</span> = <span class="i">Marshal</span>.<span class="i">AllocHGlobal</span>(<span class="r51 r">structSize</span>);
 
                    <b>try</b>
                    {
                        <b>if</b> (<span class="i n">Security</span>.<a href="../P/8e47b880ffb978dc.html#8e47b880ffb978dc" class="t t">NativeMethods</a>.<span class="i">CertGetEnhancedKeyUsage</span>(<span class="r50 r">pCert</span>, 0,
                                                                  <span class="r53 r">ekuBuffer</span>,
                                                                  <b>out</b> <span class="r51 r">structSize</span>))
                        {
                            <span class="i n">Security</span>.<a href="../P/8e47b880ffb978dc.html#8e47b880ffb978dc" class="t t">NativeMethods</a>.<a href="nativeMethods.cs.html#441de241f970b427" class="t t">CERT_ENHKEY_USAGE</a> <span id="r54 rd" class="r54 r">ekuStruct</span> =
                                <span class="i">Marshal</span>.<span class="i">PtrToStructure</span>&lt;<span class="i n">Security</span>.<a href="../P/8e47b880ffb978dc.html#8e47b880ffb978dc" class="t t">NativeMethods</a>.<a href="nativeMethods.cs.html#441de241f970b427" class="t t">CERT_ENHKEY_USAGE</a>&gt;(<span class="r53 r">ekuBuffer</span>);
                            <span class="i">IntPtr</span> <span id="r55 rd" class="r55 r">ep</span> = <span class="r54 r">ekuStruct</span>.<a href="nativeMethods.cs.html#a6569772e5dbc9db" class="i field">rgpszUsageIdentifier</a>;
                            <span class="i">IntPtr</span> <span id="r56 rd" class="r56 r">ekuptr</span>;
 
                            <b>for</b> (<b>int</b> <span id="r57 rd" class="r57 r">i</span> = 0; <span class="r57 r">i</span> &lt; <span class="r54 r">ekuStruct</span>.<a href="nativeMethods.cs.html#9e9f33b48953b15f" class="i field">cUsageIdentifier</a>; <span class="r57 r">i</span>++)
                            {
                                <span class="r56 r">ekuptr</span> = <span class="i">Marshal</span>.<span class="i">ReadIntPtr</span>(<span class="r55 r">ep</span>, <span class="r57 r">i</span> * <span class="i">Marshal</span>.<span class="i">SizeOf</span>(<span class="r55 r">ep</span>));
                                <b>string</b> <span id="r58 rd" class="r58 r">eku</span> = <span class="i">Marshal</span>.<span class="i">PtrToStringAnsi</span>(<span class="r56 r">ekuptr</span>);
                                <span class="r49 r">ekus</span>.<span class="i">Add</span>(<span class="r58 r">eku</span>);
                            }
                        }
                        <b>else</b>
                        {
                            <b>throw</b> <b>new</b> <span class="i n">System</span>.<span class="i">ComponentModel</span>.<span class="i">Win32Exception</span>(<span class="i">Marshal</span>.<span class="i">GetLastWin32Error</span>());
                        }
                    }
                    <b>finally</b>
                    {
                        <span class="i">Marshal</span>.<span class="i">FreeHGlobal</span>(<span class="r53 r">ekuBuffer</span>);
                    }
                }
            }
            <b>else</b>
            {
                <b>throw</b> <b>new</b> <span class="i n">System</span>.<span class="i">ComponentModel</span>.<span class="i">Win32Exception</span>(<span class="i">Marshal</span>.<span class="i">GetLastWin32Error</span>());
            }
 
            <b>return</b> <span class="r49 r">ekus</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Convert an int to a DWORD.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r59 r">n</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Signed int number.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">DWORD.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal static</b> <span class="i">DWORD</span> <a id="e28e84da703c2d06" href="../R/e28e84da703c2d06.html" target="n" data-glyph="74,1" class="i method">GetDWORDFromInt</a>(<b>int</b> <span id="r59 rd" class="r59 r">n</span>)
        {
            <span class="i">UInt32</span> <span id="r60 rd" class="r60 r">result</span> = <span class="i">BitConverter</span>.<span class="i">ToUInt32</span>(<span class="i">BitConverter</span>.<span class="i">GetBytes</span>(<span class="r59 r">n</span>), 0);
            <b>return</b> (<span class="i">DWORD</span>)<span class="r60 r">result</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Convert a DWORD to int.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r61 r">n</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Number.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">Int.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal static int</b> <a id="d8316b784815610d" href="../R/d8316b784815610d.html" target="n" data-glyph="74,1" class="i method">GetIntFromDWORD</a>(<span class="i">DWORD</span> <span id="r61 rd" class="r61 r">n</span>)
        {
            <span class="i">Int64</span> <span id="r62 rd" class="r62 r">n64</span> = <span class="r61 r">n</span> - 0x100000000L;
            <b>return</b> (<b>int</b>)<span class="r62 r">n64</span>;
        }
    }
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Information used for filtering a set of certs.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>internal sealed class</b> <a id="f8fe0bbbcccd4eae" href="../R/f8fe0bbbcccd4eae.html" target="n" data-glyph="2,0" class="t t">CertificateFilterInfo</a>
    {
        <b>internal</b> <a id="f9ae51fda8dee1c2" href="../R/../../0000000000.html" target="n" data-glyph="74,1" class="t constructor">CertificateFilterInfo</a>()
        {
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets or sets purpose of a certificate.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal</b> <a href="#2a3b65d3e9ee316e" class="t t">CertificatePurpose</a> <a id="5edaf891097d97fd" href="../R/../../0000000000.html" target="n" data-glyph="104,1" class="i property">Purpose</a>
        {
            <b>get</b>;
            <b>set</b>;
        } = <a href="#2a3b65d3e9ee316e" class="t t">CertificatePurpose</a>.<a href="#367092ba3f4f2822" class="i field">NotSpecified</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets or sets SSL Server Authentication.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal bool</b> <a id="d638239c6d61af1c" href="../R/../../0000000000.html" target="n" data-glyph="104,1" class="i property">SSLServerAuthentication</a>
        {
            <b>get</b>;
 
            <b>set</b>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets or sets DNS name of a certificate.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal</b> <a href="../engine/regex.cs.html#d450e739ff28e660" class="t t">WildcardPattern</a> <a id="499694df2519013d" href="../R/../../0000000000.html" target="n" data-glyph="104,1" class="i property">DnsName</a>
        {
            <b>get</b>;
            <b>set</b>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets or sets EKU OID list of a certificate.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal</b> <span class="i">List</span>&lt;<a href="../engine/regex.cs.html#d450e739ff28e660" class="t t">WildcardPattern</a>&gt; <a id="a60593e791346371" href="../R/../../0000000000.html" target="n" data-glyph="104,1" class="i property">Eku</a>
        {
            <b>get</b>;
            <b>set</b>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets or sets validity time for a certificate.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal</b> <span class="i">DateTime</span> <a id="fdb7b1c6e00a3220" href="../R/../../0000000000.html" target="n" data-glyph="104,1" class="i property">Expiring</a>
        {
            <b>get</b>;
            <b>set</b>;
        } = <span class="i">DateTime</span>.<span class="i">MinValue</span>;
 
        <b>internal const string</b> <a id="05a2d17a99ae6352" href="../R/05a2d17a99ae6352.html" target="n" data-glyph="8,1" class="i field">CodeSigningOid</a> = <span class="s">&quot;1.3.6.1.5.5.7.3.3&quot;</span>;
        <b>internal const string</b> <a id="6c0b31d3e65021dd" href="../R/../../0000000000.html" target="n" data-glyph="8,1" class="i field">OID_PKIX_KP_SERVER_AUTH</a> = <span class="s">&quot;1.3.6.1.5.5.7.3.1&quot;</span>;
 
        <span class="c">// The OID arc 1.3.6.1.4.1.311.80 is assigned to PowerShell. If we need</span>
        <span class="c">// new OIDs, we can assign them under this branch.</span>
        <b>internal const string</b> <a id="a6b79f08d3941139" href="../R/a6b79f08d3941139.html" target="n" data-glyph="8,1" class="i field">DocumentEncryptionOid</a> = <span class="s">&quot;1.3.6.1.4.1.311.80.1&quot;</span>;
    }
}
 
<b>namespace</b> <span class="i n">Microsoft</span>.<span class="i n">PowerShell</span>.<span class="i n">Commands</span>
{
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Defines the valid purposes by which</span>
    <span class="c">///</span><span class="c"> we can filter certificates.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>internal enum</b> <a id="2a3b65d3e9ee316e" href="../R/2a3b65d3e9ee316e.html" target="n" data-glyph="20,0" class="t t"><span id="dfeb6770e9ed5a74">CertificatePurpose</span></a>
    {
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Certificates where a purpose has not been specified.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <a id="367092ba3f4f2822" href="../R/367092ba3f4f2822.html" target="n" data-glyph="24,1" class="i field">NotSpecified</a> = 0,
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Certificates that can be used to sign</span>
        <span class="c">///</span><span class="c"> code and scripts.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <a id="dd5c95d1e931ec03" href="../R/../../0000000000.html" target="n" data-glyph="24,1" class="i field">CodeSigning</a> = 0x1,
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Certificates that can be used to encrypt</span>
        <span class="c">///</span><span class="c"> data.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <a id="56daa15d08192313" href="../R/../../0000000000.html" target="n" data-glyph="24,1" class="i field">DocumentEncryption</a> = 0x2,
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Certificates that can be used for any</span>
        <span class="c">///</span><span class="c"> purpose.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <a id="d1c64faa8d213dde" href="../R/../../0000000000.html" target="n" data-glyph="24,1" class="i field">All</a> = 0xffff
    }
}
 
<b>namespace</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>
{
    <b>using</b> <span class="i n">System</span>.<span class="i">Security</span>.<span class="i">Cryptography</span>.<span class="i">Pkcs</span>;
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Utility class for CMS (Cryptographic Message Syntax) related operations.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>internal static class</b> <a id="de6319bf8345395a" href="../R/de6319bf8345395a.html" target="n" data-glyph="2,0" class="t t">CmsUtils</a>
    {
        <b>internal static string</b> <a id="5194b16780add5d4" href="../R/5194b16780add5d4.html" target="n" data-glyph="74,1" class="i method">Encrypt</a>(<b>byte</b>[] <span id="r63 rd" class="r63 r">contentBytes</span>, <a href="#5c5b6fe96cf7c3f2" class="t t">CmsMessageRecipient</a>[] <span id="r64 rd" class="r64 r">recipients</span>, <a href="../engine/SessionStatePublic.cs.html#0a202aa6b2d52930" class="t t">SessionState</a> <span id="r65 rd" class="r65 r">sessionState</span>, <b>out</b> <a href="../engine/ErrorPackage.cs.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r66 rd" class="r66 r">error</span>)
        {
            <span class="r66 r">error</span> = <b>null</b>;
 
            <b>if</b> ((<span class="r63 r">contentBytes</span> == <b>null</b>) || (<span class="r63 r">contentBytes</span>.<span class="i">Length</span> == 0))
            {
                <b>return</b> <b>string</b>.<span class="i">Empty</span>;
            }
 
            <span class="c">// After review with the crypto board, NIST_AES256_CBC is more appropriate</span>
            <span class="c">// than .NET&#39;s default 3DES. Also, when specified, uses szOID_RSAES_OAEP for key</span>
            <span class="c">// encryption to prevent padding attacks.</span>
            <b>const string</b> <span id="r67 rd" class="r67 r">szOID_NIST_AES256_CBC</span> = <span class="s">&quot;2.16.840.1.101.3.4.1.42&quot;</span>;
 
            <span class="i">ContentInfo</span> <span id="r68 rd" class="r68 r">content</span> = <b>new</b> <span class="i">ContentInfo</span>(<span class="r63 r">contentBytes</span>);
            <span class="i">EnvelopedCms</span> <span id="r69 rd" class="r69 r">cms</span> = <b>new</b> <span class="i">EnvelopedCms</span>(<span class="r68 r">content</span>,
                <b>new</b> <span class="i">AlgorithmIdentifier</span>(
                    <span class="i">Oid</span>.<span class="i">FromOidValue</span>(<span class="r67 r">szOID_NIST_AES256_CBC</span>, <span class="i">OidGroup</span>.<span class="i">EncryptionAlgorithm</span>)));
 
            <span class="i">CmsRecipientCollection</span> <span id="r70 rd" class="r70 r">recipientCollection</span> = <b>new</b> <span class="i">CmsRecipientCollection</span>();
            <b>foreach</b> (<a href="#5c5b6fe96cf7c3f2" class="t t">CmsMessageRecipient</a> <span id="r71 rd" class="r71 r">recipient</span> <b>in</b> <span class="r64 r">recipients</span>)
            {
                <span class="c">// Resolve the recipient, if it hasn&#39;t been done yet.</span>
                <b>if</b> ((<span class="r71 r">recipient</span>.<a href="#eedb5991913b91ce" class="i property">Certificates</a> != <b>null</b>) &amp;&amp; (<span class="r71 r">recipient</span>.<a href="#eedb5991913b91ce" class="i property">Certificates</a>.<span class="i">Count</span> == 0))
                {
                    <span class="r71 r">recipient</span>.<a href="#cf095157bcdcff2d" class="i method">Resolve</a>(<span class="r65 r">sessionState</span>, <a href="#1ce40ae4097eedd5" class="t t">ResolutionPurpose</a>.<a href="#7fe822f4f96a4ab8" class="i field">Encryption</a>, <b>out</b> <span class="r66 r">error</span>);
                }
 
                <b>if</b> (<span class="r66 r">error</span> != <b>null</b>)
                {
                    <b>return</b> <b>null</b>;
                }
 
                <b>foreach</b> (<span class="i">X509Certificate2</span> <span id="r72 rd" class="r72 r">certificate</span> <b>in</b> <span class="r71 r">recipient</span>.<a href="#eedb5991913b91ce" class="i property">Certificates</a>)
                {
                    <span class="r70 r">recipientCollection</span>.<span class="i">Add</span>(<b>new</b> <span class="i">CmsRecipient</span>(<span class="r72 r">certificate</span>));
                }
            }
 
            <span class="r69 r">cms</span>.<span class="i">Encrypt</span>(<span class="r70 r">recipientCollection</span>);
 
            <b>byte</b>[] <span id="r73 rd" class="r73 r">encodedBytes</span> = <span class="r69 r">cms</span>.<span class="i">Encode</span>();
            <b>string</b> <span id="r74 rd" class="r74 r">encodedContent</span> = <a href="#de6319bf8345395a" class="t t">CmsUtils</a>.<a href="#92277f4c1718fdfa" class="i method">GetAsciiArmor</a>(<span class="r73 r">encodedBytes</span>);
            <b>return</b> <span class="r74 r">encodedContent</span>;
        }
 
        <b>internal static readonly string</b> <a id="cf8acf943731c3da" href="../R/cf8acf943731c3da.html" target="n" data-glyph="44,1" class="i field">BEGIN_CMS_SIGIL</a> = <span class="s">&quot;-----BEGIN CMS-----&quot;</span>;
        <b>internal static readonly string</b> <a id="4c38b64536ac6df8" href="../R/4c38b64536ac6df8.html" target="n" data-glyph="44,1" class="i field">END_CMS_SIGIL</a> = <span class="s">&quot;-----END CMS-----&quot;</span>;
 
        <b>internal static readonly string</b> <a id="9fcdc4f590c90e21" href="../R/9fcdc4f590c90e21.html" target="n" data-glyph="44,1" class="i field">BEGIN_CERTIFICATE_SIGIL</a> = <span class="s">&quot;-----BEGIN CERTIFICATE-----&quot;</span>;
        <b>internal static readonly string</b> <a id="797d6480f195e8a9" href="../R/797d6480f195e8a9.html" target="n" data-glyph="44,1" class="i field">END_CERTIFICATE_SIGIL</a> = <span class="s">&quot;-----END CERTIFICATE-----&quot;</span>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Adds Ascii armour to a byte stream in Base64 format.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r75 r">bytes</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The bytes to encode.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal static string</b> <a id="92277f4c1718fdfa" href="../R/92277f4c1718fdfa.html" target="n" data-glyph="74,1" class="i method">GetAsciiArmor</a>(<b>byte</b>[] <span id="r75 rd" class="r75 r">bytes</span>)
        {
            <span class="i">StringBuilder</span> <span id="r76 rd" class="r76 r">output</span> = <b>new</b> <span class="i">StringBuilder</span>();
            <span class="r76 r">output</span>.<span class="i">AppendLine</span>(<a href="#cf8acf943731c3da" class="i field">BEGIN_CMS_SIGIL</a>);
 
            <b>string</b> <span id="r77 rd" class="r77 r">encodedString</span> = <span class="i">Convert</span>.<span class="i">ToBase64String</span>(<span class="r75 r">bytes</span>, <span class="i">Base64FormattingOptions</span>.<span class="i">InsertLineBreaks</span>);
            <span class="r76 r">output</span>.<span class="i">AppendLine</span>(<span class="r77 r">encodedString</span>);
            <span class="r76 r">output</span>.<span class="i">Append</span>(<a href="#4c38b64536ac6df8" class="i field">END_CMS_SIGIL</a>);
 
            <b>return</b> <span class="r76 r">output</span>.<span class="i">ToString</span>();
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Removes Ascii armour from a byte stream.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r78 r">actualContent</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The Ascii armored content.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r79 r">beginMarker</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The marker of the start of the Base64 content.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r80 r">endMarker</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The marker of the end of the Base64 content.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r81 r">startIndex</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The beginning of where the Ascii armor was detected.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r82 r">endIndex</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The end of where the Ascii armor was detected.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal static byte</b>[] <a id="7d17621616a367f4" href="../R/7d17621616a367f4.html" target="n" data-glyph="74,1" class="i method">RemoveAsciiArmor</a>(<b>string</b> <span id="r78 rd" class="r78 r">actualContent</span>, <b>string</b> <span id="r79 rd" class="r79 r">beginMarker</span>, <b>string</b> <span id="r80 rd" class="r80 r">endMarker</span>, <b>out int</b> <span id="r81 rd" class="r81 r">startIndex</span>, <b>out int</b> <span id="r82 rd" class="r82 r">endIndex</span>)
        {
            <b>byte</b>[] <span id="r83 rd" class="r83 r">messageBytes</span> = <b>null</b>;
            <span class="r81 r">startIndex</span> = -1;
            <span class="r82 r">endIndex</span> = -1;
 
            <span class="r81 r">startIndex</span> = <span class="r78 r">actualContent</span>.<span class="i">IndexOf</span>(<span class="r79 r">beginMarker</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>);
            <b>if</b> (<span class="r81 r">startIndex</span> &lt; 0)
            {
                <b>return</b> <b>null</b>;
            }
 
            <span class="r82 r">endIndex</span> = <span class="r78 r">actualContent</span>.<span class="i">IndexOf</span>(<span class="r80 r">endMarker</span>, <span class="r81 r">startIndex</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>) +
                 <span class="r80 r">endMarker</span>.<span class="i">Length</span>;
            <b>if</b> (<span class="r82 r">endIndex</span> &lt; <span class="r80 r">endMarker</span>.<span class="i">Length</span>)
            {
                <b>return</b> <b>null</b>;
            }
 
            <b>int</b> <span id="r84 rd" class="r84 r">startContent</span> = <span class="r81 r">startIndex</span> + <span class="r79 r">beginMarker</span>.<span class="i">Length</span>;
            <b>int</b> <span id="r85 rd" class="r85 r">endContent</span> = <span class="r82 r">endIndex</span> - <span class="r80 r">endMarker</span>.<span class="i">Length</span>;
            <b>string</b> <span id="r86 rd" class="r86 r">encodedContent</span> = <span class="r78 r">actualContent</span>.<span class="i">Substring</span>(<span class="r84 r">startContent</span>, <span class="r85 r">endContent</span> - <span class="r84 r">startContent</span>);
            <span class="r86 r">encodedContent</span> = <span class="i n">System</span>.<span class="i">Text</span>.<span class="i">RegularExpressions</span>.<span class="i">Regex</span>.<span class="i">Replace</span>(<span class="r86 r">encodedContent</span>, <span class="s">&quot;\\s&quot;</span>, <b>string</b>.<span class="i">Empty</span>);
            <span class="r83 r">messageBytes</span> = <span class="i">Convert</span>.<span class="i">FromBase64String</span>(<span class="r86 r">encodedContent</span>);
 
            <b>return</b> <span class="r83 r">messageBytes</span>;
        }
    }
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Represents a message recipient for the Cms cmdlets.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>public class</b> <a id="5c5b6fe96cf7c3f2" href="../R/5c5b6fe96cf7c3f2.html" target="n" data-glyph="0,0" class="t t">CmsMessageRecipient</a>
    {
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Creates an instance of the CmsMessageRecipient class.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal</b> <a id="3e4a706619fcbf54" href="../R/../../0000000000.html" target="n" data-glyph="74,1" class="t constructor">CmsMessageRecipient</a>() { }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Creates an instance of the CmsMessageRecipient class.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r87 r">identifier</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c">     The identifier of the CmsMessageRecipient.</span>
        <span class="c">///</span><span class="c">     Can be either:</span>
        <span class="c">///</span><span class="c">         - The path to a file containing the certificate</span>
        <span class="c">///</span><span class="c">         - The path to a directory containing the certificate</span>
        <span class="c">///</span><span class="c">         - The thumbprint of the certificate, used to find the certificate in the certificate store</span>
        <span class="c">///</span><span class="c">         - The Subject name of the recipient, used to find the certificate in the certificate store</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>public</b> <a id="b3763cd21ae51368" href="../R/b3763cd21ae51368.html" target="n" data-glyph="72,1" class="t constructor">CmsMessageRecipient</a>(<b>string</b> <span id="r87 rd" class="r87 r">identifier</span>)
        {
            <a href="#582be86561cf7bd5" class="i field">_identifier</a> = <span class="r87 r">identifier</span>;
            <a href="#5c5b6fe96cf7c3f2" class="k">this</a>.<a href="#eedb5991913b91ce" class="i property">Certificates</a> = <b>new</b> <span class="i">X509Certificate2Collection</span>();
        }
 
        <b>private readonly string</b> <a id="582be86561cf7bd5" href="../R/582be86561cf7bd5.html" target="n" data-glyph="46,1" class="i field">_identifier</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Creates an instance of the CmsMessageRecipient class.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r88 r">certificate</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The certificate to use.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>public</b> <a id="d7ac39a7d5959cf1" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="t constructor">CmsMessageRecipient</a>(<span class="i">X509Certificate2</span> <span id="r88 rd" class="r88 r">certificate</span>)
        {
            <a href="#b3179e959e9e9682" class="i field">_pendingCertificate</a> = <span class="r88 r">certificate</span>;
            <a href="#5c5b6fe96cf7c3f2" class="k">this</a>.<a href="#eedb5991913b91ce" class="i property">Certificates</a> = <b>new</b> <span class="i">X509Certificate2Collection</span>();
        }
 
        <b>private readonly</b> <span class="i">X509Certificate2</span> <a id="b3179e959e9e9682" href="../R/b3179e959e9e9682.html" target="n" data-glyph="46,1" class="i field">_pendingCertificate</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the certificate associated with this recipient.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public</b> <span class="i">X509Certificate2Collection</span> <a id="eedb5991913b91ce" href="../R/eedb5991913b91ce.html" target="n" data-glyph="102,1" class="i property">Certificates</a>
        {
            <b>get</b>;
            <b>internal set</b>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Resolves the provided identifier into a collection of certificates.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r89 r">sessionState</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">A reference to an instance of Powershell&#39;s SessionState class.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r90 r">purpose</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The purpose for which this identifier is being resolved (Encryption / Decryption.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r91 r">error</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The error generated (if any) for this resolution.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>public void</b> <a id="cf095157bcdcff2d" href="../R/cf095157bcdcff2d.html" target="n" data-glyph="72,1" class="i method">Resolve</a>(<a href="../engine/SessionStatePublic.cs.html#0a202aa6b2d52930" class="t t">SessionState</a> <span id="r89 rd" class="r89 r">sessionState</span>, <a href="#1ce40ae4097eedd5" class="t t">ResolutionPurpose</a> <span id="r90 rd" class="r90 r">purpose</span>, <b>out</b> <a href="../engine/ErrorPackage.cs.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r91 rd" class="r91 r">error</span>)
        {
            <span class="r91 r">error</span> = <b>null</b>;
 
            <span class="c">// Process the certificate if that was supplied exactly</span>
            <b>if</b> (<a href="#b3179e959e9e9682" class="i field">_pendingCertificate</a> != <b>null</b>)
            {
                <a href="#5a14dc1eaaff4329" class="i method">ProcessResolvedCertificates</a>(
                    <span class="r90 r">purpose</span>,
                    <b>new</b> <span class="i">X509Certificate2Collection</span>(<a href="#b3179e959e9e9682" class="i field">_pendingCertificate</a>),
                    <b>out</b> <span class="r91 r">error</span>);
                <b>if</b> ((<span class="r91 r">error</span> != <b>null</b>) || (<a href="#eedb5991913b91ce" class="i property">Certificates</a>.<span class="i">Count</span> != 0))
                {
                    <b>return</b>;
                }
            }
 
            <b>if</b> (<a href="#582be86561cf7bd5" class="i field">_identifier</a> != <b>null</b>)
            {
                <span class="c">// First try to resolve assuming that the cert was Base64 encoded.</span>
                <a href="#b5fe4bc00cfce3dd" class="i method">ResolveFromBase64Encoding</a>(<span class="r90 r">purpose</span>, <b>out</b> <span class="r91 r">error</span>);
                <b>if</b> ((<span class="r91 r">error</span> != <b>null</b>) || (<a href="#eedb5991913b91ce" class="i property">Certificates</a>.<span class="i">Count</span> != 0))
                {
                    <b>return</b>;
                }
 
                <span class="c">// Then try to resolve by path.</span>
                <a href="#8dc404e499b7aeed" class="i method">ResolveFromPath</a>(<span class="r89 r">sessionState</span>, <span class="r90 r">purpose</span>, <b>out</b> <span class="r91 r">error</span>);
                <b>if</b> ((<span class="r91 r">error</span> != <b>null</b>) || (<a href="#eedb5991913b91ce" class="i property">Certificates</a>.<span class="i">Count</span> != 0))
                {
                    <b>return</b>;
                }
 
                <span class="c">// Then by cert store</span>
                <a href="#4da3158dba923e0e" class="i method">ResolveFromStoreById</a>(<span class="r90 r">purpose</span>, <b>out</b> <span class="r91 r">error</span>);
                <b>if</b> ((<span class="r91 r">error</span> != <b>null</b>) || (<a href="#eedb5991913b91ce" class="i property">Certificates</a>.<span class="i">Count</span> != 0))
                {
                    <b>return</b>;
                }
            }
 
            <span class="c">// Generate an error if no cert was found (and this is an encryption attempt).</span>
            <span class="c">// If it is only decryption, then the system will always look in the &#39;My&#39; store anyways, so</span>
            <span class="c">// don&#39;t generate an error if they used wildcards. If they did not use wildcards,</span>
            <span class="c">// then generate an error because they were expecting something specific.</span>
            <b>if</b> ((<span class="r90 r">purpose</span> == <a href="#1ce40ae4097eedd5" class="t t">ResolutionPurpose</a>.<a href="#7fe822f4f96a4ab8" class="i field">Encryption</a>) ||
                (!<a href="../engine/regex.cs.html#d450e739ff28e660" class="t t">WildcardPattern</a>.<a href="../engine/regex.cs.html#f9cf207fdd565080" class="i method">ContainsWildcardCharacters</a>(<a href="#582be86561cf7bd5" class="i field">_identifier</a>)))
            {
                <span class="r91 r">error</span> = <b>new</b> <span class="t">ErrorRecord</span>(
                    <b>new</b> <span class="i">ArgumentException</span>(
                        <b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>,
                            <span class="i">SecuritySupportStrings</span>.<span class="i">NoCertificateFound</span>, <a href="#582be86561cf7bd5" class="i field">_identifier</a>)),
                    <span class="s">&quot;NoCertificateFound&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#9a72a7d3051ac7c5" class="i field">ObjectNotFound</a>, <a href="#582be86561cf7bd5" class="i field">_identifier</a>);
            }
 
            <b>return</b>;
        }
 
        <b>private void</b> <a id="b5fe4bc00cfce3dd" href="../R/b5fe4bc00cfce3dd.html" target="n" data-glyph="76,1" class="i method">ResolveFromBase64Encoding</a>(<a href="#1ce40ae4097eedd5" class="t t">ResolutionPurpose</a> <span id="r92 rd" class="r92 r">purpose</span>, <b>out</b> <a href="../engine/ErrorPackage.cs.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r93 rd" class="r93 r">error</span>)
        {
            <span class="r93 r">error</span> = <b>null</b>;
            <b>int</b> <span id="r94 rd" class="r94 r">startIndex</span>, <span id="r95 rd" class="r95 r">endIndex</span>;
            <b>byte</b>[] <span id="r96 rd" class="r96 r">messageBytes</span> = <b>null</b>;
            <b>try</b>
            {
                <span class="r96 r">messageBytes</span> = <a href="#de6319bf8345395a" class="t t">CmsUtils</a>.<a href="#7d17621616a367f4" class="i method">RemoveAsciiArmor</a>(<a href="#582be86561cf7bd5" class="i field">_identifier</a>, <a href="#de6319bf8345395a" class="t t">CmsUtils</a>.<a href="#9fcdc4f590c90e21" class="i field">BEGIN_CERTIFICATE_SIGIL</a>, <a href="#de6319bf8345395a" class="t t">CmsUtils</a>.<a href="#797d6480f195e8a9" class="i field">END_CERTIFICATE_SIGIL</a>, <b>out</b> <span class="r94 r">startIndex</span>, <b>out</b> <span class="r95 r">endIndex</span>);
            }
            <b>catch</b> (<span class="i">FormatException</span>)
            {
                <span class="c">// Not Base-64 encoded</span>
                <b>return</b>;
            }
 
            <span class="c">// Didn&#39;t have the sigil</span>
            <b>if</b> (<span class="r96 r">messageBytes</span> == <b>null</b>)
            {
                <b>return</b>;
            }
 
            <b>var</b> <span id="r97 rd" class="r97 r">certificatesToProcess</span> = <b>new</b> <span class="i">X509Certificate2Collection</span>();
            <b>try</b>
            {
                <span class="i">X509Certificate2</span> <span id="r98 rd" class="r98 r">newCertificate</span> = <b>new</b> <span class="i">X509Certificate2</span>(<span class="r96 r">messageBytes</span>);
                <span class="r97 r">certificatesToProcess</span>.<span class="i">Add</span>(<span class="r98 r">newCertificate</span>);
            }
            <b>catch</b> (<span class="i">Exception</span>)
            {
                <span class="c">// User call-out, catch-all OK</span>
 
                <span class="c">// Wasn&#39;t certificate data</span>
                <b>return</b>;
            }
 
            <span class="c">// Now validate the certificate</span>
            <a href="#5a14dc1eaaff4329" class="i method">ProcessResolvedCertificates</a>(<span class="r92 r">purpose</span>, <span class="r97 r">certificatesToProcess</span>, <b>out</b> <span class="r93 r">error</span>);
        }
 
        <b>private void</b> <a id="8dc404e499b7aeed" href="../R/8dc404e499b7aeed.html" target="n" data-glyph="76,1" class="i method">ResolveFromPath</a>(<a href="../engine/SessionStatePublic.cs.html#0a202aa6b2d52930" class="t t">SessionState</a> <span id="r99 rd" class="r99 r">sessionState</span>, <a href="#1ce40ae4097eedd5" class="t t">ResolutionPurpose</a> <span id="r100 rd" class="r100 r">purpose</span>, <b>out</b> <a href="../engine/ErrorPackage.cs.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r101 rd" class="r101 r">error</span>)
        {
            <span class="r101 r">error</span> = <b>null</b>;
            <a href="../engine/DataStoreAdapterProvider.cs.html#dd4e1f2f8e73a1dd" class="t t">ProviderInfo</a> <span id="r102 rd" class="r102 r">pathProvider</span> = <b>null</b>;
            <span class="i">Collection</span>&lt;<b>string</b>&gt; <span id="r103 rd" class="r103 r">resolvedPaths</span> = <b>null</b>;
 
            <b>try</b>
            {
                <span class="r103 r">resolvedPaths</span> = <span class="r99 r">sessionState</span>.<a href="../engine/SessionStatePublic.cs.html#3390cfbbdcffb036" class="i property">Path</a>.<a href="../engine/PathInterfaces.cs.html#4931b2e78f6aaef1" class="i method">GetResolvedProviderPathFromPSPath</a>(<a href="#582be86561cf7bd5" class="i field">_identifier</a>, <b>out</b> <span class="r102 r">pathProvider</span>);
            }
            <b>catch</b> (<a href="../utils/SessionStateExceptions.cs.html#3f7cfda90a75013a" class="t t">SessionStateException</a>)
            {
                <span class="c">// If we got an ItemNotFound / etc., then this didn&#39;t represent a valid path.</span>
            }
 
            <span class="c">// If we got a resolved path, try to load certs from that path.</span>
            <b>if</b> ((<span class="r103 r">resolvedPaths</span> != <b>null</b>) &amp;&amp; (<span class="r103 r">resolvedPaths</span>.<span class="i">Count</span> != 0))
            {
                <span class="c">// Ensure the path is from the file system provider</span>
                <b>if</b> (!<b>string</b>.<span class="i">Equals</span>(<span class="r102 r">pathProvider</span>.<a href="../engine/DataStoreAdapterProvider.cs.html#2837d805ea30ef5c" class="i property">Name</a>, <span class="s">&quot;FileSystem&quot;</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
                {
                    <span class="r101 r">error</span> = <b>new</b> <span class="t">ErrorRecord</span>(
                        <b>new</b> <span class="i">ArgumentException</span>(
                            <b>string</b>.<span class="i">Format</span>(<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>,
                                <span class="i">SecuritySupportStrings</span>.<span class="i">CertificatePathMustBeFileSystemPath</span>, <a href="#582be86561cf7bd5" class="i field">_identifier</a>)),
                        <span class="s">&quot;CertificatePathMustBeFileSystemPath&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#9a72a7d3051ac7c5" class="i field">ObjectNotFound</a>, <span class="r102 r">pathProvider</span>);
                    <b>return</b>;
                }
 
                <span class="c">// If this is a directory, add all certificates in it. This will be the primary</span>
                <span class="c">// scenario for decryption via Group Protected PFX files</span>
                <span class="c">// (http://social.technet.microsoft.com/wiki/contents/articles/13922.certificate-pfx-export-and-import-using-ad-ds-account-protection.aspx)</span>
                <span class="i">List</span>&lt;<b>string</b>&gt; <span id="r104 rd" class="r104 r">pathsToAdd</span> = <b>new</b> <span class="i">List</span>&lt;<b>string</b>&gt;();
                <span class="i">List</span>&lt;<b>string</b>&gt; <span id="r105 rd" class="r105 r">pathsToRemove</span> = <b>new</b> <span class="i">List</span>&lt;<b>string</b>&gt;();
                <b>foreach</b> (<b>string</b> <span id="r106 rd" class="r106 r">resolvedPath</span> <b>in</b> <span class="r103 r">resolvedPaths</span>)
                {
                    <b>if</b> (<span class="i n">System</span>.<span class="i">IO</span>.<span class="i">Directory</span>.<span class="i">Exists</span>(<span class="r106 r">resolvedPath</span>))
                    {
                        <span class="c">// It would be nice to limit this to *.pfx, *.cer, etc., but</span>
                        <span class="c">// the crypto APIs support extracting certificates from arbitrary file types.</span>
                        <span class="r104 r">pathsToAdd</span>.<span class="i">AddRange</span>(<span class="i n">System</span>.<span class="i">IO</span>.<span class="i">Directory</span>.<span class="i">GetFiles</span>(<span class="r106 r">resolvedPath</span>));
                        <span class="r105 r">pathsToRemove</span>.<span class="i">Add</span>(<span class="r106 r">resolvedPath</span>);
                    }
                }
 
                <span class="c">// Update resolved paths</span>
                <b>foreach</b> (<b>string</b> <span id="r107 rd" class="r107 r">path</span> <b>in</b> <span class="r104 r">pathsToAdd</span>)
                {
                    <span class="r103 r">resolvedPaths</span>.<span class="i">Add</span>(<span class="r107 r">path</span>);
                }
 
                <b>foreach</b> (<b>string</b> <span id="r108 rd" class="r108 r">path</span> <b>in</b> <span class="r105 r">pathsToRemove</span>)
                {
                    <span class="r103 r">resolvedPaths</span>.<span class="i">Remove</span>(<span class="r108 r">path</span>);
                }
 
                <b>var</b> <span id="r109 rd" class="r109 r">certificatesToProcess</span> = <b>new</b> <span class="i">X509Certificate2Collection</span>();
                <b>foreach</b> (<b>string</b> <span id="r110 rd" class="r110 r">path</span> <b>in</b> <span class="r103 r">resolvedPaths</span>)
                {
                    <span class="i">X509Certificate2</span> <span id="r111 rd" class="r111 r">certificate</span> = <b>null</b>;
 
                    <b>try</b>
                    {
                        <span class="r111 r">certificate</span> = <b>new</b> <span class="i">X509Certificate2</span>(<span class="r110 r">path</span>);
                    }
                    <b>catch</b> (<span class="i">Exception</span>)
                    {
                        <span class="c">// User call-out, catch-all OK</span>
                        <b>continue</b>;
                    }
 
                    <span class="r109 r">certificatesToProcess</span>.<span class="i">Add</span>(<span class="r111 r">certificate</span>);
                }
 
                <a href="#5a14dc1eaaff4329" class="i method">ProcessResolvedCertificates</a>(<span class="r100 r">purpose</span>, <span class="r109 r">certificatesToProcess</span>, <b>out</b> <span class="r101 r">error</span>);
            }
        }
 
        <b>private void</b> <a id="4da3158dba923e0e" href="../R/4da3158dba923e0e.html" target="n" data-glyph="76,1" class="i method">ResolveFromStoreById</a>(<a href="#1ce40ae4097eedd5" class="t t">ResolutionPurpose</a> <span id="r112 rd" class="r112 r">purpose</span>, <b>out</b> <a href="../engine/ErrorPackage.cs.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r113 rd" class="r113 r">error</span>)
        {
            <span class="r113 r">error</span> = <b>null</b>;
            <a href="../engine/regex.cs.html#d450e739ff28e660" class="t t">WildcardPattern</a> <span id="r114 rd" class="r114 r">subjectNamePattern</span> = <a href="../engine/regex.cs.html#d450e739ff28e660" class="t t">WildcardPattern</a>.<a href="../engine/regex.cs.html#03cc3ceece086129" class="i method">Get</a>(<a href="#582be86561cf7bd5" class="i field">_identifier</a>, <a href="../engine/regex.cs.html#4e788ab2470b3632" class="t t">WildcardOptions</a>.<a href="../engine/regex.cs.html#2d0521a6986208d3" class="i field">IgnoreCase</a>);
 
            <b>try</b>
            {
                <b>var</b> <span id="r115 rd" class="r115 r">certificatesToProcess</span> = <b>new</b> <span class="i">X509Certificate2Collection</span>();
 
                <b>using</b> (<b>var</b> <span id="r116 rd" class="r116 r">storeCU</span> = <b>new</b> <span class="i">X509Store</span>(<span class="s">&quot;my&quot;</span>, <span class="i">StoreLocation</span>.<span class="i">CurrentUser</span>))
                {
                    <span class="r116 r">storeCU</span>.<span class="i">Open</span>(<span class="i">OpenFlags</span>.<span class="i">ReadOnly</span>);
                    <span class="i">X509Certificate2Collection</span> <span id="r117 rd" class="r117 r">storeCerts</span> = <span class="r116 r">storeCU</span>.<span class="i">Certificates</span>;
 
                    <b>if</b> (<span class="i">RuntimeInformation</span>.<span class="i">IsOSPlatform</span>(<span class="i">OSPlatform</span>.<span class="i">Windows</span>))
                    {
                        <b>using</b> (<b>var</b> <span id="r118 rd" class="r118 r">storeLM</span> = <b>new</b> <span class="i">X509Store</span>(<span class="s">&quot;my&quot;</span>, <span class="i">StoreLocation</span>.<span class="i">LocalMachine</span>))
                        {
                            <span class="r118 r">storeLM</span>.<span class="i">Open</span>(<span class="i">OpenFlags</span>.<span class="i">ReadOnly</span>);
                            <span class="r117 r">storeCerts</span>.<span class="i">AddRange</span>(<span class="r118 r">storeLM</span>.<span class="i">Certificates</span>);
                        }
                    }
 
                    <span class="r115 r">certificatesToProcess</span>.<span class="i">AddRange</span>(<span class="r117 r">storeCerts</span>.<span class="i">Find</span>(<span class="i">X509FindType</span>.<span class="i">FindByThumbprint</span>, <a href="#582be86561cf7bd5" class="i field">_identifier</a>, <span class="i">validOnly</span>: <b>false</b>));
 
                    <b>if</b> (<span class="r115 r">certificatesToProcess</span>.<span class="i">Count</span> == 0)
                    {
                        <b>foreach</b> (<b>var</b> <span id="r119 rd" class="r119 r">cert</span> <b>in</b> <span class="r117 r">storeCerts</span>)
                        {
                            <b>if</b> (<span class="r114 r">subjectNamePattern</span>.<span class="i">IsMatch</span>(<span class="r119 r">cert</span>.<span class="i">Subject</span>) || <span class="r114 r">subjectNamePattern</span>.<span class="i">IsMatch</span>(<span class="r119 r">cert</span>.<span class="i">GetNameInfo</span>(<span class="i">X509NameType</span>.<span class="i">SimpleName</span>, <span class="i">forIssuer</span>: <b>false</b>)))
                            {
                                <span class="r115 r">certificatesToProcess</span>.<span class="i">Add</span>(<span class="r119 r">cert</span>);
                            }
                        }
                    }
 
                    <a href="#5a14dc1eaaff4329" class="i method">ProcessResolvedCertificates</a>(<span class="r112 r">purpose</span>, <span class="r115 r">certificatesToProcess</span>, <b>out</b> <span class="r113 r">error</span>);
                }
            }
            <b>catch</b> (<a href="../utils/SessionStateExceptions.cs.html#3f7cfda90a75013a" class="t t">SessionStateException</a>)
            {
            }
        }
 
        <b>private void</b> <a id="5a14dc1eaaff4329" href="../R/5a14dc1eaaff4329.html" target="n" data-glyph="76,1" class="i method">ProcessResolvedCertificates</a>(<a href="#1ce40ae4097eedd5" class="t t">ResolutionPurpose</a> <span id="r120 rd" class="r120 r">purpose</span>, <span class="i">X509Certificate2Collection</span> <span id="r121 rd" class="r121 r">certificatesToProcess</span>, <b>out</b> <a href="../engine/ErrorPackage.cs.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r122 rd" class="r122 r">error</span>)
        {
            <span class="r122 r">error</span> = <b>null</b>;
            <span class="i">HashSet</span>&lt;<b>string</b>&gt; <span id="r123 rd" class="r123 r">processedThumbprints</span> = <b>new</b> <span class="i">HashSet</span>&lt;<b>string</b>&gt;();
 
            <b>foreach</b> (<span class="i">X509Certificate2</span> <span id="r124 rd" class="r124 r">certificate</span> <b>in</b> <span class="r121 r">certificatesToProcess</span>)
            {
                <b>if</b> (!<a href="#5c234bd2337db61c" class="t t">SecuritySupport</a>.<a href="#3679796bcda7c0bd" class="i method">CertIsGoodForEncryption</a>(<span class="r124 r">certificate</span>))
                {
                    <span class="c">// If they specified a specific cert, generate an error if it isn&#39;t good</span>
                    <span class="c">// for encryption.</span>
                    <b>if</b> (!<a href="../engine/regex.cs.html#d450e739ff28e660" class="t t">WildcardPattern</a>.<a href="../engine/regex.cs.html#f9cf207fdd565080" class="i method">ContainsWildcardCharacters</a>(<a href="#582be86561cf7bd5" class="i field">_identifier</a>))
                    {
                        <span class="r122 r">error</span> = <b>new</b> <span class="t">ErrorRecord</span>(
                            <b>new</b> <span class="i">ArgumentException</span>(
                                <b>string</b>.<span class="i">Format</span>(
                                    <span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>,
                                    <span class="i">SecuritySupportStrings</span>.<span class="i">CertificateCannotBeUsedForEncryption</span>,
                                    <span class="r124 r">certificate</span>.<span class="i">Thumbprint</span>,
                                    <a href="#f8fe0bbbcccd4eae" class="t t">CertificateFilterInfo</a>.<a href="#a6b79f08d3941139" class="i field">DocumentEncryptionOid</a>)),
                            <span class="s">&quot;CertificateCannotBeUsedForEncryption&quot;</span>,
                            <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#c855a7c43559f12f" class="i field">InvalidData</a>,
                            <span class="r124 r">certificate</span>);
                        <b>return</b>;
                    }
                    <b>else</b>
                    {
                        <b>continue</b>;
                    }
                }
 
                <span class="c">// When decrypting, only look for certs that have the private key</span>
                <b>if</b> (<span class="r120 r">purpose</span> == <a href="#1ce40ae4097eedd5" class="t t">ResolutionPurpose</a>.<a href="#875957d96a754d49" class="i field">Decryption</a>)
                {
                    <b>if</b> (!<span class="r124 r">certificate</span>.<span class="i">HasPrivateKey</span>)
                    {
                        <b>continue</b>;
                    }
                }
 
                <b>if</b> (<span class="r123 r">processedThumbprints</span>.<span class="i">Contains</span>(<span class="r124 r">certificate</span>.<span class="i">Thumbprint</span>))
                {
                    <b>continue</b>;
                }
                <b>else</b>
                {
                    <span class="r123 r">processedThumbprints</span>.<span class="i">Add</span>(<span class="r124 r">certificate</span>.<span class="i">Thumbprint</span>);
                }
 
                <b>if</b> (<span class="r120 r">purpose</span> == <a href="#1ce40ae4097eedd5" class="t t">ResolutionPurpose</a>.<a href="#7fe822f4f96a4ab8" class="i field">Encryption</a>)
                {
                    <span class="c">// Only let wildcards expand to one recipient. Otherwise, data</span>
                    <span class="c">// may be encrypted to the wrong person on accident.</span>
                    <b>if</b> (<a href="#eedb5991913b91ce" class="i property">Certificates</a>.<span class="i">Count</span> &gt; 0)
                    {
                        <span class="r122 r">error</span> = <b>new</b> <span class="t">ErrorRecord</span>(
                            <b>new</b> <span class="i">ArgumentException</span>(
                                <b>string</b>.<span class="i">Format</span>(
                                    <span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>,
                                    <span class="i">SecuritySupportStrings</span>.<span class="i">IdentifierMustReferenceSingleCertificate</span>,
                                    <a href="#582be86561cf7bd5" class="i field">_identifier</a>,
                                    <span class="i">arg1</span>: <span class="s">&quot;To&quot;</span>)),
                            <span class="s">&quot;IdentifierMustReferenceSingleCertificate&quot;</span>,
                            <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#1706f5a396e7e4ad" class="i field">LimitsExceeded</a>,
                            <span class="r121 r">certificatesToProcess</span>);
                        <a href="#eedb5991913b91ce" class="i property">Certificates</a>.<span class="i">Clear</span>();
                        <b>return</b>;
                    }
                }
 
                <a href="#eedb5991913b91ce" class="i property">Certificates</a>.<span class="i">Add</span>(<span class="r124 r">certificate</span>);
            }
        }
    }
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Defines the purpose for resolution of a CmsMessageRecipient.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>public enum</b> <a id="1ce40ae4097eedd5" href="../R/1ce40ae4097eedd5.html" target="n" data-glyph="18,0" class="t t"><span id="430bf4f9c1ac7083">ResolutionPurpose</span></a>
    {
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This message recipient is intended to be used for message encryption.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <a id="7fe822f4f96a4ab8" href="../R/7fe822f4f96a4ab8.html" target="n" data-glyph="24,1" class="i field">Encryption</a>,
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This message recipient is intended to be used for message decryption.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <a id="875957d96a754d49" href="../R/875957d96a754d49.html" target="n" data-glyph="24,1" class="i field">Decryption</a>
    }
 
    <b>internal static class</b> <a id="da6cbabe35a18e75" href="../R/da6cbabe35a18e75.html" target="n" data-glyph="2,0" class="t t">AmsiUtils</a>
    {
        <b>internal static int</b> <a id="14363e737c576de9" href="../R/14363e737c576de9.html" target="n" data-glyph="74,1" class="i method">Init</a>()
        {
            <a href="../utils/assert.cs.html#c04955255430d32f" class="t t">Diagnostics</a>.<a href="../utils/assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<a href="#65c9235a8e7e0551" class="i field">s_amsiContext</a> == <span class="i">IntPtr</span>.<span class="i">Zero</span>, <span class="s">&quot;Init should be called just once&quot;</span>);
 
            <b>lock</b> (<a href="#7b7891444d73556a" class="i field">s_amsiLockObject</a>)
            {
                <b>string</b> <span id="r125 rd" class="r125 r">appName</span>;
                <b>try</b>
                {
                    <span class="r125 r">appName</span> = <b>string</b>.<span class="i">Concat</span>(<span class="s">&quot;PowerShell_&quot;</span>, <span class="i">Environment</span>.<span class="i">ProcessPath</span>, <span class="s">&quot;_&quot;</span>, <a href="../engine/PSVersionInfo.cs.html#be287f9ea52b8d2f" class="t t">PSVersionInfo</a>.<a href="../engine/PSVersionInfo.cs.html#9bd712698246bd53" class="i property">ProductVersion</a>);
                }
                <b>catch</b> (<span class="i">Exception</span>)
                {
                    <span class="c">// Fall back to &#39;Process.ProcessName&#39; in case &#39;Environment.ProcessPath&#39; throws exception.</span>
                    <span class="i">Process</span> <span id="r126 rd" class="r126 r">currentProcess</span> = <span class="i">Process</span>.<span class="i">GetCurrentProcess</span>();
                    <span class="r125 r">appName</span> = <b>string</b>.<span class="i">Concat</span>(<span class="s">&quot;PowerShell_&quot;</span>, <span class="r126 r">currentProcess</span>.<span class="i">ProcessName</span>, <span class="s">&quot;.exe_&quot;</span>, <a href="../engine/PSVersionInfo.cs.html#be287f9ea52b8d2f" class="t t">PSVersionInfo</a>.<a href="../engine/PSVersionInfo.cs.html#9bd712698246bd53" class="i property">ProductVersion</a>);
                }
 
                <span class="i">AppDomain</span>.<span class="i">CurrentDomain</span>.<span class="i">ProcessExit</span> += <span class="i">CurrentDomain_ProcessExit</span>;
 
                <b>var</b> <span id="r127 rd" class="r127 r">hr</span> = <a href="#31aff5f95eefff88" class="t t">AmsiNativeMethods</a>.<span class="i">AmsiInitialize</span>(<span class="r125 r">appName</span>, <b>ref</b> <a href="#65c9235a8e7e0551" class="i field">s_amsiContext</a>);
                <b>if</b> (!<a href="../engine/Utils.cs.html#9185d6ecbaebbec0" class="t t">Utils</a>.<a href="../engine/Utils.cs.html#e1e11f89c723edd9" class="i method">Succeeded</a>(<span class="r127 r">hr</span>))
                {
                    <a href="#9fedba25cb7e6658" class="i field">s_amsiInitFailed</a> = <b>true</b>;
                }
 
                <b>return</b> <span class="r127 r">hr</span>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Scans a string buffer for malware using the Antimalware Scan Interface (AMSI).</span>
        <span class="c">///</span><span class="c"> Caller is responsible for calling AmsiCloseSession when a &quot;session&quot; (script)</span>
        <span class="c">///</span><span class="c"> is complete, and for calling AmsiUninitialize when the runspace is being torn down.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r128 r">content</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The string to be scanned.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r129 r">sourceMetadata</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Information about the source (filename, etc.).</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">AMSI_RESULT_DETECTED if malware was detected in the sample.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal static</b> <a href="#31aff5f95eefff88" class="t t">AmsiNativeMethods</a>.<a href="#d74158b7878b36c0" class="t t">AMSI_RESULT</a> <a id="c87998b44af3ee3d" href="../R/../../0000000000.html" target="n" data-glyph="74,1" class="i method">ScanContent</a>(<b>string</b> <span id="r128 rd" class="r128 r">content</span>, <b>string</b> <span id="r129 rd" class="r129 r">sourceMetadata</span>)
        {
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">UNIX</span>
<span class="e">            return AmsiNativeMethods.AMSI_RESULT.AMSI_RESULT_NOT_DETECTED;
</span><span class="k preprocess">#</span><span class="k preprocess">else</span>
            <b>return</b> <a href="#a435841ebdb66200" class="i method">WinScanContent</a>(<span class="r128 r">content</span>, <span class="r129 r">sourceMetadata</span>, <span class="r130 r">warmUp</span>: <b>false</b>);
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
        }
 
        <b>internal static</b> <a href="#31aff5f95eefff88" class="t t">AmsiNativeMethods</a>.<a href="#d74158b7878b36c0" class="t t">AMSI_RESULT</a> <a id="a435841ebdb66200" href="../R/a435841ebdb66200.html" target="n" data-glyph="74,1" class="i method">WinScanContent</a>(<b>string</b> <span id="r131 rd" class="r131 r">content</span>, <b>string</b> <span id="r132 rd" class="r132 r">sourceMetadata</span>, <b>bool</b> <span id="r130 rd" class="r130 r">warmUp</span>)
        {
            <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r132 r">sourceMetadata</span>))
            {
                <span class="r132 r">sourceMetadata</span> = <b>string</b>.<span class="i">Empty</span>;
            }
 
            <b>const string</b> <span id="r133 rd" class="r133 r">EICAR_STRING</span> = <span class="s">&quot;X5O!P%@AP[4\\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*&quot;</span>;
            <b>if</b> (<a href="../engine/Utils.cs.html#f365eaa75311eda0" class="t t">InternalTestHooks</a>.<a href="../engine/Utils.cs.html#3172c8cec3dfcb9d" class="i field">UseDebugAmsiImplementation</a>)
            {
                <b>if</b> (<span class="r131 r">content</span>.<span class="i">Contains</span>(<span class="r133 r">EICAR_STRING</span>, <span class="i">StringComparison</span>.<span class="i">Ordinal</span>))
                {
                    <b>return</b> <a href="#31aff5f95eefff88" class="t t">AmsiNativeMethods</a>.<a href="#d74158b7878b36c0" class="t t">AMSI_RESULT</a>.<a href="#1f564dba81089b8c" class="i field">AMSI_RESULT_DETECTED</a>;
                }
            }
 
            <span class="c">// If we had a previous initialization failure, just return the neutral result.</span>
            <b>if</b> (<a href="#9fedba25cb7e6658" class="i field">s_amsiInitFailed</a>)
            {
                <b>return</b> <a href="#31aff5f95eefff88" class="t t">AmsiNativeMethods</a>.<a href="#d74158b7878b36c0" class="t t">AMSI_RESULT</a>.<a href="#d9b731eae54c6bc4" class="i field">AMSI_RESULT_NOT_DETECTED</a>;
            }
 
            <b>lock</b> (<a href="#7b7891444d73556a" class="i field">s_amsiLockObject</a>)
            {
                <b>if</b> (<a href="#9fedba25cb7e6658" class="i field">s_amsiInitFailed</a>)
                {
                    <b>return</b> <a href="#31aff5f95eefff88" class="t t">AmsiNativeMethods</a>.<a href="#d74158b7878b36c0" class="t t">AMSI_RESULT</a>.<a href="#d9b731eae54c6bc4" class="i field">AMSI_RESULT_NOT_DETECTED</a>;
                }
 
                <b>try</b>
                {
                    <b>int</b> <span id="r134 rd" class="r134 r">hr</span> = 0;
 
                    <span class="c">// Initialize AntiMalware Scan Interface, if not already initialized.</span>
                    <span class="c">// If we failed to initialize previously, just return the neutral result (&quot;AMSI_RESULT_NOT_DETECTED&quot;)</span>
                    <b>if</b> (<a href="#65c9235a8e7e0551" class="i field">s_amsiContext</a> == <span class="i">IntPtr</span>.<span class="i">Zero</span>)
                    {
                        <span class="r134 r">hr</span> = <a href="#14363e737c576de9" class="i method">Init</a>();
 
                        <b>if</b> (!<a href="../engine/Utils.cs.html#9185d6ecbaebbec0" class="t t">Utils</a>.<a href="../engine/Utils.cs.html#e1e11f89c723edd9" class="i method">Succeeded</a>(<span class="r134 r">hr</span>))
                        {
                            <a href="#9fedba25cb7e6658" class="i field">s_amsiInitFailed</a> = <b>true</b>;
                            <b>return</b> <a href="#31aff5f95eefff88" class="t t">AmsiNativeMethods</a>.<a href="#d74158b7878b36c0" class="t t">AMSI_RESULT</a>.<a href="#d9b731eae54c6bc4" class="i field">AMSI_RESULT_NOT_DETECTED</a>;
                        }
                    }
 
                    <span class="c">// Initialize the session, if one isn&#39;t already started.</span>
                    <span class="c">// If we failed to initialize previously, just return the neutral result (&quot;AMSI_RESULT_NOT_DETECTED&quot;)</span>
                    <b>if</b> (<a href="#61d5a70f36ecd2db" class="i field">s_amsiSession</a> == <span class="i">IntPtr</span>.<span class="i">Zero</span>)
                    {
                        <span class="r134 r">hr</span> = <a href="#31aff5f95eefff88" class="t t">AmsiNativeMethods</a>.<span class="i">AmsiOpenSession</span>(<a href="#65c9235a8e7e0551" class="i field">s_amsiContext</a>, <b>ref</b> <a href="#61d5a70f36ecd2db" class="i field">s_amsiSession</a>);
                        <a href="#ab94e58a1c496e54" class="i field">AmsiInitialized</a> = <b>true</b>;
 
                        <b>if</b> (!<a href="../engine/Utils.cs.html#9185d6ecbaebbec0" class="t t">Utils</a>.<a href="../engine/Utils.cs.html#e1e11f89c723edd9" class="i method">Succeeded</a>(<span class="r134 r">hr</span>))
                        {
                            <a href="#9fedba25cb7e6658" class="i field">s_amsiInitFailed</a> = <b>true</b>;
                            <b>return</b> <a href="#31aff5f95eefff88" class="t t">AmsiNativeMethods</a>.<a href="#d74158b7878b36c0" class="t t">AMSI_RESULT</a>.<a href="#d9b731eae54c6bc4" class="i field">AMSI_RESULT_NOT_DETECTED</a>;
                        }
                    }
 
                    <b>if</b> (<span class="r130 r">warmUp</span>)
                    {
                        <span class="c">// We are warming up the AMSI component in console startup, and that means we initialize AMSI</span>
                        <span class="c">// and create a AMSI session, but don&#39;t really scan anything.</span>
                        <b>return</b> <a href="#31aff5f95eefff88" class="t t">AmsiNativeMethods</a>.<a href="#d74158b7878b36c0" class="t t">AMSI_RESULT</a>.<a href="#d9b731eae54c6bc4" class="i field">AMSI_RESULT_NOT_DETECTED</a>;
                    }
 
                    <a href="#31aff5f95eefff88" class="t t">AmsiNativeMethods</a>.<a href="#d74158b7878b36c0" class="t t">AMSI_RESULT</a> <span id="r135 rd" class="r135 r">result</span> = <a href="#31aff5f95eefff88" class="t t">AmsiNativeMethods</a>.<a href="#d74158b7878b36c0" class="t t">AMSI_RESULT</a>.<a href="#b30ba26542f0680d" class="i field">AMSI_RESULT_CLEAN</a>;
 
                    <span class="c">// Run AMSI content scan</span>
                    <b>unsafe</b>
                    {
                        <b>fixed</b> (<b>char</b>* <span id="r136 rd" class="r136 r">buffer</span> = <span class="r131 r">content</span>)
                        {
                            <b>var</b> <span id="r137 rd" class="r137 r">buffPtr</span> = <b>new</b> <span class="i">IntPtr</span>(<span class="r136 r">buffer</span>);
                            <span class="r134 r">hr</span> = <a href="#31aff5f95eefff88" class="t t">AmsiNativeMethods</a>.<span class="i">AmsiScanBuffer</span>(
                                <a href="#65c9235a8e7e0551" class="i field">s_amsiContext</a>,
                                <span class="r137 r">buffPtr</span>,
                                (<b>uint</b>)(<span class="r131 r">content</span>.<span class="i">Length</span> * <b>sizeof</b>(<b>char</b>)),
                                <span class="r132 r">sourceMetadata</span>,
                                <a href="#61d5a70f36ecd2db" class="i field">s_amsiSession</a>,
                                <b>ref</b> <span class="r135 r">result</span>);
                        }
                    }
 
                    <b>if</b> (!<a href="../engine/Utils.cs.html#9185d6ecbaebbec0" class="t t">Utils</a>.<a href="../engine/Utils.cs.html#e1e11f89c723edd9" class="i method">Succeeded</a>(<span class="r134 r">hr</span>))
                    {
                        <span class="c">// If we got a failure, just return the neutral result (&quot;AMSI_RESULT_NOT_DETECTED&quot;)</span>
                        <b>return</b> <a href="#31aff5f95eefff88" class="t t">AmsiNativeMethods</a>.<a href="#d74158b7878b36c0" class="t t">AMSI_RESULT</a>.<a href="#d9b731eae54c6bc4" class="i field">AMSI_RESULT_NOT_DETECTED</a>;
                    }
 
                    <b>return</b> <span class="r135 r">result</span>;
                }
                <b>catch</b> (<span class="i">DllNotFoundException</span>)
                {
                    <a href="#9fedba25cb7e6658" class="i field">s_amsiInitFailed</a> = <b>true</b>;
                    <b>return</b> <a href="#31aff5f95eefff88" class="t t">AmsiNativeMethods</a>.<a href="#d74158b7878b36c0" class="t t">AMSI_RESULT</a>.<a href="#d9b731eae54c6bc4" class="i field">AMSI_RESULT_NOT_DETECTED</a>;
                }
            }
        }
 
        <b>internal static void</b> <a id="e68b8dc4416bcec3" href="../R/../../0000000000.html" target="n" data-glyph="74,1" class="i method">CurrentDomain_ProcessExit</a>(<b>object</b> <span id="r138 rd" class="r138 r">sender</span>, <span class="i">EventArgs</span> <span id="r139 rd" class="r139 r">e</span>)
        {
            <b>if</b> (<a href="#ab94e58a1c496e54" class="i field">AmsiInitialized</a> &amp;&amp; !<a href="#01daa74d8c4c96d7" class="i field">AmsiUninitializeCalled</a>)
            {
                <a href="#c6fd211cc6f38bf0" class="i method">Uninitialize</a>();
            }
        }
 
        [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Reliability&quot;</span>, <span class="s">&quot;CA2006:UseSafeHandleToEncapsulateNativeResources&quot;</span>)]
        <b>private static</b> <span class="i">IntPtr</span> <a id="65c9235a8e7e0551" href="../R/65c9235a8e7e0551.html" target="n" data-glyph="46,1" class="i field">s_amsiContext</a> = <span class="i">IntPtr</span>.<span class="i">Zero</span>;
 
        [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Reliability&quot;</span>, <span class="s">&quot;CA2006:UseSafeHandleToEncapsulateNativeResources&quot;</span>)]
        <b>private static</b> <span class="i">IntPtr</span> <a id="61d5a70f36ecd2db" href="../R/61d5a70f36ecd2db.html" target="n" data-glyph="46,1" class="i field">s_amsiSession</a> = <span class="i">IntPtr</span>.<span class="i">Zero</span>;
 
        <b>private static bool</b> <a id="9fedba25cb7e6658" href="../R/9fedba25cb7e6658.html" target="n" data-glyph="46,1" class="i field">s_amsiInitFailed</a> = <b>false</b>;
        <b>private static readonly object</b> <a id="7b7891444d73556a" href="../R/7b7891444d73556a.html" target="n" data-glyph="46,1" class="i field">s_amsiLockObject</a> = <b>new</b> <b>object</b>();
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Reset the AMSI session (used to track related script invocations)</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal static void</b> <a id="82cfb9ada6fe6e60" href="../R/82cfb9ada6fe6e60.html" target="n" data-glyph="74,1" class="i method">CloseSession</a>()
        {
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">UNIX</span>
            <a href="#576484736bbc3a21" class="i method">WinCloseSession</a>();
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
        }
 
        <b>internal static void</b> <a id="576484736bbc3a21" href="../R/576484736bbc3a21.html" target="n" data-glyph="74,1" class="i method">WinCloseSession</a>()
        {
            <b>if</b> (!<a href="#9fedba25cb7e6658" class="i field">s_amsiInitFailed</a>)
            {
                <b>if</b> ((<a href="#65c9235a8e7e0551" class="i field">s_amsiContext</a> != <span class="i">IntPtr</span>.<span class="i">Zero</span>) &amp;&amp; (<a href="#61d5a70f36ecd2db" class="i field">s_amsiSession</a> != <span class="i">IntPtr</span>.<span class="i">Zero</span>))
                {
                    <b>lock</b> (<a href="#7b7891444d73556a" class="i field">s_amsiLockObject</a>)
                    {
                        <span class="c">// Clean up the session if one was open.</span>
                        <b>if</b> ((<a href="#65c9235a8e7e0551" class="i field">s_amsiContext</a> != <span class="i">IntPtr</span>.<span class="i">Zero</span>) &amp;&amp; (<a href="#61d5a70f36ecd2db" class="i field">s_amsiSession</a> != <span class="i">IntPtr</span>.<span class="i">Zero</span>))
                        {
                            <a href="#31aff5f95eefff88" class="t t">AmsiNativeMethods</a>.<span class="i">AmsiCloseSession</span>(<a href="#65c9235a8e7e0551" class="i field">s_amsiContext</a>, <a href="#61d5a70f36ecd2db" class="i field">s_amsiSession</a>);
                            <a href="#61d5a70f36ecd2db" class="i field">s_amsiSession</a> = <span class="i">IntPtr</span>.<span class="i">Zero</span>;
                        }
                    }
                }
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Uninitialize the AMSI interface.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal static void</b> <a id="c6fd211cc6f38bf0" href="../R/c6fd211cc6f38bf0.html" target="n" data-glyph="74,1" class="i method">Uninitialize</a>()
        {
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">UNIX</span>
            <a href="#94a21169336b0199" class="i method">WinUninitialize</a>();
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
        }
 
        <b>internal static void</b> <a id="94a21169336b0199" href="../R/94a21169336b0199.html" target="n" data-glyph="74,1" class="i method">WinUninitialize</a>()
        {
            <a href="#01daa74d8c4c96d7" class="i field">AmsiUninitializeCalled</a> = <b>true</b>;
            <b>if</b> (!<a href="#9fedba25cb7e6658" class="i field">s_amsiInitFailed</a>)
            {
                <b>lock</b> (<a href="#7b7891444d73556a" class="i field">s_amsiLockObject</a>)
                {
                    <b>if</b> (<a href="#65c9235a8e7e0551" class="i field">s_amsiContext</a> != <span class="i">IntPtr</span>.<span class="i">Zero</span>)
                    {
                        <a href="#82cfb9ada6fe6e60" class="i method">CloseSession</a>();
 
                        <span class="c">// Unregister the event handler.</span>
                        <span class="i">AppDomain</span>.<span class="i">CurrentDomain</span>.<span class="i">ProcessExit</span> -= <span class="i">CurrentDomain_ProcessExit</span>;
 
                        <span class="c">// Uninitialize the AMSI interface.</span>
                        <a href="#97a351230f1fa056" class="i field">AmsiCleanedUp</a> = <b>true</b>;
                        <a href="#31aff5f95eefff88" class="t t">AmsiNativeMethods</a>.<span class="i">AmsiUninitialize</span>(<a href="#65c9235a8e7e0551" class="i field">s_amsiContext</a>);
                        <a href="#65c9235a8e7e0551" class="i field">s_amsiContext</a> = <span class="i">IntPtr</span>.<span class="i">Zero</span>;
                    }
                }
            }
        }
 
        <b>public static bool</b> <a id="01daa74d8c4c96d7" href="../R/01daa74d8c4c96d7.html" target="n" data-glyph="42,1" class="i field">AmsiUninitializeCalled</a> = <b>false</b>;
        <b>public static bool</b> <a id="ab94e58a1c496e54" href="../R/ab94e58a1c496e54.html" target="n" data-glyph="42,1" class="i field">AmsiInitialized</a> = <b>false</b>;
        <b>public static bool</b> <a id="97a351230f1fa056" href="../R/97a351230f1fa056.html" target="n" data-glyph="42,1" class="i field">AmsiCleanedUp</a> = <b>false</b>;
 
        <b>internal static class</b> <a id="31aff5f95eefff88" href="../R/31aff5f95eefff88.html" target="n" data-glyph="2,1" class="t t">AmsiNativeMethods</a>
        {
            <b>internal enum</b> <a id="d74158b7878b36c0" href="../R/d74158b7878b36c0.html" target="n" data-glyph="20,2" class="t t"><span id="cc4e58338a21095a">AMSI_RESULT</span></a>
            {
                <span class="c">///</span><span class="c"> AMSI_RESULT_CLEAN -&gt; 0</span>
                <a id="b30ba26542f0680d" href="../R/b30ba26542f0680d.html" target="n" data-glyph="24,3" class="i field">AMSI_RESULT_CLEAN</a> = 0,
 
                <span class="c">///</span><span class="c"> AMSI_RESULT_NOT_DETECTED -&gt; 1</span>
                <a id="d9b731eae54c6bc4" href="../R/d9b731eae54c6bc4.html" target="n" data-glyph="24,3" class="i field">AMSI_RESULT_NOT_DETECTED</a> = 1,
 
                <span class="c">///</span><span class="c"> Certain policies set by administrator blocked this content on this machine</span>
                <a id="8f189e05dc8dc3d3" href="../R/8f189e05dc8dc3d3.html" target="n" data-glyph="24,3" class="i field">AMSI_RESULT_BLOCKED_BY_ADMIN_BEGIN</a> = 0x4000,
                <a id="7395ffb6f1c47aea" href="../R/7395ffb6f1c47aea.html" target="n" data-glyph="24,3" class="i field">AMSI_RESULT_BLOCKED_BY_ADMIN_END</a> = 0x4fff,
 
                <span class="c">///</span><span class="c"> AMSI_RESULT_DETECTED -&gt; 32768</span>
                <a id="1f564dba81089b8c" href="../R/1f564dba81089b8c.html" target="n" data-glyph="24,3" class="i field">AMSI_RESULT_DETECTED</a> = 32768,
            }
 
            <span class="c">///</span><span class="c"> Return Type: HRESULT-&gt;LONG-&gt;int</span>
            <span class="c">///</span><span class="c">appName: LPCWSTR-&gt;WCHAR*</span>
            <span class="c">///</span><span class="c">amsiContext: HAMSICONTEXT*</span>
            [<span class="i">DefaultDllImportSearchPathsAttribute</span>(<span class="i">DllImportSearchPath</span>.<span class="i">System32</span>)]
            [<span class="i">DllImportAttribute</span>(<span class="s">&quot;amsi.dll&quot;</span>, <span class="i">EntryPoint</span> = <span class="s">&quot;AmsiInitialize&quot;</span>, <span class="i">CallingConvention</span> = <span class="i">CallingConvention</span>.<span class="i">StdCall</span>)]
            <b>internal static extern int</b> <a id="7690f8ab31710a64" href="../R/../../0000000000.html" target="n" data-glyph="74,2" class="i method">AmsiInitialize</a>(
                [<span class="i">InAttribute</span>()][<span class="i">MarshalAsAttribute</span>(<span class="i">UnmanagedType</span>.<span class="i">LPWStr</span>)] <b>string</b> <span id="r140 rd" class="r140 r">appName</span>, <b>ref</b> <span class="i n">System</span>.<span class="i">IntPtr</span> <span id="r141 rd" class="r141 r">amsiContext</span>);
 
            <span class="c">///</span><span class="c"> Return Type: void</span>
            <span class="c">///</span><span class="c">amsiContext: HAMSICONTEXT-&gt;HAMSICONTEXT__*</span>
            [<span class="i">DefaultDllImportSearchPathsAttribute</span>(<span class="i">DllImportSearchPath</span>.<span class="i">System32</span>)]
            [<span class="i">DllImportAttribute</span>(<span class="s">&quot;amsi.dll&quot;</span>, <span class="i">EntryPoint</span> = <span class="s">&quot;AmsiUninitialize&quot;</span>, <span class="i">CallingConvention</span> = <span class="i">CallingConvention</span>.<span class="i">StdCall</span>)]
            <b>internal static extern void</b> <a id="c8b4969334ecfc52" href="../R/../../0000000000.html" target="n" data-glyph="74,2" class="i method">AmsiUninitialize</a>(<span class="i n">System</span>.<span class="i">IntPtr</span> <span id="r142 rd" class="r142 r">amsiContext</span>);
 
            <span class="c">///</span><span class="c"> Return Type: HRESULT-&gt;LONG-&gt;int</span>
            <span class="c">///</span><span class="c">amsiContext: HAMSICONTEXT-&gt;HAMSICONTEXT__*</span>
            <span class="c">///</span><span class="c">amsiSession: HAMSISESSION*</span>
            [<span class="i">DefaultDllImportSearchPathsAttribute</span>(<span class="i">DllImportSearchPath</span>.<span class="i">System32</span>)]
            [<span class="i">DllImportAttribute</span>(<span class="s">&quot;amsi.dll&quot;</span>, <span class="i">EntryPoint</span> = <span class="s">&quot;AmsiOpenSession&quot;</span>, <span class="i">CallingConvention</span> = <span class="i">CallingConvention</span>.<span class="i">StdCall</span>)]
            <b>internal static extern int</b> <a id="46d13b8b18406f38" href="../R/../../0000000000.html" target="n" data-glyph="74,2" class="i method">AmsiOpenSession</a>(<span class="i n">System</span>.<span class="i">IntPtr</span> <span id="r143 rd" class="r143 r">amsiContext</span>, <b>ref</b> <span class="i n">System</span>.<span class="i">IntPtr</span> <span id="r144 rd" class="r144 r">amsiSession</span>);
 
            <span class="c">///</span><span class="c"> Return Type: void</span>
            <span class="c">///</span><span class="c">amsiContext: HAMSICONTEXT-&gt;HAMSICONTEXT__*</span>
            <span class="c">///</span><span class="c">amsiSession: HAMSISESSION-&gt;HAMSISESSION__*</span>
            [<span class="i">DefaultDllImportSearchPathsAttribute</span>(<span class="i">DllImportSearchPath</span>.<span class="i">System32</span>)]
            [<span class="i">DllImportAttribute</span>(<span class="s">&quot;amsi.dll&quot;</span>, <span class="i">EntryPoint</span> = <span class="s">&quot;AmsiCloseSession&quot;</span>, <span class="i">CallingConvention</span> = <span class="i">CallingConvention</span>.<span class="i">StdCall</span>)]
            <b>internal static extern void</b> <a id="993821728469e691" href="../R/../../0000000000.html" target="n" data-glyph="74,2" class="i method">AmsiCloseSession</a>(<span class="i n">System</span>.<span class="i">IntPtr</span> <span id="r145 rd" class="r145 r">amsiContext</span>, <span class="i n">System</span>.<span class="i">IntPtr</span> <span id="r146 rd" class="r146 r">amsiSession</span>);
 
            <span class="c">///</span><span class="c"> Return Type: HRESULT-&gt;LONG-&gt;int</span>
            <span class="c">///</span><span class="c">amsiContext: HAMSICONTEXT-&gt;HAMSICONTEXT__*</span>
            <span class="c">///</span><span class="c">buffer: PVOID-&gt;void*</span>
            <span class="c">///</span><span class="c">length: ULONG-&gt;unsigned int</span>
            <span class="c">///</span><span class="c">contentName: LPCWSTR-&gt;WCHAR*</span>
            <span class="c">///</span><span class="c">amsiSession: HAMSISESSION-&gt;HAMSISESSION__*</span>
            <span class="c">///</span><span class="c">result: AMSI_RESULT*</span>
            [<span class="i">DefaultDllImportSearchPathsAttribute</span>(<span class="i">DllImportSearchPath</span>.<span class="i">System32</span>)]
            [<span class="i">DllImportAttribute</span>(<span class="s">&quot;amsi.dll&quot;</span>, <span class="i">EntryPoint</span> = <span class="s">&quot;AmsiScanBuffer&quot;</span>, <span class="i">CallingConvention</span> = <span class="i">CallingConvention</span>.<span class="i">StdCall</span>)]
            <b>internal static extern int</b> <a id="e0e32e7c51c42d34" href="../R/../../0000000000.html" target="n" data-glyph="74,2" class="i method">AmsiScanBuffer</a>(
                <span class="i n">System</span>.<span class="i">IntPtr</span> <span id="r147 rd" class="r147 r">amsiContext</span>, <span class="i n">System</span>.<span class="i">IntPtr</span> <span id="r148 rd" class="r148 r">buffer</span>, <b>uint</b> <span id="r149 rd" class="r149 r">length</span>,
                [<span class="i">InAttribute</span>()][<span class="i">MarshalAsAttribute</span>(<span class="i">UnmanagedType</span>.<span class="i">LPWStr</span>)] <b>string</b> <span id="r150 rd" class="r150 r">contentName</span>, <span class="i n">System</span>.<span class="i">IntPtr</span> <span id="r151 rd" class="r151 r">amsiSession</span>, <b>ref</b> <a href="#d74158b7878b36c0" class="t t">AMSI_RESULT</a> <span id="r152 rd" class="r152 r">result</span>);
 
            <span class="c">///</span><span class="c"> Return Type: HRESULT-&gt;LONG-&gt;int</span>
            <span class="c">///</span><span class="c">amsiContext: HAMSICONTEXT-&gt;HAMSICONTEXT__*</span>
            <span class="c">///</span><span class="c">string: LPCWSTR-&gt;WCHAR*</span>
            <span class="c">///</span><span class="c">contentName: LPCWSTR-&gt;WCHAR*</span>
            <span class="c">///</span><span class="c">amsiSession: HAMSISESSION-&gt;HAMSISESSION__*</span>
            <span class="c">///</span><span class="c">result: AMSI_RESULT*</span>
            [<span class="i">DefaultDllImportSearchPathsAttribute</span>(<span class="i">DllImportSearchPath</span>.<span class="i">System32</span>)]
            [<span class="i">DllImportAttribute</span>(<span class="s">&quot;amsi.dll&quot;</span>, <span class="i">EntryPoint</span> = <span class="s">&quot;AmsiScanString&quot;</span>, <span class="i">CallingConvention</span> = <span class="i">CallingConvention</span>.<span class="i">StdCall</span>)]
            <b>internal static extern int</b> <a id="644e7c8576a11d49" href="../R/../../0000000000.html" target="n" data-glyph="74,2" class="i method">AmsiScanString</a>(
                <span class="i n">System</span>.<span class="i">IntPtr</span> <span id="r153 rd" class="r153 r">amsiContext</span>, [<span class="i">InAttribute</span>()][<span class="i">MarshalAsAttribute</span>(<span class="i">UnmanagedType</span>.<span class="i">LPWStr</span>)] <b>string</b> <span id="r154 rd" class="r154 r">@string</span>,
                [<span class="i">InAttribute</span>()][<span class="i">MarshalAsAttribute</span>(<span class="i">UnmanagedType</span>.<span class="i">LPWStr</span>)] <b>string</b> <span id="r155 rd" class="r155 r">contentName</span>, <span class="i n">System</span>.<span class="i">IntPtr</span> <span id="r156 rd" class="r156 r">amsiSession</span>, <b>ref</b> <a href="#d74158b7878b36c0" class="t t">AMSI_RESULT</a> <span id="r157 rd" class="r157 r">result</span>);
        }
    }
}
<span class="k preprocess">#</span><span class="k preprocess">pragma</span> <span class="k preprocess">warning</span> <span class="k preprocess">restore</span> 56523
</pre></td></tr></table></div></body></html>
