<!DOCTYPE html>
<html><head><title>CryptoUtils.cs</title><link rel="stylesheet" href="../../styles.css"><script src="../../scripts.js"></script></head>
<body class="cB" onload="i(1152);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#System.Management.Automation/utils/CryptoUtils.cs" target="_top">utils\CryptoUtils.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#System.Management.Automation" target="_top">src\System.Management.Automation\System.Management.Automation.csproj</a> (System.Management.Automation)</td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation.</span>
<span class="c">// Licensed under the MIT License.</span>
 
<b>using</b> <span class="i n">System</span>.<span class="i n">Diagnostics</span>.<span class="i">CodeAnalysis</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">IO</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Linq</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Remoting</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Runtime</span>.<span class="i">InteropServices</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Runtime</span>.<span class="i">Serialization</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Security</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Security</span>.<span class="i">Cryptography</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Text</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Threading</span>;
 
<b>using</b> <span class="t">Dbg</span> = <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="assert.cs.html#c04955255430d32f" class="t t">Diagnostics</a>;
 
<b>namespace</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Internal</span>
{
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> This class provides the converters for all Native CAPI key blob formats.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>internal static class</b> <a id="a33701b45fd3ae40" href="../R/a33701b45fd3ae40.html" target="n" data-glyph="2,0" class="t t">PSCryptoNativeConverter</a>
    {
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Constants
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The blob version is fixed.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public const uint</b> <a id="bc68314f992fc438" href="../R/bc68314f992fc438.html" target="n" data-glyph="6,1" class="i field">CUR_BLOB_VERSION</a> = 0x00000002;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> RSA Key.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public const uint</b> <a id="75f9ca006c77981f" href="../R/75f9ca006c77981f.html" target="n" data-glyph="6,1" class="i field">CALG_RSA_KEYX</a> = 0x000000a4;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> AES 256 symmetric key.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public const uint</b> <a id="cfb721dbc225a0f3" href="../R/cfb721dbc225a0f3.html" target="n" data-glyph="6,1" class="i field">CALG_AES_256</a> = 0x00000010;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Option for exporting public key blob.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public const uint</b> <a id="6198b1a8cdd0603c" href="../R/6198b1a8cdd0603c.html" target="n" data-glyph="6,1" class="i field">PUBLICKEYBLOB</a> = 0x00000006;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summmary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> PUBLICKEYBLOB header length.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public const int</b> <a id="a2eacf377cd20e58" href="../R/a2eacf377cd20e58.html" target="n" data-glyph="6,1" class="i field">PUBLICKEYBLOB_HEADER_LEN</a> = 20;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Option for exporting a session key.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public const uint</b> <a id="d9a3ba40490aea9a" href="../R/d9a3ba40490aea9a.html" target="n" data-glyph="6,1" class="i field">SIMPLEBLOB</a> = 0x00000001;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summmary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> SIMPLEBLOB header length.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public const int</b> <a id="4f38738c6132ba0b" href="../R/4f38738c6132ba0b.html" target="n" data-glyph="6,1" class="i field">SIMPLEBLOB_HEADER_LEN</a> = 12;
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Constants
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Functions
 
        <b>private static int</b> <a id="a8b9a0c89a131b32" href="../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">ToInt32LE</a>(<b>byte</b>[] <span id="r0 rd" class="r0 r">bytes</span>, <b>int</b> <span id="r1 rd" class="r1 r">offset</span>)
        {
            <b>return</b> (<span class="r0 r">bytes</span>[<span class="r1 r">offset</span> + 3] &lt;&lt; 24) | (<span class="r0 r">bytes</span>[<span class="r1 r">offset</span> + 2] &lt;&lt; 16) | (<span class="r0 r">bytes</span>[<span class="r1 r">offset</span> + 1] &lt;&lt; 8) | <span class="r0 r">bytes</span>[<span class="r1 r">offset</span>];
        }
 
        <b>private static uint</b> <a id="ab4c5c54de6f97c1" href="../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">ToUInt32LE</a>(<b>byte</b>[] <span id="r2 rd" class="r2 r">bytes</span>, <b>int</b> <span id="r3 rd" class="r3 r">offset</span>)
        {
            <b>return</b> (<b>uint</b>)((<span class="r2 r">bytes</span>[<span class="r3 r">offset</span> + 3] &lt;&lt; 24) | (<span class="r2 r">bytes</span>[<span class="r3 r">offset</span> + 2] &lt;&lt; 16) | (<span class="r2 r">bytes</span>[<span class="r3 r">offset</span> + 1] &lt;&lt; 8) | <span class="r2 r">bytes</span>[<span class="r3 r">offset</span>]);
        }
 
        <b>private static byte</b>[] <a id="b58be0eb6909da2f" href="../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">GetBytesLE</a>(<b>int</b> <span id="r4 rd" class="r4 r">val</span>)
        {
            <b>return</b> <b>new</b>[] {
                (<b>byte</b>)(<span class="r4 r">val</span> &amp; 0xff),
                (<b>byte</b>)((<span class="r4 r">val</span> &gt;&gt; 8) &amp; 0xff),
                (<b>byte</b>)((<span class="r4 r">val</span> &gt;&gt; 16) &amp; 0xff),
                (<b>byte</b>)((<span class="r4 r">val</span> &gt;&gt; 24) &amp; 0xff)
            };
        }
 
        <b>private static byte</b>[] <a id="db465a4bb7549555" href="../R/db465a4bb7549555.html" target="n" data-glyph="76,1" class="i method">CreateReverseByteArray</a>(<b>byte</b>[] <span id="r5 rd" class="r5 r">data</span>)
        {
            <b>byte</b>[] <span id="r6 rd" class="r6 r">reverseData</span> = <b>new</b> <b>byte</b>[<span class="r5 r">data</span>.<span class="i">Length</span>];
            <span class="i">Array</span>.<span class="i">Copy</span>(<span class="r5 r">data</span>, <span class="r6 r">reverseData</span>, <span class="r5 r">data</span>.<span class="i">Length</span>);
            <span class="i">Array</span>.<span class="i">Reverse</span>(<span class="r6 r">reverseData</span>);
            <b>return</b> <span class="r6 r">reverseData</span>;
        }
 
        <b>internal static</b> <span class="i">RSA</span> <a id="4ce00bfa74c3a546" href="../R/4ce00bfa74c3a546.html" target="n" data-glyph="74,1" class="i method">FromCapiPublicKeyBlob</a>(<b>byte</b>[] <span id="r7 rd" class="r7 r">blob</span>)
        {
            <b>return</b> <a href="#3afd395d9f21fce3" class="i method">FromCapiPublicKeyBlob</a>(<span class="r7 r">blob</span>, 0);
        }
 
        <b>private static</b> <span class="i">RSA</span> <a id="3afd395d9f21fce3" href="../R/3afd395d9f21fce3.html" target="n" data-glyph="76,1" class="i method">FromCapiPublicKeyBlob</a>(<b>byte</b>[] <span id="r8 rd" class="r8 r">blob</span>, <b>int</b> <span id="r9 rd" class="r9 r">offset</span>)
        {
            <b>if</b> (<span class="r8 r">blob</span> == <b>null</b>)
            {
                <b>throw</b> <b>new</b> <span class="i">ArgumentNullException</span>(<b>nameof</b>(<span class="r8 r">blob</span>));
            }
 
            <b>if</b> (<span class="r9 r">offset</span> &gt; <span class="r8 r">blob</span>.<span class="i">Length</span>)
            {
                <b>throw</b> <b>new</b> <span class="i">ArgumentException</span>(<span class="i">SecuritySupportStrings</span>.<span class="i">InvalidOffset</span>);
            }
 
            <b>var</b> <span id="r10 rd" class="r10 r">rsap</span> = <a href="#5d5c087fd7ffd917" class="i method">GetParametersFromCapiPublicKeyBlob</a>(<span class="r8 r">blob</span>, <span class="r9 r">offset</span>);
 
            <b>try</b>
            {
                <span class="i">RSA</span> <span id="r11 rd" class="r11 r">rsa</span> = <span class="i">RSA</span>.<span class="i">Create</span>();
                <span class="r11 r">rsa</span>.<span class="i">ImportParameters</span>(<span class="r10 r">rsap</span>);
                <b>return</b> <span class="r11 r">rsa</span>;
            }
            <b>catch</b> (<span class="i">Exception</span> <span id="r12 rd" class="r12 r">ex</span>)
            {
                <b>throw</b> <b>new</b> <span class="i">CryptographicException</span>(<span class="i">SecuritySupportStrings</span>.<span class="i">CannotImportPublicKey</span>, <span class="r12 r">ex</span>);
            }
        }
 
        <b>private static</b> <span class="i">RSAParameters</span> <a id="5d5c087fd7ffd917" href="../R/5d5c087fd7ffd917.html" target="n" data-glyph="76,1" class="i method">GetParametersFromCapiPublicKeyBlob</a>(<b>byte</b>[] <span id="r13 rd" class="r13 r">blob</span>, <b>int</b> <span id="r14 rd" class="r14 r">offset</span>)
        {
            <b>if</b> (<span class="r13 r">blob</span> == <b>null</b>)
            {
                <b>throw</b> <b>new</b> <span class="i">ArgumentNullException</span>(<b>nameof</b>(<span class="r13 r">blob</span>));
            }
 
            <b>if</b> (<span class="r14 r">offset</span> &gt; <span class="r13 r">blob</span>.<span class="i">Length</span>)
            {
                <b>throw</b> <b>new</b> <span class="i">ArgumentException</span>(<span class="i">SecuritySupportStrings</span>.<span class="i">InvalidOffset</span>);
            }
 
            <b>if</b> (<span class="r13 r">blob</span>.<span class="i">Length</span> &lt; <a href="#a2eacf377cd20e58" class="i field">PUBLICKEYBLOB_HEADER_LEN</a>)
            {
                <b>throw</b> <b>new</b> <span class="i">ArgumentException</span>(<span class="i">SecuritySupportStrings</span>.<span class="i">InvalidPublicKey</span>);
            }
 
            <b>try</b>
            {
                <b>if</b> ((<span class="r13 r">blob</span>[<span class="r14 r">offset</span>] != <a href="#6198b1a8cdd0603c" class="i field">PUBLICKEYBLOB</a>) ||            <span class="c">// PUBLICKEYBLOB (0x06)</span>
                    (<span class="r13 r">blob</span>[<span class="r14 r">offset</span> + 1] != <a href="#bc68314f992fc438" class="i field">CUR_BLOB_VERSION</a>) ||       <span class="c">// Version (0x02)</span>
                    (<span class="r13 r">blob</span>[<span class="r14 r">offset</span> + 2] != 0x00) ||                   <span class="c">// Reserved (word)</span>
                    (<span class="r13 r">blob</span>[<span class="r14 r">offset</span> + 3] != 0x00) ||
                    (<span class="i">ToUInt32LE</span>(<span class="r13 r">blob</span>, <span class="r14 r">offset</span> + 8) != 0x31415352))   <span class="c">// DWORD magic = RSA1</span>
                {
                    <b>throw</b> <b>new</b> <span class="i">CryptographicException</span>(<span class="i">SecuritySupportStrings</span>.<span class="i">InvalidPublicKey</span>);
                }
 
                <span class="c">// DWORD bitlen</span>
                <b>int</b> <span id="r15 rd" class="r15 r">bitLen</span> = <span class="i">ToInt32LE</span>(<span class="r13 r">blob</span>, <span class="r14 r">offset</span> + 12);
 
                <span class="c">// DWORD public exponent</span>
                <span class="i">RSAParameters</span> <span id="r16 rd" class="r16 r">rsap</span> = <b>new</b> <span class="i">RSAParameters</span>();
                <span class="r16 r">rsap</span>.<span class="i">Exponent</span> = <b>new</b> <b>byte</b>[3];
                <span class="r16 r">rsap</span>.<span class="i">Exponent</span>[0] = <span class="r13 r">blob</span>[<span class="r14 r">offset</span> + 18];
                <span class="r16 r">rsap</span>.<span class="i">Exponent</span>[1] = <span class="r13 r">blob</span>[<span class="r14 r">offset</span> + 17];
                <span class="r16 r">rsap</span>.<span class="i">Exponent</span>[2] = <span class="r13 r">blob</span>[<span class="r14 r">offset</span> + 16];
 
                <b>int</b> <span id="r17 rd" class="r17 r">pos</span> = <span class="r14 r">offset</span> + 20;
                <b>int</b> <span id="r18 rd" class="r18 r">byteLen</span> = (<span class="r15 r">bitLen</span> &gt;&gt; 3);
                <span class="r16 r">rsap</span>.<span class="i">Modulus</span> = <b>new</b> <b>byte</b>[<span class="r18 r">byteLen</span>];
                <span class="i">Buffer</span>.<span class="i">BlockCopy</span>(<span class="r13 r">blob</span>, <span class="r17 r">pos</span>, <span class="r16 r">rsap</span>.<span class="i">Modulus</span>, 0, <span class="r18 r">byteLen</span>);
                <span class="i">Array</span>.<span class="i">Reverse</span>(<span class="r16 r">rsap</span>.<span class="i">Modulus</span>);
 
                <b>return</b> <span class="r16 r">rsap</span>;
            }
            <b>catch</b> (<span class="i">Exception</span> <span id="r19 rd" class="r19 r">ex</span>)
            {
                <b>throw</b> <b>new</b> <span class="i">CryptographicException</span>(<span class="i">SecuritySupportStrings</span>.<span class="i">InvalidPublicKey</span>, <span class="r19 r">ex</span>);
            }
        }
 
        <b>internal static byte</b>[] <a id="7077f6a67d065465" href="../R/7077f6a67d065465.html" target="n" data-glyph="74,1" class="i method">ToCapiPublicKeyBlob</a>(<span class="i">RSA</span> <span id="r20 rd" class="r20 r">rsa</span>)
        {
            <b>if</b> (<span class="r20 r">rsa</span> == <b>null</b>)
            {
                <b>throw</b> <b>new</b> <span class="i">ArgumentNullException</span>(<b>nameof</b>(<span class="r20 r">rsa</span>));
            }
 
            <span class="i">RSAParameters</span> <span id="r21 rd" class="r21 r">p</span> = <span class="r20 r">rsa</span>.<span class="i">ExportParameters</span>(<b>false</b>);
            <b>int</b> <span id="r22 rd" class="r22 r">keyLength</span> = <span class="r21 r">p</span>.<span class="i">Modulus</span>.<span class="i">Length</span>;   <span class="c">// in bytes</span>
            <b>byte</b>[] <span id="r23 rd" class="r23 r">blob</span> = <b>new</b> <b>byte</b>[<a href="#a2eacf377cd20e58" class="i field">PUBLICKEYBLOB_HEADER_LEN</a> + <span class="r22 r">keyLength</span>];
 
            <span class="r23 r">blob</span>[0] = (<b>byte</b>)<a href="#6198b1a8cdd0603c" class="i field">PUBLICKEYBLOB</a>;      <span class="c">// Type - PUBLICKEYBLOB (0x06)</span>
            <span class="r23 r">blob</span>[1] = (<b>byte</b>)<a href="#bc68314f992fc438" class="i field">CUR_BLOB_VERSION</a>;   <span class="c">// Version - Always CUR_BLOB_VERSION (0x02)</span>
            <span class="c">// [2], [3]                         // RESERVED - Always 0</span>
            <span class="r23 r">blob</span>[5] = (<b>byte</b>)<a href="#75f9ca006c77981f" class="i field">CALG_RSA_KEYX</a>;      <span class="c">// ALGID - Always 00 a4 00 00 (for CALG_RSA_KEYX)</span>
            <span class="r23 r">blob</span>[8] = 0x52;                     <span class="c">// Magic - RSA1 (ASCII in hex)</span>
            <span class="r23 r">blob</span>[9] = 0x53;
            <span class="r23 r">blob</span>[10] = 0x41;
            <span class="r23 r">blob</span>[11] = 0x31;
 
            <b>byte</b>[] <span id="r24 rd" class="r24 r">bitlen</span> = <span class="i">GetBytesLE</span>(<span class="r22 r">keyLength</span> &lt;&lt; 3);
            <span class="r23 r">blob</span>[12] = <span class="r24 r">bitlen</span>[0];               <span class="c">// bitlen</span>
            <span class="r23 r">blob</span>[13] = <span class="r24 r">bitlen</span>[1];
            <span class="r23 r">blob</span>[14] = <span class="r24 r">bitlen</span>[2];
            <span class="r23 r">blob</span>[15] = <span class="r24 r">bitlen</span>[3];
 
            <span class="c">// public exponent (DWORD)</span>
            <b>int</b> <span id="r25 rd" class="r25 r">pos</span> = 16;
            <b>int</b> <span id="r26 rd" class="r26 r">n</span> = <span class="r21 r">p</span>.<span class="i">Exponent</span>.<span class="i">Length</span>;
 
            <a href="assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r26 r">n</span> &lt;= 4, <span class="s">&quot;RSA exponent byte length cannot exceed allocated segment&quot;</span>);
 
            <b>while</b> (<span class="r26 r">n</span> &gt; 0)
            {
                <span class="r23 r">blob</span>[<span class="r25 r">pos</span>++] = <span class="r21 r">p</span>.<span class="i">Exponent</span>[--<span class="r26 r">n</span>];
            }
 
            <span class="c">// modulus</span>
            <span class="r25 r">pos</span> = 20;
            <b>byte</b>[] <span id="r27 rd" class="r27 r">key</span> = <span class="r21 r">p</span>.<span class="i">Modulus</span>;
            <span class="i">Array</span>.<span class="i">Reverse</span>(<span class="r27 r">key</span>);
            <span class="i">Buffer</span>.<span class="i">BlockCopy</span>(<span class="r27 r">key</span>, 0, <span class="r23 r">blob</span>, <span class="r25 r">pos</span>, <span class="r22 r">keyLength</span>);
 
            <b>return</b> <span class="r23 r">blob</span>;
        }
 
        <b>internal static byte</b>[] <a id="ae14463947d61a80" href="../R/ae14463947d61a80.html" target="n" data-glyph="74,1" class="i method">FromCapiSimpleKeyBlob</a>(<b>byte</b>[] <span id="r28 rd" class="r28 r">blob</span>)
        {
            <b>if</b> (<span class="r28 r">blob</span> == <b>null</b>)
            {
                <b>throw</b> <b>new</b> <span class="i">ArgumentNullException</span>(<b>nameof</b>(<span class="r28 r">blob</span>));
            }
 
            <b>if</b> (<span class="r28 r">blob</span>.<span class="i">Length</span> &lt; <a href="#4f38738c6132ba0b" class="i field">SIMPLEBLOB_HEADER_LEN</a>)
            {
                <b>throw</b> <b>new</b> <span class="i">ArgumentException</span>(<span class="i">SecuritySupportStrings</span>.<span class="i">InvalidSessionKey</span>);
            }
 
            <span class="c">// just ignore the header of the capi blob and go straight for the key</span>
            <b>return</b> <span class="i">CreateReverseByteArray</span>(<span class="r28 r">blob</span>.<span class="i">Skip</span>(<a href="#4f38738c6132ba0b" class="i field">SIMPLEBLOB_HEADER_LEN</a>).<span class="i">ToArray</span>());
        }
 
        <b>internal static byte</b>[] <a id="c9d1d8fa0ab05476" href="../R/c9d1d8fa0ab05476.html" target="n" data-glyph="74,1" class="i method">ToCapiSimpleKeyBlob</a>(<b>byte</b>[] <span id="r29 rd" class="r29 r">encryptedKey</span>)
        {
            <b>if</b> (<span class="r29 r">encryptedKey</span> == <b>null</b>)
            {
                <b>throw</b> <b>new</b> <span class="i">ArgumentNullException</span>(<b>nameof</b>(<span class="r29 r">encryptedKey</span>));
            }
 
            <span class="c">// formulate the PUBLICKEYSTRUCT</span>
            <b>byte</b>[] <span id="r30 rd" class="r30 r">blob</span> = <b>new</b> <b>byte</b>[<a href="#4f38738c6132ba0b" class="i field">SIMPLEBLOB_HEADER_LEN</a> + <span class="r29 r">encryptedKey</span>.<span class="i">Length</span>];
 
            <span class="r30 r">blob</span>[0] = (<b>byte</b>)<a href="#d9a3ba40490aea9a" class="i field">SIMPLEBLOB</a>;         <span class="c">// Type - SIMPLEBLOB (0x01)</span>
            <span class="r30 r">blob</span>[1] = (<b>byte</b>)<a href="#bc68314f992fc438" class="i field">CUR_BLOB_VERSION</a>;   <span class="c">// Version - Always CUR_BLOB_VERSION (0x02)</span>
            <span class="c">// [2], [3]                         // RESERVED - Always 0</span>
            <span class="r30 r">blob</span>[4] = (<b>byte</b>)<a href="#cfb721dbc225a0f3" class="i field">CALG_AES_256</a>;       <span class="c">// AES-256 algo id (0x10)</span>
            <span class="r30 r">blob</span>[5] = 0x66;                     <span class="c">// ??</span>
            <span class="c">// [6], [7], [8]                    // 0x00 </span>
            <span class="r30 r">blob</span>[9] = (<b>byte</b>)<a href="#75f9ca006c77981f" class="i field">CALG_RSA_KEYX</a>;      <span class="c">// 0xa4</span>
            <span class="c">// [10], [11]                       // 0x00 </span>
 
            <span class="c">// create a reversed copy and add the encrypted key</span>
            <b>byte</b>[] <span id="r31 rd" class="r31 r">reversedKey</span> = <a href="#db465a4bb7549555" class="i method">CreateReverseByteArray</a>(<span class="r29 r">encryptedKey</span>);
            <span class="i">Buffer</span>.<span class="i">BlockCopy</span>(<span class="r31 r">reversedKey</span>, 0, <span class="r30 r">blob</span>, <a href="#4f38738c6132ba0b" class="i field">SIMPLEBLOB_HEADER_LEN</a>, <span class="r31 r">reversedKey</span>.<span class="i">Length</span>);
 
            <b>return</b> <span class="r30 r">blob</span>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Functions
    }
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Defines a custom exception which is thrown when</span>
    <span class="c">///</span><span class="c"> a native CAPI call results in an error.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span><span class="c">This exception is currently internal as it&#39;s not</span>
    <span class="c">///</span><span class="c"> surfaced to the user. However, if we decide to surface errors</span>
    <span class="c">///</span><span class="c"> to the user when something fails on the remote end, then this</span>
    <span class="c">///</span><span class="c"> can be turned public</span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
    [<span class="i">SuppressMessage</span>(<span class="s">&quot;Microsoft.Design&quot;</span>, <span class="s">&quot;CA1064:ExceptionsShouldBePublic&quot;</span>)]
    [<span class="i">Serializable</span>]
    <b>internal class</b> <a id="8b75afddc65044dd" href="../R/8b75afddc65044dd.html" target="n" data-glyph="2,0" class="t t">PSCryptoException</a> : <span class="i">Exception</span>
    {
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Private Members
 
        <b>private readonly uint</b> <a id="b310a2f12db9a81d" href="../R/b310a2f12db9a81d.html" target="n" data-glyph="46,1" class="i field">_errorCode</a>;
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Private Members
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Internal Properties
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Error code returned by the native CAPI call.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal uint</b> <a id="0ca199c660db9109" href="../R/../../0000000000.html" target="n" data-glyph="104,1" class="i property">ErrorCode</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#b310a2f12db9a81d" class="i field">_errorCode</a>;
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Internal Properties
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Constructors
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Default constructor.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public</b> <a id="7f82bc9fd76f4200" href="../R/7f82bc9fd76f4200.html" target="n" data-glyph="72,1" class="t constructor">PSCryptoException</a>()
            : <a href="#3aa12d8a0d484f8c" class="k">this</a>(0, <b>new</b> <span class="i">StringBuilder</span>(<b>string</b>.<span class="i">Empty</span>)) { }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Constructor that will be used from within CryptoUtils.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r32 r">errorCode</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">error code returned by native</span>
        <span class="c">///</span><span class="c"> crypto application</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r33 r">message</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Error message associated with this failure.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>public</b> <a id="3aa12d8a0d484f8c" href="../R/3aa12d8a0d484f8c.html" target="n" data-glyph="72,1" class="t constructor">PSCryptoException</a>(<b>uint</b> <span id="r32 rd" class="r32 r">errorCode</span>, <span class="i">StringBuilder</span> <span id="r33 rd" class="r33 r">message</span>)
            : <b>base</b>(<span class="r33 r">message</span>.<span class="i">ToString</span>())
        {
            <a href="#b310a2f12db9a81d" class="i field">_errorCode</a> = <span class="r32 r">errorCode</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Constructor with just message but no inner exception.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r34 r">message</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Error message associated with this failure.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>public</b> <a id="49695dafd297907d" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="t constructor">PSCryptoException</a>(<b>string</b> <span id="r34 rd" class="r34 r">message</span>)
            : <a href="#b45c02cd64d5a34b" class="k">this</a>(<span class="r34 r">message</span>, <b>null</b>) { }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Constructor with inner exception.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r35 r">message</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Error message.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r36 r">innerException</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Inner exception.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span><span class="c">This constructor is currently not called</span>
        <span class="c">///</span><span class="c"> explicitly from crypto utils</span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>public</b> <a id="b45c02cd64d5a34b" href="../R/b45c02cd64d5a34b.html" target="n" data-glyph="72,1" class="t constructor">PSCryptoException</a>(<b>string</b> <span id="r35 rd" class="r35 r">message</span>, <span class="i">Exception</span> <span id="r36 rd" class="r36 r">innerException</span>)
            : <b>base</b>(<span class="r35 r">message</span>, <span class="r36 r">innerException</span>)
        {
            <a href="#b310a2f12db9a81d" class="i field">_errorCode</a> = <b>unchecked</b>((<b>uint</b>)-1);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Constructor which has type specific serialization logic.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r37 r">info</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Serialization info.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r38 r">context</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Context in which this constructor is called.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span><span class="c">Currently no custom type-specific serialization logic is</span>
        <span class="c">///</span><span class="c"> implemented</span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>protected</b> <a id="979fab43a430a81a" href="../R/../../0000000000.html" target="n" data-glyph="75,1" class="t constructor">PSCryptoException</a>(<span class="i">SerializationInfo</span> <span id="r37 rd" class="r37 r">info</span>, <span class="i">StreamingContext</span> <span id="r38 rd" class="r38 r">context</span>)
            : <b>base</b>(<span class="r37 r">info</span>, <span class="r38 r">context</span>)
        {
            <a href="#b310a2f12db9a81d" class="i field">_errorCode</a> = <b>unchecked</b>(0xFFFFFFF);
            <a href="assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<b>false</b>, <span class="s">&quot;type-specific serialization logic not implemented and so this constructor should not be called&quot;</span>);
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Constructors
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> ISerializable Overrides
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Returns base implementation.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r39 r">info</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Serialization info.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r40 r">context</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Context.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>public override void</b> <a id="39b173f1eeb543a7" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">GetObjectData</a>(<span class="i">SerializationInfo</span> <span id="r39 rd" class="r39 r">info</span>, <span class="i">StreamingContext</span> <span id="r40 rd" class="r40 r">context</span>)
        {
            <b>base</b>.<span class="i">GetObjectData</span>(<span class="r39 r">info</span>, <span class="r40 r">context</span>);
        }
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> ISerializable Overrides
    }
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> A reverse compatible implementation of session key exchange. This supports the CAPI</span>
    <span class="c">///</span><span class="c"> keyblob formats but uses dotnet std abstract AES and RSA classes for all crypto operations.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>internal sealed class</b> <a id="7c4e7e6eaa4e2bba" href="../R/7c4e7e6eaa4e2bba.html" target="n" data-glyph="2,0" class="t t">PSRSACryptoServiceProvider</a> : <span class="i">IDisposable</span>
    {
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Private Members
 
        <span class="c">// handle session key encryption/decryption</span>
        <b>private</b> <span class="i">RSA</span> <a id="6b8a4af78f7fd4c7" href="../R/6b8a4af78f7fd4c7.html" target="n" data-glyph="46,1" class="i field">_rsa</a>;
 
        <span class="c">// handle to the AES provider object (houses session key and iv)</span>
        <b>private readonly</b> <span class="i">Aes</span> <a id="40428b5d3baf6357" href="../R/40428b5d3baf6357.html" target="n" data-glyph="46,1" class="i field">_aes</a>;
 
        <span class="c">// this flag indicates that this class has a key imported from the </span>
        <span class="c">// remote end and so can be used for encryption</span>
        <b>private bool</b> <a id="d4f193920ea8ff00" href="../R/d4f193920ea8ff00.html" target="n" data-glyph="46,1" class="i field">_canEncrypt</a>;
 
        <span class="c">// bool indicating if session key was generated before</span>
        <b>private bool</b> <a id="7b36fc86aaac7683" href="../R/7b36fc86aaac7683.html" target="n" data-glyph="46,1" class="i field">_sessionKeyGenerated</a> = <b>false</b>;
 
        <b>private static readonly object</b> <a id="f42d5f7dcb00cf6e" href="../R/f42d5f7dcb00cf6e.html" target="n" data-glyph="46,1" class="i field">s_syncObject</a> = <b>new</b> <b>object</b>();
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Private Members
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Constructors
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Private constructor.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r41 r">serverMode</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">indicates if this service</span>
        <span class="c">///</span><span class="c"> provider is operating in server mode</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>private</b> <a id="191be1a21400bf4a" href="../R/191be1a21400bf4a.html" target="n" data-glyph="76,1" class="t constructor">PSRSACryptoServiceProvider</a>(<b>bool</b> <span id="r41 rd" class="r41 r">serverMode</span>)
        {
            <b>if</b> (<span class="r41 r">serverMode</span>)
            {
                <a href="#de00cb24d118e0fd" class="i method">GenerateKeyPair</a>();
            }
 
            <a href="#40428b5d3baf6357" class="i field">_aes</a> = <span class="i">Aes</span>.<span class="i">Create</span>();
            <a href="#40428b5d3baf6357" class="i field">_aes</a>.<span class="i">IV</span> = <b>new</b> <b>byte</b>[16];  <span class="c">// iv should be 0</span>
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Constructors
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Internal Methods
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Get the public key, in CAPI-compatible form, as a base64 encoded string.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">Public key as base64 encoded string.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal string</b> <a id="91071d294eadfb5d" href="../R/91071d294eadfb5d.html" target="n" data-glyph="74,1" class="i method">GetPublicKeyAsBase64EncodedString</a>()
        {
            <a href="assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<a href="#6b8a4af78f7fd4c7" class="i field">_rsa</a> != <b>null</b>, <span class="s">&quot;No public key available.&quot;</span>);
 
            <b>byte</b>[] <span id="r42 rd" class="r42 r">capiPublicKeyBlob</span> = <a href="#a33701b45fd3ae40" class="t t">PSCryptoNativeConverter</a>.<a href="#7077f6a67d065465" class="i method">ToCapiPublicKeyBlob</a>(<a href="#6b8a4af78f7fd4c7" class="i field">_rsa</a>);
 
            <b>return</b> <span class="i">Convert</span>.<span class="i">ToBase64String</span>(<span class="r42 r">capiPublicKeyBlob</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Generates an AEX-256 session key if one is not already generated.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="4bf76157c22f18a3" href="../R/4bf76157c22f18a3.html" target="n" data-glyph="74,1" class="i method">GenerateSessionKey</a>()
        {
            <b>if</b> (<a href="#7b36fc86aaac7683" class="i field">_sessionKeyGenerated</a>)
                <b>return</b>;
 
            <b>lock</b> (<a href="#f42d5f7dcb00cf6e" class="i field">s_syncObject</a>)
            {
                <b>if</b> (!<a href="#7b36fc86aaac7683" class="i field">_sessionKeyGenerated</a>)
                {
                    <span class="c">// Aes object gens key automatically on construction, so this is somewhat redundant, </span>
                    <span class="c">// but at least the actionable key will not be in-memory until it&#39;s requested fwiw.</span>
                    <a href="#40428b5d3baf6357" class="i field">_aes</a>.<span class="i">GenerateKey</span>();
                    <a href="#7b36fc86aaac7683" class="i field">_sessionKeyGenerated</a> = <b>true</b>;
                    <a href="#d4f193920ea8ff00" class="i field">_canEncrypt</a> = <b>true</b>;  <span class="c">// we can encrypt and decrypt once session key is available</span>
                }
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> 1. Generate a AES-256 session key</span>
        <span class="c">///</span><span class="c"> 2. Encrypt the session key with the Imported</span>
        <span class="c">///</span><span class="c">    RSA public key</span>
        <span class="c">///</span><span class="c"> 3. Encode result above as base 64 string and export.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">Session key encrypted with receivers public key</span>
        <span class="c">///</span><span class="c"> and encoded as a base 64 string.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal string</b> <a id="1f6472c14cc33836" href="../R/1f6472c14cc33836.html" target="n" data-glyph="74,1" class="i method">SafeExportSessionKey</a>()
        {
            <a href="assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<a href="#6b8a4af78f7fd4c7" class="i field">_rsa</a> != <b>null</b>, <span class="s">&quot;No public key available.&quot;</span>);
 
            <span class="c">// generate one if not already done.</span>
            <a href="#4bf76157c22f18a3" class="i method">GenerateSessionKey</a>();
 
            <span class="c">// encrypt it</span>
            <b>byte</b>[] <span id="r43 rd" class="r43 r">encryptedKey</span> = <a href="#6b8a4af78f7fd4c7" class="i field">_rsa</a>.<span class="i">Encrypt</span>(<a href="#40428b5d3baf6357" class="i field">_aes</a>.<span class="i">Key</span>, <span class="i">RSAEncryptionPadding</span>.<span class="i">Pkcs1</span>);
 
            <span class="c">// convert the key to capi simpleblob format before exporting</span>
            <b>byte</b>[] <span id="r44 rd" class="r44 r">simpleKeyBlob</span> = <a href="#a33701b45fd3ae40" class="t t">PSCryptoNativeConverter</a>.<a href="#c9d1d8fa0ab05476" class="i method">ToCapiSimpleKeyBlob</a>(<span class="r43 r">encryptedKey</span>);
            <b>return</b> <span class="i">Convert</span>.<span class="i">ToBase64String</span>(<span class="r44 r">simpleKeyBlob</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Import a public key into the provider whose context</span>
        <span class="c">///</span><span class="c"> has been obtained.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r45 r">publicKey</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Base64 encoded public key to import.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="3b2c0dca131b321a" href="../R/3b2c0dca131b321a.html" target="n" data-glyph="74,1" class="i method">ImportPublicKeyFromBase64EncodedString</a>(<b>string</b> <span id="r45 rd" class="r45 r">publicKey</span>)
        {
            <a href="assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<span class="i">Assert</span>(!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r45 r">publicKey</span>), <span class="s">&quot;key cannot be null or empty&quot;</span>);
 
            <b>byte</b>[] <span id="r46 rd" class="r46 r">publicKeyBlob</span> = <span class="i">Convert</span>.<span class="i">FromBase64String</span>(<span class="r45 r">publicKey</span>);
            <a href="#6b8a4af78f7fd4c7" class="i field">_rsa</a> = <a href="#a33701b45fd3ae40" class="t t">PSCryptoNativeConverter</a>.<a href="#4ce00bfa74c3a546" class="i method">FromCapiPublicKeyBlob</a>(<span class="r46 r">publicKeyBlob</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Import a session key from the remote side into</span>
        <span class="c">///</span><span class="c"> the current CSP.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r47 r">sessionKey</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">encrypted session key as a</span>
        <span class="c">///</span><span class="c"> base64 encoded string</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="7b7758a72a52b365" href="../R/7b7758a72a52b365.html" target="n" data-glyph="74,1" class="i method">ImportSessionKeyFromBase64EncodedString</a>(<b>string</b> <span id="r47 rd" class="r47 r">sessionKey</span>)
        {
            <a href="assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<span class="i">Assert</span>(!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r47 r">sessionKey</span>), <span class="s">&quot;key cannot be null or empty&quot;</span>);
 
            <b>byte</b>[] <span id="r48 rd" class="r48 r">sessionKeyBlob</span> = <span class="i">Convert</span>.<span class="i">FromBase64String</span>(<span class="r47 r">sessionKey</span>);
            <b>byte</b>[] <span id="r49 rd" class="r49 r">rsaEncryptedKey</span> = <a href="#a33701b45fd3ae40" class="t t">PSCryptoNativeConverter</a>.<a href="#ae14463947d61a80" class="i method">FromCapiSimpleKeyBlob</a>(<span class="r48 r">sessionKeyBlob</span>);
 
            <a href="#40428b5d3baf6357" class="i field">_aes</a>.<span class="i">Key</span> = <a href="#6b8a4af78f7fd4c7" class="i field">_rsa</a>.<span class="i">Decrypt</span>(<span class="r49 r">rsaEncryptedKey</span>, <span class="i">RSAEncryptionPadding</span>.<span class="i">Pkcs1</span>);
 
            <span class="c">// now we have imported the key and will be able to</span>
            <span class="c">// encrypt using the session key</span>
            <a href="#d4f193920ea8ff00" class="i field">_canEncrypt</a> = <b>true</b>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Encrypt the specified byte array.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r50 r">data</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Data to encrypt.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">Encrypted byte array.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal byte</b>[] <a id="c61810ee7f9703f9" href="../R/c61810ee7f9703f9.html" target="n" data-glyph="74,1" class="i method">EncryptWithSessionKey</a>(<b>byte</b>[] <span id="r50 rd" class="r50 r">data</span>)
        {
            <a href="assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<a href="#d4f193920ea8ff00" class="i field">_canEncrypt</a>, <span class="s">&quot;Remote key has not been imported to encrypt&quot;</span>);
 
            <b>using</b> (<span class="i">ICryptoTransform</span> <span id="r51 rd" class="r51 r">encryptor</span> = <a href="#40428b5d3baf6357" class="i field">_aes</a>.<span class="i">CreateEncryptor</span>())
            <b>using</b> (<span class="i">MemoryStream</span> <span id="r52 rd" class="r52 r">targetStream</span> = <b>new</b> <span class="i">MemoryStream</span>())
            <b>using</b> (<span class="i">MemoryStream</span> <span id="r53 rd" class="r53 r">sourceStream</span> = <b>new</b> <span class="i">MemoryStream</span>(<span class="r50 r">data</span>))
            {
                <b>using</b> (<span class="i">CryptoStream</span> <span id="r54 rd" class="r54 r">cryptoStream</span> = <b>new</b> <span class="i">CryptoStream</span>(<span class="r52 r">targetStream</span>, <span class="r51 r">encryptor</span>, <span class="i">CryptoStreamMode</span>.<span class="i">Write</span>))
                {
                    <span class="r53 r">sourceStream</span>.<span class="i">CopyTo</span>(<span class="r54 r">cryptoStream</span>);
                }
 
                <b>return</b> <span class="r52 r">targetStream</span>.<span class="i">ToArray</span>();
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Decrypt the specified buffer.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r55 r">data</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Data to decrypt.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">Decrypted buffer.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal byte</b>[] <a id="c048173ed4e2b985" href="../R/c048173ed4e2b985.html" target="n" data-glyph="74,1" class="i method">DecryptWithSessionKey</a>(<b>byte</b>[] <span id="r55 rd" class="r55 r">data</span>)
        {
            <b>using</b> (<span class="i">ICryptoTransform</span> <span id="r56 rd" class="r56 r">decryptor</span> = <a href="#40428b5d3baf6357" class="i field">_aes</a>.<span class="i">CreateDecryptor</span>())
            <b>using</b> (<span class="i">MemoryStream</span> <span id="r57 rd" class="r57 r">sourceStream</span> = <b>new</b> <span class="i">MemoryStream</span>(<span class="r55 r">data</span>))
            <b>using</b> (<span class="i">MemoryStream</span> <span id="r58 rd" class="r58 r">targetStream</span> = <b>new</b> <span class="i">MemoryStream</span>())
            {
                <b>using</b> (<span class="i">CryptoStream</span> <span id="r59 rd" class="r59 r">csDecrypt</span> = <b>new</b> <span class="i">CryptoStream</span>(<span class="r57 r">sourceStream</span>, <span class="r56 r">decryptor</span>, <span class="i">CryptoStreamMode</span>.<span class="i">Read</span>))
                {
                    <span class="r59 r">csDecrypt</span>.<span class="i">CopyTo</span>(<span class="r58 r">targetStream</span>);
                }
 
                <b>return</b> <span class="r58 r">targetStream</span>.<span class="i">ToArray</span>();
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Generates key pair in a thread safe manner</span>
        <span class="c">///</span><span class="c"> the first time when required.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="de00cb24d118e0fd" href="../R/de00cb24d118e0fd.html" target="n" data-glyph="74,1" class="i method">GenerateKeyPair</a>()
        {
            <a href="#6b8a4af78f7fd4c7" class="i field">_rsa</a> = <span class="i">RSA</span>.<span class="i">Create</span>();
            <a href="#6b8a4af78f7fd4c7" class="i field">_rsa</a>.<span class="i">KeySize</span> = 2048;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Indicates if a key exchange is complete</span>
        <span class="c">///</span><span class="c"> and this provider can encrypt.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal bool</b> <a id="3be1eb7186d049cd" href="../R/3be1eb7186d049cd.html" target="n" data-glyph="104,1" class="i property">CanEncrypt</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#d4f193920ea8ff00" class="i field">_canEncrypt</a>;
            }
 
            <b>set</b>
            {
                <a href="#d4f193920ea8ff00" class="i field">_canEncrypt</a> = <b>value</b>;
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Internal Methods
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Internal Static Methods
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Returns a crypto service provider for use in the</span>
        <span class="c">///</span><span class="c"> client. This will reuse the key that has been</span>
        <span class="c">///</span><span class="c"> generated.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">Crypto service provider for</span>
        <span class="c">///</span><span class="c"> the client side.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal static</b> <a href="#7c4e7e6eaa4e2bba" class="t t">PSRSACryptoServiceProvider</a> <a id="e79ed6caa4a0ff62" href="../R/e79ed6caa4a0ff62.html" target="n" data-glyph="74,1" class="i method">GetRSACryptoServiceProviderForClient</a>()
        {
            <b>return</b> <b>new</b> <a href="#191be1a21400bf4a" class="t constructor">PSRSACryptoServiceProvider</a>(<b>false</b>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Returns a crypto service provider for use in the</span>
        <span class="c">///</span><span class="c"> server. This will not generate a key pair.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">Crypto service provider for</span>
        <span class="c">///</span><span class="c"> the server side.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal static</b> <a href="#7c4e7e6eaa4e2bba" class="t t">PSRSACryptoServiceProvider</a> <a id="62e823e15abc4f73" href="../R/62e823e15abc4f73.html" target="n" data-glyph="74,1" class="i method">GetRSACryptoServiceProviderForServer</a>()
        {
            <b>return</b> <b>new</b> <a href="#191be1a21400bf4a" class="t constructor">PSRSACryptoServiceProvider</a>(<b>true</b>);
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Internal Static Methods
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> IDisposable
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Dispose resources.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public void</b> <a id="9f0d4e5b081e4a5e" href="../R/9f0d4e5b081e4a5e.html" target="n" data-glyph="72,1" class="i method">Dispose</a>()
        {
            <a href="#fc24d04ec90e416a" class="i method">Dispose</a>(<b>true</b>);
            <span class="i n">System</span>.<span class="i">GC</span>.<span class="i">SuppressFinalize</span>(<a href="#7c4e7e6eaa4e2bba" class="k">this</a>);
        }
 
        <b>private void</b> <a id="fc24d04ec90e416a" href="../R/fc24d04ec90e416a.html" target="n" data-glyph="76,1" class="i method">Dispose</a>(<b>bool</b> <span id="r60 rd" class="r60 r">disposing</span>)
        {
            <b>if</b> (<span class="r60 r">disposing</span>)
            {
                <b>if</b> (<a href="#6b8a4af78f7fd4c7" class="i field">_rsa</a> != <b>null</b>)
                {
                    <a href="#6b8a4af78f7fd4c7" class="i field">_rsa</a>.<span class="i">Dispose</span>();
                }
 
                <b>if</b> (<a href="#40428b5d3baf6357" class="i field">_aes</a> != <b>null</b>)
                {
                    <a href="#40428b5d3baf6357" class="i field">_aes</a>.<span class="i">Dispose</span>();
                }
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> IDisposable
    }
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Helper for exchanging keys and encrypting/decrypting</span>
    <span class="c">///</span><span class="c"> secure strings for serialization in remoting.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>internal abstract class</b> <a id="1999dfb2439af5a0" href="../R/1999dfb2439af5a0.html" target="n" data-glyph="2,0" class="t t"><span id="aac36f8d8de84aab">PSRemotingCryptoHelper</span></a> : <span class="i">IDisposable</span>
    {
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Protected Members
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Crypto provider which will be used for importing remote</span>
        <span class="c">///</span><span class="c"> public key as well as generating a session key, exporting</span>
        <span class="c">///</span><span class="c"> it and performing symmetric key operations using the</span>
        <span class="c">///</span><span class="c"> session key.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>protected</b> <a href="#7c4e7e6eaa4e2bba" class="t t">PSRSACryptoServiceProvider</a> <a id="d6550af854058cd1" href="../R/d6550af854058cd1.html" target="n" data-glyph="45,1" class="i field">_rsaCryptoProvider</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Key exchange has been completed and both keys</span>
        <span class="c">///</span><span class="c"> available.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>protected</b> <span class="i">ManualResetEvent</span> <a id="33122f881e15d187" href="../R/33122f881e15d187.html" target="n" data-glyph="45,1" class="i field">_keyExchangeCompleted</a> = <b>new</b> <span class="i">ManualResetEvent</span>(<b>false</b>);
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Object for synchronizing key exchange.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>protected object</b> <a id="bf811187c04b32e7" href="../R/bf811187c04b32e7.html" target="n" data-glyph="45,1" class="i field">syncObject</a> = <b>new</b> <b>object</b>();
 
        <b>private bool</b> <a id="fb026abed12cb9bd" href="../R/fb026abed12cb9bd.html" target="n" data-glyph="46,1" class="i field">_keyExchangeStarted</a> = <b>false</b>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>protected void</b> <a id="95dfeaa63417ca63" href="../R/95dfeaa63417ca63.html" target="n" data-glyph="75,1" class="i method">RunKeyExchangeIfRequired</a>()
        {
            <a href="assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<a href="#8d792bdd7212ca3a" class="i property">Session</a> != <b>null</b>, <span class="s">&quot;data structure handler not set&quot;</span>);
 
            <b>if</b> (!<a href="#d6550af854058cd1" class="i field">_rsaCryptoProvider</a>.<a href="#3be1eb7186d049cd" class="i property">CanEncrypt</a>)
            {
                <b>try</b>
                {
                    <b>lock</b> (<a href="#bf811187c04b32e7" class="i field">syncObject</a>)
                    {
                        <b>if</b> (!<a href="#d6550af854058cd1" class="i field">_rsaCryptoProvider</a>.<a href="#3be1eb7186d049cd" class="i property">CanEncrypt</a>)
                        {
                            <b>if</b> (!<a href="#fb026abed12cb9bd" class="i field">_keyExchangeStarted</a>)
                            {
                                <a href="#fb026abed12cb9bd" class="i field">_keyExchangeStarted</a> = <b>true</b>;
                                <a href="#33122f881e15d187" class="i field">_keyExchangeCompleted</a>.<span class="i">Reset</span>();
                                <a href="#8d792bdd7212ca3a" class="i property">Session</a>.<a href="../engine/remoting/common/remotesession.cs.html#c33e3c25c3948807" class="i method">StartKeyExchange</a>();
                            }
                        }
                    }
                }
                <b>finally</b>
                {
                    <span class="c">// for whatever reason if StartKeyExchange()</span>
                    <span class="c">// throws an exception it should reset the</span>
                    <span class="c">// wait handle, so it should pass this wait</span>
                    <span class="c">// if it doesn&#39;t do so, its a bug</span>
                    <a href="#33122f881e15d187" class="i field">_keyExchangeCompleted</a>.<span class="i">WaitOne</span>();
                }
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Core logic to encrypt a string. Assumes session key is already generated.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r61 r">secureString</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> secure string to be encrypted</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>protected string</b> <a id="7565bb15da3def39" href="../R/7565bb15da3def39.html" target="n" data-glyph="75,1" class="i method">EncryptSecureStringCore</a>(<span class="i">SecureString</span> <span id="r61 rd" class="r61 r">secureString</span>)
        {
            <b>string</b> <span id="r62 rd" class="r62 r">encryptedDataAsString</span> = <b>null</b>;
 
            <b>if</b> (<a href="#d6550af854058cd1" class="i field">_rsaCryptoProvider</a>.<a href="#3be1eb7186d049cd" class="i property">CanEncrypt</a>)
            {
                <span class="i">IntPtr</span> <span id="r63 rd" class="r63 r">ptr</span> = <span class="i">Marshal</span>.<span class="i">SecureStringToCoTaskMemUnicode</span>(<span class="r61 r">secureString</span>);
 
                <b>if</b> (<span class="r63 r">ptr</span> != <span class="i">IntPtr</span>.<span class="i">Zero</span>)
                {
                    <b>byte</b>[] <span id="r64 rd" class="r64 r">data</span> = <b>new</b> <b>byte</b>[<span class="r61 r">secureString</span>.<span class="i">Length</span> * 2];
                    <b>for</b> (<b>int</b> <span id="r65 rd" class="r65 r">i</span> = 0; <span class="r65 r">i</span> &lt; <span class="r64 r">data</span>.<span class="i">Length</span>; <span class="r65 r">i</span>++)
                    {
                        <span class="r64 r">data</span>[<span class="r65 r">i</span>] = <span class="i">Marshal</span>.<span class="i">ReadByte</span>(<span class="r63 r">ptr</span>, <span class="r65 r">i</span>);
                    }
 
                    <span class="i">Marshal</span>.<span class="i">ZeroFreeCoTaskMemUnicode</span>(<span class="r63 r">ptr</span>);
 
                    <b>try</b>
                    {
                        <b>byte</b>[] <span id="r66 rd" class="r66 r">encryptedData</span> = <a href="#d6550af854058cd1" class="i field">_rsaCryptoProvider</a>.<a href="#c61810ee7f9703f9" class="i method">EncryptWithSessionKey</a>(<span class="r64 r">data</span>);
                        <span class="r62 r">encryptedDataAsString</span> = <span class="i">Convert</span>.<span class="i">ToBase64String</span>(<span class="r66 r">encryptedData</span>);
                    }
                    <b>finally</b>
                    {
                        <b>for</b> (<b>int</b> <span id="r67 rd" class="r67 r">j</span> = 0; <span class="r67 r">j</span> &lt; <span class="r64 r">data</span>.<span class="i">Length</span>; <span class="r67 r">j</span>++)
                        {
                            <span class="r64 r">data</span>[<span class="r67 r">j</span>] = 0;
                        }
                    }
                }
            }
            <b>else</b>
            {
                <b>throw</b> <b>new</b> <span class="t">PSCryptoException</span>(<span class="i">SecuritySupportStrings</span>.<span class="i">CannotEncryptSecureString</span>);
            }
 
            <b>return</b> <span class="r62 r">encryptedDataAsString</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Core logic to decrypt a secure string. Assumes session key is already available.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r68 r">encryptedString</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> encrypted string to be decrypted</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>protected</b> <span class="i">SecureString</span> <a id="dc74de3b7d6d7f54" href="../R/dc74de3b7d6d7f54.html" target="n" data-glyph="75,1" class="i method">DecryptSecureStringCore</a>(<b>string</b> <span id="r68 rd" class="r68 r">encryptedString</span>)
        {
            <span class="c">// removing an earlier assert from here. It is</span>
            <span class="c">// possible to encrypt and decrypt empty</span>
            <span class="c">// secure strings</span>
            <span class="i">SecureString</span> <span id="r69 rd" class="r69 r">secureString</span> = <b>null</b>;
 
            <span class="c">// before you can decrypt a key exchange should have</span>
            <span class="c">// happened successfully</span>
            <b>if</b> (<a href="#d6550af854058cd1" class="i field">_rsaCryptoProvider</a>.<a href="#3be1eb7186d049cd" class="i property">CanEncrypt</a>)
            {
                <b>byte</b>[] <span id="r70 rd" class="r70 r">data</span> = <b>null</b>;
                <b>try</b>
                {
                    <span class="r70 r">data</span> = <span class="i">Convert</span>.<span class="i">FromBase64String</span>(<span class="r68 r">encryptedString</span>);
                }
                <b>catch</b> (<span class="i">FormatException</span>)
                {
                    <span class="c">// do nothing</span>
                    <span class="c">// this catch is to ensure that the exception doesn&#39;t</span>
                    <span class="c">// go unhandled leading to a crash</span>
                    <b>throw</b> <b>new</b> <a href="#7f82bc9fd76f4200" class="t constructor">PSCryptoException</a>();
                }
 
                <b>if</b> (<span class="r70 r">data</span> != <b>null</b>)
                {
                    <b>byte</b>[] <span id="r71 rd" class="r71 r">decryptedData</span> = <a href="#d6550af854058cd1" class="i field">_rsaCryptoProvider</a>.<a href="#c048173ed4e2b985" class="i method">DecryptWithSessionKey</a>(<span class="r70 r">data</span>);
 
                    <span class="r69 r">secureString</span> = <b>new</b> <span class="i">SecureString</span>();
                    <span class="i">UInt16</span> <span id="r72 rd" class="r72 r">value</span> = 0;
                    <b>try</b>
                    {
                        <b>for</b> (<b>int</b> <span id="r73 rd" class="r73 r">i</span> = 0; <span class="r73 r">i</span> &lt; <span class="r71 r">decryptedData</span>.<span class="i">Length</span>; <span class="r73 r">i</span> += 2)
                        {
                            <span class="r72 r">value</span> = (<span class="i">UInt16</span>)(<span class="r71 r">decryptedData</span>[<span class="r73 r">i</span>] + (<span class="i">UInt16</span>)(<span class="r71 r">decryptedData</span>[<span class="r73 r">i</span> + 1] &lt;&lt; 8));
                            <span class="r69 r">secureString</span>.<span class="i">AppendChar</span>((<b>char</b>)<span class="r72 r">value</span>);
                            <span class="r72 r">value</span> = 0;
                        }
                    }
                    <b>finally</b>
                    {
                        <span class="c">// if there was an exception for whatever reason,</span>
                        <span class="c">// clear the last value store in Value</span>
                        <span class="r72 r">value</span> = 0;
 
                        <span class="c">// zero out the contents</span>
                        <b>for</b> (<b>int</b> <span id="r74 rd" class="r74 r">i</span> = 0; <span class="r74 r">i</span> &lt; <span class="r71 r">decryptedData</span>.<span class="i">Length</span>; <span class="r74 r">i</span> += 2)
                        {
                            <span class="r71 r">decryptedData</span>[<span class="r74 r">i</span>] = 0;
                            <span class="r71 r">decryptedData</span>[<span class="r74 r">i</span> + 1] = 0;
                        }
                    }
                }
            }
            <b>else</b>
            {
                <a href="assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<b>false</b>, <span class="s">&quot;Session key not available to decrypt&quot;</span>);
            }
 
            <b>return</b> <span class="r69 r">secureString</span>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Protected Members
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Internal Methods
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Encrypt a secure string.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r75 r">secureString</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Secure string to encrypt.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">Encrypted string.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span><span class="c">This method zeroes out all interim buffers used</span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>internal abstract string</b> <a id="d523318642e6184f" href="../R/d523318642e6184f.html" target="n" data-glyph="74,1" class="i method">EncryptSecureString</a>(<span class="i">SecureString</span> <span id="r75 rd" class="r75 r">secureString</span>);
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Decrypt a string and construct a secure string from its</span>
        <span class="c">///</span><span class="c"> contents.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r76 r">encryptedString</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Encrypted string.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">Secure string object.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span><span class="c">This method zeroes out any interim buffers used</span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>internal abstract</b> <span class="i">SecureString</span> <a id="605ed7fabf0891f9" href="../R/605ed7fabf0891f9.html" target="n" data-glyph="74,1" class="i method">DecryptSecureString</a>(<b>string</b> <span id="r76 rd" class="r76 r">encryptedString</span>);
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Represents the session to be used for requesting public key.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal abstract</b> <a href="../engine/remoting/common/remotesession.cs.html#0b946ed667e0070a" class="t t">RemoteSession</a> <a id="8d792bdd7212ca3a" href="../R/8d792bdd7212ca3a.html" target="n" data-glyph="104,1" class="i property">Session</a> { <b>get</b>; <b>set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public void</b> <a id="261646704dcc2972" href="../R/261646704dcc2972.html" target="n" data-glyph="72,1" class="i method">Dispose</a>()
        {
            <a href="#f9f8f893a4dc35ce" class="i method">Dispose</a>(<b>true</b>);
            <span class="i">GC</span>.<span class="i">SuppressFinalize</span>(<a href="#1999dfb2439af5a0" class="k">this</a>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r77 r">disposing</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>public void</b> <a id="f9f8f893a4dc35ce" href="../R/f9f8f893a4dc35ce.html" target="n" data-glyph="72,1" class="i method">Dispose</a>(<b>bool</b> <span id="r77 rd" class="r77 r">disposing</span>)
        {
            <b>if</b> (<span class="r77 r">disposing</span>)
            {
                <b>if</b> (<a href="#d6550af854058cd1" class="i field">_rsaCryptoProvider</a> != <b>null</b>)
                {
                    <a href="#d6550af854058cd1" class="i field">_rsaCryptoProvider</a>.<a href="#9f0d4e5b081e4a5e" class="i method">Dispose</a>();
                }
 
                <a href="#d6550af854058cd1" class="i field">_rsaCryptoProvider</a> = <b>null</b>;
 
                <a href="#33122f881e15d187" class="i field">_keyExchangeCompleted</a>.<span class="i">Dispose</span>();
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Resets the wait for key exchange.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="7796a9d103b11aea" href="../R/7796a9d103b11aea.html" target="n" data-glyph="74,1" class="i method">CompleteKeyExchange</a>()
        {
            <a href="#33122f881e15d187" class="i field">_keyExchangeCompleted</a>.<span class="i">Set</span>();
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Internal Methods
    }
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Helper for exchanging keys and encrypting/decrypting</span>
    <span class="c">///</span><span class="c"> secure strings for serialization in remoting.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>internal class</b> <a id="e11543478fd30f75" href="../R/e11543478fd30f75.html" target="n" data-glyph="2,0" class="t t">PSRemotingCryptoHelperServer</a> : <a href="#1999dfb2439af5a0" class="t t">PSRemotingCryptoHelper</a>
    {
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Private Members
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This is the instance of runspace pool data structure handler</span>
        <span class="c">///</span><span class="c"> to use for negotiations.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private</b> <a href="../engine/remoting/common/remotesession.cs.html#0b946ed667e0070a" class="t t">RemoteSession</a> <a id="7634dc168fb0c0bd" href="../R/7634dc168fb0c0bd.html" target="n" data-glyph="46,1" class="i field">_session</a>;
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Private Members
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Constructors
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Creates the encryption provider, but generates no key.</span>
        <span class="c">///</span><span class="c"> The key will be imported later.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal</b> <a id="71ecffd05c1623b9" href="../R/71ecffd05c1623b9.html" target="n" data-glyph="74,1" class="t constructor">PSRemotingCryptoHelperServer</a>()
        {
            <a href="#d6550af854058cd1" class="i field">_rsaCryptoProvider</a> = <a href="#7c4e7e6eaa4e2bba" class="t t">PSRSACryptoServiceProvider</a>.<a href="#62e823e15abc4f73" class="i method">GetRSACryptoServiceProviderForServer</a>();
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Constructors
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Internal Methods
 
        <b>internal override string</b> <a id="0055d0d3e6ef7bc1" href="../R/0055d0d3e6ef7bc1.html" target="n" data-glyph="74,1" class="i method">EncryptSecureString</a>(<span class="i">SecureString</span> <span id="r78 rd" class="r78 r">secureString</span>)
        {
            <a href="../engine/remoting/server/serverremotesession.cs.html#2224dac53a001a7b" class="t t">ServerRemoteSession</a> <span id="r79 rd" class="r79 r">session</span> = <a href="#2053e749f9fa257a" class="i property">Session</a> <b>as</b> <a href="../engine/remoting/server/serverremotesession.cs.html#2224dac53a001a7b" class="t t">ServerRemoteSession</a>;
 
            <span class="c">// session!=null check required for DRTs TestEncryptSecureString* entries in CryptoUtilsTest/UTUtils.dll</span>
            <span class="c">// for newer clients, server will never initiate key exchange.</span>
            <span class="c">// for server, just the session key is required to encrypt/decrypt anything</span>
            <b>if</b> ((<span class="r79 r">session</span> != <b>null</b>) &amp;&amp; (<span class="r79 r">session</span>.<a href="../engine/remoting/server/serverremotesession.cs.html#6e51a9cf15d63f71" class="i property">Context</a>.<a href="../engine/remoting/server/serverremotesession.cs.html#3840fb6b96425feb" class="i property">ClientCapability</a>.<a href="../engine/remoting/common/WireDataFormat/RemoteSessionCapability.cs.html#e0172342f9aadac0" class="i property">ProtocolVersion</a> &gt;= <a href="../engine/remoting/common/WireDataFormat/EncodeAndDecode.cs.html#d19a1042a44001e8" class="t t">RemotingConstants</a>.<a href="../engine/remoting/common/WireDataFormat/EncodeAndDecode.cs.html#fd42c50dee2d8244" class="i field">ProtocolVersionWin8RTM</a>))
            {
                <a href="#d6550af854058cd1" class="i field">_rsaCryptoProvider</a>.<a href="#4bf76157c22f18a3" class="i method">GenerateSessionKey</a>();
            }
            <b>else</b> <span class="c">// older clients</span>
            {
                <a href="#95dfeaa63417ca63" class="i method">RunKeyExchangeIfRequired</a>();
            }
 
            <b>return</b> <a href="#7565bb15da3def39" class="i method">EncryptSecureStringCore</a>(<span class="r78 r">secureString</span>);
        }
 
        <b>internal override</b> <span class="i">SecureString</span> <a id="ade636f34da28bad" href="../R/ade636f34da28bad.html" target="n" data-glyph="74,1" class="i method">DecryptSecureString</a>(<b>string</b> <span id="r80 rd" class="r80 r">encryptedString</span>)
        {
            <a href="#95dfeaa63417ca63" class="i method">RunKeyExchangeIfRequired</a>();
 
            <b>return</b> <a href="#dc74de3b7d6d7f54" class="i method">DecryptSecureStringCore</a>(<span class="r80 r">encryptedString</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Imports a public key from its base64 encoded string representation.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r81 r">publicKeyAsString</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Public key in its string representation.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">True on success.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal bool</b> <a id="c34a0b8976ad1d15" href="../R/c34a0b8976ad1d15.html" target="n" data-glyph="74,1" class="i method">ImportRemotePublicKey</a>(<b>string</b> <span id="r81 rd" class="r81 r">publicKeyAsString</span>)
        {
            <a href="assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<span class="i">Assert</span>(!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r81 r">publicKeyAsString</span>), <span class="s">&quot;public key passed in cannot be null&quot;</span>);
 
            <span class="c">// generate the crypto provider to use for encryption</span>
            <span class="c">// _rsaCryptoProvider = GenerateCryptoServiceProvider(false);</span>
 
            <b>try</b>
            {
                <a href="#d6550af854058cd1" class="i field">_rsaCryptoProvider</a>.<a href="#3b2c0dca131b321a" class="i method">ImportPublicKeyFromBase64EncodedString</a>(<span class="r81 r">publicKeyAsString</span>);
            }
            <b>catch</b> (<a href="#8b75afddc65044dd" class="t t">PSCryptoException</a>)
            {
                <b>return</b> <b>false</b>;
            }
 
            <b>return</b> <b>true</b>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Represents the session to be used for requesting public key.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal override</b> <a href="../engine/remoting/common/remotesession.cs.html#0b946ed667e0070a" class="t t">RemoteSession</a> <a id="2053e749f9fa257a" href="../R/2053e749f9fa257a.html" target="n" data-glyph="104,1" class="i property">Session</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#7634dc168fb0c0bd" class="i field">_session</a>;
            }
 
            <b>set</b>
            {
                <a href="#7634dc168fb0c0bd" class="i field">_session</a> = <b>value</b>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r82 r">encryptedSessionKey</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal bool</b> <a id="3e4047d83e4cfb54" href="../R/3e4047d83e4cfb54.html" target="n" data-glyph="74,1" class="i method">ExportEncryptedSessionKey</a>(<b>out string</b> <span id="r82 rd" class="r82 r">encryptedSessionKey</span>)
        {
            <b>try</b>
            {
                <span class="r82 r">encryptedSessionKey</span> = <a href="#d6550af854058cd1" class="i field">_rsaCryptoProvider</a>.<a href="#1f6472c14cc33836" class="i method">SafeExportSessionKey</a>();
            }
            <b>catch</b> (<a href="#8b75afddc65044dd" class="t t">PSCryptoException</a>)
            {
                <span class="r82 r">encryptedSessionKey</span> = <b>string</b>.<span class="i">Empty</span>;
                <b>return</b> <b>false</b>;
            }
 
            <b>return</b> <b>true</b>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets a helper with a test session.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">Helper for testing.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span><span class="c">To be used only for testing</span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>internal static</b> <a href="#e11543478fd30f75" class="t t">PSRemotingCryptoHelperServer</a> <a id="65d2a647f09548e8" href="../R/../../0000000000.html" target="n" data-glyph="74,1" class="i method">GetTestRemotingCryptHelperServer</a>()
        {
            <a href="#e11543478fd30f75" class="t t">PSRemotingCryptoHelperServer</a> <span id="r83 rd" class="r83 r">helper</span> = <b>new</b> <a href="#71ecffd05c1623b9" class="t constructor">PSRemotingCryptoHelperServer</a>();
            <span class="r83 r">helper</span>.<a href="#2053e749f9fa257a" class="i property">Session</a> = <b>new</b> <span class="t">TestHelperSession</span>();
 
            <b>return</b> <span class="r83 r">helper</span>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Internal Methods
    }
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Helper for exchanging keys and encrypting/decrypting</span>
    <span class="c">///</span><span class="c"> secure strings for serialization in remoting.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>internal class</b> <a id="f1cdd84b7b6a0a95" href="../R/f1cdd84b7b6a0a95.html" target="n" data-glyph="2,0" class="t t">PSRemotingCryptoHelperClient</a> : <a href="#1999dfb2439af5a0" class="t t">PSRemotingCryptoHelper</a>
    {
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Private Members
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Private Members
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Constructors
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Creates the encryption provider, but generates no key.</span>
        <span class="c">///</span><span class="c"> The key will be imported later.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal</b> <a id="d0e445eb1fcebe01" href="../R/d0e445eb1fcebe01.html" target="n" data-glyph="74,1" class="t constructor">PSRemotingCryptoHelperClient</a>()
        {
            <a href="#d6550af854058cd1" class="i field">_rsaCryptoProvider</a> = <a href="#7c4e7e6eaa4e2bba" class="t t">PSRSACryptoServiceProvider</a>.<a href="#e79ed6caa4a0ff62" class="i method">GetRSACryptoServiceProviderForClient</a>();
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Constructors
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Protected Methods
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Protected Methods
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Internal Methods
 
        <b>internal override string</b> <a id="c8297b88a2da026c" href="../R/c8297b88a2da026c.html" target="n" data-glyph="74,1" class="i method">EncryptSecureString</a>(<span class="i">SecureString</span> <span id="r84 rd" class="r84 r">secureString</span>)
        {
            <a href="#95dfeaa63417ca63" class="i method">RunKeyExchangeIfRequired</a>();
 
            <b>return</b> <a href="#7565bb15da3def39" class="i method">EncryptSecureStringCore</a>(<span class="r84 r">secureString</span>);
        }
 
        <b>internal override</b> <span class="i">SecureString</span> <a id="48ab1fab6712b774" href="../R/48ab1fab6712b774.html" target="n" data-glyph="74,1" class="i method">DecryptSecureString</a>(<b>string</b> <span id="r85 rd" class="r85 r">encryptedString</span>)
        {
            <a href="#95dfeaa63417ca63" class="i method">RunKeyExchangeIfRequired</a>();
 
            <b>return</b> <a href="#dc74de3b7d6d7f54" class="i method">DecryptSecureStringCore</a>(<span class="r85 r">encryptedString</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Export the public key as a base64 encoded string.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r86 r">publicKeyAsString</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">on execution will contain</span>
        <span class="c">///</span><span class="c"> the public key as string</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">True on success.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal bool</b> <a id="4cf00f837b21c537" href="../R/4cf00f837b21c537.html" target="n" data-glyph="74,1" class="i method">ExportLocalPublicKey</a>(<b>out string</b> <span id="r86 rd" class="r86 r">publicKeyAsString</span>)
        {
            <span class="c">// generate keys - the method already takes of creating</span>
            <span class="c">// only when its not already created</span>
 
            <b>try</b>
            {
                <a href="#d6550af854058cd1" class="i field">_rsaCryptoProvider</a>.<a href="#de00cb24d118e0fd" class="i method">GenerateKeyPair</a>();
            }
            <b>catch</b> (<a href="#8b75afddc65044dd" class="t t">PSCryptoException</a>)
            {
                <b>throw</b>;
 
                <span class="c">// the caller has to ensure that they</span>
                <span class="c">// complete the key exchange process</span>
            }
 
            <b>try</b>
            {
                <span class="r86 r">publicKeyAsString</span> = <a href="#d6550af854058cd1" class="i field">_rsaCryptoProvider</a>.<a href="#91071d294eadfb5d" class="i method">GetPublicKeyAsBase64EncodedString</a>();
            }
            <b>catch</b> (<a href="#8b75afddc65044dd" class="t t">PSCryptoException</a>)
            {
                <span class="r86 r">publicKeyAsString</span> = <b>string</b>.<span class="i">Empty</span>;
                <b>return</b> <b>false</b>;
            }
 
            <b>return</b> <b>true</b>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r87 r">encryptedSessionKey</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal bool</b> <a id="ebd2def2bb78631c" href="../R/ebd2def2bb78631c.html" target="n" data-glyph="74,1" class="i method">ImportEncryptedSessionKey</a>(<b>string</b> <span id="r87 rd" class="r87 r">encryptedSessionKey</span>)
        {
            <a href="assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<span class="i">Assert</span>(!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r87 r">encryptedSessionKey</span>), <span class="s">&quot;encrypted session key passed in cannot be null&quot;</span>);
 
            <b>try</b>
            {
                <a href="#d6550af854058cd1" class="i field">_rsaCryptoProvider</a>.<a href="#7b7758a72a52b365" class="i method">ImportSessionKeyFromBase64EncodedString</a>(<span class="r87 r">encryptedSessionKey</span>);
            }
            <b>catch</b> (<a href="#8b75afddc65044dd" class="t t">PSCryptoException</a>)
            {
                <b>return</b> <b>false</b>;
            }
 
            <b>return</b> <b>true</b>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Represents the session to be used for requesting public key.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal override</b> <a href="../engine/remoting/common/remotesession.cs.html#0b946ed667e0070a" class="t t">RemoteSession</a> <a id="04b0417b7f17c0cf" href="../R/04b0417b7f17c0cf.html" target="n" data-glyph="104,1" class="i property">Session</a> { <b>get</b>; <b>set</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets a helper with a test session.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">Helper for testing.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span><span class="c">To be used only for testing</span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>internal static</b> <a href="#f1cdd84b7b6a0a95" class="t t">PSRemotingCryptoHelperClient</a> <a id="3cd07e96b67830b9" href="../R/../../0000000000.html" target="n" data-glyph="74,1" class="i method">GetTestRemotingCryptHelperClient</a>()
        {
            <a href="#f1cdd84b7b6a0a95" class="t t">PSRemotingCryptoHelperClient</a> <span id="r88 rd" class="r88 r">helper</span> = <b>new</b> <a href="#d0e445eb1fcebe01" class="t constructor">PSRemotingCryptoHelperClient</a>();
            <span class="r88 r">helper</span>.<a href="#04b0417b7f17c0cf" class="i property">Session</a> = <b>new</b> <span class="t">TestHelperSession</span>();
 
            <b>return</b> <span class="r88 r">helper</span>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Internal Methods
    }
 
    <span class="k preprocess">#</span><span class="k preprocess">region</span> TestHelpers
 
    <b>internal class</b> <a id="3a57ffcee819aaa2" href="../R/../../0000000000.html" target="n" data-glyph="2,0" class="t t"><span id="c536289121765bea">TestHelperSession</span></a> : <a href="../engine/remoting/common/remotesession.cs.html#0b946ed667e0070a" class="t t">RemoteSession</a>
    {
        <b>internal override void</b> <a id="106a641aa5d3e4b1" href="../R/106a641aa5d3e4b1.html" target="n" data-glyph="74,1" class="i method">StartKeyExchange</a>()
        {
            <span class="c">// intentionally left blank</span>
        }
 
        <b>internal override</b> <a href="../engine/remoting/common/WireDataFormat/EncodeAndDecode.cs.html#45c72046001f69b8" class="t t">RemotingDestination</a> <a id="1a8428a0b8a7f746" href="../R/1a8428a0b8a7f746.html" target="n" data-glyph="104,1" class="i property">MySelf</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="../engine/remoting/common/WireDataFormat/EncodeAndDecode.cs.html#45c72046001f69b8" class="t t">RemotingDestination</a>.<a href="../engine/remoting/common/WireDataFormat/EncodeAndDecode.cs.html#a5a39b4bf4f438ce" class="i field">InvalidDestination</a>;
            }
        }
 
        <b>internal override void</b> <a id="a8ae40da90ebf559" href="../R/a8ae40da90ebf559.html" target="n" data-glyph="74,1" class="i method">CompleteKeyExchange</a>()
        {
            <span class="c">// intentionally left blank</span>
        }
    }
    <span class="k preprocess">#</span><span class="k preprocess">endregion</span> TestHelpers
}
</pre></td></tr></table></div></body></html>
