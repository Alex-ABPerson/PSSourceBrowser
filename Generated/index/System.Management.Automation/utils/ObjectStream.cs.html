<!DOCTYPE html>
<html><head><title>ObjectStream.cs</title><link rel="stylesheet" href="../../styles.css"><script src="../../scripts.js"></script></head>
<body class="cB" onload="i(1982);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#System.Management.Automation/utils/ObjectStream.cs" target="_top">utils\ObjectStream.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#System.Management.Automation" target="_top">src\System.Management.Automation\System.Management.Automation.csproj</a> (System.Management.Automation)</td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation.</span>
<span class="c">// Licensed under the MIT License.</span>
 
<b>namespace</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Internal</span>
{
    <b>using</b> <span class="i n">System</span>;
    <b>using</b> <span class="i n">System</span>.<span class="i">Threading</span>;
    <b>using</b> <span class="i n">System</span>.<span class="i">Collections</span>;
    <b>using</b> <span class="i n">System</span>.<span class="i">Collections</span>.<span class="i">Generic</span>;
    <b>using</b> <span class="i n">System</span>.<span class="i">Collections</span>.<span class="i">ObjectModel</span>;
    <b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Runspaces</span>;
 
<span class="k preprocess">#</span><span class="k preprocess">pragma</span> <span class="k preprocess">warning</span> <span class="k preprocess">disable</span> 1634, 1691 <span class="c">// Stops compiler from warning about unknown warnings</span>
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Base class representing a FIFO memory based object stream.</span>
    <span class="c">///</span><span class="c"> The purpose of this abstraction is to provide the</span>
    <span class="c">///</span><span class="c"> semantics of a unidirectional stream of objects</span>
    <span class="c">///</span><span class="c"> between two threads using a dynamic memory buffer.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>internal abstract class</b> <a id="27e9349816faeecb" href="../R/27e9349816faeecb.html" target="n" data-glyph="2,0" class="t t"><span id="3c41c41e5754b653">ObjectStreamBase</span></a> : <span class="i">IDisposable</span>
    {
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Public events
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Event fired when data is added to the buffer.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal event</b> <span class="i">EventHandler</span> <a id="16ab48f9b8a043bb" href="../R/16ab48f9b8a043bb.html" target="n" data-glyph="32,1" class="i">DataReady</a> = <b>null</b>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Raises DataReadyEvent.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r0 r">source</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Source of the event</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r1 r">args</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Event args</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="f3eba942cd518b98" href="../R/../../0000000000.html" target="n" data-glyph="74,1" class="i method">FireDataReadyEvent</a>(<b>object</b> <span id="r0 rd" class="r0 r">source</span>, <span class="i">EventArgs</span> <span id="r1 rd" class="r1 r">args</span>)
        {
            <a href="#16ab48f9b8a043bb" class="i">DataReady</a>.<a href="ExtensionMethods.cs.html#79207b44c90e7eac" class="i method">SafeInvoke</a>(<span class="r0 r">source</span>, <span class="r1 r">args</span>);
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Public events
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Virtual Properties
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Get the capacity of the stream.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">value</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The capacity of the stream.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">value</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The capacity is the number of objects the stream may contain at one time.  Once this</span>
        <span class="c">///</span><span class="c"> limit is reached, attempts to write into the stream block until buffer space</span>
        <span class="c">///</span><span class="c"> becomes available.</span>
        <span class="c">///</span><span class="c"> MaxCapacity cannot change, so we can skip the lock.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>internal abstract int</b> <a id="afd17808c1bd2590" href="../R/afd17808c1bd2590.html" target="n" data-glyph="104,1" class="i property">MaxCapacity</a> { <b>get</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Waitable handle for callers to wait on until data ready to read.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The handle is set when data becomes available to read or</span>
        <span class="c">///</span><span class="c"> when a partial read has completed.  If multiple readers</span>
        <span class="c">///</span><span class="c"> are used, setting the handle does not guarantee that</span>
        <span class="c">///</span><span class="c"> a read operation will return data. If using multiple</span>
        <span class="c">///</span><span class="c"> reader threads, </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="#8d5fae42038b28d3" class="i method">NonBlockingRead</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> for</span>
        <span class="c">///</span><span class="c"> performing non-blocking reads.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>internal virtual</b> <span class="i">WaitHandle</span> <a id="f1768112bb171bd9" href="../R/f1768112bb171bd9.html" target="n" data-glyph="104,1" class="i property">ReadHandle</a>
        {
            <b>get</b>
            {
<span class="k preprocess">#</span><span class="k preprocess">pragma</span> <span class="k preprocess">warning</span> <span class="k preprocess">disable</span> 56503
                <span class="c">// disabled compiler warning as PSDataCollectionStream doesn&#39;t override this</span>
                <span class="c">// and I didn&#39;t want code duplication.</span>
                <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="MshTraceSource.cs.html#18f73963f5ead5c2" class="i method">NewNotSupportedException</a>();
<span class="k preprocess">#</span><span class="k preprocess">pragma</span> <span class="k preprocess">warning</span> <span class="k preprocess">restore</span> 56503
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Waitable handle for callers to block until buffer space becomes available.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The handle is set when space becomes available for writing. For multiple</span>
        <span class="c">///</span><span class="c"> writer threads writing to a bounded stream, the writer may still block</span>
        <span class="c">///</span><span class="c"> if another thread fills the stream to capacity.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>internal virtual</b> <span class="i">WaitHandle</span> <a id="05bf172d40ae4cd6" href="../R/05bf172d40ae4cd6.html" target="n" data-glyph="104,1" class="i property">WriteHandle</a>
        {
            <b>get</b>
            {
<span class="k preprocess">#</span><span class="k preprocess">pragma</span> <span class="k preprocess">warning</span> <span class="k preprocess">disable</span> 56503
                <span class="c">// disabled compiler warning as PSDataCollectionStream doesn&#39;t override this</span>
                <span class="c">// and I didn&#39;t want code duplication.</span>
                <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="MshTraceSource.cs.html#18f73963f5ead5c2" class="i method">NewNotSupportedException</a>();
<span class="k preprocess">#</span><span class="k preprocess">pragma</span> <span class="k preprocess">warning</span> <span class="k preprocess">restore</span> 56503
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Determine if we are at the end of the stream.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> EndOfPipeline is defined as the stream being closed and containing</span>
        <span class="c">///</span><span class="c"> zero objects.  Readers check this to determine if any objects</span>
        <span class="c">///</span><span class="c"> are in the stream.  Writers should check </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="#eff54ee10bba7a56" class="i property">IsOpen</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> to determine</span>
        <span class="c">///</span><span class="c"> if the stream can be written to.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>internal abstract bool</b> <a id="6abc1682053f7009" href="../R/6abc1682053f7009.html" target="n" data-glyph="104,1" class="i property">EndOfPipeline</a> { <b>get</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Check if the stream is open for further writes.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">True if the stream is open, false if not.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> IsOpen returns true until the first call to Close(). Writers should</span>
        <span class="c">///</span><span class="c"> check IsOpen to determine if a write operation can be made.  Note that</span>
        <span class="c">///</span><span class="c"> writers need to catch </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="ExecutionExceptions.cs.html#1496d52396952a52" class="t t">PipelineClosedException</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c">.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">seealso</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="#6abc1682053f7009" class="i property">EndOfPipeline</a><span class="c">&quot;</span><span class="c">/&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>internal abstract bool</b> <a id="eff54ee10bba7a56" href="../R/eff54ee10bba7a56.html" target="n" data-glyph="104,1" class="i property">IsOpen</a> { <b>get</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Returns the number of objects in the stream.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal abstract int</b> <a id="01c58f66ddc41629" href="../R/01c58f66ddc41629.html" target="n" data-glyph="104,1" class="i property">Count</a> { <b>get</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Return a PipelineReader(object) for this stream.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal abstract</b> <a href="IObjectReader.cs.html#6b2221741902f9bd" class="t t">PipelineReader</a>&lt;<b>object</b>&gt; <a id="8ea6b41cfdf95aa1" href="../R/8ea6b41cfdf95aa1.html" target="n" data-glyph="104,1" class="i property">ObjectReader</a> { <b>get</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Return a PipelineReader(PSObject) for this stream.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal abstract</b> <a href="IObjectReader.cs.html#6b2221741902f9bd" class="t t">PipelineReader</a>&lt;<a href="../engine/MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt; <a id="c28528f67f6c96bb" href="../R/c28528f67f6c96bb.html" target="n" data-glyph="104,1" class="i property">PSObjectReader</a> { <b>get</b>; }
 
        <span class="c">// 913921-2005/07/08 ObjectWriter can be retrieved on a closed stream</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Return an PipelineWriter for this stream.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal abstract</b> <a href="IObjectWriter.cs.html#37301df630b2ae9a" class="t t">PipelineWriter</a> <a id="3cd6a8df464ccd7a" href="../R/3cd6a8df464ccd7a.html" target="n" data-glyph="104,1" class="i property">ObjectWriter</a> { <b>get</b>; }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Read Abstractions
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Read a single object from the stream.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">The next object in the stream or AutomationNull if EndOfPipeline is reached.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span><span class="c">This method blocks if the stream is empty</span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>internal virtual object</b> <a id="de185c166d88dfca" href="../R/de185c166d88dfca.html" target="n" data-glyph="74,1" class="i method">Read</a>()
        {
            <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="MshTraceSource.cs.html#18f73963f5ead5c2" class="i method">NewNotSupportedException</a>();
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Read at most </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r2 r">count</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> objects.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r2 r">count</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The maximum number of objects to read.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">The objects read.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">ArgumentOutOfRangeException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r2 r">count</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> is less than 0</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This method blocks if the number of objects in the stream is less than </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r2 r">count</span><span class="c">&quot;</span><span class="c">/&gt;</span>
        <span class="c">///</span><span class="c"> and the stream is not closed.</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> If there are multiple reader threads, the objects returned</span>
        <span class="c">///</span><span class="c"> to blocking reads Read(int count) and ReadToEnd()</span>
        <span class="c">///</span><span class="c"> are not necessarily single blocks of objects added to the</span>
        <span class="c">///</span><span class="c"> stream in that order.  For example, if ABCDEF are added to the</span>
        <span class="c">///</span><span class="c"> stream, one reader may get ABDE and the other may get CF.</span>
        <span class="c">///</span><span class="c"> Each reader reads items from the stream as they become available.</span>
        <span class="c">///</span><span class="c"> Otherwise, if a maximum _capacity has been imposed, the writer</span>
        <span class="c">///</span><span class="c"> and reader could become mutually deadlocked.</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> When there are multiple blocked readers, any of the readers</span>
        <span class="c">///</span><span class="c"> may get the next object(s) added.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>internal virtual</b> <span class="i">Collection</span>&lt;<b>object</b>&gt; <a id="ed04bfd08df9dbc8" href="../R/ed04bfd08df9dbc8.html" target="n" data-glyph="74,1" class="i method">Read</a>(<b>int</b> <span id="r2 rd" class="r2 r">count</span>)
        {
            <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="MshTraceSource.cs.html#18f73963f5ead5c2" class="i method">NewNotSupportedException</a>();
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Blocks until the pipeline closes and reads all objects.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">A collection of zero or more objects.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If the stream is empty, a collection of size zero is returned.</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> If there are multiple reader threads, the objects returned</span>
        <span class="c">///</span><span class="c"> to blocking reads Read(int count) and ReadToEnd()</span>
        <span class="c">///</span><span class="c"> are not necessarily single blocks of objects added to the</span>
        <span class="c">///</span><span class="c"> stream in that order.  For example, if ABCDEF are added to the</span>
        <span class="c">///</span><span class="c"> stream, one reader may get ABDE and the other may get CF.</span>
        <span class="c">///</span><span class="c"> Each reader reads items from the stream as they become available.</span>
        <span class="c">///</span><span class="c"> Otherwise, if a maximum _capacity has been imposed, the writer</span>
        <span class="c">///</span><span class="c"> and reader could become mutually deadlocked.</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> When there are multiple blocked readers, any of the readers</span>
        <span class="c">///</span><span class="c"> may get the next object(s) added.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>internal virtual</b> <span class="i">Collection</span>&lt;<b>object</b>&gt; <a id="9c93f6b4d088ff5f" href="../R/9c93f6b4d088ff5f.html" target="n" data-glyph="74,1" class="i method">ReadToEnd</a>()
        {
            <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="MshTraceSource.cs.html#18f73963f5ead5c2" class="i method">NewNotSupportedException</a>();
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Reads objects currently in the stream, but does not block.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">An array of zero or more objects.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This method performs a read of objects currently in the</span>
        <span class="c">///</span><span class="c"> stream. The method will block until exclusive access to the</span>
        <span class="c">///</span><span class="c"> stream is acquired.  If there are no objects in the stream,</span>
        <span class="c">///</span><span class="c"> an empty array is returned.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r3 r">maxRequested</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Return no more than maxRequested objects.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">ArgumentOutOfRangeException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r3 r">maxRequested</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> is less than 0</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>internal virtual</b> <span class="i">Collection</span>&lt;<b>object</b>&gt; <a id="8d5fae42038b28d3" href="../R/8d5fae42038b28d3.html" target="n" data-glyph="74,1" class="i method">NonBlockingRead</a>(<b>int</b> <span id="r3 rd" class="r3 r">maxRequested</span>)
        {
            <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="MshTraceSource.cs.html#18f73963f5ead5c2" class="i method">NewNotSupportedException</a>();
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Peek the next object.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The next object in the stream or AutomationNull.Value if the stream is empty</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="ExecutionExceptions.cs.html#1496d52396952a52" class="t t">PipelineClosedException</a><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The ObjectStream is closed.</span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>internal virtual object</b> <a id="6492437245a546e3" href="../R/6492437245a546e3.html" target="n" data-glyph="74,1" class="i method">Peek</a>()
        {
            <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="MshTraceSource.cs.html#18f73963f5ead5c2" class="i method">NewNotSupportedException</a>();
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Write Abstractions
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Writes a object to the current position in the stream and</span>
        <span class="c">///</span><span class="c"> advances the position within the stream by one object.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r4 r">value</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The object to write to the stream.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> One, if the write was successful, otherwise;</span>
        <span class="c">///</span><span class="c"> zero if the stream was closed before the object could be written,</span>
        <span class="c">///</span><span class="c"> or if the object was AutomationNull.Value.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="ExecutionExceptions.cs.html#1496d52396952a52" class="t t">PipelineClosedException</a><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The stream is closed</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> AutomationNull.Value is ignored</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>internal virtual int</b> <a id="c3e6a49bad4b1dfe" href="../R/c3e6a49bad4b1dfe.html" target="n" data-glyph="74,1" class="i method">Write</a>(<b>object</b> <span id="r4 rd" class="r4 r">value</span>)
        {
            <b>return</b> <a href="#e4d41c20de29e531" class="i method">Write</a>(<span class="r4 r">value</span>, <b>false</b>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Write objects to the underlying stream.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r5 r">obj</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Object or enumeration to read from.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r6 r">enumerateCollection</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If enumerateCollection is true, and </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r5 r">obj</span><span class="c">&quot;</span><span class="c">/&gt;</span>
        <span class="c">///</span><span class="c"> is an enumeration according to LanguagePrimitives.GetEnumerable,</span>
        <span class="c">///</span><span class="c"> the objects in the enumeration will be unrolled and</span>
        <span class="c">///</span><span class="c"> written separately.  Otherwise, </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r5 r">obj</span><span class="c">&quot;</span><span class="c">/&gt;</span>
        <span class="c">///</span><span class="c"> will be written as a single object.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">The number of objects written.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="ExecutionExceptions.cs.html#1496d52396952a52" class="t t">PipelineClosedException</a><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The underlying stream is closed</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If the enumeration contains elements equal to</span>
        <span class="c">///</span><span class="c"> AutomationNull.Value, they are ignored.</span>
        <span class="c">///</span><span class="c"> This can cause the return value to be less than the size of</span>
        <span class="c">///</span><span class="c"> the collection.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>internal virtual int</b> <a id="e4d41c20de29e531" href="../R/e4d41c20de29e531.html" target="n" data-glyph="74,1" class="i method">Write</a>(<b>object</b> <span id="r5 rd" class="r5 r">obj</span>, <b>bool</b> <span id="r6 rd" class="r6 r">enumerateCollection</span>)
        {
            <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="MshTraceSource.cs.html#18f73963f5ead5c2" class="i method">NewNotSupportedException</a>();
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Close / Flush
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Close the stream.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Causes subsequent calls to IsOpen to return false and calls to</span>
        <span class="c">///</span><span class="c"> a write operation to throw PipelineClosedException.</span>
        <span class="c">///</span><span class="c"> All calls to Close() after the first call are silently ignored.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>internal virtual void</b> <a id="2bbebf10cbee9e83" href="../R/2bbebf10cbee9e83.html" target="n" data-glyph="74,1" class="i method">Close</a>()
        {
            <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="MshTraceSource.cs.html#18f73963f5ead5c2" class="i method">NewNotSupportedException</a>();
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Flush the data from the stream.  Closed streams may be flushed.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal virtual void</b> <a id="a9c3d612218fd718" href="../R/a9c3d612218fd718.html" target="n" data-glyph="74,1" class="i method">Flush</a>()
        {
            <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="MshTraceSource.cs.html#18f73963f5ead5c2" class="i method">NewNotSupportedException</a>();
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> IDisposable
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Public method for dispose.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public void</b> <a id="e609f46566bbc0e2" href="../R/e609f46566bbc0e2.html" target="n" data-glyph="72,1" class="i method">Dispose</a>()
        {
            <a href="#12cee89e3cc553f7" class="i method">Dispose</a>(<b>true</b>);
 
            <span class="i">GC</span>.<span class="i">SuppressFinalize</span>(<a href="#27e9349816faeecb" class="k">this</a>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Release all resources.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r7 r">disposing</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">If true, release all managed resources.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>protected abstract void</b> <a id="12cee89e3cc553f7" href="../R/12cee89e3cc553f7.html" target="n" data-glyph="75,1" class="i method">Dispose</a>(<b>bool</b> <span id="r7 rd" class="r7 r">disposing</span>);
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> IDisposable
    }
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> A FIFO memory based object stream.</span>
    <span class="c">///</span><span class="c"> The purpose of this stream class is to provide the</span>
    <span class="c">///</span><span class="c"> semantics of a unidirectional stream of objects</span>
    <span class="c">///</span><span class="c"> between two threads using a dynamic memory buffer.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> The stream may be bound or unbounded.  Bounded streams</span>
    <span class="c">///</span><span class="c"> are created via passing a capacity to the constructor.</span>
    <span class="c">///</span><span class="c"> Unbounded streams are created using the default constructor.</span>
    <span class="c">///</span>
    <span class="c">///</span><span class="c"> The capacity of the stream can not be changed after</span>
    <span class="c">///</span><span class="c"> construction.</span>
    <span class="c">///</span>
    <span class="c">///</span><span class="c"> For bounded streams, attempts to write to the stream when</span>
    <span class="c">///</span><span class="c"> the capacity has been reached causes the writer to block</span>
    <span class="c">///</span><span class="c"> until objects are read.</span>
    <span class="c">///</span>
    <span class="c">///</span><span class="c"> For unbounded streams, writers only block for the amount</span>
    <span class="c">///</span><span class="c"> of time needed to acquire exclusive access to the</span>
    <span class="c">///</span><span class="c"> stream.  Note that unbounded streams have a capacity of</span>
    <span class="c">///</span><span class="c"> of Int32.MaxValue objects.  In theory, if this limit were</span>
    <span class="c">///</span><span class="c"> reached, the stream would function as a bounded stream.</span>
    <span class="c">///</span>
    <span class="c">///</span><span class="c"> This class is safe for multi-threaded use with the following</span>
    <span class="c">///</span><span class="c"> side-effects:</span>
    <span class="c">///</span>
    <span class="c">///</span><span class="c"> &gt; For bounded streams, write operations are not guaranteed to</span>
    <span class="c">///</span><span class="c"> be atomic.  If a write operation causes the capacity to be</span>
    <span class="c">///</span><span class="c"> reached without writing all data, a partial write occurs and</span>
    <span class="c">///</span><span class="c"> the writer blocks until data is read from the stream.</span>
    <span class="c">///</span>
    <span class="c">///</span><span class="c"> &gt; When multiple writer or reader threads are used, the order</span>
    <span class="c">///</span><span class="c"> the reader or writer acquires a lock on the stream is</span>
    <span class="c">///</span><span class="c"> undefined.  This means that the first call to write does not</span>
    <span class="c">///</span><span class="c"> guarantee the writer will acquire a write lock first.  The first</span>
    <span class="c">///</span><span class="c"> call to read does not guarantee the reader will acquire the</span>
    <span class="c">///</span><span class="c"> read lock first.</span>
    <span class="c">///</span>
    <span class="c">///</span><span class="c"> &gt; Reads and writes may occur in any order. With a bounded</span>
    <span class="c">///</span><span class="c"> stream, write operations between threads may also result in</span>
    <span class="c">///</span><span class="c"> interleaved write operations.</span>
    <span class="c">///</span>
    <span class="c">///</span><span class="c"> The result is that the order of data is only guaranteed if there is a</span>
    <span class="c">///</span><span class="c"> single writer.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
    <span class="c">// 897230-2003/10/29-JonN marked sealed</span>
    <span class="c">// 905990-2005/05/10-JonN Removed IDisposable</span>
    <b>internal sealed class</b> <a id="247cf7c4c5dec5a4" href="../R/247cf7c4c5dec5a4.html" target="n" data-glyph="2,0" class="t t">ObjectStream</a> : <a href="#27e9349816faeecb" class="t t">ObjectStreamBase</a>, <span class="i">IDisposable</span>
    {
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Private Fields
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Objects in the stream.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">// PERF-2003/08/22-JonN We should probably use Queue instead</span>
        <span class="c">// PERF-2004/06/30-JonN Probably more efficient to use type</span>
        <span class="c">//  Collection&lt;object&gt; as the underlying store</span>
        <b>private readonly</b> <span class="i">List</span>&lt;<b>object</b>&gt; <a id="b65958155e22f9c7" href="../R/b65958155e22f9c7.html" target="n" data-glyph="46,1" class="i field">_objects</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Is the stream open or closed for writing?</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private bool</b> <a id="2127e0b9fd2df4c7" href="../R/2127e0b9fd2df4c7.html" target="n" data-glyph="46,1" class="i field">_isOpen</a>;
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Synchronization handles
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Read handle - signaled when data is ready to read.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This event may, on occasion, be signalled even when there is</span>
        <span class="c">///</span><span class="c"> no data available.  If this happens, just wait again.</span>
        <span class="c">///</span><span class="c"> Never wait on this event alone.  Since this is an AutoResetEvent,</span>
        <span class="c">///</span><span class="c"> there is no way to definitely release all blocked threads when</span>
        <span class="c">///</span><span class="c"> the stream is closed for reading.  Instead, use WaitAny on</span>
        <span class="c">///</span><span class="c"> this handle and also _readClosedHandle.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>private readonly</b> <span class="i">AutoResetEvent</span> <a id="70e29f44d8dc03b2" href="../R/70e29f44d8dc03b2.html" target="n" data-glyph="46,1" class="i field">_readHandle</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Handle returned to callers for blocking on data ready.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private</b> <span class="i">ManualResetEvent</span> <a id="b963c4b9129d5be1" href="../R/b963c4b9129d5be1.html" target="n" data-glyph="46,1" class="i field">_readWaitHandle</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> When this handle is set, the stream is closed for reading,</span>
        <span class="c">///</span><span class="c"> so all blocked readers should be released.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private readonly</b> <span class="i">ManualResetEvent</span> <a id="3858e3ee0d14b4ee" href="../R/3858e3ee0d14b4ee.html" target="n" data-glyph="46,1" class="i field">_readClosedHandle</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Write handle - signaled with the number of objects in the</span>
        <span class="c">///</span><span class="c"> stream becomes less than the maximum number of objects</span>
        <span class="c">///</span><span class="c"> allowed in the stream.  </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="#59a35f0b691a0c76" class="i field">_capacity</a><span class="c">&quot;</span><span class="c">/&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This event may, on occasion, be signalled even when there is</span>
        <span class="c">///</span><span class="c"> no write buffer available.  If this happens, just wait again.</span>
        <span class="c">///</span><span class="c"> Never wait on this event alone.  Since this is an AutoResetEvent,</span>
        <span class="c">///</span><span class="c"> there is no way to definitely release all blocked threads when</span>
        <span class="c">///</span><span class="c"> the stream is closed for writing.  Instead, use WaitAny on</span>
        <span class="c">///</span><span class="c"> this handle and also _writeClosedHandle.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>private readonly</b> <span class="i">AutoResetEvent</span> <a id="255476bfd5fff27e" href="../R/255476bfd5fff27e.html" target="n" data-glyph="46,1" class="i field">_writeHandle</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Handle returned to callers for blocking until buffer space</span>
        <span class="c">///</span><span class="c"> is available for write.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private</b> <span class="i">ManualResetEvent</span> <a id="7b815a72610473b5" href="../R/7b815a72610473b5.html" target="n" data-glyph="46,1" class="i field">_writeWaitHandle</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> When this handle is set, the stream is closed for writing,</span>
        <span class="c">///</span><span class="c"> so all blocked readers should be released.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private readonly</b> <span class="i">ManualResetEvent</span> <a id="bac0959dcfd7d589" href="../R/bac0959dcfd7d589.html" target="n" data-glyph="46,1" class="i field">_writeClosedHandle</a>;
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Synchronization handles
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The object reader for this stream.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This field is allocated on first demand and</span>
        <span class="c">///</span><span class="c"> returned on subsequent calls.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>private</b> <a href="IObjectReader.cs.html#6b2221741902f9bd" class="t t">PipelineReader</a>&lt;<b>object</b>&gt; <a id="dac598ac81a5c871" href="../R/dac598ac81a5c871.html" target="n" data-glyph="46,1" class="i field">_reader</a> = <b>null</b>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The PSObject reader for this stream.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This field is allocated on first demand and</span>
        <span class="c">///</span><span class="c"> returned on subsequent calls.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>private</b> <a href="IObjectReader.cs.html#6b2221741902f9bd" class="t t">PipelineReader</a>&lt;<a href="../engine/MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt; <a id="0fd741959c2e8d00" href="../R/0fd741959c2e8d00.html" target="n" data-glyph="46,1" class="i field">_mshreader</a> = <b>null</b>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The object writer for this stream.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This field is allocated on first demand and</span>
        <span class="c">///</span><span class="c"> returned on subsequent calls.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>private</b> <a href="IObjectWriter.cs.html#37301df630b2ae9a" class="t t">PipelineWriter</a> <a id="444c97e084f5c4ca" href="../R/444c97e084f5c4ca.html" target="n" data-glyph="46,1" class="i field">_writer</a> = <b>null</b>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Maximum number of objects allowed in the stream</span>
        <span class="c">///</span><span class="c"> Note that this is not permitted to be more than Int32.MaxValue,</span>
        <span class="c">///</span><span class="c"> since the underlying list has this limitation.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private readonly int</b> <a id="59a35f0b691a0c76" href="../R/59a35f0b691a0c76.html" target="n" data-glyph="46,1" class="i field">_capacity</a> = <span class="i">Int32</span>.<span class="i">MaxValue</span>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This object is used to acquire an exclusive lock on the stream.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Note that we lock _monitorObject rather than &quot;this&quot; so that</span>
        <span class="c">///</span><span class="c"> we are protected from outside code interfering in our</span>
        <span class="c">///</span><span class="c"> critical section.  Thanks to Wintellect for the hint.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>private readonly object</b> <a id="9ee3474c24ae825e" href="../R/9ee3474c24ae825e.html" target="n" data-glyph="46,1" class="i field">_monitorObject</a> = <b>new</b> <b>object</b>();
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Indicates if this stream has already been disposed.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private bool</b> <a id="05aff2cf763f638d" href="../R/05aff2cf763f638d.html" target="n" data-glyph="46,1" class="i field">_disposed</a> = <b>false</b>;
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Private Fields
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Ctor
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Default constructor.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Constructs a stream with a maximum size of Int32.Max</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>internal</b> <a id="9f848b3587e1f797" href="../R/9f848b3587e1f797.html" target="n" data-glyph="74,1" class="t constructor">ObjectStream</a>()
            : <b>this</b>(<span class="i">Int32</span>.<span class="i">MaxValue</span>)
        {
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Allocate the stream with an initial size.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r8 r">capacity</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The maximum number of objects to allow in the buffer at a time.</span>
        <span class="c">///</span><span class="c"> Note that this is not permitted to be more than Int32.MaxValue,</span>
        <span class="c">///</span><span class="c"> since the underlying list has this limitation</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">ArgumentOutOfRangeException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="i">_capacity</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> is less than or equal to zero</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="i">_capacity</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> is greater than Int32.MaxValue</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>internal</b> <a id="24e257f8925c32e0" href="../R/../../0000000000.html" target="n" data-glyph="74,1" class="t constructor">ObjectStream</a>(<b>int</b> <span id="r8 rd" class="r8 r">capacity</span>)
        {
            <b>if</b> (<span class="r8 r">capacity</span> &lt;= 0 || <span class="r8 r">capacity</span> &gt; <span class="i">Int32</span>.<span class="i">MaxValue</span>)
            {
                <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="MshTraceSource.cs.html#3ec1a8e5fa36a1b2" class="i method">NewArgumentOutOfRangeException</a>(<b>nameof</b>(<span class="r8 r">capacity</span>), <span class="r8 r">capacity</span>);
            }
 
            <span class="c">// the maximum number of objects to allow in the stream at a given time.</span>
            <a href="#59a35f0b691a0c76" class="i field">_capacity</a> = <span class="r8 r">capacity</span>;
 
            <span class="c">// event is not signaled since there is no data to read</span>
            <a href="#70e29f44d8dc03b2" class="i field">_readHandle</a> = <b>new</b> <span class="i">AutoResetEvent</span>(<b>false</b>);
 
            <span class="c">// event is signaled since there is available buffer space</span>
            <a href="#255476bfd5fff27e" class="i field">_writeHandle</a> = <b>new</b> <span class="i">AutoResetEvent</span>(<b>true</b>);
 
            <span class="c">// event is not signaled since the thread is still readable</span>
            <a href="#3858e3ee0d14b4ee" class="i field">_readClosedHandle</a> = <b>new</b> <span class="i">ManualResetEvent</span>(<b>false</b>);
 
            <span class="c">// event is signaled since the thread is still writeable</span>
            <a href="#bac0959dcfd7d589" class="i field">_writeClosedHandle</a> = <b>new</b> <span class="i">ManualResetEvent</span>(<b>false</b>);
 
            <span class="c">// the FIFO set of objects in the stream</span>
            <a href="#b65958155e22f9c7" class="i field">_objects</a> = <b>new</b> <span class="i">List</span>&lt;<b>object</b>&gt;();
 
            <span class="c">// Is the stream open?</span>
            <a href="#2127e0b9fd2df4c7" class="i field">_isOpen</a> = <b>true</b>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Ctor
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> internal properties
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Get the capacity of the stream.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">value</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The capacity of the stream.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">value</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The capacity is the number of objects the stream may contain at one time.  Once this</span>
        <span class="c">///</span><span class="c"> limit is reached, attempts to write into the stream block until buffer space</span>
        <span class="c">///</span><span class="c"> becomes available.</span>
        <span class="c">///</span><span class="c"> MaxCapacity cannot change, so we can skip the lock.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>internal override int</b> <a id="c3246d2f7fa7b14c" href="../R/c3246d2f7fa7b14c.html" target="n" data-glyph="104,1" class="i property">MaxCapacity</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#59a35f0b691a0c76" class="i field">_capacity</a>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Waitable handle for callers to wait on until data ready to read.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The handle is set when data becomes available to read or</span>
        <span class="c">///</span><span class="c"> when a partial read has completed.  If multiple readers</span>
        <span class="c">///</span><span class="c"> are used, setting the handle does not guarantee that</span>
        <span class="c">///</span><span class="c"> a read operation will return data. If using multiple</span>
        <span class="c">///</span><span class="c"> reader threads, </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="#d427df41689c67c8" class="i method">NonBlockingRead</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> for</span>
        <span class="c">///</span><span class="c"> performing non-blocking reads.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>internal override</b> <span class="i">WaitHandle</span> <a id="ed85295ded657f36" href="../R/ed85295ded657f36.html" target="n" data-glyph="104,1" class="i property">ReadHandle</a>
        {
            <b>get</b>
            {
                <span class="i">WaitHandle</span> <span id="r9 rd" class="r9 r">handle</span> = <b>null</b>;
 
                <b>lock</b> (<a href="#9ee3474c24ae825e" class="i field">_monitorObject</a>)
                {
                    <b>if</b> (<a href="#b963c4b9129d5be1" class="i field">_readWaitHandle</a> == <b>null</b>)
                    {
                        <span class="c">// Create the handle signaled if there are objects in the stream</span>
                        <span class="c">// or the stream has been closed.  The closed scenario addresses</span>
                        <span class="c">// Pipeline readers that execute asynchronously.  Since the pipeline</span>
                        <span class="c">// may complete with zero objects before the caller objects this</span>
                        <span class="c">// handle, it will block indefinitely unless it is set.</span>
                        <a href="#b963c4b9129d5be1" class="i field">_readWaitHandle</a> = <b>new</b> <span class="i">ManualResetEvent</span>(<a href="#b65958155e22f9c7" class="i field">_objects</a>.<span class="i">Count</span> &gt; 0 || !<a href="#2127e0b9fd2df4c7" class="i field">_isOpen</a>);
                    }
 
                    <span class="r9 r">handle</span> = <a href="#b963c4b9129d5be1" class="i field">_readWaitHandle</a>;
                }
 
                <b>return</b> <span class="r9 r">handle</span>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Waitable handle for callers to block until buffer space becomes available.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The handle is set when space becomes available for writing. For multiple</span>
        <span class="c">///</span><span class="c"> writer threads writing to a bounded stream, the writer may still block</span>
        <span class="c">///</span><span class="c"> if another thread fills the stream to capacity.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>internal override</b> <span class="i">WaitHandle</span> <a id="b2bd4bea5c3a3e9f" href="../R/b2bd4bea5c3a3e9f.html" target="n" data-glyph="104,1" class="i property">WriteHandle</a>
        {
            <b>get</b>
            {
                <span class="i">WaitHandle</span> <span id="r10 rd" class="r10 r">handle</span> = <b>null</b>;
 
                <b>lock</b> (<a href="#9ee3474c24ae825e" class="i field">_monitorObject</a>)
                {
                    <b>if</b> (<a href="#7b815a72610473b5" class="i field">_writeWaitHandle</a> == <b>null</b>)
                    {
                        <a href="#7b815a72610473b5" class="i field">_writeWaitHandle</a> = <b>new</b> <span class="i">ManualResetEvent</span>(<a href="#b65958155e22f9c7" class="i field">_objects</a>.<span class="i">Count</span> &lt; <a href="#59a35f0b691a0c76" class="i field">_capacity</a> || !<a href="#2127e0b9fd2df4c7" class="i field">_isOpen</a>);
                    }
 
                    <span class="r10 r">handle</span> = <a href="#7b815a72610473b5" class="i field">_writeWaitHandle</a>;
                }
 
                <b>return</b> <span class="r10 r">handle</span>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Return a PipelineReader(object) for this stream.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal override</b> <a href="IObjectReader.cs.html#6b2221741902f9bd" class="t t">PipelineReader</a>&lt;<b>object</b>&gt; <a id="abc89c235e72527c" href="../R/abc89c235e72527c.html" target="n" data-glyph="104,1" class="i property">ObjectReader</a>
        {
            <b>get</b>
            {
                <a href="IObjectReader.cs.html#6b2221741902f9bd" class="t t">PipelineReader</a>&lt;<b>object</b>&gt; <span id="r11 rd" class="r11 r">reader</span> = <b>null</b>;
 
                <b>lock</b> (<a href="#9ee3474c24ae825e" class="i field">_monitorObject</a>)
                {
                    <b>if</b> (<a href="#dac598ac81a5c871" class="i field">_reader</a> == <b>null</b>)
                    {
                        <span class="c">// Always return an object reader, even if the stream</span>
                        <span class="c">// is closed. This is to address requesting the object reader</span>
                        <span class="c">// after calling Pipeline.Execute(). NOTE: If Execute completes</span>
                        <span class="c">// without writing data to the output queue, the</span>
                        <span class="c">// stream will be in the EndOfPipeline state because the</span>
                        <span class="c">// stream is closed and has zero data.  Since this is a valid</span>
                        <span class="c">// and expected execution path, we don&#39;t want to throw an exception.</span>
                        <a href="#dac598ac81a5c871" class="i field">_reader</a> = <b>new</b> <a href="ObjectReader.cs.html#9bc1423ebb10db57" class="t constructor">ObjectReader</a>(<a href="#247cf7c4c5dec5a4" class="k">this</a>);
                    }
 
                    <span class="r11 r">reader</span> = <a href="#dac598ac81a5c871" class="i field">_reader</a>;
                }
 
                <b>return</b> <span class="r11 r">reader</span>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Return a PipelineReader(PSObject) for this stream.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal override</b> <a href="IObjectReader.cs.html#6b2221741902f9bd" class="t t">PipelineReader</a>&lt;<a href="../engine/MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt; <a id="6bd692b1f0f862ab" href="../R/6bd692b1f0f862ab.html" target="n" data-glyph="104,1" class="i property">PSObjectReader</a>
        {
            <b>get</b>
            {
                <a href="IObjectReader.cs.html#6b2221741902f9bd" class="t t">PipelineReader</a>&lt;<a href="../engine/MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt; <span id="r12 rd" class="r12 r">reader</span> = <b>null</b>;
 
                <b>lock</b> (<a href="#9ee3474c24ae825e" class="i field">_monitorObject</a>)
                {
                    <b>if</b> (<a href="#0fd741959c2e8d00" class="i field">_mshreader</a> == <b>null</b>)
                    {
                        <span class="c">// Always return an object reader, even if the stream</span>
                        <span class="c">// is closed. This is to address requesting the object reader</span>
                        <span class="c">// after calling Pipeline.Execute(). NOTE: If Execute completes</span>
                        <span class="c">// without writing data to the output queue, the</span>
                        <span class="c">// stream will be in the EndOfPipeline state because the</span>
                        <span class="c">// stream is closed and has zero data.  Since this is a valid</span>
                        <span class="c">// and expected execution path, we don&#39;t want to throw an exception.</span>
                        <a href="#0fd741959c2e8d00" class="i field">_mshreader</a> = <b>new</b> <a href="ObjectReader.cs.html#8ff5ec3b17721619" class="t constructor">PSObjectReader</a>(<a href="#247cf7c4c5dec5a4" class="k">this</a>);
                    }
 
                    <span class="r12 r">reader</span> = <a href="#0fd741959c2e8d00" class="i field">_mshreader</a>;
                }
 
                <b>return</b> <span class="r12 r">reader</span>;
            }
        }
 
        <span class="c">// 913921-2005/07/08 ObjectWriter can be retrieved on a closed stream</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Return an PipelineWriter for this stream.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal override</b> <a href="IObjectWriter.cs.html#37301df630b2ae9a" class="t t">PipelineWriter</a> <a id="fc0d00ddb2d6ec0c" href="../R/fc0d00ddb2d6ec0c.html" target="n" data-glyph="104,1" class="i property">ObjectWriter</a>
        {
            <b>get</b>
            {
                <a href="IObjectWriter.cs.html#37301df630b2ae9a" class="t t">PipelineWriter</a> <span id="r13 rd" class="r13 r">writer</span> = <b>null</b>;
 
                <b>lock</b> (<a href="#9ee3474c24ae825e" class="i field">_monitorObject</a>)
                {
                    <b>if</b> (<a href="#444c97e084f5c4ca" class="i field">_writer</a> == <b>null</b>)
                    {
                        <a href="#444c97e084f5c4ca" class="i field">_writer</a> = <b>new</b> <a href="ObjectWriter.cs.html#94edcdcae9cbb40e" class="t constructor">ObjectWriter</a>(<a href="#247cf7c4c5dec5a4" class="k">this</a>) <b>as</b> <a href="IObjectWriter.cs.html#37301df630b2ae9a" class="t t">PipelineWriter</a>;
                    }
 
                    <span class="r13 r">writer</span> = <a href="#444c97e084f5c4ca" class="i field">_writer</a>;
                }
 
                <b>return</b> <span class="r13 r">writer</span>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Determine if we are at the end of the stream.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> EndOfPipeline is defined as the stream being closed and containing</span>
        <span class="c">///</span><span class="c"> zero objects.  Readers check this to determine if any objects</span>
        <span class="c">///</span><span class="c"> are in the stream.  Writers should check </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="#cf84b1b3e5f2d945" class="i property">IsOpen</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> to determine</span>
        <span class="c">///</span><span class="c"> if the stream can be written to.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>internal override bool</b> <a id="d19aa95533ded62b" href="../R/d19aa95533ded62b.html" target="n" data-glyph="104,1" class="i property">EndOfPipeline</a>
        {
            <b>get</b>
            {
                <b>bool</b> <span id="r14 rd" class="r14 r">endOfStream</span> = <b>true</b>;
 
                <b>lock</b> (<a href="#9ee3474c24ae825e" class="i field">_monitorObject</a>)
                {
                    <span class="r14 r">endOfStream</span> = (<a href="#b65958155e22f9c7" class="i field">_objects</a>.<span class="i">Count</span> == 0 &amp;&amp; !<a href="#2127e0b9fd2df4c7" class="i field">_isOpen</a>);
                }
 
                <b>return</b> <span class="r14 r">endOfStream</span>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Check if the stream is open for further writes.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">True if the stream is open, false if not.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> IsOpen returns true until the first call to Close(). Writers should</span>
        <span class="c">///</span><span class="c"> check IsOpen to determine if a write operation can be made.  Note that</span>
        <span class="c">///</span><span class="c"> writers need to catch </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="ExecutionExceptions.cs.html#1496d52396952a52" class="t t">PipelineClosedException</a><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c">.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">seealso</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="#d19aa95533ded62b" class="i property">EndOfPipeline</a><span class="c">&quot;</span><span class="c">/&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>internal override bool</b> <a id="cf84b1b3e5f2d945" href="../R/cf84b1b3e5f2d945.html" target="n" data-glyph="104,1" class="i property">IsOpen</a>
        {
            <b>get</b>
            {
                <b>bool</b> <span id="r15 rd" class="r15 r">isOpen</span> = <b>true</b>;
                <span class="c">// 2003/09/02-JonN Hitesh says that the access</span>
                <span class="c">// of a bool variable is atomic so there is no need</span>
                <span class="c">// for the lock.</span>
                <b>lock</b> (<a href="#9ee3474c24ae825e" class="i field">_monitorObject</a>)
                {
                    <span class="r15 r">isOpen</span> = <a href="#2127e0b9fd2df4c7" class="i field">_isOpen</a>;
                }
 
                <b>return</b> <span class="r15 r">isOpen</span>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Returns the number of objects in the stream.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal override int</b> <a id="b5624cc19833edff" href="../R/b5624cc19833edff.html" target="n" data-glyph="104,1" class="i property">Count</a>
        {
            <b>get</b>
            {
                <b>int</b> <span id="r16 rd" class="r16 r">count</span> = 0;
 
                <b>lock</b> (<a href="#9ee3474c24ae825e" class="i field">_monitorObject</a>)
                {
                    <span class="r16 r">count</span> = <a href="#b65958155e22f9c7" class="i field">_objects</a>.<span class="i">Count</span>;
                }
 
                <b>return</b> <span class="r16 r">count</span>;
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> internal properties
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> private locking code
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Wait for data to be readable.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">True if EndOfPipeline is not reached.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> WaitRead does not guarantee that data is present in the stream,</span>
        <span class="c">///</span><span class="c"> only that data was added when the event was signaled.  Since there may be</span>
        <span class="c">///</span><span class="c"> multiple readers, data may be removed from the stream</span>
        <span class="c">///</span><span class="c"> before the caller has a chance to read the data.</span>
        <span class="c">///</span><span class="c"> This method should never be called within a lock(_monitorObject).</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>private bool</b> <a id="10c14ae9e9478af9" href="../R/10c14ae9e9478af9.html" target="n" data-glyph="76,1" class="i method">WaitRead</a>()
        {
            <b>if</b> (!<a href="#d19aa95533ded62b" class="i property">EndOfPipeline</a>)
            {
                <b>try</b>
                {
                    <span class="i">WaitHandle</span>[] <span id="r17 rd" class="r17 r">ha</span> = { <a href="#70e29f44d8dc03b2" class="i field">_readHandle</a>, <a href="#3858e3ee0d14b4ee" class="i field">_readClosedHandle</a> };
                    <span class="i">WaitHandle</span>.<span class="i">WaitAny</span>(<span class="r17 r">ha</span>); <span class="c">// ignore return value</span>
                }
                <b>catch</b> (<span class="i">ObjectDisposedException</span>)
                {
                    <span class="c">// Since the _readHandle must be acquired outside</span>
                    <span class="c">// a lock there&#39;s a chance that it was</span>
                    <span class="c">// disposed after checking EndOfPipeline</span>
                }
            }
 
            <b>return</b> !<a href="#d19aa95533ded62b" class="i property">EndOfPipeline</a>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Wait for data to be writeable.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">True if the stream is writeable, otherwise; false.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> WaitWrite does not guarantee that buffer space will be available in the stream</span>
        <span class="c">///</span><span class="c"> when the caller attempts to write, only that buffer space was available</span>
        <span class="c">///</span><span class="c"> when the event was signaled.</span>
        <span class="c">///</span><span class="c"> This method should never be called within a lock(_monitorObject).</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>private bool</b> <a id="3f544feeedfcd889" href="../R/3f544feeedfcd889.html" target="n" data-glyph="76,1" class="i method">WaitWrite</a>()
        {
            <b>if</b> (<a href="#cf84b1b3e5f2d945" class="i property">IsOpen</a>)
            {
                <b>try</b>
                {
                    <span class="i">WaitHandle</span>[] <span id="r18 rd" class="r18 r">ha</span> = { <a href="#255476bfd5fff27e" class="i field">_writeHandle</a>, <a href="#bac0959dcfd7d589" class="i field">_writeClosedHandle</a> };
                    <span class="i">WaitHandle</span>.<span class="i">WaitAny</span>(<span class="r18 r">ha</span>); <span class="c">// ignore return value</span>
                }
                <b>catch</b> (<span class="i">ObjectDisposedException</span>)
                {
                    <span class="c">// Since the _writeHandle must be acquired outside</span>
                    <span class="c">// a lock there&#39;s a chance that it was</span>
                    <span class="c">// disposed after checking IsOpen</span>
                }
            }
 
            <b>return</b> <a href="#cf84b1b3e5f2d945" class="i property">IsOpen</a>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Utility method to signal handles and raise events</span>
        <span class="c">///</span><span class="c"> in the consistent order.</span>
        <span class="c">///</span><span class="c"> NOTE: Release the lock before raising events; otherwise,</span>
        <span class="c">///</span><span class="c"> there is a possible deadlock during the readable event.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> RaiseEvents is fairly idempotent, although it will signal</span>
        <span class="c">///</span><span class="c"> DataReady every time.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>private void</b> <a id="0b8499e34f392a08" href="../R/0b8499e34f392a08.html" target="n" data-glyph="76,1" class="i method">RaiseEvents</a>()
        {
            <b>bool</b> <span id="r19 rd" class="r19 r">unblockReaders</span> = <b>true</b>;
            <b>bool</b> <span id="r20 rd" class="r20 r">unblockWriters</span> = <b>true</b>;
            <b>bool</b> <span id="r21 rd" class="r21 r">endOfStream</span> = <b>false</b>;
            <b>try</b>
            {
                <b>lock</b> (<a href="#9ee3474c24ae825e" class="i field">_monitorObject</a>)
                {
                    <span class="c">// External readers block only for open streams</span>
                    <span class="c">// with no stored objects.  External writers block</span>
                    <span class="c">// only for open streams with no free buffer space.</span>
                    <span class="r19 r">unblockReaders</span> = (!<a href="#2127e0b9fd2df4c7" class="i field">_isOpen</a> || (<a href="#b65958155e22f9c7" class="i field">_objects</a>.<span class="i">Count</span> &gt; 0));
                    <span class="r20 r">unblockWriters</span> = (!<a href="#2127e0b9fd2df4c7" class="i field">_isOpen</a> || (<a href="#b65958155e22f9c7" class="i field">_objects</a>.<span class="i">Count</span> &lt; <a href="#59a35f0b691a0c76" class="i field">_capacity</a>));
                    <span class="r21 r">endOfStream</span> = (!<a href="#2127e0b9fd2df4c7" class="i field">_isOpen</a> &amp;&amp; (<a href="#b65958155e22f9c7" class="i field">_objects</a>.<span class="i">Count</span> == 0));
 
                    <span class="c">// I would prefer to set the ManualResetEvents outside</span>
                    <span class="c">// of the lock, so that the unblocked thread would not</span>
                    <span class="c">// immediately be re-blocked.  However, I am not</span>
                    <span class="c">// confident that multiple sets/resets might not get</span>
                    <span class="c">// out of order and leave the handle in the wrong state.</span>
                    <b>if</b> (<a href="#b963c4b9129d5be1" class="i field">_readWaitHandle</a> != <b>null</b>)
                    {
                        <b>try</b>
                        {
                            <b>if</b> (<span class="r19 r">unblockReaders</span>)
                            {
                                <a href="#b963c4b9129d5be1" class="i field">_readWaitHandle</a>.<span class="i">Set</span>();
                            }
                            <b>else</b>
                            {
                                <a href="#b963c4b9129d5be1" class="i field">_readWaitHandle</a>.<span class="i">Reset</span>();
                            }
                        }
                        <b>catch</b> (<span class="i">ObjectDisposedException</span>)
                        {
                        }
                    }
 
                    <b>if</b> (<a href="#7b815a72610473b5" class="i field">_writeWaitHandle</a> != <b>null</b>)
                    {
                        <b>try</b>
                        {
                            <b>if</b> (<span class="r20 r">unblockWriters</span>)
                            {
                                <a href="#7b815a72610473b5" class="i field">_writeWaitHandle</a>.<span class="i">Set</span>();
                            }
                            <b>else</b>
                            {
                                <a href="#7b815a72610473b5" class="i field">_writeWaitHandle</a>.<span class="i">Reset</span>();
                            }
                        }
                        <b>catch</b> (<span class="i">ObjectDisposedException</span>)
                        {
                        }
                    }
                }
            }
            <b>finally</b>
            {
                <span class="c">// We prefer to set the AutoResetEvents outside of the lock,</span>
                <span class="c">// so that the unblocked thread will not immediately be</span>
                <span class="c">// re-blocked.  This works because setting the handle</span>
                <span class="c">// is idempotent.</span>
                <b>if</b> (<span class="r19 r">unblockReaders</span>)
                {
                    <b>try</b>
                    {
                        <a href="#70e29f44d8dc03b2" class="i field">_readHandle</a>.<span class="i">Set</span>();
                    }
                    <b>catch</b> (<span class="i">ObjectDisposedException</span>)
                    {
                    }
                }
 
                <b>if</b> (<span class="r20 r">unblockWriters</span>)
                {
                    <b>try</b>
                    {
                        <a href="#255476bfd5fff27e" class="i field">_writeHandle</a>.<span class="i">Set</span>();
                    }
                    <b>catch</b> (<span class="i">ObjectDisposedException</span>)
                    {
                    }
                }
 
                <b>if</b> (<span class="r21 r">endOfStream</span>)
                {
                    <b>try</b>
                    {
                        <a href="#3858e3ee0d14b4ee" class="i field">_readClosedHandle</a>.<span class="i">Set</span>();
                    }
                    <b>catch</b> (<span class="i">ObjectDisposedException</span>)
                    {
                    }
                }
            }
 
            <span class="c">// This causes a synchronous call to the</span>
            <span class="c">// client-provided handler.</span>
            <b>if</b> (<span class="r19 r">unblockReaders</span>)
            {
                <span class="i">FireDataReadyEvent</span>(<a href="#247cf7c4c5dec5a4" class="k">this</a>, <span class="i">EventArgs</span>.<span class="i">Empty</span>);
            }
<span class="k preprocess">#</span><span class="k preprocess">if</span> (<b>false</b>)
<span class="e">            //
            // NOTE: Event delegates are called only after the internal
            // AutoResetEvents are set to ensure that an exception in an
            // event delegate does not leave the reset events in a bad
            // state.
            if (unblockWriters &amp;&amp; WriteReady != null)
            {
                WriteReady (this, new EventArgs ());
            }
</span><span class="k preprocess">#</span><span class="k preprocess">endif</span>
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> private locking code
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> internal methods
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Flush the data from the stream.  Closed streams may be flushed.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal override void</b> <a id="2c4a48b0dc3a045d" href="../R/2c4a48b0dc3a045d.html" target="n" data-glyph="74,1" class="i method">Flush</a>()
        {
            <b>bool</b> <span id="r22 rd" class="r22 r">raiseEvents</span> = <b>false</b>;
 
            <b>try</b>
            {
                <b>lock</b> (<a href="#9ee3474c24ae825e" class="i field">_monitorObject</a>)
                {
                    <b>if</b> (<a href="#b65958155e22f9c7" class="i field">_objects</a>.<span class="i">Count</span> &gt; 0)
                    {
                        <span class="r22 r">raiseEvents</span> = <b>true</b>;
                        <a href="#b65958155e22f9c7" class="i field">_objects</a>.<span class="i">Clear</span>();
                    }
                }
            }
            <b>finally</b>
            {
                <b>if</b> (<span class="r22 r">raiseEvents</span>)
                {
                    <a href="#0b8499e34f392a08" class="i method">RaiseEvents</a>();
                }
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Close the stream.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Causes subsequent calls to IsOpen to return false and calls to</span>
        <span class="c">///</span><span class="c"> a write operation to throw PipelineClosedException.</span>
        <span class="c">///</span><span class="c"> All calls to Close() after the first call are silently ignored.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>internal override void</b> <a id="f4de16ecfde03e1e" href="../R/f4de16ecfde03e1e.html" target="n" data-glyph="74,1" class="i method">Close</a>()
        {
            <b>bool</b> <span id="r23 rd" class="r23 r">raiseEvents</span> = <b>false</b>;
 
            <b>try</b>
            {
                <b>lock</b> (<a href="#9ee3474c24ae825e" class="i field">_monitorObject</a>)
                {
                    <span class="c">// if we transition from open to closed,</span>
                    <span class="c">// signal any blocking readers or writers</span>
                    <span class="c">// to ensure the close is seen.</span>
                    <b>if</b> (<a href="#2127e0b9fd2df4c7" class="i field">_isOpen</a>)
                    {
                        <span class="r23 r">raiseEvents</span> = <b>true</b>;
                        <a href="#2127e0b9fd2df4c7" class="i field">_isOpen</a> = <b>false</b>;
                    }
                }
            }
            <b>finally</b>
            {
                <b>if</b> (<span class="r23 r">raiseEvents</span>)
                {
                    <span class="c">// RaiseEvents does not manage _writeClosedHandle</span>
                    <b>try</b>
                    {
                        <a href="#bac0959dcfd7d589" class="i field">_writeClosedHandle</a>.<span class="i">Set</span>();
                    }
                    <b>catch</b> (<span class="i">ObjectDisposedException</span>)
                    {
                    }
 
                    <a href="#0b8499e34f392a08" class="i method">RaiseEvents</a>();
                }
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> internal methods
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Read Methods
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Read a single object from the stream.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">The next object in the stream or AutomationNull if EndOfPipeline is reached.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span><span class="c">This method blocks if the stream is empty</span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>internal override object</b> <a id="22f0a20fb5ee8d81" href="../R/22f0a20fb5ee8d81.html" target="n" data-glyph="74,1" class="i method">Read</a>()
        {
            <span class="i">Collection</span>&lt;<b>object</b>&gt; <span id="r24 rd" class="r24 r">result</span> = <a href="#945305c85e45f44c" class="i method">Read</a>(1);
            <b>if</b> (<span class="r24 r">result</span>.<span class="i">Count</span> == 1)
            {
                <b>return</b> <span class="r24 r">result</span>[0];
            }
 
            <a href="assert.cs.html#c04955255430d32f" class="t t">Diagnostics</a>.<a href="assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r24 r">result</span>.<span class="i">Count</span> == 0, <span class="s">&quot;Invalid number of objects returned&quot;</span>);
 
            <b>return</b> <a href="../engine/AutomationNull.cs.html#681fbea4c40e4af1" class="t t">AutomationNull</a>.<a href="../engine/AutomationNull.cs.html#1cf7e193da582896" class="i property">Value</a>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Read at most </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r25 r">count</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> objects.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r25 r">count</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The maximum number of objects to read.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">The objects read.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">ArgumentOutOfRangeException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r25 r">count</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> is less than 0</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This method blocks if the number of objects in the stream is less than </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r25 r">count</span><span class="c">&quot;</span><span class="c">/&gt;</span>
        <span class="c">///</span><span class="c"> and the stream is not closed.</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> If there are multiple reader threads, the objects returned</span>
        <span class="c">///</span><span class="c"> to blocking reads Read(int count) and ReadToEnd()</span>
        <span class="c">///</span><span class="c"> are not necessarily single blocks of objects added to the</span>
        <span class="c">///</span><span class="c"> stream in that order.  For example, if ABCDEF are added to the</span>
        <span class="c">///</span><span class="c"> stream, one reader may get ABDE and the other may get CF.</span>
        <span class="c">///</span><span class="c"> Each reader reads items from the stream as they become available.</span>
        <span class="c">///</span><span class="c"> Otherwise, if a maximum _capacity has been imposed, the writer</span>
        <span class="c">///</span><span class="c"> and reader could become mutually deadlocked.</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> When there are multiple blocked readers, any of the readers</span>
        <span class="c">///</span><span class="c"> may get the next object(s) added.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>internal override</b> <span class="i">Collection</span>&lt;<b>object</b>&gt; <a id="945305c85e45f44c" href="../R/945305c85e45f44c.html" target="n" data-glyph="74,1" class="i method">Read</a>(<b>int</b> <span id="r25 rd" class="r25 r">count</span>)
        {
            <b>if</b> (<span class="r25 r">count</span> &lt; 0)
            {
                <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="MshTraceSource.cs.html#3ec1a8e5fa36a1b2" class="i method">NewArgumentOutOfRangeException</a>(<b>nameof</b>(<span class="r25 r">count</span>), <span class="r25 r">count</span>);
            }
 
            <b>if</b> (<span class="r25 r">count</span> == 0)
            {
                <b>return</b> <b>new</b> <span class="i">Collection</span>&lt;<b>object</b>&gt;();
            }
 
            <span class="i">Collection</span>&lt;<b>object</b>&gt; <span id="r26 rd" class="r26 r">results</span> = <b>new</b> <span class="i">Collection</span>&lt;<b>object</b>&gt;();
 
            <b>bool</b> <span id="r27 rd" class="r27 r">raiseEvents</span> = <b>false</b>;
            <b>while</b> ((<span class="r25 r">count</span> &gt; 0) &amp;&amp; <a href="#10c14ae9e9478af9" class="i method">WaitRead</a>())
            {
                <b>try</b>
                {
                    <b>lock</b> (<a href="#9ee3474c24ae825e" class="i field">_monitorObject</a>)
                    {
                        <span class="c">// double check to ensure data is ready</span>
                        <b>if</b> (<a href="#b65958155e22f9c7" class="i field">_objects</a>.<span class="i">Count</span> == 0)
                        {
                            <b>continue</b>;    <span class="c">// wait some more</span>
                        }
 
                        <span class="r27 r">raiseEvents</span> = <b>true</b>;
                        <span class="c">// NTRAID#Windows Out Of Band Releases-925566-2005/12/07-JonN</span>
                        <b>int</b> <span id="r28 rd" class="r28 r">objectsAdded</span> = 0;
                        <b>foreach</b> (<b>object</b> <span id="r29 rd" class="r29 r">o</span> <b>in</b> <a href="#b65958155e22f9c7" class="i field">_objects</a>)
                        {
                            <span class="r26 r">results</span>.<span class="i">Add</span>(<span class="r29 r">o</span>);
                            <span class="r28 r">objectsAdded</span>++;
                            <b>if</b> (--<span class="r25 r">count</span> &lt;= 0)
                                <b>break</b>;
                        }
 
                        <a href="#b65958155e22f9c7" class="i field">_objects</a>.<span class="i">RemoveRange</span>(0, <span class="r28 r">objectsAdded</span>);
                    }
                }
                <b>finally</b>
                {
                    <span class="c">// Raise the appropriate read/write events outside the lock. This is</span>
                    <span class="c">// inside the while loop to ensure writers can have a chance to</span>
                    <span class="c">// write otherwise the reader will starve.</span>
                    <span class="c">// NOTE: This must occur in the finally block to ensure</span>
                    <span class="c">// the AutoResetEvents are left in the appropriate state, even</span>
                    <span class="c">// for error paths.</span>
                    <b>if</b> (<span class="r27 r">raiseEvents</span>)
                    {
                        <a href="#0b8499e34f392a08" class="i method">RaiseEvents</a>();
                    }
                }
            }
 
            <b>return</b> <span class="r26 r">results</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Blocks until the pipeline closes and reads all objects.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">A collection of zero or more objects.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If the stream is empty, a collection of size zero is returned.</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> If there are multiple reader threads, the objects returned</span>
        <span class="c">///</span><span class="c"> to blocking reads Read(int count) and ReadToEnd()</span>
        <span class="c">///</span><span class="c"> are not necessarily single blocks of objects added to the</span>
        <span class="c">///</span><span class="c"> stream in that order.  For example, if ABCDEF are added to the</span>
        <span class="c">///</span><span class="c"> stream, one reader may get ABDE and the other may get CF.</span>
        <span class="c">///</span><span class="c"> Each reader reads items from the stream as they become available.</span>
        <span class="c">///</span><span class="c"> Otherwise, if a maximum _capacity has been imposed, the writer</span>
        <span class="c">///</span><span class="c"> and reader could become mutually deadlocked.</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> When there are multiple blocked readers, any of the readers</span>
        <span class="c">///</span><span class="c"> may get the next object(s) added.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>internal override</b> <span class="i">Collection</span>&lt;<b>object</b>&gt; <a id="2f5c19ef424822b8" href="../R/2f5c19ef424822b8.html" target="n" data-glyph="74,1" class="i method">ReadToEnd</a>()
        {
            <span class="c">// NTRAID#Windows Out Of Band Releases-925566-2005/12/07-JonN</span>
            <b>return</b> <span class="i">Read</span>(<span class="i">Int32</span>.<span class="i">MaxValue</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Reads objects currently in the stream, but does not block.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">An array of zero or more objects.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This method performs a read of objects currently in the</span>
        <span class="c">///</span><span class="c"> stream. The method will block until exclusive access to the</span>
        <span class="c">///</span><span class="c"> stream is acquired.  If there are no objects in the stream,</span>
        <span class="c">///</span><span class="c"> an empty array is returned.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r30 r">maxRequested</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Return no more than maxRequested objects.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">ArgumentOutOfRangeException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r30 r">maxRequested</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> is less than 0</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>internal override</b> <span class="i">Collection</span>&lt;<b>object</b>&gt; <a id="d427df41689c67c8" href="../R/d427df41689c67c8.html" target="n" data-glyph="74,1" class="i method">NonBlockingRead</a>(<b>int</b> <span id="r30 rd" class="r30 r">maxRequested</span>)
        {
            <span class="i">Collection</span>&lt;<b>object</b>&gt; <span id="r31 rd" class="r31 r">results</span> = <b>null</b>;
            <b>bool</b> <span id="r32 rd" class="r32 r">raiseEvents</span> = <b>false</b>;
 
            <b>if</b> (<span class="r30 r">maxRequested</span> == 0)
            {
                <b>return</b> <b>new</b> <span class="i">Collection</span>&lt;<b>object</b>&gt;();
            }
 
            <b>if</b> (<span class="r30 r">maxRequested</span> &lt; 0)
            {
                <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="MshTraceSource.cs.html#3ec1a8e5fa36a1b2" class="i method">NewArgumentOutOfRangeException</a>(<b>nameof</b>(<span class="r30 r">maxRequested</span>), <span class="r30 r">maxRequested</span>);
            }
 
            <b>try</b>
            {
                <b>lock</b> (<a href="#9ee3474c24ae825e" class="i field">_monitorObject</a>)
                {
                    <b>int</b> <span id="r33 rd" class="r33 r">readCount</span> = <a href="#b65958155e22f9c7" class="i field">_objects</a>.<span class="i">Count</span>;
                    <b>if</b> (<span class="r33 r">readCount</span> &gt; <span class="r30 r">maxRequested</span>)
                    {
                        <span class="c">// 2004/06/30-JonN Safe cast since 0 &lt; maxRequested &lt; readCount</span>
                        <span class="r33 r">readCount</span> = (<b>int</b>)<span class="r30 r">maxRequested</span>;
                    }
 
                    <b>if</b> (<span class="r33 r">readCount</span> &gt; 0)
                    {
                        <span class="r31 r">results</span> = <b>new</b> <span class="i">Collection</span>&lt;<b>object</b>&gt;();
                        <b>for</b> (<b>int</b> <span id="r34 rd" class="r34 r">i</span> = 0; <span class="r34 r">i</span> &lt; <span class="r33 r">readCount</span>; <span class="r34 r">i</span>++)
                        {
                            <span class="r31 r">results</span>.<span class="i">Add</span>(<a href="#b65958155e22f9c7" class="i field">_objects</a>[<span class="r34 r">i</span>]);
                        }
 
                        <span class="r32 r">raiseEvents</span> = <b>true</b>;
                        <a href="#b65958155e22f9c7" class="i field">_objects</a>.<span class="i">RemoveRange</span>(0, <span class="r33 r">readCount</span>);
                    }
                }
            }
            <b>finally</b>
            {
                <b>if</b> (<span class="r32 r">raiseEvents</span>)
                {
                    <a href="#0b8499e34f392a08" class="i method">RaiseEvents</a>();
                }
            }
 
            <b>return</b> <span class="r31 r">results</span> ?? <b>new</b> <span class="i">Collection</span>&lt;<b>object</b>&gt;();
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Peek the next object.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The next object in the stream or AutomationNull.Value if the stream is empty</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="ExecutionExceptions.cs.html#1496d52396952a52" class="t t">PipelineClosedException</a><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The ObjectStream is closed.</span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>internal override object</b> <a id="0bd90bd0a0aeb1a1" href="../R/0bd90bd0a0aeb1a1.html" target="n" data-glyph="74,1" class="i method">Peek</a>()
        {
            <b>object</b> <span id="r35 rd" class="r35 r">result</span> = <b>null</b>;
 
            <b>lock</b> (<a href="#9ee3474c24ae825e" class="i field">_monitorObject</a>)
            {
                <b>if</b> (<a href="#d19aa95533ded62b" class="i property">EndOfPipeline</a> || <a href="#b65958155e22f9c7" class="i field">_objects</a>.<span class="i">Count</span> == 0)
                {
                    <span class="r35 r">result</span> = <a href="../engine/AutomationNull.cs.html#681fbea4c40e4af1" class="t t">AutomationNull</a>.<a href="../engine/AutomationNull.cs.html#1cf7e193da582896" class="i property">Value</a>;
                }
                <b>else</b>
                {
                    <span class="r35 r">result</span> = <a href="#b65958155e22f9c7" class="i field">_objects</a>[0];
                }
            }
 
            <b>return</b> <span class="r35 r">result</span>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Read Methods
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Write Methods
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Write objects to the underlying stream.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r36 r">obj</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Object or enumeration to read from.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r37 r">enumerateCollection</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If enumerateCollection is true, and </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r36 r">obj</span><span class="c">&quot;</span><span class="c">/&gt;</span>
        <span class="c">///</span><span class="c"> is an enumeration according to LanguagePrimitives.GetEnumerable,</span>
        <span class="c">///</span><span class="c"> the objects in the enumeration will be unrolled and</span>
        <span class="c">///</span><span class="c"> written separately.  Otherwise, </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r36 r">obj</span><span class="c">&quot;</span><span class="c">/&gt;</span>
        <span class="c">///</span><span class="c"> will be written as a single object.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">The number of objects written.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><a href="ExecutionExceptions.cs.html#1496d52396952a52" class="t t">PipelineClosedException</a><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The underlying stream is closed</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If the enumeration contains elements equal to</span>
        <span class="c">///</span><span class="c"> AutomationNull.Value, they are ignored.</span>
        <span class="c">///</span><span class="c"> This can cause the return value to be less than the size of</span>
        <span class="c">///</span><span class="c"> the collection.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>internal override int</b> <a id="3f08f19c7be53dd2" href="../R/3f08f19c7be53dd2.html" target="n" data-glyph="74,1" class="i method">Write</a>(<b>object</b> <span id="r36 rd" class="r36 r">obj</span>, <b>bool</b> <span id="r37 rd" class="r37 r">enumerateCollection</span>)
        {
            <span class="c">// it is permitted to write null objects</span>
 
            <b>if</b> (<span class="r36 r">obj</span> == <a href="../engine/AutomationNull.cs.html#681fbea4c40e4af1" class="t t">AutomationNull</a>.<a href="../engine/AutomationNull.cs.html#1cf7e193da582896" class="i property">Value</a>)
            {
                <span class="c">// NTRAID#Windows Out Of Band Releases-926213-2005/12/16-JonN</span>
                <span class="c">// We no longer break on AutomationNull.Value,</span>
                <span class="c">// we just ignore it</span>
                <b>return</b> 0;
            }
 
            <b>if</b> (!<a href="#cf84b1b3e5f2d945" class="i property">IsOpen</a>)
            {
                <span class="c">// NTRAID#Windows Out Of Band Releases-925742-2005/12/07-JonN</span>
                <b>string</b> <span id="r38 rd" class="r38 r">message</span> = <span class="i">PipelineStrings</span>.<span class="i">WriteToClosedPipeline</span>;
                <span class="i">Exception</span> <span id="r39 rd" class="r39 r">e</span> = <b>new</b> <a href="ExecutionExceptions.cs.html#959293932430d8d7" class="t constructor">PipelineClosedException</a>(<span class="r38 r">message</span>);
                <b>throw</b> <span class="r39 r">e</span>;
            }
 
            <span class="c">// We want to write the objects as one block, not individually</span>
            <span class="c">// We do not want to hold the stream locked during the enumeration</span>
            <span class="i">List</span>&lt;<b>object</b>&gt; <span id="r40 rd" class="r40 r">a</span> = <b>new</b> <span class="i">List</span>&lt;<b>object</b>&gt;();
 
            <span class="i">IEnumerable</span> <span id="r41 rd" class="r41 r">enumerable</span> = <b>null</b>;
            <b>if</b> (<span class="r37 r">enumerateCollection</span>)
            {
                <span class="r41 r">enumerable</span> = <a href="../engine/LanguagePrimitives.cs.html#6dac09d64da9900c" class="t t">LanguagePrimitives</a>.<a href="../engine/LanguagePrimitives.cs.html#5489692986d47497" class="i method">GetEnumerable</a>(<span class="r36 r">obj</span>);
            }
 
            <b>if</b> (<span class="r41 r">enumerable</span> == <b>null</b>)
                <span class="r40 r">a</span>.<span class="i">Add</span>(<span class="r36 r">obj</span>);
            <b>else</b>
            {
                <b>foreach</b> (<b>object</b> <span id="r42 rd" class="r42 r">o</span> <b>in</b> <span class="r41 r">enumerable</span>)
                {
                    <span class="c">// 879023-2003/10/28-JonN</span>
                    <span class="c">//  Outputting stops when receiving a AutomationNull.Value</span>
                    <span class="c">// 2003/10/28-JonN There is a window where another</span>
                    <span class="c">//  thread could modify the array to contain</span>
                    <span class="c">//  AutomationNull.Value, but I&#39;m not going to deal with it.</span>
                    <b>if</b> (<a href="../engine/AutomationNull.cs.html#681fbea4c40e4af1" class="t t">AutomationNull</a>.<a href="../engine/AutomationNull.cs.html#1cf7e193da582896" class="i property">Value</a> == <span class="r42 r">o</span>)
                    {
                        <span class="c">// NTRAID#Windows Out Of Band Releases-926213-2005/12/16-JonN</span>
                        <span class="c">// We no longer break on AutomationNull.Value,</span>
                        <span class="c">// we just ignore it</span>
                        <b>continue</b>;
                    }
 
                    <span class="r40 r">a</span>.<span class="i">Add</span>(<span class="r42 r">o</span>);
                }
            }
 
            <b>int</b> <span id="r43 rd" class="r43 r">objectsWritten</span> = 0;
            <b>int</b> <span id="r44 rd" class="r44 r">objectsToWrite</span> = <span class="r40 r">a</span>.<span class="i">Count</span>;
 
            <b>while</b> (<span class="r44 r">objectsToWrite</span> &gt; 0)
            {
                <b>bool</b> <span id="r45 rd" class="r45 r">raiseEvents</span> = <b>false</b>;
 
                <span class="c">// wait for buffer available</span>
                <span class="c">// false indicates EndOfPipeline</span>
                <b>if</b> (!<a href="#3f544feeedfcd889" class="i method">WaitWrite</a>())
                {
                    <b>break</b>;
                }
 
                <b>try</b>
                {
                    <b>lock</b> (<a href="#9ee3474c24ae825e" class="i field">_monitorObject</a>)
                    {
                        <b>if</b> (!<a href="#cf84b1b3e5f2d945" class="i property">IsOpen</a>)
                        {
                            <span class="c">// NOTE: lock is released in finally</span>
                            <b>break</b>;
                        }
 
                        <span class="c">// determine the maximum number of objects that</span>
                        <span class="c">// can be written to the stream. Note: performing</span>
                        <span class="c">// subtraction to ensure we don&#39;t have an</span>
                        <span class="c">// overflow exception</span>
                        <b>int</b> <span id="r46 rd" class="r46 r">freeSpace</span> = <a href="#59a35f0b691a0c76" class="i field">_capacity</a> - <a href="#b65958155e22f9c7" class="i field">_objects</a>.<span class="i">Count</span>;
                        <b>if</b> (<span class="r46 r">freeSpace</span> &lt;= 0)
                        {
                            <span class="c">// NOTE: lock is released in finally</span>
                            <b>continue</b>;
                        }
 
                        <b>int</b> <span id="r47 rd" class="r47 r">writeCount</span> = <span class="r44 r">objectsToWrite</span>;
                        <b>if</b> (<span class="r47 r">writeCount</span> &gt; <span class="r46 r">freeSpace</span>)
                        {
                            <span class="c">// Note that we have already established that</span>
                            <span class="c">// 0 &lt; freeSpace &lt; writeCount,</span>
                            <span class="c">// so the cast is safe.</span>
                            <span class="r47 r">writeCount</span> = <span class="r46 r">freeSpace</span>;
                        }
 
                        <b>try</b>
                        {
                            <span class="c">// determine if we can write to the stream in</span>
                            <span class="c">// a single call.</span>
                            <b>if</b> (<span class="r47 r">writeCount</span> == <span class="r40 r">a</span>.<span class="i">Count</span>)
                            {
                                <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="assert.cs.html#c04955255430d32f" class="t t">Diagnostics</a>.<a href="assert.cs.html#703dade50a6809cd" class="i method">Assert</a>
                                    (<span class="r43 r">objectsWritten</span> == 0, <span class="s">&quot;objectsWritten == 0&quot;</span>);
                                <a href="#b65958155e22f9c7" class="i field">_objects</a>.<span class="i">AddRange</span>(<span class="r40 r">a</span>);
                                <span class="r43 r">objectsWritten</span> += <span class="r47 r">writeCount</span>;
                                <span class="r44 r">objectsToWrite</span> -= <span class="r47 r">writeCount</span>;
                                <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="assert.cs.html#c04955255430d32f" class="t t">Diagnostics</a>.<a href="assert.cs.html#703dade50a6809cd" class="i method">Assert</a>
                                    (<span class="r44 r">objectsToWrite</span> == 0, <span class="s">&quot;objectsToWrite == 0&quot;</span>);
                            }
                            <b>else</b>
                            {
                                <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="assert.cs.html#c04955255430d32f" class="t t">Diagnostics</a>.<a href="assert.cs.html#703dade50a6809cd" class="i method">Assert</a>
                                    (<span class="r47 r">writeCount</span> &gt; 0, <span class="s">&quot;writeCount &gt; 0&quot;</span>);
                                <span class="i">List</span>&lt;<b>object</b>&gt; <span id="r48 rd" class="r48 r">a2</span> = <span class="r40 r">a</span>.<span class="i">GetRange</span>(<span class="r43 r">objectsWritten</span>, <span class="r47 r">writeCount</span>);
                                <a href="#b65958155e22f9c7" class="i field">_objects</a>.<span class="i">AddRange</span>(<span class="r48 r">a2</span>);
                                <span class="r43 r">objectsWritten</span> += <span class="r47 r">writeCount</span>;
                                <span class="r44 r">objectsToWrite</span> -= <span class="r47 r">writeCount</span>;
                            }
                        }
                        <b>finally</b>
                        {
                            <span class="r45 r">raiseEvents</span> = <b>true</b>;
                        }
                    }
                }
                <b>finally</b>
                {
                    <b>if</b> (<span class="r45 r">raiseEvents</span>)
                    {
                        <a href="#0b8499e34f392a08" class="i method">RaiseEvents</a>();
                    }
                }
            }
 
            <b>return</b> <span class="r43 r">objectsWritten</span>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Write Methods
 
        <span class="c">// 905990-2005/05/10-JonN Removed IDisposable</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Design For Testability
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> These methods are necessary to provide the ObjectStreamTest BVT</span>
        <span class="c">///</span><span class="c"> access to the internal handler DataReady.  The EventInfo</span>
        <span class="c">///</span><span class="c"> reflection class does not give access to internal events.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r49 r">eventHandler</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>private void</b> <a id="35ba1c4a0a98ae07" href="../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">DFT_AddHandler_OnDataReady</a>(<span class="i">EventHandler</span> <span id="r49 rd" class="r49 r">eventHandler</span>)
        {
            <a href="#16ab48f9b8a043bb" class="i">DataReady</a> += <span class="r49 r">eventHandler</span>;
        }
 
        <b>private void</b> <a id="084ee54de0ab1315" href="../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">DFT_RemoveHandler_OnDataReady</a>(<span class="i">EventHandler</span> <span id="r50 rd" class="r50 r">eventHandler</span>)
        {
            <a href="#16ab48f9b8a043bb" class="i">DataReady</a> -= <span class="r50 r">eventHandler</span>;
        }
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Design For Testability
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> IDisposable
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Release all resources.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r51 r">disposing</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">If true, release all managed resources.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>protected override void</b> <a id="8c4439bf1058b9cd" href="../R/8c4439bf1058b9cd.html" target="n" data-glyph="75,1" class="i method">Dispose</a>(<b>bool</b> <span id="r51 rd" class="r51 r">disposing</span>)
        {
            <b>if</b> (<a href="#05aff2cf763f638d" class="i field">_disposed</a>)
            {
                <b>return</b>;
            }
 
            <b>lock</b> (<a href="#9ee3474c24ae825e" class="i field">_monitorObject</a>)
            {
                <b>if</b> (<a href="#05aff2cf763f638d" class="i field">_disposed</a>)
                {
                    <b>return</b>;
                }
 
                <a href="#05aff2cf763f638d" class="i field">_disposed</a> = <b>true</b>;
            }
 
            <b>if</b> (<span class="r51 r">disposing</span>)
            {
                <a href="#70e29f44d8dc03b2" class="i field">_readHandle</a>.<span class="i">Dispose</span>();
                <a href="#255476bfd5fff27e" class="i field">_writeHandle</a>.<span class="i">Dispose</span>();
                <a href="#bac0959dcfd7d589" class="i field">_writeClosedHandle</a>.<span class="i">Dispose</span>();
                <a href="#3858e3ee0d14b4ee" class="i field">_readClosedHandle</a>.<span class="i">Dispose</span>();
 
                <b>if</b> (<a href="#b963c4b9129d5be1" class="i field">_readWaitHandle</a> != <b>null</b>)
                {
                    <a href="#b963c4b9129d5be1" class="i field">_readWaitHandle</a>.<span class="i">Dispose</span>();
                }
 
                <b>if</b> (<a href="#7b815a72610473b5" class="i field">_writeWaitHandle</a> != <b>null</b>)
                {
                    <a href="#7b815a72610473b5" class="i field">_writeWaitHandle</a>.<span class="i">Dispose</span>();
                }
 
                <b>if</b> (<a href="#dac598ac81a5c871" class="i field">_reader</a> != <b>null</b>)
                {
                    <a href="#dac598ac81a5c871" class="i field">_reader</a>.<a href="IObjectReader.cs.html#8683203a66bbbf02" class="i method">Close</a>();
                    <a href="#dac598ac81a5c871" class="i field">_reader</a>.<a href="IObjectReader.cs.html#284e3297ec4d8f81" class="i property">WaitHandle</a>.<span class="i">Dispose</span>();
                }
 
                <b>if</b> (<a href="#444c97e084f5c4ca" class="i field">_writer</a> != <b>null</b>)
                {
                    <a href="#444c97e084f5c4ca" class="i field">_writer</a>.<a href="IObjectWriter.cs.html#2c9b22a04af963c5" class="i method">Close</a>();
                    <a href="#444c97e084f5c4ca" class="i field">_writer</a>.<a href="IObjectWriter.cs.html#c9415d4a4a1c6a2f" class="i property">WaitHandle</a>.<span class="i">Dispose</span>();
                }
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> IDisposable
    }
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> An object stream using a PSDataCollection as the object store.</span>
    <span class="c">///</span><span class="c"> This stream lets user to supply a custom PSDataCollection instance</span>
    <span class="c">///</span><span class="c"> to use as the stream&#39;s object store.</span>
    <span class="c">///</span>
    <span class="c">///</span><span class="c"> This stream is designed to be used with the user supplied</span>
    <span class="c">///</span><span class="c"> PSDataBuffers. For internal only purposes use ObjectStream.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>internal sealed class</b> <a id="7277ae0921f30c7a" href="../R/7277ae0921f30c7a.html" target="n" data-glyph="2,0" class="t t">PSDataCollectionStream</a>&lt;<span id="r52 rd t" class="r52 r t">T</span>&gt; : <a href="#27e9349816faeecb" class="t t">ObjectStreamBase</a>
    {
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Private Fields
 
        <b>private readonly</b> <a href="../engine/hostifaces/PSDataCollection.cs.html#52e2b209c10ec0a4" class="t t">PSDataCollection</a>&lt;<span class="r52 r t">T</span>&gt; <a id="db0bd325daca1bfc" href="../R/db0bd325daca1bfc.html" target="n" data-glyph="46,1" class="i field">_objects</a>;
        <b>private readonly</b> <span class="i">Guid</span> <a id="2b74595266674149" href="../R/2b74595266674149.html" target="n" data-glyph="46,1" class="i field">_psInstanceId</a>;
        <b>private bool</b> <a id="eb23efcb2107604c" href="../R/eb23efcb2107604c.html" target="n" data-glyph="46,1" class="i field">_isOpen</a>;
        <b>private</b> <a href="IObjectWriter.cs.html#37301df630b2ae9a" class="t t">PipelineWriter</a> <a id="7bb076742d7f0ec7" href="../R/7bb076742d7f0ec7.html" target="n" data-glyph="46,1" class="i field">_writer</a>;
        <b>private</b> <a href="IObjectReader.cs.html#6b2221741902f9bd" class="t t">PipelineReader</a>&lt;<b>object</b>&gt; <a id="f451f950247d4aad" href="../R/f451f950247d4aad.html" target="n" data-glyph="46,1" class="i field">_objectReader</a>;
        <b>private</b> <a href="IObjectReader.cs.html#6b2221741902f9bd" class="t t">PipelineReader</a>&lt;<a href="../engine/MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt; <a id="6b15458f840b83c9" href="../R/6b15458f840b83c9.html" target="n" data-glyph="46,1" class="i field">_psobjectReader</a>;
        <b>private</b> <a href="IObjectReader.cs.html#6b2221741902f9bd" class="t t">PipelineReader</a>&lt;<b>object</b>&gt; <a id="3e8a095aa7125781" href="../R/3e8a095aa7125781.html" target="n" data-glyph="46,1" class="i field">_objectReaderForPipeline</a>;
        <b>private</b> <a href="IObjectReader.cs.html#6b2221741902f9bd" class="t t">PipelineReader</a>&lt;<a href="../engine/MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt; <a id="50e109904ced4b04" href="../R/50e109904ced4b04.html" target="n" data-glyph="46,1" class="i field">_psobjectReaderForPipeline</a>;
        <b>private readonly object</b> <a id="a595da480bffcf70" href="../R/a595da480bffcf70.html" target="n" data-glyph="46,1" class="i field">_syncObject</a> = <b>new</b> <b>object</b>();
        <b>private bool</b> <a id="aa1cfe55f8bbc5a1" href="../R/aa1cfe55f8bbc5a1.html" target="n" data-glyph="46,1" class="i field">_disposed</a> = <b>false</b>;
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Constructors
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Creates the stream and uses the supplied </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r53 r">storeToUse</span><span class="c">&quot;</span><span class="c">/&gt;</span>
        <span class="c">///</span><span class="c"> as the object store.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r54 r">psInstanceId</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Guid of Powershell instance creating this stream.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r53 r">storeToUse</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> A PSDataCollection instance.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">exception</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">ArgumentNullException</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> 1. storeToUse is null</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">exception</span><span class="c">&gt;</span>
        <b>internal</b> <a id="472e4f0d3c7801e9" href="../R/472e4f0d3c7801e9.html" target="n" data-glyph="74,1" class="t constructor">PSDataCollectionStream</a>(<span class="i">Guid</span> <span id="r54 rd" class="r54 r">psInstanceId</span>, <a href="../engine/hostifaces/PSDataCollection.cs.html#52e2b209c10ec0a4" class="t t">PSDataCollection</a>&lt;<span class="r52 r t">T</span>&gt; <span id="r53 rd" class="r53 r">storeToUse</span>)
        {
            <b>if</b> (<span class="r53 r">storeToUse</span> == <b>null</b>)
            {
                <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="MshTraceSource.cs.html#fbe67220ad7522a0" class="i method">NewArgumentNullException</a>(<b>nameof</b>(<span class="r53 r">storeToUse</span>));
            }
 
            <a href="#db0bd325daca1bfc" class="i field">_objects</a> = <span class="r53 r">storeToUse</span>;
            <a href="#2b74595266674149" class="i field">_psInstanceId</a> = <span class="r54 r">psInstanceId</span>;
            <a href="#eb23efcb2107604c" class="i field">_isOpen</a> = <b>true</b>;
            <span class="c">// increment ref count for the store. PowerShell engine</span>
            <span class="c">// is about to use this store.</span>
            <span class="r53 r">storeToUse</span>.<a href="../engine/hostifaces/PSDataCollection.cs.html#20fe51d62499cf69" class="i method">AddRef</a>();
 
            <span class="r53 r">storeToUse</span>.<a href="../engine/hostifaces/PSDataCollection.cs.html#de98d172ff9dac86" class="i">DataAdded</a> += <span class="i">HandleDataAdded</span>;
            <span class="r53 r">storeToUse</span>.<a href="../engine/hostifaces/PSDataCollection.cs.html#6babaf76cd9d021c" class="i">Completed</a> += <span class="i">HandleClosed</span>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Properties
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets the PSDataCollection used to store data for this stream.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal</b> <a href="../engine/hostifaces/PSDataCollection.cs.html#52e2b209c10ec0a4" class="t t">PSDataCollection</a>&lt;<span class="r52 r t">T</span>&gt; <a id="a9e2d90ab43caced" href="../R/a9e2d90ab43caced.html" target="n" data-glyph="104,1" class="i property">ObjectStore</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#db0bd325daca1bfc" class="i field">_objects</a>;
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Virtual Implementation
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Returns the number of objects in the stream.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal override int</b> <a id="b914c1fcdfc6d459" href="../R/b914c1fcdfc6d459.html" target="n" data-glyph="104,1" class="i property">Count</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#db0bd325daca1bfc" class="i field">_objects</a>.<a href="../engine/hostifaces/PSDataCollection.cs.html#e7cb43bbebbb4aca" class="i property">Count</a>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This is not supported.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal override bool</b> <a id="610cfc88fa63a10c" href="../R/610cfc88fa63a10c.html" target="n" data-glyph="104,1" class="i property">EndOfPipeline</a>
        {
            <b>get</b>
            {
                <b>bool</b> <span id="r55 rd" class="r55 r">endOfStream</span> = <b>true</b>;
 
                <b>lock</b> (<a href="#a595da480bffcf70" class="i field">_syncObject</a>)
                {
                    <span class="r55 r">endOfStream</span> = (<a href="#db0bd325daca1bfc" class="i field">_objects</a>.<a href="../engine/hostifaces/PSDataCollection.cs.html#e7cb43bbebbb4aca" class="i property">Count</a> == 0 &amp;&amp; !<a href="#eb23efcb2107604c" class="i field">_isOpen</a>);
                }
 
                <b>return</b> <span class="r55 r">endOfStream</span>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Check if the stream is open for further writes.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">True if the stream is open, false if not.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> IsOpen returns true until the first call to Close(). Writers should</span>
        <span class="c">///</span><span class="c"> check IsOpen to determine if a write operation can be made.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>internal override bool</b> <a id="0e3474adb94bfb5b" href="../R/0e3474adb94bfb5b.html" target="n" data-glyph="104,1" class="i property">IsOpen</a>
        {
            <b>get</b>
            {
                <span class="c">// check both the current stream and the object store.</span>
                <b>return</b> <a href="#eb23efcb2107604c" class="i field">_isOpen</a> &amp;&amp; <a href="#db0bd325daca1bfc" class="i field">_objects</a>.<a href="../engine/hostifaces/PSDataCollection.cs.html#c160386455270a8f" class="i property">IsOpen</a>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This is not supported.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal override int</b> <a id="9b92e037e267a73b" href="../R/9b92e037e267a73b.html" target="n" data-glyph="104,1" class="i property">MaxCapacity</a>
        {
            <b>get</b>
            {
<span class="k preprocess">#</span><span class="k preprocess">pragma</span> <span class="k preprocess">warning</span> <span class="k preprocess">disable</span> 56503
                <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="MshTraceSource.cs.html#18f73963f5ead5c2" class="i method">NewNotSupportedException</a>();
<span class="k preprocess">#</span><span class="k preprocess">pragma</span> <span class="k preprocess">warning</span> <span class="k preprocess">restore</span> 56503
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Return a PipelineReader(object) for this stream.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal override</b> <a href="IObjectReader.cs.html#6b2221741902f9bd" class="t t">PipelineReader</a>&lt;<b>object</b>&gt; <a id="6b0ae2c95f03ccf8" href="../R/6b0ae2c95f03ccf8.html" target="n" data-glyph="104,1" class="i property">ObjectReader</a>
        {
            <b>get</b>
            {
                <b>if</b> (<a href="#f451f950247d4aad" class="i field">_objectReader</a> == <b>null</b>)
                {
                    <b>lock</b> (<a href="#a595da480bffcf70" class="i field">_syncObject</a>)
                    {
                        <b>if</b> (<a href="#f451f950247d4aad" class="i field">_objectReader</a> == <b>null</b>)
                        {
                            <a href="#f451f950247d4aad" class="i field">_objectReader</a> = <b>new</b> <a href="ObjectReader.cs.html#dd1066d798fea900" class="t constructor">PSDataCollectionReader</a>&lt;<span class="r52 r t">T</span>, <b>object</b>&gt;(<a href="#7277ae0921f30c7a" class="k">this</a>);
                        }
                    }
                }
 
                <b>return</b> <a href="#f451f950247d4aad" class="i field">_objectReader</a>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Creates an Object Reader for the pipeline.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r56 r">computerName</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Computer name that the pipeline specifies.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r57 r">runspaceId</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Runspace id that the pipeline specifies.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span><span class="c">the computer name and runspace id are associated with the</span>
        <span class="c">///</span><span class="c"> reader so as to enable cmdlets to identify which computer name runspace does</span>
        <span class="c">///</span><span class="c"> the object that this stream writes belongs to</span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>internal</b> <a href="IObjectReader.cs.html#6b2221741902f9bd" class="t t">PipelineReader</a>&lt;<b>object</b>&gt; <a id="3403b6e2c20c9747" href="../R/3403b6e2c20c9747.html" target="n" data-glyph="74,1" class="i method">GetObjectReaderForPipeline</a>(<b>string</b> <span id="r56 rd" class="r56 r">computerName</span>, <span class="i">Guid</span> <span id="r57 rd" class="r57 r">runspaceId</span>)
        {
            <b>if</b> (<a href="#3e8a095aa7125781" class="i field">_objectReaderForPipeline</a> == <b>null</b>)
            {
                <b>lock</b> (<a href="#a595da480bffcf70" class="i field">_syncObject</a>)
                {
                    <b>if</b> (<a href="#3e8a095aa7125781" class="i field">_objectReaderForPipeline</a> == <b>null</b>)
                    {
                        <a href="#3e8a095aa7125781" class="i field">_objectReaderForPipeline</a> =
                            <b>new</b> <a href="ObjectReader.cs.html#ed3880d18823d220" class="t constructor">PSDataCollectionPipelineReader</a>&lt;<span class="r52 r t">T</span>, <b>object</b>&gt;(<a href="#7277ae0921f30c7a" class="k">this</a>, <span class="r56 r">computerName</span>, <span class="r57 r">runspaceId</span>);
                    }
                }
            }
 
            <b>return</b> <a href="#3e8a095aa7125781" class="i field">_objectReaderForPipeline</a>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Return a PipelineReader(PSObject) for this stream.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal override</b> <a href="IObjectReader.cs.html#6b2221741902f9bd" class="t t">PipelineReader</a>&lt;<a href="../engine/MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt; <a id="89204fed82f83d0e" href="../R/89204fed82f83d0e.html" target="n" data-glyph="104,1" class="i property">PSObjectReader</a>
        {
            <b>get</b>
            {
                <b>if</b> (<a href="#6b15458f840b83c9" class="i field">_psobjectReader</a> == <b>null</b>)
                {
                    <b>lock</b> (<a href="#a595da480bffcf70" class="i field">_syncObject</a>)
                    {
                        <b>if</b> (<a href="#6b15458f840b83c9" class="i field">_psobjectReader</a> == <b>null</b>)
                        {
                            <a href="#6b15458f840b83c9" class="i field">_psobjectReader</a> = <b>new</b> <a href="ObjectReader.cs.html#dd1066d798fea900" class="t constructor">PSDataCollectionReader</a>&lt;<span class="r52 r t">T</span>, <a href="../engine/MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt;(<a href="#7277ae0921f30c7a" class="k">this</a>);
                        }
                    }
                }
 
                <b>return</b> <a href="#6b15458f840b83c9" class="i field">_psobjectReader</a>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Creates a PSObject Reader for this pipeline.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r58 r">computerName</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Computer name that the pipeline specifies.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r59 r">runspaceId</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Runspace id that the pipeline specifies.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span><span class="c">the computer name and runspace id are associated with the</span>
        <span class="c">///</span><span class="c"> reader so as to enable cmdlets to identify which computer name runspace does</span>
        <span class="c">///</span><span class="c"> the object that this stream writes belongs to</span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>internal</b> <a href="IObjectReader.cs.html#6b2221741902f9bd" class="t t">PipelineReader</a>&lt;<a href="../engine/MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt; <a id="4022074bb34dfed9" href="../R/4022074bb34dfed9.html" target="n" data-glyph="74,1" class="i method">GetPSObjectReaderForPipeline</a>(<b>string</b> <span id="r58 rd" class="r58 r">computerName</span>, <span class="i">Guid</span> <span id="r59 rd" class="r59 r">runspaceId</span>)
        {
            <b>if</b> (<a href="#50e109904ced4b04" class="i field">_psobjectReaderForPipeline</a> == <b>null</b>)
            {
                <b>lock</b> (<a href="#a595da480bffcf70" class="i field">_syncObject</a>)
                {
                    <b>if</b> (<a href="#50e109904ced4b04" class="i field">_psobjectReaderForPipeline</a> == <b>null</b>)
                    {
                        <a href="#50e109904ced4b04" class="i field">_psobjectReaderForPipeline</a> =
                            <b>new</b> <a href="ObjectReader.cs.html#ed3880d18823d220" class="t constructor">PSDataCollectionPipelineReader</a>&lt;<span class="r52 r t">T</span>, <a href="../engine/MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt;(<a href="#7277ae0921f30c7a" class="k">this</a>, <span class="r58 r">computerName</span>, <span class="r59 r">runspaceId</span>);
                    }
                }
            }
 
            <b>return</b> <a href="#50e109904ced4b04" class="i field">_psobjectReaderForPipeline</a>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> The object writer for this stream.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This field is allocated on first demand and</span>
        <span class="c">///</span><span class="c"> returned on subsequent calls.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>internal override</b> <a href="IObjectWriter.cs.html#37301df630b2ae9a" class="t t">PipelineWriter</a> <a id="ec0ff62c4b0a9a49" href="../R/ec0ff62c4b0a9a49.html" target="n" data-glyph="104,1" class="i property">ObjectWriter</a>
        {
            <b>get</b>
            {
                <b>if</b> (<a href="#7bb076742d7f0ec7" class="i field">_writer</a> == <b>null</b>)
                {
                    <b>lock</b> (<a href="#a595da480bffcf70" class="i field">_syncObject</a>)
                    {
                        <b>if</b> (<a href="#7bb076742d7f0ec7" class="i field">_writer</a> == <b>null</b>)
                        {
                            <a href="#7bb076742d7f0ec7" class="i field">_writer</a> = <b>new</b> <a href="ObjectWriter.cs.html#64cebdfb585c9cf6" class="t constructor">PSDataCollectionWriter</a>&lt;<span class="r52 r t">T</span>&gt;(<a href="#7277ae0921f30c7a" class="k">this</a>) <b>as</b> <a href="IObjectWriter.cs.html#37301df630b2ae9a" class="t t">PipelineWriter</a>;
                        }
                    }
                }
 
                <b>return</b> <a href="#7bb076742d7f0ec7" class="i field">_writer</a>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Read handle associated with this stream.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal override</b> <span class="i">WaitHandle</span> <a id="848ede72092d7e6e" href="../R/848ede72092d7e6e.html" target="n" data-glyph="104,1" class="i property">ReadHandle</a>
        {
            <b>get</b>
            {
                <b>return</b> <a href="#db0bd325daca1bfc" class="i field">_objects</a>.<a href="../engine/hostifaces/PSDataCollection.cs.html#2ab7ec209735b92b" class="i property">WaitHandle</a>;
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Write Abstractions
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Write object(s) to the databuffer.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r60 r">obj</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r61 r">enumerateCollection</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal override int</b> <a id="2c9f6b79ae44b94a" href="../R/2c9f6b79ae44b94a.html" target="n" data-glyph="74,1" class="i method">Write</a>(<b>object</b> <span id="r60 rd" class="r60 r">obj</span>, <b>bool</b> <span id="r61 rd" class="r61 r">enumerateCollection</span>)
        {
            <span class="c">// it is permitted to write null objects</span>
 
            <b>if</b> (<span class="r60 r">obj</span> == <a href="../engine/AutomationNull.cs.html#681fbea4c40e4af1" class="t t">AutomationNull</a>.<a href="../engine/AutomationNull.cs.html#1cf7e193da582896" class="i property">Value</a>)
            {
                <span class="c">// We no longer break on AutomationNull.Value,</span>
                <span class="c">// we just ignore it</span>
                <b>return</b> 0;
            }
 
            <b>if</b> (!<a href="#0e3474adb94bfb5b" class="i property">IsOpen</a>)
            {
                <span class="c">// NTRAID#Windows Out Of Band Releases-925742-2005/12/07-JonN</span>
                <b>string</b> <span id="r62 rd" class="r62 r">message</span> = <span class="i">PSDataBufferStrings</span>.<span class="i">WriteToClosedBuffer</span>;
                <span class="i">Exception</span> <span id="r63 rd" class="r63 r">e</span> = <b>new</b> <a href="ExecutionExceptions.cs.html#959293932430d8d7" class="t constructor">PipelineClosedException</a>(<span class="r62 r">message</span>);
                <b>throw</b> <span class="r63 r">e</span>;
            }
 
            <span class="c">// We want to write the objects as one block, not individually</span>
            <span class="c">// We do not want to hold the stream locked during the enumeration</span>
            <span class="i">Collection</span>&lt;<span class="r52 r t">T</span>&gt; <span id="r64 rd" class="r64 r">objectsToAdd</span> = <b>new</b> <span class="i">Collection</span>&lt;<span class="r52 r t">T</span>&gt;();
 
            <span class="i">IEnumerable</span> <span id="r65 rd" class="r65 r">enumerable</span> = <b>null</b>;
            <b>if</b> (<span class="r61 r">enumerateCollection</span>)
            {
                <span class="r65 r">enumerable</span> = <a href="../engine/LanguagePrimitives.cs.html#6dac09d64da9900c" class="t t">LanguagePrimitives</a>.<a href="../engine/LanguagePrimitives.cs.html#5489692986d47497" class="i method">GetEnumerable</a>(<span class="r60 r">obj</span>);
            }
 
            <b>if</b> (<span class="r65 r">enumerable</span> == <b>null</b>)
            {
                <span class="r64 r">objectsToAdd</span>.<span class="i">Add</span>((<span class="r52 r t">T</span>)<a href="../engine/LanguagePrimitives.cs.html#6dac09d64da9900c" class="t t">LanguagePrimitives</a>.<span class="i">ConvertTo</span>(<span class="r60 r">obj</span>,
                    <b>typeof</b>(<span class="r52 r t">T</span>), <span class="i">Globalization</span>.<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>));
            }
            <b>else</b>
            {
                <b>foreach</b> (<b>object</b> <span id="r66 rd" class="r66 r">o</span> <b>in</b> <span class="r65 r">enumerable</span>)
                {
                    <span class="c">//  Outputting stops when receiving a AutomationNull.Value</span>
                    <span class="c">//  There is a window where another thread could modify the</span>
                    <span class="c">//  array to contain AutomationNull.Value,</span>
                    <span class="c">//  but I&#39;m not going to deal with it.</span>
                    <b>if</b> (<a href="../engine/AutomationNull.cs.html#681fbea4c40e4af1" class="t t">AutomationNull</a>.<a href="../engine/AutomationNull.cs.html#1cf7e193da582896" class="i property">Value</a> == <span class="r66 r">o</span>)
                    {
                        <span class="c">// We no longer break on AutomationNull.Value,</span>
                        <span class="c">// we just ignore it</span>
                        <b>continue</b>;
                    }
 
                    <span class="r64 r">objectsToAdd</span>.<span class="i">Add</span>((<span class="r52 r t">T</span>)<a href="../engine/LanguagePrimitives.cs.html#6dac09d64da9900c" class="t t">LanguagePrimitives</a>.<span class="i">ConvertTo</span>(<span class="r60 r">obj</span>,
                        <b>typeof</b>(<span class="r52 r t">T</span>), <span class="i">Globalization</span>.<span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>));
                }
            }
 
            <a href="#db0bd325daca1bfc" class="i field">_objects</a>.<span class="i">InternalAddRange</span>(<a href="#2b74595266674149" class="i field">_psInstanceId</a>, <span class="r64 r">objectsToAdd</span>);
 
            <b>return</b> <span class="r64 r">objectsToAdd</span>.<span class="i">Count</span>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Virtual Method Implementation
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This stream do not perform close operations on the buffer.</span>
        <span class="c">///</span><span class="c"> It is upto the user to close the buffers as and when needed.</span>
        <span class="c">///</span><span class="c"> However this method notifies the buffer by decrementing the</span>
        <span class="c">///</span><span class="c"> ref count.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal override void</b> <a id="ced0aa52c520ca2b" href="../R/ced0aa52c520ca2b.html" target="n" data-glyph="74,1" class="i method">Close</a>()
        {
            <b>bool</b> <span id="r67 rd" class="r67 r">raiseEvents</span> = <b>false</b>;
            <b>lock</b> (<a href="#a595da480bffcf70" class="i field">_syncObject</a>)
            {
                <span class="c">// Make sure decrementref is called only once. if this</span>
                <span class="c">// stream is already closed..no need to decrement again.</span>
                <span class="c">// isOpen controls if this current stream is open or not.</span>
                <b>if</b> (<a href="#eb23efcb2107604c" class="i field">_isOpen</a>)
                {
                    <span class="c">// Decrement ref count (and other event handlers) for the store.</span>
                    <span class="c">// PowerShell engine is done using this store.</span>
                    <a href="#db0bd325daca1bfc" class="i field">_objects</a>.<a href="../engine/hostifaces/PSDataCollection.cs.html#737fb48bd51a18aa" class="i method">DecrementRef</a>();
                    <a href="#db0bd325daca1bfc" class="i field">_objects</a>.<a href="../engine/hostifaces/PSDataCollection.cs.html#de98d172ff9dac86" class="i">DataAdded</a> -= <span class="i">HandleDataAdded</span>;
                    <a href="#db0bd325daca1bfc" class="i field">_objects</a>.<a href="../engine/hostifaces/PSDataCollection.cs.html#6babaf76cd9d021c" class="i">Completed</a> -= <span class="i">HandleClosed</span>;
 
                    <span class="r67 r">raiseEvents</span> = <b>true</b>;
                    <a href="#eb23efcb2107604c" class="i field">_isOpen</a> = <b>false</b>;
                }
            }
 
            <b>if</b> (<span class="r67 r">raiseEvents</span>)
            {
                <span class="i">FireDataReadyEvent</span>(<a href="#7277ae0921f30c7a" class="k">this</a>, <span class="i">EventArgs</span>.<span class="i">Empty</span>);
            }
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Event Handlers
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r68 r">sender</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r69 r">e</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>private void</b> <a id="46352e007164f713" href="../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">HandleClosed</a>(<b>object</b> <span id="r68 rd" class="r68 r">sender</span>, <span class="i">EventArgs</span> <span id="r69 rd" class="r69 r">e</span>)
        {
            <a href="#ced0aa52c520ca2b" class="i method">Close</a>();
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r70 r">sender</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r71 r">e</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>private void</b> <a id="a972e0d99ef9993f" href="../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">HandleDataAdded</a>(<b>object</b> <span id="r70 rd" class="r70 r">sender</span>, <a href="../engine/hostifaces/PSDataCollection.cs.html#7044b5d8986ab72f" class="t t">DataAddedEventArgs</a> <span id="r71 rd" class="r71 r">e</span>)
        {
            <span class="i">FireDataReadyEvent</span>(<a href="#7277ae0921f30c7a" class="k">this</a>, <span class="i">EventArgs</span>.<span class="i">Empty</span>);
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> Event Handlers
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> IDisposable
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Release all resources.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r72 r">disposing</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">If true, release all resources.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>protected override void</b> <a id="b778544a72e7f5ef" href="../R/b778544a72e7f5ef.html" target="n" data-glyph="75,1" class="i method">Dispose</a>(<b>bool</b> <span id="r72 rd" class="r72 r">disposing</span>)
        {
            <b>if</b> (<a href="#aa1cfe55f8bbc5a1" class="i field">_disposed</a>)
            {
                <b>return</b>;
            }
 
            <b>lock</b> (<a href="#a595da480bffcf70" class="i field">_syncObject</a>)
            {
                <b>if</b> (<a href="#aa1cfe55f8bbc5a1" class="i field">_disposed</a>)
                {
                    <b>return</b>;
                }
 
                <a href="#aa1cfe55f8bbc5a1" class="i field">_disposed</a> = <b>true</b>;
            }
 
            <b>if</b> (<span class="r72 r">disposing</span>)
            {
                <a href="#db0bd325daca1bfc" class="i field">_objects</a>.<a href="../engine/hostifaces/PSDataCollection.cs.html#17fb91187cc003fd" class="i method">Dispose</a>();
 
                <a href="#ced0aa52c520ca2b" class="i method">Close</a>();
 
                <b>if</b> (<a href="#3e8a095aa7125781" class="i field">_objectReaderForPipeline</a> != <b>null</b>)
                {
                    ((<a href="ObjectReader.cs.html#e7b370fd04a9d878" class="t t">PSDataCollectionPipelineReader</a>&lt;<span class="r52 r t">T</span>, <b>object</b>&gt;)<a href="#3e8a095aa7125781" class="i field">_objectReaderForPipeline</a>).<a href="ObjectReader.cs.html#488ec1d048383301" class="i method">Dispose</a>();
                }
 
                <b>if</b> (<a href="#50e109904ced4b04" class="i field">_psobjectReaderForPipeline</a> != <b>null</b>)
                {
                    ((<a href="ObjectReader.cs.html#e7b370fd04a9d878" class="t t">PSDataCollectionPipelineReader</a>&lt;<span class="r52 r t">T</span>, <a href="../engine/MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>&gt;)<a href="#50e109904ced4b04" class="i field">_psobjectReaderForPipeline</a>).<a href="ObjectReader.cs.html#488ec1d048383301" class="i method">Dispose</a>();
                }
            }
        }
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> IDisposable
    }
}
</pre></td></tr></table></div></body></html>
