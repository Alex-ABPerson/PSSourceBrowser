<!DOCTYPE html>
<html><head><title>PathUtils.cs</title><link rel="stylesheet" href="../../styles.css"><script src="../../scripts.js"></script></head>
<body class="cB" onload="i(562);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#System.Management.Automation/utils/PathUtils.cs" target="_top">utils\PathUtils.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#System.Management.Automation" target="_top">src\System.Management.Automation\System.Management.Automation.csproj</a> (System.Management.Automation)</td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation.</span>
<span class="c">// Licensed under the MIT License.</span>
 
<b>using</b> <span class="i n">System</span>.<span class="i">Collections</span>.<span class="i">Generic</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Globalization</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">IO</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Internal</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Runtime</span>.<span class="i">CompilerServices</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Text</span>;
 
<b>using</b> <span class="t">Dbg</span> = <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="assert.cs.html#c04955255430d32f" class="t t">Diagnostics</a>;
 
<b>namespace</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>
{
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Defines generic utilities and helper methods for PowerShell.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>internal static class</b> <a id="fdaf75f786a21eb9" href="../R/fdaf75f786a21eb9.html" target="n" data-glyph="2,0" class="t t">PathUtils</a>
    {
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> THE method for opening a file for writing.</span>
        <span class="c">///</span><span class="c"> Should be used by all cmdlets that write to a file.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r0 r">cmdlet</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Cmdlet that is opening the file (used mainly for error reporting).</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r1 r">filePath</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Path to the file (as specified on the command line - this method will resolve the path).</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r2 r">encoding</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Encoding (this method will convert the command line string to an Encoding instance).</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r3 r">defaultEncoding</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">If </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">langword</span><span class="c">=</span><span class="c">&quot;</span><span class="c">true</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c">, then we will use default .NET encoding instead of the encoding specified in </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r2 r">encoding</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> parameter.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r4 r">Append</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r5 r">Force</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r6 r">NoClobber</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r7 r">fileStream</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Result1: </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">FileStream</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> opened for writing.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r8 r">streamWriter</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Result2: </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">StreamWriter</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> (inherits from </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">TextWriter</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c">) opened for writing.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r9 r">readOnlyFileInfo</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Result3: file info that should be used to restore file attributes after done with the file (</span><span class="c">&lt;</span><span class="c">see</span> <span class="c">langword</span><span class="c">=</span><span class="c">&quot;</span><span class="c">null</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> is this is not needed).</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r10 r">isLiteralPath</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">True if wildcard expansion should be bypassed.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal static void</b> <a id="87afbcf1303c2952" href="../R/87afbcf1303c2952.html" target="n" data-glyph="74,1" class="i method">MasterStreamOpen</a>(
            <a href="../P/30543a6971fed1fc.html#30543a6971fed1fc" class="t t">PSCmdlet</a> <span id="r0 rd" class="r0 r">cmdlet</span>,
            <b>string</b> <span id="r1 rd" class="r1 r">filePath</span>,
            <b>string</b> <span id="r2 rd" class="r2 r">encoding</span>,
            <b>bool</b> <span id="r3 rd" class="r3 r">defaultEncoding</span>,
            <b>bool</b> <span id="r4 rd" class="r4 r">Append</span>,
            <b>bool</b> <span id="r5 rd" class="r5 r">Force</span>,
            <b>bool</b> <span id="r6 rd" class="r6 r">NoClobber</span>,
            <b>out</b> <span class="i">FileStream</span> <span id="r7 rd" class="r7 r">fileStream</span>,
            <b>out</b> <span class="i">StreamWriter</span> <span id="r8 rd" class="r8 r">streamWriter</span>,
            <b>out</b> <span class="i">FileInfo</span> <span id="r9 rd" class="r9 r">readOnlyFileInfo</span>,
            <b>bool</b> <span id="r10 rd" class="r10 r">isLiteralPath</span>
            )
        {
            <span class="i">Encoding</span> <span id="r11 rd" class="r11 r">resolvedEncoding</span> = <a href="EncodingUtils.cs.html#60f6ffa4e5dbe760" class="t t">EncodingConversion</a>.<a href="EncodingUtils.cs.html#a9430c5f25a0f1d2" class="i method">Convert</a>(<span class="r0 r">cmdlet</span>, <span class="r2 r">encoding</span>);
 
            <a href="#c3461eda33679bcb" class="i method">MasterStreamOpen</a>(<span class="r0 r">cmdlet</span>, <span class="r1 r">filePath</span>, <span class="r11 r">resolvedEncoding</span>, <span class="r3 r">defaultEncoding</span>, <span class="r4 r">Append</span>, <span class="r5 r">Force</span>, <span class="r6 r">NoClobber</span>, <b>out</b> <span class="r7 r">fileStream</span>, <b>out</b> <span class="r8 r">streamWriter</span>, <b>out</b> <span class="r9 r">readOnlyFileInfo</span>, <span class="r10 r">isLiteralPath</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> THE method for opening a file for writing.</span>
        <span class="c">///</span><span class="c"> Should be used by all cmdlets that write to a file.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r12 r">cmdlet</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Cmdlet that is opening the file (used mainly for error reporting).</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r13 r">filePath</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Path to the file (as specified on the command line - this method will resolve the path).</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r14 r">resolvedEncoding</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Encoding (this method will convert the command line string to an Encoding instance).</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r15 r">defaultEncoding</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">If </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">langword</span><span class="c">=</span><span class="c">&quot;</span><span class="c">true</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c">, then we will use default .NET encoding instead of the encoding specified in </span><span class="c">&lt;</span><span class="c">paramref</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="i">encoding</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> parameter.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r16 r">Append</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r17 r">Force</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r18 r">NoClobber</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r19 r">fileStream</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Result1: </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">FileStream</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> opened for writing.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r20 r">streamWriter</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Result2: </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">StreamWriter</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> (inherits from </span><span class="c">&lt;</span><span class="c">see</span> <span class="c">cref</span><span class="c">=</span><span class="c">&quot;</span><span class="i">TextWriter</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c">) opened for writing.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r21 r">readOnlyFileInfo</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Result3: file info that should be used to restore file attributes after done with the file (</span><span class="c">&lt;</span><span class="c">see</span> <span class="c">langword</span><span class="c">=</span><span class="c">&quot;</span><span class="c">null</span><span class="c">&quot;</span><span class="c">/&gt;</span><span class="c"> is this is not needed).</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r22 r">isLiteralPath</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">True if wildcard expansion should be bypassed.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal static void</b> <a id="c3461eda33679bcb" href="../R/c3461eda33679bcb.html" target="n" data-glyph="74,1" class="i method">MasterStreamOpen</a>(
            <a href="../P/30543a6971fed1fc.html#30543a6971fed1fc" class="t t">PSCmdlet</a> <span id="r12 rd" class="r12 r">cmdlet</span>,
            <b>string</b> <span id="r13 rd" class="r13 r">filePath</span>,
            <span class="i">Encoding</span> <span id="r14 rd" class="r14 r">resolvedEncoding</span>,
            <b>bool</b> <span id="r15 rd" class="r15 r">defaultEncoding</span>,
            <b>bool</b> <span id="r16 rd" class="r16 r">Append</span>,
            <b>bool</b> <span id="r17 rd" class="r17 r">Force</span>,
            <b>bool</b> <span id="r18 rd" class="r18 r">NoClobber</span>,
            <b>out</b> <span class="i">FileStream</span> <span id="r19 rd" class="r19 r">fileStream</span>,
            <b>out</b> <span class="i">StreamWriter</span> <span id="r20 rd" class="r20 r">streamWriter</span>,
            <b>out</b> <span class="i">FileInfo</span> <span id="r21 rd" class="r21 r">readOnlyFileInfo</span>,
            <b>bool</b> <span id="r22 rd" class="r22 r">isLiteralPath</span>)
        {
            <span class="r19 r">fileStream</span> = <b>null</b>;
            <span class="r20 r">streamWriter</span> = <b>null</b>;
            <span class="r21 r">readOnlyFileInfo</span> = <b>null</b>;
 
            <span class="c">// resolve the path and the encoding</span>
            <b>string</b> <span id="r23 rd" class="r23 r">resolvedPath</span> = <a href="#87b166a6163dc3a1" class="i method">ResolveFilePath</a>(<span class="r13 r">filePath</span>, <span class="r12 r">cmdlet</span>, <span class="r22 r">isLiteralPath</span>);
 
            <b>try</b>
            {
                <span class="c">// variable to track file open mode</span>
                <span class="c">// this is controlled by append/force parameters</span>
                <span class="i">FileMode</span> <span id="r24 rd" class="r24 r">mode</span> = <span class="i">FileMode</span>.<span class="i">Create</span>;
                <b>if</b> (<span class="r16 r">Append</span>)
                {
                    <span class="r24 r">mode</span> = <span class="i">FileMode</span>.<span class="i">Append</span>;
                }
                <b>else</b> <b>if</b> (<span class="r18 r">NoClobber</span>)
                {
                    <span class="c">// throw IOException if file exists</span>
                    <span class="r24 r">mode</span> = <span class="i">FileMode</span>.<span class="i">CreateNew</span>;
                }
 
                <b>if</b> (<span class="r17 r">Force</span> &amp;&amp; (<span class="r16 r">Append</span> || !<span class="r18 r">NoClobber</span>))
                {
                    <b>if</b> (<span class="i">File</span>.<span class="i">Exists</span>(<span class="r23 r">resolvedPath</span>))
                    {
                        <span class="i">FileInfo</span> <span id="r25 rd" class="r25 r">fInfo</span> = <b>new</b> <span class="i">FileInfo</span>(<span class="r23 r">resolvedPath</span>);
                        <b>if</b> ((<span class="r25 r">fInfo</span>.<span class="i">Attributes</span> &amp; <span class="i">FileAttributes</span>.<span class="i">ReadOnly</span>) == <span class="i">FileAttributes</span>.<span class="i">ReadOnly</span>)
                        {
                            <span class="c">// remember to reset the read-only attribute later</span>
                            <span class="r21 r">readOnlyFileInfo</span> = <span class="r25 r">fInfo</span>;
                            <span class="c">// Clear the read-only attribute</span>
                            <span class="r25 r">fInfo</span>.<span class="i">Attributes</span> &amp;= ~(<span class="i">FileAttributes</span>.<span class="i">ReadOnly</span>);
                        }
                    }
                }
 
                <span class="c">// if the user knows what he/she is doing and uses &quot;-Force&quot; switch,</span>
                <span class="c">// then we let more than 1 process write to the same file at the same time</span>
                <span class="i">FileShare</span> <span id="r26 rd" class="r26 r">fileShare</span> = <span class="r17 r">Force</span> ? <span class="i">FileShare</span>.<span class="i">ReadWrite</span> : <span class="i">FileShare</span>.<span class="i">Read</span>;
 
                <span class="c">// mode is controlled by force and ShouldContinue()</span>
                <span class="r19 r">fileStream</span> = <b>new</b> <span class="i">FileStream</span>(<span class="r23 r">resolvedPath</span>, <span class="r24 r">mode</span>, <span class="i">FileAccess</span>.<span class="i">Write</span>, <span class="r26 r">fileShare</span>);
 
                <span class="c">// create stream writer</span>
                <span class="c">// NTRAID#Windows Out Of Band Releases-931008-2006/03/27</span>
                <span class="c">// For some reason, calling this without specifying</span>
                <span class="c">// the encoding is different from passing Encoding.Default.</span>
                <b>if</b> (<span class="r15 r">defaultEncoding</span>)
                    <span class="r20 r">streamWriter</span> = <b>new</b> <span class="i">StreamWriter</span>(<span class="r19 r">fileStream</span>);
                <b>else</b>
                    <span class="r20 r">streamWriter</span> = <b>new</b> <span class="i">StreamWriter</span>(<span class="r19 r">fileStream</span>, <span class="r14 r">resolvedEncoding</span>);
            }
            <span class="c">// These are the known exceptions for File.Load and StreamWriter.ctor</span>
            <b>catch</b> (<span class="i">ArgumentException</span> <span id="r27 rd" class="r27 r">e</span>)
            {
                <span class="c">// NOTE: this call will throw</span>
                <span class="i">ReportFileOpenFailure</span>(<span class="r12 r">cmdlet</span>, <span class="r23 r">resolvedPath</span>, <span class="r27 r">e</span>);
            }
            <b>catch</b> (<span class="i">IOException</span> <span id="r28 rd" class="r28 r">e</span>)
            {
                <b>if</b> (<span class="r18 r">NoClobber</span> &amp;&amp; <span class="i">File</span>.<span class="i">Exists</span>(<span class="r23 r">resolvedPath</span>))
                {
                    <span class="c">// This probably happened because the file already exists</span>
                    <a href="../engine/ErrorPackage.cs.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r29 rd" class="r29 r">errorRecord</span> = <b>new</b> <span class="t">ErrorRecord</span>(
                        <span class="r28 r">e</span>, <span class="s">&quot;NoClobber&quot;</span>, <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#22cb3b8b80f740be" class="i field">ResourceExists</a>, <span class="r23 r">resolvedPath</span>);
                    <span class="r29 r">errorRecord</span>.<a href="../engine/ErrorPackage.cs.html#4e9df045b6372ce0" class="i property">ErrorDetails</a> = <b>new</b> <a href="../engine/ErrorPackage.cs.html#7fe54a607e0a0d61" class="t constructor">ErrorDetails</a>(
                        <span class="r12 r">cmdlet</span>,
                        <span class="s">&quot;PathUtilsStrings&quot;</span>,
                        <span class="s">&quot;UtilityFileExistsNoClobber&quot;</span>,
                        <span class="r13 r">filePath</span>,
                        <span class="s">&quot;NoClobber&quot;</span>); <span class="c">// prevents localization</span>
 
                    <span class="c">// NOTE: this call will throw</span>
                    <span class="r12 r">cmdlet</span>.<a href="../engine/cmdlet.cs.html#e3346d70990a1763" class="i method">ThrowTerminatingError</a>(<span class="r29 r">errorRecord</span>);
                }
                <span class="c">// NOTE: this call will throw</span>
                <span class="i">ReportFileOpenFailure</span>(<span class="r12 r">cmdlet</span>, <span class="r23 r">resolvedPath</span>, <span class="r28 r">e</span>);
            }
            <b>catch</b> (<span class="i">UnauthorizedAccessException</span> <span id="r30 rd" class="r30 r">e</span>)
            {
                <span class="c">// NOTE: this call will throw</span>
                <span class="i">ReportFileOpenFailure</span>(<span class="r12 r">cmdlet</span>, <span class="r23 r">resolvedPath</span>, <span class="r30 r">e</span>);
            }
            <b>catch</b> (<span class="i">NotSupportedException</span> <span id="r31 rd" class="r31 r">e</span>)
            {
                <span class="c">// NOTE: this call will throw</span>
                <span class="i">ReportFileOpenFailure</span>(<span class="r12 r">cmdlet</span>, <span class="r23 r">resolvedPath</span>, <span class="r31 r">e</span>);
            }
            <b>catch</b> (<span class="i n">System</span>.<span class="i">Security</span>.<span class="i">SecurityException</span> <span id="r32 rd" class="r32 r">e</span>)
            {
                <span class="c">// NOTE: this call will throw</span>
                <span class="i">ReportFileOpenFailure</span>(<span class="r12 r">cmdlet</span>, <span class="r23 r">resolvedPath</span>, <span class="r32 r">e</span>);
            }
        }
 
        <b>internal static void</b> <a id="b74591a0a95614b7" href="../R/../../0000000000.html" target="n" data-glyph="74,1" class="i method">ReportFileOpenFailure</a>(<a href="../engine/cmdlet.cs.html#b0d421ff1d7581f9" class="t t">Cmdlet</a> <span id="r33 rd" class="r33 r">cmdlet</span>, <b>string</b> <span id="r34 rd" class="r34 r">filePath</span>, <span class="i">Exception</span> <span id="r35 rd" class="r35 r">e</span>)
        {
            <a href="../engine/ErrorPackage.cs.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r36 rd" class="r36 r">errorRecord</span> = <b>new</b> <a href="../engine/ErrorPackage.cs.html#e9334565e5136f43" class="t constructor">ErrorRecord</a>(
                <span class="r35 r">e</span>,
                <span class="s">&quot;FileOpenFailure&quot;</span>,
                <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#7650567b7604bddc" class="i field">OpenError</a>,
                <b>null</b>);
 
            <span class="r33 r">cmdlet</span>.<a href="../engine/cmdlet.cs.html#e3346d70990a1763" class="i method">ThrowTerminatingError</a>(<span class="r36 r">errorRecord</span>);
        }
 
        <b>internal static</b> <span class="i">StreamReader</span> <a id="74fc4edc84c98657" href="../R/../../0000000000.html" target="n" data-glyph="74,1" class="i method">OpenStreamReader</a>(<a href="../P/30543a6971fed1fc.html#30543a6971fed1fc" class="t t">PSCmdlet</a> <span id="r37 rd" class="r37 r">command</span>, <b>string</b> <span id="r38 rd" class="r38 r">filePath</span>, <span class="i">Encoding</span> <span id="r39 rd" class="r39 r">encoding</span>, <b>bool</b> <span id="r40 rd" class="r40 r">isLiteralPath</span>)
        {
            <span class="i">FileStream</span> <span id="r41 rd" class="r41 r">fileStream</span> = <a href="#63a591d724d103d4" class="i method">OpenFileStream</a>(<span class="r38 r">filePath</span>, <span class="r37 r">command</span>, <span class="r40 r">isLiteralPath</span>);
            <b>return</b> <b>new</b> <span class="i">StreamReader</span>(<span class="r41 r">fileStream</span>, <span class="r39 r">encoding</span>);
        }
 
        <b>internal static</b> <span class="i">FileStream</span> <a id="63a591d724d103d4" href="../R/63a591d724d103d4.html" target="n" data-glyph="74,1" class="i method">OpenFileStream</a>(<b>string</b> <span id="r42 rd" class="r42 r">filePath</span>, <a href="../P/30543a6971fed1fc.html#30543a6971fed1fc" class="t t">PSCmdlet</a> <span id="r43 rd" class="r43 r">command</span>, <b>bool</b> <span id="r44 rd" class="r44 r">isLiteralPath</span>)
        {
            <b>string</b> <span id="r45 rd" class="r45 r">resolvedPath</span> = <a href="#fdaf75f786a21eb9" class="t t">PathUtils</a>.<a href="#87b166a6163dc3a1" class="i method">ResolveFilePath</a>(<span class="r42 r">filePath</span>, <span class="r43 r">command</span>, <span class="r44 r">isLiteralPath</span>);
 
            <b>try</b>
            {
                <b>return</b> <b>new</b> <span class="i">FileStream</span>(<span class="r45 r">resolvedPath</span>, <span class="i">FileMode</span>.<span class="i">Open</span>, <span class="i">FileAccess</span>.<span class="i">Read</span>, <span class="i">FileShare</span>.<span class="i">ReadWrite</span>);
            }
            <span class="c">// These are the known exceptions for FileStream.ctor</span>
            <b>catch</b> (<span class="i">ArgumentException</span> <span id="r46 rd" class="r46 r">e</span>)
            {
                <a href="#fdaf75f786a21eb9" class="t t">PathUtils</a>.<span class="i">ReportFileOpenFailure</span>(<span class="r43 r">command</span>, <span class="r42 r">filePath</span>, <span class="r46 r">e</span>);
                <b>return</b> <b>null</b>; <span class="c">// the line above will throw - silencing the compiler</span>
            }
            <b>catch</b> (<span class="i">IOException</span> <span id="r47 rd" class="r47 r">e</span>)
            {
                <a href="#fdaf75f786a21eb9" class="t t">PathUtils</a>.<span class="i">ReportFileOpenFailure</span>(<span class="r43 r">command</span>, <span class="r42 r">filePath</span>, <span class="r47 r">e</span>);
                <b>return</b> <b>null</b>; <span class="c">// the line above will throw - silencing the compiler</span>
            }
            <b>catch</b> (<span class="i">UnauthorizedAccessException</span> <span id="r48 rd" class="r48 r">e</span>)
            {
                <a href="#fdaf75f786a21eb9" class="t t">PathUtils</a>.<span class="i">ReportFileOpenFailure</span>(<span class="r43 r">command</span>, <span class="r42 r">filePath</span>, <span class="r48 r">e</span>);
                <b>return</b> <b>null</b>; <span class="c">// the line above will throw - silencing the compiler</span>
            }
            <b>catch</b> (<span class="i">NotSupportedException</span> <span id="r49 rd" class="r49 r">e</span>)
            {
                <a href="#fdaf75f786a21eb9" class="t t">PathUtils</a>.<span class="i">ReportFileOpenFailure</span>(<span class="r43 r">command</span>, <span class="r42 r">filePath</span>, <span class="r49 r">e</span>);
                <b>return</b> <b>null</b>; <span class="c">// the line above will throw - silencing the compiler</span>
            }
            <b>catch</b> (<span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<a href="SessionStateExceptions.cs.html#09140e6dc875019b" class="t t">DriveNotFoundException</a> <span id="r50 rd" class="r50 r">e</span>)
            {
                <a href="#fdaf75f786a21eb9" class="t t">PathUtils</a>.<span class="i">ReportFileOpenFailure</span>(<span class="r43 r">command</span>, <span class="r42 r">filePath</span>, <span class="r50 r">e</span>);
                <b>return</b> <b>null</b>; <span class="c">// the line above will throw - silencing the compiler</span>
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Resolve a user provided file name or path (including globbing characters)</span>
        <span class="c">///</span><span class="c"> to a fully qualified file path, using the file system provider.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r51 r">filePath</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r52 r">command</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal static string</b> <a id="c808ee0f654fb8a6" href="../R/../../0000000000.html" target="n" data-glyph="74,1" class="i method">ResolveFilePath</a>(<b>string</b> <span id="r51 rd" class="r51 r">filePath</span>, <a href="../P/30543a6971fed1fc.html#30543a6971fed1fc" class="t t">PSCmdlet</a> <span id="r52 rd" class="r52 r">command</span>)
        {
            <b>return</b> <a href="#87b166a6163dc3a1" class="i method">ResolveFilePath</a>(<span class="r51 r">filePath</span>, <span class="r52 r">command</span>, <b>false</b>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Resolve a user provided file name or path (including globbing characters)</span>
        <span class="c">///</span><span class="c"> to a fully qualified file path, using the file system provider.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r53 r">filePath</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r54 r">command</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r55 r">isLiteralPath</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal static string</b> <a id="87b166a6163dc3a1" href="../R/87b166a6163dc3a1.html" target="n" data-glyph="74,1" class="i method">ResolveFilePath</a>(<b>string</b> <span id="r53 rd" class="r53 r">filePath</span>, <a href="../P/30543a6971fed1fc.html#30543a6971fed1fc" class="t t">PSCmdlet</a> <span id="r54 rd" class="r54 r">command</span>, <b>bool</b> <span id="r55 rd" class="r55 r">isLiteralPath</span>)
        {
            <b>string</b> <span id="r56 rd" class="r56 r">path</span> = <b>null</b>;
 
            <b>try</b>
            {
                <a href="../engine/DataStoreAdapterProvider.cs.html#dd4e1f2f8e73a1dd" class="t t">ProviderInfo</a> <span id="r57 rd" class="r57 r">provider</span> = <b>null</b>;
                <a href="../engine/DataStoreAdapter.cs.html#2d16b26a541ba185" class="t t">PSDriveInfo</a> <span id="r58 rd" class="r58 r">drive</span> = <b>null</b>;
                <span class="i">List</span>&lt;<b>string</b>&gt; <span id="r59 rd" class="r59 r">filePaths</span> = <b>new</b> <span class="i">List</span>&lt;<b>string</b>&gt;();
 
                <b>if</b> (<span class="r55 r">isLiteralPath</span>)
                {
                    <span class="r59 r">filePaths</span>.<span class="i">Add</span>(<span class="r54 r">command</span>.<a href="../engine/CommandBase.cs.html#5078d443148de142" class="i property">SessionState</a>.<a href="../engine/SessionStatePublic.cs.html#3390cfbbdcffb036" class="i property">Path</a>.<a href="../engine/PathInterfaces.cs.html#89444ef2b32a4408" class="i method">GetUnresolvedProviderPathFromPSPath</a>(<span class="r53 r">filePath</span>, <b>out</b> <span class="r57 r">provider</span>, <b>out</b> <span class="r58 r">drive</span>));
                }
                <b>else</b>
                {
                    <span class="r59 r">filePaths</span>.<span class="i">AddRange</span>(<span class="r54 r">command</span>.<a href="../engine/CommandBase.cs.html#5078d443148de142" class="i property">SessionState</a>.<a href="../engine/SessionStatePublic.cs.html#3390cfbbdcffb036" class="i property">Path</a>.<a href="../engine/PathInterfaces.cs.html#4931b2e78f6aaef1" class="i method">GetResolvedProviderPathFromPSPath</a>(<span class="r53 r">filePath</span>, <b>out</b> <span class="r57 r">provider</span>));
                }
 
                <b>if</b> (!<span class="r57 r">provider</span>.<a href="../engine/DataStoreAdapterProvider.cs.html#13e2cce7adaad137" class="i method">NameEquals</a>(<span class="r54 r">command</span>.<a href="../engine/CommandBase.cs.html#a41a765d70fc9c9d" class="i property">Context</a>.<a href="../engine/ExecutionContext.cs.html#733af3e5592e5947" class="i property">ProviderNames</a>.<a href="../engine/ProviderNames.cs.html#07509539bc35966f" class="i property">FileSystem</a>))
                {
                    <a href="#7dae20926adb7dd5" class="i method">ReportWrongProviderType</a>(<span class="r54 r">command</span>, <span class="r57 r">provider</span>.<a href="../engine/DataStoreAdapterProvider.cs.html#91a8d08ee3ba5a61" class="i property">FullName</a>);
                }
 
                <b>if</b> (<span class="r59 r">filePaths</span>.<span class="i">Count</span> &gt; 1)
                {
                    <a href="#8d3f5f2e87698e7a" class="i method">ReportMultipleFilesNotSupported</a>(<span class="r54 r">command</span>);
                }
 
                <b>if</b> (<span class="r59 r">filePaths</span>.<span class="i">Count</span> == 0)
                {
                    <a href="#5f661d663ee75335" class="i method">ReportWildcardingFailure</a>(<span class="r54 r">command</span>, <span class="r53 r">filePath</span>);
                }
 
                <span class="r56 r">path</span> = <span class="r59 r">filePaths</span>[0];
            }
            <b>catch</b> (<a href="SessionStateExceptions.cs.html#9ed59df3c4c15193" class="t t">ItemNotFoundException</a>)
            {
                <span class="r56 r">path</span> = <b>null</b>;
            }
 
            <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r56 r">path</span>))
            {
                <a href="../namespaces/CoreCommandContext.cs.html#1e83d35d5286e174" class="t t">CmdletProviderContext</a> <span id="r60 rd" class="r60 r">cmdletProviderContext</span> = <b>new</b> <a href="../namespaces/CoreCommandContext.cs.html#ce9b8f5a7a73244f" class="t constructor">CmdletProviderContext</a>(<span class="r54 r">command</span>);
                <a href="../engine/DataStoreAdapterProvider.cs.html#dd4e1f2f8e73a1dd" class="t t">ProviderInfo</a> <span id="r61 rd" class="r61 r">provider</span> = <b>null</b>;
                <a href="../engine/DataStoreAdapter.cs.html#2d16b26a541ba185" class="t t">PSDriveInfo</a> <span id="r62 rd" class="r62 r">drive</span> = <b>null</b>;
                <span class="r56 r">path</span> =
                    <span class="r54 r">command</span>.<a href="../engine/CommandBase.cs.html#5078d443148de142" class="i property">SessionState</a>.<a href="../engine/SessionStatePublic.cs.html#3390cfbbdcffb036" class="i property">Path</a>.<a href="../engine/PathInterfaces.cs.html#9c8992a5e414cb6d" class="i method">GetUnresolvedProviderPathFromPSPath</a>(
                        <span class="r53 r">filePath</span>, <span class="r60 r">cmdletProviderContext</span>, <b>out</b> <span class="r61 r">provider</span>, <b>out</b> <span class="r62 r">drive</span>);
                <span class="r60 r">cmdletProviderContext</span>.<a href="../namespaces/CoreCommandContext.cs.html#c8e1b5c9dc612598" class="i method">ThrowFirstErrorOrDoNothing</a>();
                <b>if</b> (!<span class="r61 r">provider</span>.<a href="../engine/DataStoreAdapterProvider.cs.html#13e2cce7adaad137" class="i method">NameEquals</a>(<span class="r54 r">command</span>.<a href="../engine/CommandBase.cs.html#a41a765d70fc9c9d" class="i property">Context</a>.<a href="../engine/ExecutionContext.cs.html#733af3e5592e5947" class="i property">ProviderNames</a>.<a href="../engine/ProviderNames.cs.html#07509539bc35966f" class="i property">FileSystem</a>))
                {
                    <a href="#7dae20926adb7dd5" class="i method">ReportWrongProviderType</a>(<span class="r54 r">command</span>, <span class="r61 r">provider</span>.<a href="../engine/DataStoreAdapterProvider.cs.html#91a8d08ee3ba5a61" class="i property">FullName</a>);
                }
            }
 
            <b>return</b> <span class="r56 r">path</span>;
        }
 
        <b>internal static void</b> <a id="7dae20926adb7dd5" href="../R/7dae20926adb7dd5.html" target="n" data-glyph="74,1" class="i method">ReportWrongProviderType</a>(<a href="../engine/cmdlet.cs.html#b0d421ff1d7581f9" class="t t">Cmdlet</a> <span id="r63 rd" class="r63 r">cmdlet</span>, <b>string</b> <span id="r64 rd" class="r64 r">providerId</span>)
        {
            <b>string</b> <span id="r65 rd" class="r65 r">msg</span> = <a href="StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">PathUtilsStrings</span>.<span class="i">OutFile_ReadWriteFileNotFileSystemProvider</span>, <span class="r64 r">providerId</span>);
 
            <a href="../engine/ErrorPackage.cs.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r66 rd" class="r66 r">errorRecord</span> = <b>new</b> <span class="t">ErrorRecord</span>(
                <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="MshTraceSource.cs.html#4f3f8175dd33a015" class="i method">NewInvalidOperationException</a>(),
                <span class="s">&quot;ReadWriteFileNotFileSystemProvider&quot;</span>,
                <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#846d2b572f2c4820" class="i field">InvalidArgument</a>,
                <b>null</b>);
 
            <span class="r66 r">errorRecord</span>.<a href="../engine/ErrorPackage.cs.html#4e9df045b6372ce0" class="i property">ErrorDetails</a> = <b>new</b> <a href="../engine/ErrorPackage.cs.html#908615d662085fc6" class="t constructor">ErrorDetails</a>(<span class="r65 r">msg</span>);
            <span class="r63 r">cmdlet</span>.<a href="../engine/cmdlet.cs.html#e3346d70990a1763" class="i method">ThrowTerminatingError</a>(<span class="r66 r">errorRecord</span>);
        }
 
        <b>internal static void</b> <a id="8d3f5f2e87698e7a" href="../R/8d3f5f2e87698e7a.html" target="n" data-glyph="74,1" class="i method">ReportMultipleFilesNotSupported</a>(<a href="../engine/cmdlet.cs.html#b0d421ff1d7581f9" class="t t">Cmdlet</a> <span id="r67 rd" class="r67 r">cmdlet</span>)
        {
            <b>string</b> <span id="r68 rd" class="r68 r">msg</span> = <a href="StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">PathUtilsStrings</span>.<span class="i">OutFile_MultipleFilesNotSupported</span>);
 
            <a href="../engine/ErrorPackage.cs.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r69 rd" class="r69 r">errorRecord</span> = <b>new</b> <span class="t">ErrorRecord</span>(
                <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="MshTraceSource.cs.html#4f3f8175dd33a015" class="i method">NewInvalidOperationException</a>(),
                <span class="s">&quot;ReadWriteMultipleFilesNotSupported&quot;</span>,
                <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#846d2b572f2c4820" class="i field">InvalidArgument</a>,
                <b>null</b>);
 
            <span class="r69 r">errorRecord</span>.<a href="../engine/ErrorPackage.cs.html#4e9df045b6372ce0" class="i property">ErrorDetails</a> = <b>new</b> <a href="../engine/ErrorPackage.cs.html#908615d662085fc6" class="t constructor">ErrorDetails</a>(<span class="r68 r">msg</span>);
            <span class="r67 r">cmdlet</span>.<a href="../engine/cmdlet.cs.html#e3346d70990a1763" class="i method">ThrowTerminatingError</a>(<span class="r69 r">errorRecord</span>);
        }
 
        <b>internal static void</b> <a id="5f661d663ee75335" href="../R/5f661d663ee75335.html" target="n" data-glyph="74,1" class="i method">ReportWildcardingFailure</a>(<a href="../engine/cmdlet.cs.html#b0d421ff1d7581f9" class="t t">Cmdlet</a> <span id="r70 rd" class="r70 r">cmdlet</span>, <b>string</b> <span id="r71 rd" class="r71 r">filePath</span>)
        {
            <b>string</b> <span id="r72 rd" class="r72 r">msg</span> = <a href="StringUtil.cs.html#9499fba345e707ac" class="t t">StringUtil</a>.<span class="i">Format</span>(<span class="i">PathUtilsStrings</span>.<span class="i">OutFile_DidNotResolveFile</span>, <span class="r71 r">filePath</span>);
 
            <a href="../engine/ErrorPackage.cs.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r73 rd" class="r73 r">errorRecord</span> = <b>new</b> <span class="t">ErrorRecord</span>(
                <b>new</b> <span class="i">FileNotFoundException</span>(),
                <span class="s">&quot;FileOpenFailure&quot;</span>,
                <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#7650567b7604bddc" class="i field">OpenError</a>,
                <span class="r71 r">filePath</span>);
 
            <span class="r73 r">errorRecord</span>.<a href="../engine/ErrorPackage.cs.html#4e9df045b6372ce0" class="i property">ErrorDetails</a> = <b>new</b> <a href="../engine/ErrorPackage.cs.html#908615d662085fc6" class="t constructor">ErrorDetails</a>(<span class="r72 r">msg</span>);
            <span class="r70 r">cmdlet</span>.<a href="../engine/cmdlet.cs.html#e3346d70990a1763" class="i method">ThrowTerminatingError</a>(<span class="r73 r">errorRecord</span>);
        }
 
        <b>internal static</b> <span class="i">DirectoryInfo</span> <a id="1dcfb27f8e5d6dfb" href="../R/../../0000000000.html" target="n" data-glyph="74,1" class="i method">CreateModuleDirectory</a>(<a href="../P/30543a6971fed1fc.html#30543a6971fed1fc" class="t t">PSCmdlet</a> <span id="r74 rd" class="r74 r">cmdlet</span>, <b>string</b> <span id="r75 rd" class="r75 r">moduleNameOrPath</span>, <b>bool</b> <span id="r76 rd" class="r76 r">force</span>)
        {
            <a href="assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<a href="assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r74 r">cmdlet</span> != <b>null</b>, <span class="s">&quot;Caller should verify cmdlet != null&quot;</span>);
            <a href="assert.cs.html#c04955255430d32f" class="t t">Dbg</a>.<span class="i">Assert</span>(!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r75 r">moduleNameOrPath</span>), <span class="s">&quot;Caller should verify !string.IsNullOrEmpty(moduleNameOrPath)&quot;</span>);
 
            <span class="i">DirectoryInfo</span> <span id="r77 rd" class="r77 r">directoryInfo</span> = <b>null</b>;
            <b>try</b>
            {
                <b>string</b> <span id="r78 rd" class="r78 r">rootedPath</span> = <span class="i n">Microsoft</span>.<span class="i n">PowerShell</span>.<span class="i n">Commands</span>.<a href="../engine/Modules/ModuleCmdletBase.cs.html#0479f5f00c7dafc1" class="t t">ModuleCmdletBase</a>.<a href="../engine/Modules/ModuleCmdletBase.cs.html#9910dbba4c162701" class="i method">ResolveRootedFilePath</a>(<span class="r75 r">moduleNameOrPath</span>, <span class="r74 r">cmdlet</span>.<a href="../engine/CommandBase.cs.html#a41a765d70fc9c9d" class="i property">Context</a>);
                <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r78 r">rootedPath</span>) &amp;&amp; <span class="r75 r">moduleNameOrPath</span>.<span class="i">StartsWith</span>(<span class="s">&#39;.&#39;</span>))
                {
                    <a href="../namespaces/PathInfo.cs.html#9504cfb54420cfd7" class="t t">PathInfo</a> <span id="r79 rd" class="r79 r">currentPath</span> = <span class="r74 r">cmdlet</span>.<a href="../engine/CommandBase.cs.html#401b5824624f5221" class="i method">CurrentProviderLocation</a>(<span class="r74 r">cmdlet</span>.<a href="../engine/CommandBase.cs.html#a41a765d70fc9c9d" class="i property">Context</a>.<a href="../engine/ExecutionContext.cs.html#733af3e5592e5947" class="i property">ProviderNames</a>.<a href="../engine/ProviderNames.cs.html#07509539bc35966f" class="i property">FileSystem</a>);
                    <span class="r78 r">rootedPath</span> = <span class="i">Path</span>.<span class="i">Combine</span>(<span class="r79 r">currentPath</span>.<a href="../namespaces/PathInfo.cs.html#16e3fcd7f95c1bfc" class="i property">ProviderPath</a>, <span class="r75 r">moduleNameOrPath</span>);
                }
 
                <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r78 r">rootedPath</span>))
                {
                    <b>string</b> <span id="r80 rd" class="r80 r">personalModuleRoot</span> = <a href="../engine/Modules/ModuleIntrinsics.cs.html#1693bdfaeab6548d" class="t t">ModuleIntrinsics</a>.<a href="../engine/Modules/ModuleIntrinsics.cs.html#f3c6b789edf3cc5c" class="i method">GetPersonalModulePath</a>();
                    <span class="r78 r">rootedPath</span> = <span class="i">Path</span>.<span class="i">Combine</span>(<span class="r80 r">personalModuleRoot</span>, <span class="r75 r">moduleNameOrPath</span>);
                }
 
                <span class="r77 r">directoryInfo</span> = <b>new</b> <span class="i">DirectoryInfo</span>(<span class="r78 r">rootedPath</span>);
                <b>if</b> (<span class="r77 r">directoryInfo</span>.<span class="i">Exists</span>)
                {
                    <b>if</b> (!<span class="r76 r">force</span>)
                    {
                        <b>string</b> <span id="r81 rd" class="r81 r">errorMessage</span> = <b>string</b>.<span class="i">Format</span>(
                            <span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>, <span class="c">// directory name should be treated as culture-invariant</span>
                            <span class="i">PathUtilsStrings</span>.<span class="i">ExportPSSession_ErrorDirectoryExists</span>,
                            <span class="r77 r">directoryInfo</span>.<span class="i">FullName</span>);
                        <a href="../engine/ErrorPackage.cs.html#d882fa1d2308673f" class="t t">ErrorDetails</a> <span id="r82 rd" class="r82 r">details</span> = <b>new</b> <a href="../engine/ErrorPackage.cs.html#908615d662085fc6" class="t constructor">ErrorDetails</a>(<span class="r81 r">errorMessage</span>);
                        <a href="../engine/ErrorPackage.cs.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r83 rd" class="r83 r">errorRecord</span> = <b>new</b> <span class="t">ErrorRecord</span>(
                            <b>new</b> <span class="i">ArgumentException</span>(<span class="r82 r">details</span>.<a href="../engine/ErrorPackage.cs.html#589bef4648ccf37a" class="i property">Message</a>),
                            <span class="s">&quot;ExportProxyCommand_OutputDirectoryExists&quot;</span>,
                            <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#22cb3b8b80f740be" class="i field">ResourceExists</a>,
                            <span class="r77 r">directoryInfo</span>);
                        <span class="r74 r">cmdlet</span>.<a href="../engine/cmdlet.cs.html#e3346d70990a1763" class="i method">ThrowTerminatingError</a>(<span class="r83 r">errorRecord</span>);
                    }
                }
                <b>else</b>
                {
                    <span class="r77 r">directoryInfo</span>.<span class="i">Create</span>();
                }
            }
            <b>catch</b> (<span class="i">Exception</span> <span id="r84 rd" class="r84 r">e</span>)
            {
                <b>string</b> <span id="r85 rd" class="r85 r">errorMessage</span> = <b>string</b>.<span class="i">Format</span>(
                    <span class="i">CultureInfo</span>.<span class="i">InvariantCulture</span>, <span class="c">// directory name should be treated as culture-invariant</span>
                    <span class="i">PathUtilsStrings</span>.<span class="i">ExportPSSession_CannotCreateOutputDirectory</span>,
                    <span class="r75 r">moduleNameOrPath</span>,
                    <span class="r84 r">e</span>.<span class="i">Message</span>);
                <a href="../engine/ErrorPackage.cs.html#d882fa1d2308673f" class="t t">ErrorDetails</a> <span id="r86 rd" class="r86 r">details</span> = <b>new</b> <a href="../engine/ErrorPackage.cs.html#908615d662085fc6" class="t constructor">ErrorDetails</a>(<span class="r85 r">errorMessage</span>);
                <a href="../engine/ErrorPackage.cs.html#fe2b46733a081db9" class="t t">ErrorRecord</a> <span id="r87 rd" class="r87 r">errorRecord</span> = <b>new</b> <span class="t">ErrorRecord</span>(
                    <b>new</b> <span class="i">ArgumentException</span>(<span class="r86 r">details</span>.<a href="../engine/ErrorPackage.cs.html#589bef4648ccf37a" class="i property">Message</a>, <span class="r84 r">e</span>),
                    <span class="s">&quot;ExportProxyCommand_CannotCreateOutputDirectory&quot;</span>,
                    <a href="../engine/ErrorPackage.cs.html#0e80a9653d75dd2a" class="t t">ErrorCategory</a>.<a href="../engine/ErrorPackage.cs.html#22cb3b8b80f740be" class="i field">ResourceExists</a>,
                    <span class="r75 r">moduleNameOrPath</span>);
                <span class="r74 r">cmdlet</span>.<a href="../engine/cmdlet.cs.html#e3346d70990a1763" class="i method">ThrowTerminatingError</a>(<span class="r87 r">errorRecord</span>);
            }
 
            <b>return</b> <span class="r77 r">directoryInfo</span>;
        }
 
        <b>internal static</b> <span class="i">DirectoryInfo</span> <a id="55363a83e28be2a5" href="../R/../../0000000000.html" target="n" data-glyph="74,1" class="i method">CreateTemporaryDirectory</a>()
        {
            <span class="i">DirectoryInfo</span> <span id="r88 rd" class="r88 r">temporaryDirectory</span> = <b>new</b> <span class="i">DirectoryInfo</span>(<span class="i">Path</span>.<span class="i">GetTempPath</span>());
            <span class="i">DirectoryInfo</span> <span id="r89 rd" class="r89 r">moduleDirectory</span>;
            <b>do</b>
            {
                <span class="r89 r">moduleDirectory</span> = <b>new</b> <span class="i">DirectoryInfo</span>(
                    <span class="i">Path</span>.<span class="i">Combine</span>(
                        <span class="r88 r">temporaryDirectory</span>.<span class="i">FullName</span>,
                        <b>string</b>.<span class="i">Format</span>(
                            <b>null</b>,
                            <span class="s">&quot;tmp_{0}&quot;</span>,
                            <span class="i">Path</span>.<span class="i">GetRandomFileName</span>())));
            } <b>while</b> (<span class="r89 r">moduleDirectory</span>.<span class="i">Exists</span>);
 
            <span class="i">Directory</span>.<span class="i">CreateDirectory</span>(<span class="r89 r">moduleDirectory</span>.<span class="i">FullName</span>);
            <b>return</b> <b>new</b> <span class="i">DirectoryInfo</span>(<span class="r89 r">moduleDirectory</span>.<span class="i">FullName</span>);
        }
 
        <b>internal static bool</b> <a id="559090b4830d20e9" href="../R/559090b4830d20e9.html" target="n" data-glyph="74,1" class="i method">TryDeleteFile</a>(<b>string</b> <span id="r90 rd" class="r90 r">filepath</span>)
        {
            <b>if</b> (<span class="i">IO</span>.<span class="i">File</span>.<span class="i">Exists</span>(<span class="r90 r">filepath</span>))
            {
                <b>try</b>
                {
                    <span class="i">IO</span>.<span class="i">File</span>.<span class="i">Delete</span>(<span class="r90 r">filepath</span>);
                    <b>return</b> <b>true</b>;
                }
                <b>catch</b> (<span class="i">IOException</span>)
                {
                    <span class="c">// file is in use on Windows</span>
                }
                <b>catch</b> (<span class="i">UnauthorizedAccessException</span>)
                {
                    <span class="c">// user does not have permissions</span>
                }
            }
 
            <b>return</b> <b>false</b>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> Helpers for long paths from .Net Runtime
        
        <span class="c">// Code here is copied from .NET&#39;s internal path helper implementation:</span>
        <span class="c">// https://github.com/dotnet/runtime/blob/dcce0f56e10f5ac9539354b049341a2d7c0cdebf/src/libraries/System.Private.CoreLib/src/System/IO/PathInternal.Windows.cs</span>
        <span class="c">// It has been left as a verbatim copy.</span>
 
        <b>internal static string</b> <a id="caa7014d709999ce" href="../R/caa7014d709999ce.html" target="n" data-glyph="74,1" class="i method">EnsureExtendedPrefix</a>(<b>string</b> <span id="r91 rd" class="r91 r">path</span>)
        {
            <b>if</b> (<a href="#c509005a3efda909" class="i method">IsPartiallyQualified</a>(<span class="r91 r">path</span>) || <a href="#40a6efd390235363" class="i method">IsDevice</a>(<span class="r91 r">path</span>))
                <b>return</b> <span class="r91 r">path</span>;
 
            <span class="c">// Given \\server\share in longpath becomes \\?\UNC\server\share</span>
            <b>if</b> (<span class="r91 r">path</span>.<span class="i">StartsWith</span>(<a href="#9155019cb323ad4a" class="i field">UncPathPrefix</a>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
                <b>return</b> <span class="r91 r">path</span>.<span class="i">Insert</span>(2, <a href="#a732b17b3a9c31fb" class="i field">UncDevicePrefixToInsert</a>);
 
            <b>return</b> <a href="#5bfecea0bb5f177e" class="i field">ExtendedDevicePathPrefix</a> + <span class="r91 r">path</span>;
        }
 
        <b>private const string</b> <a id="5bfecea0bb5f177e" href="../R/5bfecea0bb5f177e.html" target="n" data-glyph="10,1" class="i field">ExtendedDevicePathPrefix</a> = <span class="s">@&quot;\\?\&quot;</span>;
        <b>private const string</b> <a id="9155019cb323ad4a" href="../R/9155019cb323ad4a.html" target="n" data-glyph="10,1" class="i field">UncPathPrefix</a> = <span class="s">@&quot;\\&quot;</span>;
        <b>private const string</b> <a id="a732b17b3a9c31fb" href="../R/a732b17b3a9c31fb.html" target="n" data-glyph="10,1" class="i field">UncDevicePrefixToInsert</a> = <span class="s">@&quot;?\UNC\&quot;</span>;
        <b>private const string</b> <a id="c46e1eb6cb0f6ac0" href="../R/../../0000000000.html" target="n" data-glyph="10,1" class="i field">UncExtendedPathPrefix</a> = <span class="s">@&quot;\\?\UNC\&quot;</span>;
        <b>private const string</b> <a id="6952934b1973bc85" href="../R/../../0000000000.html" target="n" data-glyph="10,1" class="i field">DevicePathPrefix</a> = <span class="s">@&quot;\\.\&quot;</span>;
 
        <span class="c">// \\?\, \\.\, \??\</span>
        <b>private const int</b> <a id="19110f011db2bd37" href="../R/19110f011db2bd37.html" target="n" data-glyph="10,1" class="i field">DevicePrefixLength</a> = 4;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Returns true if the given character is a valid drive letter</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>private static bool</b> <a id="25c21e1f61163ac9" href="../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">IsValidDriveChar</a>(<b>char</b> <span id="r92 rd" class="r92 r">value</span>)
        {
            <b>return</b> ((<span class="r92 r">value</span> &gt;= <span class="s">&#39;A&#39;</span> &amp;&amp; <span class="r92 r">value</span> &lt;= <span class="s">&#39;Z&#39;</span>) || (<span class="r92 r">value</span> &gt;= <span class="s">&#39;a&#39;</span> &amp;&amp; <span class="r92 r">value</span> &lt;= <span class="s">&#39;z&#39;</span>));
        }
 
        <b>private static bool</b> <a id="40a6efd390235363" href="../R/40a6efd390235363.html" target="n" data-glyph="76,1" class="i method">IsDevice</a>(<b>string</b> <span id="r93 rd" class="r93 r">path</span>)
        {
            <b>return</b> <a href="#7556e367b44f5a64" class="i method">IsExtended</a>(<span class="r93 r">path</span>)
                ||
                (
                    <span class="r93 r">path</span>.<span class="i">Length</span> &gt;= <a href="#19110f011db2bd37" class="i field">DevicePrefixLength</a>
                    &amp;&amp; <span class="i">IsDirectorySeparator</span>(<span class="r93 r">path</span>[0])
                    &amp;&amp; <span class="i">IsDirectorySeparator</span>(<span class="r93 r">path</span>[1])
                    &amp;&amp; (<span class="r93 r">path</span>[2] == <span class="s">&#39;.&#39;</span> || <span class="r93 r">path</span>[2] == <span class="s">&#39;?&#39;</span>)
                    &amp;&amp; <span class="i">IsDirectorySeparator</span>(<span class="r93 r">path</span>[3])
                );
        }
 
        <b>private static bool</b> <a id="7556e367b44f5a64" href="../R/7556e367b44f5a64.html" target="n" data-glyph="76,1" class="i method">IsExtended</a>(<b>string</b> <span id="r94 rd" class="r94 r">path</span>)
        {
            <b>return</b> <span class="r94 r">path</span>.<span class="i">Length</span> &gt;= <a href="#19110f011db2bd37" class="i field">DevicePrefixLength</a>
                &amp;&amp; <span class="r94 r">path</span>[0] == <span class="s">&#39;\\&#39;</span>
                &amp;&amp; (<span class="r94 r">path</span>[1] == <span class="s">&#39;\\&#39;</span> || <span class="r94 r">path</span>[1] == <span class="s">&#39;?&#39;</span>)
                &amp;&amp; <span class="r94 r">path</span>[2] == <span class="s">&#39;?&#39;</span>
                &amp;&amp; <span class="r94 r">path</span>[3] == <span class="s">&#39;\\&#39;</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Returns true if the path specified is relative to the current drive or working directory.</span>
        <span class="c">///</span><span class="c"> Returns false if the path is fixed to a specific drive or UNC path.  This method does no</span>
        <span class="c">///</span><span class="c"> validation of the path (URIs will be returned as relative as a result).</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">remarks</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Handles paths that use the alternate directory separator.  It is a frequent mistake to</span>
        <span class="c">///</span><span class="c"> assume that rooted paths (Path.IsPathRooted) are not relative.  This isn&#39;t the case.</span>
        <span class="c">///</span><span class="c"> &quot;C:a&quot; is drive relative- meaning that it will be resolved against the current directory</span>
        <span class="c">///</span><span class="c"> for C: (rooted, but relative). &quot;C:\a&quot; is rooted and not relative (the current directory</span>
        <span class="c">///</span><span class="c"> will not be used to modify the path).</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">remarks</span><span class="c">&gt;</span>
        <b>private static bool</b> <a id="c509005a3efda909" href="../R/c509005a3efda909.html" target="n" data-glyph="76,1" class="i method">IsPartiallyQualified</a>(<b>string</b> <span id="r95 rd" class="r95 r">path</span>)
        {
            <b>if</b> (<span class="r95 r">path</span>.<span class="i">Length</span> &lt; 2)
            {
                <span class="c">// It isn&#39;t fixed, it must be relative.  There is no way to specify a fixed</span>
                <span class="c">// path with one character (or less).</span>
                <b>return</b> <b>true</b>;
            }
 
            <b>if</b> (<span class="i">IsDirectorySeparator</span>(<span class="r95 r">path</span>[0]))
            {
                <span class="c">// There is no valid way to specify a relative path with two initial slashes or</span>
                <span class="c">// \? as ? isn&#39;t valid for drive relative paths and \??\ is equivalent to \\?\</span>
                <b>return</b> !(<span class="r95 r">path</span>[1] == <span class="s">&#39;?&#39;</span> || <span class="i">IsDirectorySeparator</span>(<span class="r95 r">path</span>[1]));
            }
 
            <span class="c">// The only way to specify a fixed path that doesn&#39;t begin with two slashes</span>
            <span class="c">// is the drive, colon, slash format- i.e. C:\</span>
            <b>return</b> !((<span class="r95 r">path</span>.<span class="i">Length</span> &gt;= 3)
                &amp;&amp; (<span class="r95 r">path</span>[1] == <span class="i">Path</span>.<span class="i">VolumeSeparatorChar</span>)
                &amp;&amp; <span class="i">IsDirectorySeparator</span>(<span class="r95 r">path</span>[2])
                <span class="c">// To match old behavior we&#39;ll check the drive character for validity as the path is technically</span>
                <span class="c">// not qualified if you don&#39;t have a valid drive. &quot;=:\&quot; is the &quot;=&quot; file&#39;s default data stream.</span>
                &amp;&amp; <span class="i">IsValidDriveChar</span>(<span class="r95 r">path</span>[0]));
        }
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> True if the given character is a directory separator.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        [<span class="i">MethodImpl</span>(<span class="i">MethodImplOptions</span>.<span class="i">AggressiveInlining</span>)]
        <b>private static bool</b> <a id="7cd540c00f1b708b" href="../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">IsDirectorySeparator</a>(<b>char</b> <span id="r96 rd" class="r96 r">c</span>)
        {
            <b>return</b> <span class="r96 r">c</span> == <span class="i">Path</span>.<span class="i">DirectorySeparatorChar</span> || <span class="r96 r">c</span> == <span class="i">Path</span>.<span class="i">AltDirectorySeparatorChar</span>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
    }
}
</pre></td></tr></table></div></body></html>
