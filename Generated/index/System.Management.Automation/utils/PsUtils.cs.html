<!DOCTYPE html>
<html><head><title>PsUtils.cs</title><link rel="stylesheet" href="../../styles.css"><script src="../../scripts.js"></script></head>
<body class="cB" onload="i(592);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#System.Management.Automation/utils/PsUtils.cs" target="_top">utils\PsUtils.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#System.Management.Automation" target="_top">src\System.Management.Automation\System.Management.Automation.csproj</a> (System.Management.Automation)</td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">// Copyright (c) Microsoft Corporation.</span>
<span class="c">// Licensed under the MIT License.</span>
 
<b>using</b> <span class="i n">System</span>.<span class="i">Collections</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Collections</span>.<span class="i">Generic</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Diagnostics</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">IO</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Linq</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>.<span class="i n">Language</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Net</span>.<span class="i">NetworkInformation</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Runtime</span>.<span class="i">CompilerServices</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Runtime</span>.<span class="i">InteropServices</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Text</span>;
<b>using</b> <span class="i n">System</span>.<span class="i">Xml</span>;
 
<b>namespace</b> <span class="i n">System</span>.<span class="i n">Management</span>.<span class="i n">Automation</span>
{
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Defines generic utilities and helper methods for PowerShell.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>internal static class</b> <a id="2010e19f156f8c91" href="../R/2010e19f156f8c91.html" target="n" data-glyph="2,0" class="t t">PsUtils</a>
    {
        <span class="c">// Cache of the current process&#39; parentId</span>
        <b>private static int</b>? <a id="c5dde5b8f3141314" href="../R/c5dde5b8f3141314.html" target="n" data-glyph="46,1" class="i field">s_currentParentProcessId</a>;
        <b>private static readonly int</b> <a id="f9cdbd62e6a67978" href="../R/f9cdbd62e6a67978.html" target="n" data-glyph="46,1" class="i field">s_currentProcessId</a> = <span class="i">Environment</span>.<span class="i">ProcessId</span>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Retrieve the parent process of a process.</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> Previously this code used WMI, but WMI is causing a CPU spike whenever the query gets called as it results in</span>
        <span class="c">///</span><span class="c"> tzres.dll and tzres.mui.dll being loaded into every process to convert the time information to local format.</span>
        <span class="c">///</span><span class="c"> For perf reasons, we resort to P/Invoke.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r0 r">current</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The process we want to find the</span>
        <span class="c">///</span><span class="c"> parent of</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>internal static</b> <span class="i">Process</span> <a id="052a0531c6c08051" href="../R/052a0531c6c08051.html" target="n" data-glyph="74,1" class="i method">GetParentProcess</a>(<span class="i">Process</span> <span id="r0 rd" class="r0 r">current</span>)
        {
            <b>var</b> <span id="r1 rd" class="r1 r">processId</span> = <span class="r0 r">current</span>.<span class="i">Id</span>;
 
            <span class="c">// This is a common query (parent id for the current process)</span>
            <span class="c">// Use cached value if available</span>
            <b>var</b> <span id="r2 rd" class="r2 r">parentProcessId</span> = <span class="r1 r">processId</span> == <a href="#f9cdbd62e6a67978" class="i field">s_currentProcessId</a> &amp;&amp; <a href="#c5dde5b8f3141314" class="i field">s_currentParentProcessId</a>.<span class="i">HasValue</span> ?
                 <a href="#c5dde5b8f3141314" class="i field">s_currentParentProcessId</a>.<span class="i">Value</span> :
                 <span class="i n">Microsoft</span>.<span class="i n">PowerShell</span>.<a href="../engine/ProcessCodeMethods.cs.html#62d5a91e581f3720" class="t t">ProcessCodeMethods</a>.<a href="../engine/ProcessCodeMethods.cs.html#b8b9642fc1255bdb" class="i method">GetParentPid</a>(<span class="r0 r">current</span>);
 
            <span class="c">// cache the current process parent pid if it hasn&#39;t been done yet</span>
            <b>if</b> (<span class="r1 r">processId</span> == <a href="#f9cdbd62e6a67978" class="i field">s_currentProcessId</a> &amp;&amp; !<a href="#c5dde5b8f3141314" class="i field">s_currentParentProcessId</a>.<span class="i">HasValue</span>)
            {
                <a href="#c5dde5b8f3141314" class="i field">s_currentParentProcessId</a> = <span class="r2 r">parentProcessId</span>;
            }
 
            <b>if</b> (<span class="r2 r">parentProcessId</span> == 0)
                <b>return</b> <b>null</b>;
 
            <b>try</b>
            {
                <span class="i">Process</span> <span id="r3 rd" class="r3 r">returnProcess</span> = <span class="i">Process</span>.<span class="i">GetProcessById</span>(<span class="r2 r">parentProcessId</span>);
 
                <span class="c">// Ensure the process started before the current</span>
                <span class="c">// process, as it could have gone away and had the</span>
                <span class="c">// PID recycled.</span>
                <b>if</b> (<span class="r3 r">returnProcess</span>.<span class="i">StartTime</span> &lt;= <span class="r0 r">current</span>.<span class="i">StartTime</span>)
                    <b>return</b> <span class="r3 r">returnProcess</span>;
                <b>else</b>
                    <b>return</b> <b>null</b>;
            }
            <b>catch</b> (<span class="i">ArgumentException</span>)
            {
                <span class="c">// GetProcessById throws an ArgumentException when</span>
                <span class="c">// you reach the top of the chain -- Explorer.exe</span>
                <span class="c">// has a parent process, but you cannot retrieve it.</span>
                <b>return</b> <b>null</b>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Return true/false to indicate whether the processor architecture is ARM.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal static bool</b> <a id="45dd30da86ec04e7" href="../R/45dd30da86ec04e7.html" target="n" data-glyph="74,1" class="i method">IsRunningOnProcessorArchitectureARM</a>()
        {
            <span class="i">Architecture</span> <span id="r4 rd" class="r4 r">arch</span> = <span class="i">RuntimeInformation</span>.<span class="i">OSArchitecture</span>;
            <b>return</b> <span class="r4 r">arch</span> == <span class="i">Architecture</span>.<span class="i">Arm</span> || <span class="r4 r">arch</span> == <span class="i">Architecture</span>.<span class="i">Arm64</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Get a temporary directory to use, needs to be unique to avoid collision.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal static string</b> <a id="2814b0910ff078f8" href="../R/2814b0910ff078f8.html" target="n" data-glyph="74,1" class="i method">GetTemporaryDirectory</a>()
        {
            <b>string</b> <span id="r5 rd" class="r5 r">tempDir</span> = <b>string</b>.<span class="i">Empty</span>;
            <b>string</b> <span id="r6 rd" class="r6 r">tempPath</span> = <span class="i">Path</span>.<span class="i">GetTempPath</span>();
            <b>do</b>
            {
                <span class="r5 r">tempDir</span> = <span class="i">Path</span>.<span class="i">Combine</span>(<span class="r6 r">tempPath</span>, <span class="i n">System</span>.<span class="i">Guid</span>.<span class="i">NewGuid</span>().<span class="i">ToString</span>());
            }
            <b>while</b> (<span class="i">Directory</span>.<span class="i">Exists</span>(<span class="r5 r">tempDir</span>));
 
            <b>try</b>
            {
                <span class="i">Directory</span>.<span class="i">CreateDirectory</span>(<span class="r5 r">tempDir</span>);
            }
            <b>catch</b> (<span class="i">UnauthorizedAccessException</span>)
            {
                <span class="r5 r">tempDir</span> = <b>string</b>.<span class="i">Empty</span>; <span class="c">// will become current working directory</span>
            }
 
            <b>return</b> <span class="r5 r">tempDir</span>;
        }
 
        <b>internal static string</b> <a id="98721e9044ad047d" href="../R/98721e9044ad047d.html" target="n" data-glyph="74,1" class="i method">GetHostName</a>()
        {
            <span class="i">IPGlobalProperties</span> <span id="r7 rd" class="r7 r">ipProperties</span> = <span class="i">IPGlobalProperties</span>.<span class="i">GetIPGlobalProperties</span>();
 
            <b>string</b> <span id="r8 rd" class="r8 r">hostname</span> = <span class="r7 r">ipProperties</span>.<span class="i">HostName</span>;
            <b>string</b> <span id="r9 rd" class="r9 r">domainName</span> = <span class="r7 r">ipProperties</span>.<span class="i">DomainName</span>;
 
            <span class="c">// CoreFX on Unix calls GLibc getdomainname()</span>
            <span class="c">// which returns &quot;(none)&quot; if a domain name is not set by setdomainname()</span>
            <b>if</b> (!<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r9 r">domainName</span>) &amp;&amp; !<span class="r9 r">domainName</span>.<span class="i">Equals</span>(<span class="s">&quot;(none)&quot;</span>, <span class="i">StringComparison</span>.<span class="i">Ordinal</span>))
            {
                <span class="r8 r">hostname</span> = <span class="r8 r">hostname</span> + <span class="s">&quot;.&quot;</span> + <span class="r9 r">domainName</span>;
            }
 
            <b>return</b> <span class="r8 r">hostname</span>;
        }
 
        <b>internal static uint</b> <a id="50d22f282e13e0d5" href="../R/50d22f282e13e0d5.html" target="n" data-glyph="74,1" class="i method">GetNativeThreadId</a>()
        {
<span class="k preprocess">#</span><span class="k preprocess">if</span> <span class="i">UNIX</span>
<span class="e">            return Platform.NonWindowsGetThreadId();
</span><span class="k preprocess">#</span><span class="k preprocess">else</span>
            <b>return</b> <a href="#b2a54d28ee476b31" class="t t">NativeMethods</a>.<a href="#fc81d342df361f27" class="i method">GetCurrentThreadId</a>();
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
        }
 
        <b>private static class</b> <a id="b2a54d28ee476b31" href="../R/b2a54d28ee476b31.html" target="n" data-glyph="4,1" class="t t">NativeMethods</a>
        {
            [<span class="i">DllImport</span>(<a href="PInvokeDllNames.cs.html#6c73838805dd2f2a" class="t t">PinvokeDllNames</a>.<a href="PInvokeDllNames.cs.html#d35757043b802fd7" class="i field">GetCurrentThreadIdDllName</a>)]
            <b>internal static extern uint</b> <a id="fc81d342df361f27" href="../R/fc81d342df361f27.html" target="n" data-glyph="74,2" class="i method">GetCurrentThreadId</a>();
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> ASTUtils
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> This method is to get the unique key for a UsingExpressionAst. The key is a base64</span>
        <span class="c">///</span><span class="c"> encoded string based on the text of the UsingExpressionAst.</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> This method is used when handling a script block that contains $using for Invoke-Command.</span>
        <span class="c">///</span>
        <span class="c">///</span><span class="c"> When run Invoke-Command targeting a machine that runs PSv3 or above, we pass a dictionary</span>
        <span class="c">///</span><span class="c"> to the remote end that contains the key of each UsingExpressionAst and its value. This method</span>
        <span class="c">///</span><span class="c"> is used to generate the key.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r10 r">usingAst</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">A using expression.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">Base64 encoded string as the key of the UsingExpressionAst.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal static string</b> <a id="924437b3f1b094ad" href="../R/924437b3f1b094ad.html" target="n" data-glyph="74,1" class="i method">GetUsingExpressionKey</a>(<span class="i n">Language</span>.<a href="../engine/parser/ast.cs.html#42d36b88817a807f" class="t t">UsingExpressionAst</a> <span id="r10 rd" class="r10 r">usingAst</span>)
        {
            <a href="assert.cs.html#c04955255430d32f" class="t t">Diagnostics</a>.<a href="assert.cs.html#703dade50a6809cd" class="i method">Assert</a>(<span class="r10 r">usingAst</span> != <b>null</b>, <span class="s">&quot;Caller makes sure the parameter is not null&quot;</span>);
 
            <span class="c">// We cannot call ToLowerInvariant unconditionally, because usingAst might</span>
            <span class="c">// contain IndexExpressionAst in its SubExpression, such as</span>
            <span class="c">//   $using:bar[&quot;AAAA&quot;]</span>
            <span class="c">// and the index &quot;AAAA&quot; might not get us the same value as &quot;aaaa&quot;.</span>
            <span class="c">//</span>
            <span class="c">// But we do want a unique key to represent the same UsingExpressionAst&#39;s as much</span>
            <span class="c">// as possible, so as to avoid sending redundant key-value&#39;s to remote machine.</span>
            <span class="c">// As a workaround, we call ToLowerInvariant when the SubExpression of usingAst</span>
            <span class="c">// is a VariableExpressionAst, because:</span>
            <span class="c">//   (1) Variable name is case insensitive;</span>
            <span class="c">//   (2) People use $using to refer to a variable most of the time.</span>
            <b>string</b> <span id="r11 rd" class="r11 r">usingAstText</span> = <span class="r10 r">usingAst</span>.<a href="../engine/parser/ast.cs.html#e8e96a43a76cce85" class="i method">ToString</a>();
            <b>if</b> (<span class="r10 r">usingAst</span>.<a href="../engine/parser/ast.cs.html#eb8bbf44ea3ab101" class="i property">SubExpression</a> <b>is</b> <span class="i n">Language</span>.<a href="../engine/parser/ast.cs.html#248562b22b336dec" class="t t">VariableExpressionAst</a>)
            {
                <span class="r11 r">usingAstText</span> = <span class="r11 r">usingAstText</span>.<span class="i">ToLowerInvariant</span>();
            }
 
            <b>return</b> <a href="#9fc24c28ab053072" class="t t">StringToBase64Converter</a>.<a href="#62ba06ad26fa41b5" class="i method">StringToBase64String</a>(<span class="r11 r">usingAstText</span>);
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> ASTUtils
 
        <span class="k preprocess">#</span><span class="k preprocess">region</span> EvaluatePowerShellDataFile
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Evaluate a powershell data file as if it&#39;s a module manifest.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r12 r">parameterName</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r13 r">psDataFilePath</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r14 r">context</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r15 r">skipPathValidation</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal static</b> <span class="i">Hashtable</span> <a id="565d9c5a2abda2dc" href="../R/565d9c5a2abda2dc.html" target="n" data-glyph="74,1" class="i method">EvaluatePowerShellDataFileAsModuleManifest</a>(
                                     <b>string</b> <span id="r12 rd" class="r12 r">parameterName</span>,
                                     <b>string</b> <span id="r13 rd" class="r13 r">psDataFilePath</span>,
                                     <a href="../engine/ExecutionContext.cs.html#130bda5418e8559c" class="t t">ExecutionContext</a> <span id="r14 rd" class="r14 r">context</span>,
                                     <b>bool</b> <span id="r15 rd" class="r15 r">skipPathValidation</span>)
        {
            <span class="c">// Use the same capabilities as the module manifest</span>
            <span class="c">// e.g. allow &#39;PSScriptRoot&#39; variable</span>
            <b>return</b> <span class="i">EvaluatePowerShellDataFile</span>(
                      <span class="r12 r">parameterName</span>,
                      <span class="r13 r">psDataFilePath</span>,
                      <span class="r14 r">context</span>,
                      <span class="i n">Microsoft</span>.<span class="i n">PowerShell</span>.<span class="i n">Commands</span>.<a href="../engine/Modules/ModuleCmdletBase.cs.html#0479f5f00c7dafc1" class="t t">ModuleCmdletBase</a>.<a href="../engine/Modules/ModuleCmdletBase.cs.html#57d6a39be76f7205" class="i field">PermittedCmdlets</a>,
                      <b>new</b>[] { <span class="s">&quot;PSScriptRoot&quot;</span> },
                      <span class="i">allowEnvironmentVariables</span>: <b>true</b>,
                      <span class="i">skipPathValidation</span>: <span class="r15 r">skipPathValidation</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Get a Hashtable object out of a PowerShell data file (.psd1)</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r16 r">parameterName</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Name of the parameter that takes the specified .psd1 file as a value</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r17 r">psDataFilePath</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Path to the powershell data file</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r18 r">context</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> ExecutionContext to use</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r19 r">allowedCommands</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Set of command names that are allowed to use in the .psd1 file</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r20 r">allowedVariables</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Set of variable names that are allowed to use in the .psd1 file</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r21 r">allowEnvironmentVariables</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If true, allow to use environment variables in the .psd1 file</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r22 r">skipPathValidation</span><span class="c">&quot;</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> If true, caller guarantees the path is valid</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal static</b> <span class="i">Hashtable</span> <a id="04ffd8dcb689c17a" href="../R/../../0000000000.html" target="n" data-glyph="74,1" class="i method">EvaluatePowerShellDataFile</a>(
                                     <b>string</b> <span id="r16 rd" class="r16 r">parameterName</span>,
                                     <b>string</b> <span id="r17 rd" class="r17 r">psDataFilePath</span>,
                                     <a href="../engine/ExecutionContext.cs.html#130bda5418e8559c" class="t t">ExecutionContext</a> <span id="r18 rd" class="r18 r">context</span>,
                                     <span class="i">IEnumerable</span>&lt;<b>string</b>&gt; <span id="r19 rd" class="r19 r">allowedCommands</span>,
                                     <span class="i">IEnumerable</span>&lt;<b>string</b>&gt; <span id="r20 rd" class="r20 r">allowedVariables</span>,
                                     <b>bool</b> <span id="r21 rd" class="r21 r">allowEnvironmentVariables</span>,
                                     <b>bool</b> <span id="r22 rd" class="r22 r">skipPathValidation</span>)
        {
            <b>if</b> (!<span class="r22 r">skipPathValidation</span> &amp;&amp; <b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r16 r">parameterName</span>)) { <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="MshTraceSource.cs.html#fbe67220ad7522a0" class="i method">NewArgumentNullException</a>(<b>nameof</b>(<span class="r16 r">parameterName</span>)); }
 
            <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r17 r">psDataFilePath</span>)) { <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="MshTraceSource.cs.html#fbe67220ad7522a0" class="i method">NewArgumentNullException</a>(<b>nameof</b>(<span class="r17 r">psDataFilePath</span>)); }
 
            <b>if</b> (<span class="r18 r">context</span> == <b>null</b>) { <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="MshTraceSource.cs.html#fbe67220ad7522a0" class="i method">NewArgumentNullException</a>(<b>nameof</b>(<span class="r18 r">context</span>)); }
 
            <b>string</b> <span id="r23 rd" class="r23 r">resolvedPath</span>;
            <b>if</b> (<span class="r22 r">skipPathValidation</span>)
            {
                <span class="r23 r">resolvedPath</span> = <span class="r17 r">psDataFilePath</span>;
            }
            <b>else</b>
            {
                <span class="k preprocess">#</span><span class="k preprocess">region</span> &quot;ValidatePowerShellDataFilePath&quot;
 
                <b>bool</b> <span id="r24 rd" class="r24 r">isPathValid</span> = <b>true</b>;
 
                <span class="c">// File extension needs to be .psd1</span>
                <b>string</b> <span id="r25 rd" class="r25 r">pathExt</span> = <span class="i">Path</span>.<span class="i">GetExtension</span>(<span class="r17 r">psDataFilePath</span>);
                <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r25 r">pathExt</span>) ||
                    !<a href="../engine/SessionStateStrings.cs.html#55ee11e42c7cf459" class="t t">StringLiterals</a>.<a href="../engine/SessionStateStrings.cs.html#35afed2e7cb8ba9d" class="i field">PowerShellDataFileExtension</a>.<span class="i">Equals</span>(<span class="r25 r">pathExt</span>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
                {
                    <span class="r24 r">isPathValid</span> = <b>false</b>;
                }
 
                <a href="../engine/DataStoreAdapterProvider.cs.html#dd4e1f2f8e73a1dd" class="t t">ProviderInfo</a> <span id="r26 rd" class="r26 r">provider</span>;
                <b>var</b> <span id="r27 rd" class="r27 r">resolvedPaths</span> = <span class="r18 r">context</span>.<a href="../engine/ExecutionContext.cs.html#4502619a6e4808ee" class="i property">SessionState</a>.<a href="../engine/SessionStatePublic.cs.html#3390cfbbdcffb036" class="i property">Path</a>.<a href="../engine/PathInterfaces.cs.html#4931b2e78f6aaef1" class="i method">GetResolvedProviderPathFromPSPath</a>(<span class="r17 r">psDataFilePath</span>, <b>out</b> <span class="r26 r">provider</span>);
 
                <span class="c">// ConfigPath should be resolved as FileSystem provider</span>
                <b>if</b> (<span class="r26 r">provider</span> == <b>null</b> || !<span class="i n">Microsoft</span>.<span class="i n">PowerShell</span>.<span class="i n">Commands</span>.<a href="../P/64a92af39f1cd630.html#64a92af39f1cd630" class="t t">FileSystemProvider</a>.<a href="../namespaces/FileSystemProvider.cs.html#10b665caf52d3382" class="i field">ProviderName</a>.<span class="i">Equals</span>(<span class="r26 r">provider</span>.<a href="../engine/DataStoreAdapterProvider.cs.html#2837d805ea30ef5c" class="i property">Name</a>, <span class="i">StringComparison</span>.<span class="i">OrdinalIgnoreCase</span>))
                {
                    <span class="r24 r">isPathValid</span> = <b>false</b>;
                }
 
                <span class="c">// ConfigPath should be resolved to a single path</span>
                <b>if</b> (<span class="r27 r">resolvedPaths</span>.<span class="i">Count</span> != 1)
                {
                    <span class="r24 r">isPathValid</span> = <b>false</b>;
                }
 
                <b>if</b> (!<span class="r24 r">isPathValid</span>)
                {
                    <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<span class="i">NewArgumentException</span>(
                             <span class="r16 r">parameterName</span>,
                             <span class="i">ParserStrings</span>.<span class="i">CannotResolvePowerShellDataFilePath</span>,
                             <span class="r17 r">psDataFilePath</span>);
                }
 
                <span class="r23 r">resolvedPath</span> = <span class="r27 r">resolvedPaths</span>[0];
 
                <span class="k preprocess">#</span><span class="k preprocess">endregion</span> &quot;ValidatePowerShellDataFilePath&quot;
            }
 
            <span class="k preprocess">#</span><span class="k preprocess">region</span> &quot;LoadAndEvaluatePowerShellDataFile&quot;
 
            <b>object</b> <span id="r28 rd" class="r28 r">evaluationResult</span>;
            <b>try</b>
            {
                <span class="c">// Create the scriptInfo for the .psd1 file</span>
                <b>string</b> <span id="r29 rd" class="r29 r">dataFileName</span> = <span class="i">Path</span>.<span class="i">GetFileName</span>(<span class="r23 r">resolvedPath</span>);
                <a href="../engine/ExternalScriptInfo.cs.html#7806ac40f903221c" class="k">var</a> <span id="r30 rd" class="r30 r">dataFileScriptInfo</span> = <b>new</b> <a href="../engine/ExternalScriptInfo.cs.html#0769c91ec3133070" class="t constructor">ExternalScriptInfo</a>(<span class="r29 r">dataFileName</span>, <span class="r23 r">resolvedPath</span>, <span class="r18 r">context</span>);
                <a href="../P/eea83b421baeaca4.html#eea83b421baeaca4" class="t t">ScriptBlock</a> <span id="r31 rd" class="r31 r">scriptBlock</span> = <span class="r30 r">dataFileScriptInfo</span>.<a href="../engine/ExternalScriptInfo.cs.html#7795a39b7e78fc61" class="i property">ScriptBlock</a>;
 
                <span class="c">// Validate the scriptblock</span>
                <span class="r31 r">scriptBlock</span>.<a href="../engine/runtime/CompiledScriptBlock.cs.html#ebeb50ec60013521" class="i method">CheckRestrictedLanguage</a>(<span class="r19 r">allowedCommands</span>, <span class="r20 r">allowedVariables</span>, <span class="r21 r">allowEnvironmentVariables</span>);
 
                <span class="c">// Evaluate the scriptblock</span>
                <b>object</b> <span id="r32 rd" class="r32 r">oldPsScriptRoot</span> = <span class="r18 r">context</span>.<a href="../engine/ExecutionContext.cs.html#3a6f9a48ec862dfb" class="i method">GetVariableValue</a>(<a href="../engine/SpecialVariables.cs.html#07948374b47849e8" class="t t">SpecialVariables</a>.<a href="../engine/SpecialVariables.cs.html#a8821ffec06dcc10" class="i field">PSScriptRootVarPath</a>);
                <b>try</b>
                {
                    <span class="c">// Set the $PSScriptRoot before the evaluation</span>
                    <span class="r18 r">context</span>.<span class="i">SetVariable</span>(<a href="../engine/SpecialVariables.cs.html#07948374b47849e8" class="t t">SpecialVariables</a>.<a href="../engine/SpecialVariables.cs.html#a8821ffec06dcc10" class="i field">PSScriptRootVarPath</a>, <span class="i">Path</span>.<span class="i">GetDirectoryName</span>(<span class="r23 r">resolvedPath</span>));
                    <span class="r28 r">evaluationResult</span> = <a href="../engine/MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a>.<a href="../engine/MshObject.cs.html#8ae71f08053e5ae1" class="i method">Base</a>(<span class="r31 r">scriptBlock</span>.<a href="../engine/lang/scriptblock.cs.html#1a7b06a284505bc5" class="i method">InvokeReturnAsIs</a>());
                }
                <b>finally</b>
                {
                    <span class="r18 r">context</span>.<a href="../engine/ExecutionContext.cs.html#fa7f7322f772be22" class="i method">SetVariable</a>(<a href="../engine/SpecialVariables.cs.html#07948374b47849e8" class="t t">SpecialVariables</a>.<a href="../engine/SpecialVariables.cs.html#a8821ffec06dcc10" class="i field">PSScriptRootVarPath</a>, <span class="r32 r">oldPsScriptRoot</span>);
                }
            }
            <b>catch</b> (<a href="RuntimeException.cs.html#bd88f263eb295545" class="t t">RuntimeException</a> <span id="r33 rd" class="r33 r">ex</span>)
            {
                <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<span class="i">NewInvalidOperationException</span>(
                         <span class="r33 r">ex</span>,
                         <span class="i">ParserStrings</span>.<span class="i">CannotLoadPowerShellDataFile</span>,
                         <span class="r17 r">psDataFilePath</span>,
                         <span class="r33 r">ex</span>.<span class="i">Message</span>);
            }
 
            <b>if</b> (!(<span class="r28 r">evaluationResult</span> <b>is</b> <span class="i">Hashtable</span> <span id="r34 rd" class="r34 r">retResult</span>))
            {
                <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<span class="i">NewInvalidOperationException</span>(
                         <span class="i">ParserStrings</span>.<span class="i">InvalidPowerShellDataFile</span>,
                         <span class="r17 r">psDataFilePath</span>);
            }
 
            <span class="k preprocess">#</span><span class="k preprocess">endregion</span> &quot;LoadAndEvaluatePowerShellDataFile&quot;
 
            <b>return</b> <span class="r34 r">retResult</span>;
        }
 
        <span class="k preprocess">#</span><span class="k preprocess">endregion</span> EvaluatePowerShellDataFile
 
        <b>internal static readonly string</b>[] <a id="6d92135ec8cdd0a6" href="../R/6d92135ec8cdd0a6.html" target="n" data-glyph="44,1" class="i field">ManifestModuleVersionPropertyName</a> = <b>new</b>[] { <span class="s">&quot;ModuleVersion&quot;</span> };
        <b>internal static readonly string</b>[] <a id="1a985949987e36b7" href="../R/1a985949987e36b7.html" target="n" data-glyph="44,1" class="i field">ManifestGuidPropertyName</a> = <b>new</b>[] { <span class="s">&quot;GUID&quot;</span> };
        <b>internal static readonly string</b>[] <a id="eb70ac5f7f493afd" href="../R/eb70ac5f7f493afd.html" target="n" data-glyph="44,1" class="i field">ManifestPrivateDataPropertyName</a> = <b>new</b>[] { <span class="s">&quot;PrivateData&quot;</span> };
 
        <b>internal static readonly string</b>[] <a id="f8880321c4ea22c8" href="../R/f8880321c4ea22c8.html" target="n" data-glyph="44,1" class="i field">FastModuleManifestAnalysisPropertyNames</a> = <b>new</b>[]
        {
            <span class="s">&quot;AliasesToExport&quot;</span>,
            <span class="s">&quot;CmdletsToExport&quot;</span>,
            <span class="s">&quot;CompatiblePSEditions&quot;</span>,
            <span class="s">&quot;FunctionsToExport&quot;</span>,
            <span class="s">&quot;NestedModules&quot;</span>,
            <span class="s">&quot;RootModule&quot;</span>,
            <span class="s">&quot;ModuleToProcess&quot;</span>,
            <span class="s">&quot;ModuleVersion&quot;</span>
        };
 
        <b>internal static</b> <span class="i">Hashtable</span> <a id="7c4997ce508c858f" href="../R/7c4997ce508c858f.html" target="n" data-glyph="74,1" class="i method">GetModuleManifestProperties</a>(<b>string</b> <span id="r35 rd" class="r35 r">psDataFilePath</span>, <b>string</b>[] <span id="r36 rd" class="r36 r">keys</span>)
        {
            <b>string</b> <span id="r37 rd" class="r37 r">dataFileContents</span> = <a href="../engine/Modules/ScriptAnalysis.cs.html#2e6e7c9b1f1971eb" class="t t">ScriptAnalysis</a>.<a href="../engine/Modules/ScriptAnalysis.cs.html#484860e19aa74776" class="i method">ReadScript</a>(<span class="r35 r">psDataFilePath</span>);
            <a href="../engine/parser/Parser.cs.html#3b2ee49e322daa35" class="t t">ParseError</a>[] <span id="r38 rd" class="r38 r">parseErrors</span>;
            <a href="../engine/parser/ast.cs.html#6f963589327835a4" class="k">var</a> <span id="r39 rd" class="r39 r">ast</span> = (<b>new</b> <a href="../engine/parser/Parser.cs.html#aee2c3138d83ea53" class="t constructor">Parser</a>()).<a href="../engine/parser/Parser.cs.html#3b3edfaa9020f895" class="i method">Parse</a>(<span class="r35 r">psDataFilePath</span>, <span class="r37 r">dataFileContents</span>, <b>null</b>, <b>out</b> <span class="r38 r">parseErrors</span>, <a href="../engine/parser/Parser.cs.html#5c0497999a31aece" class="t t">ParseMode</a>.<a href="../engine/parser/Parser.cs.html#8b44977978de7d50" class="i field">ModuleAnalysis</a>);
            <b>if</b> (<span class="r38 r">parseErrors</span>.<span class="i">Length</span> &gt; 0)
            {
                <a href="ParserException.cs.html#89a0a90c9fc1219d" class="k">var</a> <span id="r40 rd" class="r40 r">pe</span> = <b>new</b> <a href="ParserException.cs.html#62f3ee5b65dd2bdb" class="t constructor">ParseException</a>(<span class="r38 r">parseErrors</span>);
                <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<span class="i">NewInvalidOperationException</span>(
                    <span class="r40 r">pe</span>,
                    <span class="i">ParserStrings</span>.<span class="i">CannotLoadPowerShellDataFile</span>,
                    <span class="r35 r">psDataFilePath</span>,
                    <span class="r40 r">pe</span>.<a href="ParserException.cs.html#f8b287eab458b0b1" class="i property">Message</a>);
            }
 
            <b>string</b> <span id="r41 rd" class="r41 r">unused1</span>;
            <b>string</b> <span id="r42 rd" class="r42 r">unused2</span>;
            <a href="../engine/parser/ast.cs.html#785915ec8547ce9f" class="k">var</a> <span id="r43 rd" class="r43 r">pipeline</span> = <span class="r39 r">ast</span>.<a href="../engine/parser/ast.cs.html#c5ba04d06deeb4d5" class="i method">GetSimplePipeline</a>(<b>false</b>, <b>out</b> <span class="r41 r">unused1</span>, <b>out</b> <span class="r42 r">unused2</span>);
            <b>if</b> (<span class="r43 r">pipeline</span> != <b>null</b>)
            {
                <a href="../engine/parser/ast.cs.html#fd6e450f68cfd52b" class="k">var</a> <span id="r44 rd" class="r44 r">hashtableAst</span> = <span class="r43 r">pipeline</span>.<a href="../engine/parser/ast.cs.html#df65de159259e5e0" class="i method">GetPureExpression</a>() <b>as</b> <a href="../engine/parser/ast.cs.html#fd6e450f68cfd52b" class="t t">HashtableAst</a>;
                <b>if</b> (<span class="r44 r">hashtableAst</span> != <b>null</b>)
                {
                    <b>var</b> <span id="r45 rd" class="r45 r">result</span> = <b>new</b> <span class="i">Hashtable</span>(<span class="i">StringComparer</span>.<span class="i">OrdinalIgnoreCase</span>);
                    <b>foreach</b> (<b>var</b> <span id="r46 rd" class="r46 r">pair</span> <b>in</b> <span class="r44 r">hashtableAst</span>.<a href="../engine/parser/ast.cs.html#87313f35bc2b66d9" class="i property">KeyValuePairs</a>)
                    {
                        <a href="../engine/parser/ast.cs.html#e18e1bad255cd022" class="k">var</a> <span id="r47 rd" class="r47 r">key</span> = <span class="r46 r">pair</span>.<span class="i">Item1</span> <b>as</b> <a href="../engine/parser/ast.cs.html#e18e1bad255cd022" class="t t">StringConstantExpressionAst</a>;
                        <b>if</b> (<span class="r47 r">key</span> != <b>null</b> &amp;&amp; <span class="r36 r">keys</span>.<span class="i">Contains</span>(<span class="r47 r">key</span>.<a href="../engine/parser/ast.cs.html#a6dc72732a1c7e0d" class="i property">Value</a>, <span class="i">StringComparer</span>.<span class="i">OrdinalIgnoreCase</span>))
                        {
                            <b>try</b>
                            {
                                <b>var</b> <span id="r48 rd" class="r48 r">val</span> = <span class="r46 r">pair</span>.<span class="i">Item2</span>.<span class="i">SafeGetValue</span>();
                                <span class="r45 r">result</span>[<span class="r47 r">key</span>.<a href="../engine/parser/ast.cs.html#a6dc72732a1c7e0d" class="i property">Value</a>] = <span class="r48 r">val</span>;
                            }
                            <b>catch</b>
                            {
                                <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<span class="i">NewInvalidOperationException</span>(
                                         <span class="i">ParserStrings</span>.<span class="i">InvalidPowerShellDataFile</span>,
                                         <span class="r35 r">psDataFilePath</span>);
                            }
                        }
                    }
 
                    <b>return</b> <span class="r45 r">result</span>;
                }
            }
 
            <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<span class="i">NewInvalidOperationException</span>(
                     <span class="i">ParserStrings</span>.<span class="i">InvalidPowerShellDataFile</span>,
                     <span class="r35 r">psDataFilePath</span>);
        }
    }
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> This class provides helper methods for converting to/fro from</span>
    <span class="c">///</span><span class="c"> string to base64string.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>internal static class</b> <a id="9fc24c28ab053072" href="../R/9fc24c28ab053072.html" target="n" data-glyph="2,0" class="t t">StringToBase64Converter</a>
    {
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Converts string to base64 encoded string.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r49 r">input</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">String to encode.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">Base64 encoded string.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal static string</b> <a id="62ba06ad26fa41b5" href="../R/62ba06ad26fa41b5.html" target="n" data-glyph="74,1" class="i method">StringToBase64String</a>(<b>string</b> <span id="r49 rd" class="r49 r">input</span>)
        {
            <span class="c">// NTRAID#Windows Out Of Band Releases-926471-2005/12/27-JonN</span>
            <span class="c">// shell crashes if you pass an empty script block to a native command</span>
            <b>if</b> (<span class="r49 r">input</span> == <b>null</b>)
            {
                <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="MshTraceSource.cs.html#fbe67220ad7522a0" class="i method">NewArgumentNullException</a>(<b>nameof</b>(<span class="r49 r">input</span>));
            }
 
            <b>string</b> <span id="r50 rd" class="r50 r">base64</span> = <span class="i">Convert</span>.<span class="i">ToBase64String</span>
                            (
                                <span class="i">Encoding</span>.<span class="i">Unicode</span>.<span class="i">GetBytes</span>(<span class="r49 r">input</span>.<span class="i">ToCharArray</span>())
                            );
            <b>return</b> <span class="r50 r">base64</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Decodes base64 encoded string.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r51 r">base64</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">Base64 string to decode.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">Decoded string.</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal static string</b> <a id="ba18c528b4b08e22" href="../R/../../0000000000.html" target="n" data-glyph="74,1" class="i method">Base64ToString</a>(<b>string</b> <span id="r51 rd" class="r51 r">base64</span>)
        {
            <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r51 r">base64</span>))
            {
                <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="MshTraceSource.cs.html#fbe67220ad7522a0" class="i method">NewArgumentNullException</a>(<b>nameof</b>(<span class="r51 r">base64</span>));
            }
 
            <b>string</b> <span id="r52 rd" class="r52 r">output</span> = <b>new</b> <b>string</b>(<span class="i">Encoding</span>.<span class="i">Unicode</span>.<span class="i">GetChars</span>(<span class="i">Convert</span>.<span class="i">FromBase64String</span>(<span class="r51 r">base64</span>)));
            <b>return</b> <span class="r52 r">output</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Decodes base64 encoded string in to args array.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r53 r">base64</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">returns</span><span class="c">&gt;</span><span class="c">&lt;/</span><span class="c">returns</span><span class="c">&gt;</span>
        <b>internal static object</b>[] <a id="9226eb74089446ed" href="../R/../../0000000000.html" target="n" data-glyph="74,1" class="i method">Base64ToArgsConverter</a>(<b>string</b> <span id="r53 rd" class="r53 r">base64</span>)
        {
            <b>if</b> (<b>string</b>.<span class="i">IsNullOrEmpty</span>(<span class="r53 r">base64</span>))
            {
                <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="MshTraceSource.cs.html#fbe67220ad7522a0" class="i method">NewArgumentNullException</a>(<b>nameof</b>(<span class="r53 r">base64</span>));
            }
 
            <b>string</b> <span id="r54 rd" class="r54 r">decoded</span> = <b>new</b> <b>string</b>(<span class="i">Encoding</span>.<span class="i">Unicode</span>.<span class="i">GetChars</span>(<span class="i">Convert</span>.<span class="i">FromBase64String</span>(<span class="r53 r">base64</span>)));
 
            <span class="c">// Deserialize string</span>
            <span class="i">XmlReader</span> <span id="r55 rd" class="r55 r">reader</span> = <span class="i">XmlReader</span>.<span class="i">Create</span>(<b>new</b> <span class="i">StringReader</span>(<span class="r54 r">decoded</span>), <a href="../engine/serialization.cs.html#758c46d6a86d6840" class="t t">InternalDeserializer</a>.<a href="../engine/serialization.cs.html#68d86b2b9f57584d" class="i property">XmlReaderSettingsForCliXml</a>);
            <b>object</b> <span id="r56 rd" class="r56 r">dso</span>;
            <a href="../engine/serialization.cs.html#27835b221aec7524" class="t t">Deserializer</a> <span id="r57 rd" class="r57 r">deserializer</span> = <b>new</b> <a href="../engine/serialization.cs.html#37284915ff9862dc" class="t constructor">Deserializer</a>(<span class="r55 r">reader</span>);
            <span class="r56 r">dso</span> = <span class="r57 r">deserializer</span>.<a href="../engine/serialization.cs.html#9c920943c97004d6" class="i method">Deserialize</a>();
            <b>if</b> (!<span class="r57 r">deserializer</span>.<a href="../engine/serialization.cs.html#6c4195591a1a2219" class="i method">Done</a>())
            {
                <span class="c">// This helper function should move to host and it should provide appropriate</span>
                <span class="c">// error message there.</span>
                <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="MshTraceSource.cs.html#fed5f40dc0075d41" class="i method">NewArgumentException</a>(<a href="../engine/MinishellParameterBinderController.cs.html#4eed1ccbae50f5e9" class="t t">MinishellParameterBinderController</a>.<a href="../engine/MinishellParameterBinderController.cs.html#796e1eac92c5f0c7" class="i field">ArgsParameter</a>);
            }
 
            <b>if</b> (!(<span class="r56 r">dso</span> <b>is</b> <a href="../engine/MshObject.cs.html#a3c2513aa3da07fa" class="t t">PSObject</a> <span id="r58 rd" class="r58 r">mo</span>))
            {
                <span class="c">// This helper function should move the host. Provide appropriate error message.</span>
                <span class="c">// Format of args parameter is not correct.</span>
                <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="MshTraceSource.cs.html#fed5f40dc0075d41" class="i method">NewArgumentException</a>(<a href="../engine/MinishellParameterBinderController.cs.html#4eed1ccbae50f5e9" class="t t">MinishellParameterBinderController</a>.<a href="../engine/MinishellParameterBinderController.cs.html#796e1eac92c5f0c7" class="i field">ArgsParameter</a>);
            }
 
            <b>if</b> (!(<span class="r58 r">mo</span>.<a href="../engine/MshObject.cs.html#d854d13536b70a12" class="i property">BaseObject</a> <b>is</b> <span class="i">ArrayList</span> <span id="r59 rd" class="r59 r">argsList</span>))
            {
                <span class="c">// This helper function should move the host. Provide appropriate error message.</span>
                <span class="c">// Format of args parameter is not correct.</span>
                <b>throw</b> <a href="../P/6de812d1f374e1ae.html#6de812d1f374e1ae" class="t t">PSTraceSource</a>.<a href="MshTraceSource.cs.html#fed5f40dc0075d41" class="i method">NewArgumentException</a>(<a href="../engine/MinishellParameterBinderController.cs.html#4eed1ccbae50f5e9" class="t t">MinishellParameterBinderController</a>.<a href="../engine/MinishellParameterBinderController.cs.html#796e1eac92c5f0c7" class="i field">ArgsParameter</a>);
            }
 
            <b>return</b> <span class="r59 r">argsList</span>.<span class="i">ToArray</span>();
        }
    }
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> A simple implementation of CRC32.</span>
    <span class="c">///</span><span class="c"> See &quot;CRC-32 algorithm&quot; in https://en.wikipedia.org/wiki/Cyclic_redundancy_check.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>internal static class</b> <a id="15d2eb95ada20450" href="../R/15d2eb95ada20450.html" target="n" data-glyph="2,0" class="t t">CRC32Hash</a>
    {
        <span class="c">// CRC-32C polynomial representations</span>
        <b>private const uint</b> <a id="27d53103bb80c28a" href="../R/27d53103bb80c28a.html" target="n" data-glyph="10,1" class="i field">polynomial</a> = 0x1EDC6F41;
 
        <b>private static readonly uint</b>[] <a id="edf52bf470e6fdd0" href="../R/edf52bf470e6fdd0.html" target="n" data-glyph="46,1" class="i field">table</a>;
 
        <b>static</b> <a id="06ca301beebc0bfe" href="../R/../../0000000000.html" target="n" data-glyph="76,1" class="t method">CRC32Hash</a>()
        {
            <b>uint</b> <span id="r60 rd" class="r60 r">temp</span> = 0;
            <a href="#edf52bf470e6fdd0" class="i field">table</a> = <b>new</b> <b>uint</b>[256];
 
            <b>for</b> (<b>int</b> <span id="r61 rd" class="r61 r">i</span> = 0; <span class="r61 r">i</span> &lt; <a href="#edf52bf470e6fdd0" class="i field">table</a>.<span class="i">Length</span>; <span class="r61 r">i</span>++)
            {
                <span class="r60 r">temp</span> = (<b>uint</b>)<span class="r61 r">i</span>;
                <b>for</b> (<b>int</b> <span id="r62 rd" class="r62 r">j</span> = 0; <span class="r62 r">j</span> &lt; 8; <span class="r62 r">j</span>++)
                {
                    <b>if</b> ((<span class="r60 r">temp</span> &amp; 1) == 1)
                    {
                        <span class="r60 r">temp</span> = (<span class="r60 r">temp</span> &gt;&gt; 1) ^ <a href="#27d53103bb80c28a" class="i field">polynomial</a>;
                    }
                    <b>else</b>
                    {
                        <span class="r60 r">temp</span> &gt;&gt;= 1;
                    }
                }
 
                <a href="#edf52bf470e6fdd0" class="i field">table</a>[<span class="r61 r">i</span>] = <span class="r60 r">temp</span>;
            }
        }
 
        <b>private static uint</b> <a id="a6a4aeeaca3d8ec5" href="../R/a6a4aeeaca3d8ec5.html" target="n" data-glyph="76,1" class="i method">Compute</a>(<b>byte</b>[] <span id="r63 rd" class="r63 r">buffer</span>)
        {
            <b>uint</b> <span id="r64 rd" class="r64 r">crc</span> = 0xFFFFFFFF;
            <b>for</b> (<b>int</b> <span id="r65 rd" class="r65 r">i</span> = 0; <span class="r65 r">i</span> &lt; <span class="r63 r">buffer</span>.<span class="i">Length</span>; ++<span class="r65 r">i</span>)
            {
                <b>var</b> <span id="r66 rd" class="r66 r">index</span> = (<b>byte</b>)(<span class="r64 r">crc</span> ^ <span class="r63 r">buffer</span>[<span class="r65 r">i</span>] &amp; 0xff);
                <span class="r64 r">crc</span> = (<span class="r64 r">crc</span> &gt;&gt; 8) ^ <a href="#edf52bf470e6fdd0" class="i field">table</a>[<span class="r66 r">index</span>];
            }
 
            <b>return</b> ~<span class="r64 r">crc</span>;
        }
 
        <b>internal static byte</b>[] <a id="3a7f6164052ca8b0" href="../R/../../0000000000.html" target="n" data-glyph="74,1" class="i method">ComputeHash</a>(<b>byte</b>[] <span id="r67 rd" class="r67 r">buffer</span>)
        {
            <b>uint</b> <span id="r68 rd" class="r68 r">crcResult</span> = <a href="#a6a4aeeaca3d8ec5" class="i method">Compute</a>(<span class="r67 r">buffer</span>);
            <b>return</b> <span class="i">BitConverter</span>.<span class="i">GetBytes</span>(<span class="r68 r">crcResult</span>);
        }
 
        <b>internal static string</b> <a id="30051373d203881b" href="../R/30051373d203881b.html" target="n" data-glyph="74,1" class="i method">ComputeHash</a>(<b>string</b> <span id="r69 rd" class="r69 r">input</span>)
        {
            <b>byte</b>[] <span id="r70 rd" class="r70 r">hashBytes</span> = <span class="i">ComputeHash</span>(<span class="i">Encoding</span>.<span class="i">UTF8</span>.<span class="i">GetBytes</span>(<span class="r69 r">input</span>));
            <b>return</b> <span class="i">BitConverter</span>.<span class="i">ToString</span>(<span class="r70 r">hashBytes</span>).<span class="i">Replace</span>(<span class="s">&quot;-&quot;</span>, <b>string</b>.<span class="i">Empty</span>);
        }
    }
 
    <span class="k preprocess">#</span><span class="k preprocess">region</span> ReferenceEqualityComparer
 
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Equality comparer based on Object Identity.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>internal class</b> <a id="fae7c46bc3827f70" href="../R/../../0000000000.html" target="n" data-glyph="2,0" class="t t"><span id="a5cfd974c9f462df">ReferenceEqualityComparer</span></a> : <span class="i">IEqualityComparer</span>
    {
        <b>bool</b> <span class="i">IEqualityComparer</span>.<a id="6ecdff65a85d8555" href="../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">Equals</a>(<b>object</b> <span id="r71 rd" class="r71 r">x</span>, <b>object</b> <span id="r72 rd" class="r72 r">y</span>)
        {
            <b>return</b> <span class="i">Object</span>.<span class="i">ReferenceEquals</span>(<span class="r71 r">x</span>, <span class="r72 r">y</span>);
        }
 
        <b>int</b> <span class="i">IEqualityComparer</span>.<a id="895fc6c60f6222d5" href="../R/../../0000000000.html" target="n" data-glyph="76,1" class="i method">GetHashCode</a>(<b>object</b> <span id="r73 rd" class="r73 r">obj</span>)
        {
            <span class="c">// The Object.GetHashCode and RuntimeHelpers.GetHashCode methods are used in the following scenarios:</span>
            <span class="c">//</span>
            <span class="c">// Object.GetHashCode is useful in scenarios where you care about object value. Two strings with identical</span>
            <span class="c">// contents will return the same value for Object.GetHashCode.</span>
            <span class="c">//</span>
            <span class="c">// RuntimeHelpers.GetHashCode is useful in scenarios where you care about object identity. Two strings with</span>
            <span class="c">// identical contents will return different values for RuntimeHelpers.GetHashCode, because they are different</span>
            <span class="c">// string objects, although their contents are the same.</span>
 
            <b>return</b> <span class="i">RuntimeHelpers</span>.<span class="i">GetHashCode</span>(<span class="r73 r">obj</span>);
        }
    }
 
    <span class="k preprocess">#</span><span class="k preprocess">endregion</span>
}
</pre></td></tr></table></div></body></html>
